<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üñêüèª üöÄ üíØ Fitur program pembuatan profil dalam C ++ üèáüèø ü•ñ üß¢</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Kadang-kadang, mungkin perlu untuk profil kinerja program atau konsumsi memori dalam program C ++. Sayangnya, seringkali ini tidak semudah kelihatanny...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Fitur program pembuatan profil dalam C ++</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/482040/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/xj/sv/vy/xjsvvy62rgww5jixemahqzaz0yi.jpeg"></div><br>  Kadang-kadang, mungkin perlu untuk profil kinerja program atau konsumsi memori dalam program C ++.  Sayangnya, seringkali ini tidak semudah kelihatannya. <br><br>  Di sini kita akan mempertimbangkan fitur program profil menggunakan alat <b>valgrind</b> dan <b>google perftools</b> .  Materi itu ternyata tidak terlalu terstruktur, itu lebih merupakan upaya untuk mengumpulkan basis pengetahuan "untuk tujuan pribadi" sehingga di masa depan Anda tidak perlu dengan panik mengingat "mengapa ini tidak berhasil" atau "bagaimana melakukannya".  Kemungkinan besar, tidak semua kasus yang tidak jelas akan terpengaruh di sini, jika Anda memiliki sesuatu untuk ditambahkan, silakan tulis di komentar. <br><br>  Semua contoh akan berjalan di sistem linux. <a name="habracut"></a><br><br><h2>  Runtime Profiling </h2><br><h3>  Persiapan </h3><br>  Untuk menganalisis fitur-fitur pembuatan profil, saya akan menjalankan program kecil, biasanya terdiri dari satu file main.cpp dan satu file func.cpp beserta inklusi. <br>  Saya akan mengkompilasinya dengan <b>kompiler g ++ 8.3.0</b> . <br><br>  Karena profiling program yang tidak dioptimalkan adalah tugas yang agak aneh, kami akan mengkompilasi dengan opsi <b>-Ofast</b> , dan untuk mendapatkan karakter debug dalam output, kami tidak akan lupa untuk menambahkan opsi <b>-g</b> .  Namun, terkadang alih-alih nama fungsi normal, Anda hanya dapat melihat alamat panggilan yang tidak terdengar.  Ini berarti bahwa telah ada "pengacakan alokasi ruang alamat".  Ini dapat ditentukan dengan memanggil perintah <b>nm</b> pada biner.  Jika sebagian besar alamat terlihat seperti ini 0000000000003030e0 (sejumlah besar nol di awal), maka kemungkinan besar ini dia.  Dalam program normal, alamatnya terlihat seperti 0000000000402fa0.  Karena itu, Anda perlu menambahkan opsi <b>-no-pie</b> .  Akibatnya, set lengkap opsi akan terlihat seperti ini: <br>  <b>-Bergas -g -tidak-pai</b> <br><br>  Untuk melihat hasilnya, kami akan menggunakan program <b>KCachegrind</b> , yang dapat bekerja dengan <b>format</b> laporan <b>callgrind</b> <br><br><h3>  Callgrind </h3><br>  Utilitas pertama yang akan kita lihat hari ini adalah <b>callgrind</b> .  Utilitas ini adalah bagian dari alat valgrind.  Ini mengemulasi setiap instruksi yang dapat dieksekusi dari program dan, berdasarkan metrik internal tentang "biaya" dari setiap instruksi, mengeluarkan kesimpulan yang kita butuhkan.  Karena pendekatan ini, kadang-kadang terjadi bahwa callgrind tidak dapat mengenali instruksi selanjutnya dan jatuh dengan kesalahan <br>  <i>Instruksi tidak dikenal di alamat</i> <br>  Satu-satunya jalan keluar dari situasi ini adalah dengan mempertimbangkan kembali semua opsi kompilasi dan mencoba menemukan interferensi <br><br>  Mari kita buat program untuk menguji alat ini, yang terdiri dari satu pustaka bersama dan satu pustaka statis (nanti kita akan menyerahkan pustaka dalam pengujian lain).  Setiap perpustakaan, serta program itu sendiri, akan menyediakan fungsi komputasi yang sederhana, misalnya, perhitungan urutan Fibonacci. <br><br><div class="spoiler">  <b class="spoiler_title">static_lib</b> <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">////////////////// // static_lib.h // ////////////////// #ifndef SERVER_STATIC_LIB_H #define SERVER_STATIC_LIB_H int func_static_lib(int arg); #endif //SERVER_STATIC_LIB_H //////////////////// // static_lib.cpp // /////////////////// #include "static_lib.h" #include "static_func.h" #include &lt;cstddef&gt; int func_static_lib(int arg) { return static_func(arg); } /////////////////// // static_func.h // /////////////////// #ifndef TEST_PROFILER_STATIC_FUNC_H #define TEST_PROFILER_STATIC_FUNC_H int static_func(int arg); #endif //TEST_PROFILER_STATIC_FUNC_H ///////////////////// // static_func.cpp // ///////////////////// #include "static_func.h" int static_func(int arg) { int fst = 0; int snd = 1; for (int i = 0; i &lt; arg; i++) { int tmp = (fst + snd) % 17769897; fst = snd; snd = tmp; } return fst; }</span></span></code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">shared_lib</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">////////////////// // shared_lib.h // ////////////////// #ifndef TEST_PROFILER_SHARED_LIB_H #define TEST_PROFILER_SHARED_LIB_H int func_shared_lib(int arg); #endif //TEST_PROFILER_SHARED_LIB_H //////////////////// // shared_lib.cpp // //////////////////// #include "shared_lib.h" #include "shared_func.h" int func_shared_lib(int arg) { return shared_func(arg); } /////////////////// // shared_func.h // /////////////////// #ifndef TEST_PROFILER_SHARED_FUNC_H #define TEST_PROFILER_SHARED_FUNC_H int shared_func(int arg); #endif //TEST_PROFILER_SHARED_FUNC_H ///////////////////// // shared_func.cpp // ///////////////////// #include "shared_func.h" int shared_func(int arg) { int result = 1; for (int i = 1; i &lt; arg; i++) { result = (int)(((long long)result * i) % 19637856977); } return result; }</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">utama</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">////////////// // main.cpp // ////////////// #include &lt;iostream&gt; #include "static_lib.h" #include "shared_lib.h" #include "func.h" int main(int argc, char **argv) { if (argc != 2) { std::cout &lt;&lt; "Incorrect args"; return -1; } const int arg = std::atoi(argv[1]); std::cout &lt;&lt; "result: " &lt;&lt; func_static_lib(arg) &lt;&lt; " " &lt;&lt; func_shared_lib(arg) &lt;&lt; " " &lt;&lt; func(arg); return 0; } //////////// // func.h // //////////// #ifndef TEST_PROFILER_FUNC_H #define TEST_PROFILER_FUNC_H int func(int arg); #endif //TEST_PROFILER_FUNC_H ////////////// // func.cpp // ////////////// #include "func.h" int func(int arg) { int fst = 1; int snd = 1; for (int i = 0; i &lt; arg; i++) { int res = (fst + snd + 1) % 19845689; fst = snd; snd = res; } return fst; }</span></span></code> </pre><br></div></div><br>  Kami mengkompilasi program, dan menjalankan valgrind sebagai berikut: <br><br><pre> <code class="bash hljs">valgrind --tool=callgrind ./test_profiler 100000000</code> </pre> <br> <a href=""><img src="https://habrastorage.org/webt/i7/xa/tt/i7xattm3xphucvb3x5ogxlbpv20.png"></a> <br>  Kami melihat bahwa untuk pustaka statis dan fungsi reguler, hasilnya mirip dengan yang diharapkan.  Tetapi di perpustakaan dinamis, callgrind tidak bisa sepenuhnya menyelesaikan fungsi. <br><br>  Untuk memperbaiki ini, ketika memulai program, Anda perlu mengatur variabel <b>LD_BIND_NOW</b> menjadi 1, seperti ini: <br><br><pre> <code class="bash hljs">LD_BIND_NOW=1 valgrind --tool=callgrind ./test_profiler 100000000</code> </pre> <br> <a href=""><img src="https://habrastorage.org/webt/nb/l2/yb/nbl2ybqiy6atyd5cak6evogfbem.png"></a> <br>  Dan sekarang, seperti yang Anda lihat, semuanya baik-baik saja <br><br>  Masalah callgrind berikutnya yang muncul dari profil dengan meniru instruksi adalah bahwa eksekusi program banyak melambat.  Ini dapat membawa estimasi relatif yang salah dari waktu eksekusi berbagai bagian kode. <br><br>  Mari kita lihat kode ini: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> arg)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> fst = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> snd = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-function"><span class="hljs-function">ofstream </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">file</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"tmp.txt"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; arg; i++) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> res = (fst + snd + <span class="hljs-number"><span class="hljs-number">1</span></span>) % <span class="hljs-number"><span class="hljs-number">19845689</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> r = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::to_string(res); file &lt;&lt; res; file.flush(); fst = snd; snd = res + r.size(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fst; }</code> </pre><br>  Di sini, saya menambahkan sejumlah kecil data ke file untuk setiap iterasi dari loop.  Karena menulis ke file adalah operasi yang agak panjang, sebagai penyeimbang, saya menambahkan generasi garis dari angka ke setiap iterasi dari loop.  Jelas, dalam hal ini, operasi penulisan ke file membutuhkan waktu lebih lama dari sisa logika fungsi.  Tetapi callgrind berpikir secara berbeda: <br> <a href=""><img src="https://habrastorage.org/webt/hn/pg/zt/hnpgztqrtptlu7_g0tmr5frgbuy.png"></a> <br><br>  Perlu juga dipertimbangkan bahwa panggilan balik hanya dapat mengukur biaya suatu fungsi saat bekerja.  Fungsi tidak berfungsi - karenanya, biaya tidak meningkat.  Ini menyulitkan debugging program yang dari waktu ke waktu memasukkan kunci atau bekerja dengan sistem / jaringan file pemblokiran.  Mari kita periksa: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"func.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;mutex&gt; static std::mutex mutex; int funcImpl(int arg) { std::lock_guard&lt;std::mutex&gt; lock(mutex); int fst = 1; int snd = 1; for (int i = 0; i &lt; arg; i++) { int res = (fst + snd + 1) % 19845689; fst = snd; snd = res; } return fst; } int func2(int arg){ return funcImpl(arg); } int func(int arg) { return funcImpl(arg); } int main(int argc, char **argv) { if (argc != 2) { std::cout &lt;&lt; "Incorrect args"; return -1; } const int arg = std::atoi(argv[1]); auto future = std::async(std::launch::async, &amp;func2, arg); std::cout &lt;&lt; "result: " &lt;&lt; func(arg) &lt;&lt; std::endl; std::cout &lt;&lt; "second result " &lt;&lt; future.get() &lt;&lt; std::endl; return 0; }</span></span></span></span></code> </pre><br>  Di sini kita telah melampirkan seluruh eksekusi fungsi di kunci mutex, dan memanggil fungsi ini dari dua utas yang berbeda.  Hasil dari callgrind cukup dapat diprediksi - ia tidak melihat masalah dalam menangkap mutex: <br> <a href=""><img src="https://habrastorage.org/webt/be/eh/nj/beehnjstn0h_kjbjjq2by_randc.png"></a> <br><br>  Jadi, kami memeriksa beberapa masalah dalam menggunakan profiler panggilan.  Mari kita beralih ke subjek tes berikutnya - profiler google perftools <br><br><h3>  google perftools </h3><br>  Tidak seperti callgrind, google profiler bekerja berdasarkan prinsip yang berbeda. <br>  Alih-alih menganalisis setiap instruksi dari program yang dapat dieksekusi, itu menjeda program secara berkala dan mencoba untuk menentukan fungsi yang saat ini berada di dalamnya.  Akibatnya, ini hampir tidak mempengaruhi kinerja aplikasi yang sedang berjalan.  Namun pendekatan ini juga memiliki kelemahannya. <br><br>  Mari kita mulai dengan membuat profil program pertama dengan dua perpustakaan. <br><br>  Sebagai aturan, untuk mulai membuat profil dengan utilitas ini, Anda harus melakukan preload pustaka libprofiler.so, mengatur frekuensi sampling dan menentukan file untuk menyimpan dump.  Sayangnya, profiler membutuhkan program untuk mengakhiri "sendiri."  Pengakhiran paksa program akan menyebabkan laporan tidak dibuang begitu saja.  Ini tidak nyaman ketika membuat profil program yang berumur panjang yang tidak berhenti, seperti daemon.  Untuk mengatasi kendala ini, saya membuat skrip ini: <br><br><div class="spoiler">  <b class="spoiler_title">gprof.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs">rnd=<span class="hljs-variable"><span class="hljs-variable">$RANDOM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-variable"><span class="hljs-variable">$#</span></span> -eq 0 ] <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"./gprof.sh command args"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"Run with variable N_STOP=true if hand stop required"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> libprofiler=$( dirname <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${BASH_SOURCE[0]}</span></span></span><span class="hljs-string">"</span></span> ) arg=<span class="hljs-variable"><span class="hljs-variable">$1</span></span> nostop=<span class="hljs-variable"><span class="hljs-variable">$N_STOP</span></span> profileName=callgrind.out.<span class="hljs-variable"><span class="hljs-variable">$rnd</span></span>.g gperftoolProfile=./gperftool.<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$rnd</span></span></span><span class="hljs-string">"</span></span>.txt touch <span class="hljs-variable"><span class="hljs-variable">$profileName</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"Profile name </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$profileName</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [[ <span class="hljs-variable"><span class="hljs-variable">$nostop</span></span> = <span class="hljs-string"><span class="hljs-string">"true"</span></span> ]] <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"without stop"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">trap</span></span> <span class="hljs-string"><span class="hljs-string">'echo trap &amp;&amp; kill -12 $PID &amp;&amp; sleep 1 &amp;&amp; kill -TERM $PID'</span></span> TERM INT <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-built_in"><span class="hljs-built_in">trap</span></span> <span class="hljs-string"><span class="hljs-string">'echo trap &amp;&amp; kill -TERM $PID'</span></span> TERM INT <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [[ <span class="hljs-variable"><span class="hljs-variable">$nostop</span></span> = <span class="hljs-string"><span class="hljs-string">"true"</span></span> ]] <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> CPUPROFILESIGNAL=12 CPUPROFILE_FREQUENCY=1000000 CPUPROFILE=<span class="hljs-variable"><span class="hljs-variable">$gperftoolProfile</span></span> LD_PRELOAD=<span class="hljs-variable"><span class="hljs-variable">${libprofiler}</span></span>/libprofiler.so <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${@:1}</span></span></span><span class="hljs-string">"</span></span> &amp; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> CPUPROFILE_FREQUENCY=1000000 CPUPROFILE=<span class="hljs-variable"><span class="hljs-variable">$gperftoolProfile</span></span> LD_PRELOAD=<span class="hljs-variable"><span class="hljs-variable">${libprofiler}</span></span>/libprofiler.so <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${@:1}</span></span></span><span class="hljs-string">"</span></span> &amp; <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> PID=$! <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [[ <span class="hljs-variable"><span class="hljs-variable">$nostop</span></span> = <span class="hljs-string"><span class="hljs-string">"true"</span></span> ]] <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> sleep 1 <span class="hljs-built_in"><span class="hljs-built_in">kill</span></span> -12 <span class="hljs-variable"><span class="hljs-variable">$PID</span></span> <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> <span class="hljs-built_in"><span class="hljs-built_in">wait</span></span> <span class="hljs-variable"><span class="hljs-variable">$PID</span></span> <span class="hljs-built_in"><span class="hljs-built_in">trap</span></span> - TERM INT <span class="hljs-built_in"><span class="hljs-built_in">wait</span></span> <span class="hljs-variable"><span class="hljs-variable">$PID</span></span> EXIT_STATUS=$? <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-variable"><span class="hljs-variable">$PWD</span></span> <span class="hljs-variable"><span class="hljs-variable">${libprofiler}</span></span>/pprof --callgrind <span class="hljs-variable"><span class="hljs-variable">$arg</span></span> <span class="hljs-variable"><span class="hljs-variable">$gperftoolProfile</span></span>* &gt; <span class="hljs-variable"><span class="hljs-variable">$profileName</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"Profile name </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$profileName</span></span></span><span class="hljs-string">"</span></span> rm -f <span class="hljs-variable"><span class="hljs-variable">$gperftoolProfile</span></span>*</code> </pre><br></div></div><br>  Utilitas ini perlu dijalankan, lewat sebagai parameter nama file yang dapat dieksekusi dan daftar parameternya.  Juga, diasumsikan bahwa di sebelah skrip adalah file yang ia butuhkan libprofiler.so dan pprof.  Jika program ini berumur panjang dan berhenti dengan mengganggu eksekusi, Anda harus mengatur variabel N_STOP menjadi true, misalnya, seperti ini: <br><pre> <code class="bash hljs">N_STOP=<span class="hljs-literal"><span class="hljs-literal">true</span></span> ./gprof.sh ./test_profiler 10000000000</code> </pre> <br>  Di akhir pekerjaan, skrip akan menghasilkan laporan dalam format callgrind favorit saya. <br><br>  Jadi, mari kita jalankan program kami di bawah profiler ini. <br><pre> <code class="bash hljs">./gprof.sh ./test_profiler 1000000000</code> </pre> <br> <a href=""><img src="https://habrastorage.org/webt/qg/q_/sw/qgq_sw__etaj7mmmrgzvgw_b70c.png"></a> <br>  Pada prinsipnya, semuanya cukup jelas. <br><br>  Seperti yang saya katakan, profiler Google bekerja dengan menghentikan eksekusi program dan menghitung fungsi saat ini.  Bagaimana dia melakukannya?  Dia melakukan ini dengan memutar tumpukan.  Tetapi bagaimana jika, pada saat promosi tumpukan, program itu sendiri melepaskan tumpukan?  Jelas, tidak ada hal baik yang akan terjadi.  Mari kita periksa.  Mari kita tulis fungsi seperti itu: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runExcept</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> res)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (res % <span class="hljs-number"><span class="hljs-number">13</span></span> == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>(<span class="hljs-string"><span class="hljs-string">"Exception"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> arg)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> fst = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> snd = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; arg; i++) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> res = (fst + snd + <span class="hljs-number"><span class="hljs-number">1</span></span>) % <span class="hljs-number"><span class="hljs-number">19845689</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { res = runExcept(res); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> &amp;e) { res = res - <span class="hljs-number"><span class="hljs-number">1</span></span>; } fst = snd; snd = res; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fst; }</code> </pre><br>  Dan jalankan profil.  Program membeku dengan sangat cepat. <br><br>  Ada masalah lain yang terkait dengan kekhasan operasi profiler.  Misalkan kita berhasil melepaskan tumpukan, dan sekarang kita perlu mencocokkan alamat dengan fungsi spesifik dari program.  Ini bisa sangat non-trivial, karena di C ++ sejumlah besar fungsi sebaris.  Mari kita lihat contoh seperti ini: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"func.h"</span></span></span><span class="hljs-meta"> static int func1(int arg) { std::cout &lt;&lt; 1 &lt;&lt; std::endl; return func(arg); } static int func2(int arg) { std::cout &lt;&lt; 2 &lt;&lt; std::endl; return func(arg); } static int func3(int arg) { std::cout &lt;&lt; 3 &lt;&lt; std::endl; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (arg % 2 == 0) { return func2(arg); } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> { return func1(arg); } } int main(int argc, char **argv) { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (argc != 2) { std::cout &lt;&lt; </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Incorrect args"</span></span></span><span class="hljs-meta">; return -1; } const int arg = std::atoi(argv[1]); int arg2 = func3(arg); int arg3 = func(arg); std::cout &lt;&lt; </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"result: "</span></span></span><span class="hljs-meta"> &lt;&lt; arg2 + arg3; return 0; }</span></span></code> </pre><br>  Tentunya, jika Anda menjalankan program misalnya seperti ini: <br><pre> <code class="bash hljs">./gprof.sh ./test_profiler 1000000000</code> </pre> <br>  maka fungsi func1 tidak akan pernah dipanggil.  Tetapi profiler itu berpikir berbeda: <br> <a href=""><img src="https://habrastorage.org/webt/8-/0o/ny/8-0onyayanqwvdarg94cd92srzc.png"></a> <br>  (Omong-omong, valgrind di sini memutuskan untuk tetap diam dan tidak menentukan fungsi spesifik dari mana panggilan itu berasal). <br><br><h2>  Pembuatan profil memori </h2><br>  Seringkali ada situasi ketika memori dari aplikasi di suatu tempat "mengalir".  Jika ini disebabkan oleh kurangnya pembersihan sumber daya, maka Memcheck akan membantu mengidentifikasi masalah.  Tetapi dalam C ++ modern tidak begitu sulit dilakukan tanpa manajemen sumber daya manual.  unique_ptr, shared_ptr, vektor, peta membuat manipulasi bare-point menjadi sia-sia. <br><br>  Namun demikian, dalam aplikasi seperti itu, memori bocor.  Bagaimana kabarnya?  Sederhananya, sebagai aturan, itu adalah sesuatu seperti "memasukkan nilai dalam peta berumur panjang, tetapi lupa untuk menghapusnya".  Mari kita coba lacak situasi ini. <br><br>  Untuk melakukan ini, kami menulis ulang fungsi pengujian kami dengan cara ini <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"func.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;deque&gt; #include &lt;string&gt; #include &lt;map&gt; static std::deque&lt;std::string&gt; deque; static std::map&lt;int, std::string&gt; map; int func(int arg) { int fst = 1; int snd = 1; for (int i = 0; i &lt; arg; i++) { int res = (fst + snd + 1) % 19845689; fst = snd; snd = res; deque.emplace_back(std::to_string(res) + " integer"); map[i] = "integer " + std::to_string(res); deque.pop_front(); if (res % 200 != 0) { map.erase(i - 1); } } return fst; }</span></span></span></span></code> </pre><br>  Di sini, pada setiap iterasi, kami menambahkan beberapa elemen ke peta, dan secara tidak sengaja (benar, benar) kami terkadang lupa menghapusnya dari sana.  Juga, untuk menghindari mata kita, kita menyiksa std :: deque sedikit. <br><br>  Kami akan <b>menangkap</b> kebocoran memori dengan dua alat - <b>valgrind massif</b> dan <b>google heapdump</b> . <br><br><h3>  Massif </h3><br>  Jalankan program dengan perintah ini <br><pre> <code class="bash hljs">valgrind --tool=massif ./test_profiler 1000000</code> </pre> <br>  Dan kita melihat sesuatu seperti <br><br><div class="spoiler">  <b class="spoiler_title">Massif</b> <div class="spoiler_text"><pre> <code class="cpp hljs">time=<span class="hljs-number"><span class="hljs-number">1277949333</span></span> mem_heap_B=<span class="hljs-number"><span class="hljs-number">313518</span></span> mem_heap_extra_B=<span class="hljs-number"><span class="hljs-number">58266</span></span> mem_stacks_B=<span class="hljs-number"><span class="hljs-number">0</span></span> heap_tree=detailed n4: <span class="hljs-number"><span class="hljs-number">313518</span></span> (heap allocation functions) <span class="hljs-built_in"><span class="hljs-built_in">malloc</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">new</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[], --alloc-fns, etc. n1: <span class="hljs-number"><span class="hljs-number">195696</span></span> <span class="hljs-number"><span class="hljs-number">0x109A69</span></span>: func(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) (new_allocator.h:<span class="hljs-number"><span class="hljs-number">111</span></span>) n0: <span class="hljs-number"><span class="hljs-number">195696</span></span> <span class="hljs-number"><span class="hljs-number">0x10947A</span></span>: main (main.cpp:<span class="hljs-number"><span class="hljs-number">18</span></span>) n1: <span class="hljs-number"><span class="hljs-number">72704</span></span> <span class="hljs-number"><span class="hljs-number">0x52BA414</span></span>: ??? (in /usr/lib/x86_64-linux-gnu/libstdc++.so<span class="hljs-number"><span class="hljs-number">.6</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.25</span></span>) n1: <span class="hljs-number"><span class="hljs-number">72704</span></span> <span class="hljs-number"><span class="hljs-number">0x4010731</span></span>: _dl_init (dl-init.c:<span class="hljs-number"><span class="hljs-number">72</span></span>) n1: <span class="hljs-number"><span class="hljs-number">72704</span></span> <span class="hljs-number"><span class="hljs-number">0x40010C8</span></span>: ??? (in /lib/x86_64-linux-gnu/ld<span class="hljs-number"><span class="hljs-number">-2.27</span></span>.so) n1: <span class="hljs-number"><span class="hljs-number">72704</span></span> <span class="hljs-number"><span class="hljs-number">0x0</span></span>: ??? n1: <span class="hljs-number"><span class="hljs-number">72704</span></span> <span class="hljs-number"><span class="hljs-number">0x1FFF0000D1</span></span>: ??? n0: <span class="hljs-number"><span class="hljs-number">72704</span></span> <span class="hljs-number"><span class="hljs-number">0x1FFF0000E1</span></span>: ??? n2: <span class="hljs-number"><span class="hljs-number">42966</span></span> <span class="hljs-number"><span class="hljs-number">0x10A7EC</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::__cxx11::basic_string&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::char_traits&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>&gt;, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::allocator&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>&gt; &gt;::_M_mutate(<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>*, <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>) (new_allocator.h:<span class="hljs-number"><span class="hljs-number">111</span></span>) n1: <span class="hljs-number"><span class="hljs-number">42966</span></span> <span class="hljs-number"><span class="hljs-number">0x10AAD9</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::__cxx11::basic_string&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::char_traits&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>&gt;, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::allocator&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>&gt; &gt;::_M_replace(<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>*, <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>) (basic_string.tcc:<span class="hljs-number"><span class="hljs-number">466</span></span>) n1: <span class="hljs-number"><span class="hljs-number">42966</span></span> <span class="hljs-number"><span class="hljs-number">0x1099D4</span></span>: func(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) (basic_string.h:<span class="hljs-number"><span class="hljs-number">1932</span></span>) n0: <span class="hljs-number"><span class="hljs-number">42966</span></span> <span class="hljs-number"><span class="hljs-number">0x10947A</span></span>: main (main.cpp:<span class="hljs-number"><span class="hljs-number">18</span></span>) n0: <span class="hljs-number"><span class="hljs-number">0</span></span> in <span class="hljs-number"><span class="hljs-number">2</span></span> places, all below massif's threshold (<span class="hljs-number"><span class="hljs-number">1.00</span></span>%) n0: <span class="hljs-number"><span class="hljs-number">2152</span></span> in <span class="hljs-number"><span class="hljs-number">10</span></span> places, all below massif's threshold (<span class="hljs-number"><span class="hljs-number">1.00</span></span>%)</code> </pre> <br></div></div><br>  Dapat dilihat bahwa massif mampu mendeteksi kebocoran pada fungsinya, tetapi sejauh ini tidak jelas di mana.  Mari kita membangun kembali program dengan <b>flag -fno-inline</b> dan menjalankan analisis lagi <br><br><div class="spoiler">  <b class="spoiler_title">massif</b> <div class="spoiler_text"><pre> <code class="cpp hljs">time=<span class="hljs-number"><span class="hljs-number">3160199549</span></span> mem_heap_B=<span class="hljs-number"><span class="hljs-number">345142</span></span> mem_heap_extra_B=<span class="hljs-number"><span class="hljs-number">65986</span></span> mem_stacks_B=<span class="hljs-number"><span class="hljs-number">0</span></span> heap_tree=detailed n4: <span class="hljs-number"><span class="hljs-number">345142</span></span> (heap allocation functions) <span class="hljs-built_in"><span class="hljs-built_in">malloc</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">new</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[], --alloc-fns, etc. n1: <span class="hljs-number"><span class="hljs-number">221616</span></span> <span class="hljs-number"><span class="hljs-number">0x10CDBC</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::_Rb_tree_node&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::pair&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::__cxx11::basic_string&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::char_traits&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>&gt;, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::allocator&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>&gt; &gt; &gt; &gt;* <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::_Rb_tree&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::pair&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::__cxx11::basic_string&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::char_traits&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>&gt;, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::allocator&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>&gt; &gt; &gt;, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::_Select1st&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::pair&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::__cxx11::basic_string&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::char_traits&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>&gt;, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::allocator&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>&gt; &gt; &gt; &gt;, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::less&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::allocator&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::pair&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::__cxx11::basic_string&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::char_traits&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>&gt;, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::allocator&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>&gt; &gt; &gt; &gt; &gt;::_M_create_node&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">piecewise_construct_t</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>&amp;, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::tuple&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>&amp;&gt;, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::tuple&lt;&gt; &gt;(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">piecewise_construct_t</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>&amp;, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::tuple&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>&amp;&gt;&amp;&amp;, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::tuple&lt;&gt;&amp;&amp;) [clone .isra<span class="hljs-number"><span class="hljs-number">.81</span></span>] (stl_tree.h:<span class="hljs-number"><span class="hljs-number">653</span></span>) n1: <span class="hljs-number"><span class="hljs-number">221616</span></span> <span class="hljs-number"><span class="hljs-number">0x10CE0C</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::_Rb_tree_iterator&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::pair&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::__cxx11::basic_string&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::char_traits&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>&gt;, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::allocator&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>&gt; &gt; &gt; &gt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::_Rb_tree&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::pair&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::__cxx11::basic_string&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::char_traits&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>&gt;, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::allocator&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>&gt; &gt; &gt;, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::_Select1st&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::pair&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::__cxx11::basic_string&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::char_traits&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>&gt;, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::allocator&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>&gt; &gt; &gt; &gt;, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::less&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::allocator&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::pair&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::__cxx11::basic_string&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::char_traits&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>&gt;, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::allocator&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>&gt; &gt; &gt; &gt; &gt;::_M_emplace_hint_unique&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">piecewise_construct_t</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>&amp;, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::tuple&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>&amp;&gt;, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::tuple&lt;&gt; &gt;(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::_Rb_tree_const_iterator&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::pair&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::__cxx11::basic_string&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::char_traits&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>&gt;, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::allocator&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>&gt; &gt; &gt; &gt;, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">piecewise_construct_t</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>&amp;, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::tuple&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>&amp;&gt;&amp;&amp;, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::tuple&lt;&gt;&amp;&amp;) [clone .constprop<span class="hljs-number"><span class="hljs-number">.87</span></span>] (stl_tree.h:<span class="hljs-number"><span class="hljs-number">2414</span></span>) n1: <span class="hljs-number"><span class="hljs-number">221616</span></span> <span class="hljs-number"><span class="hljs-number">0x10CF2B</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">map</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::__cxx11::basic_string&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::char_traits&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>&gt;, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::allocator&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>&gt; &gt;, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::less&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::allocator&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::pair&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::__cxx11::basic_string&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::char_traits&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>&gt;, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::allocator&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>&gt; &gt; &gt; &gt; &gt;::<span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>[](<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>&amp;) (stl_map.h:<span class="hljs-number"><span class="hljs-number">499</span></span>) n1: <span class="hljs-number"><span class="hljs-number">221616</span></span> <span class="hljs-number"><span class="hljs-number">0x10A7F5</span></span>: func(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) (func.cpp:<span class="hljs-number"><span class="hljs-number">20</span></span>) n0: <span class="hljs-number"><span class="hljs-number">221616</span></span> <span class="hljs-number"><span class="hljs-number">0x109F8E</span></span>: main (main.cpp:<span class="hljs-number"><span class="hljs-number">18</span></span>) n1: <span class="hljs-number"><span class="hljs-number">72704</span></span> <span class="hljs-number"><span class="hljs-number">0x52BA414</span></span>: ??? (in /usr/lib/x86_64-linux-gnu/libstdc++.so<span class="hljs-number"><span class="hljs-number">.6</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.25</span></span>) n1: <span class="hljs-number"><span class="hljs-number">72704</span></span> <span class="hljs-number"><span class="hljs-number">0x4010731</span></span>: _dl_init (dl-init.c:<span class="hljs-number"><span class="hljs-number">72</span></span>) n1: <span class="hljs-number"><span class="hljs-number">72704</span></span> <span class="hljs-number"><span class="hljs-number">0x40010C8</span></span>: ??? (in /lib/x86_64-linux-gnu/ld<span class="hljs-number"><span class="hljs-number">-2.27</span></span>.so) n1: <span class="hljs-number"><span class="hljs-number">72704</span></span> <span class="hljs-number"><span class="hljs-number">0x0</span></span>: ??? n1: <span class="hljs-number"><span class="hljs-number">72704</span></span> <span class="hljs-number"><span class="hljs-number">0x1FFF0000D1</span></span>: ??? n0: <span class="hljs-number"><span class="hljs-number">72704</span></span> <span class="hljs-number"><span class="hljs-number">0x1FFF0000E1</span></span>: ??? n2: <span class="hljs-number"><span class="hljs-number">48670</span></span> <span class="hljs-number"><span class="hljs-number">0x10B866</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::__cxx11::basic_string&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::char_traits&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>&gt;, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::allocator&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>&gt; &gt;::_M_mutate(<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>*, <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>) (basic_string.tcc:<span class="hljs-number"><span class="hljs-number">317</span></span>) n1: <span class="hljs-number"><span class="hljs-number">48639</span></span> <span class="hljs-number"><span class="hljs-number">0x10BB2C</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::__cxx11::basic_string&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::char_traits&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>&gt;, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::allocator&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>&gt; &gt;::_M_replace(<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>*, <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>) (basic_string.tcc:<span class="hljs-number"><span class="hljs-number">466</span></span>) n1: <span class="hljs-number"><span class="hljs-number">48639</span></span> <span class="hljs-number"><span class="hljs-number">0x10A643</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::__cxx11::basic_string&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::char_traits&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>&gt;, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::allocator&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>&gt; &gt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>+&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::char_traits&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>&gt;, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::allocator&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>&gt; &gt;(<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>*, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::__cxx11::basic_string&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::char_traits&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>&gt;, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::allocator&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>&gt; &gt;&amp;&amp;) [clone .constprop<span class="hljs-number"><span class="hljs-number">.86</span></span>] (basic_string.h:<span class="hljs-number"><span class="hljs-number">6018</span></span>) n1: <span class="hljs-number"><span class="hljs-number">48639</span></span> <span class="hljs-number"><span class="hljs-number">0x10A7E5</span></span>: func(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) (func.cpp:<span class="hljs-number"><span class="hljs-number">20</span></span>) n0: <span class="hljs-number"><span class="hljs-number">48639</span></span> <span class="hljs-number"><span class="hljs-number">0x109F8E</span></span>: main (main.cpp:<span class="hljs-number"><span class="hljs-number">18</span></span>) n0: <span class="hljs-number"><span class="hljs-number">31</span></span> in <span class="hljs-number"><span class="hljs-number">1</span></span> place, below massif's threshold (<span class="hljs-number"><span class="hljs-number">1.00</span></span>%) n0: <span class="hljs-number"><span class="hljs-number">2152</span></span> in <span class="hljs-number"><span class="hljs-number">10</span></span> places, all below massif's threshold (<span class="hljs-number"><span class="hljs-number">1.00</span></span>%)</code> </pre> <br></div></div><br>  Sekarang sudah jelas di mana letak kebocoran dalam menambahkan elemen peta.  Massif dapat mendeteksi objek berumur pendek, jadi manipulasi dengan std :: deque tidak terlihat dalam dump ini. <br><br><h3>  Heapdump </h3><br>  Agar google heapdump berfungsi, Anda perlu menautkan atau memuat <b>pramuka</b> perpustakaan <b>tcmalloc</b> .  Perpustakaan ini menggantikan fungsi standar alokasi memori malloc, gratis, ... Juga, dapat mengumpulkan informasi tentang penggunaan fungsi-fungsi ini, yang akan kita gunakan untuk menganalisis program. <br><br>  Karena metode ini bekerja sangat lambat (bahkan dibandingkan dengan massif), saya sarankan Anda segera menonaktifkan kompilasi fungsi dengan opsi <b>-fno-inline</b> saat mengkompilasi.  Jadi, kami membangun kembali aplikasi kami dan berjalan bersama tim <br><pre> <code class="bash hljs">HEAPPROFILESIGNAL=23 HEAPPROFILE=./heap ./test_profiler 100000000</code> </pre> <br>  Di sini diasumsikan bahwa pustaka tcmalloc ditautkan ke aplikasi kita. <br><br>  Sekarang, kita menunggu beberapa waktu yang diperlukan untuk pembentukan kebocoran yang nyata, dan mengirimkan sinyal kepada proses kita 23 <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">kill</span></span> -23 &lt;pid&gt;</code> </pre> <br>  Akibatnya, sebuah file bernama heap.0001.heap muncul, yang kami konversi ke format callgrind dengan perintah <br><br><pre> <code class="bash hljs">pprof ./test_profiler <span class="hljs-string"><span class="hljs-string">"./heap.0001.heap"</span></span> --inuse_space --callgrind &gt; callgrind.out.4</code> </pre> <br>  Juga perhatikan opsi pprof.  Anda dapat memilih dari opsi <b>inuse_space</b> , <b>inuse_objects</b> , <b>alokasi_space</b> , <b>alokasi_objects</b> , yang menunjukkan ruang atau objek yang sedang digunakan, atau ruang dan objek yang dialokasikan untuk seluruh durasi program, masing-masing.  Kami tertarik pada opsi inuse_space, yang menunjukkan ruang memori yang saat ini digunakan. <br><br>  Buka kCacheGrind favorit kami dan lihat <br> <a href=""><img src="https://habrastorage.org/webt/of/z2/j8/ofz2j88agvmi4bhfyhigracbn-i.png"></a> <br>  std :: map telah memakan terlalu banyak memori.  Mungkin ada kebocoran di dalamnya. <br><br><h2>  Kesimpulan </h2><br>  Membuat profil di C ++ adalah tugas yang sangat sulit.  Di sini kita harus berurusan dengan fungsi inlining, instruksi yang tidak didukung, hasil yang salah, dll.  Tidak selalu mungkin untuk mempercayai hasil profiler. <br><br>  Selain fungsi yang diusulkan di atas, ada alat-alat lain yang dirancang untuk profil - perf, intel VTune dan lainnya.  Tetapi mereka juga menunjukkan beberapa kekurangan ini.  Oleh karena itu, jangan lupa tentang metode "kakek" dalam membuat profil dengan mengukur waktu eksekusi fungsi dan menampilkannya dalam log. <br><br>  Juga, jika Anda memiliki teknik yang menarik untuk membuat profil kode Anda, silakan mempostingnya di komentar </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id482040/">https://habr.com/ru/post/id482040/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id482028/index.html">Dua tombol merah, besi solder dan React: bagaimana kami membuat langkah untuk konferensi IT</a></li>
<li><a href="../id482030/index.html">Vue.js: Kait siklus hidup komponen Anda dan pihak ketiga</a></li>
<li><a href="../id482032/index.html">Kami bermain dengan api: kami menjalankan kode arbitrer pada pengembangan iPhone 7</a></li>
<li><a href="../id482034/index.html">Yandex: ada segalanya ... tentang pengguna</a></li>
<li><a href="../id482038/index.html">Kami merangkum hasil 2019 di Haber Career</a></li>
<li><a href="../id482042/index.html">Bekerja dengan pustaka Newtonsoft.Json dengan contoh nyata. Bagian 2</a></li>
<li><a href="../id482044/index.html">10 praktik terbaik untuk mengamankan gambar Docker. Bagian 2</a></li>
<li><a href="../id482050/index.html">Teknik reduksi jaringan konvolusi Jedi - pemangkasan</a></li>
<li><a href="../id482052/index.html">Dataset Tahun Baru 2019: kamus nada terbuka bahasa Rusia</a></li>
<li><a href="../id482054/index.html">3. Tumpukan elastis: analisis log keamanan. Dasbor</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>