<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ¤¦ğŸ¼ ğŸ¶ ğŸ¨ RPC-åœ¨C ++ 14/17ä¸­å°è¯•æ–°çš„æœºä¼š ğŸµ ğŸ¤±ğŸ» ğŸŒ§ï¸</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="å‡ å¹´å‰ï¼ŒC ++å¼€å‘äººå‘˜æ”¶åˆ°äº†æœŸå¾…å·²ä¹…çš„C ++ 11æ ‡å‡†ï¼Œè¯¥æ ‡å‡†å¸¦æ¥äº†è®¸å¤šæ–°äº‹ç‰©ã€‚ æˆ‘æœ‰å…´è¶£å¿«é€Ÿå°†å…¶ç”¨äºæ—¥å¸¸ä»»åŠ¡ã€‚ è½¬åˆ°C ++ 14å’Œ17ï¼Œè¿™ä¸æ˜¯ã€‚ ä¼¼ä¹æ²¡æœ‰ä¸€äº›æœ‰è¶£çš„åŠŸèƒ½ã€‚ åœ¨æ˜¥å­£ï¼Œæˆ‘å†³å®šç ”ç©¶è¯­è¨€çš„åˆ›æ–°å¹¶å°è¯•ä¸€äº›å°è¯•ã€‚ è¦å°è¯•åˆ›æ–°ï¼Œæ‚¨å¿…é¡»è‡ªå·±å®Œæˆä¸€é¡¹ä»»åŠ¡ã€‚ æˆ‘æ²¡æƒ³å¤šä¹…ã€‚ å†³å®šä½¿ç”¨è‡ªå®šä¹‰æ•°æ®ç»“æ„...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>RPC-åœ¨C ++ 14/17ä¸­å°è¯•æ–°çš„æœºä¼š</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/421001/"><img src="https://habrastorage.org/webt/r5/fg/-w/r5fg-wsld9ujbwxghq54s-kpaso.jpeg" width="250" height="180" align="left"> å‡ å¹´å‰ï¼ŒC ++å¼€å‘äººå‘˜æ”¶åˆ°äº†æœŸå¾…å·²ä¹…çš„C ++ 11æ ‡å‡†ï¼Œè¯¥æ ‡å‡†å¸¦æ¥äº†è®¸å¤šæ–°äº‹ç‰©ã€‚ æˆ‘æœ‰å…´è¶£å¿«é€Ÿå°†å…¶ç”¨äºæ—¥å¸¸ä»»åŠ¡ã€‚ è½¬åˆ°C ++ 14å’Œ17ï¼Œè¿™ä¸æ˜¯ã€‚ ä¼¼ä¹æ²¡æœ‰ä¸€äº›æœ‰è¶£çš„åŠŸèƒ½ã€‚ åœ¨æ˜¥å­£ï¼Œæˆ‘å†³å®šç ”ç©¶è¯­è¨€çš„åˆ›æ–°å¹¶å°è¯•ä¸€äº›å°è¯•ã€‚ è¦å°è¯•åˆ›æ–°ï¼Œæ‚¨å¿…é¡»è‡ªå·±å®Œæˆä¸€é¡¹ä»»åŠ¡ã€‚ æˆ‘æ²¡æƒ³å¤šä¹…ã€‚ å†³å®šä½¿ç”¨è‡ªå®šä¹‰æ•°æ®ç»“æ„ä½œä¸ºå‚æ•°ç¼–å†™RPCï¼Œè€Œæ— éœ€ä½¿ç”¨å®å’Œä»£ç ç”Ÿæˆ-æ‰€æœ‰è¿™äº›éƒ½ä½¿ç”¨C ++ã€‚ è¿™è¦å½’åŠŸäºè¯¥è¯­è¨€çš„æ–°åŠŸèƒ½ã€‚ <br><br> æƒ³æ³•ï¼Œå®æ–½ï¼ŒRedditçš„åé¦ˆï¼Œæ”¹è¿›-ä¸€åˆ‡éƒ½åœ¨æ˜¥å­£ï¼Œåˆå¤å‡ºç°ã€‚ æœ€ç»ˆï¼Œä»–ä»¬è®¾æ³•å®Œæˆäº†æœ‰å…³Habrçš„æ–‡ç« ã€‚ <br><br> æ‚¨æ˜¯å¦è€ƒè™‘è¿‡è‡ªå·±çš„RPCï¼Ÿ ä¹Ÿè®¸å¸–å­çš„å†…å®¹å°†å¸®åŠ©æ‚¨ç¡®å®šç›®æ ‡ï¼Œæ–¹æ³•ï¼Œæ‰‹æ®µå¹¶å†³å®šæ˜¯å¦æ”¯æŒå·²å®Œæˆçš„ç›®æ ‡æˆ–è‡ªå·±å®ç°æŸäº›ç›®æ ‡... <br><a name="habracut"></a><br><h1> å¼•è¨€ </h1><br>  RPCï¼ˆè¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼‰ä¸æ˜¯ä¸€ä¸ªæ–°ä¸»é¢˜ã€‚ æœ‰è®¸å¤šä¸åŒç¼–ç¨‹è¯­è¨€çš„å®ç°ã€‚ å®ç°ä½¿ç”¨å„ç§æ•°æ®æ ¼å¼å’Œä¼ è¾“æ¨¡å¼ã€‚ æ‰€æœ‰è¿™äº›éƒ½å¯ä»¥ä½“ç°åœ¨ä»¥ä¸‹å‡ ç‚¹ï¼š <br><br><ul><li> åºåˆ—åŒ–/ååºåˆ—åŒ– </li><li> äº¤é€šè¿è¾“ </li><li> è¿œç¨‹æ–¹æ³•æ‰§è¡Œ </li><li> è¿”å›ç»“æœ </li></ul><br> å®æ–½å–å†³äºæ‰€éœ€çš„ç›®æ ‡ã€‚ ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥ä¸ºè‡ªå·±è®¾å®šç›®æ ‡ï¼Œä»¥ç¡®ä¿é«˜é€Ÿè°ƒç”¨è¿œç¨‹æ–¹æ³•å¹¶ç‰ºç‰²å¯ç”¨æ€§ï¼Œåä¹‹äº¦ç„¶ï¼Œä»è€Œä¸ºç¼–å†™ä»£ç æä¾›æœ€å¤§çš„èˆ’é€‚åº¦ï¼Œè€Œå¯èƒ½ä¼šé™ä½æ€§èƒ½ã€‚ ç›®æ ‡å’Œå·¥å…·æ˜¯ä¸åŒçš„â€¦â€¦æˆ‘æƒ³è¦èˆ’é€‚å’Œå¯æ¥å—çš„æ€§èƒ½ã€‚ <br><br><h1> å®ä½œ </h1><br> ä»¥ä¸‹æ˜¯åœ¨C ++ 14/17ä¸­å®ç°RPCçš„ä¸€äº›æ­¥éª¤ï¼Œé‡ç‚¹æ”¾åœ¨å¯¼è‡´è¯¥ææ–™å‡ºç°çš„ä¸€äº›è¯­è¨€åˆ›æ–°ä¸Šã€‚ <br><br> è¯¥ææ–™ä¾›é‚£äº›å‡ºäºæŸç§åŸå› å¯¹RPCæ„Ÿå…´è¶£ï¼Œå¹¶ä¸”å¯èƒ½åˆ°ç›®å‰ä¸ºæ­¢éœ€è¦æ›´å¤šä¿¡æ¯çš„ç”¨æˆ·ä½¿ç”¨ã€‚ åœ¨è¯„è®ºä¸­ï¼Œçœ‹åˆ°æè¿°å…¶ä»–é¢ä¸´ç±»ä¼¼ä»»åŠ¡çš„å¼€å‘äººå‘˜çš„ç»å†ä¼šå¾ˆæœ‰è¶£ã€‚ <br><br><h2> åºåˆ—åŒ– </h2><br> åœ¨å¼€å§‹ç¼–å†™ä»£ç ä¹‹å‰ï¼Œæˆ‘å°†å½¢æˆä¸€ä¸ªä»»åŠ¡ï¼š <br><br><ul><li> æ‰€æœ‰æ–¹æ³•å‚æ•°å’Œè¿”å›çš„ç»“æœéƒ½é€šè¿‡å…ƒç»„ä¼ é€’ã€‚ </li><li> è¢«è°ƒç”¨çš„æ–¹æ³•æœ¬èº«æ²¡æœ‰ä¹‰åŠ¡æ¥å—å’Œè¿”å›å…ƒç»„ã€‚ </li><li> æ‰“åŒ…å…ƒç»„çš„ç»“æœåº”è¯¥æ˜¯æ ¼å¼ä¸å›ºå®šçš„ç¼“å†²åŒº </li></ul><br> ä»¥ä¸‹æ˜¯ç®€åŒ–çš„å­—ç¬¦ä¸²åºåˆ—åŒ–ç¨‹åºä»£ç ã€‚ <br><br><div class="spoiler">  <b class="spoiler_title">string_serializer</b> <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> rpc::type { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> buffer = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>&gt;; } <span class="hljs-comment"><span class="hljs-comment">// namespace rpc::type namespace rpc::packer { class string_serializer final { public: template &lt;typename ... T&gt; type::buffer save(std::tuple&lt;T ... &gt; const &amp;tuple) const { auto str = to_string(tuple, std::make_index_sequence&lt;sizeof ... (T)&gt;{}); return {begin(str), end(str)}; } template &lt;typename ... T&gt; void load(type::buffer const &amp;buffer, std::tuple&lt;T ... &gt; &amp;tuple) const { std::string str{begin(buffer), end(buffer)}; from_string(std::move(str), tuple, std::make_index_sequence&lt;sizeof ... (T)&gt;{}); } private: template &lt;typename T, std::size_t ... I&gt; std::string to_string(T const &amp;tuple, std::index_sequence&lt;I ... &gt;) const { std::stringstream stream; auto put_item = [&amp;stream] (auto const &amp;i) { if constexpr (std::is_same_v&lt;std::decay_t&lt;decltype(i)&gt;, std::string&gt;) stream &lt;&lt; std::quoted(i) &lt;&lt; ' '; else stream &lt;&lt; i &lt;&lt; ' '; }; (put_item(std::get&lt;I&gt;(tuple)), ... ); return std::move(stream.str()); } template &lt;typename T, std::size_t ... I&gt; void from_string(std::string str, T &amp;tuple, std::index_sequence&lt;I ... &gt;) const { std::istringstream stream{std::move(str)}; auto get_item = [&amp;stream] (auto &amp;i) { if constexpr (std::is_same_v&lt;std::decay_t&lt;decltype(i)&gt;, std::string&gt;) stream &gt;&gt; std::quoted(i); else stream &gt;&gt; i; }; (get_item(std::get&lt;I&gt;(tuple)), ... ); } }; } // namespace rpc::packer</span></span></code> </pre> </div></div><br> ä¸»è¦åŠŸèƒ½ä»£ç æ¼”ç¤ºäº†ä¸²è¡Œå™¨çš„æ“ä½œã€‚ <br><br><div class="spoiler">  <b class="spoiler_title">ä¸»è¦åŠŸèƒ½</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::tuple args{<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>{<span class="hljs-string"><span class="hljs-string">"Test string !!!"</span></span>}, <span class="hljs-number"><span class="hljs-number">3.14</span></span>}; rpc::packer::string_serializer serializer; <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> pack = serializer.save(args); <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">cout</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">"Pack data: "</span></span> &lt;&lt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>{begin(pack), end(pack)} &lt;&lt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">endl</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">decltype</span></span>(args) params; serializer.load(pack, params); <span class="hljs-comment"><span class="hljs-comment">// For test { auto pack = serializer.save(params); std::cout &lt;&lt; "Deserialized pack: " &lt;&lt; std::string{begin(pack), end(pack)} &lt;&lt; std::endl; } } catch (std::exception const &amp;e) { std::cerr &lt;&lt; "Error: " &lt;&lt; e.what() &lt;&lt; std::endl; return EXIT_FAILURE; } return EXIT_SUCCESS; }</span></span></code> </pre></div></div><br>  <b>è®¤å¯çš„å£éŸ³</b> <br><br> é¦–å…ˆï¼Œæ‚¨éœ€è¦ç¡®å®šç”¨äºæ‰§è¡Œæ•´ä¸ªæ•°æ®äº¤æ¢çš„ç¼“å†²åŒºï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> rpc::type { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> buffer = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>&gt;; } <span class="hljs-comment"><span class="hljs-comment">// namespace rpc::type</span></span></code> </pre><br> åºåˆ—åŒ–ç¨‹åºå…·æœ‰å°†å…ƒç»„ä¿å­˜åˆ°ç¼“å†²åŒºï¼ˆä¿å­˜ï¼‰å¹¶ä»ç¼“å†²åŒºä¸­åŠ è½½ï¼ˆåŠ è½½ï¼‰æ–¹æ³•ã€‚ <br><br>  saveæ–¹æ³•é‡‡ç”¨ä¸€ä¸ªå…ƒç»„å¹¶è¿”å›ä¸€ä¸ªç¼“å†²åŒºã€‚ <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> ... T&gt; type::<span class="hljs-function"><span class="hljs-function">buffer </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">save</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::tuple&lt;T ... &gt; </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> &amp;tuple)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> str = to_string(tuple, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::make_index_sequence&lt;<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span> ... (T)&gt;{}); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> {begin(str), end(str)}; }</code> </pre><br> å…ƒç»„æ˜¯å…·æœ‰å¯å˜æ•°é‡çš„å‚æ•°çš„æ¨¡æ¿ã€‚ è¿™ç§æ¨¡å¼å‡ºç°åœ¨C ++ 11ä¸­ï¼Œå¹¶ä¸”è¿è¡Œè‰¯å¥½ã€‚ åœ¨è¿™é‡Œï¼Œæ‚¨éœ€è¦ä»¥æŸç§æ–¹å¼éå†æ­¤ç±»æ¨¡æ¿çš„æ‰€æœ‰å…ƒç´ ã€‚ å¯èƒ½æœ‰å‡ ç§é€‰æ‹©ã€‚ æˆ‘å°†ä½¿ç”¨C ++ 14çš„åŠŸèƒ½ä¹‹ä¸€-æ•´æ•°åºåˆ—ï¼ˆç´¢å¼•ï¼‰ã€‚  make_index_sequenceç±»å‹å·²å‡ºç°åœ¨æ ‡å‡†åº“ä¸­ï¼Œè¯¥åº“å…è®¸è·å–ä»¥ä¸‹åºåˆ—ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">... </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Ints</span></span></span><span class="hljs-class"> &gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">integer_sequence</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">N</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">using</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">make_integer_sequence</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">:</span></span>:integer_sequence&lt;T, <span class="hljs-comment"><span class="hljs-comment">/* a sequence 0, 1, 2, ..., N-1 */</span></span> &gt;; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> N&gt; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> make_index_sequence = make_integer_sequence&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>, N&gt;;</code> </pre><br> å¯ä»¥åœ¨C ++ 11ä¸­å®ç°ç±»ä¼¼çš„åŠŸèƒ½ï¼Œç„¶åå°†å…¶ä»ä¸€ä¸ªé¡¹ç›®ç§»æ¤åˆ°å¦ä¸€ä¸ªé¡¹ç›®ã€‚ <br><br> è¿™æ ·çš„ç´¢å¼•åºåˆ—ä½¿â€œéå†â€å…ƒç»„æˆä¸ºå¯èƒ½ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> ... I&gt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-function"><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">to_string</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(T </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> &amp;tuple, </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::index_sequence&lt;I ... &gt;)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">stringstream</span></span> stream; <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> put_item = [&amp;stream] (<span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> &amp;i) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::is_same_v&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">decay_t</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">decltype</span></span>(i)&gt;, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;) stream &lt;&lt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::quoted(i) &lt;&lt; <span class="hljs-string"><span class="hljs-string">' '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> stream &lt;&lt; i &lt;&lt; <span class="hljs-string"><span class="hljs-string">' '</span></span>; }; (put_item(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::get&lt;I&gt;(tuple)), ... ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move(stream.str()); }</code> </pre><br>  to_stringæ–¹æ³•ä½¿ç”¨æœ€æ–°çš„C ++æ ‡å‡†çš„å¤šä¸ªåŠŸèƒ½ã€‚ <br><br>  <b>è®¤å¯çš„å£éŸ³</b> <br><br> åœ¨C ++ 14ä¸­ï¼Œå¯ä»¥å°†autoç”¨ä½œlambdaå‡½æ•°çš„å‚æ•°ã€‚ ä¾‹å¦‚ï¼Œå½“ä½¿ç”¨æ ‡å‡†åº“çš„ç®—æ³•æ—¶ï¼Œè¿™é€šå¸¸æ˜¯ä¸å¤Ÿçš„ã€‚ <br><br>  <b>å·ç§¯</b>å‡ºç°åœ¨C ++ 17ä¸­ï¼Œå®ƒå…è®¸æ‚¨ç¼–å†™å¦‚ä¸‹ä»£ç ï¼š <br><br><pre> <code class="cpp hljs">(put_item(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::get&lt;I&gt;(tuple)), ... );</code> </pre><br> åœ¨ç»™å®šçš„ç‰‡æ®µä¸­ï¼Œä¸ºä¼ è¾“çš„å…ƒç»„çš„æ¯ä¸ªå…ƒç´ è°ƒç”¨put_item lambdaå‡½æ•°ã€‚ è¿™æ ·å¯ä»¥ä¿è¯åºåˆ—ç‹¬ç«‹äºå¹³å°å’Œç¼–è¯‘å™¨ã€‚ ç±»ä¼¼çš„ä¸œè¥¿å¯ä»¥ç”¨C ++ 11ç¼–å†™ã€‚ <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> â€¦ T&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">unused</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(T &amp;&amp; â€¦ )</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-comment"><span class="hljs-comment">// ... unused(put_item(std::get&lt;I&gt;(tuple)) ... );</span></span></code> </pre><br> ä½†æ˜¯å…ƒç´ çš„å­˜å‚¨é¡ºåºå–å†³äºç¼–è¯‘å™¨ã€‚ <br><br> è®¸å¤šåˆ«åå‡ºç°åœ¨C ++ 17æ ‡å‡†åº“ä¸­ï¼Œä¾‹å¦‚ï¼Œdelay_tï¼Œå®ƒå‡å°‘äº†ä»¥ä¸‹å½¢å¼çš„è®°å½•ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> decay&lt;T&gt;::type</code> </pre><br> å†™è¾ƒçŸ­çš„ç»“æ„çš„æ„¿æœ›æ˜¯å­˜åœ¨çš„ã€‚ æ¨¡æ¿è®¾è®¡åœ¨ä¸€è¡Œä¸­æ‰¾åˆ°äº†ä¸¤ä¸ªç±»å‹åå’Œæ¨¡æ¿ï¼Œå¹¶ç”¨å†’å·å’Œå°–æ‹¬å·éš”å¼€ï¼Œçœ‹èµ·æ¥ä»¤äººæ¯›éª¨æ‚šç„¶ã€‚ ä½ æ€ä¹ˆèƒ½å“åˆ°ä½ çš„ä¸€äº›åŒäº‹ã€‚ å°†æ¥ï¼Œä»–ä»¬æ‰¿è¯ºå‡å°‘æ‚¨éœ€è¦ç¼–å†™æ¨¡æ¿ï¼ˆç±»å‹åï¼‰çš„ä½ç½®ã€‚ <br><br> å¯¹ç®€æ´çš„æ¸´æœ›ä¸ºè¯­è¨€â€œ if constexprâ€æä¾›äº†å¦ä¸€ç§æœ‰è¶£çš„æ„é€ ï¼Œä»è€Œé¿å…äº†ç¼–å†™æ¨¡æ¿çš„è®¸å¤šç§æœ‰ä¸“ä¸šçŸ¥è¯†ã€‚ <br><br> æœ‰ä¸€ä¸ªæœ‰è¶£çš„è§‚ç‚¹ã€‚ è®¸å¤šäººè¢«æ•™å¯¼å¼€å…³å’Œç±»ä¼¼çš„æ„é€ åœ¨ä»£ç å¯ä¼¸ç¼©æ€§æ–¹é¢ä¸æ˜¯å¾ˆå¥½ã€‚ æœ€å¥½ä½¿ç”¨è¿è¡Œæ—¶/ç¼–è¯‘æ—¶å¤šæ€æ€§å’Œå¸¦æœ‰å‚æ•°çš„é‡è½½ï¼Œä»¥æ”¯æŒâ€œæ­£ç¡®çš„é€‰æ‹©â€ã€‚ ç„¶åæ˜¯â€œå¦‚æœæ˜¯constexprâ€â€¦â€¦ç´§å‡‘çš„å¯èƒ½æ€§å¹¶ä¸ä¼šè®©æ¯ä¸ªäººéƒ½å¯¹å®ƒæ— åŠ¨äºè¡·ã€‚ è¯­è¨€çš„å¯èƒ½æ€§å¹¶ä¸æ„å‘³ç€éœ€è¦ä½¿ç”¨å®ƒã€‚ <br><br> æœ‰å¿…è¦ä¸ºå­—ç¬¦ä¸²ç±»å‹ç¼–å†™ä¸€ä¸ªå•ç‹¬çš„åºåˆ—åŒ–ã€‚ ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ï¼Œä¿å­˜åˆ°æµä¸­å¹¶ä»ä¸­è¯»å–æ—¶ï¼Œä¼šå‡ºç°std ::å¼•å·å‡½æ•°ã€‚ å®ƒä½¿æ‚¨å¯ä»¥ç­›é€‰å­—ç¬¦ä¸²ï¼Œå¹¶å¯ä»¥ä¿å­˜åˆ°æµä¸­å¹¶ä»ä¸­åŠ è½½æ—¥æœŸï¼Œè€Œæ— éœ€è€ƒè™‘åˆ†éš”ç¬¦ã€‚ <br><br> æ‚¨ç°åœ¨å¯ä»¥åœæ­¢åºåˆ—åŒ–çš„æè¿°ã€‚ ååºåˆ—åŒ–ï¼ˆè´Ÿè½½ï¼‰çš„å®ç°æ–¹å¼ä¸æ­¤ç±»ä¼¼ã€‚ <br><br><h2> äº¤é€šè¿è¾“ </h2><br> è¿è¾“å¾ˆç®€å•ã€‚ è¿™æ˜¯ä¸€ä¸ªæ¥æ”¶å¹¶è¿”å›ç¼“å†²åŒºçš„å‡½æ•°ã€‚ <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> rpc::type { <span class="hljs-comment"><span class="hljs-comment">// ... using executor = std::function&lt;buffer (buffer)&gt;; } // namespace rpc::type</span></span></code> </pre><br> ä½¿ç”¨std :: bindï¼Œlambdaå‡½æ•°ç­‰å½¢æˆè¿™æ ·çš„å¯¹è±¡â€œæ‰§è¡Œç¨‹åºâ€ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»»ä½•ä¼ è¾“å®ç°ã€‚ å°†ä¸è€ƒè™‘æ­¤èŒä½å†…çš„è¿è¾“å®æ–½ç»†èŠ‚ã€‚ æ‚¨å¯ä»¥æŸ¥çœ‹å®Œæˆçš„RPCå®ç°ï¼Œæœ€åå°†æä¾›æŒ‡å‘è¯¥é“¾æ¥çš„é“¾æ¥ã€‚ <br><br><h2> é¡¾å®¢ </h2><br> ä»¥ä¸‹æ˜¯æµ‹è¯•å®¢æˆ·ç«¯ä»£ç ã€‚ å®¢æˆ·ç«¯ä¼šç”Ÿæˆè¯·æ±‚ï¼Œå¹¶è€ƒè™‘åˆ°æ‰€é€‰çš„ä¼ è¾“ï¼Œå°†å…¶å‘é€åˆ°æœåŠ¡å™¨ã€‚ åœ¨ä¸‹é¢çš„æµ‹è¯•ä»£ç ä¸­ï¼Œæ‰€æœ‰å®¢æˆ·ç«¯è¯·æ±‚éƒ½æ˜¾ç¤ºåœ¨æ§åˆ¶å°ä¸Šã€‚ åœ¨ä¸‹ä¸€æ­¥çš„å®æ–½ä¸­ï¼Œå®¢æˆ·ç«¯å°†å·²ç»ä¸æœåŠ¡å™¨ç›´æ¥é€šä¿¡ã€‚ <br><br><div class="spoiler">  <b class="spoiler_title">é¡¾å®¢</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> rpc { <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> TPacker&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">client</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">final</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">result</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: client(type::executor executor) : executor_{executor} { } <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> ... TArgs&gt; <span class="hljs-function"><span class="hljs-function">result </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> &amp;func_name, TArgs &amp;&amp; ... args)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> request = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::make_tuple(func_name, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::forward&lt;TArgs&gt;(args) ... ); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> pack = packer_.save(request); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> responce = executor_(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move(pack)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> {responce}; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> packer_type = TPacker; packer_type packer_; type::executor executor_; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">result</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">final</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: result(type::buffer buffer) : buffer_{<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move(buffer)} { } <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">auto</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">as</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::tuple&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">decay_t</span></span>&lt;T&gt;&gt; tuple; packer_.load(buffer_, tuple); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::get&lt;<span class="hljs-number"><span class="hljs-number">0</span></span>&gt;(tuple)); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: packer_type packer_; type::buffer buffer_; }; }; } <span class="hljs-comment"><span class="hljs-comment">// namespace rpc</span></span></code> </pre></div></div><br> å®¢æˆ·ç«¯è¢«å®ç°ä¸ºæ¨¡æ¿ç±»ã€‚  templateå‚æ•°æ˜¯ä¸€ä¸ªåºåˆ—åŒ–å™¨ã€‚ å¦‚æœ‰å¿…è¦ï¼Œå¯ä»¥ä¸åœ¨æ¨¡æ¿1ä¸­é‡åšè¯¥ç±»ï¼Œå¹¶å°†å®ç°åºåˆ—åŒ–å™¨çš„å¯¹è±¡ä¼ é€’ç»™æ„é€ å‡½æ•°ã€‚ <br><br> åœ¨å½“å‰çš„å®ç°ä¸­ï¼Œç±»æ„é€ å‡½æ•°æ¥å—ä¸€ä¸ªæ‰§è¡Œå¯¹è±¡ã€‚ æ‰¿åŒ…å•†å°†ä¼ è¾“çš„å®ç°éšè—åœ¨è‡ªå·±çš„å†…éƒ¨ï¼Œå¹¶ä¸”ä½¿ä»£ç åœ¨è¿™ä¸€ç‚¹ä¸Šæœ‰å¯èƒ½ä¸è€ƒè™‘åœ¨è¿›ç¨‹ä¹‹é—´äº¤æ¢æ•°æ®çš„æ–¹æ³•ã€‚ åœ¨æµ‹è¯•ç”¨ä¾‹ä¸­ï¼Œä¼ è¾“å®ç°å°†è¯·æ±‚æ˜¾ç¤ºåˆ°æ§åˆ¶å°ã€‚ <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> executor = [] (rpc::type::buffer buffer) { <span class="hljs-comment"><span class="hljs-comment">// Print request data std::cout &lt;&lt; "Request pack: " &lt;&lt; std::string{begin(buffer), end(buffer)} &lt;&lt; std::endl; return buffer; };</span></span></code> </pre><br> è‡ªå®šä¹‰ä»£ç å°šæœªå°è¯•åˆ©ç”¨å®¢æˆ·çš„å·¥ä½œæˆæœï¼Œå› ä¸ºæ²¡æœ‰åœ°æ–¹å¯ä»¥ä»ä¸­è·å–ã€‚ <br><br>  <b>å®¢æˆ·ç«¯è°ƒç”¨æ–¹æ³•ï¼š</b> <br><br><ul><li> ä½¿ç”¨åºåˆ—åŒ–ç¨‹åºæ‰“åŒ…è¢«è°ƒç”¨æ–¹æ³•çš„åç§°åŠå…¶å‚æ•° </li><li> ä½¿ç”¨æ‰§è¡Œå¯¹è±¡å°†è¯·æ±‚å‘é€åˆ°æœåŠ¡å™¨å¹¶æ¥æ”¶å“åº” </li><li> å°†æ¥æ”¶åˆ°çš„å“åº”ä¼ é€’ç»™æ£€ç´¢æ¥æ”¶åˆ°çš„ç»“æœçš„ç±» </li></ul><br> åŸºæœ¬å®¢æˆ·ç«¯å®ç°å·²å‡†å¤‡å°±ç»ªã€‚ å‰©ä¸‹çš„ä¸œè¥¿ã€‚ ç¨åå†è¯¦ç»†ä»‹ç»ã€‚ <br><br><h2> ä¼ºæœå™¨ </h2><br> åœ¨å¼€å§‹è€ƒè™‘æœåŠ¡å™¨ç«¯çš„å®ç°ç»†èŠ‚ä¹‹å‰ï¼Œæˆ‘å»ºè®®å¿«é€Ÿï¼Œæ–œç€åœ°çœ‹ä¸€ä¸‹å®Œæ•´çš„å®¢æˆ·ç«¯-æœåŠ¡å™¨äº¤äº’ç¤ºä¾‹ã€‚ <br><br> ä¸ºç®€å•èµ·è§ï¼Œæ¼”ç¤ºå…¨éƒ¨åœ¨ä¸€ä¸ªè¿‡ç¨‹ä¸­è¿›è¡Œã€‚ ä¼ è¾“å®ç°æ˜¯ä¸€ä¸ªlambdaå‡½æ•°ï¼Œè¯¥å‡½æ•°åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´ä¼ é€’ç¼“å†²åŒºã€‚ <br><br><div class="spoiler">  <b class="spoiler_title">å®¢æˆ·ç«¯-æœåŠ¡å™¨äº¤äº’ã€‚</b>  <b class="spoiler_title">æµ‹è¯•ç”¨ä¾‹</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;cstdint&gt; #include &lt;cstdlib&gt; #include &lt;functional&gt; #include &lt;iomanip&gt; #include &lt;iostream&gt; #include &lt;map&gt; #include &lt;sstream&gt; #include &lt;string&gt; #include &lt;tuple&gt; #include &lt;vector&gt; #include &lt;utility&gt; namespace rpc::type { using buffer = std::vector&lt;char&gt;; using executor = std::function&lt;buffer (buffer)&gt;; } // namespace rpc::type namespace rpc::detail { template &lt;typename&gt; struct function_meta; template &lt;typename TRes, typename ... TArgs&gt; struct function_meta&lt;std::function&lt;TRes (TArgs ... )&gt;&gt; { using result_type = std::decay_t&lt;TRes&gt;; using args_type = std::tuple&lt;std::decay_t&lt;TArgs&gt; ... &gt;; using request_type = std::tuple&lt;std::string, std::decay_t&lt;TArgs&gt; ... &gt;; }; } // namespace rpc::detail namespace rpc::packer { class string_serializer final { public: template &lt;typename ... T&gt; type::buffer save(std::tuple&lt;T ... &gt; const const &amp;tuple) const { auto str = to_string(tuple, std::make_index_sequence&lt;sizeof ... (T)&gt;{}); return {begin(str), end(str)}; } template &lt;typename ... T&gt; void load(type::buffer const &amp;buffer, std::tuple&lt;T ... &gt; &amp;tuple) const { std::string str{begin(buffer), end(buffer)}; from_string(std::move(str), tuple, std::make_index_sequence&lt;sizeof ... (T)&gt;{}); } private: template &lt;typename T, std::size_t ... I&gt; std::string to_string(T const &amp;tuple, std::index_sequence&lt;I ... &gt;) const { std::stringstream stream; auto put_item = [&amp;stream] (auto const &amp;i) { if constexpr (std::is_same_v&lt;std::decay_t&lt;decltype(i)&gt;, std::string&gt;) stream &lt;&lt; std::quoted(i) &lt;&lt; ' '; else stream &lt;&lt; i &lt;&lt; ' '; }; (put_item(std::get&lt;I&gt;(tuple)), ... ); return std::move(stream.str()); } template &lt;typename T, std::size_t ... I&gt; void from_string(std::string str, T &amp;tuple, std::index_sequence&lt;I ... &gt;) const { std::istringstream stream{std::move(str)}; auto get_item = [&amp;stream] (auto &amp;i) { if constexpr (std::is_same_v&lt;std::decay_t&lt;decltype(i)&gt;, std::string&gt;) stream &gt;&gt; std::quoted(i); else stream &gt;&gt; i; }; (get_item(std::get&lt;I&gt;(tuple)), ... ); } }; } // namespace rpc::packer namespace rpc { template &lt;typename TPacker&gt; class client final { private: class result; public: client(type::executor executor) : executor_{executor} { } template &lt;typename ... TArgs&gt; result call(std::string const &amp;func_name, TArgs &amp;&amp; ... args) { auto request = std::make_tuple(func_name, std::forward&lt;TArgs&gt;(args) ... ); auto pack = packer_.save(request); auto responce = executor_(std::move(pack)); return {responce}; } private: using packer_type = TPacker; packer_type packer_; type::executor executor_; class result final { public: result(type::buffer buffer) : buffer_{std::move(buffer)} { } template &lt;typename T&gt; auto as() const { std::tuple&lt;std::decay_t&lt;T&gt;&gt; tuple; packer_.load(buffer_, tuple); return std::move(std::get&lt;0&gt;(tuple)); } private: packer_type packer_; type::buffer buffer_; }; }; template &lt;typename TPacker&gt; class server final { public: template &lt;typename ... THandler&gt; server(std::pair&lt;char const *, THandler&gt; const &amp; ... handlers) { auto make_executor = [&amp;packer = packer_] (auto const &amp;handler) { auto executor = [&amp;packer, function = std::function{handler}] (type::buffer buffer) { using meta = detail::function_meta&lt;std::decay_t&lt;decltype(function)&gt;&gt;; typename meta::request_type request; packer.load(buffer, request); auto response = std::apply([&amp;function] (std::string const &amp;, auto &amp;&amp; ... args) { return function(std::forward&lt;decltype(args)&gt;(args) ... ); }, std::move(request) ); return packer.save(std::make_tuple(std::move(response))); }; return executor; }; (handlers_.emplace(handlers.first, make_executor(handlers.second)), ... ); } type::buffer execute(type::buffer buffer) { std::tuple&lt;std::string&gt; pack; packer_.load(buffer, pack); auto func_name = std::move(std::get&lt;0&gt;(pack)); auto const iter = handlers_.find(func_name); if (iter == end(handlers_)) throw std::runtime_error{"Function \"" + func_name + "\" not found."}; return iter-&gt;second(std::move(buffer)); } private: using packer_type = TPacker; packer_type packer_; using handlers_type = std::map&lt;std::string, type::executor&gt;; handlers_type handlers_; }; } // namespace rpc int main() { try { using packer_type = rpc::packer::string_serializer; rpc::server&lt;packer_type&gt; server{ std::pair{"hello", [] (std::string const &amp;s) { std::cout &lt;&lt; "Func: \"hello\". Inpur string: " &lt;&lt; s &lt;&lt; std::endl; return "Hello " + s + "!"; }}, std::pair{"to_int", [] (std::string const &amp;s) { std::cout &lt;&lt; "Func: \"to_int\". Inpur string: " &lt;&lt; s &lt;&lt; std::endl; return std::stoi(s); }} }; auto executor = [&amp;server] (rpc::type::buffer buffer) { return server.execute(std::move(buffer)); }; rpc::client&lt;packer_type&gt; client{std::move(executor)}; std::cout &lt;&lt; client.call("hello", std::string{"world"}).as&lt;std::string&gt;() &lt;&lt; std::endl; std::cout &lt;&lt; "Convert to int: " &lt;&lt; client.call("to_int", std::string{"100500"}).as&lt;int&gt;() &lt;&lt; std::endl; } catch (std::exception const &amp;e) { std::cerr &lt;&lt; "Error: " &lt;&lt; e.what() &lt;&lt; std::endl; return EXIT_FAILURE; } return EXIT_SUCCESS; }</span></span></span></span></code> </pre></div></div><br> åœ¨æœåŠ¡å™¨ç±»çš„ä¸Šè¿°å®ç°ä¸­ï¼Œæœ€æœ‰è¶£çš„æ˜¯å®ƒçš„æ„é€ å‡½æ•°å’Œexecuteæ–¹æ³•ã€‚ <br><br>  <b>æœåŠ¡å™¨ç±»æ„é€ å‡½æ•°</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> ... THandler&gt; server(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::pair&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> *, THandler&gt; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> &amp; ... handlers) { <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> make_executor = [&amp;packer = packer_] (<span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> &amp;handler) { <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> executor = [&amp;packer, function = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::function{handler}] (type::buffer buffer) { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> meta = detail::function_meta&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">decay_t</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">decltype</span></span>(function)&gt;&gt;; <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> meta::request_type request; packer.load(buffer, request); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> response = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::apply([&amp;function] (<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> &amp;, <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> &amp;&amp; ... args) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> function(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::forward&lt;<span class="hljs-keyword"><span class="hljs-keyword">decltype</span></span>(args)&gt;(args) ... ); }, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move(request) ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> packer.save(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::make_tuple(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move(response))); }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> executor; }; (handlers_.emplace(handlers.first, make_executor(handlers.second)), ... ); }</code> </pre><br> è¯¥ç±»çš„æ„é€ å‡½æ•°æ˜¯æ ·æ¿ã€‚ åœ¨è¾“å…¥å¤„ï¼ŒåŒ…å«ä¸€å¯¹å¯¹çš„åˆ—è¡¨ã€‚ æ¯å¯¹éƒ½æ˜¯ä¸€ä¸ªæ–¹æ³•åç§°å’Œä¸€ä¸ªå¤„ç†ç¨‹åºã€‚ è€Œä¸”ç”±äºæ„é€ å‡½æ•°æ˜¯å¸¦æœ‰å¯å˜æ•°é‡å‚æ•°çš„æ¨¡æ¿ï¼Œå› æ­¤åœ¨åˆ›å»ºæœåŠ¡å™¨å¯¹è±¡æ—¶ï¼Œå°†ç«‹å³æ³¨å†ŒæœåŠ¡å™¨ä¸Šæ‰€æœ‰å¯ç”¨çš„å¤„ç†ç¨‹åºã€‚ è¿™æ ·å°±å¯ä»¥é¿å…åœ¨æœåŠ¡å™¨å¤„ç†ç¨‹åºä¸Šè°ƒç”¨å…¶ä»–æ³¨å†Œæ–¹æ³•ã€‚ è¿›è€Œä½¿äººä»¬ä¸å¿…è€ƒè™‘æœåŠ¡å™¨ç±»å¯¹è±¡æ˜¯å¦å°†åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ä½¿ç”¨ä»¥åŠæ˜¯å¦éœ€è¦åŒæ­¥ã€‚ <br><br>  <b>æœåŠ¡å™¨ç±»çš„æ„é€ å‡½æ•°çš„ä¸€ä¸ªç‰‡æ®µ</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> ... THandler&gt; server(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::pair&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> *, THandler&gt; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> &amp; ... handlers) { <span class="hljs-comment"><span class="hljs-comment">// â€¦ (handlers_.emplace(handlers.first, make_executor(handlers.second)), ... ); }</span></span></code> </pre><br> å°†å¤§é‡ä¼ é€’çš„å¼‚æ„å¤„ç†ç¨‹åºæ”¾å…¥ç›¸åŒç±»å‹çš„å‡½æ•°æ˜ å°„ä¸­ã€‚ ä¸ºæ­¤ï¼Œè¿˜ä½¿ç”¨äº†å·ç§¯ï¼Œè¿™ä½¿å¾—è½»æ¾åœ°å°†std ::æ˜ å°„æ•´ä¸ªä¼ é€’çš„å¤„ç†ç¨‹åºé›†æ”¾åœ¨ä¸€è¡Œä¸­è€Œæ²¡æœ‰å¾ªç¯å’Œç®—æ³• <br><br><pre> <code class="cpp hljs">(handlers_.emplace(handlers.first, make_executor(handlers.second)), ... );</code> </pre><br> å…è®¸å°†autoç”¨ä½œå‚æ•°çš„Lambdaå‡½æ•°ä½¿åœ¨å¤„ç†ç¨‹åºä¸Šå®ç°ç›¸åŒç±»å‹çš„åŒ…è£…å™¨å˜å¾—å®¹æ˜“ã€‚ ç›¸åŒç±»å‹çš„åŒ…è£…åœ¨æœåŠ¡å™¨ä¸Šå¯ç”¨æ–¹æ³•çš„æ˜ å°„ä¸­æ³¨å†Œï¼ˆstd :: mapï¼‰ã€‚ å¤„ç†è¯·æ±‚æ—¶ï¼Œå°†åœ¨æ­¤ç±»å¡ä¸Šæ‰§è¡Œæœç´¢ï¼Œå¹¶ä¸”ç›¸åŒçš„å¤„ç†ç¨‹åºå°†è°ƒç”¨æ‰¾åˆ°çš„å¤„ç†ç¨‹åºï¼Œè€Œä¸ç®¡æ¥æ”¶åˆ°çš„å‚æ•°å’Œè¿”å›çš„ç»“æœå¦‚ä½•ã€‚ æ ‡å‡†åº“ä¸­å‡ºç°çš„std :: applyå‡½æ•°ä½¿ç”¨ä½œä¸ºå…ƒç»„ä¼ é€’çš„å‚æ•°è°ƒç”¨ä¼ é€’ç»™å®ƒçš„å‡½æ•°ã€‚  std :: applyå‡½æ•°ä¹Ÿå¯ä»¥åœ¨C ++ 11ä¸­å®ç°ã€‚ ç°åœ¨ï¼Œå®ƒæ˜¯â€œå¼€ç®±å³ç”¨â€çš„ï¼Œæ— éœ€åœ¨é¡¹ç›®ä¹‹é—´è½¬ç§»ã€‚ <br><br>  <b>æ‰§è¡Œæ–¹æ³•</b> <br><br><pre> <code class="cpp hljs">type::<span class="hljs-function"><span class="hljs-function">buffer </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(type::buffer buffer)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::tuple&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; pack; packer_.load(buffer, pack); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> func_name = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::get&lt;<span class="hljs-number"><span class="hljs-number">0</span></span>&gt;(pack)); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> iter = handlers_.find(func_name); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (iter == end(handlers_)) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::runtime_error{<span class="hljs-string"><span class="hljs-string">"Function \""</span></span> + func_name + <span class="hljs-string"><span class="hljs-string">"\" not found."</span></span>}; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> iter-&gt;second(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move(buffer)); }</code> </pre><br> æ£€ç´¢è¢«è°ƒç”¨å‡½æ•°çš„åç§°ï¼Œåœ¨å·²æ³¨å†Œå¤„ç†ç¨‹åºçš„æ˜ å°„ä¸­æœç´¢æ–¹æ³•ï¼Œè°ƒç”¨å¤„ç†ç¨‹åºå¹¶è¿”å›ç»“æœã€‚ åœ¨æœåŠ¡å™¨ç±»çš„æ„é€ å‡½æ•°ä¸­å‡†å¤‡çš„åŒ…è£…å™¨ä¸­ï¼Œæ‰€æœ‰è¿™äº›éƒ½å¾ˆæœ‰è¶£ã€‚ å¯èƒ½æœ‰äººæ³¨æ„åˆ°äº†è¯¥å¼‚å¸¸ï¼Œä¹Ÿè®¸åˆå‡ºç°äº†ä¸€ä¸ªé—®é¢˜ï¼šâ€œå¼‚å¸¸æ˜¯å¦ä»¥æŸç§æ–¹å¼å¤„ç†ï¼Ÿâ€ æ˜¯çš„ï¼Œåœ¨å®Œæ•´çš„å®æ–½ä¸­ï¼ˆå°†åœ¨æœ€åæä¾›å‚è€ƒï¼‰ï¼Œæä¾›äº†å¼‚å¸¸å°é€å¤„ç†ã€‚ ä¸ºäº†ç®€åŒ–å†…å®¹ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´æ²¡æœ‰ä¼ é€’å¼‚å¸¸ã€‚ <br><br> å†çœ‹ä¸€ä¸‹åŠŸèƒ½ <br><br><div class="spoiler">  <b class="spoiler_title">ä¸»è¦çš„</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> packer_type = rpc::packer::string_serializer; rpc::server&lt;packer_type&gt; server{ <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::pair{<span class="hljs-string"><span class="hljs-string">"hello"</span></span>, [] (<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> &amp;s) { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">cout</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">"Func: \"hello\". Inpur string: "</span></span> &lt;&lt; s &lt;&lt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">endl</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Hello "</span></span> + s + <span class="hljs-string"><span class="hljs-string">"!"</span></span>; }}, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::pair{<span class="hljs-string"><span class="hljs-string">"to_int"</span></span>, [] (<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> &amp;s) { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">cout</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">"Func: \"to_int\". Inpur string: "</span></span> &lt;&lt; s &lt;&lt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">endl</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::stoi(s); }} }; <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> executor = [&amp;server] (rpc::type::buffer buffer) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> server.execute(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move(buffer)); }; rpc::client&lt;packer_type&gt; client{<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move(executor)}; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">cout</span></span> &lt;&lt; client.call(<span class="hljs-string"><span class="hljs-string">"hello"</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>{<span class="hljs-string"><span class="hljs-string">"world"</span></span>}).as&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;() &lt;&lt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">endl</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">cout</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">"Convert to int: "</span></span> &lt;&lt; client.call(<span class="hljs-string"><span class="hljs-string">"to_int"</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>{<span class="hljs-string"><span class="hljs-string">"100500"</span></span>}).as&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;() &lt;&lt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">endl</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::exception <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> &amp;e) { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">cerr</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">"Error: "</span></span> &lt;&lt; e.what() &lt;&lt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">endl</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> EXIT_FAILURE; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> EXIT_SUCCESS; }</code> </pre></div></div><br> å®ƒå®ç°äº†æˆç†Ÿçš„å®¢æˆ·ç«¯-æœåŠ¡å™¨äº¤äº’ã€‚ ä¸ºäº†ä¸ä½¿å†…å®¹å¤æ‚åŒ–ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨åœ¨ä¸€ä¸ªè¿‡ç¨‹ä¸­å·¥ä½œã€‚ æ›¿æ¢æ‰§è¡Œç¨‹åºçš„æ‰§è¡Œç¨‹åºï¼Œå¯ä»¥ä½¿ç”¨å¿…è¦çš„ä¼ è¾“æ–¹å¼ã€‚ <br><br> åœ¨C ++ 17æ ‡å‡†ä¸­ï¼Œæœ‰æ—¶å¯èƒ½åœ¨å®ä¾‹åŒ–æ—¶ä¸æŒ‡å®šæ¨¡æ¿å‚æ•°ã€‚ åœ¨ä¸Šé¢çš„ä¸»è¦åŠŸèƒ½ä¸­ï¼Œæ­¤åŠŸèƒ½åœ¨æ³¨å†ŒæœåŠ¡å™¨å¤„ç†ç¨‹åºï¼ˆä¸å¸¦æ¨¡æ¿å‚æ•°çš„std :: pairï¼‰æ—¶ä½¿ç”¨ï¼Œå¹¶ä½¿ä»£ç æ›´ç®€å•ã€‚ <br><br> åŸºæœ¬çš„RPCå®æ–½å·²å‡†å¤‡å°±ç»ªã€‚ ä»ç„¶æœ‰å¸Œæœ›å¢åŠ å°†è‡ªå®šä¹‰æ•°æ®ç»“æ„ä½œä¸ºå‚æ•°ä¼ é€’å¹¶è¿”å›ç»“æœçš„èƒ½åŠ›ã€‚ <br><br><h2> è‡ªå®šä¹‰æ•°æ®ç»“æ„ </h2><br> ä¸ºäº†è·¨è¿‡ç¨‹è¾¹ç•Œä¼ è¾“æ•°æ®ï¼Œéœ€è¦å°†å®ƒä»¬åºåˆ—åŒ–ä¸ºæŸç§ä¸œè¥¿ã€‚ ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥å°†æ‰€æœ‰å†…å®¹è¾“å‡ºåˆ°æ ‡å‡†æµã€‚ å¼€ç®±å³ç”¨å°†æä¾›å¾ˆå¤šæ”¯æŒã€‚ å¯¹äºè‡ªå®šä¹‰æ•°æ®ç»“æ„ï¼Œæ‚¨å°†å¿…é¡»è‡ªå·±å®ç°è¾“å‡ºè¿ç®—ç¬¦ã€‚ æ¯ä¸ªç»“æ„éƒ½éœ€è¦è‡ªå·±çš„è¾“å‡ºè¿ç®—ç¬¦ã€‚ æœ‰æ—¶æ‚¨ä¸æƒ³è¿™æ ·åšã€‚ è¦å¯¹ç»“æ„çš„æ‰€æœ‰å­—æ®µè¿›è¡Œæ’åºå¹¶å°†æ¯ä¸ªå­—æ®µè¾“å‡ºåˆ°æµï¼Œæ‚¨éœ€è¦ä¸€äº›é€šç”¨æ–¹æ³•ã€‚ åæ€å¯ä»¥å¾ˆå¥½åœ°å¸®åŠ©è¿™ä¸€ç‚¹ã€‚ åœ¨C ++ä¸­è¿˜æ²¡æœ‰ã€‚ æ‚¨å¯ä»¥æ±‚åŠ©äºä»£ç ç”Ÿæˆä»¥åŠå®å’Œæ¨¡æ¿çš„æ··åˆä½¿ç”¨ã€‚ ä½†æƒ³æ³•æ˜¯ä½¿åº“æ¥å£ä½¿ç”¨çº¯C ++ã€‚ <br><br>  C ++å°šæ— å®Œæ•´çš„ä½“ç°ã€‚ å› æ­¤ï¼Œä¸‹é¢çš„è§£å†³æ–¹æ¡ˆå¯ä»¥æœ‰ä¸€äº›é™åˆ¶ã€‚ <br><br> è¯¥è§£å†³æ–¹æ¡ˆåŸºäºå¯¹æ–°C ++ 17â€œç»“æ„åŒ–ç»‘å®šâ€åŠŸèƒ½çš„ä½¿ç”¨ã€‚ é€šå¸¸ï¼Œåœ¨å¯¹è¯æ¡†ä¸­æ‚¨ä¼šå‘ç°å¾ˆå¤šè¡Œè¯ï¼Œå› æ­¤æˆ‘æ‹’ç»ä½¿ç”¨ä¿„è¯­æä¾›æ­¤åŠŸèƒ½åç§°çš„ä»»ä½•é€‰é¡¹ã€‚ <br><br> ä¸‹é¢æ˜¯ä¸€ä¸ªè§£å†³æ–¹æ¡ˆï¼Œå…è®¸æ‚¨å°†å·²ä¼ è¾“æ•°æ®ç»“æ„çš„å­—æ®µä¼ è¾“åˆ°å…ƒç»„ã€‚ <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">auto</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">to_tuple</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(T &amp;&amp;value)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> type = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">decay_t</span></span>&lt;T&gt;; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">if</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">constexpr</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(is_braces_constructible_v&lt;type, dummy_type, dummy_type, dummy_type&gt;)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> &amp;&amp;[f1, f2, f3] = value; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::make_tuple(f1, f2, f3); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> (is_braces_constructible_v&lt;type, dummy_type, dummy_type&gt;) { <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> &amp;&amp;[f1, f2] = value; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::make_tuple(f1, f2); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> (is_braces_constructible_v&lt;type, dummy_type&gt;) { <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> &amp;&amp;[f1] = value; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::make_tuple(f1); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::make_tuple(); } }</code> </pre><br> åœ¨Internetä¸Šï¼Œæ‚¨å¯ä»¥æ‰¾åˆ°è®¸å¤šç±»ä¼¼çš„è§£å†³æ–¹æ¡ˆã€‚ <br><br> ä¸Šé¢è¯´äº†å¾ˆå¤šåœ¨è¿™é‡Œä½¿ç”¨çš„å†…å®¹ï¼Œé™¤äº†ç»“æ„åŒ–ç»‘å®šã€‚  to_tupleå‡½æ•°æ¥å—è‡ªå®šä¹‰ç±»å‹ï¼Œç¡®å®šå­—æ®µæ•°ï¼Œå¹¶å€ŸåŠ©ç»“æ„åŒ–ç»‘å®šå°†ç»“æ„å­—æ®µâ€œè½¬ç§»â€åˆ°å…ƒç»„ã€‚  â€œ if constexprâ€ä½¿æ‚¨å¯ä»¥é€‰æ‹©æ‰€éœ€çš„å®ç°åˆ†æ”¯ã€‚ ç”±äºC ++ä¸­æ²¡æœ‰åå°„ï¼Œå› æ­¤æ— æ³•æ„å»ºä¸€ä¸ªè€ƒè™‘ç±»å‹æ‰€æœ‰æ–¹é¢çš„å®Œæ•´è§£å†³æ–¹æ¡ˆã€‚ å¯¹ä½¿ç”¨çš„ç±»å‹æœ‰é™åˆ¶ã€‚ å…¶ä¸­ä¹‹ä¸€-ç±»å‹åº”è¯¥æ²¡æœ‰è‡ªå®šä¹‰æ„é€ å‡½æ•°ã€‚ <br><br>  To_tupleä½¿ç”¨is_braces_constructible_vã€‚ ä½¿ç”¨æ­¤ç±»å‹ï¼Œæ‚¨å¯ä»¥ç¡®å®šä½¿ç”¨èŠ±æ‹¬å·åˆå§‹åŒ–ä¼ è¾“çš„ç»“æ„å¹¶ç¡®å®šå­—æ®µæ•°çš„èƒ½åŠ›ã€‚ <br><br><div class="spoiler">  <b class="spoiler_title">is_braces_constructible_v</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dummy_type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">final</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constexpr</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">operator</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">T</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">noexcept</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> *<span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;T <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> *&gt;(<span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>); } }; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> ... TArgs&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constexpr</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">decltype</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">(T{</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::declval&lt;TArgs&gt;() ... }), </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::declval&lt;</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::true_type&gt;())</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is_braces_constructible</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">noexcept</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> ... &gt; <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-function"><span class="hljs-function">false_type </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is_braces_constructible</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(...)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">noexcept</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> ... TArgs&gt; <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> is_braces_constructible_v = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">decay_t</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">decltype</span></span>(is_braces_constructible&lt;T, TArgs ... &gt;(<span class="hljs-number"><span class="hljs-number">0</span></span>))&gt;::value;</code> </pre></div></div><br> ä¸Šé¢çš„to_tupleå‡½æ•°å¯ä»¥å°†åŒ…å«ä¸è¶…è¿‡ä¸‰ä¸ªå­—æ®µçš„ç”¨æˆ·æ•°æ®ç»“æ„è½¬æ¢ä¸ºå…ƒç»„ã€‚ ä¸ºäº†å¢åŠ ç»“æ„çš„â€œç§»ä½â€å­—æ®µçš„å¯èƒ½æ•°é‡ï¼Œæ‚¨å¯ä»¥å¤åˆ¶â€œ if constexprâ€åˆ†æ”¯ï¼Œä½†è¦æ³¨æ„ä¸€ç‚¹ï¼Œä¹Ÿå¯ä»¥ä¸ä½¿ç”¨æœ€ç®€å•çš„boost.preprocessoråº“ã€‚ å¦‚æœé€‰æ‹©ç¬¬äºŒä¸ªé€‰é¡¹ï¼Œåˆ™ä»£ç å°†å˜å¾—éš¾ä»¥é˜…è¯»ï¼Œå¹¶ä¸”å¯ä»¥ä½¿ç”¨å…·æœ‰å¤§é‡å­—æ®µçš„ç»“æ„ã€‚ <br><br><div class="spoiler">  <b class="spoiler_title">ç”¨boost.preprocessorå®ç°to_tuple</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">auto</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">to_tuple</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(T &amp;&amp;value)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> type = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">decay_t</span></span>&lt;T&gt;; <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> NANORPC_TO_TUPLE_LIMIT_FIELDS 64 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// you can try to use BOOST_PP_LIMIT_REPEAT #define NANORPC_TO_TUPLE_DUMMY_TYPE_N(_, n, data) \ BOOST_PP_COMMA_IF(n) data #define NANORPC_TO_TUPLE_PARAM_N(_, n, data) \ BOOST_PP_COMMA_IF(n) data ## n #define NANORPC_TO_TUPLE_ITEM_N(_, n, __) \ if constexpr (is_braces_constructible_v&lt;type, \ BOOST_PP_REPEAT_FROM_TO(0, BOOST_PP_SUB(NANORPC_TO_TUPLE_LIMIT_FIELDS, n), NANORPC_TO_TUPLE_DUMMY_TYPE_N, dummy_type) \ &gt;) { auto &amp;&amp;[ \ BOOST_PP_REPEAT_FROM_TO(0, BOOST_PP_SUB(NANORPC_TO_TUPLE_LIMIT_FIELDS, n), NANORPC_TO_TUPLE_PARAM_N, f) \ ] = value; return std::make_tuple( \ BOOST_PP_REPEAT_FROM_TO(0, BOOST_PP_SUB(NANORPC_TO_TUPLE_LIMIT_FIELDS, n), NANORPC_TO_TUPLE_PARAM_N, f) \ ); } else #define NANORPC_TO_TUPLE_ITEMS(n) \ BOOST_PP_REPEAT_FROM_TO(0, n, NANORPC_TO_TUPLE_ITEM_N, nil) NANORPC_TO_TUPLE_ITEMS(NANORPC_TO_TUPLE_LIMIT_FIELDS) { return std::make_tuple(); } #undef NANORPC_TO_TUPLE_ITEMS #undef NANORPC_TO_TUPLE_ITEM_N #undef NANORPC_TO_TUPLE_PARAM_N #undef NANORPC_TO_TUPLE_DUMMY_TYPE_N #undef NANORPC_TO_TUPLE_LIMIT_FIELDS }</span></span></span></span></code> </pre></div></div><br> å¦‚æœæ‚¨æ›¾ç»å°è¯•ä¸ºC ++ 03åšè¯¸å¦‚boost.bindä¹‹ç±»çš„äº‹æƒ…ï¼Œå…¶ä¸­â€‹â€‹æ‚¨ä¸å¾—ä¸ä½¿ç”¨ä¸åŒæ•°é‡çš„å‚æ•°è¿›è¡Œè®¸å¤šå®ç°ï¼Œé‚£ä¹ˆä½¿ç”¨boost.preprocessorå®ç°to_tupleä¼¼ä¹å¹¶ä¸å¥‡æ€ªæˆ–å¤æ‚ã€‚ <br><br> è€Œä¸”ï¼Œå¦‚æœåœ¨åºåˆ—åŒ–ç¨‹åºä¸­æ·»åŠ äº†å…ƒç»„æ”¯æŒï¼Œåˆ™to_tupleå‡½æ•°å°†å¯ç”¨ç”¨æˆ·æ•°æ®ç»“æ„çš„åºåˆ—åŒ–ã€‚ å¹¶ä¸”æœ‰å¯èƒ½å°†å®ƒä»¬ä½œä¸ºå‚æ•°å‡ºå–ï¼Œå¹¶åœ¨RPCä¸­è¿”å›ç»“æœã€‚ <br><br> é™¤äº†ç”¨æˆ·å®šä¹‰çš„æ•°æ®ç»“æ„å¤–ï¼ŒC ++è¿˜æœ‰å…¶ä»–å†…ç½®ç±»å‹ï¼Œè¿™äº›ç±»å‹æ— æ³•å®ç°å‘æ ‡å‡†æµçš„è¾“å‡ºã€‚ å‡å°‘æµä¸­é‡è½½è¾“å‡ºè¿ç®—ç¬¦æ•°é‡çš„éœ€æ±‚å¯¼è‡´äº†ä¸€ç§é€šç”¨ä»£ç ï¼Œè¯¥ä»£ç å…è®¸ä¸€ç§æ–¹æ³•æ¥å¤„ç†å¤§å¤šæ•°C ++å®¹å™¨ï¼Œä¾‹å¦‚std :: listï¼Œstd :: vectorï¼Œstd :: mapã€‚ åœ¨ä¸å¿˜è®°SFINAEå’Œstd :: enable_if_tçš„æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥ç»§ç»­æ‰©å±•åºåˆ—åŒ–å™¨ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæœ‰å¿…è¦ä»¥æŸç§æ–¹å¼é—´æ¥ç¡®å®šç±»å‹çš„å±æ€§ï¼Œè¿™ä¸åœ¨is_braces_constructible_vçš„å®ç°ä¸­ç±»ä¼¼ã€‚ <br><br><h1> ç»“è®º </h1><br>      , ,  stl-   .          ,       RPC          â€”    C++ 14 / 17.           HTTP / HTTPS      . <br><br>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">NanoRPC  GitHub</a> . <br><br> æ„Ÿè°¢æ‚¨çš„å…³æ³¨ï¼ <br></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN421001/">https://habr.com/ru/post/zh-CN421001/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt486174/index.html">Tenho rotatividade zero</a></li>
<li><a href="../zh-CN420993/index.html">åˆ›å»ºæœåŠ¡å™¨ä»¥æµ‹è¯•android RESTè¯·æ±‚çš„5ä¸ªç®€å•æ­¥éª¤</a></li>
<li><a href="../zh-CN420995/index.html">æˆ‘ä»¬åœ¨ä¸¤ç§’é’Ÿå†…é€‰æ‹©å°åº¦TINçš„å¯†ç ï¼Œæˆ–è€…ä¸ºä»€ä¹ˆè¦ä½¿ç”¨è›®åŠ›æ•°å­¦</a></li>
<li><a href="../zh-CN420997/index.html">KDD 2018ï¼Œç¬¬å››å¤©ï¼Œè¯ºè´å°”å¥–è·å¾—è€…</a></li>
<li><a href="../zh-CN420999/index.html">åŸºç»´ Xamarin ååº”æœ¬æœºã€‚ ä¸‰ä¸ªæ¡†æ¶-ä¸€ä¸ªå®éªŒï¼ˆç¬¬2éƒ¨åˆ†ï¼‰</a></li>
<li><a href="../zh-CN421005/index.html">RESTä¿è¯ï¼šæœ‰ç”¨çš„æŠ€å·§</a></li>
<li><a href="../zh-CN421007/index.html">å½•éŸ³æœº-å½•åˆ¶è‡ªåŠ¨æµ‹è¯•çš„å·¥å…·</a></li>
<li><a href="../zh-CN421009/index.html">8æœˆ25æ—¥è‡³26æ—¥ï¼šåœ¨çº¿è¿è¥ç®¡ç†ä¼šè®®</a></li>
<li><a href="../zh-CN421011/index.html">æ‚¨è®¤ä¸ºåœ¨é‡‡è®¿ä¸­çš„é—®é¢˜å¾ˆæ„šè ¢ã€‚ ä½†ä¸æ˜¯çœŸçš„</a></li>
<li><a href="../zh-CN421015/index.html">2018å¹´å…¨å›½äº’è”ç½‘ç»†åˆ†å¸‚åœºå¯æŒç»­å‘å±•è°ƒæŸ¥</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>