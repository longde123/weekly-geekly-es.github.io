<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü¶ë ü§Ω üëÖ Bot f√ºr die √úberwachung von Webdiensten in einer halben Stunde: Telegramm + Bash + Cron „ÄΩÔ∏è üçú üî∑</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Manchmal m√ºssen Sie schnell eine √úberwachung f√ºr einen neuen Dienst durchf√ºhren, aber es steht keine vorgefertigte Infrastruktur / Expertise zur Verf√º...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Bot f√ºr die √úberwachung von Webdiensten in einer halben Stunde: Telegramm + Bash + Cron</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/483318/"><img src="https://habrastorage.org/webt/ks/-r/l9/ks-rl9jvsn3vka3r5kxkj4jvbxg.jpeg"><br><br>  Manchmal m√ºssen Sie schnell eine √úberwachung f√ºr einen neuen Dienst durchf√ºhren, aber es steht keine vorgefertigte Infrastruktur / Expertise zur Verf√ºgung.  In diesem Handbuch implementieren wir in einer halben Stunde ein Tool zum √úberwachen von Webdiensten, das nur die integrierten Ubuntu-Tools verwendet: bash, cron und curl.  Wir werden Telegramm verwenden, um Warnungen zu liefern. <br><br>  "Cherry on the cake" wird die emotionale Beteiligung der Benutzer sein.  Es wird auf Menschen √ºberpr√ºft - es funktioniert. <br><a name="habracut"></a><br>  Als wir im Telemedizin-Service von Doctor Near einen Chatbot erstellt haben, um den Grad des Benutzerstresses zu bestimmen, mussten wir ihn √ºberwachen.  In wenigen Stunden wurde ein Miniprojekt erstellt, das nicht nur gro√üartig funktioniert, sondern auch positive R√ºckmeldungen liefert. <br><br>  Holen Sie sich zun√§chst ein Repository mit Skripten: <br><br><pre><code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/rshekhovtsov/msms.git</code> </pre> <br>  Gehen Sie zum Ordner msms und arbeiten Sie darin. <br><br>  Wenn das Telegramm blockiert ist, verwenden Sie einen Proxy.  Die einfachste und zuverl√§ssigste Option sind Torsocks: <br><br><pre> <code class="bash hljs">sudo apt install tor sudo apt install torsocks</code> </pre> <br>  Als Beispiel konfigurieren wir die √úberwachung der Startseite von google.com in drei Schritten. <br><br><h2>  SCHRITT 1. Erstellen Sie einen Bot im Telegramm und erhalten Sie die Benutzer-ID </h2><br><ul><li>  Suchen Sie in der Kontaktsuche im Telegramm nach <a href="https://t.me/botfather" rel="nofollow">@botfather</a> : <br><br><img src="https://habrastorage.org/webt/mf/8r/tx/mf8rtxrovcs-4r8ax2pn7fuxusc.png"><br></li><li>  Wir starten es mit der Schaltfl√§che Start, geben den Befehl / newbot ein und beantworten Fragen.  Sie m√ºssen ber√ºcksichtigen, dass name der Name des Bots ist, der den Benutzern angezeigt wird, und dass username eindeutig ist und mit "bot" enden muss: <br><br><img src="https://habrastorage.org/webt/gc/q5/fx/gcq5fxjht5xytwso83degwhmslm.png"><br><br>  Unter anderem gibt der Bot ein geheimes Token f√ºr die HTTP-API aus, das Sie kopieren und in der Datei telegram-api-key.txt im Ordner msms speichern m√ºssen. <br></li><li>  Wir geben den Namen unseres Bots in die Telegramm-Suchzeile ein und f√ºhren ihn aus. <br></li><li>  F√ºgen Sie sich abschlie√üend der Liste der Empf√§nger von √úberwachungsalarmen hinzu: <br><br><pre> <code class="bash hljs">sudo chmod +x ./recipients-setup.sh torsocks ./recipients-setup.sh</code> </pre> <br>  Das Skript zeigt eine Liste der letzten Aufrufe des Bots an. Es sollte eine Zeile mit unserer ID und unserem Namen im Telegramm geben.  Wir nehmen diese ID und speichern sie in der Datei services / google-recipient.txt.  Dateiformat: Jede Zeile hat eine ID.  Ein Beispiel: <br><br><pre> <code class="bash hljs">123456789 987654321</code> </pre> </li></ul><br>  Um einen neuen Empf√§nger hinzuzuf√ºgen, m√ºssen Sie ihn bitten, den Bot im Telegramm zu starten, recipient-setup.sh auszuf√ºhren und der Datei die ID hinzuzuf√ºgen. <br><br><h2>  SCHRITT 2. √úberwachung konfigurieren </h2><br>  Die Beschreibung des Dienstes erfolgt durch Erstellen einer INI-Datei im Ordner "servies".  Es m√ºssen f√ºnf Parameter eingestellt werden: <br><br><ol><li>  <b>MSMS_SERVICE_NAME</b> : <b>Dienstname</b> - wird in Warnungen und √úberwachungsprotokollen verwendet. </li><li>  <b>MSMS_SERVICE_ENDPOINT</b> : Der Endpunkt des Dienstes, mit dem wir uns bei curl on in Verbindung setzen. </li><li>  <b>MSMS_CURL_PARAMS</b> : Zus√§tzliche Curl-Parameter, siehe Beispiel unten. </li><li>  <b>MSMS_EXPECTED</b> : erwartete Serviceantwort.  Wird verwendet, wenn die Antwort kurz ist. </li><li>  <b>MSMS_EXPECTED_FILE</b> : Dateiname mit der erwarteten Serviceantwort.  Wenn angegeben, wird MSMS_EXPECTED √ºberschrieben. </li><li>  <b>MSMS_RECIPIENTS</b> : Datei mit einer Liste der Benachrichtigungsempf√§nger. </li></ol><br>  Die Anfrage auf google.com gibt einen festen HTML-Code mit einer Weiterleitung zur√ºck. Wir verwenden diesen als erwartete Serverantwort: <br><br><pre> <code class="bash hljs">curl google.com &gt; services/google-response.html</code> </pre> <br>  Erstellen Sie die Datei services / google.ini: <br><br><pre> <code class="bash hljs">MSMS_SERVICE_NAME=<span class="hljs-string"><span class="hljs-string">'google front page'</span></span> <span class="hljs-comment"><span class="hljs-comment"># service endpoint MSMS_SERVICE_ENDPOINT='google.com' # curl parameters MSMS_CURL_PARAMS='-s --connect-timeout 3 -m 7' # expected service response MSMS_EXPECTED_FILE='google-response.html' # recipients list file MSMS_RECIPIENTS='google-recipients.txt'</span></span></code> </pre> <br>  In <code>MSMS_CURL_PARAMS</code> Sie alles angeben, was Curl tun kann, einschlie√ülich: <br><br><ol><li>  Deaktivieren Sie die Curl-Meldungen, um die Konsole und das Protokoll nicht zu verstopfen: <code>-s</code> </li><li>  <code>--connect-timeout 3</code> Zeitlimit f√ºr die Verbindung mit dem zu √ºberpr√ºfenden Dienst ein (in Sekunden): <code>--connect-timeout 3</code> </li><li>  Antwort-Timeout einstellen: <code>-m 7</code> </li><li>  Deaktivieren Sie die Zertifikat√ºberpr√ºfung f√ºr SSL (z. B. wenn ein selbstsigniertes Zertifikat verwendet wird): - <code>--insecure</code> </li><li>  Geben Sie den Typ der http-Anforderung an: <code>-X POST</code> </li><li>  Geben Sie die √úberschriften an: <code>-H "Content-Type: application/json"</code> </li><li>  Geben Sie den Anforderungshauptteil als Zeichenfolge oder Datei an.  Beispiel f√ºr die Datei: <code>-d @request.json</code> </li></ol><br>  Wir haben Benachrichtigungen deaktiviert und eine Zeit√ºberschreitung von 3 Sekunden festgelegt.  bei Verbindung und 7 sek.  um eine Antwort vom Dienst zu erhalten. <br><br>  <b>Achtung</b> : Geben Sie die Parameterwerte wie im Beispiel in einfachen Anf√ºhrungszeichen an.  Leider ist Bash in diesem Sinne ziemlich zerbrechlich, und ein <s>versehentlich an die</s> falsche Stelle <s>geflogener Schmetterling</s> kann <s>mit</s> schwer zu diagnostizierenden Fehlern zum <s>Tod des Universums</s> f√ºhren. <br><br>  Wir richten die √úberwachung ein.  √úberpr√ºfen Sie, ob alles in Ordnung ist: <br><br><pre> <code class="bash hljs">sudo chmod +x ./monitoring.sh torsocks ./monitoring.sh</code> </pre> <br>  Das Skript sollte eine Nachricht des Formulars anzeigen: <br><br><pre> <code class="bash hljs">2020-01-10 12:14:31 health-check <span class="hljs-string"><span class="hljs-string">"google front page"</span></span>: OK</code> </pre> <br><h2>  SCHRITT 3. Passen Sie den Zeitplan an </h2><br>  Richten Sie einen √úberwachungsplan in cron ein: <br><br><pre> <code class="bash hljs">sudo crontab -e</code> </pre> <br>  F√ºgen Sie jede Minute eine Zeile hinzu, um google.com zu √ºberpr√ºfen: <br><br><pre> <code class="bash hljs">*/1 * * * * torsocks &lt;   &gt;/monitoring.sh &gt;&gt; &lt;   &gt;/monitoring.log 2&gt;&amp;1</code> </pre> <br>  F√ºgen Sie jeden Tag um 11.00 Uhr einen Alarm hinzu, um die √úberwachung selbst zu best√§tigen.  √úbergeben Sie dazu den Parameter DAILY an das Skript: <br><br><pre> <code class="bash hljs">0 11 * * * torsocks &lt;   &gt;/monitoring.sh DAILY &gt;&gt; &lt;   &gt;/monitoring.log 2&gt;&amp;1</code> </pre><br>  <code>2&gt;&amp;1</code> - Standardtechnik zur Umleitung von Fehlern in den Hauptausgabestream.  Infolgedessen werden sie auch in das √úberwachungsprotokoll aufgenommen. <br><br>  Speichern Sie die √Ñnderungen und rufen Sie sie mit dem folgenden Befehl auf: <br><br><pre> <code class="bash hljs"> sudo service cron reload</code> </pre> <br>  Weitere Informationen zum Konfigurieren von cron finden Sie beispielsweise <a href="https://losst.ru/nastrojka-cron" rel="nofollow">hier</a> . <br><br>  Daher wird jede Minute ein √úberwachungsskript gestartet, auf das √ºber gol auf google.com zugegriffen werden kann.  Wenn die empfangene Antwort von der erwarteten abweicht, sendet das Skript eine Benachrichtigung im Telegramm an die Empf√§ngerliste.  Das √úberwachungsprotokoll wird in der Datei monitoring.log verwaltet <br><br>  Wenn Sie einen weiteren Dienst hinzuf√ºgen m√ºssen, erstellen wir einfach eine neue Ini-Datei f√ºr diesen Dienst im Dienstordner und erstellen gegebenenfalls eine separate Empf√§ngerliste.  Alles andere wird automatisch funktionieren. <br><br>  Wenn der √ºberpr√ºfte Dienst nicht mehr verf√ºgbar ist, wird jede Minute eine Warnung gesendet.  Wenn Sie den Dienst nicht schnell wiederherstellen k√∂nnen, k√∂nnen Sie Benachrichtigungen in den Bot-Eigenschaften im Telegramm vor√ºbergehend deaktivieren. <br><br>  Schauen wir uns nun die zus√§tzlichen Funktionen und die Implementierung von Skripten genauer an. <br><br><h2>  Nachrichtenvorlagen und emotionales Engagement </h2><br>  Um die Kommunikation mit dem Bot lebendiger zu gestalten, haben wir ihn Manechka genannt, den entsprechenden Bild-Avatar hinzugef√ºgt und professionelle PR-Spezialisten mit der Erstellung von Nachrichtentexten beauftragt.  Sie k√∂nnen unsere Leistungen nutzen oder nach Ihrem Geschmack ver√§ndern. <br><br>  Zum Beispiel so: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/zs/kk/nd/zskkndbpynjm9l-o2ujyvblznlw.jpeg"></div><br>  oder auch so: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ul/nh/e3/ulnhe3lg9gypwy56x53sk-kuegm.png"></div><br>  Warum nicht? <br><br>  Der <a href="https://t.me/botfather" rel="nofollow">Botname</a> und der Avatar werden √ºber <a href="https://t.me/botfather" rel="nofollow">@botfather eingestellt</a> . <br>  Nachrichtenvorlagen befinden sich im <b>Vorlagenordner</b> : <br><br><ul><li>  <b>curl-fail.txt</b> : Nachricht, die gesendet wird, wenn curl einen Fehlercode ungleich Null <b>zur√ºckgibt</b> .  Spricht normalerweise √ºber die Unm√∂glichkeit, den Dienst zu erreichen. </li><li>  <b>daily.txt</b> : t√§gliche Nachricht, die best√§tigt, dass die <b>Dienst√ºberwachung</b> funktioniert. </li><li>  <b>service-fail.txt</b> : Nachricht gesendet, wenn die Serviceantwort anders als erwartet ist. </li></ul><br>  Lassen Sie uns die Anpassungsm√∂glichkeiten am Beispiel der eingebauten Nachrichtenvorlagen untersuchen. <br>  Die Vorlagen verwenden Emojis.  Habr zeigt sie leider nicht an. <br>  Um Emojis auszuw√§hlen, ist es bequem, die Suche auf <a href="https://emojipedia.org/" rel="nofollow">emojipedia.org zu verwenden</a> : <br><br><img src="https://habrastorage.org/webt/wj/uy/_3/wjuy_3icssro1d0hpptoe5xq91e.jpeg"><br><br>  Sie kopieren einfach das entsprechende Zeichen und f√ºgen es in den Text der Vorlage ein (dies ist der √ºbliche Unicode). <br><ol><li>  curl-fail.txt: <br><br><pre> <code class="bash hljs">,  ...      \<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$MSMS_SERVICE_NAME</span></span></span><span class="hljs-string">\" \`CURL EXIT CODE: </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$EXIT_CODE</span></span></span><span class="hljs-string">\`</span></span></code> </pre> <br>  Wir haben den von uns angegebenen <code>MSMS_SERVICE_NAME</code> ( <code>MSMS_SERVICE_NAME</code> Variable) und eine interne <code>MSMS_SERVICE_NAME</code> mit dem Curl-Beendigungscode ( <code>EXIT_CODE</code> ) verwendet.  Wir haben die Nachricht auch mit dem <a href="https://core.telegram.org/bots/api" rel="nofollow">Telegramm-Mark-Down-</a> Markup formatiert: Die Zeichen `` '' haben einen Rahmentext mit fester Breite.  Da Anf√ºhrungszeichen und Apostrophe offizielle Bash-Zeichen sind, werden sie mit dem Zeichen "\" maskiert.  Variablennamen wird ein "$" vorangestellt. <br><br>  Ergebnis: <br><br><img src="https://habrastorage.org/webt/po/zf/3n/pozf3neoa1bjqxslwqny1ocal2s.jpeg"><br></li><li>  service-fail.txt: <br><br><pre> <code class="bash hljs">,  ...  \<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$MSMS_SERVICE_NAME</span></span></span><span class="hljs-string">\"     ,     : \`</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$RESPONSE</span></span></span><span class="hljs-string">\`</span></span></code> </pre> <br>  Ergebnis: <br><br><img src="https://habrastorage.org/webt/kv/f1/tl/kvf1tlzbrmm3cqdpf70tnm0m2z4.jpeg"><br><br>  Hier verwenden wir eine andere <code>RESPONSE</code> : <code>RESPONSE</code> .  Es enth√§lt die Antwort des Dienstes. <br></li><li>  daily.txt: <br><br><pre> <code class="bash hljs">, !    , c  : \<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$MSMS_SERVICE_NAME</span></span></span><span class="hljs-string">\"  ...     ?</span></span></code> </pre><br>  Ergebnis: <br><br><img src="https://habrastorage.org/webt/qs/ox/r_/qsoxr_bkdi8qva9ms1xzwpxugxa.jpeg"><br></li></ol><br>  Fahren wir mit der Skriptimplementierung fort. <br><br><h2>  √úberwachungsskript </h2><br>  <b>monitoring.sh</b> macht die automatische Erkennung einfach - entnimmt alle ini-Dateien aus dem Ordner services und f√ºhrt f√ºr jede Datei das Hauptskript mit der Logik zum Pr√ºfen und Senden von Warnungen aus: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash cd $(dirname "$0")/services for service_ini in $(ls *.ini); do bash ../msms.sh "$1" "$service_ini" done</span></span></code> </pre> <br>  Um eine t√§gliche Nachricht √ºber den √úberwachungsstatus zu generieren, kann dem Skript der Parameter DAILY √ºbergeben werden. <br><br>  Bitte beachten Sie, dass beim Start des Skripts der aktuelle Ordner in Dienste ge√§ndert wird.  Dies erm√∂glicht es ini-Dateien, Dateipfade relativ zu Diensten anzugeben. <br><br><h2>  Skript zum Pr√ºfen und Versenden von Alarmen </h2><br>  <b>msms.sh</b> enth√§lt die grundlegende Logik zum √úberpr√ºfen eines Dienstes und zum Senden von Warnungen. <br><br>  Mit Telegramm arbeiten: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># telegram endpoint TG_API_URL="https://api.telegram.org/bot$(cat ../telegram-api-key.txt)/sendMessage" ################################################################# # send message to telegram # parameter: message text ################################################################# function send_message { for chat_id in $(cat ../$MSMS_RECIPIENTS); do curl -s -X POST --connect-timeout 10 $TG_API_URL -d chat_id=$chat_id -d parse_mode="Markdown" -d text="$1" echo done }</span></span></code> </pre><br>  Wir erstellen eine URL f√ºr den Zugriff auf die Telegramm-REST-API mit dem in der Datei gespeicherten privaten Schl√ºssel. <br><br>  Die Funktion send_message verwendet curl, um Nachrichten an diese REST-API zu senden. Dabei wird die Empf√§nger-ID aus der in ini angegebenen Datei √ºbernommen.  In den Daten, die wir senden, geben wir an, dass wir das Nachrichten-Markup verwenden: <code>parse_mode="Markdown"</code> . <br><br>  Drucken Sie die aktuelle Uhrzeit aus und laden Sie die Ini-Datei. <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> $(date <span class="hljs-string"><span class="hljs-string">'+%Y-%m-%d %H:%M:%S'</span></span>) <span class="hljs-comment"><span class="hljs-comment"># load variables from .ini file: . $2</span></span></code> </pre><br>  Die magische Linie <code>. $2</code>  <code>. $2</code> f√ºhrt die als zweiter Parameter √ºbergebene ini-Datei als normales Skript aus und tr√§gt die darin angegebenen Werte in Umgebungsvariablen ein. <br><br>  Laden Sie die erwartete Antwort aus der Datei herunter, wenn der Parameter <code>MSMS_EXPECTED_FILE</code> angegeben ist: <br><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ -n <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$MSMS_EXPECTED_FILE</span></span></span><span class="hljs-string">"</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> MSMS_EXPECTED=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$(cat "$MSMS_EXPECTED_FILE")</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span></code> </pre><br>  F√ºhren Sie bei Bedarf eine Servicepr√ºfung durch, indem Sie Warnmeldungen senden: <br><br><pre> <code class="bash hljs">RESPONSE=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$(eval curl $MSMS_CURL_PARAMS \"$MSMS_SERVICE_ENDPOINT\")</span></span></span><span class="hljs-string">"</span></span> EXIT_CODE=$? <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [[ <span class="hljs-variable"><span class="hljs-variable">$EXIT_CODE</span></span> != 0 ]]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> health-check \<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$MSMS_SERVICE_NAME</span></span></span><span class="hljs-string">\" FAILED: CURL EXIT WITH </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$EXIT_CODE</span></span></span><span class="hljs-string"> MESSAGE="</span></span>$(cat ../templates/curl-fail.txt)<span class="hljs-string"><span class="hljs-string">" MESSAGE=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$(eval echo $MESSAGE)</span></span></span><span class="hljs-string"> send_message "</span></span><span class="hljs-variable"><span class="hljs-variable">$MESSAGE</span></span><span class="hljs-string"><span class="hljs-string">" elif [[ "</span></span><span class="hljs-variable"><span class="hljs-variable">$RESPONSE</span></span><span class="hljs-string"><span class="hljs-string">" != "</span></span><span class="hljs-variable"><span class="hljs-variable">$MSMS_EXPECTED</span></span><span class="hljs-string"><span class="hljs-string">" ]]; then echo health-check \"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$MSMS_SERVICE_NAME</span></span></span><span class="hljs-string">\" FAILED: "</span></span><span class="hljs-variable"><span class="hljs-variable">$RESPONSE</span></span><span class="hljs-string"><span class="hljs-string">" MESSAGE="</span></span>$(cat ../templates/service-fail.txt)<span class="hljs-string"><span class="hljs-string">" MESSAGE=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$(eval echo $MESSAGE)</span></span></span><span class="hljs-string"> send_message "</span></span><span class="hljs-variable"><span class="hljs-variable">$MESSAGE</span></span><span class="hljs-string"><span class="hljs-string">" else echo health-check \"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$MSMS_SERVICE_NAME</span></span></span><span class="hljs-string">\": OK fi</span></span></code> </pre><br>  Zuerst weisen wir die Variable <code>RESPONSE</code> dem Ergebnis des Befehls curl f√ºr diesen Dienst zu. <br><br>  Ausdruck <code>EXIT_CODE=$?</code>  Setzt das Ergebnis des letzten Befehls, d. h.  locken.  Wenn Sie eine Warnung senden m√ºssen, wird die Vorlage aus der entsprechenden Datei gelesen und der Versand an die Empf√§nger <code>send_message</code> mit <code>send_message</code> . <br><br>  Der letzte Block verarbeitet den Parameter DAILY: <br><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">"</span></span> = <span class="hljs-string"><span class="hljs-string">"DAILY"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> health-check \<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$MSMS_SERVICE_NAME</span></span></span><span class="hljs-string">\" DAILY MESSAGE="</span></span>$(cat ../templates/daily.txt)<span class="hljs-string"><span class="hljs-string">" MESSAGE=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$(eval echo $MESSAGE)</span></span></span><span class="hljs-string"> send_message "</span></span><span class="hljs-variable"><span class="hljs-variable">$MESSAGE</span></span><span class="hljs-string"><span class="hljs-string">" fi</span></span></code> </pre> <br>  Es wird eine Nachricht gesendet, die den Zustand der √úberwachung selbst best√§tigt. <br><br><h2>  Liste der Benutzer-IDs abrufen </h2><br>  <b>recipient-setup.sh</b> ruft die Telegramm-API auf, um die neuesten Nachrichten an den Bot zu senden: <br><br><pre> <code class="bash hljs">curl -s https://api.telegram.org/bot$(cat telegram-api-key.txt)/getUpdates \ | python recipients-setup.py</code> </pre> <br>  Es verwendet Python-Magie, um die Ausgabe sch√∂n aufzulisten.  Dies ist optional, Sie k√∂nnen einfach die gew√ºnschte ID von json nehmen, die der Befehl ausgibt: <br><br><pre> <code class="bash hljs">torsocks curl -s https://api.telegram.org/bot$(cat telegram-api-key.txt)/getUpdates</code> </pre> <br><h2>  Fazit </h2><br>  Auf diese Weise k√∂nnen Sie vorgefertigte Skripts und Nachrichtenvorlagen verwenden und nur beobachtbare Dienste und Listen f√ºr Benachrichtigungen einrichten.  Sie k√∂nnen eine neue "Identit√§t" f√ºr den Bot erstellen.  und Sie k√∂nnen Ihre Entscheidung auf der Grundlage des Vorschlags treffen. <br><br>  Als Optionen f√ºr die Weiterentwicklung bietet sich die Konfiguration und Verwaltung der √úberwachung im Bot selbst an, auf Python kann man hier jedoch nicht verzichten.  Wenn jemand die H√§nde vor mir hat, wei√üt du, wo du die Pull-Anfrage hochladen musst :-) </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de483318/">https://habr.com/ru/post/de483318/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de483308/index.html">VonmoTrade-Experiment. Teil 4: Trading Charts</a></li>
<li><a href="../de483310/index.html">Erstellen Sie mit pix2pix Linsen f√ºr Snapchat</a></li>
<li><a href="../de483312/index.html">Die gro√üe Schneeflockentheorie</a></li>
<li><a href="../de483314/index.html">So f√ºhren Sie asynchrone Redux-Aktionen mit Redux-Thunk durch</a></li>
<li><a href="../de483316/index.html">Schnelle Einf√ºhrung in SwiftUI</a></li>
<li><a href="../de483320/index.html">Schaffung eines mittelalterlichen VR-Museums</a></li>
<li><a href="../de483322/index.html">REST-API-Entwicklung - Was ist der Code First-Ansatz?</a></li>
<li><a href="../de483324/index.html">Flexible Prozesse im IT-Team</a></li>
<li><a href="../de483328/index.html">REST API - Was ist HATEOAS?</a></li>
<li><a href="../de483330/index.html">√úber die Bedienung eines PCs am Beispiel von Windows 10 und der Tastatur, Teil 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>