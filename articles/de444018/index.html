<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßñüèæ üçÅ üìí Wie eine √Ñnderung der PostgreSQL-Konfiguration die Leistung langsamer Abfragen 50-mal verbessert üñêüèΩ ‚ö±Ô∏è üò≥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo Khabrovites! Ich mache Sie auf eine √úbersetzung des Artikels "Wie eine einzelne √Ñnderung der PostgreSQL-Konfiguration die Leistung langsamer Abf...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Wie eine √Ñnderung der PostgreSQL-Konfiguration die Leistung langsamer Abfragen 50-mal verbessert</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/444018/">  Hallo Khabrovites!  Ich mache Sie auf eine √úbersetzung des Artikels <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">"Wie eine einzelne √Ñnderung der PostgreSQL-Konfiguration die Leistung langsamer Abfragen um das 50-fache verbessert"</a> von Pavan Patibandla aufmerksam.  Es hat mir sehr geholfen, die Leistung von PostgreSQL zu verbessern. <br><br>  Unser Ziel bei Amplitude ist es, benutzerfreundliche interaktive Produktanalysen bereitzustellen, damit jeder Antworten auf seine Fragen zum Produkt finden kann.  Um die Benutzerfreundlichkeit sicherzustellen, muss Amplitude diese Antworten schnell bereitstellen.  Als sich einer unserer Kunden dar√ºber beschwerte, wie lange es gedauert hat, die Dropdown-Liste der Ereigniseigenschaften in die Amplitude-Benutzeroberfl√§che zu laden, haben wir eine detaillierte Untersuchung des Problems gestartet. <br><br>  Durch Verfolgen der Verz√∂gerung auf verschiedenen Ebenen haben wir festgestellt, dass es 20 Sekunden dauerte, bis eine bestimmte PostgreSQL-Abfrage abgeschlossen war.  Dies war f√ºr uns eine √úberraschung, da beide Tabellen Indizes in der Join-Spalte haben. <br><br>  <b>Langsame Anfrage</b> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/baa/ee5/4d3/baaee54d35e5279d4db80032a422ef73.png" alt="Bild"><br><a name="habracut"></a><br>  Der PostgreSQL-Ausf√ºhrungsplan f√ºr diese Abfrage war f√ºr uns unerwartet.  Trotz der Tatsache, dass beide Tabellen Indizes haben, hat PostgreSQL beschlossen, einen Hash-Join mit sequentiellem Scannen einer gro√üen Tabelle durchzuf√ºhren.  Das sequentielle Scannen einer gro√üen Tabelle nahm den gr√∂√üten Teil der Abfragezeit in Anspruch. <br><br>  <b>Plan zur Ausf√ºhrung langsamer Abfragen</b> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/31e/57c/9ec/31e57c9ec8e242c349cabeeefe700f2b.png" alt="Bild"><br><br>  Ich hatte zun√§chst den Verdacht, dass dies an einer Fragmentierung liegen k√∂nnte.  Nachdem ich die Daten √ºberpr√ºft hatte, stellte ich fest, dass Daten nur zu dieser Tabelle hinzugef√ºgt und von dort praktisch nicht gel√∂scht werden.  Da es hier nicht viel hilft, den Platz mit VACUUM zu r√§umen, fing ich an, weiter zu graben.  Dann habe ich die gleiche Anfrage auf einem anderen Client mit einer guten Antwortzeit versucht.  Zu meiner √úberraschung sah der Ausf√ºhrungsplan f√ºr Abfragen v√∂llig anders aus! <br><br>  <b>Ausf√ºhrungsplan f√ºr dieselbe Anforderung auf einem anderen Client</b> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b58/dfd/435/b58dfd435727e9c537467d3e69d6728f.png" alt="Bild"><br><br>  Interessanterweise hatte Anwendung A nur Zugriff auf zehnmal mehr Daten als Anwendung B, aber die Antwortzeit war 3.000 Mal l√§nger. <br><br>  Um alternative PostgreSQL-Abfragepl√§ne anzuzeigen, habe ich die Hash-Verbindung deaktiviert und die Abfrage neu gestartet. <br><br>  <b>Alternativer Ausf√ºhrungsplan f√ºr langsame Abfragen</b> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c46/b16/482/c46b16482a3ea0c42d3ca61022b842df.png" alt="Bild"><br><br>  Bitte sch√∂n!  Dieselbe Anforderung wird 50-mal schneller ausgef√ºhrt, wenn eine verschachtelte Schleife anstelle eines Hash-Joins verwendet wird.  Warum hat PostgreSQL den schlechtesten Plan f√ºr Anwendung A gew√§hlt? <br><br>  Bei n√§herer Betrachtung der gesch√§tzten Kosten und der tats√§chlichen Vorlaufzeit f√ºr beide Pl√§ne waren die gesch√§tzten Verh√§ltnisse von Kosten und tats√§chlicher Vorlaufzeit sehr unterschiedlich.  Der Hauptschuldige f√ºr diese Diskrepanz war die Kostensch√§tzung des sequentiellen Scannens.  PostgreSQL sch√§tzt, dass sequentielle Scans besser w√§ren als mehr als 4000 Index-Scans, aber tats√§chlich waren Index-Scans 50-mal schneller. <br><br>  Dies f√ºhrte mich zu den Konfigurationsoptionen <b>random_page_cost</b> und <b>seq_page_cost</b> .  Die Standardwerte f√ºr PostgreSQL sind <b>4</b> und <b>1</b> f√ºr <b>random_page_cost</b> , <b>seq_page_cost</b> , die f√ºr die Festplatte konfiguriert sind, bei der der wahlfreie Zugriff auf die Festplatte teurer ist als der sequentielle Zugriff.  Diese Kosten waren jedoch f√ºr unsere Bereitstellung mit dem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">gp2-EBS-</a> Volume, bei dem es sich um Solid-State-Laufwerke handelt, ungenau.  F√ºr unsere Bereitstellung ist der wahlfreie und sequentielle Zugriff nahezu identisch. <br><br>  Ich habe den Wert von <b>random_page_cost</b> auf <b>1</b> <b>ge√§ndert</b> und <b>die</b> Anforderung <b>wiederholt</b> .  Dieses Mal verwendete PostgreSQL die verschachtelte Schleife und die Abfrage wurde 50-mal schneller ausgef√ºhrt.  Nach der √Ñnderung haben wir auch eine signifikante Verringerung der maximalen Antwortzeit von PostgreSQL festgestellt. <br><br>  <b>Die Gesamtleistung einer langsamen Anforderung hat sich erheblich verbessert.</b> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/203/587/79b/20358779bdd2b3ddfe7bf964054781c0.png" alt="Bild"><br><br>  Wenn Sie SSD verwenden und PostgreSQL mit Standardkonfiguration verwenden, empfehlen wir Ihnen, <b>random_page_cost</b> und <b>seq_page_cost festzulegen</b> .  Sie werden m√∂glicherweise von der dramatischen Leistungsverbesserung √ºberrascht sein. <br><br>  Ich <b>m√∂chte</b> von mir selbst hinzuf√ºgen, dass ich die Mindestparameter <b>seq_page_cost = random_page_cost = 0.1 festgelegt habe</b> , um den Daten im Speicher (Cache) Vorrang vor Prozessoroperationen zu geben, da ich f√ºr PostgreSQL eine gro√üe Menge RAM zugewiesen habe (die Gr√∂√üe des RAM √ºberschreitet die Gr√∂√üe der Datenbank auf der Festplatte).  Es ist nicht sehr klar, warum die Postgres-Community immer noch die Standardeinstellungen verwendet, die f√ºr einen Server mit wenig RAM und Festplatten relevant sind, und nicht f√ºr moderne Server.  Hoffentlich wird dies bald behoben. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de444018/">https://habr.com/ru/post/de444018/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de444004/index.html">CLRium # 5: Alles √ºber GC und mehr. Peter und Moskau</a></li>
<li><a href="../de444006/index.html">DIY Do-it-yourself-Spielekonsole</a></li>
<li><a href="../de444010/index.html">.NET Core Container-Images jetzt in der Microsoft Container Registry ver√∂ffentlicht</a></li>
<li><a href="../de444014/index.html">Microsoft er√∂ffnet die Business School, um KI-Strategien, Kultur und Verantwortung zu lernen</a></li>
<li><a href="../de444016/index.html">Erreichen Sie mehr mit Microsoft Game Stack</a></li>
<li><a href="../de444020/index.html">Karting in der UdSSR: Wie das Hobby amerikanischer Piloten zu einem massiven DIY-Hobby in der Sowjetunion wurde</a></li>
<li><a href="../de444022/index.html">Beego geht nicht mehr</a></li>
<li><a href="../de444024/index.html">So implementieren Sie eine Programmiersprache in JavaScript. Teil 3: CPS-Dolmetscher</a></li>
<li><a href="../de444026/index.html">MODX Digest # 1.1 (25. Februar - 11. M√§rz 2019)</a></li>
<li><a href="../de444028/index.html">Einf√ºhrung in Microsoft Game Stack</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>