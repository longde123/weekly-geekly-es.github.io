<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ» ğŸ˜§ ğŸ‘©ğŸ¼â€ğŸ³ åŸºäºGolangæ•°æ®åº“çš„å®¢æˆ·ç«¯ç”Ÿæˆå™¨æ¥å£ ğŸ¾ ğŸ‘©â€ğŸ‘©â€ğŸ‘¦ ğŸ¤ª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="åŸºäºæ¥å£çš„Golangæ•°æ®åº“å®¢æˆ·ç«¯ç”Ÿæˆå™¨ ã€‚ 





ä¸ºäº†ä½¿ç”¨æ•°æ®åº“ï¼ŒGolangæä¾›äº†database/sqlåŒ…ï¼Œå®ƒæ˜¯å…³ç³»æ•°æ®åº“ç¼–ç¨‹æ¥å£çš„æŠ½è±¡ã€‚ ä¸€æ–¹é¢ï¼Œè¯¥è½¯ä»¶åŒ…åŒ…æ‹¬å¼ºå¤§çš„åŠŸèƒ½ï¼Œç”¨äºç®¡ç†è¿æ¥æ± ï¼Œä½¿ç”¨å‡†å¤‡å¥½çš„è¯­å¥ï¼Œäº‹åŠ¡å’Œæ•°æ®åº“æŸ¥è¯¢ç•Œé¢ã€‚ å¦ä¸€æ–¹é¢ï¼Œæ‚¨å¿…é¡»åœ¨Webåº”ç”¨ç¨‹åºä¸­ç¼–å†™å¤§é‡ä¸æ•°æ®åº“äº¤äº’çš„ç›¸...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>åŸºäºGolangæ•°æ®åº“çš„å®¢æˆ·ç«¯ç”Ÿæˆå™¨æ¥å£</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/431984/"><p> åŸºäºæ¥å£çš„Golangæ•°æ®åº“<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å®¢æˆ·ç«¯ç”Ÿæˆå™¨</a> ã€‚ </p><br><p><img src="https://habrastorage.org/webt/jn/y8/f1/jny8f1pghqry-6htgynybbcufbi.png"></p><br><p>ä¸ºäº†ä½¿ç”¨æ•°æ®åº“ï¼ŒGolangæä¾›äº†<code>database/sql</code>åŒ…ï¼Œå®ƒæ˜¯å…³ç³»æ•°æ®åº“ç¼–ç¨‹æ¥å£çš„æŠ½è±¡ã€‚ ä¸€æ–¹é¢ï¼Œè¯¥è½¯ä»¶åŒ…åŒ…æ‹¬å¼ºå¤§çš„åŠŸèƒ½ï¼Œç”¨äºç®¡ç†è¿æ¥æ± ï¼Œä½¿ç”¨å‡†å¤‡å¥½çš„è¯­å¥ï¼Œäº‹åŠ¡å’Œæ•°æ®åº“æŸ¥è¯¢ç•Œé¢ã€‚ å¦ä¸€æ–¹é¢ï¼Œæ‚¨å¿…é¡»åœ¨Webåº”ç”¨ç¨‹åºä¸­ç¼–å†™å¤§é‡ä¸æ•°æ®åº“äº¤äº’çš„ç›¸åŒç±»å‹çš„ä»£ç ã€‚  go-gad / salåº“ä»¥åŸºäºæè¿°çš„ç•Œé¢ç”Ÿæˆç›¸åŒç±»å‹çš„ä»£ç çš„å½¢å¼æä¾›äº†ä¸€ç§è§£å†³æ–¹æ¡ˆã€‚ </p><a name="habracut"></a><br><h2 id="motivation"> åŠ¨æœº </h2><br><p> å¦‚ä»Šï¼Œæœ‰è¶³å¤Ÿæ•°é‡çš„åº“ä»¥ORMçš„å½¢å¼æä¾›è§£å†³æ–¹æ¡ˆï¼Œæä¾›ç”¨äºæ„å»ºæŸ¥è¯¢çš„å¸®åŠ©å™¨ï¼ŒåŸºäºæ•°æ®åº“æ¨¡å¼ç”Ÿæˆå¸®åŠ©å™¨çš„å½¢å¼ã€‚ </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://github.com/jmoiron/sqlx</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://github.com/go-reform/reform</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://github.com/jinzhu/gorm</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://github.com/Masterminds/squirrel</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://github.com/volatiletech/sqlboiler</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://github.com/drone/sqlgen</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://github.com/gocraft/dbr</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://github.com/go-gorp/gorp</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://github.com/doug-martin/goqu</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://github.com/src-d/go-kallax</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://github.com/go-pg/pg</a> </li></ul><br><p> å‡ å¹´å‰ï¼Œå½“æˆ‘åˆ‡æ¢åˆ°Golangè¯­è¨€æ—¶ï¼Œæˆ‘å·²ç»æœ‰ä½¿ç”¨ä¸åŒè¯­è¨€çš„æ•°æ®åº“çš„ç»éªŒã€‚ ä½¿ç”¨ORMï¼Œä¾‹å¦‚ActiveRecordï¼Œå¹¶ä¸”ä¸ä½¿ç”¨ã€‚ ä»çˆ±æ¨è½¬ä¸ºåŒçƒ¦ï¼Œç¼–å†™å‡ è¡Œé¢å¤–çš„ä»£ç æ²¡æœ‰é—®é¢˜ï¼Œåœ¨Golangä¸­ä¸æ•°æ®åº“è¿›è¡Œäº¤äº’äº§ç”Ÿäº†è¯¸å¦‚å­˜å‚¨åº“æ¨¡å¼ä¹‹ç±»çš„ä¸œè¥¿ã€‚ æˆ‘ä»¬æè¿°äº†ä¸æ•°æ®åº“ä¸€èµ·ä½¿ç”¨çš„æ¥å£ï¼Œæˆ‘ä»¬ä½¿ç”¨æ ‡å‡†çš„db.Queryï¼Œrow.Scanå®ç°äº†è¯¥æ¥å£ã€‚ ä½¿ç”¨é¢å¤–çš„åŒ…è£…ç¨‹åºæ ¹æœ¬æ²¡æœ‰æ„ä¹‰ï¼Œå› ä¸ºå®ƒæ˜¯ä¸é€æ˜çš„ï¼Œå› æ­¤å¿…é¡»ä¿æŒè­¦æƒ•ã€‚ </p><br><p>  SQLè¯­è¨€æœ¬èº«å·²ç»æ˜¯æ‚¨çš„ç¨‹åºä¸å­˜å‚¨åº“ä¸­çš„æ•°æ®ä¹‹é—´çš„æŠ½è±¡ã€‚ è¯•å›¾æè¿°ä¸€ä¸ªæ•°æ®æ–¹æ¡ˆï¼Œç„¶åå»ºç«‹å¤æ‚çš„æŸ¥è¯¢ï¼Œå¯¹æˆ‘æ¥è¯´æ€»æ˜¯ä¸åˆé€»è¾‘çš„ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå“åº”ç»“æ„ä¸æ•°æ®æ–¹æ¡ˆä¸åŒã€‚ äº‹å®è¯æ˜ï¼Œæ— éœ€åœ¨æ•°æ®æ–¹æ¡ˆçº§åˆ«æè¿°åˆåŒï¼Œè€Œåœ¨è¯·æ±‚å’Œå“åº”çº§åˆ«æè¿°åˆåŒã€‚ æè¿°APIè¯·æ±‚å’Œå“åº”çš„æ•°æ®ç»“æ„æ—¶ï¼Œæˆ‘ä»¬åœ¨Webå¼€å‘ä¸­ä½¿ç”¨äº†è¿™ç§æ–¹æ³•ã€‚ ä½¿ç”¨RESTful JSONæˆ–gRPCè®¿é—®æœåŠ¡æ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨JSON Schemaæˆ–Protobufåœ¨è¯·æ±‚å’Œå“åº”çº§åˆ«å£°æ˜åˆåŒï¼Œè€Œä¸æ˜¯åœ¨æœåŠ¡å†…çš„å®ä½“çš„æ•°æ®æ¨¡å¼ä¸‹å£°æ˜åˆåŒã€‚ </p><br><p> ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸æ•°æ®åº“çš„äº¤äº’å½’ç»“ä¸ºä¸€ç§ç±»ä¼¼çš„æ–¹æ³•ï¼š </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> User <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { ID <span class="hljs-keyword"><span class="hljs-keyword">int64</span></span> Name <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Store <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> { FindUser(id <span class="hljs-keyword"><span class="hljs-keyword">int64</span></span>) (*User, error) } <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Postgres <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { DB *sql.DB } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pg *Postgres)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FindUser</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(id </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int64</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*User, error)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> resp User err := pg.DB.QueryRow(<span class="hljs-string"><span class="hljs-string">"SELECT id, name FROM users WHERE id=$1"</span></span>, id).Scan(&amp;resp.ID, &amp;resp.Name) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, err } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> &amp;resp, <span class="hljs-literal"><span class="hljs-literal">nil</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HanlderFindUser</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(s Store, id </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*User, error)</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">// logic of service object user, err := s.FindUser(id) //... }</span></span></code> </pre> <br><p> è¿™æ ·å¯ä»¥ä½¿æ‚¨çš„ç¨‹åºå¯é¢„æµ‹ã€‚ ä½†æ˜¯è€å®è¯´ï¼Œè¿™ä¸æ˜¯è¯—äººçš„æ¢¦æƒ³ã€‚ æˆ‘ä»¬å¸Œæœ›å‡å°‘ç¼–å†™æŸ¥è¯¢ï¼Œå¡«å……æ•°æ®ç»“æ„ï¼Œä½¿ç”¨å˜é‡ç»‘å®šç­‰æ ·æ¿ä»£ç çš„æ•°é‡ã€‚ æˆ‘è¯•å›¾åˆ—å‡ºæ‰€éœ€çš„å®ç”¨ç¨‹åºé›†åº”æ»¡è¶³çš„è¦æ±‚åˆ—è¡¨ã€‚ </p><br><h2 id="requirements"> è¦æ±‚æ¡ä»¶ </h2><br><ul><li> ä»¥æ¥å£å½¢å¼æè¿°äº¤äº’ã€‚ </li><li> è¯¥æ¥å£ç”±è¯·æ±‚å’Œå“åº”çš„æ–¹æ³•å’Œæ¶ˆæ¯æè¿°ã€‚ </li><li> æ”¯æŒç»‘å®šå˜é‡å’Œå‡†å¤‡å¥½çš„è¯­å¥ã€‚ </li><li> æ”¯æŒå‘½åå‚æ•°ã€‚ </li><li> å°†æ•°æ®åº“å“åº”é“¾æ¥åˆ°æ¶ˆæ¯æ•°æ®ç»“æ„çš„å­—æ®µã€‚ </li><li> æ”¯æŒéå…¸å‹æ•°æ®ç»“æ„ï¼ˆæ•°ç»„ï¼Œjsonï¼‰ã€‚ </li><li> é€æ˜åœ°å¤„ç†äº‹åŠ¡ã€‚ </li><li> å¯¹ä¸­é—´ä»¶çš„æœ¬æœºæ”¯æŒã€‚ </li></ul><br><p> æˆ‘ä»¬æƒ³ä½¿ç”¨è¯¥æ¥å£æ¥æŠ½è±¡ä¸æ•°æ®åº“äº¤äº’çš„å®ç°ã€‚ è¿™å°†ä½¿æˆ‘ä»¬èƒ½å¤Ÿå®ç°ç±»ä¼¼äºè®¾è®¡æ¨¡å¼çš„å†…å®¹ï¼Œä¾‹å¦‚å­˜å‚¨åº“ã€‚ åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬æè¿°äº†Storeæ¥å£ã€‚ ç°åœ¨æˆ‘ä»¬å¯ä»¥å°†å…¶ç”¨ä½œä¾èµ–é¡¹ã€‚ åœ¨æµ‹è¯•é˜¶æ®µï¼Œæˆ‘ä»¬å¯ä»¥ä¼ é€’åŸºäºæ­¤æ¥å£ç”Ÿæˆçš„å­˜æ ¹ï¼Œå¹¶ä¸”åœ¨äº§å“ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨åŸºäºPostgresç»“æ„çš„å®ç°ã€‚ </p><br><p> æ¯ç§æ¥å£æ–¹æ³•éƒ½æè¿°ä¸€ä¸ªæ•°æ®åº“æŸ¥è¯¢ã€‚ æ–¹æ³•çš„è¾“å…¥å’Œè¾“å‡ºå‚æ•°å¿…é¡»æ˜¯è¯·æ±‚åˆåŒçš„ä¸€éƒ¨åˆ†ã€‚ æŸ¥è¯¢å­—ç¬¦ä¸²éœ€è¦èƒ½å¤Ÿæ ¹æ®è¾“å…¥å‚æ•°è¿›è¡Œæ ¼å¼åŒ–ã€‚ åœ¨ç¼–è¯‘å…·æœ‰å¤æ‚é‡‡æ ·æ¡ä»¶çš„æŸ¥è¯¢æ—¶å°¤å…¶å¦‚æ­¤ã€‚ </p><br><p> ç¼–è¯‘æŸ¥è¯¢æ—¶ï¼Œæˆ‘ä»¬è¦ä½¿ç”¨æ›¿æ¢å’Œå˜é‡ç»‘å®šã€‚ ä¾‹å¦‚ï¼Œåœ¨PostgreSQLä¸­ï¼Œæ‚¨ç¼–å†™<code>$1</code>è€Œä¸æ˜¯å€¼ï¼Œå¹¶ä¸æŸ¥è¯¢ä¸€èµ·ä¼ é€’ä¸€ä¸ªå‚æ•°æ•°ç»„ã€‚ ç¬¬ä¸€ä¸ªå‚æ•°å°†ç”¨ä½œè½¬æ¢åçš„æŸ¥è¯¢ä¸­çš„å€¼ã€‚ å¯¹é¢„å¤‡è¡¨è¾¾å¼çš„æ”¯æŒä½¿æ‚¨ä¸å¿…æ‹…å¿ƒç»„ç»‡è¿™äº›ç›¸åŒè¡¨è¾¾å¼çš„å­˜å‚¨ã€‚ æ•°æ®åº“/ sqlåº“æä¾›äº†ä¸€ä¸ªå¼ºå¤§çš„å·¥å…·æ¥æ”¯æŒå‡†å¤‡å¥½çš„è¡¨è¾¾å¼ï¼›å®ƒæœ¬èº«è´Ÿè´£è¿æ¥æ± ï¼Œå…³é—­çš„è¿æ¥ã€‚ ä½†æ˜¯å¯¹äºç”¨æˆ·è€Œè¨€ï¼Œå¿…é¡»æ‰§è¡Œå…¶ä»–æ“ä½œæ‰èƒ½åœ¨äº‹åŠ¡ä¸­é‡ç”¨å‡†å¤‡å¥½çš„è¡¨è¾¾å¼ã€‚ </p><br><p>  PostgreSQLå’ŒMySQLç­‰æ•°æ®åº“ä½¿ç”¨ä¸åŒçš„è¯­æ³•æ¥ä½¿ç”¨æ›¿æ¢å’Œå˜é‡ç»‘å®šã€‚  PostgreSQLä½¿ç”¨<code>$1</code> ï¼Œ <code>$2</code> ï¼Œ... MySQLæ ¼å¼<code>?</code> æ— è®ºå€¼çš„ä½ç½®å¦‚ä½•ã€‚ æ•°æ®åº“/ sqlåº“ä¸ºå‘½åå‚æ•°<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://golang.org/pkg/database/sql/#NamedArg</a>æå‡ºäº†ä¸€ç§é€šç”¨æ ¼å¼ã€‚ ç”¨æ³•ç¤ºä¾‹ï¼š </p><br><pre> <code class="go hljs">db.ExecContext(ctx, <span class="hljs-string"><span class="hljs-string">`DELETE FROM orders WHERE created_at &lt; @end`</span></span>, sql.Named(<span class="hljs-string"><span class="hljs-string">"end"</span></span>, endTime))</code> </pre> <br><p> ä¸PostgreSQLæˆ–MySQLè§£å†³æ–¹æ¡ˆç›¸æ¯”ï¼Œæœ€å¥½ä½¿ç”¨æ­¤æ ¼å¼çš„æ”¯æŒã€‚ </p><br><p> æ¥è‡ªå¤„ç†è½¯ä»¶é©±åŠ¨ç¨‹åºçš„æ•°æ®åº“çš„å“åº”å¯ä»¥æœ‰æ¡ä»¶åœ°è¡¨ç¤ºä¸ºï¼š </p><br><pre> <code class="sql hljs">dev &gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> rubrics; id | created_at | title | url <span class="hljs-comment"><span class="hljs-comment">----+-------------------------+-------+------------ 1 | 2012-03-13 11:17:23.609 | Tech | technology 2 | 2015-07-21 18:05:43.412 | Style | fashion (2 rows)</span></span></code> </pre> <br><p> ä»ç”¨æˆ·çš„è§’åº¦æ¥çœ‹ï¼Œå°†è¾“å‡ºå‚æ•°æè¿°ä¸ºä»¥ä¸‹å½¢å¼çš„ç»“æ„æ•°ç»„å¾ˆæ–¹ä¾¿ï¼š </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> GetRubricsResp <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { ID <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> CreatedAt time.Time Title <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> URL <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> }</code> </pre> <br><p> æ¥ä¸‹æ¥ï¼Œå°†<code>id</code>å€¼<code>resp.ID</code>åˆ°<code>resp.ID</code>ç­‰ä¸Šã€‚ é€šå¸¸ï¼Œæ­¤åŠŸèƒ½å¯ä»¥æ»¡è¶³å¤§å¤šæ•°éœ€æ±‚ã€‚ </p><br><p> é€šè¿‡å†…éƒ¨æ•°æ®ç»“æ„å£°æ˜æ¶ˆæ¯æ—¶ï¼Œå‡ºç°äº†å¦‚ä½•æ”¯æŒéæ ‡å‡†æ•°æ®ç±»å‹çš„é—®é¢˜ã€‚ ä¾‹å¦‚ï¼Œä¸€ä¸ªæ•°ç»„ã€‚ å¦‚æœåœ¨ä½¿ç”¨PostgreSQLæ—¶ä½¿ç”¨github.com/lib/pqé©±åŠ¨ç¨‹åºï¼Œåˆ™åœ¨ä¼ é€’æŸ¥è¯¢å‚æ•°æˆ–æ‰«æå“åº”æ—¶å¯ä»¥ä½¿ç”¨<code>pq.Array(&amp;x)</code>ç­‰è¾…åŠ©åŠŸèƒ½ã€‚ æ–‡æ¡£ä¸­çš„ç¤ºä¾‹ï¼š </p><br><pre> <code class="go hljs">db.Query(<span class="hljs-string"><span class="hljs-string">`SELECT * FROM t WHERE id = ANY($1)`</span></span>, pq.Array([]<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>{<span class="hljs-number"><span class="hljs-number">235</span></span>, <span class="hljs-number"><span class="hljs-number">401</span></span>})) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> x []sql.NullInt64 db.QueryRow(<span class="hljs-string"><span class="hljs-string">'SELECT ARRAY[235, 401]'</span></span>).Scan(pq.Array(&amp;x))</code> </pre> <br><p> å› æ­¤ï¼Œå¿…é¡»æœ‰å‡†å¤‡æ•°æ®ç»“æ„çš„æ–¹æ³•ã€‚ </p><br><p> æ‰§è¡Œä»»ä½•æ¥å£æ–¹æ³•æ—¶ï¼Œéƒ½å¯ä»¥ä½¿ç”¨<code>*sql.DB</code>çš„å½¢å¼ä½¿ç”¨æ•°æ®åº“è¿æ¥ã€‚ å¦‚æœæ‚¨éœ€è¦åœ¨å•ä¸ªäº‹åŠ¡ä¸­æ‰§è¡Œå¤šç§æ–¹æ³•ï¼Œæˆ‘æƒ³ä½¿ç”¨é€æ˜åŠŸèƒ½ä»¥åŠç±»ä¼¼çš„æ–¹æ³•åœ¨äº‹åŠ¡å¤–éƒ¨å·¥ä½œï¼Œè€Œä¸è¦ä¼ é€’å…¶ä»–å‚æ•°ã€‚ </p><br><p> åœ¨ä½¿ç”¨æ¥å£å®ç°æ—¶ï¼Œå¯¹æˆ‘ä»¬è€Œè¨€è‡³å…³é‡è¦çš„æ˜¯èƒ½å¤ŸåµŒå…¥è¯¥å·¥å…·åŒ…ã€‚ ä¾‹å¦‚ï¼Œè®°å½•æ‰€æœ‰è¯·æ±‚ã€‚ è¯¥å·¥å…·ç®±å¿…é¡»è®¿é—®è¯·æ±‚å˜é‡ï¼Œå“åº”é”™è¯¯ï¼Œè¿è¡Œæ—¶ï¼Œæ¥å£æ–¹æ³•åç§°ã€‚ </p><br><p> åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œéœ€æ±‚è¢«è¡¨è¿°ä¸ºæ•°æ®åº“æ–¹æ¡ˆçš„ç³»ç»ŸåŒ–ã€‚ </p><br><h2 id="solution-go-gadsal"> è§£å†³æ–¹æ¡ˆï¼šgo-gad / sal </h2><br><p> å¤„ç†æ ·æ¿ä»£ç çš„ä¸€ç§æ–¹æ³•æ˜¯ç”Ÿæˆå®ƒã€‚ å¹¸è¿çš„æ˜¯ï¼ŒGolangå…·æœ‰ç”¨äºæ­¤<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://blog.golang.org/generateçš„</a>å·¥å…·å’Œç¤ºä¾‹ã€‚  GoMockçš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://github.com/golang/mock</a>æ–¹æ³•è¢«ç”¨ä½œè¿™ä¸€ä»£çš„ä½“ç³»ç»“æ„è§£å†³æ–¹æ¡ˆï¼Œå…¶ä¸­ä½¿ç”¨åå°„æ¥æ‰§è¡Œæ¥å£åˆ†æã€‚ åŸºäºæ­¤æ–¹æ³•ï¼Œæ ¹æ®è¦æ±‚ï¼Œç¼–å†™äº†salgenå®ç”¨ç¨‹åºå’Œsalåº“ï¼Œå®ƒä»¬ç”Ÿæˆæ¥å£å®ç°ä»£ç å¹¶æä¾›ä¸€ç»„è¾…åŠ©åŠŸèƒ½ã€‚ </p><br><p> ä¸ºäº†å¼€å§‹ä½¿ç”¨æ­¤è§£å†³æ–¹æ¡ˆï¼Œå¿…é¡»æè¿°ä¸€ä¸ªæè¿°äº¤äº’å±‚ä¸æ•°æ®åº“è¡Œä¸ºçš„æ¥å£ã€‚ ä½¿ç”¨ä¸€ç»„å‚æ•°æŒ‡å®š<code>go:generate</code>æŒ‡ä»¤å¹¶å¼€å§‹ç”Ÿæˆã€‚ æ‚¨å°†è·å¾—ä¸€ä¸ªæ„é€ å‡½æ•°å’Œä¸€å †æ ·æ¿ä»£ç ï¼Œéšæ—¶å¯ä»¥ä½¿ç”¨ã€‚ </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> repo <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">"context"</span></span> <span class="hljs-comment"><span class="hljs-comment">//go:generate salgen -destination=./postgres_client.go -package=dev/taxi/repo dev/taxi/repo Postgres type Postgres interface { CreateDriver(ctx context.Context, r *CreateDriverReq) error } type CreateDriverReq struct { taxi.Driver } func (r *CreateDriverReq) Query() string { return `INSERT INTO drivers(id, name) VALUES(@id, @name)` }</span></span></code> </pre> <br><h4 id="interface"> ä»‹é¢ </h4><br><p> ä¸€åˆ‡éƒ½ä»å£°æ˜æ¥å£å’Œ<code>go generate</code>å®ç”¨ç¨‹åºçš„ç‰¹æ®Šå‘½ä»¤å¼€å§‹ï¼š </p><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">//go:generate salgen -destination=./client.go -package=github.com/go-gad/sal/examples/profile/storage github.com/go-gad/sal/examples/profile/storage Store type Store interface { ...</span></span></code> </pre> <br><p> è¿™é‡Œæè¿°äº†å¯¹äºæˆ‘ä»¬çš„<code>Store</code>ç•Œé¢ï¼Œå°†ä»åŒ…ä¸­è°ƒç”¨æ§åˆ¶å°å®ç”¨ç¨‹åº<code>salgen</code> ï¼Œå®ƒå¸¦æœ‰ä¸¤ä¸ªé€‰é¡¹å’Œä¸¤ä¸ªå‚æ•°ã€‚ ç¬¬ä¸€ä¸ªé€‰é¡¹<code>-destination</code>ç¡®å®šæ‰€ç”Ÿæˆçš„ä»£ç å°†å†™å…¥å“ªä¸ªæ–‡ä»¶ä¸­ã€‚ ç¬¬äºŒä¸ªé€‰é¡¹<code>-package</code>ä¸ºç”Ÿæˆçš„å®ç°å®šä¹‰åº“çš„å®Œæ•´è·¯å¾„ï¼ˆå¯¼å…¥è·¯å¾„ï¼‰ã€‚ ä»¥ä¸‹æ˜¯ä¸¤ä¸ªå‚æ•°ã€‚ ç¬¬ä¸€ä¸ªæè¿°æ¥å£æ‰€åœ¨çš„å®Œæ•´åŒ…è·¯å¾„ï¼ˆ <code>github.com/go-gad/sal/examples/profile/storage</code> ï¼‰ï¼Œç¬¬äºŒä¸ªæè¿°æ¥å£æœ¬èº«çš„åç§°ã€‚ è¯·æ³¨æ„ï¼Œç”¨äº<code>go generate</code>çš„å‘½ä»¤å¯ä»¥ä½äºä»»ä½•ä½ç½®ï¼Œè€Œä¸å¿…ä½äºç›®æ ‡æ¥å£æ—è¾¹ã€‚ </p><br><p> æ‰§è¡Œ<code>go generate</code>å‘½ä»¤åï¼Œæˆ‘ä»¬å¾—åˆ°ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œè¯¥æ„é€ å‡½æ•°çš„åç§°æ˜¯é€šè¿‡åœ¨æ¥å£åç§°ä¸Šæ·»åŠ <code>New</code>å‰ç¼€æ¥æ„å»ºçš„ã€‚ æ„é€ å‡½æ•°é‡‡ç”¨ä¸<code>sal.QueryHandler</code>æ¥å£ç›¸å¯¹åº”çš„å¿…éœ€å‚æ•°ï¼š </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> QueryHandler <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> { QueryContext(ctx context.Context, query <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, args ...<span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>{}) (*sql.Rows, error) ExecContext(ctx context.Context, query <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, args ...<span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>{}) (sql.Result, error) PrepareContext(ctx context.Context, query <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>) (*sql.Stmt, error) }</code> </pre> <br><p> æ­¤æ¥å£å¯¹åº”äº<code>*sql.DB</code>å¯¹è±¡ã€‚ </p><br><pre> <code class="go hljs">connStr := <span class="hljs-string"><span class="hljs-string">"user=pqgotest dbname=pqgotest sslmode=verify-full"</span></span> db, err := sql.Open(<span class="hljs-string"><span class="hljs-string">"postgres"</span></span>, connStr) client := storage.NewStore(db)</code> </pre> <br><h4 id="methods"> æ–¹æ³• </h4><br><p> æ¥å£æ–¹æ³•ç¡®å®šå¯ç”¨æ•°æ®åº“æŸ¥è¯¢çš„é›†åˆã€‚ </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Store <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> { CreateAuthor(ctx context.Context, req CreateAuthorReq) (CreateAuthorResp, error) GetAuthors(ctx context.Context, req GetAuthorsReq) ([]*GetAuthorsResp, error) UpdateAuthor(ctx context.Context, req *UpdateAuthorReq) error }</code> </pre> <br><ul><li> å‚æ•°çš„æ•°é‡å§‹ç»ˆä¸¥æ ¼ä¸º2ã€‚ </li><li> ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸Šä¸‹æ–‡ã€‚ </li><li> ç¬¬äºŒä¸ªå‚æ•°åŒ…å«ç”¨äºç»‘å®šå˜é‡çš„æ•°æ®å¹¶å®šä¹‰æŸ¥è¯¢å­—ç¬¦ä¸²ã€‚ </li><li> ç¬¬ä¸€è¾“å‡ºå‚æ•°å¯ä»¥æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œä¸€ä¸ªå¯¹è±¡æ•°ç»„æˆ–ä¸å­˜åœ¨ã€‚ </li><li> æœ€åçš„è¾“å‡ºå‚æ•°å§‹ç»ˆæ˜¯é”™è¯¯ã€‚ </li></ul><br><p> ç¬¬ä¸€ä¸ªå‚æ•°å§‹ç»ˆæ˜¯<code>context.Context</code>å¯¹è±¡ã€‚ è°ƒç”¨æ•°æ®åº“å’Œå·¥å…·ç®±æ—¶ï¼Œå°†ä¼ é€’æ­¤ä¸Šä¸‹æ–‡ã€‚ ç¬¬äºŒä¸ªå‚æ•°éœ€è¦ä¸€ä¸ªåŸºæœ¬ç±»å‹ä¸º<code>struct</code>çš„å‚æ•°ï¼ˆæˆ–æŒ‡å‘<code>struct</code>çš„æŒ‡é’ˆï¼‰ã€‚ è¯¥å‚æ•°å¿…é¡»æ»¡è¶³ä»¥ä¸‹æ¥å£ï¼š </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Queryer <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> { Query() <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> }</code> </pre> <br><p> åœ¨æ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢ä¹‹å‰ï¼Œå°†è°ƒç”¨<code>Query()</code>æ–¹æ³•ã€‚ ç»“æœå­—ç¬¦ä¸²å°†è½¬æ¢ä¸ºç‰¹å®šäºæ•°æ®åº“çš„æ ¼å¼ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹äºPostgreSQLï¼Œ@ <code>@end</code>å°†è¢«æ›¿æ¢ä¸º<code>$1</code> ï¼Œå¹¶ä¸”å€¼<code>&amp;req.End</code>å°†è¢«ä¼ é€’ç»™å‚æ•°æ•°ç»„ </p><br><p> æ ¹æ®è¾“å‡ºå‚æ•°ï¼Œç¡®å®šå°†è°ƒç”¨å“ªç§æ–¹æ³•ï¼ˆæŸ¥è¯¢/æ‰§è¡Œï¼‰ï¼š </p><br><ul><li> å¦‚æœç¬¬ä¸€ä¸ªå‚æ•°çš„åŸºæœ¬ç±»å‹ä¸º<code>struct</code> ï¼ˆæˆ–<code>struct</code>çš„æŒ‡é’ˆï¼‰ï¼Œåˆ™å°†è°ƒç”¨<code>QueryContext</code>æ–¹æ³•ã€‚ å¦‚æœæ¥è‡ªæ•°æ®åº“çš„å“åº”ä¸åŒ…å«å•ä¸ªè¡Œï¼Œåˆ™å°†<code>sql.ErrNoRows</code>é”™è¯¯ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œè¯¥è¡Œä¸ºç±»ä¼¼äº<code>db.QueryRow</code> ã€‚ </li><li> å¦‚æœç¬¬ä¸€ä¸ªå‚æ•°å…·æœ‰åŸºæœ¬ç±»å‹<code>slice</code> ï¼Œåˆ™å°†è°ƒç”¨<code>QueryContext</code>æ–¹æ³•ã€‚ å¦‚æœæ¥è‡ªæ•°æ®åº“çš„å“åº”ä¸åŒ…å«è¡Œï¼Œåˆ™å°†è¿”å›ä¸€ä¸ªç©ºåˆ—è¡¨ã€‚ åˆ—è¡¨é¡¹çš„åŸºæœ¬ç±»å‹å¿…é¡»ä¸º<code>stuct</code> ï¼ˆæˆ–æŒ‡å‘<code>struct</code>çš„æŒ‡é’ˆï¼‰ã€‚ </li><li> å¦‚æœè¾“å‡ºå‚æ•°ä¸º<code>error</code>ç±»å‹ä¹‹ä¸€ï¼Œåˆ™å°†è°ƒç”¨<code>ExecContext</code>æ–¹æ³•ã€‚ </li></ul><br><h4 id="prepared-statements"> å‡†å¤‡å¥½çš„é™ˆè¿° </h4><br><p> ç”Ÿæˆçš„ä»£ç æ”¯æŒå‡†å¤‡å¥½çš„è¡¨è¾¾å¼ã€‚ é¢„å¤‡çš„è¡¨è¾¾å¼è¢«ç¼“å­˜ã€‚ ç¬¬ä¸€æ¬¡å‡†å¤‡è¡¨è¾¾å¼åï¼Œå°†å¯¹å…¶è¿›è¡Œç¼“å­˜ã€‚ æ•°æ®åº“/ sqlåº“æœ¬èº«ç¡®ä¿å°†å‡†å¤‡å¥½çš„è¡¨è¾¾å¼é€æ˜åœ°åº”ç”¨äºæ‰€éœ€çš„æ•°æ®åº“è¿æ¥ï¼ŒåŒ…æ‹¬å¤„ç†å°é—­çš„è¿æ¥ã€‚ åè¿‡æ¥ï¼Œ <code>go-gad/sal</code>åº“è´Ÿè´£åœ¨äº‹åŠ¡ä¸Šä¸‹æ–‡ä¸­é‡ç”¨å‡†å¤‡å¥½çš„è¯­å¥ã€‚ æ‰§è¡Œå‡†å¤‡å¥½çš„è¡¨è¾¾å¼æ—¶ï¼Œå°†ä½¿ç”¨å¯¹å¼€å‘äººå‘˜é€æ˜çš„å˜é‡ç»‘å®šä¼ é€’å‚æ•°ã€‚ </p><br><p> ä¸ºäº†åœ¨<code>go-gad/sal</code>åº“æ–¹é¢æ”¯æŒå‘½åå‚æ•°ï¼Œè¯¥è¯·æ±‚å°†è½¬æ¢ä¸ºé€‚åˆæ•°æ®åº“çš„è§†å›¾ã€‚ ç°åœ¨æœ‰å¯¹PostgreSQLçš„è½¬æ¢æ”¯æŒã€‚ æŸ¥è¯¢å¯¹è±¡çš„å­—æ®µåç§°ç”¨äºæ›¿æ¢å‘½åå‚æ•°ã€‚ è¦æŒ‡å®šå…¶ä»–åç§°è€Œä¸æ˜¯å¯¹è±¡å­—æ®µåç§°ï¼Œå¿…é¡»å¯¹ç»“æ„å­—æ®µä½¿ç”¨<code>sql</code>æ ‡è®°ã€‚ è€ƒè™‘ä¸€ä¸ªä¾‹å­ï¼š </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> DeleteOrdersRequest <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { UserID <span class="hljs-keyword"><span class="hljs-keyword">int64</span></span> <span class="hljs-string"><span class="hljs-string">`sql:"user_id"`</span></span> CreateAt time.Time <span class="hljs-string"><span class="hljs-string">`sql:"created_at"`</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(r * DeleteOrdersRequest)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Query</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">`DELETE FROM orders WHERE user_id=@user_id AND created_at&lt;@end`</span></span> }</code> </pre> <br><p> å°†è½¬æ¢æŸ¥è¯¢å­—ç¬¦ä¸²ï¼Œå¹¶ä½¿ç”¨å¯¹åº”è¡¨å’Œå˜é‡ç»‘å®šå°†åˆ—è¡¨ä¼ é€’ç»™æŸ¥è¯¢æ‰§è¡Œå‚æ•°ï¼š </p><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// generated code: db.Query("DELETE FROM orders WHERE user_id=$1 AND created_at&lt;$2", &amp;req.UserID, &amp;req.CreatedAt)</span></span></code> </pre> <br><h4 id="map-structs-to-requests-arguments-and-response-messages"> å°†ç»“æ„æ˜ å°„åˆ°è¯·æ±‚çš„å‚æ•°å’Œå“åº”æ¶ˆæ¯ </h4><br><p>  <code>go-gad/sal</code>åº“è´Ÿè´£å°†æ•°æ®åº“å“åº”è¡Œä¸å“åº”ç»“æ„ï¼Œè¡¨åˆ—ä¸ç»“æ„å­—æ®µç›¸å…³è”ï¼š </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> GetRubricsReq <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(r GetRubricReq)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Query</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">`SELECT * FROM rubrics`</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Rubric <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { ID <span class="hljs-keyword"><span class="hljs-keyword">int64</span></span> <span class="hljs-string"><span class="hljs-string">`sql:"id"`</span></span> CreateAt time.Time <span class="hljs-string"><span class="hljs-string">`sql:"created_at"`</span></span> Title <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-string"><span class="hljs-string">`sql:"title"`</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> GetRubricsResp []*Rubric <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Store <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> { GetRubrics(ctx context.Context, req GetRubricsReq) (GetRubricsResp, error) }</code> </pre> <br><p> å¹¶ä¸”å¦‚æœæ•°æ®åº“å“åº”ä¸ºï¼š </p><br><pre> <code class="sql hljs">dev &gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> rubrics; id | created_at | title <span class="hljs-comment"><span class="hljs-comment">----+-------------------------+------- 1 | 2012-03-13 11:17:23.609 | Tech 2 | 2015-07-21 18:05:43.412 | Style (2 rows)</span></span></code> </pre> <br><p> ç„¶åï¼ŒGetRubricsRespåˆ—è¡¨å°†è¿”å›ç»™æˆ‘ä»¬ï¼Œå…¶ä¸­çš„å…ƒç´ å°†æ˜¯æŒ‡å‘Rubricçš„æŒ‡é’ˆï¼Œåœ¨è¯¥å­—æ®µä¸­ï¼Œå­—æ®µä¸­å¡«å……äº†ä¸æ ‡ç­¾åç§°ç›¸å¯¹åº”çš„åˆ—ä¸­çš„å€¼ã€‚ </p><br><p> å¦‚æœæ•°æ®åº“å“åº”åŒ…å«å…·æœ‰ç›¸åŒåç§°çš„åˆ—ï¼Œåˆ™å°†æŒ‰ç…§å£°æ˜é¡ºåºé€‰æ‹©ç›¸åº”çš„ç»“æ„å­—æ®µã€‚ </p><br><pre> <code class="sql hljs">dev &gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> rubrics, subrubrics; id | title | id | title <span class="hljs-comment"><span class="hljs-comment">----+-------+----+---------- 1 | Tech | 3 | Politics</span></span></code> </pre> <br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Rubric <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { ID <span class="hljs-keyword"><span class="hljs-keyword">int64</span></span> <span class="hljs-string"><span class="hljs-string">`sql:"id"`</span></span> Title <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-string"><span class="hljs-string">`sql:"title"`</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Subrubric <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { ID <span class="hljs-keyword"><span class="hljs-keyword">int64</span></span> <span class="hljs-string"><span class="hljs-string">`sql:"id"`</span></span> Title <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-string"><span class="hljs-string">`sql:"title"`</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> GetCategoryResp <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { Rubric Subrubric }</code> </pre> <br><h4 id="non-standard-data-types"> éæ ‡å‡†æ•°æ®ç±»å‹ </h4><br><p>  <code>database/sql</code>è½¯ä»¶åŒ…æä¾›å¯¹åŸºæœ¬æ•°æ®ç±»å‹ï¼ˆå­—ç¬¦ä¸²ï¼Œæ•°å­—ï¼‰çš„æ”¯æŒã€‚ ä¸ºäº†å¤„ç†è¯·æ±‚æˆ–å“åº”ä¸­çš„æ•°æ®ç±»å‹ï¼ˆä¾‹å¦‚æ•°ç»„æˆ–jsonï¼‰ï¼Œå¿…é¡»æ”¯æŒ<code>driver.Valuer</code>å’Œ<code>sql.Scanner</code> ã€‚ ä¸åŒçš„é©±åŠ¨ç¨‹åºå®ç°å…·æœ‰ç‰¹æ®Šçš„åŠ©æ‰‹åŠŸèƒ½ã€‚ ä¾‹å¦‚<code>lib/pq.Array</code> ï¼ˆ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://godoc.org/github.com/lib/pq#Array</a> ï¼‰ï¼š </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Array</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(a </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">interface</span></span></span></span><span class="hljs-function"><span class="hljs-params">{})</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">interface</span></span></span></span> { driver.Valuer sql.Scanner }</code> </pre> <br><p> é»˜è®¤æƒ…å†µä¸‹ï¼Œç”¨äºè§†å›¾ç»“æ„å­—æ®µçš„<code>go-gad/sql</code>åº“ </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> DeleteAuthrosReq <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { Tags []<span class="hljs-keyword"><span class="hljs-keyword">int64</span></span> <span class="hljs-string"><span class="hljs-string">`sql:"tags"`</span></span> }</code> </pre> <br><p> å°†ä½¿ç”¨å€¼<code>&amp;req.Tags</code> ã€‚ å¦‚æœç»“æ„æ»¡è¶³<code>sal.ProcessRower</code>æ¥å£ï¼Œ </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> ProcessRower <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> { ProcessRow(rowMap RowMap) }</code> </pre> <br><p> ç„¶åå¯ä»¥è°ƒæ•´ä½¿ç”¨çš„å€¼ </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(r *DeleteAuthorsReq)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessRow</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(rowMap sal.RowMap)</span></span></span></span> { rowMap.Set(<span class="hljs-string"><span class="hljs-string">"tags"</span></span>, pq.Array(r.Tags)) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(r *DeleteAuthorsReq)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Query</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">`DELETE FROM authors WHERE tags=ANY(@tags::UUID[])`</span></span> }</code> </pre> <br><p> è¯¥å¤„ç†ç¨‹åºå¯ç”¨äºè¯·æ±‚å’Œå“åº”å‚æ•°ã€‚ å¦‚æœå“åº”ä¸­æœ‰åˆ—è¡¨ï¼Œåˆ™è¯¥æ–¹æ³•å¿…é¡»å±äºåˆ—è¡¨é¡¹ã€‚ </p><br><h4 id="transactions"> äº¤æ˜“æ¬¡æ•° </h4><br><p> ä¸ºäº†æ”¯æŒäº‹åŠ¡ï¼Œåº”ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•æ‰©å±•æ¥å£ï¼ˆå•†åº—ï¼‰ï¼š </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Store <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> { BeginTx(ctx context.Context, opts *sql.TxOptions) (Store, error) sal.Txer ...</code> </pre> <br><p> å°†ç”Ÿæˆæ–¹æ³•çš„å®ç°ã€‚  <code>BeginTx</code>æ–¹æ³•ä½¿ç”¨æ¥è‡ªå½“å‰<code>sal.QueryHandler</code>å¯¹è±¡çš„è¿æ¥ï¼Œå¹¶æ‰“å¼€äº‹åŠ¡<code>db.BeginTx(...)</code> ï¼› è¿”å›<code>Store</code>æ¥å£çš„æ–°å®ç°å¯¹è±¡ï¼Œä½†å°†æ¥æ”¶åˆ°çš„<code>*sql.Tx</code>å¯¹è±¡ç”¨ä½œ<code>*sql.Tx</code> </p><br><h4 id="middleware"> ä¸­é—´ä»¶ </h4><br><p> æä¾›äº†ç”¨äºåµŒå…¥å·¥å…·çš„æŒ‚é’©ã€‚ </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> BeforeQueryFunc <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ctx context.Context, query </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">, req </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">interface</span></span></span></span><span class="hljs-function"><span class="hljs-params">{})</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(context.Context, FinalizerFunc)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">type</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FinalizerFunc</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ctx context.Context, err error)</span></span></span></span></code> </pre> <br><p> åœ¨<code>db.Query</code> <code>db.PrepareContext</code>æˆ–<code>db.Query</code>ä¹‹å‰ï¼Œå°†è°ƒç”¨<code>BeforeQueryFunc</code>æŒ‚é’©ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ç¨‹åºå¼€å§‹æ—¶ï¼Œå½“å‡†å¤‡å¥½çš„è¡¨è¾¾å¼ç¼“å­˜ä¸ºç©ºæ—¶ï¼Œå½“è°ƒç”¨<code>BeforeQueryFunc</code>æ—¶ï¼Œ <code>BeforeQueryFunc</code>æŒ‚é’©å°†è¢«è°ƒç”¨ä¸¤æ¬¡ã€‚ åœ¨æˆ‘ä»¬çš„æ¡ˆä¾‹<code>store.GetAuthors</code> ï¼Œ <code>BeforeQueryFunc</code>æŒ‚é’©å¯ä»¥è¿”å›<code>FinalizerFunc</code>æŒ‚é’©ï¼Œåœ¨é€€å‡ºç”¨æˆ·æ–¹æ³•ä¹‹å‰å°†ä½¿ç”¨<code>defer</code>è°ƒç”¨è¯¥<code>FinalizerFunc</code> ã€‚ </p><br><p> åœ¨æ‰§è¡ŒæŒ‚é’©æ—¶ï¼Œä¸Šä¸‹æ–‡ä¸­å°†å¡«å……å…·æœ‰ä»¥ä¸‹å€¼çš„æœåŠ¡å¯†é’¥ï¼š </p><br><ul><li>  <code>ctx.Value(sal.ContextKeyTxOpened)</code>å¸ƒå°”å€¼ç¡®å®šæ˜¯å¦åœ¨äº‹åŠ¡ä¸Šä¸‹æ–‡ä¸­è°ƒç”¨è¯¥æ–¹æ³•ã€‚ </li><li>  <code>ctx.Value(sal.ContextKeyOperationType)</code> ï¼Œæ“ä½œç±»å‹çš„å­—ç¬¦ä¸²å€¼ï¼Œ <code>"QueryRow"</code> ï¼Œ <code>"Query"</code> ï¼Œ <code>"Exec"</code> ï¼Œ <code>"Commit"</code>ç­‰ã€‚ </li><li>  <code>ctx.Value(sal.ContextKeyMethodName)</code>æ¥å£æ–¹æ³•<code>ctx.Value(sal.ContextKeyMethodName)</code>å­—ç¬¦ä¸²å€¼ï¼Œä¾‹å¦‚<code>"GetAuthors"</code> ã€‚ </li></ul><br><p> ä½œä¸ºå‚æ•°ï¼Œ <code>BeforeQueryFunc</code>æŒ‚é’©æ¥å—æŸ¥è¯¢çš„sqlå­—ç¬¦ä¸²å’Œç”¨æˆ·æŸ¥è¯¢æ–¹æ³•çš„<code>req</code>å‚æ•°ã€‚  <code>FinalizerFunc</code>æŒ‚é’©ä½¿ç”¨<code>err</code>å˜é‡ä½œä¸ºå‚æ•°ã€‚ </p><br><pre> <code class="go hljs">beforeHook := <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ctx context.Context, query </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">, req </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">interface</span></span></span></span><span class="hljs-function"><span class="hljs-params">{})</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(context.Context, sal.FinalizerFunc)</span></span></span></span> { start := time.Now() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ctx, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ctx context.Context, err error)</span></span></span></span> { log.Printf( <span class="hljs-string"><span class="hljs-string">"%q &gt; Opeartion %q: %q with req %#v took [%v] inTx[%v] Error: %+v"</span></span>, ctx.Value(sal.ContextKeyMethodName), ctx.Value(sal.ContextKeyOperationType), query, req, time.Since(start), ctx.Value(sal.ContextKeyTxOpened), err, ) } } client := NewStore(db, sal.BeforeQuery(beforeHook))</code> </pre> <br><p> è¾“å‡ºç¤ºä¾‹ï¼š </p><br><pre> <code class="plaintext hljs">"CreateAuthor" &gt; Opeartion "Prepare": "INSERT INTO authors (Name, Desc, CreatedAt) VALUES($1, $2, now()) RETURNING ID, CreatedAt" with req &lt;nil&gt; took [50.819Âµs] inTx[false] Error: &lt;nil&gt; "CreateAuthor" &gt; Opeartion "QueryRow": "INSERT INTO authors (Name, Desc, CreatedAt) VALUES(@Name, @Desc, now()) RETURNING ID, CreatedAt" with req bookstore.CreateAuthorReq{BaseAuthor:bookstore.BaseAuthor{Name:"foo", Desc:"Bar"}} took [150.994Âµs] inTx[false] Error: &lt;nil&gt;</code> </pre> <br><h3 id="whats-next"> æ¥ä¸‹æ¥æ˜¯ä»€ä¹ˆ </h3><br><ul><li> æ”¯æŒMySQLçš„ç»‘å®šå˜é‡å’Œé¢„å¤‡è¡¨è¾¾å¼ã€‚ </li><li>  RowAppenderæŒ‚é’©å¯è°ƒæ•´å“åº”ã€‚ </li><li> è¿”å›<code>Exec.Result</code>çš„å€¼ã€‚ </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN431984/">https://habr.com/ru/post/zh-CN431984/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN431972/index.html">Quoraç”¨æˆ·æ•°æ®æ³„æ¼</a></li>
<li><a href="../zh-CN431974/index.html">Tumblrå®Œå…¨æ”¾å¼ƒäº†â€œè‰è“â€å†…å®¹</a></li>
<li><a href="../zh-CN431976/index.html">ä¿„ç½—æ–¯ä¿¡æ¯å­¦æ—¥ï¼šè‡ªåŠ¨è®¡ç®—æœºç¬¬ä¸€ä¸ªé¡¹ç›®çš„å†å²</a></li>
<li><a href="../zh-CN431978/index.html">ç½‘ä¸Šå•†åº—ä¿ƒé”€ï¼šå¿…é¡»è§£å†³çš„é—®é¢˜</a></li>
<li><a href="../zh-CN431982/index.html">æ•°æ®ä¸­çš„Digeratiï¼ŒHakerazziå’Œèƒ†å›ºé†‡ï¼šå…³äºIT Slang</a></li>
<li><a href="../zh-CN431986/index.html">Fuck Upçš„æ•…äº‹ï¼šæˆ‘å¯¹ä¸šåŠ¡çš„æ•°å­—æœåŠ¡æ„Ÿåˆ°å¤±æœ›å¹¶æ‹¥æœ‰è‡ªå·±çš„ä¸šåŠ¡ï¼ˆå—¯ï¼Œå·®ä¸å¤šï¼‰</a></li>
<li><a href="../zh-CN431988/index.html">å½“å®šç†æˆä¸ºä¸€ä¸ªå…¬ç†æ—¶ï¼šONYX BOOX Euclidè¯„ä¼°</a></li>
<li><a href="../zh-CN431990/index.html">å·®è·èµ¢äº†ã€‚ ä»JetBrainsç¿»è¯‘Kotlinç¼–ç çº¦å®šæ–‡æ¡£</a></li>
<li><a href="../zh-CN431992/index.html">ç”Ÿç‰©è¯†åˆ«ï¼šæˆ‘ä»¬ä¸ä»–ä»¬ä¹‹é—´çš„æƒ…å†µå¦‚ä½•</a></li>
<li><a href="../zh-CN431994/index.html">è®¨è®ºæ‰˜ç®¡åœ¨GitHubä¸Šçš„é¡¹ç›®çš„å…è´¹PVS-Studioè®¸å¯è¯</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>