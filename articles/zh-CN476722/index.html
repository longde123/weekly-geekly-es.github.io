<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>✋ 🙆 🤪 Apache NiFi流交付自动化 💪🏾 👨🏼‍🤝‍👨🏻 👨🏻‍🌾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="大家好！ 



 任务如下-上图中显示了流程，必须使用Apache NiFi将其推广到N个服务器。 流量测试-文件正在生成并发送到另一个NiFi实例。 数据是使用NiFi站点到站点协议传输的。 

 NiFi站点到站点（S2S）是一种安全，易于自定义的方法，可以在NiFi实例之间传输数据。 在文档...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Apache NiFi流交付自动化</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/476722/"> 大家好！ <br><br><img src="https://habrastorage.org/webt/jv/w6/ho/jvw6hodwifbfkov69ezswvjbx_k.png"><br><br> 任务如下-上图中显示了流程，必须使用<a href="https://nifi.apache.org/">Apache NiFi</a>将其推广到N个服务器。 流量测试-文件正在生成并发送到另一个NiFi实例。 数据是使用NiFi站点到站点协议传输的。 <br><a name="habracut"></a><br><hr>  <em>NiFi站点到站点（S2S）是一种安全，易于自定义的方法，可以在NiFi实例之间传输数据。</em>  <em>在<a href="https://docs.cloudera.com/HDPDocuments/HDF2/HDF-2.1.2/bk_dataflow-user-guide/content/site-to-site.html">文档中</a>查看S2S的工作方式，重要的是不要忘记配置NiFi实例以启用S2S，请参见<a href="https://docs.cloudera.com/HDPDocuments/HDF2/HDF-2.1.2/bk_dataflow-administration/content/site_to_site_properties.html">此处</a> 。</em> <em><br><br></em>  <em>在那些使用S2S进行数据传输的情况下-一个实例称为客户端，第二个服务器。</em>  <em>客户端发送数据，服务器发送。</em>  <em>配置它们之间的数据传输的两种方法：</em> <em><br><br></em> <ol><li>  <strong>推入</strong> 从客户端实例，使用远程进程组（RPG）发送数据。 在服务器实例上，使用输入端口接收数据。 </li><li>  <strong>拉力</strong> 服务器使用RPG接收数据，客户端使用输出端口发送数据。 </li></ol><hr><br> 我们将滚动流程存储在Apache注册表中。 <br><br><hr>  <em>Apache NiFi Registry是Apache NiFi的子项目，提供了用于存储流和版本控制的工具。</em>  <em>一种git。</em>  <em>有关安装，配置和使用注册表的信息，请参见<a href="https://nifi.apache.org/registry">官方文档</a> 。</em>  <em>用于存储的流被组合到一个过程组中，并以此形式存储在注册表中。</em>  <em>在本文的进一步部分，我们将回到这一点。</em> <em><br></em> <hr><br> 首先，当N为小数时，将在可接受的时间内手动传递和更新流。 <br><br> 但是随着N的增长，还有更多的问题： <br><br><ol><li> 更新流程需要更多时间。 有必要去所有的服务器 </li><li> 更新模板时出错。 在这里他们更新了，但是在这里他们忘记了 </li><li> 执行大量相同类型的操作时出现人为错误 </li></ol><br> 所有这些使我们得出一个事实，那就是我们需要使流程自动化。 我尝试了以下方法来解决此问题： <br><br><ol><li> 使用MiNiFi代替NiFi </li><li>  NiFi CLI </li><li>  NiPyAPI </li></ol><br><h1> 使用MiNiFi </h1><br>  <a href="https://nifi.apache.org/minifi/index.html">Apache MiNiFy</a>是Apache NiFi的子项目。  MiNiFy是一种紧凑型代理，使用与NiFi相同的处理器，使您可以创建与NiFi中相同的流。 除其他因素外，由于MiNiFy没有用于流程配置的图形界面，因此可以实现代理的轻便性。  MiNiFy中缺少图形界面，这意味着有必要解决minifi中流传输的问题。 由于MiNiFy已在IOT中得到积极使用，因此有许多组件，并且将流传输到最终minifi实例的过程需要自动化。 熟悉的任务，对不对？ <br><br> 另一个子项目-MiNiFi C2 Server将帮助解决此问题。 该产品旨在成为滚动配置体系结构的中心点。 如何配置环境- <a href="https://habr.com/ru/company/itsumma/blog/415933/">本文</a>在Habré上进行了介绍，并提供了足够的信息来解决该任务。  MiNiFi与C2服务器一起可以在家中自动更新配置。 这种方法的唯一缺点是，您必须在C2服务器上创建模板，简单的注册表提交是不够的。 <br><br> 上面文章中描述的选项正在运行，并且很难实现，但是请不要忘记以下内容： <br><br><ol><li> 在minifi中，并非所有来自nifi的处理器 </li><li>  Minifi中的处理器版本落后于NiFi中的处理器版本。 </li></ol><br> 在撰写本文时，NiFi的最新版本是1.9.2。 最新的MiNiFi版本的处理器版本为1.7.0。 可以将处理器添加到MiNiFi，但是由于NiFi和MiNiFi处理器之间的版本差异，这可能无法正常工作。 <br><br><h1>  NiFi CLI </h1><br> 从官方网站上<a href="https://nifi.apache.org/docs/nifi-docs/html/toolkit-guide.html">对该</a>工具的<a href="https://nifi.apache.org/docs/nifi-docs/html/toolkit-guide.html">描述</a>来看，它是一种用于自动化NiFI和NiFi Registry在流程交付或过程控制领域中交互作用的工具。 首先，必须<a href="https://nifi.apache.org/download.html">从此处</a>下载该工具。 <br><br> 运行实用程序 <br><br><pre><code class="plaintext hljs">./bin/cli.sh _ ___ _ Apache (_) .' ..](_) , _ .--. __ _| |_ __ )\ [ `.-. | [ |'-| |-'[ | / \ | | | | | | | | | | ' ' [___||__][___][___] [___]', ,' `' CLI v1.9.2 Type 'help' to see a list of available commands, use tab to auto-complete.</code> </pre> <br> 为了使我们能够从注册表中加载必要的流程，我们需要知道篮子的标识符（存储桶标识符）和流程本身（流程标识符）。 可以通过cli或NiFi注册中心网络界面获取此数据。  Web界面如下所示： <br><br><img src="https://habrastorage.org/webt/32/zw/e-/32zwe-t2p220zehsvlpy_1se6py.png"><br><br> 使用CLI可以做到这一点： <br><br><pre> <code class="plaintext hljs">#&gt; registry list-buckets -u http://nifi-registry:18080 # Name Id Description - -------------- ------------------------------------ ----------- 1 test_bucket 709d387a-9ce9-4535-8546-3621efe38e96 (empty) #&gt; registry list-flows -b 709d387a-9ce9-4535-8546-3621efe38e96 -u http://nifi-registry:18080 # Name Id Description - ------------ ------------------------------------ ----------- 1 test_flow d27af00a-5b47-4910-89cd-9c664cd91e85</code> </pre><br> 我们从注册表开始导入流程组： <br><br><pre> <code class="plaintext hljs">#&gt; nifi pg-import -b 709d387a-9ce9-4535-8546-3621efe38e96 -f d27af00a-5b47-4910-89cd-9c664cd91e85 -fv 1 -u http://nifi:8080 7f522a13-016e-1000-e504-d5b15587f2f3</code> </pre><br> 重要的一点是，可以将任何nifi实例指定为我们在其上滚动进程组的主机。 <br><br> 添加了已停止处理器的进程组，必须启动它们 <br><br><pre> <code class="plaintext hljs">#&gt; nifi pg-start -pgid 7f522a13-016e-1000-e504-d5b15587f2f3 -u http://nifi:8080</code> </pre><br> 太好了，处理器开始了。 但是，根据问题的情况，我们需要NiFi实例将数据发送到其他实例。 假设您选择Push方法将数据传输到服务器。 为了组织数据传输，您需要在添加的远程进程组（RPG）上启用数据传输（启用传输），该组已经包含在我们的流程中。 <br><br><img src="https://habrastorage.org/webt/bh/7w/_m/bh7w_m1qbd_5pbookh6hex9nkqs.png"><br><br> 在CLI和其他来源的文档中，我找不到启用数据传输的方法。 如果您知道该怎么做，请在评论中写。 <br><br> 既然我们有重击，并且我们准备走到尽头-我们将找到一条出路！ 您可以使用NiFi API解决此问题。 我们使用以下方法，从上面的示例中获取ID（在我们的示例中为7f522a13-016e-1000-e504-d5b15587f2f3）。  NiFi API方法的说明在<a href="https://nifi.apache.org/docs/nifi-docs/rest-api/index.html">此处</a> 。 <br><br><img src="https://habrastorage.org/webt/ii/nx/9c/iinx9ckcphh4vdld6_8vwjra8mc.png"><br> 在正文中，您需要传递以下格式的JSON： <br><br><pre> <code class="plaintext hljs">{ "revision": { "clientId": "value", "version": 0, "lastModifier": "value" }, "state": "value", "disconnectedNodeAcknowledged": true }</code> </pre><br> 为了“工作”必须填写的参数： <br>  <strong>状态</strong> -数据传输状态。 可用的TRANSMITTING启用数据传输，STOPPED关闭 <br>  <strong>版本</strong> -处理器版本 <br><br> 创建时，版本默认为0，但是可以使用方法获得这些参数 <br><br><img src="https://habrastorage.org/webt/5x/ul/nv/5xulnvdp0w9a-jtf3oqapfbdghs.png"><br><br> 对于喜欢bash脚本的人来说，这种方法似乎很合适，但是对我来说很难-bash脚本不是我的最爱。 我认为以下方法更有趣且更舒适。 <br><br><h1>  NiPyAPI </h1><br>  NiPyAPI是用于与NiFi实例进行交互的Python库。  <a href="https://nipyapi.readthedocs.io/en/latest/">文档页面</a>包含使用库的必要信息。 快速启动在github <a href="https://github.com/Chaffelson/nipyapi">项目</a>中进行了描述。 <br><br> 我们用于部署配置的脚本是Python程序。 我们通过编码。 <br> 我们配置配置以进行进一步的工作。 我们将需要以下参数： <br><br><pre> <code class="plaintext hljs">nipyapi.config.nifi_config.host = 'http://nifi:8080/nifi-api' #  nifi-api ,    process group nipyapi.config.registry_config.host = 'http://nifi-registry:18080/nifi-registry-api' #  nifi-registry-api registry nipyapi.config.registry_name = 'MyBeutifulRegistry' # registry,      nifi nipyapi.config.bucket_name = 'BucketName' # bucket,    flow nipyapi.config.flow_name = 'FlowName' # flow,  </code> </pre><br> 此外，我将插入此库的方法名称，在此进行描述。 <br><br> 使用以下命令将注册表连接到Nifi实例 <br><br><pre> <code class="plaintext hljs">nipyapi.versioning.create_registry_client</code> </pre> <br> 在这一步，您还可以添加检查注册表是否已经添加到实例中；为此，您可以使用方法 <br><br><pre> <code class="plaintext hljs">nipyapi.versioning.list_registry_clients</code> </pre> <br> 找到一个桶以进一步搜索篮子中的流量。 <br><br><pre> <code class="plaintext hljs">nipyapi.versioning.get_registry_bucket</code> </pre> <br> 搜索桶中的流量 <br><br><pre> <code class="plaintext hljs">nipyapi.versioning.get_flow_in_bucket</code> </pre> <br> 此外，重要的是要了解是否已添加此过程组。 将过程组放置在坐标中，并且将第二个组件叠加在一个组件的顶部时，可能会出现这种情况。 我检查了一下，这可以是:)要添加所有流程组，我们使用方法 <br><br><pre> <code class="plaintext hljs">nipyapi.canvas.list_all_process_groups</code> </pre> <br> 然后我们可以搜索，例如按名称搜索。 <br><br> 我不会描述模板的更新过程，只会说，如果在模板的新版本中添加了处理器，那么队列中消息的存在就不会有问题。 但是，如果删除了处理器，则可能会出现问题（如果消息队列前面已累积消息，nifi不允许删除处理器）。 如果您对我如何解决此问题感兴趣-请给我写信，我们将讨论这一点。 文章末尾的联系方式。 让我们继续进行添加流程组的步骤。 <br><br> 在调试脚本时，我遇到了一个功能，即最新的流版本不会总是被提取，因此我建议首先澄清该版本： <br><br><pre> <code class="plaintext hljs">nipyapi.versioning.get_latest_flow_ver</code> </pre> <br> 部署过程组： <br><br><pre> <code class="plaintext hljs">nipyapi.versioning.deploy_flow_version</code> </pre> <br> 我们启动处理器： <br><br><pre> <code class="plaintext hljs">nipyapi.canvas.schedule_process_group</code> </pre> <br> 在CLI块中，写道远程进程组中的数据传输没有自动打开？ 在实施脚本时，我也遇到了这个问题。 当时，我没有成功使用API​​启动数据传输，因此决定写信给NiPyAPI库开发人员并寻求建议/帮助。 开发人员回答了我，我们讨论了问题，他写道他需要时间来“检查”。 现在，几天后，收到一封来信，其中写有Python函数可以解决我的启动问题！！！ 当时，NiPyAPI版本为0.13.3，当然，里面没有类似的东西。 但是在最近发布的0.14.0版本中，此功能已包含在库中。 见面 <br><br><pre> <code class="plaintext hljs">nipyapi.canvas.set_remote_process_group_transmission</code> </pre> <br> 因此，使用NiPyAPI库，我们连接了注册表，滚动流程，甚至启动了处理器和数据传输。 然后，您可以整理代码，添加各种检查，日志记录，仅此而已。 但这是一个完全不同的故事。 <br><br> 在我考虑的自动化选项中，后者在我看来是最有效的。 首先，这仍然是python代码，您可以在其中嵌入辅助程序代码并充分利用编程语言。 其次，NiPyAPI项目正在积极开发中，如有问题，您可以写信给开发人员。 第三，NiPyAPI仍然是与NiFi进行交互以解决复杂问题的更灵活的工具。 例如，在确定消息队列现在是否在流动中是否为空以及是否可以更新过程组时。 <br><br> 仅此而已。 我介绍了3种在NiFi中自动执行流交付的方法，开发人员可能遇到的陷阱并提供了用于自动交付的工作代码。 如果您对此主题同样感兴趣，请<a href="">写下！</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN476722/">https://habr.com/ru/post/zh-CN476722/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN476710/index.html">开放注册：火星深入IT</a></li>
<li><a href="../zh-CN476712/index.html">与陌生人随机开会的服务，但不约会。 随机咖啡启动历史</a></li>
<li><a href="../zh-CN476714/index.html">Mail.ru Mail中机器学习的操作</a></li>
<li><a href="../zh-CN476718/index.html">全国广播的历史：乡村广播电台的墨索里尼和约瑟夫·戈培尔的暖灯</a></li>
<li><a href="../zh-CN476720/index.html">如何在简历阶段确定潜在员工</a></li>
<li><a href="../zh-CN476724/index.html">在Mac Pro 1.1上安装Vmware ESXi</a></li>
<li><a href="../zh-CN476726/index.html">毕业于Innopolis大学，准备在AI的格勒诺布尔大学学习，英语和法语以及带臭虫的奶酪</a></li>
<li><a href="../zh-CN476728/index.html">B2B公司的内容策略：案例和清单</a></li>
<li><a href="../zh-CN476734/index.html">硬盘自我诊断和数据恢复</a></li>
<li><a href="../zh-CN476736/index.html">寻找威胁猎人：如何寻找和培训称职的专家？</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>