<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>  锔 Escribir un cliente de Telegram es f谩cil   </title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="驴Cu谩l es la diferencia entre Telegram y otros mensajeros populares? El esta abierto! 
 Otros mensajeros tambi茅n tienen una API, pero por alguna raz贸n,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Escribir un cliente de Telegram es f谩cil</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/424245/"><p><img src="https://habrastorage.org/webt/74/05/en/7405endgngr3x59c7slog56gha0.png"></p><br><p>  驴Cu谩l es la diferencia entre Telegram y otros mensajeros populares?  El esta abierto! <br>  Otros mensajeros tambi茅n tienen una API, pero por alguna raz贸n, 驴se conoce a Telegram como el m谩s abierto de los m谩s populares? </p><br><p>  Para empezar, Telegram tiene un cliente realmente totalmente abierto. <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">c贸digo</a>  Desafortunadamente, no vemos confirmaciones todos los d铆as directamente en GitHub, pero tenemos un c贸digo bajo una licencia abierta.  La arquitectura de Telegram implica que tanto Bot como API tienen casi los mismos m茅todos: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://core.telegram.org/methods</a> . </p><br><p>  De hecho, Telegram no es solo un mensajero de chat, sino una plataforma social, cuyo acceso est谩 abierto para varios tipos de aplicaciones.  Pueden proporcionar chips adicionales a los usuarios, en lugar de utilizar una red de usuarios y servidores listos para enviar mensajes.  Suena tan atractivo que quer铆amos intentar escribir a nuestro "cliente" para Telegramas. </p><a name="habracut"></a><br><h3 id="sut-prilozheniya">  La esencia de la aplicaci贸n. </h3><br><p>  Principalmente nos ocupamos de los mapas y la navegaci贸n, por lo que inmediatamente analizamos algo relacionado con la geolocalizaci贸n.  Realmente me gust贸 que en Telegram, antes de todas las dem谩s aplicaciones, hab铆a una manera conveniente de compartir su ubicaci贸n en tiempo real ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://telegram.org/blog/live-locations</a> ) y a menudo lo uso: ayudarme a orientarme, mostrar mi camino y Lo m谩s importante es responder la pregunta principal "驴Cu谩ndo estar谩s?".  En principio, esto es suficiente para la mayor铆a de las personas, pero como siempre hay escenarios en los que las oportunidades simples no son suficientes.  Por ejemplo, puede ser un grupo de m谩s de 10 personas, con diferentes dispositivos (algunos dispositivos pueden no ser tel茅fonos) y diferentes personas.  Ser铆a conveniente para estas personas intercambiar mensajes en un grupo, as铆 como verse mutuamente movi茅ndose en un mapa. </p><br><p>  Nos centramos en la tarea de crear valor adicional para Telegram y no tratar de usarlo para otros fines.  No quer铆amos que las personas que no ten铆an un cliente especial de Telegram vieran un desorden de mensajes en el chat o algo ininteligible.  Las personas con un cliente "mejorado" tienen oportunidades adicionales, por ejemplo: </p><br><ol><li>  Gesti贸n de tiempo m谩s precisa al enviar ubicaciones en tiempo real para chatear. </li><li>  Ver la ubicaci贸n de los contactos en el mapa. </li><li>  Conexi贸n al chat de dispositivos beacon a trav茅s de una API externa (Bot). </li></ol><br><h3 id="kak-my-eto-delali">  Como lo hicimos </h3><br><p>  Afortunadamente, todo el c贸digo que escribimos es de c贸digo abierto, por lo que puedo dar inmediatamente un enlace a su implementaci贸n: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Implementaci贸n de</a> <a href="">Bot</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Implementaci贸n de cliente de Telegram en Kotlin</a> . </p><br><h5 id="bot---osnovy">  Bot - lo b谩sico </h5><br><p>  Hay mucha documentaci贸n y ejemplos sobre la implementaci贸n de Bot, pero aun as铆 quiero hablar sobre algunas de las dificultades.  Para empezar, escribimos el lado del servidor <br>  en Java y eleg铆 la biblioteca org.telegram: telegrambots.  Como nuestro servidor es un SpringBoot normal, la inicializaci贸n es extremadamente simple: </p><br><pre><code class="hljs coffeescript"><span class="hljs-regexp"><span class="hljs-regexp">//</span></span> Gradle implementation <span class="hljs-string"><span class="hljs-string">"org.telegram:telegrambots:3.6"</span></span> TelegramBotsApi telegramBotsApi = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TelegramBotsApi(); telegramBotsApi.registerBot(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TelegramLongPollingBot() {...});</code> </pre> <br><p>  La caracter铆stica principal de la transferencia de ubicaci贸n es que debe actualizarse con frecuencia y el bot debe editar los mensajes ya enviados.  Si no hubiera tal oportunidad, Bot simplemente enviar铆a spam al chat y, por supuesto, ser铆a Epic Fail.  Gracias a Dios Telegram le da al bot el derecho de editar mensajes durante 24 horas (m铆nimo, posiblemente m谩s). </p><br><p>  Hay muchas formas de enviar un mensaje.  Hay texto sin formato, lugar, ubicaci贸n, juego, contacto, factura, etc.  Parec铆a que la ubicaci贸n era perfecta para nuestra tarea, pero se revel贸 una caracter铆stica desagradable.  隆La ubicaci贸n solo se puede transferir de un dispositivo a una cuenta o bot a la vez!  Imagina que tienes 2 tel茅fonos y desde dos tel茅fonos enviaste tu ubicaci贸n en un chat.  Por lo tanto, se producir谩 un error en el servidor y la primera ubicaci贸n compartida simplemente se detendr谩.  Parece que este es claramente un caso neuronal, pero imagine que tiene muchas balizas chinas que pueden enviar Ubicaci贸n a una URL determinada, pero no pueden enviar directamente a Telegram.  Escribes Bot, que recoge del servidor y empuja telegramas.  Aqu铆 es donde se descubre que Bot no podr谩 enviar m谩s de un mensaje de baliza con el tipo de ubicaci贸n.  Resulta que esto es ideal para el env铆o de una sola vez, pero no es adecuado para Live Location. </p><br><p>  La soluci贸n es simple: env铆e mensajes de texto y el cliente analizar谩 el texto y mostrar谩 las ubicaciones en el mapa.  Desafortunadamente, solo los mensajes de texto ser谩n visibles en el cliente est谩ndar de Telegram, pero puede insertar un enlace all铆 para abrir el mapa. </p><br><h5 id="bot---podvodnye-kamni">  Bot - trampas </h5><br><p>  Desafortunadamente, Bot tuvo que reescribir hasta 2.5 veces.  El principal problema es el dise帽o incorrecto de la comunicaci贸n. </p><br><ol><li>  Por alguna raz贸n, al principio parec铆a una buena idea si el robot ser铆a un participante de pleno derecho en el chat y enviar铆a mensajes.  Pero, esto es malo tanto en t茅rminos de privacidad de la correspondencia como en t茅rminos de interacci贸n con el bot.  La decisi贸n correcta, usa <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">bots en l铆nea</a> .  Por lo tanto, se garantiza que el bot no ve nada m谩s que su ubicaci贸n y se puede usar en cualquier chat.  Hablando humanamente, no es cultural arrastrar tu bot a alg煤n tipo de chat general, pero debes hablar con el bot uno a uno y configurarlo, y luego podr谩 enviar los mensajes necesarios a cualquier chat seleccionado. </li><li>  Hist贸ricamente hay 2 tipos de interacci贸n en la API de mensajes de Telegram: botones debajo del texto ((botones en l铆nea) [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://core.telegram.org/bots/2-0-intro#switch-to-inline-buttons</a> ]) y respuestas al bot directamente texto  En general, las respuestas con el bot est谩n irremediablemente desactualizadas.  Los botones son un poco m谩s complicados desde el punto de vista de la implementaci贸n, pero esto se paga por la facilidad de uso y deben usarse para todas las entradas que no sean de texto. </li><li>  Como ejemplo de un bot, puedes ver el popular @vote_bot o nuestro @osmand_bot. </li></ol><br><h5 id="telegram-client">  Telegram Client </h5><br><p>  No pudimos encontrar ejemplos de clientes de telegramas listos, excepto el principal, pero la estructura bastante simple de tdlib nos ayud贸 a crear un cliente b谩sico en solo un par de d铆as. </p><br><div class="spoiler">  <b class="spoiler_title">Configuraci贸n de Gradle:</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">task downloadTdLibzip { doLast { ant.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(src: <span class="hljs-string"><span class="hljs-string">'https://core.telegram.org/tdlib/tdlib.zip'</span></span>, dest: <span class="hljs-string"><span class="hljs-string">'tdlib.zip'</span></span>, skipexisting: <span class="hljs-string"><span class="hljs-string">'true'</span></span>) ant.unzip(src: <span class="hljs-string"><span class="hljs-string">'tdlib.zip'</span></span>, dest: <span class="hljs-string"><span class="hljs-string">'tdlib/'</span></span>) } } task copyNativeLibs(<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">Copy</span></span>) { dependsOn downloadTdLibzip <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> "tdlib/libtd/src/main/libs" <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> "libs" } task copyJavaSources(<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">Copy</span></span>) { dependsOn downloadTdLibzip <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> "tdlib/libtd/src/main/java/org/drinkless/td" <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> "src/org/drinkless/td" } dependencies { implementation fileTree(dir: <span class="hljs-string"><span class="hljs-string">'libs'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">include</span></span>: [<span class="hljs-string"><span class="hljs-string">'*.jar'</span></span>]) }</code> </pre> </div></div><br><p>  Casi todas las partes internas del Telegram est谩n escritas en C ++ y desde el punto de vista de Android, solo la clase API es visible en los m茅todos proxy <a href="">TdApi.java de</a> 1.5 MB.  Al comparar la documentaci贸n de los bots y el nombre de los m茅todos, simplemente puede averiguar d贸nde moverse. </p><br><div class="spoiler">  <b class="spoiler_title">Inicializaci贸n del cliente con manejador global:</b> <div class="spoiler_text"><pre> <code class="hljs kotlin"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (libraryLoaded) { <span class="hljs-comment"><span class="hljs-comment">// create client client = Client.create(UpdatesHandler(), null, null) true } else { false } }</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Solicitud de foto de usuario:</b> <div class="spoiler_text"><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">requestUserPhoto</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(user: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">TdApi</span></span></span></span><span class="hljs-function"><span class="hljs-params">.</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">User</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> remotePhoto = user.profilePhoto?.small?.remote <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (remotePhoto != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; remotePhoto.id.isNotEmpty()) { downloadUserFilesMap[remotePhoto.id] = user client!!.send(TdApi.GetRemoteFile(remotePhoto.id, <span class="hljs-literal"><span class="hljs-literal">null</span></span>)) { obj -&gt; <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> (obj.<span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>) { TdApi.Error.CONSTRUCTOR -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> error = obj <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> TdApi.Error <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> code = error.code <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (code != IGNORED_ERROR_CODE) { listener?.onTelegramError(code, error.message) } } TdApi.File.CONSTRUCTOR -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> file = obj <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> TdApi.File client!!.send(TdApi.DownloadFile(file.id, <span class="hljs-number"><span class="hljs-number">10</span></span>), defaultHandler) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> -&gt; listener?.onTelegramError(-<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"Receive wrong response from TDLib: </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$obj</span></span></span><span class="hljs-string">"</span></span>) } } } }</code> </pre> </div></div><br><h5 id="telegram-client---podvodnye-kamni">  Telegram Client - trampas </h5><br><ol><li>  Registro / inicio de sesi贸n y cierre de sesi贸n.  Al registrarse, es necesario tener en cuenta diferentes escenarios: cuando el c贸digo de acceso se env铆a por SMS u otro cliente de telegramas, autorizaci贸n de dos factores, etc.  El mayor desaf铆o es probar.  Cualquier autorizaci贸n m谩s de 3 veces condujo al bloqueo de la cuenta durante 24 horas, por lo que probar Logout fue especialmente divertido.  A pesar de que el registro se necesita solo una vez, esta es probablemente la parte m谩s dif铆cil de la integraci贸n. </li><li>  Determine c贸mo y en qu茅 orden leer los mensajes.  Cualquier cliente tiene acceso a todos los mensajes en todos los chats, pero deben leerse secuencialmente.  En nuestro caso, el 99% de los mensajes deben descartarse.  Primero, por alguna raz贸n, le铆mos todos los mensajes de los 煤ltimos 3 d铆as con un inicio de sesi贸n, pero luego solo caus贸 problemas y cuando reiniciamos, los mensajes desaparecieron.  Por lo tanto, ahora solo leemos mensajes nuevos y, para los mensajes que necesitamos, guardamos la identificaci贸n en la base de datos interna. </li></ol><br><h3 id="chto-poluchilos">  Que paso </h3><br><p>  Probablemente, conociendo todas las trampas, uno podr铆a hacer todo muchas veces m谩s r谩pido, pero result贸 para aproximadamente 1-2 meses para tres personas.  La aplicaci贸n final se puede encontrar en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Google Play</a> . </p><br><p><img src="https://habrastorage.org/webt/gf/o0/zs/gfo0zsgavbn09pkswyzurjoibik.png"></p><br><p>  La pregunta principal en esta historia es cu谩n correcta es esta interacci贸n desde el punto de vista de Telegram y si a los usuarios les gusta este tipo de integraci贸n.  En cualquier caso, la idea en s铆 misma es un nicho y ya ha encontrado clientes individuales. </p><br><p>  Estar茅 encantado de responder a sus preguntas. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es424245/">https://habr.com/ru/post/es424245/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es424235/index.html">C贸mo usar STATSPACK en lugar de AWR en Oracle Standard Edition</a></li>
<li><a href="../es424237/index.html">隆Carga tus cerebros directamente! Tiempos de ejecuci贸n, compiladores y rendimiento en Joker 2018</a></li>
<li><a href="../es424239/index.html">Seminarios de oto帽o de IBM: Contenedores, Visi贸n por computadora, Transformaci贸n digital</a></li>
<li><a href="../es424241/index.html">Imprime tu mundo</a></li>
<li><a href="../es424243/index.html">5 maneras f谩ciles de mejorar la comunicaci贸n con los clientes</a></li>
<li><a href="../es424247/index.html">KotlinConf 2018 Live - vea la transmisi贸n del 4 al 5 de octubre</a></li>
<li><a href="../es424249/index.html">Materiales de la reuni贸n #RuPostgres - videos, presentaciones, an谩lisis de cuestionarios y reportaje fotogr谩fico</a></li>
<li><a href="../es424251/index.html">Consideramos estad铆sticas sobre experimentos en hh.ru</a></li>
<li><a href="../es424255/index.html">C贸mo usar el an谩lisis est谩tico correctamente</a></li>
<li><a href="../es424257/index.html">Mapas de hex谩gono en Unity: partes 1-3</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>