<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§≥üèø üñ®Ô∏è üçú Lutando por recursos, parte 5: Come√ßando do zero üë®‚Äçüåæ üí™üèΩ üôåüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Continuamos a estudar cgroups. No Red Hat Enterprise Linux 7, eles s√£o ativados por padr√£o, porque ele usa systemd, e ele, por sua vez, j√° possui cgro...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Lutando por recursos, parte 5: Come√ßando do zero</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/redhatrussia/blog/429064/"> Continuamos a estudar cgroups.  No Red Hat Enterprise Linux 7, eles s√£o ativados por padr√£o, porque ele usa systemd, e ele, por sua vez, j√° possui cgroups embutidos.  Com o Red Hat, o Red Hat Enterprise Linux 6 √© um pouco diferente.  De fato, os controladores cgroups estavam l√° inicialmente, mas esta vers√£o foi lan√ßada, lembre-se de janeiro de 2010, isto √©, alguns s√©culos atr√°s, em termos de anos de computador. <br><br><img src="https://habrastorage.org/webt/7y/lx/mw/7ylxmwyn3vgxxrj7b6utthzftwk.png" width="100%"><br><br>  No entanto, os cgroups no Red Hat Enterprise Linux 6 s√£o capazes de muito ainda hoje, o que ilustraremos hoje. <br><a name="habracut"></a><br>  Vamos analisar os recursos dos cgroups no Red Hat Enterprise Linux 6 usando um exemplo puramente hipot√©tico, baseado inteiramente em eventos reais.  Mas para iniciantes, por tradi√ß√£o, uma pequena digress√£o. <br><br>  Nunca houve tantos problemas com a seguran√ßa de TI como agora.  N√£o √© de surpreender, porque hoje n√£o apenas todos os computadores e telefones est√£o conectados √† rede, mas tamb√©m geladeiras, aspiradores de p√≥ e v√°rias outras coisas - a possibilidade de amea√ßas √† rede √© simplesmente imensa.  E a luta contra essas amea√ßas, em regra, come√ßa imediatamente em todas as frentes.  Instala√ß√£o r√°pida de patches de seguran√ßa?  Sim definitivamente!  Fortalecendo a seguran√ßa do sistema - firewalls, SELinux, autentica√ß√£o inteligente, isso √© tudo?  Claro!  Scanners antiv√≠rus em m√°quinas Linux?  Bem, como dizer ... <br><br>  Em m√°quinas Linux, os antiv√≠rus √†s vezes fazem mais mal do que bem.  No entanto, os guardas de seguran√ßa t√™m seus pr√≥prios motivos e geralmente exigem que voc√™ execute varreduras de antiv√≠rus regularmente, sem realmente pensar na integridade deles do ponto de vista t√©cnico.  E essa √© uma realidade que √© preciso suportar e com a qual, mais cedo ou mais tarde, quase todo especialista em TI enfrenta. <br><br>  O segundo ponto √© que o Red Hat Enterprise Linux 7 √© obviamente moderno, avan√ßado e interessante, mas muitos ainda usam o Red Hat Enterprise Linux 6 e n√£o pensam em recus√°-lo.  De fato, √© por isso que as pessoas escolhem a Red Hat - voc√™ pode permanecer na mesma vers√£o por anos e ainda ter os patches, atualiza√ß√µes e suporte mais recentes. <br><br>  Vamos voltar ao nosso exemplo ... Imagine que existe um cara chamado Jerry.  Jerry trabalha em um grande escrit√≥rio e √© respons√°vel pelo servidor Red Hat Enterprise Linux 6. Ele est√° completamente satisfeito com a forma como eles funcionam e n√£o precisa de novos problemas e restri√ß√µes. <br><br>  Mas os funcion√°rios do departamento de seguran√ßa decidem que em todos os servidores dele √© necess√°rio colocar uma coisa chamada ScanIT.  E como essa coisa verifica periodicamente discos e mem√≥ria quanto a v√≠rus e outros malwares, ela precisa de acesso root completo. <br><br>  Jerry suspira, abaixa o viol√£o e vai colocar o ScanIT em uma m√°quina de teste.  Muito rapidamente, acontece o seguinte: <br><br><ul><li>  Ao executar uma verifica√ß√£o antiv√≠rus, o scanit (este √© um script para iniciar o processo) consome todo o tempo do processador que pode atingir.  E isso afeta muito o trabalho da m√°quina de teste - uma vez que Jerry nem conseguia alcan√ß√°-la no ssh. </li><li>  Al√©m disso, o processo scanit consome mem√≥ria de tempos em tempos, como se estivesse dentro de si.  Como resultado, o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">OOM Killer</a> acorda e come√ßa a matar qualquer processo que n√£o seja o pr√≥prio scanit. </li></ul><br>  Em geral, algo precisa ser feito com isso. <br><br>  Jerry pega o viol√£o e, tocando Grateful Dead, come√ßa a pensar.  Muito rapidamente, ocorreu-lhe que os mesmos cgroups do Red Hat Enterprise Linux 7 provavelmente poderiam ajudar aqui, sobre os quais um amigo chamado Alex tocou em seus ouvidos.  Jerry novamente tira o viol√£o e come√ßa a ler as <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">docas</a> enviadas por Alex <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">no Red Hat Enterprise Linux 6</a> .  Acontece que a primeira coisa que ele precisa √© do libcgroup. <br><br>  N√£o h√° libcgroup na m√°quina de teste, ent√£o Jerry come√ßa a instal√°-lo: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/-7/wt/dk/-7wtdk4uuvnhwypqp9oblrgtx60.png"></div><br><br>  Al√©m disso, Jerry inclui dois servi√ßos necess√°rios para o trabalho de cgroups permanentes (persistentes): <br><br><ul><li>  cgconfig - fornece uma interface mais ou menos simples para trabalhar com √°rvores de cgroup.  Jerry certamente poderia montar e configurar o cgroups manualmente, mas por que, se voc√™ pode economizar tempo? </li><li>  cgred - esse √© um mecanismo de regras do cgroup: quando um processo √© iniciado, esse servi√ßo o coloca em um ou outro cgroup de acordo com as regras especificadas. </li></ul><br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ga/i-/4c/gai-4cqblbowiy66etcfkm9wxlc.png"></div><br><br>  Tendo instalado e configurado tudo isso, Jerry pode finalmente prosseguir diretamente para o problema em si.  Depois de refletir cuidadosamente, ele toma a seguinte decis√£o: <br><br><ul><li>  O scanit e seus processos filhos n√£o devem consumir mais de 20% dos recursos da CPU.  De fato, menos ainda - n√£o mais que 20% dos recursos de um n√∫cleo de processador, mesmo em uma m√°quina com v√°rios n√∫cleos.  Nos cgroups, isso √© feito usando cotas de CPU. </li><li>  Quanto √† mem√≥ria, o scanit e seus processos filhos n√£o devem consumir mais que 512 MB de mem√≥ria do sistema.  Se eles est√£o cruzando essa linha, o sistema deve mat√°-los, e n√£o quaisquer outros processos. </li></ul><br><h3>  N√£o h√° necessidade de me dizer o que fazer! </h3><br>  Jerry ter√° que lidar com dois conjuntos de arquivos de configura√ß√£o: <br><ul><li>  /etc/cgconfig.conf - Gerado automaticamente ao instalar o libcgroup. </li><li>  /etc/cgrules.conf - cont√©m um conjunto de regras do conjunto de regras, de acordo com o qual o cgred classifica os processos em execu√ß√£o por grupos do cgroups. </li></ul><br>  Aqui est√° a apar√™ncia do arquivo cgconfig.conf padr√£o: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/jk/7-/ie/jk7-ie0pclu29d7uourgo6mjq6c.png"></div><br><br>  Jerry poderia ter feito as altera√ß√µes necess√°rias diretamente para ele, mas √© melhor usar arquivos conf drop-in para isso.  Como isso funciona?  Se voc√™ colocar (por exemplo, drop-in-drop) na pasta /etc/cgconfig.d qualquer arquivo com a extens√£o .conf, o sistema o processar√° e far√° as altera√ß√µes apropriadas na configura√ß√£o.  Isso √© conveniente porque voc√™ pode criar drop-ins para diferentes tarefas e adicion√°-los ou remov√™-los da configura√ß√£o usando as ferramentas que voc√™ mais gosta (por exemplo, Ansible, bem, ainda √© um blog da Red Hat). <br><br>  Jerry primeiro cria um arquivo drop-in para a CPU: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/li/w6/8u/liw68uvhsmfnz2dwet4g_9rfmhs.png"></div><br><br>  N√≥s olhamos o que temos aqui e como ele funciona. <br><br>  A palavra-chave group simplesmente define o nome do novo cgroup, no nosso caso, scanit.  Dentro das chaves, especificamos os controles cgroup que queremos usar.  Aqui, cpu.cfs_period_us e cpu.cfs_quota_us, eles permitem que voc√™ defina os limites correspondentes no Completely Fair Scheduler, o agendador de kernel usado por padr√£o no Red Hat Enterprise Linux 6. Vamos ver o que est√° escrito sobre eles no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Guia de Gerenciamento de Recursos</a> do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Red Hat Enterprise Linux 6</a> : <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/wr/jp/zx/wrjpzxiksqg-3eos3ammagjg_di.png"></div><br><br>  Em outras palavras, Jerry escreveu isso em seu drop-in: ‚ÄúPara cada processo relacionado ao cgroup chamado scanit, uma vez por segundo, verifique a quantidade de recursos da CPU alocados a ele.  Se o tempo total do processador para todos os processos deste grupo for superior a 200.000 milissegundos, pare completamente de dar tempo ao processador para esses processos ".  Bem, isto √©, alocar para todos os processos no scanit cgroup-group, bem como para os processos filhos, no total, no m√°ximo, 20% do tempo do processador. <br><br>  Ap√≥s reiniciar o cgconfig, o servidor atualizar√° a configura√ß√£o e, se voc√™ entrar no sistema de arquivos, veremos que o scanit est√° agora localizado no diret√≥rio do controlador da CPU: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/2u/is/z9/2uisz9gmmcpjaaqi7zjgauw-pwa.png"></div><br><br>  Isso, √© claro, √© bom, mas ainda precisamos, de alguma forma, empurrar o scanit para esse cgroup.  Crged √© √∫til aqui, por padr√£o, √© algo como isto: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/sm/-d/t5/sm-dt5oeb5xqypbyfgdytjagrci.png"></div><br><br>  Usar este arquivo √© mais ou menos f√°cil.  No entanto, para isso, teremos que editar diretamente o arquivo cgrules.conf, pois o mecanismo de entrada n√£o √© suportado aqui.  Indicamos o usu√°rio ou grupo que possui o processo, bem como o nome do processo espec√≠fico - se voc√™ desejar -, bem como um controlador personalizado e um grupo de destino do cgroup. <br><br>  Em nosso exemplo, em vez do scanit antiv√≠rus real, usamos um script que tamb√©m √© chamado scanit, mas na verdade apenas emula a carga.  Sem o cgroup, tudo fica assim: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/rz/9e/jr/rz9ejrq2hvosc8tx6qygwtlprju.png"></div><br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/zg/_q/5w/zg_q5wnmcxzrirruk73ium-l4xg.png"></div><br><br>  A CPU est√° totalmente ocupada, principalmente pelo espa√ßo do usu√°rio e um pouco de sistema. <br><br>  Jerry co√ßa a barba.  Inicia o vi e, usando exatamente um dedo indicador, faz algumas altera√ß√µes e reinicia o daemon cgred: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/dn/sq/br/dnsqbrojxhtx0holtc3i-5f6uco.png"></div><br><br>  Em seguida, ele lan√ßa manualmente o scanit ...: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/qa/o2/um/qao2umbcrsuefcn1n9m1jtrojtq.png"></div><br><br>  E - Sa√∫de!  Vit√≥ria <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ik/vi/mr/ikvimrn0d_pkujdyjdaefnxzgsa.png"></div><br><br>  Como voc√™ pode ver, nossos processos de emula√ß√£o de carga (processos filhos de scanits) agora consomem um total de 20% dos recursos da CPU, principalmente no espa√ßo do usu√°rio e um pouco no sistema.  Portanto, esse maldito antiv√≠rus n√£o carregar√° mais o carro com total insanidade. <br><br><h3>  Lembra o que vem a seguir? </h3><br>  Regozijado com o sucesso, Jerry quase esqueceu sua mem√≥ria.  Mas ele ainda se lembra e inicia o vi novamente para corrigir seu arquivo de configura√ß√£o. <br><br>  Agora ele adiciona duas configura√ß√µes em rela√ß√£o √† mem√≥ria: <br><ul><li>  Memory.limit_in_bytes - m√°x.  A quantidade de RAM que todos os processos no scanit cgroup podem usar.  E excluindo espa√ßo de troca.  Jerry limita a 256 MB </li><li>  Memory.memsw.limit_in_bytes - m√°x.  Volume de RAM, mais espa√ßo no arquivo de troca, que pode ser alocado para todos os processos no scanit cgroup-group, no total.  Se esse limite for excedido, os processos ser√£o eliminados pelo killer do OOM.  Jerry define para 512 MB. </li></ul><br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/d9/ey/p7/d9eyp7j01qhdzrc_xughbzsatny.png"></div><br><br>  Oh n√£o!  O que est√° errado? <br><br>  Jerry olha para o topo e v√™ que os processos filho do scanit ainda est√£o em execu√ß√£o.  Como este cgroup est√° atualmente em uso, Jerry n√£o pode iniciar o servi√ßo.  Portanto, ele mata processos filho manualmente e reinicia esses servi√ßos. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/8t/er/fb/8terfbxnn3mp4bb-nrdmeasb1s4.png"></div><br><br>  Agora, uma pequena edi√ß√£o no cgred.conf: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/sr/ma/zs/srmazsl7k259dze13dcnjtij_ae.png"></div><br><br>  Para verificar, Jerry executa v√°rias tarefas de scanit de uma s√≥ vez, para que o assassino do OOM funcione com certeza. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/mv/cf/m7/mvcfm7gxz5b_l2ylpptrp5skseo.png"></div><br><br>  Ent√£o Jerry olha para o log do sistema e assente com satisfa√ß√£o - o scanit n√£o pode mais deixar a mem√≥ria em quantidades com impunidade. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/rf/n-/gc/rfn-gcg6nk2lwjz5aelxw6lt9ue.png"></div><br><br>  Esperamos que nossa s√©rie de artigos do cgroups tenha ajudado voc√™ a entender o que √©, como us√°-lo no Red Hat Enterprise Linux 7, como cri√°-lo no Red Hat Enterprise Linux 6 e como us√°-lo em seu ambiente. <br><br><ul><li>  Parte 1 - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">habr.com/company/redhatrussia/blog/423051</a> </li><li>  Parte 2 - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">habr.com/company/redhatrussia/blog/424367</a> </li><li>  Parte 3 - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">habr.com/company/redhatrussia/blog/425803</a> </li><li>  Parte 4 - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">habr.com/company/redhatrussia/blog/427413</a> </li><li>  Parte 6 - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">habr.com/company/redhatrussia/blog/430748</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt429064/">https://habr.com/ru/post/pt429064/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt429054/index.html">Encontre N diferen√ßas. Experi√™ncia de teste de layout Tinkoff.ru</a></li>
<li><a href="../pt429056/index.html">F√≠sica, n√£o biologia, torna o envelhecimento inevit√°vel</a></li>
<li><a href="../pt429058/index.html">Usando o Retrofit 2 em um aplicativo Android</a></li>
<li><a href="../pt429060/index.html">O conceito de uma mente ideal. Universal AI</a></li>
<li><a href="../pt429062/index.html">Domando multicast</a></li>
<li><a href="../pt429066/index.html">Como a tripula√ß√£o da aeronave se prepara para a partida</a></li>
<li><a href="../pt429068/index.html">Um post muito corporativo: abertura em Moscou ou por que 10 e 11 de novembro s√£o bons dias para comprar eletr√¥nicos</a></li>
<li><a href="../pt429070/index.html">O Linux n√£o pode ser carregado em novos MacBooks devido ao chip T2</a></li>
<li><a href="../pt429072/index.html">Por que a Kodak morreu e a Fujifilm floresceu: a hist√≥ria de dois cineastas</a></li>
<li><a href="../pt429074/index.html">Boas a√ß√µes para o Google Money: novo desafio de impacto da IA</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>