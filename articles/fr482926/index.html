<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üí° üë©üèª‚Äçüè´ üë®‚Äçüëß Arc est un syst√®me de contr√¥le de version pour un monorepositaire. Rapport Yandex ‚ôäÔ∏è üßïüèΩ üíë</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Les syst√®mes de contr√¥le de version sont depuis longtemps un outil quotidien pour les d√©veloppeurs. Dans les grands monorepositoires, leurs exigences ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Arc est un syst√®me de contr√¥le de version pour un monorepositaire. Rapport Yandex</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/482926/">  Les syst√®mes de contr√¥le de version sont depuis longtemps un outil quotidien pour les d√©veloppeurs.  Dans les grands monorepositoires, leurs exigences sont tr√®s sp√©cifiques.  Pour cette raison, les entreprises adaptent les solutions existantes, comme Facebook le fait avec Mercurial et Microsoft avec Git, ou d√©veloppent leurs propres syst√®mes: Piper et CitC sur Google et Arc VCS sur Yandex. <br><br>  Dans le rapport, le d√©veloppeur Vladimir Kikhtenko <a href="https://habr.com/ru/users/kikht/" class="user_link">kikht</a> explique pourquoi Yandex avait besoin de son propre syst√®me de contr√¥le de version et comment cela fonctionne.  Consid√©rez-le du c√¥t√© d'un d√©veloppeur ordinaire: comment acc√©der au code source, mettre de c√¥t√© une branche pour le d√©veloppement et int√©grer les modifications dans une base de code commune.  Nous regardons sous le capot - nous apprenons la repr√©sentation interne des donn√©es et leur affichage dans un syst√®me de fichiers virtuel avec une copie de travail.  Nous discuterons des difficult√©s de mise en ≈ìuvre des fonctions VCS dans un syst√®me de fichiers virtuel et lors du chargement de donn√©es paresseux.  Parlons de la fa√ßon de garantir la fiabilit√© de l'infrastructure de serveur du r√©f√©rentiel.  <a href="https://habr.com/ru/company/yandex/blog/482926">√Ä la fin,</a> vous pouvez voir un enregistrement non officiel du rapport. <br><br>  - Bonjour tout le monde, je m'appelle Vladimir.  Vous avez tous entendu des discours disant de ne pas √©crire de v√©los.  Mon rapport sera de l'autre c√¥t√© de la barricade. <br><a name="habracut"></a><br>  En effet, Yandex poss√®de un monorepositaire dans lequel il y a beaucoup de code.  Et nous sommes arriv√©s √† la conclusion que nous d√©veloppons notre propre syst√®me de contr√¥le de version. <br><br><img src="https://habrastorage.org/webt/l3/y8/lq/l3y8lqxua4etd-ukds2vvc5kxkg.jpeg"><br><br>  Comment en sommes-nous arriv√©s √† une telle vie?  Historiquement, ce monorepositaire a v√©cu avec nous dans SVN.  Il pratique le d√©veloppement bas√© sur le tronc.  Il n'y a pas de succursales avec tr√®s peu d'exceptions.  Tout le code doit d'abord entrer dans le coffre, puis devenir plein. <br><br>  Avec la croissance du r√©f√©rentiel, le seul moyen possible de travailler avec lui √©tait le paiement s√©lectif, car il est pris en charge dans SVN.  Le t√©l√©chargement de l'ensemble du r√©f√©rentiel pour vous-m√™me n'est pas enti√®rement impossible, mais travailler avec lui est tr√®s difficile. <br><br><img src="https://habrastorage.org/webt/rw/i0/wa/rwi0wambw-yjb_ahmiwoytmvytk.jpeg"><br><br>  Quelle est l'ampleur de notre probl√®me?  Voici quelques chiffres: 6 millions de commits, pr√®s de 2 millions de fichiers individuels.  La taille totale avec l'historique complet du r√©f√©rentiel est de 2 To.  Pour clarifier la signification de ces chiffres par rapport √† d'autres r√©f√©rentiels typiques, voici un graphique.  La m√©diane GitHub est la taille m√©diane du r√©f√©rentiel sur GitHub, 1 Mo.  Le 90e centile sur GitHub est ce que mes coll√®gues ont appel√© le "r√©f√©rentiel du fils de la petite amie de ma m√®re".  Et tout le reste, ce sont les fameux grands r√©f√©rentiels. <br><br><img src="https://habrastorage.org/webt/sb/dd/ek/sbddeks2vvyhyzwwmwsotp-etne.jpeg"><br><br>  Pour autant que je sache, le plus grand r√©f√©rentiel au monde est avec Google.  Une estimation de sa taille est donn√©e √† partir d'un article en 2015 - probablement depuis lors, ils ont augment√©.  Comme vous pouvez le voir, l'√©chelle est logarithmique.  On peut voir que nous sommes √©galement assez grands. <br><br>  Comment fonctionnent les diff√©rents syst√®mes de contr√¥le de version lorsque vous essayez de t√©l√©charger l'int√©gralit√© de ce r√©f√©rentiel?  Naturellement, nous n'avons pas imm√©diatement commenc√© √† d√©velopper notre syst√®me de contr√¥le de version.  Nous avons essay√© de convertir notre r√©f√©rentiel en diff√©rents syst√®mes.  La tentative la plus s√©rieuse a √©t√© faite avec Mercurial.  Et les r√©sultats de l'√©poque des op√©rations typiques ne nous conviennent toujours pas. <br><br><img src="https://habrastorage.org/webt/xu/ww/bz/xuwwbztsv7_qyoptjukm2pu3nay.jpeg"><br><br>  Lors de la pr√©paration du rapport, git-svn n'a malheureusement pas pu convertir l'int√©gralit√© de notre r√©f√©rentiel.  J'ai converti une tranche d'un petit nombre de validations, donc je ne peux pas estimer le nombre d'op√©rations li√©es √† l'historique.  Dans un segment, ils sont rapides, et ce que ce sera pour 6 millions de commits n'est pas tr√®s clair. <br><br>  √Ä la fin sont les num√©ros de notre syst√®me de contr√¥le de version.  Vous pouvez instantan√©ment vous procurer une copie de travail.  Au premier d√©marrage, les op√©rations de journalisation sont l√©g√®rement ralenties; au deuxi√®me d√©marrage, tout fonctionne rapidement. <br><br>  Et le dernier chiffre.  Puisque notre syst√®me de contr√¥le de version charge toutes les donn√©es paresseusement, seuls les codes source que nous avons vraiment √©labor√©s, que nous avons vraiment utilis√©s, sont sur le disque.  C'est beaucoup moins que de t√©l√©charger le tout. <br><br><img src="https://habrastorage.org/webt/ig/8e/oh/ig8eohthc8a_mfyfyiaxjslhrka.jpeg"><br><br>  Comment y sommes-nous parvenus?  La principale caract√©ristique: la copie de travail que nous cr√©ons n'est pas un vrai fichier sur disque.  Il s'agit d'un syst√®me de fichiers virtuel.  Sous Linux et Mac, cela se fait avec fusible, sous Windows avec ProjFS.  Nous chargeons toutes les donn√©es paresseusement, donc autant d'espace disque est utilis√© que nous en avons vraiment besoin, nous n'essayons pas de tout charger √† l'avance.  Et nous effectuons toutes sortes d'op√©rations lourdes sur le serveur.  En particulier - le fonctionnement du journal et quelques autres. <br><br><img src="https://habrastorage.org/webt/ig/jg/jw/igjgjww9nzy70irbsg-svup6_vi.jpeg"><br><br>  L'interface de notre syst√®me de contr√¥le de version, dans l'ensemble, r√©p√®te Git, donc je ne montrerai pas √† quoi ressemble un flux de travail typique.  Imaginez Git.  Tout est pareil: checkout pour obtenir la r√©vision souhait√©e, branche pour cr√©er des branches, commit pour les commits, stash est √©galement support√© de la m√™me mani√®re.  Que donne cette approche?  Nous r√©duisons consid√©rablement le seuil d'entr√©e.  La plupart des d√©veloppeurs √† l'int√©rieur et √† l'ext√©rieur de Yandex peuvent travailler avec Git.  Ils n'ont rien √† apprendre de nouveau. <br><br>  D'un autre c√¥t√©, nous n'avons aucun objectif de faire du drop en remplacement de Git.  J'en parlerai plus tard plus en d√©tail.  Pour soutenir toute la vari√©t√© des √©quipes git semble fou, nous avons √† peine besoin de toutes. <br><br><img src="https://habrastorage.org/webt/u2/fh/ke/u2fhkejztyav2rfuwrcsvmwmzv4.jpeg"><br><br>  Je vais vous parler un peu de l'int√©rieur, de la fa√ßon dont tout cela fonctionne.  Commen√ßons par le mod√®le de donn√©es.  Notre mod√®le de donn√©es est tr√®s similaire au mod√®le g√©ographique, avec quelques diff√©rences.  De la m√™me mani√®re, tous les objets que nous cr√©ons √† l'int√©rieur sont immuables, ils sont adress√©s par un hachage de leur contenu, et √† l'int√©rieur ils sont stock√©s dans des tampons plats. <br><br><img src="https://habrastorage.org/webt/0y/xn/5f/0yxn5fgiyjkgkuatsacat0igx44.jpeg"><br><br>  √Ä quoi ressemble la structure?  Il y a des objets commit, chaque commit a un ou plusieurs anc√™tres.  Et de cette fa√ßon, ils construisent des histoires DAG (graphique acyclique dirig√©). <br><br><img src="https://habrastorage.org/webt/vj/gq/ai/vjgqaiudbezdynjexr6ys2qnh30.jpeg"><br><br>  Ce que nous avons et ce qui n'est pas imm√©diatement apparu dans Git, ce sont les nombres de g√©n√©ration.  En utilisant un algorithme simple, nous consid√©rons une certaine distance de la racine de l'arbre.  Pourquoi en avons-nous besoin?  Tout cela est cousu dans la structure des objets, une fois fix√©, et ne change plus jamais. <br><br>  Une op√©ration assez importante pour un syst√®me de contr√¥le de version consiste √† trouver le plus petit anc√™tre commun pour les deux validations.  Dans la version de base, il peut √™tre impl√©ment√© simplement en parcourant en largeur, √† partir de deux points environ, en marquant tous les commits atteints avec l'un ou l'autre signe, d√®s qu'ils trouvent un commit qui a ces deux signes, il y a l'anc√™tre le moins commun. <br><br>  Comment cela fonctionnera-t-il dans une impl√©mentation na√Øve?  Quelque chose comme √ßa: faites le tour et trouvez notre engagement souhait√©. <br><br><img src="https://habrastorage.org/webt/_k/ua/ra/_kuarauekfozlpunbtufesyaxem.gif"><br><br>  Le probl√®me est avec B, qui est superflu.  Il semble que nous ne pouvions pas y entrer, mais nous l'avons examin√©.  Et plus nous avons la diff√©rence entre une branche et un tronc en utilisant un exemple, plus nous trouverons de tels commits suppl√©mentaires.  Dans le cas d'un monorepositaire, lorsque le taux de commits sur un tronc est suffisamment √©lev√©, cette distance peut √™tre tr√®s importante.  Et il y aura des dizaines de milliers de ces commits suppl√©mentaires. <br><br><img src="https://habrastorage.org/webt/ls/qe/ko/lsqekoyn9trz8dxsqejf8tfkvdy.jpeg"><br><br><img src="https://habrastorage.org/webt/b2/_i/ld/b2_ild3rkleepwd-w2gwvnoegak.gif"><br><br>  Dans le cas o√π il y a des num√©ros de g√©n√©ration, nous pouvons utiliser la file d'attente prioritaire lors de l'exploration, et l'analyse ressemblera √† ceci: une fois - et trouvera imm√©diatement ce dont vous avez besoin. <br><br><img src="https://habrastorage.org/webt/xq/dy/hx/xqdyhxj1w29lm5r0j_xdftsmg8y.jpeg"><br><br>  Ceci est un exemple de la diff√©rence entre notre mod√®le.  Dans Git, cette chose √©tait pr√©c√©demment prise en charge, ils utilisaient des horodatages de num√©ros de g√©n√©ration, mais cela ne fonctionnera que si les heures de cr√©ation des validations sont coh√©rentes avec le graphique de validation. <br><br><img src="https://habrastorage.org/webt/l2/nz/ob/l2nzobltj8dcwjfefjrp_dpea68.jpeg"><br><br>  Malheureusement, ce n'est pas le cas pour notre historique de r√©f√©rentiel.  Il y a des commits qui r√©sultent de la migration d'un autre r√©f√©rentiel, et le temps commence √† y reculer.  Dans Git, cette chose a √©t√© prise en charge √† un moment donn√©, mais elle n'est pas toujours applicable ici, car dans Git, vous pouvez remplacer l'objet commit par un autre localement.  L'immunit√© du mod√®le en souffre, donc ces num√©ros de g√©n√©ration qui n'enregistrent pas, ils ne sont parfois pas applicables √† ce qui y est √©crit, ce n'est pas vrai.  Nous n'avons pas un tel probl√®me. <br><br>  Un autre avantage de cette optimisation est qu'elle est compl√®tement locale.  Pour utiliser ces chiffres, nous n'avons pas besoin d'avoir l'int√©gralit√© du graphique de validation.  Et nous ne l'avons g√©n√©ralement pas du tout, avec nous, il est charg√© paresseusement.  Moins nous chargeons paresseusement, mieux nous vivons. <br><br>  Outre les commits, le mod√®le est tr√®s similaire √† Git.  Chaque commit pointe vers un certain objet d'arborescence, l'arborescence est constitu√©e d'enregistrements, chaque enregistrement est soit une autre arborescence, et c'est ainsi que la hi√©rarchie des r√©pertoires est affich√©e en nous, ou c'est un blob, un fichier.  De plus, nous avons une chose telle que BlobRef, lorsque le fichier est tr√®s volumineux, nous le divisons en morceaux et le pr√©sentons dans un objet sp√©cial.  C‚Äôest tout, comme dans Git. <br><br><img src="https://habrastorage.org/webt/zx/ma/yb/zxmaybpia7hh2rnjgzledt6ikg8.jpeg"><br><br>  Qu'est-ce que nous n'aimons pas dans Git?  Nous appelons cette chose copy-info.  Si le fichier a √©t√© copi√© dans une sorte de validation, Git n'enregistre pas ces informations de quelque mani√®re que ce soit, puis essaie de le restaurer avec des heuristiques lorsqu'il vous montre des diff√©rences et des statuts.  Nous enregistrons ces informations dans le graphique.  Les enregistrements peuvent avoir un lien info-copie vers un autre commit, vers le chemin √† l'int√©rieur du r√©f√©rentiel dans ce commit, par lequel nous savons que ce fichier a √©t√© copi√© dans ce commit. <br><br>  Il y a aussi la d√©duplication, car sur le c√¥t√©, ce blob est stock√© une fois.  Mais la d√©duplication serait tout de m√™me, car le contenu du fichier n'a pas chang√©; il aurait √©t√© d√©dupliqu√© par hachage. <br><br>  Comment sont organis√©s les backends?  Si Git dispose d'un syst√®me de contr√¥le de version distribu√©, il n'a pas besoin de backends.  Nous le ressentons particuli√®rement lorsque GitHub est en panne.  Nous comprenons clairement que Git n'a pas besoin de backends.  Notre syst√®me est client-serveur, il stocke toutes les donn√©es sur le serveur et la disponibilit√© du serveur est n√©cessaire pour t√©l√©charger les objets qui ne sont pas encore sur le client. <br><br><img src="https://habrastorage.org/webt/tn/ra/uz/tnrauzebvya5hi9zuvdjsorttxe.jpeg"><br><br>  Toutes les donn√©es que nous stockons dans la base de donn√©es Yandex.  Il s'agit d'une base de donn√©es tr√®s cool qui fournit la transaction, le niveau de fiabilit√© n√©cessaire.  Il a tout ce dont nous avons besoin, et cette chose nous a sauv√©s de nombreux probl√®mes. <br><br>  Gr√¢ce √† cela, les backends eux-m√™mes sont compl√®tement sans √©tat, l'√©tat entier est dans la base de donn√©es et les backends que nous pouvons tr√®s facilement mettre √† l'√©chelle autant que nous en avons besoin. <br><br>  Et pour l'interaction avec les clients, celle des interserveurs, nous utilisons gRPC, il y avait un rapport d√©taill√© √† ce sujet aujourd'hui. <br><br><img src="https://habrastorage.org/webt/ce/xh/at/cexhatxlfxthnfdofvi1wedwexq.jpeg"><br><br>  Comment notre syst√®me est-il int√©gr√© √† SVN?  Le r√©f√©rentiel SVN continue de vivre.  De plus, notre syst√®me de contr√¥le de version n'est pas encore autosuffisant.  Comment fonctionne-t-elle dans cette partie?  Initialement, il existe un composant Converter qui surveille l'√©tat du r√©f√©rentiel SVN et transforme les validations SVN en validations Arc - notre syst√®me de contr√¥le de version. <br><br>  Ensuite, il y a un client qui monte une copie de travail et va au serveur pour les donn√©es.  Lorsqu'un d√©veloppeur valide quelque chose, il est d'abord envoy√© au serveur Arc, mais pour que ces modifications soient transmises au tronc, notre branche principale, il doit passer par le syst√®me de demande de pool et le syst√®me de r√©vision de code.  Voici un autre service qui surveille les branches d'Arc et, si elles sont mises √† jour, envoie une demande de pool √† notre revue de code syst√®me.  Ensuite, le syst√®me de r√©vision du code, lorsqu'il est d√©cid√© que ce correctif doit √™tre fusionn√©, le valide dans SVN.  Pas tout √† fait simple: il y ajoute une certaine quantit√© de m√©tadonn√©es que ce commit est en fait une fusion de telle ou telle branche d'Arc.  Et puis cette validation voit d√©j√† le convertisseur, y trouve ces m√©tadonn√©es et cr√©e une validation sur le serveur Arc.  C'est le cycle des commits.  Par cons√©quent, alors que nous ne pouvons pas vivre sans SVN, parce que nous avons un tronc en SVN. <br><br>  La branche principale est constamment synchronis√©e avec notre serveur, mais nous ne permettons pas de nous y engager directement. <br><br><img src="https://habrastorage.org/webt/gi/a0/-1/gia0-1aqpsq2bt3xsikjhilcr2g.jpeg"><br><br>  √Ä propos de la fiabilit√© des backends.  Bien s√ªr, nous pr√©voyons que tous les d√©veloppeurs Yandex utiliseront cette chose, il est donc important pour nous qu'elle ne casse pas.  Il s'agit d'une telle norme intra-index: nos services doivent survivre √† la d√©faillance de tout centre de donn√©es.  Le syst√®me de contr√¥le de version ne fait pas exception.  Ici, nous sommes grandement sauv√©s par le fait que YDB le supporte.  Et nos backends sont sans √©tat, diff√©rentes parties sont impl√©ment√©es de mani√®re l√©g√®rement diff√©rente.  Les serveurs qui op√®rent sur des objets Arc fonctionnent sur des branches, ils sont sans √©tat, r√©pliqu√©s.  Les convertisseurs qui convertissent constamment √† partir de SVN sont r√©pliqu√©s selon le sch√©ma actif-actif.  Plusieurs convertisseurs fonctionnent simultan√©ment, ils convertissent en m√™me temps et, au moment o√π ils essaient de mettre √† jour la branche Arc, ils r√©solvent les conflits.  L'un a r√©ussi, l'autre a √©chou√©.  Il essaie de convertir quelque chose de plus. <br><br>  Le service de demande de pool est r√©pliqu√© par ma√Ætre-esclave.  Il y en a un principal qui fonctionne.  S'il √©choue, un nouveau est s√©lectionn√© via YDB.  Il y a une chose aussi merveilleuse que les s√©maphores, qui ont de s√©rieuses garanties d'accessibilit√©, de fiabilit√©.  Les acc√®s aux s√©maphores sont compl√®tement s√©rialis√©s.  Nous utilisons des s√©maphores √† la fois pour le service de d√©couverte des demandes de pool et pour la s√©lection des leaders. <br><br>  Un peu sur le fonctionnement du client.  C'est la partie la plus difficile de notre syst√®me de contr√¥le de version, car il existe un syst√®me de fichiers virtuel.  En fait, nous sommes oblig√©s d'impl√©menter nous-m√™mes toutes les op√©rations sur les fichiers.  Je vais passer en revue certaines op√©rations de base, d√©crire grossi√®rement sur les doigts ce qui se passe √† l'int√©rieur lorsque nous les faisons. <br><br><img src="https://habrastorage.org/webt/is/sg/5l/issg5lt5g8ozy9hfmjalxuhhbig.jpeg"><br><br>  Par exemple, nous avons ouvert un fichier pour l'enregistrement.  Lorsque nous avons ouvert le fichier pour l'√©criture, nous trouvons le blob correspondant de notre mod√®le d'objet.  Si n√©cessaire, t√©l√©chargez quelque chose depuis le serveur.  Si nous cr√©ons physiquement un fichier dans un magasin sp√©cial, toutes les autres demandes qui iront √† ce fichier y seront transmises par proxy.  Ainsi, jusqu'√† ce que les modifications localis√©es soient valid√©es (dans Git, cela s'appelle non organis√©), elles entrent dans un stockage temporaire.  Nous appelons ces fichiers mat√©rialis√©s. <br><br><img src="https://habrastorage.org/webt/wi/ig/ar/wiigarboe1byzw6g2dm1tpj3mda.jpeg"><br><br>  Si nous ouvrons le fichier en lecture, nous ne pouvons rien mat√©rialiser, mais simplement donner des donn√©es directement √† partir de notre blob. <br><br><img src="https://habrastorage.org/webt/kt/4w/qg/kt4wqgxgb6p155jfrcsmej5kxek.jpeg"><br><br>  Voici le moment o√π nous ajoutons le fichier √† l'index.  √Ä ce stade, vous devez voir si nous avons quelque chose de concr√©tis√©.  Y a-t-il un fichier qui a chang√©.  Si c'est le cas, cr√©ez un blob pour celui-ci et enregistrez-le dans l'index. <br><br><img src="https://habrastorage.org/webt/-d/qj/lx/-dqjlxli2tamjacrjl2aus-iinu.jpeg"><br><br>  L'op√©ration suivante est l'√©tat de l'arc.  C'est int√©ressant parce que c'est la chose qui dans les syst√®mes de contr√¥le de version conventionnels √† de telles tailles est lent, car il doit parcourir toute l'arborescence des fichiers.  Nous n'avons pas √† parcourir toute l'arborescence des fichiers, car toutes les demandes de changement de fichiers passent par notre pilote de fusible, et nous savons imm√©diatement quels fichiers m√©ritent d'√™tre v√©rifi√©s.  Nous v√©rifions ce que nous avons r√©ussi √† √©crire dans l'index et imprimons la r√©ponse. <br><br><img src="https://habrastorage.org/webt/wa/7f/0e/wa7f0emrhfllexxyj8asf0kplso.jpeg"><br><br>  Engagez le temps.  Tout semble clair.  Il y a un index, nous avons d√©j√† cr√©√© des blobs pour ces objets, cr√©er des objets arborescents qui correspondent √† cet √©tat, cr√©er un nouvel objet commit, l'√©crire dans le stockage d'objets. <br><br><img src="https://habrastorage.org/webt/eb/p4/uj/ebp4ujcdu2jg9vk18vnsgg9by9o.jpeg"><br><br>  Ensuite, nous basculons la copie de travail vers le nouveau commit.  C'est une op√©ration d√©licate, cela peut clairement √™tre fait avec la commande de paiement.  Et ici, vous pourriez penser que tous nos changements locaux semblent s'√™tre d√©j√† mat√©rialis√©s, nous pouvons supposer que nous devons ensuite rendre les fichiers qui ne sont pas mat√©rialis√©s √† partir de nouveaux commits.  Et c'est tout.  Toutes les op√©rations suivantes sont simplement envoy√©es vers un autre arbre et des blobs. <br><br><img src="https://habrastorage.org/webt/ne/qa/cu/neqacudmw91qauhiaoonre_49zm.jpeg"><br><br>  Pourquoi cela ne fonctionnerait-il pas?  La premi√®re version √©tait √† ce sujet.  Le probl√®me r√©side dans toutes sortes d'op√©rations d√©licates comme la r√©initialisation de l'arc ‚Äìsoft.  Ils nous changent d'arborescence, mais ne mat√©rialisent pas les fichiers.  Ils continuent d'exister dans un endroit sacr√©.  Nous avons √©galement des fichiers non suivis et ignor√©s, qui doivent √©galement √™tre trait√©s de mani√®re sp√©ciale.  √Ä cet endroit, nous avons collect√© beaucoup de r√¢teaux et sommes finalement parvenus √† la conclusion que nous devons encore prendre un arbre (maintenant une copie de travail) pendant le paiement, prendre l'arbre du commit vers lequel nous passons, prendre l'index et le nettoyer proprement attendez. <br><br>  Mais en termes de complexit√© des algorithmes, nous n'avons rien perdu ici: tous ces arbres de changements locaux sont proportionnels aux changements que nous avons faits.  Par cons√©quent, nous ne devons pas parcourir tout le r√©f√©rentiel avec ces op√©rations, elles fonctionnent toujours assez rapidement. <br><br>  En m√™me temps, nous faisons de la magie pour que les horodatages que nous donnons aux fichiers soient plus ou moins corrects.  Si nous stockons simplement des fichiers dans le syst√®me de fichiers, il surveille cela et le temps passe toujours.  Ici, nous devons nous rappeler en quelque sorte quel fichier l'utilisateur a vu √† quel moment.  Et s'il est pass√© √† un commit ant√©rieur, ne commencez pas √† lui donner un temps plus t√¥t.  Parce que les syst√®mes d'assemblage, tous les IDE ne sont pas pr√™ts pour cela, ils enl√®vent beaucoup de choses. <br><br><img src="https://habrastorage.org/webt/r7/h7/fd/r7h7fdedl8-aip9z49ovoeb3zci.jpeg"><br><br>  Dans notre syst√®me de contr√¥le de version, la prise en charge du d√©veloppement bas√© sur le tronc est clou√©e.  Tout d'abord, ce que j'ai d√©j√† dit: tous les changements passent par les requ√™tes de pool et le tronc.  Il y a encore quelques points.  Nous n'avons pas de support de branche de groupe.  Les branches cr√©√©es dans Arc sont li√©es √† un utilisateur sp√©cifique, et lui seul peut s'y engager.  Cela nous permet d'√©viter les branches √† longue dur√©e de vie.  Dans SVN, ce n'√©tait pas particuli√®rement, car l√†, il n'est pas pratique de faire des branches.  Et c'est pratique de les faire dans Arc, et si cela n'est pas contr√¥l√©, nous avons peur que certaines parties de notre mono-r√©f√©rentiel partent pour leurs succursales et y conduisent leur d√©veloppement.  C'est contraire au mod√®le que nous voulons faire. <br><br><img src="https://habrastorage.org/webt/uq/9a/bv/uq9abvkh2dunwxijq1vpuqefh7a.jpeg"><br><br>  Deuxi√®mement, nous n'avons pas de commande de fusion.  Toutes les fusions de succursales ont lieu sous notre contr√¥le strict.  Nous d√©veloppons actuellement des branches pour les versions, dans lesquelles il sera √©galement possible de fusionner.  Cela sera √©galement r√©alis√© non pas par une √©quipe d'utilisateurs, mais par des machines de serveurs, tr√®s probablement. <br><br><img src="https://habrastorage.org/webt/qa/dk/yl/qadkylvgcbgyx8lwuvc3n93ix7e.jpeg"><br><br>  Quels sont nos plans?  20% des d√©veloppeurs mono-d√©positaires utilisent d√©j√† notre syst√®me de contr√¥le de version.      -  ,    ,      .   ‚Äî       .   -   80% ,    ,     . ,           ,    Git. <br><br> ,  -     ,         ,       Arc,     SVN    . <br><br>      ‚Äî       ,   CI   .   ,    ,       .      .     . <br><br>    ‚Äî    ,   CI        Arc, - .         ,       .     .      ,      ++-  ,  ,      .     . <br><br>   .      ¬´  Git¬ª.       :   Git.      ,   ,     . <br><br>   .  Git  .      ,       .     -  .       ,        checkout  reset,       .   ,     ,       .   :    Git. ¬´    ,   ¬ª.  Git   . <br><br>        .       Git,  git begin-wave-stash? <br><br>  : <br> ‚Äî  . <br><br> ‚Äî   ,  Git    ?     ‚Äî         ,   ,      ,   .  ,     .  Git   .         ,      .  Je vous remercie <br><br><a name="video"></a><div class="spoiler"> <b class="spoiler_title">  </b> <div class="spoiler_text"><iframe width="560" height="315" src="https://www.youtube.com/embed/PQWdvuo6Gzc" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr482926/">https://habr.com/ru/post/fr482926/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr482908/index.html">La deuxi√®me partie de la traduction du livre Masters of Doom de David Kouchner. Chapitres 6-12</a></li>
<li><a href="../fr482912/index.html">L'id√©e d'un r√©seau social d√©centralis√© de nouvelle g√©n√©ration</a></li>
<li><a href="../fr482918/index.html">Enregistrement de donn√©es dans une EEPROM sur un Arduino de mani√®re transactionnelle</a></li>
<li><a href="../fr482920/index.html">Comment le pilote automatique est entr√© dans nos vies, mais nous n'avons pas remarqu√©</a></li>
<li><a href="../fr482922/index.html">Drupal Digest - 2019 / d√©cembre</a></li>
<li><a href="../fr482928/index.html">Predator Vision: effet de vision thermique</a></li>
<li><a href="../fr482930/index.html">Recherche g√©n√©alogique - livres m√©triques, recensements, archives, bases de donn√©es ouvertes</a></li>
<li><a href="../fr482932/index.html">IIoT - ou comment aider les employ√©s √† utiliser leur cerveau comme pr√©vu</a></li>
<li><a href="../fr482934/index.html">√âchec du projet ERP (Liqui Moly, Otto et autres comme lui)</a></li>
<li><a href="../fr482936/index.html">Introduction √† ASGI: cr√©ation d'un √©cosyst√®me Web Python asynchrone</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>