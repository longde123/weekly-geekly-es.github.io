<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèΩ‚Äçüè´ üë©üèª‚Äçüåæ üßñüèª Obtenemos la contrase√±a maestra del administrador de contrase√±as bloqueadas 1 Contrase√±a 4 ‚ö´Ô∏è ‚òùüèº üßöüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nuevas herramientas, viejos m√©todos. Realizamos ingenier√≠a inversa y encontramos el defecto fatal de 1Password. 

 Todos aman los administradores de c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Obtenemos la contrase√±a maestra del administrador de contrase√±as bloqueadas 1 Contrase√±a 4</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/441166/">  <b>Nuevas herramientas, viejos m√©todos.</b>  <b>Realizamos ingenier√≠a inversa y encontramos el defecto fatal de 1Password.</b> <br><br>  Todos aman los administradores de contrase√±as.  Son geniales por muchas razones.  Personalmente, tengo m√°s de 200 entradas en el administrador.  Con tantos datos confidenciales en un solo lugar, es importante comprender el alcance del da√±o si su registro se ve comprometido, ya sea malware, exploits o simplemente una computadora que no se atiende durante varios minutos.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">El Washington Post</a> public√≥ recientemente un art√≠culo basado en nuestro <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">estudio</a> .  Este art√≠culo ayuda a las personas a darse cuenta de que no todos los administradores de contrase√±as son iguales. <br><br>  Cre√≠a firmemente que un administrador de contrase√±as bloqueadas estaba bien protegido.  Si alguien tiene acceso a mi computadora, entonces el m√°ximo puede contar con un mont√≥n de bytes aleatorios, ya que la informaci√≥n se borra de forma confiable de la memoria. <br><a name="habracut"></a><br>  Esto es cierto para 1Password 4 (Tenga en cuenta que la √∫ltima versi√≥n es la s√©ptima hoy).  Antes de cambiarlo hace unos a√±os, verifiqu√© que realmente no hay contrase√±as claras cuando el administrador est√° en un estado bloqueado.  Entonces, en caso de compromiso, el atacante tendr√° que lidiar con el almacenamiento encriptado. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/527/994/2ed/5279942edfcbb8687d113731500b6953.png"></div><br>  <i><font color="gray">¬°La b√≥veda est√° cerrada!</font></i> <br><br>  En este estado, no hay entradas de contrase√±a o una contrase√±a maestra.  Muy razonable y correcto, y 1Password 4 pas√≥ esta prueba.  O no? <br><br>  Para deshacerme de los detalles aburridos, dir√© de inmediato: pudimos restaurar la contrase√±a maestra de una instancia bloqueada en 1Password 4, como se muestra a continuaci√≥n. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0ad/2c0/d81/0ad2c0d817dd2dc75a942e5b2bd5b974.gif"><br>  <i><font color="gray">Desbloquee 1Password 4 y recupere su contrase√±a maestra</font></i> <br><br>  La animaci√≥n muestra que 1Password 4 se desbloquea primero de la manera normal y luego se bloquea.  Despu√©s de eso, ejecutamos nuestra utilidad <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">multipass</a> , que recupera con √©xito la contrase√±a.  La utilidad explota el procesamiento incorrecto del campo de entrada de contrase√±a en 1Password 4 para restaurar el b√∫fer de contrase√±a maestra ofuscado, desobuscarlo, desbloquear autom√°ticamente 1Password 4 y finalmente mostrar la contrase√±a maestra en la consola. <br><br><h1>  Detalles aburridos </h1><br>  El primer paso para evaluar un administrador de contrase√±as es verificar si hay una contrase√±a maestra clara en la memoria.  Esto es posible en cualquier editor hexadecimal que pueda interactuar con el espacio de memoria del proceso.  Por ejemplo, el editor gratuito de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">HxD</a> .  √öselo para abrir el espacio de memoria 1Password 4. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/38d/87b/b48/38d87bb48b7c4b87f39e44a990cd3f74.png"></div><br><br>  Inmediatamente caemos en el primer √°rea legible del espacio de memoria 1Password 4. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ef4/e95/f2d/ef4e95f2d092a6f236ba53fdfd090787.png"></div><br>  <i><font color="gray">Ejemplo de representaci√≥n de memoria HxD</font></i> <br><br>  Nada especial todav√≠a.  Pero puedes hacer una b√∫squeda.  Por ejemplo, c√≥mo se ve la situaci√≥n si escribe la contrase√±a en la ventana de desbloqueo de 1Password 4, pero no hace clic en el bot√≥n "Desbloquear": <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e6c/d9c/08b/e6cd9c08bee8130e7775a51bd7a91ad0.png"></div><br>  <i><font color="gray">B√≥veda bloqueada 1 Contrase√±a 4 con la contrase√±a maestra ingresada en el campo</font></i> <br><br>  ¬øSeguramente la contrase√±a est√° en alg√∫n lugar de la memoria? <br><br>  Abrimos HxD, pero la b√∫squeda de una l√≠nea con nuestra contrase√±a maestra ("Z3Superpass #") no produce resultados. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b41/066/2c0/b410662c04b7e3d642f05ef94eacc7da.png"></div><br><br>  Parece que 1Password de alguna manera cifra u ofusca el formulario a medida que se ingresa.  Si el procedimiento funciona correctamente, entonces todo est√° bien. <br><br><h1>  Bucear m√°s profundo </h1><br>  Para averiguar por qu√© la contrase√±a maestra no se puede encontrar en la memoria cuando est√° claramente presente en el cuadro de di√°logo de desbloqueo, debe encontrar el c√≥digo que interact√∫a con ella.  Hay varias formas  Puede rastrear el procesamiento de eventos de teclado y mouse localizando 'GetMessage', 'PeekMessage', 'GetWindowText' u otras API de Windows que generalmente manejan la entrada del usuario.  Entonces encontramos el b√∫fer donde se graban las pulsaciones de teclas, y a trav√©s de ellas salimos a la rutina de cifrado / ofuscaci√≥n.  Pero este es un proceso largo y propenso a errores, especialmente con marcos grandes que a veces manejan la memoria de manera muy extra√±a, por lo que debe hacer muchas copias y conversiones para rastrear el b√∫fer. <br><br>  En cambio, utilizamos nuestra propia herramienta Thread Imager, dise√±ada para realizar ingenier√≠a inversa de protocolos propietarios "extra√±os" a nivel de aplicaci√≥n.  Le ayudar√° a determinar d√≥nde en la memoria 1Password 4 interact√∫a con nuestra contrase√±a maestra.  La herramienta "autom√°ticamente" identifica √°reas de c√≥digo en 1Password 4 que interact√∫an con una contrase√±a ofuscada (simplemente resalta las instrucciones que interact√∫an con los datos de inter√©s para su posterior an√°lisis).  El resultado se parece a esto: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b6b/c11/157/b6bc1115787869abc9ba25719b7c060a.gif"><br>  <i><font color="gray">Thread Imager encuentra el c√≥digo 1Password 4 que interact√∫a con una contrase√±a maestra desenfocada</font></i> <br><br>  Dado que la contrase√±a maestra se almacena en la memoria en forma ofuscada, la herramienta primero debe mostrar d√≥nde ocurre la ofuscaci√≥n. <br><br>  Un fragmento del primer resultado muestra que la primera aparici√≥n de la contrase√±a maestra se acompa√±a de una transici√≥n de c√≥digo desde la direcci√≥n 0x7707A75D a 0x701CFA10. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/49b/f32/d7a/49bf32d7a1f5b0bf01f12f7d47685dea.png"></div><br>  <i><font color="gray">Una entrada detallada en Thread Imager resalta la transici√≥n del c√≥digo de 0x7707A75D a 0x701CFA10, mientras que los registros EAX y ECX se refieren al b√∫fer con la contrase√±a maestra</font></i> <br><br>  Examinar este lugar 0x7707A75D en el depurador (x64dbg) confirma nuestra teor√≠a.  De hecho, por primera vez, la cadena 'Z3superpass #' ocurre cuando finaliza la funci√≥n de decodificaci√≥n 'RtlRunDecodeUnicodeString' de la biblioteca ntdll.dll. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/173/cd8/1bb/173cd81bba5c294f9e21c139610ee290.png"><br><br>  Despu√©s de un peque√±o an√°lisis, est√° claro que estas dos funciones se utilizan para ofuscar la contrase√±a: 'RtlRunEncodeUnicodeString' y 'RtlRunDecodeUnicodeString'.  Entonces, la contrase√±a maestra est√° oculta de la copia primitiva de la memoria, por lo que anteriormente no pudimos encontrarla en el editor hexadecimal. <br><br>  Si estudia el b√∫fer codificado al final de la funci√≥n RtlRunEncodeUnicodeString, la l√≠nea cifrada con la contrase√±a maestra se ve as√≠: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d47/547/aec/d47547aecf337b3c33206ddbe3bbad97.png"></div><br>  <i><font color="gray">Contrase√±a maestra cifrada</font></i> <br><br>  Despu√©s de RtlRunDecodeUnicodeString 'se decodifica: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/204/85b/b2b/20485bb2b8b6f40b6509db04bcedf5b1.png"></div><br>  <i><font color="gray">Contrase√±a maestra descifrada</font></i> <br><br>  Curiosamente, esta √°rea se guarda en la misma direcci√≥n 0x00DFA790 y podemos observar literalmente su cambio al ingresar una contrase√±a en la ventana de desbloqueo de 1Password 4: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3cf/d32/83f/3cfd3283fef38c3e5ef0a62630b4372b.gif"></div><br><br><h1>  Vulnerabilidad </h1><br>  'RtlRunEncodeUnicodeString' y 'RtlRunDecodeUnicodeString' son funciones simples que modifican una cadena con una operaci√≥n XOR simple.  Esto no es tan malo: parece ser el m√©todo est√°ndar para enmascarar todos los controles de edici√≥n nativos de Windows con el conjunto de indicadores 'ES_PASSWORD'. <br><br>  El problema es que despu√©s de desbloquear 1Password 4, la contrase√±a maestra cifrada no se borra de la memoria. <br><br>  Peor a√∫n, permanece en la memoria incluso despu√©s de que 1Password 4. est√° bloqueado, es decir, tenemos un almac√©n de contrase√±as bloqueadas, pero con una contrase√±a maestra cifrada en la memoria. <br><br>  Y lo que es peor, dado que interactuamos con el cuadro de di√°logo de entrada de contrase√±a maestra, la misma √°rea de memoria se reutiliza con el mismo valor XOR, lo que nos da f√°cil acceso al b√∫fer codificado para crear un exploit. <br><br><h1>  Desaf√≠o </h1><br>  Para crear un exploit confiable para 1Password 4, debe obtener una imagen m√°s clara de c√≥mo los flujos de trabajo del programa procesan la contrase√±a maestra.  Usando las herramientas antes mencionadas, creamos un diagrama de datos de salida (ver figura a continuaci√≥n). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/453/5e4/763/4535e476369c9114c5fd62f1ec7480c6.png"><br><br>  Este diagrama facilita la comprensi√≥n de d√≥nde y qu√© bibliotecas est√°n involucradas para identificar de manera confiable las √°reas en la memoria donde puede recuperar la contrase√±a maestra. <br><br><h1>  Explotar </h1><br>  ¬øQu√© tenemos en este momento?  Tenemos un almacenamiento bloqueado, y en alg√∫n lugar de la memoria se almacena una contrase√±a ofuscada, porque el programa no limpi√≥ la memoria correctamente. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a77/ac0/8f1/a77ac08f195de46d8e546b1f43ab1415.png"></div><br><br>  Para recuperarlo, debe llamar al procedimiento en 1Password 4, que inicia 'RtlRunEncodeUnicodeString' y 'RtlRunDecodeUnicodeString'.  Por lo tanto, mostrar√° la ubicaci√≥n del b√∫fer de memoria con la contrase√±a maestra codificada. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d47/547/aec/d47547aecf337b3c33206ddbe3bbad97.png"></div><br>  <i><font color="gray">√Årea de memoria con una contrase√±a maestra ofuscada</font></i> <br><br>  Sin este b√∫fer, habr√≠a que sumergirse en el abismo de los procedimientos internos y los controles de Windows y los mecanismos de gesti√≥n de memoria relacionados.  Tal vez este an√°lisis facilita la b√∫squeda de un b√∫fer, pero no fuimos por este camino. <br><br>  Parece que la √∫nica forma de llamar a 'RtlRunEncodeUnicodeString' y 'RtlRunDecodeUnicodeString' es ingresar la contrase√±a maestra en el car√°cter en el cuadro de di√°logo.  Entonces obtenemos el b√∫fer deseado.  Pero no sabemos la longitud de la contrase√±a. <br><br>  Resolvimos este problema interceptando c√≥digo que accede al primer car√°cter de nuestro b√∫fer, bloqueando un intento de cambio.  Esta rutina est√° en el bucle de mensajes de control en comctl32, que maneja el control del b√∫fer de los elementos correspondientes.  Llamar a 'memmove' con desplazamiento 0x70191731 sobrescribe el b√∫fer con el car√°cter ingresado: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/676/8a9/351/6768a9351ed39fe85a98ca9d01368586.png"></div><br>  <i><font color="gray">(Efecto secundario: la l√≠nea resaltada (amarilla) actualiza la l√≠nea de contrase√±a completa)</font></i> <br><br>  Ahora finalmente tenemos todo lo que necesitamos para crear un exploit.  Los siguientes pasos nos permitir√°n extraer la contrase√±a maestra: <br><br><ol><li>  Enganche 'memmove' para evitar sobrescribir el primer byte de la contrase√±a maestra. <br></li><li>  Enganche 'RtlRunEncodeUnicodeString' para obtener la ubicaci√≥n del b√∫fer de contrase√±a maestra ofuscado. <br></li><li>  Enganche 'RtlRunDecodeUnicodeString' para acceder al b√∫fer ofuscado obtenido en el paso anterior. <br></li><li>  Ingresando un car√°cter en el campo de ingreso de contrase√±a y rechazando el paso 1 (guardar la contrase√±a maestra completa), redirigiendo el paso 2 al paso 3 para decodificar la contrase√±a maestra ofuscada. </li></ol><br>  Para realizar todas estas acciones, cree una DLL con el c√≥digo del controlador para todos estos enlaces.  La biblioteca est√° incrustada en el proceso 1Password 4, env√≠a un car√°cter al cuadro de di√°logo de contrase√±a maestra, iniciando los pasos memmove, RtlRunEncodeUnicodeString y RtlRunDecodeUnicodeString que podemos interceptar, y haciendo nuestra magia para recuperar la contrase√±a maestra ofuscada.  La mayor parte de la magia ocurre en DetourRtlRunEncodeUnicodeString, este es el gancho para la funci√≥n 'RtlRunEncodeUnicodeString', que se muestra a continuaci√≥n: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2c5/652/36e/2c565236ec1efb158e586bd603d0a908.png"></div><br><br>  Lo que nos lleva al resultado final: desbloquear el repositorio bloqueado 1Password 4 de cualquier versi√≥n utilizando el procedimiento con errores utilizado por la API de Windows: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0ad/2c0/d81/0ad2c0d817dd2dc75a942e5b2bd5b974.gif"><br><br><h1>  Resumen </h1><br>  Cuando profundizamos en el interior de 1Password 4, esper√°bamos encontrar alg√∫n tipo de sistema de seguridad complejo y que toda la informaci√≥n confidencial se borre de la memoria, como sucede en los procedimientos PBKDF2 y otras √°reas donde se usa la contrase√±a maestra.  Las entradas correspondientes tambi√©n se borran.  Sin embargo, debido a la supervisi√≥n, el campo de entrada de contrase√±a se considera un control est√°ndar de la API de Windows con una contrase√±a oculta, lo que socava la seguridad de 1Password 4. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/441166/">https://habr.com/ru/post/441166/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../441150/index.html">Primera introducci√≥n al protocolo HTTP escribiendo el servidor web Java m√°s simple</a></li>
<li><a href="../441152/index.html">C√≥mo minimizar los errores al integrarse con servicios externos: la experiencia de un corredor en l√≠nea</a></li>
<li><a href="../441154/index.html">Once perlas ocultas de Java 11</a></li>
<li><a href="../441158/index.html">C√≥mo la √©tica se convirti√≥ en el problema m√°s costoso de Silicon Valley, y la filosof√≠a se convirti√≥ en su soluci√≥n m√°s pr√°ctica</a></li>
<li><a href="../441160/index.html">C√≥mo aprender a determinar cu√°ndo decir no</a></li>
<li><a href="../441168/index.html">Canales de datos QUIC: primeros pasos</a></li>
<li><a href="../441172/index.html">C√≥mo creci√≥ el mercado de la impresi√≥n 3D en 2018 y lo que significa para las empresas</a></li>
<li><a href="../441174/index.html">OOP est√° muerto, larga vida OOP</a></li>
<li><a href="../441180/index.html">Nublado con posibilidad de publicidad no desactivable en el cielo estrellado</a></li>
<li><a href="../441182/index.html">Enfoque sinest√©sico de m√°quina para detectar ataques DDoS de red. Parte 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>