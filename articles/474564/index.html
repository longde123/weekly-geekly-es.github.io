<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>  ぞ Muestreador autom谩tico: vida despu茅s de la vida   </title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Vivi贸 feliz para siempre ... y luego se rompi贸. 

 Prologo 
 Durante un a帽o, parece que en 2009, se compr贸 un analizador de agua para un proyecto. Deb...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Muestreador autom谩tico: vida despu茅s de la vida</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/474564/">  <i>Vivi贸 feliz para siempre ... y luego se rompi贸.</i> <br><br><h3>  Prologo </h3><br>  Durante un a帽o, parece que en 2009, se compr贸 un analizador de agua para un proyecto.  Debido al hecho de que se supon铆a que deb铆a usarse para garantizar el funcionamiento del equipo tecnol贸gico, el dispositivo se compr贸 completo con un inyector autom谩tico. <br><br><img src="https://habrastorage.org/webt/vl/ru/s0/vlrus0joyo1eagedi_nr2vq-kqg.jpeg"><br><br>  Esto es esencialmente un manipulador CNC con cuatro grados de libertad de movimiento para alimentar autom谩ticamente las muestras al analizador. <br><br>  Trabaj贸 durante unos 10 a帽os y archiv贸 m谩s de treinta mil muestras con algunos problemas menores, que, sin embargo, fueron superados con "poca sangre". <br><br>  A principios de este a帽o estaba cansado: el eje Z fall贸, movimiento vertical. <br><a name="habracut"></a><br>  Es decir, el manipulador simplemente dej贸 de "verlo".  En vista de una serie de circunstancias de mantenimiento oficial, el complejo de medici贸n nunca tuvo problemas menores (reparaci贸n de PSU, parpadeo despu茅s de una falla FLASH) se resolvieron de forma independiente.  Aqu铆 ya ten铆a que buscar funcionarios, de quienes result贸 ... Algunas caracter铆sticas: <br><br><ul><li>  result贸 que el manipulador no solo es viejo, sino desastrosamente viejo </li><li>  era viejo y descontinuado con la compra </li><li>  no hay documentaci贸n para ello </li><li>  toda la electr贸nica debe ser cambiada </li><li>  las piezas est谩n disponibles pero cuestan m谩s que las nuevas </li><li>  no hay una garant铆a del cien por ciento de que con un reemplazo funcionar谩 </li></ul><br>  Algunas caracter铆sticas que conoc铆a: <br><br><ul><li>  el firmware del fabricante no funciona con el analizador (es bueno que se haya realizado una copia de seguridad), </li><li>  el cargador de arranque tambi茅n parece haber cambiado, ya que el firmware de f谩brica "tal cual" no se acepta </li><li>  no hay forma de "actualizar" el gestor de arranque, por lo que comprar productos electr贸nicos por $ 6k es in煤til </li><li>  la mec谩nica est谩 en excelentes condiciones, ya que la revisaba peri贸dicamente </li><li>  Los sensores de cero (Hall) est谩n vivos </li></ul><br>  Por lo tanto, resultaron dos opciones: <br><br><ul><li>  comprar un nuevo analizador del fabricante por $ 17k y un tiempo de entrega incomprensible </li><li>  rehacer todos los programas electr贸nicos y de escritura </li></ul><br><h3>  Primera parte, hardware </h3><br>  Para empezar, decid铆 asegurarme de que la mec谩nica funciona a un voltaje de 12v (contra 37 en el original).  Decidi贸 bajar debido al hecho de que el control de potencia de la mitad del engranaje de control se calienta decentemente.  Por lo tanto, los controladores A4988, la placa de identificaci贸n del CNC y Arduino NANO fueron retirados de la mesa de noche.  todo esto fue atracado, exhibido por el famoso proyecto grbl e interrogado con parcialidad.  La frecuencia de paso m谩xima se obtuvo para cada unidad, se ajustaron los coeficientes de divisi贸n de pasos, las corrientes del controlador. <br><br>  Result贸 que XY no se calienta en absoluto, y dan una velocidad bastante adecuada.  La corriente para la unidad Z - tuvo que ser atornillada al m谩ximo, debido a la divisi贸n entre 8 y el consumo decente al comienzo del movimiento ascendente, ya que extrae una gran masa de dos SD y entra帽as, mientras que el chip del controlador se calent贸 hasta 50 grados incluso con un radiador.  Tuve que agregar un enfriador al ventilador frente a esta unidad en el dise帽o final. <br><br>  Al final, en cambio <br><br><img src="https://habrastorage.org/webt/hv/uk/im/hvukimqjri3xmvuirghyqxdy85k.jpeg"><br><br>  result贸 <br><br><img src="https://habrastorage.org/webt/jn/kh/7o/jnkh7ojbzppodwqniscy5pzkdvu.jpeg"><br><br>  El Arduino Pro Micro ser谩 una canci贸n separada.  En el fondo hay un panel con interruptores para seleccionar un modo de funcionamiento, botones de inicio y reinicio. <br><br>  Ahora sobre tripas.  Como dije, todos los sensores Hall sobrevivieron.  De estos, los XY solo son interesantes para las diferentes l贸gicas de activaci贸n.  Si en Y el sensor se abre OK cuando se acerca al im谩n, entonces en X el im谩n est谩 constantemente opuesto al sensor, y en Zero-X y m谩s entre ellos hay un obturador magn茅ticamente suave que protege el sensor del im谩n, mientras se cierra OK.  A la luz de esta heterogeneidad, es necesario comprender a d贸nde ir cuando se buscan ceros.  Para hacer esto, el dise帽o original proporciona una posici贸n de estacionamiento al final del trabajo.  Sin embargo, no se implement贸 en absoluto: cuando se desconect贸 la alimentaci贸n, tuve que atrapar mi cabeza en el eje Z con la mano y avanzarla manualmente a la posici贸n de estacionamiento. <br><br>  Sobre Z es la historia principal.  All铆, en el caso Z, el 茅mbolo de la jeringa sigue vivo, sin un sensor cero, pero con un sensor de doble rotaci贸n, casi un codificador.  Y tambi茅n hay un sensor para presionar el vial con una falla, implementado por un engranaje helicoidal y tambi茅n un sensor Hall.  Ambos sensores de rotaci贸n son engranajes de lat贸n que pasan con dientes m谩s all谩 de los sensores Hall con magnetizaci贸n. <br><br>  驴Por qu茅 necesito un codificador magn茅tico (como parte de mi tarea privada)? Todav铆a no lo entend铆a y, por lo tanto, lo reemplac茅 con un sensor cero para el accionamiento del 茅mbolo, ya que los pasillos estaban all铆, en la mesa de noche, as铆 como un peque帽o im谩n de neodimio de la unidad de lentes de DVD. <br><br>  En cambio <br><br><img src="https://habrastorage.org/webt/uz/tj/xb/uztjxbqffeieifu4nhx1wshhxma.jpeg"><br><br>  Se convirti贸 <br><br><img src="https://habrastorage.org/webt/ev/mt/x3/evmtx3f6xbe4big2vl4efoxffvy.jpeg"><br><br>  El principal problema de esculpir hierro era abarrotar, bueno, usted mismo comprende.  Realmente no quer铆a guardar algo en una caja separada, como resultado, todo encajaba en los lugares previstos para esto, pero ahora lo har铆a un poco diferente. <br><br>  <b>Segunda parte, software</b> <br><br>  Las pruebas en la placa de identificaci贸n del CNC mostraron una velocidad decente.  PERO!  Si intenta ofrecer a la SD de inmediato la frecuencia de PASO correspondiente a esta velocidad, no obtendr谩 nada m谩s que un gru帽ido.  Para alcanzar velocidades de movimiento decentes, el motor paso a paso debe acelerarse, como si apreciara los engranajes y condujera los rieles (bueno, o los tornillos de bola, o las correas), luego reduzca la velocidad suavemente.  Porque el c贸digo trivial ha crecido un poco. <br><br>  Dado que es casi indecente venir a la secci贸n de "Rob贸tica" con un art铆culo sin c贸digo, por ejemplo, manejar el control Z (por culpa).  Al emitir una frecuencia a STEP, digitalWrite no tiene tiempo, debe extraer el puerto directamente.  Probablemente se retras贸 y se retras贸, pero el c贸digo provino del control XY y all铆 se necesita simultaneidad. <br><br><pre><code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//*****************  Z ************************* void movement_z (unsigned int tz, int spd) { long interval_z; long spd_z = 2000; unsigned long cur_micros; unsigned long prev_micros_z =0; int half_z; byte full_mask = mask_z; int dz = tz - z; z=z+dz; if (dz &lt;0) digitalWrite(pin_dir_z, HIGH); else digitalWrite(pin_dir_z, LOW); dz = abs(dz); half_z = int(dz/2); interval_z = spd; do { if (dz&gt;0){ cur_micros = micros(); if(cur_micros - prev_micros_z &gt; spd_z) { if ( dz&gt;half_z ) {if (spd_z &gt; interval_z) {spd_z = spd_z - 5;} else spd_z = interval_z;} if ( dz&lt;300 ) {if (spd_z &lt; 1000) spd_z = spd_z + 2; else spd_z = 3000;} prev_micros_z = cur_micros; if (dz&gt;0) {PORTB = PORTB | mask_z; dz--;} }} delayMicroseconds(5); PORTB = PORTB &amp; B11110000; } while( dz != 0); } //*************************************************************</span></span></code> </pre> <br>  En el conjunto de niveles de funci贸n: <br><br><ul><li>  bajo - ir y venir, encontrar algo que no s茅 qu茅 </li><li>  medio: calibre a ceros, extraiga una jeringa, haga una muestra de la muestra </li><li>  diagrama de ciclo alto de la derivaci贸n del en茅simo n煤mero de viales en una paleta </li></ul><br>  El programa comienza inicializando los puertos, leyendo la configuraci贸n especificada de los interruptores en el panel posterior y, despu茅s de presionar INICIAR, elaborando el diagrama de secuencia hasta encontrar una posici贸n en el pal茅 en la que no hay un vial con la muestra. <br><br>  El diagrama de secuencia principal se ve as铆: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">frame_1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;<span class="hljs-number"><span class="hljs-number">6</span></span>; i++){ <span class="hljs-comment"><span class="hljs-comment">// 6 for (unsigned int j=0; j&lt;9; j++){ // 9 for (unsigned int k=1; k &lt; probe+1; k++){ for (unsigned int l=1; l &lt; inj+1; l++){ sound1(); delay(1000); if (inj == 2) {tone(tone_p,5000);delay(200);noTone(tone_p);delay(200);tone(tone_p,5000);delay(200);noTone(tone_p);} if (inj == 1) {tone(tone_p,5000);delay(200);noTone(tone_p);} Serial.print("going to x = ");Serial.print(j+1);Serial.print(" y = ");Serial.print(i+1); Serial.print(" probe = ");Serial.print(k); Serial.print(" inj = ");Serial.println(l); show_xyzp(); movement_z (0,450); movement_xy (prime_x-j*272, prime_y+i*372,500); movement_z(1800,300); if (z&gt;2500) ost(); fill(); while(sensor()); if (inj == 1) {click_mouse(); Serial.println("mouse CLICKED for FLUSH and inj=1");} if (inj == 2 &amp;&amp; l==1) {click_mouse(); Serial.println("mouse CLICKED for FLUSH and inj=2");} septa_pos(); while(sensor()); sound2(); inject(); } delay(3000); click_mouse(); Serial.println("mouse CLICKED for INJECT"); find_zero_xy(); movement_xy (3257, 1247,500); movement_z (6000,100); movement_z (0,100); } } } }</span></span></code> </pre> <br>  Los atavismos en la forma de enviar informaci贸n de depuraci贸n a Serial permanecieron en el c贸digo, quedando para futuras mejoras.  uno casi ha madurado, recibi贸 jeringas anal铆ticas por cuatro veces el volumen, tendr谩 que agregar otra opci贸n al comienzo. <br><br><img src="https://habrastorage.org/webt/ug/mz/8e/ugmz8e1ty00fujj-gishy0o_yha.jpeg"><br><br>  El principal problema al compilar el programa fue que, en el original, el analizador le da al inyector autom谩tico d贸nde ir y qu茅 hacer.  Todo esto sucede a trav茅s del puerto COM y el protocolo, que no se puede tomar.  Porque tuve que salir. <br><br>  El analizador tiene un modo manual para aquellos que no han comprado un muestreador autom谩tico de <s>ardilla</s> .  Al mismo tiempo, aparece un bot贸n oscuro de "muestra lista" en la pantalla del analizador y, cuando el operador es apu帽alado, debe tocarlo con el mouse (rastreador en el panel del analizador).  Cuando se completa la medici贸n, aparece un bot贸n oscuro de "inicio de lavado" y, si el operador tiene otra muestra, la presiona con el mouse para preparar el analizador para la pr贸xima medici贸n.  Despu茅s de hacer clic con el mouse, el bot贸n desaparece y queda un campo blanco (brillante).  Decid铆 captar esta diferencia de brillo con un fotosensor.  Compruebo la apariencia del bot贸n oscuro con un fotorresistor pegado en la ventosa.  No encontr茅 una ventosa negra, y cuando sale el sol por la ventana, tengo que cubrir el sensor del bot贸n con algo. <br><br><img src="https://habrastorage.org/webt/i7/lm/zu/i7lmzujnaezp7vvoj_tzqkqyvzs.jpeg"><br><br>  驴Pero tienes que hacer clic en algo?  Afortunadamente, el analizador ten铆a un puerto USB y suficiente embotellado RedHat no circuncidado a principios de 2000 para engancharse autom谩ticamente en este puerto.  Es para emular el mouse en la nueva placa principal del automuestreador donde se encuentra el Arduino Pro Micro.  recibe un PIN de NANO en el momento en que se debe hacer clic en el analizador.  Era demasiado perezoso para escribir el movimiento, porque antes de comenzar a trabajar, el mouse debe estar configurado con anticipaci贸n en el bot贸n. <br><br>  O FELICIDAD, que cargada de experiencia, liber茅 la parte del mouse del otro optron galv谩nico econ贸mico y econ贸mico.  DEBIDO al final del segundo d铆a de depuraci贸n en especie, cuando todo funcionaba y configur茅 el zumbador para emitir sonidos similares a los originales, uno de los controladores lanz贸 humo m谩gico y conect贸 la secci贸n de alimentaci贸n de 12v a la l贸gica de 5v.  Bueno, nada, medio d铆a de reemplazarlo con uno extra铆do de una mesita de noche sin fondo no es una reparaci贸n del analizador de $ 100k.  Es cierto que m谩s tarde result贸 que la nueva fuente de alimentaci贸n REXANT comprada en lugar de una casa olvidada en alg煤n momento comenz贸 a producir casi 50 en lugar de 12v, lo que caus贸 un retraso desafortunado. <br><br>  <b>Tercera parte, prueba de calibraci贸n y confiabilidad</b> <br><br>  Despu茅s del montaje y la depuraci贸n inicial, surgi贸 el problema del recuento de posiciones por la ubicaci贸n real del vial.  Tuve que hacer un teclado y escribirle una interfaz simple en la serie.  No quedaban puertos, pero para el caso m谩s extremo se almacenaron los pines responsables de i2c.  Se colgar铆an en el extensor popular PCF8574 con micro botones que se pueden tirar hacia arriba y se pueden usar para mover el XY, seleccionar un multiplicador de pasos para acelerar el proceso y cambiar XY a ZP.  Despu茅s de cada clic en la serie muestra una nueva posici贸n.  Gracias a esta t茅cnica simple, fue posible obtener de forma r谩pida y precisa todas las coordenadas e incrementos actuales.  Fuera del procedimiento de calibraci贸n, los interruptores del selector de modo y el bot贸n para activar el ciclograma est谩n conectados a las entradas del expansor.  En el video, aproximadamente en el medio, se ven los botones y los interruptores de palanca. <br><br>  Las jeringas para alimentar una muestra no son baratas: $ 100 cada una.  Un error en el posicionamiento cuesta una aguja doblada y una jeringa irrevocablemente atornillada.  Por lo tanto, se insert贸 una jeringa rota con una aguja de coser pegada y el aparato durante casi medio d铆a estaba trillando en cuatro puntos de una hoja de papel para identificar presuntas fallas de posicionamiento.  Pero no estaban all铆, incluso me sorprendi贸.  Sin embargo, dado que hay suficiente tiempo entre el apu帽alamiento de la muestra y el reclutamiento, lo us茅 para buscar ceros, por si acaso.  En el video, este momento se ve m谩s cerca del final del video. <br><br><h3>  Ep铆logo </h3><br>  En general, fue m谩s probable que fuera exitoso.  Pasaron dos semanas desde la comprensi贸n de la desesperanza hasta la transferencia a la producci贸n.  Operado desde finales de mayo, produce hasta 200 mediciones por d铆a.  El colega a cargo del muestreo y la medici贸n no se queja. <br><br>  Las cerezas para el pastel eran nuevas caracter铆sticas que no estaban en el original.  Posibilidad de moverse en XY al mismo tiempo.  La capacidad de doble pin de la muestra, lo que aument贸 la sensibilidad del analizador a concentraciones ultrabajas de la sustancia medida en la muestra.  Estacionamiento autom谩tico despu茅s de la medici贸n. <br><br><h3>  PostScriptum </h3><br>  A petici贸n de los interesados, un video. <br><iframe width="560" height="315" src="https://www.youtube.com/embed/TE1aumgB2ok" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/474564/">https://habr.com/ru/post/474564/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../474554/index.html">Intel Tremont - Nueva microarquitectura para la eficiencia energ茅tica</a></li>
<li><a href="../474556/index.html">C贸mo hacer que PCRE2 sea compatible con Apache 2.4</a></li>
<li><a href="../474558/index.html">Programaci贸n Orientada a Protocolo, Parte 2</a></li>
<li><a href="../474560/index.html">4 pasos desde un economista hasta un gerente de desarrollo personalizado o TI como una forma de lidiar con el aburrimiento</a></li>
<li><a href="../474562/index.html">LEGO MINDSTORMS Education EV3 + MicroPython: programamos un constructor para ni帽os en un idioma para adultos</a></li>
<li><a href="../474566/index.html">Esta ciudad necesita un nuevo h茅roe: una revisi贸n de las mochilas antirrobo de Bobby Hero</a></li>
<li><a href="../474568/index.html">Leche de dientes: un cambio de profesi贸n para las c茅lulas</a></li>
<li><a href="../474572/index.html">驴Es esto normal en absoluto? El problema normativo en psicolog铆a</a></li>
<li><a href="../474574/index.html">Identificamos el ataque del virus de cifrado, accedemos al controlador de dominio e intentamos resistir estos ataques.</a></li>
<li><a href="../474576/index.html">Visi贸n sonora VOZ Visi贸n. Mira desde la oscuridad</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>