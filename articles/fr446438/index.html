<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëèüèª üêà üë©üèæ‚Äçüè´ Notre exp√©rience de cr√©ation d'API de passerelle ü§πüèø üÖ±Ô∏è üç´</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Certaines entreprises, dont notre client, d√©veloppent le produit via un r√©seau d'affiliation. Par exemple, les grandes boutiques en ligne sont int√©gr√©...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Notre exp√©rience de cr√©ation d'API de passerelle</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/true_engineering/blog/446438/">  Certaines entreprises, dont notre client, d√©veloppent le produit via un r√©seau d'affiliation.  Par exemple, les grandes boutiques en ligne sont int√©gr√©es √† un service de livraison - vous commandez des marchandises et recevez rapidement un num√©ro de suivi pour le colis.  Autre exemple - avec un billet d'avion, vous achetez une assurance ou un billet Aeroexpress. <br><br>  Pour cela, une API est utilis√©e, qui doit √™tre √©mise aux partenaires via l'API Gateway.  Nous avons r√©solu ce probl√®me.  Cet article fournira des d√©tails. <br><br>  √âl√©ments fournis: √©cosyst√®me et portail API avec une interface o√π les utilisateurs sont enregistr√©s, re√ßoivent des informations, etc.  Nous devons cr√©er une API de passerelle pratique et fiable.  Dans le processus, nous devions fournir <br><br><ul><li>  Inscription </li><li>  Contr√¥le de connexion API </li><li>  Surveillance de la fa√ßon dont les utilisateurs utilisent le syst√®me final </li><li>  comptabilit√© des indicateurs commerciaux. </li></ul><br><img src="https://habrastorage.org/webt/op/f3/aa/opf3aadequfubwpkiu4gci8j9nm.png"><br><br>  Dans l'article, nous parlerons de notre exp√©rience dans la cr√©ation de l'API Gateway, au cours de laquelle nous avons r√©solu les t√¢ches suivantes: <br><br><ul><li>  authentification des utilisateurs </li><li>  autorisation utilisateur </li><li>  modification de la demande d'origine, </li><li>  demander un mandataire </li><li>  post-traitement de la r√©ponse. </li></ul><br><a name="habracut"></a><br>  Il existe deux types de gestion des API: <br><br>  1. Standard, qui fonctionne comme suit.  Avant de se connecter, l'utilisateur teste les possibilit√©s, puis paie et int√®gre sur son site.  Le plus souvent, il est utilis√© dans les petites et moyennes entreprises. <br><br>  2. Une grande gestion d'API B2B, lorsque l'entreprise prend d'abord une d√©cision commerciale concernant la connexion, devient une entreprise partenaire avec une obligation contractuelle, puis se connecte √† l'API.  Et apr√®s avoir r√©gl√© toutes les formalit√©s, l'entreprise obtient un acc√®s aux tests, passe les tests et entre dans les ventes.  Mais cela n'est pas possible sans une d√©cision de gestion de se connecter. <br><br><img src="https://habrastorage.org/webt/go/qv/oi/goqvoiroiq0yknutwbn9hrt7abe.jpeg"><br><br><h3>  Notre d√©cision </h3><br>  Dans cette partie, nous allons parler de la cr√©ation de l'API Gateway. <br><br>  Les utilisateurs finaux de la passerelle cr√©√©e vers l'API sont les partenaires de nos clients.  Pour chacun d'eux, nous avons d√©j√† les contrats n√©cessaires.  Nous aurons seulement besoin d'√©tendre la fonctionnalit√©, en notant l'acc√®s accord√© √† la passerelle.  En cons√©quence, un processus de connexion et de contr√¥le contr√¥l√© est n√©cessaire. <br><br>  Bien s√ªr, on pourrait prendre une solution pr√™te √† l'emploi pour r√©soudre la t√¢che de gestion des API et cr√©er la passerelle API en particulier.  Par exemple, il peut s'agir de la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">gestion des API Azure</a> .  Cela ne nous convenait pas, car dans notre cas, nous avions d√©j√† un portail API et un immense √©cosyst√®me construit autour de lui.  Tous les utilisateurs ont d√©j√† √©t√© enregistr√©s, ils ont d√©j√† compris o√π et comment obtenir les informations n√©cessaires.  Les interfaces n√©cessaires existaient d√©j√† dans le portail API, nous avions juste besoin de la passerelle API.  En fait, nous avons commenc√© √† le d√©velopper. <br><br>  Ce que nous appelons l'API Gateway est une sorte de proxy.  Ici encore, nous avions le choix - vous pouvez √©crire votre proxy, ou vous pouvez choisir quelque chose de pr√™t √† l'emploi.  Dans ce cas, nous sommes all√©s dans la deuxi√®me voie et avons choisi le bundle nginx + Lua.  Pourquoi?  Nous avions besoin d'un logiciel fiable et test√© qui prend en charge la mise √† l'√©chelle.  Apr√®s l'impl√©mentation, nous ne voulions pas v√©rifier l'exactitude de la logique m√©tier et l'exactitude du proxy. <br><br>  Tout serveur Web dispose d'un pipeline de traitement des demandes.  Dans le cas de nginx, cela ressemble √† ceci: <br><br><img src="https://habrastorage.org/webt/7p/bu/9y/7pbu9y7z9ier1gtfhmu5pccawlu.png"><br><br>  (diagramme de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">GitHub Lua Nginx</a> ) <br><br>  Notre objectif √©tait de nous int√©grer dans ce pipeline au moment o√π nous pouvons modifier la demande d'origine. <br><br>  Nous voulons cr√©er un proxy transparent afin que la demande reste fonctionnellement telle qu'elle est venue.  Nous contr√¥lons uniquement l'acc√®s √† l'API finale, nous aidons la demande √† y acc√©der.  Dans le cas o√π la demande √©tait incorrecte, l'API finale devrait afficher l'erreur, mais pas nous.  La seule raison pour laquelle nous pouvons rejeter la demande est le manque d'acc√®s au client. <br><br>  Pour nginx, une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">extension</a> existe d√©j√† sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Lua</a> .  Lua est un langage de script, il est tr√®s l√©ger et facile √† apprendre.  Ainsi, nous avons impl√©ment√© la logique n√©cessaire en utilisant Lua. <br><br>  La configuration de nginx (analogie avec l'itin√©raire de l'application), o√π tout le travail est effectu√©, est compr√©hensible.  Il convient de noter ici la derni√®re directive - post_action. <br><br><pre><code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /middleware { <span class="hljs-attribute"><span class="hljs-attribute">more_clear_input_headers</span></span> Accept-Encoding; <span class="hljs-attribute"><span class="hljs-attribute">lua_need_request_body</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">rewrite_by_lua_file</span></span> <span class="hljs-string"><span class="hljs-string">'middleware/rewrite.lua'</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">access_by_lua_file</span></span> <span class="hljs-string"><span class="hljs-string">'middleware/access.lua'</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> https://someurl.com; <span class="hljs-attribute"><span class="hljs-attribute">body_filter_by_lua_file</span></span> <span class="hljs-string"><span class="hljs-string">'middleware/body_filter.lua'</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">post_action</span></span> /process_session; }</code> </pre> <br>  Consid√©rez ce qui se passe dans cette configuration: <br>  <b>more_clear_input_headers</b> - efface la valeur des en-t√™tes sp√©cifi√©s apr√®s la directive. <br>  <b>lua_need_request_body</b> - contr√¥le s'il faut lire le corps source de la requ√™te avant d'ex√©cuter ou non les directives de r√©√©criture / acc√®s / acc√®s_par_lua.  Par d√©faut, nginx ne lit pas le corps de la demande client et si vous devez y acc√©der, cette directive doit √™tre activ√©e. <br>  <b>rewrite_by_lua_file</b> - le chemin d'acc√®s aux scripts, qui d√©crit la logique de modification de la demande <br>  <b>access_by_lua_file</b> - le chemin d'acc√®s au script, qui d√©crit la logique qui v√©rifie l'acc√®s √† la ressource. <br>  <b>proxy_pass</b> - URL vers laquelle la demande sera envoy√©e par proxy. <br>  <b>body_filter_by_lua_file</b> - le chemin d'acc√®s au script, qui d√©crit la logique de filtrage de la demande avant de retourner au client. <br>  Et enfin, <b>post_action</b> est une directive officiellement non document√©e qui peut √™tre utilis√©e pour effectuer toute autre action apr√®s que la r√©ponse a √©t√© donn√©e au client. <br><br>  Ensuite, nous d√©crirons dans l'ordre comment nous avons r√©solu nos probl√®mes. <br><br><h3>  Autorisation / authentification et demande de modification </h3><br>  <b>Se connecter</b> <br><br>  Nous avons construit l'autorisation et l'authentification √† l'aide des acc√®s par certificat.  Il existe un certificat racine.  Chaque nouveau client du client g√©n√®re son certificat personnel avec lequel il peut acc√©der √† l'API.  Ce certificat est configur√© dans la section du serveur de param√®tres nginx. <br><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">ssl</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">ssl_certificate</span></span> /usr/local/openresty/nginx/ssl/cert.pem; <span class="hljs-attribute"><span class="hljs-attribute">ssl_certificate_key</span></span> /usr/local/openresty/nginx/ssl/cert.pem; <span class="hljs-attribute"><span class="hljs-attribute">ssl_client_certificate</span></span> /usr/local/openresty/nginx/ssl/ca.crt; <span class="hljs-attribute"><span class="hljs-attribute">ssl_verify_client</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>;</code> </pre> <br>  <b>Modification</b> <br><br>  Une question l√©gitime peut se poser: que faire d'un client certifi√© si nous voulons soudainement le d√©connecter du syst√®me?  Ne r√©√©mettez pas de certificats pour tous les autres clients. <br><br>  Nous nous sommes donc approch√©s en douceur et avons abord√© la t√¢che suivante - la modification de la demande d'origine.  De mani√®re g√©n√©rale, la demande initiale du client n'est pas valable pour le syst√®me final.  L'une des t√¢ches consiste √† ajouter les pi√®ces manquantes √† la demande afin de la rendre valide.  Le fait est que les donn√©es manquantes sont diff√©rentes pour chaque client.  Nous savons que le client nous vient avec un certificat √† partir duquel nous pouvons prendre une empreinte digitale et extraire les donn√©es client n√©cessaires de la base de donn√©es. <br><br>  Si √† un moment donn√©, vous devez d√©connecter le client de notre service, ses donn√©es dispara√Ætront de la base de donn√©es et il ne pourra rien faire. <br><br><h3>  Travailler avec les donn√©es client </h3><br>  Nous devions garantir une haute disponibilit√© de la solution, en particulier la mani√®re dont nous obtenons les donn√©es des clients.  La difficult√© est que la source de ces donn√©es est un service tiers qui ne garantit pas une vitesse ininterrompue et assez √©lev√©e. <br><br>  Par cons√©quent, nous devions garantir une haute disponibilit√© des donn√©es clients.  Comme outil, nous avons choisi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Hazelcast</a> , qui nous fournit: <br><br><ul><li>  acc√®s rapide aux donn√©es </li><li>  la possibilit√© d'organiser un cluster de plusieurs n≈ìuds avec des donn√©es r√©pliqu√©es sur diff√©rents n≈ìuds. </li></ul><br>  Nous avons opt√© pour la strat√©gie de livraison de cache la plus simple: <br><br><img src="https://habrastorage.org/webt/u6/f6/72/u6f6729km0g71ge4prl5ww1kes8.png"><br><br>  Le travail avec le syst√®me final se fait dans le cadre des sessions et il y a une limite sur le nombre maximum.  Si le client n'a pas ferm√© la session, nous devrons le faire. <br><br>  Les donn√©es de session ouvertes proviennent du syst√®me cible et sont initialement trait√©es du c√¥t√© Lua.  Nous avons d√©cid√© d'utiliser Hazelcast pour enregistrer ces donn√©es avec un √©crivain .NET.  Ensuite, √† certains intervalles, nous v√©rifions le droit √† la vie des s√©ances ouvertes et fermons la faute. <br><br><h3>  Acc√®s √† Hazelcast depuis Lua et .NET </h3><br>  Il n'y a pas de clients sur Lua pour travailler avec Hazelcast, mais Hazelcast a une API REST, que nous avons d√©cid√© d'utiliser.  Pour .NET, il existe un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">client</a> via lequel nous avons pr√©vu d'acc√©der aux donn√©es Hazelcast du c√¥t√© .NET.  Mais √ßa y √©tait. <br><br><img src="https://habrastorage.org/webt/qr/xn/ip/qrxnipywarywskcoslishyb8xtm.png"><br><br>  Lors de l'enregistrement des donn√©es via REST et de la r√©cup√©ration via le client .NET, diff√©rents s√©rialiseurs / d√©s√©rialiseurs sont utilis√©s.  Par cons√©quent, il est impossible de passer des donn√©es via REST, mais de passer par le client .NET et vice versa. <br><br>  Si vous √™tes int√©ress√©, nous parlerons davantage de ce probl√®me dans un article s√©par√©.  Spoiler - sur la shemka. <br><br><img src="https://habrastorage.org/webt/wh/l8/ra/whl8rayewel52cotktzhfcejmbs.png"><br><br><h3>  Journalisation et surveillance </h3><br>  Notre norme d'entreprise pour la connexion via .NET est Serilog, tous les journaux finissent dans Elasticsearch, et nous les analysons via Kibana.  Je voulais faire quelque chose de similaire dans ce cas.  Le seul <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">client</a> √† travailler avec Elastic sur Lua qui a √©t√© trouv√© cass√© au premier besoin.  Et nous avons utilis√© Fluentd. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Fluentd</a> est une solution open source pour fournir une couche de journalisation d'application unique.  Vous permet de collecter des journaux de diff√©rentes couches de l'application, puis de les traduire en une seule source. <br><br>  L'API de passerelle fonctionne dans K8S, nous avons donc d√©cid√© d'ajouter le conteneur avec fluentd au m√™me sous-type pour √©crire les journaux sur le port tcp ouvert existant fluentd. <br><br>  Nous avons √©galement examin√© le comportement de fluentd s'il n'avait aucun lien avec Elasticsearch.  Pendant deux jours, les demandes ont √©t√© envoy√©es en continu √† la passerelle, les journaux ont √©t√© envoy√©s √† fluentd, mais IP Elastic a √©t√© banni de fluentd.  Apr√®s la reconnexion, fluentd a parfaitement d√©pass√© absolument tous les journaux d'Elastic. <br><br><h3>  Conclusion </h3><br>  L'approche choisie pour la mise en ≈ìuvre nous a permis de livrer un produit vraiment fonctionnel √† l'environnement de combat en seulement 2,5 mois. <br><br>  S'il vous arrive de faire de telles choses, nous vous conseillons d'abord de bien comprendre quel probl√®me vous r√©solvez et quelles ressources vous avez d√©j√†.  Soyez conscient de la complexit√© de l'int√©gration avec les syst√®mes de gestion d'API existants. <br><br>  Comprenez par vous-m√™me ce que vous allez d√©velopper exactement - uniquement la logique m√©tier du traitement des demandes ou, comme cela pourrait √™tre le cas dans notre cas, l'ensemble du proxy.  N'oubliez pas que tout ce que vous faites vous-m√™me doit √™tre soigneusement test√© par la suite. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr446438/">https://habr.com/ru/post/fr446438/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr446428/index.html">Comment l'usine de bourdons de HR a construit</a></li>
<li><a href="../fr446430/index.html">Refroidissement d'une nanoparticule en l√©vitation au moyen d'un r√©sonateur optique</a></li>
<li><a href="../fr446432/index.html">Un s√©minaire sur la gestion des documents techniques s'est tenu en Crim√©e</a></li>
<li><a href="../fr446434/index.html">Mise √† l'√©chelle de Zimbra Collaboration Suite</a></li>
<li><a href="../fr446436/index.html">Comment g√©n√©rer des hypoth√®ses sur les besoins des consommateurs potentiels de votre futur produit</a></li>
<li><a href="../fr446440/index.html">Le livre React Fast. Applications Web dans React, JSX, Redux et GraphQL ¬ª</a></li>
<li><a href="../fr446444/index.html">De Skype √† WebRTC: comment nous avons organis√© la communication vid√©o sur le Web</a></li>
<li><a href="../fr446446/index.html">Bases du moteur JavaScript: formulaires g√©n√©raux et mise en cache en ligne. Partie 1</a></li>
<li><a href="../fr446448/index.html">5 r√®gles de base pour mener des entretiens de probl√®mes pour identifier les besoins des consommateurs</a></li>
<li><a href="../fr446452/index.html">Mission lunaire "Bereshit" - le 4 avril 2019, la transition vers l'orbite lunaire a √©t√© achev√©e, 7 jours de vol √† venir, 6 man≈ìuvres et 1 atterrissage</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>