<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚õ©Ô∏è üßîüèø ü¶Å Ben√∂tigen Sie keine Protokolle? üë©üèª‚Äçü§ù‚Äçüë®üèæ ‚õµÔ∏è üëáüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Die Entwicklung hat sich in den letzten Jahren stark ver√§ndert. Anstelle monolithischer Anwendungen kamen Mikrodienste und Funktionen. Datenbanken von...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Ben√∂tigen Sie keine Protokolle?</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/468535/">  Die Entwicklung hat sich in den letzten Jahren stark ver√§ndert.  Anstelle monolithischer Anwendungen kamen Mikrodienste und Funktionen.  Datenbanken von universellen Industriemonstern sind zu eng zielgerichteten Datenbanken verkommen.  Docker √§nderte seine Meinung √ºber den Einsatz.  Aber hat sich unsere Vorstellung von Protokollen ge√§ndert? <br><br>  Eines der gro√üen Probleme bei Yandex.Verticals waren die Protokolle - 18 TB pro Tag und 250.000 Protokolle pro Sekunde, alles wird in Dateien geschrieben.  Protokolle sind heterogen, da es viele Sprachen gibt: Scala, Java, Python, Go.  Dann werden sie von Fluent Bit gesammelt, in Kafka geschrieben, Handler arbeiten an einer Eisenmaschine, bauen aus Kafka zusammen und schreiben alles auf die Festplatte.  Dar√ºber hinaus ist dies die zweite Version der Protokolle. <br><br><img src="https://habrastorage.org/webt/4i/z8/ws/4iz8wst0a72z7ytipvzx77wnxiq.jpeg"><br><br>  Infolgedessen tritt ein langes Suchproblem auf.  Diese Protokolle werden mit grep durchsucht.  Bei einigen Diensten kann grep Stunden erreichen.  Wenn Sie Probleme in der Produktion haben, werden Sie stundenlang nicht nach Ihren Protokollen suchen.  Um das Problem zu l√∂sen, hat Yandex beschlossen, ein eigenes Log Delivery Bike f√ºr die Suche zu schreiben.  Was dabei herauskam, wird <b>Alexei Danilov</b> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link">danevge</a> ) - dem Entwickler des Infrastrukturteams in Yandex.Verticals - mitteilen.  Entwickelt, schreibt und unterst√ºtzt Auto.ru- und Yandex.Real Estate-Projekte. <br><br>  <i>Haftungsausschluss.</i>  <i>Der Artikel spricht √ºber moderne Entwicklung und ist f√ºr die Microservice-Architektur geeignet.</i>  <i>Hier werden verschiedene Produkte vorgestellt - dies sind Werkzeuge, die in Yandex.Verticals verwendet werden.</i>  <i>Unter anderen Bedingungen sind Analoga erfolgreicher m√∂glich, erf√ºllen jedoch fast die gleichen Funktionen.</i> <a name="habracut"></a><br><blockquote>  Hinweis  Der Artikel ist eine erweiterte Version von Alexey Danilovs Bericht ‚ÄûProtokolle werden nicht ben√∂tigt‚Äú bei RIT ++ 2019 DevOps Conf, der stilistisch modifiziert und durch neues Material erg√§nzt wird.  Die Videoaufzeichnung von Alexeys Rede finden Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">unter dem Link</a> auf unserem YouTube-Kanal. </blockquote><br>  Das Yandex.Vertical-Team besteht aus 300 Mitarbeitern, von denen etwa 100 Entwickler sind.  In der Entwicklung unterscheiden wir uns nicht von den meisten Unternehmen, die ihre eigenen Produktl√∂sungen entwickeln.  Microservices, jeder lebt in Docker, ein Monolith in PHP verstaubt in einer dunklen Ecke, wird √ºber Hashicorp Nomad bereitgestellt und wir haben einen Zoo von Sprachen: Scala, Java, Go, Node.js, Python. <br><br>  Eines der gro√üen Infrastrukturprobleme in Yandex.Verticals sind Anwendungsprotokolle.  Als wir uns diesem Problem ernsthaft n√§herten, verwendeten wir die dritte Version ihrer Sammlung und Verarbeitung.  Vereinfacht funktioniert es so: <br><br><ul><li>  Anwendungen, die in Dateien geschrieben wurden; <br></li><li>  Fluent Bit las Dateien und schickte sie Zeile f√ºr Zeile an Kafka Filebeat. <br></li><li>  Auf einer dedizierten Eisenmaschine gab es eine Anwendung, die das Kafka-Thema las und in Dateien auf der Festplatte schrieb. <br></li></ul><br>  In der hei√üen Jahreszeit hatten wir 18 TB Protokolle pro Tag oder 250.000 Zeilen pro Sekunde.  Dies ist eine sehr gro√üe Menge, die die Arbeit mit diesen Daten erschwert.  Die einzige M√∂glichkeit, dies zu analysieren, ist grep, da alles in Dateien gespeichert ist.  Bei gro√üen Anwendungen kann die Analyse Stunden dauern.  Bei Problemen in der Produktion haben Sie diese Zeit nicht. <br><br>  Fertige L√∂sungen passten nicht zu Preis, Ressourcen oder Geschwindigkeit.  Sie konnten unseren Fluss nicht akzeptabel bew√§ltigen.  Es ist schwer, die Anzahl der Versuche, Elasticsearch zu kochen, √ºberhaupt zu z√§hlen.  Ich nehme an, wir wissen nicht, wie man es kocht.  Dies ist jedoch nicht das, was wir brauchen, wenn wir es als Aufbewahrungsort f√ºr Protokolle verwenden m√∂chten, sind besondere F√§higkeiten (Fertigkeiten) erforderlich. <br><br>  In dieser Situation haben wir beschlossen, ein eigenes System zum Sammeln und Analysieren von Protokollen zu implementieren. <br><br><h2>  Fahrrad </h2><br><img src="https://habrastorage.org/webt/aw/49/s9/aw49s9cfjgf28z2eqyofr3cx7ea.jpeg"><br><br>  <i>Hinweis: Wenn das n√§chste Fahrrad nicht interessant ist, fahren Sie sofort mit dem Abschnitt "Typisierung" fort.</i> <br><br><h3>  Formatieren </h3><br>  Wir verwenden mehrere PLs und lieben Microservices.  Um mit den Protokollen arbeiten zu k√∂nnen, haben wir einheitlich unser eigenes JSON-Format erstellt.  Es deckt den gr√∂√üten Teil des Bedarfs f√ºr die weitere Arbeit mit Protokollen ab. <br><br><img src="https://habrastorage.org/webt/z8/8q/g5/z88qg5gh3s5ntz9n91q5opbk0ku.png"><br>  <i>Ein Beispiel f√ºr Protokolle mit allen m√∂glichen Feldern.</i> <br><br><h2>  Docker-Protokolltreiber </h2><br>  Um die Protokolle zu sammeln, haben wir unseren eigenen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Docker-Protokolltreiber geschrieben</a> - eine Anwendung auf Go.  Es wird auf spezielle Weise zusammengestellt, von Docker-Plugin-Befehlen bereitgestellt, in der Registrierung gespeichert und in einer einzelnen Instanz ausgef√ºhrt, in der Docker ausgef√ºhrt wird. <br><br>  Da sich Probleme mit dem Protokolltreiber negativ auf die gesamte Arbeit auswirken k√∂nnen, haben wir versucht, eine minimale Implementierung zu schreiben.  Unser Fahrer h√∂rt auf die Standardausgabe des Containers und leitet die Protokolle sofort an die Anwendung in der N√§he weiter.  Es befasst sich bereits mit dem komplexeren Teil der Lieferung. <br><br><h3>  Die Probleme </h3><br>  Ich werde die Probleme beim Aktualisieren der Version des Docker-Protokolltreibers separat erw√§hnen. <br><br><img src="https://habrastorage.org/webt/a6/sy/md/a6symdnuvy0z5kekvjv924yth-i.png"><br>  <i>Screenshot von der internen Grafana.</i> <br><br>  Links ist das Verh√§ltnis von installierten Versionen zu Maschinen.  Jetzt sind drei Versionen auf der gesamten Hardware installiert - es gehen nirgendwo Autos verloren und es gibt keine unn√∂tigen Installationen.  Rechts ist die Anzahl der Container angegeben, die diese oder jene Version verwenden. <br><br>  Der Docker-Treiber kann nicht sofort aktualisiert werden.  Dazu m√ºssten Sie alle Container und alle Dienste neu starten, was zu Problemen f√ºhren k√∂nnte.  Um die neue Version zu installieren, warten wir nur darauf, dass sich alle Container selbst aktualisieren. <br><br><h2>  Allgemeines Schema </h2><br>  Betrachten Sie das allgemeine Schema eines neuen Systems zum Sammeln und Bereitstellen von Protokollen.  Andere Details sind nicht so interessant. <br><br><img src="https://habrastorage.org/webt/nm/lx/pq/nmlxpqlg41ntzuar5imu8pw3-km.jpeg"><br><br>  Anwendungen schreiben Protokolle im JSON-Format in stdout.  Docker h√∂rt zu, wie Pipe vom Container geleitet wird, und leitet sie an den Docker-Treiber weiter.  Der Docker-Treiber liest alles in Pusher und schmilzt es asynchron neu. <br><br>  Dr√ºcker steht auf jedem Eisenauto.  Er bereitet Protokolle vor, s√§ttigt sie, dreht sie um und schiebt sie in die Yandex Message Queue.  Der Protokolldatenstrom von MQ wird von drei Arten von Workern analysiert und in die Repositorys geschrieben. <br><br>  Es gibt drei Repositorys zum Aufzeichnen von Protokollen. <br><br><ul><li>  <b>Yandex mapReduce</b> zum Speichern und Analysieren von Protokollen √ºber einen langen Zeitraum.  Dies ist ein Analogon von Hadoop. <br></li><li>  <b>ClickHouse</b> zum Speichern von Protokollen am letzten Tag. <br></li><li>  <b>Humio</b> (als Experiment) zum Speichern von Protokollen f√ºr den letzten Tag. <br></li></ul><br><h3>  Gewinn </h3><br>  Mit dem allgemeinen Format k√∂nnen Sie Protokolle auf dieselbe Weise schreiben und verarbeiten.  Die Protokollerfassung erfolgt automatisch ohne Verwendung einer Festplatte, und die Zustellung erfolgt innerhalb weniger Sekunden.  Tastensuche von 2 Sekunden bis 5 Sekunden.  Lagerung und Abruf √ºber einen langen Zeitraum. <br><br>  Bei kleineren Volumina sollten Sie Alternativen in Betracht ziehen: Humio, Splunk und Elastic.  Die letzten beiden haben offizielle Docker-Treiber.  Wenn Sie in AWS leben, ist dies Amazon CloudWatch. <br><br><h3>  Amazon Cloudwatch </h3><br>  Amazon CloudWatch verarbeitet Metriken, Ereignisse und Protokolle.  Er sucht nicht nach letzterem, gibt keine Supersuchelemente an und verarbeitet sie nicht in der √ºblichen Form.  Amazon CloudWatch verarbeitet Protokolle, Analysen, Filter und Anzeigen in Diagrammen. <br><br><img src="https://habrastorage.org/webt/xc/le/o2/xcleo2if8o1ezw7hob29olfzcta.png"><br>  <i>Amazon CloudWatch konvertiert Protokolle in Metriken und Grafiken.</i> <br><br><h2>  Was tun mit Protokollen? </h2><br>  Zur√ºck zu unserem Fahrrad - befriedigt es alle F√§lle?  Nein, mit unserer L√∂sung k√∂nnen Sie die Protokolle finden, aber sie erfordern eine viel gr√∂√üere Heterogenit√§t der Informationen und ihrer Typen.  Protokolle werden in viel mehr F√§llen verwendet. <br><br>  Sobald Sie die Protokolle gesammelt haben, lautet der folgende Satz: ‚ÄûLassen Sie uns etwas analysieren, irgendwie verarbeiten, irgendwo aufschreiben und in Diagrammen oder Dashboards anzeigen.‚Äú  Dies ist der Weg zur H√∂lle.  Vor allem, wenn es sich um g√§ngige Tools handelt. <br><br><blockquote>  Wenn Sie sich die Protokolle als ein bestimmtes Chaos- oder Ereignisprotokoll von Daten vorstellen, funktionieren sie nicht. </blockquote><br>  Dies wird ein gro√ües Durcheinander von Informationen sein, die nicht verarbeitet werden k√∂nnen.  Ein Spiel beginnt mit der Formalisierung von Protokollen: ‚ÄûSchreiben wir diese Zeilen in einem speziellen Format, damit sie sp√§ter analysiert werden k√∂nnen!‚Äú  Das funktioniert auch nicht.  Glauben Sie uns, wir haben es versucht. <br><br><h2>  Tippen </h2><br>  Wenn Sie die Protokolle in Typen aufteilen und separat verarbeiten, finden Sie Tools, die die Arbeit mit ihnen erleichtern.  Arbeiten nicht mehr wie bei Protokollen, sondern wie bei n√ºtzlichen Daten - solche Arbeiten sind transparenter und bequemer.  Einige Arten von Protokollen k√∂nnen vollst√§ndig weggeworfen werden. <br><br><h3>  Nur f√ºr den Fall </h3><br>  Diese Art von Protokollen "zu sein" ist mein Favorit.  Wenn es unm√∂glich ist, klar zu beantworten, warum diese oder jene Zeile ben√∂tigt wird, dann sind sie es.  Dieser Typ kann auch als "Protokolle f√ºr alle F√§lle" bezeichnet werden. <br><br><pre><code class="plaintext hljs">// validate customer func Validate(customer Customer) { // ??? log.debug(‚ÄúValidate customer %v‚Äù, customer) ‚Ä¶ log.Error(‚ÄúCustomer not valid %v. Reason: %s‚Äù, ...) ‚Ä¶. }</code> </pre> <br><blockquote>  Protokolle sind keine Kommentare, die gel√∂scht werden k√∂nnen.  Dies ist Teil des Codes, der schwieriger zu √§ndern, zu warten und noch schwieriger zu l√∂schen ist. </blockquote><br>  Im besten Fall kann ein solches Protokoll zu einem Debug oder Trace werden.  Dieser Typ <b>√ºberfrachtet den Code</b> .  Aufgrund der vorschnellen Protokollierung kann ich pers√∂nliche Daten, Passw√∂rter und Cookies von Benutzern darin abrufen. <br><br>  Der richtige Weg ist <b>, sie wegzuwerfen und zu vergessen</b> .  Aber dann stehen wir vor einem neuen Problem.  Wie kann man die Situation mit einem Fehler analysieren? <br><br><h3>  Schwerwiegender / kritischer Fehler </h3><br>  Zun√§chst betrachten wir nur kritische Fehler.  Dies sind Fehler, unter denen Benutzer und Entwickler leiden.  Die erste - wenn sie den Vorgang nicht abschlie√üen k√∂nnen.  Die zweite - wenn Sie Korrekturen von Hand vornehmen m√ºssen. <br><br>  Warum passen Protokolle nicht? <br><br>  <b>Keine schnelle Antwort</b> .  Wenn das Entwicklungsteam von den Benutzern √ºber den Support oder √ºber Twitter von dem Fehler erf√§hrt, ist es Zeit, etwas zu √§ndern. <br><br>  <b>Es gibt keinen Kontext</b> .  Eine separate Zeile des Fehlerprotokolls ist unbrauchbar.  Wir m√ºssen den Kontext St√ºck f√ºr St√ºck sammeln.  Trotzdem reicht es m√∂glicherweise nicht aus, da dies der Kontext des Prozesses ist, nicht der Fehler. <br><br>  <b>Es gibt kein gro√ües Bild</b> .  Keine Antwort auf die Fragen: <br><br><ul><li>  wie oft ein solcher Fehler auftritt; <br></li><li>  es trat auf den verbleibenden Replikaten des Dienstes auf; <br></li><li>  war es vorher? <br></li></ul><br>  Verwenden Sie zur Behebung dieser Probleme ein geeignetes Tool, z. B. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">sentry.io</a> .  Sie k√∂nnen mit repr√§sentativen, vollst√§ndigen (kontextbezogenen) Fehlerinformationen mit anpassbaren <code>alerting rule</code> .  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Die Sentry-Website</a> beschreibt die Unterschiede in den Protokollen zur Verwendung von sentry.io. <br><br><h3>  Kein kritischer Fehler </h3><br>  Wir haben schwerwiegende und kritische Fehler gemacht und jetzt sind sie in Sentry geschrieben.  Es gab jedoch interne Fehler - verschiedene Bibliotheken oder Antworten von Drittanbieterdiensten. <br><br>  Ein gutes Beispiel ist ein erfolgreicher Wiederholungsversuch.  Angenommen, Dienst A hat sich an Dienst B gewandt, konnte jedoch aufgrund von Netzwerkproblemen keine Antwort erhalten.  Nach dem Fehler wandte sich Service A erneut an Service B und erhielt eine g√ºltige Antwort.  Ist der Fehler beim ersten Anruf kritisch?  Nein.  In diesem Fall wurde der Vorgang erfolgreich abgeschlossen und der Benutzer konnte den Dienst nutzen. <br><br>  Wenn solche Fehler f√ºr das Funktionieren des Dienstes nicht kritisch sind und den Benutzer nicht mit einer seltenen Wiederholung betreffen, handelt es sich √ºberhaupt nicht um Fehler.  Dies ist eine Verschlechterung des Dienstes, obwohl die Antwort an den Benutzer 50 ms sp√§ter erfolgte.  Diese Art von Protokoll bezieht sich auf Warnungen - Warnung. <br><br><h3>  Warnung </h3><br><blockquote>  Warnungen sind Informationen √ºber die Verschlechterung eines Dienstes. </blockquote><br>  Hier sehen wir die gleichen Probleme, die mit kritischen Fehlern verbunden sind, jedoch mit Vorbehalt.  Die Reaktion auf ein einzelnes Ereignis ist nicht wichtig - ihre Menge im Laufe der Zeit ist wichtig. <br><br>  Stellen Sie sich ein Beispiel vor, in dem ein Dienst keinen Cache-Eintrag abrufen kann und auf den K√ºhlraum zugreift.  Wenn dies einmal pro Minute geschieht, kann dies f√ºr den normalen Betrieb des Dienstes verwendet werden.  <b>Seltene Emissionen sind nicht wichtig</b> . <br><br>  Gleichzeitig ben√∂tigen Sie ein Tool, um das Gesamtbild zu betrachten. Sie ben√∂tigen eine <b>Echtzeitanalyse</b> .  Um √Ñnderungen √ºber einen langen Zeitraum zu verfolgen, w√§re es auch sch√∂n, eine <b>retrospektive Analyse durchzuf√ºhren</b> .  Eine Verschlechterung √ºber einem bestimmten Niveau (Schwellenwerte) kann sich nachteilig auf die Benutzer auswirken. Sie ben√∂tigen eine <b>Reaktion mit starker Verschlechterung</b> . <br><br><blockquote>  Wir brauchen nicht die mit Warnung gekennzeichneten Protokolle, sondern die Verschlechterungsmetriken. </blockquote><br>  Das beliebteste Tool zum Sammeln von Metriken ist Prometheus, und Sie k√∂nnen Grafana zur Visualisierung verwenden.  Wenn Sie einen gro√üen Kontext ben√∂tigen (der gleiche wie der Fehler), reicht derselbe Sentry aus, jedoch mit deaktivierten Warnungen.  In den meisten F√§llen wird jedoch gen√ºgend Kontext vorhanden sein.  Es wird f√ºr Grafiken verwendet - Prometheus-Beschriftungen. <br><br>  Beispiele. <br><div class="scrollable-table"><table><tbody><tr><td>  Etikett <br></td><td>  Beispiel 1 <br></td><td>  Beispiel 2 <br></td><td>  Beispiel 3 <br></td></tr><tr><td>  Kontext <br></td><td>  db <br></td><td>  interner_service <br></td><td>  Cache <br></td></tr><tr><td>  Modul <br></td><td>  user_service <br></td><td>  user_service <br></td><td>  user_service <br></td></tr><tr><td>  Grund <br></td><td>  long_query <br></td><td>  erneut versuchen <br></td><td>  miss_cache <br></td></tr><tr><td>  andere <br></td><td>  get_user <br></td><td>  service_b <br></td><td>  user_permisson <br></td></tr></tbody></table></div><br>  Im bedingten <code>user_service</code> drei Ereignisse aufgetreten.  Sie wirken sich auf den Betrieb des Dienstes aus: Eine lange Anforderung an die Datenbank, wiederholter Zugriff auf die Dienst-API <code>service_b</code> und keine Benutzerrechte im Cache.  Diagramme und Warnungen werden aufgrund des Kontexts f√ºr die Entwickler des Dienstes als wichtig konfiguriert. <br><br><h3>  R√ºckverfolgung </h3><br>  Dies ist der erste Schritt, wenn wir den Pfad ausw√§hlen, in dem Sie die Protokolle analysieren m√ºssen.  Diese Informationen in den Protokollen sind f√ºr sich genommen nutzlos, da Sie Anrufketten erstellen, die Daten in den Anforderungen, Fehler in den Anrufketten, Antwortzeiten und die Anzahl der RPS anzeigen m√ºssen. <br><br>  Es gibt gro√üartige Werkzeuge zum Aufsp√ºren - Jaeger oder Zipkin.  Ich empfehle die Verwendung von OpenTracing, das beide unterst√ºtzen. <br><br>  Sie k√∂nnen die Ablaufverfolgung aus drei Quellen erfassen. <br><br><ul><li>  Wenn Sie Shared <b>Balancer verwenden</b> , analysieren Sie die Protokolle von ihnen und senden Sie sie an Jaeger. <br></li><li>  <b>Services selbst</b> , wenn sie Adressen √ºber Service Discovery erhalten und direkt gehen.  In diesem Fall wird der Trace von den Diensten direkt an Jaeger gesendet. <br></li><li>  Smart <b>Service Mesh</b> .  Er wei√ü, wie man eine Spur sammelt und sendet, zum Beispiel Istio. <br></li></ul><br><br><h3>  Erste Informationen </h3><br>  Diese Informationen beziehen sich auf API-Dienstaufrufe, Cron-Start, Datenbankabfragen oder Aufrufe anderer Dienste. <br><br><pre> <code class="plaintext hljs">{ "_message": "Request: ...; request_id: ...,... ", "_level": "INFO", "_time": "2019-03-08T12:04:05.000+07:00", "_context": "ryawvcHandler", "_tread": "785534" }</code> </pre> <br>  Diese Informationen geh√∂ren zum Block "Nur f√ºr den Fall", sind jedoch getrennt, da sie h√§ufiger vorkommen.  Diese Informationen werden ben√∂tigt, um den Fehler zu analysieren, und <b>Sie k√∂nnen ihn wegwerfen</b> . <br><br>  Wenn Informationen √ºber Aufrufe interner Methoden von entscheidender Bedeutung sind und Sie auch im gesammelten Kontext im Fehlerfall nicht darauf verzichten k√∂nnen, lohnt es sich, Methodenaufrufe als Trace zu instrumentieren. <br><br><h3>  Ausf√ºhrungszeit </h3><br>  Diese Informationen beziehen sich auf die Ausf√ºhrungszeit von Methoden, APIs, Datenbankabfragen oder anderen Diensten. <br><br><pre> <code class="plaintext hljs">{ "_message": "Get customer 12ms", "_level": "INFO", "_time": "2019-03-08T12:04:05.000+07:00", "_context": "ryawvcCustomerRepository", "_tread": "785534" }</code> </pre> <br>  Die Protokolle enthalten keinen Wert, da Sie diese Informationen analysieren, in Diagrammen anzeigen und Schwellenwerte konfigurieren m√ºssen.  Diese Art von Protokollen muss beispielsweise in Prometheus durch <b>Metriken</b> ersetzt werden. <br><br><h3>  Gesch√§ftsinformationen </h3><br>  Diese Informationen werden f√ºr Gesch√§ftsanalysen, Kundenverhaltensanalysen und Finanzberechnungen ben√∂tigt.  An dieser Stelle haben wir in der Vergangenheit den umgekehrten Ansatz verwendet - analysierte Protokolle.  Dies ist jedoch ein gutes Beispiel daf√ºr, was die Anwendungsprotokolle degenerieren k√∂nnen, wenn Sie auf diese Weise mit ihnen arbeiten. <br><br>  F√ºr Protokolle mit Gesch√§ftsdaten wurden Vereinbarungen mit festen Feldern im TSKV-Format getroffen, die f√ºr die Analyse erforderlich sind.  Anwendungen haben Gesch√§ftsprotokolle in eine dedizierte Datei geschrieben.  Dann wurden die Protokolle gelesen und Zeile f√ºr Zeile an MQ gesendet, und eine separate Anwendung verarbeitete sie und schrieb sie in die Datenbank.  Dies ist ein Beispiel daf√ºr, was aus einer Analyse wird. <br><br><blockquote>  Es wird nicht funktionieren, den gesamten Protokollstrom zu analysieren, in der Hoffnung, dass die Daten konvergieren. </blockquote><br>  Konventionen, Formate, Regeln und Zuverl√§ssigkeitsanforderungen entstehen.  Dies sieht bereits ein wenig wie die Anwendungsprotokolle aus.  In diesem Fall wird das Protokoll zur Daten√ºbermittlungswarteschlange mit allen sich daraus ergebenden Anforderungen f√ºr MQ.  Auff√§llig ist, dass Middleware in Form eines Logs hier √ºberfl√ºssig ist. <br><br>  Eine gute L√∂sung besteht darin, diese Daten direkt an MQ zu senden.  Bereits dort werden sie verarbeitet, im entsprechenden Speicher gespeichert und vom Analyseteam verwendet.  F√ºr die Anzeige verwenden wir beispielsweise Tableau. <br><br><h3>  Leistung </h3><br>  Diese Art von Protokoll wird selten in Anwendungsprotokollen gefunden und h√§ufiger als Metrik erfasst.  Separat f√ºge ich hinzu, dass es ausreicht, die Prometheus-Bibliothek zu verwenden, um die sprachspezifischen Grundmetriken zu erfassen.  Sie wird standardm√§√üig alles sammeln, was sie erreicht.  Die Kosten f√ºr das Hinzuf√ºgen dieser Metriken sind gering. <br><br><img src="https://habrastorage.org/webt/iz/od/jv/izodjvufyysy4-3ihlurtw9rueq.png"><br><br><h3>  Tippergebnis </h3><br>  Nachdem wir die Protokolle nach Typ sortiert haben, k√∂nnen wir leistungsf√§higere Tools f√ºr die Arbeit mit ihnen ausw√§hlen.  Es gibt keine komplexen Systeme oder Weltraumtechnologien wie Amazon, es gibt nichts, was morgen nicht angesprochen werden kann.  Sie haben wahrscheinlich bereits einige dieser Systeme oder Analoga: Sentry verstaubt irgendwo, Prometheus arbeitet irgendwo. <br><br><img src="https://habrastorage.org/webt/69/jj/ik/69jjikx9uuyrghuq-1rpw0bu5o0.png"><br><br><blockquote>  Das Problem liegt nicht in der Technologie, sondern in einer kognitiven Falle, wenn wir Protokollen als Mittel zur zuverl√§ssigen Darstellung des Zustands unseres Systems vertrauen.  Dies ist nicht so, Protokolle sind eine Reihe von chaotischen Ereignissen. </blockquote><br>  Es gibt eine Ausnahme - Debug-Protokolle, die in seltenen F√§llen verwendet werden k√∂nnen. <br><br><h3>  Debug-Protokoll </h3><br>  Debug-Protokolle sollten detaillierte Informationen sein.  Sie sollten nicht duplizieren, was bereits an die oben beschriebenen Systeme gesendet wurde.  Dieser Typ dient zum Parsen von Sonderf√§llen.  Beispielsweise tritt in der Produktion ein unverst√§ndlicher Fehler auf, und im Moment ist anhand von Metriken nicht klar, was passiert. <br><br>  <b>Aktivieren Sie Debug-Protokolle im laufenden Betrieb, ohne den Dienst neu zu starten</b> .  Da es sich um mehrere Dienste handelt, wird es nicht viele davon geben.  Eine ausgefeilte Infrastruktur ist nicht erforderlich.  Genug ELK-Stapel ohne komplizierte "Vorbereitung".  Es ist auch sinnvoll, Sentry eine Warnung mit allen erforderlichen Kontexten hinzuzuf√ºgen. <br><br>  <b>Debug-Protokolle k√∂nnen f√ºr die Entwicklung verwendet werden</b> .  Sie werden jedoch perfekt durch das Debuggen ersetzt. <br><br><h2>  Zusammenfassend </h2><br>  <b>Wir haben unser Fahrradprotokoll f√ºr die Suche geschrieben</b> .  Wir haben die Kunden des Dienstes nicht zufrieden gestellt - sie alle kommen zu uns, um sie irgendwo zu analysieren, zu sammeln und zu aggregieren.  Dies kann vermieden werden - komplexe Protokollverarbeitungssysteme werden nicht ben√∂tigt. <br><br><blockquote>  Rohprotokolle sind nutzlos, k√∂nnen jedoch in n√ºtzliche Metriken umgewandelt werden. </blockquote><br>  Es reicht aus, eine Infrastruktur f√ºr die Bereitstellung n√ºtzlicher Metriken und Daten rund um Services zu erstellen.  Infolgedessen werden n√ºtzliche Metriken angezeigt, die √ºber Dienste sprechen und alles, was mit ihnen passiert, transparent anzeigen. <br><br><blockquote>  Fehler m√ºssen den Kontext des Fehlers selbst enthalten. </blockquote><br>  Dies wird helfen, damit umzugehen und es sofort zu beheben.  <b>Fehler und Verschlechterungen sollten zu Ma√ünahmen f√ºhren</b> , damit Entwickler sofort von Problemen erfahren und diese beheben k√∂nnen, noch bevor ver√§rgerte Benutzeranfragen gestellt werden. <br><br>  <b>Mit den richtigen Tools wird die Arbeit mit Ihren Diensten angenehmer und transparenter</b> .  Debug hat einen Platz, an dem man sein muss, aber man muss streng damit umgehen. <br><br><blockquote>  Auf der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">HighLoad ++ 2019</a> im November wird es einen DevOps-Bereich geben - 13 Berichte √ºber Lasten in AWS, ein √úberwachungssystem in Lamoda, F√∂rderer f√ºr die Modelllieferung, Leben ohne Kubernetes und vieles mehr.  Die vollst√§ndige Liste der Themen und Abstracts finden Sie auf der separaten Seite ‚Äû <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Berichte</a> ‚Äú.  Und wir werden uns im Fr√ºhjahr auf der DevOpsConf treffen - abonnieren Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">den Newsletter</a> und teilen Sie uns mit, wann wir Datum und Ort festlegen. </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de468535/">https://habr.com/ru/post/de468535/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de468525/index.html">Holzspielzeug, Teil eins - 1982-1985</a></li>
<li><a href="../de468527/index.html">Synthese eines Controllers nach der inversen Dynamikproblemmethode</a></li>
<li><a href="../de468529/index.html">Gorynych z√§hmen oder eBPF in Ghidra dekompilieren</a></li>
<li><a href="../de468531/index.html">Der erste PHP-Bot f√ºr VKontakte</a></li>
<li><a href="../de468533/index.html">Trampen auf DevOps mit Express 42</a></li>
<li><a href="../de468537/index.html">Grundlagen von DevOps. Einstieg in das Projekt von Grund auf neu</a></li>
<li><a href="../de468541/index.html">Drag & Drop-Komponenten f√ºr blinde Benutzer? Sie machen Witze?</a></li>
<li><a href="../de468543/index.html">Wochentags Programmkomitee FrontendConf. Interview mit Sergey Popov</a></li>
<li><a href="../de468545/index.html">"Alice, lass uns zum Frontend gehen!"</a></li>
<li><a href="../de468547/index.html">Englisch sprechend, CSS, Grid und Barrierefreiheit bei FrontendConf</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>