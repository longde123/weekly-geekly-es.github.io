<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👊🏻 🏳️ 💘 Mein Compiler für Lisp 👴🏾 🔄 👴🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ich freue mich sehr, die Fertigstellung meines ersten Compilers für eine Programmiersprache bekannt zu geben! Malcc ist ein inkrementeller Lisp AOT- C...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Mein Compiler für Lisp</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/446808/">  Ich freue mich sehr, die Fertigstellung meines ersten Compilers für eine Programmiersprache bekannt zu geben!  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Malcc</a> ist ein inkrementeller Lisp <abbr title="Vor der Zeit">AOT-</abbr> Compiler, der in C geschrieben wurde.</b> <br><br>  Ich werde kurz über die langjährige Entwicklung und das, was ich dabei gelernt habe, sprechen.  Alternativer Artikeltitel: "Wie schreibe ich einen Compiler in zehn Jahren oder weniger?" <br><br>  (Am Ende gibt es <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">TL; DR</a> , wenn Sie sich nicht für den Hintergrund interessieren). <br><a name="habracut"></a><br><h1>  Compiler-Demo </h1><br><pre><code class="plaintext hljs">tim ~/pp/malcc master 0 → ./malcc Mal [malcc] user&gt; (println "hello world") hello world nil user&gt; (+ 1 2) 3 user&gt; (def! fib2 (fn* (n) (let* (f (fn* (n1 n2 c) (if (= cn) n2 (f n2 (+ n1 n2) (+ c 1))))) (f 0 1 1)))) &lt;lambda&gt; user&gt; (fib2 25) 75025 user&gt; ^D% tim ~/pp/malcc master 0 → ./malcc examples/hello.mal hello world tim ~/pp/malcc master 0 → ./malcc --compile examples/hello.mal hello gcc -g -I ./tinycc -I . -o hello hello.c ./reader.c ./printer.c ./hashmap.c ./types.c ./util.c ./env.c ./core.c ./tinycc/libtcc.a -ledit -lgc -lpcre -ldl tim ~/pp/malcc master 0 → ./hello hello world tim ~/pp/malcc master 0 →</code> </pre> <br><h1>  Erfolgreiche Ausfälle </h1><br>  Fast zehn Jahre lang habe ich davon geträumt, einen Compiler zu schreiben.  Ich war schon immer fasziniert von der Arbeit der Programmiersprachen, insbesondere der Compiler.  Obwohl ich mir den Compiler als dunkle Magie vorstellte und verstand, dass es für einen bloßen Sterblichen wie mich unmöglich war, ihn von Grund auf neu zu erstellen. <br><br>  Aber ich habe es trotzdem versucht und studiert! <br><br><h1>  Erstens der Dolmetscher </h1><br>  2011 begann ich mit der Arbeit an einem einfachen Dolmetscher für die fiktive Sprache Airball (Airball kann als „Muff“ übersetzt werden).  Mit Namen können Sie den Grad meiner Unsicherheit bewerten, dass es funktionieren wird.  Es war ein ziemlich einfaches Ruby-Programm, das Code analysierte und durch einen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">abstrakten Syntaxbaum</a> (AST) ging.  Als der Dolmetscher noch funktionierte, habe ich ihn in <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Lydia umbenannt</a> und in C umgeschrieben, um ihn schneller zu machen. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6b4/902/4ee/6b49024ee04e02ae1b56776aa5ed05bc.png"><br><br>  Ich erinnere mich, dass mir Lydias Syntax sehr klug erschien!  Ich genieße immer noch seine Einfachheit. <br><br>  Obwohl Lydia alles andere als ein perfekter Compiler war, inspirierte es mich, weiter zu experimentieren.  Ich wurde jedoch immer noch von Fragen gequält, wie der Compiler funktioniert: In <i>was soll kompiliert werden?</i>  <i>Muss ich Assembler lernen?</i> <br><br><h1>  Zweitens der Bytecode-Compiler und Interpreter </h1><br>  Als nächsten Schritt begann ich 2014 mit der Arbeit an <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Schema-VM</a> , einer <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">virtuellen Maschine</a> für Schema, die in Ruby geschrieben wurde.  Ich dachte, dass eine virtuelle Maschine mit eigenem Stack und Bytecode eine Übergangsphase von einem Interpreter mit AST-Pässen und einem vollwertigen Compiler wäre.  Und da das Schema <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">formal definiert ist</a> , besteht keine Notwendigkeit, etwas zu erfinden. <br><br>  Ich habe über drei Jahre lang mit Schema-VM herumgespielt und viel über das Kompilieren gelernt.  Am Ende wurde mir klar, dass ich dieses Projekt nicht beenden konnte.  Der Code verwandelte sich in echtes Chaos, aber ein Ende war nicht in Sicht.  Ohne einen Mentor oder eine Erfahrung schien ich im Dunkeln zu wandern.  Wie sich herausstellte, stimmt <i>die</i> Sprachspezifikation nicht mit dem <i>Handbuch</i> überein.  Lektion gelernt! <br><br>  Bis Ende 2017 habe ich Schema-VM auf der Suche nach etwas Besserem verschoben. <br><br><h1>  Treffen mit Mal </h1><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/386/7e7/183/3867e7183f1ec919f168fcfefc2ec6b3.png"></a> <br><br>  Irgendwann im Jahr 2018 stieß ich <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">auf Mal</a> , einen Lisp-Dolmetscher im Clojure-Stil. <br><br>  Mal wurde von Joel Martin als Trainingsinstrument erfunden.  Seitdem wurden mehr als 75 Implementierungen in verschiedenen Sprachen entwickelt!  Als ich mir diese Implementierungen ansah, stellte ich fest, dass sie wirklich helfen: Wenn ich nicht weiterkomme, kann ich in der Ruby- oder Python-Version nach Hinweisen suchen.  Endlich spricht wenigstens jemand meine Sprache! <br><br>  Ich dachte auch, wenn ich einen Interpreter für Mal schreiben könnte, könnte ich die gleichen Schritte wiederholen - und einen Compiler für Mal erstellen. <br><br><h1>  Mal Dolmetscher auf Rust </h1><br>  Zuerst begann ich, den Interpreter gemäß der <a href="">exemplarischen Vorgehensweise zu entwickeln</a> .  Zu dieser Zeit habe ich Rust aktiv studiert (ich werde es für einen anderen Artikel belassen), also habe ich meine eigene Implementierung von Mal in Rust geschrieben: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Mal-</a> Rust.  Weitere Informationen zu diesem Experiment finden Sie hier. <br><br>  <b>Es war ein perfektes Vergnügen!</b>  Ich weiß nicht, wie ich Joel dafür danken oder loben soll, dass er einen hervorragenden Leitfaden für Mal erstellt hat.  Jeder Schritt wird ausführlich <i>beschrieben</i> , es gibt Flussdiagramme, Pseudocode und <b>Tests</b> !  Alles, was ein Entwickler benötigt, um eine Programmiersprache von Anfang bis Ende zu erstellen. <br><br>  Gegen Ende des Tutorials gelang es mir, meine in Mal geschriebene Mal-Implementierung für Mal zusätzlich zu meiner Rust-Implementierung auszuführen.  (zwei Tiefenstufen, wow).  Als sie zum ersten Mal arbeitete, sprang ich vor Aufregung auf einen Stuhl! <br><br><h1>  Compiler Mal C. </h1><br>  Sobald ich die Lebensfähigkeit von Mal-Rust bewiesen hatte, begann ich sofort zu erforschen, wie man einen Compiler schreibt.  Zum Assembler kompilieren?  Kann ich Maschinencode direkt kompilieren? <br><br>  Ich habe den in Ruby geschriebenen x86-Assembler gesehen.  Er faszinierte mich, aber der Gedanke, mit einem Assembler zusammenzuarbeiten, ließ mich aufhören. <br><br>  Irgendwann bin ich auf diesen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Kommentar in Hacker News</a> gestoßen, der den <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Tiny C Compiler</a> als "Compilation Backend" bezeichnete.  Es schien eine großartige Idee zu sein! <br><br>  TinyCC verfügt über eine Testdatei, die zeigt, <a href="">wie mit libtcc</a> C-Code aus dem C-Programm kompiliert wird. Dies ist der Ausgangspunkt für „Hallo Welt“. <br><br>  Als ich wieder auf die exemplarische Vorgehensweise von Mal zurückkam und mich an meine Kenntnisse von C erinnerte, konnte ich in ein paar Monaten freier Abende und Wochenenden den Mal-Compiler schreiben.  Es war eine wahre Freude. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/187/2e2/99e/1872e299effaaea82a3716cd48cdf27a.png"></a> <br><br>  Wenn Sie es gewohnt sind, durch Tests zu entwickeln, bewerten Sie die Verfügbarkeit einer vorläufigen Testreihe.  Tests führen zu einer funktionierenden Implementierung. <br><br>  Ich kann nicht viel über diesen Prozess sagen, es sei denn, ich wiederhole: Das Mal-Handbuch ist ein wahrer Schatz.  Bei jedem Schritt wusste ich genau, was zu tun war! <br><br><h1>  Schwierigkeiten </h1><br>  Rückblickend sind hier einige Schwierigkeiten beim Schreiben des Mal-Compilers, an dem ich basteln musste: <br><br><ol><li>  Makros müssen im laufenden Betrieb kompiliert werden und zur Kompilierungszeit ausgeführt werden können.  Das ist etwas verwirrend. <br></li><li>  Sowohl für den Compiler-Code als auch für den endgültigen Code des kompilierten Programms muss eine „Umgebung“ (ein Baum von Hashes / assoziativen Arrays / Wörterbüchern mit Variablen und deren Werten) bereitgestellt werden.  Auf diese Weise können Sie zur Kompilierungszeit Makros definieren. <br></li><li>  Da die Umgebung zur Kompilierungszeit verfügbar ist, hat Malcc beim Kompilieren zunächst <i>undefinierte</i> Fehler festgestellt (Zugriff auf eine nicht definierte Variable), und an einigen Stellen hat dies die Erwartungen der Testsuite verletzt.  Um die Tests zu bestehen, habe ich diese Funktion deaktiviert.  Es wäre großartig, es als zusätzliches Flag des Compilers wieder hinzuzufügen, da Sie auf diese Weise viele Fehler im Voraus abfangen können. </li><li>  Ich habe C-Code kompiliert, indem ich in drei Zeilen der Struktur geschrieben habe: <ul><li>  <code>top</code> : Code der obersten Ebene - hier sind die Funktionen </li><li>  <code>decl</code> : Deklaration und Initialisierung der im Body verwendeten Variablen </li><li>  <code>body</code> : Körper, in dem die Hauptarbeit erledigt wird </li></ul></li><li>  Den ganzen Tag fragte ich mich, ob ich meinen eigenen Müllsammler schreiben könnte, aber ich beschloss, diese Übung für später zu verlassen.  Die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Speicherbereinigungsbibliothek Boehm-Demers-Weiser</a> ist einfach zu verbinden und auf vielen Plattformen verfügbar. <br></li><li>  Es ist wichtig, dass Sie sich den Code ansehen, den Ihr Compiler schreibt.  Immer wenn der Compiler auf eine <code>DEBUG</code> Umgebungsvariable stieß, gab er kompilierten C-Code zurück, in dem Fehler angezeigt werden konnten. </li></ol><br><h1>  Was würde ich sonst tun? </h1><br><ol><li>  C-Code zu schreiben und zu versuchen, die Einrückung beizubehalten, war nicht einfach, dann würde ich die Automatisierung nicht ablehnen.  Es scheint mir, dass einige Compiler hässlichen Code schreiben und dann von einer speziellen Bibliothek "dekoriert" werden, bevor sie ausgegeben werden.  Es muss studiert werden! <br></li><li>  Das Hinzufügen zu Zeilen während der Codegenerierung ist etwas chaotisch.  Sie könnten in Betracht ziehen, einen AST zu erstellen und ihn dann in die letzte Zeile des C-Codes zu konvertieren. Dies sollte den Code in Ordnung bringen und Harmonie schaffen. </li></ol><br><a name="1"></a><h1>  Nun Ratschläge </h1><br>  Ich mag es, dass der Compiler fast ein Jahrzehnt gebraucht hat.  Nein wirklich.  Jeder Schritt auf dem Weg ist eine angenehme Erinnerung daran, wie ich allmählich ein immer besserer Programmierer wurde. <br><br>  Das heißt aber nicht, dass ich "fertig" bin.  Es gibt immer noch Hunderte von Methoden und Werkzeugen, die Sie lernen müssen, um sich als echter Compilerautor zu fühlen.  Aber ich kann zuversichtlich sagen: "Ich habe es getan." <br><br>  Hier ist der gesamte Prozess in einer übersichtlichen Form, wie Sie Ihren eigenen Lisp-Compiler erstellen: <br><br><ol><li>  Wählen Sie die Sprache, in der Sie sich wohl fühlen.  Sie möchten nicht gleichzeitig eine neue Sprache lernen und eine andere neue Sprache schreiben. <br></li><li>  Schreiben Sie nach <a href="">dem Mal-Handbuch</a> einen Dolmetscher. <br></li><li>  Freut euch! <br></li><li>  Befolgen Sie die Anweisungen erneut, aber anstatt den Code auszuführen, schreiben Sie Code, der den Code ausführt.  (Nicht nur das Umgestalten des vorhandenen Interpreters. Sie müssen bei Null anfangen, obwohl das Kopieren und Einfügen nicht verboten ist.) </li></ol><br>  Ich glaube, dass diese Methode mit jeder Programmiersprache verwendet werden kann, die in eine ausführbare Datei kompiliert wird.  Zum Beispiel können Sie: <br><br><ol><li>  Schreiben Sie den Mal-Interpreter auf <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Go</a> . </li><li>  Ändern Sie Ihren Code in: <br><ul><li>  Erstellen Sie eine Zeile Go-Code und schreiben Sie ihn in eine Datei. </li><li>  Kompilieren Sie diese resultierende Datei mit <code>go build</code> . </li></ul></li></ol><br>  Im Idealfall ist es besser, den Go-Compiler als Bibliothek zu steuern, aber dies ist auch eine Möglichkeit, einen Compiler zu erstellen! <br><br>  Mit Hilfe von Mals Führer und Ihrem Einfallsreichtum können Sie all dies tun.  Wenn auch ich könnte, dann kannst du! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de446808/">https://habr.com/ru/post/de446808/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de446794/index.html">Wir arbeiten korrekt mit Wordstat. Komplette Anleitung</a></li>
<li><a href="../de446796/index.html">Nicht standardmäßige Schaltung: Sieben-Segment-Anzeige bei ATtiny13</a></li>
<li><a href="../de446798/index.html">Der Abgang eines Elektronikingenieurs von Apple sorgte bei Aktienspekulanten für Aufsehen. Wie werde ich wie er?</a></li>
<li><a href="../de446802/index.html">Punktkassetten nachfüllen - das ist interessant</a></li>
<li><a href="../de446806/index.html">Hintergrund: "Autonomous Runet" - was ist das und wer braucht es?</a></li>
<li><a href="../de446810/index.html">Wenn Sie eine Schachtel Zigaretten in der Tasche haben ...</a></li>
<li><a href="../de446812/index.html">Mobilität und Umweltfreundlichkeit: Wie moderne Obusse ohne Trolleys fahren können</a></li>
<li><a href="../de446816/index.html">OOP, die "Heilige Dreifaltigkeit" und SOLID: einige minimale Kenntnisse über sie</a></li>
<li><a href="../de446818/index.html">Venus, der Mond, im Folgenden überall: ein Interview mit Pavel Shubin</a></li>
<li><a href="../de446820/index.html">Webinar - Authentifizierung und ES in VDI-Umgebungen mit Dell Thin Clients und JaCarta-Dongles</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>