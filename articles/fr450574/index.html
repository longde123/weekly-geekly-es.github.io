<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🗯️ 👨🏽‍🔧 🏖️ Créer un jeu web .io multijoueur 🚴🏽 🚛 📿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sorti en 2015, Agar.io est devenu l'ancêtre du nouveau genre de jeux .io , dont la popularité a depuis considérablement augmenté. La croissance de la ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Créer un jeu web .io multijoueur</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/450574/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c7c/405/7a7/c7c4057a7ab7333ee3cb9aba5ecc8c37.jpg" alt="image"></div><br>  Sorti en 2015, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">Agar.io</a> est devenu l'ancêtre du nouveau genre de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer"><strong>jeux .io</strong></a> , dont la popularité a depuis considérablement augmenté.  La croissance de la popularité des jeux .io que j'ai connue sur moi-même: au cours des trois dernières années, j'ai <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">créé et vendu deux jeux de ce genre.</a>  . <br><br>  Dans le cas où vous n'avez jamais entendu parler de tels jeux auparavant: ce sont des jeux Web multijoueurs gratuits auxquels il est facile de participer (aucun compte requis).  Habituellement, ils poussent de nombreux joueurs adverses dans la même arène.  D'autres jeux célèbres du genre .io sont: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">Slither.io</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">Diep.io.</a> <br><br>  Dans cet article, nous découvrirons comment <strong>créer un jeu .io à partir de zéro</strong> .  Pour cela, seule la connaissance de Javascript sera suffisante: vous devez comprendre des choses telles que la syntaxe <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">ES6</a> , le <code>this</code> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">Promises</a> .  Même si vous ne connaissez pas parfaitement Javascript, vous pouvez toujours comprendre la plupart des messages. <br><a name="habracut"></a><br><h2>  Exemple de jeu .io </h2><br>  Pour vous aider à apprendre, nous nous référerons à <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">un exemple de jeu .io</a> .  Essayez de jouer! <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/um/yq/qj/umyqqjon22wmshrz8o8wtyeaxl0.png"></div><br>  Le jeu est assez simple: vous contrôlez un navire dans une arène où il y a d'autres joueurs.  Votre vaisseau tire automatiquement des obus et vous essayez de frapper d'autres joueurs, tout en évitant leurs obus. <br><br><h2>  1. Aperçu / structure du projet </h2><br><blockquote>  Je recommande de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer"><strong>télécharger le code source d'un</strong></a> exemple de jeu afin que vous puissiez me suivre. </blockquote><br>  L'exemple utilise les éléments suivants: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">Express</a> est le cadre Web le plus populaire pour Node.js qui gère le serveur Web du jeu. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">socket.io</a> - une bibliothèque websocket pour échanger des données entre un navigateur et un serveur. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Webpack</a> est un gestionnaire de modules.  Vous pouvez découvrir pourquoi utiliser Webpack <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . </li></ul><br>  Voici à quoi ressemble la structure du répertoire du projet: <br><br><pre> <code class="hljs axapta"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span>/ assets/ ... src/ <span class="hljs-keyword"><span class="hljs-keyword">client</span></span>/ css/ ... html/ <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>.html <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>.js ... <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>/ <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>.js ... shared/ constants.js</code> </pre> <br><h3>  public / </h3><br>  Tout dans le dossier <code>public/</code> sera transmis statiquement par le serveur.  <code>public/assets/</code> contient les images utilisées par notre projet. <br><br><h3>  src / </h3><br>  Tout le code source se trouve dans le dossier <code>src/</code> .  Les noms <code>client/</code> et <code>server/</code> parlent d'eux-mêmes et <code>shared/</code> contient un fichier constant importé par le client et le serveur. <br><br><h2>  2. Assemblages / paramètres du projet </h2><br>  Comme indiqué ci-dessus, nous utilisons le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">gestionnaire de</a> modules <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Webpack</a> pour construire le projet.  Jetons un œil à notre configuration Webpack: <br><br><h5>  webpack.common.js: </h5><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> path = require(<span class="hljs-string"><span class="hljs-string">'path'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> MiniCssExtractPlugin = require(<span class="hljs-string"><span class="hljs-string">'mini-css-extract-plugin'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">module</span></span>.exports = { entry: { game: <span class="hljs-string"><span class="hljs-string">'./src/client/index.js'</span></span>, }, output: { filename: <span class="hljs-string"><span class="hljs-string">'[name].[contenthash].js'</span></span>, path: path.resolve(__dirname, <span class="hljs-string"><span class="hljs-string">'dist'</span></span>), }, <span class="hljs-keyword"><span class="hljs-keyword">module</span></span>: { rules: [ { test: /\.js$/, exclude: /node_modules/, use: { loader: <span class="hljs-string"><span class="hljs-string">"babel-loader"</span></span>, options: { presets: [<span class="hljs-string"><span class="hljs-string">'@babel/preset-env'</span></span>], }, }, }, { test: /\.css$/, use: [ { loader: MiniCssExtractPlugin.loader, }, <span class="hljs-string"><span class="hljs-string">'css-loader'</span></span>, ], }, ], }, plugins: [ <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MiniCssExtractPlugin({ filename: <span class="hljs-string"><span class="hljs-string">'[name].[contenthash].css'</span></span>, }), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HtmlWebpackPlugin({ filename: <span class="hljs-string"><span class="hljs-string">'index.html'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>: <span class="hljs-string"><span class="hljs-string">'src/client/html/index.html'</span></span>, }), ], };</code> </pre> <br>  Les plus importantes ici sont les lignes suivantes: <br><br><ul><li>  <code>src/client/index.js</code> est le point d'entrée du client Javascript (JS).  Webpack démarre à partir d'ici et recherche récursivement d'autres fichiers importés. </li><li>  Le JS de sortie de notre assemblage Webpack sera situé dans le répertoire <code>dist/</code> .  J'appellerai ce fichier notre <strong>package JS</strong> . </li><li>  Nous utilisons <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">Babel</a> , et en particulier la configuration <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">@ babel / preset-env</a> pour transpiler notre code JS pour les navigateurs plus anciens. </li><li>  Nous utilisons le plugin pour extraire tous les CSS référencés par les fichiers JS et les combiner en un seul endroit.  Je l'appellerai notre <strong>package CSS</strong> . </li></ul><br>  Vous avez peut-être remarqué d'étranges noms de fichiers de package <code>'[name].[contenthash].ext'</code> .  Ils contiennent la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">substitution des noms des fichiers</a> Webpack: <code>[name]</code> sera remplacé par le nom du point d'entrée (dans notre cas, c'est un <code>game</code> ), et <code>[contenthash]</code> sera remplacé par un hachage du contenu du fichier.  Nous faisons cela afin d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">optimiser le projet pour le hachage</a> - vous pouvez dire aux navigateurs de mettre en cache nos packages JS indéfiniment, car <strong>si le package change, alors son nom de fichier</strong> change (changements de <code>contenthash</code> ).  Le résultat final sera un nom de fichier de la forme <code>game.dbeee76e91a97d0c7207.js</code> . <br><br>  Le fichier <code>webpack.common.js</code> est le fichier de configuration de base que nous importons dans les configurations de développement et de projet terminées.  Par exemple, une configuration de développement: <br><br><h5>  webpack.dev.js </h5><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> merge = require(<span class="hljs-string"><span class="hljs-string">'webpack-merge'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> common = require(<span class="hljs-string"><span class="hljs-string">'./webpack.common.js'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">module</span></span>.exports = merge(common, { mode: <span class="hljs-string"><span class="hljs-string">'development'</span></span>, });</code> </pre> <br>  Pour plus d'efficacité, nous utilisons <code>webpack.dev.js</code> dans le <code>webpack.dev.js</code> développement et <code>webpack.prod.js</code> vers <code>webpack.prod.js</code> pour optimiser la taille des packages lorsqu'ils sont déployés en production. <br><br><h3>  Réglage local </h3><br>  Je recommande d'installer le projet sur une machine locale afin que vous puissiez suivre les étapes répertoriées dans cet article.  La configuration est simple: tout d'abord, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Node</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">NPM</a> doivent être installés sur le système.  Ensuite, vous devez effectuer <br><br><pre> <code class="cpp hljs">$ git clone https:<span class="hljs-comment"><span class="hljs-comment">//github.com/vzhou842/example-.io-game.git $ cd example-.io-game $ npm install</span></span></code> </pre> <br>  et vous êtes prêt à partir!  Pour démarrer le serveur de développement, exécutez simplement <br><br><pre> <code class="cpp hljs">$ npm run develop</code> </pre> <br>  et accédez à l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">hôte local: 3000</a> dans un navigateur Web.  Le serveur de développement reconstruira automatiquement les packages JS et CSS à mesure que le code change - actualisez simplement la page pour voir toutes les modifications! <br><br><h2>  3. Points d'entrée des clients </h2><br>  Passons au code du jeu lui-même.  Tout d'abord, nous avons besoin de la page <code>index.html</code> , lorsque vous visitez le site, le navigateur la charge d'abord.  Notre page sera assez simple: <br><br><h5>  index.html </h5><br><pre>  &lt;! DOCTYPE html&gt;
 &lt;html&gt;
 &lt;head&gt;
   &lt;title&gt; Un exemple de jeu .io &lt;/title&gt;
   &lt;link type = "text / css" rel = "stylesheet" href = "/ game.bundle.css"&gt;
 &lt;/head&gt;
 &lt;body&gt;
   &lt;canvas id = "game-canvas"&gt; &lt;/canvas&gt;
   &lt;script async src = "/ game.bundle.js"&gt; &lt;/script&gt;
   &lt;div id = "play-menu" class = "hidden"&gt;
     &lt;input type = "text" id = "username-input" placeholder = "Username" /&gt;
     &lt;button id = "play-button"&gt; PLAY &lt;/button&gt;
   &lt;/div&gt;
 &lt;/body&gt;
 &lt;/html&gt; </pre><br>  <i>Cet exemple de code est légèrement simplifié pour plus de clarté, je ferai de même avec de nombreux autres exemples de poste.</i>  <i>Le code complet peut toujours être consulté sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Github</a> .</i> <br><br>  Nous avons: <br><br><ul><li>  <code>&lt;canvas&gt;</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">HTML5 Canvas</a> ( <code>&lt;canvas&gt;</code> ) que nous utiliserons pour rendre le jeu. </li><li>  <code>&lt;link&gt;</code> pour ajouter notre package CSS. </li><li>  <code>&lt;script&gt;</code> pour ajouter notre package Javascript. </li><li>  Le menu principal avec le nom d'utilisateur <code>&lt;input&gt;</code> et le <code>&lt;button&gt;</code> "PLAY" ( <code>&lt;button&gt;</code> ). </li></ul><br>  Après avoir chargé la page d'accueil, le code Javascript commencera à s'exécuter dans le navigateur, en commençant par le fichier JS du point d'entrée: <code>src/client/index.js</code> . <br><br><h5>  index.js </h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { connect, play } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./networking'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { startRendering, stopRendering } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./render'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { startCapturingInput, stopCapturingInput } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./input'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { downloadAssets } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./assets'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { initState } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./state'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { setLeaderboardHidden } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./leaderboard'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">'./css/main.css'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> playMenu = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">'play-menu'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> playButton = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">'play-button'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> usernameInput = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">'username-input'</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>.all([ connect(), downloadAssets(), ]).then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { playMenu.classList.remove(<span class="hljs-string"><span class="hljs-string">'hidden'</span></span>); usernameInput.focus(); playButton.onclick = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-comment"><span class="hljs-comment">// Play! play(usernameInput.value); playMenu.classList.add('hidden'); initState(); startCapturingInput(); startRendering(); setLeaderboardHidden(false); }; });</span></span></code> </pre> <br>  Cela peut sembler compliqué, mais en réalité, peu d'actions se produisent ici: <br><br><ol><li>  Importez plusieurs autres fichiers JS. </li><li>  Importez du CSS (afin que Webpack sache les inclure dans notre package CSS). </li><li>  Exécutez <code>connect()</code> pour établir une connexion au serveur et exécutez <code>downloadAssets()</code> pour télécharger les images nécessaires au rendu du jeu. </li><li>  <em>Une fois l'étape 3 terminée</em> , le menu principal ( <code>playMenu</code> ) <code>playMenu</code> . </li><li>  Configuration du gestionnaire pour appuyer sur le bouton PLAY.  Lorsque le bouton est enfoncé, le code initialise le jeu et indique au serveur que nous sommes prêts à jouer. </li></ol><br>  La «viande» principale de notre logique client-serveur réside dans les fichiers importés par le fichier <code>index.js</code> .  Nous allons maintenant les considérer tous en ordre. <br><br><h2>  4. Échange de données clients </h2><br>  Dans ce jeu, nous utilisons la bibliothèque bien connue <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">socket.io</a> pour communiquer avec le serveur.  Socket.io a un support intégré pour les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">WebSockets</a> , qui sont bien adaptés à la communication bidirectionnelle: nous pouvons envoyer des messages au serveur <em>et le</em> serveur peut nous envoyer des messages via la même connexion. <br><br>  Nous aurons un fichier <code>src/client/networking.js</code> qui gérera <strong>toutes les</strong> communications avec le serveur: <br><br><h5>  networking.js </h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'socket.io-client'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { processGameUpdate } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./state'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Constants = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../shared/constants'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> socket = io(<span class="hljs-string"><span class="hljs-string">`ws://</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${</span></span><span class="hljs-built_in"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-built_in">window</span></span></span></span><span class="hljs-string"><span class="hljs-subst">.location.host}</span></span></span><span class="hljs-string">`</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> connectedPromise = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">resolve</span></span></span><span class="hljs-function"> =&gt;</span></span> { socket.on(<span class="hljs-string"><span class="hljs-string">'connect'</span></span>, () =&gt; { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'Connected to server!'</span></span>); resolve(); }); }); <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> connect = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">onGameOver</span></span></span><span class="hljs-function"> =&gt;</span></span> ( connectedPromise.then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-comment"><span class="hljs-comment">// Register callbacks socket.on(Constants.MSG_TYPES.GAME_UPDATE, processGameUpdate); socket.on(Constants.MSG_TYPES.GAME_OVER, onGameOver); }) ); export const play = username =&gt; { socket.emit(Constants.MSG_TYPES.JOIN_GAME, username); }; export const updateDirection = dir =&gt; { socket.emit(Constants.MSG_TYPES.INPUT, dir); };</span></span></code> </pre> <br>  <i>Ce code est également légèrement réduit pour plus de clarté.</i> <br><br>  Ce fichier comporte trois actions principales: <br><br><ul><li>  Nous essayons de nous connecter au serveur.  <code>connectedPromise</code> n'est autorisé que lorsque nous avons établi une connexion. </li><li>  Si la connexion est établie avec succès, nous enregistrons les fonctions de rappel ( <code>processGameUpdate()</code> et <code>onGameOver()</code> ) pour les messages que nous pouvons recevoir du serveur. </li><li>  Nous exportons <code>play()</code> et <code>updateDirection()</code> afin que d'autres fichiers puissent les utiliser. </li></ul><br><h2>  5. Rendu client </h2><br>  Il est temps d'afficher une image à l'écran! <br><br>  ... mais avant de pouvoir le faire, nous devons télécharger toutes les images (ressources) nécessaires pour cela.  Écrivons un gestionnaire de ressources: <br><br><h5>  assets.js </h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ASSET_NAMES = [<span class="hljs-string"><span class="hljs-string">'ship.svg'</span></span>, <span class="hljs-string"><span class="hljs-string">'bullet.svg'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> assets = {}; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> downloadPromise = <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>.all(ASSET_NAMES.map(downloadAsset)); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">downloadAsset</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">assetName</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">resolve</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> asset = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Image(); asset.onload = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">`Downloaded </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${assetName}</span></span></span><span class="hljs-string">`</span></span>); assets[assetName] = asset; resolve(); }; asset.src = <span class="hljs-string"><span class="hljs-string">`/assets/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${assetName}</span></span></span><span class="hljs-string">`</span></span>; }); } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> downloadAssets = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> downloadPromise; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> getAsset = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">assetName</span></span></span><span class="hljs-function"> =&gt;</span></span> assets[assetName];</code> </pre> <br>  La gestion des ressources n'est pas si difficile à mettre en œuvre!  Le point principal est de stocker l'objet d' <code>assets</code> , qui liera la clé du nom de fichier à la valeur de l'objet <code>Image</code> .  Lorsque la ressource est chargée, nous l'enregistrons dans l'objet d' <code>assets</code> pour une récupération rapide à l'avenir.  Lorsque le téléchargement sera autorisé pour chaque ressource individuelle (c'est-à-dire que <strong>toutes les</strong> ressources seront téléchargées), nous activons <code>downloadPromise</code> . <br><br>  Après avoir téléchargé les ressources, vous pouvez commencer le rendu.  Comme indiqué précédemment, nous utilisons <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">HTML5 Canvas</a> ( <code>&lt;canvas&gt;</code> ) pour dessiner sur la page Web.  Notre jeu est assez simple, il nous suffit donc de dessiner uniquement les éléments suivants: <br><br><ol><li>  Contexte </li><li>  Navire joueur </li><li>  Autres joueurs du jeu </li><li>  Coquillages </li></ol><br>  Voici les extraits importants de <code>src/client/render.js</code> qui rendent exactement les quatre points énumérés ci-dessus: <br><br><h5>  render.js </h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { getAsset } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./assets'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { getCurrentState } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./state'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Constants = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../shared/constants'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { PLAYER_RADIUS, PLAYER_MAX_HP, BULLET_RADIUS, MAP_SIZE } = Constants; <span class="hljs-comment"><span class="hljs-comment">// Get the canvas graphics context const canvas = document.getElementById('game-canvas'); const context = canvas.getContext('2d'); // Make the canvas fullscreen canvas.width = window.innerWidth; canvas.height = window.innerHeight; function render() { const { me, others, bullets } = getCurrentState(); if (!me) { return; } // Draw background renderBackground(me.x, me.y); // Draw all bullets bullets.forEach(renderBullet.bind(null, me)); // Draw all players renderPlayer(me, me); others.forEach(renderPlayer.bind(null, me)); } // ... Helper functions here excluded let renderInterval = null; export function startRendering() { renderInterval = setInterval(render, 1000 / 60); } export function stopRendering() { clearInterval(renderInterval); }</span></span></code> </pre> <br>  <i>Ce code est également raccourci pour plus de clarté.</i> <br><br>  <code>render()</code> est la fonction principale de ce fichier.  <code>startRendering()</code> et <code>stopRendering()</code> contrôlent l'activation du cycle de rendu à 60 FPS. <br><br>  Les implémentations spécifiques des fonctions de rendu auxiliaires individuelles (par exemple, <code>renderBullet()</code> ) ne sont pas si importantes, mais voici un exemple simple: <br><br><h5>  render.js </h5><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">renderBullet</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">me, bullet</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { x, y } = bullet; context.drawImage( getAsset(<span class="hljs-string"><span class="hljs-string">'bullet.svg'</span></span>), canvas.width / <span class="hljs-number"><span class="hljs-number">2</span></span> + x - me.x - BULLET_RADIUS, canvas.height / <span class="hljs-number"><span class="hljs-number">2</span></span> + y - me.y - BULLET_RADIUS, BULLET_RADIUS * <span class="hljs-number"><span class="hljs-number">2</span></span>, BULLET_RADIUS * <span class="hljs-number"><span class="hljs-number">2</span></span>, ); }</code> </pre> <br>  Notez que nous utilisons la méthode <code>getAsset()</code> qui a été vue précédemment dans <code>asset.js</code> ! <br><br><blockquote>  Si vous souhaitez explorer d'autres fonctions de rendu auxiliaires, lisez le reste de <a href="">src / client / render.js</a> . </blockquote><br><h2>  6. Contribution du client </h2><br>  Il est temps de rendre le jeu <em>jouable</em> !  Le schéma de contrôle sera très simple: vous pouvez utiliser la souris (sur l'ordinateur) ou toucher l'écran (sur l'appareil mobile) pour changer la direction du mouvement.  Pour implémenter cela, nous enregistrerons les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">écouteurs d'événements</a> pour les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">événements</a> Mouse and Touch. <br>  <code>src/client/input.js</code> fera tout cela: <br><br><h5>  input.js </h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { updateDirection } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./networking'</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onMouseInput</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ handleInput(e.clientX, e.clientY); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onTouchInput</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> touch = e.touches[<span class="hljs-number"><span class="hljs-number">0</span></span>]; handleInput(touch.clientX, touch.clientY); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handleInput</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">x, y</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> dir = <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.atan2(x - <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.innerWidth / <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.innerHeight / <span class="hljs-number"><span class="hljs-number">2</span></span> - y); updateDirection(dir); } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startCapturingInput</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.addEventListener(<span class="hljs-string"><span class="hljs-string">'mousemove'</span></span>, onMouseInput); <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.addEventListener(<span class="hljs-string"><span class="hljs-string">'touchmove'</span></span>, onTouchInput); } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stopCapturingInput</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.removeEventListener(<span class="hljs-string"><span class="hljs-string">'mousemove'</span></span>, onMouseInput); <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.removeEventListener(<span class="hljs-string"><span class="hljs-string">'touchmove'</span></span>, onTouchInput); }</code> </pre> <br>  <code>onMouseInput()</code> et <code>onTouchInput()</code> sont des écouteurs d'événements qui appellent <code>updateDirection()</code> (à partir de <code>networking.js</code> ) lorsqu'un événement d'entrée se produit (par exemple, lors du déplacement de la souris).  <code>updateDirection()</code> est engagé dans la messagerie avec un serveur qui traite l'événement d'entrée et met à jour l'état du jeu en conséquence. <br><br><h2>  7. Condition du client </h2><br><blockquote>  Cette section est la plus difficile dans la première partie de l'article.  Ne vous découragez pas si vous ne le comprenez pas dès la première lecture!  Vous pouvez même l'ignorer et y revenir plus tard. </blockquote><br>  La dernière pièce du puzzle nécessaire pour terminer le code client-serveur est l' <strong>état</strong> .  Vous vous souvenez de l'extrait de code de la section Rendu client? <br><br><h5>  render.js </h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { getCurrentState } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./state'</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">render</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { me, others, bullets } = getCurrentState(); <span class="hljs-comment"><span class="hljs-comment">// Do the rendering // ... }</span></span></code> </pre> <br>  <code>getCurrentState()</code> devrait être en mesure de nous fournir à tout moment l'état actuel du jeu dans le client <strong>en</strong> fonction des mises à jour reçues du serveur.  Voici un exemple de mise à jour de jeu qu'un serveur peut envoyer: <br><br><pre> <code class="cpp hljs">{ <span class="hljs-string"><span class="hljs-string">"t"</span></span>: <span class="hljs-number"><span class="hljs-number">1555960373725</span></span>, <span class="hljs-string"><span class="hljs-string">"me"</span></span>: { <span class="hljs-string"><span class="hljs-string">"x"</span></span>: <span class="hljs-number"><span class="hljs-number">2213.8050880413657</span></span>, <span class="hljs-string"><span class="hljs-string">"y"</span></span>: <span class="hljs-number"><span class="hljs-number">1469.370893425012</span></span>, <span class="hljs-string"><span class="hljs-string">"direction"</span></span>: <span class="hljs-number"><span class="hljs-number">1.3082443894581433</span></span>, <span class="hljs-string"><span class="hljs-string">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"AhzgAtklgo2FJvwWAADO"</span></span>, <span class="hljs-string"><span class="hljs-string">"hp"</span></span>: <span class="hljs-number"><span class="hljs-number">100</span></span> }, <span class="hljs-string"><span class="hljs-string">"others"</span></span>: [], <span class="hljs-string"><span class="hljs-string">"bullets"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"RUJfJ8Y18n"</span></span>, <span class="hljs-string"><span class="hljs-string">"x"</span></span>: <span class="hljs-number"><span class="hljs-number">2354.029197099604</span></span>, <span class="hljs-string"><span class="hljs-string">"y"</span></span>: <span class="hljs-number"><span class="hljs-number">1431.6848318262666</span></span> }, { <span class="hljs-string"><span class="hljs-string">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"ctg5rht5s"</span></span>, <span class="hljs-string"><span class="hljs-string">"x"</span></span>: <span class="hljs-number"><span class="hljs-number">2260.546457727445</span></span>, <span class="hljs-string"><span class="hljs-string">"y"</span></span>: <span class="hljs-number"><span class="hljs-number">1456.8088728920968</span></span> } ], <span class="hljs-string"><span class="hljs-string">"leaderboard"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"username"</span></span>: <span class="hljs-string"><span class="hljs-string">"Player"</span></span>, <span class="hljs-string"><span class="hljs-string">"score"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span> } ] }</code> </pre> <br>  Chaque mise à jour du jeu contient cinq champs identiques: <br><br><ul><li>  <strong>t</strong> : horodatage du serveur pour l'heure de création de cette mise à jour. </li><li>  <strong>moi</strong> : informations sur le joueur qui reçoit cette mise à jour. </li><li>  <strong>autres</strong> : un tableau d'informations sur les autres joueurs participant au même jeu. </li><li>  <strong>balles</strong> : un tableau d'informations sur les obus du jeu. </li><li>  <strong>leaderboard</strong> : données actuelles du leaderboard.  Dans ce post, nous ne les prendrons pas en compte. </li></ul><br><h3>  7.1 L'état naïf du client </h3><br>  L'implémentation naïve de <code>getCurrentState()</code> ne peut que renvoyer directement les données de la dernière mise à jour du jeu reçue. <br><br><h5>  naive-state.js </h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> lastGameUpdate = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-comment"><span class="hljs-comment">// Handle a newly received game update. export function processGameUpdate(update) { lastGameUpdate = update; } export function getCurrentState() { return lastGameUpdate; }</span></span></code> </pre> <br>  Beau et clair!  Mais si tout était si simple.  L'une des raisons pour lesquelles cette implémentation est problématique: <strong>elle limite la fréquence d'images du rendu à la fréquence de l'horloge du serveur</strong> . <br><br><blockquote>  <strong>Fréquence</strong> d'images: nombre d'images (c. <code>render()</code> Appels de <code>render()</code> ) par seconde, ou FPS.  Les jeux ont généralement tendance à atteindre au moins 60 FPS. </blockquote><br><blockquote>  <strong>Taux de tick</strong> : fréquence à laquelle le serveur envoie des mises à jour du jeu aux clients.  <strong>Il est souvent inférieur à la fréquence d'images</strong> .  Dans notre jeu, le serveur fonctionne à une fréquence de 30 cycles par seconde. </blockquote><br>  Si nous rendons simplement la dernière mise à jour du jeu, alors FPS ne pourra en fait jamais dépasser 30, car <em>nous ne recevons jamais plus de 30 mises à jour par seconde du serveur</em> .  Même si nous appelons <code>render()</code> 60 fois par seconde, la moitié de ces appels redessineront simplement la même chose, ne faisant essentiellement rien.  Un autre problème de mise en œuvre naïve est qu'elle est <strong>sujette à des retards</strong> .  Avec une vitesse Internet idéale, le client recevra une mise à jour du jeu exactement toutes les 33 ms (30 par seconde): <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/bc3/815/7c9/bc38157c91d436b5fedf948b60c8a213.svg"></div><br>  Malheureusement, rien n'est parfait.  Une image plus réaliste serait: <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/836/45f/75e/83645f75e556bc5c1c38111a69510734.svg"></div><br>  Une mise en œuvre naïve est pratiquement le pire des cas de retard.  Si la mise à jour du jeu est reçue avec un retard de 50 ms, le <strong>client ralentit</strong> pendant 50 ms supplémentaires, car il restitue l'état du jeu à partir de la mise à jour précédente.  Vous pouvez imaginer à quel point cela est gênant pour un joueur: en raison d'un freinage arbitraire, le jeu semblera instable et instable. <br><br><h3>  7.2 Statut client amélioré </h3><br>  Nous apporterons quelques améliorations à l'implémentation naïve.  Tout d'abord, nous utilisons <strong>un délai de rendu de</strong> 100 ms.  Cela signifie que l'état "actuel" du client sera toujours en retard de 100 ms sur l'état du jeu sur le serveur.  Par exemple, si l'heure sur le serveur est <strong>150</strong> , alors l'état dans lequel le serveur était à l'heure <strong>50</strong> sera rendu sur le client: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/788/1b5/c78/7881b5c789321648ff1ff70d15b881d4.svg"></div><br>  Cela nous donne un tampon de 100 ms, nous permettant de survivre au temps imprévisible pour recevoir les mises à jour du jeu: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c1e/494/615/c1e4946159c599c7a2a9196968755e4b.svg"></div><br>  Le payer sera un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">retard d'entrée</a> constant <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">(décalage d'entrée) de</a> 100 ms.  Il s'agit d'un sacrifice mineur pour un gameplay fluide - la plupart des joueurs (en particulier les joueurs occasionnels) ne remarqueront même pas ce retard.  Il est beaucoup plus facile pour les gens de s'adapter à un retard constant de 100 ms que de jouer avec un retard imprévisible. <br><br><blockquote>  Nous pouvons utiliser une autre technique appelée <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">«prévisions côté client»,</a> qui fait un bon travail de réduction des retards perçus, mais elle ne sera pas considérée dans ce post. </blockquote><br>  Une autre amélioration que nous utilisons est <strong>l'interpolation linéaire</strong> .  En raison des retards de rendu, nous dépassons généralement l'heure actuelle dans le client par au moins une mise à jour.  Lorsque <code>getCurrentState()</code> est appelé, nous pouvons effectuer <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">une interpolation linéaire</a> entre les mises à jour du jeu immédiatement avant et après l'heure actuelle dans le client: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2ca/1c8/91c/2ca1c891ce7db0341dc78c2f88e16ce4.svg"></div><br>  Cela résout le problème de la fréquence d'images: nous pouvons maintenant rendre des images uniques avec n'importe quelle fréquence dont nous avons besoin! <br><br><h3>  7.3 Implémentation du statut client amélioré </h3><br>  Un exemple d'implémentation dans <code>src/client/state.js</code> utilise à la fois le délai de rendu et l'interpolation linéaire, mais ce n'est pas pour longtemps.  Décomposons le code en deux parties.  Voici le premier: <br><br><h5>  state.js partie 1 </h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> RENDER_DELAY = <span class="hljs-number"><span class="hljs-number">100</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> gameUpdates = []; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> gameStart = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> firstServerTimestamp = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initState</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ gameStart = <span class="hljs-number"><span class="hljs-number">0</span></span>; firstServerTimestamp = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processGameUpdate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">update</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!firstServerTimestamp) { firstServerTimestamp = update.t; gameStart = <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>.now(); } gameUpdates.push(update); <span class="hljs-comment"><span class="hljs-comment">// Keep only one game update before the current server time const base = getBaseUpdate(); if (base &gt; 0) { gameUpdates.splice(0, base); } } function currentServerTime() { return firstServerTimestamp + (Date.now() - gameStart) - RENDER_DELAY; } // Returns the index of the base update, the first game update before // current server time, or -1 if N/A. function getBaseUpdate() { const serverTime = currentServerTime(); for (let i = gameUpdates.length - 1; i &gt;= 0; i--) { if (gameUpdates[i].t &lt;= serverTime) { return i; } } return -1; }</span></span></code> </pre> <br>  La première étape consiste à comprendre ce que fait <code>currentServerTime()</code> .  Comme nous l'avons vu précédemment, un horodatage du serveur est inclus dans chaque mise à jour du jeu.  Nous voulons utiliser le délai de rendu pour rendre l'image 100 ms derrière le serveur, mais <strong>nous ne connaîtrons jamais l'heure actuelle sur le serveur</strong> , car nous ne pouvons pas savoir combien de temps les mises à jour nous sont parvenues.  Internet est imprévisible et sa vitesse peut varier considérablement! <br><br>  Pour contourner ce problème, vous pouvez utiliser une approximation raisonnable: nous <strong>prétendrons que la première mise à jour est arrivée instantanément</strong> .  Si cela était vrai, nous saurions l'heure du serveur à ce moment particulier!  Nous enregistrons l'horodatage du serveur dans <code>firstServerTimestamp</code> et enregistrons notre horodatage <strong>local</strong> (client) en même temps dans <code>gameStart</code> . <br><br>  Oh attends.  <b>Ne devrait-il pas y avoir de temps sur le serveur = temps dans le client?</b>  Pourquoi faisons-nous la distinction entre «horodatage serveur» et «horodatage client»?  C'est une excellente question!  Il s'avère que ce n'est pas la même chose.  <code>Date.now()</code> renverra différents horodatages sur le client et le serveur, et cela dépend des facteurs locaux pour ces machines.  <strong>Ne présumez jamais que les horodatages sont les mêmes sur toutes les machines.</strong> <br><br>  Nous comprenons maintenant ce que fait <code>currentServerTime()</code> : il retourne l' <strong>horodatage du serveur pour le temps de rendu actuel</strong> .<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En d'autres termes, il s'agit de l'heure actuelle du serveur ( </font></font><code>firstServerTimestamp &lt;+ (Date.now() - gameStart)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) moins le délai de rendu ( </font></font><code>RENDER_DELAY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voyons maintenant comment nous gérons les mises à jour du jeu. Lorsqu'une mise à jour est reçue du serveur, elle est appelée </font></font><code>processGameUpdate()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et nous enregistrons la nouvelle mise à jour dans un tableau </font></font><code>gameUpdates</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Ensuite, pour vérifier l'utilisation de la mémoire, nous supprimons toutes les anciennes mises à jour de la </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mise</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> à jour de </font><strong><font style="vertical-align: inherit;">base</font></strong><font style="vertical-align: inherit;"> , car nous n'en avons plus besoin. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qu'est-ce qu'une "mise à jour de base"? Il s'agit de la </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">première mise à jour que nous constatons en reculant par rapport à l'heure actuelle du serveur</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Rappelez-vous ce circuit?</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2ca/1c8/91c/2ca1c891ce7db0341dc78c2f88e16ce4.svg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La mise à jour du jeu directement à gauche de Client Render Time est une mise à jour de base. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">À quoi sert la mise à jour de base? </font><font style="vertical-align: inherit;">Pourquoi pouvons-nous supprimer les mises à jour de la base? </font><font style="vertical-align: inherit;">Pour comprendre cela, regardons </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">enfin</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> l'implémentation </font></font><code>getCurrentState()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> state.js partie 2 </font></font></h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCurrentState</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!firstServerTimestamp) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> {}; } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> base = getBaseUpdate(); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> serverTime = currentServerTime(); <span class="hljs-comment"><span class="hljs-comment">// If base is the most recent update we have, use its state. // Else, interpolate between its state and the state of (base + 1). if (base &lt; 0) { return gameUpdates[gameUpdates.length - 1]; } else if (base === gameUpdates.length - 1) { return gameUpdates[base]; } else { const baseUpdate = gameUpdates[base]; const next = gameUpdates[base + 1]; const r = (serverTime - baseUpdate.t) / (next.t - baseUpdate.t); return { me: interpolateObject(baseUpdate.me, next.me, r), others: interpolateObjectArray(baseUpdate.others, next.others, r), bullets: interpolateObjectArray(baseUpdate.bullets, next.bullets, r), }; } }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Nous traitons trois cas: </font></font><br><br><ol><li> <code>base &lt; 0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">signifie qu'il n'y a pas de mise à jour du temps de rendu actuel (voir implémentation ci-dessus </font></font><code>getBaseUpdate()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">Cela peut se produire dès le début du jeu en raison de retards de rendu. </font><font style="vertical-align: inherit;">Dans ce cas, nous utilisons la mise à jour la plus récente.</font></font></li><li> <code>base</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ceci est la dernière mise à jour que nous avons. </font><font style="vertical-align: inherit;">Cela peut être dû à une latence du réseau ou à une mauvaise connexion Internet. </font><font style="vertical-align: inherit;">Dans ce cas, nous utilisons également la dernière mise à jour que nous avons.</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous avons une mise à jour avant et après le temps de rendu actuel, vous pouvez donc </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">interpoler</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> !</font></font></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il ne reste plus qu'à </font></font><code>state.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">implémenter l'interpolation linéaire, qui est un calcul simple (mais ennuyeux). </font><font style="vertical-align: inherit;">Si vous voulez l'apprendre vous-même, ouvrez-le </font></font><code>state.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sur </font></font><a href="" rel="noopener noreferrer"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Partie 2. Serveur principal </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans cette partie, nous allons examiner le backend Node.js qui exécute notre </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exemple de jeu .io</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1. Point d'entrée du serveur </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour contrôler le serveur Web, nous utiliserons le cadre Web populaire pour Node.js appelé </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Express</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Il sera configuré par notre fichier de point d'entrée de serveur </font></font><code>src/server/server.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> server.js, partie 1 </font></font></h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> express = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'express'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> webpack = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'webpack'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> webpackDevMiddleware = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'webpack-dev-middleware'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> webpackConfig = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../../webpack.dev.js'</span></span>); <span class="hljs-comment"><span class="hljs-comment">// Setup an Express server const app = express(); app.use(express.static('public')); if (process.env.NODE_ENV === 'development') { // Setup Webpack for development const compiler = webpack(webpackConfig); app.use(webpackDevMiddleware(compiler)); } else { // Static serve the dist/ folder in production app.use(express.static('dist')); } // Listen on port const port = process.env.PORT || 3000; const server = app.listen(port); console.log(`Server listening on port ${port}`);</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rappelez-vous que dans la première partie, nous avons discuté de Webpack? </font><font style="vertical-align: inherit;">C'est là que nous utiliserons nos configurations Webpack. </font><font style="vertical-align: inherit;">Nous les appliquerons de deux manières:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Utilisez </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">webpack-dev-middleware</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour reconstruire automatiquement nos packages de développement, ou</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transférez statiquement le dossier </font></font><code>dist/</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans lequel Webpack écrira nos fichiers après l'assemblage de la production.</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une autre tâche importante </font></font><code>server.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">consiste à configurer le serveur </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">socket.io</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui se connecte simplement au serveur Express:</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> server.js, partie 2 </font></font></h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> socketio = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'socket.io'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Constants = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../shared/constants'</span></span>); <span class="hljs-comment"><span class="hljs-comment">// Setup Express // ... const server = app.listen(port); console.log(`Server listening on port ${port}`); // Setup socket.io const io = socketio(server); // Listen for socket.io connections io.on('connection', socket =&gt; { console.log('Player connected!', socket.id); socket.on(Constants.MSG_TYPES.JOIN_GAME, joinGame); socket.on(Constants.MSG_TYPES.INPUT, handleInput); socket.on('disconnect', onDisconnect); });</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Après avoir réussi à établir une connexion socket.io avec le serveur, nous configurons les gestionnaires d'événements pour le nouveau socket. </font><font style="vertical-align: inherit;">Les gestionnaires d'événements traitent les messages reçus des clients par délégation à l'objet singleton </font></font><code>game</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> server.js, partie 3 </font></font></h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Game = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./game'</span></span>); <span class="hljs-comment"><span class="hljs-comment">// ... // Setup the Game const game = new Game(); function joinGame(username) { game.addPlayer(this, username); } function handleInput(dir) { game.handleInput(this, dir); } function onDisconnect() { game.removePlayer(this); }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous créons un jeu du genre .io, nous n'avons donc besoin que d'une seule instance </font></font><code>Game</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(«Jeu») - tous les joueurs jouent dans la même arène! </font><font style="vertical-align: inherit;">Dans la section suivante, nous verrons comment fonctionne cette classe </font></font><code>Game</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 2. Serveur de jeu </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La classe </font></font><code>Game</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">contient la logique côté serveur la plus importante. </font><font style="vertical-align: inherit;">Il a deux tâches principales: la </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gestion des joueurs</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et la </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">simulation de jeu</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Commençons par la première tâche - avec la gestion des joueurs.</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> game.js, partie 1 </font></font></h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Constants = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../shared/constants'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Player = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./player'</span></span>); <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Game</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.sockets = {}; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.players = {}; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bullets = []; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.lastUpdateTime = <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>.now(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.shouldSendUpdate = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; setInterval(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.update.bind(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>), <span class="hljs-number"><span class="hljs-number">1000</span></span> / <span class="hljs-number"><span class="hljs-number">60</span></span>); } addPlayer(socket, username) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.sockets[socket.id] = socket; <span class="hljs-comment"><span class="hljs-comment">// Generate a position to start this player at. const x = Constants.MAP_SIZE * (0.25 + Math.random() * 0.5); const y = Constants.MAP_SIZE * (0.25 + Math.random() * 0.5); this.players[socket.id] = new Player(socket.id, username, x, y); } removePlayer(socket) { delete this.sockets[socket.id]; delete this.players[socket.id]; } handleInput(socket, dir) { if (this.players[socket.id]) { this.players[socket.id].setDirection(dir); } } // ... }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans ce jeu, nous allons identifier les joueurs par le champ de </font></font><code>id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">leur socket socket.io (si vous êtes confus, revenez à </font></font><code>server.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">Socket.io lui-même attribue un socket unique à chaque socket </font></font><code>id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, nous n'avons donc pas à nous en préoccuper. </font><font style="vertical-align: inherit;">Je vais appeler son </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ID de joueur</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans cet esprit, examinons les variables d'instance dans la classe </font></font><code>Game</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><ul><li> <code>sockets</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Est un objet qui lie l'ID du lecteur à la socket associée au lecteur. </font><font style="vertical-align: inherit;">Il nous permet d'accéder aux sockets par leur identifiant de joueur pendant un temps constant.</font></font></li><li> <code>players</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Est un objet qui lie un ID joueur à un code&gt; Objet joueur </font></font></li></ul><br> <code>bullets</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Est un tableau d'objets </font></font><code>Bullet</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qui n'a pas d'ordre spécifique. </font></font><br> <code>lastUpdateTime</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Il s'agit de l'horodatage de la dernière mise à jour du jeu. </font><font style="vertical-align: inherit;">Bientôt, nous verrons comment il est utilisé. </font></font><br> <code>shouldSendUpdate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Est une variable auxiliaire. </font><font style="vertical-align: inherit;">Nous verrons bientôt son utilisation. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les méthodes </font></font><code>addPlayer()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>removePlayer()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>handleInput()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pas besoin d'expliquer, elles sont utilisées dans </font></font><code>server.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Si vous avez besoin de rafraîchir votre mémoire, remontez un peu plus haut. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La dernière ligne </font></font><code>constructor()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">démarre </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">le cycle de mise à jour du</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> jeu (avec une fréquence de 60 mises à jour / s):</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> game.js, partie 2 </font></font></h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Constants = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../shared/constants'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> applyCollisions = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./collisions'</span></span>); <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Game</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... update() { // Calculate time elapsed const now = Date.now(); const dt = (now - this.lastUpdateTime) / 1000; this.lastUpdateTime = now; // Update each bullet const bulletsToRemove = []; this.bullets.forEach(bullet =&gt; { if (bullet.update(dt)) { // Destroy this bullet bulletsToRemove.push(bullet); } }); this.bullets = this.bullets.filter( bullet =&gt; !bulletsToRemove.includes(bullet), ); // Update each player Object.keys(this.sockets).forEach(playerID =&gt; { const player = this.players[playerID]; const newBullet = player.update(dt); if (newBullet) { this.bullets.push(newBullet); } }); // Apply collisions, give players score for hitting bullets const destroyedBullets = applyCollisions( Object.values(this.players), this.bullets, ); destroyedBullets.forEach(b =&gt; { if (this.players[b.parentID]) { this.players[b.parentID].onDealtDamage(); } }); this.bullets = this.bullets.filter( bullet =&gt; !destroyedBullets.includes(bullet), ); // Check if any players are dead Object.keys(this.sockets).forEach(playerID =&gt; { const socket = this.sockets[playerID]; const player = this.players[playerID]; if (player.hp &lt;= 0) { socket.emit(Constants.MSG_TYPES.GAME_OVER); this.removePlayer(socket); } }); // Send a game update to each player every other time if (this.shouldSendUpdate) { const leaderboard = this.getLeaderboard(); Object.keys(this.sockets).forEach(playerID =&gt; { const socket = this.sockets[playerID]; const player = this.players[playerID]; socket.emit( Constants.MSG_TYPES.GAME_UPDATE, this.createUpdate(player, leaderboard), ); }); this.shouldSendUpdate = false; } else { this.shouldSendUpdate = true; } } // ... }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La méthode </font></font><code>update()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">contient probablement la partie la plus importante de la logique côté serveur. </font><font style="vertical-align: inherit;">Dans l'ordre, nous listons tout ce qu'il fait:</font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Calcule le temps </font></font><code>dt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">écoulé depuis le dernier </font></font><code>update()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li><li>        .      .    ,  <code>bullet.update()</code> <strong> <code>true</code> ,     </strong> (    ). </li><li>        .       — <code>player.update()</code> <strong>   <code>Bullet</code></strong> . </li><li>         <code>applyCollisions()</code> ,    ,    .        ,    (  <code>player.onDealtDamage()</code> ),       <code>bullets</code> . </li><li>      . </li><li>      <strong> </strong>    <code>update()</code> .         <code>shouldSendUpdate</code> .   <code>update()</code>  60 /,     30 /.  , <strong> </strong>   30 / (       ). </li></ol><br><blockquote> <strong>     <em> </em> ?</strong>   . 30     –   ! </blockquote><br><blockquote> <strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pourquoi alors ne pas appeler </font></font><code>update()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">30 fois par seconde? </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour améliorer la simulation du jeu. </font><font style="vertical-align: inherit;">Le plus souvent appelé </font></font><code>update()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, le plus précis sera la simulation du jeu. </font><font style="vertical-align: inherit;">Mais ne vous laissez pas trop emporter par le nombre d'appels </font></font><code>update()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, car c'est une tâche coûteuse en calcul - 60 par seconde est assez suffisant.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le reste de la classe se </font></font><code>Game</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">compose de méthodes d'assistance utilisées dans </font></font><code>update()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> game.js, partie 3 </font></font></h5><br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Game</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... getLeaderboard() { return Object.values(this.players) .sort((p1, p2) =&gt; p2.score - p1.score) .slice(0, 5) .map(p =&gt; ({ username: p.username, score: Math.round(p.score) })); } createUpdate(player, leaderboard) { const nearbyPlayers = Object.values(this.players).filter( p =&gt; p !== player &amp;&amp; p.distanceTo(player) &lt;= Constants.MAP_SIZE / 2, ); const nearbyBullets = this.bullets.filter( b =&gt; b.distanceTo(player) &lt;= Constants.MAP_SIZE / 2, ); return { t: Date.now(), me: player.serializeForUpdate(), others: nearbyPlayers.map(p =&gt; p.serializeForUpdate()), bullets: nearbyBullets.map(b =&gt; b.serializeForUpdate()), leaderboard, }; } }</span></span></code> </pre> <br> <code>getLeaderboard()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">assez simple - il trie les joueurs par le nombre de points, prend les cinq meilleurs et revient pour chaque nom d'utilisateur et score. </font></font><br><br> <code>createUpdate()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">utilisé </font></font><code>update()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pour créer des mises à jour de jeu qui sont transmises aux joueurs. </font><font style="vertical-align: inherit;">Sa tâche principale est d'appeler les méthodes </font></font><code>serializeForUpdate()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">implémentées pour </font></font><code>Player</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et les </font><font style="vertical-align: inherit;">classes </font></font><code>Bullet</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Notez qu'il transfère à chaque joueur uniquement les </font><font style="vertical-align: inherit;">informations </font><font style="vertical-align: inherit;">sur les </font><font style="vertical-align: inherit;">joueurs et les obus </font><font style="vertical-align: inherit;">les </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">plus proches</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - il n'est pas nécessaire de transmettre des informations sur les objets de jeu situés loin du joueur!</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 3. Objets de jeu sur le serveur </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans notre jeu, les coquilles et les joueurs sont en fait très similaires: ce sont des objets de jeu circulaires abstraits. </font><font style="vertical-align: inherit;">Pour profiter de cette similitude des joueurs et des shells, commençons par l'implémentation de la classe de base </font></font><code>Object</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> object.js </font></font></h5><br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Object</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(id, x, y, dir, speed) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.id = id; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.x = x; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.y = y; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.direction = dir; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.speed = speed; } update(dt) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.x += dt * <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.speed * <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.sin(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.direction); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.y -= dt * <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.speed * <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.cos(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.direction); } distanceTo(object) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> dx = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.x - object.x; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> dy = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.y - object.y; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.sqrt(dx * dx + dy * dy); } setDirection(dir) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.direction = dir; } serializeForUpdate() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.id, <span class="hljs-attr"><span class="hljs-attr">x</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.x, <span class="hljs-attr"><span class="hljs-attr">y</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.y, }; } }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rien de compliqué ne se passe ici. </font><font style="vertical-align: inherit;">Cette classe sera un bon point de référence pour l'expansion. </font><font style="vertical-align: inherit;">Voyons comment la classe </font></font><code>Bullet</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">utilise </font></font><code>Object</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> bullet.js </font></font></h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> shortid = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'shortid'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ObjectClass = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./object'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Constants = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../shared/constants'</span></span>); <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Bullet</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ObjectClass</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(parentID, x, y, dir) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(shortid(), x, y, dir, Constants.BULLET_SPEED); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.parentID = parentID; } <span class="hljs-comment"><span class="hljs-comment">// Returns true if the bullet should be destroyed update(dt) { super.update(dt); return this.x &lt; 0 || this.x &gt; Constants.MAP_SIZE || this.y &lt; 0 || this.y &gt; Constants.MAP_SIZE; } }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'implémentation est </font></font><code>Bullet</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">très courte! </font><font style="vertical-align: inherit;">Nous avons ajouté </font></font><code>Object</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uniquement aux extensions suivantes:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Utiliser un package </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">shortid</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour générer aléatoirement un </font></font><code>id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">projectile.</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ajout d'un champ </font></font><code>parentID</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pour suivre le joueur qui a créé ce projectile.</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ajouter une valeur de retour à </font></font><code>update()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, qui est égale </font></font><code>true</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">si le projectile est en dehors de l'arène (rappelez-vous, nous en avons parlé dans la dernière section?).</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Passons à </font></font><code>Player</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> player.js </font></font></h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ObjectClass = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./object'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Bullet = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./bullet'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Constants = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../shared/constants'</span></span>); <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Player</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ObjectClass</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(id, username, x, y) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(id, x, y, <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.random() * <span class="hljs-number"><span class="hljs-number">2</span></span> * <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.PI, Constants.PLAYER_SPEED); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.username = username; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.hp = Constants.PLAYER_MAX_HP; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fireCooldown = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.score = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-comment"><span class="hljs-comment">// Returns a newly created bullet, or null. update(dt) { super.update(dt); // Update score this.score += dt * Constants.SCORE_PER_SECOND; // Make sure the player stays in bounds this.x = Math.max(0, Math.min(Constants.MAP_SIZE, this.x)); this.y = Math.max(0, Math.min(Constants.MAP_SIZE, this.y)); // Fire a bullet, if needed this.fireCooldown -= dt; if (this.fireCooldown &lt;= 0) { this.fireCooldown += Constants.PLAYER_FIRE_COOLDOWN; return new Bullet(this.id, this.x, this.y, this.direction); } return null; } takeBulletDamage() { this.hp -= Constants.BULLET_DAMAGE; } onDealtDamage() { this.score += Constants.SCORE_BULLET_HIT; } serializeForUpdate() { return { ...(super.serializeForUpdate()), direction: this.direction, hp: this.hp, }; } }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les joueurs sont plus complexes que les obus, donc quelques champs supplémentaires devraient être stockés dans cette classe. Sa méthode </font></font><code>update()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fait beaucoup de travail, en particulier, renvoie le shell nouvellement créé s'il n'est pas laissé </font></font><code>fireCooldown</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(rappelez-vous, nous en avons parlé dans la section précédente?). Il étend également la méthode </font></font><code>serializeForUpdate()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, car nous devons inclure des champs supplémentaires pour le joueur dans la mise à jour du jeu. </font></font><br><br> <strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Avoir une classe de base </font></font><code>Object</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">est une étape importante pour éviter la répétabilité du code</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Par exemple, sans classe, </font></font><code>Object</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">chaque objet de jeu devrait avoir la même implémentation </font></font><code>distanceTo()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, et la synchronisation copier-coller de toutes ces implémentations dans plusieurs fichiers serait un cauchemar. </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cela devient particulièrement important pour les grands projets</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> lorsque le nombre de </font></font><code>Object</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">classes d' </font><font style="vertical-align: inherit;">extension </font><font style="vertical-align: inherit;">augmente.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 4. Reconnaissance des conflits </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il ne nous reste plus qu'à reconnaître quand les obus frappent les joueurs! </font><font style="vertical-align: inherit;">Rappelez-vous ce morceau de code d'une méthode </font></font><code>update()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans une classe </font></font><code>Game</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> game.js </font></font></h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> applyCollisions = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./collisions'</span></span>); <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Game</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... update() { // ... // Apply collisions, give players score for hitting bullets const destroyedBullets = applyCollisions( Object.values(this.players), this.bullets, ); destroyedBullets.forEach(b =&gt; { if (this.players[b.parentID]) { this.players[b.parentID].onDealtDamage(); } }); this.bullets = this.bullets.filter( bullet =&gt; !destroyedBullets.includes(bullet), ); // ... } }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous devons implémenter une méthode </font></font><code>applyCollisions()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qui retourne tous les obus qui frappent les joueurs. </font><font style="vertical-align: inherit;">Heureusement, ce n'est pas si difficile à faire, car</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tous les objets en collision sont des cercles, et c'est la figure la plus simple pour implémenter la reconnaissance des collisions. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous avons déjà une méthode </font></font><code>distanceTo()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que nous avons implémentée dans la section précédente de la classe </font></font><code>Object</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Voici à quoi ressemble notre implémentation de reconnaissance des collisions: </font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> collisions.js </font></font></h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Constants = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../shared/constants'</span></span>); <span class="hljs-comment"><span class="hljs-comment">// Returns an array of bullets to be destroyed. function applyCollisions(players, bullets) { const destroyedBullets = []; for (let i = 0; i &lt; bullets.length; i++) { // Look for a player (who didn't create the bullet) to collide each bullet with. // As soon as we find one, break out of the loop to prevent double counting a bullet. for (let j = 0; j &lt; players.length; j++) { const bullet = bullets[i]; const player = players[j]; if ( bullet.parentID !== player.id &amp;&amp; player.distanceTo(bullet) &lt;= Constants.PLAYER_RADIUS + Constants.BULLET_RADIUS ) { destroyedBullets.push(bullet); player.takeBulletDamage(); break; } } } return destroyedBullets; }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cette simple reconnaissance de collision est basée sur le fait que </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">deux cercles entrent en collision si la distance entre leurs centres est inférieure à la somme de leurs rayons</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Voici le cas où la distance entre les centres de deux cercles est exactement égale à la somme de leurs rayons:</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/63f/e73/2c8/63fe732c87ed1872522787e3cc4d5ab2.svg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ici, vous devez examiner attentivement quelques aspects: </font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le projectile ne doit pas tomber dans le joueur qui l'a créé. </font><font style="vertical-align: inherit;">Ceci peut être réalisé en comparant </font></font><code>bullet.parentID</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avec </font></font><code>player.id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le projectile ne doit frapper qu'une seule fois dans le cas extrême d'une collision simultanée avec plusieurs joueurs. </font><font style="vertical-align: inherit;">Nous allons résoudre ce problème avec l'aide de l'opérateur </font></font><code>break</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: dès qu'un joueur est entré en collision avec un projectile, nous arrêtons de chercher et passons au projectile suivant.</font></font></li></ul><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> La fin </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C'est tout! </font><font style="vertical-align: inherit;">Nous avons couvert tout ce que vous devez savoir pour créer un jeu Web .io.</font></font> Et ensuite? <strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Créez votre propre jeu .io! </font></font></strong> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tous les exemples de code sont open source et publiés sur </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr450574/">https://habr.com/ru/post/fr450574/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr450556/index.html">Indice de valve - examen du nouvel ensemble VR</a></li>
<li><a href="../fr450564/index.html">Paillettes et pauvreté: comment la révolution numérique a rendu les musiciens plus pauvres</a></li>
<li><a href="../fr450566/index.html">OutOfMemory et l'utilisation d'images vectorielles dans Android Studio</a></li>
<li><a href="../fr450568/index.html">Chaque poison a son propre antidote. Comment économiser ou au moins essayer (mise à jour: à propos des antidotes contre les empoisonnements domestiques)</a></li>
<li><a href="../fr450572/index.html">Samba DC en tant que deuxième contrôleur dans le domaine AD de Windows 2012R2 et dossiers itinérants pour les clients sous Windows et Linux</a></li>
<li><a href="../fr450576/index.html">De nouvelles règles pour l'anonymat des messagers</a></li>
<li><a href="../fr450578/index.html">Qu'entend-on dans l'air? Nous recevons et décodons les signaux les plus intéressants. Partie 2, VHF</a></li>
<li><a href="../fr450582/index.html">Principes PIM</a></li>
<li><a href="../fr450586/index.html">Fish Redux - Nouvelle bibliothèque Redux pour Flutter</a></li>
<li><a href="../fr450592/index.html">En Allemagne, le coût du voyage en voiture électrique peut être plus élevé qu'en voiture diesel</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>