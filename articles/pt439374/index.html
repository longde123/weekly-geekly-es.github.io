<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üÜé üïù ü§∏üèº Para aqueles que querem jogar detetive: encontre o erro na fun√ß√£o do Midnight Commander üëàüèª üõÄüèª üéÅ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Convidamos voc√™ a tentar encontrar um erro em uma fun√ß√£o muito simples do projeto GNU Midnight Commander. Porque Assim mesmo. √â engra√ßado e interessan...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Para aqueles que querem jogar detetive: encontre o erro na fun√ß√£o do Midnight Commander</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/439374/"><p><img src="https://habrastorage.org/getpro/habr/post_images/687/3a6/927/6873a6927bd61a58aa2d2a53b7a31df6.png" alt="Encontre o erro!"></p><br>  Convidamos voc√™ a tentar encontrar um erro em uma fun√ß√£o muito simples do projeto GNU Midnight Commander.  Porque  Assim mesmo.  √â engra√ßado e interessante.  Embora n√£o, n√≥s mentimos.  Mais uma vez, queremos demonstrar um erro que uma pessoa encontra com dificuldade no processo de revis√£o de c√≥digo, mas encontra facilmente o analisador de c√≥digo est√°tico do PVS-Studio. <br><a name="habracut"></a><br>  Recentemente, recebemos uma carta perguntando por que o analisador gera um aviso na fun√ß√£o <i>EatWhitespace</i> , cujo c√≥digo √© fornecido abaixo.  Na verdade, a quest√£o n√£o √© t√£o simples.  Tente descobrir o que h√° de errado com esse c√≥digo. <br><br><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EatWhitespace</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(FILE * InFile)</span></span></span><span class="hljs-function"> </span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment">/* ----------------------------------------------------------------------- ** * Scan past whitespace (see ctype(3C)) and return the first non-whitespace * character, or newline, or EOF. * * Input: InFile - Input source. * * Output: The next non-whitespace character in the input stream. * * Notes: Because the config files use a line-oriented grammar, we * explicitly exclude the newline character from the list of * whitespace characters. * - Note that both EOF (-1) and the nul character ('\0') are * considered end-of-file markers. * * ----------------------------------------------------------------------- ** */</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> c; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (c = getc (InFile); <span class="hljs-built_in"><span class="hljs-built_in">isspace</span></span> (c) &amp;&amp; (<span class="hljs-string"><span class="hljs-string">'\n'</span></span> != c); c = getc (InFile)) ; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (c); } <span class="hljs-comment"><span class="hljs-comment">/* EatWhitespace */</span></span></code> </pre> <br>  Como voc√™ pode ver, a fun√ß√£o <i>EatWhitespace √©</i> muito pequena.  Mesmo um coment√°rio em uma fun√ß√£o ocupa mais espa√ßo do que o corpo da pr√≥pria fun√ß√£o :).  Agora alguns detalhes. <br><br>  Descri√ß√£o da fun√ß√£o <i>Getc</i> : <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getc</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( FILE * stream )</span></span></span></span>;</code> </pre> <br>  A fun√ß√£o retorna o caractere apontado pelo indicador interno da posi√ß√£o do arquivo do fluxo especificado.  Ent√£o o indicador vai para o pr√≥ximo caractere.  Se o final do arquivo for atingido no momento da chamada para o fluxo, a fun√ß√£o retornar√° <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">EOF</a> e definir√° o indicador de fim do arquivo para esse fluxo.  Se ocorrer um erro de leitura, a fun√ß√£o retornar√° um valor EOF e definir√° um indicador de erro para o fluxo especificado (ferror). <br><br>  Descri√ß√£o da fun√ß√£o <i>isspace</i> : <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isspace</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ch )</span></span></span></span>;</code> </pre> <br>  A fun√ß√£o verifica se o caractere est√° em branco, de acordo com a classifica√ß√£o do c√≥digo do idioma atual.  No c√≥digo do idioma padr√£o, os seguintes caracteres s√£o espa√ßos em branco: <br><br><ul><li>  espa√ßo (0x20, ``); </li><li>  mudan√ßa de p√°gina (0x0c, '\ f'); </li><li>  avan√ßo de linha LF (0x0a, '\ n'); </li><li>  retorno de carro CR (0x0d, '\ r'); </li><li>  guia horizontal (0x09, '\ t'); </li><li>  guia vertical (0x0b, '\ v'). </li></ul><br>  <b>Valor de retorno</b>  Valor diferente de zero, se o caractere for espa√ßo em branco, zero caso contr√°rio. <br><br>  A fun√ß√£o <i>EatWhitespace</i> deve pular todos os caracteres considerados em branco, exceto o feed de linha '\ n'.  Outro motivo para interromper a leitura de um arquivo pode estar chegando ao final do arquivo (EOF). <br><br>  E agora, sabendo tudo isso, tente encontrar um erro! <br><br>  Para impedir que o leitor acidentalmente n√£o olhe imediatamente para a resposta, adicione alguns unic√≥rnios em espera. <br><br><p><img src="https://habrastorage.org/getpro/habr/post_images/58d/139/130/58d1391306fa2c02969581281747e5fb.png" alt="Figura 1. Hora de procurar um erro.  Unic√≥rnios v√£o esperar."></p><br>  <font color="#999999"><i>Figura 1. Hora de procurar um erro.</i></font>  <font color="#999999"><i>Unic√≥rnios v√£o esperar.</i></font> <br><br>  Ainda n√£o encontrou o erro? <br><br>  O fato √© que <i>enganamos os</i> leitores sobre o <i>isspace</i> .  Haha  Este n√£o √© um recurso padr√£o, mas uma macro caseira.  Sim, somos inocentes e deixamos voc√™ confuso. <br><br><p><img src="https://habrastorage.org/getpro/habr/post_images/011/c8b/5cf/011c8b5cfed117704c596889c41f7e46.png" alt="Figura 2. Um unic√≥rnio d√° aos leitores uma impress√£o falsa do espa√ßo em quest√£o."></p><br>  <font color="#999999"><i>Figura 2. Um unic√≥rnio d√° aos leitores uma falsa impress√£o do que <i>√© isspace</i> .</i></font> <br><br>  Na verdade, √© claro, n√≥s e nosso unic√≥rnio n√£o temos culpa.  Os autores do projeto GNU Midnight Commander contribu√≠ram para a confus√£o ao decidir criar sua pr√≥pria implementa√ß√£o de espa√ßo de <i>iss</i> no arquivo <i>charset.h</i> : <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> isspace #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">undef</span></span></span><span class="hljs-meta"> isspace #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> .... #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> isspace(c) ((c)==</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">' '</span></span></span><span class="hljs-meta"> || (c) == </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'\t'</span></span></span><span class="hljs-meta">)</span></span></code> </pre> <br>  Ao criar essa macro, alguns desenvolvedores confundiram outros.  O c√≥digo √© escrito na suposi√ß√£o de que <i>isspace</i> √© uma fun√ß√£o padr√£o que considera retornos de carro (0x0d, '\ r') como um dos caracteres de espa√ßo em branco. <br><br>  A macro implementada considera apenas espa√ßos e tabula√ß√µes como caracteres de espa√ßo em branco.  Vamos substituir a macro e ver o que acontece. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (c = getc (InFile); ((c)==<span class="hljs-string"><span class="hljs-string">' '</span></span> || (c) == <span class="hljs-string"><span class="hljs-string">'\t'</span></span>) &amp;&amp; (<span class="hljs-string"><span class="hljs-string">'\n'</span></span> != c); c = getc (InFile))</code> </pre> <br>  A subexpress√£o ('\ n'! = C) √© redundante (redundante), pois seu resultado sempre ser√° verdadeiro.  O analisador PVS-Studio alerta sobre isso, emitindo um aviso: <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">V560</a> Uma parte da express√£o condicional √© sempre verdadeira: ('\ n'! = C).  params.c 136. <br><br>  Para maior clareza, vamos analisar tr√™s op√ß√µes para o desenvolvimento de eventos: <br><br><ul><li>  O final do arquivo √© atingido.  O fim do arquivo (EOF) n√£o √© um espa√ßo ou tabula√ß√£o.  A subexpress√£o ('\ n'! = C) n√£o √© calculada devido √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">avalia√ß√£o de curto-circuito</a> .  O ciclo para. </li><li>  Qualquer caractere que n√£o seja um espa√ßo ou tabula√ß√£o √© lido.  A subexpress√£o ('\ n'! = C) n√£o √© calculada devido √† avalia√ß√£o de curto-circuito.  O ciclo para. </li><li>  Leia um caractere de espa√ßo ou uma guia horizontal.  A subexpress√£o ('\ n'! = C) √© calculada, mas seu resultado sempre ser√° verdadeiro. </li></ul><br>  Em outras palavras, o c√≥digo revisado √© equivalente a isso: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (c = getc (InFile); c==<span class="hljs-string"><span class="hljs-string">' '</span></span> || c == <span class="hljs-string"><span class="hljs-string">'\t'</span></span>; c = getc (InFile))</code> </pre> <br>  Descobrimos que o c√≥digo n√£o funciona conforme o esperado.  Vamos ver agora que consequ√™ncias isso tem. <br><br>  O programador que escreveu a chamada <i>isspace</i> no corpo da fun√ß√£o <i>EatWhitespace</i> esperava que uma fun√ß√£o padr√£o fosse chamada.  Por isso, ele adicionou a condi√ß√£o de que o avan√ßo de linha LF ('\ n') n√£o deve ser considerado um caractere de espa√ßo em branco. <br><br>  Portanto, o programador planejou que, al√©m das guias de espa√ßo e horizontais, caracteres como mudan√ßa de p√°gina e guia vertical fossem ignorados. <br><br>  Vale ressaltar que tamb√©m foi planejado pular o caractere de retorno de carro CR (0x0d, '\ r').  Isso n√£o acontece e o ciclo para quando encontra esse s√≠mbolo.  Isso causar√° surpresas desagrad√°veis ‚Äã‚Äãse o separador de linhas no arquivo for a sequ√™ncia CR + LF usada em alguns sistemas n√£o UNIX, como o Microsoft Windows. <br><br>  Para aqueles que desejam aprender mais sobre os motivos hist√≥ricos para usar LF ou CR + LF como separadores de linhas, aqui est√° o artigo da Wikipedia " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Feed de linha</a> ". <br><br>  A fun√ß√£o <i>EatWhitespace deve</i> processar arquivos da mesma maneira, onde LF e CR + LF s√£o usados ‚Äã‚Äãcomo um separador.  Para o caso de CR + LF, n√£o √© assim.  Em outras palavras, se seu arquivo veio do mundo do Windows, voc√™ est√° sem sorte :). <br><br>  Talvez este n√£o seja um erro s√©rio, especialmente porque o GNU Midnight Commander √© comum em sistemas operacionais do tipo UNIX, onde o caractere LF (0x0a, '\ n') √© usado para converter uma linha.  No entanto, devido a essas insignific√¢ncias, surgem v√°rios problemas irritantes de incompatibilidade de dados preparados nos sistemas Linux e Windows. <br><br>  O erro descrito √© interessante, pois √© quase imposs√≠vel detectar com uma revis√£o de c√≥digo cl√°ssica.  Nem todos os desenvolvedores de projetos podem conhecer os meandros da macro, e esquec√™-los √© muito f√°cil.  Este √© um bom exemplo de an√°lise de c√≥digo est√°tica que complementa as an√°lises de c√≥digo e outras t√©cnicas de detec√ß√£o de erros. <br><br>  Substituir fun√ß√µes padr√£o √© uma m√° pr√°tica.  A prop√≥sito, recentemente no artigo ‚Äú <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">An√°lise de c√≥digo est√°tico do amor</a> ‚Äù, um caso semelhante foi considerado com a macro <i>#define sprintf std :: printf</i> . <br><br>  Uma solu√ß√£o melhor seria atribuir √† macro um nome exclusivo, por exemplo, <i>is_space_or_tab</i> .  Ent√£o a confus√£o seria imposs√≠vel. <br><br>  Talvez o motivo da cria√ß√£o da macro tenha sido a opera√ß√£o lenta da fun√ß√£o <i>isspace</i> padr√£o <i>,</i> e o programador criou uma vers√£o mais r√°pida, suficiente para resolver todas as tarefas necess√°rias.  Mas ainda assim, esta decis√£o est√° errada.  Seria mais <i>confi√°vel</i> definir o <i>isspace de</i> maneira a obter c√≥digo n√£o compilado.  E para implementar a funcionalidade necess√°ria em uma macro com um nome exclusivo. <br><br>  Obrigado pela aten√ß√£o.  Convidamos voc√™ a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">baixar</a> e experimentar o analisador PVS-Studio para testar seus projetos.  Al√©m disso, lembramos que recentemente o analisador adicionou suporte √† linguagem Java. <br><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img src="https://habrastorage.org/webt/ts/z9/km/tsz9kmyjtteajhd4x1au60rsrvq.png" align="left"></a> </p><br><br>  Se voc√™ deseja compartilhar este artigo com um p√∫blico que fala ingl√™s, use o link para a tradu√ß√£o: Andrey Karpov.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Quer jogar um detetive?</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Encontre o bug em uma fun√ß√£o do Midnight Commander</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt439374/">https://habr.com/ru/post/pt439374/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt439364/index.html">Os √≥culos Oculus Go com um conjunto de conte√∫do "morango" apareceram √† venda</a></li>
<li><a href="../pt439366/index.html">Automa√ß√£o de tr√™s pregos</a></li>
<li><a href="../pt439368/index.html">Anima√ß√µes em aplicativos iOS nascidos no servidor</a></li>
<li><a href="../pt439370/index.html">Anima√ß√µes fornecidas pelo servidor em aplicativos iOS</a></li>
<li><a href="../pt439372/index.html">Quer jogar um detetive? Encontre o bug em uma fun√ß√£o do Midnight Commander</a></li>
<li><a href="../pt439376/index.html">Clube de Interesse</a></li>
<li><a href="../pt439378/index.html">Livro (de ser?). Reflex√µes sobre a natureza da mente. Parte I</a></li>
<li><a href="../pt439380/index.html">Como criei uma extens√£o para o c√≥digo Atom e VS: experi√™ncia e fontes pessoais</a></li>
<li><a href="../pt439382/index.html">Usando Ansible, Terraform, Docker, Consul, Nomad nas nuvens (Alexey Vakhov, Uchi.ru)</a></li>
<li><a href="../pt439384/index.html">Modelagem Metr√≥pole</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>