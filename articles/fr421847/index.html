<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§µüèª üè∑Ô∏è üêù Sautez dans le cloud. Cr√©ation d'une solution IoT √©conomique sur NodeMCU + Azure IoT Hub üéë üôÖüèø üë®üèΩ‚Äçüè≠</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="La destination la plus populaire pour les appareils IoT est la collecte de t√©l√©m√©trie. √Ä ce jour, les prix des services IoT cloud ont tellement diminu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Sautez dans le cloud. Cr√©ation d'une solution IoT √©conomique sur NodeMCU + Azure IoT Hub</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/microsoft/blog/421847/"><p>  La destination la plus populaire pour les appareils IoT est la collecte de t√©l√©m√©trie.  √Ä ce jour, les prix des services IoT cloud ont tellement diminu√© que m√™me un utilisateur ordinaire ordinaire peut se permettre de les utiliser.  Aujourd'hui, nous allons parler de la fa√ßon d'envoyer des donn√©es vers le cloud √† partir de la carte NodeMCU en utilisant le langage Lua. </p><br><p><img src="https://habrastorage.org/webt/k3/f5/nx/k3f5nxom4hfjshqqwpgl43ppjwo.jpeg"><a name="habracut"></a></p><br><p>  <em>Remarque: nous continuons la s√©rie de publications de versions compl√®tes d'articles du magazine Hacker.</em>  <em>Orthographe et ponctuation de l'auteur enregistr√©es.</em> </p><br><p>  Je donne la parole √† l'auteur. </p><br><p>  √âtant donn√© que je travaille dans la pile technologique Microsoft, j'utilise Azure Functions et Table Storage pour cr√©er la partie cloud de la solution IoT, mais mon PoC pour NodeMCU et Lua peut √©galement √™tre utilis√© avec d'autres fournisseurs de solutions IoT dans le cloud. </p><br><h1>  INFO </h1><br><p>  Expressif NodeMCU est l'une des cartes m√®res les plus abordables avec Wi-Fi, micro USB et programmateur embarqu√©.  Il est bas√© sur le module ESP8266.  La carte de deuxi√®me g√©n√©ration peut √™tre achet√©e pour environ 6-7 $.  Vous pouvez travailler avec la carte de l'IDE Arduino.  De plus, le tableau prend en charge un langage de script appel√© Lua (traduit du portugais par ¬´Moon¬ª). </p><br><h2>  Connectez et configurez l'appareil </h2><br><p>  Pour que le p√©riph√©rique soit reconnu sous Windows, vous devez t√©l√©charger le pilote √† partir du lien suivant: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Pilotes VC2 USB vers UART Bridge CP210x</a> </p><br><p> La vitesse du port s√©rie NodeMCU standard est de 115'200bps.  Vous pouvez d√©finir une vitesse diff√©rente, lors de la premi√®re r√©initialisation de l'appareil, il reviendra √† 115200. <br>  Il est important que le pilote soit r√©gl√© exactement √† la m√™me vitesse: </p><br><p><img src="https://habrastorage.org/webt/ce/sq/y5/cesqy5kslu5pos-rrdqsxvch-vo.png"></p><br><h2>  Firmware </h2><br><p>  Tr√®s probablement, quelque chose sera manquant dans le firmware initial, donc id√©alement flasher l'appareil vous-m√™me.  Il existe plusieurs fa√ßons de cr√©er une image de micrologiciel.  √Ä l'aide d'un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">service cloud</a> , d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">une image Docker</a> ou √† l'aide d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">instructions pour Linux</a> .  J'ai collect√© en utilisant un service cloud.  Je vous conseille √©galement cette option. </p><br><p>  Si vous devez envoyer des donn√©es vers le cloud, les fonctionnalit√©s de s√©lection n√©cessaires sont SNTP, MQTT, HTTP (WiFi, minuterie, fichier, GPIO, net, n≈ìud, UART sont d√©j√† s√©lectionn√©s par d√©faut).  Il est √©galement n√©cessaire de marquer comme support TLS / SSL requis dans les options diverses <br>  Le lien avec le fichier bin vient √† l'e-mail.  Plus pr√©cis√©ment, m√™me 2 liens arrivent imm√©diatement.  L'une avec une image qui prend en charge les op√©rations en virgule flottante, et la seconde avec une image non compatible. </p><br><p>  Avant de flasher l'ESP8266, vous devez le mettre en mode sp√©cial.  Il y a un bouton FLASH s√©par√© sur la carte.  En appuyant dessus pendant la mise sous tension ou en appuyant sur reset, l'appareil passe en mode bootloader.  Si votre modification de carte n'a pas un tel bouton, alors avant de flasher, vous devez connecter GPIO0 √† GND et appuyer sur reset (cette m√©thode convient √† ESP-12). </p><br><p>  Le firmware peut √™tre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">flash√©</a> avec l'utilitaire <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PyFlasher</a> .  Py dans le nom signifie que l'application est √©crite en Python.  Il y a aussi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">nodemcu-flasher</a> , mais il n'a pas √©t√© mis √† jour depuis longtemps.  Je ne l'ai pas essay√©. </p><br><p>  La fen√™tre PyFlasher ressemble √† ceci: </p><br><p><img src="https://habrastorage.org/webt/1a/ns/rh/1ansrh_oc-zpqvaif8eujfvetvg.png"></p><br><p>  Le mode Flash est s√©lectionn√© en fonction de la carte que vous poss√©dez.  La plupart des cartes m√®res modernes bas√©es sur les modules ESP8266 ESP-12 et ESP32 utilisent le mode DIO.  ESP8266 01 √† 07 s'adapte au mode QIO plus rapide.  DOUT est utilis√© par ESP8285. </p><br><h2>  Configuration IDE </h2><br><p>  T√©l√©chargez l'IDE gratuit sur le lien <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ESPlorer</a> .  Il existe √©galement <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ZeroBrane Studio</a> .  J'ai surtout aim√© ESPlorer, je vais donc vous donner un exemple de travail avec.  ESPlorer est √©crit en JAVA.  L'interface d'application est </p><br><p><img src="https://habrastorage.org/webt/gi/lj/vs/giljvs_zxesytj7k52d_nlka_u8.png"></p><br><p>  Sur le c√¥t√© gauche se trouve le code, les param√®tres et d'autres fonctionnalit√©s similaires.  √Ä droite, la fen√™tre de surveillance et les commandes de gestion des p√©riph√©riques.  Ouvrez l'application, s√©lectionnez le port.  D√©finissez la vitesse √† laquelle l'√©change aura lieu (il s'agit tr√®s probablement de 115200) et cliquez sur Ouvrir. </p><br><p><img src="https://habrastorage.org/webt/1p/iq/xr/1piqxr933-f-nwkk6wagwtw42ea.png"></p><br><p>  Pour vous √©chauffer, vous pouvez ex√©cuter un script simple qui clignote avec une LED int√©gr√©e: </p><br><pre><code class="hljs powershell">LED = <span class="hljs-number"><span class="hljs-number">0</span></span> gpio.mode(LED, gpio.OUTPUT) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">flash_led</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gpio</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(LED, gpio.LOW)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tmr</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">delay</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(500000)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gpio</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(LED, gpio.HIGH)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tmr</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">alarm</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(1, 1000, tmr.ALARM_AUTO, flash_led)</span></span></span></span></code> </pre> <br><p>  Si votre carte n'a pas de LED int√©gr√©e (ou si vous en avez assez des exemples de LED clignotantes =), vous pouvez essayer d'ex√©cuter un script encore plus simple qui affiche la ligne: </p><br><pre> <code class="hljs swift"><span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Hello from Lua!"</span></span>)</code> </pre> <br><p>  Apr√®s avoir cr√©√© un fichier .lua (par exemple test.lua), y ajouter le code et l'enregistrer sur le disque, vous pouvez le t√©l√©charger sur votre appareil.  Pour ce faire, ouvrez le port s'il n'est pas ouvert (bouton Ouvrir) et cliquez sur le bouton T√©l√©charger.  Vous pouvez le trouver parmi les boutons situ√©s sous le code (√† gauche). </p><br><p>  Apr√®s avoir t√©l√©charg√© le fichier, vous pouvez l'ex√©cuter en envoyant la commande: </p><br><pre> <code class="hljs lisp">dofile(<span class="hljs-string"><span class="hljs-string">"test.lua"</span></span>)</code> </pre> <br><p>  La commande peut √™tre entr√©e manuellement dans le champ inf√©rieur situ√© √† droite sous le moniteur.  Ou si vous ne souhaitez pas saisir de texte, vous pouvez cliquer sur le bouton Recharger (la rang√©e de boutons extr√™me √† droite).  Apr√®s avoir cliqu√© sur ce bouton, vous recevrez une liste de boutons avec les fichiers .lua charg√©s sur la carte.  Cliquez sur le bouton avec le nom du fichier pour lancer l'ex√©cution du fichier. </p><br><p>  Si vous souhaitez que le fichier d√©marre imm√©diatement apr√®s avoir allum√© la carte, cr√©ez un fichier appel√© init.lua. </p><br><h2>  Configuration de la partie cloud pour travailler avec l'appareil </h2><br><p>  Laissons notre appareil pendant un certain temps et cr√©ons son double dans le cloud.  R√©cemment, un double d'appareil a pu √™tre cr√©√© directement sur le portail Azure, √† l'aide de la nouvelle fonctionnalit√©.  Dans le groupe de param√®tres du hub IoT appel√© Explorers, vous devez s√©lectionner les p√©riph√©riques IoT et cliquer sur "+ Ajouter" </p><br><p>  Pour connecter l'appareil au hub IoT, nous devons g√©n√©rer SAS (signature d'acc√®s partag√©).  Pour g√©n√©rer SAS, une double cl√© de p√©riph√©rique est utilis√©e, qui peut √™tre obtenue √† l'aide d'un utilitaire auxiliaire (Device Explorer, iothub-explorer, IoT Extension pour Azure CLI 2.0).  Mais le moyen le plus simple consiste √† obtenir la cl√© au m√™me endroit, sur le portail Azure, en acc√©dant au hub IoT -&gt; Appareils IoT. </p><br><p><img src="https://habrastorage.org/webt/gu/fn/jz/gufnjz89qukktzouxgsoauw01ww.png"></p><br><p>  SAS peut √™tre g√©n√©r√© sur l'appareil, ou il peut √™tre g√©n√©r√© √† l'aide de l'un de ses services en ligne.  Si vous utilisez le SDK, il peut g√©n√©rer automatiquement SAS pour vous (il suffit de sp√©cifier la double cl√© de l'appareil dans le code). </p><br><p><img src="https://habrastorage.org/webt/ob/gs/v1/obgsv1ag1bhj7rrcjejvonpvs3u.png"></p><br><p>  La fa√ßon dont un jeton SAS est g√©n√©r√© par un service Web pendant un certain temps limit√© est l√©g√®rement plus s√©curis√©e.  Bien qu'il y ait une certaine nuance.  Si vous envoyez uniquement le nom de l'appareil au service, quelqu'un peut rechercher parmi les noms pour obtenir le jeton d'un autre appareil.  Par cons√©quent, afin de rendre le processus un peu plus s√ªr, je propose cette solution: enregistrons le hachage Azure de la double cl√© de l'appareil sur l'appareil.  Et dans le code de service, avant de g√©n√©rer le SAS, nous v√©rifierons si le hachage correspond au hachage de la cl√© de p√©riph√©rique.  Ainsi, il sera possible d'obtenir SAS uniquement en connaissant le nom de l'appareil et le hachage de sa cl√©. </p><br><p>  La premi√®re fa√ßon dont SAS est g√©n√©r√© sur l'appareil est plus simple et plus pratique, mais l√©g√®rement moins s√©curis√©e.  Depuis, apr√®s avoir acc√©d√© √† l'appareil, un attaquant pourra obtenir une cl√© et g√©n√©rer lui-m√™me des appareils SAS.  Dans le second cas, ayant acc√©d√© √† l'appareil, le cracker ne pourra recevoir que des tokens SAS dont la dur√©e de vie est limit√©e. </p><br><p>  Il s'av√®re que les deux m√©thodes ne sont g√©n√©ralement pas id√©ales si le pirate a acc√®s √† l'appareil.  M√™me la s√©curisation d'une connexion √† l'aide d'un VPN n'aidera pas ici.  Dans ce cas, le canal de transmission sera prot√©g√©, mais ceux qui auront l'appareil entre leurs mains pourront acc√©der au canal.  Malheureusement, sur les appareils NodeMCU, Arduino, etc.  il n'y a aucun moyen de stocker les cl√©s / mots de passe dans un stockage s√©curis√©.  Peut-√™tre que le march√© des appareils IoT √† faible co√ªt n√©cessite de nouvelles fonctionnalit√©s mat√©rielles. </p><br><h2>  Cr√©ation d'une fonction Azure pour la g√©n√©ration SAS </h2><br><p>  En tant que service en ligne, il est plus facile d'utiliser les fonctionnalit√©s Azure.  Ce sont des extraits uniques qui peuvent √™tre √©crits imm√©diatement sur le portail Azure dans le navigateur.  Blague comme une blague, mais de cette fa√ßon, vous pouvez programmer m√™me √† partir d'un smartphone.  Bien s√ªr, personne n'interdit de les cr√©er et de les d√©boguer √† partir de Visual Studio, puis de les publier sur Azure sous forme compil√©e. </p><br><p>  La fonction de la fonction est d'effectuer une op√©ration g√©n√©ralement peu compliqu√©e.  Selon l‚Äôid√©e du microservice, chaque fonction peut faire une chose, mais c‚Äôest tr√®s bien (principe de responsabilit√© unique). </p><br><p>  Vous pouvez cr√©er une application Azure Function sur le portail en remplissant un court formulaire </p><br><p><img src="https://habrastorage.org/webt/hd/ec/cu/hdeccuzb_kfv3cz7ggi1x5cnwe4.png"></p><br><p>  Le plan de consommation vous permet de payer uniquement pour les appels de fonction qui ont √©t√© valid√©s.  C'est l'option la moins ch√®re.  Actuellement, un million d'appels de fonctionnalit√©s sont gratuits. </p><br><p>  Notez qu'avec la cr√©ation de la fonction, un stockage de donn√©es auxiliaire (stockage) est √©galement cr√©√©. </p><br><p>  Apr√®s avoir cr√©√© l'application de fonction, vous pouvez cr√©er la fonction elle-m√™me.  Dans ce cas, nous avons besoin d'une fonction comme Webhook + API.  La fonction peut √™tre ouverte √† tout le monde (acc√®s anonyme), et peut √™tre accessible uniquement aux propri√©taires d'un code sp√©cial.  Le code peut √™tre obtenu √† partir de la fen√™tre avec la fonction en cliquant sur le lien &lt;/&gt; URL de la fonction Get: </p><br><p><img src="https://habrastorage.org/webt/fl/mi/4w/flmi4wk8td66jpkudkozeqaec_o.png"></p><br><p>  Les fonctions peuvent √™tre √©crites dans diff√©rentes langues.  Je pr√©f√®re C #. </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Net; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.Azure.Devices; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.Azure.Devices.Common.<span class="hljs-keyword"><span class="hljs-keyword">Security</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Globalization; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Security</span></span>.Cryptography; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Text; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static async Task&lt;HttpResponseMessage&gt; Run(HttpRequestMessage req, TraceWriter <span class="hljs-keyword"><span class="hljs-keyword">log</span></span>) { string deviceid = req.GetQueryNameValuePairs() .FirstOrDefault(q =&gt; string.Compare(q.Key, "deviceid", <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, CultureInfo.InvariantCulture) == <span class="hljs-number"><span class="hljs-number">0</span></span>).<span class="hljs-keyword"><span class="hljs-keyword">Value</span></span>; string hash = req.GetQueryNameValuePairs() .FirstOrDefault(q =&gt; string.Compare(q.Key, "hash", <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, CultureInfo.InvariantCulture) == <span class="hljs-number"><span class="hljs-number">0</span></span>).<span class="hljs-keyword"><span class="hljs-keyword">Value</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (String.IsNullOrEmpty(deviceid)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> req.CreateResponse(HttpStatusCode.BadRequest, "device id missing"); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (String.IsNullOrEmpty(hash)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> req.CreateResponse(HttpStatusCode.BadRequest, "hash missing"); var resourceUri ="ArduinoDemoHub.azure-devices.net/devices/"+deviceid; // taken <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> IoT Hub <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Connect</span></span> devices rights (<span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> Device Explorer) var connectionString = "HostName=ArduinoDemoHub.azure-devices.net;SharedAccessKeyName=iothubowner;SharedAccessKey=cuYBKc42lfJr4oSRGQGQ8IiKWxGQkLre7rprZDZ/ths="; var registryManager = RegistryManager.CreateFromConnectionString(connectionString); var device = await registryManager.GetDeviceAsync(deviceid); var key = device.Authentication.SymmetricKey.PrimaryKey; HMACSHA256 hmac = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> HMACSHA256(<span class="hljs-keyword"><span class="hljs-keyword">Encoding</span></span>.UTF8.GetBytes("somerandomkeyKJBWyfy4gski")); var hashedkey = Convert.ToBase64String(hmac.ComputeHash(<span class="hljs-keyword"><span class="hljs-keyword">Encoding</span></span>.UTF8.GetBytes(key))); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (hashedkey!=hash) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> req.CreateResponse(HttpStatusCode.BadRequest, "wrong hash"); SharedAccessSignatureBuilder sasBuilder = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SharedAccessSignatureBuilder() { Key = key, Target = resourceUri, TimeToLive = TimeSpan.FromDays(Convert.ToDouble(<span class="hljs-number"><span class="hljs-number">7</span></span>)) }; var SAS = sasBuilder.ToSignature(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> req.CreateResponse(HttpStatusCode.OK, SAS); }</code> </pre> <br><p>  Nous cr√©ons le fichier project.json et y ajoutons le contenu suivant: </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"frameworks"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"net46"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"dependencies"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"Microsoft.Azure.Devices"</span></span>: <span class="hljs-string"><span class="hljs-string">"1.4.1"</span></span> } } } }</code> </pre> <br><p>  Le code utilise la cha√Æne de connexion au concentrateur IoT.  Il peut √™tre confondu avec la cha√Æne de connexion √† l'appareil.  Pour que vous ne soyez pas confus, permettez-moi de vous rappeler o√π l'obtenir: </p><br><p><img src="https://habrastorage.org/webt/7v/i9/jd/7vi9jdnq12-lsf2gwv82pbbhge0.png"></p><br><p>  Il est n√©cessaire de prendre la cha√Æne de connexion d'une politique avec les droits de connexion de l'appareil. <br>  Il est pr√©f√©rable de ne pas sp√©cifier la cha√Æne de connexion elle-m√™me dans le code, comme je l'ai fait.  Je l'ai fait uniquement √† titre d'exemple.  Il est pr√©f√©rable d'acc√©der √† la fonction Param√®tres d'application. </p><br><p><img src="https://habrastorage.org/webt/u2/e_/uc/u2e_uchy0i1np_d6ikqjpbtpflw.png"></p><br><p>  Et sp√©cifiez la cha√Æne de connexion ici.  Apr√®s cela, vous pouvez "l'obtenir" de la boutique s√©curis√©e en utilisant </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">ConfigurationManager</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ConnectionStrings</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">["___"]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ConnectionString</span></span></code> </pre> <br><p>  Sur l'appareil, nous devons enregistrer la cl√© de hachage.  Mais vous devez d'abord encoder les personnages.  HttpUtility.UrlEncode de l'espace System.Web nous aidera avec cela. </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">hashedkey</span></span> = HttpUtility.UrlEncode(hashedkey);</code> </pre> <br><p>  Nous enverrons la demande √† l'aide de Get, mais tous les caract√®res ne peuvent pas √™tre transmis comme valeur de param√®tre. </p><br><h2>  √âcrire du code pour envoyer des donn√©es vers le cloud </h2><br><p>  J'ai √©crit un petit code sur l'envoi de donn√©es par Lua dans le cloud.  Le r√©sultat a √©t√© une sorte de PoC.  Vous pouvez l'utiliser et le modifier selon vos besoins. <br>  Cr√©ez 2 fichiers init.lua et SendDataToCloud.lua <br>  Le contenu du premier: </p><br><pre> <code class="hljs php">--    <span class="hljs-keyword"><span class="hljs-keyword">print</span></span>(<span class="hljs-string"><span class="hljs-string">'init.lua ver 1.2'</span></span>) wifi.setmode(wifi.STATION) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span>(<span class="hljs-string"><span class="hljs-string">'set mode=STATION (mode='</span></span>..wifi.getmode()..<span class="hljs-string"><span class="hljs-string">')'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span>(<span class="hljs-string"><span class="hljs-string">'MAC: '</span></span>..wifi.sta.getmac()) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span>(<span class="hljs-string"><span class="hljs-string">'chip: '</span></span>..node.chipid()) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span>(<span class="hljs-string"><span class="hljs-string">'heap: '</span></span>..node.heap()) --  Wifi station_cfg={} station_cfg.ssid=<span class="hljs-string"><span class="hljs-string">"_SSID"</span></span> station_cfg.pwd=<span class="hljs-string"><span class="hljs-string">"___"</span></span> station_cfg.save=<span class="hljs-keyword"><span class="hljs-keyword">false</span></span> wifi.sta.config(station_cfg) wifi_status_codes = { [<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-string"><span class="hljs-string">"Idle"</span></span>, [<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-string"><span class="hljs-string">"Connecting"</span></span>, [<span class="hljs-number"><span class="hljs-number">2</span></span>] = <span class="hljs-string"><span class="hljs-string">"Wrong Password"</span></span>, [<span class="hljs-number"><span class="hljs-number">3</span></span>] = <span class="hljs-string"><span class="hljs-string">"No AP Found"</span></span>, [<span class="hljs-number"><span class="hljs-number">4</span></span>] = <span class="hljs-string"><span class="hljs-string">"Connection Failed"</span></span>, [<span class="hljs-number"><span class="hljs-number">5</span></span>] = <span class="hljs-string"><span class="hljs-string">"Got IP"</span></span> } sntp_connect_status_codes = { [<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-string"><span class="hljs-string">"DNS lookup failed"</span></span>, [<span class="hljs-number"><span class="hljs-number">2</span></span>] = <span class="hljs-string"><span class="hljs-string">"Memory allocation failure"</span></span>, [<span class="hljs-number"><span class="hljs-number">3</span></span>] = <span class="hljs-string"><span class="hljs-string">"UDP send failed"</span></span>, [<span class="hljs-number"><span class="hljs-number">4</span></span>] = <span class="hljs-string"><span class="hljs-string">"Timeout, no NTP response received"</span></span> } --    Wi-fi (   ) tmr.alarm(<span class="hljs-number"><span class="hljs-number">6</span></span>,<span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">wifi</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sta</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getip</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">==</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nil</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">then</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"Waiting for IP address! (Status: "</span></span></span></span><span class="hljs-function"><span class="hljs-params">..wifi_status_codes[wifi.sta.status</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">()</span></span></span></span><span class="hljs-function"><span class="hljs-params">]..</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">")"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">else</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"New IP address is "</span></span></span></span><span class="hljs-function"><span class="hljs-params">..wifi.sta.getip</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">()</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tmr</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">6</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> --    </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NTP</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sntp</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sync</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">({</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'pool.ntp.org'</span></span></span></span><span class="hljs-function"><span class="hljs-params">}, function</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(sec, usec, server)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> print</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(</span></span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-string">"Clock Synced: "</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">..sec..</span></span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-string">", "</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">..usec..</span></span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-string">", "</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">..server)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> tls.cert.verify</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(false)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> --    dofile</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(</span></span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-string">'SendDataToCloud.lua'</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> end, function</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(error_code)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> print</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(</span></span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-string">"Clock Sync Failed: "</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">..sntp_connect_status_codes[error_code])</span></span></span></span><span class="hljs-function"><span class="hljs-params"> end, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params"> --      )</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> )</span></span></code> </pre> <br><p>  Ce fichier se connecte au r√©seau et ex√©cute le code du fichier SendDataToCloud.lua si la connexion r√©ussit. </p><br><p>  Vous devez sp√©cifier les donn√©es de votre point d'acc√®s Wi-Fi comme valeurs pour station_cfg.ssid et station_cfg.pwd. </p><br><p>  Dans le fichier suivant, vous devez modifier le nom de l'appareil et l'IoT du concentrateur (variables DEVICE et IOTHUB).  La variable funcurl contient l'adresse de la fonction g√©n√©ratrice SAS et le hachage de la cl√© de p√©riph√©rique (que nous avons pr√©c√©demment cod√© √† l'aide de HttpUtility.UrlEncode) comme valeur du param√®tre de hachage </p><br><pre> <code class="hljs powershell">--  DEVICE = <span class="hljs-string"><span class="hljs-string">"LuaDevice"</span></span> IOTHUB = <span class="hljs-string"><span class="hljs-string">"ArduinoDemoHub.azure-devices.net"</span></span> PORT = <span class="hljs-number"><span class="hljs-number">8883</span></span> USER = <span class="hljs-string"><span class="hljs-string">"ArduinoDemoHub.azure-devices.net/"</span></span>..DEVICE..<span class="hljs-string"><span class="hljs-string">"/api-version=2016-11-14"</span></span> telemetry_topic=<span class="hljs-string"><span class="hljs-string">"devices/"</span></span>..DEVICE..<span class="hljs-string"><span class="hljs-string">"/messages/events/"</span></span> connected = false local headers = <span class="hljs-string"><span class="hljs-string">'Content-Type: application/x-www-form-urlencoded\r\n'</span></span>.. <span class="hljs-string"><span class="hljs-string">'Accept: */*\r\n'</span></span>.. <span class="hljs-string"><span class="hljs-string">'User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:47.0) Gecko/20100101 Firefox/47.0'</span></span> funcurl = <span class="hljs-string"><span class="hljs-string">"https://arduinofunction.azurewebsites.net/api/GenerateSASFunction?code=Jn7j54PbR31BSRa0UZrDwp4ZEltjmWHmblG9zLo0Ne0tyGM7w/wQ7w=="</span></span> funcurl = funcurl..<span class="hljs-string"><span class="hljs-string">"&amp;hash=oJzykimyQsTPtzgJxYq90Xfqmw1rZTPTCH%2bJ5sSurKI%3d"</span></span> funcurl = funcurl..<span class="hljs-string"><span class="hljs-string">"&amp;deviceid="</span></span>..DEVICE tmr.alarm(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">5000</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, function() http.get(funcurl, headers, function(code, <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>, header) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (code &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) then print(<span class="hljs-string"><span class="hljs-string">"HTTP request failed"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> sas = true print(code, <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> string.match(<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>, <span class="hljs-string"><span class="hljs-string">"Shared"</span></span>) then tmr.stop(<span class="hljs-number"><span class="hljs-number">1</span></span>) SAS = string.sub(<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,string.len(<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>)<span class="hljs-literal"><span class="hljs-literal">-1</span></span>) print(SAS) connect(SAS) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connect</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SAS)</span></span></span><span class="hljs-function"> --   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MQTT</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">client</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mqtt</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Client</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DEVICE, 240, USER, SAS)</span></span></span><span class="hljs-function"> --   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IoTHub</span></span></span><span class="hljs-function">    </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MQTT</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">("Connecting to MQTT broker. Please wait...")</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tmr</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">alarm</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(2,1000, 1, function()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">client</span></span></span><span class="hljs-function">:</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connect</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(IOTHUB, PORT, 1, -- Callback     function(client)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tmr</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(2)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">("Connected to MQTT: "..IOTHUB..":"..PORT.." as "..DEVICE)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connected</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">true</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">senddata</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function">, -- </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Callback</span></span></span><span class="hljs-function">    </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(client, reason)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">("Error Connecting: "..reason)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> ) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">senddata</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">math</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">randomseed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(1)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tmr</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">alarm</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(3, 1000, tmr.ALARM_AUTO, publish_data)</span></span></span><span class="hljs-function"> --   ,     </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">callback</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">client</span></span></span><span class="hljs-function">:</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">("offline", function(client)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">("MQTT Disconnected.")</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connected</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">false</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> --      </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">publish_data</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connected</span></span></span><span class="hljs-function"> == </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">true</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">then</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">somedata</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">math</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">random</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(1,100)</span></span></span><span class="hljs-function"> --     </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">payload</span></span></span><span class="hljs-function"> = "</span></span>{ \<span class="hljs-string"><span class="hljs-string">"deviceId\"</span></span> : \<span class="hljs-string"><span class="hljs-string">""</span></span>..DEVICE..<span class="hljs-string"><span class="hljs-string">"\"</span></span>,<span class="hljs-string"><span class="hljs-string">".. "</span></span>\<span class="hljs-string"><span class="hljs-string">"iotdata\"</span></span> :<span class="hljs-string"><span class="hljs-string">"..somedata.."</span></span>}<span class="hljs-string"><span class="hljs-string">" --   client:publish(telemetry_topic, payload, 1, 0, function(client) print("</span></span><span class="hljs-keyword"><span class="hljs-keyword">Data</span></span> published successfully.<span class="hljs-string"><span class="hljs-string">") end) end end</span></span></code> </pre> <br><p>  Les donn√©es sont envoy√©es sans utiliser le SDK Azure, vous pouvez donc utiliser ce code non seulement pour envoyer des donn√©es √† Azure.  Il existe de nombreuses alternatives: AWS, Google Cloud IoT, IBM Watson IoT Platform. </p><br><p>  L'exemple utilise le protocole MQTT (Message Queuing Telemetry Transport).  Il s'agit d'un protocole ouvert con√ßu sp√©cifiquement pour les appareils IoT.  Les donn√©es sont envoy√©es au format JSON.  Lorsque dans des projets r√©els, les donn√©es proviennent de capteurs, un nombre al√©atoire est g√©n√©r√© dans l'exemple. </p><br><p>  Au cours du processus d'√©tablissement de liaison entre l'appareil et le hub IoT, le serveur peut envoyer son certificat ou demander un certificat d'appareil.  Si vous vous souvenez, la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">derni√®re fois que nous avons</a> travaill√© avec le p√©riph√©rique Arduino, nous l'avons flash√© avec un certificat.  Maintenant, un r√©cepteur de code suffit: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">tls</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.cert</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.verify</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">false</span></span>)</code> </pre> <br><p>  Nous sommes limit√©s au certificat que le serveur nous enverra. </p><br><h2>  INFO </h2><br><p>  Vous pouvez √™tre int√©ress√© par le contenu des certificats de votre concentrateur √† l'aide de la commande OpenSSL suivante. </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">openssl</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">s_client</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-showcerts</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-connect</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ArduinoDemoHub</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.azure-devices</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.net</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:8883</span></span></code> </pre> <br><p>  Pour pr√©parer le mat√©riel, les laboratoires ont √©t√© utilis√©s, qui sont disponibles sur le lien: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Envoi de messages Device-to-Cloud (D2C)</a> <br>  Le code n'est pas tout √† fait √† jour et j'ai d√ª le mettre √† jour un peu, mais en g√©n√©ral, le lien peut √™tre utile. </p><br><h2>  Travailler avec NodeMCU depuis Arduino IDE </h2><br><p>  Je ne peux pas ignorer le sujet de l'utilisation du SDK.  Votre solution est bonne, mais le SDK est le m√™me code qui est d√©j√† d√©bogu√©, simplifi√© et pr√™t √† l'emploi.  Quelques mots sur la fa√ßon de configurer et d'utiliser l'IDE Arduino pour travailler avec NodeMCU. </p><br><p>  Apr√®s avoir install√© l'IDE Arduino, vous devez aller dans le menu Fichier - Pr√©f√©rences </p><br><p><img src="https://habrastorage.org/webt/ea/u_/fq/eau_fqwxsvtujmn50otjftkgwvi.png"></p><br><p>  Et ajoutez un lien vers le gestionnaire de cartes suppl√©mentaires - entrez dans le champ URL du gestionnaire de cartes suppl√©mentaires l'adresse: <a href="">http://arduino.esp8266.com/versions/2.4.0/package_esp8266com_index.json</a> </p><br><p>  Ensuite, allez dans le menu Tools - Board xxx - Boardx Manager et installez ESP8266 <br>  Installez les biblioth√®ques AzureIoTHub, AzureIoTUtility, AzureIoTProtocol_MQTT.  Apr√®s avoir install√© la derni√®re biblioth√®que dans les exemples (menu Fichier - Exemples - AzureIoTProtocol_MQTT), vous pouvez trouver un exemple simplesample_mqtt pour ESP8266. </p><br><p>  L'exemple est pr√™t √† l'emploi.  Remplissez simplement les valeurs des variables dans le fichier iot_configs.h <br>  Je mentionne un petit inconv√©nient.  La compilation du projet et son t√©l√©chargement sur la carte, par rapport √† Lua, prennent un temps assez long. </p><br><h2>  Enregistrement de donn√©es dans le cloud Azure </h2><br><p>  Avec l'envoi de donn√©es, tout est clair, mais combien peu co√ªteux d'enregistrer des donn√©es dans le cloud. <br>  Azure Functions est le moyen le moins cher d'envoyer des donn√©es du hub IoT √† la base de donn√©es.  Et le stockage de donn√©es le moins cher est Azure Table Storage. </p><br><p>  Fait int√©ressant, lorsque vous cr√©ez une application de fonction, le stockage est √©galement cr√©√© automatiquement, dont la fonction elle-m√™me a besoin pour fonctionner.  Si vous cr√©ez un r√©f√©rentiel s√©par√©, il est conseill√© de d√©finir les param√®tres de base comme ceci: </p><br><p><img src="https://habrastorage.org/webt/zg/va/sz/zgvaszlilbyzjh6srxdmrq3cjyi.png"></p><br><p>  La r√©plication LSR est actuellement l'option la moins ch√®re.  Il est s√©lectionn√© lors de la cr√©ation automatique d'un r√©f√©rentiel li√© √† une fonction. <br>  Ce dont nous avons besoin maintenant, c'est de recevoir les donn√©es du hub IoT et de les √©crire dans le stockage.  Dans ce cas, lors de la cr√©ation d'une fonction, la fen√™tre Quick Start ne pourra pas nous proposer l'option souhait√©e. </p><br><p><img src="https://habrastorage.org/webt/x5/vw/6i/x5vw6ia4ubsfidgvpqmlrretqru.png"></p><br><p>  Par cons√©quent, cliquez sur le lien Fonction personnalis√©e situ√© en bas et s√©lectionnez l'option IoT Hub (Event Hub). <br>  Cette fen√™tre s'ouvrira pour nous: </p><br><p><img src="https://habrastorage.org/webt/gu/t6/ry/gut6ryx8peg_aq2mqfv0dr62agk.jpeg"></p><br><p>  Dans lequel nous pouvons remplir le champ de connexion Event Hub avec un choix simple (en cliquant sur nouveau).  Mais pour indiquer le nom du concentrateur d'√©v√©nements, vous devez acc√©der au concentrateur IoT.  Dans le concentrateur, vous devez acc√©der aux points de terminaison (points de terminaison) et obtenir le nom compatible avec Event Hub √† partir de l√† </p><br><p><img src="https://habrastorage.org/webt/dl/tk/lb/dltklbv7hubhxdhe07nioe7ckgu.png"></p><br><p>  Passons au code de fonction.  L'extrait de code suivant re√ßoit des donn√©es du hub IoT et les stocke dans le stockage de table: </p><br><pre> <code class="hljs lua">#r <span class="hljs-string"><span class="hljs-string">"Microsoft.WindowsAzure.Storage"</span></span> #r <span class="hljs-string"><span class="hljs-string">"Newtonsoft.Json"</span></span> using Microsoft.Azure; // Namespace <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> CloudConfigurationManager using Microsoft.WindowsAzure.Storage; // Namespace <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> CloudStorageAccount using Microsoft.WindowsAzure.Storage.Table; // Namespace <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Table storage types using Newtonsoft.Json; public static void Run(<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> myIoTHubMessage, TraceWriter <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>) { var e = JsonConvert.DeserializeObject&lt;EventDataEntity&gt;(myIoTHubMessage); <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>.Info($<span class="hljs-string"><span class="hljs-string">"C# IoT Hub trigger function processed a message: {myIoTHubMessage}"</span></span>); CloudStorageAccount storageAccount = CloudStorageAccount.Parse (<span class="hljs-string"><span class="hljs-string">"DefaultEndpointsProtocol=https;AccountName=iotdatademostorage;AccountKey=JgStNcJvlQYeNsVCmpkHQUkWlZiQ7tJwAm6OCL34+lGx3XrR+0CPiY9RoxIDA6VSvMKlOEUrVWL+KWP0qLMLrw==;EndpointSuffix=core.windows.net"</span></span>); CloudTableClient tableClient = storageAccount.CreateCloudTableClient(); CloudTable <span class="hljs-built_in"><span class="hljs-built_in">table</span></span> = tableClient.GetTableReference(<span class="hljs-string"><span class="hljs-string">"iottable"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">table</span></span>.CreateIfNotExists(); EventDataEntity edata = new EventDataEntity(<span class="hljs-string"><span class="hljs-string">"IOTpartition"</span></span>, Guid.NewGuid().ToString()); edata.DeviceId = e.DeviceId; edata.IotData = e.IotData; TableOperation insertOperation = TableOperation.Insert(edata); <span class="hljs-built_in"><span class="hljs-built_in">table</span></span>.Execute(insertOperation); } public class EventDataEntity : TableEntity { public EventDataEntity(<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> pkey, <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> rkey) { this.PartitionKey = pkey; this.RowKey = rkey; } public EventDataEntity() { } public <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> DeviceId { get; set; } public int IotData { get; set; } }</code> </pre> <br><p>  Si vous utilisez ce code dans un projet r√©el, n'oubliez pas de placer la cha√Æne de connexion dans un endroit plus s√ªr - dans les param√®tres de l'application (exactement la m√™me que la cha√Æne de connexion de la premi√®re fonction). </p><br><p>  La cha√Æne de connexion elle-m√™me peut √™tre prise dans l'√©l√©ment de param√®tres appel√© Cl√©s d'acc√®s: </p><br><p><img src="https://habrastorage.org/webt/ot/z9/pb/otz9pbjqyflhjivwztvvsmkjms4.png"></p><br><p>  Afficher le contenu du tableau avec l'utilitaire gratuit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Azure Storage Explorer</a> </p><br><p>  √âtant donn√© que le co√ªt d'Azure Table Storage est assez faible et que les fonctions Azure et le hub IoT offrent gratuitement certaines ressources mensuellement, le co√ªt de la solution compl√®te par mois peut √™tre inf√©rieur √† 1 $.  Bien s√ªr, cela d√©pend de la quantit√© de donn√©es.  Comptez pour vous.  Aujourd'hui, 1 Go de donn√©es co√ªte 7 cents par mois et pour chaque million de transactions, vous ne serez factur√© que 4 cents. </p><br><h2>  INFO </h2><br><p>  Lorsque vous utilisez des services cloud de n'importe quel fournisseur, je vous conseille toujours de lier une carte de cr√©dit avec le montant minimum √† votre compte.  C'est tout √† fait par hasard qu'en choisissant une sorte de param√®tre erron√©, vous payez beaucoup plus que vous ne le pensez. </p><br><p>  Nous vous rappelons qu'il s'agit de la version compl√®te d'un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article du magazine Hacker</a> .  Son auteur est <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Alexey Sommer</a> . </p><br><h2>  Mat√©riaux utiles </h2><br><h4>  Guide d'architecture d'application cloud </h4><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img width="200" align="left" src="https://habrastorage.org/webt/zk/ns/pq/zknspqark8ose3vto4iom_kbdaq.jpeg"></a>  Adoptez une approche structur√©e pour d√©velopper des applications cloud.  Cet e-book de 300 pages sur l'architecture de cloud computing d√©crit l'architecture, le d√©veloppement et les directives de mise en ≈ìuvre qui s'appliquent quelle que soit la plateforme cloud que vous choisissez.  Ce guide comprend des √©tapes pour: </p><br><ul><li>  Choisir le bon style d'architecture d'application cloud pour votre application ou solution; </li><li>  s√©lection de technologies informatiques et de stockage de donn√©es appropri√©es; </li><li>  mettre en ≈ìuvre 10 principes de d√©veloppement pour cr√©er une application √©volutive, r√©siliente et g√©rable; </li><li>  suivre les cinq principes de cr√©ation d'un logiciel de qualit√© garantissant le succ√®s de votre application cloud; </li><li>  Utiliser des mod√®les de conception con√ßus pour le probl√®me que vous essayez de r√©soudre. </li></ul><br><p>  ‚Üí <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><b>T√©l√©charger</b></a> </p><br><h4>  Guide du d√©veloppeur Azure </h4><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img width="200" align="right" src="https://habrastorage.org/webt/ik/2g/ot/ik2gotwyadnbqcjeusitbjdk550.png"></a> </p><br><p>  Dans cette mise √† jour du Guide du d√©veloppeur Azure, vous verrez comment l'ensemble complet de services pour la plate-forme logicielle Azure r√©pond √† vos besoins.  Vous trouverez ici des informations sur les approches architecturales et les situations les plus courantes qui se produisent lors de la cr√©ation d'applications cloud. </p><br><p>  ‚Üí <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><b>T√©l√©charger</b></a> </p><br><h4>  Bases de Microsoft Azure </h4><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img width="200" align="left" src="https://habrastorage.org/webt/w1/pe/sj/w1pesji9lrslkdggsjzwdkya2la.png"></a>  Ce livre fournit des informations importantes sur les services Azure cl√©s pour les d√©veloppeurs et les professionnels de l'informatique qui d√©couvrent le cloud computing.  Des d√©mos √©tape par √©tape sont incluses pour aider le lecteur √† comprendre comment d√©marrer avec chacun des services cl√©s.  Chaque chapitre est ind√©pendant, il n'est pas n√©cessaire d'effectuer des d√©monstrations pratiques des chapitres pr√©c√©dents pour comprendre un chapitre en particulier. </p><br><p>  Les sujets suivants sont trait√©s dans ce livre: </p><br><ul><li>  Premiers pas avec Azure; </li><li>  Azure Application Service et applications Web; </li><li>  Machines virtuelles; </li><li>  Service de stockage; </li><li>  Bases de donn√©es </li><li>  Services Azure suppl√©mentaires. </li></ul><br><p>  ‚Üí <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><b>T√©l√©charger</b></a> </p><br><h2>  Liens utiles </h2><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Documentation en russe pour IoT Hub</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Exemples Azure IoT pour Csharp (.NET)</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr421847/">https://habr.com/ru/post/fr421847/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr421835/index.html">La Commission interinstitutions d√©veloppe une nouvelle technologie pour bloquer Telegram</a></li>
<li><a href="../fr421837/index.html">Cr√©er 1k d'intro Chaos pour ZX-Spectrum</a></li>
<li><a href="../fr421839/index.html">Programmation Java fonctionnelle avec Vavr</a></li>
<li><a href="../fr421841/index.html">Robotaxi Waymo n'est pas tout √† fait pr√™t pour l'acc√®s aux voies publiques</a></li>
<li><a href="../fr421845/index.html">Que font r√©ellement les analystes de donn√©es? R√©sultats de 35 entretiens</a></li>
<li><a href="../fr421849/index.html">Ev√©nements RH en TI en septembre 2018: My Circle Digest</a></li>
<li><a href="../fr421851/index.html">Probl√®mes de hibou et de globe: connexion de deux assemblys avec des espaces de noms et des noms de classe identiques</a></li>
<li><a href="../fr421855/index.html">Projecteurs √† domicile: les meilleurs ¬´selon la version¬ª, mise au point ultra courte, champions de la luminosit√© et de la vitesse</a></li>
<li><a href="../fr421857/index.html">ToFoIn v 1. R√©servation de passerelles et commutation entre canaux externes dans FreeBSD</a></li>
<li><a href="../fr421859/index.html">Notes du fournisseur IoT. Appareils et surench√©rir</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>