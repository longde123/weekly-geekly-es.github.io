<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíï üë©üèæ‚Äç‚öïÔ∏è üßïüèº Controlador dom√©stico inteligente Arduino Mega 2560 de c√≥digo abierto con soporte para MQTT, DMX-512, 1-Wire, Modbus y Openhab üö≥ üôåüèº üî©</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hoy decid√≠ presentar al p√∫blico un proyecto en el que hab√≠a estado trabajando durante los √∫ltimos a√±os: LightHub . Lo que result√≥ al final puede llama...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Controlador dom√©stico inteligente Arduino Mega 2560 de c√≥digo abierto con soporte para MQTT, DMX-512, 1-Wire, Modbus y Openhab</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/407975/"><img src="https://habrastorage.org/webt/bn/nt/mx/bnntmx1wnvytzqt3cgoxigc2mvu.jpeg" width="400" hspace="1" vspace="1" align="right">  Hoy decid√≠ presentar al p√∫blico un proyecto en el que hab√≠a estado trabajando durante los √∫ltimos a√±os: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">LightHub</a> .  Lo que result√≥ al final puede llamarse quiz√°s la soluci√≥n m√°s barata para crear una casa inteligente, que, sin embargo, puede: <br><br><ul><li>  Controle la iluminaci√≥n y los dispositivos de alimentaci√≥n (rel√©s, reguladores DMX-512 y Modbus RTU) </li><li>  Gestione la calefacci√≥n por suelo radiante (se utilizan como sensores de temperatura una docena y media de DS18B20 diluidos alrededor del apartamento como sensores de temperatura) </li><li>  Operar v√°lvulas de ventilaci√≥n / aire acondicionado </li><li>  Gestionar un sistema de ventilaci√≥n improvisado. </li><li>  Muchas cosas en las que no pens√© inicialmente, simplemente porque el controlador result√≥ ser completamente abierto, configurable de manera flexible y complementaba perfectamente las soluciones OpenSource Openhab + Mosquitto + NodeRed </li></ul><br>  Los interruptores convencionales, botones, sensores de contacto, sensores de fugas, etc., que pueden controlar tanto las cargas locales como los dispositivos conectados a otros mismos controladores o a todo lo que comprende el protocolo MQTT, est√°n conectados a la entrada del controlador.  Por ejemplo, tengo un interruptor de l√°minas instalado en la caja de la puerta delantera.  Cuando cierro la cerradura tres vueltas, las luces se apagan, calefacci√≥n por suelo radiante, calderas, receptor de AV.  Cuando regreso, el estado de estos dispositivos se restaura como estaba antes de salir. <br><br>  En la salida, por ejemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">tales m√≥dulos de rel√©</a> , DMX, perif√©ricos Modbus. <br><br>  Los controladores se configuran utilizando archivos JSON, que se cargan a trav√©s de http al inicio del controlador (adem√°s, la configuraci√≥n se puede guardar en NVRAM a trav√©s de la CLI de serie).  Y, por supuesto, todo esto est√° controlado por el sistema Openhab 2, a trav√©s de una aplicaci√≥n m√≥vil normal. <br>  Las tareas de "peque√±a automatizaci√≥n" se resuelven tanto con la ayuda de las reglas regulares de openhab (no muy conveniente) como con la ayuda de NodeRed.  (Con respecto a NodeRed, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠ hay un art√≠culo</a> que describe perfectamente un ejemplo de automatizaci√≥n). <br><br>  Las fuentes, junto con ejemplos de configuraciones, se publican en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">GIThub</a> , un poco de la descripci√≥n se publica en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">el sitio web del proyecto.</a>  En consecuencia, una historia m√°s completa debajo del corte. <br><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">ACTUALIZACI√ìN: Han pasado seis meses desde la publicaci√≥n, y as√≠ es como se ve el prototipo industrial del dispositivo durante la instalaci√≥n en un armario el√©ctrico.</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/e2/yw/lg/e2ywlg3lx4xk7ln3vlpk4omjuik.jpeg"><br>  La placa Arduino DUE est√° instalada en la placa base. <br><img src="https://habrastorage.org/webt/zq/k4/52/zqk452ibyvxpxo9mga5p-ne7yvm.jpeg"><br>  Se retira la placa, aislamiento √≥ptico visible, protecci√≥n de entrada, DMX, Modbus, controladores de 1 cable, un potente conjunto de transistores (por ejemplo) para controlar el rel√©. <br><img src="https://habrastorage.org/webt/mw/rb/nb/mwrbnbepfer6az_kb8p_gxqrcum.jpeg"><br>  Y as√≠ es como se ve el controlador en un riel DIN (se quita la cubierta), junto a un bloque de rel√© t√≠pico.  (Como escrib√≠, deliberadamente no pongo elementos de potencia dentro de la caja del controlador) <br></div></div><br>  Todo comenz√≥ con reparaciones en el departamento, durante las cuales decid√≠ hacer la casa decentemente m√°s inteligente. <br>  Al mismo tiempo, francamente, no quer√≠a gastar mucho dinero en la soluci√≥n "Marca" de Smart House.  Adem√°s, muchas soluciones "serias" utilizaron est√°ndares cerrados e integrados entre s√≠ mediante muletas. <br><br>  En consecuencia, me propuse la tarea de ensamblar una casa inteligente con los componentes m√°s prefabricados y econ√≥micos. <br><br>  Como hardware para el controlador, eleg√≠ el escudo Arduino Mega 2560 + Ethernet. <br>  Actualizaci√≥n: Despu√©s de escuchar los comentarios a continuaci√≥n, port√© el proyecto a Atmel SAM3X8E ARM Cortex-M3 (Arduino DUE), una placa que, al mismo precio barato, tiene un orden de magnitud de mayor rendimiento y, lo m√°s importante, RAM.  Tuve que jugar con la biblioteca DMX, pero ahora tanto DMX-IN como DMX-OUT funcionan con el mismo hardware USART, sin ocupar los recursos del procesador.  El proyecto ya se encuentra en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">github</a> y se compila autom√°ticamente para la plataforma deseada. <br><br>  Un precio de un centavo, una gran cantidad de puertos de entrada / salida, 4 UART de hardware, un tama√±o decente de NVRAM, que hasta ahora he logrado ocupar solo el 30% del firmware y que se ajusta a toda la configuraci√≥n con un margen, y directamente en el formato JSON confirm√≥ la razonabilidad de la elecci√≥n. <br><br>  Despu√©s de actualizar el Bootloader y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ajustar la biblioteca de Ethernet, pude</a> usar con √©xito el Watchdog de hardware del procesador, lo que se sum√≥ a la decisi√≥n de la "industria" y todav√≠a tengo tranquilidad, aunque el firmware no se not√≥ incluso sin √©l. <br><br>  La ausencia de cualquier sistema operativo en el controlador nos permite considerarlo un "sistema en tiempo real", que permite, por ejemplo, generar mediante programaci√≥n la misma se√±al DMX. <br>  El cuello de botella es del tama√±o de la RAM.  Y esto no permite el uso de toda la vasta periferia del controlador.  Aunque, m√°s de 30 canales diferentes (elementos, en t√©rminos de una configuraci√≥n) encajan perfectamente en la memoria.  Y conectar todo lo que permite la placa Arduino Mega es una tarea, sin embargo, no relacionada con la realidad. <br>  (en ARM - no hay m√°s cuellos de botella) <br><br>  Adem√°s, la escalabilidad se logra al aumentar el n√∫mero de dispositivos.  Por ejemplo, tengo dos controladores involucrados.  Est√°n espaciados alrededor del apartamento (esto tambi√©n le permite no tirar de todos los cables a un punto).  Para la interacci√≥n entre ellos, as√≠ como con los sistemas Openhab y NodeRed, se utiliza el agente MQTT Mosquitto. <br><br>  Como controlador de bus de 1 cable, utilic√© un chip <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ds2482-100</a> (controlador I2C) <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">con Aliexpress</a> , que a un precio de 60 rublos garantiza un funcionamiento estable con un bus de hasta 100M. <br><br>  Para una configuraci√≥n flexible del dispositivo, modifiqu√© la biblioteca AJSON para Arduino, de modo que tenga la capacidad de cargar un objeto a trav√©s de http, leer y escribir un objeto desde / hacia el controlador NVRAM.  Fork est√° disponible <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">en Github</a> . <br><br>  La CLI de serie al crear un nuevo controlador, debe registrar una direcci√≥n MAC √∫nica en NVRAM.  Ese MAC es la clave por la cual se carga inicialmente la configuraci√≥n del servidor http. <br><br>  Como software de gesti√≥n, tom√© Openhab 2, que tiene toda la funcionalidad que necesito, adem√°s de una aplicaci√≥n m√≥vil, adem√°s de Cloud, cuya funci√≥n, sin embargo, es solo proporcionar acceso a la infraestructura dom√©stica desde el exterior, sin reenviar puertos en el enrutador y no tener IP fija.  Adem√°s, Openhab tiene integraci√≥n con HomeKit de Apple, que le permite controlar dispositivos en casa con el iPhone, sin instalar una aplicaci√≥n.  (La oportunidad es interesante, pero uso principalmente la aplicaci√≥n "nativa"). <br><br><div class="spoiler">  <b class="spoiler_title">Algunas capturas de pantalla de Openhab</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/bd/in/lz/bdinlz0d2isemsr_fov8orjjbbk.png" width="400" hspace="1" vspace="1"><br><br><img src="https://habrastorage.org/webt/mp/wc/id/mpwcidb2l-bses2xwbzpx3vufoi.png" width="400" hspace="1" vspace="1"><br></div></div><br>  La presencia de una gran cantidad de iluminaci√≥n LED en el proyecto del apartamento tambi√©n requiri√≥ una gesti√≥n razonable. <br><br><div class="spoiler">  <b class="spoiler_title">Detalles de iluminaci√≥n LED</b> <div class="spoiler_text">  Las soluciones encontradas en el mercado eran "cosas en s√≠ mismas" cerradas o costaban dinero inadecuado, mientras que admit√≠an pocos canales.  A menudo, los fabricantes estaban limitados a tres canales (RGB), aunque la opci√≥n RGBW permite el uso de cintas LED como la iluminaci√≥n principal, y no solo para la iluminaci√≥n de color. <br><br>  Pensando, orden√© un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">par de placas</a> en AliExpress, cada una de las cuales puede controlar 30 canales LED con una corriente nominal de hasta 2A por canal. <br><br>  Para aumentar la potencia m√°xima de un canal, cambi√© de tiras de LED a tiras de 12V a 24V.  En este caso, ilumine completamente la habitaci√≥n unos 16-18 metros cuadrados.  m era posible con 4 teclas.  Las instalaciones m√°s grandes tuvieron que dividirse en zonas: en la sala de estar conect√© de forma independiente 4 cintas de 5 m cada una, usando 16 canales. <br><br>  Para el control sincr√≥nico de toda la sala, tuve que encontrar el tipo de canal "grupo" <br><br>  Aqu√≠ est√° la descripci√≥n de la sala de estar en la configuraci√≥n JSON: <br><br><pre><code class="hljs powershell"><span class="hljs-string"><span class="hljs-string">"kuh"</span></span>:[<span class="hljs-number"><span class="hljs-number">7</span></span>,[<span class="hljs-string"><span class="hljs-string">"kuhline"</span></span>,<span class="hljs-string"><span class="hljs-string">"kuhfre"</span></span>,<span class="hljs-string"><span class="hljs-string">"kuhwork"</span></span>,<span class="hljs-string"><span class="hljs-string">"kuhwin"</span></span>]], <span class="hljs-string"><span class="hljs-string">"kuhwin"</span></span>:[<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">5</span></span>], <span class="hljs-string"><span class="hljs-string">"kuhline"</span></span>:[<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">13</span></span>], <span class="hljs-string"><span class="hljs-string">"kuhfre"</span></span>:[<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">25</span></span>], <span class="hljs-string"><span class="hljs-string">"kuhwork"</span></span>:[<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>],</code> </pre> <br>  El primer elemento de la matriz es el tipo de canal, el segundo es el par√°metro del canal, que puede ser una matriz. <br><br>  Para un elemento de tipo 7 (grupo), el argumento es una matriz de elementos en el grupo. <br>  La recursi√≥n, por supuesto, es compatible. <br><br>  Para un elemento de tipo 1 (cinta RGBW), el argumento es la direcci√≥n DMX base del canal. <br><br>  Con la biblioteca est√°ndar EasyDMX, las tarjetas no funcionaron de inmediato.  Al final result√≥ que, el controlador LED chino no digiri√≥ el retraso de 2 ms entre los cuadros DMX (retraso entre cuadros).  Una simple modificaci√≥n del c√≥digo de la biblioteca (reducir a la mitad el ciclo) ayud√≥. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Bifurcaciones de bibliotecas</a> en github <br>  A petici√≥n de los lectores, se agregaron im√°genes sobre el tema "Iluminaci√≥n LED en acci√≥n" <br><img src="https://habrastorage.org/webt/6c/08/dk/6c08dkziy1zslvk2aml37fywnfi.jpeg"><br>  Este es un decodificador DMX alternativo de la categor√≠a "caro y rico" <br><br>  Adem√°s, hay una "sesi√≥n de fotos", donde puede comprender cu√°nto cambia la habitaci√≥n cuando cambia la iluminaci√≥n, y tambi√©n que usando solo el color blanco en las cintas RGBW, puede obtener una iluminaci√≥n difusa que es agradable a la vista. <br>  Recomiendo cintas exclusivamente con luz blanca c√°lida (2700K) <br><br><img src="https://habrastorage.org/webt/lg/w-/ai/lgw-aiucdfmfabohe_xym8naw4g.jpeg"><br><br><img src="https://habrastorage.org/webt/ku/od/ra/kuodraad1vqhwr-eeovc4rifp74.jpeg"><br><br><img src="https://habrastorage.org/webt/0n/kb/gk/0nkbgk68234xqhwewigqydltdr0.jpeg"><br><br><img src="https://habrastorage.org/webt/6u/bw/cu/6ubwcuoondmfls25twqwso_6zjq.jpeg"><br><br><img src="https://habrastorage.org/webt/17/3z/lv/173zlvbmplrk4hfnc91kpbjqxsy.jpeg"><br><br><img src="https://habrastorage.org/webt/ks/xo/e8/ksxoe8gssobhbrrob7httuovgtm.jpeg"><br><br><img src="https://habrastorage.org/webt/pz/pl/tp/pzpltpjgk2gqwepbotu9vdxhuy4.jpeg"><br><br><img src="https://habrastorage.org/webt/ff/i-/12/ffi-12cpc6ikejgwihjuefh6wt4.jpeg"><br><br>  Y luego, algunos ejemplos de la combinaci√≥n de focos y LED: <br><img src="https://habrastorage.org/webt/6b/_o/ks/6b_oksc6q2wm-dtjml2znpmxu3s.jpeg"><br><br><img src="https://habrastorage.org/webt/pe/eo/tm/peeotmfppeyllnqs9wn4l95kshy.jpeg"><br><br><img src="https://habrastorage.org/webt/ri/ku/6n/riku6nkypopnnucs2xvo4sr2sf0.jpeg"><br><br><img src="https://habrastorage.org/webt/47/wr/d7/47wrd79finps2vlh4rdydkot9pa.jpeg"><br><br></div></div><br>  Con la iluminaci√≥n ordinaria de CA 220V, logr√© controlar los atenuadores chinos con Aliexpress que tienen soporte para Modbus RTU (protocolo de control industrial est√°ndar sobre RS-485).  Estos reguladores est√°n perfectamente controlados localmente (por interruptores sin fijaci√≥n), al mismo tiempo, el controlador tiene la capacidad de leer el brillo y controlarlos a trav√©s de Modbus (implementado para un dispositivo de dos canales hasta ahora). <br><br>  En el momento de la publicaci√≥n del art√≠culo, los atenuadores faltaban en Aliexpress, pero encontr√© un fabricante chino por etiqueta en la placa de circuito del dispositivo.  Aqu√≠ hay un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">enlace a su sitio web asc√©tico</a> .  Respondemos ansiosamente las preguntas por correo electr√≥nico, incluso enviamos poca documentaci√≥n. <br><br>  Otra opci√≥n para controlar la iluminaci√≥n de 220V es usar un atenuador de CA DMX-512.  En e-bay, en surtido, cualquier factor de forma: una placa o un riel DIN.  De uno a ocho canales. <br>  Al principio, tuve cuidado con esta opci√≥n, ya que el controlador todav√≠a estaba en una forma muy experimental y, por confiabilidad, quer√≠a mantener el control local aut√≥nomo.  Pero ahora ya usar√≠a esta opci√≥n. <br><br>  A continuaci√≥n, instal√© un aire acondicionado de canal, que puede calentar y enfriar todo el apartamento.  Para distribuir de alguna manera el fr√≠o y el calor en las habitaciones, instal√© servos con control de se√±al de 0-10V.  El √°ngulo de apertura de la v√°lvula se ajusta autom√°ticamente usando NodeRed, en el que se encontr√≥ un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">conveniente controlador PID</a> para esto. <br><br><div class="spoiler">  <b class="spoiler_title">Detalles de aire acondicionado</b> <div class="spoiler_text">  Desafortunadamente, no fue posible encontrar unidades de amortiguaci√≥n de aire con un PWM o alguna entrada digital, por lo que se compraron 4 convertidores PWM a una se√±al anal√≥gica est√°ndar 0..10V en el mismo AliExpress. <br><br>  Desafortunadamente, no veo estos dispositivos en Aliexpress, pero en e-bay, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">por favor</a> <br><br>  Los convertidores funcionaron de inmediato, solo tuve que reprogramar el temporizador de salida PWM para establecer la frecuencia adecuada. <br><br>  A continuaci√≥n se muestra un ejemplo de reprogramaci√≥n de los temporizadores 3 y 4 (responsables del pin 2, 3, 5, 6, 7, 8 Arduino Mega a una frecuencia de 4000 Hz). <br><br><pre> <code class="hljs pgsql"> pinMode(iaddr,OUTPUT); //timer <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> pin <span class="hljs-number"><span class="hljs-number">13</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> //timer <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> pin <span class="hljs-number"><span class="hljs-number">12</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span> //timer <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> pin <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span> //timer <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> pin <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> //timer <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> pin <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-type"><span class="hljs-type">int</span></span> tval = <span class="hljs-number"><span class="hljs-number">7</span></span>; // <span class="hljs-number"><span class="hljs-number">111</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> binary - used <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> an eraser TCCR4B &amp;= ~tval; // <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> the three bits <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> TCCR2B <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> TCCR3B &amp;= ~tval; tval=<span class="hljs-number"><span class="hljs-number">2</span></span>; //prescaler = <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-comment"><span class="hljs-comment">---&gt; PWM frequency is 4000 Hz TCCR4B|=tval; TCCR3B|=tval; analogWrite(iaddr,k=map(Value,0,100,0,255));</span></span></code> </pre><br></div></div><br>  Luego, comenc√© a buscar controladores de calefacci√≥n de piso WiFi.  En general, encontr√© un buen dispositivo que val√≠a unos 6 mil rublos de Teplolux, pero ten√≠a algunos inconvenientes importantes para m√≠. <br><br>  A pesar de la presencia de una aplicaci√≥n m√≥vil, el protocolo de control fue cerrado.  Hice un poco de ingenier√≠a inversa, lo que demostr√≥ que, en teor√≠a, el protocolo se puede descifrar.  Quiz√°s hubiera hecho esto, pero descubr√≠ que sin reinstalar los enchufes, este dispositivo no est√° instalado en la misma fila con los interruptores.  Esto determin√≥ el destino del dispositivo: despu√©s de venderlo, implement√© la funcionalidad de un termostato simple en mi controlador, ahorrando casi 30 mil rublos en 5 pisos c√°lidos. <br><br><div class="spoiler">  <b class="spoiler_title">Result√≥ lo siguiente:</b> <div class="spoiler_text"><ul><li>  Toda la administraci√≥n: localmente en el controlador e independientemente de la infraestructura de TI del hogar </li><li>  Se utilizan mediciones de sensores de temperatura de 1 cable.  Si el sensor no puede ser interrogado durante mucho tiempo, el calentador se apaga. </li><li>  A trav√©s de MQTT puede encender / apagar el piso c√°lido y configurar su temperatura.  En consecuencia, los pisos se controlan a trav√©s de interfaces y la aplicaci√≥n m√≥vil Openhab </li><li>  No implement√© scripts y horarios complicados en el controlador.  Si lo desea, esto se implementa f√°cilmente mediante las reglas de Openhab o Node-Red.  Me limit√© a apagar los dispositivos cuando la gente sale de la casa. </li></ul><br>  Aqu√≠ hay un ejemplo de una configuraci√≥n para un piso c√°lido: <br><br><pre> <code class="hljs powershell"><span class="hljs-string"><span class="hljs-string">"ow"</span></span>:{ <span class="hljs-string"><span class="hljs-string">"2807FFD503000036"</span></span>:{<span class="hljs-string"><span class="hljs-string">"emit"</span></span>:<span class="hljs-string"><span class="hljs-string">"t_bath1"</span></span>,<span class="hljs-string"><span class="hljs-string">"item"</span></span>:<span class="hljs-string"><span class="hljs-string">"h_bath1"</span></span>} }, <span class="hljs-string"><span class="hljs-string">"items"</span></span>:{ <span class="hljs-string"><span class="hljs-string">"h_bath1"</span></span>:[<span class="hljs-number"><span class="hljs-number">5</span></span>,<span class="hljs-number"><span class="hljs-number">24</span></span>,<span class="hljs-number"><span class="hljs-number">33</span></span>], },</code> </pre><br>  Al sondear un term√≥metro OneWire con la direcci√≥n especificada, se transfiere al bus MQTT en el tema t_bath1, y tambi√©n, dentro del controlador, al objeto h_bath del tipo No. 5 (termostato), el rel√© se conecta al pin # 24 del controlador, la configuraci√≥n es de 33 grados (puede ajustarse mediante MQTT ) <br></div></div><br>  <b>Entradas de dispositivo</b> <br><br>  En la configuraci√≥n de cada entrada, puede especificar c√≥mo se env√≠a el comando al objeto local y c√≥mo se emite el comando en el tema MQTT.  Adem√°s, por separado tanto para la "presi√≥n" condicional del bot√≥n como para la "liberaci√≥n". <br><br><div class="spoiler">  <b class="spoiler_title">Ejemplos:</b> <div class="spoiler_text"><pre> <code class="hljs objectivec"><span class="hljs-string"><span class="hljs-string">"in"</span></span>:{ <span class="hljs-string"><span class="hljs-string">"41"</span></span>:{<span class="hljs-string"><span class="hljs-string">"emit"</span></span>:<span class="hljs-string"><span class="hljs-string">"/myhome/in/all"</span></span>,<span class="hljs-string"><span class="hljs-string">"scmd"</span></span>:<span class="hljs-string"><span class="hljs-string">"HALT"</span></span>,<span class="hljs-string"><span class="hljs-string">"rcmd"</span></span>:<span class="hljs-string"><span class="hljs-string">"REST"</span></span>}, <span class="hljs-string"><span class="hljs-string">"38"</span></span>:{<span class="hljs-string"><span class="hljs-string">"item"</span></span>:<span class="hljs-string"><span class="hljs-string">"spots_en"</span></span>}, <span class="hljs-string"><span class="hljs-string">"37"</span></span>:{<span class="hljs-string"><span class="hljs-string">"emit"</span></span>:<span class="hljs-string"><span class="hljs-string">"/myhome/in/light"</span></span>,<span class="hljs-string"><span class="hljs-string">"scmd"</span></span>:<span class="hljs-string"><span class="hljs-string">"ON"</span></span>,<span class="hljs-string"><span class="hljs-string">"rcmd"</span></span>:<span class="hljs-string"><span class="hljs-string">"OFF"</span></span>}, <span class="hljs-string"><span class="hljs-string">"40"</span></span>:{<span class="hljs-string"><span class="hljs-string">"emit"</span></span>:<span class="hljs-string"><span class="hljs-string">"/myhome/in/gstall"</span></span>,<span class="hljs-string"><span class="hljs-string">"scmd"</span></span>:<span class="hljs-string"><span class="hljs-string">"TOGGLE"</span></span>,<span class="hljs-string"><span class="hljs-string">"rcmd"</span></span>:<span class="hljs-string"><span class="hljs-string">"TOGGLE"</span></span>}, <span class="hljs-string"><span class="hljs-string">"35"</span></span>:{<span class="hljs-string"><span class="hljs-string">"emit"</span></span>:<span class="hljs-string"><span class="hljs-string">"/myhome/s_out/water_leak"</span></span>} }</code> </pre><br>  Pin 41: Interruptor Reed en la cerradura de la puerta delantera - cuando est√° bloqueado - emita el comando HALT al tema / myhome / in / all, cuando est√© desbloqueado - el comando REST. <br><br>  Para m√≠, esto lleva a completar "quedarse dormido" y "despertar" en casa.  Por cierto, los comandos no est√°n incluidos en el conjunto est√°ndar de OpenHab, pero result√≥ ser extremadamente conveniente - HALT - apaga el dispositivo, REST - restaura la configuraci√≥n del dispositivo al √∫ltimo valor (color, brillo, temperatura), pero solo para el dispositivo que fue apagado por el comando HALT y no OFF  Esto le permite no incluir lo que estaba apagado al momento de salir de casa. <br><br>  Pin 38: solo un interruptor de luz ordinario.  Cuando est√° cerrado, emite (por defecto) el comando ON, cuando se abre, el comando OFF.  Estos valores se pasan al objeto spots_en.  Est√° claro que el estado de un objeto se puede cambiar desde una aplicaci√≥n m√≥vil.  En este caso, el interruptor, por as√≠ decirlo, permanece, por ejemplo, en la posici√≥n de encendido, pero la luz est√° apagada. <br><br>  Para los amantes de los interruptores de recorrido cl√°sicos, la sintaxis de Pin 40 es adecuada: tanto cuando se enciende como se apaga, se emite el comando TOGGLE (tambi√©n, por cierto, uno nuevo, relativo a OpenHab), que cambia la posici√≥n de encendido y apagado del dispositivo (en este ejemplo, la l√°mpara se controla no localmente, sino a trav√©s de MQTT otro controlador). <br><br>  Si no se trata de un interruptor basculante sino de un bot√≥n, simplemente ajuste ‚Äúrcmd‚Äù: "" - solo dar√° un comando de interruptor cuando se presione. <br></div></div><br>  Ah, bueno, casi me olvido de describir DMX-IN, la entrada para la cual, podr√≠a decirse, comenc√© este desarrollo. <br><br>  Hay una gran cantidad de controladores de tiras LED DMX de dise√±o exitoso y, en general, ergon√≥micos en el mercado. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Uno de estos (panel t√°ctil) lo compr√©</a> al principio para experimentar con DMX.  Todo est√° bien, pero la arquitectura DMX no proporciona ning√∫n control desde m√°s de un lugar.  Hay un Maestro, que se traduce constantemente en el canal de brillo de los canales.  Pero en este proyecto este problema est√° resuelto.  El controlador LightHub monitorea los cambios del canal DMX en la entrada conectada al panel t√°ctil.  Si cambian, traduce los cambios a la salida (con asignaci√≥n a dispositivos configurados, incluidos grupos de tiras de LED). <br><br>  Hasta ahora nada ha cambiado: los dispositivos se controlan normalmente de forma remota.  Vale la pena que el panel t√°ctil cambie los valores de brillo de los canales; estos cambios se transmiten a las salidas DMX. <br><br>  Por extra√±o que parezca, esta muleta result√≥ ser bastante ergon√≥mica.  Aunque, como lo ha demostrado la experiencia, es cada vez menos probable que usemos el panel t√°ctil y cada vez m√°s tel√©fonos inteligentes para controlar dispositivos. <br><br>  <b>Conclusi√≥n</b> <br><br>  Desafortunadamente, en un art√≠culo es imposible describir todos los matices inherentes al desarrollo. <br>  Por ejemplo, el tema de la conexi√≥n de dispositivos Modbus, su extracci√≥n y sincronizaci√≥n del estado local del dispositivo con el sistema Smart Home, la integraci√≥n con una instalaci√≥n de suministro simple permaneci√≥ completamente detr√°s de escena.  Bueno, y tal vez una comparaci√≥n con los sistemas existentes de clases relacionadas, como, por ejemplo, MegaD-328, AMS e, incluso, WirenBoard.  Quiz√°s si hay inter√©s, continuar√©. <br><br>  Adem√°s, mientras est√°bamos detr√°s de escena, usando NodeRed, pudimos integrar el sistema con Telegram.  Si bien funciona para recibir alertas, pero puede crear un Bot completo. <br><br>  Con respecto al proyecto LightHub, a pesar de su bajo costo, los controladores resultaron ser una soluci√≥n completamente funcional.  Honestamente, yo mismo no cre√≠a que sobre la base de Arduino se pudiera crear un sistema de trabajo estable, pero, en mi opini√≥n, era posible. <br><br>  Por supuesto, a√∫n queda mucho por hacer: al√©jese completamente del c√≥digo r√≠gido (solo un poco m√°s), limpie y refactorice un poco el c√≥digo, documente cuidadosamente el proyecto, abra la placa de circuito impreso (ahora los escudos de interfaz se sueldan simplemente sobre la base de placas de pruebas y contienen tres MAX-485 - (DMX-IN, DMX-OUT, Modbus) y 1-Wire bridge) - y esto se convertir√°, de hecho, en una soluci√≥n llave en mano de muy bajo costo. <br><br>  Advertencia: le recuerdo que el proyecto todav√≠a est√° en el nivel de la placa de pruebas.  Al abrir el siguiente spoiler, puede da√±ar sus sentidos est√©ticos. <br><div class="spoiler">  <b class="spoiler_title">Algunas fotos</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/kg/jd/qo/kgjdqoi6_mqq5hj5_tcgvflkm-y.jpeg"><br>  El primer controlador que controla el LED (60 canales DMX-512), Modbus (atenuadores, entrada), flaps; <br><br><img src="https://habrastorage.org/webt/m4/qs/dv/m4qsdvcfcjydoqszeq1uptpvooy.jpeg"><br>  Este es un decodificador DMX-512, que es conveniente colocar donde la tira de LED llega a los transformadores.  Tengo - debajo del falso techo en la despensa. <br><br><img src="https://habrastorage.org/webt/np/ib/7_/npib7_bsnhtyjoza0dwxdtt1uq0.jpeg"><br><br>  Y este es el segundo controlador que sirve 1 cable, interruptores / sensores y un m√≥dulo de rel√©.  (El m√≥dulo de rel√© en s√≠ estaba ubicado justo en la caja de conexiones, donde pertenece a las tres fases. Erradiqu√© el vecindario de 380V y las corrientes d√©biles siempre que fue posible despu√©s de un incidente fallido) <br></div></div><br><br>  Est√° claro que es necesario ampliar la funcionalidad.  Como m√≠nimo, hacia sensores / dispositivos inal√°mbricos.  (Aunque, por ejemplo, ZWave ahora se puede usar a trav√©s de carpetas est√°ndar de Openhab). <br><br>  La capacidad de conectarse, por ejemplo, el presupuesto NooLight es probablemente una buena idea.  Tal vez piense en migrar al ESP-8266 para expandir la RAM, aunque no me gusta dejar WiFi en una conexi√≥n LAN por cable en t√©rminos de confiabilidad.  S√≠, y ESP no tiene una periferia tan rica como Arduino Mega.  Tambi√©n planeo hacer la medici√≥n de electricidad a trav√©s de sensores de corriente y conectar el codificador rotatorio a la entrada. <br><br>  Adem√°s, ser√≠a √∫til hacer que la configuraci√≥n y el inicio del controlador sean m√°s f√°ciles de usar (configuradores visuales, etc.).  Al mismo tiempo, deliberadamente no quiero convertir el controlador en un servidor web con archivos / im√°genes, AJAX, etc. En mi opini√≥n, esto ya deber√≠a ser una prerrogativa del servidor.  Al menos basado en frambuesa. <br><br>  Pero dado que el proyecto es absolutamente de c√≥digo abierto, hay diferentes opciones posibles, √∫nase. <br>  Adem√°s, espero sus comentarios. <br><br><h3>  ACTUALIZACI√ìN </h3><br>  Despu√©s de la publicaci√≥n del art√≠culo, despu√©s de unir fuerzas con uno de los residentes de Habr y dibujar un diagrama esquem√°tico del Escudo LighthHub, comenzamos a dise√±ar la placa de circuito impreso, teniendo en cuenta toda la experiencia y los comentarios significativos <br><br><ul><li>  La placa ser√° compatible con Arduino Mega (5v) y Arduino DUE (ARM 3.3V) </li><li>  Interfaz Ethernet incorporada basada en Wiznet5500 </li><li>  8 entradas discretas optoacopladas, 8 entradas / salidas discretas con protecci√≥n de voltaje / corriente </li><li>  8 entradas anal√≥gicas con protecci√≥n de voltaje / corriente.  En el futuro, propongo usar entradas anal√≥gicas para controlar el consumo de energ√≠a (sensores de corriente) y para conectar potenci√≥metros externos (atenuadores) </li><li>  8 salidas PWM, 4 de ellas con teclas de salida potentes (hasta 500 mA / 50V) + 4 salidas potentes discretas.  Le permitir√°n conectarse localmente al controlador, por ejemplo, varios arrancadores o incluso una tira LED RGBW no muy larga. </li><li>  Un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">conector de</a> formato UEXT, que posteriormente le permitir√° conectar un perif√©rico compatible al controlador, por ejemplo, m√≥dulos de radio adicionales para conectarse a dispositivos inal√°mbricos. </li><li>  Las entradas / salidas restantes se emitir√°n sin protecci√≥n a los conectores RJ45 para conectar dispositivos locales (tarjetas de rel√©s, DAC, etc.) </li><li>  Por supuesto, quedan interfaces de 1 cable para conectar sensores de temperatura, una entrada y salida DMX-512 para control de iluminaci√≥n, Modbus RTU para todo lo dem√°s. </li></ul><br><br>  Puede dejar comentarios sobre la funcionalidad, as√≠ como el deseo de unirse al pedido del primer lote de tableros, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> <br><br>  El siguiente punto en el programa ser√° el desarrollo de una placa controladora con un m√≥dulo ESP32 integrado (esto le permitir√° alejarse del factor de forma Arduino) </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es407975/">https://habr.com/ru/post/es407975/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es407959/index.html">Demos la bienvenida a nuestros nuevos propietarios - robots - cap√≠tulo dos</a></li>
<li><a href="../es407961/index.html">Antiportfolio: oportunidades de inversi√≥n que hemos perdido</a></li>
<li><a href="../es407963/index.html">Varios asteroides hicieron una "fotobomba" para el Hubble, impidi√©ndoles fotografiar galaxias distantes</a></li>
<li><a href="../es407965/index.html">Multilateraci√≥n - Tecnolog√≠a digital de monitoreo del tr√°nsito a√©reo</a></li>
<li><a href="../es407967/index.html">Sobre la materia oscura, el n√∫mero de Pi y los antiguos griegos</a></li>
<li><a href="../es407977/index.html">Sobre la recopilaci√≥n de datos. C√≥mo recopilar datos, analizarlos y robarlos</a></li>
<li><a href="../es407979/index.html">Vulnerabilidades en los sistemas operativos. Parte 1</a></li>
<li><a href="../es407981/index.html">Detalles del desarrollo de la terapia g√©nica para el envejecimiento en una entrevista con Fight Aging!</a></li>
<li><a href="../es407983/index.html">Los astr√≥nomos han comenzado a trabajar en el quinto espejo del telescopio gigante de Magallanes</a></li>
<li><a href="../es407985/index.html">Rocket Mail Memories</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>