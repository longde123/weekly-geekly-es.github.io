<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🎩 🙆🏽 🦓 Nextcloud di dalam dan di luar OpenLiteSpeed: konfigurasikan proxy terbalik 🕔 👨🏾‍🎤 🛵</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bagaimana cara mengkonfigurasi OpenLiteSpeed ​​untuk membalikkan proxy di Nextcloud, yang terletak di jaringan internal? 


 Anehnya, pencarian di Hab...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Nextcloud di dalam dan di luar OpenLiteSpeed: konfigurasikan proxy terbalik</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/452750/"><h3>  Bagaimana cara mengkonfigurasi OpenLiteSpeed ​​untuk membalikkan proxy di Nextcloud, yang terletak di jaringan internal? </h3><br><p>  Anehnya, pencarian di Habré untuk OpenLiteSpeed ​​tidak menghasilkan apa-apa!  Saya segera memperbaiki ketidakadilan ini, karena LSWS adalah server web yang layak.  Saya suka dia untuk antarmuka administrasi web yang cepat dan modis: </p><br><p><img src="https://habrastorage.org/webt/ex/pr/ai/expraidfnnddzqcw-222w5tbbto.png" alt="gambar"></p><br><p>  Terlepas dari kenyataan bahwa OpenLiteSpeed ​​paling terkenal sebagai "akselerator" WordPress, dalam artikel hari ini saya akan menunjukkan aplikasi yang agak spesifik.  Yaitu membalikkan permintaan proxy (reverse proxy).  Anda mengatakan bahwa lebih umum menggunakan nginx untuk ini?  Saya akan setuju.  Tapi itu benar-benar melukai kita untuk mencintai LSWS! </p><br><p>  Proksi ok, tapi dimana?  Layanan yang sama hebatnya adalah Nextcloud.  Kami menggunakan Nextcloud untuk membuat "cloud file-sharing" pribadi.  Untuk setiap klien, kami mengalokasikan VM terpisah dengan Nextcloud, dan tidak ingin mengekspos mereka "keluar".  Sebagai gantinya, kami mem-proxy permintaan melalui proxy terbalik umum.  Solusi ini memungkinkan Anda untuk: </p><br><ol><li>  menghapus server tempat data klien disimpan dari Internet dan </li><li>  simpan alamat ip. </li></ol><br><p>  Skemanya terlihat seperti ini: </p><br><p><img src="https://habrastorage.org/webt/pt/iw/dk/ptiwdkww_5xiebu_7rzjk1q_nn4.png" alt="gambar"></p><br><p>  Jelas bahwa skema ini disederhanakan, karena  mengatur infrastruktur layanan web bukan topik artikel hari ini. </p><br><p>  Juga dalam artikel ini saya akan menghilangkan instalasi dan konfigurasi dasar non-clauda, ​​terutama karena ada materi tentang topik ini di Habré.  Tapi saya pasti akan menunjukkan pengaturan, yang tanpanya Nextcloud tidak akan berfungsi untuk proxy. </p><a name="habracut"></a><br><p>  Diberikan: Nextcloud diinstal pada host 1 dan dikonfigurasikan untuk bekerja melalui http (tanpa SSL), ia hanya memiliki antarmuka jaringan lokal dan alamat IP "abu-abu" 172.16.22.110. </p><br><p>  Kami akan mengkonfigurasi OpenLiteSpeed ​​pada host 2. Ini memiliki dua antarmuka, yang eksternal (terlihat di Internet) dan yang internal dengan alamat IP pada jaringan 172.16.22.0/24 </p><br><p>  Nama DNS cloud.connect.link mengarah ke alamat IP antarmuka eksternal host 2 </p><br><p>  Tugas: untuk mendapatkan dari Internet melalui tautan ' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://cloud.connect.link</a> ' (SSL) ke Nextcloud di jaringan internal. </p><br><ul><li>  Instal OpenLiteSpeed ​​di Ubuntu 18.04.2. </li></ul><br><p>  Tambahkan repositori: </p><br><blockquote>  wget -O - <a href="">http://rpms.litespeedtech.com/debian/enable_lst_debain_repo.sh</a> | sudo bash <br>  sudo apt-get pembaruan </blockquote><p>  atur, jalankan: </p><br><blockquote>  sudo apt-get install openlitespeed <br>  sudo / usr / local / lsws / bin / lswsctrl mulai </blockquote><br><ul><li>  Minimalkan firewall. <br><blockquote>  sudo ufw izinkan ssh <br>  sudo ufw default memungkinkan keluar <br>  sudo ufw default tolak masuk <br>  sudo ufw memungkinkan http <br>  sudo ufw memungkinkan https <br>  sudo ufw izinkan dari <em>host manajemen Anda</em> ke port 7080 <br>  sudo ufw aktifkan <br></blockquote></li><li>  Atur OpenLiteSpeed ​​sebagai proxy terbalik. <br>  Buat direktori untuk virtualhost. <br><blockquote>  cd / usr / local / lsws / <br>  sudo mkdirc cloud.connect.link <br>  cd cloud.connect.link/ <br>  sudo mkdir {conf, html, logs} <br>  sudo chown lsadm: lsadm ./conf/ <br></blockquote></li></ul><br><p>  Konfigurasikan virtualhost dari antarmuka web LSWS. <br>  Buka manajemen url <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">http://cloud.connect.link:7080</a> <br>  Login / kata sandi default: admin / 123456 </p><br><p><img src="https://habrastorage.org/webt/cw/1w/he/cw1whegtkiqtmeolcucdy5poqci.png" alt="gambar"></p><br><p>  Tambahkan host virtual (Host Virtual&gt; Tambah). </p><br><p>  Saat menambahkan, pesan kesalahan akan muncul - tidak ada file konfigurasi.  Ini normal, diselesaikan dengan mengeklik Klik untuk membuat. </p><br><p><img src="https://habrastorage.org/webt/yo/_0/-p/yo_0-p7xc0c80x4bdaswadf1fpg.png" alt="gambar"></p><br><p>  Di tab Umum, tentukan Dokumen Root (meskipun tidak diperlukan, konfigurasi tidak akan lepas landas tanpanya).  Nama Domain, jika tidak ditentukan, akan diambil dari Nama Host Virtual, yang kami namai nama domain kami. </p><br><p><img src="https://habrastorage.org/webt/eo/7j/m_/eo7jm_yuk5x5plv6cimesnxxbso.png" alt="gambar"></p><br><p>  Sekarang saatnya untuk mengingat bahwa kita tidak hanya memiliki server web, tetapi juga proxy terbalik.  Pengaturan berikut akan memberi tahu LSWS apa yang harus proxy dan di mana.  Dalam pengaturan host virtual, buka tab Aplikasi Eksternal dan tambahkan aplikasi baru seperti server Web: </p><br><p><img src="https://habrastorage.org/webt/ls/_k/9q/ls_k9qnq-b83jduewm-euwucaku.png" alt="gambar"></p><br><p>  Tunjukkan nama dan alamatnya.  Nama dapat ditentukan secara sewenang-wenang, tetapi harus diingat, berguna dalam langkah selanjutnya.  Alamatnya adalah tempat tinggal Nextcloud di jaringan internal: </p><br><p><img src="https://habrastorage.org/webt/lc/aj/ah/lcajahhbytgrbchjugfl5nz0hoq.png" alt="gambar"></p><br><p>  Dalam pengaturan yang sama dari host virtual, buka tab Konteks dan buat konteks baru dari tipe Proxy: </p><br><p><img src="https://habrastorage.org/webt/mj/mq/yg/mjmqyg_hy4gsxza_dcjb-sc1ldu.png" alt="gambar"></p><br><p>  Tentukan parameter: URI = /, server Web = nextcloud_1 (nama dari langkah sebelumnya) </p><br><p><img src="https://habrastorage.org/webt/km/e_/x9/kme_x90yobopk29vt86fymdc7uu.png" alt="gambar"></p><br><p>  Mulai ulang LSWS.  Ini dilakukan dengan satu klik dari antarmuka web, keajaiban!  (Pembawa tikus herediter berbicara pada saya) </p><br><p><img src="https://habrastorage.org/webt/qw/vr/bl/qwvrblflsbimg6ya16ay29m_pus.png" alt="gambar"></p><br><p><img src="https://habrastorage.org/webt/1f/z_/p5/1fz_p5uigm1ef5sdx3vrvptniic.png" alt="gambar"></p><br><ul><li>  Kami menempatkan sertifikat, mengkonfigurasi https. <br>  Kami akan mengabaikan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">prosedur untuk memperoleh sertifikat</a> , setuju bahwa kami sudah memilikinya dan berbaring dengan kunci di direktori /etc/letsencrypt/live/cloud.connect.link. </li></ul><br><p>  Buat "pendengar" (Pendengar&gt; Tambah), sebut saja "https".  Kami arahkan ke port 443 dan perhatikan bahwa itu akan Aman: </p><br><p><img src="https://habrastorage.org/webt/ou/1q/mf/ou1qmfazgmggv1wwo1alxxtpxl8.png" alt="gambar"></p><br><p>  Di tab SSL, tentukan jalur ke kunci dan sertifikat: </p><br><p><img src="https://habrastorage.org/webt/tr/xg/c0/trxgc0tcpnnca9f53yvvpk2_5hq.png" alt="gambar"></p><br><p>  "Pendengar" telah dibuat, sekarang di bagian Pemetaan Host Virtual kami menambahkan host virtual kami ke dalamnya: </p><br><p><img src="https://habrastorage.org/webt/-0/y9/2b/-0y92bbvfhdefzynyjuoipouwea.png" alt="gambar"></p><br><p>  Jika LSWS hanya mewakili satu layanan, konfigurasi dapat diselesaikan.  Tetapi kami berencana menggunakannya untuk mentransfer permintaan ke "otoritas" yang berbeda tergantung pada nama domain.  Dan semua domain akan memiliki sertifikat sendiri.  Oleh karena itu, Anda perlu pergi ke konfigurasi virtualhost dan tentukan lagi kunci dan sertifikatnya di tab SSL.  Di masa depan, ini harus dilakukan untuk setiap host virtual baru. </p><br><p><img src="https://habrastorage.org/webt/us/ap/7z/usap7zccpjkyyko7llyawrkkz7g.png" alt="gambar"></p><br><p>  Tetap mengonfigurasi penulisan ulang url agar permintaan http ditujukan ke https. </p><br><p>  <i>(Omong-omong, kapan ini akan berakhir? Sudah waktunya browser dan perangkat lunak lain untuk membuka https secara default, dan melakukan penerusan tanpa-SSL secara manual jika perlu).</i> <br>  Aktifkan Aktifkan Penulisan Ulang dan tulis Aturan Penulisan Ulang: </p><br><blockquote>  RewriteCond% {SERVER_PORT} 80 <br>  RewriteRule ^ (. *) $ <a href="">Https: //% {SERVER_NAME}% {REQUEST_URI</a> } [R = 301, L] </blockquote><p><img src="https://habrastorage.org/webt/ki/rn/xq/kirnxqm_dendpov7gniojwnsk7q.png" alt="gambar"></p><br><p>  Tidak mungkin untuk menerapkan aturan Menulis Ulang dengan Restart Anggun yang biasa karena kesalahpahaman yang aneh.  Karenanya, memulai ulang LSWS tidak elegan, tetapi kasar dan efisien: </p><br><blockquote>  sudo systemctl restart lsws.service </blockquote><p>  Agar server mendengarkan port 80, buat Listener lain.  Sebut saja http, tentukan port ke-80 dan tidak aman: </p><br><p><img src="https://habrastorage.org/webt/k3/za/ji/k3zajihurrtkg4ddc8eabk_njuq.png" alt="gambar"></p><br><p>  Dengan analogi dengan pengaturan pendengar https, mari lampirkan host virtual kami untuk itu. </p><br><p>  Sekarang LSWS akan mendengarkan port ke-80 dan mengirim permintaan dari sana ke 443, menulis ulang url. <br>  Sebagai kesimpulan, saya sarankan menurunkan tingkat logging LSWS, yang ditetapkan sebagai Debug secara default.  Dalam mode ini, log berkembang biak dengan kecepatan kilat!  Untuk sebagian besar kasus, tingkat Peringatan sudah cukup.  Pergi ke Konfigurasi Server&gt; Log: </p><br><p><img src="https://habrastorage.org/webt/c5/cb/pl/c5cbplov4zgqtonzcw8x6bb0poy.png" alt="gambar"></p><br><p>  Ini melengkapi konfigurasi OpenLiteSpeed ​​sebagai proxy terbalik.  Sekali lagi kami memulai ulang LSWS, ikuti tautan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://cloud.connect.link</a> dan lihat: </p><br><p><img src="https://habrastorage.org/webt/nn/vo/_d/nnvo_dsr_qk_pzkv0j6xoixedve.png" alt="gambar"></p><br><p>  Agar Nextcloud mengizinkan kami masuk, Anda perlu menambahkan domain cloud.connect.link ke daftar yang tepercaya.  Pergi edit config.php.  Saya menginstal Nextcloud secara otomatis ketika menginstal Ubuntu dan konfigurasi ada di sini: / var / snap / nextcloud / current / nextcloud / config. </p><br><p>  Untuk kunci tepercaya_domain, tambahkan parameter 'cloud.connect.link': </p><br><blockquote>  'trust_domains' =&gt; <br>  array ( <br>  0 =&gt; '172.16.22.110', <br>  1 =&gt; 'cloud.connect.link', <br>  ), </blockquote><p><img src="https://habrastorage.org/webt/ow/62/kd/ow62kdr0pbvhfqgcrj-04yvicfi.png" alt="gambar"></p><br><p>  Lebih lanjut, dalam konfigurasi yang sama Anda harus menentukan alamat IP proxy kami.  Saya menarik perhatian pada fakta bahwa alamat harus ditentukan yang terlihat oleh server Nextcloud, yaitu  IP antarmuka lokal LSWS.  Tanpa langkah ini, antarmuka web Nextcloud berfungsi, tetapi aplikasi tidak diotorisasi. </p><br><blockquote>  'trust_proxies' =&gt; <br>  array ( <br>  0 =&gt; '172.16.22.100', <br>  ), </blockquote><p>  Nah, setelah itu kita bisa masuk ke antarmuka otorisasi: </p><br><p><img src="https://habrastorage.org/webt/ln/wk/ty/lnwktyhkca3giakan3fqnk0v7ji.png" alt="gambar"></p><br><p>  Masalahnya terpecahkan!  Sekarang setiap klien dapat menggunakan "file cloud" dengan aman di url pribadinya, server dengan file dipisahkan dari Internet, klien masa depan akan mendapatkan hal yang sama dan tidak ada alamat IP tambahan yang akan terpengaruh. <br>  Selain itu, Anda dapat menggunakan proxy terbalik untuk mengirimkan konten statis, tetapi dalam kasus Nextcloud ini tidak akan memberikan peningkatan kecepatan yang nyata.  Jadi ini opsional dan opsional. </p><br><p>  Senang berbagi cerita ini, saya berharap seseorang akan membantu.  Jika Anda tahu metode yang lebih elegan dan efektif untuk menyelesaikan tugas - saya akan berterima kasih atas komentarnya! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id452750/">https://habr.com/ru/post/id452750/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id452740/index.html">Pilihan Kumpulan Data untuk Pembelajaran Mesin</a></li>
<li><a href="../id452742/index.html">Menyiapkan pengujian otomatis aplikasi hybrid</a></li>
<li><a href="../id452744/index.html">Apakah ada kehidupan penuh seorang pengubah tanpa pertukaran lepas?</a></li>
<li><a href="../id452746/index.html">Buku "The Art of Programming dalam R. Immersing in Big Data"</a></li>
<li><a href="../id452748/index.html">Prinsip pengembangan aplikasi modern dari NGINX. Bagian 1</a></li>
<li><a href="../id452752/index.html">BigData buatan rumah. Bagian 1. Praktek Spark Streaming pada gugus AWS</a></li>
<li><a href="../id452754/index.html">19% dari gambar Docker paling populer tidak memiliki kata sandi root</a></li>
<li><a href="../id452756/index.html">Menciptakan Tower Defense in Unity: Enemies</a></li>
<li><a href="../id452760/index.html">Vitamin D. Untuk minum atau tidak minum, itulah pertanyaannya. (Atau cerita tentang bagaimana saya melewati analisis yang tidak saya resepkan)</a></li>
<li><a href="../id452762/index.html">MVCC-7. Pembersihan otomatis</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>