<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üàöÔ∏è üëì üë¶ Hacer una b√∫squeda realmente inteligente: gu√≠a paso a paso üë®üèø‚Äçüé§ ‚åöÔ∏è üë®üèª‚Äçüöí</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Busque en el sistema de informaci√≥n corporativo , ya que esta frase se queda atrapada en la boca. Es bueno si tienes uno, ni siquiera tienes que pensa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Hacer una b√∫squeda realmente inteligente: gu√≠a paso a paso</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/directum/blog/460263/"><p>  <em>Busque en el sistema de informaci√≥n corporativo</em> , ya que esta frase se queda atrapada en la boca.  Es bueno si tienes uno, ni siquiera tienes que pensar en una experiencia de usuario positiva.  ¬øC√≥mo revertir la actitud de los usuarios mimados por los motores de b√∫squeda y crear un producto r√°pido, preciso y perfectamente comprensible?  Necesitamos tomar una buena parte de Elasticsearch, un pu√±ado de servicios inteligentes y amasarlos en esta gu√≠a. </p><br><p>  Hay muchos art√≠culos sobre c√≥mo ajustar la b√∫squeda de texto completo basada en Elasticsearch a la base de datos existente.  Pero claramente no hay suficientes art√≠culos sobre c√≥mo hacer una b√∫squeda realmente inteligente. </p><br><blockquote>  Al mismo tiempo, la frase "B√∫squeda inteligente" ya se ha convertido en una palabra de moda y se utiliza para el lugar y no.  Entonces, ¬øqu√© debe hacer un motor de b√∫squeda para ser considerado inteligente?  En √∫ltima instancia, esto puede describirse como el resultado que el usuario realmente necesita, incluso si este resultado no coincide con el texto de la solicitud.  Los motores de b√∫squeda populares como Google y Yandex van m√°s all√° y no solo encuentran la informaci√≥n que necesitan, sino que responden directamente a las preguntas de los usuarios. </blockquote><p>  De acuerdo, no vamos a barrer una decisi√≥n de ultim√°tum de inmediato, pero ¬øqu√© se puede hacer para acercar una b√∫squeda de texto completo a una <em>inteligente</em> ? </p><a name="habracut"></a><br><h2 id="elementy-intellektualnosti">  Elementos de inteligencia </h2><br><p>  B√∫squeda inteligente: este es el caso cuando la cantidad puede entrar en calidad y muchas caracter√≠sticas peque√±as y bastante simples pueden formar un sentido de magia. </p><br><ul><li>  Correcci√≥n de errores del usuario, ya sea un error tipogr√°fico, un dise√±o incorrecto o, tal vez, una solicitud con un n√∫mero sospechosamente peque√±o de resultados, pero similar a una solicitud para la que hay mucha m√°s informaci√≥n. </li><li>  Para <del>  th </del>  Chats de PNL (procesamiento de lenguaje natural, no lo que pensaba): si el usuario ingres√≥ <em><strong>ofertas comerciales durante el √∫ltimo a√±o</strong></em> , ¬ørealmente quer√≠a buscar estas palabras en el texto de todos los documentos o realmente solo necesitaba ofertas comerciales y solo el a√±o pasado? ? </li><li>  Predecir entradas basadas en consultas anteriores o documentos populares. </li><li> La presentaci√≥n del resultado es el punto culminante habitual del fragmento encontrado, informaci√≥n adicional dependiendo de lo que estaba buscando.  Dado que se necesitaban propuestas comerciales en el p√°rrafo anterior, ¬øquiz√°s tenga sentido mostrar de inmediato el tema de la propuesta y de qu√© organizaci√≥n proviene? </li><li>  Desglose f√°cil: la capacidad de refinar la consulta de b√∫squeda utilizando filtros adicionales, facetas. </li></ul><br><h2 id="vvodnaya">  Introductorio </h2><br><p>  Hay un DIRECTO ECM con muchos documentos.  El documento consta de una tarjeta con metainformaci√≥n y un cuerpo, que puede tener varias versiones. </p><br><p>  El objetivo es buscar r√°pida y convenientemente informaci√≥n en estos documentos de la manera habitual para un usuario de motores de b√∫squeda. </p><br><h2 id="indeksirovanie">  Indexaci√≥n </h2><br><blockquote>  Para buscar algo bien, primero debe indexarlo bien. </blockquote><p>  Los documentos en ECM no son est√°ticos, los usuarios modifican texto, crean nuevas versiones, cambian datos en tarjetas;  constantemente se crean nuevos documentos y los antiguos a veces se eliminan. <br>  Para mantener la informaci√≥n actualizada en Elasticsearch, los documentos deben reindexarse ‚Äã‚Äãconstantemente.  Afortunadamente, ECM ya tiene su propia cola de eventos asincr√≥nicos, as√≠ que cuando cambie un documento, simplemente agr√©guelo a la cola para indexarlo. </p><br><h3 id="otobrazhenie-dokumentov-ecm-na-dokumenty-elasticsearch">  Asignaci√≥n de documentos ECM a documentos de Elasticsearch </h3><br><p>  Un cuerpo de documento en ECM puede tener varias versiones.  En Elasticsearch, esto podr√≠a considerarse como una matriz de objetos anidados, pero luego resulta inconveniente trabajar con ellos: se vuelve m√°s dif√≠cil escribir consultas, al cambiar una de las versiones, debe reindexar todo, no se pueden almacenar diferentes versiones del mismo documento en diferentes √≠ndices (¬øpor qu√© podr√≠a ser necesario?) en la siguiente secci√≥n).  Por lo tanto, desnormalizamos un documento de ECM en varios documentos de Elasticsearch con la misma tarjeta pero con cuerpos diferentes. </p><br><p>  Adem√°s de la tarjeta y el cuerpo, se agrega diversa informaci√≥n de servicio al documento de Elasticsearch, que vale la pena mencionar por separado: </p><br><ul><li>  una lista de ID de grupos y usuarios que tienen derechos sobre el documento, para b√∫squedas con derechos; </li><li>  la cantidad de llamadas al documento, para ajustar la relevancia; </li><li>  hora de la √∫ltima indexaci√≥n. </li></ul><br><h3 id="sostav-indeksov">  Composici√≥n de √≠ndice </h3><br><p>  S√≠, √≠ndices plurales.  Por lo general, se utilizan varios √≠ndices para almacenar informaci√≥n que tiene un significado similar en Elasticsearch solo si esta informaci√≥n es inmutable y est√° vinculada a alg√∫n tipo de per√≠odo de tiempo, por ejemplo, registros.  Luego, los √≠ndices se crean cada mes / d√≠a o m√°s a menudo dependiendo de la intensidad de la carga.  En nuestro caso, cualquier documento puede cambiarse y ser√≠a posible almacenar todo en un √≠ndice. </p><br><p>  Pero, los documentos en el sistema pueden estar en diferentes idiomas, y almacenar datos multiling√ºes en Elasticsearch trae 2 problemas: </p><br><ul><li>  Mal derivado.  Para algunas palabras, la base se encontrar√° correctamente, para algunos - incorrectamente (habr√° otra palabra en el √≠ndice), para algunos - no se encontrar√° en absoluto (el √≠ndice se obstruir√° con formas de palabras).  Para algunas palabras de diferentes idiomas y con diferentes significados, la base ser√° la misma y luego se perder√° el significado de la palabra.  El uso de varios stemmers en una fila puede conducir a un c√°lculo adicional de la base para uno ya calculado. </li></ul><br><blockquote>  Tartamudeo: encontrar la base de la palabra.  La ra√≠z no tiene que ser la ra√≠z de la palabra o su forma normal.  Por lo general, es suficiente que las palabras relacionadas se proyecten en un marco. <br>  La lematizaci√≥n es un tipo de derivaci√≥n en la cual la forma normal (vocabulario) de una palabra se considera la base. </blockquote><br><ul><li>  Frecuencia de palabras incorrecta.  Algunos mecanismos de determinaci√≥n de relevancia en ES tienen en cuenta la frecuencia de las palabras buscadas en el documento (cuanto m√°s frecuente, mayor es la relevancia) y la frecuencia de las palabras buscadas en el √≠ndice (cuanto m√°s frecuente, menor es la relevancia).  Entonces, una peque√±a difusi√≥n del discurso ruso en un documento en ingl√©s, cuando los documentos en ingl√©s est√°n predominantemente en el √≠ndice, tendr√° un gran peso, pero vale la pena mezclar los documentos en ingl√©s y ruso en el √≠ndice, y el peso disminuir√°. </li></ul><br><p>  El primer problema puede resolverse para el caso en que diferentes idiomas usan diferentes conjuntos de caracteres (los documentos ruso-ingleses usan letras cir√≠licas y latinas): los usuarios de idiomas solo procesar√°n "sus" caracteres. </p><br><p>  Solo para resolver el segundo problema, utilizamos el enfoque con un √≠ndice separado para cada idioma. </p><br><p>  Combinando ambos enfoques, obtenemos √≠ndices de idiomas, que sin embargo contienen analizadores para varios idiomas que no se cruzan en conjuntos de caracteres: ruso-ingl√©s (y por separado ingl√©s-ruso), polaco-ruso, alem√°n-ruso, ucraniano-ingl√©s, etc. . </p><br><p>  Para no crear todos los √≠ndices posibles por adelantado, utilizamos plantillas de √≠ndice: Elasticsearch le permite especificar una plantilla que contiene configuraciones y asignaciones, y especificar un patr√≥n de nombre de √≠ndice.  Cuando intentas indexar un documento en un √≠ndice inexistente, cuyo nombre coincide con uno de los patrones de la plantilla, no solo se crear√° un nuevo √≠ndice, sino que se aplicar√°n configuraciones y asignaciones de la plantilla correspondiente. </p><br><h3 id="struktura-indeksov">  Estructura de √≠ndice </h3><br><p>  Para la indexaci√≥n, utilizamos dos analizadores a la vez (a trav√©s de m√∫ltiples campos): predeterminado para buscar por frase exacta y personalizado para todo lo dem√°s: </p><br><pre><code class="json hljs"><span class="hljs-string"><span class="hljs-string">"ru_en_analyzer"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"filter"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"lowercase"</span></span>, <span class="hljs-string"><span class="hljs-string">"russian_morphology"</span></span>, <span class="hljs-string"><span class="hljs-string">"english_morphology"</span></span>, <span class="hljs-string"><span class="hljs-string">"word_delimiter"</span></span>, <span class="hljs-string"><span class="hljs-string">"ru_en_stopwords"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"char_filter"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"yo_filter"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"custom"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tokenizer"</span></span>: <span class="hljs-string"><span class="hljs-string">"standard"</span></span>}</code> </pre> <br><p>  Con el filtro en min√∫sculas, todo est√° claro, te contar√© sobre el resto. </p><br><p>  Los filtros ruso_morfolog√≠a e ingl√©s_morfolog√≠a est√°n destinados al an√°lisis morfol√≥gico de textos en ruso e ingl√©s, respectivamente.  No forman parte de Elasticsearch y se incluyen como parte de un complemento de an√°lisis-morfolog√≠a separado.  Estos son lematizadores que utilizan el enfoque de vocabulario en combinaci√≥n con algunas heur√≠sticas y funcionan significativamente, MUCHO, mejor que los filtros integrados para los idiomas correspondientes. </p><br><pre> <code class="json hljs">POST _analyze { <span class="hljs-attr"><span class="hljs-attr">"analyzer"</span></span>: <span class="hljs-string"><span class="hljs-string">"russian"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"text"</span></span>: <span class="hljs-string"><span class="hljs-string">"   "</span></span> } &gt;&gt;   </code> </pre> <br><p>  Y: </p><br><pre> <code class="json hljs">POST _analyze { <span class="hljs-attr"><span class="hljs-attr">"analyzer"</span></span>: <span class="hljs-string"><span class="hljs-string">"ru_en_analyzer"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"text"</span></span>: <span class="hljs-string"><span class="hljs-string">"   "</span></span> } &gt;&gt;   </code> </pre> <br><p>  Muy curioso filtro word_delimiter.  Por ejemplo, ayuda a eliminar errores tipogr√°ficos cuando no hay espacio despu√©s del punto.  Usamos la siguiente configuraci√≥n: </p><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"word_delimiter"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"catenate_all"</span></span>: <span class="hljs-string"><span class="hljs-string">"true"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"word_delimiter"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"preserve_original"</span></span>: <span class="hljs-string"><span class="hljs-string">"true"</span></span> }</code> </pre> <br><p>  yo_filter le permite ignorar la diferencia entre E y E: </p><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"yo_filter"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"mapping"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"mappings"</span></span>: [ <span class="hljs-string"><span class="hljs-string">" =&gt; "</span></span>, <span class="hljs-string"><span class="hljs-string">" =&gt; "</span></span> ] }</code> </pre> <br><p>  tipo de filtro ru_en_stopwords stop: nuestro diccionario de palabras de detenci√≥n. </p><br><h3 id="process-indeksirovaniya">  Proceso de indexaci√≥n </h3><br><p>  Los cuerpos de los documentos en ECM son, por regla general, archivos de formatos de oficina: .docx, .pdf, etc.  Para extraer texto, el complemento de ingesta de archivos adjuntos se utiliza con la siguiente tuber√≠a: </p><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"document_version"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"processors"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"attachment"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"field"</span></span>: <span class="hljs-string"><span class="hljs-string">"content"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"target_field"</span></span>: <span class="hljs-string"><span class="hljs-string">"attachment"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"properties"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"content"</span></span>, <span class="hljs-string"><span class="hljs-string">"content_length"</span></span>, <span class="hljs-string"><span class="hljs-string">"content_type"</span></span>, <span class="hljs-string"><span class="hljs-string">"language"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"indexed_chars"</span></span>: <span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ignore_failure"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> } }, { <span class="hljs-attr"><span class="hljs-attr">"remove"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"field"</span></span>: <span class="hljs-string"><span class="hljs-string">"content"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ignore_failure"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> } }, { <span class="hljs-attr"><span class="hljs-attr">"script"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"lang"</span></span>: <span class="hljs-string"><span class="hljs-string">"painless"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"params"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"languages"</span></span>: [<span class="hljs-string"><span class="hljs-string">"ru"</span></span>, <span class="hljs-string"><span class="hljs-string">"en"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"language_delimeter"</span></span>: <span class="hljs-string"><span class="hljs-string">"_"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"source"</span></span>: <span class="hljs-string"><span class="hljs-string">"..."</span></span> } }, { <span class="hljs-attr"><span class="hljs-attr">"remove"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"field"</span></span>: <span class="hljs-string"><span class="hljs-string">"attachment"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ignore_failure"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> } } ] } }</code> </pre> <br><p>  De lo inusual en la tuber√≠a, ignorar los errores de la ausencia del cuerpo (esto sucede para los documentos encriptados) y determinar el √≠ndice objetivo en funci√≥n del idioma del texto.  Este √∫ltimo se realiza en un gui√≥n indoloro, cuyo cuerpo dar√© por separado, porque  debido a restricciones JSON, tiene que escribirse en una l√≠nea.  Junto con las dificultades de depuraci√≥n (la forma recomendada es lanzar excepciones aqu√≠ y all√°), se convierte completamente en una dolorosa. </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ctx.attachment != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">params</span></span>.languages.contains(ctx.attachment.language)) ctx._index = ctx._index + <span class="hljs-keyword"><span class="hljs-keyword">params</span></span>.language_delimeter + ctx.attachment.language; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ctx.attachment.content != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) ctx.content = ctx.attachment.content; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ctx.attachment.content_length != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) ctx.content_length = ctx.attachment.content_length; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ctx.attachment.content_type != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) ctx.content_type = ctx.attachment.content_type; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ctx.attachment.language != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) ctx.language = ctx.attachment.language; }</code> </pre> <br><p>  Por lo tanto, siempre enviamos el documento a <em>index_name</em> .  Si el idioma no est√° definido o no es compatible, entonces el documento se establece en este √≠ndice, de lo contrario cae en <em>index_name_language</em> . </p><br><p>  No almacenamos el cuerpo original del archivo, pero el campo _source est√° habilitado, porque  se requiere actualizar parcialmente el documento y resaltar lo encontrado. </p><br><p>  Si solo la tarjeta ha cambiado desde la √∫ltima indexaci√≥n, entonces usamos la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">API Actualizar por consulta</a> sin canalizaci√≥n para actualizarla.  Esto permite, en primer lugar, no arrastrar cuerpos de documentos potencialmente pesados ‚Äã‚Äãdesde ECM, y en segundo lugar, acelera significativamente la actualizaci√≥n en el lado de Elasticsearch: no es necesario extraer el texto de los documentos de formatos de oficina, lo que requiere muchos recursos. </p><br><blockquote>  Como tal, no hay ninguna actualizaci√≥n del documento en Elasticsearch, t√©cnicamente, cuando se actualiza desde el √≠ndice, el documento antiguo se saca, se cambia y se indexa por completo nuevamente. </blockquote><p>  Pero si el cuerpo cambi√≥, entonces el documento antiguo generalmente se elimina e indexa desde cero.  Esto permite que los documentos se <em>muevan</em> de un √≠ndice de idioma a otro. </p><br><h2 id="poisk">  Buscar </h2><br><p>  Para facilitar la descripci√≥n, dar√© una captura de pantalla del resultado final </p><br><p><img src="https://habrastorage.org/webt/ni/l4/xm/nil4xm-qrg7meikrjbd16mt_ziq.png"></p><br><h3 id="polnotekst">  Texto completo </h3><br><p>  El tipo principal de consulta que tenemos es <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Simple Query String Query</a> : </p><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"simple_query_string"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"fields"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"card.d*.*_text"</span></span>, <span class="hljs-string"><span class="hljs-string">"card.d*.*_text.exact"</span></span>, <span class="hljs-string"><span class="hljs-string">"card.name^2"</span></span>, <span class="hljs-string"><span class="hljs-string">"card.name.exact^2"</span></span>, <span class="hljs-string"><span class="hljs-string">"content"</span></span>, <span class="hljs-string"><span class="hljs-string">"content.exact"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"query"</span></span>: <span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"default_operator"</span></span>: <span class="hljs-string"><span class="hljs-string">"or"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"analyze_wildcard"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"minimum_should_match"</span></span>: <span class="hljs-string"><span class="hljs-string">"-35%"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"quote_field_suffix"</span></span>: <span class="hljs-string"><span class="hljs-string">".exact"</span></span> }</code> </pre> <br><p>  donde <em>.exact</em> son los campos indexados por el analizador <em>predeterminado</em> .  La importancia del nombre del documento es dos veces mayor que el resto de los campos.  La combinaci√≥n de <code>"default_operator": "or"</code> y <code>"minimum_should_match": "-35%"</code> permite encontrar documentos que no contienen hasta el 35% de las palabras buscadas. </p><br><h3 id="sinonimy">  Sin√≥nimos </h3><br><p>  En general, se utilizan diferentes analizadores para indexar y buscar, pero la √∫nica diferencia en ellos es la adici√≥n de un filtro para agregar sin√≥nimos a la consulta de b√∫squeda: </p><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"search_analyzer"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"filter"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"lowercase"</span></span>, <span class="hljs-string"><span class="hljs-string">"russian_morphology"</span></span>, <span class="hljs-string"><span class="hljs-string">"english_morphology"</span></span>, <span class="hljs-string"><span class="hljs-string">"synonym_filter"</span></span>, <span class="hljs-string"><span class="hljs-string">"word_delimiter"</span></span>, <span class="hljs-string"><span class="hljs-string">"ru_en_stopwords"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"char_filter"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"yo_filter"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"tokenizer"</span></span>: <span class="hljs-string"><span class="hljs-string">"standard"</span></span> }</code> </pre> <br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"synonym_filter"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"synonym_graph"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"synonyms_path"</span></span>: <span class="hljs-string"><span class="hljs-string">"synonyms.txt"</span></span> }</code> </pre> <br><h3 id="uchyot-prav">  Derechos contables </h3><br><p>  Para las b√∫squedas basadas en derechos, la consulta principal se incrusta en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Bool Query</a> , con la adici√≥n de un filtro: </p><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"bool"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"must"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"simple_query_string"</span></span>: {...} } ], <span class="hljs-attr"><span class="hljs-attr">"filter"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"terms"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"rights"</span></span>: [           ] } } ] }</code> </pre> <br><p>  Como recordamos de la secci√≥n sobre indexaci√≥n, el √≠ndice tiene un campo con la ID de usuarios y grupos que tienen derechos sobre el documento.  Si hay una intersecci√≥n de este campo con la matriz pasada, entonces hay derechos. </p><br><h3 id="tyuning-relevantnosti">  Ajuste de relevancia </h3><br><p>  Por defecto, Elasticsearch eval√∫a la relevancia de los resultados usando el algoritmo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">BM25</a> usando la consulta y el texto del documento.  Decidimos que tres factores m√°s deber√≠an influir en la evaluaci√≥n del cumplimiento del resultado deseado y real: </p><br><ul><li>  el momento de la √∫ltima edici√≥n del documento: cuanto m√°s lejos estuvo en el pasado, menos probable es que se necesite este documento; </li><li>  la cantidad de llamadas al documento: cuanto m√°s, m√°s probable es que se necesite este documento; </li><li><p>  Las versiones del cuerpo de ECM tienen varios estados posibles: en desarrollo, operacionales y en desuso.  Es l√≥gico que la actuaci√≥n sea m√°s importante que las dem√°s. </p><br><p>  Puede lograr este efecto con la ayuda de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Function Score Query</a> : </p><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"function_score"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"functions"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"gauss"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"modified_date"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"origin"</span></span>: <span class="hljs-string"><span class="hljs-string">"now"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"scale"</span></span>: <span class="hljs-string"><span class="hljs-string">"1095d"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"offset"</span></span>: <span class="hljs-string"><span class="hljs-string">"31d"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"decay"</span></span>: <span class="hljs-number"><span class="hljs-number">0.5</span></span> } } }, { <span class="hljs-attr"><span class="hljs-attr">"field_value_factor"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"field"</span></span>: <span class="hljs-string"><span class="hljs-string">"access_count"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"missing"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"modifier"</span></span>: <span class="hljs-string"><span class="hljs-string">"log2p"</span></span> } }, { <span class="hljs-attr"><span class="hljs-attr">"filter"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"term"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"life_stage_value_id"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span> } } }, <span class="hljs-attr"><span class="hljs-attr">"weight"</span></span>: <span class="hljs-number"><span class="hljs-number">1.1</span></span> } ], <span class="hljs-attr"><span class="hljs-attr">"query"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"bool"</span></span>: {...} } }</code> </pre> <br><p>  Como resultado, ceteris paribus, obtenemos aproximadamente la siguiente dependencia del modificador de calificaci√≥n de resultados en la fecha de su √∫ltimo cambio X y el n√∫mero de visitas Y: </p><br></li></ul><br><p></p><div style="text-align:center;"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://habrastorage.org/webt/wa/wz/td/wawztd9zvlz-fetkplnfrjw8ddy.png"></a> </div><p></p><br><h3 id="vneshniy-intellekt">  Inteligencia externa </h3><br><p>  Para parte de la funcionalidad de b√∫squeda inteligente, necesitamos extraer varios <em>hechos</em> de la consulta de b√∫squeda: fechas con su aplicaci√≥n (creaci√≥n, modificaci√≥n, aprobaci√≥n, etc.), nombres de organizaciones, tipos de documentos buscados, etc. </p><br><p>  Tambi√©n es deseable clasificar la solicitud en una determinada categor√≠a, por ejemplo, documentos por organizaci√≥n, por empleado, regulatorio, etc. </p><br><p>  Estas dos operaciones son realizadas por el m√≥dulo inteligente ECM - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">DIRECTUM Ario</a> . </p><br><h3 id="process-umnogo-poiska">  Proceso de b√∫squeda inteligente </h3><br><p>  Es hora de considerar con m√°s detalle qu√© mecanismos son elementos de inteligencia implementados. </p><br><h4 id="ispravlenie-oshibok-polzovatelya">  Correcci√≥n de errores del usuario </h4><br><p>  La exactitud del dise√±o se determina en funci√≥n del modelo de lenguaje de trigrama: para una l√≠nea, se calcula la probabilidad de cumplir con sus secuencias de tres caracteres en textos en ingl√©s y ruso.  Si el dise√±o actual se considera menos probable, en primer lugar, se muestra una pista con un dise√±o correcto: </p><br><p><img src="https://habrastorage.org/webt/ek/ow/c5/ekowc5ikjiwx1xe87b5wewhoohm.png"></p><br><p>  y en segundo lugar, los pasos adicionales de la b√∫squeda se realizan con el dise√±o correcto: </p><br><p><img src="https://habrastorage.org/webt/ug/dr/tc/ugdrtchejvx024datttkc_zcxxw.png"></p><br><p>  Y si no se puede encontrar nada con el dise√±o corregido, la b√∫squeda comienza con la l√≠nea original. </p><br><p>  La correcci√≥n de errores tipogr√°ficos se implementa utilizando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Phrase Suggester</a> .  Hay un problema con esto: si ejecuta una consulta en varios √≠ndices al mismo tiempo, puede sugerir que no devuelva nada, mientras que si ejecuta solo en un √≠ndice, hay resultados.  Esto <em>se trata</em> estableciendo la confianza = 0, pero luego sugiere sugerir reemplazar las palabras con su forma normal.  De acuerdo, ser√° extra√±o cuando busque "letra <strong>a</strong> " para obtener una respuesta en el esp√≠ritu: ¬ø <em>Quiz√°s estaba buscando una carta?</em> </p><br><p>  Esto se puede eludir usando dos indicaciones en la solicitud: </p><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"suggest"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"content_suggest"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"text"</span></span>: <span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"phrase"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"collate"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"query"</span></span>: {         {{suggestion}} } }, } }, <span class="hljs-string"><span class="hljs-string">"check_suggest"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"text"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"phrase"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"collate"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"query"</span></span>: {         {{suggestion}} - ({{source_query}}) }, <span class="hljs-string"><span class="hljs-string">"params"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"source_query"</span></span>: <span class="hljs-string"><span class="hljs-string">" "</span></span> } }, } } }</code> </pre> <br><p>  De los par√°metros comunes utilizados </p><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"confidence"</span></span>: <span class="hljs-number"><span class="hljs-number">0.0</span></span>, <span class="hljs-string"><span class="hljs-string">"max_errors"</span></span>: <span class="hljs-number"><span class="hljs-number">3.0</span></span>, <span class="hljs-string"><span class="hljs-string">"size"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br><p>  Si el primer opinador devolvi√≥ el resultado, pero el segundo no lo hizo, entonces este resultado es la cadena original en s√≠, posiblemente con palabras en otras formas, y no hay necesidad de mostrar una pista.  Si a√∫n se necesita la pista, la frase de b√∫squeda original se fusiona con la pista.  Esto sucede al reemplazar solo las palabras corregidas y solo aquellas que el corrector ortogr√°fico (usando Hunspell) considera incorrectas. </p><br><p>  Si la b√∫squeda en la cadena de origen arroj√≥ 0 resultados, entonces se reemplaza por la cadena obtenida por la fusi√≥n y la b√∫squeda se realiza nuevamente: </p><br><p><img src="https://habrastorage.org/webt/up/r3/wx/upr3wxky4mkbeyy3exjocbwzocy.png"></p><br><p>  De lo contrario, la cadena de solicitud resultante se devuelve solo como una solicitud para la b√∫squeda: </p><br><p><img src="https://habrastorage.org/webt/qv/ts/4t/qvts4tauspo9yspwy_itbzcdttq.png"></p><br><h4 id="klassifikaciya-zaprosov-i-izvlechenie-faktov">  Clasificaci√≥n de consultas y extracci√≥n de hechos </h4><br><p>  Como mencion√©, usamos DIRECTUM Ario, es decir, el servicio de clasificaci√≥n de texto y el servicio de extracci√≥n de hechos.  Para hacer esto, proporcionamos a los analistas consultas de b√∫squeda an√≥nimas y una lista de hechos que nos interesan.  Sobre la base de consultas y conocimientos sobre qu√© documentos hay en el sistema, los analistas identificaron varias categor√≠as y capacitaron al servicio de clasificaci√≥n para determinar la categor√≠a de acuerdo con el texto de la consulta.  Con base en las categor√≠as resultantes y la lista de hechos, formulamos las reglas para usar estos hechos.  Por ejemplo, la frase <em><strong>del √∫ltimo a√±o</strong></em> en la categor√≠a <strong>Todos</strong> se considera la fecha de creaci√≥n del documento, y en la categor√≠a <strong>Por organizaci√≥n</strong> : la fecha de registro.  Al mismo tiempo, los <em><strong>creados el a√±o pasado</strong></em> deber√≠an, en cualquier categor√≠a, caer en la fecha de creaci√≥n. </p><br><p>  Desde el lado de la b√∫squeda, hicieron una configuraci√≥n en la que registraron las categor√≠as, qu√© hechos se aplican a qu√© filtros de facetas. </p><br><h4 id="avtodopolnenie-vvoda">  Entrada completada </h4><br><p>  Adem√°s de las correcciones de dise√±o ya mencionadas, las b√∫squedas anteriores del usuario y los documentos p√∫blicos se completan autom√°ticamente. </p><br><p><img src="https://habrastorage.org/webt/zc/52/yo/zc52yohihrkkrnny6ekla80-mro.png"></p><br><p>  Se implementan utilizando otro tipo de Suggester: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Completion Suggester</a> , pero cada uno tiene sus propios matices. </p><br><h5 id="avtodopolnenie-istoriya-poiskov">  Autocompletado: Historial de b√∫squeda </h5><br><p>  Hay muchos menos usuarios en ECM que motores de b√∫squeda, y asignan suficientes consultas comunes para ellos <del>  por qu√© hongo Lenin </del>  No es posible  Mostrar todo en una fila tampoco vale la pena debido a consideraciones de privacidad.  El Sugerencia de finalizaci√≥n habitual solo puede buscar el conjunto completo de documentos en el √≠ndice, pero <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Context Suggester</a> viene al rescate, una forma de establecer un contexto para cada pista y filtrar por estos contextos.  Si los nombres de usuario se usan como contextos, solo su historial se puede mostrar a todos. </p><br><p>  Tambi√©n debe darle al usuario la oportunidad de eliminar la solicitud por la que se averg√ºenza.  Como clave para la eliminaci√≥n, utilizamos el nombre de usuario y el texto de informaci√≥n sobre herramientas.  Como resultado, para el √≠ndice con sugerencias, obtuvimos una asignaci√≥n tan ligeramente duplicada: </p><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"mappings"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"document"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"properties"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"input"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"keyword"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"suggest"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"completion"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"analyzer"</span></span>: <span class="hljs-string"><span class="hljs-string">"simple"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"preserve_separators"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"preserve_position_increments"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_input_length"</span></span>: <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-attr"><span class="hljs-attr">"contexts"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"user"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"CATEGORY"</span></span> } ] }, <span class="hljs-attr"><span class="hljs-attr">"user"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"keyword"</span></span> } } } }</code> </pre> <br><p>  El peso para cada nueva sugerencia se establece en uno y aumenta cada vez que vuelve a ingresarlo utilizando la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">API Actualizar por consulta</a> con un script <code>ctx._source.suggest.weight++</code> muy simple. </p><br><h5 id="avtodopolnenie-dokumenty">  Autocompletado: documentos </h5><br><p>  Pero puede haber muchos documentos y posibles combinaciones de derechos.  Por lo tanto, aqu√≠, por el contrario, decidimos no filtrar por derechos cuando se completa autom√°ticamente, sino solo indexar documentos p√∫blicos.  S√≠, y no necesita eliminar consejos individuales de este √≠ndice.  Parecer√≠a que la implementaci√≥n en todo es m√°s f√°cil que la anterior, si no fuera por dos puntos: </p><br><p>  El primero: Completion Suggester solo admite la b√∫squeda de prefijos, y a los clientes les encanta asignar n√∫meros de art√≠culos a todo, y algunas <code>.01.01   </code> medida que escribe una consulta No <code>.01.01   </code> .  Aqu√≠, junto con el nombre completo, tambi√©n puede indexar n-gramos derivados de √©l: </p><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"extension"</span></span>: <span class="hljs-string"><span class="hljs-string">"pdf"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">".01.01   "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"suggest"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"input"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"weight"</span></span>: <span class="hljs-number"><span class="hljs-number">70</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"input"</span></span>: <span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"weight"</span></span>: <span class="hljs-number"><span class="hljs-number">80</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"input"</span></span>: <span class="hljs-string"><span class="hljs-string">"  "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"weight"</span></span>: <span class="hljs-number"><span class="hljs-number">90</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"input"</span></span>: <span class="hljs-string"><span class="hljs-string">".01.01   "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"weight"</span></span>: <span class="hljs-number"><span class="hljs-number">100</span></span> } ] }</code> </pre> <br><p>  Esto no fue tan cr√≠tico con la historia, sin embargo, el mismo usuario ingresa aproximadamente la misma l√≠nea si busca algo nuevamente.  <em>Probablemente</em> </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/bi/rc/dv/bircdvzu2hvcblxhrryvauzajf0.png"></div><br><p>  El segundo: de manera predeterminada, todos los consejos son iguales, pero nos gustar√≠a hacer que algunos de ellos sean m√°s iguales y preferiblemente para que sea coherente con la clasificaci√≥n de los resultados de b√∫squeda.  Para hacer esto, repita aproximadamente las funciones gauss y field_value_factor utilizadas en la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">consulta de puntuaci√≥n de funci√≥n</a> . </p><br><p>  Resulta que aqu√≠ hay una tuber√≠a as√≠: </p><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"dir_public_documents_pipeline"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"processors"</span></span>: [ ... { <span class="hljs-attr"><span class="hljs-attr">"set"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"field"</span></span>: <span class="hljs-string"><span class="hljs-string">"terms_array"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">"{{name}}"</span></span> } }, { <span class="hljs-attr"><span class="hljs-attr">"split"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"field"</span></span>: <span class="hljs-string"><span class="hljs-string">"terms_array"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"separator"</span></span>: <span class="hljs-string"><span class="hljs-string">"\\s+|$"</span></span> } }, { <span class="hljs-attr"><span class="hljs-attr">"script"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"source"</span></span>: <span class="hljs-string"><span class="hljs-string">"..."</span></span> } } ] } }</code> </pre> <br><p>  con el siguiente script: </p><br><pre> <code class="cs hljs">Date modified = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Date(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ctx.modified_date != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) modified = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SimpleDateFormat(<span class="hljs-string"><span class="hljs-string">'dd.MM.yyyy'</span></span>).parse(ctx.modified_date); <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> dayCount = (System.currentTimeMillis() - modified.getTime())/(<span class="hljs-number"><span class="hljs-number">1000</span></span>*<span class="hljs-number"><span class="hljs-number">60</span></span>*<span class="hljs-number"><span class="hljs-number">60</span></span>*<span class="hljs-number"><span class="hljs-number">24</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> score = Math.exp((<span class="hljs-number"><span class="hljs-number">-0.7</span></span>*Math.max(<span class="hljs-number"><span class="hljs-number">0</span></span>, dayCount - <span class="hljs-number"><span class="hljs-number">31</span></span>))/<span class="hljs-number"><span class="hljs-number">1095</span></span>) * Math.log10(ctx.access_count + <span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> count = ctx.terms_array.length; ctx.suggest = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList(); ctx.suggest.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>([ <span class="hljs-string"><span class="hljs-string">'input'</span></span>: ctx.terms_array[count - <span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-string"><span class="hljs-string">'weight'</span></span>: Math.round(score * (<span class="hljs-number"><span class="hljs-number">255</span></span> - count + <span class="hljs-number"><span class="hljs-number">1</span></span>)) ]); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = count - <span class="hljs-number"><span class="hljs-number">2</span></span>; i &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span> ; --i) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ctx.terms_array[i].trim() != <span class="hljs-string"><span class="hljs-string">""</span></span>) { ctx.suggest.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>([ <span class="hljs-string"><span class="hljs-string">"input"</span></span>: ctx.terms_array[i] + <span class="hljs-string"><span class="hljs-string">" "</span></span> + ctx.suggest[ctx.suggest.length - <span class="hljs-number"><span class="hljs-number">1</span></span>].input, <span class="hljs-string"><span class="hljs-string">"weight"</span></span>: Math.round(score * (<span class="hljs-number"><span class="hljs-number">255</span></span> - i))]); } } ctx.<span class="hljs-keyword"><span class="hljs-keyword">remove</span></span>(<span class="hljs-string"><span class="hljs-string">'terms_array'</span></span>); ctx.<span class="hljs-keyword"><span class="hljs-keyword">remove</span></span>(<span class="hljs-string"><span class="hljs-string">'access_count'</span></span>); ctx.<span class="hljs-keyword"><span class="hljs-keyword">remove</span></span>(<span class="hljs-string"><span class="hljs-string">'modified_date'</span></span>);</code> </pre> <br><p>  ¬øPor qu√© molestarse con una tuber√≠a indolora en lugar de escribirla en un idioma m√°s conveniente?  Porque ahora, utilizando la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">API Reindex</a> , puede adelantar el contenido de los √≠ndices de b√∫squeda en √≠ndices para obtener pistas (especificando solo los campos necesarios, por supuesto) en un solo comando. </p><br><p>  La composici√≥n de los documentos p√∫blicos realmente necesarios no se actualiza a menudo, por lo que este comando se puede dejar en un inicio manual. </p><br><h3 id="otobrazhenie-rezultatov">  Mostrar resultados </h3><br><h4 id="kategorii">  Categorias </h4><br><p>  La categor√≠a determina qu√© facetas estar√°n disponibles y c√≥mo se ver√° el fragmento.  Puede ser detectado autom√°ticamente por <em>inteligencia externa</em> o seleccionado manualmente sobre la barra de b√∫squeda. </p><br><h4 id="fasety">  Facetas </h4><br><p>  Las facetas son algo muy intuitivo para todos cuyo comportamiento, sin embargo, se describe mediante reglas muy poco triviales.  Aqu√≠ hay algunos de ellos: </p><br><ol><li><p>  Los valores de las facetas dependen de los resultados de b√∫squeda, PERO y los resultados de la b√∫squeda dependen de las facetas seleccionadas.  ¬øC√≥mo evitar la recursividad? </p><br></li><li><p>  Seleccionar valores dentro de una faceta no afecta a otros valores de esta faceta, pero s√≠ afecta a los valores en otras facetas: </p><br></li></ol><br><p><img src="https://habrastorage.org/webt/60/ei/g6/60eig601ltskcwvcesh5zno8crc.png"></p><br><ol><li>  Los valores de faceta seleccionados por el usuario no deber√≠an desaparecer, incluso si una elecci√≥n en otra faceta los <em>aniquila</em> a 0 o ya no est√°n en la parte superior: </li></ol><br><p><img src="https://habrastorage.org/webt/mu/6u/e-/mu6ue-ybxh3sa9h6ymkj1idn_ti.png"></p><br><p>  En elasticidad, las facetas se realizan a trav√©s del mecanismo de agregaci√≥n, pero para cumplir con las reglas descritas, estas agregaciones deben invertirse entre s√≠ y filtrarse entre s√≠. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/zd/jt/zu/zdjtzudyw9iei8x-tjarja-a5tm.jpeg"></div><br><p>  Considere los fragmentos de solicitud responsables de esto: </p><br><div class="spoiler">  <b class="spoiler_title">C√≥digo demasiado grande</b> <div class="spoiler_text"><pre> <code class="json hljs">{ ... <span class="hljs-attr"><span class="hljs-attr">"post_filter"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"bool"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"must"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"terms"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"card.author_value_id"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"1951063"</span></span> ] } }, { <span class="hljs-attr"><span class="hljs-attr">"terms"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"editor_value_id"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"2337706"</span></span>, <span class="hljs-string"><span class="hljs-string">"300643"</span></span> ] } } ] } }, <span class="hljs-attr"><span class="hljs-attr">"query"</span></span>: {...} <span class="hljs-string"><span class="hljs-string">"aggs"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"card.author_value_id"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"filter"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"terms"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"editor_value_id"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"2337706"</span></span>, <span class="hljs-string"><span class="hljs-string">"300643"</span></span> ] } }, <span class="hljs-attr"><span class="hljs-attr">"aggs"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"card.author_value_id"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"terms"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"field"</span></span>: <span class="hljs-string"><span class="hljs-string">"card.author_value_id"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"size"</span></span>: <span class="hljs-number"><span class="hljs-number">11</span></span>, <span class="hljs-attr"><span class="hljs-attr">"exclude"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"1951063"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"missing"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span> } }, <span class="hljs-attr"><span class="hljs-attr">"card.author_value_id_selected"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"terms"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"field"</span></span>: <span class="hljs-string"><span class="hljs-string">"card.author_value_id"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"size"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"include"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"1951063"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"missing"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span> } } } }, ... <span class="hljs-attr"><span class="hljs-attr">"editor_value_id"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"filter"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"terms"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"card.author_value_id"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"1951063"</span></span> ] } }, <span class="hljs-attr"><span class="hljs-attr">"aggs"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"editor_value_id"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"terms"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"field"</span></span>: <span class="hljs-string"><span class="hljs-string">"editor_value_id"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"size"</span></span>: <span class="hljs-number"><span class="hljs-number">11</span></span>, <span class="hljs-attr"><span class="hljs-attr">"exclude"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"2337706"</span></span>, <span class="hljs-string"><span class="hljs-string">"300643"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"missing"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span> } }, <span class="hljs-attr"><span class="hljs-attr">"editor_value_id_selected"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"terms"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"field"</span></span>: <span class="hljs-string"><span class="hljs-string">"editor_value_id"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"size"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-attr"><span class="hljs-attr">"include"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"2337706"</span></span>, <span class="hljs-string"><span class="hljs-string">"300643"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"missing"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span> } } } }, ... } }</code> </pre> </div></div><br><p>  ¬øQu√© hay aqu√≠ que: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">post_filter le</a> permite imponer una condici√≥n adicional en los resultados de una consulta ya completada y no afecta los resultados de las agregaciones.  Esa misma brecha de recursi√≥n.  Incluye todos los valores seleccionados de todas las facetas. </li><li>  agregaciones de nivel superior, en el ejemplo <em>card.author_value_id</em> y <em>editor_value_id</em> .  Cada uno tiene: <br><ul><li>  filtre por los valores de todas las dem√°s facetas, excepto la suya propia; </li><li>  agregaci√≥n anidada para valores de faceta seleccionados: <em>protecci√≥n contra la aniquilaci√≥n</em> ; </li><li>  agregaci√≥n anidada para otros valores de faceta.  Mostramos los 10 principales y solicitamos los 11 principales para determinar si se muestra el bot√≥n <strong>Mostrar todo</strong> . </li></ul></li></ul><br><h4 id="snippety">  Fragmentos </h4><br><p>  Dependiendo de la categor√≠a seleccionada, el fragmento puede verse diferente, por ejemplo, el mismo documento al buscar en una categor√≠a </p><br><p>  <strong>Todos</strong> : </p><br><p><img src="https://habrastorage.org/webt/ka/_b/ia/ka_biaaygfgbsk2msyfhu-bnkse.png"></p><br><p>  y <strong>empleados</strong> : </p><br><p><img src="https://habrastorage.org/webt/5i/po/k_/5ipok_qgkc9170ucyidespnnitc.png"></p><br><p>  O recuerde, ¬øquer√≠amos ver el tema de una oferta comercial y de qui√©n vino? </p><br><p><img src="https://habrastorage.org/webt/-i/7z/g7/-i7zg7dwh7kbs9e9_2yk3fnxc6k.png"></p><br><p>  Para no arrastrar toda la tarjeta desde el el√°stico (esto ralentiza la b√∫squeda), <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">se utiliza el filtrado de origen</a> : </p><br><pre> <code class="json hljs">{ ... <span class="hljs-attr"><span class="hljs-attr">"_source"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"includes"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"id"</span></span>, <span class="hljs-string"><span class="hljs-string">"card.name"</span></span>, <span class="hljs-string"><span class="hljs-string">"card.card_type_value_id"</span></span>, <span class="hljs-string"><span class="hljs-string">"card.life_stage_value_id"</span></span>, <span class="hljs-string"><span class="hljs-string">"extension"</span></span>, ... ] }, <span class="hljs-attr"><span class="hljs-attr">"query"</span></span>: {...} ... }</code> </pre> <br><p>  Para resaltar las palabras que se encuentran en el texto del documento, se utiliza el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">resaltador Fast Vector</a> , como generador de los fragmentos m√°s apropiados para textos grandes, y para el nombre, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">resaltador unificado</a> , como el menos exigente en recursos y estructura de √≠ndice: </p><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"highlight"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"pre_tags"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"&lt;strong&gt;"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"post_tags"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"&lt;/strong&gt;"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"encoder"</span></span>: <span class="hljs-string"><span class="hljs-string">"html"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"fields"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"card.name"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"number_of_fragments"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"content"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"fragment_size"</span></span>: <span class="hljs-number"><span class="hljs-number">300</span></span>, <span class="hljs-attr"><span class="hljs-attr">"number_of_fragments"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"fvh"</span></span> } } },</code> </pre> <br><p>  En este caso, el nombre se resalta en su totalidad, y del texto obtenemos hasta 3 fragmentos de 300 caracteres de longitud.  El texto devuelto por el resaltador Fast Vector se comprime a√∫n m√°s mediante un algoritmo improvisado para obtener un estado de fragmento minimizado. </p><br><h3 id="kollaps">  Colapso </h3><br><p>  Hist√≥ricamente, los usuarios de este ECM est√°n acostumbrados al hecho de que la b√∫squeda les devuelve <em>documentos</em> , pero de hecho Elasticsearch busca entre <em>versiones de documentos</em> .  Puede resultar que se encuentren varias versiones casi id√©nticas en la misma consulta.  Esto saturar√° los resultados y confundir√° al usuario.  Afortunadamente, este comportamiento puede evitarse utilizando el mecanismo de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">colapso de campo</a> , una versi√≥n ligera de agregaciones que ya funciona en los resultados finales (en esto se parece a post_filter, <em>dos muletas son un par</em> ).  El <em>colapso</em> dar√° como resultado el objeto de colapso m√°s relevante. </p><br><pre> <code class="json hljs">{ ... <span class="hljs-attr"><span class="hljs-attr">"query"</span></span>: {...} ... <span class="hljs-string"><span class="hljs-string">"collapse"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"field"</span></span>: <span class="hljs-string"><span class="hljs-string">"id"</span></span> } }</code> </pre> <br><p>  Desafortunadamente, el colapso tiene una serie de efectos desagradables, por ejemplo, varias caracter√≠sticas num√©ricas del resultado de la b√∫squeda contin√∫an regresando como si no hubiera colapso.  Es decir, el n√∫mero de resultados, el n√∫mero de valores de faceta: todos ser√°n <em>ligeramente</em> incorrectos, pero el usuario generalmente no se da cuenta de esto, al igual que el lector cansado, que es poco probable que haya le√≠do esta propuesta antes. </p><br><p>  El final </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/460263/">https://habr.com/ru/post/460263/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../460253/index.html">10 razones para hacer tu habilidad para asistente de voz</a></li>
<li><a href="../460255/index.html">Backdoor on Node.js: por qu√©, por qu√© y c√≥mo funciona</a></li>
<li><a href="../460257/index.html">Hola mundo Inmersi√≥n profunda en terminales</a></li>
<li><a href="../460259/index.html">¬øQu√© es el dise√±o de UI y UX? ¬øQu√© es com√∫n y diferente?</a></li>
<li><a href="../460261/index.html">Amazon: 25 a√±os de √©xito de comercio electr√≥nico</a></li>
<li><a href="../460265/index.html">Crear una plantilla de proyecto Xcode</a></li>
<li><a href="../460273/index.html">Autorizaci√≥n en Apple Pay para los m√°s peque√±os</a></li>
<li><a href="../460275/index.html">¬øPor qu√© no necesitas la soluci√≥n perfecta?</a></li>
<li><a href="../460279/index.html">Contrato de 10 mil millones: ¬øqui√©n se ocupar√° de la nube para el Pent√°gono?</a></li>
<li><a href="../460281/index.html">C√≥mo UX Writer ayuda a mejorar el producto</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>