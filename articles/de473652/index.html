<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚úñÔ∏è üê§ üòø Erstellen einer REST-API mit Node.js und einer Oracle-Datenbank. Teil 5 üçç üîã üõÄüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Teil 5. Erstellen einer REST-API: Paginierung, manuelle Sortierung und Filterung 

 Im vorherigen Artikel haben Sie die Kernfunktionalit√§t der CRUD-AP...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Erstellen einer REST-API mit Node.js und einer Oracle-Datenbank. Teil 5</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/473652/"> <b>Teil 5. Erstellen einer REST-API: Paginierung, manuelle Sortierung und Filterung</b> <br><br>  Im <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">vorherigen Artikel haben</a> Sie die Kernfunktionalit√§t der CRUD-API erstellt. <br><br>  Wenn jetzt eine HTTP-GET-Anforderung auf der Mitarbeiterroute ausgegeben wird, werden alle Zeilen der Tabelle zur√ºckgegeben.  Dies mag bei nur 107 Zeilen in der Tabelle HR.EMPLOYEES nicht viel ausmachen, aber stellen Sie sich vor, was passieren w√ºrde, wenn die Tabelle Tausende oder Millionen von Zeilen enth√§lt.  Clients wie Mobil- und Webanwendungen zeigen normalerweise nur einen Bruchteil der in der Datenbank verf√ºgbaren Zeilen an und w√§hlen dann bei Bedarf weitere Zeilen aus - m√∂glicherweise, wenn der Benutzer bei einer Unterbrechungssteuerung nach unten scrollt oder auf die Schaltfl√§che ‚ÄûWeiter‚Äú klickt zu Seiten in der Benutzeroberfl√§che. <br><br>  Zu diesem Zweck m√ºssen REST-APIs Paginierungswerkzeuge f√ºr zur√ºckgegebene Ergebnisse unterst√ºtzen.  Sobald die Paginierung unterst√ºtzt wird, sind Sortierfunktionen erforderlich, da Daten normalerweise sortiert werden sollten, bevor die Paginierung angewendet wird.  Dar√ºber hinaus ist das Datenfilter-Tool f√ºr die Leistung sehr wichtig.  Warum Daten aus der Datenbank √ºber die Zwischenschicht und vollst√§ndig an den Client senden, wenn dies nicht erforderlich ist? <br><a name="habracut"></a><br>  Ich werde die URL-Abfragezeichenfolgenparameter verwenden, damit Clients angeben k√∂nnen, wie die Ergebnisse paginiert, sortiert und gefiltert werden sollen.  Wie immer bei der Programmierung kann die Implementierung abh√§ngig von Ihren Anforderungen, Leistungszielen usw. variieren. In diesem Beitrag werde ich Ihnen einen manuellen Ansatz zum Hinzuf√ºgen dieser Funktionen zur API erl√§utern. <br><br>  <b>Paginierung</b> <br><br>  Abfragezeichenfolgenparameter, die ich f√ºr die Paginierung verwenden werde: √úberspringen und Begrenzen.  Der Parameter skip wird verwendet, um die angegebene Anzahl von Zeilen zu √ºberspringen, w√§hrend limit die Anzahl der zur√ºckgegebenen Zeilen begrenzt.  Ich werde den Standardwert 30 f√ºr das Limit verwenden, wenn der Client den Wert nicht angibt. <br><br>  Aktualisieren Sie zun√§chst die Controller-Logik, um Werte aus der Abfragezeichenfolge zu extrahieren und an die Datenbank-API zu √ºbergeben.  √ñffnen Sie die Datei <b>controller / employee.js</b> und f√ºgen Sie der Funktion get nach der Zeile, in der der Parameter req.params.id analysiert wird, die folgenden Codezeilen hinzu. <br><br><pre><code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// *** line that parses req.params.id is here *** context.skip = parseInt(req.query.skip, 10); context.limit = parseInt(req.query.limit, 10);</span></span></code> </pre> <br>  Jetzt m√ºssen Sie die Datenbanklogik aktualisieren, um diese Werte zu ber√ºcksichtigen, und die SQL-Abfrage entsprechend aktualisieren.  In SQL wird die Offset-Klausel zum √úberspringen von Zeilen und die Abrufklausel zum Begrenzen der Anzahl der von der Abfrage zur√ºckgegebenen Zeilen verwendet.  Wie √ºblich werden Werte nicht direkt zur Abfrage hinzugef√ºgt, sondern aus Leistungs- und Sicherheitsgr√ºnden als Bindevariablen hinzugef√ºgt.  √ñffnen Sie <b>db_apis / employee.js</b> und f√ºgen Sie nach dem if-Block in der <b>Suchfunktion</b> den folgenden Code hinzu, der der Anforderung die where-Klausel hinzuf√ºgt. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// *** if block that appends where clause ends here *** if (context.skip) { binds.row_offset = context.skip; query += '\noffset :row_offset rows'; } const limit = (context.limit &gt; 0) ? context.limit : 30; binds.row_limit = limit; query += '\nfetch next :row_limit rows only';</span></span></code> </pre> <br>  Das ist alles was Sie tun m√ºssen, um zu paginieren!  Starten Sie die API und f√ºhren Sie dann einige URL-Befehle in einem anderen Terminal aus, um sie zu testen.  Hier sind einige Beispiele, die Sie verwenden k√∂nnen: <br><br><pre> <code class="javascript hljs"># use <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> limit (<span class="hljs-number"><span class="hljs-number">30</span></span>) curl <span class="hljs-string"><span class="hljs-string">"http://localhost:3000/api/employees"</span></span> # set limit to <span class="hljs-number"><span class="hljs-number">5</span></span> curl <span class="hljs-string"><span class="hljs-string">"http://localhost:3000/api/employees?limit=5"</span></span> # use <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> limit and set skip to <span class="hljs-number"><span class="hljs-number">5</span></span> curl <span class="hljs-string"><span class="hljs-string">"http://localhost:3000/api/employees?skip=5"</span></span> # set both skip and limit to <span class="hljs-number"><span class="hljs-number">5</span></span> curl <span class="hljs-string"><span class="hljs-string">"http://localhost:3000/api/employees?skip=5&amp;limit=5"</span></span></code> </pre> <br>  <b>Sortieren</b> <br><br>  Kunden sollten mindestens in der Lage sein, eine Spalte zum Sortieren und Sortieren anzugeben (aufsteigend oder absteigend).  Der einfachste Weg, dies zu tun, besteht darin, einen Abfrageparameter zu definieren (ich verwende sort), mit dem Sie eine Zeichenfolge wie 'Nachname: Aufstieg' oder 'Gehalt: Abstieg' √ºbergeben k√∂nnen.  Die einzige M√∂glichkeit, die Reihenfolge der von der SQL-Abfrage zur√ºckgegebenen Ergebnismenge zu gew√§hrleisten, besteht darin, die order by-Klausel einzuschlie√üen.  Aus diesem Grund w√§re es sch√∂n, eine Standardauftragsdefinition zu definieren, um die Konsistenz sicherzustellen, wenn der Client sie nicht angibt. <br><br>  Gehen Sie zur√ºck zu <b>controller / employee.js</b> und f√ºgen Sie der get-Funktion nach der Zeile, in der der Parameter req.query.limit analysiert wird, die folgende Codezeile hinzu. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// *** line that parses req.query.limit is here *** context.sort = req.query.sort;</span></span></code> </pre> <br>  √ñffnen <b>Sie</b> dann <b>db_apis / employee.js</b> und f√ºgen Sie die folgende Zeile unter den Zeilen hinzu, die baseQuery deklarieren und initialisieren. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// *** lines that initalize baseQuery end here *** const sortableColumns = ['id', 'last_name', 'email', 'hire_date', 'salary'];</span></span></code> </pre> <br>  sortableColumns ist eine Whitelist mit Spalten, mit denen Kunden sortieren k√∂nnen.  F√ºgen Sie dann in der Suchfunktion den folgenden if-Block hinzu, der die order by-Klausel hinzuf√ºgt.  Dies muss nach dem Hinzuf√ºgen der where-Klausel, jedoch vor den Offset- und Fetch-Klauseln erfolgen. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// *** if block that appends where clause ends here *** if (context.sort === undefined) { query += '\norder by last_name asc'; } else { let [column, order] = context.sort.split(':'); if (!sortableColumns.includes(column)) { throw new Error('Invalid "sort" column'); } if (order === undefined) { order = 'asc'; } if (order !== 'asc' &amp;&amp; order !== 'desc') { throw new Error('Invalid "sort" order'); } query += `\norder by "${column}" ${order}`; }</span></span></code> </pre> <br>  Der erste Teil des if-Blocks pr√ºft, ob der Client den Sortierwert √ºbergeben hat.  Wenn nicht, wird der SQL-Abfrage die Standardreihenfolge nach Klausel hinzugef√ºgt, die in aufsteigender Reihenfolge nach Nachname sortiert wird.  Wenn ein Sortierwert angegeben wird, wird dieser zuerst in Spalten- und Auftragswerte aufgeteilt, und jeder Wert wird √ºberpr√ºft, bevor der Abfrage eine Reihenfolge hinzugef√ºgt wird. <br><br>  Jetzt k√∂nnen Sie mehrere URL-Befehle ausf√ºhren, um sie zu √ºberpr√ºfen.  Hier einige Beispiele zum Ausprobieren: <br><br><pre> <code class="javascript hljs"># use <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> sort (last_name asc) curl <span class="hljs-string"><span class="hljs-string">"http://localhost:3000/api/employees"</span></span> # sort by id and use <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> direction (asc) curl <span class="hljs-string"><span class="hljs-string">"http://localhost:3000/api/employees?sort=id"</span></span> # sort by hire_date desc curl <span class="hljs-string"><span class="hljs-string">"http://localhost:3000/api/employees?sort=hire_date:desc"</span></span> # use sort <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> limit and skip together curl <span class="hljs-string"><span class="hljs-string">"http://localhost:3000/api/employees?limit=5&amp;skip=5&amp;sort=salary:desc"</span></span> # should <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> an error because first_name is not whitelisted curl <span class="hljs-string"><span class="hljs-string">"http://localhost:3000/api/employees?sort=first_name:desc"</span></span> # should <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> an error because <span class="hljs-string"><span class="hljs-string">'other'</span></span> is not a valid order curl <span class="hljs-string"><span class="hljs-string">"http://localhost:3000/api/employees?sort=last_name:other"</span></span></code> </pre> <br>  Die letzten beiden Beispiele sollten Ausnahmen ausl√∂sen, da sie Werte enthalten, die nicht f√ºr die Whitelist erstellt wurden.  Es verwendet den Standard-Express-Fehlerhandler, sodass der Fehler als HTML-Webseite zur√ºckgegeben wird. <br><br>  <b>Filtern</b> <br><br>  Die F√§higkeit, Daten zu filtern, ist eine wichtige Funktion, die alle REST-APIs bereitstellen m√ºssen.  Wie beim Sortieren kann die Implementierung einfach oder komplex sein, je nachdem, was Sie unterst√ºtzen m√∂chten.  Am einfachsten ist es, Unterst√ºtzung f√ºr Filter mit vollst√§ndiger √úbereinstimmung hinzuzuf√ºgen (z. B. Nachname = Doe).  Komplexere Implementierungen k√∂nnen Unterst√ºtzung f√ºr grundlegende Operatoren (z. B. &lt;,&gt;, Instr usw. usw.) und komplexe logische Operatoren (z. B. und / oder) hinzuf√ºgen, die mehrere Filter zusammenfassen k√∂nnen. <br><br>  In diesem Beitrag werde ich versuchen, die Situation zu vereinfachen und Filterunterst√ºtzung f√ºr nur zwei Spalten hinzuzuf√ºgen: department_id und manager_id.  F√ºr jede Spalte werde ich den entsprechenden Parameter in der Abfragezeichenfolge aktivieren.  Die Datenbanklogik, die die where-Klausel hinzuf√ºgt, wenn GET-Anforderungen mit einem einzelnen Mitarbeiter an den Endpunkt gesendet werden, muss aktualisiert werden, um diese neuen Filter zu ber√ºcksichtigen. <br><br>  √ñffnen Sie <b>controller / employee.js</b> und f√ºgen Sie die folgenden Zeilen unter der Zeile hinzu, in der der Wert req.query.sort in der Funktion get analysiert wird. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// *** line that parses req.query.sort is here *** context.department_id = parseInt(req.query.department_id, 10); context.manager_id = parseInt(req.query.manager_id, 10);</span></span></code> </pre> <br>  Bearbeiten <b>Sie</b> dann <b>db_apis / employee.js</b> , um der <b>Basisabfrage</b> den Satz 1 = 1 hinzuzuf√ºgen, wie unten gezeigt. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> baseQuery = <span class="hljs-string"><span class="hljs-string">`select employee_id "id", first_name "first_name", last_name "last_name", email "email", phone_number "phone_number", hire_date "hire_date", job_id "job_id", salary "salary", commission_pct "commission_pct", manager_id "manager_id", department_id "department_id" from employees where 1 = 1`</span></span>;</code> </pre> <br>  Nat√ºrlich ist 1 = 1 immer wahr, daher ignoriert der Optimierer es einfach.  Diese Methode wird jedoch in Zukunft das Hinzuf√ºgen zus√§tzlicher Pr√§dikate vereinfachen. <br><br>  Ersetzen Sie in der Suchfunktion den if-Block, der beim √úbergeben von context.id die where-Klausel hinzuf√ºgt, durch die folgenden Zeilen. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// *** line that declares 'binds' is here *** if (context.id) { binds.employee_id = context.id; query += '\nand employee_id = :employee_id'; } if (context.department_id) { binds.department_id = context.department_id; query += '\nand department_id = :department_id'; } if (context.manager_id) { binds.manager_id = context.manager_id; query += '\nand manager_id = :manager_id'; }</span></span></code> </pre> <br>  Wie Sie sehen k√∂nnen, f√ºgt jeder if-Block einfach den an das binds-Objekt √ºbergebenen Wert hinzu und f√ºgt dann das entsprechende Pr√§dikat zur where-Klausel hinzu.  Speichern Sie die √Ñnderungen und starten Sie die API neu.  Verwenden Sie dann diese URL-Befehle, um dies zu √ºberpr√ºfen: <br><br><pre> <code class="javascript hljs"># filter where department_id = <span class="hljs-number"><span class="hljs-number">90</span></span> (returns <span class="hljs-number"><span class="hljs-number">3</span></span> employees) curl <span class="hljs-string"><span class="hljs-string">"http://localhost:3000/api/employees?department_id=90"</span></span> # filter where manager_id = <span class="hljs-number"><span class="hljs-number">100</span></span> (returns <span class="hljs-number"><span class="hljs-number">14</span></span> employees) curl <span class="hljs-string"><span class="hljs-string">"http://localhost:3000/api/employees?manager_id=100"</span></span> # filter where department_id = <span class="hljs-number"><span class="hljs-number">90</span></span> and manager_id = <span class="hljs-number"><span class="hljs-number">100</span></span> (returns <span class="hljs-number"><span class="hljs-number">2</span></span> employees) curl <span class="hljs-string"><span class="hljs-string">"http://localhost:3000/api/employees?department_id=90&amp;manager_id=100"</span></span></code> </pre> <br>  Das war's - die API unterst√ºtzt jetzt Paginierung, Sortierung und Filterung!  Ein manueller Ansatz bietet viel Kontrolle, erfordert jedoch viel Code.  Die Suchfunktion hat jetzt 58 Zeilen und unterst√ºtzt nur eingeschr√§nkte Sortier- und Filterfunktionen.  Sie k√∂nnen ein Modul wie den <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Knex.js-</a> Abfrage- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Generator verwenden</a> , um diese Vorg√§nge zu vereinfachen. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de473652/">https://habr.com/ru/post/de473652/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de473638/index.html">Shader ist keine Magie. Shader in Unity schreiben. Einleitung</a></li>
<li><a href="../de473640/index.html">Big Data Sonnenuntergang</a></li>
<li><a href="../de473642/index.html">Cribble Crabble Gradle: Magie automatisch aufbauen</a></li>
<li><a href="../de473646/index.html">Hackathon in einer kleinen Firma: Wie man arrangiert, ohne einen Zug von Ressourcen zu entsorgen</a></li>
<li><a href="../de473648/index.html">Das Pferd ist totschrei: √úbergang von Tslint zu Eslint</a></li>
<li><a href="../de473654/index.html">PHP Composer: Korrigieren Sie Abh√§ngigkeiten ohne Schmerzen</a></li>
<li><a href="../de473656/index.html">Hugo Static Site Generator Erfahrung</a></li>
<li><a href="../de473658/index.html">Umgang mit Fehlern in Go 1.13</a></li>
<li><a href="../de473660/index.html">Arcade Reverse Engineering: Nehmen Sie Michael Jordan bei NBA Jam auf</a></li>
<li><a href="../de473664/index.html">Lernerfahrung aus erster Hand. Yandex.Practicum - Datenanalyst</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>