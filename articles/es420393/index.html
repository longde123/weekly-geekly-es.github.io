<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üéê üíÜ üßû PHP, YII2 y la formaci√≥n de grandes archivos de Excel üë®‚Äç‚ù§Ô∏è‚Äçüë® üêª üÜñ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Inicio 
 Un sistema de contabilidad e informes respaldado por nuestra empresa comenz√≥ a crecer muy r√°pidamente en la cantidad de datos almacenados. El...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>PHP, YII2 y la formaci√≥n de grandes archivos de Excel</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/420393/"><h3>  Inicio </h3><br>  Un sistema de contabilidad e informes respaldado por nuestra empresa comenz√≥ a crecer muy r√°pidamente en la cantidad de datos almacenados.  El sistema est√° escrito en PHP usando el marco Yii2.  Inicialmente, los informes se crearon a trav√©s de la biblioteca PhpSpreadsheet, que reemplaz√≥ al obsoleto obsoleto, PhpExcel. <br><br>  Entre los diferentes tipos de informes, hab√≠a uno muy grande; de ‚Äã‚Äãhecho, el conjunto completo de todos los datos almacenados en la base de datos deber√≠a cargarse en una tabla de Excel.  En la etapa inicial, no hubo problemas, pero cuando el volumen comenz√≥ a exceder muchos cientos de miles de registros, el script de formaci√≥n de descarga comenz√≥ a caerse en el l√≠mite de tiempo de espera. <a name="habracut"></a>  Para empezar, aumentamos este l√≠mite y comenzamos a buscar formas de resolver el problema.  Pero una soluci√≥n temporal no dur√≥ mucho: el problema con el l√≠mite de tiempo se convirti√≥ en un problema con el l√≠mite de memoria.  Lanzaron la "RAM" al servidor y eliminaron el l√≠mite de memoria para esta operaci√≥n en particular.  Muy pronto, los usuarios comenzaron a quejarse de los errores de tiempo de ejecuci√≥n nuevamente.  Tuve que eliminar el l√≠mite de tiempo para el informe completo.  Pero sentarse y mirar una docena de minutos en la pantalla con un indicador de carga no es muy divertido.  Adem√°s, a veces se necesitaba un informe "aqu√≠ y ahora", y cada minuto dedicado a su formaci√≥n result√≥ ser cr√≠tico.  Los experimentos con la configuraci√≥n del entorno se detuvieron, se rascaron la parte posterior de la cabeza y comenzaron a optimizar el c√≥digo. <br><br><h3>  Busca una soluci√≥n </h3><br>  Lo primero que se hizo fue colocar el script de informes en el proceso en segundo plano y el usuario supervisa el progreso a trav√©s de la "barra de progreso".  La ejecuci√≥n del trabajo en segundo plano se implement√≥ a trav√©s del mecanismo de cola usando Redis para el almacenamiento.  El trabajo en el sistema no se detiene, puede realizar otras tareas y regresar peri√≥dicamente a la p√°gina del informe para ver si el archivo est√° listo.  Tan pronto como se forma el archivo, se le ofrece al usuario un enlace de descarga.  Pero, como se mencion√≥ anteriormente, a veces el archivo fue requerido "inmediatamente", y el aumento de la usabilidad no resolvi√≥ este problema.  Mientras tanto, la cantidad de datos continu√≥ creciendo y el tiempo que tom√≥ construir el archivo lleg√≥ a 79 minutos.  Esto es completamente inaceptable, especialmente teniendo en cuenta que los informes son uno de los fundamentos de la funcionalidad de este sistema.  No, todas las otras partes funcionaron como un reloj, pero esta mosca en la pomada ech√≥ a perder la impresi√≥n general. <br><br><h3>  Primeros resultados </h3><br>  Nos sentamos nuevamente para el an√°lisis de c√≥digo.  Lo primero que se prob√≥ fue el proceso de selecci√≥n de datos de la base de datos.  Pero las consultas ya se han optimizado de la mejor manera posible.  Aunque la solicitud m√°s larga fue una muestra terrible con cinco o seis llamadas a la monstruosa FIAS, funcion√≥ en 2-5 segundos.  El punto d√©bil no era √©l, sino la formaci√≥n del archivo "exelnik".  Los intentos han comenzado a optimizar este proceso.  Comenzando desde el almacenamiento en cach√© en redis, hasta perversiones, como la formaci√≥n de peque√±os "sobresalientes" separados en flujos paralelos, seguidos de pegar en un archivo.  Pero el resultado siempre fue el mismo: el problema con el tiempo se convirti√≥ en un problema con la memoria y viceversa.  No hab√≠a t√©rmino medio, solo flu√≠a de un extremo a otro.  Despu√©s de una cierta cantidad de datos, el consumo de recursos de la biblioteca comenz√≥ a crecer exponencialmente y no fue posible derrotarlo.  PhpSpreadsheet: no es adecuado para archivos grandes.  Como resultado, se decidi√≥ cambiar la biblioteca.  Como opci√≥n, escribir su propio an√°logo para la formaci√≥n de ex archivos. <br><br><h3>  An√°lisis y selecci√≥n de herramientas. </h3><br>  No se apresuraron a escribir bicicletas, pero para empezar, analizaron las soluciones existentes.  De las posibles opciones, solo la caja / boquilla era de inter√©s.  Reescribi√≥ r√°pidamente el m√≥dulo utilizando esta biblioteca.  Como resultado, se obtuvo un informe completo en 145 segundos.  Perm√≠tame recordarle que las √∫ltimas pruebas con PhpSpreadsheet son 79 minutos, ¬°y aqu√≠ 2.5 minutos!  Pruebas realizadas: aument√≥ la cantidad de datos en 2 veces.  El informe se gener√≥ en 172 segundos.  La diferencia es asombrosa.  Por supuesto, la biblioteca no tiene las mismas funciones que PhpSpreadsheet, pero en este caso el conjunto m√≠nimo de herramientas es suficiente, ya que la velocidad es cr√≠tica. <br><br><h3>  Extensi√≥n para Yii2 </h3><br>  La decisi√≥n final fue enmarcada como una extensi√≥n para Yii2.  Tal vez alguien sea √∫til.  La extensi√≥n le permite cargar cualquier conjunto de datos desde GridView para sobresalir mientras mantiene el filtrado y la clasificaci√≥n.  Utiliza yii / queue y box / spout como dependencias.  Tiene sentido usar la extensi√≥n para formar archivos realmente grandes, bueno, al menos 50,000 l√≠neas =) Por el momento, el m√≥dulo, que se ha convertido en la base de la extensi√≥n, hace frente a una carga de casi 600,000 l√≠neas. <br><br>  Enlace a github: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">extensi√≥n Yii2 ExcelReport</a> <br><br>  Gracias por su atencion! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es420393/">https://habr.com/ru/post/es420393/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es420383/index.html">"Yandex.Money no le interesa ingresar su solicitud".</a></li>
<li><a href="../es420385/index.html">Pruebas de integraci√≥n basadas en contenedores.</a></li>
<li><a href="../es420387/index.html">Tres cubos inteligentes de Rubik: Xiaomi, Roobo y GoCube</a></li>
<li><a href="../es420389/index.html">Implementaci√≥n del patr√≥n "Observador-Suscriptor" utilizando devoluciones de llamada JNI en Android (NDK)</a></li>
<li><a href="../es420391/index.html">Salarios de TI a mediados de 2018</a></li>
<li><a href="../es420395/index.html">Tabletas "gratis" para prisioneros, nada gratis</a></li>
<li><a href="../es420397/index.html">Los cient√≠ficos han encontrado una manera de revertir el proceso de envejecimiento de las c√©lulas</a></li>
<li><a href="../es420405/index.html">Investigando el proceso de ventas de TI</a></li>
<li><a href="../es420407/index.html">C no es un lenguaje de bajo nivel</a></li>
<li><a href="../es420409/index.html">Aprende OpenGL. Lecci√≥n 5.7 - HDR</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>