<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚òéÔ∏è üéÅ üèûÔ∏è √âcrire un client Telegram est facile üèÖ üõ•Ô∏è üèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Quelle est la diff√©rence entre Telegram et d'autres messagers populaires? Il est ouvert! 
 D'autres messagers ont √©galement une API, mais pour une rai...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>√âcrire un client Telegram est facile</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/424245/"><p><img src="https://habrastorage.org/webt/74/05/en/7405endgngr3x59c7slog56gha0.png"></p><br><p>  Quelle est la diff√©rence entre Telegram et d'autres messagers populaires?  Il est ouvert! <br>  D'autres messagers ont √©galement une API, mais pour une raison quelconque, le t√©l√©gramme est-il connu comme le plus ouvert des plus populaires? </p><br><p>  Pour commencer, Telegram a un client vraiment totalement ouvert <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">code</a> .  Malheureusement, nous ne voyons pas de commit tous les jours directement sur GitHub, mais nous avons un code sous une licence ouverte.  L'architecture Telegram implique que Bot et API ont presque les m√™mes m√©thodes - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://core.telegram.org/methods</a> . </p><br><p>  En fait, Telegram n'est pas seulement un messager de chat, mais une plate-forme sociale, dont l'acc√®s est ouvert √† toutes sortes d'applications.  Ils peuvent fournir des puces suppl√©mentaires aux utilisateurs, au lieu d'utiliser un r√©seau pr√™t √† l'emploi d'utilisateurs et de serveurs pour la livraison des messages.  Cela semble si attrayant que nous voulions essayer d'√©crire notre ¬´client¬ª pour Telegrams. </p><a name="habracut"></a><br><h3 id="sut-prilozheniya">  L'essence de l'application </h3><br><p>  Nous traitons principalement des cartes et de la navigation, nous avons donc imm√©diatement examin√© quelque chose li√© √† la g√©olocalisation.  J'ai vraiment aim√© que dans Telegram, avant toutes les autres applications, il y avait un moyen pratique de partager votre position en temps r√©el ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://telegram.org/blog/live-locations</a> ) et je l'utilise souvent: aidez-moi √† m'orienter, montrer mon chemin et la chose la plus importante est de r√©pondre √† la question principale "Quand serez-vous?".  En principe, cela suffit pour la plupart des gens, mais comme toujours, il existe des sc√©narios o√π de simples opportunit√©s ne suffisent pas.  Par exemple, il peut s'agir d'un groupe de plus de 10 personnes, avec diff√©rents appareils (certains appareils peuvent ne pas √™tre des t√©l√©phones) et des personnes diff√©rentes.  Il serait commode pour ces personnes d'√©changer des messages en groupe, ainsi que de se voir se d√©placer sur une carte. </p><br><p>  Nous nous sommes concentr√©s sur la t√¢che de cr√©er de la valeur suppl√©mentaire pour Telegram, et de ne pas essayer de l'utiliser √† d'autres fins.  Nous ne voulions pas que les gens qui n'avaient pas de client Telegram sp√©cial voient un d√©sordre de messages dans le chat ou quelque chose d'inintelligible.  Les personnes avec un client "am√©lior√©" ont des opportunit√©s suppl√©mentaires, par exemple: </p><br><ol><li>  Gestion du temps plus fine lors de l'envoi de sites en temps r√©el pour discuter. </li><li>  Affichez l'emplacement des contacts sur la carte. </li><li>  Connexion au chat des appareils balises via une API externe (Bot). </li></ol><br><h3 id="kak-my-eto-delali">  Comment l'avons-nous fait </h3><br><p>  Heureusement, tout le code que nous √©crivons est Open-Source, donc je peux imm√©diatement donner un lien vers son impl√©mentation - <a href="">Bot</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Implementation</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Telegram Client Implementation sur Kotlin</a> . </p><br><h5 id="bot---osnovy">  Bot - les bases </h5><br><p>  Il y a beaucoup de documentation et d'exemples sur l'impl√©mentation de Bot, mais je veux quand m√™me passer en revue certains des pi√®ges.  Pour commencer, nous avons √©crit c√¥t√© serveur <br>  √† Java et a choisi la biblioth√®que org.telegram: telegrambots.  Comme notre serveur est un SpringBoot r√©gulier, l'initialisation est extr√™mement simple: </p><br><pre><code class="hljs coffeescript"><span class="hljs-regexp"><span class="hljs-regexp">//</span></span> Gradle implementation <span class="hljs-string"><span class="hljs-string">"org.telegram:telegrambots:3.6"</span></span> TelegramBotsApi telegramBotsApi = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TelegramBotsApi(); telegramBotsApi.registerBot(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TelegramLongPollingBot() {...});</code> </pre> <br><p>  La principale caract√©ristique du transfert de position est qu'il doit √™tre mis √† jour fr√©quemment et que le bot doit modifier les messages d√©j√† envoy√©s.  S'il n'y avait pas une telle opportunit√©, Bot ne ferait que spammer le chat et bien s√ªr, ce serait Epic Fail.  Dieu merci, Telegram donne au bot le droit de modifier les messages pendant 24 heures (minimum, √©ventuellement plus). </p><br><p>  Il existe plusieurs fa√ßons d'envoyer un message.  Il existe des types Texte brut, Lieu, Emplacement, Jeu, Contact, Facture, etc.  Il semblait que l'emplacement √©tait parfait pour notre t√¢che, mais une caract√©ristique d√©sagr√©able a √©t√© r√©v√©l√©e.  La position ne peut √™tre transf√©r√©e que d'un appareil √† un seul compte ou bot √† la fois!  Imaginez que vous avez 2 t√©l√©phones et √† partir de deux t√©l√©phones, vous avez envoy√© votre position dans un chat.  Ainsi, une erreur se produira sur le serveur et le premier partage de position s'arr√™tera simplement.  Il semblerait que ce soit clairement un cas neuronal, mais imaginez que vous avez beaucoup de balises chinoises qui peuvent envoyer Location √† une URL donn√©e, mais elles ne peuvent pas envoyer directement √† Telegram.  Vous √©crivez Bot, qui d√©croche sur le serveur et envoie des t√©l√©grammes.  C'est l√† o√π il ressort que Bot ne sera pas en mesure d'envoyer plus d'un message de balise avec le type d'emplacement.  Il s'av√®re que cela est id√©al pour l'envoi unique, mais ne convient pas pour Live Location. </p><br><p>  La solution est simple: envoyez des messages texte et le client analysera le texte et affichera les emplacements sur la carte.  Malheureusement, seuls les messages texte seront visibles dans le client Telegram standard, mais vous pouvez y ins√©rer un lien pour ouvrir la carte. </p><br><h5 id="bot---podvodnye-kamni">  Bot - Pi√®ges </h5><br><p>  Malheureusement, Bot a d√ª r√©√©crire jusqu'√† 2,5 fois.  Le principal probl√®me est la mauvaise conception de la communication. </p><br><ol><li>  Pour une raison quelconque, au d√©but, cela semblait √™tre une bonne id√©e si le bot serait un participant √† part enti√®re au chat et enverrait des messages.  Mais, c'est mauvais √† la fois en termes de confidentialit√© de la correspondance et en termes d'interaction avec le bot.  La bonne d√©cision, utilisez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">les robots en ligne</a> .  Ainsi, il est garanti que le bot ne voit rien d'autre que son emplacement et qu'il peut √™tre utilis√© dans n'importe quel chat.  Humainement parlant, il n'est pas culturel de faire glisser votre bot dans une sorte de chat g√©n√©ral, mais vous devez parler au bot un √† un et le configurer, puis il pourra envoyer les messages n√©cessaires √† n'importe quel chat s√©lectionn√©. </li><li>  Il existe historiquement 2 types d'interaction dans l'API Telegram Message: les boutons sous le texte ((boutons en ligne) [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://core.telegram.org/bots/2-0-intro#switch-to-inline-buttons</a> ]) et les r√©ponses au bot directement texte.  En g√©n√©ral, les r√©ponses avec le bot sont d√©sesp√©r√©ment d√©pass√©es.  Les boutons sont un peu plus compliqu√©s du point de vue de la mise en ≈ìuvre, mais cela est enti√®rement pay√© par la facilit√© d'utilisation et ils devraient √™tre utilis√©s pour toutes les entr√©es non textuelles. </li><li>  Comme exemple de bot, vous pouvez voir le populaire @vote_bot ou notre @osmand_bot. </li></ol><br><h5 id="telegram-client">  Client Telegram </h5><br><p>  Nous n'avons pas pu trouver d'exemples de client de t√©l√©gramme pr√™t √† l'emploi, √† l'exception du client principal, mais la structure tdlib assez simple nous a aid√©s √† cr√©er un client de base en quelques jours seulement. </p><br><div class="spoiler">  <b class="spoiler_title">Configuration Gradle:</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">task downloadTdLibzip { doLast { ant.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(src: <span class="hljs-string"><span class="hljs-string">'https://core.telegram.org/tdlib/tdlib.zip'</span></span>, dest: <span class="hljs-string"><span class="hljs-string">'tdlib.zip'</span></span>, skipexisting: <span class="hljs-string"><span class="hljs-string">'true'</span></span>) ant.unzip(src: <span class="hljs-string"><span class="hljs-string">'tdlib.zip'</span></span>, dest: <span class="hljs-string"><span class="hljs-string">'tdlib/'</span></span>) } } task copyNativeLibs(<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">Copy</span></span>) { dependsOn downloadTdLibzip <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> "tdlib/libtd/src/main/libs" <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> "libs" } task copyJavaSources(<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">Copy</span></span>) { dependsOn downloadTdLibzip <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> "tdlib/libtd/src/main/java/org/drinkless/td" <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> "src/org/drinkless/td" } dependencies { implementation fileTree(dir: <span class="hljs-string"><span class="hljs-string">'libs'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">include</span></span>: [<span class="hljs-string"><span class="hljs-string">'*.jar'</span></span>]) }</code> </pre> </div></div><br><p>  Presque tous les √©l√©ments internes du Telegram sont √©crits en C ++ et du point de vue d'Android, seule la classe API est visible sur les m√©thodes proxy de 1,5 Mo <a href="">TdApi.java</a> .  En comparant la documentation des bots et le nom des m√©thodes, vous pouvez simplement d√©terminer o√π vous d√©placer. </p><br><div class="spoiler">  <b class="spoiler_title">Initialisation client avec gestionnaire global:</b> <div class="spoiler_text"><pre> <code class="hljs kotlin"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (libraryLoaded) { <span class="hljs-comment"><span class="hljs-comment">// create client client = Client.create(UpdatesHandler(), null, null) true } else { false } }</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Demande de photo d'utilisateur:</b> <div class="spoiler_text"><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">requestUserPhoto</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(user: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">TdApi</span></span></span></span><span class="hljs-function"><span class="hljs-params">.</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">User</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> remotePhoto = user.profilePhoto?.small?.remote <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (remotePhoto != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; remotePhoto.id.isNotEmpty()) { downloadUserFilesMap[remotePhoto.id] = user client!!.send(TdApi.GetRemoteFile(remotePhoto.id, <span class="hljs-literal"><span class="hljs-literal">null</span></span>)) { obj -&gt; <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> (obj.<span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>) { TdApi.Error.CONSTRUCTOR -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> error = obj <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> TdApi.Error <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> code = error.code <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (code != IGNORED_ERROR_CODE) { listener?.onTelegramError(code, error.message) } } TdApi.File.CONSTRUCTOR -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> file = obj <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> TdApi.File client!!.send(TdApi.DownloadFile(file.id, <span class="hljs-number"><span class="hljs-number">10</span></span>), defaultHandler) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> -&gt; listener?.onTelegramError(-<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"Receive wrong response from TDLib: </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$obj</span></span></span><span class="hljs-string">"</span></span>) } } } }</code> </pre> </div></div><br><h5 id="telegram-client---podvodnye-kamni">  Telegram Client - pi√®ges </h5><br><ol><li>  Inscription / Connexion et D√©connexion.  Lors de l'inscription, il est n√©cessaire de prendre en compte diff√©rents sc√©narios: lorsque le code d'acc√®s est envoy√© par SMS ou √† un autre client t√©l√©gramme, autorisation √† deux facteurs, etc.  Le plus grand d√©fi est le test.  Toute autorisation plus de 3 fois a conduit au blocage du compte pendant 24 heures, donc tester la d√©connexion √©tait particuli√®rement amusant.  Bien que l'enregistrement ne soit n√©cessaire qu'une seule fois, c'est probablement la partie la plus difficile de l'int√©gration. </li><li>  D√©terminez comment et dans quel ordre lire les messages.  Tout client a acc√®s √† tous les messages de toutes les discussions, mais ils doivent √™tre lus de mani√®re s√©quentielle.  Dans notre cas, 99% des messages doivent √™tre √©limin√©s.  Tout d'abord, pour une raison quelconque, nous avons lu tous les messages des 3 derniers jours avec une connexion, mais plus tard, cela n'a caus√© que des probl√®mes et lorsque nous avons red√©marr√©, les messages ont disparu.  Par cons√©quent, maintenant nous lisons uniquement les nouveaux messages, et pour les messages dont nous avons besoin, nous enregistrons l'identifiant dans la base de donn√©es interne. </li></ol><br><h3 id="chto-poluchilos">  Qu'est-il arriv√©? </h3><br><p>  Probablement, connaissant tous les pi√®ges, on pourrait tout faire plusieurs fois plus vite, mais cela s'est av√©r√© environ 1-2 mois pour trois personnes.  L'application finale se trouve sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Google Play</a> . </p><br><p><img src="https://habrastorage.org/webt/gf/o0/zs/gfo0zsgavbn09pkswyzurjoibik.png"></p><br><p>  La principale question dans cette histoire est de savoir comment cette interaction est correcte du point de vue du t√©l√©gramme et si les utilisateurs aiment ce type d'int√©gration.  En tout cas, l'id√©e elle-m√™me est une niche et elle a d√©j√† trouv√© des clients individuels. </p><br><p>  Je me ferai un plaisir de r√©pondre √† vos questions. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr424245/">https://habr.com/ru/post/fr424245/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr424235/index.html">Comment utiliser STATSPACK au lieu d'AWR dans Oracle Standard Edition</a></li>
<li><a href="../fr424237/index.html">Chargez votre cerveau directement! Runtimes, compilateurs et performances au Joker 2018</a></li>
<li><a href="../fr424239/index.html">S√©minaires d'automne IBM - Conteneurs, vision par ordinateur, transformation num√©rique</a></li>
<li><a href="../fr424241/index.html">Imprimez votre monde</a></li>
<li><a href="../fr424243/index.html">5 fa√ßons simples d'am√©liorer la communication avec les clients</a></li>
<li><a href="../fr424247/index.html">KotlinConf 2018 Live - regardez l'√©mission du 4 au 5 octobre</a></li>
<li><a href="../fr424249/index.html">Mat√©riel de la r√©union #RuPostgres - vid√©os, pr√©sentations, analyse du quiz et reportage photo</a></li>
<li><a href="../fr424251/index.html">Nous consid√©rons les statistiques sur les exp√©riences sur hh.ru</a></li>
<li><a href="../fr424255/index.html">Comment utiliser correctement l'analyse statique</a></li>
<li><a href="../fr424257/index.html">Cartes hexagonales dans Unity: parties 1 √† 3</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>