<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üïô üëâüèæ üñºÔ∏è Django bajo microscopio üë©üèø‚Äçüéì üöé ü•Ä</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Si, seg√∫n el informe de Artyom Malyshev ( prueba 404 ), har√°n una pel√≠cula, entonces el director ser√° Quentin Tarantino; ya ha hecho una pel√≠cula sobr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Django bajo microscopio</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/433482/">  Si, seg√∫n el informe de Artyom Malyshev ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">prueba 404</a> ), har√°n una pel√≠cula, entonces el director ser√° Quentin Tarantino; ya ha hecho una pel√≠cula sobre Django, tambi√©n filmar√° la segunda.  Todos los detalles de la vida de los mecanismos internos de Django desde el primer byte de la solicitud HTTP hasta el √∫ltimo byte de la respuesta.  Extravaganza de formas de an√°lisis, compilaci√≥n de SQL llena de acci√≥n, efectos especiales de la implementaci√≥n del motor de plantillas para HTML.  ¬øQui√©n administra el grupo de conexiones y c√≥mo?  Todo esto en orden cronol√≥gico de procesamiento de objetos WSGI.  En todas las pantallas del pa√≠s - la decodificaci√≥n "Django bajo microscopio". <br><br><img src="https://habrastorage.org/webt/np/fq/rq/npfqrqbbgfwn2lktbgdq9h4xhgg.jpeg"><br><br>  <strong>Sobre el orador: Artyom Malyshev</strong> es el fundador del proyecto Dry Python y el desarrollador principal de Django Channels versi√≥n 1.0.  Ha estado escribiendo Python durante 5 a√±os y ha ayudado a organizar reuniones de Python Rannts en Nizhny Novgorod.  Artyom puede estar familiarizado con el apodo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">PROOFIT404</a> .  La presentaci√≥n del informe se almacena <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> . <br><a name="habracut"></a><br><iframe width="560" height="315" src="https://www.youtube.com/embed/AvGl7Vi2yT4" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  √ârase una vez, lanzamos la versi√≥n anterior de Django.  Luego se ve√≠a aterradora y triste. <br><br><img src="https://habrastorage.org/webt/yv/i5/a9/yvi5a9ueicvuhwgsyf8npzvojne.jpeg"><br><br>  Vieron que <code>self_check</code> pas√≥, instalamos todo correctamente, todo funcion√≥ y ahora puedes escribir c√≥digo.  Para lograr todo esto, tuvimos que ejecutar el <code>django-admin runserver</code> . <br><br><pre> <code class="plaintext hljs">$ django-admin runserver Performing system checks‚Ä¶ System check identified no issues (0 silenced). You have unapplied migrations; your app may not work properly until they are applied. Run 'python manage.py migrate1 to apply them. August 21, 2018 - 15:50:53 Django version 2.1, using settings 'mysite.settings' Starting development server at http://127.0.0.1:8000/Quit the server with CONTROL-C.</code> </pre><br>  El proceso comienza, procesa las solicitudes HTTP y toda la magia ocurre dentro y se ejecuta todo el c√≥digo que queremos mostrar a los usuarios como sitio. <br><br><h2>  Instalaci√≥n <br></h2><br>  <code>django-admin</code> aparece en el sistema cuando instalamos Django usando, por ejemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">pip, el administrador de paquetes</a> . <br><br><pre> <code class="python hljs">$ pip install Django <span class="hljs-comment"><span class="hljs-comment"># setup.py from setuptools import find_packages, setup setup( name='Django', entry_points={ 'console_scripts': [ 'django-admin = django.core.management:execute_from_command_line' ] }, )</span></span></code> </pre><br>  Aparece <code>entry_points setuptools</code> , que apunta a la funci√≥n <code>execute_from_command_line</code> .  Esta funci√≥n es un punto de entrada para cualquier operaci√≥n con Django, para cualquier proceso actual. <br><br><h3>  Bootstrap <br></h3><br>  ¬øQu√© pasa dentro de una funci√≥n?  <strong>Bootstrap</strong> , que se divide en dos iteraciones. <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.core.management django.setup().</span></span></code> </pre><br><h4>  Configurar ajustes <br></h4><br>  El primero es <strong>leer configuraciones</strong> : <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> django.conf.global_settings import_module(os.environ[<span class="hljs-string"><span class="hljs-string">"DJANGO_SETTINGS_MODULE"</span></span>])</code> </pre><br>  La configuraci√≥n predeterminada <code>global_settings</code> , luego, desde la variable de entorno, intentamos encontrar el m√≥dulo con <code>DJANGO_SETTINGS_MODULE</code> , que escribi√≥ el usuario.  Estas configuraciones se combinan en un espacio de nombre. <br><br>  Cualquiera que escriba en Django al menos "Hola, mundo" sabe que hay <code>INSTALLED_APPS</code> , donde escribimos el c√≥digo de usuario. <br><br><h4>  Completar aplicaciones <br></h4><br>  En la segunda parte, todas estas aplicaciones, esencialmente paquetes, se repiten una por una.  Creamos para cada configuraci√≥n, importamos modelos para trabajar con una base de datos y verificamos la integridad de los modelos.  Adem√°s, el marco ejecuta <code>Check</code> , es decir, comprueba que cada modelo tiene una clave primaria, todas las claves externas apuntan a campos existentes y que el campo Nulo no est√° escrito en BooleanField, sino que se utiliza NullBooleanField. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> entry <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> settings.INSTALLED_APPS: cfg = AppConfig.create(entry) cfg.import_models()</code> </pre><br>  Esta es la verificaci√≥n de sanidad m√≠nima para modelos, para el panel de administraci√≥n, para cualquier cosa, sin conectarse a la base de datos, sin algo s√∫per complicado y espec√≠fico.  En esta etapa, Django a√∫n no sabe qu√© comando solicit√≥ ejecutar, es decir, no distingue la <code>migrate</code> de <code>runserver</code> o <code>shell</code> . <br><br>  Luego nos encontramos en un m√≥dulo que intenta adivinar mediante los argumentos de la l√≠nea de comandos qu√© comando queremos ejecutar y en qu√© aplicaci√≥n se encuentra. <br><br><h2>  Comando de gesti√≥n <br></h2><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.core.management subcommand = sys.argv[1] app_name = find(pkgutils.iter_modules(settings.INSTALLED_APPS)) module = import_module( '%s.management.commands.%s' % (app_name, subcommand) ) cmd = module.Command() cmd.run_from_argv(self.argv)</span></span></code> </pre><br>  En este caso, el m√≥dulo runserver tendr√° un m√≥dulo <code>django.core.management.commands.runserver</code> .  Despu√©s de importar el m√≥dulo, por convenci√≥n, la clase global <code>Command</code> se llama dentro, se instancia, y decimos: " <em>Te encontr√©, aqu√≠ tienes los argumentos de la l√≠nea de comando que el usuario pas√≥, haz algo con ellos</em> ". <br><br>  A continuaci√≥n, vamos al m√≥dulo runserver y vemos que <b>Django est√° hecho de "</b> expresiones regulares <b>y palos"</b> , sobre lo que hablar√© en detalle hoy: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.core.management.commands.runserver naiveip_re = re.compile(r"""^(?: (?P&lt;addr&gt; (?P&lt;ipv4&gt;\d{1,3}(?:\.\d{1,3}){3}) | # IPv4 address (?P&lt;ipv6&gt;\[[a-fA-F0-9:]+\]) | # IPv6 address (?P&lt;fqdn&gt;[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*) # FQDN ):)?(?P&lt;port&gt;\d+)$""", re.X)</span></span></code> </pre><br><h3>  Comandos <br></h3><br>  Despl√°cese hacia abajo una pantalla y media; finalmente llegamos a la definici√≥n de nuestro equipo que inicia el servidor. <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.core.management.commands.runserver class Command(BaseCommand): def handle(self, *args, **options): httpd = WSGIServer(*args, **options) handler = WSGIHandler() httpd.set_app(handler) httpd.serve_forever()</span></span></code> </pre><br>  <code>BaseCommand</code> realiza un conjunto m√≠nimo de operaciones para que los argumentos de la l√≠nea de comandos <code>BaseCommand</code> como resultado argumentos para llamar a las funciones de <code>**options</code> <code>*args</code> y <code>**options</code> .  Vemos que la instancia del servidor WSGI se est√° creando aqu√≠, el WSGIHandler global est√° instalado en este servidor WSGI, esto es exactamente <strong>God Object Django</strong> .  Podemos decir que esta es la √∫nica instancia del marco.  La instancia se instala en el servidor globalmente, a trav√©s de la <code>set application</code> y dice: "Girar en el bucle de eventos, ejecutar solicitudes". <br><br><blockquote>  Siempre hay un Event Loop en alguna parte y un programador que le asigna tareas. <br></blockquote><br><h2>  Servidor WSGI <br></h2><br>  ¬øQu√© es <strong>WSGIHandler</strong> ?  WSGI es una interfaz que le permite procesar solicitudes HTTP con un nivel m√≠nimo de abstracci√≥n, y se ve como algo en forma de una funci√≥n. <br><br><h3>  Controlador WSGI <br></h3><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.core.handlers.wsgi class WSGIHandler: def __call__(self, environ, start_response): signals.request_started.send() request = WSGIRequest(environ) response = self.get_response(request) start_response(response.status, response.headers) return response</span></span></code> </pre><br>  Por ejemplo, aqu√≠ es una instancia de una clase que tiene una <code>call</code> definida.  Espera su entrada de diccionario, en la que los encabezados se presentar√°n como bytes y un controlador de archivos.  Se necesita un controlador para leer el <code>&lt;body&gt;</code> la solicitud.  El servidor en s√≠ tambi√©n proporciona callback <code>start_response</code> para que podamos enviar <code>response.headers</code> y su encabezado, por ejemplo, estado, en un paquete. <br><br>  Adem√°s, podemos pasar el cuerpo de respuesta al servidor a trav√©s del objeto de respuesta.  <strong>La respuesta</strong> es un generador sobre el que puedes iterar. <br><br>  Todos los servidores que est√°n escritos para WSGI: Gunicorn, uWSGI, Waitress, funcionan en esta interfaz y son intercambiables.  Ahora estamos considerando un servidor para el desarrollo, pero cualquier servidor llega al punto de que en Django golpea el entorno y la devoluci√≥n de llamada. <br><br><h2>  ¬øQu√© hay dentro de Dios Objeto? <br></h2><br>  ¬øQu√© sucede dentro de esta funci√≥n global de Dios Objeto dentro de Django? <br><br><ul><li>  SOLICITUD </li><li>  MIDDLEWARES. </li><li>  Enrutamiento solicitud para ver. </li><li>  VISTA - procesamiento de c√≥digo de usuario dentro de la vista. </li><li>  FORMULARIO - trabajar con formularios. </li><li>  ORM </li><li>  PLANTILLA </li><li>  RESPUESTA </li></ul><br>  Toda la maquinaria que queremos de Django se lleva a cabo dentro de una sola funci√≥n, que se extiende por todo el marco. <br><br><h3>  Solicitud <br></h3><br>  Envolvemos el entorno WSGI, que es un diccionario simple, en alg√∫n objeto especial, para la conveniencia de trabajar con el entorno.  Por ejemplo, es m√°s conveniente averiguar la longitud de una solicitud de usuario trabajando con algo similar a un diccionario que con una cadena de bytes que debe analizarse y buscar entradas de valor clave en ella.  Cuando trabajo con cookies, tampoco quiero calcular manualmente si el per√≠odo de almacenamiento ha expirado o no, y de alguna manera interpretarlo. <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.core.handlers.wsgi class WSGIRequest(HttpRequest): @cached_property def GET(self): return QueryDict(self.environ['QUERY_STRING']) @property def POST(self): self._load_post_and_files() return self._post @cached_property def COOKIES(self): return parse_cookie(self.environ['HTTP_COOKIE'])</span></span></code> </pre><br>  La solicitud contiene analizadores, as√≠ como un conjunto de controladores para controlar el procesamiento del cuerpo de la solicitud POST: ya sea un archivo en la memoria o temporal en el almacenamiento en el disco.  Todo se decide dentro de la Solicitud.  Request en Django tambi√©n es un objeto agregador en el que todos los middlewares pueden poner la informaci√≥n que necesitamos sobre la sesi√≥n, la autenticaci√≥n y la autorizaci√≥n del usuario.  Podemos decir que este tambi√©n es un Objeto de Dios, pero m√°s peque√±o. <br><br>  Solicitud adicional llega al middleware. <br><br><h3>  Middlewares <br></h3><br>  <strong>El middleware</strong> es un contenedor que envuelve otras funciones como un decorador.  Antes de renunciar al control del middleware, en el m√©todo de llamada damos una respuesta o llamamos a un middleware ya envuelto. <br><br>  As√≠ es como se ve el middleware desde el punto de vista de un programador. <br><br><h4>  Configuraciones <br></h4><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># settings.py MIDDLEWARE = [ 'django.middleware.security.SecurityMiddleware', 'django.middleware.csrf.CsrfViewMiddleware', 'django.contrib.sessions.middleware.SessionMiddleware', 'django.contrib.auth.middleware.AuthenticationMiddleware', ]</span></span></code> </pre><br><h4>  Definir <br></h4><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Middleware</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, get_response=None)</span></span></span><span class="hljs-function">:</span></span> self.get_response = get_response <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__call__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, request)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.get_response(request)</code> </pre><br>  Desde el punto de vista de Django, los middlewares parecen una especie de pila: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.core.handlers.base def load_middleware(self): handler = convert_exception_to_response(self._get_response) for middleware_path in reversed(settings.MIDDLEWARE): middleware = import_string(middleware_path) instance = middleware(handler) handler = convert_exception_to_response(instance) self._middleware_chain = handler</span></span></code> </pre><br><h4>  Aplicar <br></h4><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_response</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, request)</span></span></span><span class="hljs-function">:</span></span> set_urlconf(settings.ROOT_URLCONF) response = self._middleware_chain(request) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> response</code> </pre><br>  Tomamos la funci√≥n <code>get_response</code> inicial, la <code>get_response</code> en un controlador, que traducir√°, por ejemplo, <code>permission error</code> y <code>permission error</code> <code>not found error</code> al c√≥digo HTTP correcto.  Envolvemos todo en el middleware de la lista.  La pila de middlewares crece, y cada siguiente envuelve la anterior.  Esto es muy similar a aplicar la misma pila de decoradores a todas las vistas en un proyecto, solo de manera centralizada.  No es necesario ir y organizar los envoltorios con las manos de acuerdo con el proyecto, todo es conveniente y l√≥gico. <br><br>  Revisamos 7 c√≠rculos de middlewares, nuestra solicitud sobrevivi√≥ y decidimos procesarla a la vista.  Luego llegamos al m√≥dulo de enrutamiento. <br><br><h3>  Enrutamiento <br></h3><br>  Aqu√≠ es donde decidimos a qu√© controlador llamar para una solicitud en particular.  Y esto est√° resuelto: <br><br><ul><li>  basado en url; </li><li>  en la especificaci√≥n WSGI, donde se llama a request.path_info. </li></ul><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.core.handlers.base def _get_response(self, request): resolver = get_resolver() view, args, kwargs = resolver.resolve(request.path_info) response = view(request, *args, **kwargs) return response</span></span></code> </pre><br><h4>  Urls <br></h4><br>  Tomamos el resolutor, lo alimentamos con la url de solicitud actual y esperamos que devuelva la funci√≥n de vista en s√≠, y de la misma url obtenemos los argumentos con los que llamar a view.  Luego, <code>get_response</code> llama a la vista, maneja las excepciones y hace algo con ella. <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># urls.py urlpatterns = [ path('articles/2003/', views.special_case_2003), path('articles/&lt;int:year&gt;/', views.year_archive), path('articles/&lt;int:year&gt;/&lt;int:month&gt;/', views.month_archive) ]</span></span></code> </pre><br><h4>  Resolver <br></h4><br>  As√≠ es como se ve el resolutor: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.urls.resolvers _PATH_RE = re.compile( r'&lt;(?:(?P&lt;converter&gt;[^&gt;:]+):)?(?P&lt;parameter&gt;\w+)&gt;' ) def resolve(self, path): for pattern in self.url_patterns: match = pattern.search(path) if match: return ResolverMatch( self.resolve(match[0]) ) raise Resolver404({'path': path})</span></span></code> </pre><br>  Esto tambi√©n es regexp, pero recursivo.  Va en partes de la url, busca lo que el usuario quiere: otros usuarios, publicaciones, blogs, o es alg√∫n tipo de convertidor, por ejemplo, un a√±o espec√≠fico que necesita ser resuelto, puesto en argumentos, enviado a int. <br><br>  Es caracter√≠stico que la profundidad de recursi√≥n del m√©todo de resoluci√≥n sea siempre igual al n√∫mero de argumentos con los que se llama la vista.  Si algo sali√≥ mal y no encontramos una URL espec√≠fica, se produce un error no encontrado. <br><br>  Entonces finalmente llegamos a la vista: el c√≥digo que escribi√≥ el programador. <br><br><h3>  Vista <br></h3><br>  En su representaci√≥n m√°s simple, esta es una funci√≥n que devuelve la solicitud de la respuesta, pero dentro de ella realizamos tareas l√≥gicas: "para, si, alg√∫n d√≠a" - muchas tareas repetitivas.  Django nos proporciona una vista basada en la clase en la que puede especificar detalles espec√≠ficos, y todo el comportamiento ser√° interpretado en el formato correcto por la clase misma. <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.views.generic.edit class ContactView(FormView): template_name = 'contact.html' form_class = ContactForm success_url = '/thanks/'</span></span></code> </pre><br><h4>  Diagrama de flujo del m√©todo <br></h4><br><pre> <code class="python hljs">self.dispatch() self.post() self.get_form() self.form_valid() self.render_to_response()</code> </pre><br>  El m√©todo de <code>dispatch</code> de esta instancia ya est√° en la asignaci√≥n de URL en lugar de una funci√≥n.  El env√≠o basado en el verbo HTTP comprende qu√© m√©todo llamar: POST vino a nosotros y lo m√°s probable es que queramos crear una instancia del objeto de formulario, si el formulario es v√°lido, gu√°rdelo en la base de datos y muestre la plantilla.  Todo esto se hace a trav√©s de la gran cantidad de mixins que componen esta clase. <br><br><h3>  Forma <br></h3><br>  El formulario debe leerse desde el socket antes de que entre en la vista de Django, a trav√©s del mismo controlador de archivos que se encuentra en el entorno WSGI.  form-data es un flujo de bytes, en el que se describen los separadores: podemos leer estos bloques y hacer algo con ellos.  Puede ser una correspondencia clave-valor, si es un campo, parte de un archivo, luego nuevamente alg√∫n campo: todo est√° mezclado. <br><br><pre> <code class="python hljs">Content-Type: multipart/form-data;boundary=<span class="hljs-string"><span class="hljs-string">"boundary"</span></span> --boundary name=<span class="hljs-string"><span class="hljs-string">"field1"</span></span> value1 --boundary name=<span class="hljs-string"><span class="hljs-string">"field2"</span></span>; value2</code> </pre><br><h4>  Analizador <br></h4><br>  El analizador consta de 3 partes. <br><br>  El iterador de fragmentos que crea las lecturas esperadas de la secuencia de bytes se convierte en un iterador que puede producir <code>boundaries</code> .  Garantiza que si algo vuelve, ser√° un l√≠mite.  Esto es necesario para que dentro del analizador no sea necesario almacenar el estado de la conexi√≥n, leer desde el socket o no leer para minimizar la l√≥gica del procesamiento de datos. <br><br>  A continuaci√≥n, el generador se ajusta en <strong>LazyStream</strong> , que nuevamente crea un archivo objeto a partir de √©l, pero con la lectura esperada.  Por lo tanto, el analizador ya puede recorrer pedazos de bytes y construir un valor-clave a partir de ellos. <br><br>  <strong>El campo y los datos aqu√≠ siempre ser√°n cadenas</strong> .  Si recibimos un tiempo de datos en formato ISO, el formulario Django (que fue escrito por el programador) recibir√°, utilizando ciertos campos, por ejemplo, marca de tiempo. <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.http.multipartparser self._post = QueryDict(mutable=True) stream = LazyStream(ChunkIter(self._input_data)) for field, data in Parser(stream): self._post.append(field, force_text(data))</span></span></code> </pre><br>  Adem√°s, el formulario, muy probablemente, quiere guardarse en una base de datos, y aqu√≠ comienza Django ORM. <br><br><h3>  ORM <br></h3><br>  Aproximadamente a trav√©s de tales solicitudes DSL para ORM se ejecutan: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># models.py Entry.objects.exclude( pub_date__gt=date(2005, 1, 3), headline='Hello', )</span></span></code> </pre><br>  Usando claves, puede recopilar expresiones SQL similares: <br><br><pre> <code class="python hljs">SELECT * WHERE NOT (pub_date &gt; <span class="hljs-string"><span class="hljs-string">'2005-1-3'</span></span> AND headline = <span class="hljs-string"><span class="hljs-string">'Hello'</span></span>)</code> </pre><br>  ¬øC√≥mo va esto? <br><br><h4>  Conjunto de consultas <br></h4><br>  El m√©todo de <code>exclude</code> tiene un objeto <code>Query</code> debajo del cap√≥.  El objeto se pasa argumentos a la funci√≥n, y crea una jerarqu√≠a de objetos, cada uno de los cuales puede convertirse en una parte separada de la consulta SQL como una cadena. <br><br>  Al atravesar el √°rbol, cada una de las secciones sondea sus nodos secundarios, recibe consultas SQL anidadas y, como resultado, podemos construir SQL como una cadena.  Por ejemplo, el valor-clave no ser√° un campo SQL separado, sino que se comparar√° con el valor-valor.  La concatenaci√≥n y la denegaci√≥n de consultas funcionan de la misma manera que un recorrido de √°rbol recursivo, para cada nodo del que se llama una conversi√≥n a SQL. <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.db.models.query sql.Query(Entry).where.add( ~Q( Q(F('pub_date') &gt; date(2005, 1, 3)) &amp; Q(headline='Hello') ) )</span></span></code> </pre><br><h4>  Compilador <br></h4><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.db.models.expressions class Q(tree.Node): AND = 'AND' OR = 'OR' def as_sql(self, compiler, connection): return self.template % self.field.get_lookup('gt')</span></span></code> </pre><br><h3>  Salida <br></h3><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>Q(headline=<span class="hljs-string"><span class="hljs-string">'Hello'</span></span>) <span class="hljs-comment"><span class="hljs-comment"># headline = 'Hello' &gt;&gt;&gt; F('pub_date') # pub_date &gt;&gt;&gt; F('pub_date') &gt; date(2005, 1, 3) # pub_date &gt; '2005-1-3' &gt;&gt;&gt; Q(...) &amp; Q(...) # ... AND ... &gt;&gt;&gt; ~Q(...) # NOT ‚Ä¶</span></span></code> </pre><br>  Se pasa un peque√±o compilador auxiliar a este m√©todo, que puede distinguir el dialecto de MySQL de PostgreSQL y organizar correctamente el az√∫car sint√°ctico que se usa en el dialecto de una base de datos particular. <br><br><h3>  Enrutamiento de base de datos <br></h3><br>  Cuando recibimos la consulta SQL, el modelo toca el enrutamiento de la base de datos y pregunta en qu√© base de datos se encuentra.  En el 99% de los casos, ser√° la base de datos predeterminada, en el 1% restante, algo propio. <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.db.utils class ConnectionRouter: def db_for_read(self, model, **hints): if model._meta.app_label == 'auth': return 'auth_db'</span></span></code> </pre><br>  Al envolver un controlador de base de datos desde una interfaz de biblioteca espec√≠fica, como Python MySQL o Psycopg2, se crea un objeto universal con el que Django puede trabajar.  Hay un contenedor para cursores, un contenedor para transacciones. <br><br><h4>  Piscina de conexi√≥n <br></h4><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.db.backends.base.base class BaseDatabaseWrapper: def commit(self): self.validate_thread_sharing() self.validate_no_atomic_block() with self.wrap_database_errors: return self.connection.commit()</span></span></code> </pre><br>  En esta conexi√≥n en particular, enviamos solicitudes al socket que est√° golpeando la base de datos y esperamos su ejecuci√≥n.  El contenedor sobre la biblioteca leer√° la respuesta humana de la base de datos en forma de registro, y Django recopila la instancia del modelo de estos datos en tipos de Python.  Esta no es una iteraci√≥n complicada. <br><br>  Escribimos algo en la base de datos, le√≠mos algo y decidimos informarle al usuario al respecto mediante la p√°gina HTML.  Para hacer esto, Django tiene un lenguaje de plantilla que no le gusta a la comunidad que se parece a un lenguaje de programaci√≥n, solo en un archivo HTML. <br><br><h3>  Plantilla <br></h3><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.template.loader <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> render_to_string render_to_string(<span class="hljs-string"><span class="hljs-string">'my_template.html'</span></span>, {<span class="hljs-string"><span class="hljs-string">'entries'</span></span>: ...})</code> </pre><br><h4>  C√≥digo <br></h4><br><pre> <code class="python hljs">&lt;ul&gt; {% <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> entry <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> entries %} &lt;li&gt;{{ entry.name }}&lt;/li&gt; {% endfor %} &lt;/ul&gt;</code> </pre><br><h4>  Analizador <br></h4><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.template.base BLOCK_TAG_START = '{%' BLOCK_TAG_END = '%}' VARIABLE_TAG_START = '{{' VARIABLE_TAG_END = '}}' COMMENT_TAG_START = '{#' COMMENT_TAG_END = '#}' tag_re = (re.compile('(%s.*?%s|%s.*?%s|%s.*?%s)' % (re.escape(BLOCK_TAG_START), re.escape(BLOCK_TAG_END), re.escape(VARIABLE_TAG_START), re.escape(VARIABLE_TAG_END), re.escape(COMMENT_TAG_START), re.escape(COMMENT_TAG_END))))</span></span></code> </pre><br>  Sorpresa - regexp de nuevo.  Solo al final debe haber una coma, y ‚Äã‚Äãla lista ir√° muy abajo.  Esta es probablemente la expresi√≥n regular m√°s dif√≠cil que he visto en este proyecto. <br><br><h3>  Lexer <br></h3><br>  El manejador de plantillas y el int√©rprete son bastante simples.  Hay un lexer que usa regexp para traducir texto en una lista de peque√±os tokens. <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.template.base def tokenize(self): for bit in tag_re.split(template_string): lineno += bit.count('\n') yield bit</span></span></code> </pre><br>  Repetimos la lista de tokens, mira: ‚Äú¬øQui√©n eres?  Te envuelven en un nodo de etiqueta.  Por ejemplo, si este es el comienzo de algunos <code>if</code> o <code>for</code> or <code>for</code> , el manejador de etiquetas tomar√° el manejador apropiado.  El manejador <code>for</code> nuevamente le dice al analizador: "L√©ame una lista de tokens hasta la etiqueta de cierre". <br><br>  La operaci√≥n vuelve al analizador. <br><br><blockquote>  Un nodo, una etiqueta y un analizador son elementos recursivos entre s√≠, y la profundidad de la recursi√≥n suele ser igual a la anidaci√≥n de la plantilla en s√≠ por las etiquetas. <br></blockquote><br><h4>  Analizador <br></h4><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> tokens: token = tokens.pop() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> token.startswith(BLOCK_TAG_START): <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> TagNode(token) <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> token.startswith(VARIABLE_TAG_START): ...</code> </pre><br>  El manejador de etiquetas nos proporciona un nodo espec√≠fico, por ejemplo, con un bucle for, para el cual aparece el m√©todo de <code>render</code> . <br><br><h4>  Para bucle <br></h4><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.template.defaulttags @register.tag('for') def do_for(parser, token): args = token.split_contents() body = parser.parse(until=['endfor']) return ForNode(args, body)</span></span></code> </pre><br><h4>  Para el nodo <br></h4><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ForNode</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(Node)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">render</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, context)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> context.push(): <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> self.args: <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> self.body.render(context)</code> </pre><br>  El m√©todo de <code>render</code> es un √°rbol de renderizado.  Cada nodo superior puede ir a un nodo hijo, pedirle que procese.  Los programadores est√°n acostumbrados a mostrar algunas variables en esta plantilla.  Esto se hace a trav√©s del <code>context</code> : se presenta en forma de diccionario regular.  Esta es una pila de diccionarios para emular un √°mbito cuando ingresamos una etiqueta.  Por ejemplo, si el <code>context</code> mismo cambia alguna otra etiqueta dentro del ciclo <code>for</code> , entonces cuando salgamos del ciclo los cambios se revertir√°n.  Esto es conveniente porque cuando todo es global, es dif√≠cil trabajar. <br><br><h3>  Respuesta <br></h3><br>  Finalmente obtuvimos nuestra l√≠nea con la respuesta HTTP: <br><br><blockquote>  Hola mundo <br></blockquote><br>  Podemos darle la l√≠nea al usuario. <br><br><ul><li>  Devuelve esta respuesta de la vista. </li><li>  Ver listas de middlewares. </li><li>  Middlewares esta respuesta modifica, complementa y mejora. </li><li>  La respuesta comienza a repetirse dentro de WSGIHandler, se escribe parcialmente en el socket y el navegador recibe una respuesta de nuestro servidor. </li></ul><br>  Todas las startups famosas que se escribieron en Django, como Bitbucket o Instagram, comenzaron con un ciclo tan peque√±o que todos los programadores pasaron. <br><br>  Todo esto, y una presentaci√≥n en Moscow Python Conf ++, es necesario para que comprenda mejor lo que est√° en sus manos y c√≥mo usarlo.  En cualquier magia, hay una gran parte de expresiones regulares que debes poder cocinar. <br><br><blockquote>  Artyom Malyshev y otros 23 grandes oradores <strong>el 5 de abril</strong> nuevamente nos dar√°n mucha reflexi√≥n y discusi√≥n sobre el tema de Python en la conferencia <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Conf ++</a> de Python en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Mosc√∫</a> .  Estudie el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">horario</a> y √∫nase al intercambio de experiencias para resolver una variedad de problemas usando Python. <br></blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es433482/">https://habr.com/ru/post/es433482/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es433472/index.html">Lanzamiento de Unity 2018.3</a></li>
<li><a href="../es433474/index.html">Pylint de adentro hacia afuera. Como lo hace</a></li>
<li><a href="../es433476/index.html">50 tonos de apio</a></li>
<li><a href="../es433478/index.html">Por qu√© Django es elegido en la revista Tinkoff</a></li>
<li><a href="../es433480/index.html">Holivarny historia sobre linter</a></li>
<li><a href="../es433486/index.html">Que otra vez La reactivaci√≥n de las tarjetas de d√©bito no bancarias</a></li>
<li><a href="../es433488/index.html">Christmas Scrum Meetup UPD Broadcast mitap</a></li>
<li><a href="../es433490/index.html">Revisi√≥n de la impresora 3D Creality CR-X</a></li>
<li><a href="../es433494/index.html">10 modismos ingleses que nunca sabr√°s</a></li>
<li><a href="../es433496/index.html">Las empresas estatales obligan a cambiar a software nacional para 2022</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>