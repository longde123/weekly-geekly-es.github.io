<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üñçÔ∏è üíù üëéüèø Jouez "osu!", Mais attention aux bugs ü§≥ üö• ‚òÄÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Salut, vous tous, collectionneurs d'insectes exotiques et simples! Nous avons un sp√©cimen rare sur notre banc d'essai PVS-Studio aujourd'hui - un jeu ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Jouez "osu!", Mais attention aux bugs</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/483436/"><p><img src="https://habrastorage.org/getpro/habr/post_images/3ac/9da/a12/3ac9daa12b519fc14e45f7f65abdd204.png" alt="Image 1" align="left"></p><br>  Salut, vous tous, collectionneurs d'insectes exotiques et simples!  Nous avons un sp√©cimen rare sur notre banc d'essai PVS-Studio aujourd'hui - un jeu appel√© "osu!", √âcrit en C #.  Comme d'habitude, nous chercherons des bogues, les analyserons et jouerons. <br><a name="habracut"></a><br><h2>  Le jeu </h2><br>  Osu!  est un jeu de rythme open source.  Selon le <a href="https://osu.ppy.sh/home">site Web</a> du jeu, il est assez populaire, avec plus de 15 millions de comptes de joueurs.  Le projet propose un gameplay gratuit, un design color√©, une personnalisation de la carte, un syst√®me avanc√© de classement des joueurs en ligne, un mode multijoueur et un riche ensemble de pi√®ces musicales.  Il n'y a aucun int√©r√™t √† approfondir le jeu;  vous pouvez tout lire sur Internet.  Commencez avec <a href="https://en.wikipedia.org/wiki/Osu!">cette page</a> . <br><br>  Je suis plus int√©ress√© par le code source du projet, qui est disponible sur <a href="https://github.com/ppy/osu">GitHub</a> .  Une chose qui attire imm√©diatement votre attention est le grand nombre de validations de r√©f√©rentiel (plus de 24 mille), qui est un signe de d√©veloppement intense et continu (le jeu a √©t√© publi√© pour la premi√®re fois en 2007, mais le travail doit avoir commenc√© encore plus t√¥t).  Le projet n'est pas grand cependant: seulement 1813 fichiers .cs avec un total de 135 000 LOC non vides.  Ce nombre comprend √©galement des tests, que je ne prends g√©n√©ralement pas en compte lors de l'ex√©cution des v√©rifications.  Les tests repr√©sentent 306 des fichiers .cs avec 25 000 LOC.  Le projet est en effet petit: par exemple, le noyau C # de PVS-Studio fait environ 300 000 LOC. <br><br>  Laissant de c√¥t√© les fichiers de test, j'ai v√©rifi√© 1507 fichiers de 110 000 LOC.  La v√©rification a r√©v√©l√© quelques bugs int√©ressants, que je suis pr√™t √† vous montrer. <br><br><h2>  Les bugs </h2><br>  <a href="https://www.viva64.com/en/w/v3001/">V3001</a> Il existe des sous-expressions identiques 'result == HitResult.Perfect' √† gauche et √† droite de '||'  op√©rateur.  DrawableHoldNote.cs 266 <br><br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CheckForResult</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">....</span></span></span><span class="hljs-function">)</span></span> { .... ApplyResult(r =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (holdNote.hasBroken &amp;&amp; (result == HitResult.Perfect || result == HitResult.Perfect)) result = HitResult.Good; .... }); }</code> </pre> <br>  Ceci est un bel exemple de programmation orient√©e copier-coller, qui est un terme humoristique r√©cemment utilis√© par mon coll√®gue Valeriy Komarov dans son article " <a href="https://www.viva64.com/en/b/0699/">Top 10 des bogues trouv√©s dans les projets Java en 2019</a> ". <br><br>  Quoi qu'il en soit, deux v√©rifications identiques sont ex√©cut√©es d'affil√©e.  L'un d'eux √©tait probablement destin√© √† v√©rifier une autre constante de l'√©num√©ration <i>HitResult</i> : <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> HitResult { None, Miss, Meh, Ok, Good, Great, Perfect, }</code> </pre> <br>  Quelle constante devait √™tre v√©rifi√©e?  Ou peut-√™tre que le deuxi√®me ch√®que ne devrait pas √™tre l√† du tout?  Ce sont les questions auxquelles seuls les auteurs peuvent r√©pondre.  Quoi qu'il en soit, il s'agit d'une erreur qui d√©forme la logique d'ex√©cution du programme. <br><br>  <a href="https://www.viva64.com/en/w/v3001/">V3001</a> Il existe des sous-expressions identiques ¬´famille! = GetFamilyString (TournamentTypeface.Aquatico)¬ª √† gauche et √† droite de l'op√©rateur ¬´&amp;&amp;¬ª.  TournamentFont.cs 64 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetWeightString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> family, FontWeight weight</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (weight == FontWeight.Regular &amp;&amp; family != GetFamilyString(TournamentTypeface.Aquatico) &amp;&amp; family != GetFamilyString(TournamentTypeface.Aquatico)) weightString = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty; .... }</code> </pre> <br>  Copiez-collez √† nouveau.  J'ai refactoris√© le code afin que l'erreur soit facilement d√©tect√©e maintenant, mais √† l'origine, elle avait √©t√© √©crite sur une seule ligne.  Tout comme dans l'exemple pr√©c√©dent, je ne peux pas dire avec certitude comment celui-ci doit √™tre corrig√©.  L'√©num√©ration <i>TournamentTypeface</i> contient une seule constante: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> TournamentTypeface { Aquatico }</code> </pre> <br>  L'erreur consiste peut-√™tre √† v√©rifier deux fois la variable <i>familiale</i> , mais je me trompe peut-√™tre. <br><br>  <a href="https://www.viva64.com/en/w/v3009/">V3009</a> [CWE-393] Il est √©trange que cette m√©thode renvoie toujours une seule et m√™me valeur de 'false'.  KeyCounterAction.cs 19 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnPressed</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T action, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> forwards</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!EqualityComparer&lt;T&gt;.Default.Equals(action, Action)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; IsLit = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (forwards) Increment(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }</code> </pre> <br>  Cette m√©thode renvoie <i>false √†</i> chaque fois.  Dans des cas comme celui-ci, je v√©rifie g√©n√©ralement l'appel de fonction, car vous pouvez souvent constater que l'appelant n'utilise pas la valeur de retour, ce qui signifie qu'il n'y a pas de probl√®me (autre qu'un mauvais style).  Voici √† quoi ressemble l'appel dans ce cas: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnPressed</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T action</span></span></span><span class="hljs-function">)</span></span> =&gt; Target.Children .OfType&lt;KeyCounterAction&lt;T&gt;&gt;() .Any(c =&gt; c.OnPressed(action, Clock.Rate &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>));</code> </pre> <br>  Comme vous pouvez le voir, l'appelant utilise la valeur renvoy√©e par la m√©thode <i>OnPressed</i> .  Puisque cette valeur est toujours <i>fausse</i> , l'appelant lui-m√™me retourne toujours <i>faux</i> √©galement.  Ce code contient tr√®s probablement une erreur et doit √™tre r√©vis√©. <br><br>  Un autre bug similaire: <br><br><ul><li>  V3009 [CWE-393] Il est √©trange que cette m√©thode renvoie toujours une seule et m√™me valeur de 'false'.  KeyCounterAction.cs 30 </li></ul><br>  <a href="https://www.viva64.com/en/w/v3042/">V3042</a> [CWE-476] Possible NullReferenceException.  Le '?.'  et '.'  les op√©rateurs sont utilis√©s pour acc√©der aux membres de l'objet 'val.NewValue' TournamentTeam.cs 41 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TournamentTeam</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Acronym.ValueChanged += val =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (....) FlagName.Value = val.NewValue.Length &gt;= <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-comment"><span class="hljs-comment">// &lt;= ? val.NewValue?.Substring(0, 2).ToUpper() : string.Empty; }; .... }</span></span></code> </pre> <br>  La variable <i>val.NewValue</i> est g√©r√©e de mani√®re dangereuse dans la condition de l'op√©rateur <i>?:</i> .  Ce qui fait que l'analyseur pense ainsi, c'est que plus tard dans la branche <i>alors</i> , la m√™me variable est g√©r√©e de mani√®re s√ªre en utilisant l'op√©rateur d'acc√®s conditionnel: <i>val.NewValue? .Substring (....)</i> . <br><br>  Un autre bug similaire: <br><br><ul><li>  V3042 [CWE-476] Possible NullReferenceException.  Le '?.'  et '.'  les op√©rateurs sont utilis√©s pour acc√©der aux membres de l'objet 'val.NewValue' TournamentTeam.cs 48 </li></ul><br>  <a href="https://www.viva64.com/en/w/v3042/">V3042</a> [CWE-476] Possible NullReferenceException.  Le '?.'  et '.'  les op√©rateurs sont utilis√©s pour acc√©der aux membres de l'objet 'api' SetupScreen.cs 77 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reload</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ActionableInfo { Label = <span class="hljs-string"><span class="hljs-string">"Current User"</span></span>, ButtonText = <span class="hljs-string"><span class="hljs-string">"Change Login"</span></span>, Action = () =&gt; { api.Logout(); <span class="hljs-comment"><span class="hljs-comment">// &lt;= .... }, Value = api?.LocalUser.Value.Username, .... }, .... } private class ActionableInfo : LabelledDrawable&lt;Drawable&gt; { .... public Action Action; .... }</span></span></code> </pre> <br>  Celui-ci est plus ambigu, mais je pense que c'est aussi un bug.  Le programmeur cr√©e un objet de type <i>ActionableInfo</i> .  Le champ <i>Action</i> est initialis√© √† l'aide d'une fonction lambda, qui g√®re de mani√®re dangereuse l' <i>API de</i> r√©f√©rence potentiellement nulle.  L'analyseur pense que ce mod√®le est une erreur car la variable <i>api</i> est trait√©e de mani√®re s√ªre plus tard, lors de l'initialisation du param√®tre <i>Value</i> .  J'ai appel√© ce cas ambigu parce que le code de la fonction lambda implique une ex√©cution retard√©e, au moment o√π le d√©veloppeur pourrait en quelque sorte garantir que la r√©f√©rence <i>api</i> serait non nulle.  Mais je ne suis pas s√ªr de cela, car le corps de la fonction lambda ne semble pas utiliser de gestion de r√©f√©rence s√ªre, comme les v√©rifications pr√©alables. <br><br>  <a href="https://www.viva64.com/en/w/v3066/">V3066</a> [CWE-683] Ordre incorrect possible des arguments pass√©s √† la m√©thode 'Atan2': 'diff.X' et 'diff.Y'.  SliderBall.cs 182 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateProgress</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> completionProgress</span></span></span><span class="hljs-function">)</span></span> { .... Rotation = <span class="hljs-number"><span class="hljs-number">-90</span></span> + (<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>)(-Math.Atan2(diff.X, diff.Y) * <span class="hljs-number"><span class="hljs-number">180</span></span> / Math.PI); .... }</code> </pre> <br>  L'analyseur soup√ßonne que les arguments de la m√©thode <i>Atan2</i> sont pass√©s dans le mauvais ordre.  Voici la d√©claration de la m√©thode: <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// Parameters: // y: // The y coordinate of a point. // // x: // The x coordinate of a point. public static double Atan2(double y, double x);</span></span></code> </pre> <br>  Les valeurs ont √©t√© transmises dans l'ordre inverse.  Je ne suis pas s√ªr que ce soit un bug car la m√©thode <i>UpdateProgress</i> contient pas mal de calculs non triviaux;  Je le mentionne juste comme un bug possible. <br><br>  <a href="https://www.viva64.com/en/w/v3080/">V3080</a> [CWE-476] <a href="https://www.viva64.com/en/w/v3080/">D√©r√©f√©rence</a> nulle possible.  Pensez √† inspecter ¬´Beatmap¬ª.  WorkingBeatmap.cs 57 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> Track </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetVirtualTrack</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lastObject = Beatmap.HitObjects.LastOrDefault(); .... }</code> </pre> <br>  L'analyseur signale une √©ventuelle d√©r√©f√©rence nulle de <i>Beatmap</i> : <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IBeatmap Beatmap { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> LoadBeatmapAsync().Result; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (TaskCanceledException) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } } }</code> </pre> <br>  Eh bien, l'analyseur est correct. <br><br>  Pour en savoir plus sur la fa√ßon dont PVS-Studio d√©tecte des bogues comme celui-ci et sur les nouvelles fonctionnalit√©s ajout√©es dans C # 8.0 qui ont √† voir avec la gestion des r√©f√©rences potentiellement nulles, consultez l'article " <a href="https://www.viva64.com/en/b/0631/">Types de r√©f√©rence Nullable dans C # 8.0 et analyse statique</a> ". <br><br>  <a href="https://www.viva64.com/en/w/v3083/">V3083</a> [CWE-367] L'appel non s√©curis√© de l'√©v√©nement 'ObjectConverted', NullReferenceException est possible.  Pensez √† affecter un √©v√©nement √† une variable locale avant de l'invoquer.  BeatmapConverter.cs 82 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> List&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">convertHitObjects</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">....</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ObjectConverted != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { converted = converted.ToList(); ObjectConverted.Invoke(obj, converted); } .... }</code> </pre> <br>  Il s'agit d'une erreur mineure et assez courante.  Les abonn√©s peuvent se d√©sinscrire de l'√©v√©nement entre la v√©rification nulle et l'invocation de l'√©v√©nement, entra√Ænant un plantage.  C'est une fa√ßon de corriger le bogue: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> List&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">convertHitObjects</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">....</span></span></span><span class="hljs-function">)</span></span> { .... converted = converted.ToList(); ObjectConverted?.Invoke(obj, converted); .... }</code> </pre> <br>  <a href="https://www.viva64.com/en/w/v3095/">V3095</a> [CWE-476] L'objet 'colonnes' a √©t√© utilis√© avant d'√™tre v√©rifi√© par rapport √† null.  V√©rifiez les lignes: 141, 142. SquareGraph.cs 141 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">redrawProgress</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; ColumnCount; i++) columns[i].State = i &lt;= progress ? ColumnState.Lit : ColumnState.Dimmed; columns?.ForceRedraw(); }</code> </pre> <br>  L'it√©ration sur la collection de <i>colonnes</i> se fait de mani√®re dangereuse.  Le d√©veloppeur a suppos√© que la r√©f√©rence des <i>colonnes</i> pouvait √™tre nulle, ce qui est indiqu√© par l'utilisation de l'op√©rateur d'acc√®s conditionnel pour acc√©der √† la collection plus loin dans le code. <br><br>  <a href="https://www.viva64.com/en/w/v3119/">V3119 L'</a> appel de l'√©v√©nement ignor√© 'OnNewResult' peut entra√Æner un comportement impr√©visible.  Envisagez d'impl√©menter explicitement les accesseurs d'√©v√©nements ou utilisez un mot cl√© ¬´scell√©¬ª.  DrawableRuleset.cs 256 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addHitObject</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">TObject hitObject</span></span></span><span class="hljs-function">)</span></span> { .... drawableObject.OnNewResult += (_, r) =&gt; OnNewResult?.Invoke(r); .... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> Action&lt;JudgementResult&gt; OnNewResult;</code> </pre> <br>  L'analyseur indique qu'il est dangereux d'utiliser un √©v√©nement ignor√© ou virtuel.  Voir la <a href="https://www.viva64.com/en/w/v3119/">description</a> du diagnostic pour l'explication.  J'ai √©galement √©crit un article sur ce sujet: " <a href="https://www.viva64.com/en/b/0453/">Ev√©nements virtuels en C #: quelque chose s'est mal pass√©</a> ". <br><br>  Voici une autre construction dangereuse similaire: <br><br><ul><li>  V3119 L'appel d'un √©v√©nement ignor√© peut entra√Æner un comportement impr√©visible.  Envisagez d'impl√©menter explicitement les accesseurs d'√©v√©nements ou utilisez un mot cl√© ¬´scell√©¬ª.  DrawableRuleset.cs 257 </li></ul><br>  <a href="https://www.viva64.com/en/w/v3123/">V3123</a> [CWE-783] Peut-√™tre le '??'  L'op√©rateur fonctionne d'une mani√®re diff√©rente de celle attendue.  Sa priorit√© est inf√©rieure √† la priorit√© des autres op√©rateurs dans sa partie gauche.  OsuScreenStack.cs 45 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onScreenChange</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IScreen prev, IScreen next</span></span></span><span class="hljs-function">)</span></span> { parallaxContainer.ParallaxAmount = ParallaxContainer.DEFAULT_PARALLAX_AMOUNT * ((IOsuScreen)next)?.BackgroundParallaxAmount ?? <span class="hljs-number"><span class="hljs-number">1.0f</span></span>; }</code> </pre> <br>  Pour une meilleure compr√©hension, voici un exemple synth√©tique d√©montrant la logique d'origine de ce code: <br><br><pre> <code class="cs hljs">x = (c * a) ?? b;</code> </pre> <br>  Le bogue provient du fait que la priorit√© de l'op√©rateur "*" est sup√©rieure √† celle de l'op√©rateur "??"  op√©rateur.  Voici √† quoi devrait ressembler le code fixe (avec des parenth√®ses ajout√©es): <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onScreenChange</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IScreen prev, IScreen next</span></span></span><span class="hljs-function">)</span></span> { parallaxContainer.ParallaxAmount = ParallaxContainer.DEFAULT_PARALLAX_AMOUNT * (((IOsuScreen)next)?.BackgroundParallaxAmount ?? <span class="hljs-number"><span class="hljs-number">1.0f</span></span>); }</code> </pre> <br>  Un autre bug similaire: <br><br>  <a href="https://www.viva64.com/en/w/v3123/">V3123</a> [CWE-783] Peut-√™tre le '??'  L'op√©rateur fonctionne d'une mani√®re diff√©rente de celle attendue.  Sa priorit√© est inf√©rieure √† la priorit√© des autres op√©rateurs dans sa partie gauche.  FramedReplayInputHandler.cs 103 <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> inImportantSection { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> IsImportant(frame) &amp;&amp; Math.Abs(CurrentTime - NextFrame?.Time ?? <span class="hljs-number"><span class="hljs-number">0</span></span>) &lt;= AllowedImportantTimeSpan; } }</code> </pre> <br>  Comme dans le cas pr√©c√©dent, le programmeur avait des hypoth√®ses erron√©es sur la priorit√© des op√©rateurs.  L'expression d'origine transmise √† la m√©thode <i>Math.Abs ‚Äã‚Äãest</i> √©valu√©e comme suit: <br><br><pre> <code class="cs hljs">(a ‚Äì b) ?? <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br>  Voici comment cela devrait √™tre corrig√©: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> inImportantSection { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> IsImportant(frame) &amp;&amp; Math.Abs(CurrentTime ‚Äì (NextFrame?.Time ?? <span class="hljs-number"><span class="hljs-number">0</span></span>)) &lt;= AllowedImportantTimeSpan; } }</code> </pre> <br>  <a href="https://www.viva64.com/en/w/v3142/">V3142</a> [CWE-561] Code inaccessible d√©tect√©.  Il est possible qu'une erreur soit pr√©sente.  DrawableHoldNote.cs 214 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnPressed</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ManiaAction action</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.OnPressed(action)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Result.Type == HitResult.Miss) <span class="hljs-comment"><span class="hljs-comment">// &lt;= holdNote.hasBroken = true; .... }</span></span></code> </pre> <br>  L'analyseur pense que le code du gestionnaire <i>OnPressed</i> est inaccessible √† partir de la deuxi√®me instruction <i>if</i> .  Cela d√©coule du fait que la premi√®re condition est toujours vraie, c'est-√†-dire que la m√©thode <i>base.OnPressed</i> retournera toujours <i>false</i> .  Jetons un coup d'≈ìil √† la m√©thode <i>base.OnPressed</i> : <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnPressed</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ManiaAction action</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (action != Action.Value) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UpdateResult(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); }</code> </pre> <br>  Et maintenant √† la m√©thode <i>UpdateResult</i> : <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateResult</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> userTriggered</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Time.Elapsed &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Judged) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; .... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Judged; }</code> </pre> <br>  Notez que l'impl√©mentation de la propri√©t√© <i>Judged</i> n'a pas d'importance ici car la logique de la m√©thode <i>UpdateResult</i> implique que la derni√®re instruction de <i>retour</i> est √©quivalente √† la suivante: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>;</code> </pre> <br>  Cela signifie que la m√©thode <i>UpdateResult</i> retournera <i>false</i> tout le temps, conduisant ainsi au probl√®me de code inaccessible plus t√¥t dans la pile. <br><br>  <a href="https://www.viva64.com/en/w/v3146/">V3146</a> [CWE-476] <a href="https://www.viva64.com/en/w/v3146/">D√©r√©f√©rence</a> nulle possible de 'jeu de r√®gles'.  Le 'FirstOrDefault' peut renvoyer la valeur nulle par d√©faut.  APILegacyScoreInfo.cs 24 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ScoreInfo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateScoreInfo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">RulesetStore rulesets</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ruleset = rulesets.GetRuleset(OnlineRulesetID); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mods = Mods != <span class="hljs-literal"><span class="hljs-literal">null</span></span> ? ruleset.CreateInstance() <span class="hljs-comment"><span class="hljs-comment">// &lt;= .GetAllMods().Where(....) .ToArray() : Array.Empty&lt;Mod&gt;(); .... }</span></span></code> </pre> <br>  L'analyseur consid√®re que l'appel de <i>ruleset.CreateInstance ()</i> n'est pas s√ªr.  Avant cet appel, la variable d'ensemble de <i>r√®gles</i> se voit attribuer une valeur √† la suite de l'appel de la m√©thode <i>GetRuleset</i> : <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> RulesetInfo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetRuleset</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id</span></span></span><span class="hljs-function">)</span></span> =&gt; AvailableRulesets.FirstOrDefault(....);</code> </pre> <br>  Comme vous pouvez le voir, l'avertissement est valide car la s√©quence d'appel inclut la m√©thode <i>FirstOrDefault</i> , qui peut retourner <i>null</i> . <br><br><h2>  Conclusion </h2><br>  Il n'y a pas beaucoup de bugs dans le code de "osu!", Et c'est bien.  Mais je recommanderais toujours aux auteurs de v√©rifier les probl√®mes signal√©s par l'analyseur.  J'esp√®re que cela aidera √† maintenir la haute qualit√© et que le jeu continuera √† apporter de la joie aux joueurs. <br><br>  Pour rappel, PVS-Studio est un bon choix si vous aimez bricoler le code source.  L'analyseur est disponible en <a href="https://www.viva64.com/en/pvs-studio-download/">t√©l√©chargement</a> sur le site officiel.  J'aimerais √©galement que vous gardiez √† l'esprit que les contr√¥les ponctuels comme celui-ci n'ont rien √† voir avec l'utilisation normale de l'analyse statique dans le processus de d√©veloppement r√©el.  Il n'est plus efficace que lorsqu'il est utilis√© r√©guli√®rement √† la fois sur le serveur de build et sur les ordinateurs des d√©veloppeurs (c'est ce qu'on appelle l'analyse incr√©mentale).  Votre but ultime est d'emp√™cher les bogues de glisser dans le syst√®me de contr√¥le de version en les rattrapant au stade du codage. <br><br>  Bonne chance et restez cr√©atif! <br><br><h2>  Les r√©f√©rences </h2><br>  Ceci est notre premier article en 2020. Pendant que nous y sommes, voici les liens vers les v√©rifications des projets C # effectu√©es au cours de la derni√®re ann√©e: <br><br><ul><li>  <a href="https://www.viva64.com/en/b/0605/">Recherche d'erreurs dans le code source du SDK Amazon Web Services pour .NET</a> </li><li>  <a href="https://www.viva64.com/en/b/0622/">V√©rification du code source de Roslyn</a> </li><li>  <a href="https://www.viva64.com/en/b/0631/">Types de r√©f√©rence Nullable en C # 8.0 et analyse statique</a> </li><li>  <a href="https://www.viva64.com/en/b/0653/">WinForms: erreurs, Holmes</a> </li><li>  <a href="https://www.viva64.com/en/b/0654/">L'histoire de la fa√ßon dont PVS-Studio a trouv√© une erreur dans la biblioth√®que utilis√©e dans ... PVS-Studio</a> </li><li>  <a href="https://www.viva64.com/en/b/0656/">V√©rification du code source des biblioth√®ques .NET Core par l'analyseur statique PVS-Studio</a> </li><li>  <a href="https://www.viva64.com/en/b/0664/">V√©rification des analyseurs Roslyn</a> </li><li>  <a href="https://www.viva64.com/en/b/0677/">V√©rification de l'interface utilisateur de Telerik pour UWP comme moyen de d√©marrer avec PVS-Studio</a> </li><li>  <a href="https://www.viva64.com/en/b/0678/">Azure PowerShell: principalement inoffensif</a> </li><li>  <a href="https://www.viva64.com/en/b/0681/">Analyse du code d'Orchard CMS pour les bogues</a> </li><li>  <a href="https://www.viva64.com/en/b/0683/">V√©rification de l'encapsuleur OpenCvSharp pour OpenCV avec PVS-Studio</a> </li><li>  <a href="https://www.viva64.com/en/b/0692/">SDK Azure pour .NET: histoire d'une recherche d'erreur difficile</a> </li><li>  <a href="https://www.viva64.com/en/b/0694/">SDK SARIF et ses erreurs</a> </li><li>  <a href="https://www.viva64.com/en/b/0698/">Top 10 des bugs trouv√©s dans les projets C # en 2019</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr483436/">https://habr.com/ru/post/fr483436/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr483416/index.html">Essayer d'automatiser des processus √† l'aide de Powershell</a></li>
<li><a href="../fr483418/index.html">Syst√®mes de billetterie: comment avez-vous pay√© trois OTRS gratuits?</a></li>
<li><a href="../fr483424/index.html">DBA: transfert de valeurs SEQUENCE entre des bases de donn√©es PostgreSQL</a></li>
<li><a href="../fr483426/index.html">Enqu√™te sur l'onglet du vendredi</a></li>
<li><a href="../fr483428/index.html">Quelle sera la gestion √©lectronique des documents apr√®s l'entr√©e en vigueur des amendements √† la loi sur la signature √©lectronique?</a></li>
<li><a href="../fr483438/index.html">Jouez "osu!", N'oubliez pas les erreurs</a></li>
<li><a href="../fr483440/index.html">Derniers compilateurs D</a></li>
<li><a href="../fr483444/index.html">Rapport DORA 2019: comment am√©liorer les performances de DevOps</a></li>
<li><a href="../fr483446/index.html">Les scientifiques ont trouv√© une nouvelle fa√ßon de r√©duire les niveaux de fer dans l'eau potable</a></li>
<li><a href="../fr483448/index.html">Disney - Le plus grand double sens de l'histoire de l'humanit√©</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>