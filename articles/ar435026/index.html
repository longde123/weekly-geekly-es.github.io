<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>♐️ 👸🏾 🧔🏾 نصنع رسولا * يعمل حتى في المصعد 🐀 🎠 🔪</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="* في الواقع ، سنكتب فقط النموذج الأولي للبروتوكول. 

 ربما واجهت موقفًا مشابهًا - الجلوس في الرسول المفضل لديك ، والدردشة مع الأصدقاء ، والدخول في الم...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>نصنع رسولا * يعمل حتى في المصعد</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/435026/" style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/l2/cw/fy/l2cwfyqz2xuen2nzyyrz-2wvsnw.png" width="500" align="left">  * في الواقع ، سنكتب فقط النموذج الأولي للبروتوكول. <br><br>  ربما واجهت موقفًا مشابهًا - الجلوس في الرسول المفضل لديك ، والدردشة مع الأصدقاء ، والدخول في المصعد / النفق / النقل ، ويبدو أن الإنترنت ما زال يصطاد ، ولكن لا يمكن إرسال شيء؟  أو في بعض الأحيان يقوم موفر الاتصال الخاص بك بتهيئة الشبكة بشكل غير صحيح ويختفي 50٪ من الحزم ولا يعمل أي شيء أيضًا.  ربما كنت تفكر في هذه اللحظة - حسنًا ، ربما يمكنك القيام بشيء ما بطريقة ما بحيث لا يزال بإمكانك إرسال جزء النص الذي تريده مع اتصال سيء؟  أنت لست وحدك. <br><br>  <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">مصدر الصورة</a></i> <br><br>  في هذه المقالة سأتحدث عن فكرتي لتطبيق بروتوكول يستند إلى UDP ، والذي يمكن أن يساعد في هذا الموقف. <br><a name="habracut"></a><br><h3 style=";text-align:right;direction:rtl">  مشكلات TCP / IP </h3><br>  عندما يكون لدينا اتصال رديء (محمول) ، تبدأ نسبة كبيرة من الحزم في الضياع (أو تذهب مع تأخير طويل جدًا) ، وقد ينظر بروتوكول TCP / IP إلى هذا كإشارة على أن الشبكة مزدحمة ، وكل شيء يبدأ في العمل sooooooooooooooobly بشكل عام.  لا تضفي المزيد من السعادة على أن إنشاء اتصال (خاصة TLS) يتطلب إرسال واستقبال عدة حزم ، وحتى الخسائر الصغيرة تؤثر على تشغيلها بشكل سيء للغاية.  كما يتطلب غالبًا الوصول إلى DNS قبل إنشاء اتصال - بضع حزم إضافية. <br><br>  الكل في الكل ، مشاكل REST API نموذجي TCP / IP المستندة إلى اتصال رديئة: <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  استجابة سيئة لفقدان الحزمة (تقليل حاد للسرعة ، مهلات كبيرة) </li><li style=";text-align:right;direction:rtl">  يتطلب إنشاء اتصال تبادل حزم (+3 حزم) </li><li style=";text-align:right;direction:rtl">  غالبًا ما تحتاج إلى استعلام DNS "إضافي" لمعرفة خادم IP (+2 حزم) </li><li style=";text-align:right;direction:rtl">  غالبًا ما تحتاج إلى TLS (+2 حزم كحد أدنى) </li></ul><br>  في المجموع ، هذا يعني أنه فقط للاتصال بالخادم ، نحتاج إلى إرسال 3-7 حزم ، وبنسبة مئوية عالية من الخسائر ، يمكن أن يستغرق الاتصال قدراً كبيراً من الوقت ، وحتى أننا لم نرسل أي شيء حتى الآن. <br><br><h3 style=";text-align:right;direction:rtl">  فكرة التنفيذ </h3><br>  الفكرة هي: نحتاج فقط إلى إرسال حزمة UDP واحدة إلى عنوان IP الخاص بالسلك مسبقًا للخادم مع بيانات الترخيص ونص الرسالة الضرورية ، والحصول على إجابة عليه.  يمكن تشفير جميع البيانات بالإضافة إلى ذلك (هذا ليس في النموذج الأولي).  إذا لم تصل الإجابة خلال ثانية ، فإننا نعتقد أن الطلب قد فقد ونحاول إرساله مرة أخرى.  يجب أن يكون الخادم قادراً على إزالة الرسائل المكررة ، لذا يجب ألا تؤدي إعادة الإرسال إلى إنشاء مشاكل. <br><br><h3 style=";text-align:right;direction:rtl">  المزالق المحتملة للتنفيذ جاهزة للإنتاج </h3><br>  فيما يلي (بأي حال من الأحوال) أشياء تحتاج إلى التفكير فيها قبل استخدام شيء مثل هذا في ظروف "القتال": <br><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  يمكن "قطع" UDP بواسطة الموفر - يجب أن تكون قادرًا على العمل عبر TCP / IP </li><li style=";text-align:right;direction:rtl">  UDP ليست سهلة مع NAT - عادة ما يكون هناك القليل من الوقت (~ 30 ثانية) للرد على طلب العميل </li><li style=";text-align:right;direction:rtl">  يجب أن يكون الخادم مقاومًا <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">لهجمات</a> - يجب عليك التأكد من أن حزمة الاستجابة ليست أكثر من حزمة الطلب </li><li style=";text-align:right;direction:rtl">  يكون التشفير صعبًا ، وإذا لم تكن خبيرًا في الأمن ، فلديك فرصة ضئيلة في تنفيذه بشكل صحيح </li><li style=";text-align:right;direction:rtl">  إذا قمت بتعيين الفاصل الزمني لإعادة الإرسال بشكل غير صحيح (على سبيل المثال ، بدلاً من المحاولة مرة أخرى كل ثانية ، والمحاولة مرة أخرى دون توقف) ، فيمكنك فعل ما هو أسوأ بكثير من TCP / IP </li><li style=";text-align:right;direction:rtl">  قد يبدأ عدد أكبر من الزيارات في الوصول إلى الخادم الخاص بك بسبب نقص الملاحظات في UDP وإعادة المحاولات التي لا تنتهي </li><li style=";text-align:right;direction:rtl">  يمكن أن يحتوي الخادم على عدة عناوين IP ، ويمكن أن يتغير مع مرور الوقت ، لذلك يجب أن تكون قادرًا على تحديث ذاكرة التخزين المؤقت (Telegram يعمل جيدًا :)) </li></ol><br><h3 style=";text-align:right;direction:rtl">  التنفيذ </h3><br>  سنكتب خادمًا يرسل ردًا عبر UDP وسنرسل في الرد رقم الطلب الذي وصل إليه (يشبه الطلب "نص رسالة الطلب") ، بالإضافة إلى الطابع الزمني لتلقي الاستجابة: <br><br><pre style=";text-align:right;direction:rtl"><code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">//  Go. //      buf := make([]byte, maxUDPPacketSize) //   UDP addr, _ := net.ResolveUDPAddr("udp", fmt.Sprintf("0.0.0.0:%d", serverPort)) conn, _ := net.ListenUDP("udp", addr) for { //   UDP,      n, uaddr, _ := conn.ReadFromUDP(buf) req := string(buf[0:n]) parts := strings.SplitN(req, " ", 2) //          curTs := time.Now().UnixNano() clientTs, _ := strconv.Atoi(parts[0]) //       -      //   conn.WriteToUDP([]byte(fmt.Sprintf("%d %d", curTs, clientTs)), uaddr) }</span></span></code> </pre> <br>  الآن الجزء الصعب هو العميل.  سنرسل رسائل واحدة تلو الأخرى وننتظر حتى يرد الخادم قبل إرسال التالي.  سوف نرسل الطابع الزمني الحالي وقطعة من النص - الطابع الزمني سيكون بمثابة معرف الطلب. <br><br><pre style=";text-align:right;direction:rtl"> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">//   addr, _ := net.ResolveUDPAddr("udp", fmt.Sprintf("%s:%d", serverIP, serverPort)) conn, _ := net.DialUDP("udp", nil, addr) //  UDP      ,     . resCh := make(chan udpResult, 10) go readResponse(conn, resCh) for i := 0; i &lt; numMessages; i++ { requestID := time.Now().UnixNano() send(conn, requestID, resCh) }</span></span></code> </pre><br>  رمز الميزات: <br><br><pre style=";text-align:right;direction:rtl"> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">send</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(conn *net.UDPConn, requestID </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int64</span></span></span></span><span class="hljs-function"><span class="hljs-params">, resCh </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">chan</span></span></span></span><span class="hljs-function"><span class="hljs-params"> udpResult)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> { <span class="hljs-comment"><span class="hljs-comment">//     ,       . conn.Write([]byte(fmt.Sprintf("%d %s", requestID, testMessageText))) if waitReply(requestID, time.After(time.Second), resCh) { return } } } //   ,  . //      ,   ,   // ,        , //   . func waitReply(requestID int64, timeout &lt;-chan time.Time, resCh chan udpResult) (ok bool) { for { select { case res := &lt;-resCh: if res.requestTs == requestID { return true } case &lt;-timeout: return false } } } //    type udpResult struct { serverTs int64 requestTs int64 } //           . func readResp(conn *net.UDPConn, resCh chan udpResult) { buf := make([]byte, maxUDPPacketSize) for { n, _, _ := conn.ReadFromUDP(buf) respStr := string(buf[0:n]) parts := strings.SplitN(respStr, " ", 2) var res udpResult res.serverTs, _ = strconv.ParseInt(parts[0], 10, 64) res.requestTs, _ = strconv.ParseInt(parts[1], 10, 64) resCh &lt;- res } }</span></span></code> </pre><br>  قمت أيضًا بتنفيذ نفس الشيء على أساس REST القياسي (أكثر أو أقل): باستخدام HTTP POST ، نرسل نفس requestTs ونص الرسالة وننتظر الرد ، ثم ننتقل إلى الرد التالي.  تم تقديم الطعن من خلال اسم النطاق ، ولم يتم حظر تخزين DNS المؤقت في النظام.  لم يتم استخدام HTTPS لجعل المقارنة أكثر صدقًا (لا يوجد تشفير في النموذج الأولي).  تم تعيين المهلة في 15 ثانية: TCP / IP لديه بالفعل إعادة توجيه الحزم المفقودة ، وعلى الأرجح لن ينتظر المستخدم أكثر من 15 ثانية. <br><br><h3 style=";text-align:right;direction:rtl">  اختبار ، النتائج </h3><br>  عند اختبار النموذج الأولي ، تم قياس الأشياء التالية (جميعها <b>بالمللي ثانية</b> ): <br><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  وقت الاستجابة الأول (الأول) </li><li style=";text-align:right;direction:rtl">  متوسط ​​زمن الاستجابة (متوسط) </li><li style=";text-align:right;direction:rtl">  وقت الاستجابة الأقصى (الحد الأقصى) </li><li style=";text-align:right;direction:rtl">  H / U - نسبة "وقت HTTP" / "وقت UDP" - كم مرة أقل تأخير عند استخدام UDP </li></ol><br>  تم تقديم 100 سلسلة من 10 طلبات - نحن نحاكي موقفًا عندما تحتاج إلى إرسال بضع رسائل فقط وبعد توفر الإنترنت العادي (على سبيل المثال ، شبكة Wi-Fi في المترو أو 3G / LTE في الشارع). <br><br><h4 style=";text-align:right;direction:rtl">  أنواع الاتصالات التي تم اختبارها: </h4><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ملف تعريف "الشبكة السيئة للغاية" (خسارة 10٪ ، زمن وصول 500 مللي ثانية ، 1 ميجابت في الثانية) في <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">مكيف ارتباط الشبكة</a> - "سيء جدًا" </li><li style=";text-align:right;direction:rtl">  EDGE ، هاتف في الثلاجة ("مصعد") - ثلاجة </li><li style=";text-align:right;direction:rtl">  إيدج </li><li style=";text-align:right;direction:rtl">  3G </li><li style=";text-align:right;direction:rtl">  LTE </li><li style=";text-align:right;direction:rtl">  واي فاي </li></ol><br><h4 style=";text-align:right;direction:rtl">  النتائج (الوقت بالميلي ثانية): </h4><br><img src="https://habrastorage.org/webt/kc/sb/as/kcsbasqpv64ahu_xusy44k8s8-o.png"><br><br>  ( <a href="">نفس الشيء بتنسيق CSV</a> ) <br><br><h3 style=";text-align:right;direction:rtl">  الاستنتاجات </h3><br>  فيما يلي الاستنتاجات التي يمكن استخلاصها من النتائج: <br><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  بصرف النظر عن الحالة الشاذة LTE ، يكون الفرق في إرسال الرسالة الأولى أكبر ، والأسوأ من ذلك (في المتوسط ​​، أسرع بمعدل 2-3 مرات) </li><li style=";text-align:right;direction:rtl">  الإرسال اللاحق للرسائل في HTTP ليس أبطأ بكثير - في المتوسط ​​1.3 مرة أبطأ ، ولكن على شبكة Wi-Fi مستقرة لا يوجد فرق على الإطلاق </li><li style=";text-align:right;direction:rtl">  يكون زمن الاستجابة المستند إلى UDP أكثر استقرارًا بكثير ، والذي يتم رؤيته بشكل غير مباشر من خلال الكمون الأقصى - كما أنه أقل من 1.4 إلى 1.8 مرة </li></ol><br>  بمعنى آخر ، في ظل الظروف ("السيئة") المناسبة ، سيعمل بروتوكولنا بشكل أفضل ، خاصة عند إرسال الرسالة الأولى (غالبًا ما يكون هذا هو كل ما يلزم إرساله). <br><br><h3 style=";text-align:right;direction:rtl">  تنفيذ النموذج الأولي </h3><br>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">تم نشر النموذج الأولي على جيثب</a></b> .  لا تستخدمه في الإنتاج! <br><br>  أمر بدء تشغيل العميل على الهاتف أو الكمبيوتر: <pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">instant-im -client -num 10</code> </pre>  .  الخادم لا يزال قيد التشغيل :).  من الضروري أن ننظر أولاً وقبل كل شيء في وقت الإجابة الأولى ، وكذلك في أقصى تأخير.  تتم طباعة كل هذه البيانات في النهاية. <br><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">مثال على إطلاق المصعد</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/bi/s8/5c/bis85cdxcwloeyv2l7phi7th5ke.png"><br><img src="https://habrastorage.org/webt/7n/5w/zb/7n5wzbeumstn7bfhdvenaihq1m8.png"><br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar435026/">https://habr.com/ru/post/ar435026/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar435012/index.html">أول لعبة فيديو لـ Alice ، أو مساعد صوت كوحدة تحكم لعبة</a></li>
<li><a href="../ar435014/index.html">Dart vs Node.js: مقارنة الأداء في تطبيقات خادم HTTP</a></li>
<li><a href="../ar435016/index.html">ما لاري إليسون سيجلب إلى تسلا</a></li>
<li><a href="../ar435018/index.html">في عام 2018 ، بدأنا أخيرًا في أخذ الوقت الذي قضيته على الهاتف الذكي على محمل الجد</a></li>
<li><a href="../ar435020/index.html">قاعة مشاهير إلكترونيات المستهلك: قصص أفضل الأدوات خلال الخمسين عامًا الماضية ، الجزء الثاني</a></li>
<li><a href="../ar435028/index.html">اختبارات C بدون رسائل نصية وتسجيل</a></li>
<li><a href="../ar435032/index.html">قامت مركبة الفضاء Chang'e-4 بهبوط ناجح على الجانب الآخر من القمر وأرسلت الصورة الأولى</a></li>
<li><a href="../ar435036/index.html">أفكار حول C ++ الحديثة وتطوير اللعبة</a></li>
<li><a href="../ar435038/index.html">الطاقة النووية العالمية في عام 2018</a></li>
<li><a href="../ar435044/index.html">الآثار: Minidisc في بيئتها الطبيعية</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>