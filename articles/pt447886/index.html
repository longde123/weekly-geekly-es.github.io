<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üéª üëπ üõãÔ∏è An√°lise de log do Nginx usando o Amazon Athena e o Cube.js üë∞üèª ‚ôæ üë©‚Äçüëß</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Normalmente, o Nginx usa produtos comerciais ou alternativas de c√≥digo aberto, como Prometheus + Grafana, para monitorar e analisar o desempenho do Ng...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>An√°lise de log do Nginx usando o Amazon Athena e o Cube.js</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/447886/"><p>  Normalmente, o Nginx usa produtos comerciais ou alternativas de c√≥digo aberto, como Prometheus + Grafana, para monitorar e analisar o desempenho do Nginx.  Essa √© uma boa op√ß√£o para monitoramento ou an√°lise em tempo real, mas n√£o √© muito conveniente para an√°lise hist√≥rica.  Em qualquer recurso popular, a quantidade de dados dos logs do nginx est√° crescendo rapidamente e √© l√≥gico usar algo mais especializado para analisar uma grande quantidade de dados. </p><br><p> Neste artigo, mostrarei como usar o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Athena</a> para analisar logs usando o Nginx como exemplo e mostrarei como compilar um painel anal√≠tico a partir desses dados usando a estrutura <a href="">cube.js de</a> c√≥digo <a href="">aberto</a> .  Aqui est√° a arquitetura completa da solu√ß√£o: </p><br><p><img src="https://habrastorage.org/webt/km/xo/3i/kmxo3izommuyzgajw20t6-aolcg.png" alt="Arquitetura"></p><br><p>  TL: DR; <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Link para o painel conclu√≠do</a> . </p><a name="habracut"></a><br><p>  Usamos o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Fluentd</a> para coletar informa√ß√µes, o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">AWS Kinesis Data Firehose</a> e o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">AWS Glue</a> para processamento e o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">AWS S3</a> para armazenamento.  Usando este pacote, voc√™ pode armazenar n√£o apenas logs nginx, mas tamb√©m outros eventos, bem como logs de outros servi√ßos.  √â poss√≠vel substituir algumas pe√ßas por outras semelhantes √† sua pilha; por exemplo, voc√™ pode gravar logs no kinesis diretamente do nginx, ignorando o fluentd ou usar o logstash para fazer isso. </p><br><h2 id="sobiraem-logi-nginx">  Coletando logs do Nginx </h2><br><p>  Por padr√£o, os logs do Nginx s√£o mais ou menos assim: </p><br><pre><code class="bash hljs">4/9/2019 12:58:17 PM1.1.1.1 - - [09/Apr/2019:09:58:17 +0000] <span class="hljs-string"><span class="hljs-string">"GET /sign-up HTTP/2.0"</span></span> 200 9168 <span class="hljs-string"><span class="hljs-string">"https://example.com/sign-in"</span></span> <span class="hljs-string"><span class="hljs-string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/73.0.3683.86 Safari/537.36"</span></span> <span class="hljs-string"><span class="hljs-string">"-"</span></span> 4/9/2019 12:58:17 PM1.1.1.1 - - [09/Apr/2019:09:58:17 +0000] <span class="hljs-string"><span class="hljs-string">"GET /sign-in HTTP/2.0"</span></span> 200 9168 <span class="hljs-string"><span class="hljs-string">"https://example.com/sign-up"</span></span> <span class="hljs-string"><span class="hljs-string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/73.0.3683.86 Safari/537.36"</span></span> <span class="hljs-string"><span class="hljs-string">"-"</span></span></code> </pre> <br><p>  Eles podem ser analisados, mas √© muito mais f√°cil corrigir a configura√ß√£o do Nginx para que ele exiba logs em JSON: </p><br><pre> <code class="plaintext hljs">log_format json_combined escape=json '{ "created_at": "$msec", ' '"remote_addr": "$remote_addr", ' '"remote_user": "$remote_user", ' '"request": "$request", ' '"status": $status, ' '"bytes_sent": $bytes_sent, ' '"request_length": $request_length, ' '"request_time": $request_time, ' '"http_referrer": "$http_referer", ' '"http_x_forwarded_for": "$http_x_forwarded_for", ' '"http_user_agent": "$http_user_agent" }'; access_log /var/log/nginx/access.log json_combined;</code> </pre> <br><h3 id="s3-dlya-hraneniya">  S3 para armazenamento </h3><br><p>  Para armazenar os logs, usaremos o S3.  Isso permite armazenar e analisar os logs em um √∫nico local, j√° que o Athena pode trabalhar com dados no S3 diretamente.  Mais adiante neste artigo, mostrarei como dobrar e processar corretamente os logs, mas primeiro precisamos de um balde limpo no S3, no qual nada mais ser√° armazenado.  Vale a pena pensar com anteced√™ncia em qual regi√£o voc√™ criar√° o bucket, porque o Athena n√£o est√° dispon√≠vel em todas as regi√µes. </p><br><h3 id="sozdaem-shemu-v-konsoli-athena">  Crie um diagrama no console do Athena </h3><br><p>  Crie uma tabela no Athena para logs.  √â necess√°rio para a escrita e a leitura, se voc√™ planeja usar o Kinesis Firehose.  Abra o console do Athena e crie uma tabela: </p><br><div class="spoiler">  <b class="spoiler_title">Cria√ß√£o de tabela SQL</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXTERNAL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`kinesis_logs_nginx`</span></span>( <span class="hljs-string"><span class="hljs-string">`created_at`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span>, <span class="hljs-string"><span class="hljs-string">`remote_addr`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-string"><span class="hljs-string">`remote_user`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-string"><span class="hljs-string">`request`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-string"><span class="hljs-string">`status`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>, <span class="hljs-string"><span class="hljs-string">`bytes_sent`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>, <span class="hljs-string"><span class="hljs-string">`request_length`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>, <span class="hljs-string"><span class="hljs-string">`request_time`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span>, <span class="hljs-string"><span class="hljs-string">`http_referrer`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-string"><span class="hljs-string">`http_x_forwarded_for`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-string"><span class="hljs-string">`http_user_agent`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ROW</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FORMAT</span></span> SERDE <span class="hljs-string"><span class="hljs-string">'org.apache.hadoop.hive.ql.io.orc.OrcSerde'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STORED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> INPUTFORMAT <span class="hljs-string"><span class="hljs-string">'org.apache.hadoop.hive.ql.io.orc.OrcInputFormat'</span></span> OUTPUTFORMAT <span class="hljs-string"><span class="hljs-string">'org.apache.hadoop.hive.ql.io.orc.OrcOutputFormat'</span></span> LOCATION <span class="hljs-string"><span class="hljs-string">'s3://&lt;YOUR-S3-BUCKET&gt;'</span></span> TBLPROPERTIES (<span class="hljs-string"><span class="hljs-string">'has_encrypted_data'</span></span>=<span class="hljs-string"><span class="hljs-string">'false'</span></span>);</code> </pre> </div></div><br><h3 id="sozdaem-kinesis-firehose-stream">  Criar fluxo Kinesis Firehose </h3><br><p>  O Kinesis Firehose gravar√° os dados recebidos do Nginx no S3 no formato selecionado, divididos em diret√≥rios no formato AAAA / MM / DD / HH.  Isso √© √∫til ao ler dados.  Obviamente, voc√™ pode escrever diretamente no S3 a partir do fluentd, mas nesse caso voc√™ deve escrever JSON, o que √© ineficiente devido ao grande tamanho do arquivo.  Al√©m disso, ao usar o PrestoDB ou Athena, o JSON √© o formato de dados mais lento.  Portanto, abra o console do Kinesis Firehose, clique em "Criar fluxo de entrega", selecione "PUT direto" no campo "entrega": </p><br><p><img src="https://habrastorage.org/webt/xe/vb/mc/xevbmcpntl3aqkgg50lh844gxe4.png" alt="Kinesis Firehose Console 1"></p><br><p>  Na pr√≥xima guia, selecione "Convers√£o de formato de grava√ß√£o" - "Ativado" e selecione "Apache ORC" como o formato para grava√ß√£o.  Segundo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Owen O'Malley</a> , esse √© o formato ideal para o PrestoDB e Athena.  Como um diagrama, indicamos a tabela que criamos acima.  Observe que voc√™ pode especificar qualquer local S3 em kinesis, apenas o esquema √© usado na tabela.  Mas se voc√™ especificar outro local S3, a leitura desses registros desta tabela n√£o funcionar√°. </p><br><p><img src="https://habrastorage.org/webt/vu/y1/ro/vuy1royrwm3pb3jle5nvclzskd0.png" alt="Console de mangueira de inc√™ndio Kinesis 2"></p><br><p>  Escolhemos o S3 para armazenamento e o bucket que criamos anteriormente.  O Aws Glue Crawler, sobre o qual falarei um pouco mais tarde, n√£o sabe como trabalhar com prefixos no bucket S3, por isso √© importante deix√°-lo vazio. </p><br><p><img src="https://habrastorage.org/webt/jq/0u/bs/jq0ubs7jvqmehbfqaaycrmxryso.png" alt="Console de mangueira de inc√™ndio Kinesis 3"></p><br><p>  As op√ß√µes restantes podem ser alteradas dependendo da sua carga, geralmente uso as padr√£o.  Observe que a compacta√ß√£o S3 n√£o est√° dispon√≠vel, mas o ORC usa a compacta√ß√£o nativa por padr√£o. </p><br><h3 id="fluentd">  Fluente </h3><br><p>  Agora que configuramos o armazenamento e o recebimento de logs, voc√™ precisa configurar o envio.  Usaremos o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Fluentd</a> porque eu amo Ruby, mas voc√™ pode usar o Logstash ou enviar logs para o kinesis diretamente.  Voc√™ pode iniciar o servidor Fluentd de v√°rias maneiras, vou falar sobre o docker, porque √© simples e conveniente. </p><br><p>  Primeiro, precisamos do arquivo de configura√ß√£o fluent.conf.  Crie-o e adicione a fonte: </p><br><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">digite</a> para a frente <br>  porta 24224 <br>  bind 0.0.0.0 </p><br><br><p>  Agora voc√™ pode iniciar o servidor Fluentd.  Se voc√™ precisar de uma configura√ß√£o mais avan√ßada, o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Docker Hub</a> possui um guia detalhado, incluindo como montar sua imagem. </p><br><pre> <code class="bash hljs">$ docker run \ -d \ -p 24224:24224 \ -p 24224:24224/udp \ -v /data:/fluentd/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span> \ -v &lt;PATH-TO-FLUENT-CONF&gt;:/fluentd/etc fluentd \ -c /fluentd/etc/fluent.conf fluent/fluentd:stable</code> </pre> <br><p>  Essa configura√ß√£o usa o <code>/fluentd/log</code> para armazenar em cache os logs antes do envio.  Voc√™ pode ficar sem isso, mas, ao reiniciar, pode perder tudo em cache por trabalho excessivo.  Qualquer porta tamb√©m pode ser usada, 24224 √© a porta padr√£o do Fluentd. </p><br><p>  Agora que temos o Fluentd em execu√ß√£o, podemos enviar logs do Nginx para l√°.  Geralmente, executamos o Nginx em um cont√™iner do Docker. Nesse caso, o Docker possui um driver de log nativo para o Fluentd: </p><br><pre> <code class="bash hljs">$ docker run \ --<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>-driver=fluentd \ --<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>-opt fluentd-address=&lt;FLUENTD-SERVER-ADDRESS&gt;\ --<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>-opt tag=\<span class="hljs-string"><span class="hljs-string">"{{.Name}}\" \ -v /some/content:/usr/share/nginx/html:ro \ -d \ nginx</span></span></code> </pre> <br><p>  Se voc√™ executar o Nginx de maneira diferente, poder√° usar os arquivos de log, o Fluentd possui um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">plug-in de cauda de arquivo</a> . </p><br><p>  Adicione a an√°lise de log configurada acima √† configura√ß√£o do Fluent: </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">filter</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">YOUR-NGINX-TAG.</span></span></span><span class="hljs-tag">*&gt;</span></span> @type parser key_name log emit_invalid_record_to_error false <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">parse</span></span></span><span class="hljs-tag">&gt;</span></span> @type json <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">parse</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">filter</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  E enviando logs para o Kinesis usando o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">plug</a> - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">in kinesis firehose</a> : </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">match</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">YOUR-NGINX-TAG.</span></span></span><span class="hljs-tag">*&gt;</span></span> @type kinesis_firehose region region delivery_stream_name <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">YOUR-KINESIS-STREAM-NAME</span></span></span><span class="hljs-tag">&gt;</span></span> aws_key_id <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">YOUR-AWS-KEY-ID</span></span></span><span class="hljs-tag">&gt;</span></span> aws_sec_key <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">YOUR_AWS-SEC_KEY</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">match</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><h2 id="athena">  Athena </h2><br><p>  Se voc√™ configurou tudo corretamente, depois de um tempo (por padr√£o, o Kinesis grava os dados recebidos a cada 10 minutos), voc√™ deve ver os arquivos de log no S3.  No menu "monitoramento" do Kinesis Firehose, √© poss√≠vel ver a quantidade de dados gravados no S3, al√©m de erros.  N√£o esque√ßa de conceder acesso de grava√ß√£o ao bucket S3 para a fun√ß√£o Kinesis.  Se Kinesis n√£o conseguiu analisar algo, ele adicionar√° erros no mesmo bloco. </p><br><p>  Agora voc√™ pode ver os dados em Athena.  Vamos encontrar algumas novas consultas √†s quais cometemos erros: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">"db_name"</span></span>.<span class="hljs-string"><span class="hljs-string">"table_name"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> &gt; <span class="hljs-number"><span class="hljs-number">499</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> created_at <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>;</code> </pre> <br><h3 id="skanirovanie-vseh-zapisey-na-kazhdyy-zapros">  Digitalizar todos os registros para cada solicita√ß√£o </h3><br><p>  Agora, nossos logs s√£o processados ‚Äã‚Äãe empilhados no S3 no ORC, compactados e prontos para an√°lise.  O Kinesis Firehose at√© os coloca em diret√≥rios a cada hora.  No entanto, enquanto a tabela n√£o estiver particionada, o Athena carregar√° dados de todos os tempos para cada consulta, com raras exce√ß√µes.  Este √© um grande problema por dois motivos: </p><br><ul><li>  A quantidade de dados est√° em constante crescimento, diminuindo a velocidade das consultas; </li><li>  O Athena √© cobrado com base na quantidade de dados verificados, com um m√≠nimo de 10 MB para cada solicita√ß√£o. </li></ul><br><p>  Para corrigir isso, usamos o AWS Glue Crawler, que verificar√° os dados no S3 e registrar√° as informa√ß√µes da parti√ß√£o no Glue Metastore.  Isso nos permitir√° usar parti√ß√µes como um filtro para solicita√ß√µes no Athena, e ele somente examinar√° os diret√≥rios especificados na solicita√ß√£o. </p><br><h3 id="nastraivaem-amazon-glue-crawler">  Personalizar o Amazon Glue Crawler </h3><br><p>  O Amazon Glue Crawler verifica todos os dados no bucket S3 e cria tabelas de parti√ß√£o.  Crie um rastreador de cola no console da AWS Glue e adicione o balde no qual voc√™ armazena os dados.  Voc√™ pode usar um rastreador para v√°rios buckets; nesse caso, ele criar√° tabelas no banco de dados especificado com nomes que correspondem aos nomes dos buckets.  Se voc√™ planeja usar esses dados o tempo todo, certifique-se de ajustar a programa√ß√£o de inicializa√ß√£o do rastreador para atender √†s suas necessidades.  Usamos um rastreador para todas as tabelas, que √© executado a cada hora. </p><br><h3 id="particirovannye-tablicy">  Tabelas Particionadas </h3><br><p>  Ap√≥s o primeiro in√≠cio do rastreador, as tabelas para cada intervalo verificado devem aparecer no banco de dados especificado nas configura√ß√µes.  Abra o console do Athena e encontre a tabela com os logs do Nginx.  Vamos tentar ler algo: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">"default"</span></span>.<span class="hljs-string"><span class="hljs-string">"part_demo_kinesis_bucket"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span>( partition_0 = <span class="hljs-string"><span class="hljs-string">'2019'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> partition_1 = <span class="hljs-string"><span class="hljs-string">'04'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> partition_2 = <span class="hljs-string"><span class="hljs-string">'08'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> partition_3 = <span class="hljs-string"><span class="hljs-string">'06'</span></span> );</code> </pre> <br><p>  Esta consulta selecionar√° todos os registros recebidos das 6 √†s 7 da manh√£ de 8 de abril de 2019.  Mas quanto mais eficaz do que apenas ler de uma tabela n√£o particionada?  Vamos descobrir e selecionar os mesmos registros, filtrando-os por carimbo de data / hora: </p><br><p><img src="https://habrastorage.org/webt/mu/bg/me/mubgmef262bxyte5dsqsa1q_hag.png" alt="Pedido sem parti√ß√µes"></p><br><p>  3,59 segundos e 244,34 megabytes de dados no conjunto de dados, nos quais h√° apenas uma semana de logs.  Vamos tentar o filtro por parti√ß√µes: </p><br><p><img src="https://habrastorage.org/webt/9-/n4/dc/9-n4dczjdvcrspm0zbypq-ul5cs.png" alt="Solicita√ß√£o de filtro de parti√ß√£o"></p><br><p>  Um pouco mais r√°pido, mas o mais importante - apenas 1,23 megabytes de dados!  Seria muito mais barato se n√£o fosse pelo pre√ßo m√≠nimo de 10 megabytes por solicita√ß√£o.  Mas √© muito melhor de qualquer maneira, e em grandes conjuntos de dados a diferen√ßa ser√° muito mais impressionante. </p><br><h2 id="sobiraem-deshbord-s-pomoschyu-cubejs">  Crie um painel usando o Cube.js </h2><br><p>  Para criar um painel, usamos a estrutura anal√≠tica Cube.js.  Ele tem algumas fun√ß√µes, mas estamos interessados ‚Äã‚Äãem duas: a capacidade de usar automaticamente filtros em parti√ß√µes e pr√©-agrega√ß√£o de dados.  Ele usa um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">esquema de dados</a> escrito em Javascript para gerar SQL e executar uma consulta ao banco de dados.  Tudo o que √© necess√°rio para n√≥s √© indicar como usar o filtro de parti√ß√£o no esquema de dados. </p><br><p>  Vamos criar um novo aplicativo Cube.js.  Como j√° usamos a pilha da AWS, √© l√≥gico usar o Lambda para implanta√ß√£o.  Voc√™ pode usar o modelo expresso para gera√ß√£o se planeja hospedar o back-end Cube.js no Heroku ou Docker.  A documenta√ß√£o descreve outros <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">m√©todos de hospedagem</a> . </p><br><pre> <code class="bash hljs">$ npm install -g cubejs-cli $ cubejs create nginx-log-analytics -t serverless -d athena</code> </pre> <br><p>  Vari√°veis ‚Äã‚Äãde ambiente s√£o usadas para configurar o acesso ao banco de dados em cube.js.  O gerador criar√° um arquivo .env no qual voc√™ pode especificar suas chaves para o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Athena</a> . </p><br><p>  Agora precisamos de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">um esquema de dados</a> no qual indicamos como nossos logs s√£o armazenados.  L√° voc√™ pode especificar como ler m√©tricas para pain√©is. </p><br><p>  No diret√≥rio de <code>schema</code> , crie o arquivo <code>Logs.js</code>  Aqui est√° um exemplo de modelo de dados para nginx: </p><br><div class="spoiler">  <b class="spoiler_title">C√≥digo do modelo</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> partitionFilter = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">from</span></span></span></span><span class="hljs-function"><span class="hljs-params">, to</span></span></span><span class="hljs-function">) =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">` date(from_iso8601_timestamp(</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${</span></span><span class="hljs-keyword"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-keyword">from</span></span></span></span><span class="hljs-string"><span class="hljs-subst">}</span></span></span><span class="hljs-string">)) &lt;= date_parse(partition_0 || partition_1 || partition_2, '%Y%m%d') AND date(from_iso8601_timestamp(</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${to}</span></span></span><span class="hljs-string">)) &gt;= date_parse(partition_0 || partition_1 || partition_2, '%Y%m%d') `</span></span> cube(<span class="hljs-string"><span class="hljs-string">`Logs`</span></span>, { <span class="hljs-attr"><span class="hljs-attr">sql</span></span>: <span class="hljs-string"><span class="hljs-string">` select * from part_demo_kinesis_bucket WHERE </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${FILTER_PARAMS.Logs.createdAt.filter(partitionFilter)}</span></span></span><span class="hljs-string"> `</span></span>, <span class="hljs-attr"><span class="hljs-attr">measures</span></span>: { <span class="hljs-attr"><span class="hljs-attr">count</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">`count`</span></span>, }, <span class="hljs-attr"><span class="hljs-attr">errorCount</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">`count`</span></span>, <span class="hljs-attr"><span class="hljs-attr">filters</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">sql</span></span>: <span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${CUBE.isError}</span></span></span><span class="hljs-string"> = 'Yes'`</span></span> } ] }, <span class="hljs-attr"><span class="hljs-attr">errorRate</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">`number`</span></span>, <span class="hljs-attr"><span class="hljs-attr">sql</span></span>: <span class="hljs-string"><span class="hljs-string">`100.0 * </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${errorCount}</span></span></span><span class="hljs-string"> / </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${count}</span></span></span><span class="hljs-string">`</span></span>, <span class="hljs-attr"><span class="hljs-attr">format</span></span>: <span class="hljs-string"><span class="hljs-string">`percent`</span></span> } }, <span class="hljs-attr"><span class="hljs-attr">dimensions</span></span>: { <span class="hljs-attr"><span class="hljs-attr">status</span></span>: { <span class="hljs-attr"><span class="hljs-attr">sql</span></span>: <span class="hljs-string"><span class="hljs-string">`status`</span></span>, <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">`number`</span></span> }, <span class="hljs-attr"><span class="hljs-attr">isError</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">`string`</span></span>, <span class="hljs-attr"><span class="hljs-attr">case</span></span>: { <span class="hljs-attr"><span class="hljs-attr">when</span></span>: [{ <span class="hljs-attr"><span class="hljs-attr">sql</span></span>: <span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${CUBE}</span></span></span><span class="hljs-string">.status &gt;= 400`</span></span>, <span class="hljs-attr"><span class="hljs-attr">label</span></span>: <span class="hljs-string"><span class="hljs-string">`Yes`</span></span> }], <span class="hljs-attr"><span class="hljs-attr">else</span></span>: { <span class="hljs-attr"><span class="hljs-attr">label</span></span>: <span class="hljs-string"><span class="hljs-string">`No`</span></span> } } }, <span class="hljs-attr"><span class="hljs-attr">createdAt</span></span>: { <span class="hljs-attr"><span class="hljs-attr">sql</span></span>: <span class="hljs-string"><span class="hljs-string">`from_unixtime(created_at)`</span></span>, <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">`time`</span></span> } } });</code> </pre> </div></div><br><p>  Aqui usamos a vari√°vel <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">FILTER_PARAMS</a> para gerar uma consulta SQL com um filtro de parti√ß√£o. </p><br><p>  Tamb√©m especificamos as m√©tricas e par√¢metros que queremos exibir no painel e especificamos as pr√©-agrega√ß√µes.  O Cube.js criar√° tabelas adicionais com dados pr√©-agregados e atualizar√° automaticamente os dados assim que estiverem dispon√≠veis.  Isso n√£o apenas acelera as solicita√ß√µes, mas tamb√©m reduz o custo do uso do Athena. </p><br><p>  Inclua essas informa√ß√µes no arquivo do esquema de dados: </p><br><pre> <code class="javascript hljs">preAggregations: { <span class="hljs-attr"><span class="hljs-attr">main</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">`rollup`</span></span>, <span class="hljs-attr"><span class="hljs-attr">measureReferences</span></span>: [count, errorCount], <span class="hljs-attr"><span class="hljs-attr">dimensionReferences</span></span>: [isError, status], <span class="hljs-attr"><span class="hljs-attr">timeDimensionReference</span></span>: createdAt, <span class="hljs-attr"><span class="hljs-attr">granularity</span></span>: <span class="hljs-string"><span class="hljs-string">`day`</span></span>, <span class="hljs-attr"><span class="hljs-attr">partitionGranularity</span></span>: <span class="hljs-string"><span class="hljs-string">`month`</span></span>, <span class="hljs-attr"><span class="hljs-attr">refreshKey</span></span>: { <span class="hljs-attr"><span class="hljs-attr">sql</span></span>: FILTER_PARAMS.Logs.createdAt.filter(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">from</span></span></span></span><span class="hljs-function"><span class="hljs-params">, to</span></span></span><span class="hljs-function">) =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">`select CASE WHEN from_iso8601_timestamp(</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${to}</span></span></span><span class="hljs-string">) + interval '3' day &gt; now() THEN date_trunc('hour', now()) END`</span></span> ) } } }</code> </pre> <br><p>  Nesse modelo, indicamos que √© necess√°rio agregar previamente os dados para todas as m√©tricas usadas e usar o particionamento mensal.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O particionamento de pr√©-agrega√ß√µes</a> pode acelerar significativamente a coleta e atualiza√ß√£o de dados. </p><br><p>  Agora podemos montar um painel! </p><br><p>  O back-end do Cube.js fornece uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">API REST</a> e um conjunto de bibliotecas de clientes para estruturas de front-end populares.  Usaremos a vers√£o React do cliente para criar o painel.  O Cube.js fornece apenas dados, por isso precisamos de uma biblioteca para visualiza√ß√µes - eu gosto de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">recargas</a> , mas voc√™ pode usar qualquer. </p><br><p>  O servidor Cube.js aceita a solicita√ß√£o no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">formato JSON</a> , que indica as m√©tricas necess√°rias.  Por exemplo, para calcular quantos erros o Nginx deu por dia, voc√™ precisa enviar a seguinte solicita√ß√£o: </p><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"measures"</span></span>: [<span class="hljs-string"><span class="hljs-string">"Logs.errorCount"</span></span>], <span class="hljs-attr"><span class="hljs-attr">"timeDimensions"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"dimension"</span></span>: <span class="hljs-string"><span class="hljs-string">"Logs.createdAt"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dateRange"</span></span>: [<span class="hljs-string"><span class="hljs-string">"2019-01-01"</span></span>, <span class="hljs-string"><span class="hljs-string">"2019-01-07"</span></span>], <span class="hljs-attr"><span class="hljs-attr">"granularity"</span></span>: <span class="hljs-string"><span class="hljs-string">"day"</span></span> } ] }</code> </pre> <br><p>  Instale o cliente Cube.js e a biblioteca de componentes React via NPM: </p><br><pre> <code class="bash hljs">$ npm i --save @cubejs-client/core @cubejs-client/react</code> </pre> <br><p>  Importamos <code>cubejs</code> e componentes QueryRenderer para descarregar os dados e coletamos o painel: </p><br><div class="spoiler">  <b class="spoiler_title">C√≥digo do painel</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> React <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { LineChart, Line, XAxis, YAxis } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'recharts'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> cubejs <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@cubejs-client/core'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { QueryRenderer } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@cubejs-client/react'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> cubejsApi = cubejs( <span class="hljs-string"><span class="hljs-string">'YOUR-CUBEJS-API-TOKEN'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">apiUrl</span></span>: <span class="hljs-string"><span class="hljs-string">'http://localhost:4000/cubejs-api/v1'</span></span> }, ); <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> &lt;QueryRenderer query={{ measures: [</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'Logs.errorCount'</span></span></span></span><span class="hljs-function"><span class="hljs-params">], timeDimensions: [{ dimension: </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'Logs.createdAt'</span></span></span></span><span class="hljs-function"><span class="hljs-params">, dateRange: [</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'2019-01-01'</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'2019-01-07'</span></span></span></span><span class="hljs-function"><span class="hljs-params">], granularity: </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'day'</span></span></span></span><span class="hljs-function"><span class="hljs-params"> }] }} cubejsApi={cubejsApi} render={({ resultSet }</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!resultSet) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'Loading...'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ( &lt;LineChart data={resultSet.rawData()}&gt; &lt;XAxis dataKey="Logs.createdAt"/&gt; &lt;YAxis/&gt; &lt;Line type="monotone" dataKey="Logs.errorCount" stroke="#8884d8"/&gt; &lt;/LineChart&gt; ); }} /&gt; ) }</code> </pre> </div></div><br><p>  As fontes do painel est√£o dispon√≠veis no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">CodeSandbox</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt447886/">https://habr.com/ru/post/pt447886/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt447876/index.html">Tudo est√° muito ruim ou um novo tipo de intercepta√ß√£o de tr√°fego</a></li>
<li><a href="../pt447878/index.html">Verificando o rdesktop e o xrdp com o PVS-Studio</a></li>
<li><a href="../pt447880/index.html">Validando rdesktop e xrdp usando o analisador PVS-Studio</a></li>
<li><a href="../pt447882/index.html">Ferramentas de rede ou por onde come√ßar o pentester?</a></li>
<li><a href="../pt447884/index.html">N√≥s descobrimos como o 5G funcionar√° na faixa de mil√≠metros na rua e em ambientes fechados</a></li>
<li><a href="../pt447890/index.html">Gra√ßas a Deus eu n√£o sou gerente</a></li>
<li><a href="../pt447892/index.html">Dois novos concursos PHDays: desvio de IDS e hackers de f√°brica</a></li>
<li><a href="../pt447894/index.html">MODX Digest # 3 (25 de mar√ßo a 8 de abril de 2019)</a></li>
<li><a href="../pt447896/index.html">Fotos de esbo√ßos aproximados: exatamente como a rede neural NVIDIA GauGAN funciona</a></li>
<li><a href="../pt447898/index.html">Fil√≥sofos bem alimentados ou programa√ß√£o .NET competitiva</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>