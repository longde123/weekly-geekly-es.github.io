<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßëüèø ü§öüèº üíÜüèø Configure el lanzamiento autom√°tico de pruebas de IU de aplicaciones de Android a trav√©s de TeamCity üë©üèø‚Äçüöí ‚è±Ô∏è ü§í</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Tarde o temprano, cualquier probador que desarrolle la pr√°ctica de la autoevaluaci√≥n enfrenta el problema de la ejecuci√≥n aut√≥noma de sus pruebas. Ade...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Configure el lanzamiento autom√°tico de pruebas de IU de aplicaciones de Android a trav√©s de TeamCity</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/415769/">  Tarde o temprano, cualquier probador que desarrolle la pr√°ctica de la autoevaluaci√≥n enfrenta el problema de la ejecuci√≥n aut√≥noma de sus pruebas.  Adem√°s, si el especialista tiene experiencia, entonces trata de lidiar con esto lo antes posible.  Entonces, despu√©s de la primera prueba de autotest exitosa ejecutada localmente, decid√≠ configurar inmediatamente el lanzamiento en TeamCity. <br><br>  Observo que en nuestra empresa pr√°cticamente no hay experiencia en el lanzamiento remoto de pruebas instrumentales de Android, por lo que tuve que buscar en Google, pero tampoco encontr√© ninguna gu√≠a detallada all√≠.  Por lo tanto, decid√≠ cortar estas instrucciones. <br><a name="habracut"></a><br>  En la entrada tenemos: <br><br><ul><li>  Las pruebas se ejecutan con √©xito localmente </li><li>  ejecutando el servidor TeamCity </li><li>  servidor en debian con KVM y X </li></ul><br>  <i>El descargo de responsabilidad inmediatamente sobre el servidor donde se realizar√° el lanzamiento: la configuraci√≥n del sistema operativo, la virtualizaci√≥n de hardware y el shell gr√°fico no es el tema de este art√≠culo y se omitir√°.</i> <br><br><h3>  Instalar y configurar el agente de TeamCity </h3><br>  Comencemos con Java.  Lo principal aqu√≠ es elegir la versi√≥n correcta.  Tuve 3 dependencias: las pruebas en s√≠, las herramientas de Android y el agente de teamcity.  Par√© en la versi√≥n 8 para usar una JVM para todos.  Si tiene menos suerte y habr√° conflictos, deber√° configurar el uso de varias versiones de Java en la misma m√°quina.  Una nota m√°s: si tiene Debian, primero debe agregar el repositorio webupd8team (google es muy r√°pido). <br><br><pre><code class="bash hljs">sudo apt-get install oracle-java8-installer sudo apt-get install oracle-java8-set-default</code> </pre> <br>  A continuaci√≥n, cree un usuario bajo el cual se iniciar√° el agente y, en consecuencia, todo lo dem√°s.  No olvides establecer una contrase√±a. <br><br><pre> <code class="bash hljs">sudo useradd -d /home/tc_agent -s /bin/bash -m tc_agent sudo passwd tc_agent</code> </pre> <br>  La distribuci√≥n del agente se puede realizar en la interfaz web de su teamcity.  Para hacerlo, vaya a la secci√≥n <i>Agentes</i> y haga clic en el enlace <i>Instalar agentes de compilaci√≥n</i> en la esquina superior derecha.  Descargue y descomprima en la carpeta deseada en el servidor (recomiendo la carpeta de inicio de nuestro usuario - <code>/home/tc_agent</code> ).  A continuaci√≥n, agregue los derechos para ejecutar todos los scripts: <br><br><pre> <code class="bash hljs">sudo chmod +x /home/tc_agent/BuildAgent/bin/*</code> </pre> <br>  Si su versi√≥n de teamcity admite Agent Push, entonces a√∫n es m√°s f√°cil.  Simplemente abra la pesta√±a correspondiente en la interfaz web, haga clic en el bot√≥n <i>Instalar agente ...</i> y siga las instrucciones. <br><br>  Configuramos una configuraci√≥n.  Si utiliz√≥ una instalaci√≥n remota, ya se ha creado y solo necesita especificar el nombre del agente en ella.  Si no, cree: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /home/tc_agent/BuildAgent/conf cp buildAgent.dist.properties buildAgent.properties nano buildAgent.properties</code> </pre> <br>  <code>serverUrl=</code> direcci√≥n de la interfaz web del servidor, y <code>name=</code> nombre √∫nico del agente.  Si tiene varios agentes o el puerto predeterminado (9090) est√° ocupado, configure el suyo usando el par√°metro <code>ownPort=</code> . <br><br>  Iniciamos <code>/home/tc_agent/BuildAgent/bin/agent.sh start</code> comando <code>/home/tc_agent/BuildAgent/bin/agent.sh start</code> .  Si todo est√° configurado correctamente, veremos a nuestro agente en la pesta√±a <i>No autorizado</i> .  Autorizamos y puedes usar. <br><br>  Para iniciar el agente autom√°ticamente, cree el script <code>/etc/init.d/teamcity_agent</code> con el siguiente contenido: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash BINARY="/home/tc_agent/BuildAgent/bin/agent.sh" RUNAS="tc_agent" LOGFILE="/home/tc_agent/BuildAgent/logs/start.log" CMD="$BINARY $1 $2" runuser - "$RUNAS" -c "$CMD &gt; $LOGFILE" cat $LOGFILE</span></span></code> </pre><br>  Agregue los derechos para ejecutar <code>sudo chmod +x /etc/init.d/teamcity_agent</code> y agregue la l√≠nea <code>/etc/init.d/teamcity_agent start</code> al archivo <code>/etc/rc.local</code> . <br><br>  Control de reinicio, el agente ha subido, seguimos adelante. <br><br><h3>  Instalar Android SDK y emulador </h3><br>  Descargue las <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">herramientas de Android SDK</a> (solo herramientas de l√≠nea de comandos) y descompr√≠malo en el directorio deseado.  Cree un directorio para almacenar futuras im√°genes AVD (debe haber suficiente espacio).  Para m√≠, los administradores han conectado el repositorio principal al directorio <code>/var,</code> y pondr√© todo all√≠.  A continuaci√≥n, cambiamos el propietario de los archivos a nuestro usuario y los siguientes pasos se realizan mejor con √©l. <br><br><pre> <code class="bash hljs">sudo chown tc_agent -R /var/opt/android-sdk sudo mkdir /var/opt/.android sudo chown tc_agent /var/opt/.android</code> </pre> <br>  Agregar variables de entorno.  Abra el archivo <code>/home/tc_agent/.bash_profile</code> para editarlo y escriba: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">export</span></span> ANDROID_HOME=/var/opt/android-sdk <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> ANDROID_AVD_HOME=/var/opt/.android/avd <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> PATH=<span class="hljs-variable"><span class="hljs-variable">$ANDROID_HOME</span></span>/platform-tools:<span class="hljs-variable"><span class="hljs-variable">$PATH</span></span> <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> PATH=<span class="hljs-variable"><span class="hljs-variable">$ANDROID_HOME</span></span>/tools:<span class="hljs-variable"><span class="hljs-variable">$PATH</span></span></code> </pre> <br>  Reiniciamos y verificamos que las variables se muestran correctamente en la interfaz web de teamcity en la pesta√±a <i>Par√°metros</i> del <i>agente</i> . <br><br>  Intentamos ejecutar sdkmanager: el <code>$ANDROID_HOME/tools/bin/sdkmanager --list</code> debe enumerar los paquetes instalados y disponibles.  Si obtiene un error como <code>Exception in thread "main" java.lang.NoClassDefFoundError</code> , pruebe <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">esta soluci√≥n</a> . <br><br>  Instale las herramientas necesarias y las im√°genes de las m√°quinas virtuales. <br><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$ANDROID_HOME</span></span>/tools/bin/sdkmanager emulator platform-tools tools <span class="hljs-variable"><span class="hljs-variable">$ANDROID_HOME</span></span>/tools/bin/sdkmanager <span class="hljs-string"><span class="hljs-string">'system-images;android-25;google_apis;x86'</span></span></code> </pre> <br><h3>  Crea y ejecuta AVD </h3><br>  Entonces, descargamos la imagen de <code>'system-images;android-25;google_apis;x86'</code> (Android 7.1.1), creamos un dispositivo virtual basado en √©l.  No entrar√© en detalles de todos los par√°metros posibles de la utilidad avdmanager, lo mostrar√© en la cantidad m√≠nima posible: <br><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$ANDROID_HOME</span></span>/tools/bin/avdmanager create avd -n avd_name -k <span class="hljs-string"><span class="hljs-string">"system-images;android-25;google_apis;x86"</span></span></code> </pre> <br>  Transferimos el nombre y la imagen original (debe descargarse previamente a trav√©s de sdkmanager).  Si el error regresa, agregue la bandera <code>-v</code> para ver el texto. <br><br>  Pasamos al emulador.  Primero, verifique el emulador, plataformas, herramientas de plataforma, carpetas de im√°genes del sistema en el directorio SDK.  Cre√© plataformas con mis manos, el resto se cre√≥ al instalar paquetes a trav√©s de sdkmanager.  A continuaci√≥n, verifique la aceleraci√≥n de hardware.  Deber√≠a haber tal respuesta. <br><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$ANDROID_HOME</span></span>/emulator/emulator -accel-check accel: 0 KVM (version 12) is installed and usable. accel</code> </pre><br>  Si hay un error al acceder a <code>/dev/kvm</code> , agregue los derechos: <br><br><pre> <code class="bash hljs">addgroup kvm usermod -a -G kvm tc_agent chown root:kvm /dev/kvm</code> </pre><br>  Adem√°s, todav√≠a necesitaba instalar QEMU: <code>sudo apt-get install qemu-kvm</code> <br>  Realice un nuevo inicio de sesi√≥n y vuelva a comprobar el emulador. <br><br>  Si todo est√° bien, intente ejecutar.  Para ver a trav√©s de los ojos, con√©ctese al servidor a trav√©s de vnc.  Y ejecuta el emulador: <br><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$ANDROID_HOME</span></span>/emulator/emulator @avd_name</code> </pre> <br>  La siguiente ventana deber√≠a aparecer: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/xh/j8/ba/xhj8ba7qlv8xivwalti-cg9mf-m.png"></div><br>  Durante las ejecuciones de prueba, ejecutaremos sin gr√°ficos, por lo que agregaremos el par√°metro <code>-no-window</code> . <br><br><h3>  Configurar compilaci√≥n en TeamCity </h3><br>  Pasamos a la etapa final: configurar un lanzamiento aut√≥nomo de nuestras pruebas.  Obtuve una compilaci√≥n de 4 pasos. <br><br>  1. Iniciando el emulador <br><br><pre> <code class="bash hljs">nohup /var/opt/android-sdk/emulator/emulator @avd_name -no-snapshot-save -no-boot-anim -no-window -snapshot clean_snap_1 &gt; start_emulator.log 2&gt;&amp;1&amp;</code> </pre> <br>  Dado que el emulador "bloquea" el terminal, debe desatar el proceso utilizando la utilidad nohup (puede hacerlo de otra manera, usted decide).  Por si acaso, guarde el registro del emulador en el archivo <code>start_emulator.log</code> .  Para ejecutar las pruebas, cre√© una instant√°nea limpia (vea <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> c√≥mo hacerlo) y agregu√© el interruptor <code>-no-snapshot-save</code> para que no se sobrescribiera. <br><br>  2. Esperando a que el dispositivo arranque. <br><br><pre> <code class="bash hljs">adb <span class="hljs-built_in"><span class="hljs-built_in">wait</span></span>-for-device shell <span class="hljs-string"><span class="hljs-string">'while [[ -z $(getprop sys.boot_completed) ]]; do sleep 1; done;'</span></span></code> </pre> <br>  Primero, esperamos el estado de <code>wait-for-device</code> , luego en el bucle esperamos cuando la variable <code>sys.boot_completed</code> devuelve 1. <br><br>  3. Ejecuci√≥n de pruebas.  Aqu√≠ todo es individual, aqu√≠ est√° mi ejemplo: <br><br><pre> <code class="bash hljs">./gradlew clean connectedAndroidTest</code> </pre> <br>  4. Cierre el emulador.  Aqu√≠ he hecho una simple terminaci√≥n del proceso. <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">kill</span></span> -s 2 `pgrep qemu-system`</code> </pre> <br>  Pero, por supuesto, es mejor recordar la ID del proceso al crear el emulador.  Esto ser√° necesario cuando comencemos a ejecutar las pruebas en varios subprocesos, lo que accidentalmente no "mata" el proceso incorrecto. <br><br>  Eso es todo, gracias por leer.  Si hay comentarios de colegas m√°s experimentados, con gusto har√© cambios en el manual. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es415769/">https://habr.com/ru/post/es415769/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es415759/index.html">La NSA ha comenzado a eliminar metadatos que se registraron debido a un "error t√©cnico"</a></li>
<li><a href="../es415761/index.html">Qu√©, c√≥mo y por qu√© en los anuncios jugables</a></li>
<li><a href="../es415763/index.html">El gobierno de los Estados Unidos est√° discutiendo la posibilidad de recuperar el control sobre la IANA [pero esto es poco probable]</a></li>
<li><a href="../es415765/index.html">¬øPor qu√© VMware decidi√≥ crear una plataforma para desarrollar blockchains empresariales?</a></li>
<li><a href="../es415767/index.html">Tesla Inc ha abierto la posibilidad de pedir un Tesla Model 3 para residentes de Canad√° y Estados Unidos</a></li>
<li><a href="../es415771/index.html">Ir compilador: lenguaje de descripci√≥n de reglas de optimizaci√≥n de SSA</a></li>
<li><a href="../es415773/index.html">Requisitos no funcionales: escalabilidad</a></li>
<li><a href="../es415775/index.html">Consejos simples, pero no obvios, para preparar un informe para una conferencia genial</a></li>
<li><a href="../es415777/index.html">El primer campeonato de aprendizaje autom√°tico en desarrollo</a></li>
<li><a href="../es415779/index.html">Implementaci√≥n de una plataforma segura de software NAS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>