<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ¨ ğŸˆ´ ğŸ‡ğŸ¿ Conversion en continu des bases de donnÃ©es Firebird 2.5 au format ODS12 (Firebird 3.0) âœŒğŸ¾ ğŸ¤³ğŸ¿ ğŸ§“ğŸ½</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Chaque version de Firebird a sa propre version du format des structures de base de donnÃ©es de disques - O (n) D (isk) S (tructure). Avant la version 2...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Conversion en continu des bases de donnÃ©es Firebird 2.5 au format ODS12 (Firebird 3.0)</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/445204/">  Chaque version de Firebird a sa propre version du format des structures de base de donnÃ©es de disques - O (n) D (isk) S (tructure).  Avant la version 2.5 incluse, le moteur Firebird pouvait fonctionner avec les ODS des versions prÃ©cÃ©dentes, c'est-Ã -dire que les bases de donnÃ©es des anciennes versions Ã©taient ouvertes par la nouvelle version et fonctionnaient en mode de compatibilitÃ©, mais le moteur Firebird 3.0 ne fonctionne qu'avec une base de donnÃ©es dans sa propre version ODS 12.0. <br><br>  Pour passer Ã  3.0, la base de donnÃ©es de 2.5 doit Ãªtre convertie dans un nouveau format via sauvegarde / restauration.  Bien sÃ»r, nous supposons que la base de donnÃ©es a Ã©tÃ© prÃ©alablement prÃ©parÃ©e pour la conversion - c.-Ã -d.  les mÃ©tadonnÃ©es et les requÃªtes ont Ã©tÃ© testÃ©es pour la compatibilitÃ© avec Firebird 3.0. <br><br>  Si vous suivez l'approche standard, cela signifie que vous devez sauvegarder sur la version 2.5, puis installer 3.0 et effectuer une restauration.  Cette procÃ©dure est acceptable s'il y a suffisamment de temps, mais lors de la migration de grandes bases de donnÃ©es, ou lors de la migration de plusieurs dizaines de bases de donnÃ©es en mÃªme temps, lorsque le temps est comptÃ©, vous pouvez utiliser la conversion de flux, ce qui est 30 Ã  40% plus rapide.  Comment faire exactement cela (sous Windows et sous Linux), lire sous le chat. <br><a name="habracut"></a><br>  L'idÃ©e gÃ©nÃ©rale est que pour l'accÃ©lÃ©ration, nous utiliserons le pipeline: <br><br><pre><code class="plaintext hljs">gbak -b â€¦ 25 stdout | gbak -c â€¦ stdin 30</code> </pre> <br>  Gbak Ã  partir de 2.5 gÃ©nÃ¨re une sauvegarde au format linÃ©aire et l'envoie Ã  stdout, qui rÃ©cupÃ¨re immÃ©diatement gbak Ã  partir de 3.0 via stdin et crÃ©e une nouvelle base de donnÃ©es. <br><br>  Il est nÃ©cessaire d'organiser un tel pipeline en utilisant la mÃ©thode d'accÃ¨s local (fichier), car l'accÃ¨s au rÃ©seau (mÃªme via localhost) ralentira considÃ©rablement le processus. <br><br>  Ci-dessous, nous examinons les dÃ©tails pour Windows et Linux. <br><br>  <b>Windows</b> <br><br>  Dans le cas de Windows, le moyen le plus simple est de crÃ©er une version entiÃ¨rement autonome de Firebird.  Pour ce faire, prenez l' <a href="">archive</a> intÃ©grÃ©e <a href="">Firebird 2.5</a> , renommez fbemded.dll en fbclient.dll, ajoutez les utilitaires gbak.exe Ã  partir de l'archive 2.5 Â«habituelleÂ» et (Ã©ventuellement) isql.exe. <br><br>  Firebird 3.0 utilise un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">seul assemblage</a> et ne nÃ©cessite aucune modification. <br><br>  La plus petite option (qui ne nÃ©cessite pas l'installation de bibliothÃ¨ques d'exÃ©cution VS2008 / VS2010 sur le systÃ¨me cible) contient les fichiers suivants: <br><br><pre> <code class="plaintext hljs">25/gbak.exe 25/fbclient.dll 25/firebird.conf 25/firebird.log 25/firebird.msg 25/ib_util.dll 25/icudt30.dll 25/icuin30.dll 25/icuuc30.dll 25/Microsoft.VC80.CRT.manifest 25/msvcp80.dll 25/msvcr80.dll 30/fbclient.dll 30/firebird.conf 30/firebird.msg 30/gbak.exe 30/ib_util.dll 30/icudt52.dll 30/icudt52l.dat 30/icuin52.dll 30/icuuc52.dll 30/msvcp100.dll 30/msvcr100.dll 30/intl/fbintl.conf 30/intl/fbintl.dll 30/plugins/engine12.dll</code> </pre> <br>  Un administrateur expÃ©rimentÃ© peut remarquer que intl / fbintl.dll et intl / fbintl.conf ne sont pas inclus dans 2.5.  C'est vrai, car gbak n'utilise pas de caractÃ¨re de connexion et ne convertit pas les donnÃ©es entre caractÃ¨res, mais du cÃ´tÃ© "rÃ©ception" de Firebird 3.0, ces fichiers sont nÃ©cessaires lors de la crÃ©ation d'index. <br><br>  Dans firebird.conf, Firebird 3.0 recommande d'ajouter: <br><br><pre> <code class="plaintext hljs">MaxUnflushedWrites = -1 MaxUnflushedWriteTime = -1</code> </pre> <br>  En outre, il est conseillÃ© de dÃ©finir diffÃ©rentes valeurs IpcName pour 2.5 et 3.0. <br><br>  Lors du choix des valeurs d'autres paramÃ¨tres, firebird.conf procÃ¨de d'une simple considÃ©ration: au stade du transfert de donnÃ©es, dans un processus, gbak exÃ©cute 2.5, et dans l'autre 3.0, puis 2.5 se termine et 3.0 commence Ã  construire des index. <br><br>  Pour accÃ©lÃ©rer la phase de construction des index dans 3.0, il est recommandÃ© d'augmenter la taille du paramÃ¨tre TempCacheLimit Ã  ~ 40% de RAM (s'il s'agit d'un serveur dÃ©diÃ©, bien sÃ»r). <br><br>  Par exemple, si le serveur dispose de 16 Go de RAM, vous pouvez mettre <br><br><pre> <code class="plaintext hljs">TempCacheLimit=6G</code> </pre> <br>  <i>Bien sÃ»r, cette valeur ne peut Ãªtre dÃ©finie que pour Firebird 3 64 bits, car tout processus 32 bits ne pourra pas allouer plus de 2 gigaoctets de mÃ©moire.</i> <br><br>  Ã€ 2,5, ce paramÃ¨tre n'a pas besoin d'Ãªtre modifiÃ© - il ne peut dÃ©jÃ  pas dÃ©passer 2 gigaoctets et il n'affecte pas la vitesse pendant la sauvegarde. <br><br>  Avant d'effectuer l'opÃ©ration, vous devez vÃ©rifier que le cache de page dans l'en-tÃªte de la base de donnÃ©es est dÃ©fini sur 0 (commande <code>gstat -h databasename</code> , voir la ligne Page buffers). <br><br>  Si le cache est spÃ©cifiÃ© explicitement dans l'en-tÃªte de la base de donnÃ©es, il remplace les valeurs de firebird.conf (et databases.conf dans 3.0), et en cas de valeurs insuffisamment grandes, il peut entraÃ®ner une consommation de mÃ©moire excessive et passer au swap. <br><br>  Ensuite, copiez les fichiers sur le systÃ¨me cible. <br><br>  La conversion est effectuÃ©e aprÃ¨s l'arrÃªt du service Â«systÃ¨meÂ» Firebird 2.5, sur la ligne de commande avec des privilÃ¨ges croissants pour l'administrateur local (exemple): <br><br><pre> <code class="plaintext hljs">set ISC_USER= "25/gbak" -z -b -g -v -st t -y 25.log 25 stdout|^ "30/gbak" -z -c -v -st t -y 30.log stdin 30</code> </pre> <br>  Cet exemple utilise Â«rectiligne obliqueÂ» entre guillemets (Â«style unixÂ» valide) et Â«chapeauÂ» (caractÃ¨re Â«^Â») Ã©chappe au caractÃ¨re de saut de ligne, ce qui est pratique lors de la saisie de commandes longues.  L'option -st (atus) est apparue dans Firebird 2.5.8 et vous permet d'Ã©crire des donnÃ©es sur la durÃ©e de fonctionnement du processus gbak dans le protocole (voir la documentation pour plus de dÃ©tails). <br><br>  <b>Linux</b> <br><br>  Sous Linux, Firebird 3 dÃ©pend de la bibliothÃ¨que tommath.  Dans CentOS (RHEL), cette bibliothÃ¨que est dans le dÃ©pÃ´t epel, dans Ubuntu (Debian) elle est dans le systÃ¨me. <br><br>  Pour CentOS, vous devez d'abord connecter le rÃ©fÃ©rentiel epel et ensuite seulement <br><br><pre> <code class="plaintext hljs">yum install libtommath</code> </pre> <br>  Ubuntu n'a pas besoin de connecter des rÃ©fÃ©rentiels supplÃ©mentaires, mais diffÃ©rentes versions des packages sont installÃ©es sur Ubuntu 16 et Ubuntu 18 - libtommath0 et libtommath1, respectivement. <br><br>  Firebird 3.0 recherche tommath.so.0 et pour Ubuntu 18, il est Ã©galement nÃ©cessaire de crÃ©er un lien (lien symbolique) entre tommath.so.0 et tommath.so.1.  Pour ce faire, vous devez d'abord trouver tommath.so.1. <br><br>  Le chemin de recherche dans Ubuntu est <code>/usr/lib/x86_64-linux-gnu/</code> , mais dans d'autres distributions basÃ©es sur Debian, il peut Ãªtre diffÃ©rent. <br><br>  Le deuxiÃ¨me problÃ¨me est qu'avant Firebird 3.0.1, inclus, il n'y avait pas de moyen facile d'installer deux versions diffÃ©rentes du serveur.  Nous ne considÃ©rons pas l'option Â«compiler depuis la source avec le prÃ©fixe souhaitÃ©Â» en raison de sa relative complexitÃ©. <br><br>  Pour Firebird 3.0.2 et supÃ©rieur, une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">version avec â€“enable-binreloc</a> et une option d'installation distincte (-path path) sont implÃ©mentÃ©es. <br><br>  En supposant que la bibliothÃ¨que tommath et, si nÃ©cessaire, le lien symbolique pour tommath.so.0 ont Ã©tÃ© ajoutÃ©s au systÃ¨me, vous pouvez ajouter la distribution Firebird 3.0.4 rÃ©elle (au moment d'Ã©crire ces lignes), par exemple, / opt / fb3: <br><br><pre> <code class="plaintext hljs">./install.sh -path /opt/fb3</code> </pre> <br>  AprÃ¨s cela, vous pouvez arrÃªter le service systÃ¨me Firebird et dÃ©marrer la conversion en streaming. <br><br>  <i>Lors de l'arrÃªt de Firebird, il convient de garder Ã  l'esprit que les processus Firebid 2.5 en mode classique dÃ©marrent gÃ©nÃ©ralement xinetd - il est donc nÃ©cessaire de dÃ©sactiver le service firebird pour xinetd ou d'arrÃªter complÃ¨tement xinetd.</i> <br><br>  Dans firebird.conf for 3.0 sous Linux, vous n'avez pas besoin de dÃ©finir les paramÃ¨tres MaxUnflushed (ils ne fonctionnent que sous Windows) et de modifier les paramÃ¨tres de Firebird 2.5. <br><br>  Sous Linux, l'accÃ¨s local (fichier) de Firebird 2.5 n'est pas Ã©quivalent Ã  la version intÃ©grÃ©e pour Windows - le serveur 2.5 fonctionnera dans le processus gbak (sans la partie rÃ©seau), mais les droits d'accÃ¨s seront vÃ©rifiÃ©s par rapport Ã  la base d'utilisateurs, ce qui signifie que non seulement une connexion, mais aussi un mot de passe seront nÃ©cessaires : <br><br><pre> <code class="plaintext hljs">export ISC_USER=username ISC_PASSWORD=password /opt/firebird/bin/gbak -b â€¦ 25 stdout\ |/opt/fb3/bin/gbak -c â€¦ stdin 30</code> </pre> <br>  AprÃ¨s une conversion rÃ©ussie, vous devez d'abord supprimer Firebird 3.0 "supplÃ©mentaire", puis Firebird 2.5 "principal", et seulement aprÃ¨s cela, effectuez une nouvelle installation de Firebird 3.0 - le meilleur de tous depuis le programme d'installation tar.gz normal, et non via les rÃ©fÃ©rentiels, car  la version dans les rÃ©fÃ©rentiels peut Ãªtre en retard. <br><br>  De plus, aprÃ¨s avoir restaurÃ© la base de donnÃ©es Linux et l'avoir rÃ©installÃ©e, vous devez vÃ©rifier que la nouvelle base de donnÃ©es a le propriÃ©taire de l'utilisateur firebird. <br><br>  Si ce n'est pas le cas, il sera nÃ©cessaire de corriger <br><br><pre> <code class="plaintext hljs">chown firebird.firebird database</code> </pre> <br>  <b>RÃ©sumÃ©</b> <br><br>  En plus d'Ã©conomiser du temps et de l'espace disque, la conversion de flux prÃ©sente un autre avantage important - la conversion de la base de donnÃ©es se fait sans supprimer Firebird 2.5 existant, ce qui simplifie considÃ©rablement la restauration si la conversion Ã©choue (le plus souvent en raison d'un manque d'espace ou d'un redÃ©marrage inattendu pendant le processus de migration). <br><br>  Le gain de temps est dÃ» au fait que la conversion "classique" est "temps de sauvegarde" plus "temps de rÃ©cupÃ©ration".  La rÃ©cupÃ©ration se compose de deux parties: lire les donnÃ©es d'un fichier de sauvegarde et crÃ©er un index. <br><br>  Dans la conversion en streaming, le temps total est obtenu comme Â«temps de sauvegarde plus cinq Ã  dix pour centÂ» et Â«temps de construction d'indexÂ». <br><br>  Les rÃ©sultats spÃ©cifiques dÃ©pendent de la structure de la base de donnÃ©es, mais en moyenne, le temps de rÃ©cupÃ©ration est approximativement Ã©gal au temps de double sauvegarde.  Par consÃ©quent, si nous prenons le temps de sauvegarde par unitÃ©, alors la Â«conversion classiqueÂ» - trois unitÃ©s de temps, le flux - deux unitÃ©s de temps.  Une augmentation de TempCacheLimit contribue Ã©galement Ã  rÃ©duire le temps. <br><br>  En gÃ©nÃ©ral, la conversion de flux dans la pratique vous permet d'Ã©conomiser 30 Ã  40% pour cent du temps d'une sauvegarde et d'un restaurant alternatifs. <br><br>  <b>Des questions?</b> <br><br>  Veuillez Ã©crire toutes les questions dans les commentaires ou envoyer Ã  l'auteur de la mÃ©thodologie et co-auteur de cet article - Vasily Sidorov, ingÃ©nieur systÃ¨me leader d'iBase, chez bs at ibase ru. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr445204/">https://habr.com/ru/post/fr445204/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr445194/index.html">10 concepts pour un designer en 2019</a></li>
<li><a href="../fr445196/index.html">Kubernetes 1.14: AperÃ§u des principales innovations</a></li>
<li><a href="../fr445198/index.html">Lecteur de console Cmus pour Linux</a></li>
<li><a href="../fr445200/index.html">Les fournisseurs d'accÃ¨s Internet demandent au ministÃ¨re des Communications de les laisser entrer chez eux sans contrat</a></li>
<li><a href="../fr445202/index.html">Happy Potter et l'Ordre de CSS</a></li>
<li><a href="../fr445206/index.html">RÃ©duisez les temps d'arrÃªt lors de la mise Ã  niveau de Zimbra</a></li>
<li><a href="../fr445208/index.html">Niveaux de maturitÃ© informatique d'entreprise</a></li>
<li><a href="../fr445210/index.html">Colonie de crypto-monnaie</a></li>
<li><a href="../fr445212/index.html">NetBIOS entre les mains d'un pirate</a></li>
<li><a href="../fr445214/index.html">Nous pompons les crochets React Ã  l'aide de FRP</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>