<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🛀🏻 🐞 🧚 Kubernetes中自动缩放的三个级别：如何有效使用它们 🤙 🧚🏿 👨‍🎨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="要完全掌握Kubernetes，您需要了解扩展集群资源的各种方法：根据系统开发人员的说法，这是Kubernetes的主要任务之一。 我们已经对水平和垂直自动缩放和群集大小调整的机制进行了高级审查，并提供了有关如何有效使用它们的建议。 

 Kubernetes Autoscaling 101撰写的文...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Kubernetes中自动缩放的三个级别：如何有效使用它们</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/484344/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/ns/da/j-/nsdaj-fipddnizqrkx4z2rzvyc0.png"></div><br> 要完全掌握Kubernetes，您需要了解扩展集群资源的各种方法：根据<a href="https://speakerdeck.com/thockin/everything-you-ever-wanted-to-know-about-resource-scheduling-dot-dot-dot-almost">系统开发人员的</a>说法，这是Kubernetes的主要任务之一。 我们已经对水平和垂直自动缩放和群集大小调整的机制进行了高级审查，并提供了有关如何有效使用它们的建议。 <br><br>  <a href="https://www.magalix.com/blog/kubernetes-autoscaling-101">Kubernetes Autoscaling 101撰写</a>的文章<a href="https://www.magalix.com/blog/kubernetes-autoscaling-101">：集群自动缩放器，水平自动</a> <a href="https://mcs.mail.ru/containers/">缩放器</a> <a href="https://www.magalix.com/blog/kubernetes-autoscaling-101">和垂直Pod自动</a> <a href="https://mcs.mail.ru/containers/">缩放</a>器由一个团队翻译，该团队在<a href="https://mcs.mail.ru/containers/">Mail.ru</a>中的<a href="https://mcs.mail.ru/containers/">Kubernetes aaS</a>中实现了<a href="https://mcs.mail.ru/containers/">自动缩放</a> 。 <br><a name="habracut"></a><br><h2> 为什么考虑扩展很重要 </h2><br>  <a href="https://mcs.mail.ru/blog/kubernetes-for-much-stuff">Kubernetes</a>是一种资源管理和编排工具。 当然，很高兴修改凉爽的部署，监视和Pod管理功能（pod模块是响应请求而启动的一组容器）。 <br><br> 但是，您应该考虑以下问题： <br><br><ol><li> 如何扩展模块和应用程序？ <br></li><li> 如何保持集装箱的运转和效率？ <br></li><li> 如何应对用户不断变化的代码和工作负载？ <br></li></ol><br> 配置Kubernetes集群以平衡资源和性能可能是一个挑战;这需要Kubernetes内部的专业知识。 您的应用程序或服务上的工作负载可能会在一整天甚至一小时内波动，因此最好将平衡表示为一个连续的过程。 <br><br><h2>  Kubernetes自动缩放级别 </h2><br> 有效的自动缩放需要两个级别之间的协调： <br><br><ol><li>  Pod级别，包括水平（Horizo​​ntal Pod Autoscaler，HPA）和垂直自动缩放（Vertical Pod Autoscaler，VPA）。 这正在扩展容器的可用资源。 <br></li><li> 群集级别由群集自动缩放器（CA）控制，可以增加或减少群集中的节点数。 <br></li></ol><br><h2> 水平自动缩放模块（HPA） </h2><br> 顾名思义，HPA可扩展Pod副本的数量。 作为更改副本数量的触发器，大多数开发人员都使用CPU和内存负载。 但是，您可以基于<a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/">自定义指标</a> ， <a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/">指标</a>的<a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/">组合</a>甚至是<a href="https://cloud.google.com/kubernetes-engine/docs/tutorials/external-metrics-autoscaling">外部指标</a>来扩展系统。 <br><br> 高级HPA工作流程： <br><br><ol><li>  HPA以30秒的默认间隔连续检查安装期间指定的度量标准值。 <br></li><li> 如果达到指定的阈值，则HPA尝试增加模块数量。 <br></li><li>  HPA更新部署/复制控制器中的副本数。 <br></li><li> 然后，部署/复制控制器将部署所有必需的附加模块。 <br></li></ol><br><img src="https://habrastorage.org/getpro/habr/post_images/879/338/b0e/879338b0e99aa2b652ab1406e9677319.jpg"><br>  <i>达到指标阈值时，HPA启动模块部署过程</i> <br><br> 使用HPA时，请考虑以下事项： <br><br><ul><li> 默认的HPA验证间隔为30秒。 通过控制器管理器中的<i>horizo​​ntal-pod-autoscaler-sync-period</i>标志进行设置。 <br></li><li> 默认相对误差为10％。 <br></li><li> 在模块数量最后增加之后，HPA希望指标在三分钟内稳定下来。 该间隔由<i>horizo​​ntal-pod-autoscaler-upscale-delay</i>标志设置。 <br></li><li>在最后一次减少模块数量之后，HPA有望稳定五分钟。 该间隔由<i>horizo​​ntal-pod-autoscaler-downscale-delay</i>标志设置。 <br></li><li>  HPA与部署对象（而不是复制控制器）一起使用时效果最佳。 水平自动缩放与直接操作复制控制器的滚动更新不兼容。 部署时，副本数直接取决于部署对象。 <br></li></ul><br><h2> 吊舱垂直自动缩放 </h2><br> 垂直自动缩放（VPA）将更多（或更少）的处理器或内存时间分配给现有的Pod。 它适用于具有或不具有状态无状态的Pod，但主要用于状态服务。 但是，如果需要自动调整最初分配的资源量，则可以将VPA应用于无状态模块。 <br><br>  VPA还响应OOM事件（内存不足，内存不足）。 要更改处理器时间和内存大小，需要重新启动Pod。 重新启动时，VPA会遵循<a href="https://kubernetes.io/docs/concepts/workloads/pods/disruptions/">Pod分配预算（PDB</a> ），以确保最少的模块数量。 <br><br> 您可以为每个模块设置最小和最大资源量。 因此，您可以将最大分配内存限制为8 GB。 如果当前节点不能为每个容器分配超过8 GB的内存，这将很有用。 详细的规格和操作机制在<a href="">VPA官方Wiki中</a>进行了描述。 <br><br> 另外，VPA具有有趣的推荐功能（VPA推荐器）。 它基于基于历史指标的智能算法，跟踪所有模块的资源利用率和OOM事件，以提供新的内存和处理器时间值。 还有一个API，它使用pod描述符并返回建议的资源值。 <br><br> 值得注意的是，VPA Recommender不会监视资源的“限制”。 这可能导致模块垄断节点内的资源。 最好在名称空间级别设置一个限制值，以避免浪费大量的内存或处理器时间。 <br><br>  VPA的高级方案： <br><br><ol><li>  VPA以默认间隔10秒连续检查安装期间指定的度量标准值。 <br></li><li> 如果达到指定的阈值，则VPA尝试更改分配的资源量。 <br></li><li>  VPA更新部署/复制控制器中的资源量。 <br></li><li> 重新启动模块时，所有新资源都将应用于创建的实例。 <br></li></ol><br><img src="https://habrastorage.org/getpro/habr/post_images/738/82e/e90/73882ee906b515bcf4c9a8ab42a742b6.jpg"><br>  <i>VPA添加了所需的资源量</i> <br><br> 使用VPA时请考虑以下几点： <br><br><ul><li> 缩放需要强制重启Pod。 为避免进行更改后的不稳定操作，这是必要的。 为了可靠性，模块将根据新分配的资源重新启动并在节点之间分配。 <br></li><li>  VPA和HPA尚不兼容，不能在同一吊舱上工作。 如果在同一群集中同时使用两种缩放机制，请确保设置不允许在同一对象上激活它们。 <br></li><li>  VPA仅根据过去和当前的使用情况来配置容器对资源的请求。 它没有对资源使用设置限制。 应用程序的不正确操作可能会出现问题，这些问题将开始占用越来越多的资源，这将导致Kubernetes关闭此pod。 <br></li><li>  VPA仍处于发展初期。 准备在不久的将来系统可能会发生一些变化。 您可以阅读有关<a href="https://github.com/kubernetes/autoscaler/tree/master/vertical-pod-autoscaler">已知限制</a>和<a href="">开发计划的信息</a> 。 因此，计划是实施VPA和HPA的联合工作，以及模块的部署以及针对它们的垂直自动扩展策略（例如，特殊标签“ require VPA”）。 <br></li></ul><br><h2>  Kubernetes集群自动扩展 </h2><br> 群集自动缩放器（CA）根据等待的Pod数更改节点数。 系统会定期检查挂起的模块-如果需要更多资源并且集群未超过既定限制，则增加集群大小。  CA与云服务提供商进行交互，向其请求其他节点或释放空闲节点。  CA的第一个公开版本是在Kubernetes 1.8中引入的。 <br><br> 高级操作方案CA： <br><br><ol><li>  CA以默认间隔10秒检查处于待机状态的模块。 <br></li><li> 如果由于群集中可用的资源不足而无法分配一个或几个模块，则它会尝试准备一个或几个其他节点。 <br></li><li> 当云服务提供商分配所需的节点时，它会加入集群并准备为Pod模块提供服务。 <br></li><li>  Kubernetes Scheduler将待处理的模块分发到新主机。 如果在此之后某些模块仍保持待机状态，则重复该过程并将新节点添加到群集中。 <br></li></ol><br><img src="https://habrastorage.org/getpro/habr/post_images/13a/65b/ac3/13a65bac364aca04c83fc6fe1a59c60f.jpg"><br>  <i>在云中自动分配群集节点</i> <br><br> 使用CA时，请考虑以下事项： <br><br><ul><li>  CA确保无论处理器负载如何，群集中的所有模块都可以运行。 此外，他尝试确保集群中没有不必要的节点。 <br></li><li>  CA会在约30秒后记录对扩展的需求。 <br></li><li> 在节点不再需要之后，CA默认会等待10分钟，然后再扩展系统。 <br></li><li> 在自动缩放系统中，存在扩展器的概念。 这些是选择要添加新节点的节点组的不同策略。 <br></li><li> 负责任地使用选项<i>cluster-autoscaler.kubernetes.io/safe-to-evict（true）</i> 。 如果安装许多Pod，或者其中许多Pod分散在所有节点上，则将大大失去缩减集群大小的能力。 <br></li><li> 使用<a href="https://kubernetes.io/docs/concepts/workloads/pods/disruptions/">PodDisruptionBudgets</a>防止删除Pod，因为应用程序的哪一部分可能完全失败。 <br></li></ul><br><h2>  Kubernetes自动缩放系统如何相互作用 </h2><br> 为了实现完美的和谐，应在Pod级别（HPA / VPA）和群集级别同时应用自动缩放。 它们相对简单地彼此交互： <br><br><ol><li>  HPA或VPA更新分配给现有Pod的Pod副本或资源。 <br></li><li> 如果没有足够的节点用于计划的扩展，则CA会注意到空闲状态下的Pod的存在。 <br></li><li>  CA分配新节点。 <br></li><li> 模块被分发到新节点。 <br></li></ol><br><img src="https://habrastorage.org/getpro/habr/post_images/20a/8c0/bef/20a8c0befe51c509efc2354c43aeaf13.jpg"><br>  <i>Kubernetes协作扩展系统</i> <br><br><h2> 常见的Kubernetes自动缩放错误 </h2><br> 开发人员在尝试应用自动缩放时会遇到一些典型问题。 <br><br>  HPA和VPA取决于指标和一些历史数据。 如果分配的资源不足，则模块将被折叠并且将无法生成指标。 在这种情况下，自动缩放将永远不会发生。 <br><br> 缩放操作本身是时间敏感的。 我们希望模块和集群能够快速扩展-在用户注意到任何问题或故障之前。 因此，应考虑吊舱和群集的平均扩展时间。 <br><br> 理想情况-4分钟： <br><br><ol><li>  30秒 目标指标更新：30-60秒。 <br></li><li>  30秒  HPA检查指标值：30秒。 <br></li><li> 少于2秒。  Pod模块已创建并进入待机状态：1秒。 <br></li><li> 少于2秒。  CA查看待处理的模块并发送呼叫以准备节点：1秒。 <br></li><li>  3分钟 云提供商分配节点。  K8等待直到准备就绪：最多10分钟（取决于多个因素）。 <br></li></ol><br> 最糟糕（更现实）的场景-12分钟： <br><br><ol><li>  30秒 目标指标更新。 <br></li><li>  30秒  HPA验证指标值。 <br></li><li> 少于2秒。  Pod模块已创建并进入待机状态。 <br></li><li> 少于2秒。  CA会看到挂起的模块，并发送呼叫以准备节点。 <br></li><li>  10分钟 云提供商分配节点。  K8等待直到准备就绪。 等待时间取决于几个因素，例如供应商的延迟，OS的延迟，辅助工具的工作。 <br></li></ol><br> 不要将云提供商的扩展机制与我们的CA混淆。 后者在Kubernetes集群内部工作，而云提供程序机制在节点分配的基础上工作。 他不知道您的Pod或应用程序正在发生什么。 这些系统并行工作。 <br><br><h2> 如何在Kubernetes中管理扩展 </h2><br><ol><li>  Kubernetes是一种资源管理和编排工具。 集群Pod和资源管理操作是Kubernetes开发的关键里程碑。 <br></li><li> 了解适用于HPA和VPA的Pod可扩展性逻辑。 <br></li><li> 仅当您充分了解吊舱和容器的需求时，才应使用CA。 <br></li><li> 为了获得最佳的群集配置，您需要了解各种扩展系统如何协同工作。 <br></li><li> 在评估扩展时间时，请记住最坏的情况和最好的情况。 <br></li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN484344/">https://habr.com/ru/post/zh-CN484344/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN484332/index.html">专注于任务管理。 我们如何做我们的管理系统</a></li>
<li><a href="../zh-CN484336/index.html">使用动态数组和自定义集合类的规则</a></li>
<li><a href="../zh-CN484338/index.html">三星的霓虹灯项目：数字银行家，电视节目主持人，同伴</a></li>
<li><a href="../zh-CN484340/index.html">1月17日的Java摘要。 新年的前两周</a></li>
<li><a href="../zh-CN484342/index.html">基于Eclipse和GTK +的工具包，用于“ Toradex Colibri T20（Linux）”</a></li>
<li><a href="../zh-CN484356/index.html">一个友好的团队中一个有趣的项目，或者合适的员工要花多少钱？</a></li>
<li><a href="../zh-CN484358/index.html">R中的投资组合管理</a></li>
<li><a href="../zh-CN484364/index.html">26岁的Yana Harlan领导了太空引擎的开发。 明年，他们计划启动它。</a></li>
<li><a href="../zh-CN484368/index.html">我如何为电报创建搜索引擎</a></li>
<li><a href="../zh-CN484370/index.html">Slurm SRE-学习确保用户满意</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>