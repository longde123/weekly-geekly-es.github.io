<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>âš›ï¸ ğŸš¨ ğŸŒ Ù‚Ù„ÙŠÙ„Ø§ Ø¹Ù† Ø¨Ø±Ù…Ø¬Ø© ESP8266 ÙÙŠ C ØªØ­Øª FreeRTOS ğŸŒ¸ ğŸ‘¨ğŸ¿â€ğŸ­ ğŸ˜¨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ CAP ØŒ ÙˆÙ„ÙƒÙ† Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ù…ÙŠØ²Ø§Ù†ÙŠØ© ÙƒØ§ÙÙŠØ© Ù„Ø°Ù„Ùƒ. 

 Ø¨Ø¯Ø§ÙØ¹ Ù…Ù† Ø§Ø³ØªØ¬Ø§Ø¨Ø© Tarson Ù„ØªØ¹Ù„ÙŠÙ‚ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø±Ù…Ø¬Ø© ÙˆØªØ¨Ø§Ø¯Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ ARDUINO Ø¹Ø¨Ø± WIFI Ø¹Ø¨Ø± ESP...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Ù‚Ù„ÙŠÙ„Ø§ Ø¹Ù† Ø¨Ø±Ù…Ø¬Ø© ESP8266 ÙÙŠ C ØªØ­Øª FreeRTOS</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/406813/" style=";text-align:right;direction:rtl"> <i><b>ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ CAP ØŒ ÙˆÙ„ÙƒÙ† Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ù…ÙŠØ²Ø§Ù†ÙŠØ© ÙƒØ§ÙÙŠØ© Ù„Ø°Ù„Ùƒ.</b></i> <br><br>  Ø¨Ø¯Ø§ÙØ¹ Ù…Ù† Ø§Ø³ØªØ¬Ø§Ø¨Ø© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Tarson Ù„ØªØ¹Ù„ÙŠÙ‚ÙŠ</a> Ø¹Ù„Ù‰ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Ø§Ù„Ø¨Ø±Ù…Ø¬Ø© ÙˆØªØ¨Ø§Ø¯Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ ARDUINO Ø¹Ø¨Ø± WIFI Ø¹Ø¨Ø± ESP8266</a> ØŒ Ù‚Ø±Ø±Øª Ø£Ù† Ø£ÙƒØªØ¨ Ø¹Ù† Ø£Ø³Ø§Ø³ÙŠØ§Øª Ø§Ù„Ø¨Ø±Ù…Ø¬Ø© ESP8266 ÙÙŠ C ØªØ­Øª FreeRTOS.  Ø§Ù„ØªÙØ§ØµÙŠÙ„ ØªØ­Øª Ø§Ù„Ù‚Ø·Ø¹. <br><a name="habracut"></a><br>  <b>Ø§Ù„Ø®Ø·ÙˆØ© 0 - Ø§Ù„Ø¬Ù‡Ø§Ø²</b> <br><br>  ØªØ­ØªØ§Ø¬ Ø£ÙˆÙ„Ø§Ù‹ Ø¥Ù„Ù‰ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø² Ù…Ø¹ ESP8266 ØŒ ÙÙ…Ù† Ø§Ù„Ù…Ø³ØªØ­Ø³Ù† Ø£Ù† ÙŠØªÙ… ÙØµÙ„ USB Ø¥Ù„Ù‰ UART ØŒ Ø­ØªÙ‰ Ù„Ø§ ØªØ¶Ø·Ø± Ø¥Ù„Ù‰ Ø¥ÙŠÙ‚Ø§Ù ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø¨Ø±Ù…Ø¬.  Ø£Ù‚Ø¶ÙŠ ØªØ¬Ø§Ø±Ø¨ÙŠ Ø§Ù„Ù„Ø§Ø¥Ù†Ø³Ø§Ù†ÙŠØ© ÙÙŠ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">NodeMCU</a> . <br><br>  <b>Ù„Ø°Ø§ ØŒ Ø§Ù„Ø®Ø·ÙˆØ© 1 - Ø§Ø¬Ù…Ø¹ Ø³Ù„Ø³Ù„Ø© Ø§Ù„Ø£Ø¯ÙˆØ§Øª</b> <br><br>  ØªØ­ØªØ§Ø¬ Ø£ÙˆÙ„Ø§Ù‹ Ø¥Ù„Ù‰ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø² ÙƒÙ…Ø¨ÙŠÙˆØªØ± Ù…Ø«Ø¨Øª Ø¹Ù„ÙŠÙ‡ ØªÙˆØ²ÙŠØ¹ Linux (Ù„Ø¯ÙŠ OpenSUSE Leap).  Ù†Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ github Ø¹Ù„Ù‰ Ø±Ø§Ø¨Ø· <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">tyts</a> ØŒ ÙˆÙ†Ù‚Ø±Ø£ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„ØªØ¬Ù…ÙŠØ¹ ØŒ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ÙˆÙ†Ø«Ø¨Øª</a> Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª Ø§Ù„Ù„Ø§Ø²Ù…Ø© ØŒ ÙˆÙ†Ù†Ø³Ø® Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ ØŒ ÙˆÙ†Ø¬Ù…Ø¹.  Ù‚Ù…Øª Ø¨Ø§Ø³ØªÙ†Ø³Ø§Ø® ÙÙŠ / opt / ESP ÙˆÙ‚Ø¨Ù„ ØªØ¬Ù…ÙŠØ¹ Ù‚ÙˆØ§Ø¹Ø¯ Makefile ØŒ Ù‚Ù… Ø¨ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª: <br><br><pre style=";text-align:right;direction:rtl"><code class="bash hljs">STANDALONE = n VENDOR_SDK = 2.1.0</code> </pre> <br>  Ø¨Ø¹Ø¯ Ø°Ù„Ùƒ ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³Ø§Ø± Ø¥Ù„Ù‰ Ø«Ù†Ø§Ø¦ÙŠØ§Øª Ø³Ù„Ø³Ù„Ø© Ø§Ù„Ø£Ø¯ÙˆØ§Øª ÙÙŠ PATH ÙÙŠ ~ / .bashrc: <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">export</span></span> PATH=/opt/ESP/esp-open-sdk/xtensa-lx106-elf/bin:<span class="hljs-variable"><span class="hljs-variable">$PATH</span></span></code> </pre><br>  <b>Ø§Ù„Ø®Ø·ÙˆØ© 2 - Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ SDK</b> <br><br>  Ù†Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ github ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">tynk</a> ) ØŒ ÙˆÙ†Ù‚Ø±Ø£ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª ØŒ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ÙˆÙ†Ø³ØªÙ†Ø³Ø®</a> (Ø¹Ù„Ù‰ Ø³Ø¨ÙŠÙ„ Ø§Ù„Ù…Ø«Ø§Ù„ ÙÙŠ / opt / ESP).  Ø¨Ø¹Ø¯ Ø°Ù„Ùƒ ØŒ Ù‚Ù…Ù†Ø§ Ø¨ØªØ¹ÙŠÙŠÙ† Ù…ØªØºÙŠØ± Ø§Ù„Ø¨ÙŠØ¦Ø© ESP8266_SDK_PATH Ø¨Ø·Ø±ÙŠÙ‚ØªÙ†Ø§ Ø§Ù„Ù…ÙØ¶Ù„Ø© (Ø¹Ù„Ù‰ Ø³Ø¨ÙŠÙ„ Ø§Ù„Ù…Ø«Ø§Ù„ ØŒ Ù…Ù† Ø®Ù„Ø§Ù„ ~ / .bashrc): <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">export</span></span> ESP8266_SDK_PATH=/opt/ESP/esp-open-rtos</code> </pre><br>  <b>Ø§Ù„Ø®Ø·ÙˆØ© 3 - Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø´Ø±ÙˆØ¹</b> <br><br>  Ù†Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø£Ù…Ø«Ù„Ø© ÙÙŠ Ø§Ù„Ø¯Ù„ÙŠÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… SDK ÙˆÙ†Ø³Ø® Ø£ÙŠ Ù…Ø«Ø§Ù„ ØªØ±ÙŠØ¯Ù‡.  Ù†Ø³ØªÙˆØ±Ø¯ / Ù†ÙØªØ­ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ÙÙŠ Ø¨ÙŠØ¦Ø© Ø§Ù„ØªØ·ÙˆÙŠØ± Ø§Ù„Ù…ÙØ¶Ù„Ø© Ù„Ø¯ÙŠÙ†Ø§ ØŒ ÙŠÙ…ÙƒÙ† Ù„Ù„Ù…Ø§Ø³ÙˆØ´ÙŠÙŠÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø­Ø±Ø± Ù†ØµÙˆØµ.  Ø£ÙØ¶Ù„ NetBeans - Ù„Ø¯ÙŠÙ‡Ø§ Ø¯Ø¹Ù… Ø¬ÙŠØ¯ Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ C / C ++ ØŒ Ø¨Ù…Ø§ ÙÙŠ Ø°Ù„Ùƒ ØªÙ„Ùƒ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù„Ù‰ Makefile.  ÙŠØªÙ… ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… make ØŒ ÙˆÙŠÙˆÙ…Ø¶ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… make flash.  ÙÙŠ Ù…Ù„Ù local.mk ØŒ ÙŠÙ…ÙƒÙ†Ùƒ ØªÙƒÙˆÙŠÙ† Ø§Ù„Ù…Ø¹Ù„Ù…Ø§Øª Ù„ØªØ­Ø¯ÙŠØ« Ø¬Ù‡Ø§Ø²Ùƒ (Ø§Ù„Ø­Ø¬Ù… ÙˆÙˆØ¶Ø¹ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø°Ø§ÙƒØ±Ø© ÙÙ„Ø§Ø´ ØŒ Ø¹Ù„Ù‰ Ø³Ø¨ÙŠÙ„ Ø§Ù„Ù…Ø«Ø§Ù„). <br><br>  <b>Ø§Ù„Ø®Ø·ÙˆØ© 4 - Ø§Ù„Ø¨Ø±Ù…Ø¬Ø©</b> <br><br>  Ù†Ù‚ÙˆÙ… Ø¨ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª ØŒ ÙˆÙ…Ø¬Ø§Ù„ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ ØŒ ÙˆØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„ÙÙ†ÙŠØ© ÙˆÙÙ‚Ù‹Ø§ Ù„Ù€ GOST 34.602-89 ØŒ ÙˆØ¨Ø¹Ø¯ Ø°Ù„Ùƒ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¨Ø¯Ø¡ ÙÙŠ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø±Ù…Ø² :) Ù„Ù† Ø£ÙˆÙ…Ø¶ Ø§Ù„Ù…ØµØ§Ø¨ÙŠØ­ ØŒ Ù„Ø£Ù†Ù†ÙŠ Ù„Ø§ Ø£Ù…Ù„ÙƒÙ‡Ø§ ØŒ Ù„Ø°Ø§ Ø³Ø£Ù‚Ø±Ø£ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù…Ø³ØªØ´Ø¹Ø± AM2302 Ø¨ØµÙØªÙŠ HelloWorld (Ø¥Ù†Ù‡ DHT22) ÙˆØ¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ø¹Ø¨Ø± Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ MQTT Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…. <br><br>  Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙˆØ­Ø¯Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© ØŒ Ø¹Ù„Ù‰ Ø³Ø¨ÙŠÙ„ Ø§Ù„Ù…Ø«Ø§Ù„ MQTT Ø£Ùˆ DHT ØŒ ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ø¥Ù„Ù‰ Makefile: <br><br><pre style=";text-align:right;direction:rtl"> <code class="hljs ruby">PROGRAM=fffmeteo EXTRA_COMPONENTS = extras/paho_mqtt_c extras/dht <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> $(ESP8266_SDK_PATH)/common.mk</code> </pre><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">main.h</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> MAIN_H #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MAIN_H #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; #include &lt;stdint.h&gt; #include &lt;limits.h&gt; #include &lt;FreeRTOS.h&gt; #include &lt;task.h&gt; #include &lt;queue.h&gt; #include &lt;semphr.h&gt; #define DEBUG #ifdef DEBUG #define debug(args...) printf("--- "); printf(args) #define SNTP_DEBUG_ENABLED true #else #define debug(args...) #define SNTP_DEBUG_ENABLED false #endif #define WIFI_SSID "kosmonaFFFt" #define WIFI_PASS "mysupermegapassword" #define MQTT_HOST "m11.cloudmqtt.com" #define MQTT_PORT 16464 #define MQTT_USER "kosmonaFFFt" #define MQTT_PASS "mysupermegapassword" #define MQTT_TOPIC "/meteo" #define NTP_SERVER "pool.ntp.org" #define UART0_BAUD 9600 #define STACK_SIZE 512 #define INIT_TASK_PRIORITY (configTIMER_TASK_PRIORITY + 1) #define MEASUREMENT_TASK_PRIORITY (INIT_TASK_PRIORITY + 1) #define SENDING_DATA_TASK_PRIORITY (MEASUREMENT_TASK_PRIORITY + 1) #define MEASUREMENTS_PERIOD_S 59 #define MAX_MEASUREMENTS_COUNT 16 #define SEND_PERIOD_S 120 #define RUN_SNTP_SYNC_PERIOD 5 #define MS(x) (x / portTICK_PERIOD_MS) #define AM2302_PIN 5 #ifdef __cplusplus extern "C" { #endif #ifdef __cplusplus } #endif #endif /* MAIN_H */</span></span></span></span></code> </pre><br></div></div><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø¬</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"main.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"sntp.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;esp/uart.h&gt; #include &lt;espressif/esp_common.h&gt; #include &lt;paho_mqtt_c/MQTTESP8266.h&gt; #include &lt;paho_mqtt_c/MQTTClient.h&gt; #include &lt;dht/dht.h&gt; //-----------------------------------------------------------------------------+ // Measurements task section. | //-----------------------------------------------------------------------------+ struct measurement_results { time_t timestamp; int am2302_humidity; int am2302_temperature; }; static QueueHandle_t measurements_queue; void measurement_task(void *arg) { int16_t humidity; int16_t temperature; struct measurement_results measurements; while (true) { debug("MEASUREMENTS: Start measurements...\n"); measurements.timestamp = time(NULL); bool success = dht_read_data(DHT_TYPE_DHT22, AM2302_PIN, &amp;humidity, &amp;temperature); if (success &amp;&amp; temperature &gt;= -500 &amp;&amp; temperature &lt;= 1500 &amp;&amp; humidity &gt;= 0 &amp;&amp; humidity &lt;= 1000) { measurements.am2302_humidity = humidity; measurements.am2302_temperature = temperature; } else { debug("MEASUREMENT: Error! Cannot read data from AM2302!!!\n"); measurements.am2302_humidity = INT_MIN; measurements.am2302_temperature = INT_MIN; } debug("MEASUREMENTS: Measurements finished...\n"); xQueueSendToBack(measurements_queue, &amp;measurements, MS(250)); vTaskDelay(MS(MEASUREMENTS_PERIOD_S * 1000)); } vTaskDelete(NULL); } //-----------------------------------------------------------------------------+ // Sending data task section. | //-----------------------------------------------------------------------------+ static uint8_t mqtt_buf[512]; static uint8_t mqtt_readbuf[128]; void sending_data_task(void *arg) { mqtt_network_t network; mqtt_network_new(&amp;network); mqtt_client_t client = mqtt_client_default; mqtt_packet_connect_data_t data = mqtt_packet_connect_data_initializer; uint8_t sntp_sync_counter = 0; while (true) { debug("MQTT: ConnectNetwork...\n"); int err = mqtt_network_connect(&amp;network, MQTT_HOST, MQTT_PORT); if (err) { debug("MQTT: Error!!! ConnectNetwork ERROR!\n"); vTaskDelay(MS(5 * 1000)); continue; } else { debug("MQTT: ConnectNetwork success...\n"); } // TODO: add check for errors!!! // TODO: replace magic constants!!! mqtt_client_new(&amp;client, &amp;network, 5000, mqtt_buf, 100, mqtt_readbuf, 100); data.willFlag = 0; data.MQTTVersion = 3; data.clientID.cstring = "fff"; data.username.cstring = MQTT_USER; data.password.cstring = MQTT_PASS; data.keepAliveInterval = 10; data.cleansession = 0; err = mqtt_connect(&amp;client, &amp;data); if (err) { debug("MQTT: Error!!! MQTTConnect ERROR!\n"); vTaskDelay(MS(5 * 1000)); continue; } else { debug("MQTT: MQTTConnect success...\n"); } struct measurement_results msg; while (xQueueReceive(measurements_queue, &amp;msg, 0) == pdTRUE) { if (msg.am2302_humidity == INT_MIN || msg.am2302_temperature == INT_MIN) { debug("MQTT: Got invalid message, no publishing!!!\n"); continue; } debug("MQTT: Got message to publish...\n"); debug(" timestamp: %ld\n", msg.timestamp); debug(" am2302_humidity: %.1f\n", msg.am2302_humidity / 10.0); debug(" am2302_temperature: %.1f\n", msg.am2302_temperature / 10.0); msg.timestamp = htonl(msg.timestamp); msg.am2302_humidity = htonl(msg.am2302_humidity); msg.am2302_temperature = htonl(msg.am2302_temperature); mqtt_message_t message; message.payload = &amp;msg; message.payloadlen = sizeof (msg); message.dup = 0; message.qos = MQTT_QOS1; message.retained = 0; err = mqtt_publish(&amp;client, MQTT_TOPIC, &amp;message); if (err) { debug("MQTT: Error!!! Error while publishing message!\n"); } else { debug("MQTT: Successfully publish message...\n"); } } mqtt_disconnect(&amp;client); mqtt_network_disconnect(&amp;network); ++sntp_sync_counter; if (sntp_sync_counter == RUN_SNTP_SYNC_PERIOD) { sntp_sync(NTP_SERVER, NULL, arg); sntp_sync_counter = 0; } vTaskDelay(MS(SEND_PERIOD_S * 1000)); } vTaskDelete(NULL); } //-----------------------------------------------------------------------------+ // Init task section. | //-----------------------------------------------------------------------------+ /** * This semaphore is taken during sntp sync and released after it finished. */ static SemaphoreHandle_t init_task_sem; /** * Set time and free init task semaphore. * @param error unused * @param arg unused */ void init_sntp_callback(int8_t error, void* arg) { time_t ts = time(NULL); debug("TIME: %s", ctime(&amp;ts)); xSemaphoreGive(init_task_sem); } /** * Connection parameters. */ static struct sdk_station_config STATION_CONFIG = { .ssid = WIFI_SSID, .password = WIFI_PASS, }; void init_task(void* arg) { debug("INIT: setting pins...\n"); gpio_set_pullup(AM2302_PIN, false, false); debug("INIT: Set station parameters...\n"); sdk_wifi_station_set_auto_connect(false); sdk_wifi_station_set_config(&amp;STATION_CONFIG); debug("Station parameters has been set.\n"); debug("INIT: Connecting to AP...\n"); sdk_wifi_station_connect(); while (sdk_wifi_station_get_connect_status() != STATION_GOT_IP) { vTaskDelay(MS(1000)); } debug("INIT: Connection to AP has been estabilished...\n"); debug("INIT: Start SNTP synchronization...\n"); init_task_sem = xSemaphoreCreateMutex(); if (!init_task_sem) { debug("INIT: Cannot create init task semaphore!!!"); return; } xSemaphoreTake(init_task_sem, 0); sntp_init(); sntp_sync(NTP_SERVER, init_sntp_callback, arg); BaseType_t result = pdFALSE; while (true) { debug("INIT: Trying to take init task semaphore...\n"); result = xSemaphoreTake(init_task_sem, MS(5 * 1000)); if (result == pdTRUE) { debug("INIT: Init task semaphore is taken...\n"); break; } } measurements_queue = xQueueCreate(MAX_MEASUREMENTS_COUNT, sizeof (struct measurement_results)); if (!measurements_queue) { debug("INIT: ERROR!!! Cannot create queue for measurements!\n"); goto fail; } result = xTaskCreate(measurement_task, "measurement_task", STACK_SIZE, NULL, MEASUREMENT_TASK_PRIORITY, NULL); if (result == pdFAIL) { debug("INIT: Measurement task creation failed!!!\n"); goto fail; } debug("INIT: Measurement task created...\n"); result = xTaskCreate(sending_data_task, "send_data_task", STACK_SIZE, NULL, SENDING_DATA_TASK_PRIORITY, NULL); if (result == pdFAIL) { debug("INIT: Send task creation failed!!!\n"); goto fail; } debug("INIT: Send data task created...\n"); fail: vSemaphoreDelete(init_task_sem); vTaskDelete(NULL); } //-----------------------------------------------------------------------------+ // Application entry point. | //-----------------------------------------------------------------------------+ void user_init(void) { debug("USER_INIT: SDK version: %s\n", sdk_system_get_sdk_version()); debug("USER_INIT: sizeof (int): %d\n", sizeof (int)); debug("USER_INIT: sizeof (float): %d\n", sizeof (float)); debug("USER_INIT: sizeof (time_t): %d\n", sizeof (time_t)); uart_set_baud(0, UART0_BAUD); BaseType_t result = xTaskCreate(init_task, (const char * const) "init_task", STACK_SIZE, NULL, INIT_TASK_PRIORITY, NULL); if (!result) { debug("USER_INIT: Cannot create init task!!!"); return; } }</span></span></span></span></code> </pre><br></div></div><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">sntp.h</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> SNTP_H #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SNTP_H #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;time.h&gt; #include &lt;stdint.h&gt; #ifdef __cplusplus extern "C" { #endif #define SNTP_ERR_OK 0 #define SNTP_ERR_CONTEXT -1 #define SNTP_ERR_DNS -2 #define SNTP_ERR_UDP_PCB_ALLOC -3 #define SNTP_ERR_PBUF_ALLOC -4 #define SNTP_ERR_SEND -5 #define SNTP_ERR_RECV_ADDR_PORT -6; #define SNTP_ERR_RECV_SIZE -7 #define SNTP_ERR_RECV_MODE -8 #define SNTP_ERR_RECV_STRATUM -9 typedef void (*sntp_sync_callback)(int8_t error, void *arg); void sntp_init(); void sntp_sync(char *server, sntp_sync_callback callback, void *callback_arg); time_t sntp_get_rtc_time(int32_t *us); void sntp_update_rtc(time_t t, uint32_t us); #ifdef __cplusplus } #endif #endif /* SNTP_H */</span></span></span></span></code> </pre><br></div></div><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">sntp.c</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"main.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"sntp.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;time.h&gt; #include &lt;string.h&gt; #include &lt;lwip/ip_addr.h&gt; #include &lt;lwip/err.h&gt; #include &lt;lwip/dns.h&gt; #include &lt;lwip/udp.h&gt; #include &lt;esp/rtc_regs.h&gt; #include &lt;espressif/esp_common.h&gt; #define TIMER_COUNT RTC.COUNTER /** * Daylight settings. * Base calculated with value obtained from NTP server (64 bits). */ #define SNTP_BASE (*((uint64_t*) RTC.SCRATCH)) /** * Timer value when base was obtained. */ #define SNTP_TIME_REF (RTC.SCRATCH[2]) /** * Calibration value. */ #define SNTP_CALIBRATION (RTC.SCRATCH[3]) /** * SNTP modes. */ #define SNTP_MODE_CLIENT 0x03 #define SNTP_MODE_SERVER 0x04 #define SNTP_MODE_BROADCAST 0x05 /** * Kiss-of-death code. */ #define SNTP_STRATUM_KOD 0x00 #define SNTP_OFFSET_LI_VN_MODE 0 #define SNTP_OFFSET_STRATUM 1 #define SNTP_OFFSET_RECEIVE_TIME 32 #define DIFF_SEC_1900_1970 (2208988800UL) struct sntp_message { uint8_t li_vn_mode; uint8_t stratum; uint8_t poll; uint8_t precision; uint32_t root_delay; uint32_t root_dispersion; uint32_t reference_identifier; uint32_t reference_timestamp[2]; uint32_t originate_timestamp[2]; uint32_t receive_timestamp[2]; uint32_t transmit_timestamp[2]; } __attribute__ ((packed)); struct sntp_sync_context { ip_addr_t ip_address; sntp_sync_callback callback; void* callback_arg; }; void sntp_init() { SNTP_BASE = 0; SNTP_CALIBRATION = 1; SNTP_TIME_REF = TIMER_COUNT; } void on_dns_found(const char* name, ip_addr_t* ipaddr, void* arg); void on_udp_recv(void* arg, struct udp_pcb* pcb, struct pbuf* p, ip_addr_t* addr, u16_t port); void sntp_sync(char* server, sntp_sync_callback callback, void* callback_arg) { int result = ERR_OK; debug("SNTP: Start SNTP synchronization, allocating memory for context...\n"); struct sntp_sync_context* context = malloc(sizeof (struct sntp_sync_context)); if (!context) { debug("SNTP: Error!!! Cannot allocate memory for context!\n"); result = SNTP_ERR_CONTEXT; goto fail; } context-&gt;callback = callback; context-&gt;callback_arg = callback_arg; debug("SNTP: Context successfully allocated...\n"); debug("SNTP: Start DNS lookup...\n"); err_t err = dns_gethostbyname(server, &amp;(context-&gt;ip_address), on_dns_found, context); if (!(err == ERR_OK || err == ERR_INPROGRESS)) { debug("SNTP: Error!!! DNS lookup error!\n"); result = SNTP_ERR_DNS; goto fail; } return; fail: if (context) { free(context); } if (callback) { callback(result, callback_arg); } } // //============================================================================================================================================================== // void on_dns_found(const char* name, ip_addr_t* ipaddr, void* arg) { debug("SNTP: Start DNS lookup successfully finished...\n"); int result = ERR_OK; struct sntp_sync_context* context = arg; sntp_sync_callback callback = context-&gt;callback; void* callback_arg = context-&gt;callback_arg; debug("SNTP: Creating upd_pcb...\n"); struct udp_pcb* sntp_pcb = udp_new(); if (!sntp_pcb) { debug("SNTP: Error!!! Cannot allocate udp_pcb!\n"); result = SNTP_ERR_UDP_PCB_ALLOC; goto fail; } debug("SNTP: Successfully created upd_pcb...\n"); debug("SNTP: Allocating pbuf...\n"); struct pbuf* p = pbuf_alloc(PBUF_TRANSPORT, sizeof (struct sntp_message), PBUF_RAM); if (!p) { debug("SNTP: Error!!! DNS lookup error!\n"); result = SNTP_ERR_PBUF_ALLOC; goto fail; } struct sntp_message* message = p-&gt;payload; memset(message, 0, sizeof (struct sntp_message)); message-&gt;li_vn_mode = 0b00100011; // li = 00, vn = 4, mode = 3 debug("SNTP: Pbuf allocated successfully...\n"); debug("SNTP: Sending data to server...\n"); udp_recv(sntp_pcb, on_udp_recv, context); err_t err = udp_sendto(sntp_pcb, p, ipaddr, 123); pbuf_free(p); if (err != ERR_OK) { debug("SNTP: Error!!! data sending error!\n"); result = SNTP_ERR_SEND; goto fail; } debug("SNTP: Data sent...\n"); return; fail: if (context) { free(context); } if (sntp_pcb) { udp_remove(sntp_pcb); } if (callback) { callback(result, callback_arg); } } void on_udp_recv(void* arg, struct udp_pcb* pcb, struct pbuf* p, ip_addr_t* addr, u16_t port) { debug("SNTP: Response has successfully received...\n"); int result = ERR_OK; struct sntp_sync_context* context = arg; sntp_sync_callback callback = context-&gt;callback; void* callback_arg = context-&gt;callback_arg; debug("SNTP: Checking response size...\n"); if (p-&gt;tot_len &lt; sizeof (struct sntp_message)) { debug("SNTP: Error!!! Invalid response size!\n"); result = SNTP_ERR_RECV_SIZE; goto fail; } debug("SNTP: Response size is OK...\n"); debug("SNTP: Checking mode...\n"); u8_t mode = 0x0; pbuf_copy_partial(p, &amp;mode, sizeof (mode), SNTP_OFFSET_LI_VN_MODE); mode &amp;= 0b00000111; if (mode != SNTP_MODE_SERVER &amp;&amp; mode != SNTP_MODE_BROADCAST) { debug("SNTP: Error!!! Invalid mode!\n"); result = SNTP_ERR_RECV_MODE; goto fail; } debug("SNTP: Mode is OK...\n"); debug("SNTP: Checking stratum...\n"); u8_t stratum = 0x0; pbuf_copy_partial(p, &amp;stratum, sizeof (stratum), SNTP_OFFSET_STRATUM); if (stratum == SNTP_STRATUM_KOD) { debug("SNTP: Error!!! Kiss of death!\n"); result = SNTP_ERR_RECV_STRATUM; goto fail; } debug("SNTP: Stratum is OK...\n"); debug("SNTP: Updating system timer...\n"); uint32_t receive_time[2]; pbuf_copy_partial(p, &amp;receive_time, 2 * sizeof (uint32_t), SNTP_OFFSET_RECEIVE_TIME); time_t t = ntohl(receive_time[0]) - DIFF_SEC_1900_1970; uint32_t us = ntohl(receive_time[1]) / 4295; sntp_update_rtc(t, us); debug("SNTP: System timer updated...\n"); fail: if (context) { free(context); } if (pcb) { udp_remove(pcb); } if (callback) { callback(result, callback_arg); } } /** * Check if a timer wrap has occurred. Compensate sntp_base reference * if affirmative. * TODO: think about multitasking and race conditions. */ inline void sntp_check_timer_wrap(uint32_t current_value) { if (current_value &lt; SNTP_TIME_REF) { // Timer wrap has occurred, compensate by subtracting 2^32 to ref. SNTP_BASE -= 1LLU &lt;&lt; 32; } } /** * Return secs. If us is not a null pointer, fill it with usecs */ time_t sntp_get_rtc_time(int32_t *us) { time_t secs; uint32_t tim; uint64_t base; tim = TIMER_COUNT; // Check for timer wrap. sntp_check_timer_wrap(tim); base = SNTP_BASE + tim - SNTP_TIME_REF; secs = base * SNTP_CALIBRATION / (1000000U &lt;&lt; 12); if (us) { *us = base * SNTP_CALIBRATION % (1000000U &lt;&lt; 12); } return secs; } /** * Update RTC timer. Called by SNTP module each time it receives an update. */ void sntp_update_rtc(time_t t, uint32_t us) { // Apply daylight and timezone correction // DEBUG: Compute and print drift int64_t sntp_current = SNTP_BASE + TIMER_COUNT - SNTP_TIME_REF; int64_t sntp_correct = (((uint64_t) us + (uint64_t) t * 1000000U) &lt;&lt; 12) / SNTP_CALIBRATION; debug("RTC Adjust: drift = %ld ticks, cal = %d\n", (time_t) (sntp_correct - sntp_current), SNTP_CALIBRATION); SNTP_TIME_REF = TIMER_COUNT; SNTP_CALIBRATION = sdk_system_rtc_clock_cali_proc(); SNTP_BASE = (((uint64_t) us + (uint64_t) t * 1000000U) &lt;&lt; 12) / SNTP_CALIBRATION; } /** * Syscall implementation. doesn't seem to use tzp. */ int _gettimeofday_r(struct _reent* r, struct timeval* tp, void* tzp) { // Syscall defined by xtensa newlib defines tzp as void* // So it looks like it is not used. Also check tp is not NULL if (tzp || !tp) { return EINVAL; } tp-&gt;tv_sec = sntp_get_rtc_time((int32_t*) &amp; tp-&gt;tv_usec); return 0; }</span></span></span></span></code> </pre><br></div></div><br>  Ø§Ù†Ø­Ø¯Ø§Ø± ØºÙ†Ø§Ø¦ÙŠ Ø­ÙˆÙ„ ØªÙˆÙØ± Ø±Ù…Ø² Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ø¹Ø¨Ø± SNTP: ÙÙŠ Ø§Ù„Ø§Ù…ØªØ¯Ø§Ø¯Ø§Øª Ù…Ù† SDK Ù‡Ù†Ø§Ùƒ Ø¨Ø§Ù„ÙØ¹Ù„ Ù…Ø«Ù„ Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ­Ø¯Ø© ØŒ ÙˆÙ„ÙƒÙ† Ù„Ø³Ø¨Ø¨ Ù…Ø§ Ù„Ù… ÙŠØ¹Ø¬Ø¨Ù†ÙŠ (Ù…Ù†Ø° ÙˆÙ‚Øª Ø·ÙˆÙŠÙ„ ØŒ Ù„Ø§ Ø£ØªØ°ÙƒØ± Ø§Ù„Ø³Ø¨Ø¨) ØŒ Ù„Ø°Ù„Ùƒ Ù‚Ù…Øª Ø¨Ù†Ø³Ø® Ù‡Ø°Ø§ Ø§Ù„Ø±Ù…Ø² Ø¨Ø´ÙƒÙ„ ØºÙŠØ± Ø­ÙƒÙŠÙ… ÙˆÙ‚Ù…Øª Ø¨ØªØ¹Ø¯ÙŠÙ„Ù‡ Ù„Ù†ÙØ³ÙŠ. <br><br>  ÙƒÙ„ Ø´ÙŠØ¡ ÙŠØ¹Ù…Ù„ Ø¨Ø¨Ø³Ø§Ø·Ø©: Ø¹Ù†Ø¯Ù…Ø§ ØªØ¨Ø¯Ø£ ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ­ÙƒÙ… ØŒ ØªØ¨Ø¯Ø£ Ù…Ù‡Ù…Ø© Ø§Ù„ØªÙ‡ÙŠØ¦Ø© ØŒ Ø§Ù„ØªÙŠ ØªØªØµÙ„ Ø¨Ù†Ù‚Ø·Ø© Ø§Ù„ÙˆØµÙˆÙ„ ØŒ ÙˆØªØ²Ø§Ù…Ù† Ø§Ù„ÙˆÙ‚Øª Ø¹Ø¨Ø± SNTP ØŒ ÙˆØªØ¨Ø¯Ø£ Ù…Ù‡Ù…Ø© Ù‚ÙŠØ§Ø³ Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø© Ø¨Ø§Ù„Ø±Ø·ÙˆØ¨Ø© ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù… ØŒ ÙˆØ¨Ø¹Ø¯ Ø°Ù„Ùƒ ØªÙ‚ØªÙ„ Ù†ÙØ³Ù‡Ø§.  ØªØ³ØªÙ‚ØµÙŠ Ù…Ù‡Ù…Ø© Ø§Ù„Ù‚ÙŠØ§Ø³ Ø§Ù„Ù…Ø³ØªØ´Ø¹Ø± Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙƒÙ„ 59 Ø«Ø§Ù†ÙŠØ© ÙˆØªØ¶Ø¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù†ØªØ¸Ø§Ø± ØŒ ÙˆØªØ¨Ø¯Ø£ Ù…Ù‡Ù…Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ† ØŒ ÙˆØªÙ‚Ø±Ø£ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± ÙˆØªØ±Ø³Ù„Ù‡Ø§ Ø¥Ù„Ù‰ Ø®Ø§Ø¯Ù… MQTT. <br><br>  Ù…Ù† Ø§Ù„Ù†Ø§Ø­ÙŠØ© Ø§Ù„Ù†Ø¸Ø±ÙŠØ© ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙÙŠ C ++. <br><br>  <b>Ø§Ù„Ø®Ø·ÙˆØ© 5 - Ø§Ù„Ø®Ø§ØªÙ…Ø© Ø­ÙŠØ« Ø¨Ø¯ÙˆÙ†Ù‡</b> <br><br>  Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¨Ø³ÙŠØ·Ø© ØŒ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù„ØºØ© C ÙˆØ§Ù„ÙŠØ¯ÙŠÙ† Ù…Ø¹ Ù†ØµÙ Ù‚Ø·Ø± ØµØºÙŠØ± Ù„Ù„Ø§Ù†Ø­Ù†Ø§Ø¡ ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø¨Ø±Ù…Ø¬Ø© ÙˆØ­Ø¯Ø© ØªØ­ÙƒÙ… ESP8266.  Ø§Ù„Ù…ÙŠØ²Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù†Ù‡Ø¬ Ø¹Ù„Ù‰ Ø­Ù„ÙˆÙ„ Ø§Ù„Ø¨Ø±Ù…Ø¬Ø© Ø§Ù„Ù†ØµÙŠØ© (Ø¹Ù„Ù‰ Ø³Ø¨ÙŠÙ„ Ø§Ù„Ù…Ø«Ø§Ù„ ØŒ LUA Ø£Ùˆ MicroPython) Ù‡ÙŠ Ø§Ù„Ø³ÙŠØ·Ø±Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ø¹Ù„Ù‰ ØªÙƒÙˆÙŠÙ† ÙˆÙ…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„Ø«Ø§Ø¨ØªØ© ØŒ ÙˆØ§Ù„Ù‚Ø¯Ø±Ø© Ø¹Ù„Ù‰ Ø­Ø´Ø± Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø¨Ù…ÙˆØ§Ø±Ø¯ ØªØ­ÙƒÙ… Ù…Ø­Ø¯ÙˆØ¯Ø©.  Ù‡Ù†Ø§Ùƒ Ø£ÙŠØ¶Ù‹Ø§ Ø®ÙŠØ§Ø± Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… RTOS SDK Ø£Ùˆ NONOS SDK Ù…Ù† Espressif ØŒ Ù„ÙƒÙ†Ù†ÙŠ Ù„Ù… Ø£ØªØ·ÙˆØ± Ù…Ø¹ Ø§Ù„Ø£ÙˆÙ„ ØŒ ÙˆÙ„Ù… Ø£Ø­Ø§ÙˆÙ„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø«Ø§Ù†ÙŠ.  Ø¥Ø°Ø§ ÙƒØ§Ù† Ø´Ø®Øµ Ù…Ø§ Ù…Ù‡ØªÙ…Ù‹Ø§ ØŒ ÙˆÙƒØ°Ù„Ùƒ Ø¹Ù†Ø¯Ù…Ø§ Ø£Ø¹Ø±Ù Ø°Ù„Ùƒ Ø¨Ù†ÙØ³ÙŠ ØŒ ÙŠÙ…ÙƒÙ†Ù†ÙŠ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ Ø§Ù„ØªØ§Ù„ÙŠ Ø­ÙˆÙ„ OTA (ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„Ø«Ø§Ø¨ØªØ© Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø§Ù„Ø¬Ùˆ). <br><br>  Ø¨Ø¹Ø¶ Ù†ØªØ§Ø¦Ø¬ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯: <br><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø© Ù…Ù† Ø®Ø§Ø¯Ù… MQTT ÙˆØªØ­Ù…ÙŠÙ„Ù‡Ø§ Ø¹Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/web/db8/1b7/085/db81b70850ce4ef8afbb77536c57f973.png"><br></div></div><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">Ø§Ù„Ø¹Ø§Ø¯Ù… ØªØ­ÙƒÙ… Ø§Ù„ØªØµØ­ÙŠØ­ ÙÙŠ UART</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="hljs delphi">SDK version: <span class="hljs-number"><span class="hljs-number">0.9</span></span>.<span class="hljs-number"><span class="hljs-number">9</span></span> --- USER_INIT: sizeof (int): <span class="hljs-number"><span class="hljs-number">4</span></span> --- USER_INIT: sizeof (float): <span class="hljs-number"><span class="hljs-number">4</span></span> --- USER_INIT: sizeof (time_t): <span class="hljs-number"><span class="hljs-number">4</span></span> mode : sta(<span class="hljs-number"><span class="hljs-number">18</span></span>:fe:<span class="hljs-number"><span class="hljs-number">34</span></span>:d2:c5:a7) add if0 --- INIT: setting pins... --- INIT: <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> station parameters... --- Station parameters has been <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>. --- INIT: Connecting <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> AP... scandone add <span class="hljs-number"><span class="hljs-number">0</span></span> aid <span class="hljs-number"><span class="hljs-number">2</span></span> cnt connected <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> kosmonaFFFt, channel <span class="hljs-number"><span class="hljs-number">1</span></span> dhcp client start... ip:<span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">1.21</span></span>,mask:<span class="hljs-number"><span class="hljs-number">255.255</span></span>.<span class="hljs-number"><span class="hljs-number">255.0</span></span>,gw:<span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">1.1</span></span> --- INIT: Connection <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> AP has been estabilished... --- INIT: Start SNTP synchronization... --- SNTP: Start SNTP synchronization, allocating memory <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> context... --- SNTP: Context successfully allocated... --- SNTP: Start DNS lookup... --- INIT: Trying <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> take init task semaphore... --- SNTP: Start DNS lookup successfully finished... --- SNTP: Creating upd_pcb... --- SNTP: Successfully created upd_pcb... --- SNTP: Allocating pbuf... --- SNTP: Pbuf allocated successfully... --- SNTP: Sending data <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> server... --- SNTP: Data sent... --- SNTP: Response has successfully received... --- SNTP: Checking response size... --- SNTP: Response size <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> OK... --- SNTP: Checking mode... --- SNTP: Mode <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> OK... --- SNTP: Checking stratum... --- SNTP: Stratum <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> OK... --- SNTP: Updating system timer... --- RTC Adjust: drift = <span class="hljs-number"><span class="hljs-number">1220897578</span></span> ticks, cal = <span class="hljs-number"><span class="hljs-number">1</span></span> --- SNTP: System timer updated... --- TIME: Thu Sep <span class="hljs-number"><span class="hljs-number">21</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">20</span></span>:<span class="hljs-number"><span class="hljs-number">36</span></span> <span class="hljs-number"><span class="hljs-number">2017</span></span> --- INIT: Init task semaphore <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> taken... --- MEASUREMENTS: Start measurements... --- MEASUREMENTS: Measurements finished... --- INIT: Measurement task created... --- MQTT: ConnectNetwork... --- INIT: Send data task created... --- MQTT: ConnectNetwork success... --- MQTT: MQTTConnect success... --- MQTT: Got <span class="hljs-keyword"><span class="hljs-keyword">message</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> publish... --- timestamp: <span class="hljs-number"><span class="hljs-number">1506021636</span></span> --- am2302_humidity: <span class="hljs-number"><span class="hljs-number">55.8</span></span> --- am2302_temperature: <span class="hljs-number"><span class="hljs-number">23.4</span></span> --- MQTT: Successfully publish <span class="hljs-keyword"><span class="hljs-keyword">message</span></span>... --- MEASUREMENTS: Start measurements... --- MEASUREMENTS: Measurements finished... --- MEASUREMENTS: Start measurements... --- MEASUREMENTS: Measurements finished... --- MQTT: ConnectNetwork... --- MQTT: ConnectNetwork success... --- MQTT: MQTTConnect success... --- MQTT: Got <span class="hljs-keyword"><span class="hljs-keyword">message</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> publish... --- timestamp: <span class="hljs-number"><span class="hljs-number">1506021694</span></span> --- am2302_humidity: <span class="hljs-number"><span class="hljs-number">55.2</span></span> --- am2302_temperature: <span class="hljs-number"><span class="hljs-number">23.8</span></span> --- MQTT: Successfully publish <span class="hljs-keyword"><span class="hljs-keyword">message</span></span>... --- MQTT: Got <span class="hljs-keyword"><span class="hljs-keyword">message</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> publish... --- timestamp: <span class="hljs-number"><span class="hljs-number">1506021751</span></span> --- am2302_humidity: <span class="hljs-number"><span class="hljs-number">56.5</span></span> --- am2302_temperature: <span class="hljs-number"><span class="hljs-number">24.4</span></span> --- MQTT: Successfully publish <span class="hljs-keyword"><span class="hljs-keyword">message</span></span>... --- MEASUREMENTS: Start measurements... --- MEASUREMENTS: Measurements finished... --- MEASUREMENTS: Start measurements... --- MEASUREMENTS: Measurements finished... --- MQTT: ConnectNetwork... --- MQTT: ConnectNetwork success... --- MQTT: MQTTConnect success... --- MQTT: Got <span class="hljs-keyword"><span class="hljs-keyword">message</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> publish... --- timestamp: <span class="hljs-number"><span class="hljs-number">1506021807</span></span> --- am2302_humidity: <span class="hljs-number"><span class="hljs-number">53.0</span></span> --- am2302_temperature: <span class="hljs-number"><span class="hljs-number">24.7</span></span> --- MQTT: Successfully publish <span class="hljs-keyword"><span class="hljs-keyword">message</span></span>... --- MQTT: Got <span class="hljs-keyword"><span class="hljs-keyword">message</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> publish... --- timestamp: <span class="hljs-number"><span class="hljs-number">1506021863</span></span> --- am2302_humidity: <span class="hljs-number"><span class="hljs-number">52.3</span></span> --- am2302_temperature: <span class="hljs-number"><span class="hljs-number">24.8</span></span> --- MQTT: Successfully publish <span class="hljs-keyword"><span class="hljs-keyword">message</span></span>... --- MEASUREMENTS: Start measurements... --- MEASUREMENTS: Measurements finished... --- MEASUREMENTS: Start measurements... --- MEASUREMENTS: Measurements finished... --- MQTT: ConnectNetwork... --- MQTT: ConnectNetwork success... --- MQTT: MQTTConnect success... --- MQTT: Got <span class="hljs-keyword"><span class="hljs-keyword">message</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> publish... --- timestamp: <span class="hljs-number"><span class="hljs-number">1506021919</span></span> --- am2302_humidity: <span class="hljs-number"><span class="hljs-number">52.0</span></span> --- am2302_temperature: <span class="hljs-number"><span class="hljs-number">24.9</span></span> --- MQTT: Successfully publish <span class="hljs-keyword"><span class="hljs-keyword">message</span></span>... --- MQTT: Got <span class="hljs-keyword"><span class="hljs-keyword">message</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> publish... --- timestamp: <span class="hljs-number"><span class="hljs-number">1506021975</span></span> --- am2302_humidity: <span class="hljs-number"><span class="hljs-number">53.3</span></span> --- am2302_temperature: <span class="hljs-number"><span class="hljs-number">25.2</span></span> --- MQTT: Successfully publish <span class="hljs-keyword"><span class="hljs-keyword">message</span></span>...</code> </pre> <br></div></div><br>  <b>PS</b> Ø£ÙˆØµÙŠ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… minicom (ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ­ÙƒÙ…) Ø£Ùˆ cutecom (GUI) Ù„Ù„Ø¹Ù…Ù„ Ù…Ø¹ UART Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø² Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±. <br><br>  <b>Ø±ÙˆØ§Ø¨Ø· Ù…ÙÙŠØ¯Ø©:</b> <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">API FreeRTOS</a> </li><li style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Ø¯Ù„ÙŠÙ„ ESP RTOS SDK</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar406813/">https://habr.com/ru/post/ar406813/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar406803/index.html">ÙŠØ³ØªÙƒØ´Ù Rossvyaz Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª IMEI ÙˆØ§Ø­Ø¯Ø© Ù„Ù„Ù‡ÙˆØ§ØªÙ Ø§Ù„ØªÙŠ ØªØ¹Ù…Ù„ ÙÙŠ Ø§Ù„Ø§ØªØ­Ø§Ø¯ Ø§Ù„Ø±ÙˆØ³ÙŠ</a></li>
<li><a href="../ar406805/index.html">Ù„Ù… ØªØ¹Ø¯ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¯Ù…Ø§Øº ÙˆØ§Ù„Ø­Ø§Ø³ÙˆØ¨ Ø§Ù„Ø®ÙŠØ§Ù„ Ø§Ù„Ø¹Ù„Ù…ÙŠ</a></li>
<li><a href="../ar406807/index.html">Ù‚Ø±Ø±Øª Ø§Ù„Ø¨Ø­Ø±ÙŠØ© Ø§Ù„Ø£Ù…Ø±ÙŠÙƒÙŠØ© Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙˆØ­Ø¯Ø§Øª ØªØ­ÙƒÙ… Xbox 360 Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø¹Ù† Ø¨Ø¹Ø¯ Ø§Ù„Ø¨Ø§Ù‡Ø¸Ø© Ø§Ù„Ø«Ù…Ù† Ø§Ù„Ø¨Ø§Ù„ØºØ© 38000 Ø¯ÙˆÙ„Ø§Ø±</a></li>
<li><a href="../ar406809/index.html">Ø§Ø®ØªØ¨Ø±Øª Ø£ÙƒØ¨Ø± Ø·Ø§Ø¦Ø±Ø§Øª Stratolaunch ÙÙŠ Ø§Ù„Ø¹Ø§Ù„Ù… Ø§Ù„Ù…Ø­Ø±ÙƒØ§Øª ÙˆÙ†Ø¸Ø§Ù… Ø§Ù„ÙˆÙ‚ÙˆØ¯</a></li>
<li><a href="../ar406811/index.html">ÙƒÙŠÙ Ù‡Ùˆ Ø§Ù„Ø¹Ø§Ù„Ù… Ø§Ù„Ø³Ø±ÙŠ Ù„ØªØ¯Ø±ÙŠØ¨ Ø£Ø¬Ù‡Ø²Ø© ÙˆØ§ÙŠÙˆÙ…Ùˆ Ø§Ù„Ø¢Ù„ÙŠØ©</a></li>
<li><a href="../ar406815/index.html">Ù„Ø§ ØŒ Ù„ÙŠØ³ Ù…Ù† Ø§Ù„Ù…Ù…ÙƒÙ† Ø£Ù† ØªØ´Ø¹Ø± Ø¨Ø§Ù„Ø£Ø³Ù Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù…ÙŠØ¹ ÙÙˆØ±Ù‹Ø§</a></li>
<li><a href="../ar406817/index.html">Ù‡Ù„ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ù…Ø®Ù„ÙˆÙ‚ Ø§Ù„Ø­ÙŠ Ø¨Ø­Ø¬Ù… Ø§Ù„Ù…Ø¬Ø±Ø©ØŸ</a></li>
<li><a href="../ar406819/index.html">ÙƒÙŠÙ ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ø¢Ù„ÙŠ Ù„Ù„Ø­Ù…ÙˆÙ„Ø§Øª</a></li>
<li><a href="../ar406821/index.html">ØµÙ†Ø¹ Ø§Ù„ÙˆØ±Ù‚ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Epson PaperLab</a></li>
<li><a href="../ar406823/index.html">Ø§Ù„ØªÙ…Ø§Ø«Ù„Ø§Øª C Ùˆ P Ùˆ T (ÙˆÙ…Ø¬Ù…ÙˆØ¹Ø§Øª Ù…Ù†Ù‡Ø§)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>