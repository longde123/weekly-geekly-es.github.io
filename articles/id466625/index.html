<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ® ğŸ’‡ ğŸ˜¹ Melampaui pod di Kubernetes melalui pemasangan log ğŸ˜ˆ ğŸ’…ğŸ» ğŸ¤²ğŸ»</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Catatan perev. : Catatan ini ditulis oleh seorang peneliti keamanan TI di Aqua Security, sebuah perusahaan DevSecOps. Dia adalah ilustrasi yang sangat...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Melampaui pod di Kubernetes melalui pemasangan log</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/466625/"> <i><b>Catatan</b></i>  <i><b>perev.</b></i>  <i>: Catatan ini ditulis oleh seorang peneliti keamanan TI di Aqua Security, sebuah perusahaan DevSecOps.</i>  <i>Dia adalah ilustrasi yang sangat baik tentang seluk-beluk dalam konfigurasi Kubernetes, yang penting untuk selalu diingat ketika melayani cluster dalam produksi.</i>  <i>Tentu saja, jika Anda memikirkan keselamatan mereka ...</i> <br><br><img src="https://habrastorage.org/webt/aw/z0/ej/awz0ejuhbrd7tfaoggoapj86e7y.jpeg"><br><br>  Kubernetes terdiri dari banyak komponen, dan kadang-kadang menggabungkannya dengan cara tertentu mengarah ke hasil yang tidak terduga.  Pada artikel ini saya akan menunjukkan bagaimana pod diluncurkan dengan hak akses root dan direktori yang terpasang <code>/var/log</code> dari sebuah node dapat <b>memperluas konten seluruh sistem file host ke</b> pengguna dengan akses ke log-nya.  Kami juga akan membahas solusi untuk masalah ini. <a name="habracut"></a><br><br><h2>  Bagaimana Kubernetes melihat log </h2><br>  Pernahkah Anda bertanya-tanya bagaimana <code>kubectl logs &lt;pod_name&gt;</code> mengekstrak log dari pod?  Siapa yang bertanggung jawab untuk mengumpulkan kayu dari wadah?  Dan bagaimana mereka mendapatkannya di komputer Anda? <br><br>  Diagram berikut menggambarkan proses: <br><br><img src="https://habrastorage.org/webt/rc/3j/32/rc3j32co5ems4w2xvpztnqw3bwq.jpeg"><br><br>  Kubelet membuat struktur di dalam direktori <code>/var/log</code> pada host yang mewakili pod pada host.  Ada file <code>0.log</code> (1) di direktori untuk <code>0.log</code> kami, tetapi sebenarnya itu adalah symlink ke log kontainer yang terletak di <code>/var/lib/docker/containers</code> .  Ini semua dari sudut pandang tuan rumah. <br><br>  Kubelet membuka titik akhir <code>/logs/</code> (2), yang hanya bekerja dengan server file HTTP di direktori (3), membuat log tersedia untuk permintaan yang datang dari server API. <br><br>  Sekarang bayangkan kita memasang pod dengan <code>hostPath</code> terpasang di <code>/var/log</code> .  Pod semacam itu akan memiliki akses ke semua file log di host.  Meskipun ini sendiri merupakan masalah potensial, kita dapat mengambil langkah logis berikutnya.  Bagaimana jika kita mengganti <code>0.log</code> dengan symlink ke ... katakanlah, <code>/etc/shadow</code> ? <br><br><pre> <code class="plaintext hljs">â”‚ â”œâ”€â”€ var â”‚ â”œâ”€â”€ logs â”‚ â”‚ â”œâ”€â”€ pods â”‚ â”‚ â”‚ â”œâ”€â”€ default_mypod_e7869b14-abca-11e8-9888-42010a8e020e â”‚ â”‚ â”‚ â”‚ â”œâ”€â”€ mypod â”‚ â”‚ â”‚ â”‚ â”‚ â”œâ”€â”€ 0.log -&gt; /etc/shadow â”‚ â”‚ â”‚ â”‚ â”‚ â”‚</code> </pre> <br>  Sekarang, mencoba mengunduh log menggunakan <code>kubectl logs</code> pada mesin klien, kita mendapatkan: <br><br><pre> <code class="bash hljs">$ kubectl logs mypod failed to get parse <span class="hljs-keyword"><span class="hljs-keyword">function</span></span>: unsupported <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> format: <span class="hljs-string"><span class="hljs-string">"root:*:18033:0:99999:7:::\n"</span></span></code> </pre> <br>  Kubelet mengikuti tautan dan membaca isi file yang ditunjuknya (itu bisa berupa file apa pun pada node). <br><br>  Karena JSON diharapkan, kubectl mogok setelah baris pertama, namun, kita dapat dengan mudah membaca baris spesifik dari file <code>shadow</code> dengan menjalankan perintah dengan <code>â€“-tail=-&lt;line_number&gt;</code> . <br><br>  Ini luar biasa.  Karena kubelet mengikuti symlink, Anda dapat menggunakan hak akses rootnya untuk membaca file apa pun pada node, cukup dengan membuat tautan simbolik di dalam pod. <br><br><h2>  Melarikan diri dari pod </h2><br>  Mari kita melangkah lebih jauh.  Kita tahu bahwa ketika memulai sebuah pod di Kubernetes, token ServiceAccount diinstal di dalamnya.  Dengan demikian, jika akun layanan memungkinkan akses ke log, kita dapat langsung mengakses hak akses kubelet dan root pada node. <br><br>  Saya menulis bukti konsep (POC) yang menunjukkan vektor serangan ini: <br><br><ul><li>  penyebaran pod dengan mount point <code>/var/log</code> ; </li><li>  membuat tautan simbolis ke direktori root host; </li><li>  membaca kunci pribadi ssh pengguna pada host. </li></ul><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Video berikut</a> menunjukkan dua perintah khusus yang berjalan di dalam pod: <br><br><ul><li>  <code>lsh == ls</code> (pada sistem file host); </li><li>  <code>cath == cat</code> (pada sistem file host). </li></ul><br>  <i><b>Catatan</b></i>  <i><b>perev.</b></i>  <i>: Sayangnya, mereka tidak memperbaiki penyisipan konten dari asciinema pada hub, meskipun kami sudah <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">mengatasi</a> masalah ini, oleh karena itu kami terpaksa "menyematkan" video dengan tautan sederhana di atas.</i> <br><br>  Semua file yang terlibat dalam POC ini dapat ditemukan di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">repositori GitHub yang sesuai</a> .  Ada skrip POC lain yang secara otomatis mengumpulkan kunci pribadi dan token ServiceAccount dari sistem file host. <br><br><h2>  Direktori pemasangan bisa berbahaya </h2><br>  Jadi apakah ini kerentanan atau hanya praktik buruk? <br><br>  Menyebarkan pod dengan <code>hostPath</code> -open write- <code>hostPath</code> di <code>/var/log</code> jarang terjadi (di samping itu, ada cara lain untuk menyalahgunakan pemasangan direktori rahasia host di pod).  Tetapi bahkan jika Anda tahu bahwa pemasangan <code>/var/log</code> adalah praktik yang meragukan, Anda mungkin tidak mengharapkannya untuk memungkinkan Anda mengambil alih simpul dengan mudah. <br><br>  Sebelum dipublikasikan, kami menghubungi tim keamanan Kubernetes untuk mencari tahu apakah mereka menganggap ini kerentanan.  Mereka menyimpulkan bahwa ini hanyalah konsekuensi menyedihkan dari pemasangan direktori host pribadi dengan izin menulis: risiko yang terlibat <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">didokumentasikan dengan</a> baik.  Namun, kerentanan ini cukup mudah untuk dieksploitasi.  Di dunia ada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">banyak proyek</a> yang menggunakan mount ini.  Jika Anda menggunakan salah satu proyek ini, ingatlah bahwa penyebaran Anda akan rentan terhadap cara pembajakan host ini. <br><br>  Metode ini telah diuji pada Kubernetes 1.15 dan 1.13, tetapi kemungkinan besar memengaruhi versi lain. <br><br><h2>  Eliminasi </h2><br>  "Pelarian" seperti itu hanya dimungkinkan jika pod berjalan sebagai root.  Ini umumnya <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">harus dihindari</a> .  Aqua CSP memungkinkan Anda untuk menetapkan kebijakan dengan upaya minimal yang mencegah kontainer berjalan sebagai root atau memberikan izin hanya ke grup gambar tertentu yang benar-benar membutuhkan root. <br><br>  Cara lain adalah tidak menyebarkan pods dengan <code>hostPath</code> dengan hak akses tulis di <code>/var/log</code> .  Pendekatan ini tidak ditetapkan secara default dan bukan praktik yang umum, oleh karena itu perlu untuk secara sadar menentukannya (namun, kemungkinan masih ada).  Tapi bagaimana cara mengeceknya? <br><br>  Kami menambahkan skrip baru (pemburu) ke <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">kube-hunter</a> - alat Open Source kami yang ringan untuk menguji Kubernetes - yang memeriksa kluster untuk polong dengan titik pemasangan berbahaya tersebut.  <i>( <b>Catatan</b> : Kube-hunter hadir dalam <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">ulasan terbaru</a> tentang utilitas keamanan K8, yang kami posting di blog kami.)</i> <br><br>  Pengguna Aqua dapat melindungi diri mereka dari risiko ini dengan menggunakan kebijakan runtime untuk mencegah volume tertentu agar tidak dipasang: <br><br><img src="https://habrastorage.org/webt/yi/ue/1k/yiue1kwxcn7fonmqvd9n2pfm5oq.png"><br><br>  <i><b>Catatan</b></i>  <i><b>perev.</b></i>  <i>: Bagian dari masalah ini dapat diselesaikan dengan menggunakan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Kebijakan Keamanan Pod</a> , yaitu <code>AllowedHostPaths</code> .</i>  <i>Namun, ini juga bukan perlindungan terhadap symlink.</i>  <i>Akhirnya, seperti komentar yang disarankan, kita bisa membatasi peluncuran sebagai root, sekali lagi dipandu oleh <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">PSP</a> .</i> <br><br><h2>  Ringkasan </h2><br>  Kubernetes adalah sistem yang kompleks dengan banyak kehalusan dalam pengaturan keamanan, yang tidak selalu jelas bagi pengguna rata-rata dan bahkan berpengalaman.  Dalam artikel ini, saya telah menunjukkan bagaimana, dalam keadaan tertentu, penebangan tidak bersalah dapat menyebabkan potensi kerentanan.  Dalam kebanyakan kasus ini tidak mungkin, tetapi Kubernetes menawarkan pengguna kebebasan bertindak yang lebih besar yang dapat memengaruhi keamanan.  Penting untuk mengingat hal ini dan menerapkan kontrol yang sesuai untuk mencegah kesalahan tersebut. <br><br><h2>  PS dari penerjemah </h2><br>  Baca juga di blog kami: <br><br><ul><li>  â€œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Dalam 19% gambar Docker paling populer, tidak ada kata sandi untuk root</a> â€; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">33+ Alat Keamanan Kubernetes</a> "; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Pengantar Kebijakan Jaringan Kubernet untuk Profesional Keamanan</a> "; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Docker dan Kubernetes di lingkungan yang menuntut keamanan</a> "; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">9 Praktik Keamanan Terbaik di Kubernetes</a> "; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">11 Cara untuk (Tidak) Menjadi Korban Peretasan Kubernet</a> ." </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id466625/">https://habr.com/ru/post/id466625/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id466607/index.html">"Semua yang Anda baca akan digunakan untuk melawan Anda": bagaimana musik rap masuk ke ruang sidang</a></li>
<li><a href="../id466609/index.html">Opsi untuk menggunakan cryptocurrency blockchain sebagai media untuk mentransfer perintah untuk elemen botnet</a></li>
<li><a href="../id466611/index.html">Apa yang tidak bisa Anda tuntut dan mengapa Anda tidak bisa memuji karyawan jika Anda ingin mereka bekerja dengan baik</a></li>
<li><a href="../id466615/index.html">Resep TeamCity. Laporkan Yandex.Taxi</a></li>
<li><a href="../id466623/index.html">Membuat rentang slider nilai untuk filter tanpa menggunakan jQuery</a></li>
<li><a href="../id466629/index.html">Mengapa aplikasi Anda memerlukan aksesibilitas</a></li>
<li><a href="../id466631/index.html">Sistem Manajemen Kasus Uji QuAck - Kegembiraan Sederhana dalam Pengujian</a></li>
<li><a href="../id466633/index.html">Ssh mengobrol</a></li>
<li><a href="../id466635/index.html">Berita dari dunia OpenStreetMap No. 475 (08.20.2019-26.08.2019)</a></li>
<li><a href="../id466637/index.html">Desain Mesin Marmer Elektromekanik v2.0</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>