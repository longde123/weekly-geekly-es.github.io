<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🐾 😓 ♉️ 难以捉摸的马尔瓦里历险记，第四部分：DDE和Word文档字段 📏 💳 🚑</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="本文是无文件恶意软件系列的一部分。 该系列的所有其他部分： 



- 难以捉摸的马尔瓦里历险记，第一部分 
- 难以捉摸的马尔瓦里历险记，第二部分：VBA秘密脚本 
- 难以捉摸的马尔瓦里历险记，第三部分：复杂的VBA脚本，为笑声和利润 
- 难以捉摸的马尔瓦里历险记，第四部分：DDE和Word文...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>难以捉摸的马尔瓦里历险记，第四部分：DDE和Word文档字段</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/varonis/blog/460521/"><img src="https://habrastorage.org/webt/zn/w7/ji/znw7ji_p5zvifvliksiuceqjll0.png"><br><br> 本文是无文件恶意软件系列的一部分。 该系列的所有其他部分： <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">难以捉摸的马尔瓦里历险记，第一部分</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">难以捉摸的马尔瓦里历险记，第二部分：VBA秘密脚本</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">难以捉摸的马尔瓦里历险记，第三部分：复杂的VBA脚本，为笑声和利润</a> </li><li> 难以捉摸的马尔瓦里历险记，第四部分：DDE和Word文档字段（在这里） </li></ul><br> 在本文中，我将陷入一个更加复杂的多阶段方案，即在系统中进行修复的无文件攻击。 但是后来我遇到了一种非常简单的攻击，没有代码-不需要Word或Excel宏！ 这有效地证明了我作为本系列文章基础的最初假设：克服任何组织的外部边界是一项非常简单的任务。 <br><a name="habracut"></a><br> 我将描述的第一个攻击利用Microsoft Word漏洞，该漏洞基于<strong>旧版<a href="">动态数据交换协议</a> （DDE）</strong> 。 它已经被<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">修复</a> 。 第二个漏洞利用了Microsoft COM和对象传输功能中的一个更一般的漏洞。 <br><br><h2> 借助DDE回到未来 </h2><br> 还有其他人记得DDE吗？ 可能很少。 这是最早的<strong>允许应用程序和设备传输数据的进程间通信协议之一</strong> 。 <br><br> 我自己对此有点熟悉，因为我曾经检查和测试电信设备。 当时，DDE允许将呼叫者ID转移到呼叫中心运营商的CRM应用程序，从而最终打开了客户卡。 为此，您必须在电话和计算机之间连接RS-232电缆。 这是日子！ <br><br> 事实证明，Microsoft Word仍<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">支持</a> DDE。 <br><br> 无需代码即可使这种攻击有效的原因在于，您可以<i>直接</i>从Word文档的自动字段访问DDE协议（我将帽子戴在SensePost上进行<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">研究和发布</a> ）。 <br><br>  <strong>域代码</strong>是MS Word的另一个古老功能，可让您向文档中添加动态文本和一些编程。 最明显的示例是“页码”字段，可以使用值{PAGE \ * MERGEFORMAT}将其插入页脚。 这使您可以自动生成页码。 <br><br><img src="https://habrastorage.org/webt/wu/ov/ns/wuovnsvhhei65psga4ongzkfwuc.jpeg"><br>  <font color="#999999"><i>提示：您可以在“插入”部分中找到“字段”菜单项。</i></font> <br><br> 我记得当我第一次在Word中发现此功能时，我感到非常惊讶。 只要补丁没有禁用它，Word就支持DDE字段参数。 想法是DDE允许Word直接与应用程序通信，以便随后将程序输出传输到文档中。 当时这是一项非常年轻的技术-支持与外部应用程序交换数据。 后来，它是用COM技术开发的，我们还将在下面进行介绍。 <br><br> 结果，黑客意识到此DDE应用程序可能是一个命令外壳，它当然会启动PowerShell，并且黑客可以从那里执行他们想要的任何操作。 <br> 下面的屏幕快照显示了我如何使用这种秘密技术：DDE字段中的一个小型PowerShell脚本（以下称为PS）加载了另一个PS脚本，该脚本启动了攻击的第二阶段。 <br><br><img src="https://habrastorage.org/webt/p6/17/2j/p6172jjjmcko74uq-klljtznybs.jpeg"><br>  <font color="#999999"><i>多亏了Windows的弹出警告，DDEAUTO内置字段正在暗中尝试启动外壳程序</i></font> <br><br> 利用此漏洞的首选方法是将该选项与DDEAUTO字段一起使用，该字段<i>在打开</i> Word文档<i>时</i>自动运行脚本。 <br> 让我们考虑一下我们可以做些什么。 <br><br> 作为一名新手黑客，您可以例如发送钓鱼邮件，假装您来自联邦税务局，并在第一阶段将PSDE脚本嵌入DDEAUTO字段（本质上是一个dropper）。 而且您甚至不需要像<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">上一篇文章中</a>那样对宏等进行任何真正的编码<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">。</a> <br> 受害者打开您的文档，内置脚本被激活，黑客位于计算机内部。 就我而言，远程PS脚本仅打印消息，但它也可以轻松启动PS Empire客户端，该客户端将提供对Shell的远程访问。 <br> 在受害者有话要说之前，黑客将是村里最富有的青少年。 <br><br><img src="https://habrastorage.org/webt/s2/hr/o3/s2hro3e7lhftosp6nrtdj1cjsge.jpeg"><br>  <font color="#999999"><i>外壳启动时没有丝毫编码。</i></font>  <font color="#999999"><i>甚至一个孩子都能做到！</i></font> <br><br><h2>  DDE和字段 </h2><br> 后来，Microsoft仍然禁用了Word中的DDE，但在此之前，该公司表示该功能只是被滥用。 他们不愿意改变某些东西是可以理解的。 根据我自己的经验，我自己观察到一个示例，该示例启用了打开文档时更新字段的功能，但Word宏已被IT服务禁用（但带有通知）。 顺便说一句，您可以在“字设置”部分中找到相应的参数。 <br><br> 但是，即使启用了字段更新，Microsoft Word也会在字段请求访问已删除数据时通知用户，就像上面的DDE一样。 微软真的在警告您。 <br><br> 但是最有可能的是，用户仍然会跳过此警告，并在Word中激活字段更新。 这是感谢Microsoft禁用危险的DDE功能的难得机会之一。 <br><br> 今天找到一个未打补丁的Windows系统有多困难？ <br><br> 在此测试中，我使用AWS Workspaces访问虚拟桌面。 因此，我使用MS Office获得了未打补丁的虚拟机，这使我可以插入DDEAUTO字段。 我毫不怀疑，您可以通过类似的方式找到尚未安装必要的安全修补程序的其他公司。 <br><br><h2> 物体之谜 </h2><br> 即使安装了此修补程序，MS Office中也存在其他安全漏洞，这些漏洞使黑客可以执行与Word相似的操作。 在以下情况下，我们将学习如何在<strong>不编写代码的</strong>情况下将<strong>Excel用作网络钓鱼攻击的诱饵。</strong> <br><br> 要了解这种情况，让我们回顾一下Microsoft <i>Component Object Model</i>或缩写为<i>COM（Component Object Model）</i> 。 <br><br>  COM自1990年代就已经存在，并且被定义为基于远程RPC过程调用的“对编程语言而言中立的面向对象的组件模型”。 对于COM术语的一般理解，请阅读StackOverflow上的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">这篇文章</a> 。 <br><br> 总的来说，您可以将COM应用程序想象为Excel或Word可执行文件，或者可以启动的其他一些二进制文件。 <br><br> 事实证明，COM应用程序也可以运行<i>脚本</i> -JavaScript或VBScript。 从技术上讲，这称为<strong>scriptlet</strong> 。 也许您在Windows上遇到了文件的sct扩展名-这是scriptlet的官方扩展名。 实际上，它们是包装在XML包装器中的脚本的代码： <br><br><pre><code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?XML version="1.0"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">scriptlet</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">registration</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">description</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"test"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">progid</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"test"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">version</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1.00"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">classid</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{BBBB4444-0000-0000-0000-0000FAADACDC}"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">remotable</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">registration</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">language</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"JScript"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="xml"><span class="xml"> &lt;![CDATA[ var r = new ActiveXObject("WScript.Shell").Run("cmd /k powershell -c Write-Host You have been scripted!"); ]]&gt; </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">scriptlet</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br> 黑客和渗透测试者发现，Windows上有单独的实用程序和应用程序可以接受COM对象，因此也可以接受脚本。 <br><br> 我可以将脚本传递给用VBS编写的Windows实用程序，称为pubprn。 它位于C：\ Windows \ system32 \ Printing_Admin_Scripts的肠子中。 顺便说一句，还有其他Windows实用程序将对象作为参数。 首先，请考虑以下示例。 <br><br><img src="https://habrastorage.org/webt/yk/ed/ne/ykedneaau8q1rs8n_jizxmiwzp4.jpeg"><br>  <font color="#999999"><i>即使从打印脚本启动外壳程序也是很自然的。</i></font>  <font color="#999999"><i>去微软吧！</i></font> <br><br> 作为测试，我创建了一个简单的远程脚本，该脚本可启动外壳并打印有趣的消息“您刚被编写脚本！”。 本质上，pubprn实例化scriptlet对象，从而允许VBScript运行Shell。 这种方法为想要潜入系统并隐藏在系统中的黑客提供了明显的好处。 <br><br> 在下一篇文章中，我将解释黑客如何使用Excel电子表格来使用COM脚本。 <br><br> 为了做家庭作业，请观看<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">此</a> 2016 Derbycon <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">视频</a> ，其中介绍了黑客如何使用脚本。 并阅读有关scriptlet和某种绰号的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">这篇文章</a> 。 </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN460521/">https://habr.com/ru/post/zh-CN460521/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN460509/index.html">居民代理如何为企业提供帮助：在数据挖掘中使用Infatica的真实案例</a></li>
<li><a href="../zh-CN460511/index.html">PHP-FPM调优：使用pm static可获得最佳性能</a></li>
<li><a href="../zh-CN460513/index.html">Flutter 1.7-2019年7月10日发行版中的新功能</a></li>
<li><a href="../zh-CN460515/index.html">我们真的离自动驾驶汽车的出现有多近？</a></li>
<li><a href="../zh-CN460517/index.html">如何检测对Windows基础结构的攻击：探索黑客工具</a></li>
<li><a href="../zh-CN460523/index.html">宣布将mitap顺利转变为BeerPHP饮料盖的公告（在莫斯科和在线）</a></li>
<li><a href="../zh-CN460525/index.html">QA和JS欢迎您参加7月的DINS IT之夜</a></li>
<li><a href="../zh-CN460527/index.html">使用pwnable.kr 06-随机和09-错误解决问题</a></li>
<li><a href="../zh-CN460531/index.html">来自IT世界的好奇变态-5</a></li>
<li><a href="../zh-CN460535/index.html">为Go应用创建最小的Docker容器</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>