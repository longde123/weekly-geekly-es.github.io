<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🎂 👐🏽 🈹 Making Modern Build 👨🏾‍🚀 👦 ⌛️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola Habr! 

 Cada navegador moderno ahora le permite trabajar con módulos ES6 . 

 A primera vista, parece que esto es algo completamente inútil: des...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Making Modern Build</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/constanta/blog/430950/">  Hola Habr! <br><br>  Cada navegador moderno ahora le permite trabajar con <nobr>módulos ES6</nobr> . <br><br>  A primera vista, parece que esto es algo completamente inútil: después de todo, todos utilizamos coleccionistas que reemplazan las importaciones con sus desafíos internos.  Pero si profundiza en las especificaciones, resulta que gracias a ellas puede proporcionar un ensamblaje separado para los navegadores modernos. <br><br>  Under the cat es una historia sobre cómo pude reducir el tamaño de la aplicación en un 11% sin perjuicio de los navegadores antiguos y mis nervios. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/cc/a8/6i/cca86i0z-kir9y5tomdwywude5c.png"></div><br><a name="habracut"></a><br><h2>  Características de los módulos ES6 </h2><br>  ES6 Modules es un sistema modular bien conocido y ampliamente utilizado para todos: <br><br><pre><code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/* someFile.js */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { someFunc } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'path/to/helpers.js'</span></span></code> </pre> <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/* helpers.js */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">someFunc</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> }</code> </pre><br>  Para usar este sistema modular en los navegadores, debe agregar el tipo de módulo a cada etiqueta de script.  Los navegadores más antiguos verán que el tipo es diferente de text / javascript y no ejecutarán el archivo como JavaScript. <br><br><pre> <code class="xml hljs"><span class="hljs-comment"><span class="hljs-comment">&lt;!--        ES6 Modules --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"module"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/path/to/someFile.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  La especificación también tiene un atributo nomodule para etiquetas de script.  Los navegadores que admiten <nobr>módulos ES6</nobr> ignorarán este script, y los navegadores más antiguos lo descargarán y ejecutarán. <br><br><pre> <code class="xml hljs"><span class="hljs-comment"><span class="hljs-comment">&lt;!--       --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">nomodule</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/path/to/someFileFallback.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Resulta que simplemente puede hacer dos ensamblajes: el primero con el tipo de módulo para navegadores modernos (Modern Build), y el otro con el nomodule para navegadores antiguos (Fallback build): <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"module"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/path/to/someFile.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">nomodule</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/path/to/someFileFallback.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><h2>  Porque es necesario </h2><br>  Antes de enviar un proyecto a producción, debemos: <br><br><ul><li>  Añadir polifilos. </li><li>  Transponga el código moderno a uno más antiguo. </li></ul><br>  En mis proyectos, trato de admitir el número máximo de navegadores, a veces incluso <nobr>IE 10</nobr> .  Por lo tanto, mi lista de polyfiles consta de elementos básicos como es6.promise, es6.object.values, etc.  Pero los navegadores con <nobr>módulos ES6 son</nobr> compatibles con todos los métodos ES6, y no necesitan kilobytes adicionales de polyfills. <br><br>  La transpilación también deja una marca notable en el tamaño del archivo: babel / preset-env usa 25 transformadores para cubrir la mayoría de los navegadores, cada uno de los cuales aumenta el tamaño del código.  Al mismo tiempo, para los navegadores con soporte para <nobr>módulos ES6</nobr> , el número de transformadores se reduce a 9. <br><br>  Por lo tanto, en el ensamblaje de los navegadores modernos, podemos eliminar archivos innecesarios y reducir la cantidad de transformadores, lo que afectará en gran medida el tamaño de los archivos resultantes. <br><br><h2>  Cómo agregar polyfiles </h2><br>  Antes de preparar Modern Build para navegadores modernos, vale la pena mencionar cómo agrego polyfills al proyecto. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/pt/rt/mz/ptrtmzce1nt10saffpl7lk9gokc.png"></div><br><br>  Por lo general, los proyectos usan core-js para agregar todos los polyfills posibles. <br><br>  Por supuesto, no desea todos los 88 Kbytes de archivos de polígonos de esta biblioteca, sino solo aquellos que son necesarios para su lista de navegadores.  Esta característica está disponible usando babel / preset-env y su opción useBuiltIns.  Si lo configura como entrada, la importación de core-js se reemplazará con las importaciones de los módulos individuales que necesita su navegador: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/* .babelrc.js */</span></span> <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { <span class="hljs-attr"><span class="hljs-attr">presets</span></span>: [ [<span class="hljs-string"><span class="hljs-string">'@babel/preset-env'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">useBuiltIns</span></span>: <span class="hljs-string"><span class="hljs-string">'entry'</span></span>, <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> }] ], <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> };</code> </pre><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">'core-js'</span></span>;</code> </pre><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">"core-js/modules/es6.array.copy-within"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">"core-js/modules/es6.array.fill"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">"core-js/modules/es6.array.find"</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*   -  */</span></span></code> </pre><br>  Pero con tal transformación nos libramos de solo una parte de los innecesarios polifilos muy antiguos.  Todavía tenemos polífilos para TypedArray, WeakMap y otras cosas extrañas que nunca se usan en el proyecto. <br><br>  Para superar completamente este problema, para la opción useBuiltIns configuré el valor de uso.  En la etapa de compilación, babel / preset-env analizará los archivos para el uso de funciones que no están disponibles en los navegadores seleccionados, y les agregará archivos polifónicos: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/* .babelrc.js */</span></span> <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { <span class="hljs-attr"><span class="hljs-attr">presets</span></span>: [ [<span class="hljs-string"><span class="hljs-string">'@babel/preset-env'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">useBuiltIns</span></span>: <span class="hljs-string"><span class="hljs-string">'usage'</span></span>, <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> }] ], <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> };</code> </pre><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sortStrings</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">strings</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> strings.sort(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createResolvedPromise</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>.resolve(); }</code> </pre><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">"core-js/modules/es6.array.sort"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">"core-js/modules/es6.promise"</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sortStrings</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">strings</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> strings.sort(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createResolvedPromise</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>.resolve(); }</code> </pre><br>  En el ejemplo anterior, babel / preset-env agregó un polífilo a la función de clasificación.  No puede encontrar en JavaScript qué tipo de objeto se pasará a la función: será una matriz o un objeto de clase con la función de clasificación, pero babel / preset-env selecciona el peor de los casos para sí mismo e inserta un archivo polivinílico. <br><br>  Las situaciones en que babel / preset-env están mal suceden todo el tiempo.  Para eliminar los polífilos innecesarios, verifique de vez en cuando cuáles importa y elimine los innecesarios con la opción de exclusión: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/* .babelrc.js */</span></span> <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { <span class="hljs-attr"><span class="hljs-attr">presets</span></span>: [ [<span class="hljs-string"><span class="hljs-string">'@babel/preset-env'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">useBuiltIns</span></span>: <span class="hljs-string"><span class="hljs-string">'usage'</span></span>, <span class="hljs-comment"><span class="hljs-comment">//   ,  ,     debug: true, //      exclude: ['es6.regexp.to-string', 'es6.number.constructor'], /* ... */ }] ], /* ... */ };</span></span></code> </pre><br>  <font color="#999999">No considero el módulo regenerator-runtime, ya que uso fast-async ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">y aconsejo a todos</a> ).</font> <br><br><h2>  Crea una construcción moderna </h2><br>  Configuremos Modern Build. <br><br>  Asegúrese de que tengamos un archivo de lista de navegadores en el proyecto que describa todos los navegadores necesarios: <br><br><pre> <code class="plaintext hljs">/* .browserslistrc */ &gt; 0.5% IE 10</code> </pre><br>  Agregue la variable de entorno BROWSERS_ENV durante la compilación, que puede tomar los valores de respaldo (para Fallback Build) y moderno (para Modern Build): <br><br><pre> <code class="json hljs">/* package.json */ { <span class="hljs-attr"><span class="hljs-attr">"scripts"</span></span>: { /* ... */ <span class="hljs-attr"><span class="hljs-attr">"build"</span></span>: <span class="hljs-string"><span class="hljs-string">"NODE_ENV=production webpack /.../"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"build:fallback"</span></span>: <span class="hljs-string"><span class="hljs-string">"BROWSERS_ENV=fallback npm run build"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"build:modern"</span></span>: <span class="hljs-string"><span class="hljs-string">"BROWSERS_ENV=modern npm run build"</span></span> }, /* ... */ }</code> </pre><br>  Ahora cambie la configuración de babel / preset-env.  Para especificar navegadores compatibles en el preajuste hay una opción de objetivos.  Ella tiene una abreviatura especial: esmodules.  Al usarlo, babel / preset-env sustituirá automáticamente a los navegadores que admitan <nobr>módulos ES6</nobr> . <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/* .babelrc.js */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> isModern = process.env.BROWSERS_ENV === <span class="hljs-string"><span class="hljs-string">'modern'</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { <span class="hljs-attr"><span class="hljs-attr">presets</span></span>: [ [<span class="hljs-string"><span class="hljs-string">'@babel/preset-env'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">useBuiltIns</span></span>: <span class="hljs-string"><span class="hljs-string">'usage'</span></span>, <span class="hljs-comment"><span class="hljs-comment">//  Modern Build     ES6 modules, //   Fallback Build     .browsersrc targets: isModern ? { esmodules: true } : undefined, /* ... */ }] ], /* ... */ ], };</span></span></code> </pre><br>  Babel / preset-env hará todo el trabajo por nosotros aún más: seleccionará solo los polífilos y transformaciones necesarios. <br><br>  ¡Ahora podemos construir un proyecto para navegadores modernos o antiguos con solo un comando desde la consola! <br><br><h2>  Vincula la construcción moderna y alternativa </h2><br>  El último paso es combinar Modern y Fallback Builds en uno. <br><br>  Planeo crear una estructura de proyecto de este tipo: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//     dist/ //  html- index.html //   Modern Build' modern/ ... //   Fallback Build' fallback/ ...</span></span></code> </pre><br>  En index.html habrá enlaces a los archivos javascript necesarios de ambos ensamblados: <br><br><pre> <code class="xml hljs">/* index.html */ <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- ... --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- ... --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"module"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/modern/js/app.540601d23b6d03413d5b.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">nomodule</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/fallback/js/app.4d03e1af64f68111703e.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Este paso se puede dividir en tres partes: <br><br><ol><li>  Build Modern y Fallback Build en diferentes directorios. </li><li>  Obteniendo información sobre las rutas a los archivos javascript necesarios. </li><li>  Crear index.html con enlaces a todos los archivos javascript. </li></ol><br>  ¡Empecemos! <br><br><h4>  Build Modern y Fallback Build en diferentes directorios </h4><br>  Para comenzar, tomemos el paso más fácil: recopilaremos Modern y Fallback Build en diferentes directorios dentro del directorio dist. <br><br>  Es simplemente imposible especificar el directorio deseado para output.path, ya que necesitamos que webpack tenga rutas a los archivos relativos al directorio dist (index.html está en este directorio, y todas las demás dependencias se eliminarán en relación con él). <br><br>  Cree una función especial para generar rutas de archivos: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/* getFilePath.js */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   ,       */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> path = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'path'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> isModern = process.env.BROWSERS_ENV === <span class="hljs-string"><span class="hljs-string">'modern'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> prefix = isModern ? <span class="hljs-string"><span class="hljs-string">'modern'</span></span> : <span class="hljs-string"><span class="hljs-string">'fallback'</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">relativePath</span></span></span><span class="hljs-function"> =&gt;</span></span> ( path.join(prefix, relativePath) );</code> </pre><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/* webpack.prod.config.js */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> getFilePath = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'path/to/getFilePath'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> MiniCssExtractPlugin = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'mini-css-extract-plugin'</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { <span class="hljs-attr"><span class="hljs-attr">mode</span></span>: <span class="hljs-string"><span class="hljs-string">'production'</span></span>, <span class="hljs-attr"><span class="hljs-attr">output</span></span>: { <span class="hljs-attr"><span class="hljs-attr">path</span></span>: <span class="hljs-string"><span class="hljs-string">'dist'</span></span>, <span class="hljs-attr"><span class="hljs-attr">filename</span></span>: getFilePath(<span class="hljs-string"><span class="hljs-string">'js/[name].[contenthash].js'</span></span>), }, <span class="hljs-attr"><span class="hljs-attr">plugins</span></span>: [ <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MiniCssExtractPlugin({ <span class="hljs-attr"><span class="hljs-attr">filename</span></span>: getFilePath(<span class="hljs-string"><span class="hljs-string">'css/[name].[contenthash].css'</span></span>), }), <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> ], <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> }</code> </pre><br>  El proyecto comenzó a reunirse en diferentes directorios para Modern y Fallback Build. <br><br><h4>  Obtener información sobre rutas a los archivos JavaScript necesarios </h4><br>  Para obtener información sobre los archivos recopilados, conecte el plugin webpack-manifest-plugin.  Al final del ensamblaje, agregará un archivo manifest.json con datos sobre las rutas a los archivos: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/* webpack.prod.config.js */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> getFilePath = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'path/to/getFilePath'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> WebpackManifestPlugin = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'webpack-manifest-plugin'</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { <span class="hljs-attr"><span class="hljs-attr">mode</span></span>: <span class="hljs-string"><span class="hljs-string">'production'</span></span>, <span class="hljs-attr"><span class="hljs-attr">plugins</span></span>: [ <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WebpackManifestPlugin({ <span class="hljs-attr"><span class="hljs-attr">fileName</span></span>: getFilePath(<span class="hljs-string"><span class="hljs-string">'manifest.json'</span></span>), }), <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> ], <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> }</code> </pre><br>  Ahora tenemos información sobre los archivos recopilados: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/* manifest.json */</span></span> { <span class="hljs-string"><span class="hljs-string">"app.js"</span></span>: <span class="hljs-string"><span class="hljs-string">"/fallback/js/app.4d03e1af64f68111703e.js"</span></span>, <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> }</code> </pre><br><h4>  Crear index.html con enlaces a todos los archivos javascript </h4><br>  Lo único que queda es agregar index.html e insertar las rutas a los archivos necesarios en él. <br><br>  Para generar el archivo html, usaré html-webpack-plugin durante Modern Build.  El plugin html-webpack insertará las rutas a los archivos modernos en sí, y obtendré las rutas a los archivos de respaldo del archivo creado en el paso anterior y los pegaré en el HTML usando un pequeño plugin webpack: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/* webpack.prod.config.js */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> HtmlWebpackPlugin = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'html-webpack-plugin'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ModernBuildPlugin = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'path/to/ModernBuildPlugin'</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { <span class="hljs-attr"><span class="hljs-attr">mode</span></span>: <span class="hljs-string"><span class="hljs-string">'production'</span></span>, <span class="hljs-attr"><span class="hljs-attr">plugins</span></span>: [ ...(isModern ? [ <span class="hljs-comment"><span class="hljs-comment">//  html-  Modern Build new HtmlWebpackPlugin({ filename: 'index.html', }), new ModernBuildPlugin(), ] : []), /* ... */ ], /* ... */ }</span></span></code> </pre><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/* ModernBuildPlugin.js */</span></span> <span class="hljs-comment"><span class="hljs-comment">// Safari 10.1    nomodule. //      Safari   . //    : // https://gist.github.com/samthor/64b114e4a4f539915a95b91ffd340acc const safariFix = '!function(){var e=document,t=e.createE/* ...   ... */'; class ModernBuildPlugin { apply(compiler) { const pluginName = 'modern-build-plugin'; //    Fallback Build const fallbackManifest = require('path/to/dist/fallback/manifest.json'); compiler.hooks.compilation.tap(pluginName, (compilation) =&gt; { //    html-webpack-plugin, //      HTML compilation.hooks.htmlWebpackPluginAlterAssetTags.tapAsync(pluginName, (data, cb) =&gt; { //  type="module"  modern- data.body.forEach((tag) =&gt; { if (tag.tagName === 'script' &amp;&amp; tag.attributes) { tag.attributes.type = 'module'; } }); //    Safari data.body.push({ tagName: 'script', closeTag: true, innerHTML: safariFix, }); //  fallback-   nomodule const legacyAsset = { tagName: 'script', closeTag: true, attributes: { src: fallbackManifest['app.js'], nomodule: true, defer: true, }, }; data.body.push(legacyAsset); cb(); }); }); } } module.exports = ModernBuildPlugin;</span></span></code> </pre><br>  Actualizar package.json: <br><br><pre> <code class="json hljs">/* package.json */ { <span class="hljs-attr"><span class="hljs-attr">"scripts"</span></span>: { /* ... */ <span class="hljs-attr"><span class="hljs-attr">"build:full"</span></span>: <span class="hljs-string"><span class="hljs-string">"npm run build:fallback &amp;&amp; npm run build:modern"</span></span> }, /* ... */ }</code> </pre><br>  Usando el comando npm run build: full, crearemos un archivo html con Modern y Fallback Build.  Cualquier navegador ahora recibirá el JavaScript que puede ejecutar. <br><br><h2>  Agregue Modern Build a su aplicación </h2><br>  Para probar mi solución en algo real, la conduje a uno de mis proyectos.  Configurar la configuración me llevó menos de una hora, y el tamaño de los archivos JavaScript disminuyó en un 11%.  Gran resultado con una implementación simple. <br><br>  ¡Gracias por leer el artículo hasta el final! <br><br><h3>  Materiales utilizados </h3><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Speed ​​Essentials: técnicas clave para sitios web rápidos</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Vue CLI Modo moderno</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es430950/">https://habr.com/ru/post/es430950/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es430938/index.html">Cómo obtener los primeros pedidos en diseño cuando no hay cartera ni experiencia</a></li>
<li><a href="../es430940/index.html">¡SDK para ti, SDK para mí, SDK para todos! Cómo hacer un SDK y por qué es necesario</a></li>
<li><a href="../es430942/index.html">Julia Scripts y análisis de argumentos de línea de comando</a></li>
<li><a href="../es430944/index.html">La NASA ha decidido a los participantes para su competencia de mini-rover de luna</a></li>
<li><a href="../es430948/index.html">El Ministerio de Comunicaciones propone reforzar el control sobre los datos personales.</a></li>
<li><a href="../es430952/index.html">Los autos eléctricos y los híbridos deberán emitir sonidos adicionales: ¿por qué es necesario?</a></li>
<li><a href="../es430954/index.html">Qt Everywhere: WebAssembly y WebGL Streaming</a></li>
<li><a href="../es430956/index.html">Enseñamos a un cerdo con monoides a creer en sí mismos y volar</a></li>
<li><a href="../es430958/index.html">Lanzamos el contenedor con pruebas unitarias en Azure DevOps (VSTS)</a></li>
<li><a href="../es430960/index.html">Sobre gamedev de una exposición de escritorio</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>