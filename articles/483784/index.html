<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏼 🔚 👐🏿 Cómo hacer una aplicación multiinquilino a partir de una aplicación no inquilina 👨🏾‍🚀 🏇🏾 🌞</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="No daré una definición de arrendamiento múltiple, ya han escrito sobre esto varias veces aquí y aquí . Y es mejor ir directamente al tema del artículo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Cómo hacer una aplicación multiinquilino a partir de una aplicación no inquilina</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/directum/blog/483784/"><p><img src="https://habrastorage.org/webt/-8/wa/hf/-8wahfnvtijn8bqkeopcgo0an1g.png" alt="imagen"></p><br><p>  No daré una definición de arrendamiento múltiple, ya han escrito sobre esto varias veces <a href="https://habr.com/ru/company/microsoft/blog/145027/">aquí</a> y <a href="https://habr.com/ru/company/1c/blog/326654/">aquí</a> .  Y es mejor ir directamente al tema del artículo y comenzar con las siguientes preguntas: </p><br><h2 id="pochemu-prilozhenie-ne-delayut-srazu-multitenantnym">  ¿Por qué la aplicación no es inmediatamente multiempresa? </h2><br><p>  Sucede que la aplicación se desarrolla inicialmente para la instalación solo en el lado del cliente.  Puede llamar a dicha aplicación en caja o <i>software como producto</i> .  Un cliente compra una caja e implementa la aplicación en sus servidores (hay muchos ejemplos de tales aplicaciones). </p><br><p>  Pero con el tiempo, la compañía desarrolladora puede pensar que sería bueno colocar la aplicación en la nube para que se alquile (software como servicio).  Este método de implementación tiene ventajas tanto para los clientes como para la empresa desarrolladora.  Los clientes pueden obtener rápidamente un sistema de trabajo y no preocuparse por la implementación y la administración.  Al alquilar una aplicación, no necesita grandes inversiones únicas. </p><br><p>  Y la empresa desarrolladora recibirá nuevos clientes, así como nuevas tareas: implementar la aplicación en la nube, administrar, actualizar a nuevas versiones, migrar datos durante la actualización, copia de seguridad de datos, monitoreo de velocidad y errores, solucionar problemas si ocurren. </p><a name="habracut"></a><br><h2 id="pochemu-prilozhenie-v-oblake-dolzhno-byt-multitenantnym">  ¿Por qué la aplicación en la nube debe ser multiinquilino? </h2><br><p>  Para colocar una aplicación en la nube, no es necesario que sea multiinquilino.  Pero luego habrá el siguiente problema: para cada cliente, deberá implementar un soporte dedicado en la nube con la aplicación arrendada, y esto ya es costoso, tanto en términos de consumo de recursos de soporte en la nube como en términos de administración.  Es más rentable implementar la tenencia múltiple en la aplicación para que una instancia pueda servir a varios clientes (organizaciones). </p><br><p>  Si la aplicación atrae a 1000 usuarios que trabajan simultáneamente, es ventajoso agrupar clientes (organizaciones) para que en total den la carga deseada de 1000 usuarios por instancia de aplicación.  Y luego habrá el consumo más óptimo de recursos en la nube. </p><br><p>  Supongamos que una organización alquila una aplicación para 20 usuarios (empleados de la organización).  Luego, necesita agrupar 50 de estas organizaciones para alcanzar la carga correcta.  Es importante aislar las organizaciones entre sí.  Una organización alquila una aplicación, permite que solo sus empleados vayan allí, almacena solo sus datos y no ve que otras organizaciones también sean atendidas por la misma aplicación. </p><br><p>  La implementación de arrendamiento múltiple no significa que la aplicación ya no se pueda implementar localmente en el servidor de la organización.  Puede admitir dos métodos de implementación al mismo tiempo: </p><br><ul><li>  aplicación multiinquilino en la nube; </li><li>  aplicación de inquilino único en el servidor del cliente. </li></ul><br><p>  Nuestra aplicación ha tenido un camino similar: de no inquilino a multiinquilino.  Y en este artículo compartiré algunos enfoques para desarrollar la tenencia múltiple. </p><br><h2 id="kak-realizovat-multitenantnost-v-prilozhenii-kotoroe-sproektirovano-kak-ne-tenantnoe">  ¿Cómo implementar el arrendamiento múltiple en una aplicación que está diseñada como no arrendatario? </h2><br><p>  Limitaremos inmediatamente el tema, solo consideraremos el desarrollo, no tocaremos temas de prueba, lanzamiento de una versión, implementación y administración.  En todas estas áreas, también debe tenerse en cuenta la aparición de la tenencia múltiple, pero por ahora solo hablaremos sobre el desarrollo. </p><br><p>  Para comprender qué es una aplicación que no era de inquilinos y se convirtió en multicliente, describiré su propósito, una lista de servicios y tecnologías utilizados. </p><br><p>  Este es un sistema ECM (DirectumRX), que consta de 10 servicios (5 servicios monolíticos y 5 microservicios).  Todos estos servicios se pueden colocar en un servidor potente o en varios servidores. </p><br><div class="spoiler">  <b class="spoiler_title">Los servicios son</b> <div class="spoiler_text"><ul><li>  Servicio web: para dar servicio a clientes web (navegadores). </li><li>  Servicio WCF: para dar servicio a clientes de escritorio (aplicaciones WPF). </li><li>  Servicio para aplicaciones móviles. </li><li>  Servicio para realizar procesos en segundo plano. </li><li>  Servicio de planificación de procesos en segundo plano. </li><li>  Servicio de ejecución de esquema de flujo de trabajo </li><li>  Servicio de ejecución de bloque de flujo de trabajo </li><li>  Servicio de almacenamiento de documentos (datos binarios). </li><li>  Servicio para convertir documentos a html (vista previa en un navegador). </li><li>  Servicio para almacenar resultados de conversión en html </li></ul></div></div><br><p>  Pila de tecnologías utilizadas: <br>  .NET + SQLServer / Postgres + NHibernate + IIS + RabbitMQ + Redis </p><br><p>  Entonces, ¿qué hacer para que los servicios se conviertan en múltiples inquilinos?  Para hacer esto, debe refinar los siguientes mecanismos en los servicios, a saber, agregar conocimiento sobre los inquilinos a: </p><br><ul><li>  almacenamiento de datos; </li><li> ORM; </li><li>  almacenamiento en caché de datos; </li><li>  procesamiento de solicitudes; </li><li>  procesamiento de mensajes en cola; </li><li>  configuración </li><li>  tala </li><li>  realizar tareas de fondo; </li><li>  interacción con microservicios; </li><li>  interacción con el agente de mensajes. </li></ul><br><p>  En el caso de nuestra aplicación, estos fueron los principales lugares que requirieron mejoras.  Consideremos por separado. </p><br><h2 id="vybor-sposoba-hraneniya-dannyh">  Elegir un método de almacenamiento de datos </h2><br><p>  Cuando lee artículos sobre multicliente, lo primero que están resolviendo es cómo organizar el almacenamiento de datos.  De hecho, el punto es importante. </p><br><p>  Para nuestro sistema ECM, el almacenamiento principal es una base de datos relacional, que tiene alrededor de 100 tablas.  ¿Cómo organizar el almacenamiento de datos de muchas organizaciones para que la organización A no vea de ninguna manera los datos de la organización B? </p><br><p>  Se conocen varios esquemas (ya se ha escrito mucho sobre estos esquemas): </p><br><ul><li>  cree su propia base de datos para cada organización (para cada inquilino); </li><li>  use una base de datos para todas las organizaciones, pero para cada organización haga su propio esquema en la base de datos; </li><li>  use una base de datos para todas las organizaciones, pero agregue una columna "clave de inquilino / organización" en cada tabla. </li></ul><br><p>  La elección del esquema no es accidental.  En nuestro caso, es suficiente considerar los casos de administración del sistema para comprender la opción preferida.  Los casos son los siguientes: </p><br><ul><li>  agregar inquilino (una nueva organización alquila un sistema); </li><li>  eliminar inquilino (la organización se negó a alquilar); </li><li>  transferir el inquilino a otro soporte de nube (redistribuir la carga entre los soportes de nube cuando un soporte deja de hacer frente a la carga). </li></ul><br><p>  Considere un caso de transferencia de inquilino.  La tarea principal de la transferencia es transferir los datos de la organización a otro stand.  La transferencia no es difícil de hacer si el inquilino tiene su propia base de datos, pero será un dolor de cabeza si combina los datos de diferentes organizaciones en 100 tablas.  Intente extraer solo los datos necesarios de las tablas, transferirlos a otra base de datos, donde ya hay datos de otros inquilinos, y para que sus identificadores no se crucen. </p><br><p>  El siguiente caso es la incorporación de un nuevo inquilino.  El caso tampoco es simple.  Agregar inquilinos es la necesidad de completar directorios del sistema, usuarios, derechos, para que pueda iniciar sesión en el sistema.  Esta tarea se resuelve mejor clonando una base de datos de referencia, que ya tiene todo lo que necesita. </p><br><p>  El caso de eliminación de inquilinos se resuelve muy fácilmente deshabilitando la base de datos de inquilinos. </p><br><p>  Por estas razones, elegimos un esquema: <strong>un inquilino - una base de datos</strong> . </p><br><h2 id="orm">  ORM </h2><br><p>  Elegimos el método de almacenamiento de datos, la siguiente pregunta: ¿cómo enseñarle a ORM a trabajar con el esquema seleccionado? </p><br><p>  Usamos Nhibernate.  Se requería que Nhibernate trabajara con varias bases de datos y cambiara periódicamente a la correcta, por ejemplo, dependiendo de la solicitud http.  Si procesamos la solicitud de la organización A, se utilizó la base de datos A, y si la solicitud es de la organización B, entonces la base de datos B. </p><br><p>  NHibernate tiene esa oportunidad.  Debe anular la implementación de <em>NHibernate.Connection.DriverConnectionProvider</em> .  Cada vez que NHibernate quiere abrir una conexión de base de datos, llama a <em>DriverConnectionProvider</em> para obtener una cadena de conexión.  Aquí lo reemplazaremos con el necesario: </p><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MyDriverConnectionProvider</span></span> : <span class="hljs-title"><span class="hljs-title">DriverConnectionProvider</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConnectionString =&gt; TenantRegistry.Instance.CurrentTenant.ConnectionString; }</code> </pre> <br><p>  ¿Qué es <em>TenantRegistry.Instance.CurrentTenant</em> que contaré un poco más tarde? </p><br><h2 id="keshirovanie-dannyh">  Almacenamiento en caché de datos </h2><br><p>  Los servicios a menudo almacenan datos en la memoria caché para minimizar las consultas a la base de datos o no para calcular la misma cosa muchas veces.  El problema es que los inquilinos deben desglosar los cachés si los datos del inquilino se almacenan en caché.  No es aceptable que el caché de datos de una organización se use al procesar una solicitud de otra organización.  La solución más simple es agregar un identificador de inquilino a la clave de cada caché: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tenantCacheKey = cacheKey + TenantRegistry.Instance.CurrentTenant.Id;</code> </pre> <br><p>  Este problema debe recordarse al crear cada caché.  Hay muchos cachés en nuestros servicios.  Para no olvidar tener en cuenta el identificador de inquilino en cada uno, es mejor unificar el trabajo con cachés.  Por ejemplo, cree un mecanismo de almacenamiento en caché general que se almacene en la memoria caché de fábrica en el contexto de los inquilinos. </p><br><h2 id="logirovanie">  Registro </h2><br><p>  Tarde o temprano, algo saldrá mal en el sistema, deberá abrir el archivo de registro y comenzar a estudiarlo.  La primera pregunta es: ¿en nombre de qué usuario y qué organización se comprometieron estas acciones? </p><br><p>  Es conveniente cuando cada línea del registro tiene un identificador de inquilino y un nombre de usuario de inquilino.  Esta información se vuelve tan necesaria como, por ejemplo, el tiempo del mensaje: </p><br><pre> <code class="plaintext hljs">2019-05-24 17:05:27.985 &lt;message&gt; [User2 :Tenant1] 2019-05-24 17:05:28.126 &lt;message&gt; [User3 :Tenant2] 2019-05-24 17:05:28.173 &lt;message&gt; [User4 :Tenant3]</code> </pre> <br><p>  El desarrollador no debe pensar qué inquilino debe escribir en el registro, debe ser automático, oculto "bajo el capó" del sistema de registro. </p><br><p>  Usamos NLog, así que daré un ejemplo al respecto.  La forma más fácil de proteger el identificador de inquilino es crear <em>NLog.LayoutRenderers.LayoutRenderer</em> , que le permite obtener un identificador de inquilino para cada entrada de registro: </p><br><pre> <code class="cs hljs"> [<span class="hljs-meta"><span class="hljs-meta">LayoutRenderer(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"tenant"</span></span></span><span class="hljs-meta">)</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">TenantLayoutRenderer</span></span> : <span class="hljs-title"><span class="hljs-title">LayoutRenderer</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Append</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">StringBuilder builder, LogEventInfo logEvent</span></span></span><span class="hljs-function">)</span></span> { builder.Append(TenantRegistry.Instance.CurrentTenant.Id); } }</code> </pre> <br><p>  Y luego use este LayoutRenderer en la plantilla de registro: </p><br><pre> <code class="plaintext hljs">&lt;target layout="${odate} ${message} [${user} :${tenant}]"/&gt;</code> </pre> <br><h2 id="vypolnenie-koda">  Ejecución de código </h2><br><p>  En los ejemplos anteriores, a menudo utilicé el siguiente código: </p><br><pre> <code class="cs hljs">TenantRegistry.Instance.CurrentTenant</code> </pre> <br><p>  Es hora de decir lo que eso significa.  Pero primero debe comprender el enfoque que seguimos en los servicios: </p><br><blockquote>  Cualquier ejecución de código (procesar una solicitud http, procesar un mensaje de cola, realizar una tarea en segundo plano en un hilo separado) debe estar asociada con algún inquilino. </blockquote><p>  Esto significa que en cualquier lugar de la ejecución del código se puede preguntar: "¿Para qué inquilino funciona este hilo?"  o de otra manera, "¿Cuál es el inquilino actual?" </p><br><p>  <em>TenantRegistry.Instance.CurrentTenant</em> es el inquilino actual para la secuencia actual.  Stream y el inquilino se pueden vincular en nuestras aplicaciones.  Se conectan temporalmente, por ejemplo, al procesar una solicitud http o al procesar un mensaje de la cola.  Una forma de vincular al inquilino a una secuencia se realiza así: </p><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//    . using (TenantRegistry.Instance.SwitchTo(tenantId)) { // ,     . var tenant = TenantRegistry.Instance.CurrentTenant; //     . var connectionString = tenant.ConnectionString; //  . var id = tenant.Id; }</span></span></code> </pre> <br><p>  Un inquilino vinculado a un hilo se puede obtener en cualquier parte del código, contactando a <em>TenantRegistry</em> ; este es un punto <em>único</em> , un punto de acceso para trabajar con inquilinos.  Por lo tanto, Nhibernate y NLog pueden acceder a este singleton (en los puntos de extensión) para averiguar la cadena de conexión o el identificador de inquilino. </p><br><h2 id="fonovye-zadachi">  Tareas de fondo </h2><br><p>  Los servicios a menudo tienen tareas en segundo plano que deben realizarse en un temporizador.  Las tareas en segundo plano pueden acceder a la base de datos de la organización, y luego la tarea en segundo plano debe realizarse para cada inquilino.  Para hacer esto, no es necesario iniciar un temporizador o subproceso por separado para cada inquilino.  Es posible realizar una tarea en diferentes inquilinos dentro de un solo hilo / temporizador.  Para hacer esto, en el controlador del temporizador, clasificamos los inquilinos, asociamos cada inquilino con una secuencia y realizamos una tarea en segundo plano: </p><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//    . foreach (var tenant in TenantRegistry.Instance.Tenants) { //    . using (TenantRegistry.Instance.SwitchTo(tenant.Id)) { //     . } }</span></span></code> </pre> <br><p>  No se pueden unir dos inquilinos al flujo al mismo tiempo; si adjuntamos uno, el otro se separa del flujo.  Utilizamos activamente este enfoque para no producir hilos / temporizadores para tareas en segundo plano. </p><br><h2 id="kak-sootnesti-http-zapros-c-tenantom">  Cómo correlacionar una solicitud http con un inquilino </h2><br><p>  Para procesar la solicitud http del cliente, debe saber de qué organización vino.  Si el usuario ya está autenticado, el identificador de inquilino se puede almacenar en la cookie de autenticación (si el trabajo con la aplicación se realiza a través del navegador) o en el token JWT.  Pero, ¿qué pasa si el usuario aún no se ha autenticado?  Por ejemplo, un usuario anónimo ha abierto un sitio web de aplicación y desea autenticarse.  Para hacer esto, envía una solicitud con un nombre de usuario y contraseña.  ¿En la base de datos de qué organización buscar este usuario? </p><br><p>  Además, se recibirán solicitudes anónimas para obtener la página de inicio de sesión en la aplicación, y puede diferir para diferentes organizaciones, por ejemplo, el idioma de localización. </p><br><p>  Para resolver el problema de la correlación de la solicitud anónima de http y la organización (inquilino), utilizamos subdominios para organizaciones.  El nombre del subdominio está formado por el nombre de la organización.  Los usuarios deben usar el subdominio para trabajar con el sistema: </p><br><pre> <code class="plaintext hljs">https://company1.service.com https://company2.service.com</code> </pre> <br><p>  El mismo servicio web multiinquilino está disponible en estas direcciones.  Pero ahora el servicio comprende de qué organización vendrá una solicitud http anónima, centrándose en el nombre de dominio. <br>  El enlace del nombre de dominio y el inquilino se realiza en el archivo de configuración del servicio web: </p><br><pre> <code class="json hljs">&lt;tenant name=<span class="hljs-string"><span class="hljs-string">"company1"</span></span> db=<span class="hljs-string"><span class="hljs-string">"database1"</span></span> host=<span class="hljs-string"><span class="hljs-string">"company1.service.com"</span></span> /&gt; &lt;tenant name=<span class="hljs-string"><span class="hljs-string">"company2"</span></span> db=<span class="hljs-string"><span class="hljs-string">"database2"</span></span> host=<span class="hljs-string"><span class="hljs-string">"company2.service.com"</span></span> /&gt;</code> </pre> <br><p>  Sobre la configuración de servicios se describirá a continuación. </p><br><h2 id="mikroservisy-hranenie-dannyh">  Microservicios  Almacenamiento de datos </h2><br><p>  Cuando dije que el sistema ECM necesita 100 tablas, hablé de los servicios monolíticos.  Pero sucede que un microservicio requiere un almacenamiento relacional, en el que se necesitan 2-3 tablas para almacenar sus datos.  Idealmente, cada microservicio tiene su propio almacenamiento, al que solo tiene acceso.  Y el microservicio decide cómo almacenar datos en el contexto de los inquilinos. </p><br><p>  Pero fuimos por el otro lado: decidimos almacenar todos los datos de la organización en una base de datos.  Si un microservicio requiere almacenamiento relacional, entonces utiliza la base de datos de la organización existente para que los datos no estén dispersos en diferentes almacenes, sino que se recopilen en una base de datos.  Los servicios monolíticos usan la misma base de datos. </p><br><p>  Los microservicios funcionan solo con sus tablas en la base de datos, y no intente trabajar con tablas de un monolito u otro microservicio.  Hay ventajas y desventajas de este enfoque. </p><br><p>  Pros: </p><br><ul><li>  datos de la organización en un solo lugar; </li><li>  fácil de respaldar y restaurar datos de la organización; </li><li>  En la copia de seguridad, los datos de todos los servicios son consistentes. </li></ul><br><p>  Contras: </p><br><ul><li>  una base de datos para todos los servicios es estrecha cuando se escala (aumentan los requisitos para los recursos DBMS); </li><li>  Los microservicios tienen acceso físico a las tablas de los demás, pero no utilizan esta función. </li></ul><br><h2 id="mikroservisy-znanie-o-tenantah-ne-vsegda-trebuetsya">  Microservicios  No siempre se requiere conocimiento de los inquilinos. </h2><br><p>  Un microservicio puede no saber que funciona en un entorno multiinquilino.  Considere uno de nuestros servicios, que se dedica a convertir documentos a html. </p><br><p>  Qué hace el servicio: </p><br><ol><li>  Toma un mensaje de una cola RabbitMQ para convertir un documento. <br><ul><li>  recupera el identificador del documento y el identificador del inquilino del mensaje </li></ul></li><li>  Descargue un documento de un servicio de almacenamiento de documentos. <br><ul><li>  para esto genera una solicitud en la que transmite el identificador del documento y el identificador del inquilino </li></ul></li><li>  Convierte un documento a html. </li><li>  Da html al servicio para almacenar resultados de conversión. </li></ol><br><p>  El servicio no almacena documentos y no almacena resultados de conversión.  Tiene conocimiento indirecto de los inquilinos: el identificador del inquilino pasa por el servicio en tránsito. </p><br><h2 id="mikroservisy-poddomeny-ne-nuzhny">  Microservicios  No se necesitan subdominios </h2><br><p>  Escribí anteriormente que los subdominios ayudan a resolver el problema de las solicitudes anónimas de http: </p><br><pre> <code class="plaintext hljs">https://company1.service.com https://company2.service.com</code> </pre> <br><p>  Pero no todos los servicios funcionan con solicitudes anónimas, la mayoría requiere autenticación ya aprobada.  Por lo tanto, los microservicios que funcionan a través de http a menudo no les importa de qué nombre de host proviene la solicitud, reciben toda la información sobre el inquilino desde el token JWT o la cookie de autenticación que viene con cada solicitud. </p><br><h2 id="konfigurirovanie">  Configuracion </h2><br><p>  Los servicios deben configurarse para que conozcan a los inquilinos.  A saber: </p><br><ul><li>  especifique las cadenas para conectarse a la base de datos de inquilinos; </li><li>  enlazar nombres de dominio a inquilinos; </li><li>  especifique el idioma predeterminado y la zona horaria del inquilino. </li></ul><br><p>  Los inquilinos pueden tener muchas configuraciones.  Para nuestros servicios, establecemos configuraciones de inquilinos en archivos de configuración xml.  Esto no es web.config ni app.config.  Este es un archivo xml separado, cuyos cambios deben poder capturarse sin reiniciar los servicios para que agregar un nuevo inquilino no reinicie todo el sistema. </p><br><p>  La lista de configuraciones es algo como esto: </p><br><pre> <code class="xml hljs"><span class="hljs-comment"><span class="hljs-comment">&lt;!--  . --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">block</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"TENANTS"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tenant</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Jupiter"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">db</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"DirectumRX_Jupiter"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">login</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"admin"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">password</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"password"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">hyperlinkUriScheme</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"jupiter"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">hyperlinkFileExtension</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">".jupiter"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">hyperlinkServer</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://jupiter-rx.directum.ru/Sungero"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">helpAddress</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://jupiter-rx.directum.ru/Sungero/help"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">devHelpAddress</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://jupiter-rx.directum.ru/Sungero/dev_help"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">language</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Ru-ru"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">isAttributesSignatureAbsenceAllowed</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">endorsingSignatureLocksSignedProperties</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">administratorEmail</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"admin@jupiter-company.ru"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">feedbackEmail</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"support@jupiter-company.ru"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">isSendFeedbackAllowed</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">serviceUserPassword</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"password"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">utcOffset</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"5"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">collaborativeEditingEnabled</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">collaborativeEditingForced</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tenant</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Mars"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">db</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"DirectumRX_Mars"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">login</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"admin"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">password</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"password"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">hyperlinkUriScheme</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"mars"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">hyperlinkFileExtension</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">".mars"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">hyperlinkServer</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://mars-rx.directum.ru/Sungero"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">helpAddress</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://mars-rx.directum.ru/Sungero/help"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">devHelpAddress</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://mars-rx.directum.ru/Sungero/dev_help"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">language</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Ru-ru"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">isAttributesSignatureAbsenceAllowed</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">endorsingSignatureLocksSignedProperties</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">administratorEmail</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"root@mars-ooo.ru"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">feedbackEmail</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"support@mars-ooo.ru"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">isSendFeedbackAllowed</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">serviceUserPassword</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"password"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">utcOffset</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"-1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">collaborativeEditingEnabled</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">collaborativeEditingForced</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">block</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Cuando una nueva organización alquila un servicio, necesita agregar un nuevo inquilino al archivo de configuración.  Y es deseable que otras organizaciones no sientan esto.  Idealmente, no debería haber un reinicio de los servicios. </p><br><p>  En nosotros, no todos los servicios pueden recoger una configuración sin reiniciar, pero los servicios más críticos (monolitos) pueden hacerlo. </p><br><h2 id="itog">  Resumen </h2><br><p>  Cuando una aplicación se convierte en multiinquilino, parece que la complejidad del desarrollo ha aumentado dramáticamente.  Pero luego te acostumbras a la multiempresa y tratas su apoyo como un requisito normal. </p><br><p>  También vale la pena recordar que la tenencia múltiple no es solo desarrollo, sino también pruebas, administración, implementación, actualización, copias de seguridad, migraciones de datos.  Pero mejor sobre ellos en otro momento. </p></div></div><p>Source: <a href="https://habr.com/ru/post/483784/">https://habr.com/ru/post/483784/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../483770/index.html">Hacia la automatización SSL</a></li>
<li><a href="../483774/index.html">El resumen de eventos para profesionales de recursos humanos en TI para enero de 2020</a></li>
<li><a href="../483776/index.html">Introducción al método diferencial semántico en 5 minutos.</a></li>
<li><a href="../483778/index.html">Semana de la seguridad 03: Principios responsables del informe de errores</a></li>
<li><a href="../483780/index.html">¿Qué es la holgura y cómo funciona?</a></li>
<li><a href="../483786/index.html">Clasificación híbrida</a></li>
<li><a href="../483788/index.html">La pequeña nación isleña gana gracias a Twitch</a></li>
<li><a href="../483790/index.html">Notas del proveedor de IoT. Tecnología y economía LoRaWAN en alumbrado urbano</a></li>
<li><a href="../483794/index.html">Dejando ir: por qué no deberías tomar kontroffer</a></li>
<li><a href="../483796/index.html">Parámetros opcionales en repositorios de datos de Spring</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>