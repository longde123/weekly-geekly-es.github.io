<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üï¶ üíß üöß "20.000 IOPS pro Knoten bieten eine gute Leistung bei einer Latenz von 5 ms." F√ºr OLTP - nein ü§∞ üëÇüèΩ üë®üèΩ‚Äçü§ù‚Äçüë®üèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Der Grund f√ºr das Schreiben dieses Artikels war eine sehr w√ºrdige √úberpr√ºfung, wie wir VMware vSAN ... CROC getestet haben. Die Rezension ist es wert,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>"20.000 IOPS pro Knoten bieten eine gute Leistung bei einer Latenz von 5 ms." F√ºr OLTP - nein</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/414269/"><p><img src="https://habrastorage.org/webt/fq/yy/2k/fqyy2kbw4iqx5ikqy7v-o60jfce.jpeg" alt="KDPV"></p><br><p>  Der Grund f√ºr das Schreiben dieses Artikels war eine sehr w√ºrdige √úberpr√ºfung, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">wie wir VMware vSAN ...</a> CROC <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">getestet</a> haben.  Die Rezension ist es wert, aber sie enth√§lt einen Satz, mit dem ich seit mehr als einem Jahrzehnt zu k√§mpfen habe.  Speicheradministratoren, Virtualisierer und Integratoren wiederholen immer wieder: "Verz√∂gerungen von 5 ms sind ein hervorragender Indikator."  Auch die Zahl von 5 ms f√ºr zehn Jahre √§ndert sich nicht.  Ich habe das mindestens ein Dutzend Mal live von hoch angesehenen Admins geh√∂rt.  Von weniger angesehenen - Dutzenden und wie oft ich im Internet lese ... Nein, nein, nein.  Bei OLTP-Lasten von 5 ms, insbesondere wenn sie normalerweise gemessen werden, handelt es sich um epische Fehler.  Ich musste die Gr√ºnde daf√ºr oft erkl√§ren, diesmal beschloss ich, meine Gedanken in einer wiederverwendbaren Form zu sammeln. </p><br><p>  Ich muss sofort sagen, dass der oben erw√§hnte Artikel keine derartigen Fehler enth√§lt, sondern dass der Ausdruck als Ausl√∂ser fungierte. </p><a name="habracut"></a><br><h2 id="tipichnoe-nachalo">  Typischer Start </h2><br><p>  Alles, was in diesem Artikel beschrieben wird, gilt f√ºr g√§ngige DBMS, die f√ºr typisches Gesch√§fts-OLTP verwendet werden.  Vor allem habe ich Erfahrung mit MS SQL Server, aber zumindest f√ºr PostgeSQL, Oracle und Sybase werden auch viele Punkte und Schlussfolgerungen zutreffen. </p><br><p>  Leistung DBMS ist normalerweise mit allen unzufrieden.  Wenn es in einem gro√üen System ein DBMS gibt - und es pl√∂tzlich fast immer da ist -, ist dieses DBMS ein Engpass.  Nun, oder es wird sofort zu einem Engpass, wenn Sie anfangen, alles andere zu optimieren.  Und so kommt der Kunde und sagt mit menschlicher Stimme: "Hilfe! Sparen! Sie haben $ NNNNNNNN f√ºr den Server und den Speicher bezahlt, aber die Geschwindigkeit steigt nicht! Oh, und der Administrator hat eingerichtet und der Anbieter hat sich beraten, bewegt sich aber immer noch nicht."  Wenn die Entwickler des Systems der Definition von Lawrow entsprechen (wir k√∂nnen auf ein genaues Angebot verzichten) und die Betriebs- und Wartungsspezialisten ‚Äûmit Vorf√§llen durch Neustart des Servers k√§mpfen‚Äú, ist das Problem oft einfach und unpr√§tenti√∂s: Es gibt keine Indizes, krummen Abfragen, schwerwiegende Konfigurationsfehler (√ºber die die Dokumentation fett gedruckt ist) es hei√üt <strong>"das kannst du nicht !!!"</strong> ), √ºberm√§√üige Sperren, Deadlocks und anderer einfacher und klarer Unsinn.  Es gibt viele solcher F√§lle, die meisten, aber nicht alle.  Wenn das System in seiner Komplexit√§t oder Auslastung eine unsichtbare Grenze √ºberschritten hat, stirbt es entweder an diesen Problemen oder geht zur n√§chsten Ebene √ºber. </p><br><div class="spoiler">  <b class="spoiler_title">SQL Server-Diagnosetipps</b> <div class="spoiler_text"><p> IMHO, das beste Tool ist jetzt das <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">SQL Server First Responder Kit</a> , das von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Brent Ozar</a> beworben wird.  Dieses Tool entwickelt sich sehr aktiv.  Es gibt noch ein w√ºrdiges <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Set</a> von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Glenn Berry</a> , er hat auch sein Projekt nicht aufgegeben.  Beide Sets sind auf ihre Weise wundersch√∂n. Das erstmalige Lesen von Kommentaren und Fragen er√∂ffnet viele neue M√∂glichkeiten.  Ich selbst sehe mich immer mit <code>sys.dm_os_waitsats</code> , schaue kurz in das <code>sys.dm_os_waitsats</code> und <code>sys.dm_os_waitsats</code> heraus, ob es mindestens ein funktionierendes Backup-System gibt. </p></div></div><br><p>  Auf dieser Ebene befindet sich der Server nicht mehr unter der Tabelle des Direktors, die Festplatten befinden sich nicht mehr im Server, aber im Speichersystem kennen Entwickler Indizes und Administratoren kennen PowerShell bereits, und IT-Manager beginnen, intelligente W√∂rter wie SLA und RPO / RTO zu sagen.  Auf dieser Ebene ergibt sich eine interessante Situation: </p><br><ul><li>  DBMS ist ein Engpass. </li><li>  Der Server scheint in jeder Hinsicht ausreichend zu sein. </li><li>  DBMS kann programmgesteuert weiter verbessert werden, ist jedoch schwierig (entweder zu teureren Lizenzen wechseln oder zur Optimierung in die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">"rote Zone der Shipilev-Kurve"</a> wechseln) </li><li>  Das Festplattensystem ist teuer gekauft und anscheinend sogar irgendwie konfiguriert. </li></ul><br><p>  Aber nein.  Das Krokodil wird nicht gefangen, die Kokosnuss w√§chst nicht und die Systemleistung ist gleich oder niedriger als auf dem alten Server.  Ich schaue in <code>sys.dm_os_waitsats</code> und sehe oben <code>WRITELOG</code> , <code>PAGEIOLATCH_SH</code> und <code>PAGEIOLATCH_EX</code> , die durchschnittliche Wartezeit betr√§gt 5+ ms.  Nun, typisch, cho: "Hey, Admins und DBA, hier hast du ein Diskettensystem - Engpass" und hier beginnt ein altes Lied √ºber 5 ms: </p><br><ul><li>  Wir haben 5 ms f√ºr SLA </li><li>  Ja, wir haben ein Regiment von 20.000 IOPS </li><li>  Der Anbieter teilte uns mit, dass sich alle Datenbankdateien auf einer Partition befinden k√∂nnen </li><li>  Wir haben Virtualisierung und Hyperkonvergenz und k√∂nnen keine separaten Festplatten unter der Datenbank zuordnen </li><li>  Nach unseren Angaben betr√§gt die Serverauslastung 5% </li><li>  Alles ist gem√§√ü den Empfehlungen konfiguriert </li><li>  Ihre Datenbanken ben√∂tigen nicht viel Leistung, sie leisten nicht mehr als 300 IOPS (und wir haben ein Regal f√ºr 20.000 IOPS). </li></ul><br><p>  √úbrigens, all das, nicht nur √ºber "ihre" Server, sondern auch √ºber Cloud-Dienste und Virtualisierung.  Es gibt eine Reihe eigener Besonderheiten, aber das typische klinische Bild ist ungef√§hr das gleiche: m√§√üig optimierte Datenbank, cleveres Entwicklungs- und Wartungspersonal, eine Reserve f√ºr Prozessor und Speicher, der "Auspuff" aus weiteren Investitionen ist nahezu Null. </p><br><p>  Also.  Dieses ganze Lied √ºber "5 ms" ist Unsinn und Unsinn.  Wenn Sie dies selbst sagen, lesen Sie diesen Artikel.  Und wenn sie dir das sagen, bereite die Argumente vor.  Fr√ºher, als ich diese Worte h√∂rte, war ich w√ºtend, aber ich bin nicht mehr w√ºtend.  Ich habe wie dieser Topf mit einer Petunie aus dem Per Anhalter durch die Galaxis nur einen Gedanken: "Nun, wieder ...". </p><br><h2 id="kto-vinovat">  Wer ist schuld? </h2><br><p>  Warum ist die Datenbank so langsam?  Nun, es scheint, dass ein typischer Server mit 20-64 Kernen bei einer Frequenz von 2-3 GHz 50-150 Milliarden einfache Operationen ausf√ºhren kann, und die maximalen (synthetischen) Datenbanktests zeigen auf solchen Maschinen nur 10.000-50000 Transaktionen pro Sekunde.  Hey!  Nun, das sind eine Million bis ein Dutzend m√∂gliche Millionen von Transaktionen pro Transaktion.  Es ist nicht nur viel, es ist viel zu sp√ºren. <br>  Ein solcher Overhead kostet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ACID-</a> Anforderungen f√ºr Transaktionen. </p><br><ul><li>  <strong>Eine</strong> Tomicity - entweder ist die gesamte Transaktion abgeschlossen oder das Ganze ist nicht abgeschlossen. </li><li>  <strong>C</strong> onsistancy - Beim Ein- und Ausstieg einer Transaktion befindet sich das System in einem konsistenten Zustand </li><li>  <strong>Ich</strong> solation - Transaktionen sehen nicht die Zwischenzust√§nde des anderen </li><li>  Dauerhaftigkeit - Wenn die Transaktion erfolgreich abgeschlossen (festgeschrieben) wurde, m√ºssen die vorgenommenen √Ñnderungen unabh√§ngig von den Umst√§nden im System verbleiben. </li></ul><br><p>  Buchstabe f√ºr Buchstabe werden diese Anforderungen √ºbrigens fast nirgendwo und nie erf√ºllt, sondern einfach nie in verteilten Systemen (der CAP-Satz greift ein).  In unserer Situation ist die D-Anforderung h√∂chstwahrscheinlich teurer als andere. Diese Anforderung wird durch den Schl√ºsselmechanismus aller g√§ngigen OLTP-DBMS bereitgestellt: WAL, Write-Ahead-Protokoll (PostgeSQL), es ist auch ein Transaktionsprotokoll (SQL Server), auch bekannt als REDO-Protokoll (Oracle).  Hier ist es - ein Stein am Hals der Produktivit√§t, und es ist die Grundlage f√ºr Durability-Transaktionen. </p><br><h3 id="chto-takoe-wal">  Was ist WAL? </h3><br><p>  Vergessen wir f√ºr einen Moment moderne SSDs, coole Speichersysteme.  Angenommen, wir haben einen Server, der eine oder mehrere Festplatten hat. <br>  Jede Transaktion, auch das Einf√ºgen eines Datensatzes, ist zumindest potenziell, aber tats√§chlich fast immer und realistisch eine nichtatomare Aktion.  Wir m√ºssen fast immer nicht nur die Seite √§ndern, auf der sich der Datensatz befindet, sondern auch Indexseiten, m√∂glicherweise Serviceseiten.  Dar√ºber hinaus kann sich dieselbe Seite in derselben Transaktion viele Male √§ndern.  Au√üerdem k√∂nnen andere Transaktionen parallel zu uns durchgef√ºhrt werden.  Dar√ºber hinaus "ziehen" die zeitlich benachbarten Transaktionen st√§ndig die gleichen Seiten.  Wenn wir warten, bis jede Seite auf die Festplatte geschrieben ist, bevor wir fortfahren, was im Wesentlichen f√ºr die Haltbarkeit erforderlich ist, m√ºssen wir ein Vielfaches mehr schreiben und warten, bis jede Aufnahme auf nichtfl√ºchtigen Medien abgeschlossen ist.  Keine Caches, keine Neuordnung von Operationen in der Warteschlange, sonst gibt es keine Integrit√§t!  Au√üerdem m√ºssen wir irgendwie feststellen, welche Daten sich bereits auf festen Transaktionen befinden und welche noch nicht (und welche Daten zuvor waren).  Zum Verst√§ndnis - eine typische einzelne Festplatte (HDD) in diesem Modus liefert 50-100 IOPS, und dies ist seit 20 Jahren eine Konstante.  Eine kleine Transaktion erfordert 5-10 Schreibvorg√§nge.  Ah ja, um zu wissen, was aufzunehmen ist, m√ºssen Sie es lesen.  Selbst sehr, sehr stark beschreibbare OLTP-Systeme lesen dreimal mehr als sie schreiben.  Somit kostet unsere Transaktion 20-40 IO, was 0,2-0,8 Sekunden pro Festplatte bedeutet. <br>  2 Transaktionen pro Sekunde.  Nicht genug?  Versuchen wir, die Festplatten zu verteilen.  Oh, aber wir m√ºssen noch warten, bis die vorherige aufgenommen ist und es am Ende keine Parallelit√§t gibt.  Wie man ist  Und starten wir eine Protokolldatei, in der wir nacheinander alle Schreibvorg√§nge in der Datenbank und die Transaktionsmarken aufzeichnen!  Vorteile: </p><br><ul><li>  Informationen √ºber den Vorgang k√∂nnen viel kompakter sein als das Aufzeichnen der gesamten Seite (eine typische Seitengr√∂√üe betr√§gt 8 KB, in das Protokoll geschriebene Informationen betragen h√§ufig 0,5 bis 1 KB). </li><li>  Anstatt dar√ºber zu schreiben, ob die Transaktion direkt auf der Seite aufgezeichnet wurde oder nicht, gibt es im Protokoll gen√ºgend Beschriftungen f√ºr den Beginn und die Korrektur der Transaktion. </li><li>  Seiten k√∂nnen nicht nach jeder Transaktion geschrieben werden - um ein Vielfaches weniger.  Das Lesen / Schreiben von Daten wird vollst√§ndig aus dem Protokoll "gel√∂st". </li><li>  Die Hauptsache.  Wenn wir unser Journal auf einer separaten Festplatte ablegen und Datens√§tze nacheinander schreiben, werden aufgrund der Tatsache, dass Sie die Festplattenk√∂pfe nicht st√§ndig neu positionieren m√ºssen, selbst eine Haushaltsfestplatte in diesem Modus bis zu 1000 IOPS komprimiert, da kleine Transaktionen 2-4 Journaleintr√§ge ‚Äûkosten‚Äú. dann k√∂nnen Sie 200-400 TPS dr√ºcken </li><li>  Im Falle eines Fehlers kann der Status der Datendatei aus einem solchen Protokoll wiederhergestellt werden. Wenn die Transaktion abgebrochen wird, kann sie zur√ºckgesetzt werden </li></ul><br><p>  Ein solches Protokoll wird als Vorausschreibprotokoll / Transaktionsprotokoll / REDO-Protokoll bezeichnet. </p><br><p>  Hurra!  Gro√üartig!  Es gab 2 Transaktionen pro Sekunde, es wurde 300 - 150-mal verbessert.  Und zu welchem ‚Äã‚ÄãPreis?  Wie sich herausstellt, ist der Preis erheblich: </p><br><ul><li>  In allen g√§ngigen DBMS ist die Protokollierung streng konsistent.  Ein Thread ist f√ºr das Schreiben in das Protokoll verantwortlich.  Haben Sie 100 Prozessoren?  Cool.  Und das Protokoll schreibt immer noch einen Thread.  Die Tiefe der Warteschlange ist genau eins. </li><li>  Trotzdem - keine Betriebssystem-Caches, keine Operationspermutationen.  Die Anforderungen an die Haltbarkeit blieben bestehen.  Durchschreibvorg√§nge: Bis die CD mit "Ich habe geschrieben, ich habe sie direkt an die Oberfl√§che geschrieben, sicher nicht in den Cache" antwortete. Das DBMS funktioniert nicht weiter. </li><li>  Wenn Sie die Protokolldatei auf der Datendiskette ablegen, gehen fast alle Vorteile der sequentiellen Aufzeichnung verloren.  Au√üerdem - f√ºr immer, wenn sich mehrere Datenbanken auf dem Server befinden, dann mehrere Datentr√§ger f√ºr Magazine. </li><li>  Transaktions-Rollback (zumindest in MS SQL Server) - Lesen Sie das Protokoll und stellen Sie den Status wieder her.  Dies sind so viele oder sogar mehr Schreibvorg√§nge, wie Schreibvorg√§nge in der Transaktion vorhanden waren.  Rollback ist teuer! </li></ul><br><p>  Diese Erkl√§rung ist sehr vereinfacht, "an den Fingern".  Das reicht f√ºr unser Thema.  WAL ist ein wichtiger, grundlegender Mechanismus zur Gew√§hrleistung der Transaktionsf√§higkeit. Es handelt sich notwendigerweise um Durchschreiben. Der Zugriff erfolgt nur f√ºr die sequentielle Aufzeichnung mit einem Thread. Aus Sicht der Speicherung betr√§gt die Warteschlangentiefe 1. </p><br><div class="spoiler">  <b class="spoiler_title">Wenn Sie an diesem Thema interessiert sind</b> <div class="spoiler_text"><ul><li>  Ein sehr einf√ºhrender Artikel <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Wie Datenbanken entworfen werden</a> </li><li>  Es gibt eine hervorragende Artikelserie f√ºr SQL Server: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">So beenden Sie den Aufruf des SQL Server-Transaktionsprotokolls als Protokolldatei und k√§mpfen nicht mehr um seine Gr√∂√üe.</a> </li><li>  Es ist interessant, ein wenig von der anderen Seite zu schauen, zum Beispiel die Abschrift eines ausgezeichneten Berichts √ºber das speicherinterne <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Tarantool-</a> DBMS </li><li>  Jedes DBMS verf√ºgt √ºber umfangreiche Abschnitte, in denen die Funktionsweise von WAL erl√§utert wird. </li></ul></div></div><br><p>  Das Thema der Vorausschreibprotokollierung in der Datenbank sollte jedem, der das DBMS oder die DBMS-Infrastruktur irgendwie verwaltet oder Datenbanken entwickelt, zumindest minimal bekannt sein. </p><br><h3 id="wal-i-shd">  WAL und SHD </h3><br><p>  Speicherhersteller von Geburt an sind mit DBMS konfrontiert.  F√ºr Datenbanken kauft das Unternehmen diese wahnsinnig teuren Komplexe: Aus den Stra√üenpreisspeichern von Dell-EMC, HP, Hitachi und NetApp f√ºllen sich die Augen f√ºr die meisten Top-Manager mit Tr√§nen, es sei denn, sie erhalten nat√ºrlich einen Prozentsatz dieses Preises.  Es gibt jedoch einen Engineering- und Marketingkonflikt.  Ich werde es am Beispiel von Dell-EMC erl√§utern, aber nur, weil ich mich daran erinnere, wo sich die Dokumentation befindet. </p><br><p>  Also: </p><br><ol><li>  Single Threaded Journal </li><li>  Das Durchschreibprotokoll, dh die Latenz, ist im Vergleich zur CPU-Leistung "ewig" </li><li>  OLTP-Lasten sind viele relativ kleine Transaktionen. </li><li>  Die meisten anderen DBMS-Lasten sind auf die eine oder andere Weise parallel. </li></ol><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Amdahls Gesetz</a> sagt uns gnadenlos, dass eine Single-Threaded-Last mit geringer Leistung das Hinzuf√ºgen von Prozessoren unbrauchbar macht und die Leistung durch das Protokoll bestimmt wird.  Dar√ºber hinaus werden wir uns in diesem Moment nicht um die Leistung des Speichers in IOPS k√ºmmern, und nur die Latenz wird wichtig. <br>  Diskontieren Sie jedoch nicht andere Festplattenvorg√§nge - Lesen und Schreiben in Datendateien und <code>tempdb</code> .  Lesen ist auch eine "wartende" Operation.  Bis eine Datenseite von der Festplatte in den Speicher gelesen wird, kann der Prozessor sie nicht verarbeiten.  Bei diesen Vorg√§ngen sind jedoch gro√üe Warteschlangen und die Permutation von Vorg√§ngen in dieser Warteschlange m√∂glich: Das DBMS wei√ü h√§ufig, welche Seiten in den Speicher geladen werden m√ºssen, welche Seiten ausgegeben werden m√ºssen, und stellt viele Warteschlangen gleichzeitig zum Lesen bereit.  Da es in diesem Szenario wichtig ist, wenn die letzte Operation aus dem Bundle endet, ist IOPS bei dieser Last im Gegenteil wichtiger als die Latenz einer einzelnen Operation.  Um den Umfang zu verstehen: Lesevorg√§nge in einem typischen OLTP-System sind 85% -95%.  Ja, ja, ja, Schreiboperationen sind um eine Gr√∂√üenordnung geringer. </p><br><p>  Vendor Storage-Ingenieure arbeiten eng mit DBMS-Anbietern zusammen und kennen alle technischen Nuancen der Funktionsweise eines DBMS mit einem Festplattensubsystem.  Die ordnungsgem√§√üe Planung, Partitionierung und Zuweisung von Festplattenressourcen f√ºr das DBMS ist eine komplexe und wichtige Kompetenz des <strong>Administrators des Speichersystems</strong> .  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Dieselbe</a> Dell-EMC verf√ºgt sogar √ºber das grundlegende <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Whitepaper H14621</a> und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">H12341</a> zum Partitionieren von Empfehlungen f√ºr SQL Server - √ºber hundert Seiten.  Hey!  Dies ist kein detailliertes Dock, dies ist das am h√§ufigsten verwendete Whitepaper!  Es gibt immer noch eine Reihe spezifischer ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">h15142</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">h16389</a> ... dort herrscht Dunkelheit).  Die ‚ÄûNachbarn‚Äú von VMware - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Architektur von Microsoft SQL Server auf VMware vSphere</a> liegen nicht weit zur√ºck.  Bitte beachten Sie, dass diese Dokumente nicht nur f√ºr Datenbankadministratoren, sondern auch f√ºr Infrastruktur- und Speicheradministratoren bestimmt sind. <br>  Ich <code>tempdb</code> auch fest, dass in all diesen Dokumenten separate LUNs f√ºr Daten, Protokolle und <code>tempdb</code> .  Ja, irgendwo in den neuesten Dokumenten hei√üt es genau, dass es f√ºr All-Flash-L√∂sungen keinen Sinn macht, die Protokolle in physisch getrennte Medien aufzuteilen, aber LUNs bieten immer noch an, sie getrennt zu schneiden.  Wenn Sie Daten sichern und sich bei einer LUN anmelden, handelt es sich aus Sicht des Betriebssystems um eine E / A-Warteschlange.  Und es wird ein Problem geben.  Latenzoperationen haben sofort eine Gr√∂√üenordnung mehr.  Und aufgrund der Tatsache, dass nicht verschiebbare Protokollvorg√§nge in der Warteschlange angezeigt werden, rutscht IOPS auf Datendateien und <code>tempdb</code> .  Dies ist keine "Entdeckung des Jahrhunderts", sondern eine elementare Wahrheit der Arbeit mit der Datenbank.  Es ist nicht veraltet oder mit dem Aufkommen von All-Flash abgebrochen.  Ja, Verz√∂gerungen bei Operationen mit SSDs sind um eine Gr√∂√üenordnung schneller als bei Operationen mit HDDs, aber immer noch einige Gr√∂√üenordnungen langsamer als Operationen mit Speicher.  IO ist immer noch der Engpass des DBMS. <br>  Und die technischen Dokumente betonen korrekt, dass in den Transaktionsprotokollen die Anzahl der IOPS nicht wichtig ist, aber es ist wichtig, dass die Latenz minimal ist (in der heutigen Zeit wird geschrieben, dass weniger als 1 ms). </p><br><p>  Aber Vermarkter m√ºssen verkaufen.  Hyperkonvergenz!  Virtualisierung!  Flexibilit√§t bei der Bereitstellung!  Deduplizierung!  Einfache Einrichtung!  Viele, viele IOPS!  Sch√∂ne Pr√§sentationen, selbstbewusste Stimme, formelle Kost√ºme.  Aber wie kann man sonst eine L√∂sung mit einem 6-7-stelligen Preis in Dollar verkaufen?  Aus diesem Grund wird irgendwie vergessen, dass entweder Latenz oder Durchsatz vom Speichersystem abgerufen werden k√∂nnen, aber nicht beide gleichzeitig, dass eine Art Lizenz f√ºr den Load Balancer wie ein anderes Regal ist, dass, wenn die intensive Aufzeichnung l√§nger als eine Stunde dauert, der RAM der Controller Es ist nicht genug und die Produktivit√§t wird auf "als ob es keinen Cache gibt" sinken. Die Schulung der Mitarbeiter des Kunden kostet im ersten Jahr weitere 100.000 Rubel. Nun, solche Tricks ... </p><br><h3 id="5-ms">  5 ms </h3><br><p>  Entweder viel vom Lesen von Vermarktern oder von Faulheit geh√∂rt zu haben oder wegen irgendeiner Art von Kakerlaken, aber aus irgendeinem Grund tun Speicheradministratoren oft so etwas.  Wir nehmen ein gro√ües Regal, kombinieren alles zu etwas Flachem, schneiden es in d√ºnne bereitgestellte LUNs und verteilen es per LUN an den Server.  Oder zwei, weil "die Systempartition gut dedupliziert ist".  Und wenn ich sehe, dass mit dem Festplattensubsystem von der Seite von SQL H√∂lle-H√∂lle-H√∂lle, dann beginnt genau das Lied, dass "5 ms ein ausgezeichneter Indikator ist", dass "100000 IOPS", "Ihre Speicherlast ist weniger als 5%" </p><br><p>  <strong>NEIN</strong> . </p><br><ul><li>  F√ºr OLTP-Systeme auf einer Partition mit WAL / Transaktionsprotokollen von 5 ms ist dies ein ung√ºltiger Indikator.  Auf dem "fast handels√ºblichen" St√ºck Eisen zu einem Preis von 1000 (in Worten: tausendmal) billiger ist der normale Indikator jetzt 0,1 bis 0,3 ms.  Und morgen - 0,01 ms.  Geschwindigkeit wie die der Festplatte von 2008 zum Preis eines ganzen Eingangs von Wohnungen in Moskau ist nicht erforderlich.  Keine ‚ÄûWartungsfreundlichkeit‚Äú lohnt sich. </li><li>  Schreibt der Anbieter, dass Transaktionsprotokolle keine Anforderungen an IOPS stellen und auf die Festplatte gestellt werden k√∂nnen?  Ja das stimmt.  Daf√ºr ist jedoch keine dieser Festplatten erforderlich <del>  Ansteckung </del>  Zus√§tzlich zum Schreiben von Protokollen hat das DBMS die Aufgabe nicht ber√ºhrt.  Und damit das Speichersystem dem Server antwortet, dass die Daten geschrieben werden, sofort, wenn die Daten in den nichtfl√ºchtigen Speicher gelangen (dies ist viel fr√ºher als sie geschrieben werden). </li><li>  D√ºnne Festplatten f√ºr echte OLTP-Datenbanken sind b√∂se. </li><li>  F√ºr WAL ist es absolut uninteressant, wie viel IOPS bei einer Warteschlangentiefe von 10 oder 20 herausgedr√ºckt werden kann. Dort gibt es keine Tiefe. </li><li>  F√ºr WAL ist dies absolut kein Indikator daf√ºr, dass die E / A-Warteschlange im Betriebssystem "nur etwa 1" betr√§gt.  Sie wird nicht mehr sein. </li><li>  Nein, DBA- und DB-Entwickler sind keine "Spechte, die sich nicht richtig konfigurieren k√∂nnen, um in die WAL-Parallele zu schreiben" <em>(echte Meinung des Administrators).</em> </li><li>  Die Logik der L√ºfter, das Recycling in Betracht zu ziehen "Da Ihr System, das <em>wir krumm in einer Partition konfiguriert haben,</em> keine 10.000 IOPS ausf√ºhrt, muss es von einem High-End-Array in einen mittleren Bereich verschoben werden" - dies ist eine falsche Logik. </li><li>  Wenn der 40-Core-Server eine Prozessorlast von 2,5 Prozent hat, bedeutet dies nicht, dass er nichts zu tun hat, sondern h√∂chstwahrscheinlich, dass es eine Aufgabe gibt, die alle anderen blockiert. </li></ul><br><p>  Wenn das Laden einiger Daten auf den Laptop des Entwicklers 5 Minuten dauert und auf dem 40. Nuklearserver mit 1 TiB RAM und Speicher f√ºr eine halbe Million Dollar dieselbe Aufgabe eine Stunde lang ausgef√ºhrt wird, haben selbst die geduldigsten Kunden Fragen zur Machbarkeit der Kosten. </p><br><table><thead><tr><th>  Durchschnittliche Latenz der WAL-Partition </th><th>  Es wird nie mehr Transaktionen pro Sekunde geben als: </th></tr></thead><tbody><tr><td>  5 ms </td><td>  200 </td></tr><tr><td>  1 ms </td><td>  1000 </td></tr><tr><td>  0,5 ms </td><td>  2000 </td></tr><tr><td>  0,1 ms </td><td>  10.000 </td></tr><tr><td>  0,05 ms </td><td>  20000 </td></tr></tbody></table><br><h2 id="chto-delat">  Was zu tun ist </h2><br><h3 id="sovety-administratoram-i-dba">  Admin-Tipps und Datenbankadministratoren </h3><br><p>  H√∂ren Sie bei OLTP auf, ‚ÄûRecycling‚Äú und IOPS zu z√§hlen.  Unabh√§ngig davon stelle ich fest, dass IOPS √ºberhaupt nicht mit einer gro√üen Warteschlangentiefe betrachtet werden: Selbst auf Datenpartitionen weisen gro√üe Warteschlangen normalerweise einen kurzen Burst auf oder etwas, das die tats√§chliche Leistung von OLTP nicht beeintr√§chtigt. </p><br><p>  Das Teilen von Speicherplatz durch LUN ist keine DBA-Laune.  Die Datenbank verf√ºgt √ºber verschiedene Lastprofile des Festplattensubsystems.  Zumindest kann Folgendes unterschieden werden: </p><br><ul><li>  Arbeiten Sie mit Datendateien.  Normalerweise liest und schreibt dies mit zuf√§lligen Bl√∂cken von 8/64 KiB.  Messwerte 80-95%.  Warteschlangen entstehen: w√§hrend Dienstzeiten, w√§hrend Massenladezeiten, bei ineffizienten oder Massenanforderungen und w√§hrend des Pr√ºfpunkts.  Die Leistung wird durch die Reaktionsf√§higkeit auf das Lesen beeinflusst.  Es ist wichtig, dass die Ausrichtung der 8/64 KiB-Bl√∂cke ‚Äûdurch‚Äú das gesamte Speichersystem durchl√§uft. </li><li>  Das Arbeiten mit <code>tempdb</code> dem Arbeiten mit Datendateien, die Messwerte liegen jedoch normalerweise zwischen 40 und 75%, und die Reaktionsf√§higkeit beim Schreiben kann wichtig sein.  In modernen MS SQL-Systemen kann diese Datenbank um ein Vielfaches st√§rker geladen werden als Datendatenbanken.  In einer DBMS-Konfiguration ohne Cluster sollte dieser Abschnitt von jeder Speicherreplikation ausgeschlossen werden.  Sein Inhalt nach dem Neustart des Dienstes wird weiterhin zerst√∂rt. </li><li>  Arbeiten Sie mit archivierten Daten / DWH.  Die Messwerte liegen nahe bei 100%.  Die Gr√∂√üe eines Leseblocks betr√§gt normalerweise 64 KB.  Anfragen werden h√§ufig und hintereinander gelesen, sodass die Warteschlange bis zu 1000 oder mehr umfassen kann. </li><li>  Arbeiten Sie mit Transaktionsprotokollen.  Das Lesen dient nur der Wartung (Sicherung, Replikation usw.). Die Anwendungsleistung wird nur durch das Schreiben beeintr√§chtigt.  Aufnahme in Bl√∂cken von 0,5-64 KiB.  Ohne Warteschlange in einem Thread.  Verz√∂gerung ist f√ºr Anwendungen von entscheidender Bedeutung. </li><li>  Sichern und wiederherstellen.  Aus Sicht der Datenbank wird in gro√üen Bl√∂cken gelesen (oft 1 MiB).  Es ist wichtig, dass diese Last in einigen F√§llen auf den Kan√§len / Bussen (sowohl FC als auch Ethernet) und der Leistung von Speicherprozessoren ruhen kann.  Das Sichern eines Servers kann die Leistung anderer Server desselben SAN / SHD beeintr√§chtigen. </li><li>  Arbeiten mit Anwendungsdateien: Dies sind Protokolle, Standardablaufverfolgung, Bin√§rdateien usw.  Diese Belastung ist selten signifikant und nur zu Beginn des Systems wichtig. </li></ul><br><p>  Es gibt andere Arten des Ladens, diese sind jedoch leicht exotisch (z. B. kann ein Repository von Dateien in Form des FileStream-Verzeichnisses in der Datenbank gespeichert sein).  Alle diese Arten von Lasten haben unterschiedliche, h√§ufig widerspr√ºchliche Festplattenanforderungen.  Wenn sie alle auf einer Partition gestapelt sind, verschlechtern Sie nicht nur die Leistung, sondern es ist auch sehr wichtig, dass Sie nicht mehr verstehen, warum das System langsamer wird, und Sie verlieren auch die M√∂glichkeit, nur den Teil zu verbessern, der ohne globale Verbesserungen / Upgrades des Speichers verbessert werden muss.  Daher die Hauptempfehlung: </p><br><p> <strong>      ,   "   "        .        .</strong> </p><br><p>     </p><br><ul><li>    ,   .  Dell/EMC  SQL Server     . </li><li>    .      ""  (, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="> NUC c SSD,  , </a> ).    --,    . </li><li>      <strong></strong>     DBA,    -   ( 200   ). </li><li>        (etrolaster   ), ,     ,  .      +0,5 ,    0,2,     0,7     3 . </li><li>   ,          .      <code>tempdb</code>  , , ,       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">RCSI</a>   12      . </li><li> Latency    throughput.         ,   " ",   .    throughput  latency,    .      . </li></ul><br><h3 id="ms-sql-server"> MS SQL Server </h3><br><p>    MS SQL,            bottleneck  ,  - : </p><br><ol><li>        .  Das ist richtig.        . 1000          5-30      1000 <code>INSERT</code> . , , ,       ,      "  ‚Äî  ". </li><li>  <code>tempdb</code>   " ".    . ,     ,       . </li><li>     ,    BULK INSERT      .            ,      "Simple"  "Bulk logged". , ,         Simple/Bulk logged  Full  .         ‚Äî <a href="">The Data Loading Performance Guide</a> ,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="></a> .   (  ETL,   OLTP)       <a href="">We Loaded 1TB in 30 Minutes with SSIS, and So Can You</a> </li><li>    SQL Server  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Delayed Transaction Durability</a> ‚Äî ,       . </li><li>    SQL Server  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">In-Memory OLTP</a> .    ,        . </li><li> ,     ,   AlwaysOn . </li></ol><br><h2>  ***. </h2><br><p>  Das ist alles.   . 20000 IOPS  5  latency    4-16         OLTP.  OLTP    ,        . </p><br><div class="spoiler"> <b class="spoiler_title">PS:    SSD.</b> <div class="spoiler_text"><p>              .  Intel Optane.   SSD ""       4,       .            SSD, ,     ,      .    SSD  . ,      ""   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">,    </a> .      Intel Optane:      ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="></a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="></a> )        1     20 .     ,  . SSD        100-300 .   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="></a>     SSD. <br>  , .         OLTP "",  in-memory     ACID.     latency 20      "" .  low-latency        Optane ( <em>    ?</em> ). <br>          ( ) Optane. </p></div></div><br><div class="spoiler"> <b class="spoiler_title"></b> <div class="spoiler_text"><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link">eugeneb0</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link">apatyukov</a>     . </p></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de414269/">https://habr.com/ru/post/de414269/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de414255/index.html">Patentierter Traum des Programmierers - Teil II</a></li>
<li><a href="../de414261/index.html">Wo speichern Sie die Daten?</a></li>
<li><a href="../de414263/index.html">Gibt es Leben au√üerhalb von Roscosmos? √úberblick √ºber die Erforschung des russischen Privatraums</a></li>
<li><a href="../de414265/index.html">Richard Hamming: Kapitel 7. K√ºnstliche Intelligenz - II</a></li>
<li><a href="../de414267/index.html">Wie ersetze ich einen Buchhalter durch einen Roboter?</a></li>
<li><a href="../de414271/index.html">So z√§hmen Sie eine Festplatte in einem Laptop und verhindern das Parken in 8 Sekunden Ausfallzeit</a></li>
<li><a href="../de414273/index.html">Was Sie wissen m√ºssen, bevor Sie einen Backtester f√ºr eine Handelsstrategie entwickeln: typische Probleme, Systemtypen und deren Parameter</a></li>
<li><a href="../de414277/index.html">Der Mensch, seine Umwelt und das Internet der Dinge</a></li>
<li><a href="../de414279/index.html">Abstimmung f√ºr Berichte beim achten DIY-Meeting in der Mail.Ru Group (07.07.2018)</a></li>
<li><a href="../de414281/index.html">Entwicklung eines Fahrradtachometers basierend auf einem Display des Nokia 3310</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>