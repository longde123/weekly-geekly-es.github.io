<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üåí ü§õüèª ü§µüèº Imers√£o no AD: analisamos ataques avan√ßados no Microsoft Active Directory e como detect√°-los ‚òéÔ∏è üåæ üë®üèæ‚Äçüîß</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Imagem: Pexels 

 Nos √∫ltimos quatro anos, nenhum Black Hat ou DEF CON ficou sem relat√≥rios sobre ataques ao Microsoft Active Directory. Os participan...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Imers√£o no AD: analisamos ataques avan√ßados no Microsoft Active Directory e como detect√°-los</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pt/blog/423903/"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img src="https://habrastorage.org/webt/a7/-h/dd/a7-hddi1lio7lql-ftmp3xryg1e.jpeg"></a> <br><br>  <i>Imagem: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Pexels</a></i> <br><br>  Nos √∫ltimos quatro anos, nenhum Black Hat ou DEF CON ficou sem relat√≥rios sobre ataques ao Microsoft Active Directory.  Os participantes falam sobre novos vetores e suas inven√ß√µes, mas n√£o esquecem dicas sobre como detect√°-los e evit√°-los.  Neste artigo, examinaremos maneiras populares de atacar o AD e forneceremos recomenda√ß√µes que ajudar√£o a proteger contra eles. <a name="habracut"></a><br><br><h2>  Seis ataques do AD que voc√™ n√£o pode ignorar </h2><br>  Muitos fabricantes de software de monitoramento de seguran√ßa j√° oferecem suporte a uma variedade de t√©cnicas de ataque em seus produtos.  Vamos considerar alguns deles. <br><br><h3>  Pass-the-hash </h3><br>  Essa t√©cnica √© poss√≠vel devido aos recursos arquitet√¥nicos do protocolo de autentica√ß√£o NTLM, desenvolvido pela Microsoft nos anos noventa do s√©culo passado.  Para fazer login em um host remoto, √© usado um hash de senha, que √© armazenado na mem√≥ria do computador no qual a autentica√ß√£o ocorre.  Consequentemente, pode ser extra√≠do de l√°. <br><br><h3>  Mimikatz </h3><br>  Para uma opera√ß√£o conveniente do Pass-the-Hash, o pesquisador franc√™s Benjamin Delpy (Benjamin Delpy) em 2014 desenvolveu o utilit√°rio mimikatz.  Ele permite descarregar senhas de texto n√£o criptografado e hashes NTLM da mem√≥ria. <br><br><h3>  For√ßa bruta </h3><br>  Se o invasor n√£o tiver credenciais suficientes para extrair de um host, ele poder√° recorrer a uma t√©cnica grosseira, mas eficaz, de adivinha√ß√£o de senha. <br><br><h3>  usu√°rio / dom√≠nio da rede </h3><br>  Onde obter um dicion√°rio de nomes de usu√°rio para realizar a For√ßa Bruta?  Qualquer membro do dom√≠nio pode usar o comando net user / domain, que retorna uma lista completa de nomes de usu√°rio do AD. <br><br><h3>  Kerberoasting </h3><br>  Se o dom√≠nio usar o Kerberos como protocolo de autentica√ß√£o, o invasor poder√° recorrer a um ataque de Kerberoasting.  Qualquer usu√°rio autenticado no dom√≠nio pode solicitar um ticket Kerberos para acessar o Servi√ßo de Concess√£o de Ticket.  O TGS √© criptografado com o hash da senha da conta na qual o servi√ßo de destino est√° sendo executado.  Um invasor que obteve o TGS agora pode descriptograf√°-lo, escolhendo uma senha e n√£o tendo medo de bloquear, pois o faz offline.  Ap√≥s um resultado bem-sucedido, ele recebe uma senha da conta associada ao servi√ßo, que geralmente √© privilegiada. <br><br><h3>  Psexec </h3><br>  Depois que o invasor recebe as credenciais necess√°rias, ele se depara com a tarefa de executar comandos remotamente.  O utilit√°rio PsExec do conjunto Sysinternals √© adequado para isso.  Ele se provou tanto entre administradores de TI quanto entre atacantes. <br><br><h2>  Sete feiti√ßos de ataque para capturar o Active Directory </h2><br>  Agora estamos migrando para sete feiti√ßos, gra√ßas aos quais os invasores podem assumir o controle completo do Active Directory.  Vamos dividi-los em quatro etapas: <br><br><ol><li>  Intelig√™ncia. </li><li>  Promo√ß√£o no AD. </li><li>  Opera√ß√£o. </li><li>  Captura de dom√≠nio. </li></ol><br>  No diagrama, voc√™ pode ver todos os quatro, bem como as t√©cnicas usadas neles.  Vamos considerar cada um em detalhes. <br><br><img src="https://habrastorage.org/webt/bq/lw/uf/bqlwufggd4wwixlwo6dsb5w66by.png"><br><br><h2>  Etapa 1. Explora√ß√£o </h2><br>  Vamos come√ßar com o est√°gio de intelig√™ncia. <br><br><h3>  Powerview </h3><br>  Essa ferramenta faz parte da popular estrutura de teste de penetra√ß√£o do PowerShell - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">PowerSploit</a> .  Ele tamb√©m conta com a ferramenta <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">BloodHound</a> , que cria um gr√°fico de relacionamentos de objetos no AD. <br><br><img src="https://habrastorage.org/webt/vb/45/xl/vb45xlilemlfooxopnrxytorpq0.png"><br><br>  <i>Representa√ß√£o gr√°fica de relacionamentos de objetos do Active Directory</i> <br><br>  Bloodhound fornece imediatamente esses recursos: <br><br><ul><li>  Encontre contas de todos os administradores de dom√≠nio; </li><li>  encontre hosts nos quais os administradores de dom√≠nio estejam conectados; </li><li>  crie o caminho mais curto do host do invasor para o host com a sess√£o de administra√ß√£o do dom√≠nio. </li></ul><br>  O √∫ltimo par√°grafo fornece uma resposta para a pergunta de quais hosts precisam ser invadidos por hackers para acessar a conta de administrador do dom√≠nio.  Essa abordagem reduz bastante o tempo para obter controle total sobre o dom√≠nio. <br><br>  O PowerView difere dos utilit√°rios internos para recuperar dados sobre objetos do AD (por exemplo, net.exe), na medida em que √© executado no protocolo LDAP, n√£o no SAMR.  O evento 1644 de um controlador de dom√≠nio √© adequado para detectar essa atividade.  O log deste evento √© ativado adicionando o valor apropriado no registro: <br><br> <code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\NTDS\Diagnostic\\15 Field Engineering = 5</code> <br> <br><img src="https://habrastorage.org/webt/7q/i2/ny/7qi2nyhavykzj4rqdyohz3ou0pi.png"><br><br>  <i>Habilitando o log de eventos LDAP 1644</i> <br><br><img src="https://habrastorage.org/webt/aj/6m/1b/aj6m1bzfn0tgimroq6gnxva_7_e.png"><br><br>  <i>Evento 1644 com par√¢metros de solicita√ß√£o LDAP</i> <br><br>  Vale a pena prestar aten√ß√£o ao fato de que pode haver muitos desses eventos, e uma boa alternativa √† detec√ß√£o de eventos √© a detec√ß√£o de tr√°fego, pois o LDAP √© um protocolo de texto n√£o criptografado; portanto, todas as solicita√ß√µes no tr√°fego s√£o perfeitamente vis√≠veis. <br><br> <a href=""><img src="https://habrastorage.org/webt/_w/cd/s3/_wcds3rfyfneg4f6fukn2ojjx4q.png"></a> <br><br>  <i>LDAP SearchRequest (clique para abrir a imagem em tamanho real)</i> <br><br>  Outro recurso importante dessa estrutura √© que ela √© escrita no PowerShell puro e n√£o possui depend√™ncias.  E aqui, para detec√ß√£o, o recurso avan√ßado de auditoria introduzido no PowerShell vers√£o 5 nos ajudar√°.  O evento 4104 mostra o corpo de um script no qual podemos procurar nomes de fun√ß√µes espec√≠ficas do PowerView. <br><br><img src="https://habrastorage.org/webt/4g/3q/ri/4g3qri26i-n9yd52ca5s95o-fg0.png"><br><br><h3>  Verifica√ß√£o SPN </h3><br>  Ele pode substituir o nmap de inicializa√ß√£o do invasor.  Depois que o invasor descobrir quais usu√°rios e grupos est√£o no AD, para concluir a imagem, ele precisar√° de informa√ß√µes sobre quais servi√ßos est√£o dispon√≠veis. <br><br><img src="https://habrastorage.org/webt/yt/gp/ro/ytgprok6xzem1x1ihixxn1awb1q.png"><br><br>  Isso geralmente √© resolvido varrendo as portas com o nmap.  Mas agora essas informa√ß√µes tamb√©m podem ser obtidas no AD - elas j√° est√£o armazenadas l√°.  Voc√™ pode ver o resultado dessa solicita√ß√£o: retorne o chamado SPN (Service Principal Names).  O SPN consiste em uma classe de servi√ßo, √© exclusivo para cada tipo de servi√ßo e, em seguida, vem o nome do host na forma de FQDN e, para alguns servi√ßos - porta. <br><br><img src="https://habrastorage.org/webt/5b/z8/ot/5bz8otu_w7hroldiqy0wscyut-g.png"><br><br>  <i>Exemplos de spn</i>  <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Lista completa de nomes principais de servi√ßo</a></i> <br><br>  Para detectar a verifica√ß√£o do SPN, a auditoria de eventos LDAP tamb√©m vem ao resgate. <br>  √â importante observar que a verifica√ß√£o do SPN tem uma vantagem distinta sobre a verifica√ß√£o do nmap: √© menos barulhenta.  Ao usar o nmap, voc√™ precisa se conectar a cada n√≥ e enviar pacotes para o intervalo de portas que voc√™ especificou.  E para obter a lista de SPN, voc√™ precisa enviar apenas uma solicita√ß√£o. <br><br><h3>  Enumera√ß√£o de sess√µes remotas </h3><br>  Uma tarefa importante para um invasor no est√°gio de movimento lateral √© determinar qual usu√°rio est√° conectado a qual m√°quina.  Ou ele j√° possui credenciais de usu√°rio (hash ou t√≠quete Kerberos) e est√° procurando hosts nos quais voc√™ pode fazer login sem impedimentos.  Ou ele est√° em busca de um host em que haja uma sess√£o de administrador de dom√≠nio ativo. <br><br>  Ent√£o o cen√°rio funciona: ca√ßando -&gt; comprometendo qualquer host -&gt; Golfo de Mimikatz -&gt; lucro. <br><br>  Voc√™ pode usar 2 eventos para detectar esta t√©cnica.  4624 √© um logon bem-sucedido em um sistema remoto com um logon do tipo 3, bem como eventos de acesso √† rede IPC $, e a nuance √© o nome do pipe - srvsvc.  Por que um tubo √© chamado pode ser entendido a partir do tr√°fego. <br><br> <a href=""><img src="https://habrastorage.org/webt/gl/5k/kf/gl5kkf1bkclyx3b5dgkvwhxpeyo.png"></a> <br><br>  <i>Clique para abrir a imagem em tamanho real.</i> <br><br>  No lado esquerdo, nos quadros vermelhos, acesse SMB e, em seguida, acesse pipe - srvsvc.  Esse canal permite que voc√™ interaja usando o Protocolo remoto de servi√ßo de servidor especial.  Permite que os hosts finais recebam v√°rias informa√ß√µes administrativas, incluindo  Entre as consultas, h√° uma chamada NetSessEnum.  Como resultado dessa solicita√ß√£o, uma lista completa de usu√°rios conectados ao sistema remoto com IP e nomes de usu√°rio √© retornada. <br><br> <a href=""><img src="https://habrastorage.org/webt/6z/3-/oa/6z3-oas3amujm5b6kohgowgops0.png"></a> <br><br>  <i>No MaxPatrol SIEM, fizemos uma detec√ß√£o com base em uma combina√ß√£o desses dois eventos, levando em considera√ß√£o srvsvc.</i>  <i>E uma detec√ß√£o de tr√°fego semelhante no PT Network Attack Discovery.</i> <br><br><h2>  Etapa 2. Promo√ß√£o do AD </h2><br><h3>  Overpass-the-hash </h3><br>  A reencarna√ß√£o de Pass-the-Hash.  Continuando o tema do movimento lateral.  O que um invasor pode fazer se tiver um hash NTLM?  Ele pode realizar um ataque Pass-the-Hash - mas j√° existem detec√ß√µes nela.  Portanto, um novo vetor foi encontrado - o ataque Overpass-the-Hash. <br><br>  O protocolo Kerberos foi projetado especificamente para que as senhas dos usu√°rios, de uma forma ou de outra, n√£o sejam transmitidas pela rede.  Para fazer isso, em sua m√°quina, o usu√°rio coloca sua senha criptografada na solicita√ß√£o de autentica√ß√£o.  Em resposta, o Centro de Distribui√ß√£o de Chaves (um servi√ßo especial hospedado no controlador de dom√≠nio) emite um ticket para receber outros tickets.  O chamado Ticket Granting Ticket (TGT).  Agora, o cliente √© considerado autenticado e, dentro de 10 horas, pode solicitar tickets para acessar outros servi√ßos.  Por conseguinte, se um ataque despejar hash de um usu√°rio que seja membro de um grupo confi√°vel de um servi√ßo de seu interesse, por exemplo, um sistema ERP ou banco de dados, o invasor poder√° emitir um passe para si pr√≥prio e efetuar login com √™xito no servi√ßo de seu interesse. <br><br><img src="https://habrastorage.org/webt/6s/iy/qv/6siyqv90fxjresvbwwzhw2ioynw.png"><br><br><h4>  Como detectar </h4><br>  Se o invasor usar a vers√£o do mimikatz do PowerShell para esse ataque, o registro do corpo do script ser√° √∫til.  Porque Invoke-Mimikatz √© uma linha muito caracter√≠stica. <br><br><img src="https://habrastorage.org/webt/hh/3v/cu/hh3vcum-h8mlcker6wdmdsjiwfu.png"><br><br><img src="https://habrastorage.org/webt/hh/3v/cu/hh3vcum-h8mlcker6wdmdsjiwfu.png"><br><br>  Ou 4688 √© um evento de in√≠cio do processo com auditoria avan√ßada da linha de comandos.  Mesmo que o binar seja renomeado, na linha de comando, encontraremos um comando muito caracter√≠stico da mimikatz. <br><br><img src="https://habrastorage.org/webt/ur/li/cq/urlicqqkfzjpcphbagcrhvzdoxw.png"><br><br>  O tr√°fego de ultrapassar o hash pode ser detectado com base em uma anomalia resultante do fato de a Microsoft recomendar o uso da solicita√ß√£o de autentica√ß√£o AES256 para criptografia dos dom√≠nios atuais.  E mimikatz, quando envia dados de solicita√ß√£o de autentica√ß√£o, criptografa os dados usando o ARCFOUR desatualizado. <br><br> <a href=""><img src="https://habrastorage.org/webt/1n/yh/tr/1nyhtr7fvxksqjh6snv_dwyhtco.png"></a> <br><br>  No tr√¢nsito, outra diferen√ßa √© observada devido √†s caracter√≠sticas da mimikatz.  Ele se baseia na diferen√ßa no conjunto de cifras no dom√≠nio leg√≠timo e no que a mimikatz envia. <br><br><h3>  Bilhete de ouro </h3><br>  O que um invasor pode fazer se tiver um hash de senha de uma conta especial chamada krbtgt?  Anteriormente, consideramos o caso em que o usu√°rio n√£o podia ter privil√©gios.  Agora, estamos considerando um usu√°rio com um hash de senha no qual absolutamente todos os tickets para outros tickets (TGT) s√£o assinados.  Assim, o atacante n√£o se dirige mais ao Centro de Distribui√ß√£o de Chaves, ele gera esse ticket por conta pr√≥pria, j√° que o Golden Ticket, em ess√™ncia, √© o TGT.  Em seguida, ele pode enviar solicita√ß√µes de autentica√ß√£o para qualquer servi√ßo dentro do AD e por tempo ilimitado.  Como resultado, ele recorre livremente a esse recurso - o Bilhete de Ouro n√£o √© sem raz√£o chamado de ouro. <br><br><img src="https://habrastorage.org/webt/58/z6/vh/58z6vh3afwjzkebygy_jmxu6ee0.png"><br><br><h4>  Como detectar por eventos </h4><br>  H√° o evento 4768, que diz que o TGT foi emitido, e o evento 4769, que diz que foi emitido um t√≠quete de servi√ßo, necess√°rio para autentica√ß√£o em algum servi√ßo dentro do AD. <br><br><img src="https://habrastorage.org/webt/wx/l5/gx/wxl5gx-fncwjf1oukr1ldumzzv8.png"><br><br>  Aqui podemos jogar a diferen√ßa:  durante um ataque, o Golden Ticket n√£o solicita um TGT de um controlador de dom√≠nio (ele o gera por si pr√≥prio) e precisa solicitar um TGS; se encontrarmos uma diferen√ßa no TGT e no TGS recebidos, podemos assumir que um ataque do Golden Ticket est√° ocorrendo. <br><br>  No MaxPatrol SIEM usando listas de tabelas nas quais registramos todos os TGT e TGS emitidos, conseguimos implementar essa detec√ß√£o. <br><br><h3>  Execu√ß√£o remota WMI </h3><br>  Ap√≥s a resolu√ß√£o da tarefa de autentica√ß√£o e autoriza√ß√£o nos hosts desejados, o invasor pode come√ßar a executar tarefas remotamente.  O WMI, como um mecanismo interno e projetado para isso, se encaixa perfeitamente.  Nos √∫ltimos anos, "viver fora da terra" significa usar os mecanismos internos do Windows em uma tend√™ncia.  Primeiro de tudo, porque permite que voc√™ se disfarce de atividade leg√≠tima. <br><br> <a href=""><img src="https://habrastorage.org/webt/m-/96/ez/m-96ez5gjcxuckslwxweegfopcu.png"></a> <br><br>  Na captura de tela, o uso do utilit√°rio wmic interno.  Ele especifica o endere√ßo do host ao qual voc√™ deseja se conectar, credenciais, a instru√ß√£o de cria√ß√£o de chamada de processo e o comando que deve ser executado no host remoto. <br><br><h4>  Como detectar </h4><br>  Em v√°rios eventos de um logon remoto 4624 (preste aten√ß√£o a <br>  mania no ID de logon) e no evento 4688, falando sobre iniciar um processo com a linha de comando.  4688 - voc√™ pode ver que o pai do processo iniciado √© o WmiPrvSE.exe, um processo especial do servi√ßo WMI usado para administra√ß√£o remota.  O comando que enviamos net user / add √© vis√≠vel e o ID de logon corresponde ao evento 4624. Portanto, podemos dizer exatamente de qual host esse comando est√° sendo executado. <br><br><img src="https://habrastorage.org/webt/7u/eb/ei/7uebeito5oikpqj5c_uth187-3m.png"><br><br><h4>  Detec√ß√£o de Tr√°fego </h4><br>  Aqui, vemos claramente as palavras caracter√≠sticas do processo Win32 criadas, bem como a linha de comando, que √© enviada para iniciar.  Na captura de tela, conhecemos recentemente um malware, distribu√≠do em redes virtuais de acordo com um princ√≠pio semelhante ao WannaCry, mas, em vez de criptografia, ele instalou um minerador.  Malvar carregava mimikatz e EthernalBlue com ela, ela despejou as contas; com a ajuda delas, ela se conectou a todos os hosts que conseguia acessar na rede.  Usando o WMI, ela lan√ßou o PowerShell neles, baixou a carga √∫til do PowerShell, que novamente continha mimikatz, EthernalBlue e o mineiro.  Assim, uma rea√ß√£o em cadeia foi obtida. <br><br><img src="https://habrastorage.org/webt/xm/jy/yb/xmjyybw60n3mxmjjrnm8wwvsrq8.png"><br><br><h2>  Recomenda√ß√µes para os est√°gios 1-3 </h2><br><blockquote>  1. <b>Senhas longas e complexas (&gt; 25 caracteres) para contas de servi√ßo.</b>  Isso n√£o deixar√° o atacante a chance de realizar um ataque de Kerberoasting, pois  vai demorar muito tempo para ser bruto. <br><br>  2. <b>Registrando o PowerShell</b> .  Isso ajudar√° a detectar o uso de muitas ferramentas modernas para ataques ao AD <br><br>  3. <b>Mudando para o Windows 10, Windows Server 2016. A</b> Microsoft criou o Credential Guard: n√£o ser√° mais poss√≠vel despejar hashes NTLM e tickets Kerberos da mem√≥ria <br><br>  4. <b>Demarca√ß√£o estrita de pap√©is</b> .  √â perigoso combinar em uma fun√ß√£o o administrador do AD, DC, todos os servidores e m√°quinas que funcionam <br><br>  5. <b>Altera√ß√£o da senha dupla krbtgt (√© a mesma conta com a qual os tickets do TGT se inscrevem)</b> .  Todo ano.  E depois que o administrador do AD sai do AD: <br><ul><li>  precisa ser alterado duas vezes, porque  a senha atual e a anterior s√£o armazenadas, </li><li>  mudar todos os anos, incl.  depois de sair do administrador do dom√≠nio.  Mesmo que a rede j√° esteja comprometida e os invasores tenham emitido o Golden Ticket, a altera√ß√£o da senha torna esse Ticket in√∫til.  E novamente eles precisam come√ßar tudo de novo. </li></ul><br>  6. <b>Rem√©dios com uma base de conhecimentos especializados continuamente atualizada</b> .  √â necess√°rio detectar ataques reais reais. </blockquote><br><h2>  Etapa 4. Captura de Dom√≠nio </h2><br><h3>  DCShadow </h3><br>  Em 24 de janeiro de 2018, na confer√™ncia Microsoft BlueHat em Israel, Benjamin Delpy e Vincent Le Toux introduziram o novo m√≥dulo mimikatz, que implementa o ataque DCShadow.  A ess√™ncia do ataque √© que um controlador de dom√≠nio falso √© criado para modificar e criar novos objetos no AD por meio da replica√ß√£o.  Os pesquisadores conseguiram isolar o conjunto m√≠nimo de SPNs Kerberos necess√°rios para passar pelo processo de replica√ß√£o - eles precisam apenas de 2. Al√©m disso, eles apresentaram uma fun√ß√£o especial que pode for√ßar a replica√ß√£o de controladores.  Os autores do ataque o posicionam como um ataque que far√° seu SIEM cego.  Porque  um controlador de dom√≠nio falso n√£o envia eventos para o SIEM, o que significa que os invasores podem fazer v√°rias coisas obscuras com o AD e o SIEM n√£o saber√° sobre isso. <br><br><img src="https://habrastorage.org/webt/op/t5/nv/opt5nvhaixi6i8da_2ixv5kivmk.png"><br><br><h4>  Padr√£o de ataque </h4><br>  No sistema com o qual o ataque √© realizado, √© necess√°rio adicionar 2 SPNs, necess√°rios para que outros controladores de dom√≠nio possam se autenticar usando o kerberos para replica√ß√£o.  Porque  de acordo com a especifica√ß√£o, o controlador de dom√≠nio √© representado no banco de dados do AD por um objeto da classe nTDSDSA; √© necess√°rio criar esse objeto.  Por fim, chame a replica√ß√£o usando a fun√ß√£o DRSReplicaAdd. <br><br><h4>  Como detectar </h4><br>  Como o DCShadow parece no tr√¢nsito.  Pelo tr√°fego, vemos claramente a adi√ß√£o de um novo objeto ao esquema de configura√ß√£o do tipo de controlador de dom√≠nio e, em seguida, o in√≠cio for√ßado da replica√ß√£o <br><br><img src="https://habrastorage.org/webt/fl/fa/xf/flfaxfzh1dwlccjntfdgcs44aui.png"><br><br>  Devido ao fato de nossa correla√ß√£o conhecer a lista de controladores de dom√≠nio leg√≠timos, ela ser√° acionada quando ocorrer a replica√ß√£o de um controlador de dom√≠nio que n√£o esteja inclu√≠do nessa lista branca.  Por conseguinte, a divis√£o de seguran√ßa da informa√ß√£o pode conduzir uma investiga√ß√£o e j√° entende que este √© um controlador de dom√≠nio leg√≠timo que foi adicionado pelo servi√ßo de TI ou pelo ataque do DCShadow. <br><br><h2>  Conclus√£o </h2><br>  O exemplo do DCShadow mostra que existem novos vetores de ataque para empresas.  Nesse oceano de eventos de seguran√ßa da informa√ß√£o, √© muito importante permanecer na crista da onda: olhar mais longe e avan√ßar rapidamente.  Todos os dias, no PT Expert Security Center, pesquisamos novas amea√ßas e desenvolvemos m√©todos e ferramentas de detec√ß√£o para elas.  E estamos prontos para compartilhar essas informa√ß√µes ainda mais. <br><br>  <b>Postado por</b> Anton Tyurin, chefe da equipe de detec√ß√£o de ataques, Positive Technologies </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt423903/">https://habr.com/ru/post/pt423903/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt423891/index.html">√Årvores de express√£o de desenvolvimento empresarial</a></li>
<li><a href="../pt423893/index.html">Hello World por receber dados de um dispositivo Bluetooth (BLE) via C #</a></li>
<li><a href="../pt423895/index.html">Voc√™ n√£o precisa de um advogado. Mas isso n√£o √© certo</a></li>
<li><a href="../pt423897/index.html">Dicas √∫teis para o uso do Assistente HyperLynx DDR para an√°lise QDR4</a></li>
<li><a href="../pt423901/index.html">Quando a velocidade e o dimensionamento s√£o necess√°rios: servidor de dispositivos iOS distribu√≠dos</a></li>
<li><a href="../pt423905/index.html">Os desenvolvedores permaneceram desconhecidos. Palestra Yandex</a></li>
<li><a href="../pt423911/index.html">Fot√¥nica de sil√≠cio trope√ßa no √∫ltimo medidor</a></li>
<li><a href="../pt423919/index.html">Como automatizar a coleta de KPI por m√™s e deixar os usu√°rios quase satisfeitos</a></li>
<li><a href="../pt423921/index.html">10 anos do Android: lembre-se de tudo</a></li>
<li><a href="../pt423923/index.html">SAP Leonardo Hackathon da velcom e SAP para desenvolvedores da Bielorr√∫ssia</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>