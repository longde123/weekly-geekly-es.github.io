<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ò∏Ô∏è üîò üë®üèΩ‚ÄçüöÄ Wie ich einen Fehler in GNU Tar gefunden habe ‚ñ∂Ô∏è üé§ üçê</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Gepostet von Chris Siebenmann , Unix-Systemadministrator an der Universit√§t von Toronto 

 Von Zeit zu Zeit passiert in meiner Arbeit etwas Seltsames,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Wie ich einen Fehler in GNU Tar gefunden habe</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/434624/"> <i><font color="gray">Gepostet von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Chris Siebenmann</a> , Unix-Systemadministrator an der Universit√§t von Toronto</font></i> <br><br>  Von Zeit zu Zeit passiert in meiner Arbeit etwas Seltsames, das mich zum Nachdenken bringt.  Auch wenn nicht sofort klar ist, welche Schlussfolgerungen folgen.  Ich habe k√ºrzlich erw√§hnt, dass wir einen Fehler in GNU Tar gefunden haben, und die Geschichte, wie dies passiert ist, ist ein solcher Fall. <br><br>  F√ºr Backup-Dateiserver verwenden wir Amanda und GNU Tar.  Im Laufe der Zeit hatten wir gelegentlich ein eher seltenes Problem, bei dem Teer beim Sichern des Dateisystems mit dem Verzeichnis <code>/var/mail</code> verr√ºckt wurde und eine gro√üe Menge an Ausgabe erzeugte.  Normalerweise ging dieser Prozess bis ins Unendliche und musste die M√ºllkippe t√∂ten;  In anderen F√§llen wurden immer noch Terabyte an Daten ausgegeben, die perfekt komprimiert zu sein schienen.  Als ich wieder auf eine so riesige TAR-Datei stie√ü, √ºberpr√ºfte ich sie - und stellte fest, dass sie teilweise aus null Bytes besteht, was das <code>tar -t</code> Testteam wirklich nicht mag. Danach kehrt alles zum Normalzustand zur√ºck. <br><br>  (Aus diesem Grund habe ich mich gefragt, ob Null-Bytes in Personen in Postf√§chern nat√ºrlich vorkommen. Es stellte sich heraus, dass das <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Auffinden von Null-Bytes in Textdateien</a> nicht so einfach ist und ja, sie sind vorhanden.) <br><a name="habracut"></a><br>  Wir haben k√ºrzlich das Dateisystem von <code>/var/mail</code> auf die neuen Linux-Dateiserver unter Ubuntu 18.04 verschoben und daher auf eine sp√§tere und standardisiertere Version von GNU Tar umgestellt als auf OmniOS-Computern.  Wir hofften, dass dies unsere Probleme l√∂sen w√ºrde, aber der gleiche Vorfall ereignete sich fast sofort.  Dieses Mal arbeitete GNU Tar auf einem Ubuntu-Computer, auf dem ich mit allen verf√ºgbaren Debugging-Tools sehr vertraut bin. Daher habe ich den laufenden <code>tar</code> Prozess √ºberpr√ºft.  Der Test zeigte, dass <code>tar</code> einen endlosen Strom von <code>read()</code> , der 0 Bytes zur√ºckgibt: <br><br><pre> <code class="plaintext hljs">read(6, "", 512) = 0 read(6, "", 512) = 0 [...] read(6, "", 512) = 0 write(1, "\0\0\0\0\0"..., 10240) = 10240 read(6, "", 512) = 0 [...]</code> </pre> <br>  <code>lsof</code> Dateideskriptor 6 ist das Postfach eines anderen. <br><br>  Mit <code>apt-get source tar</code> ich den Quellcode heruntergeladen und nach <code>read()</code> -Systemaufrufen gesucht, die nicht auf Dateivervollst√§ndigung √ºberpr√ºft haben.  Nachdem ich mehrere Ebenen der indirekten Adressierung untersucht hatte, fand ich einen offensichtlichen Ort, an dem eine solche Pr√ºfung anscheinend weggelassen wurde, n√§mlich in der Funktion <code>sparse_dump_region</code> aus der Datei <a href="">sparse.cs</a> .  Und dann erinnerte ich mich an etwas. <br><br>  Vor einigen Monaten sind <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">wir in Alpine auf ein NFS-Problem gesto√üen</a> .  W√§hrend ich an diesem Fehler arbeitete, verfolgte ich den Alpine-Prozess und stellte unter anderem fest, dass <code>ftruncate()</code> zum <code>ftruncate()</code> der Gr√∂√üe von Postf√§chern verwendet wird.  manchmal werden sie erweitert, vor√ºbergehend ein sp√§rlicher Abschnitt der Datei erstellt, bis sie gef√ºllt ist, und manchmal wird sie m√∂glicherweise komprimiert.  Dies schien mit der aktuellen Situation <code>ftruncate()</code> : Es werden sp√§rliche Bereiche verbunden, und das Reduzieren der Dateigr√∂√üe mit <code>ftruncate()</code> , dass tar unerwartet auf eine Dateivervollst√§ndigung st√∂√üt. <br><br>  (Dies erkl√§rt sogar, warum tar manchmal wiederhergestellt wird. Wenn neue E-Mails sp√§ter pl√∂tzlich in der Mailbox eintreffen, wird die erwartete Gr√∂√üe wiederhergestellt, und tar st√∂√üt nicht mehr auf eine unerwartete Beendigung der Datei.) <br><br>  Ich habe in GDB ein bisschen mit den Ubuntu-Debugging-Symbolen und dem Quellcode des Tar-Pakets herumgespielt und konnte den Fehler reproduzieren, obwohl er sich etwas von meiner urspr√ºnglichen Theorie unterschied.  Es stellte sich heraus, dass <code>sparse_dump_region</code> die sp√§rlichen Bereiche der Datei nicht zur√ºcksetzt, aber (nat√ºrlich) nicht sp√§rliche Bereiche zur√ºcksetzt und f√ºr alle Dateien (sp√§rlich oder nicht) verwendet wird, wenn Sie tar mit dem Argument <code>--sparse</code> .  Der eigentliche Fehler besteht also <b>darin, dass tar das Ende der fr√ºher empfangenen Datei nicht korrekt verarbeiten kann</b> , <b>wenn Sie GNU Tar mit dem Argument <code>--sparse</code> und die Datei beim <code>--sparse</code> komprimiert wird</b> .  Wenn die Datei erneut w√§chst, wird tar wiederhergestellt. <br><br>  (Au√üer wenn die Datei nur am Ende sp√§rlich ist und nur an dieser Stelle komprimiert wird. In diesem Fall ist alles in Ordnung). <br><br>  Ich dachte, dass ich es trotzdem vor vielen Jahren auf unseren OmniOS-Dateiservern √ºberpr√ºfen k√∂nnte.  Es gibt M√∂glichkeiten, die Systemaufrufe des Programms und <code>lsof</code> Analoga zu verfolgen, und ich k√∂nnte den Quellcode meiner Version von GNU Tar finden und anzeigen und ihn mit dem OmniOS-Debugger ausf√ºhren (obwohl GDB dort nicht installiert ist) und so weiter.  Aber ich habe es nicht getan.  Stattdessen zuckten wir die Achseln und gingen weiter.  Ich brauchte, um das Dateisystem unter Ubuntu zu verschieben, damit ich meinen Finger bewegen und das Problem herausfinden konnte. <br><br>  (Es geht nicht nur um die Tools und die Umgebung. Wir haben automatisch angenommen, dass OmniOS eine alte, nicht unterst√ºtzte Version von GNU Tar hat, deren Untersuchung keinen Sinn macht, da das Problem in der neueren Version sicherlich gel√∂st wurde.) <br><br>  PS: Wahrscheinlich verbieten wir Amanda als schnelle L√∂sung einfach, beim <code>--sparse</code> tar <code>--sparse</code> .  Postf√§cher sollten nicht sp√§rlich sein. In diesem Fall werden <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">die Dateisystemsicherungen weiterhin komprimiert</a> , sodass alle diese Null-Bytes gut komprimiert sind. <br><br>  PPS: Ich habe nicht versucht, den Fehler den GNU Tar-Entwicklern zu melden, da ich ihn erst am Freitag gefunden habe und die Universit√§t jetzt in den Winterferien ist.  F√ºhlen Sie sich frei, es vor mir zu tun. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de434624/">https://habr.com/ru/post/de434624/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de434604/index.html">Wie schreibe ich keine Vorlagen f√ºr Bootstrap?</a></li>
<li><a href="../de434616/index.html">Sowjetisches HI-FI und seine Sch√∂pfer: Digitale Tonaufnahme in der UdSSR - ein Schritt vom Sieg entfernt</a></li>
<li><a href="../de434618/index.html">MVP und Dolch 2 - Android Application Skeleton - Teil 2</a></li>
<li><a href="../de434620/index.html">Erstellen Sie einen stilvollen Wasserfall aus RiME direkt in Unity oder UE4</a></li>
<li><a href="../de434622/index.html">Welche Welten k√∂nnen nach dem Tod der Sonne √ºberleben?</a></li>
<li><a href="../de434626/index.html">Neuer Buhtrap Downloader</a></li>
<li><a href="../de434628/index.html">bitContainer (f√ºr Lebensmittel) - hausgemachte Yandex.Station</a></li>
<li><a href="../de434634/index.html">Universal Radio Hacker - Eine einfache M√∂glichkeit, digitale Funkprotokolle zu erkunden</a></li>
<li><a href="../de434636/index.html">Wie man Kinder ausbeutet</a></li>
<li><a href="../de434638/index.html">Raketenstart aus dem Osten mit eigenen Augen</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>