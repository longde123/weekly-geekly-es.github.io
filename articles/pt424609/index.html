<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üéµ üåßÔ∏è üë©‚Äçüç≥ Como estender o Kubernetes üçä ü•ï üë®üèΩ‚Äçü§ù‚Äçüë®üèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hoje falaremos sobre DevOps, ou melhor, principalmente sobre Ops. Eles dizem que h√° muito poucas pessoas satisfeitas com o n√≠vel de automa√ß√£o de suas ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como estender o Kubernetes</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/jugru/blog/424609/">  Hoje falaremos sobre DevOps, ou melhor, principalmente sobre Ops.  Eles dizem que h√° muito poucas pessoas satisfeitas com o n√≠vel de automa√ß√£o de suas opera√ß√µes.  Mas a situa√ß√£o parece ser corrig√≠vel.  Neste artigo, Nikolai Ryzhikov falar√° sobre sua experi√™ncia com a expans√£o do Kubernetes. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b1a/4f7/1a2/b1a4f71a2809a5b098e738ed4e0b5d3f.png"><br><br>  O material foi preparado com base no discurso de Nikolai na confer√™ncia de outono do DevOops 2017. Sob o corte - transcri√ß√£o em v√≠deo e texto do relat√≥rio. <br><a name="habracut"></a><br><iframe width="560" height="315" src="https://www.youtube.com/embed/3BMTNx2xCtQ" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  <i>Atualmente, Nikolai Ryzhikov est√° trabalhando no setor de Sa√∫de-TI para criar sistemas de informa√ß√£o m√©dica.</i>  <i>Membro da comunidade de programadores funcionais de S√£o Petersburgo FPROG.</i>  <i>Membro ativo da comunidade Online Clojure, membro do padr√£o de troca de informa√ß√µes m√©dicas HL7 FHIR.</i>  <i>Programa h√° 15 anos.</i> <br><hr><br>  Que lado temos para o DevOps?  Nossa f√≥rmula de DevOps √© bastante simples h√° 10 anos: os desenvolvedores s√£o respons√°veis ‚Äã‚Äãpelas opera√ß√µes, os desenvolvedores s√£o implantados, os desenvolvedores s√£o mantidos.  Com esse arranjo, que parece um pouco duro, voc√™ se tornar√° o DevOps.  Se voc√™ deseja implementar DevOps de maneira r√°pida e dolorosa - torne os desenvolvedores respons√°veis ‚Äã‚Äãpor sua produ√ß√£o.  Se os caras s√£o espertos, eles come√ßam a sair e entender tudo. <br><img src="https://habrastorage.org/getpro/habr/post_images/8f4/799/e0d/8f4799e0d6f25b897b6bd72f2ba1081a.png"><br>  Nossa hist√≥ria: h√° muito tempo, quando n√£o havia Chef e automa√ß√£o, j√° implantamos o Capistrano autom√°tico.  Ent√£o eles come√ßaram a entedi√°-lo, para que ele fizesse moda.  Mas ent√£o o Chef apareceu.  Mudamos para ele e partimos para a nuvem: est√°vamos cansados ‚Äã‚Äãde nossos data centers.  Ent√£o Ansible apareceu, Docker se levantou.  Depois disso, nos mudamos para a Terraform com o supervisor de portaria escrito √† m√£o do Condom√≠nio em Camel.  E agora estamos nos mudando para Kubernetes. <br><img src="https://habrastorage.org/getpro/habr/post_images/366/af1/be8/366af1be8b4c4cf204553b48c8a76e70.png"><br>  Qual √© a pior coisa das opera√ß√µes?  Muito poucas pessoas est√£o satisfeitas com o n√≠vel de automa√ß√£o de suas opera√ß√µes.  Isso √© assustador, confirmo: gastamos muitos recursos e esfor√ßos para coletar todas essas pilhas para n√≥s mesmos, e o resultado √© insatisfat√≥rio. <br><br>  H√° um sentimento de que, com o advento do Kubernetes, algo pode mudar.  Estou comprometido com a manufatura enxuta e, do ponto de vista dele, as opera√ß√µes geralmente n√£o s√£o √∫teis.  Opera√ß√µes ideais s√£o a aus√™ncia ou o m√≠nimo de opera√ß√µes em um projeto.  O valor √© criado quando um desenvolvedor faz um produto.  Quando est√° pronta, a entrega n√£o agrega valor.  Mas voc√™ precisa reduzir custos. <br><img src="https://habrastorage.org/getpro/habr/post_images/731/1a4/6e3/7311a46e3eb4d1d73d788f6ee881be3a.png"><br>  Para mim, o ideal sempre foi o heroku.  N√≥s o usamos para aplicativos simples, onde o desenvolvedor implementou seu servi√ßo, basta dizer git push e configurar heroku.  Demora um minuto. <br><img src="https://habrastorage.org/getpro/habr/post_images/a57/4c0/12b/a574c012ba1158086cd3578287d6d2a9.png"><br>  Como ser  Voc√™ pode comprar NoOps - tamb√©m heroku.  E eu aconselho voc√™ a comprar, caso contr√°rio, h√° uma chance de gastar mais dinheiro no desenvolvimento de opera√ß√µes normais. <br><br>  Existem caras da Deis, eles est√£o tentando fazer algo como heroku no Kubernetes.  Existe a fundi√ß√£o em nuvem, que tamb√©m fornece uma plataforma na qual trabalhar. <br><img src="https://habrastorage.org/getpro/habr/post_images/bbd/7b9/7e0/bbd7b97e07aae6af9a54663d633e3cc2.png"><br>  Mas se voc√™ se incomodar com algo mais complexo ou grande, poder√° fazer isso sozinho.  Agora, junto com o Docker e o Kubernetes, isso se torna uma tarefa que pode ser conclu√≠da em um per√≠odo de tempo razo√°vel e a um custo razo√°vel.  Costumava ser muito duro. <br><img src="https://habrastorage.org/getpro/habr/post_images/299/2d2/90a/2992d290a7167b9fe4a8cf2320528b8e.png"><br><h2>  Um pouco sobre o Docker e o Kubernetes </h2><br>  Um dos problemas das opera√ß√µes √© a repetibilidade.  A grande coisa que o docker trouxe s√£o duas fases.  Temos uma fase de constru√ß√£o. <br><br>  O segundo ponto que agrada na janela de encaixe √© uma interface universal para o lan√ßamento de servi√ßos arbitr√°rios.  Algu√©m montou o Docker, colocou algo dentro e as opera√ß√µes s√£o suficientes para dizer que o Docker √© executado e iniciado. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0b4/ca2/5ad/0b4ca25ade4ae7d3513539aaa576d3e7.png"><br><br>  O que √© o Kubernetes?  Por isso, criamos o Docker e precisamos inici√°-lo, integr√°-lo, configur√°-lo e conect√°-lo a outras pessoas em algum lugar.  O Kubernetes permite que voc√™ fa√ßa isso.  Ele introduz uma s√©rie de abstra√ß√µes, chamadas "recurso".  Iremos rapidamente examin√°-los e at√© tentar criar. <br><br><h2>  Abstra√ß√£o </h2><br>  A primeira abstra√ß√£o √© um POD ou um conjunto de cont√™ineres.  Feito corretamente, o que exatamente √© um <b>conjunto de</b> cont√™ineres, e n√£o um.  Os conjuntos podem vasculhar entre si volumes que se v√™em atrav√©s do host local.  Isso permite que voc√™ use um padr√£o como o side-car (√© quando lan√ßamos o cont√™iner principal e existem cont√™ineres auxiliares nas proximidades que o ajudam). <br><br>  Por exemplo, a abordagem do embaixador.  √â quando voc√™ n√£o deseja que o cont√™iner pense onde alguns servi√ßos est√£o localizados.  Voc√™ coloca um cont√™iner pr√≥ximo a ele que sabe onde est√£o esses servi√ßos.  E eles ficam dispon√≠veis para o cont√™iner principal no host local.  Assim, o ambiente come√ßa a parecer que voc√™ est√° trabalhando localmente. <br><img src="https://habrastorage.org/getpro/habr/post_images/0b8/ab5/bda/0b8ab5bdae5f0d0e7375ff1b08efc6ee.png"><br>  Vamos aumentar o POD e ver como ele √© descrito.  Localmente, voc√™ pode desenvolver o minikube.  Ele consome v√°rias CPUs, mas permite que voc√™ crie um pequeno cluster Kubernetes em uma caixa virtual e trabalhe com ele. <br><br>  Vamos implantar o POD.  Eu disse que o Kubernetes aplica e inundou o POD.  Posso ver quais PODs tenho: vejo que um POD est√° implantado.  Isso significa que o Kubernetes lan√ßou esses cont√™ineres. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/970/862/d90/970862d90a9afea1066caa69c1af63c8.png"></div><br>  Eu posso at√© entrar neste cont√™iner. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/122/603/8f7/1226038f78d2c9593826e7f26d611853.png"></div><br>  Nesta perspectiva, o Kubernetes √© feito para pessoas.  De fato, o que fazemos constantemente em opera√ß√µes, na liga√ß√£o do Kubernetes, por exemplo, usando o utilit√°rio kubectl, pode ser feito facilmente. <br><br>  Mas o POD √© mortal.  Come√ßa como uma execu√ß√£o no Docker: se algu√©m o interrompe, ningu√©m o levanta.  Al√©m dessa abstra√ß√£o, o Kubernetes come√ßa a criar o seguinte - por exemplo, um conjunto de r√©plicas.  Este √© um supervisor que monitora os PODs, monitora seu n√∫mero e, se os PODs ca√≠rem, ele os levanta.  Este √© um conceito importante de autocura em Kubernetes que permite que voc√™ durma em paz √† noite. <br><br>  Acima da replicaset, h√° uma abstra√ß√£o da implanta√ß√£o - tamb√©m um recurso que permite fazer a implanta√ß√£o em tempo zero.  Por exemplo, um replicaset funciona.  Quando implantamos e alteramos a vers√£o do cont√™iner, por exemplo a nossa, dentro da implanta√ß√£o, outro replicaset aumenta.  Aguardamos at√© que esses cont√™ineres sejam iniciados, passemos por suas verifica√ß√µes de integridade e depois mudamos rapidamente para o novo conjunto de replicas.  Tamb√©m cl√°ssico e boas pr√°ticas. <br><img src="https://habrastorage.org/getpro/habr/post_images/02e/d07/f33/02ed07f333733af0155ee539be18c669.png"><br>  Vamos pegar um servi√ßo simples.  Por exemplo, temos uma implanta√ß√£o.  No interior, ele descreve o padr√£o de PODs que ele buscar√°.  Podemos aplicar essa implanta√ß√£o, ver o que temos.  Funcionalidade interessante do Kubernetes - tudo est√° no banco de dados e podemos ver o que acontece no sistema. <br><br>  Aqui vemos uma implanta√ß√£o.  Se tentarmos olhar para os PODs, vemos que alguns PODs aumentaram.  Podemos pegar e remover esse POD.  O que acontece com os PODs?  Um √© destru√≠do e o segundo se eleva imediatamente.  Este controlador de replicaset n√£o encontrou o POD desejado e lan√ßou outro. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/524/7f4/0d4/5247f40d4fb21eb93bda0ce14124245e.png"></div><br>  Al√©m disso, se esse √© algum tipo de servi√ßo da Web, ou dentro de nossos servi√ßos deve se comunicar, precisamos de uma descoberta de servi√ßo.  Voc√™ deve dar ao servi√ßo um nome e um ponto de entrada.  O Kubernetes oferece um recurso chamado servi√ßo para isso.  Ele pode lidar com o balanceamento de carga e ser respons√°vel pela descoberta de servi√ßos. <br><img src="https://habrastorage.org/getpro/habr/post_images/2fa/926/6e5/2fa9266e57c6718a81241ae1ac15da8e.png"><br>  Vamos ver um servi√ßo simples.  N√≥s o conectamos √† implanta√ß√£o e aos PODs por meio de etiquetas: um link t√£o din√¢mico.  Um conceito muito importante no Kubernetes: o sistema √© din√¢mico.  N√£o importa em que ordem tudo isso ser√° criado.  O servi√ßo tentar√° encontrar PODs com essas etiquetas e iniciar seu equil√≠brio de carga. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b48/992/f7d/b48992f7dca832fce9b45276936a4914.png"></div><br>  Aplique servi√ßo, veja quais servi√ßos temos.  Entramos em nosso teste de POD, que foi criado, e fazemos a pesquisa.  O Kubernetes nos fornece um DNS-ku atrav√©s do qual os servi√ßos podem ver e descobrir um ao outro. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b05/66f/01e/b0566f01e54210ea26c5b6526b0ed0de.png"></div><br>  O servi√ßo √© mais uma interface.  Existem v√°rias implementa√ß√µes diferentes, porque as tarefas de balanceamento de carga e servi√ßo s√£o bastante complicadas: de uma maneira, trabalhamos com bancos de dados comuns, no outro com bancos de dados carregados, e alguns simples s√£o simplificados.  Este tamb√©m √© um conceito importante no Kubernetes: algumas coisas podem ser chamadas de interfaces, em vez de implementa√ß√µes.  Eles n√£o s√£o corrigidos rigidamente e diferentes, por exemplo, os provedores de nuvem oferecem implementa√ß√µes diferentes.  Ou seja, por exemplo, h√° um volume persistente de recurso, que j√° √© implementado em cada nuvem espec√≠fica por seus meios regulares. <br><br>  Em seguida, geralmente queremos disponibilizar o servi√ßo da web.  Kubernetes tem uma abstra√ß√£o de entrada.  Geralmente, o SSL √© adicionado l√°. <br><img src="https://habrastorage.org/getpro/habr/post_images/fc7/69e/4e7/fc769e4e7a526588c3f3ae32388d9c11.png"><br>  A entrada mais simples se parece com isso.  L√°, escrevemos as regras: para quais URLs, para quais hosts, para qual servi√ßo interno redirecionar a solicita√ß√£o.  Da mesma maneira, podemos aumentar nossa entrada. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/69d/79c/046/69d79c046478f1fde2a073f2fe37067f.png"></div><br>  Ap√≥s o qual, ap√≥s se registrar localmente nos hosts, voc√™ pode ver este servi√ßo a partir daqui. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/73d/752/75c/73d75275c26a468f49cd192e781595db.png"></div><br>  Essa √© uma tarefa t√£o regular: implantamos um determinado servi√ßo da web e nos encontramos um pouco com o Kubernetes. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1a3/1f8/c2f/1a31f8c2f639a4758d95719ee6dca1e0.png"></div><br>  Vamos limpar tudo, remover a entrada e analisar todos os recursos. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c75/990/40c/c7599040cd85c2c155e8acf057be0246.png"></div><br>  Existem v√°rios recursos, como configmap e secret.  Estes s√£o recursos puramente informativos que voc√™ pode montar em um cont√™iner e transferir para l√°, por exemplo, a senha do postgres.  Voc√™ pode associar isso a vari√°veis ‚Äã‚Äãde ambiente que ser√£o injetadas no cont√™iner na inicializa√ß√£o.  Voc√™ pode montar o sistema de arquivos.  Tudo √© bastante conveniente: tarefas padr√£o, solu√ß√µes agrad√°veis. <br><br>  H√° um volume persistente - uma interface que √© implementada de maneira diferente por diferentes provedores de nuvem.  Ele √© dividido em duas partes: h√° uma reivindica√ß√£o de volume persistente (solicita√ß√£o) e, em seguida, √© criado um EBS que arrasta para o cont√™iner.  Voc√™ pode trabalhar com um servi√ßo com estado. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cd6/5c1/2f7/cd65c12f71d417ffd11e3e62c76b484c.png"><br><br>  Mas como isso funciona por dentro?  O conceito em si √© muito simples e transparente.  Kubernetes tem duas partes.  Um √© apenas um banco de dados no qual temos todos esses recursos.  Os recursos podem ser considerados tablets: especificamente, essas inst√¢ncias s√£o simplesmente registros em tablets.  Al√©m do Kubernetes, um servidor de API est√° configurado.  Ou seja, quando voc√™ tem um cluster Kubernetes, geralmente se comunica com o servidor da API (mais precisamente, o cliente se comunica com ele). <br><br>  Assim, o que criamos (PODs, servi√ßos etc.) √© simplesmente gravado no banco de dados.  Este banco de dados √© implementado pelo ETCD, ou seja,  para que seja est√°vel no n√≠vel de alta disponibilidade. <br><br>  O que vem depois?  Al√©m disso, sob cada tipo de recursos, h√° um determinado controlador.  Este √© apenas um servi√ßo que monitora seu tipo de recurso e faz algo no mundo exterior.  Por exemplo, um Docker √© executado.  Se tivermos PODs, para cada N√≥ existe um servi√ßo de kubelet que monitora os PODs que est√£o conectados a esse n√≥.  E tudo o que ele faz √© o Docker executar ap√≥s a pr√≥xima verifica√ß√£o peri√≥dica se esse POD n√£o est√° l√°. <br><br>  Al√©m disso, o que √© muito importante - tudo acontece em tempo real, portanto a pot√™ncia deste controlador √© maior que o m√≠nimo.  Freq√ºentemente, o controlador ainda pega as m√©tricas e analisa o que foi iniciado.  I.e.  remove o feedback do mundo real e o grava no banco de dados, para que voc√™ ou outros controladores possam v√™-lo.  Por exemplo, o mesmo status de POD ser√° gravado de volta no ETCD. <br><br>  Assim, tudo √© implementado no Kubernetes.  √â muito legal que o modelo de informa√ß√µes seja separado da sala de opera√ß√µes.  No banco de dados atrav√©s da interface CRUD usual, declaramos o que deveria ser.  Em seguida, o conjunto de controladores tenta fazer tudo certo.  √â verdade que isso nem sempre acontece. <br><br>  Este √© um modelo cibern√©tico.  Temos uma certa predefini√ß√£o: existe algum tipo de m√°quina que est√° tentando direcionar o mundo real ou a m√°quina para o local necess√°rio.  Nem sempre √© assim: devemos ter um ciclo de feedback.  √Äs vezes, uma m√°quina n√£o pode fazer isso e deve recorrer a uma pessoa. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/59e/0a9/1e8/59e0a91e8974351a5f0f49fd94709c9a.png"><br><br>  Em sistemas reais, pensamos em abstra√ß√µes do pr√≥ximo n√≠vel: temos alguns servi√ßos, bancos de dados e todos n√≥s o conectamos.  N√£o pensamos em PODs e Ingresss e queremos criar um pr√≥ximo n√≠vel de abstra√ß√£o. <br><img src="https://habrastorage.org/getpro/habr/post_images/77f/5cb/697/77f5cb6974c6ac85e0b5e8b13921d672.png"><br>  Para que o desenvolvedor fosse o mais f√°cil poss√≠vel: para que ele simplesmente dissesse: "Quero iniciar esse e tal servi√ßo", e tudo o mais aconteceu por dentro. <br><br>  Existe algo como HELM.  Este √© o caminho errado - modelagem de estilo ansible, onde estamos apenas tentando gerar um conjunto de recursos configurados e solt√°-los em um cluster Kubernetes. <br><br>  O problema, em primeiro lugar, √© que isso √© feito apenas no momento da rolagem.  Ou seja, ele n√£o pode implementar muita l√≥gica.  Em segundo lugar, em tempo de execu√ß√£o, essa abstra√ß√£o desaparece.  Quando vou olhar para o meu cluster, vejo apenas PODs e servi√ßos.  N√£o vejo que esse e esse servi√ßo seja implantado, que tal e qual base com replica√ß√£o seja criada l√°.  Eu s√≥ vejo dezenas de lares l√°.  A abstra√ß√£o desaparece como em uma matriz. <br><img src="https://habrastorage.org/getpro/habr/post_images/696/6e6/9bd/6966e69bd8b289229194911f62a11f84.png"><br><h2>  Modelo de solu√ß√£o interna </h2><br>  Por outro lado, o pr√≥prio Kubernetes j√° fornece um modelo de extens√£o muito interessante e simples.  Podemos declarar novos tipos de recursos, por exemplo implanta√ß√£o.  Este √© um recurso criado sobre PODs ou replicaset.  Podemos escrever um controlador nesse recurso, coloc√°-lo no banco de dados e executar nosso loop cibern√©tico para que tudo funcione.  Isso parece interessante, e parece-me que este √© o caminho certo para estender o Kubernetes. <br><img src="https://habrastorage.org/getpro/habr/post_images/39e/491/c51/39e491c511ea25078eda191097d88b24.png"><br>  Gostaria de poder apenas escrever algum manifesto para o meu servi√ßo no estilo heroku.  Um exemplo muito simples: quero implantar algum tipo de aplicativo no meu ambiente real.  J√° possui contratos, SSL, dom√≠nios comprados.  Eu s√≥ gostaria de dar aos desenvolvedores a interface mais simples poss√≠vel.  O manifesto me diz qual cont√™iner levantar, quais recursos esse cont√™iner ainda precisa.  Ele lan√ßa esse an√∫ncio no cluster e tudo come√ßa a funcionar. <br><img src="https://habrastorage.org/getpro/habr/post_images/a91/24e/8a8/a9124e8a8309c952cc0a65b32f28d76f.png"><br><br>  Como isso ficar√° em termos de recursos e controladores personalizados?  Aqui teremos um aplicativo de recurso no banco de dados.  E o controlador do aplicativo gerar√° tr√™s recursos.  Ou seja, ele anotar√° as regras de entrada sobre como encaminhar para esse servi√ßo, iniciar o servi√ßo de balanceamento de carga e iniciar a implanta√ß√£o com algum tipo de configura√ß√£o. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/807/938/d22/807938d229cb312ca761214fa30829ed.png"><br><br>  Antes de criarmos um recurso personalizado no Kubernetes, precisamos declar√°-lo.  Para isso, existe um meta-recurso chamado CustomResourceDefinition. <br><br>  Para declarar um novo recurso no Kubernetes, basta publicar esse an√∫ncio.  Considere esta tabela de cria√ß√£o. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/09e/253/7d3/09e2537d3520f688c7029a357d9773dd.png"></div><br>  Criou uma tabela.  Depois disso, podemos examinar o kubectl e obter os recursos de terceiros que temos.  Assim que anunciamos, tamb√©m recebemos um banner.  Podemos fazer, por exemplo, o kubeclt obter aplicativos.  Mas at√© agora nenhum aplicativo. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d5b/c40/9ad/d5bc409ad70866a12358ccb68ba497f8.png"></div><br>  Vamos escrever um aplicativo.  Depois disso, podemos criar uma inst√¢ncia de recurso personalizado.  Vamos dar uma olhada no YAML e cri√°-lo por postagem em um URL espec√≠fico. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/044/e55/454/044e554549dc4dc00d262ecf49d8d72d.png"></div><br>  Se executarmos e examinarmos o kubectl, um aplicativo ser√° exibido.  Mas enquanto nada acontece, ele est√° apenas no banco de dados.  Voc√™ pode, por exemplo, pegar e solicitar todos os recursos do aplicativo. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/701/234/74d/70123474de1bf62ece27d49587098368.png"></div><br>  Podemos criar um segundo recurso desse tipo a partir do mesmo modelo, simplesmente alterando o nome.  Aqui est√° o segundo recurso. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/842/a58/4b0/842a584b09631555234babcbd3c7e57c.png"></div><br>  Al√©m disso, nosso controlador deve fazer modelagem, semelhante ao que o HELM faz.  Ou seja, depois de receber uma descri√ß√£o do nosso aplicativo, preciso gerar uma implanta√ß√£o de recursos e um servi√ßo de recursos, al√©m de fazer uma entrada na entrada.  Esta √© a parte mais f√°cil: aqui no clojure √© erlmacro.  Eu passo a estrutura de dados, ele puxa a fun√ß√£o de implanta√ß√£o, passa para depura√ß√£o, que √© o pipeline.  E esta √© uma fun√ß√£o pura: modelagem simples.  Dessa forma, da forma mais ing√™nua, eu poderia cri√°-lo imediatamente, transform√°-lo em um utilit√°rio de console e come√ßar a distribu√≠-lo. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b33/bf5/2cb/b33bf52cbd901d2c5e0a0641daed9161.png"></div><br>  Fazemos o mesmo pelo servi√ßo: a fun√ß√£o de servi√ßo aceita a declara√ß√£o e gera o recurso Kubernetes para n√≥s. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c2e/daf/e7f/c2edafe7f36d7c0db4573054991c436a.png"></div><br>  Fazemos o mesmo para a linha de entrada. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5d0/22f/156/5d022f15612aa3dcc19f635b0dd9b403.png"></div><br>  Como isso tudo vai funcionar?  Haver√° algo no mundo real e haver√° o que queremos.  O que queremos - pegamos o recurso do aplicativo e geramos nele o que deveria ser.  E agora precisamos ver o que √©.  O que solicitamos atrav√©s da API REST.  Podemos obter todos os servi√ßos, todas as implanta√ß√µes. <br><br>  Como nosso controlador personalizado funcionar√°?  Ele receber√° o que queremos e o que √©, tira dessa div e aplica-se ao Kubernetes.  Isso √© semelhante ao React.  Eu vim com um DOM virtual quando algumas fun√ß√µes simplesmente geram uma √°rvore de objetos JS.  E ent√£o um determinado algoritmo calcula o patch e o aplica ao DOM real. <br><br>  Faremos o mesmo aqui.  Isso √© feito em 50 linhas de c√≥digo.  Quer - tudo est√° no Github.  No final, devemos obter a fun√ß√£o reconciliar a√ß√µes. <br><br>  Temos uma fun√ß√£o de reconcilia√ß√£o de a√ß√µes que n√£o faz nada e apenas calcula essa div.  Ela pega o que √©, mais o que √© necess√°rio.  E ent√£o ele mostra o que precisa ser feito para trazer o primeiro para o segundo. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/460/49b/90d/46049b90d8fa93dfe9279c02828cfa1c.png"></div><br>  Vamos pux√°-la.  N√£o h√° nada de errado com ela, ela pode ser prejudicada.  Ela diz que voc√™ precisa criar um servi√ßo de entrada, fazer duas entradas nele, criar uma implanta√ß√£o 1 e 2, criar um servi√ßo 1 e 2. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c72/c0a/c10/c72c0ac10e4924fde59ed749339345aa.png"></div><br>  Nesse caso, j√° deve haver apenas um servi√ßo.  Vimos pela entrada que resta apenas uma entrada. <br><br>  Tudo o que resta √© escrever uma fun√ß√£o que aplique esse patch ao cluster Kubernetes.  Para fazer isso, simplesmente transmitimos a√ß√µes de reconcilia√ß√£o para a fun√ß√£o de reconcilia√ß√£o, e tudo ser√° aplicado.  E agora vemos que o POD aumentou, a implanta√ß√£o se tornou e o servi√ßo foi iniciado. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/66b/144/1a5/66b1441a56d805344c7e734d3b9b2c80.png"></div><br>  Vamos adicionar outro servi√ßo: execute a fun√ß√£o reconciliar a√ß√µes novamente.  Vamos ver o que aconteceu.  Tudo come√ßou, est√° tudo bem. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/32a/f9f/c1e/32af9fc1e444ed1c135e4bbe828a946f.png"></div><br>  Como lidar com isso?  Empacotamos tudo isso em um cont√™iner Docker.  Depois disso, escrevemos uma fun√ß√£o que acorda periodicamente, faz uma reconcilia√ß√£o e adormece.  A velocidade n√£o √© muito importante, ela pode dormir por cinco segundos e executar a√ß√µes de reconcilia√ß√£o com menos frequ√™ncia. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/bec/04e/8d1/bec04e8d1791843d80aed4f2b3f2a673.png"></div><br>  Nosso controlador personalizado √© apenas um servi√ßo que ser√° ativado e calcular√° periodicamente o patch. <br><br>  Agora temos dois servi√ßos zaddeloino, vamos excluir um dos aplicativos.  Vamos ver como nosso cluster reagiu: est√° tudo bem.  Exclu√≠mos o segundo: tudo est√° limpo. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5ff/a23/96e/5ffa2396ef22187604393a9ae657edd5.png"></div><br>  Vamos ver atrav√©s dos olhos do desenvolvedor.  Ele s√≥ precisa dizer que o Kubernetes aplica e nomeia o novo servi√ßo.  Fazemos isso, nosso controlador pegou tudo e o criou. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/bd6/ca6/3d7/bd6ca63d77dfbadee1587b6f44a680bd.png"></div><br>  Em seguida, coletamos tudo isso em um servi√ßo de implanta√ß√£o e lan√ßamos esse controlador personalizado no cluster usando as ferramentas padr√£o do Kubernetes.  Criamos uma abstra√ß√£o para 200 linhas de c√≥digo. <br><br>  Tudo parece HELM, mas na verdade mais poderoso.  O controlador trabalha em um cluster: v√™ a base, v√™ o mundo exterior e pode ser inteligente o suficiente. <br><br><h2>  IC pr√≥prio </h2><br>  Considere os exemplos de extens√£o Kubernetes.  Decidimos que o IC deveria fazer parte da infraestrutura.  Isso √© bom, √© conveniente do ponto de vista da seguran√ßa - um reposit√≥rio privado.  Tentamos usar o jenkins, mas √© uma ferramenta desatualizada.  Eu queria um CI hacker.  N√£o precisamos de interfaces, amamos o ChatOps: diga no bate-papo se a compila√ß√£o caiu ou n√£o.  Al√©m disso, eu queria depurar tudo localmente. <br><img src="https://habrastorage.org/getpro/habr/post_images/9a4/ecf/86e/9a4ecf86e022a465ce11072352456728.png"><br>  Sentamos e escrevemos nosso IC em uma semana.  Apenas como uma extens√£o para o Kubernetes.  Se voc√™ pensa em CI, essa √© apenas uma ferramenta que executa algum tipo de trabalho.  Como parte desse trabalho, criamos algo, executamos testes e frequentemente implantamos. <br><br>  Como tudo isso funciona?  Ele √© constru√≠do com o mesmo conceito de controladores personalizados.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Primeiro, deixamos no Kubernetes uma descri√ß√£o de quais reposit√≥rios estamos seguindo. </font><font style="vertical-align: inherit;">O controlador apenas acessa o github e adiciona gancho da web. </font><font style="vertical-align: inherit;">Ainda temos introspec√ß√£o. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A seguir, vem o gancho da web, cuja √∫nica tarefa √© processar o JSON recebido e solt√°-lo no recurso de compila√ß√£o personalizado, que tamb√©m √© dobrado no banco de dados Kubernetes. </font><font style="vertical-align: inherit;">O recurso de constru√ß√£o √© monitorado pelo controlador de constru√ß√£o, que l√™ o manifesto dentro do projeto e inicia o POD. </font><font style="vertical-align: inherit;">Nesse POD, todos os servi√ßos necess√°rios s√£o lan√ßados. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No POD, um agente muito simples que l√™ uma declara√ß√£o no estilo travis ou circleci, e no YAML, um conjunto de etapas. </font><font style="vertical-align: inherit;">Ele come√ßa a cumpri-los. </font><font style="vertical-align: inherit;">Ent√£o, no final da compila√ß√£o, ele lan√ßa seu resultado no telegrama.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Outro recurso que obtivemos com o Kubernetes √© que um dos comandos na execu√ß√£o de seu IC ou entrega cont√≠nua pode ser definido simplesmente enquanto o sono for verdadeiro 10, e seu POD congelar√° nesta etapa. </font><font style="vertical-align: inherit;">Voc√™ executa o kubectl exec, se encontra dentro da sua compila√ß√£o e pode estrear. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Outro recurso - tudo √© constru√≠do em janelas de encaixe e voc√™ pode depurar o script localmente, iniciando a janela de encaixe. </font><font style="vertical-align: inherit;">Tudo levou duas semanas e 300 linhas de c√≥digo.</font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/72f/334/ec3/72f334ec33db75d3b32e4c464a24dc03.png"><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Trabalhar com o postgres </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nosso produto √© constru√≠do no postgres, usamos todos os tipos de recursos interessantes. At√© escrevemos v√°rias extens√µes. Mas n√£o podemos usar o RDS ou qualquer outra coisa. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Agora estamos no processo de desenvolvimento de um operador para um postgres indestrut√≠vel. Vou soar arquitetura. Eu quero dizer: "Cluster, me d√™ um postgres que n√£o possa ser morto". Adicione a isso que eu preciso de duas r√©plicas ass√≠ncronas, uma s√≠ncrona, backups di√°rios e at√© um terabyte. Eu jogo tudo, ent√£o meu controlador de cluster come√ßa a orquestrar e expandir meu cont√™iner. Ele cria recursos de inst√¢ncia que s√£o respons√°veis ‚Äã‚Äãpor cada postgres de inst√¢ncia. Este ser√° o postgres de cluster.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Controlador pginstance adicional, bastante simples, apenas tentando executar o POD ou a implanta√ß√£o l√° com este postgres. O cora√ß√£o √© volume persistente. Toda esta m√°quina assume o controle total do postgres. Voc√™ fornece a ela um cont√™iner Docker, que possui apenas postgres bin√°rios. Tudo o resto: o pr√≥prio controlador faz a configura√ß√£o e a cria√ß√£o do cluster de in√≠cio do postgres. Ele faz isso para que possamos reconfigurar mais tarde e para que ele possa configurar a replica√ß√£o, os n√≠veis de log etc. No in√≠cio, o POD tempor√°rio √© executado sobre o volume persistente e cria um cluster postgres para o mestre l√°. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em seguida, al√©m disso, a implanta√ß√£o come√ßa com o mestre. Em seguida, um volume persistente √© criado da mesma maneira. Outro POD √© executado, faz um backup b√°sico, faz o backup e, al√©m disso, a implanta√ß√£o come√ßa com um escravo.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em seguida, o controlador de cluster cria um recurso de backup (depois de ter sido descrito com backups). E o controlador de backup j√° pega e joga em algum S3.</font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/972/b42/457/972b42457c664d988fd8eeee0aaa603c.png"><br><br><h2>  O que vem a seguir? </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vamos apresentar o futuro pr√≥ximo a voc√™. Pode acontecer que, mais cedo ou mais tarde, tenhamos recursos personalizados t√£o interessantes, controladores personalizados que direi "D√™-me o postgres, d√™-me kafka, deixe-me o IC e inicie tudo". Tudo ser√° simples. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se n√£o estamos falando sobre o futuro pr√≥ximo, eu, como programador declarativo, acho que apenas a programa√ß√£o l√≥gica ou relacional √© superior √† programa√ß√£o funcional. L√°, nossa sem√¢ntica de opera√ß√µes √© completamente separada da sem√¢ntica de informa√ß√µes. Se olharmos atentamente para nossos controladores personalizados, fizemos, por exemplo, um aplicativo de recurso em nosso banco de dados. E extra√≠mos mais tr√™s recursos adicionais. Isso √© muito semelhante √† exibi√ß√£o do banco de dados. Esta √© uma descoberta de fato. Esta √© uma vis√£o l√≥gica ou de rela√ß√£o.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O pr√≥ximo passo para o Kubernetes √© fornecer uma certa ilus√£o de uma base relacional ou l√≥gica em vez de uma API REST cortada, na qual voc√™ pode simplesmente escrever uma regra. Como, mais cedo ou mais tarde, tudo flui para o banco de dados, incluindo feedback, as regras podem parecer assim: "Se a carga aumentou assim, aumente a replica√ß√£o assim". Teremos uma pequena regra sql ou l√≥gica. Tudo que voc√™ precisa √© de um mecanismo gen√©rico que siga isso. Mas este √© um futuro brilhante.</font></font><br><img src="https://habrastorage.org/getpro/habr/post_images/fb4/f1e/930/fb4f1e930029011d081eeb911203d289.png"><br><br><blockquote>    ‚Äî   <b>DevOops 2018</b> !     ‚Äî  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a> . <br><br>        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">¬´The DevOps Handbook¬ª</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">¬´Learning Chef: A Guide to Configuration Management and Automation¬ª</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">¬´How to containerize your Go code¬ª</a>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">¬´Liquid Software: How to Achieve Trusted Continuous Updates in the DevOps World¬ª</a> ‚Äî      .         -    . <br><br>  :       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> </a> ! <br><br>    : <b> 1 </b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voc√™</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pode reservar um </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">ingresso</font></a><font style="vertical-align: inherit;"> para o DevOops 2018 com desconto.</font></font></blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt424609/">https://habr.com/ru/post/pt424609/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt424599/index.html">Voc√™ precisa escolher o software que precisa: escrito dentro do prazo ou de alta qualidade</a></li>
<li><a href="../pt424601/index.html">Arquitetura da informa√ß√£o na Internet parte 1</a></li>
<li><a href="../pt424603/index.html">O livro ‚ÄúPor que estamos errados? Armadilhas para o pensamento em a√ß√£o. ‚Äù Trechos Parte 1</a></li>
<li><a href="../pt424605/index.html">Fundos Zuckerberg: Colabora√ß√£o + Tecnologia + Ci√™ncia Aberta</a></li>
<li><a href="../pt424607/index.html">Ascens√£o de Helidon</a></li>
<li><a href="../pt424611/index.html">Como criar um funcion√°rio de um freelancer</a></li>
<li><a href="../pt424613/index.html">Experi√™ncia no uso de redux sem redutores</a></li>
<li><a href="../pt424615/index.html">Sa√≠da da fun√ß√£o curva para limitar par√¢metros, sinais e n√£o apenas no Wolfram Mathematica</a></li>
<li><a href="../pt424621/index.html">Super-her√≥is que n√£o s√£o filmes. Quem e como protege o canteiro de obras do Lakhta Center contra inc√™ndios?</a></li>
<li><a href="../pt424623/index.html">Vamos processar o som no Go</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>