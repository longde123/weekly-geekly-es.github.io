<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëÜüèº üôåüèº üë®üèæ‚Äçüíº Par ordre des d√©veloppeurs Embedded: recherche de bogues dans Amazon FreeRTOS üßóüèø üêé üêè</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Tous ceux qui programment des microcontr√¥leurs connaissent probablement FreeRTOS, ou du moins ont entendu parler de ce syst√®me d'exploitation. Les gar...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Par ordre des d√©veloppeurs Embedded: recherche de bogues dans Amazon FreeRTOS</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/473972/">  Tous ceux qui programment des microcontr√¥leurs connaissent probablement FreeRTOS, ou du moins ont entendu parler de ce syst√®me d'exploitation.  Les gars d'Amazon ont d√©cid√© d'√©tendre les capacit√©s de ce syst√®me d'exploitation pour travailler avec les services AWS Internet of Things - c'est ainsi qu'Amazon FreeRTOS est apparu.  Nous, les d√©veloppeurs de l'analyseur de code PVS-Studio, avons √©t√© invit√©s √† v√©rifier ces projets dans l'e-mail et dans les commentaires ci-dessous les articles.  Eh bien, vous avez demand√© - nous l'avons fait.  Ce qui en est ressorti - lisez la suite. <br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8d2/efa/d2f/8d2efad2f7885ec13add7368f6d2ff96.png" alt="Figure 3"></div><a name="habracut"></a><br><h2>  Un peu sur les projets </h2><br>  Pour commencer, je vais vous parler un peu du ¬´papa¬ª du projet v√©rifi√© - FreeRTOS (vous pouvez trouver le code source <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> ).  Comme le dit Wikipedia, FreeRTOS est un syst√®me d'exploitation multit√¢che en temps r√©el pour les syst√®mes embarqu√©s. <br><br>  Il a √©t√© √©crit dans le bon vieux C, ce qui n'est pas surprenant - ce syst√®me d'exploitation devrait fonctionner dans des conditions typiques des microcontr√¥leurs: faible puissance de calcul, une petite quantit√© de RAM, etc.  Le langage C vous permet de travailler avec des ressources √† un faible niveau et a des performances √©lev√©es, il est donc le mieux adapt√© pour le d√©veloppement d'un tel syst√®me d'exploitation. <br><br>  Revenons maintenant √† Amazon, qui ne reste pas immobile et se d√©veloppe dans divers domaines prometteurs.  Par exemple, Amazon d√©veloppe le moteur AAA du jeu Amazon Lumberyard, que nous avons <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">√©galement test√©</a> . <br><br>  L'un de ces domaines est l'Internet des objets (Internet des objets, IoT).  Pour se d√©velopper dans ce domaine, Amazon a d√©cid√© d'√©crire son propre syst√®me d'exploitation - et ils ont pris le noyau FreeRTOS comme base. <br><br>  Le syst√®me r√©sultant - Amazon FreeRTOS - se positionne comme ¬´offrant la possibilit√© de se connecter en toute s√©curit√© √† Amazon Web Services, comme AWS IoT Core ou AWS IoT Greengrass¬ª.  Le code source de ce projet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">est stock√©</a> sur Github. <br><br>  Dans cet article, nous examinerons s'il existe des erreurs dans FreeRTOS, ainsi que la s√©curit√© du syst√®me d'exploitation d'Amazon en termes d'analyse de code statique. <br><br><h2>  Comment √©tait le ch√®que </h2><br>  Le code a √©t√© v√©rifi√© √† l'aide d'un outil de recherche d'erreur automatique: l'analyseur de code statique PVS-Studio.  Il est capable de d√©tecter les erreurs dans les programmes √©crits en C, C ++, C # et Java. <br><br>  Avant de commencer l'analyse, vous devez assembler le projet - je serai donc s√ªr que j'ai toutes les d√©pendances n√©cessaires et que tout est en ordre avec le projet.  Il existe plusieurs fa√ßons de v√©rifier un projet - par exemple, en utilisant un syst√®me de surveillance de compilation.  J'ai effectu√© l'analyse √† l'aide du plug-in pour Visual Studio - il est bon que les r√©f√©rentiels des deux projets disposent d'un ensemble de fichiers de projet qui facilitent la cr√©ation sous Windows. <br><br>  Tout ce qu'il me fallait, c'√©tait de collecter les projets pour m'assurer qu'il y avait tout le n√©cessaire pour la v√©rification.  Ensuite, j'ai lanc√© l'analyse et le tour est jou√©!  - devant moi est un rapport d'analyseur pr√™t √† l'emploi. <br><br>  Les biblioth√®ques tierces incluses dans ces projets peuvent √©galement contenir des erreurs et, bien s√ªr, elles peuvent √©galement affecter le fonctionnement du programme.  Cependant, je les ai exclus de l'analyse dans un souci de puret√© de la narration. <br><br>  Ainsi, les projets sont analys√©s, des rapports sont re√ßus, des erreurs int√©ressantes sont √©crites.  Il est temps de passer √† leur analyse! <br><br><h2>  Ce qui cache FreeRTOS </h2><br>  Au d√©part, je m'attendais √† √©crire deux articles distincts: un pour chaque syst√®me d'exploitation.  J'ai d√©j√† frott√© mes mains, me pr√©parant √† √©crire un bon article sur FreeRTOS.  Anticipant la d√©tection d'au moins quelques erreurs juteuses (comme <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">CWE-457</a> ), j'ai regard√© avec impatience les quelques avertissements de l'analyseur, et ... et rien.  Je n'ai trouv√© aucune erreur int√©ressante. <br><br>  De nombreux avertissements √©mis par l'analyseur n'√©taient pas pertinents pour FreeRTOS.  Par exemple, ces avertissements √©taient des lacunes 64 bits comme le <i>cast</i> de <i>size_t</i> en <i>uint32_t</i> .  Cela est d√ª au fait que FreeRTOS est con√ßu pour fonctionner sur des appareils dont la taille du pointeur ne d√©passe pas 32 bits. <br><br>  J'ai soigneusement v√©rifi√© tous les avertissements <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">V1027</a> li√©s aux <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">lancements</a> entre pointeurs vers des structures ind√©pendantes.  Si les structures r√©ductibles ont le m√™me alignement, une telle fonte n'est pas une erreur.  Et je n'ai trouv√© aucun casting dangereux! <br><br>  Tous les autres endroits suspects √©taient li√©s au style de codage ou √©taient √©quip√©s d'un commentaire expliquant pourquoi cela se fait ici exactement et pourquoi ce n'est pas une erreur. <br><br>  En g√©n√©ral, je souhaite contacter les d√©veloppeurs de FreeRTOS.  Vous √™tes vraiment super!  Nous n'avons presque jamais rencontr√© de projets aussi propres et de haute qualit√© que le v√¥tre.  Et j'ai √©t√© tr√®s heureux de lire du code propre, bien rang√© et bien document√©.  Chapeau √† toi. <br><br>  Bien que je n'aie pas trouv√© d'erreurs int√©ressantes ce jour-l√†, j'ai compris que je ne m'arr√™terais pas l√†.  Je rentrais chez moi avec la ferme conviction que quelque chose d'int√©ressant se trouverait dans la version d'Amazon √† 100%, et que demain je collecterais certainement suffisamment d'erreurs pour l'article.  Comme vous l'avez probablement devin√©, j'avais raison. <br><br><h2>  Ce qui cache Amazon FreeRTOS </h2><br>  La version d'Amazon du syst√®me s'est av√©r√©e √™tre ... pour le dire l√©g√®rement, un peu pire.  L'h√©ritage de FreeRTOS est rest√© tout aussi propre, mais les nouvelles r√©visions se sont av√©r√©es assez int√©ressantes. <br><br>  Dans certains endroits, la logique du programme a √©t√© viol√©e, quelque part mal travaill√©e avec des pointeurs.  √Ä certains endroits, le code pouvait conduire √† un comportement ind√©fini, mais quelque part le programmeur ne savait tout simplement pas le motif d'erreur qu'il avait fait.  J'ai m√™me trouv√© de s√©rieuses vuln√©rabilit√©s potentielles. <br><br>  Quelque chose que j'ai retard√© avec l'introduction.  Commen√ßons √† analyser les bogues! <br><br><h3>  Violation de la logique du programme </h3><br>  Commen√ßons par les zones √† probl√®mes, qui indiquent clairement que le programme ne fonctionne pas exactement comme le programmeur s'y attendait.  Le premier de ces endroits sera un travail suspect avec un tableau: <br><br><pre><code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/** * @brief Pool of request and associated response buffers, * handles, and configurations. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> _requestPool_t _requestPool = { <span class="hljs-number"><span class="hljs-number">0</span></span> }; .... <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _scheduleAsyncRequest(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> reqIndex, <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> currentRange) { .... <span class="hljs-comment"><span class="hljs-comment">/* Set the user private data to use in the asynchronous callback context. */</span></span> _requestPool.pRequestDatas[reqIndex].pConnHandle = &amp;_connHandle; _requestPool.pRequestDatas[reqIndex].pConnConfig = &amp;_connConfig; _requestPool.pRequestDatas[reqIndex].reqNum = reqIndex; _requestPool.pRequestDatas[reqIndex].currRange = currentRange; _requestPool.pRequestDatas[reqIndex].currDownloaded = <span class="hljs-number"><span class="hljs-number">0</span></span>; _requestPool.pRequestDatas[reqIndex].numReqBytes = numReqBytes; .... _requestPool.pRequestDatas-&gt;scheduled = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; .... }</code> </pre> <br>  PVS-Studio a √©mis deux avertissements pour ce morceau de code: <br><br><ul><li>  V619 Le tableau '_requestPool.pRequestDatas' est utilis√© comme pointeur vers un seul objet.  iot_demo_https_s3_download_async.c 973 </li><li>  V574 Le pointeur '_requestPool.pRequestDatas' est utilis√© simultan√©ment comme tableau et comme pointeur vers un seul objet.  V√©rifiez les lignes: 931, 973. iot_demo_https_s3_download_async.c 973 </li></ul><br>  Au cas o√π, laissez-moi vous rappeler: le nom du tableau est un pointeur sur son premier √©l√©ment.  Autrement dit, si <i>_requestPool.pRequestDatas</i> est un tableau de structures, alors <i>_requestPool.pRequestDatas [i] .scheduled</i> est l'acc√®s au membre <i>planifi√©</i> de la <i>i-</i> √®me structure du tableau.  Et si vous √©crivez <i>_requestPool.pRequestDatas-&gt; planifi√©</i> , cela signifie l'acc√®s au membre <i>planifi√©</i> de la premi√®re structure du tableau. <br><br>  C'est ce qui se passe dans l'extrait de code ci-dessus.  La derni√®re ligne modifie toujours la valeur uniquement pour un membre de la premi√®re structure du tableau.  En soi, cet appel est d√©j√† suspect, mais la situation ici est encore plus √©vidente: dans tout le corps de la fonction, le tableau <i>_requestPool.pRequestDatas est</i> accessible par index, et ce n'est qu'√† la fin de l'op√©ration d'indexation que l'on a oubli√© d'appliquer. <br><br>  Si je comprends bien, la derni√®re ligne devrait ressembler √† ceci: <br><br><pre> <code class="cpp hljs">_requestPool.pRequestDatas[reqIndex].scheduled = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;</code> </pre> <br>  L'erreur suivante r√©side dans une petite fonction, je vais donc la donner dans son int√©gralit√©: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* Return true if the string " pcString" is found * inside the token pxTok in JSON file pcJson. */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> BaseType_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prvGGDJsoneq</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * pcJson, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">jsmntok_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pxTok, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * pcString )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> ulStringSize = ( <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> ) pxTok-&gt;end - ( <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> ) pxTok-&gt;start; BaseType_t xStatus = pdFALSE; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( pxTok-&gt;type == JSMN_STRING ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( ( <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> ) <span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>( pcString ) == ulStringSize ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( ( <span class="hljs-keyword"><span class="hljs-keyword">int16_t</span></span> ) <span class="hljs-built_in"><span class="hljs-built_in">strncmp</span></span>( &amp;pcJson[ pxTok-&gt;start ], <span class="hljs-comment"><span class="hljs-comment">// &lt;= pcString, ulStringSize ) == 0 ) { xStatus = pdTRUE; } } } return xStatus; }</span></span></code> </pre> <br>  <b>Avertissement PVS-Studio:</b> V642 [CWE-197] L'enregistrement du r√©sultat de la fonction 'strncmp' dans la variable de type 'short' est inappropri√©.  Les bits significatifs pourraient √™tre perdus en brisant la logique du programme.  aws_greengrass_discovery.c 637 <br><br>  Jetons un coup d'≈ìil √† la d√©finition de la fonction strncmp: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">strncmp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *lhs, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *rhs, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> count )</span></span></span></span>;</code> </pre> <br>  Dans l'exemple, un r√©sultat de type <i>int</i> , dont la taille est de 32 bits, est converti en une variable de type <i>int16_t</i> .  Avec une telle conversion de "r√©tr√©cissement", les bits les plus significatifs de la valeur de retour seront perdus.  Par exemple, si la fonction <i>strncmp</i> renvoie <i>0x00010000</i> , celle- <i>ci</i> sera <i>perdue</i> lors de la conversion et la condition sera satisfaite. <br><br>  En fait, il est √©trange de voir un tel casting dans un √©tat.  Pourquoi m√™me le faire si vous pouvez comparer un <i>int</i> normal √† z√©ro?  D'un autre c√¥t√©, si le programmeur voulait consciemment que la fonction retourne <i>vrai</i> , m√™me si ce n'est pas le cas, alors pourquoi ce comportement d√©licat n'est-il pas d√©crit par le commentaire?  Mais c'est d√©j√† un signet.  En g√©n√©ral, je suis port√© √† croire que c'est une erreur.  Que pensez-vous? <br><br><h3>  Comportement et pointeurs ind√©finis </h3><br>  Maintenant, il y aura un exemple assez important.  Il masque le d√©r√©f√©rencement potentiel d'un pointeur nul: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> _networkReceiveCallback(....) { IotHttpsReturnCode_t status = IOT_HTTPS_OK; _httpsResponse_t* pCurrentHttpsResponse = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; IotLink_t* pQItem = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; .... <span class="hljs-comment"><span class="hljs-comment">/* Get the response from the response queue. */</span></span> IotMutex_Lock(&amp;(pHttpsConnection-&gt;connectionMutex)); pQItem = IotDeQueue_PeekHead(&amp;(pHttpsConnection-&gt;respQ)); IotMutex_Unlock(&amp;(pHttpsConnection-&gt;connectionMutex)); <span class="hljs-comment"><span class="hljs-comment">/* If the receive callback is invoked * and there is no response expected, * then this a violation of the HTTP/1.1 protocol. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pQItem == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { IotLogError(....); fatalDisconnect = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; status = IOT_HTTPS_NETWORK_ERROR; <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> iotCleanup; } .... iotCleanup : <span class="hljs-comment"><span class="hljs-comment">/* Report errors back to the application. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (status != IOT_HTTPS_OK) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( pCurrentHttpsResponse-&gt;isAsync &amp;&amp; pCurrentHttpsResponse-&gt;pCallbacks-&gt;errorCallback) { pCurrentHttpsResponse-&gt;pCallbacks-&gt;errorCallback(....); } pCurrentHttpsResponse-&gt;syncStatus = status; } .... }</code> </pre> <br>  <b>Avertissement PVS-Studio:</b> V522 [CWE-690] Il peut y avoir un d√©r√©f√©rencement d'un pointeur nul potentiel 'pCurrentHttpsResponse'.  iot_https_client.c 1184 <br><br>  Les d√©r√©f√©rences de probl√®me sont tout en bas <i>si</i> .  Voyons ce qui se passe ici. <br><br>  Au d√©but de la fonction, les <i>variables</i> <i>pCurrentHttpsResponse</i> et <i>pQItem sont</i> initialis√©es √† <i>NULL</i> et la variable d' <i>√©tat</i> est <i>initialis√©e</i> √† <i>IOT_HTTPS_OK</i> , ce qui signifie que tout se passe bien. <br><br>  Ensuite, <i>pQItem</i> re√ßoit la valeur renvoy√©e par la fonction <i>IotDeQueue_PeekHead</i> , qui renvoie un pointeur sur le d√©but d'une file d'attente doublement connect√©e. <br><br>  Que se passe-t-il si la file d'attente est vide?  Dans ce cas, la fonction <i>IotDeQueue_PeekHead</i> retournera <i>NULL</i> : <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> IotLink_t* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IotDeQueue_PeekHead</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> IotDeQueue_t* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pQueue)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> IotListDouble_PeekHead(pQueue); } .... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> IotLink_t* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IotListDouble_PeekHead</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> IotListDouble_t* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pList)</span></span></span><span class="hljs-function"> </span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment">/* @[declare_linear_containers_list_double_peekhead] */</span></span></span><span class="hljs-function"> </span></span>{ IotLink_t* pHead = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pList != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (IotListDouble_IsEmpty(pList) == <span class="hljs-literal"><span class="hljs-literal">false</span></span>) { pHead = pList-&gt;pNext; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pHead; }</code> </pre> <br>  Ensuite, la condition <i>pQItem == NULL est</i> satisfaite et le flux de contr√¥le <i>passe</i> par <i>goto</i> √† la partie inf√©rieure du corps de la fonction.  √Ä ce moment, le pointeur <i>pCurrentHttpsResponse</i> restera nul et le <i>statut</i> ne <i>sera</i> plus √©gal √† <i>IOT_HTTPS_OK</i> .  En cons√©quence, nous tomberons dans cette m√™me branche <i>si</i> , et ... larges!  Vous connaissez vous-m√™me les cons√©quences de ce d√©r√©f√©rencement. <br><br>  Ok  C'√©tait un exemple l√©g√®rement orn√©.  J'attire maintenant votre attention sur un d√©r√©f√©rencement potentiel tr√®s simple et compr√©hensible: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PKI_mbedTLSSignatureToPkcs11Signature</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * pxSignaturePKCS, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * pxMbedSignature )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> xReturn = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> * pxNextLength; <span class="hljs-comment"><span class="hljs-comment">/* The 4th byte contains the length of the R component */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> ucSigComponentLength = pxMbedSignature[ <span class="hljs-number"><span class="hljs-number">3</span></span> ]; <span class="hljs-comment"><span class="hljs-comment">// &lt;= if( ( pxSignaturePKCS == NULL ) || ( pxMbedSignature == NULL ) ) { xReturn = FAILURE; } .... }</span></span></code> </pre> <br>  <b>Avertissement PVS-Studio:</b> V595 [CWE-476] Le pointeur 'pxMbedSignature' a √©t√© utilis√© avant d'√™tre v√©rifi√© par rapport √† nullptr.  V√©rifiez les lignes: 52, 54. iot_pki_utils.c 52 <br><br>  Cette fonction obtient deux pointeurs vers <i>uint8_t</i> .  Les deux pointeurs sont v√©rifi√©s pour <i>NULL</i> , ce qui est une bonne pratique - de telles situations doivent √™tre r√©solues imm√©diatement. <br><br>  Mais voici la malchance: au moment o√π <i>pxMbedSignature</i> est v√©rifi√©, il sera d√©j√† d√©r√©f√©renc√© litt√©ralement une ligne au-dessus.  Ta-daa! <br><br>  Un autre exemple de code sp√©culatif: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">CK_RV </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">vAppendSHA256AlgorithmIdentifierSequence</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * x32ByteHashedMessage, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * x51ByteHashOidBuffer )</span></span></span><span class="hljs-function"> </span></span>{ CK_RV xResult = CKR_OK; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> xOidSequence[] = pkcs11STUFF_APPENDED_TO_RSA_SIG; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( ( x32ByteHashedMessage == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ) || ( x51ByteHashOidBuffer == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ) ) { xResult = CKR_ARGUMENTS_BAD; } <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>( x51ByteHashOidBuffer, xOidSequence, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>( xOidSequence ) ); <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>( &amp;x51ByteHashOidBuffer[ <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>( xOidSequence ) ], x32ByteHashedMessage, <span class="hljs-number"><span class="hljs-number">32</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> xResult; }</code> </pre> <br>  <b>Avertissements de PVS-Studio:</b> <br><br><ul><li>  V1004 [CWE-628] Le pointeur 'x51ByteHashOidBuffer' a √©t√© utilis√© de mani√®re non s√©curis√©e apr√®s avoir √©t√© v√©rifi√© par rapport √† nullptr.  V√©rifiez les lignes: 275, 280. iot_pkcs11.c 280 </li><li>  V1004 [CWE-628] Le pointeur 'x32ByteHashedMessage' a √©t√© utilis√© de mani√®re non s√©curis√©e apr√®s avoir √©t√© v√©rifi√© par rapport √† nullptr.  V√©rifiez les lignes: 275, 281. iot_pkcs11.c 281 </li></ul><br>  L'analyseur avertit que les param√®tres de fonction qui sont des pointeurs sont utilis√©s de mani√®re non s√©curis√©e apr√®s avoir √©t√© test√©s pour <i>NULL</i> .  En effet, les arguments sont v√©rifi√©s, mais si l'un d'eux s'av√®re √™tre <i>NULL</i> , aucune action n'est entreprise, sauf pour √©crire dans <i>xResult</i> .  Ce morceau de code semble dire: ¬´Oui, cela signifie que les arguments se sont av√©r√©s mauvais.  Nous allons l'√©crire maintenant, pendant que vous continuez, continuez. " <br><br>  <i>Conclusion</i> : <i>NULL</i> sera transmis √† <i>memcpy</i> .  Que peut-il en r√©sulter?  O√π les valeurs seront-elles copi√©es et lesquelles?  En fait, deviner cela ne vaut pas la peine, car  la norme <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">indique clairement</a> qu'un tel appel conduit √† un comportement ind√©fini (voir paragraphe 1). <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/cf7/7d6/856/cf77d6856666f6a1529a1744832bd5bf.png" alt="Figure 2"></div><br><br>  Le rapport de l'analyseur contient toujours des exemples de fonctionnement incorrect avec des pointeurs que j'ai trouv√©s dans Amazon FreeRTOS, mais je pense que les exemples donn√©s sont d√©j√† suffisants pour vous montrer les capacit√©s de PVS-Studio √† d√©tecter de telles erreurs.  Consid√©rez quelque chose de nouveau. <br><br><h3>  VRAI! = 1 </h3><br>  Plusieurs erreurs que j'ai trouv√©es √©taient li√©es √† un mod√®le, qui, malheureusement, est souvent oubli√©. <br><br>  Le fait est que le type <i>bool</i> (de C ++) est diff√©rent du type <i>BOOL</i> (habituellement utilis√© en C).  Le premier ne peut contenir que <i>vrai</i> ou <i>faux</i> .  Le second est un typedef d'un type entier ( <i>int</i> , <i>long</i> , etc.).  Pour lui, ¬´faux¬ª est la valeur <i>0</i> et ¬´vrai¬ª est toute valeur autre que z√©ro. <br><br>  Puisqu'il n'y a pas de type bool√©en int√©gr√© en C, ces constantes sont d√©finies par commodit√©: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> FALSE 0 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> TRUE 1</span></span></code> </pre> <br>  Prenons maintenant un exemple: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mbedtls_hardware_poll</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">* data, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* output, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> len, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* olen)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> lStatus = MBEDTLS_ERR_ENTROPY_SOURCE_FAILED; HCRYPTPROV hProv = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* Unferenced parameter. */</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)data; <span class="hljs-comment"><span class="hljs-comment">/* * This is port-specific for the Windows simulator, * so just use Crypto API. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (TRUE == CryptAcquireContextA( &amp;hProv, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, PROV_RSA_FULL, CRYPT_VERIFYCONTEXT)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (TRUE == CryptGenRandom(hProv, len, output)) { lStatus = <span class="hljs-number"><span class="hljs-number">0</span></span>; *olen = len; } CryptReleaseContext(hProv, <span class="hljs-number"><span class="hljs-number">0</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> lStatus; }</code> </pre> <br>  <b>Avertissements de PVS-Studio:</b> <br><br><ul><li>  V676 [CWE-253] Il est incorrect de comparer la variable de type BOOL avec TRUE.  aws_entropy_hardware_poll.c 48 </li><li>  V676 [CWE-253] Il est incorrect de comparer la variable de type BOOL avec TRUE.  L'expression correcte est: ¬´FAUX! = CryptGenRandom (hProv, len, output)¬ª.  aws_entropy_hardware_poll.c 51 </li></ul><br>  Vous avez trouv√© une erreur?  Et c'est :) Fonctions <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><i>CryptAcquireContextA</i></a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><i>CryptGenRandom</i></a> sont des fonctions standard de l'en <i>-</i> t√™te <i>wincrypt.h</i> .  En cas de succ√®s, ils renvoient une valeur diff√©rente de z√©ro.  J'insiste - <i>non nul</i> .  Donc, th√©oriquement, cela peut √™tre n'importe quelle valeur autre que z√©ro: <i>1</i> , <i>314</i> , <i>42</i> , <i>420</i> . <br><br>  Apparemment, le programmeur qui a √©crit la fonction de l'exemple n'y a pas pens√©, et par cons√©quent, les valeurs obtenues sont compar√©es √† l'unit√©. <br><br>  Avec quelle probabilit√© la condition <i>VRAI == CryptGenRandom (....)</i> n'est-elle pas remplie?  C'est difficile √† dire.  Peut-√™tre que <i>CryptGenRandom</i> renvoie une unit√© plus souvent que les autres valeurs, et peut-√™tre qu'il n'en renvoie toujours qu'une seule.  Nous ne pouvons pas le savoir avec certitude: l'impl√©mentation de cette fonction cryptographique est cach√©e aux yeux des programmeurs mortels :) <br><br>  Il est important de se rappeler que de telles comparaisons sont potentiellement dangereuses.  Et au lieu de: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (TRUE == GetBOOL())</code> </pre> <br>  utilisez une option plus s√ªre: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (FALSE != GetBOOL())</code> </pre> <br><h3>  Probl√®mes d'optimisation </h3><br>  Plusieurs avertissements de l'analyseur ont √©t√© associ√©s √† des constructions √† ex√©cution lente.  Par exemple: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _IotHttpsDemo_GetS3ObjectFileSize(....) { .... pFileSizeStr = <span class="hljs-built_in"><span class="hljs-built_in">strstr</span></span>(contentRangeValStr, <span class="hljs-string"><span class="hljs-string">"/"</span></span>); .... }</code> </pre> <br>  <b>Avertissement PVS-Studio:</b> V817 Il est plus efficace de rechercher un caract√®re '/' plut√¥t qu'une cha√Æne.  iot_demo_https_common.c 205 <br><br>  Bri√®vement et clairement, n'est-ce pas?  La fonction <i>strstr</i> ici est utilis√©e pour rechercher un seul caract√®re, qui est pass√© au param√®tre sous forme de cha√Æne (il est plac√© entre guillemets). <br><br>  Cet endroit peut √™tre potentiellement optimis√© en rempla√ßant <i>strstr</i> par <i>strchr</i> : <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _IotHttpsDemo_GetS3ObjectFileSize(....) { .... pFileSizeStr = <span class="hljs-built_in"><span class="hljs-built_in">strchr</span></span>(contentRangeValStr, <span class="hljs-string"><span class="hljs-string">'/'</span></span>); .... }</code> </pre> <br>  Ensuite, la recherche fonctionnera un peu plus rapidement.  Un peu, mais sympa. <br><br>  De telles optimisations sont, bien s√ªr, bonnes, et l'analyseur a trouv√© un autre endroit qui peut √™tre optimis√© beaucoup plus sensiblement: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">vRunOTAUpdateDemo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (; ; ) { .... xConnectInfo.cleanSession = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; xConnectInfo.clientIdentifierLength = (<span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span>)<span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>(clientcredentialIOT_THING_NAME); xConnectInfo.pClientIdentifier = clientcredentialIOT_THING_NAME; .... } }</code> </pre> <br>  <b>Avertissement PVS-Studio:</b> V814 Baisse des performances.  La fonction 'strlen' a √©t√© appel√©e plusieurs fois √† l'int√©rieur du corps d'une boucle.  aws_iot_ota_update_demo.c 235 <br><br>  Hmmm ... A l'int√©rieur de la boucle, √† chaque it√©ration, <i>strlen</i> est appel√©, qui calcule √† chaque fois la longueur de la m√™me ligne.  Pas l'op√©ration la plus efficace :) <br><br>  Jetons un coup d'≈ìil √† la d√©finition de <i>clientcredentialIOT_THING_NAME</i> : <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* * @brief Host name. * * @todo Set this to the unique name of your IoT Thing. */</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> clientcredentialIOT_THING_NAME </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">""</span></span></span></span></code> </pre> <br>  L'utilisateur est invit√© √† saisir ici le nom de son appareil.  Par d√©faut, il est vide, et dans ce cas, tout va bien.  Mais que se passe-t-il si l'utilisateur veut y entrer un nom long et beau?  Par exemple, j'aimerais appeler mon id√©e originale " <i>La machine √† caf√© passionn√©e et sophistiqu√©e BarBarista-N061E The Ultimate Edition</i> ".  Pouvez-vous imaginer quelle serait ma surprise si apr√®s cela ma belle machine √† caf√© commen√ßait √† fonctionner un peu plus lentement?  Mess! <br><br>  Pour corriger l'erreur, <i>strlen</i> doit √™tre retir√© du corps de la boucle.  Apr√®s tout, le nom de l'appareil ne change pas pendant l'ex√©cution du programme.  Ehhh, ici serait <i>constexpr</i> de C ++ ... <br><br>  D'accord, d'accord, j'avoue: ici j'√©tais un peu √©paissi.  Comme mon coll√®gue Andrei Karpov l'a not√©, les compilateurs modernes savent ce qu'est un <i>strlen</i> et il a personnellement observ√© comment ils utilisent simplement une constante en code binaire, s'ils comprennent que la longueur de la cha√Æne ne peut pas changer.  Il y a donc une forte probabilit√© que dans le mode de construction de la version finale, au lieu du calcul r√©el de la longueur de la cha√Æne, une valeur pr√©c√©demment calcul√©e sera simplement utilis√©e.  Cependant, cela ne fonctionne pas toujours, donc l'√©criture d'un tel code n'est pas une bonne pratique. <br><br><h2>  Quelques mots sur MISRA </h2><br>  L'analyseur PVS-Studio dispose d'un large ensemble de r√®gles qui vous permettent de v√©rifier la conformit√© de votre code avec les normes MISRA C et MISRA C ++.  Quelles sont ces normes? <br><br>  MISRA est la norme de codage pour les syst√®mes embarqu√©s hautement r√©actifs.  Il contient un ensemble de r√®gles et de directives strictes pour l'√©criture de code et la configuration du processus de d√©veloppement.  Il existe un certain nombre de ces r√®gles, qui visent non seulement √† √©liminer les erreurs graves, mais aussi √† diverses "odeurs de code", ainsi qu'√† √©crire le code maximum clair et lisible. <br><br>  Ainsi, suivre la norme MISRA permet non seulement d'√©viter les erreurs et les vuln√©rabilit√©s, mais aussi de mani√®re significative - significative!  - r√©duire la probabilit√© de leur occurrence dans un code existant. <br><br>  MISRA est utilis√© dans les industries a√©rospatiale, m√©dicale, automobile et militaire - o√π la vie humaine d√©pend de la qualit√© du logiciel embarqu√©. <br><br>  Apparemment, les d√©veloppeurs d'Amazon FreeRTOS connaissent cette norme et la suivent pour la plupart.  C'est vrai: si vous √©crivez un syst√®me d'exploitation large pour les syst√®mes embarqu√©s, vous devez penser √† la s√©curit√©. <br><br>  Cependant, j'ai trouv√© pas mal de violations de la norme MISRA.  Je ne donnerai pas ici d'exemples de r√®gles comme ¬´ne pas utiliser l'union¬ª ou ¬´une fonction ne devrait avoir qu'un seul retour √† la fin du corps¬ª - malheureusement, elles ne sont pas spectaculaires, comme la plupart des r√®gles MISRA.  Je ferais mieux de vous donner des exemples de violations qui pourraient potentiellement entra√Æner des cons√©quences graves. <br><br>  Commen√ßons par les macros: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> FreeRTOS_ms_to_tick(ms) ( ( ms * configTICK_RATE_HZ + 500 ) / 1000 )</span></span></code> </pre> <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SOCKETS_htonl( ulIn ) ( ( uint32_t ) \ ( ( ( ulIn &amp; 0xFF ) </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;&lt; 24 ) | ( ( ulIn &amp; 0xFF00 ) &lt;&lt; 8 ) \ | ( ( ulIn &amp; 0xFF0000 ) &gt;&gt; 8 ) | ( ( ulIn &amp; 0xFF000000 ) &gt;&gt; 24 ) ) )</span></span></span></span></code> </pre> <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LEFT_ROTATE( x, c ) ( ( x </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;&lt; c ) | ( x &gt;&gt; ( 32 - c ) ) )</span></span></span></span></code> </pre> <br>  <b>Avertissements de PVS-Studio:</b> <br><br><ul><li>  V2546 [MISRA C 20.7] La ‚Äã‚Äãmacro et ses param√®tres doivent √™tre plac√©s entre parenth√®ses.  Pensez √† inspecter le param√®tre ¬´ms¬ª de la macro ¬´FreeRTOS_ms_to_tick¬ª.  FreeRTOS_IP.h 201 </li><li>  V2546 [MISRA C 20.7] La ‚Äã‚Äãmacro et ses param√®tres doivent √™tre plac√©s entre parenth√®ses.  Pensez √† inspecter le param√®tre 'ulIn' de la macro 'SOCKETS_htonl'.  iot_secure_sockets.h 512 </li><li>  V2546 [MISRA C 20.7] La ‚Äã‚Äãmacro et ses param√®tres doivent √™tre plac√©s entre parenth√®ses.  Pensez √† inspecter les param√®tres ¬´x¬ª, ¬´c¬ª de la macro ¬´LEFT_ROTATE¬ª.  iot_device_metrics.c 90 </li></ul><br>  Oui, c'est exactement ce que tu pensais.  Les param√®tres de ces macros ne sont pas plac√©s entre crochets.  Si quelqu'un √©crit accidentellement quelque chose comme <br><br><pre> <code class="cpp hljs">val = LEFT_ROTATE(A[i] | <span class="hljs-number"><span class="hljs-number">1</span></span>, B);</code> </pre> <br>  alors une telle macro ¬´appel¬ª s'ouvrira dans: <br><br><pre> <code class="cpp hljs">val = ( ( A[i] | <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; B ) | ( A[i] | <span class="hljs-number"><span class="hljs-number">1</span></span> &gt;&gt; ( <span class="hljs-number"><span class="hljs-number">32</span></span> - B ) ) );</code> </pre> <br>  Rappelez-vous les priorit√©s des op√©rations?  Tout d'abord, un d√©calage au niveau du bit est effectu√©, et seulement apr√®s, il s'agit d'un ¬´ou¬ª au niveau du bit.  Par cons√©quent, la logique du programme sera viol√©e.  Un exemple plus simple: que se passe-t-il si l'expression " <i>x + y</i> " est pass√©e √† la macro <i>FreeRTOS_ms_to_tick</i> ?  L'un des principaux objectifs de MISRA est de pr√©venir la survenue de telles situations. <br><br>  Quelqu'un peut objecter: "si vous avez des programmeurs qui ne connaissent pas cela, alors aucune norme ne vous sauvera!" Et je ne serai pas d'accord avec cela.  Les programmeurs sont aussi des personnes, et quelle que soit l'exp√©rience d'une personne, elle aussi peut se fatiguer et faire une erreur √† la fin de la journ√©e de travail.  C'est l'une des raisons pour lesquelles MISRA recommande fortement l'utilisation d'outils d'analyse automatis√©s pour valider la conformit√© d'un projet avec la norme. <br><br>  Je me tourne vers les d√©veloppeurs d'Amazon FreeRTOS: PVS-Studio a trouv√© 12 macros plus dangereuses, vous √™tes donc plus prudent avec elles :) <br><br>  Une autre violation int√©ressante de la MISRA: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/** * @brief Callback for an asynchronous request to notify * that the response is complete. * * @param[in] 0pPrivData - User private data configured * with the HTTPS Client library request configuration. * @param[in] respHandle - Identifier for the current response finished. * @param[in] rc - Return code from the HTTPS Client Library * signaling a possible error. * @param[in] status - The HTTP response status. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> _responseCompleteCallback(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>* pPrivData, IotHttpsResponseHandle_t respHandle, IotHttpsReturnCode_t rc, <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> status) { <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>* pUploadSuccess = (<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>*)pPrivData; <span class="hljs-comment"><span class="hljs-comment">/* When the remote server response with 200 OK, the file was successfully uploaded. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (status == IOT_HTTPS_STATUS_OK) { *pUploadSuccess = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { *pUploadSuccess = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/* Post to the semaphore that the upload is finished. */</span></span> IotSemaphore_Post(&amp;(_uploadFinishedSem)); }</code> </pre> <br>  Pouvez-vous trouver l'erreur vous-m√™me? <br><br>  <b>Avertissement PVS-Studio:</b> V2537 [MISRA C 2.7] Les fonctions ne doivent pas avoir de param√®tres inutilis√©s.  Pensez √† inspecter le param√®tre: ¬´rc¬ª.  iot_demo_https_s3_upload_async.c 234 <br><br>  Regardez de plus pr√®s: le param√®tre <i>rc</i> n'est utilis√© nulle part dans le corps de la fonction.  De plus, dans le commentaire de la fonction, il est explicitement √©crit que ce param√®tre est le code retour d'une autre fonction, et qu'il peut signaler une erreur.  Alors pourquoi ce param√®tre n'est-il trait√© d'aucune fa√ßon?  Il y a clairement quelque chose qui cloche ici. <br><br>  Cependant, m√™me sans ces commentaires, les param√®tres inutilis√©s indiquent souvent une logique de programme cass√©e.  Sinon, pourquoi sont-ils n√©cessaires dans la signature de fonction? <br><br>  Ici, j'ai donn√© une petite fonction qui convient bien √† un exemple dans l'article.  En plus d'elle, j'ai trouv√© 10 autres param√®tres inutilis√©s.  Beaucoup d'entre eux sont utilis√©s dans des fonctions plus importantes, et les trouver n'est pas la chose la plus simple. <br><br>  Il est suspect qu'ils n'aient pas √©t√© retrouv√©s auparavant.  En effet, les compilateurs peuvent facilement d√©tecter de tels cas. <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b80/6c7/bb9/b806c7bb94c335ce2712e9b46cffc560.png" alt="Figure 1"></div><br><br><h2>  Conclusion </h2><br>  Ce n'√©taient pas tous les probl√®mes rencontr√©s par l'analyseur, mais l'article √©tait d√©j√† assez volumineux.  J'esp√®re que gr√¢ce √† cela, les d√©veloppeurs d'Amazon FreeRTOS pourront corriger certaines lacunes, et voudront peut-√™tre m√™me <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">essayer PVS-Studio par</a> eux-m√™mes.  De cette fa√ßon, il sera possible d'√©tudier les avertissements de mani√®re plus approfondie, et en effet, travailler avec une interface pratique est beaucoup plus facile que de regarder un rapport texte. <br><br>  Merci d'avoir lu nos articles!  Rendez-vous dans le prochain num√©ro: D <br><br>  PS Il se trouve que cet article a √©t√© publi√© le 31 octobre.  Par cons√©quent, je souhaite √† tous un joyeux Halloween! <br><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/getpro/habr/post_images/c78/30f/70c/c7830f70c5577c3d6704f254d7cad6a3.png" align="left"></a> </p><br><br>  Si vous souhaitez partager cet article avec un public anglophone, veuillez utiliser le lien vers la traduction: George Gribkov.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">√Ä la demande des d√©veloppeurs int√©gr√©s: d√©tection des erreurs dans Amazon FreeRTOS</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr473972/">https://habr.com/ru/post/fr473972/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr473956/index.html">Informations secr√®tes d'une compagnie de t√©l√©phone de trafiquants de drogue</a></li>
<li><a href="../fr473958/index.html">Le japonais de NICT a pr√©sent√© un cluster de fibres de travail avec une bande passante de 1 Pbit / s</a></li>
<li><a href="../fr473960/index.html">Strat√©gies de localisation de contenu</a></li>
<li><a href="../fr473962/index.html">Le mode sombre est maintenant partout. Est-ce si utile? (√† la fin de l'enqu√™te post√©rieure)</a></li>
<li><a href="../fr473966/index.html">√Ä la demande des d√©veloppeurs int√©gr√©s: d√©tection des erreurs dans Amazon FreeRTOS</a></li>
<li><a href="../fr473974/index.html">Intercom'19 - une conf√©rence sur l'automatisation des communications de Voximplant aura lieu le 14 novembre</a></li>
<li><a href="../fr473976/index.html">AWS Elasticsearch: produit fondamentalement d√©fectueux</a></li>
<li><a href="../fr473978/index.html">Une telle douleur, une telle douleur, une caisse enregistreuse 2: 0</a></li>
<li><a href="../fr473980/index.html">La technologie et le monde r√©el: 4 start-ups qui changent l'avenir du design d'int√©rieur</a></li>
<li><a href="../fr473982/index.html">NB-IoT: comment √ßa marche? Partie 3: SCEF - une fen√™tre d'acc√®s unique aux services de l'op√©rateur</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>