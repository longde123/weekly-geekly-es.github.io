<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèª‚Äçüîß üí± üë∏üèæ Analyse des validations et des demandes d'extraction dans Travis CI, Buddy et AppVeyor √† l'aide de PVS-Studio ü•î üéπ ü§≥üèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="√Ä partir de la version 7.04, l'analyseur PVS-Studio pour les langages C et C ++ sous Linux et macOS fournit la fonction de test de v√©rification de la ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Analyse des validations et des demandes d'extraction dans Travis CI, Buddy et AppVeyor √† l'aide de PVS-Studio</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/470982/"><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ac4/d08/0e7/ac4d080e7661626569ef514abe190662.png" alt="Image 11"></div><br>  √Ä partir de la version 7.04, l'analyseur PVS-Studio pour les langages C et C ++ sous Linux et macOS fournit la fonction de test de v√©rification de la liste des fichiers sp√©cifi√©s.  En utilisant le nouveau mode, vous pouvez configurer l'analyseur pour v√©rifier les validations et les demandes d'extraction.  Cet article couvre la configuration de la v√©rification de certains fichiers modifi√©s √† partir d'un projet GitHub dans des syst√®mes CI (int√©gration continue) populaires, tels que Travis CI, Buddy et AppVeyor. <br><a name="habracut"></a><br><h2>  Mode de v√©rification de la liste des fichiers </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PVS-Studio</a> est un outil con√ßu pour d√©tecter les erreurs et les vuln√©rabilit√©s potentielles dans le code source des programmes, √©crit en C, C ++, C # et Java.  Fonctionne dans les syst√®mes 64 bits sur Windows, Linux et macOS. <br><br>  Dans la version PVS-Studio 7.04 pour Linux et macOS, il existe d√©sormais le mode de v√©rification de la liste des fichiers.  Il fonctionne pour les projets, dont le syst√®me de construction permet de g√©n√©rer le fichier <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">compile_commands.json</a> .  Il est n√©cessaire pour que l'analyseur obtienne des informations sur la compilation de certains fichiers.  Si votre syst√®me de g√©n√©ration ne prend pas en charge la g√©n√©ration du fichier compile_commands.json, vous pouvez essayer de g√©n√©rer ce fichier √† l'aide de l'utilitaire <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Bear</a> . <br><br>  Ce mode de v√©rification de la liste des fichiers peut √©galement √™tre utilis√© avec le journal de suivi d'ex√©cution du compilateur g√©n√©r√© par strace (trace pvs-studio-analyzer).  Pour ce faire, vous devez d'abord terminer une g√©n√©ration de projet compl√®te et la suivre afin que l'analyseur collecte des informations compl√®tes sur les param√®tres de compilation de tous les fichiers v√©rifi√©s. <br><br>  Cependant, cette option pr√©sente un inconv√©nient important - vous devrez soit effectuer un suivi complet de la construction de l'ensemble du projet √† chaque ex√©cution, ce qui va √† l'encontre de l'id√©e d'une v√©rification de validation rapide.  Ou si vous mettez en cache le r√©sultat du suivi lui-m√™me, les ex√©cutions d'analyseurs suivantes peuvent √™tre incompl√®tes si, apr√®s le suivi, la structure des fichiers sources change (par exemple, un nouveau #include est ajout√© dans l'un des fichiers source). <br><br>  Par cons√©quent, nous ne recommandons pas d'utiliser le mode de v√©rification de la liste des fichiers avec un journal de suivi pour v√©rifier les validations ou les demandes d'extraction.  Si vous pouvez effectuer une g√©n√©ration incr√©mentielle lors de la v√©rification d'une validation, envisagez d'utiliser le mode d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">analyse incr√©mentielle</a> . <br><br>  La liste des fichiers source pour l'analyse est enregistr√©e dans le fichier texte et transmise √† l'analyseur √† l'aide du param√®tre <i>-S</i> : <br><br><pre><code class="bash hljs">pvs-studio-analyzer analyze ... -f build/compile_commands.json -S check-list.txt</code> </pre> <br>  Ce fichier contient des chemins relatifs et absolus vers des fichiers o√π chaque nouveau fichier arrive sur une nouvelle ligne.  Vous pouvez sp√©cifier les deux noms de fichier pour l'analyse et un texte diff√©rent.  Quant au texte, l'analyseur remarquera qu'il ne s'agit pas d'un nom de fichier et ignorera la ligne.  Il peut √™tre utile de commenter si les fichiers sont sp√©cifi√©s manuellement.  Cependant, la liste des fichiers est souvent g√©n√©r√©e lors de l'analyse CI, par exemple, il peut s'agir de fichiers provenant d'une validation ou d'une demande d'extraction. <br><br>  Maintenant, en utilisant ce mode, vous pouvez rapidement v√©rifier le nouveau code avant qu'il n'entre dans la branche principale de d√©veloppement.  L' <i>indicateur --indicate-warnings</i> a √©t√© ajout√© dans l' <i>utilitaire de conversion de plog</i> afin que le syst√®me de v√©rification r√©ponde √† la pr√©sence d'avertissements de l'analyseur. <br><br><pre> <code class="bash hljs">plog-converter ... --indicate-warnings ... -o /path/to/report.tasks ...</code> </pre> <br>  Avec cet indicateur, le convertisseur retournera un code diff√©rent de z√©ro s'il y a des avertissements dans le rapport de l'analyseur.  Vous pouvez bloquer le crochet de pr√©-validation, la demande de validation ou d'extraction et afficher le rapport g√©n√©r√© de l'analyseur, le partager ou l'envoyer par courrier. <br><br>  <i>Remarque</i>  <i>Lors de la premi√®re analyse de la liste des fichiers, l'ensemble du projet sera v√©rifi√©, car l'analyseur doit g√©n√©rer le fichier avec les d√©pendances des fichiers source du projet √† partir des fichiers d'en-t√™te.</i>  <i>Il s'agit d'une particularit√© de l'analyse des fichiers C et C ++.</i>  <i>√Ä l'avenir, ce fichier de d√©pendance peut √™tre mis en cache et sera automatiquement mis √† jour par l'analyseur.</i>  <i>L'avantage de la v√©rification des validations en utilisant le mode de v√©rification de la liste des fichiers par rapport au mode d'analyse incr√©mentielle est le fait que vous ne devez mettre en cache que ce fichier, pas les fichiers objets.</i> <br><br><h2>  Principes g√©n√©raux de l'analyse des demandes de tirage </h2><br>  L'analyse compl√®te du projet prend beaucoup de temps, il est donc logique de n'en v√©rifier qu'une partie.  Le probl√®me est que vous devez s√©parer les nouveaux fichiers du reste des fichiers du projet. <br><br>  Regardons l'exemple d'un arbre de validation √† deux branches: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/722/646/68c/72264668c4a90b96ccb63f363a46c683.png" alt="Image 5"></div><br><br>  Imaginez que la validation <i>A1</i> contienne une quantit√© de code assez importante qui a d√©j√† √©t√© v√©rifi√©e.  Auparavant, nous avons cr√©√© une branche √† partir de la validation <i>A1</i> et modifi√© certains fichiers. <br><br>  Bien s√ªr, vous avez remarqu√© qu'apr√®s <i>A1</i> , deux autres validations ont eu lieu et deux autres branches ont fusionn√©, car nous ne validons pas en <i>master</i> .  Voici le moment o√π le <i>correctif</i> est pr√™t.  C'est pourquoi nous avons re√ßu une demande d'extraction pour la fusion <i>B3</i> et <i>A3</i> . <br><br>  Nous pourrions v√©rifier le r√©sultat de leur fusion, mais ce serait trop long et d√©raisonnable, car seuls quelques fichiers ont √©t√© modifi√©s.  Par cons√©quent, il est plus efficace d'analyser uniquement les modifications. <br><br>  Pour ce faire, nous recevrons la diff√©rence entre les branches, √©tant en t√™te de la branche, √† partir de laquelle nous voulons fusionner dans le ma√Ætre: <br><br><pre> <code class="bash hljs">git diff --name-only HEAD origin/<span class="hljs-variable"><span class="hljs-variable">$MERGE_BASE</span></span> &gt; .pvs-pr.list</code> </pre> <br>  Nous consid√©rerons <i>$ MERGE_BASE</i> en d√©tail plus tard.  Le fait est que tous les services CI ne fournissent pas les informations n√©cessaires sur la base de fusion, donc √† chaque fois nous devons penser √† de nouvelles fa√ßons d'obtenir ces donn√©es.  Ceci sera consid√©r√© dans les d√©tails ci-dessous pour chacun des services Web d√©crits. <br><br>  Nous avons donc obtenu la diff√©rence entre les branches, qui est la liste des noms de fichiers modifi√©s.  Maintenant, nous devons <i>envoyer</i> ce fichier <i>.pvs-pr.list</i> √† l'analyseur.  Nous y avons redirig√© la sortie plus t√¥t. <br><br><pre> <code class="bash hljs">pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ -S .pvs-pr.list</code> </pre> <br>  Apr√®s l'analyse, nous devons convertir le fichier journal (PVS-Studio.log) dans un format convivial: <br><br><pre> <code class="bash hljs">plog-converter -t errorfile PVS-Studio.log --cerr -w</code> </pre> <br>  Cette commande affichera la liste des erreurs dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">stderr</a> (flux d'erreurs standard). <br><br>  Le probl√®me est que nous devons non seulement g√©n√©rer les erreurs, mais √©galement signaler notre service de g√©n√©ration et de test des probl√®mes.  Pour ce faire, l' <i>indicateur</i> <i>-W</i> ( <i>--indicate-warnings</i> ) a √©t√© ajout√© dans le convertisseur.  S'il y a au moins un avertissement de l'analyseur, le code de retour de l' <i>utilitaire de conversion de plog</i> passera √† 2, qui √† son tour signalera le service CI sur les erreurs potentielles dans les fichiers de demande d'extraction. <br><br><h2>  Travis ci </h2><br>  La configuration se fait sous la forme du fichier <i>.travis.yml</i> .  Pour plus de commodit√©, je vous conseille d'isoler toutes les commandes li√©es √† PVS-Studio dans un script bash s√©par√© avec des fonctions qui seront appel√©es √† partir du fichier <i>.travis.yml</i> ( <i>bash script_name.sh function_name</i> ). <br><br>  En d√©veloppant le script, vous obtiendrez plus de fonctionnalit√©s.  Dans la section d' <i>installation</i> , √©crivez ce qui suit: <br><br><pre> <code class="xml hljs">install: - bash .travis.sh travis_install</code> </pre> <br>  Si vous aviez des instructions, vous pouvez les d√©placer dans le script, apr√®s avoir supprim√© les tirets. <br><br>  Ouvrez le fichier <i>.travis.sh</i> et ajoutez l'installation de l'analyseur dans la fonction <i>travis_install ()</i> : <br><br><pre> <code class="bash hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">travis_install</span></span></span></span>() { wget -q -O - https://files.viva64.com/etc/pubkey.txt \ | sudo apt-key add - sudo wget -O /etc/apt/sources.list.d/viva64.list \ https://files.viva64.com/etc/viva64.list sudo apt-get update -qq sudo apt-get install -qq pvs-studio }</code> </pre> <br>  Ajoutons maintenant l'analyse ex√©cut√©e dans la section <i>script</i> : <br><br><pre> <code class="xml hljs">script: - bash .travis.sh travis_script</code> </pre> <br>  Et dans le script bash: <br><br><pre> <code class="bash hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">travis_script</span></span></span></span>() { pvs-studio-analyzer credentials <span class="hljs-variable"><span class="hljs-variable">$PVS_USERNAME</span></span> <span class="hljs-variable"><span class="hljs-variable">$PVS_KEY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$TRAVIS_PULL_REQUEST</span></span></span><span class="hljs-string">"</span></span> != <span class="hljs-string"><span class="hljs-string">"false"</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> git diff --name-only origin/HEAD &gt; .pvs-pr.list pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ -S .pvs-pr.list \ --disableLicenseExpirationCheck <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> plog-converter -t errorfile PVS-Studio.log --cerr -w }</code> </pre> <br>  Vous devez ex√©cuter ce code apr√®s la construction du projet, par exemple, si vous aviez une build sur CMake: <br><br><pre> <code class="bash hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">travis_script</span></span></span></span>() { CMAKE_ARGS=<span class="hljs-string"><span class="hljs-string">"-DCMAKE_EXPORT_COMPILE_COMMANDS=On </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${CMAKE_ARGS}</span></span></span><span class="hljs-string">"</span></span> cmake <span class="hljs-variable"><span class="hljs-variable">$CMAKE_ARGS</span></span> CMakeLists.txt make -j8 }</code> </pre> <br>  Vous obtiendrez les √©l√©ments suivants: <br><br><pre> <code class="bash hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">travis_script</span></span></span></span>() { CMAKE_ARGS=<span class="hljs-string"><span class="hljs-string">"-DCMAKE_EXPORT_COMPILE_COMMANDS=On </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${CMAKE_ARGS}</span></span></span><span class="hljs-string">"</span></span> cmake <span class="hljs-variable"><span class="hljs-variable">$CMAKE_ARGS</span></span> CMakeLists.txt make -j8 pvs-studio-analyzer credentials <span class="hljs-variable"><span class="hljs-variable">$PVS_USERNAME</span></span> <span class="hljs-variable"><span class="hljs-variable">$PVS_KEY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$TRAVIS_PULL_REQUEST</span></span></span><span class="hljs-string">"</span></span> != <span class="hljs-string"><span class="hljs-string">"false"</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> git diff --name-only origin/HEAD &gt; .pvs-pr.list pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ -S .pvs-pr.list \ --disableLicenseExpirationCheck <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> plog-converter -t errorfile PVS-Studio.log --cerr -w }</code> </pre> <br>  Vous avez probablement d√©j√† remarqu√© les variables d'environnement <i>$ TRAVIS_PULL_REQUEST</i> et <i>$ TRAVIS_BRANCH</i> .  Travis CI les d√©clare lui-m√™me: <br><br><ul><li>  <i>$ TRAVIS_PULL_REQUEST</i> stocke le num√©ro de demande d'extraction ou <i>false</i> s'il s'agit d'une branche r√©guli√®re; </li><li>  <i>$ TRAVIS_REPO_SLUG</i> stocke le nom du r√©f√©rentiel de projet. </li></ul><br>  Voici l'algorithme op√©rationnel de cette fonction: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ebe/643/58b/ebe64358b6f4cc73db5d4b0094919faa.png" alt="Image 13"></div><br>  Travis CI r√©pond aux codes de retour, donc la pr√©sence d'avertissements signalera le service pour marquer la validation comme contenant des erreurs. <br><br>  Examinons maintenant de plus pr√®s cette ligne de code: <br><pre> <code class="bash hljs">git diff --name-only origin/HEAD &gt; .pvs-pr.list</code> </pre> <br>  Le fait est que Travis CI fusionne automatiquement les branches lors de l'analyse d'une demande de pull: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/443/986/1f4/4439861f46637d41119e83f83e2e440b.png" alt="Image 8"></div><br>  C'est pourquoi nous analysons <i>A4</i> , pas <i>B3-&gt; A3</i> .  En raison de cette particularit√©, nous devons √©valuer la diff√©rence avec <i>A3</i> , qui est le chef de la branche d' <i>origine</i> . <br><br>  Un d√©tail important demeure - la mise en cache des d√©pendances des fichiers d'en-t√™te des unit√©s de traduction compil√©es (* .c, * .cc, * .cpp et autres).  L'analyseur √©value ces d√©pendances lors de la premi√®re ex√©cution en mode de v√©rification de la liste des fichiers puis les stocke dans le r√©pertoire .PVS-Studio.  Travis CI permet la mise en cache des r√©f√©rentiels, nous allons donc enregistrer les donn√©es dans le <i>r√©pertoire .PVS-Studio /</i> : <br><br><pre> <code class="xml hljs">cache: directories: - .PVS-Studio/</code> </pre> <br>  Ce code doit √™tre ajout√© dans le fichier <i>.travis.yml</i> : ce r√©pertoire stocke diverses donn√©es, collect√©es apr√®s l'analyse.  Ces donn√©es acc√©l√®rent consid√©rablement les ex√©cutions suivantes de l'analyse de la liste des fichiers ou de l'analyse incr√©mentielle.  Si vous ne le faites pas, l'analyseur analysera tous les fichiers √† chaque fois. <br><br><h2>  Copain </h2><br>  Comme Travis CI, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Buddy</a> vous permet de cr√©er et de tester automatiquement des projets √† partir de GitHub.  Contrairement √† Travis CI, il est configur√© dans l'interface Web (le support bash est disponible), il n'est donc pas n√©cessaire de stocker les fichiers de configuration dans le projet. <br><br>  Tout d'abord, nous devons ajouter une nouvelle √©tape au pipeline: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/75e/2fd/36e/75e2fd36e9a4420ff74256429ff73e0c.gif" alt="Image 1"></div><br>  Pr√©cisons le compilateur utilis√© pour construire le projet.  Faites attention au conteneur docker, install√© lors de cette √©tape.  Par exemple, il existe un conteneur sp√©cial pour GCC: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/95b/837/7ad/95b8377adbac7e50e55d97c5b318f56c.png" alt="Image 6"></div><br>  Maintenant, installons PVS-Studio et les utilitaires n√©cessaires: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/88e/fba/02b/88efba02b5a4c34f55c4344744812cc7.gif" alt="Image 2"></div><br>  Ajoutez les lignes suivantes √† l'√©diteur: <br><br><pre> <code class="bash hljs">apt-get update &amp;&amp; apt-get -y install wget gnupg jq wget -q -O - https://files.viva64.com/etc/pubkey.txt | apt-key add - wget -O /etc/apt/sources.list.d/viva64.list \ https://files.viva64.com/etc/viva64.list apt-get update &amp;&amp; apt-get -y install pvs-studio</code> </pre> <br>  Passons √† l'onglet Ex√©cuter (premi√®re ic√¥ne) et ajoutons le code suivant au champ de l'√©diteur appropri√©: <br><pre> <code class="bash hljs">pvs-studio-analyzer credentials <span class="hljs-variable"><span class="hljs-variable">$PVS_USERNAME</span></span> <span class="hljs-variable"><span class="hljs-variable">$PVS_KEY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$BUDDY_EXECUTION_PULL_REQUEST_NO</span></span></span><span class="hljs-string">"</span></span> != <span class="hljs-string"><span class="hljs-string">''</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> PULL_REQUEST_ID=<span class="hljs-string"><span class="hljs-string">"pulls/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$BUDDY_EXECUTION_PULL_REQUEST_NO</span></span></span><span class="hljs-string">"</span></span> MERGE_BASE=`wget -qO - \ https://api.github.com/repos/<span class="hljs-variable"><span class="hljs-variable">${BUDDY_REPO_SLUG}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${PULL_REQUEST_ID}</span></span> \ | jq -r <span class="hljs-string"><span class="hljs-string">".base.ref"</span></span>` git diff --name-only HEAD origin/<span class="hljs-variable"><span class="hljs-variable">$MERGE_BASE</span></span> &gt; .pvs-pr.list pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck \ -S .pvs-pr.list <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> plog-converter -t errorfile PVS-Studio.log --cerr -w</code> </pre> <br>  Si vous lisez la section sur Travs-CI, ce code vous est familier.  Mais ici, il y a une nouvelle √©tape: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a7a/c65/3e3/a7ac653e3e89c4fc2a2b425b1ccefec8.png" alt="Image 14"></div><br>  Le fait est que maintenant nous analysons non pas le r√©sultat de la fusion, mais le HEAD de la branche avec la demande d'extraction v√©rifi√©e: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/722/646/68c/72264668c4a90b96ccb63f363a46c683.png" alt="Image 10"></div><br>  Nous sommes donc dans un commit <i>B3</i> et nous devons faire la diff√©rence avec <i>A3</i> : <br><br><pre> <code class="bash hljs">PULL_REQUEST_ID=<span class="hljs-string"><span class="hljs-string">"pulls/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$BUDDY_EXECUTION_PULL_REQUEST_NO</span></span></span><span class="hljs-string">"</span></span> MERGE_BASE=`wget -qO - \ https://api.github.com/repos/<span class="hljs-variable"><span class="hljs-variable">${BUDDY_REPO_SLUG}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${PULL_REQUEST_ID}</span></span> \ | jq -r <span class="hljs-string"><span class="hljs-string">".base.ref"</span></span>` git diff --name-only HEAD origin/<span class="hljs-variable"><span class="hljs-variable">$MERGE_BASE</span></span> &gt; .pvs-pr.list</code> </pre> <br>  Pour d√©finir <i>A3</i> , utilisons l'API GitHub: <br><br><pre> <code class="bash hljs">https://api.github.com/repos/<span class="hljs-variable"><span class="hljs-variable">${USERNAME}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${REPO}</span></span>/pulls/<span class="hljs-variable"><span class="hljs-variable">${PULL_REQUEST_ID}</span></span></code> </pre> <br>  Nous avons utilis√© les variables suivantes, que Buddy nous fournit: <br><br><ul><li>  <i>$ BUDDY_EXECUTION_PULL_REQEUST_NO</i> - num√©ro d'une demande d'extraction; </li><li>  <i>$ BUDDY_REPO_SLUG</i> - combinaison d'un nom d'utilisateur et d'un r√©f√©rentiel (par exemple, max / test). </li></ul><br>  Maintenant, enregistrons les modifications, en utilisant le bouton ci-dessous et activons l'analyse des demandes d'extraction: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/74c/5d6/876/74c5d6876c07c0b2e0c10cdabb8b0f78.gif" alt="Image 3"></div><br>  Contrairement √† Travis CI, nous n'avons pas besoin de sp√©cifier <i>.pvs-studio</i> pour la mise en cache, car Buddy met automatiquement en cache tous les fichiers pour les ex√©cutions suivantes.  Il ne reste donc plus qu'√† enregistrer le login et le mot de passe de PVS-Studio dans Buddy.  Apr√®s avoir enregistr√© les modifications, nous reviendrons dans le Pipeline.  Nous devons passer √† la configuration des variables et ins√©rer le login et la cl√© pour PVS-Studio: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/eb1/816/e3e/eb1816e3e4aff72ad55b187ec1ebf0a2.gif" alt="Image 4"></div><br>  Apr√®s cela, une v√©rification commencera √† chaque nouvelle demande d'extraction ou validation.  Si un commit contient des erreurs, Buddy le signalera sur la page de demande de pull. <br><br><h2>  Appveyor </h2><br>  Le param√®tre AppVeyor est Buddy similaire, car tout se passe dans l'interface Web et il n'est pas n√©cessaire d'ajouter le fichier * .yml dans le r√©f√©rentiel du projet. <br><br>  Passons √† l'onglet Param√®tres dans la revue de projet: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f11/2fc/576/f112fc576fc1f8bf7552625578093292.png" alt="Image 12"></div><br>  Faites d√©filer cette page vers le bas et activez l'enregistrement du cache pour la g√©n√©ration de demande de tirage: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/be8/8f3/f34/be88f3f34708075a49bdd13c65f5bc26.png" alt="Image 18"></div><br><br>  Passons maintenant √† l'onglet Environnement, o√π nous allons sp√©cifier l'image pour la construction et les variables d'environnement n√©cessaires: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/453/26a/80c/45326a80c62211c6b29bd16fad1ef0d1.png" alt="Image 19"></div><br>  Si vous avez lu les sections pr√©c√©dentes, vous connaissez d√©j√† ces deux variables - <i>PVS_KEY</i> et <i>PVS_USERNAME</i> .  Sinon, permettez-moi de vous rappeler qu'ils sont n√©cessaires pour v√©rifier la licence de l'analyseur PVS-Studio.  √Ä l'avenir, nous les retrouverons dans des scripts Bash. <br><br>  Sur la m√™me page en bas, sp√©cifions le dossier cache: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4e2/967/dbf/4e2967dbfb796e2d0104d5b6539be65a.png" alt="Image 15"></div><br>  Si nous ne le faisons pas, nous analyserons l'ensemble du projet au lieu de quelques fichiers, mais nous recevrons la sortie pour les fichiers sp√©cifi√©s.  Il est donc important de saisir le nom correct du r√©f√©rentiel. <br><br>  Le moment est venu pour le script de v√©rification.  Ouvrez l'onglet Tests et choisissez Script: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b5f/dbd/0d6/b5fdbd0d6d448174bc05222fe1965c1c.png" alt="Image 20"></div><br>  Le code suivant doit √™tre ins√©r√© dans ce formulaire: <br><br><pre> <code class="bash hljs">sudo apt-get update &amp;&amp; sudo apt-get -y install jq wget -q -O - https://files.viva64.com/etc/pubkey.txt \ | sudo apt-key add - sudo wget -O /etc/apt/sources.list.d/viva64.list \ https://files.viva64.com/etc/viva64.list sudo apt-get update &amp;&amp; sudo apt-get -y install pvs-studio pvs-studio-analyzer credentials <span class="hljs-variable"><span class="hljs-variable">$PVS_USERNAME</span></span> <span class="hljs-variable"><span class="hljs-variable">$PVS_KEY</span></span> PWD=$(<span class="hljs-built_in"><span class="hljs-built_in">pwd</span></span> -L) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$APPVEYOR_PULL_REQUEST_NUMBER</span></span></span><span class="hljs-string">"</span></span> != <span class="hljs-string"><span class="hljs-string">''</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> PULL_REQUEST_ID=<span class="hljs-string"><span class="hljs-string">"pulls/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$APPVEYOR_PULL_REQUEST_NUMBER</span></span></span><span class="hljs-string">"</span></span> MERGE_BASE=`wget -qO - \ https://api.github.com/repos/<span class="hljs-variable"><span class="hljs-variable">${APPVEYOR_REPO_NAME}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${PULL_REQUEST_ID}</span></span> \ | jq -r <span class="hljs-string"><span class="hljs-string">".base.ref"</span></span>` git diff --name-only HEAD origin/<span class="hljs-variable"><span class="hljs-variable">$MERGE_BASE</span></span> &gt; .pvs-pr.list pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck \ --dump-files --dump-log pvs-dump.log \ -S .pvs-pr.list <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> plog-converter -t errorfile PVS-Studio.log --cerr -w</code> </pre> <br>  Prenons attention √† la partie suivante du code: <br><br><pre> <code class="bash hljs">PWD=$(<span class="hljs-built_in"><span class="hljs-built_in">pwd</span></span> -L) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$APPVEYOR_PULL_REQUEST_NUMBER</span></span></span><span class="hljs-string">"</span></span> != <span class="hljs-string"><span class="hljs-string">''</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> PULL_REQUEST_ID=<span class="hljs-string"><span class="hljs-string">"pulls/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$APPVEYOR_PULL_REQUEST_NUMBER</span></span></span><span class="hljs-string">"</span></span> MERGE_BASE=`wget -qO - \ https://api.github.com/repos/<span class="hljs-variable"><span class="hljs-variable">${APPVEYOR_REPO_NAME}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${PULL_REQUEST_ID}</span></span> \ | jq -r <span class="hljs-string"><span class="hljs-string">".base.ref"</span></span>` git diff --name-only HEAD origin/<span class="hljs-variable"><span class="hljs-variable">$MERGE_BASE</span></span> &gt; .pvs-pr.list pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck \ --dump-files --dump-log pvs-dump.log \ -S .pvs-pr.list <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span></code> </pre> <br>  C'est une affectation assez sp√©cifique de la valeur de sortie de la commande pwd √† la variable, qui doit stocker cette valeur par d√©faut.  Au d√©but, cela semble √©trange, mais permettez-moi de tout expliquer. <br><br>  Lors de la configuration de l'analyseur dans AppVeyor, je suis tomb√© sur un comportement d'analyseur tr√®s √©trange.  D'une part, tout fonctionnait correctement, mais l'analyse n'a pas commenc√©.  Il a fallu beaucoup de temps pour remarquer que nous √©tions dans le r√©pertoire / home / appveyor / projects / testcalc /, alors que l'analyseur √©tait s√ªr que nous √©tions dans / opt / appveyor / build-agent /.  A ce moment, j'ai r√©alis√© que la variable $ PWD est trompeuse.  Pour cette raison, j'ai renouvel√© manuellement sa valeur avant d'ex√©cuter l'analyse. <br><br>  L'ordre des actions √©tait le m√™me que pr√©c√©demment: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a99/1be/5b1/a991be5b13dd4e17ccb9cb47e4f48cf2.png" alt="Image 16"></div><br>  Jetez maintenant un ≈ìil √† ce fragment: <br><br><pre> <code class="bash hljs">PULL_REQUEST_ID=<span class="hljs-string"><span class="hljs-string">"pulls/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$APPVEYOR_PULL_REQUEST_NUMBER</span></span></span><span class="hljs-string">"</span></span> MERGE_BASE=`wget -qO - \ https://api.github.com/repos/<span class="hljs-variable"><span class="hljs-variable">${APPVEYOR_REPO_NAME}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${PULL_REQUEST_ID}</span></span> \ | jq -r <span class="hljs-string"><span class="hljs-string">".base.ref"</span></span>`</code> </pre> <br>  Dans ce document, nous obtenons la diff√©rence entre les branches, li√©e √† la demande d'extraction v√©rifi√©e.  Pour ce faire, nous avons besoin des variables d'environnement suivantes: <br><br><ul><li>  $ APPVEYOR_PULL_REQUEST_NUMBER - num√©ro de demande d'extraction; </li><li>  $ APPVEYOR_REPO_NAME - nom d'utilisateur et r√©f√©rentiel de projet. </li></ul><br><h2>  Conclusion </h2><br>  Eh bien, nous n'avons pas envisag√© tous les services d'int√©gration continue possibles, mais ils ont tous des caract√©ristiques op√©rationnelles similaires.  Mais quant √† la mise en cache, chaque service r√©invente sa propre roue, donc c'est toujours diff√©rent. <br><br>  Dans certains cas (comme dans Travis-CI), cela prend quelques lignes de code - et la mise en cache fonctionne parfaitement.  Dans d'autres cas (comme dans AppVeyor), il vous suffit de sp√©cifier le r√©pertoire dans les param√®tres.  Mais il existe certains services, o√π vous devez cr√©er des cl√©s sp√©ciales et essayer de convaincre le syst√®me de vous donner la possibilit√© de r√©√©crire un fragment mis en cache.  Par cons√©quent, si vous souhaitez configurer l'analyse des demandes d'extraction sur un service d'int√©gration continue, ce qui n'a pas √©t√© consid√©r√© ci-dessus, assurez-vous d'abord que vous n'aurez pas de probl√®mes de mise en cache. <br><br>  Merci de votre attention.  Si quelque chose ne fonctionne pas, vous pouvez √©crire en toute s√©curit√© √† notre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">support</a> .  Nous vous donnerons un indice et de l'aide. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr470982/">https://habr.com/ru/post/fr470982/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr470966/index.html">Mot de passe Unix de Ken Thompson</a></li>
<li><a href="../fr470974/index.html">DNS passif entre les mains de l'analyste</a></li>
<li><a href="../fr470976/index.html">Song of Ice (Bloody Enterprise) et Flames (DevOps et IaC)</a></li>
<li><a href="../fr470978/index.html">√âtude de march√© des analystes: o√π √©tudient-ils, quels outils utilisent-ils et combien gagnent-ils</a></li>
<li><a href="../fr470980/index.html">Les t√¢ches que les robots logiciels (RPA) r√©solvent dans le secteur bancaire</a></li>
<li><a href="../fr470984/index.html">Analyse des validations et des demandes d'extraction dans Travis CI, Buddy et AppVeyor √† l'aide de PVS-Studio</a></li>
<li><a href="../fr470988/index.html">L'inscription est ouverte pour Slerm DevOps √† Moscou</a></li>
<li><a href="../fr470990/index.html">Bo√Æte √† outils de marketing en ligne: 3 applications pour booster la communication visuelle</a></li>
<li><a href="../fr470994/index.html">H√©ritage JavaScript du point de vue d'un nerd ennuy√©: Constructors Factory</a></li>
<li><a href="../fr470996/index.html">Comment une simple balise <img> peut-elle devenir un risque √©lev√© pour une entreprise?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>