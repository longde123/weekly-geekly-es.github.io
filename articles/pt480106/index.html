<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§≤üèø üëºüèø üë®üèø‚Äçü§ù‚Äçüë®üèæ Como montar uma imagem do banco de dados Oracle para cont√™ineres de teste üêµ üë®‚Äçüîß üê§</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O c√≥digo deve ser testado no DBMS com o qual ele trabalhar√°. Testcontainers √© uma biblioteca que permite que voc√™ use praticamente qualquer DBMS em te...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como montar uma imagem do banco de dados Oracle para cont√™ineres de teste</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/480106/"><p>  O c√≥digo deve ser testado no DBMS com o qual ele trabalhar√°.  Testcontainers √© uma biblioteca que permite que voc√™ use praticamente qualquer DBMS em testes de unidade com a mesma facilidade que bancos de dados incorporados, como HSQLDB ou H2.  S√≥ haveria uma imagem do docker </p><br><img src="https://habrastorage.org/webt/hn/x3/ho/hnx3hojiqvya8flignz-mqkrk6s.jpeg"><br><p>  Este artigo √© dedicado √† montagem de uma imagem da janela de encaixe conveniente para uso com os cont√™ineres de teste.  Quando tentei faz√™-lo, tive problemas e aqui compartilho minha solu√ß√£o. <br>  Vou coletar a imagem para o Oracle 11, porque √© pequena e tenho a vers√£o 11 suficiente.  Com outras vers√µes, a abordagem √© praticamente a mesma. </p><br><p>  Para deixar claro como usar a imagem, tamb√©m haver√° c√≥digo Java que demonstra o uso da imagem para testar aplicativos Spring Boot.  O m√©todo de conex√£o com os cont√™ineres de teste que forneci provavelmente n√£o √© o melhor.  Mas, primeiro, ele demonstra como usar as configura√ß√µes especificadas ao criar a imagem.  Em segundo lugar, √© simples.  E em terceiro lugar, ele quase n√£o est√° vinculado ao Spring, pode at√© ficar preso no c√≥digo Java, no qual n√£o h√° nada al√©m de main public void est√°tico. </p><br><p>  Sup√µe-se que o leitor esteja familiarizado superficialmente com o Docker e o Testcontaners e tamb√©m conhe√ßa bem o Java.  Para construir, voc√™ precisa usar o Linux, se estiver construindo no Windows, precisar√° usar o msys2 ou algo assim. </p><br><p>  O c√≥digo de demonstra√ß√£o √© carregado no github aqui <a href="https://github.com/poxu/testcontainers-spring-demo" rel="nofollow">https://github.com/poxu/testcontainers-spring-demo Os</a> scripts corrigidos para montar a imagem podem ser visualizados no meu fork das instru√ß√µes de Oraklov <a href="https://github.com/poxu/docker-images/tree/master/OracleDatabase/SingleInstance" rel="nofollow">https://github.com/poxu/docker-images/tree/ master / OracleDatabase / SingleInstance</a> </p><a name="habracut"></a><br><h1>  Criar uma imagem do Docker </h1><br><p>  O Oracle n√£o fornece imagens para o docker, mas publicou instru√ß√µes detalhadas sobre como mont√°-las no github. </p><br><p>  Infelizmente, n√£o √© poss√≠vel usar essas imagens em cont√™ineres de teste porque o cont√™iner que √© iniciado a partir dessa imagem come√ßa de dois a 20 minutos. </p><br><p>  Para uso em testes de unidade, isso √© inaceit√°vel; portanto, √© necess√°rio fazer suas pr√≥prias altera√ß√µes nos scripts, mas primeiro, √© melhor tentar montar o cont√™iner de acordo com as instru√ß√µes fornecidas pela Oracle.  Farei uma breve recontagem aqui, uma instru√ß√£o mais completa pode ser encontrada neste link <a href="https://github.com/oracle/docker-images/tree/master/OracleDatabase/SingleInstance" rel="nofollow">https://github.com/oracle/docker-images/tree/master/OracleDatabase/SingleInstance</a> </p><br><h2>  Montagem da imagem de acordo com as instru√ß√µes do Oracle </h2><br><p>  Primeiro, voc√™ precisa clonar o reposit√≥rio com instru√ß√µes sobre como montar a imagem. </p><br><pre><code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/oracle/docker-images.git</code> </pre> <br><p>  Em seguida, obtenha o pacote rpm para a vers√£o expressa autorizada do Oracle 11.2.0.2 N√£o √© muito dif√≠cil, voc√™ s√≥ precisa se registrar no site da Oracle, acessar a p√°gina de download do Oracle DBMS, selecionar a vers√£o 11.2.0.2 XE e baixar o arquivo rpm compactado oracle-xe-11.2.0 -1.0.x86 ~ 64 ~ .rpm.zip. </p><br><p>  Coloque o arquivo no reposit√≥rio git baixado no diret√≥rio docker-images / OracleDatabase / SingleInstance / dockerfiles / 11.2.0.2 / </p><br><p>  Em seguida, acesse o diret√≥rio docker-images / OracleDatabase / SingleInstance / dockerfiles e execute o comando </p><br><pre> <code class="bash hljs">./buildDockerImage.sh -v 11.2.0.2 -x</code> </pre> <br><p>  A janela de encaixe montar√° uma imagem chamada oracle / database: 11.2.0.2-xe com base na qual voc√™ precisa criar o cont√™iner com este comando </p><br><pre> <code class="bash hljs">docker run --rm --name vanilla_oracle_test_habr \ -p 1234:1521 \ -p 5678:5500 \ -e ORACLE_PWD=123 \ --shm-size=<span class="hljs-string"><span class="hljs-string">"1g"</span></span> \ oracle/database:11.2.0.2-xe</code> </pre> <br><p>  O cont√™iner inicia alguns minutos, porque, ap√≥s iniciar, cria um novo banco de dados, e esse processo n√£o √© r√°pido. </p><br><p>  Ap√≥s alguns minutos, um banner aparecer√° no console </p><br><blockquote>  ############################ <br>  O BASE DE DADOS EST√Å PRONTO PARA USAR! <br>  ############################ </blockquote><p>  Depois disso, voc√™ pode se conectar ao banco de dados usando o logon do sistema, a senha √© 123, o endere√ßo de conex√£o √© localhost e o SID √© XE. </p><br><p>  Se tudo funcionou, voc√™ pode prosseguir com o processo de cria√ß√£o de uma imagem em cont√™ineres de teste.  Caso contr√°rio, √© melhor primeiro ler o manual da Oracle e descobrir o que est√° errado. </p><br><p>  Como j√° descobrimos, o cont√™iner √© iniciado por um longo tempo devido ao fato de que, ap√≥s o in√≠cio, um banco de dados √© criado.  Em alguns casos, isso provavelmente pode ser conveniente, mas agora isso est√° causando danos completos.  √â necess√°rio deixar o recipiente pronto para uso imediatamente ap√≥s o lan√ßamento. </p><br><h2>  Refinamento manual de imagens </h2><br><p>  Uma maneira de obter a imagem do banco de dados finalizado √© aguardar at√© que o cont√™iner seja iniciado e a cria√ß√£o do banco de dados seja conclu√≠da e salve o cont√™iner em uma nova imagem. </p><br><p>  √â importante n√£o iniciar o cont√™iner com o argumento --rm, caso contr√°rio, a janela de encaixe o vencer√° imediatamente ap√≥s a parada. </p><br><pre> <code class="bash hljs">docker commit --message <span class="hljs-string"><span class="hljs-string">"container for unit tests"</span></span> &lt;container id&gt; my/oracle-11.2.0.2-for-unit-tests</code> </pre> <br><p>  Isso criar√° uma nova imagem a partir do cont√™iner, que ser√° iniciada n√£o apenas por alguns minutos, mas por 20 a 30 segundos. </p><br><h2>  Modifica√ß√£o do processo de montagem da imagem para obter uma imagem finalizada imediatamente ap√≥s a montagem </h2><br><p>  Obviamente, √© bom ter instru√ß√µes para montar a imagem na forma de c√≥digo, para que voc√™ possa iniciar a montagem com um comando e n√£o seja necess√°rio aguardar o in√≠cio do cont√™iner e criar uma imagem com base nas suas m√£os. </p><br><p>  A √∫ltima linha do arquivo docker indica o comando que √© executado ap√≥s o in√≠cio </p><br><pre> <code class="bash hljs">CMD <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> <span class="hljs-variable"><span class="hljs-variable">$ORACLE_BASE</span></span>/<span class="hljs-variable"><span class="hljs-variable">$RUN_FILE</span></span></code> </pre> <br><p>  \ $ ORACLE ~ BASE ~ / \ $ RUN ~ FILE ~ aponta para o arquivo docker-images / OracleDatabase / SingleInstance / dockerfiles / 11.2.0.2 / runOracle.sh </p><br><p>  Se voc√™ parar esse cont√™iner e depois execut√°-lo novamente, como resultado, pela primeira vez, o script criar√° o banco de dados e, pela segunda vez, simplesmente o iniciar√°.  Pode-se supor que, se voc√™ executar o script no est√°gio de montagem da imagem, a imagem ser√° montada a partir do banco de dados j√° criado. </p><br><p>  Mas, no caminho para implementar esse plano ousado, surge uma complica√ß√£o. </p><br><p>  O script √© executado para sempre, ou seja, at√© que um sinal chegue ao cont√™iner de que o trabalho precisa ser conclu√≠do.  Isso √© resolvido de maneira bastante simples.  A √∫ltima linha do arquivo runOracle.sh cont√©m o comando wait.  Sabemos que, na fase de montagem, voc√™ n√£o precisa esperar nada, precisa terminar o trabalho e, portanto, colocaremos uma declara√ß√£o condicional no script. </p><br><p>  Ele verificar√° se o argumento - execu√ß√£o durante a constru√ß√£o n√£o √© passado para o arquivo e se esse argumento √© passado, n√£o espere por nenhum sinal, mas simplesmente interrompa o trabalho.  Ou seja, fa√ßa assim: </p><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">"</span></span> != <span class="hljs-string"><span class="hljs-string">"--running-while-building"</span></span> ] <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">wait</span></span> <span class="hljs-variable"><span class="hljs-variable">$childPID</span></span> <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span></code> </pre> <br><p>  Bem, no dockerfile, adicionamos outra chamada de script, apenas no est√°gio de montagem.  Acontecer√° assim. </p><br><pre> <code class="bash hljs">RUN <span class="hljs-variable"><span class="hljs-variable">$ORACLE_BASE</span></span>/<span class="hljs-variable"><span class="hljs-variable">$RUN_FILE</span></span> --running-while-building CMD <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> <span class="hljs-variable"><span class="hljs-variable">$ORACLE_BASE</span></span>/<span class="hljs-variable"><span class="hljs-variable">$RUN_FILE</span></span></code> </pre> <br><h2>  Altera√ß√µes necess√°rias para uso em testes </h2><br><h3 id="ustranit-ispolzovanie-tomov">  Eliminar o uso do volume </h3><br><p>  Precisa encontrar a linha </p><br><blockquote>  VOLUME ["\ $ ORACLE ~ BASE ~ / oradata"] </blockquote><p>  E comente sobre isso.  N√£o h√° necessidade de usar volumes, porque todas as altera√ß√µes ser√£o lan√ßadas ap√≥s cada execu√ß√£o de teste, mas problemas com o uso de volumes podem surgir facilmente ao copiar imagens. </p><br><h3 id="udalit-nenuzhnye-fayly">  Excluir arquivos desnecess√°rios </h3><br><p>  Precisa adicionar linhas </p><br><pre> <code class="bash hljs">rm -rf <span class="hljs-variable"><span class="hljs-variable">$ORACLE_HOME</span></span>/demo &amp;&amp; \ rm -rf <span class="hljs-variable"><span class="hljs-variable">$ORACLE_HOME</span></span>/jdbc &amp;&amp; \ rm -rf <span class="hljs-variable"><span class="hljs-variable">$ORACLE_HOME</span></span>/jlib &amp;&amp; \ rm -rf <span class="hljs-variable"><span class="hljs-variable">$ORACLE_HOME</span></span>/md &amp;&amp; \ rm -rf <span class="hljs-variable"><span class="hljs-variable">$ORACLE_HOME</span></span>/nls/demo &amp;&amp; \ rm -rf <span class="hljs-variable"><span class="hljs-variable">$ORACLE_HOME</span></span>/odbc &amp;&amp; \ rm -rf <span class="hljs-variable"><span class="hljs-variable">$ORACLE_HOME</span></span>/rdbms/jlib &amp;&amp; \ rm -rf <span class="hljs-variable"><span class="hljs-variable">$ORACLE_HOME</span></span>/rdbms/public &amp;&amp; \ rm -rf <span class="hljs-variable"><span class="hljs-variable">$ORACLE_HOME</span></span>/rdbms/demo &amp;&amp; \ rm -rf <span class="hljs-variable"><span class="hljs-variable">$ORACLE_HOME</span></span>/bin/rman &amp;&amp; \</code> </pre> <br><p>  Pouco antes da linha </p><br><pre> <code class="bash hljs">chmod ug+x <span class="hljs-variable"><span class="hljs-variable">$ORACLE_BASE</span></span>/*.sh</code> </pre> <br><p>  Isso remover√° da imagem todos os arquivos que n√£o s√£o necess√°rios para fins de teste.  Quanto menor a imagem, melhor. </p><br><h3 id="ubrat-razbienie-obraza-na-sloi">  Remover divis√£o de imagem </h3><br><p>  Para reduzir a imagem, voc√™ precisa compil√°-la usando o argumento <strong>squash</strong> .  Isso remover√° a separa√ß√£o em camadas da imagem, o que reduzir√° ainda mais seu volume.  O argumento squash √© experimental, ent√£o voc√™ deve habilit√°-lo separadamente.  Em diferentes sistemas operacionais, isso √© feito de maneiras diferentes. </p><br><p>  Para encaminhar argumentos para a janela de encaixe, docker-images / OracleDatabase / SingleInstance / dockerfiles / buildDockerImage.sh fornece o argumento -o.  Ou seja, para encaminhar o argumento --squash para a janela de encaixe, voc√™ precisa chamar buildDockerImage.sh assim </p><br><pre> <code class="bash hljs">./buildDockerImage.sh -o <span class="hljs-string"><span class="hljs-string">'--squash'</span></span></code> </pre> <br><h3 id="pomenyat-nazvanie-obraza">  Alterar nome da imagem </h3><br><p>  At√© o momento, a imagem √© significativamente diferente do que a Oracle se prop√µe a fazer, portanto, deve ser renomeada.  Para fazer isso, voc√™ j√° precisa editar o arquivo buildDockerImage.sh.O script leva o nome da imagem da vari√°vel IMAGE ~ NAME ~, cujo valor √© definido diretamente no arquivo </p><br><p>  Bem aqui </p><br><pre> <code class="plaintext hljs"># Oracle Database Image Name IMAGE_NAME="oracle/database:$VERSION-$EDITION"</code> </pre> <br><p>  Eu mudei para </p><br><pre> <code class="plaintext hljs"># Oracle Database Image Name IMAGE_NAME="my/oracle-for-habr:$VERSION-$EDITION"</code> </pre> <br><h3 id="zadat-parol-k-bd">  Definir senha do banco de dados </h3><br><p>  Essa senha √© definida na vari√°vel de ambiente ORACLE ~ PWD ~ durante o primeiro in√≠cio do cont√™iner.  Por√©m, como temos a configura√ß√£o do banco de dados durante a cria√ß√£o da imagem, a vari√°vel precisa ser definida neste est√°gio.  Se a capacidade de definir uma senha para cada montagem por meio da linha de comando n√£o for necess√°ria, voc√™ pode simplesmente inseri-la no dockerfile: </p><br><pre> <code class="plaintext hljs">ENV ORACLE_PWD=123</code> </pre> <br><p>  Se, para algo que voc√™ precisa determinar a senha novamente a cada compila√ß√£o, para encaminhar o argumento para a janela de encaixe, voc√™ pode novamente usar -o </p><br><pre> <code class="bash hljs">./buildDockerImage.sh -v 11.2.0.2 -x -o <span class="hljs-string"><span class="hljs-string">'--squash --build-arg ORACLE_PWD=123'</span></span></code> </pre> <br><p>  Isso transferir√° a vari√°vel de ambiente ORACLE ~ PWD ~ para o dockerfile, mas o dockerfile n√£o a passar√° para scripts executados durante a constru√ß√£o.  Para que ele fa√ßa isso, voc√™ precisa adicionar a instru√ß√£o ARG ao dockerfile. </p><br><pre> <code class="plaintext hljs">ARG ORACLE_PWD=default</code> </pre> <br><p>  A senha, como provavelmente j√° ficou clara, ser√° 123 e, se voc√™ n√£o passar o ORACLE ~ PWD ~ para buildDockerImage.sh, ser√° o padr√£o. </p><br><p>  √Äs vezes, a Oracle acredita que a senha √© incorreta e n√£o deseja funcionar, portanto, pode ser necess√°rio substituir 123 por outra. </p><br><h2>  Teste para elevar a imagem resultante </h2><br><p>  Agora voc√™ pode tentar executar o cont√™iner com base na imagem </p><br><pre> <code class="bash hljs">docker run --rm --name dockertest_habr \ -p 1234:1521 \ -p 5678:5500 \ --shm-size=<span class="hljs-string"><span class="hljs-string">"1g"</span></span> \ my/oracle-for-habr:11.2.0.2-xe</code> </pre> <br><p>  O argumento --shm-size = "1g" √© importante aqui, sem o qual o cont√™iner √© iniciado, mas o pr√≥prio Oracle 11.2.0.2 n√£o pode funcionar.  Isso, apenas no caso, n√£o significa que o cont√™iner precisar√° de um gigabyte de RAM, ele consome cerca de 100 megabytes. </p><br><p>  Se o cont√™iner tiver aumentado normalmente, voc√™ pode tentar se conectar ao banco de dados, localizado l√°. </p><br><p>  Endere√ßo base - provavelmente localhost <br>  Porto - 1234 <br>  Usu√°rio - SISTEMA <br>  Senha - 123 </p><br><p>  Se iniciar normalmente, voc√™ poder√° prosseguir para a pr√≥xima etapa. </p><br><h2>  Script de inicializa√ß√£o do banco de dados </h2><br><p>  Para que o programa possa trabalhar com o banco de dados a partir da imagem, √© necess√°rio que exista um circuito l√° ap√≥s o lan√ßamento.  Voc√™ pode criar esse circuito no est√°gio de constru√ß√£o, mas eu prefiro faz√™-lo quando o cont√™iner iniciar. </p><br><p>  Ap√≥s o in√≠cio, o cont√™iner procurar√° no diret√≥rio <em>u01 / app / oracle / scripts / startup</em> e executar√° todos os scripts sql que encontrar l√°, que voc√™ poder√° usar colocando o arquivo que criar√° o circuito.  Algo assim. </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span> TEST_USER <span class="hljs-keyword"><span class="hljs-keyword">IDENTIFIED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> passwordnoquotes; <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span> TEST_USER <span class="hljs-keyword"><span class="hljs-keyword">QUOTA</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unlimited</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SYSTEM</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SESSION</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONNECT</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">RESOURCE</span></span>, DBA <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> TEST_USER; <span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">PRIVILEGES</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> TEST_USER;</code> </pre> <br><p>  Tudo isso precisa ser adicionado ao arquivo init ~ db ~ .sql, e o arquivo √© lan√ßado no cont√™iner usando -v </p><br><pre> <code class="bash hljs">docker run --rm --name dockertest_habr \ -p 1234:1521 \ -p 5678:5500 \ -e ORACLE_PWD=123 \ -v <span class="hljs-variable"><span class="hljs-variable">${PWD}</span></span>/init_db.sql:/u01/app/oracle/scripts/startup/init_db.sql \ --shm-size=<span class="hljs-string"><span class="hljs-string">"1g"</span></span> \ my/oracle-for-habr:11.2.0.2-xe</code> </pre> <br><p>  \ $ {PWD} Aqui √© usado porque o caminho absoluto para o arquivo √© necess√°rio. Ao usar o Windows, voc√™ precisa especific√°-lo de alguma maneira diferente.  Se, ap√≥s iniciar, o esquema TEST ~ USER ~ foi criado com √™xito, voc√™ pode continuar parafusando o cont√™iner rec√©m-criado nos testes. </p><br><h1>  Usando uma imagem no c√≥digo Java </h1><br><p>  Ao testar usando o banco de dados interno, via de regra, o mesmo problema surge.  Se a configura√ß√£o n√£o puder ser retirada do cache, o Spring a coletar√° novamente.  Em particular, ele recria o banco de dados interno, o que obviamente atrasa seriamente os testes.  Resolvi o problema com for√ßa bruta, simplesmente transformando a parte de eleva√ß√£o do cont√™iner em um singleton.  Real, condom√≠nio. </p><br><p>  Para o Oracle XE, o Testcontainers possui uma classe especialmente preparada.  Antes de tudo, essa classe sabe que estamos falando de um cont√™iner com um DBMS e que, para determinar se ele foi gerado, devemos tentar conectar-se ao banco de dados usando o jdbc. </p><br><p>  Um objeto desta classe aguardar√° o levantamento do cont√™iner por si s√≥, voc√™ s√≥ precisa dizer quais logs com senha usar. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.testcontainers.containers.BindMode; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.testcontainers.containers.OracleContainer; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StaticOracleContainer</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> OracleContainer </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getContainer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> LazyOracleContainer.ORACLE_CONTAINER; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LazyOracleContainer</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> OracleContainer ORACLE_CONTAINER = makeContainer(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> OracleContainer </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">makeContainer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//       testcontainers.properties //  oracle.container.image final var dockerImageName = "my/oracle-for-habr"; final var container = new OracleContainer(dockerImageName) //    ,  testcontainers //  ,  ,  //   .withUsername("SYSTEM").withPassword("123") // ,  testcontainers  //     .withExposedPorts(1521, 5500) //      shared memory //    .withSharedMemorySize(2147483648L) //   ,       // -v /path/to/init_db.sql:/u01/app/oracle/scripts/startup/init_db.sql //    init_db.sql   .withClasspathResourceMapping("init_db.sql" , "/u01/app/oracle/scripts/startup/init_db.sql" , BindMode.READ_ONLY); container.start(); return container; } } }</span></span></code> </pre> <br><p>  Al√©m disso, os cont√™ineres de teste, quando iniciados, mapeiam as portas internas do cont√™iner para portas externas desocupadas definidas aleatoriamente.  Portanto, voc√™ n√£o pode ter medo de que o cont√™iner n√£o suba, porque a porta j√° est√° sendo usada por algu√©m.  Uma porta externa pode ser obtida do cont√™iner usando o m√©todo getOraclePort (). </p><br><p>  Voc√™ tamb√©m pode obter o endere√ßo do cont√™iner usando o m√©todo getContainerIpAddress (), mas qualquer cont√™iner possui esse m√©todo. </p><br><p>  Ap√≥s a primeira chamada ao m√©todo getContainer, o cont√™iner n√£o ser√° recriado, mas o existente ser√° retornado.  Agora, esse m√©todo pode ser usado em Java simples ou na configura√ß√£o do Spring para obter um objeto com um cont√™iner do qual voc√™ pode extrair as portas e o endere√ßo da conex√£o. </p><br><p>  Por exemplo, voc√™ pode criar um inicializador que, ao elevar o contexto, substituir√° os atributos de mola respons√°veis ‚Äã‚Äãpela conex√£o com o banco de dados. </p><br><h2>  Classe para anexar cont√™ineres de teste ao Spring </h2><br><p>  Ap√≥s elevar o cont√™iner, o inicializador substitui as propriedades respons√°veis ‚Äã‚Äãpela URL para conectar-se ao banco de dados, login, senha e tudo mais. </p><br><p>  Mas, se n√£o houver configura√ß√£o evilcorp.testcontainers.enabled em application.properties, o cont√™iner n√£o ser√° levantado e tudo funcionar√° como se ningu√©m conectasse cont√™ineres de teste. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.evilcorp.demo; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.junit.platform.commons.logging.Logger; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.junit.platform.commons.logging.LoggerFactory; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.boot.test.util.TestPropertyValues; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.context.ApplicationContextInitializer; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.context.ConfigurableApplicationContext; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.testcontainers.containers.OracleContainer; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestcontainersInitializer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApplicationContextInitializer</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConfigurableApplicationContext</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Logger log = LoggerFactory.getLogger(TestcontainersInitializer.class); <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initialize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConfigurableApplicationContext applicationContext)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ,   Testcontainers final String testcontainersEnabled = applicationContext.getEnvironment().getProperty("evilcorp.testcontainers.enabled"); if (!"true".equals(testcontainersEnabled)) { return; } OracleContainer oracleContainer = StaticOracleContainer.getContainer(); oracleContainer.followOutput(s -&gt; log.debug(() -&gt; s.getUtf8String())); // IP       //  ,    // (linux, MacOs, Windows  ) , //    oracleContainer.getContainerIpAddress() //    // // Testcontainers     //   ,    oracleContainer.getOraclePort() //  ,         final String jdbcUrl = "jdbc:oracle:thin:@//" + oracleContainer.getContainerIpAddress() + ":" + oracleContainer.getOraclePort() + "/XE"; //      init_db.sql //      final String user = "TEST_USER"; final String password = "passwordnoquotes"; TestPropertyValues.of( "spring.jpa.properties.hibernate.default_schema=" + user, "spring.datasource.driver-class-name=oracle.jdbc.OracleDriver", "spring.jpa.database-platform=org.hibernate.dialect.Oracle10gDialect", "spring.datasource.username=" + user, "spring.datasource.password=" + password, "spring.datasource.url=" + jdbcUrl, "spring.liquibase.url=" + jdbcUrl, "spring.liquibase.user=" + user, "spring.liquibase.password=" + password ).applyTo(applicationContext.getEnvironment(), TestPropertyValues.Type.MAP, "test"); } }</span></span></code> </pre> <br><p>  Essa configura√ß√£o pode ser usada no teste de inicializa√ß√£o da primavera para substituir as configura√ß√µes do banco de dados em tempo real. </p><br><h2>  Teste usando cont√™ineres de teste </h2><br><p>  O teste simplesmente grava um objeto no banco de dados e o l√™, nada de especial. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.evilcorp.demo; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.evilcorp.demo.entity.User; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.junit.jupiter.api.BeforeEach; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.junit.jupiter.api.Test; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.beans.factory.annotation.Autowired; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.boot.test.context.SpringBootTest; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.test.context.ContextConfiguration; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Optional; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> org.junit.jupiter.api.Assertions.assertEquals; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> org.junit.jupiter.api.Assertions.assertNotNull; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> org.junit.jupiter.api.Assertions.assertNotSame; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> org.junit.jupiter.api.Assertions.assertTrue; <span class="hljs-meta"><span class="hljs-meta">@SpringBootTest</span></span> <span class="hljs-meta"><span class="hljs-meta">@ContextConfiguration</span></span>(initializers = {TestcontainersInitializer.class}) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestcontainersSpringDemoApplicationTests</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> UserRepository userRepository; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> User createdUser; <span class="hljs-meta"><span class="hljs-meta">@BeforeEach</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setUp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ createdUser = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User(); createdUser.setName(<span class="hljs-string"><span class="hljs-string">"Fry"</span></span>); userRepository.save(createdUser); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">userRepositoryLoaded</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ assertNotNull(userRepository); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">userAdded</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Optional&lt;User&gt; loadedUser = userRepository.findById(createdUser.getUserId()); assertTrue(loadedUser.isPresent()); assertEquals(<span class="hljs-string"><span class="hljs-string">"Fry"</span></span>, loadedUser.get().getName()); assertNotSame(createdUser, loadedUser.get()); } }</code> </pre> <br><p>  E sim, adicione depend√™ncias ao pom.xml </p><br><pre> <code class="xml hljs"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.testcontainers<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>testcontainers<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>1.12.3<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">scope</span></span></span><span class="hljs-tag">&gt;</span></span>test<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">scope</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.testcontainers<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>oracle-xe<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>1.12.3<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">scope</span></span></span><span class="hljs-tag">&gt;</span></span>test<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">scope</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  √â sobre como voc√™ pode criar uma imagem de janela de encaixe Oracle DBMS e us√°-la no c√≥digo Java.  Resta apenas colocar a imagem no reposit√≥rio corporativo de artefatos e organizar o lan√ßamento de testes dentro de outro cont√™iner de docker.  Mas esta √© uma hist√≥ria completamente diferente. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt480106/">https://habr.com/ru/post/pt480106/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt480096/index.html">Fim da inf√¢ncia: direitos autorais sobre obras criadas por intelig√™ncia artificial (IA)</a></li>
<li><a href="../pt480098/index.html">JH Rainwater "Como pastar gatos": do outro lado do desenvolvimento</a></li>
<li><a href="../pt480100/index.html">Iniciantes Sobre SEO</a></li>
<li><a href="../pt480102/index.html">Resumo do gerenciamento de produtos em novembro</a></li>
<li><a href="../pt480104/index.html">9 truques √∫teis em HTML</a></li>
<li><a href="../pt480108/index.html">F√≠sica em um projeto de unidade usando a luta m√≥vel como exemplo</a></li>
<li><a href="../pt480110/index.html">uMCPIno: Escrevendo um protocolo simples com entrega garantida para o Arduino</a></li>
<li><a href="../pt480112/index.html">Diferen√ßas entre C ++ / Visual Basic e Java no n√≠vel geral (para iniciantes e estudantes)</a></li>
<li><a href="../pt480114/index.html">Tudo sobre impostos para freelancers de TI. IE e trabalhadores por conta pr√≥pria. Parte 1</a></li>
<li><a href="../pt480116/index.html">Posi√ß√£o do grupo Mail.ru no desenvolvimento de c√≥digo-fonte aberto na R√∫ssia</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>