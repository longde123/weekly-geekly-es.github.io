<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©‚Äçüé§ üè¢ üìø La funci√≥n no reconocida ralentiza el programa 5 veces üë©üèø‚Äçüè≠ üë©üèº‚Äçüè≠ üöè</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Retraso de Windows Parte 3: Terminaci√≥n del proceso 



 El autor se dedica a optimizar el rendimiento de Chrome en Google: aprox. trans. 

 En el ver...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>La funci√≥n no reconocida ralentiza el programa 5 veces</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/432076/"> <b>Retraso de Windows Parte 3: Terminaci√≥n del proceso</b> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b55/8f1/93c/b558f193cbc015bf35b2b068ff1c8e65.jpg"><br><br>  <font color="gray">El autor se dedica a optimizar el rendimiento de Chrome en Google: aprox.</font>  <font color="gray">trans.</font> <br><br>  En el verano de 2017, luch√© con un problema de rendimiento de Windows.  La finalizaci√≥n del proceso fue lenta, serializada y bloque√≥ la cola de entrada del sistema, lo que provoc√≥ m√∫ltiples bloqueos del cursor del mouse durante el ensamblaje de Chrome.  La raz√≥n principal fue que al final de los procesos, Windows pas√≥ mucho tiempo buscando objetos GDI, mientras manten√≠a presionada la secci√≥n cr√≠tica del usuario global del sistema32.  Habl√© sobre esto en el art√≠culo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">"Procesador de 24 n√∫cleos, pero no puedo mover el cursor"</a> . <br><br>  Microsoft solucion√≥ el error y volv√≠ a mi negocio, pero luego result√≥ que el error hab√≠a regresado.  Hubo quejas sobre el funcionamiento lento de las pruebas LLVM, con frecuentes bloqueos de entrada. <br><br>  Pero, de hecho, el error no regres√≥.  La raz√≥n fue un cambio en nuestro c√≥digo. <br><a name="habracut"></a><br><h1>  N√∫mero 2017 </h1><br><img src="https://habrastorage.org/getpro/habr/post_images/dcd/5f4/417/dcd5f4417f6d878a47d7d3c292a9304a.png" align="left">  Cada proceso de Windows contiene varios descriptores de objetos GDI est√°ndar.  Para los procesos que no hacen nada con gr√°ficos, estos descriptores suelen ser NULL.  Al final del proceso, Windows llama a algunas funciones para estos descriptores, incluso si son NULL.  No import√≥, las caracter√≠sticas funcionaron r√°pidamente, hasta el lanzamiento de la Edici√≥n de aniversario de Windows 10, en la que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">algunos cambios de seguridad hicieron que estas caracter√≠sticas fueran lentas</a> .  Durante la operaci√≥n, mantuvieron el mismo bloqueo que se utiliz√≥ para los eventos de entrada.  Cuando una gran cantidad de procesos se terminan simult√°neamente, cada uno realiza varias llamadas a la funci√≥n lenta que mantiene este bloqueo cr√≠tico, lo que finalmente lleva a que la entrada del usuario se bloquee y el cursor se congele. <br><br>  El parche de Microsoft no deb√≠a llamar a estas funciones para procesos sin objetos GDI.  No conozco los detalles, pero creo que el parche de Microsoft fue algo como esto: <br><br> <code>+ if (IsGUIProcess()) <br> + NtGdiCloseProcess(); <br> ‚Äì NtGdiCloseProcess();</code> <br> <br>  Es decir, simplemente omita la limpieza de GDI si el proceso no es un proceso GUI / GDI. <br><br>  Dado que los compiladores y otros procesos que creamos y terminamos r√°pidamente no usaban objetos GDI, este parche result√≥ ser suficiente para reparar la congelaci√≥n de la interfaz de usuario. <br><br><h1>  Edici√≥n 2018 </h1><br>  Result√≥ que a los procesos se les asignan muy f√°cilmente algunos objetos GDI est√°ndar.  Si su proceso carga gdi32.dll, recibir√° autom√°ticamente objetos GDI (DC, superficies, regiones, pinceles, fuentes, etc.), ya sea que los necesite o no (tenga en cuenta que estos objetos GDI est√°ndar no se muestran en el Administrador de tareas entre los objetos GDI para el proceso). <br><br>  Pero eso no deber√≠a ser un problema.  Quiero decir, ¬øpor qu√© el compilador cargar√≠a gdi32.dll?  Bueno, result√≥ que si carga user32.dll, shell32.dll, ole32.dll o muchas otras DLL, autom√°ticamente obtendr√° adem√°s gdi32.dll (con los objetos GDI est√°ndar mencionados anteriormente).  Y es muy f√°cil descargar accidentalmente una de estas bibliotecas. <br><br>  LLVM prueba al cargar cada proceso llamado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">CommandLineToArgvW</a> (shell32.dll), y a veces llamado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">SHGetKnownFolderPath</a> (tambi√©n shell32.dll) Estas llamadas fueron suficientes para extraer gdi32.dll y generar estos objetos GDI est√°ndar de miedo.  Dado que el conjunto de pruebas LLVM genera tantos procesos, finalmente se serializa al finalizar los procesos, causando enormes demoras y congelaciones de entrada, mucho peores que las de 2017. <br><br>  Pero esta vez sab√≠amos sobre el principal problema con el bloqueo, por lo que inmediatamente supimos qu√© hacer. <br><br>  En primer lugar, nos deshicimos de llamar a <i>CommandLineToArgvW</i> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">analizando manualmente la l√≠nea de comando</a> .  Despu√©s de eso, el conjunto de pruebas LLVM rara vez llamaba a alguna funci√≥n desde una DLL problem√°tica.  Pero sab√≠amos de antemano que esto no afectar√≠a el rendimiento de ninguna manera.  La raz√≥n era que incluso la llamada <i>condicional</i> restante era suficiente para extraer siempre shell32.dll, que a su vez extra√≠a gdi32.dll, que crea objetos GDI est√°ndar. <br><br>  La segunda soluci√≥n fue la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">carga retrasada de shell32.dll</a> .  La carga retrasada significa que la biblioteca se carga bajo demanda, cuando se llama a la funci√≥n, en lugar de cargarse cuando comienza el proceso.  Esto significaba que shell32.dll y gdi32.dll se cargar√≠an raramente, y no siempre. <br><br>  Despu√©s de eso, el conjunto de pruebas LLVM comenz√≥ a ejecutarse <i>cinco veces</i> m√°s r√°pido, en un minuto en lugar de cinco.  Y ya no se congela el mouse en las m√°quinas de desarrollo, para que los empleados puedan trabajar normalmente durante la ejecuci√≥n de las pruebas.  Esta es una aceleraci√≥n loca para un cambio tan modesto, y el autor de los parches estaba tan agradecido por mi investigaci√≥n que me nomin√≥ para un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">bono corporativo</a> . <br><br>  A veces, los cambios m√°s peque√±os tienen las mayores consecuencias.  Solo necesita <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">saber d√≥nde marcar "cero"</a> . <br><br><h1>  Ruta de ejecuci√≥n no aceptada </h1><br><img src="https://habrastorage.org/getpro/habr/post_images/83d/1a9/e86/83d1a9e868d112a30dd4c37ea0caa9cb.jpg" align="left" width="350">  Vale la pena repetir que prestamos atenci√≥n al c√≥digo que <i>no se ejecut√≥</i> , y este fue un cambio clave.  Si tiene una herramienta de l√≠nea de comando que no accede a gdi32.dll, entonces agregar c√≥digo con una llamada de funci√≥n <i>condicional</i> ralentizar√° el proceso muchas veces si se carga gdi32.dll.  En el siguiente ejemplo, nunca se llama a <i>CommandLineToArgvW</i> , pero incluso una simple presencia en el c√≥digo (sin demora de llamada) afecta negativamente el rendimiento: <br><br><pre> <code class="plaintext hljs">int main(int argc, char* argv[]) { if (argc &lt; 0) { CommandLineToArgvW(nullptr, nullptr); // shell32.dll, pulls in gdi32.dll } }</code> </pre> <br>  Entonces, s√≠, eliminar una llamada de funci√≥n, incluso si el c√≥digo nunca se ejecuta, puede ser suficiente para mejorar significativamente el rendimiento en algunos casos. <br><br><h1>  Reproducci√≥n de patolog√≠a </h1><br><img src="https://habrastorage.org/getpro/habr/post_images/8ab/f3f/4aa/8abf3f4aac933be4fe7cdb400727b049.png" align="left">  Cuando investigu√© el error inicial, escrib√≠ un programa ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ProcessCreateTests</a> ) que cre√≥ 1000 procesos y luego los elimin√≥ a todos en paralelo.  Esto reprodujo el congelamiento, y cuando Microsoft corrigi√≥ el error, utilic√© un programa de prueba para verificar el parche: mira el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">video</a> .  Despu√©s de la reencarnaci√≥n del error, cambi√© mi programa <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">agregando la opci√≥n -user32</a> , que carga user32.dll para cada uno de los miles de procesos de prueba.  Como se esperaba, el tiempo de finalizaci√≥n de todos los procesos de prueba aumenta dram√°ticamente con esta opci√≥n, y es f√°cil detectar el congelamiento del cursor del mouse.  El tiempo de creaci√≥n del proceso tambi√©n aumenta con la opci√≥n -user32, pero no hay suspensiones de cursor durante la creaci√≥n del proceso.  Puede usar este programa y ver qu√© tan terrible puede ser el problema.  Estos son algunos resultados t√≠picos de mi port√°til de cuatro n√∫cleos / ocho subprocesos despu√©s de una semana de tiempo de actividad.  La opci√≥n -user32 aumenta el tiempo para todo, pero el bloqueo de <i>UserCrit</i> en los procesos termina especialmente dram√°ticamente: <br><br> <code>&gt; ProcessCreatetests.exe <br> Process creation took 2.448 s (2.448 ms per process). <br> Lock blocked for 0.008 s total, maximum was 0.001 s. <br> <br> Process destruction took 0.801 s (0.801 ms per process). <br> Lock blocked for 0.004 s total, maximum was 0.001 s. <br> <br> &gt; ProcessCreatetests.exe -user32 <br> Testing with 1000 descendant processes with user32.dll loaded. <br> Process creation took 3.154 s (3.154 ms per process). <br> Lock blocked for 0.032 s total, maximum was 0.007 s. <br> <br> Process destruction took 2.240 s (2.240 ms per process). <br> Lock blocked for 1.991 s total, maximum was 0.864 s.</code> <br> <br><h1>  Cavando m√°s profundo solo por diversi√≥n </h1><br>  Pens√© en algunos m√©todos ETW que se pueden usar para estudiar el problema con m√°s detalle, y ya comenc√© a escribirlos.  Pero me encontr√© con un comportamiento tan inexplicable, que decid√≠ dedicar un art√≠culo separado.  Baste decir que en este caso, Windows se comporta a√∫n m√°s extra√±amente. <br><br>  Otros art√≠culos de la serie: <br><br><ul><li>  Retraso de Windows, parte 0: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">desaceleraci√≥n arbitraria de VirtualAlloc</a> </li><li>  Retrasando Windows, parte 1: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">acceso a archivos</a> </li><li>  Retrasando Windows Parte 2: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Creando Procesos</a> </li><li>  Retrasando Windows, parte 3: esto </li></ul><br><h1>  Literatura </h1><br><ul><li>  Primer informe de suspensi√≥n de la interfaz de usuario: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">"procesador de 24 n√∫cleos, pero no puedo mover el cursor"</a> </li><li>  El siguiente art√≠culo, que conduce a una comprensi√≥n del problema: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">"Qu√© * hace * Windows hace mientras mantiene este bloqueo"</a> </li><li>  Un art√≠culo sobre <i>otro</i> bloqueo de UI debido a la interacci√≥n entre Gmail, los trabajadores de ASLR v8, las pol√≠ticas de asignaci√≥n de memoria CFG y el escaneo lento de WMI: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">"CPU de 24 n√∫cleos, pero no puedo escribir un correo electr√≥nico"</a> </li><li>  El compilador que carga gdi32.dll parece extra√±o, pero es a√∫n m√°s extra√±o que el compilador cargue mshtml.dll, que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">VC ++ sol√≠a hacer en algunos casos</a> </li><li>  A veces, semanas de investigaci√≥n conducen a cambios peque√±os pero cr√≠ticos, como se discute en el art√≠culo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">"Saber d√≥nde marcar cero"</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Video que</a> muestra el uso de ProcessCreateTests y ETW para verificar una correcci√≥n de errores </li><li>  Primer cambio para LLVM mediante <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">an√°lisis de l√≠nea de comando manual</a> </li><li>  Segunda soluci√≥n para LLVM usando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">el retraso de carga shell32.dll</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es432076/">https://habr.com/ru/post/es432076/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es432064/index.html">C√≥mo escapar de las "liebres". Instrucci√≥n UV</a></li>
<li><a href="../es432068/index.html">C√≥mo facilitar el estudio del ingl√©s: 5 servicios √∫tiles</a></li>
<li><a href="../es432070/index.html">Brevemente sobre los canales redux-saga</a></li>
<li><a href="../es432072/index.html">Tres tipos de p√©rdidas de memoria</a></li>
<li><a href="../es432074/index.html">C√≥mo los jugadores rasgan la tela de realidad Spelunky con escopetas</a></li>
<li><a href="../es432078/index.html">Tr√°fico al final del t√∫nel o DNS en el pentest</a></li>
<li><a href="../es432080/index.html">Las ideas err√≥neas de los jugadores al evaluar los riesgos. Control del generador de n√∫meros aleatorios en desarrollo.</a></li>
<li><a href="../es432082/index.html">Microsoft AI Chatbot lanza la colecci√≥n de ropa de China</a></li>
<li><a href="../es432084/index.html">C√≥mo organizamos una competencia por turnos entre los trabajadores de producci√≥n (como en la URSS)</a></li>
<li><a href="../es432086/index.html">Impresi√≥n 3D en la escuela internacional que lleva el nombre de M.V. Lomonosov</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>