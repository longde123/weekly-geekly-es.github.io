<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©‚Äçüé® üë®üèø‚Äçüåæ ü•ä Identifiez le blocage PKH sur un routeur OpenWrt avec WireGuard et DNSCrypt üë©üèº‚Äçüíª üëßüèª üí™üèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Quelle est la diff√©rence avec des mat√©riaux similaires? 


- Impl√©mentation Pure OpenWrt 
- Utilisation de WireGuard 
- La configuration du routeur es...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Identifiez le blocage PKH sur un routeur OpenWrt avec WireGuard et DNSCrypt</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/440030/"><h2 id="chem-otlichaetsya-ot-podobnyh-materialov">  Quelle est la diff√©rence avec des mat√©riaux similaires? </h2><br><ul><li>  Impl√©mentation Pure OpenWrt </li><li>  Utilisation de WireGuard </li><li>  La configuration du routeur est organis√©e √† l'aide de configurations OpenWrt, et non d'un groupe dans un script </li><li>  Il existe des situations lors du red√©marrage du r√©seau et du red√©marrage </li><li>  Il consomme peu de ressources de routeur: les sous-r√©seaux verrouill√©s sont contenus dans iptables et non dans les tables de routage.  Ce qui vous permet de d√©ployer cette entreprise m√™me sur des appareils faibles </li><li>  Automatisez la configuration √† l'aide d'Ansible (aucun python requis sur le routeur) </li></ul><a name="habracut"></a><br><h2 id="videoversiya">  Version vid√©o </h2><br><iframe width="560" height="315" src="https://www.youtube.com/embed/GMvEF0PXN-w" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><h2 id="pochemu-openwrt-i-wireguard">  Pourquoi OpenWrt et WireGuard? </h2><br><p>  OpenWrt est install√© sur de nombreux mod√®les de routeurs soho, il est configur√© et √©tendu √† votre guise.  Maintenant, de nombreux firmwares de routeurs sont des modules compl√©mentaires sur OpenWrt. </p><br><p>  Wireguard est utilis√© en raison de sa configuration rapide et facile, ainsi qu'en raison de la vitesse de transmission √©lev√©e √† travers le tunnel. </p><br><h2 id="nemnogo-o-wireguard">  Un peu sur WireGuard </h2><br><p>  Dans notre cas, le serveur est un VPS en dehors de l'ILV, le client est un routeur OpenWrt √† la maison.  Quand tu veux aller √† <del>  pornolab </del>  t√©l√©gramme, votre routeur dirigera le trafic via un serveur avec WireGuard. <br>  WireGuard √©tablit une connexion de site √† site, c'est-√†-dire  le serveur et le client ont tous deux le c√¥t√© serveur et client de la configuration.  Si ce n'est pas clair, cela deviendra clair lorsque vous verrez la configuration. </p><br><p>  Le serveur et le client ont leurs propres cl√©s priv√©es et publiques. </p><br><h2 id="nastroyka-wireguard-na-servere">  Configuration de WireGuard sur le serveur </h2><br><p>  Je fais tout sur Ubuntu 18.04, mais dans la documentation officielle il <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="instructions d'installation">y a des instructions d'installation</a> pour tous les OS connus et pas tr√®s. </p><br><h3 id="ustanovka">  L'installation </h3><br><pre><code class="bash hljs">sudo add-apt-repository ppa:wireguard/wireguard</code> </pre> <br><blockquote>  En cas d'erreur <br><pre> <code class="bash hljs">sudo: add-apt-repository: <span class="hljs-built_in"><span class="hljs-built_in">command</span></span> not found</code> </pre> <br><br>  Installer les propri√©t√©s du logiciel communes - le package offre la possibilit√© d'ajouter et de supprimer PPA <br><pre> <code class="bash hljs">sudo apt install software-properties-common</code> </pre> <br></blockquote><br><pre> <code class="bash hljs">sudo apt update sudo apt install wireguard-dkms wireguard-tools</code> </pre> <br><p>  Nous g√©n√©rons des cl√©s pour le serveur.  Nous enregistrerons les cl√©s dans le r√©pertoire WireGuard pour plus de commodit√©. </p><br><pre> <code class="plaintext hljs">cd /etc/wireguard/ wg genkey | tee privatekey-server | wg pubkey &gt; publickey-server</code> </pre> <br><p>  Par cons√©quent, il y aura une cl√© priv√©e dans le fichier privatekey-server et une cl√© publique dans le fichier publickey-server. <br>  Nous g√©n√©rons √©galement imm√©diatement une cl√© pour le client: </p><br><pre> <code class="plaintext hljs">wg genkey | tee privatekey-client | wg pubkey &gt; publickey-client</code> </pre> <br><p><img src="https://habrastorage.org/webt/k4/xo/m5/k4xom503xmvyxdhjsvelqhaslxo.png"></p><br><h3 id="konfiguraciya">  La configuration </h3><br><p>  La configuration est stock√©e dans /etc/wireguard/wg0.conf.  Le c√¥t√© serveur ressemble √† ceci: </p><br><pre> <code class="bash hljs">[Interface] Address = 192.168.100.1 PrivateKey = privatekey-server ListenPort = 51820 PostUp = iptables -A FORWARD -i %i -j ACCEPT; iptables -A FORWARD -o %i -j ACCEPT; iptables -t nat -A POSTROUTING -o ens3 -j MASQUERADE PostDown = iptables -D FORWARD -i %i -j ACCEPT; iptables -D FORWARD -o %i -j ACCEPT; iptables -t nat -D POSTROUTING -o ens3 -j MASQUERADE</code> </pre> <br><p>  <strong>Adresse</strong> - adresse de l'interface wg (adresse √† l'int√©rieur du tunnel) <br>  <strong>PrivateKey</strong> - Cl√© priv√©e (privatekey-server) <br>  <strong>ListenPort</strong> - Le port sur lequel le service attend pour se connecter </p><br><p>  Eh bien, nous faisons du masquage, car nous allons utiliser ce serveur pour acc√©der √† Internet <br>  Veuillez noter que le nom de l'interface dans votre cas peut diff√©rer: </p><br><p>  Partie client </p><br><pre> <code class="bash hljs">[Peer] PublicKey = publickey-client AllowedIPs = 192.168.100.3/24</code> </pre> <br><p>  <strong>PublicKey</strong> - la cl√© publique de notre routeur (publickey-client) <br>  <strong>Les IP autoris√©s</strong> sont les sous-r√©seaux qui seront disponibles via ce tunnel.  Le serveur n'a besoin que d'acc√©der √† l'adresse client. </p><br><p>  Les deux parties sont stock√©es dans une seule configuration. </p><br><p>  Activez le d√©marrage automatique au red√©marrage: </p><br><pre> <code class="bash hljs">systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> wg-quick@wg0</code> </pre> <br><p>  Nous faisons du serveur un routeur: </p><br><pre> <code class="bash hljs">sysctl -w net.ipv4.ip_forward=1</code> </pre> <br><p>  Configurez le pare-feu.  Supposons que nous ayons uniquement WireGuard et ssh sur notre serveur: </p><br><pre> <code class="bash hljs">sudo iptables -A INPUT -i lo -j ACCEPT sudo iptables -A INPUT -p udp -m udp --dport 51820 -j ACCEPT sudo iptables -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT sudo iptables -A INPUT -p icmp -j ACCEPT sudo iptables -A INPUT -p tcp -m tcp --dport 22 -j ACCEPT sudo iptables -A INPUT -j DROP</code> </pre> <br><p>  Enregistrez la configuration iptables: </p><br><pre> <code class="bash hljs">sudo apt-get install iptables-persistent sudo netfilter-persistent save</code> </pre> <br><p>  Nous √©levons l'interface wg pour la premi√®re fois manuellement: </p><br><pre> <code class="bash hljs">wg-quick up wg0</code> </pre> <br><p><img src="https://habrastorage.org/webt/1_/me/ai/1_meai1la87gto2qfa7vwmcfmju.png"></p><br><p>  Le serveur WireGuard est pr√™t. </p><br><p>  <strong>UPD 27/06/19</strong> Si votre fournisseur utilise toujours PPoE, vous devez ajouter une r√®gle.  Merci <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">denix123</a> </p><br><pre> <code class="plaintext hljs">iptables -t mangle -I POSTROUTING -p tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu</code> </pre> <br><h2 id="nastroyka-routera">  Configuration du routeur </h2><br><p>  J'utilise la version 18.06.1 d'OpenWrt sur Xiaomi mi 3G et Asus RT-N16. </p><br><h3 id="logika-raboty-routera">  La logique du routeur </h3><br><p>  Nous chargeons les listes, les mettons dans iptables, iptables marque toutes les adresses de ces listes avec un marqueur 0x1.  De plus, tous les paquets marqu√©s de 0x1 vont dans une table de routage distincte, tous les paquets tombant dans cette table de routage passent par l'interface wg. </p><br><p><img src="https://habrastorage.org/webt/vy/rc/ji/vyrcjihaaozo-vzf1nkm9nlxpl0.gif"></p><br><h3 id="ustanovka-paketov">  Installation du package </h3><br><p>  Quant √† l'espace occup√© sur le flash, tout aura besoin d'environ 0,9 Mo.  Si vous avez un tr√®s mauvais endroit, remplacez curl par wget et vous n'aurez peut-√™tre pas besoin d'installer dnscrypt-proxy. </p><br><p>  Nous mettons des paquets.  Dans OpenWrt, cela est facile √† faire via le gestionnaire de paquets opkg: </p><br><pre> <code class="bash hljs">opkg update opkg install ipset wireguard curl</code> </pre> <br><h3 id="zagruzka-spiskov">  T√©l√©chargez les listes </h3><br><p>  Tout ce qui peut √™tre fait via les fonctionnalit√©s standard d'OpenWrt se fait par leur interm√©diaire.  Tout le reste (sauf hotplug) je mets dans un petit script: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh START=99 dir=/tmp/lst mkdir -p $dir echo "Run download lists" curl -z $dir/subnet.lst https://antifilter.download/list/subnet.lst --output $dir/subnet.lst curl -z $dir/ipsum.lst https://antifilter.download/list/ipsum.lst --output $dir/ipsum.lst echo "Firewall restart" /etc/init.d/firewall restart</span></span></code> </pre> <br><p>  Les listes de sous-r√©seaux et d'adresses interdits sont obtenues par fichiers.  Pour eux, nous cr√©ons un r√©pertoire dans / tmp.  Dans / tmp - car il s'agit de RAM, une telle fonctionnalit√© d'OpenWrt est assez pratique.  Cela ne vaut pas la peine d'√©crire √† nouveau quelque chose sur la ROM du routeur. </p><br><p>  Nous pompons les listes avec antifilter.download curl, le drapeau z signifie que curl t√©l√©chargera le fichier uniquement si le fichier distant est diff√©rent du fichier local ou s'il ne l'est pas, comme par exemple lors du chargement d'un routeur. </p><br><p>  <em>subnet.lst</em> - une liste de sous-r√©seaux bloqu√©s; il ne change pas souvent. <br>  <em>ipsum.lst</em> est une liste d'adresses bloqu√©es, qui est r√©sum√©e par masque.  Au lieu de 150 000 enregistrements, nous en obtenons 15 000 - commod√©ment. </p><br><p>  Apr√®s avoir les fichiers, nous red√©marrons le pare-feu, cela est n√©cessaire pour que l'ipset fonctionne et ajoute des listes √† iptables, nous configurerons l'ipset dans / etc / config / firewall. </p><br><p>  Ce script que nous ajoutons dans /etc/init.d/ sera appel√© hirkn.  Rendez-le ex√©cutable </p><br><pre> <code class="bash hljs">chmod +x /etc/init.d/hirkn</code> </pre> <br><p>  Maintenant, nous avons non seulement un script, mais un service complet.  Pour qu'il d√©marre au d√©marrage, nous cr√©ons un lien symbolique dans /etc/rc.d.  Nous en avons besoin pour d√©marrer apr√®s tous les autres services, nous <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="pr√©fixe S99">cr√©ons donc le pr√©fixe S99</a> </p><br><pre> <code class="bash hljs">ln -s /etc/init.d/hirkn /etc/rc.d/S99hirkn</code> </pre> <br><p>  Les listes doivent √™tre mises √† jour de temps en temps, nous ajoutons un enregistrement dans cron: </p><br><pre> <code class="bash hljs">crontab -e</code> </pre> <br><pre> <code class="bash hljs">0 4 * * * /etc/init.d/hirkn</code> </pre> <br><p>  Il semble tout √† fait suffisant de les mettre √† jour une fois par jour.  Gardez √† l'esprit que lors de l'ajout de listes √† l'ipset, le r√©seau tombe, dans mon cas, c'est 2 secondes. <br>  <strong>UPD</strong> : Si vous ne voulez pas de pauses, alors <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">sigo73</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">Grayver ont</a> sugg√©r√© dans les commentaires comment faire. </p><br><p>  Allumez √©galement la couronne, par d√©faut, elle est d√©sactiv√©e: </p><br><pre> <code class="bash hljs">/etc/init.d/cron <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> /etc/init.d/cron start</code> </pre> <br><h3 id="konfiguraciya-tablicy-marshrutizacii">  Configuration de la table de routage </h3><br><p>  Cr√©ez une table de routage pour le trafic √† travers le tunnel en ajoutant simplement la ligne: </p><br><pre> <code class="bash hljs">99 vpn</code> </pre> <br><p>  dans le fichier / etc / iproute2 / rt_tables. </p><br><p>  Vous pouvez cr√©er une route par d√©faut pour la table "vpn" via l'interface wg avec la commande: </p><br><pre> <code class="bash hljs">ip route add table vpn default dev wg0</code> </pre> <br><p>  Mais lorsque vous red√©marrez le r√©seau, l'itin√©raire dispara√Æt, nous cr√©ons donc le fichier 30-rknroute dans le r√©pertoire /etc/hotplug.d/iface/ avec un contenu simple: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh ip route add table vpn default dev wg0</span></span></code> </pre> <br><p>  Cela signifie que lorsque vous activez / d√©sactivez les interfaces, notre itin√©raire sera ajout√©.  Et en cons√©quence, cet itin√©raire sera toujours enregistr√©. </p><br><h3 id="konfiguraciya-seti">  Configuration du r√©seau </h3><br><p>  Nous devons configurer WireGuard et la r√®gle pour les paquets √©tiquet√©s 0x1. </p><br><p>  La configuration de WireGuard se trouve dans / etc / config / network </p><br><p>  La partie "serveur": </p><br><pre> <code class="bash hljs">config interface <span class="hljs-string"><span class="hljs-string">'wg0'</span></span> option private_key <span class="hljs-string"><span class="hljs-string">'privatekey-client'</span></span> list addresses <span class="hljs-string"><span class="hljs-string">'192.168.100.3/24'</span></span> option listen_port <span class="hljs-string"><span class="hljs-string">'51820'</span></span> option proto <span class="hljs-string"><span class="hljs-string">'wireguard'</span></span></code> </pre> <br><p>  <strong>private_key</strong> est le client de cl√© priv√©e que nous avons g√©n√©r√© lors de la configuration du serveur <br>  <strong>liste des adresses</strong> - adresse de l'interface wg <br>  <strong>listen_port</strong> - le port sur lequel WireGuard accepte les connexions.  Mais la connexion se fera via le port du serveur, donc ici nous n'ouvrirons pas le port sur le pare-feu pour cela <br>  <strong>proto</strong> - sp√©cifiez le protocole afin que openwrt comprenne qu'il s'agit d'une configuration WireGuard </p><br><p>  Partie "Client": </p><br><pre> <code class="bash hljs">config wireguard_wg0 option public_key <span class="hljs-string"><span class="hljs-string">'publickey-server'</span></span> option allowed_ips <span class="hljs-string"><span class="hljs-string">'0.0.0.0/0'</span></span> option route_allowed_ips <span class="hljs-string"><span class="hljs-string">'0'</span></span> option endpoint_host <span class="hljs-string"><span class="hljs-string">'wg-server-ip'</span></span> option persistent_keepalive <span class="hljs-string"><span class="hljs-string">'25'</span></span> option endpoint_port <span class="hljs-string"><span class="hljs-string">'51820'</span></span></code> </pre> <br><p>  <strong>public_key</strong> - cl√© publickey-server <br>  <strong>allowed_ips</strong> - sous-r√©seaux dans lesquels le trafic peut passer par le tunnel, dans notre cas aucune restriction n'est requise, donc 0.0.0.0/0 <br>  <strong>route_allowed_ips</strong> - un indicateur qui fait un itin√©raire via l'interface wg pour les r√©seaux r√©pertori√©s √† partir du param√®tre allowed_ips.  Dans notre cas, ce n'est pas n√©cessaire, iptables fait ce travail <br>  <strong>endpoint_host</strong> - ip / url de notre serveur wg <br>  <strong>persistent_keepalive</strong> - intervalle de temps apr√®s lequel les paquets sont envoy√©s pour prendre en charge la connexion <br>  <strong>endpoint_port</strong> - port wireguard sur le serveur </p><br><p>  Nous allons √©galement ajouter une r√®gle √† la configuration du r√©seau qui enverra tout le trafic marqu√© 0x1 vers la table de routage "vpn": </p><br><pre> <code class="bash hljs">config rule option priority <span class="hljs-string"><span class="hljs-string">'100'</span></span> option lookup <span class="hljs-string"><span class="hljs-string">'vpn'</span></span> option mark <span class="hljs-string"><span class="hljs-string">'0x1'</span></span></code> </pre> <br><h3 id="konfiguraciya-firewall">  Configuration du pare-feu </h3><br><p><del>  Nous ajoutons deux r√®gles pour marquer les packages, elles ne rentrent pas dans la syntaxe UCI openwrt, nous les ajoutons donc "telles quelles" √† /etc/firewall.user. </del><br>  <strong>UPD</strong> : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">Grayver a</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="sugg√©r√©">sugg√©r√©</a> qu'ils s'int√®grent assez bien.  Nous les avons configur√©s apr√®s avoir configur√© l'ipset </p><br><p>  La configuration du pare-feu se trouve dans / etc / config / firewall </p><br><p>  Ajoutez une zone pour le prot√®ge-fil.  Dans openwrt, les zones sont des cha√Ænes personnalis√©es dans iptables.  Ainsi, une zone avec une / plusieurs interfaces est cr√©√©e et des r√®gles y sont d√©j√† accroch√©es.  La zone pour wg ressemble √† ceci: </p><br><pre> <code class="bash hljs">config zone option name <span class="hljs-string"><span class="hljs-string">'wg'</span></span> option family <span class="hljs-string"><span class="hljs-string">'ipv4'</span></span> option masq <span class="hljs-string"><span class="hljs-string">'1'</span></span> option output <span class="hljs-string"><span class="hljs-string">'ACCEPT'</span></span> option forward <span class="hljs-string"><span class="hljs-string">'REJECT'</span></span> option input <span class="hljs-string"><span class="hljs-string">'REJECT'</span></span> option mtu_fix <span class="hljs-string"><span class="hljs-string">'1'</span></span> option network <span class="hljs-string"><span class="hljs-string">'wg0'</span></span></code> </pre> <br><p>  Nous autorisons uniquement le trafic √† quitter l'interface et √† activer le masquage. </p><br><p>  Vous devez maintenant activer le transfert de la zone lan vers la zone wg: </p><br><pre> <code class="bash hljs">config forwarding option src <span class="hljs-string"><span class="hljs-string">'lan'</span></span> option dest <span class="hljs-string"><span class="hljs-string">'wg'</span></span></code> </pre> <br><p>  Eh bien, la derni√®re chose est de cr√©er des listes dans iptables en utilisant ipset: </p><br><pre> <code class="bash hljs">config ipset option name <span class="hljs-string"><span class="hljs-string">'vpn_subnets'</span></span> option storage <span class="hljs-string"><span class="hljs-string">'hash'</span></span> option loadfile <span class="hljs-string"><span class="hljs-string">'/tmp/lst/subnet.lst'</span></span> option match <span class="hljs-string"><span class="hljs-string">'dst_net'</span></span> config ipset option name <span class="hljs-string"><span class="hljs-string">'vpn_ipsum'</span></span> option storage <span class="hljs-string"><span class="hljs-string">'hash'</span></span> option loadfile <span class="hljs-string"><span class="hljs-string">'/tmp/lst/ipsum.lst'</span></span> option match <span class="hljs-string"><span class="hljs-string">'dst_net'</span></span></code> </pre> <br><p>  fichier de <strong>chargement</strong> - le fichier dont nous prenons la liste <br>  <strong>nom</strong> - nom de notre liste <br>  <strong>stockage</strong> , <strong>correspondance</strong> - nous sp√©cifions ici comment stocker et quel type de donn√©es.  Nous allons stocker le type "sous-r√©seau" </p><br><p>  <strong>UPD</strong> : Si vous souhaitez utiliser la liste des adresses IP individuelles, vous devez augmenter la taille de la liste des ipsets.  Dans la configuration ipset ajouter </p><br><pre> <code class="plaintext hljs"> option hashsize '1000000' option maxelem '1000000'</code> </pre> <br><p>  Sinon, vous obtiendrez une erreur </p><br><pre> <code class="plaintext hljs">ipset v6.38: Hash is full, cannot add more elements</code> </pre> <br><p>  <strong>UPD</strong> : ajouter deux r√®gles d'√©tiquetage des packages </p><br><pre> <code class="plaintext hljs">config rule option name 'mark_subnet' option src 'lan' option proto 'all' option ipset 'vpn_subnets' option set_mark '0x1' option target 'MARK' config rule option name 'mark_ipsum' option src 'lan' option proto 'all' option ipset 'vpn_ipsum' option set_mark '0x1' option target 'MARK'</code> </pre> <br><p>  Ces r√®gles impliquent que tous les paquets allant aux sous-r√©seaux des listes vpn_subnets et vpn_ipsum doivent √™tre marqu√©s avec 0x1. </p><br><p>  Apr√®s cela, nous red√©marrons le r√©seau: </p><br><pre> <code class="bash hljs">/etc/init.d/network restart</code> </pre> <br><p><img src="https://habrastorage.org/webt/e6/pm/m6/e6pmm6etqcw0dbz-c3ddqmzqemo.png"></p><br><p>  et ex√©cutez le script: </p><br><pre> <code class="bash hljs">/etc/init.d/hirkn</code> </pre> <br><p><img src="https://habrastorage.org/webt/e4/q-/6r/e4q-6rktvq2y8znvhmtpxfdsnwi.gif"></p><br><p>  Apr√®s avoir √©labor√© le script, tout devrait fonctionner pour vous.  V√©rifiez l'itin√©raire sur le client du routeur: </p><br><pre> <code class="bash hljs">mtr/traceroute telegram.org/linkedin.com</code> </pre> <br><p><img src="https://habrastorage.org/webt/wp/6e/jp/wp6ejpwtfwu9xkk-iizc8qj_aeu.gif"></p><br><h2 id="bonusom-nastroim-dnscrypt">  Bonus configurer DNSCrypt </h2><br><p>  Pourquoi?  Votre fournisseur peut soigneusement remplacer l'adresse IP de la ressource bloqu√©e, vous redirigeant ainsi vers votre adresse IP avec un talon, eh bien, notre contournement IP n'aidera pas dans ce cas.  Pour la substitution, il n'est pas toujours n√©cessaire d'utiliser le serveur DNS du fournisseur, vos demandes peuvent √™tre intercept√©es et les r√©ponses seront substitu√©es.  Eh bien, au fait, non seulement le fournisseur peut le faire. </p><br><pre> <code class="bash hljs">opkg install dnscrpt-proxy</code> </pre> <br><p>  Configurez la configuration / etc / config / dnscrypt-proxy comme ceci: </p><br><pre> <code class="bash hljs">config dnscrypt-proxy ns1 option address <span class="hljs-string"><span class="hljs-string">'127.0.0.1'</span></span> option port <span class="hljs-string"><span class="hljs-string">'5353'</span></span> option resolver <span class="hljs-string"><span class="hljs-string">'cpunks-ru'</span></span></code> </pre> <br><p>  Nous avons donc le service dnscrypt sur le port 5353 disponible sur localhost. </p><br><p>  <strong>Resolver</strong> est un serveur DNS prenant en charge le chiffrement.  Sur le routeur, le fichier /usr/share/dnscrypt-proxy/dnscrypt-resolvers.csv contient une liste des serveurs disponibles au moment de la sortie de la version install√©e de dnscrypt.  Et voici <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://dnscrypt.info/public-servers/</a> en g√©n√©ral tous les serveurs dnscrypt disponibles.  Vous pouvez choisir un autre r√©solveur et / ou ajouter des serveurs pour la tol√©rance aux pannes.  Gardez √† l'esprit que pour que DNSCrypt fonctionne avec le r√©solveur s√©lectionn√©, il doit √™tre sp√©cifi√© dans dnscrypt-resolvers.csv. </p><br><p>  Nous configurons dnsmasq pour fonctionner avec dnscrypt.  Dans / etc / config / dhcp, mettez la ligne en commentaire: </p><br><pre> <code class="bash hljs">option resolvfile <span class="hljs-string"><span class="hljs-string">'/tmp/resolv.conf.auto'</span></span></code> </pre> <br><p>  afin que les serveurs DNS du fournisseur ne soient pas impliqu√©s. </p><br><p>  Et ajoutez: </p><br><pre> <code class="bash hljs"> list server <span class="hljs-string"><span class="hljs-string">'/pool.ntp.org/208.67.222.222'</span></span> list server <span class="hljs-string"><span class="hljs-string">'127.0.0.1#5353'</span></span></code> </pre> <br><p>  L' <strong>entr√©e du serveur de liste ¬´domaine / ip_dns¬ª</strong> indique le serveur DNS √† utiliser pour r√©soudre le domaine sp√©cifi√©.  Ainsi, nous n'utilisons pas dnscrypt pour la synchronisation ntp - il est important que le service dnscrypt ait l'heure actuelle. </p><br><p><del>  Lorsque le routeur se charge, le script hirkn s'ex√©cute plus rapidement que le d√©marrage de dnscrypt, donc le domaine antifilter.download ne se r√©sout pas et les listes ne sont pas t√©l√©charg√©es.  Vous pouvez faire un retard ou autre chose √† venir, mais pour l'instant je ne vois aucune raison. </del><br>  <strong>UPD</strong> : besoin d'ajouter une ligne </p><br><pre> <code class="plaintext hljs">START=99</code> </pre> <br><p>  au script hirkn </p><br><p>  En cons√©quence, nous obtenons un tel insert dans la configuration: </p><br><pre> <code class="bash hljs"> <span class="hljs-comment"><span class="hljs-comment">#option resolvfile '/tmp/resolv.conf.auto' list server '/pool.ntp.org/208.67.222.222' list server '127.0.0.1#5353'</span></span></code> </pre> <br><p>  <strong>UPD</strong> : Sur certains appareils, DNSCrypt d√©marre quand m√™me apr√®s le script.  La mani√®re la plus simple de r√©soudre ce probl√®me consiste √† ajouter la ligne dans / etc / config / dhcp </p><br><pre> <code class="plaintext hljs"> list server '/antifilter.download/208.67.222.222'</code> </pre> <br><p>  D√©sactiver l'utilisation du fournisseur DNS pour l'interface WAN <br>  Dans / etc / config / network ajoutez la ligne </p><br><pre> <code class="plaintext hljs">option peerdns '0'</code> </pre> <br><p>  √† l'interface wan. <br>  Nous obtenons cette configuration </p><br><pre> <code class="bash hljs">config interface <span class="hljs-string"><span class="hljs-string">'wan'</span></span> option ifname <span class="hljs-string"><span class="hljs-string">'eth0.2'</span></span> option proto <span class="hljs-string"><span class="hljs-string">'dhcp'</span></span> option peerdns <span class="hljs-string"><span class="hljs-string">'0'</span></span></code> </pre> <br><p>  Red√©marrez le r√©seau </p><br><pre> <code class="plaintext hljs">/etc/init.d/network restart</code> </pre> <br><p>  Ajoutez au d√©marrage et d√©marrez dnscrypt: </p><br><pre> <code class="bash hljs">/etc/init.d/dnscrypt-proxy <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> /etc/init.d/dnscrypt-proxy start</code> </pre> <br><p>  Red√©marrez dnsmasq: </p><br><pre> <code class="bash hljs">/etc/init.d/dnsmasq restart</code> </pre> <br><p><img src="https://habrastorage.org/webt/i2/b5/90/i2b590nxr6-lqnk1h2-tq-i6t-4.gif"><br>  <em>Illustration du travail sans DNSCrypt et avec DNSCrypt</em> </p><br><h2 id="avtomaticheski-razvertyvaem-s-pomoschyu-ansible">  D√©ploy√© automatiquement avec Ansible </h2><br><p>  Playbook et mod√®les sont sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="github">github</a> .  Il utilise un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">module</a> , il n'a pas besoin de python sur le routeur et il y a un support pour uci.  J'ai essay√© de m'assurer que votre configuration OpenWrt restait intacte, mais soyez prudent quand m√™me. </p><br><p>  Installez le module gekmihesg / ansible-openwrt: </p><br><pre> <code class="bash hljs">ansible-galaxy install gekmihesg.openwrt</code> </pre> <br><p>  Copiez le playbook et tempeyta: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /etc/ansible git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/itdoginfo/ansible-openwrt-hirkn mv ansible-openwrt-hirkn/* . rm -rf ansible-openwrt-hirkn</code> </pre> <br><p>  Ajoutez votre routeur aux h√¥tes: </p><br><pre> <code class="bash hljs">[openwrt] 192.168.1.1</code> </pre> <br><p>  Remplacez vos variables dans hirkn.yml: </p><br><pre> <code class="bash hljs"> vars: ansible_template_dir: /etc/ansible/templates/ wg_server_address: wg_server_ip/url wg_private_key: privatekey-client wg_public_key: publickey-server wg_listen_port: 51820 wg_client_port: 51820 wg_client_address: 192.168.100.3/24</code> </pre> <br><p>  Assurez-vous de d√©finir: </p><br><p>  <strong>wg_server_address</strong> - serveur wireguard ip / url <br>  <strong>wg_private_key</strong> , <strong>wg_public_key</strong> - cl√© priv√©e du client et du serveur public <br>  Le reste ne peut pas √™tre chang√© ou chang√©, selon la configuration du serveur WireGuard </p><br><p>  Lancer le playbook </p><br><pre> <code class="bash hljs">ansible-playbook playbooks/hirkn.yml</code> </pre> <br><p>  Apr√®s avoir termin√© le playbook, le routeur commencera imm√©diatement √† contourner les verrous via votre serveur Wireguard. </p><br><h2 id="pochemu-ne-bgp">  Pourquoi pas BGP? </h2><br><p>  Sous openwrt, il existe deux utilitaires qui impl√©mentent BGP - quagga et bird.  Quagg je n'ai pas pu obtenir de donn√©es d'antifiltre.  Bird s'est li√© d'amiti√© avec le service √† partir d'un demi-coup de pied, mais malheureusement je n'ai pas compris comment forcer l'interface par d√©faut √† √™tre ajout√©e aux sous-r√©seaux re√ßus.  (Je serai heureux de savoir comment cela peut √™tre mis en ≈ìuvre). </p><br><p>  Dans les commentaires sur ces articles, j'ai vu que les routeurs des gens √©taient ¬´r√©fl√©chis¬ª pendant un certain temps, lorsqu'ils mettaient des listes dans la table de routage.  Avec l'impl√©mentation via ipset, mon Xiaomi mi 3G r√©fl√©chit pendant 2 secondes (Asus rt-n16 pendant 5 secondes), lorsque vous lui fournissez une liste de 15 mille sous-r√©seaux.  Avec plus de travail, je n'ai pas remarqu√© la charge sur le processeur. </p><br><p>  <em>Tous les documents ne sont pas un appel √† l'action et sont pr√©sent√©s pour se familiariser avec les fonctionnalit√©s du syst√®me d'exploitation Linux.</em> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr440030/">https://habr.com/ru/post/fr440030/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr440018/index.html">Exposition locale dynamique</a></li>
<li><a href="../fr440020/index.html">R√©gression ou r√©gression dans les tests</a></li>
<li><a href="../fr440022/index.html">Une petite Ferrari: la start-up Fintech Rally Rd vous permettra d'acheter des "parts" de voitures rares</a></li>
<li><a href="../fr440024/index.html">Rediriger printf () de STM32 vers Qt Creator Console</a></li>
<li><a href="../fr440026/index.html">Kaggle: ne peut pas marcher - courons</a></li>
<li><a href="../fr440032/index.html">Intelligence artificielle Horizon Zero Dawn</a></li>
<li><a href="../fr440034/index.html">KISS Architecture. Du microservice au monolithe</a></li>
<li><a href="../fr440036/index.html">Saisie tactile</a></li>
<li><a href="../fr440040/index.html">En d√©veloppement - chacun pour soi. Mais parfois, cela conduit √† une impasse.</a></li>
<li><a href="../fr440044/index.html">Historique d√©taill√© de Qualcomm</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>