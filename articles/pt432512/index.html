<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôâ üà∑Ô∏è ü§òüèΩ PostgreSQL: PipelineDB - consultas agregadas em tempo real üç´ üìÆ üëµüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Voc√™ j√° foi solicitado a calcular a quantidade de algo com base nos dados do banco de dados do √∫ltimo m√™s, agrupando o resultado por alguns valores e ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>PostgreSQL: PipelineDB - consultas agregadas em tempo real</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/432512/">  Voc√™ j√° foi solicitado a calcular a quantidade de algo com base nos dados do banco de dados do √∫ltimo m√™s, agrupando o resultado por alguns valores e dividindo tudo por dia / hora? <br>  Se sim - ent√£o voc√™ j√° imagina que precisa escrever algo assim, s√≥ que pior <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">hour</span></span>(datetime), somename, <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*), <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(somemetric) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> datetime &gt; :monthAgo <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre> <br>  De tempos em tempos, uma grande variedade de solicita√ß√µes come√ßa a aparecer e, se voc√™ perseverar e ajudar uma vez, infelizmente, surgir√£o recursos no futuro. <br><br>  Mas essas solicita√ß√µes s√£o ruins, pois consomem bem os recursos do sistema em tempo de execu√ß√£o, e pode haver tantos dados que mesmo uma r√©plica para essas solicita√ß√µes ser√° uma pena (e √© o tempo). <br><br>  Mas e se eu disser que, no PostgreSQL, voc√™ pode criar uma vis√£o de que apenas levar√° em conta os novos dados recebidos em uma consulta diretamente semelhante, como acima? <br><br>  Ent√£o - ele pode fazer a extens√£o PipelineDB <br><br><div class="spoiler">  <b class="spoiler_title">Demonstra√ß√£o de seu site como funciona</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/kz/5x/mb/kz5xmbjf4yjqv_ogkuhnirwu-ve.gif"><br></div></div><br><a name="habracut"></a>  O PipelineDB era anteriormente um projeto separado, mas agora est√° dispon√≠vel como uma extens√£o para o PG 10.1 e superior. <br><br>  E embora as oportunidades oferecidas existam h√° muito tempo em outros produtos projetados especificamente para coletar m√©tricas em tempo real, o PipelineDB tem uma vantagem significativa: um limite de entrada mais baixo para desenvolvedores que j√° conhecem SQL. <br><br>  Talvez para alguns n√£o seja essencial.  Pessoalmente, n√£o tenho pregui√ßa de tentar tudo o que parece adequado para resolver um problema espec√≠fico, mas n√£o vou me mexer imediatamente para usar uma nova solu√ß√£o para todos os casos.  Portanto, neste artigo, n√£o desejo descartar tudo e instalar o PipelineDB imediatamente, isso √© apenas uma vis√£o geral da funcionalidade principal, como  a coisa me pareceu curiosa. <br><br>  E assim, em geral, eles t√™m boa documenta√ß√£o, mas quero compartilhar minha experi√™ncia sobre como experimentar esse neg√≥cio na pr√°tica e trazer os resultados para a Grafana. <br><br>  Para n√£o desarrumar a m√°quina local, implanto tudo na janela de encaixe. <br>  Imagens usadas: <code>postgres:latest</code> , <code>grafana/grafana</code> <br><br><h3>  Instale o PipelineDB no Postgres </h3><br>  Em uma m√°quina com postgres, execute sequencialmente: <br><br><ol><li> <code>apt update</code> </li> <li> <code>apt install curl</code> </li> <li> <code>curl -s http://download.pipelinedb.com/apt.sh | bash</code> </li> <li> <code>apt install pipelinedb-postgresql-11</code> </li> <li> <code>cd /var/lib/postgresql/data</code> </li> <li>  Abra o arquivo <code>postgresql.conf</code> em qualquer editor </li><li>  Encontre a chave <code>shared_preload_libraries</code> , remova o coment√°rio e defina o valor <code>pipelinedb</code> </li><li>  Chave <code>max_worker_processes</code> configurada para 128 (esta√ß√µes de recomenda√ß√£o) </li><li>  Reinicialize o servidor </li></ol><br><h3>  Criando um fluxo e visualiza√ß√£o no PipelineDB </h3><br><div class="spoiler">  <b class="spoiler_title">Ap√≥s a reinicializa√ß√£o pg - observe os logs para que exista uma coisa dessas</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/xc/6i/dz/xc6idzmydyyu2qgvpu7emd7aj2i.png"><br></div></div><br><ol><li>  O banco de dados no qual trabalharemos: <code>CREATE DATABASE testpipe;</code> </li><li>  Criando uma extens√£o: <code>CREATE EXTENSION pipelinedb;</code> </li><li>  Agora, o mais interessante √© criar um fluxo.  √â nele que voc√™ precisa adicionar dados para processamento adicional: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> flow_stream ( dtmsk <span class="hljs-built_in"><span class="hljs-built_in">timestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">without</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> zone, <span class="hljs-keyword"><span class="hljs-keyword">action</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">duration</span></span> <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">SERVER</span></span> pipelinedb;</code> </pre> <br>  Na verdade, √© muito parecido com a cria√ß√£o de uma tabela comum, voc√™ n√£o pode obter dados desse fluxo com uma simples <code>select</code> - voc√™ precisa de uma visualiza√ß√£o </li><li>  na verdade, como cri√°-lo: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VIEW</span></span> viewflow <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (ttl = <span class="hljs-string"><span class="hljs-string">'3 month'</span></span>, ttl_column = <span class="hljs-string"><span class="hljs-string">'m'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">minute</span></span>(dtmsk) m, <span class="hljs-keyword"><span class="hljs-keyword">action</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*), <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">duration</span></span>)::<span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">min</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">duration</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">duration</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> flow_stream <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>;</code> </pre> <br>  Eles s√£o chamados de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Visualiza√ß√µes cont√≠nuas</a> e padronizados para se materializar, ou seja,  com preserva√ß√£o do estado. <br><br>  A <code>WITH</code> passa par√¢metros adicionais. <br><br>  No meu caso, <code>ttl = '3 month'</code> significa que voc√™ precisa armazenar dados apenas nos √∫ltimos 3 meses e pegar a data / hora da coluna <code>M</code>  O processo do <code>reaper</code> segundo plano <code>reaper</code> dados obsoletos e os exclui. <br><br>  Para quem n√£o sabe, a fun√ß√£o <code>minute</code> retorna uma data / hora sem segundos.  Assim, todos os eventos que ocorreram em um minuto ter√£o o mesmo tempo como resultado da agrega√ß√£o. </li><li>  Essa visualiza√ß√£o √© quase uma tabela, porque o √≠ndice por data para amostragem ser√° √∫til se muitos dados forem armazenados <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> viewflow (m <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">action</span></span>);</code> </pre> </li></ol><br><h3>  Usando o PipelineDB </h3><br>  Lembre-se: insira dados no fluxo e leia a partir da visualiza√ß√£o que assina <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> flow_stream <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">now</span></span>(), <span class="hljs-string"><span class="hljs-string">'act1'</span></span>, <span class="hljs-number"><span class="hljs-number">21</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> flow_stream <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">now</span></span>(), <span class="hljs-string"><span class="hljs-string">'act2'</span></span>, <span class="hljs-number"><span class="hljs-number">33</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> viewflow <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> m <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">action</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">now</span></span>()</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Eu executo a solicita√ß√£o manualmente</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/3j/rb/fy/3jrbfyanqdnf8uhrmwytpmippxa.gif"><br></div></div>  Primeiro, assisto como os dados mudam aos 46 minutos <br>  Assim que o 47¬∫ chega, o anterior para de atualizar e o minuto atual come√ßa a contar. <br><br>  Se voc√™ prestar aten√ß√£o ao plano de consulta, poder√° ver a tabela original com dados <br><br><img src="https://habrastorage.org/webt/z8/pm/fd/z8pmfdnqxflibrane_hjpmyxupa.png"><br><br>  Eu recomendo ir l√° e descobrir como seus dados s√£o realmente armazenados <br><br><div class="spoiler">  <b class="spoiler_title">Gerador de Eventos em C #</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Npgsql; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Threading; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">PipelineDbLogGenerator</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Random _rnd = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Random(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] _actions = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"foo"</span></span>, <span class="hljs-string"><span class="hljs-string">"bar"</span></span>, <span class="hljs-string"><span class="hljs-string">"yep"</span></span>, <span class="hljs-string"><span class="hljs-string">"goal"</span></span>, <span class="hljs-string"><span class="hljs-string">"ano"</span></span> }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> connString = <span class="hljs-string"><span class="hljs-string">"Host=localhost;port=5432;Username=postgres;Database=testpipe"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> conn = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NpgsqlConnection(connString)) { conn.Open(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dt = DateTime.UtcNow; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cmd = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NpgsqlCommand()) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> act = GetAction(); cmd.Connection = conn; cmd.CommandText = <span class="hljs-string"><span class="hljs-string">"INSERT INTO flow_stream VALUES (@dtmsk, @action, @duration)"</span></span>; cmd.Parameters.AddWithValue(<span class="hljs-string"><span class="hljs-string">"dtmsk"</span></span>, dt); cmd.Parameters.AddWithValue(<span class="hljs-string"><span class="hljs-string">"action"</span></span>, act); cmd.Parameters.AddWithValue(<span class="hljs-string"><span class="hljs-string">"duration"</span></span>, GetDuration(act)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> res = cmd.ExecuteNonQuery(); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">$"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{res}</span></span></span><span class="hljs-string"> </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{dt}</span></span></span><span class="hljs-string">"</span></span>); } Thread.Sleep(_rnd.Next(<span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-number"><span class="hljs-number">230</span></span>)); } } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetDuration</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> act</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> c = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; act.Length; i++) { c += act[i]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _rnd.Next(c); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetAction</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _actions[_rnd.Next(_actions.Length)]; } } }</code> </pre> <br></div></div><br><h3>  Conclus√£o em Grafana </h3><br>  Para obter dados do postgres, voc√™ precisa adicionar a fonte de dados apropriada: <br><br><img src="https://habrastorage.org/webt/_6/5s/lo/_65slonsdesxobympei4ty266es.png"><br><br>  Crie um novo painel e adicione um painel do tipo Graph a ele; depois disso, voc√™ precisar√° editar o painel: <br><br><img src="https://habrastorage.org/webt/sm/va/ca/smvacalablhaoaohk0hamjcdrv0.png"><br><br>  Pr√≥ximo - selecione uma fonte de dados, alterne para o modo de grava√ß√£o de consultas sql e digite o seguinte: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> m <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>, <span class="hljs-comment"><span class="hljs-comment">-- Grafana   time count, action from viewflow where $__timeFilter(m) --  ,     ,   col between :startdate and :enddate order by m desc, action;</span></span></code> </pre> <br>  E ent√£o voc√™ obt√©m uma programa√ß√£o normal, √© claro, se voc√™ iniciou o gerador de eventos <br><br><img src="https://habrastorage.org/webt/y-/3j/3k/y-3j3k8kzkwu_p6ipmzovycuqe0.png"><br><br>  Para sua informa√ß√£o: ter um √≠ndice pode ser muito importante.  Embora seu uso dependa do volume da tabela resultante.  Se voc√™ planeja armazenar um pequeno n√∫mero de linhas em um curto per√≠odo de tempo, pode ser muito f√°cil descobrir que a verifica√ß√£o seq ser√° mais barata e o √≠ndice adicionar√° apenas extra.  carregar ao atualizar valores <br><br>  V√°rias visualiza√ß√µes podem ser inscritas em um fluxo. <br><br>  Suponha que eu queira ver quantos m√©todos de API s√£o executados por percentis <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VIEW</span></span> viewflow_per <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (ttl = <span class="hljs-string"><span class="hljs-string">'3 d'</span></span>, ttl_column = <span class="hljs-string"><span class="hljs-string">'m'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">minute</span></span>(dtmsk) m, <span class="hljs-keyword"><span class="hljs-keyword">action</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">percentile_cont</span></span>(<span class="hljs-number"><span class="hljs-number">0.50</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">WITHIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">duration</span></span>)::<span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span> p50, <span class="hljs-keyword"><span class="hljs-keyword">percentile_cont</span></span>(<span class="hljs-number"><span class="hljs-number">0.95</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">WITHIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">duration</span></span>)::<span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span> p95, <span class="hljs-keyword"><span class="hljs-keyword">percentile_cont</span></span>(<span class="hljs-number"><span class="hljs-number">0.99</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">WITHIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">duration</span></span>)::<span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span> p99 <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> flow_stream <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> viewflow_per (m <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>);</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Eu fa√ßo o mesmo truque com grafana e obtenho:</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/rx/zx/kj/rxzxkjagevdpf_v82yx-81b3-7a.png"><br></div></div><br><h3>  Total </h3><br>  Em geral, a coisa est√° funcionando, comportou-se bem, sem queixas.  Embora sob a janela de encaixe, o download do banco de dados demo no arquivo morto (2,3 GB) acabou sendo um pouco longo. <br><br>  Quero observar - n√£o realizei testes de estresse. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Documenta√ß√£o oficial</a> <br><br><h4>  Pode ser interessante </h4><br><ul><li>  Suporte para baixar dados <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">do Apache Kafka para fluxos</a> </li><li>  Semelhante ao <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Amazon Kinesis</a> </li><li>  Voc√™ pode criar visualiza√ß√µes apenas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">para transforma√ß√£o de dados</a> (sem armazenamento) </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">PipelineDB Cluster</a> - existe uma vers√£o comercial.  Nele, voc√™ pode distribuir vistas de acordo com os shards.  Mais detalhes <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">na doca de decis√£o do cluster</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt432512/">https://habr.com/ru/post/pt432512/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt432500/index.html">Certifica√ß√£o PMP: Auditoria de Aplica√ß√£o</a></li>
<li><a href="../pt432502/index.html">A Internet pode ter s√©rios problemas devido a idiomas como C e C ++ que contribuem para vulnerabilidades</a></li>
<li><a href="../pt432506/index.html">Microsoft Connect (); 2018: todos os an√∫ncios de confer√™ncia na nuvem</a></li>
<li><a href="../pt432508/index.html">Sobre as barreiras ao uso de sistemas de sinais na intelig√™ncia artificial</a></li>
<li><a href="../pt432510/index.html">A participa√ß√£o de mercado da Noruega em ve√≠culos el√©tricos plug√°veis ‚Äã‚Äãquase atinge um novo recorde</a></li>
<li><a href="../pt432514/index.html">Reconhecendo textos sobre coisas do Android com o ABBYY RTR SDK e o django</a></li>
<li><a href="../pt432516/index.html">Amplie seus horizontes, Holmes! Ou por que os f√≠sicos precisam de um violino e habilidades culin√°rias</a></li>
<li><a href="../pt432518/index.html">El√©tron e o decl√≠nio de aplicativos nativos</a></li>
<li><a href="../pt432520/index.html">Como alterar a senha de administrador no Atlassian Jira e Confluence no banco de dados incorporado (H2)</a></li>
<li><a href="../pt432524/index.html">Por que voc√™ nunca deve usar o Quora novamente</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>