<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®‚Äçüëß‚Äçüëß üö§ üèúÔ∏è Modo sin conexi√≥n en iOS y caracter√≠sticas de su implementaci√≥n en Realm üî∞ üåÖ üë©üèª‚Äç‚öïÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Publicado por Ekaterina Semashko, Desarrollador Strong Junior iOS, DataArt 

 Un poco sobre el proyecto: una aplicaci√≥n m√≥vil para la plataforma iOS, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Modo sin conexi√≥n en iOS y caracter√≠sticas de su implementaci√≥n en Realm</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dataart/blog/432422/"><img src="https://habrastorage.org/webt/mz/rf/z2/mzrfz2k1ntkzycx5hxev_211qrc.jpeg"><br><br>  <i>Publicado por Ekaterina Semashko, Desarrollador Strong Junior iOS, DataArt</i> <br><br>  Un poco sobre el proyecto: una aplicaci√≥n m√≥vil para la plataforma iOS, escrita en Swift.  El prop√≥sito de la aplicaci√≥n es la capacidad de compartir tarjetas de descuento entre los empleados de la empresa y sus amigos. <br><br>  Uno de los objetivos del proyecto era aprender y practicar tecnolog√≠as y bibliotecas populares.  El reino fue elegido para almacenar datos locales, Alamofire se us√≥ para trabajar con el servidor, Google Sign-In se us√≥ para la autenticaci√≥n, PINRemoteImage se us√≥ para cargar im√°genes. <br><br>  Las principales funciones de la aplicaci√≥n: <br><br><ul><li>  agregar un mapa, editarlo y eliminarlo; </li><li>  ver las tarjetas de otras personas; </li><li>  buscar tarjetas por nombre de tienda / nombre de usuario; </li><li>  Agregue tarjetas a sus favoritos para un acceso r√°pido. </li></ul><br>  La capacidad de usar la aplicaci√≥n sin conectarse a la red se asumi√≥ desde el principio, pero solo en modo de lectura.  Es decir  podr√≠amos ver informaci√≥n sobre tarjetas, pero no podr√≠amos modificarlas sin Internet.  Para esto, la aplicaci√≥n siempre ten√≠a una copia de todas las tarjetas y marcas de la base de datos del servidor, adem√°s de una lista de favoritos para el usuario actual.  La b√∫squeda tambi√©n se implement√≥ localmente. <br><br>  M√°s tarde, decidimos expandirnos sin conexi√≥n agregando un modo de grabaci√≥n.  La informaci√≥n sobre los cambios realizados por el usuario se almacen√≥ y sincroniz√≥ cuando apareci√≥ una conexi√≥n a Internet.  Se discutir√° la implementaci√≥n de dicho modo fuera de l√≠nea de lectura-escritura. <a name="habracut"></a><br><br><hr><br>  ¬øQu√© es necesario para un modo sin conexi√≥n completo en una aplicaci√≥n m√≥vil?  Necesitamos eliminar la dependencia del usuario de la calidad de la conexi√≥n a Internet, en particular: <br><br><ol><li>  Elimine la dependencia de las respuestas al usuario de sus acciones en la interfaz de usuario del servidor.  En primer lugar, la solicitud interactuar√° con el almacenamiento local, luego se enviar√° al servidor. </li><li>  Marcar y almacenar cambios locales. </li><li>  Implemente un mecanismo de sincronizaci√≥n: cuando aparece una conexi√≥n a Internet, debe enviar los cambios al servidor. </li><li>  Mostrar al usuario qu√© cambios est√°n sincronizados, cu√°les no. </li></ol><br><h2>  Enfoque sin conexi√≥n primero </h2><br>  En primer lugar, tuve que cambiar el mecanismo existente para interactuar con el servidor y la base de datos.  El objetivo era evitar que el usuario dependiera de la presencia o ausencia de Internet.  En primer lugar, debe interactuar con el almac√©n de datos local y las solicitudes del servidor deben pasar a un segundo plano. <br><br>  En la versi√≥n anterior, hab√≠a una fuerte conexi√≥n entre la capa de almacenamiento de datos y la capa de red.  El mecanismo para trabajar con datos fue el siguiente: primero se realiz√≥ una solicitud al servidor a trav√©s de la clase NetworkManager, esperamos el resultado, luego los datos se guardaron en la base de datos a trav√©s de la clase Repository.  Luego, el resultado fue dado a la interfaz de usuario, como se muestra en el diagrama. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/tw/n9/8d/twn98dmriqa0uuzej10hjhntw78.png"></div><br>  Para implementar el primer enfoque fuera de l√≠nea, separ√© la capa de almacenamiento de datos y la capa de red, introduciendo una nueva clase Flow que controlaba el orden en que se llamaba NetworkManager y Repository.  Ahora los datos se guardan primero en la base de datos a trav√©s de la clase Repository, luego el resultado se env√≠a a la interfaz de usuario y el usuario contin√∫a trabajando con la aplicaci√≥n.  En segundo plano, se realiza una solicitud al servidor, despu√©s de la respuesta, se actualiza la informaci√≥n en la base de datos y la interfaz de usuario. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/wi/ru/yd/wiruyd-reybblt8x0zp1lzcgd14.png"></div><br><h2>  Trabajar con identificadores de objeto </h2><br>  Con la nueva arquitectura, aparecieron varias tareas nuevas, una de las cuales es trabajar con objetos de identificaci√≥n.  Anteriormente, los recibimos del servidor al crear el objeto.  Pero ahora el objeto se cre√≥ localmente, por lo tanto, era necesario generar una identificaci√≥n y despu√©s de la sincronizaci√≥n actualizarlos a los actuales.  Aqu√≠ me encontr√© con la primera limitaci√≥n de Realm: despu√©s de crear un objeto, no puedes cambiar su clave principal. <br><br>  La primera opci√≥n era abandonar la clave primaria en el objeto, hacer id en un campo regular.  Pero al mismo tiempo, se perdieron las ventajas de usar la clave primaria: la indexaci√≥n de dominios, que acelera la b√∫squeda del objeto, la capacidad de actualizar el objeto con el indicador de creaci√≥n (crear un objeto si no existe) y el cumplimiento de la unicidad del objeto. <br><br>  Quer√≠a guardar la clave primaria, pero no pod√≠a ser la identificaci√≥n del objeto del servidor.  Como resultado, la soluci√≥n de trabajo era tener dos identificadores, uno de ellos servidor, campo opcional, y el segundo local, que ser√≠a la clave principal. <br><br>  Como resultado, se genera una identificaci√≥n local en el cliente cuando se crea el objeto localmente, y en el caso de que el objeto provenga del servidor, es igual a la identificaci√≥n del servidor.  Dado que en la aplicaci√≥n de fuente √∫nica de verdad hay una base de datos, cuando se reciben datos del servidor, el objeto se actualiza con el identificador local actual y solo funciona con √©l.  Al enviar datos al servidor, se transmite el identificador del servidor. <br><br><h2>  Almacenamiento de cambios no sincronizados </h2><br>  Los cambios en los objetos que a√∫n no se han enviado al servidor deben almacenarse localmente.  Esto se puede implementar de las siguientes maneras: <br><br><ol><li>  Agregar campos a objetos existentes </li><li>  almacenar objetos no sincronizados en tablas separadas; </li><li>  almacenar cambios de campo individuales en alg√∫n formato. </li></ol><br><br>  No uso objetos Realm directamente en mis clases, pero hago su mapeo por mi cuenta para evitar problemas con el subprocesamiento m√∫ltiple.  Las actualizaciones autom√°ticas de la interfaz se realizan utilizando ejemplos de resultados de actualizaci√≥n autom√°tica, donde me suscribo a las solicitudes de actualizaci√≥n.  Solo el primer enfoque funcion√≥ con mi arquitectura actual, por lo que la elecci√≥n recay√≥ en agregar campos a los objetos existentes. <br><br>  El objeto del mapa ha sufrido la mayor√≠a de los cambios: <br><br><ul><li>  sincronizado: ¬øhay datos en el servidor? </li><li>  eliminado: verdadero, si la tarjeta se elimina solo localmente, se requiere sincronizaci√≥n. </li></ul><br>  Identificadores que se discutieron en la parte anterior: <br><br><ul><li>  localId: la clave principal de la entidad en la aplicaci√≥n, ya sea igual a la identificaci√≥n del servidor o generada localmente; </li><li>  serverId: identificaci√≥n del servidor. </li></ul><br>  Por separado vale la pena mencionar es el almacenamiento de im√°genes.  En esencia, el campo Attachment diskURL se agreg√≥ al campo serverURL de la imagen en el servidor, que almacena la direcci√≥n de la imagen local no sincronizada.  Al sincronizar la imagen, la local se elimin√≥ para no obstruir la memoria del dispositivo. <br><br><h2>  Sincronizaci√≥n del servidor </h2><br>  Para sincronizar con el servidor, se agreg√≥ el trabajo con Accesibilidad, para que cuando aparezca Internet, se inicie el mecanismo de sincronizaci√≥n. <br><br>  Primero, verifica si hay cambios en la base de datos que deben enviarse.  Luego, se env√≠a una solicitud al servidor para una transmisi√≥n de datos real, como resultado, los cambios que no es necesario enviar al cliente se descartan (por ejemplo, cambiar un objeto que ya se ha eliminado en el servidor).  Los cambios restantes ponen en cola las solicitudes al servidor. <br><br>  Para enviar cambios, fue posible implementar actualizaciones masivas, enviar los cambios en una matriz o hacer una solicitud grande para sincronizar todos los datos.  Pero en ese momento, el desarrollador de back-end ya estaba ocupado en otro proyecto y solo nos ayud√≥ en nuestro tiempo libre, por lo que creamos una solicitud para cada tipo de cambio. <br><br>  Implement√© la cola a trav√©s de OperationQueue y envolv√≠ cada solicitud en una operaci√≥n asincr√≥nica.  Algunas operaciones dependen unas de otras, por ejemplo, no podemos cargar la imagen del mapa antes de crear el mapa, as√≠ que agregu√© la dependencia de la operaci√≥n de la imagen a la operaci√≥n del mapa.  Adem√°s, la operaci√≥n de cargar im√°genes al servidor recibi√≥ una prioridad menor que todos los dem√°s, y las agregu√© a la cola tambi√©n duran debido a su gran peso. <br><br>  Al planificar el modo fuera de l√≠nea, la gran pregunta era resolver conflictos con el servidor durante la sincronizaci√≥n.  Pero cuando llegamos a este punto durante la implementaci√≥n, nos dimos cuenta de que el caso en que un usuario cambia los mismos datos en diferentes dispositivos es muy raro.  Por lo tanto, es suficiente para nosotros implementar el mecanismo del √∫ltimo escritor ganador.  Durante la sincronizaci√≥n, siempre se da prioridad a los cambios no enviados en el cliente, no se eliminan. <br><br>  El manejo de errores a√∫n est√° en su infancia, si la sincronizaci√≥n falla, el objeto se agregar√° a la cola de cambios la pr√≥xima vez que aparezca Internet.  Y luego, si a√∫n no se sincroniza despu√©s de la fusi√≥n, el usuario decidir√° si lo deja o lo elimina. <br><br><h2>  Soluci√≥n adicional al trabajar con Realm </h2><br>  Cuando trabajas con Realm enfrentas varios problemas m√°s.  Quiz√°s esta experiencia tambi√©n sea √∫til para alguien. <br><br>  Al ordenar por cadena, el orden va de acuerdo con el orden de los caracteres en UTF-8, no hay soporte de b√∫squeda entre may√∫sculas y min√∫sculas.  Nos enfrentamos a una situaci√≥n en la que los nombres en min√∫scula van despu√©s de los nombres en may√∫scula, por ejemplo: Im√°n, Pyaterochka, Cinta.  Si la lista es muy grande, todos los nombres en min√∫sculas estar√°n en la parte inferior, lo cual es muy desagradable. <br><br>  Para preservar el orden de clasificaci√≥n, independientemente del caso, tuvimos que introducir un nuevo campo de nombre en min√∫sculas, actualizarlo al actualizar el nombre y ordenar por √©l. <br><br>  Adem√°s, se agreg√≥ un nuevo campo para ordenar por la presencia de una tarjeta en los favoritos, ya que en esencia esto requiere una subconsulta para las relaciones del objeto. <br><br>  Al buscar en Realm, existe el m√©todo CONTAINS [c]% @ para b√∫squedas que no distinguen entre may√∫sculas y min√∫sculas.  Pero, por desgracia, solo funciona con el alfabeto latino.  Para las marcas rusas, tambi√©n tuvimos que crear campos separados y buscarlos.  Pero m√°s tarde result√≥ estar en nuestras manos excluir caracteres especiales al buscar. <br><br><hr><br>  Como puede ver, para aplicaciones m√≥viles es bastante posible implementar un modo fuera de l√≠nea con cambios de guardado y sincronizaci√≥n con poca sangre, y a veces incluso con cambios m√≠nimos en el backend. <br><br>  A pesar de algunas dificultades, puede usar Realm para implementarlo, mientras recibe todas las ventajas en forma de actualizaciones en vivo, arquitectura de copia cero y una API conveniente. <br><br>  Por lo tanto, no hay ninguna raz√≥n para negar a sus usuarios el acceso a los datos en cualquier momento, independientemente de la calidad de la conexi√≥n. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es432422/">https://habr.com/ru/post/es432422/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es432412/index.html">Highload ++: C√≥mo ayudar al sistema ERP a hacer frente a 500,000 solicitudes por segundo</a></li>
<li><a href="../es432414/index.html">Viejos secretos para la depuraci√≥n r√°pida: animaci√≥n del c√≥digo fuente</a></li>
<li><a href="../es432416/index.html">Tipos dependientes: el futuro de los lenguajes de programaci√≥n</a></li>
<li><a href="../es432418/index.html">Analizando expresiones lambda en Java</a></li>
<li><a href="../es432420/index.html">Introducci√≥n a Git Merge y Git Rebase: por qu√© y cu√°ndo usarlos</a></li>
<li><a href="../es432424/index.html">Infraestructura certificada HyperFlex para SAP HANA</a></li>
<li><a href="../es432426/index.html">Depuraci√≥n de un error que no se reproduce</a></li>
<li><a href="../es432428/index.html">Autob√∫s centralizado vs Malla de servicio: c√≥mo convertir un mitap en una batalla</a></li>
<li><a href="../es432432/index.html">La nueva tecnolog√≠a de la serie Oc√© ColorWave mejora la impresi√≥n</a></li>
<li><a href="../es432434/index.html">Los desarrolladores de Rover de pr√≥xima generaci√≥n usan IA para aumentar la eficiencia del Rover</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>