<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëêüèæ üì¨ ü¶ï √âquilibrage de charge dans Zimbra Open-Source Edition avec HAProxy ‚åõÔ∏è ü•Ñ ‚öõÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="L'une des principales t√¢ches de la construction d'infrastructures Zimbra OSE √† grande √©chelle est un √©quilibrage de charge comp√©tent. Outre le fait qu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>√âquilibrage de charge dans Zimbra Open-Source Edition avec HAProxy</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/zimbra/blog/479536/">  L'une des principales t√¢ches de la construction d'infrastructures Zimbra OSE √† grande √©chelle est un √©quilibrage de charge comp√©tent.  Outre le fait qu'il augmente la tol√©rance aux pannes du service, sans √©quilibrage de charge, il est impossible de fournir la m√™me r√©activit√© du service √† tous les utilisateurs.  Afin de r√©soudre ce probl√®me, des √©quilibreurs de charge sont utilis√©s - des solutions logicielles et mat√©rielles qui redistribuent les demandes entre les serveurs.  Parmi eux, il y en a quelques-uns plut√¥t primitifs, comme RoundRobin, qui envoie simplement chaque prochaine requ√™te au serveur suivant dans la liste, et il y en a d'autres plus avanc√©s, par exemple, HAProxy, qui est largement utilis√© dans les infrastructures informatiques tr√®s charg√©es en raison d'un certain nombre d'avantages importants.  Voyons comment les √©quilibreurs de charge HAProxy et Zimbra OSE peuvent fonctionner ensemble. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e98/93d/7d9/e9893d7d9f995c2a24dce02df7fa5d51.png" alt="image"><a name="habracut"></a><br><br>  Ainsi, selon les conditions de la t√¢che, nous avons re√ßu l'infrastructure Zimbra OSE, dans laquelle il y a deux Zimbra Proxy, deux serveurs LDAP et LDAP Replica, quatre magasins de messagerie avec 1000 bo√Ætes aux lettres sur chacun et trois MTA.  √âtant donn√© que nous avons affaire √† un serveur de messagerie, il recevra trois types de trafic qui doivent √™tre √©quilibr√©s: HTTP pour t√©l√©charger le client Web, ainsi que POP et SMTP pour envoyer des e-mails.  Dans le m√™me temps, le trafic HTTP ira aux serveurs proxy Zimbra avec les adresses IP 192.168.0.57 et 192.168.0.58, et le trafic SMTP ira aux serveurs MTA avec les adresses IP 192.168.0.77 et 192.168.0.78. <br><br>  Comme d√©j√† mentionn√©, pour assurer une distribution uniforme des demandes entre les serveurs, nous utiliserons l'√©quilibreur de charge HAProxy, qui fonctionnera sur le n≈ìud d'entr√©e de l'infrastructure Zimbra ex√©cutant Ubuntu 18.04.  L'installation de haproxy sur ce syst√®me d'exploitation se fait √† l'aide de la commande <b>sudo apt-get install haproxy</b> .  Apr√®s cela, dans le <b>fichier / etc / default / haproxy,</b> remplacez le param√®tre <b>ENABLED</b> <b>= 0</b> par <b>ENABLED = 1</b> .  Maintenant, pour vous assurer que haproxy fonctionne, entrez simplement la <b>commande service haproxy</b> .  Dans le cas o√π ce service fonctionne, il appara√Ætra clairement √† la sortie de la commande. <br><br>  L'un des principaux inconv√©nients de HAProxy est qu'il ne transmet pas par d√©faut l'adresse IP du client connect√©, la rempla√ßant par la sienne.  Cela peut conduire √† des situations o√π les e-mails envoy√©s par des attaquants ne peuvent pas √™tre identifi√©s par leur adresse IP pour l'ajouter √† la liste noire.  Cependant, ce probl√®me peut √™tre r√©solu.  Pour ce faire, √©ditez le fichier <b>/opt/zimbra/common/conf/master.cf.in</b> sur les serveurs avec Postfix et ajoutez-y les lignes suivantes: <br><br><pre><code class="plaintext hljs">26 inet n - n - 1 postscreen -o postscreen_upstream_proxy_protocol=haproxy 466 inet n - n - - smtpd %%uncomment SERVICE:opendkim%% -o content_filter=scan:[%%zimbraLocalBindAddress%%]:10030 -o smtpd_tls_wrappermode=yes -o smtpd_sasl_auth_enable=yes -o smtpd_client_restrictions= -o smtpd_data_restrictions= -o smtpd_helo_restrictions= -o smtpd_recipient_restrictions= -o smtpd_relay_restrictions=permit_sasl_authenticated,reject -o syslog_name=postfix/smtps -o milter_macro_daemon_name=ORIGINATING -o smtpd_upstream_proxy_protocol=haproxy %%uncomment LOCAL:postjournal_enabled%% -o smtpd_proxy_filter=[%%zimbraLocalBindAddress%%]:10027 %%uncomment LOCAL:postjournal_enabled%% -o smtpd_proxy_options=speed_adjust 588 inet n - n - - smtpd %%uncomment SERVICE:opendkim%% -o content_filter=scan:[%%zimbraLocalBindAddress%%]:10030 -o smtpd_etrn_restrictions=reject -o smtpd_sasl_auth_enable=%%zimbraMtaSaslAuthEnable%% -o smtpd_tls_security_level=%%zimbraMtaTlsSecurityLevel%% -o smtpd_client_restrictions=permit_sasl_authenticated,reject -o smtpd_data_restrictions= -o smtpd_helo_restrictions= -o smtpd_recipient_restrictions= -o smtpd_relay_restrictions=permit_sasl_authenticated,reject -o syslog_name=postfix/submission -o milter_macro_daemon_name=ORIGINATING -o smtpd_upstream_proxy_protocol=haproxy %%uncomment LOCAL:postjournal_enabled%% -o smtpd_proxy_filter=[%%zimbraLocalBindAddress%%]:10027 %%uncomment LOCAL:postjournal_enabled%% -o smtpd_proxy_options=speed_adjust</code> </pre> <br>  Pour cette raison, nous ouvrirons les ports 26, 466 et 588, qui recevront le trafic entrant de HAProxy.  Une fois les fichiers enregistr√©s, vous devez red√©marrer Postfix sur tous les serveurs √† l'aide de la commande zmmtactl restart. <br><br>  Apr√®s cela, commen√ßons √† configurer HAProxy.  Pour ce faire, cr√©ez d'abord une copie de sauvegarde du fichier avec les param√®tres <b>cp /etc/haproxy/haproxy.cfg /etc/haproxy/haproxy.cfg.bak</b> .  Ensuite, ouvrez le fichier source <b>/etc/haproxy/haproxy.cfg</b> dans un √©diteur de texte et commencez √† lui ajouter progressivement les param√®tres n√©cessaires.  Le premier bloc sera l'ajout d'un serveur qui supprime les journaux, la d√©finition du nombre maximal autoris√© de connexions simultan√©es, ainsi que la sp√©cification du nom et du groupe de l'utilisateur auquel le processus ex√©cutable appartiendra. <br><br><pre> <code class="plaintext hljs">global user daemon group daemon daemon log 127.0.0.1 daemon maxconn 5000 chroot /var/lib/haproxy</code> </pre> <br>  Le chiffre de 5000 connexions simultan√©es est apparu pour une raison.  Puisqu'il y a 4000 bo√Ætes aux lettres dans notre infrastructure, il est n√©cessaire de pr√©voir la probabilit√© que toutes iront √† leur courrier professionnel en m√™me temps.  De plus, vous devez laisser une petite marge au cas o√π leur nombre augmenterait. <br><br>  Ajoutez maintenant un bloc avec les param√®tres par d√©faut: <br><br><pre> <code class="plaintext hljs">defaults timeout client 1m log global mode tcp timeout server 1m timeout connect 5s</code> </pre> <br>  Dans ce bloc, le d√©lai maximal pour le client et le serveur est d√©fini afin de rompre la connexion √† son expiration, et le mode HAProxy est √©galement d√©fini.  Dans notre cas, l'√©quilibreur de charge fonctionne en mode TCP, c'est-√†-dire qu'il transmet simplement les paquets TCP sans analyser leur contenu. <br><br>  Ensuite, nous ajouterons des r√®gles pour les connexions sur diff√©rents ports.  Par exemple, si le port 25 est utilis√© pour les connexions SMTP et le transfert de courrier, il est logique de rediriger les connexions vers les MTA disponibles dans notre infrastructure.  Si la connexion est sur le port 80, il s'agit d'une demande http qui doit √™tre transmise au proxy Zimbra. <br><br>  <b>R√®gle pour le port 25:</b> <br><br><pre> <code class="plaintext hljs">frontend smtp-25 bind *:27 default_backend backend-smtp-25 backend backend-smtp-25 server mta1 192.168.0.77:26 send-proxy server mta2 192.168.0.78:26 send-proxy</code> </pre> <br>  <b>R√®gle pour le port 465:</b> <br><br><pre> <code class="plaintext hljs">frontend smtp-465 bind *:467 default_backend backend-smtp-465 backend backend-smtp-465 server mta1 192.168.0.77:466 send-proxy server mta2 192.168.0.78:466 send-proxy</code> </pre> <br>  <b>R√®gle pour le port 587:</b> <br><br><pre> <code class="plaintext hljs">frontend smtp-587 bind *:589 default_backend backend-smtp-587 backend backend-smtp-587 server mail1 192.168.0.77:588 send-proxy server mail2 192.168.0.78:588 send-proxy</code> </pre> <br>  <b>R√®gle pour le port 80:</b> <br><br><pre> <code class="plaintext hljs">frontend http-80 bind *:80 default_backend http-80 backend http-80 mode tcp server zproxy1 192.168.0.57:80 check server zproxy2 192.168.0.58:80 check</code> </pre> <br>  <b>R√®gle pour le port 443:</b> <br><br><pre> <code class="plaintext hljs">frontend https bind *:443 default_backend https-443 backend https-443 mode tcp server zproxy1 192.168.0.57:80 check server zproxy2 192.168.0.58:80 check</code> </pre> <br>  Veuillez noter que dans les r√®gles d'envoi de paquets TCP au MTA, le param√®tre <b>send-proxy</b> se trouve √† c√¥t√© de leurs adresses.  Ceci est n√©cessaire pour que, conform√©ment aux modifications que nous avons apport√©es pr√©c√©demment aux param√®tres de Postfix, l'adresse IP d'origine de son exp√©diteur soit envoy√©e avec les paquets TCP. <br><br>  Maintenant que toutes les modifications n√©cessaires ont √©t√© apport√©es √† HAProxy, vous pouvez red√©marrer le service √† l'aide de la <b>commande service haproxy restart</b> et commencer √† l'utiliser. <br><br>  Pour toutes questions relatives √† la Suite Zextras, vous pouvez contacter la repr√©sentante de Zextras, Ekaterina Triandafilidi, par e-mail katerina@zextras.com </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr479536/">https://habr.com/ru/post/fr479536/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr479518/index.html">La communication au sein d'une √©quipe √† distance est notre exp√©rience</a></li>
<li><a href="../fr479522/index.html">Editeur Peter. Soldes d'hiver</a></li>
<li><a href="../fr479524/index.html">Service pour Active Restore ou l'histoire d'un projet industriel √† Innopolis</a></li>
<li><a href="../fr479530/index.html">Syst√®me de coordonn√©es ultrasonique 2.0</a></li>
<li><a href="../fr479534/index.html">Kubernetes 1.17 - Comment mettre √† niveau et ne pas d√©penser tout le budget d'erreur</a></li>
<li><a href="../fr479538/index.html">La technologie entra√Æne le d√©clin de l'humanit√©. Il est temps de changer quelque chose</a></li>
<li><a href="../fr479540/index.html">Utilisation de passwordstore.org - Gestionnaire de mots de passe de style KISS</a></li>
<li><a href="../fr479542/index.html">Comment √©crire votre propre translitt√©rateur</a></li>
<li><a href="../fr479548/index.html">Le chemin des stages aux performances √† HighLoad 2019</a></li>
<li><a href="../fr479550/index.html">MVC dans Unity avec des objets scriptables. 3e partie</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>