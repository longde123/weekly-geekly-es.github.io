<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ“ƒ ğŸ‘¨ğŸ¼â€âœˆï¸ ğŸ‘ƒğŸ¾ PM2: mendekati masalah manajemen proses dengan bijak ğŸ˜­ ğŸ­ ğŸ§™</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hanya beberapa jam yang lalu, saya memulai perdebatan tentang fakta bahwa Node.JS terlalu lambat untuk proyek-proyek besar dan seharusnya lebih suka G...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>PM2: mendekati masalah manajemen proses dengan bijak</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/480670/"> Hanya beberapa jam yang lalu, saya memulai perdebatan tentang fakta bahwa Node.JS terlalu lambat untuk proyek-proyek besar dan seharusnya lebih suka Golang, Rust, PHP, dll.  Argumen utama dari sisi yang berlawanan dalam perselisihan ini adalah fakta bahwa JavaScript adalah single-threaded.  Diduga, ketika mengembangkan aplikasi, kinerja hanya bertumpu pada single-threadedness ini dan tidak ada yang bisa dilakukan lagi - hanya menulis ulang dalam beberapa bahasa lain.  Namun, hal-hal sedikit lebih baik dengan NodeJS daripada yang terlihat pada pandangan pertama.  Sebelum kita membahas topik ini, saya ingin menyatakan bahwa saya menghormati hak setiap pengembang untuk menggunakan bahasa pemrograman yang ia sukai dan yang menurutnya lebih disukai dalam tugas tertentu. <br><br>  Setelah melakukan pencarian dengan kata kunci "PM2" di Habr, saya tidak menemukan artikel yang ditujukan untuk manajer proses ini.  Hanya satu referensi dalam artikel pengguna lain.  Saya menjadi bersemangat (sangat diceritakan) dengan gagasan untuk mengejar dan menjelaskan sudut gelap pengembangan backend di Node.JS (yang banyak orang tahu, ya, saya sadar).  Saya meminta semua orang tertarik pada kucing. <br><br><a name="habracut"></a><br><br><h2>  Beberapa kata tentang PM2 itu sendiri </h2><br><br>  PM2 adalah manajer proses sumber terbuka yang dilisensikan di bawah lisensi AGPL-3.0.  Pada saat penulisan, ini memiliki ~ 350k unduhan mingguan, menurut NPM.  Ini terutama digunakan dalam lingkungan di mana Anda perlu menjalankan aplikasi pada NodeJS dan melupakannya (Anda juga dapat menggunakannya dengan bahasa lain, tetapi lebih lanjut tentang itu nanti), yang memungkinkan Anda untuk mengelompokkan aplikasi dan secara fleksibel mendistribusikan beban antara inti prosesor.  Kliping kecil dari <a href="https://github.com/Unitech/pm2" rel="nofollow">repositori PM2 di GitHub</a> : <br><br><blockquote>  PM2 adalah manajer proses produksi untuk aplikasi Node.js dengan penyeimbang beban bawaan.  Ini memungkinkan Anda untuk menjaga aplikasi tetap hidup selamanya, memuatnya kembali tanpa downtime dan untuk memudahkan tugas-tugas admin sistem umum. </blockquote><br><br>  Ketika berkembang, banyak pendatang baru menghadapi masalah ketika, setelah "meluncurkan" aplikasi ke server produksi, mereka tidak tahu bagaimana meluncurkannya "selamanya".  Mereka menulis <code>set NODE_ENV=production &amp;&amp; node app.js</code> di konsol SSH, semuanya baik-baik saja, aplikasi berfungsi.  Tutup konsol dan aplikasi tidak lagi berfungsi.  Pertanyaan StackOverflow - <a href="https://stackoverflow.com/questions/12701259/how-to-make-a-node-js-application-run-permanently" rel="nofollow">Bagaimana menjalankan aplikasi node.js secara permanen?</a>  mencetak lebih dari 237 ribu tampilan sepanjang masa. <br><br>  PM2 memecahkan masalah ini dengan satu perintah: <br><br><pre> <code class="bash hljs">pm2 start app.js</code> </pre> <br><br>  Perintah ini "mendemonstrasikan" (dari bahasa Inggris "daemonize") proses NodeJS, memantau konsumsi memorinya dan mempertimbangkan beban prosesor. <br><br><h2>  Kembali ke domba jantan kita </h2><br><br>  Ketika beban pada backend bertambah, menjadi perlu untuk menskalakannya - baik vertikal maupun horizontal - kepada siapa ia lebih nyaman dalam situasi tersebut.  Seperti yang kita ketahui, satu proses dapat menggunakan beberapa inti prosesor, tetapi hanya jika ada beberapa untaian di dalam proses.  Dalam aplikasi NodeJS, alirannya adalah satu.  PM2 dapat membantu dalam situasi ini dan mendistribusikan beban antara beberapa inti prosesor.  Masih hanya dengan satu perintah: <br><br><pre> <code class="plaintext hljs">pm2 start app.js -i max</code> </pre> <br><br>  Dalam hal ini, parameter <i>maks</i> sesuai dengan jumlah inti prosesor.  Yaitu  8 proses terpisah akan dibuat untuk prosesor 8-core.  Anda juga dapat mengatur <i>-1</i> bukannya <i>max,</i> dan kemudian jumlah proses akan sesuai dengan <i>jumlah</i> core <i>minus 1</i> .  Semua pesona adalah bahwa koneksi HTTP (S) / Websocket / TCP / UDP akan didistribusikan secara merata di antara proses-proses ini.  Mengapa tidak penskalaan horizontal?  Anda dapat membaca lebih lanjut tentang pengelompokan di PM2 di sini - <a href="https://pm2.keymetrics.io/docs/usage/cluster-mode/" rel="nofollow">Mode Cluster PM2</a> . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a46/084/b81/a46084b8119afc457b9d0692678fe7f9.png" alt="cluster_mode"><br><br>  Anda dapat menjalankan sebanyak mungkin proses sesuai keinginan, tetapi tetap disarankan untuk mematuhi rekomendasi "satu proses per inti". <br><br><h3>  Menghormati memori </h3><br>  Ketika berkembang di PHP, saya pernah mengalami masalah.  Karena tidak berpengalaman, ia secara tidak sadar meletakkan bug di mesin sistem, karena itu, dalam kondisi tertentu, proses mulai memakan terlalu banyak RAM.  Selain itu, prosesor dimuat, karena itu mesin virtual baru saja menutup dan saya tidak memiliki akses sama sekali. <br>  Seperti yang diketahui pengembang PHP, di PHP-FPM Anda dapat menentukan jenis distribusi proses (jika Anda tiba-tiba tidak tahu, maka dalam PHP-FPM proses baru dibuat untuk setiap permintaan baru) - statis, ketika ambang minimum dan maksimum ditetapkan, dan dinamis - alokasi berapa banyak sebanyak proses besar yang diperlukan.  Apa yang akan terjadi pada PM2 jika Anda memulai 8 proses dan semuanya mulai memakan banyak memori?  Dan PM2 dapat menyelesaikan masalah ini - hanya dengan satu parameter pada baris perintah: <br><br><pre> <code class="plaintext hljs"># Set memory threshold for app reload pm2 start app.js -i max --max-memory-restart &lt;200MB&gt;</code> </pre><br><br>  Setiap kali batas memori tercapai, PM2 akan secara otomatis memulai kembali proses.  Mendistribusikan memori lebih mudah daripada proses, bukan?  8 proses * 200 megabita = 1,6 gigabita.  Matematika kelas dua. <br><br>  Selain memulai kembali proses, Anda juga dapat mengonfigurasi memulai kembali setelah interval waktu N.  Saya belum menemukan dalam kasus mana ini bisa berguna, tetapi jangan ragu untuk menunjukkan kepada saya beberapa contoh di komentar :) <br><br><h3>  Dan jika saya me-reboot mesin virtual? </h3><br>  Kejutan-kejutan!  PM2 juga memecahkan masalah ini untuk Anda.  Masih dengan tidak lebih dari satu perintah tunggal di konsol: <br><br><pre> <code class="plaintext hljs">pm2 startup</code> </pre> <br><br>  PM2 akan menghasilkan skrip yang akan meningkatkan semua proses yang diperlukan ketika sistem operasi dimulai.  Namun, Anda harus waspada - ketika meningkatkan versi Node.JS semuanya bisa rusak.  Untuk menghindari ini, setelah memutakhirkan ke versi baru Node.JS berhasil, jalankan <code>pm2 unstartup</code> dan <code>pm2 startup</code> .  Anda dapat membaca lebih lanjut tentang ini di tautan - <a href="https://pm2.keymetrics.io/docs/usage/startup/" rel="nofollow">PM2 Startup Script Generator</a> . <br><br><h3>  Apakah perlu untuk memulai kembali kluster secara manual saat membuat perubahan? </h3><br>  Tentu tidak!  Ya, lebih tepatnya, Anda, tentu saja, dapat memulai ulang aplikasi secara manual, tetapi mengapa?  Otomatisasi semua yang Anda bisa dan semoga kekuatan datang bersama Anda! <br><br><pre> <code class="plaintext hljs">pm2 start env.js --watch --ignore-watch="node_modules"</code> </pre> <br><br>  Anda bisa menggunakan ini saat menggabungkan cabang master dalam repositori lokal dengan cabang master dari repositori jarak jauh.  Dalam proyek sampingan saya, ini dilakukan secara sederhana - <code>git pull origin master &amp;&amp; npm run build</code> .  Saat mengubah file di <i>server / build</i> dan folder <i>klien / build</i> , proses akan dimulai kembali secara otomatis.  Saya mengerti ini adalah fitur yang sangat sederhana dan bahkan tidak layak disebutkan dalam teks ini.  Saya akan mencairkannya dengan sesuatu yang serius dan menulis bahwa jika Anda menggunakan pengelompokan, maka semua proses akan dimulai kembali secara bergantian.  Ya, sehingga setidaknya satu dari mereka akan selalu tersedia.  Ini adalah penerapan zero-downtime! <br><br>  Dan Anda tidak dapat memulai kembali proses.  Ada reload untuk ini (mirip dengan nginx reload): <br><br><pre> <code class="plaintext hljs">pm2 reload all</code> </pre> <br><br><h3>  Terlalu banyak tim!  Secara umum, saya lebih suka konfigurasi </h3><br>  Saya sudah bosan membuat frasa lucu, jadi sederhana dan dangkal: ada file ekosistem.  Format yang didukung adalah JSON, YAML dan JS.  Misalnya, ketika Anda perlu memonitor file di folder <i>server</i> dan <i>klien</i> : <br><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { <span class="hljs-attr"><span class="hljs-attr">apps</span></span>: [{ <span class="hljs-attr"><span class="hljs-attr">script</span></span>: <span class="hljs-string"><span class="hljs-string">"app.js"</span></span>, <span class="hljs-attr"><span class="hljs-attr">watch</span></span>: [<span class="hljs-string"><span class="hljs-string">"server"</span></span>, <span class="hljs-string"><span class="hljs-string">"client"</span></span>], <span class="hljs-attr"><span class="hljs-attr">env_production</span></span> : { <span class="hljs-string"><span class="hljs-string">"NODE_ENV"</span></span>: <span class="hljs-string"><span class="hljs-string">"production"</span></span> } }] }</code> </pre><br><br>  Untuk informasi lebih lanjut, lihat tautan - <a href="https://pm2.keymetrics.io/docs/usage/application-declaration/" rel="nofollow">Deklarasi Aplikasi PM2</a> . <br><br><h3>  Dan bahkan pemantauan! </h3><br>  Dan bukan satu.  Pilih yang paling Anda sukai.  Anda dapat memonitor di konsol dengan perintah: <br><br><pre> <code class="plaintext hljs">pm2 monit</code> </pre> <br><br><img src="https://habrastorage.org/webt/8l/y-/c9/8ly-c9ljx5qjvxscgu1nagmycrg.png"><br><br>  Atau gunakan versi pemantauan berbasis web lengkap: <br><br><img src="https://habrastorage.org/webt/0q/u4/mt/0qu4mtcxqhdqd9ysabk5xelvzns.png"><br><br>  Anda, tentu saja, tidak akan mempercayai saya, tetapi itu diinstal dan diluncurkan dengan <b>satu</b> perintah: <br><br><pre> <code class="plaintext hljs">pm2 plus</code> </pre> <br><br><h3>  Dan masih banyak lagi ... </h3><br>  Menyatakan dukungan untuk Heroku dan Docker, peningkatan port otomatis dengan kemampuan transfer ke <code>process.env</code> (ketika Anda perlu menjalankan setiap proses pada port terpisah), peluncuran beberapa instance PM2 dalam OS yang sama, kehadiran API perangkat lunak dan kemampuan untuk menjalankan skrip Bash dan Python yang di-iblis! <br><br>  Saya mungkin melewatkan sesuatu yang penting atau menarik, yang selalu dapat Anda ingatkan dalam komentar.  Saya harap Anda dapat mempelajari sesuatu yang baru dari artikel ini. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id480670/">https://habr.com/ru/post/id480670/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id480654/index.html">Akankah Julia mengalahkan Python seperti halnya Python yang dilakukan Java</a></li>
<li><a href="../id480658/index.html">1C - Baik dan jahat. Penempatan titik dalam holivar sekitar 1C</a></li>
<li><a href="../id480660/index.html">Memvisualisasikan penarik aneh di Plotly adalah sebuah mahakarya</a></li>
<li><a href="../id480664/index.html">Proyek ELISA: Linux dalam Sistem Keselamatan-Kritis</a></li>
<li><a href="../id480668/index.html">WTF per Jam</a></li>
<li><a href="../id480672/index.html">Paradoks Einstein - Podolsky - Rosen di jari dan ... apa hubungannya eter dengan itu</a></li>
<li><a href="../id480674/index.html">Menguji server virtual dari DigitalOcean, Vultr, Linode dan Hetzner. Korban manusia: 0,0</a></li>
<li><a href="../id480680/index.html">Strategi pertahanan NGINX dan permintaan ke Igor Sysoev</a></li>
<li><a href="../id480682/index.html">Intel RealSense LiDAR L515 - RealSense Baru Lainnya</a></li>
<li><a href="../id480684/index.html">Kepingan Salju StarWars DIY (pembaruan 2019)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>