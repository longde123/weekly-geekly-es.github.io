<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üåµ üßùüèø üîÄ Outil de refactoring personnalis√©: Swift üë©‚Äç‚ù§Ô∏è‚Äçüë© ‚öôÔ∏è üè≠</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Tout ing√©nieur s'efforce de rendre son processus de travail aussi optimis√© que possible. En tant que d√©veloppeurs iOS mobiles, nous devons tr√®s souven...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Outil de refactoring personnalis√©: Swift</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/sberbank/blog/460227/">  Tout ing√©nieur s'efforce de rendre son processus de travail aussi optimis√© que possible.  En tant que d√©veloppeurs iOS mobiles, nous devons tr√®s souvent travailler avec des structures linguistiques uniformes.  Apple am√©liore les outils de d√©veloppement en mettant beaucoup d'efforts pour nous faciliter la programmation: la mise en √©vidence du langage, les m√©thodes de compl√©tion automatique et de nombreuses autres fonctionnalit√©s IDE permettent √† nos doigts de suivre le rythme des id√©es dans nos t√™tes. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4b6/69d/e24/4b669de249e57f8f8d7ad2da21df22a3.png"><br><br>  Que fait un ing√©nieur lorsque l'outil requis est manquant?  Certes, il fera tout lui-m√™me!  Plus t√¥t, nous avons <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">parl√©</a> de la cr√©ation de nos outils personnalis√©s, maintenant parlons de la fa√ßon de modifier Xcode et de le faire fonctionner selon vos r√®gles. <br><a name="habracut"></a><br>  Nous avons pris la t√¢che de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">JIRA Swift</a> et cr√©√© un outil qui se transforme <b>s'il est laiss√©</b> en une construction de <b>garde</b> √©quivalente. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d68/6b7/ad5/d686b7ad5d24b87b61df2bb6d87299eb.gif"><br><br>  Depuis la neuvi√®me version, Xcode fournit un nouveau m√©canisme de refactorisation qui peut convertir le code localement, dans le m√™me fichier source Swift, ou globalement lorsque vous renommez une m√©thode ou une propri√©t√© qui se produit dans plusieurs fichiers, m√™me si elles sont dans des langues diff√©rentes. <br><br>  Le refactoring local est enti√®rement impl√©ment√© dans le compilateur et le framework SourceKit, la fonctionnalit√© est situ√©e dans le r√©f√©rentiel Swift open source et est √©crite en C ++.  La modification du refactoring global est actuellement inaccessible aux gens ordinaires, car la base de code Xcode est ferm√©e.  Par cons√©quent, nous allons nous attarder sur l'histoire locale et parler de la fa√ßon de r√©p√©ter notre exp√©rience. <br><br>  Ce dont vous avez besoin pour cr√©er votre propre outil de refactoring local: <br><br><ol><li>  Comprendre C ++ <br></li><li>  Connaissance de base du compilateur <br></li><li>  Comprendre ce qu'est l'AST et comment l'utiliser <br></li><li>  Code source <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Swift</a> <br></li><li>  Guide <a href="">swift / docs / refactoring / SwiftLocalRefactoring.md</a> <br></li><li>  Beaucoup de patience <br></li></ol><br><h2>  Un peu sur l'AST </h2><br>  Un peu de bases th√©oriques avant de plonger dans la pratique.  Voyons comment fonctionne l'architecture du compilateur Swift.  Tout d'abord, le compilateur est responsable de la transformation du code en code machine ex√©cutable. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/00b/9e7/f23/00b9e7f23d9d1c1b3e02d14905179ef2.png"><br><br>  Parmi les √©tapes de transformation pr√©sent√©es, la plus int√©ressante pour nous est la g√©n√©ration d'un arbre de syntaxe abstraite (AST) - un graphique dans lequel les sommets sont des op√©rateurs et les feuilles sont leurs op√©randes. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/350/269/29f/35026929fee03914b2689ee5b20fa6f8.png"><br><br>  Les arbres de syntaxe sont utilis√©s dans l'analyseur.  AST est utilis√© comme repr√©sentation interne dans le compilateur / interpr√®te d'un programme informatique pour optimiser et g√©n√©rer du code. <br><br>  Une fois l'AST g√©n√©r√©, l'analyse est effectu√©e pour cr√©er l'AST avec une v√©rification de type qui a √©t√© traduite dans le Swift Intermediate Language.  SIL est converti, optimis√©, d√©class√© en LLVM IR, qui se compile finalement en code machine. <br><br>  Pour cr√©er un outil de refactoring, nous devons comprendre AST et √™tre capable de travailler avec lui.  Ainsi, l'outil pourra fonctionner correctement avec les parties du code que nous voulons traiter. <br><br>  Pour g√©n√©rer l'AST d'un fichier, ex√©cutez la commande: swiftc -dump-ast <i>MyFile.swift</i> <i><br><br></i>  <i>Vous trouverez ci-dessous la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sortie vers la console</a> AST <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">de</a> la fonction <b>if let</b> , mentionn√©e pr√©c√©demment.</i> <i><br><br><img src="https://habrastorage.org/getpro/habr/post_images/901/276/7b6/9012767b6955ddd58dfc221181e8a70b.png"></i> <br><br>  Il existe trois principaux types de n≈ìuds dans Swift AST: <br><br><ul><li>  d√©clarations (sous-classes de type Decl), <br></li><li>  expressions (sous-classes de type Expr), <br></li><li>  op√©rateurs (sous-classes de type Stmt). <br></li></ul><br>  Ils correspondent aux trois entit√©s utilis√©es dans la langue swift elle-m√™me.  Les noms des fonctions, structures, param√®tres sont des d√©clarations.  Les expressions sont des entit√©s qui renvoient une valeur;  par exemple, appeler des fonctions.  Les op√©rateurs font partie du langage qui d√©finissent le flux de contr√¥le de l'ex√©cution du code, mais ne renvoient pas de valeur (par exemple, if ou do-catch). <br><br>  Il s'agit d'un minimum suffisant que vous devez conna√Ætre AST pour votre prochain travail. <br><br><h2>  Fonctionnement th√©orique de l'outil de refactoring </h2><br>  Pour impl√©menter des outils de refactoring, vous avez besoin d'informations sp√©cifiques sur la zone du code que vous allez modifier.  Les d√©veloppeurs disposent d'entit√©s auxiliaires qui accumulent des donn√©es.  Le premier, ResolvedCursorInfo (refactoring bas√© sur le curseur), vous indique si nous sommes au d√©but d'une expression.  Si tel est le cas, l'objet de compilation correspondant √† cette expression est renvoy√©.  La deuxi√®me entit√©, RangeInfo (refactoring bas√© sur la plage), encapsule les donn√©es sur la plage d'origine (par exemple, combien de points d'entr√©e et de sortie elle poss√®de). <br><br>  Le refactoring bas√© sur le curseur est initi√© par l'emplacement du curseur dans le fichier source.  Les actions de refactoring impl√©mentent les m√©thodes que le m√©canisme de refactoring utilise pour afficher les actions disponibles dans l'EDI et pour effectuer des transformations.  Exemples d'actions bas√©es sur le curseur: Aller √† la d√©finition, aide rapide, etc. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/fce/30f/c9d/fce30fc9de1ab5b473ff9ac14795c462.png"><br><br>  Consid√©rez les actions habituelles du c√¥t√© technique: <br><br><ol><li>  Lorsque vous s√©lectionnez un emplacement dans l'√©diteur Xcode, une demande est faite √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sourcekitd</a> (le framework responsable de la mise en √©vidence, de l'ach√®vement du code, etc.) pour afficher les actions de refactoring disponibles. <br></li><li>  Chaque action disponible est demand√©e par l'objet ResolvedCursorInfo pour v√©rifier si cette action s'applique au code s√©lectionn√©. <br></li><li>  La liste des actions applicables est renvoy√©e comme r√©ponse de sourcekitd et affich√©e dans Xcode. <br></li><li>  Xcode applique ensuite les modifications √† l'outil de refactoring. <br></li></ol><br>  Le refactoring bas√© sur la plage est initi√© en s√©lectionnant une plage continue de code dans le fichier source. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/670/987/f65/670987f65cedaec71b072c3d2c721315.png"><br><br>  Dans ce cas, l'outil de refactoring passera par une cha√Æne d'appel similaire d√©crite.  La diff√©rence est que lorsqu'elle est impl√©ment√©e, l'entr√©e est RangeInfo au lieu de ResolvedCursorInfo.  Les lecteurs int√©ress√©s peuvent se r√©f√©rer √† <a href="">Refactoring.cpp</a> pour plus d'informations sur les exemples de la bo√Æte √† outils Apple. <br><br>  Et maintenant √† la pratique de la cr√©ation d'un outil. <br><br><h2>  La pr√©paration </h2><br>  Tout d'abord, vous devez t√©l√©charger et construire le compilateur Swift.  Des instructions d√©taill√©es se trouvent dans le r√©f√©rentiel officiel ( <a href="">readme.md</a> ).  Voici les raccourcis clavier pour le clonage de code: <br><br><pre><code class="swift hljs">mkdir swift-source cd swift-source git clone https:<span class="hljs-comment"><span class="hljs-comment">//github.com/apple/swift.git ./swift/utils/update-checkout --clone</span></span></code> </pre> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Cmake est</a> utilis√© pour d√©crire la structure et les d√©pendances du projet.  En l'utilisant, vous pouvez g√©n√©rer un projet pour Xcode (plus pratique) ou pour ninja (plus rapide) gr√¢ce √† l'une des commandes: <br><br><pre> <code class="swift hljs">./utils/build-script --debug --xcode</code> </pre> <br>  ou <br><pre> <code class="swift hljs">swift/utils/build-script --debug-debuginfo</code> </pre> <br>  Une compilation r√©ussie n√©cessite la derni√®re version de Xcode beta (10.2.1 au moment de la r√©daction) - disponible sur le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">site officiel d'Apple</a> .  Pour utiliser le nouveau Xcode pour construire le projet, vous devez enregistrer le chemin √† l'aide de l'utilitaire xcode-select: <br><br><pre> <code class="bash hljs">sudo xcode-select -s /Users/username/Xcode.app</code> </pre> <br>  Si nous avons utilis√© l'indicateur --xcode pour construire le projet pour Xcode, respectivement, puis apr√®s plusieurs heures de compilation (nous en avons eu un peu plus de deux) dans le dossier de construction, nous trouverons le fichier Swift.xcodeproj.  En ouvrant le projet, nous verrons le Xcode familier avec l'indexation, les points d'arr√™t. <br><br>  Pour cr√©er un nouvel instrument, nous devons ajouter le code avec la logique de l'instrument au fichier: lib / IDE / Refactoring.cpp et d√©finir deux m√©thodes isApplicable et performChange.  Dans la premi√®re m√©thode, nous d√©cidons de g√©n√©rer ou non l'option de refactorisation pour le code s√©lectionn√©.  Et dans le second - comment convertir le code s√©lectionn√© pour appliquer le refactoring. <br><br>  Une fois la pr√©paration effectu√©e, il reste √† mettre en ≈ìuvre les √©tapes suivantes: <br><br><ol><li>  D√©velopper la logique de l'outil (le d√©veloppement peut se faire de plusieurs mani√®res - via la cha√Æne d'outils, via Ninja, via Xcode; toutes les options seront d√©crites ci-dessous) <br></li><li>  Impl√©mentez deux m√©thodes: isApplicable et performChange (ils sont responsables de l'acc√®s √† l'outil et de son fonctionnement) <br></li><li>  Diagnostiquez et testez l'outil termin√© avant d'envoyer le PR au r√©f√©rentiel Swift officiel. <br></li></ol><br><h2>  Tester le fonctionnement de l'outil via la cha√Æne d'outils </h2><br>  Cette m√©thode de d√©veloppement vous prendra beaucoup de temps en raison du long assemblage des composants, mais le r√©sultat est imm√©diatement visible dans Xcode - la fa√ßon de le v√©rifier manuellement. <br><br>  Pour commencer, construisons la cha√Æne d'outils Swift √† l'aide de la commande: <br><br><pre> <code class="plaintext hljs">./utils/build-toolchain some_bundle_id</code> </pre> <br>  La compilation de la cha√Æne d'outils prendra encore plus de temps que la compilation du compilateur et des d√©pendances.  La sortie est le fichier swift-LOCAL-yyyy-mm-dd.xctoolchain du dossier swift-nightly-install, que vous devez transf√©rer vers Xcode: / Library / Developer / Toolchains /.  Ensuite, dans les param√®tres IDE, s√©lectionnez la nouvelle cha√Æne d'outils, red√©marrez Xcode. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b67/402/ead/b67402ead1fd1e4470886c8a8ad2f3c2.png"><br><br>  S√©lectionnez un morceau de code que l'outil doit traiter et recherchez l'outil dans le menu contextuel. <br><br><h2>  D√©veloppement par des tests avec Ninja </h2><br>  Si le projet a √©t√© construit pour Ninja et que vous avez choisi la voie TDD, le d√©veloppement par des tests avec Ninja est l'une des options qui vous conviendra.  Inconv√©nients - vous ne pouvez pas d√©finir de points d'arr√™t, comme dans le d√©veloppement via Xcode. <br><br>  Nous devons donc v√©rifier que le nouvel outil est affich√© dans Xcode lorsque l'utilisateur s√©lectionne la construction de garde dans le code source.  Nous √©crivons le test dans le fichier test / refactoring / RefactoringKind / basic.swift existant: <br><br><pre> <code class="swift hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testConvertToGuardExpr</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(idxOpt: Int?)</span></span></span></span> {    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> idx = idxOpt {        <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(idx)    } } <span class="hljs-comment"><span class="hljs-comment">//     . // RUN: %refactor -source-filename %s -pos=266:3 -end-pos=268:4 | %FileCheck %s -check-prefix=CHECK-CONVERT-TO-GUARD-EXPRESSION // CHECK-CONVERT-TO-GUARD-EXPRESSION: Convert To Guard Expression</span></span></code> </pre> <br><br>  Nous indiquons que lors de la mise en √©vidence du code entre 266 colonnes de ligne 3 et 268 colonnes de ligne 4, nous nous attendons √† l'apparition d'un √©l√©ment de menu avec un nouvel outil. <br><br>  L'utilisation du script <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">lit.py</a> peut fournir une r√©troaction plus rapide √† votre cycle de d√©veloppement.  Vous pouvez sp√©cifier la combinaison de test qui vous int√©resse.  Dans notre cas, cette suite sera RefactoringKind: <br><br> <code>./llvm/utils/lit/lit.py -sv ./build/Ninja-RelWithDebInfoAssert/swift-macosx-x86_64/test-macosx-x86_64/refactoring/RefactoringKind/</code> <br>  Par cons√©quent, les tests de ce fichier uniquement seront lanc√©s.  Leur mise en ≈ìuvre prendra quelques dizaines de secondes.  Plus d'informations sur lit.py seront discut√©es plus loin dans la section Diagnostics et tests. <br>  Le test √©choue, ce qui est normal pour le paradigme TDD.  Apr√®s tout, jusqu'√† pr√©sent, nous n'avons pas √©crit une seule ligne de code avec la logique de l'outil. <br><br><h2>  D√©veloppement par d√©bogage et Xcode </h2><br>  Et enfin, la derni√®re m√©thode de d√©veloppement lorsque le projet a √©t√© construit sous Xcode.  Le principal avantage est la possibilit√© de d√©finir des points d'arr√™t et de contr√¥ler le d√©bogage. <br><br>  Lors de la cr√©ation d'un projet sous Xcode, le fichier Swift.xcodeproj est cr√©√© dans le dossier build / Xcode-DebugAssert / swift-macosx-x86_64 /.  Lorsque vous ouvrez ce fichier pour la premi√®re fois, il est pr√©f√©rable de choisir de cr√©er des sch√©mas manuellement pour g√©n√©rer ALL_BUILD et swift-refactor vous-m√™me: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f7d/7cb/458/f7d7cb4587c345d03bc77fc62cd615a9.png"><br><br>  Ensuite, nous construisons le projet avec ALL_BUILD une fois, apr√®s quoi nous utilisons le sch√©ma swift-refactor. <br><br>  L'outil de refactorisation est compil√© dans un fichier ex√©cutable distinct - swift-refactor.  L'aide de ce fichier peut √™tre affich√©e √† l'aide de l'indicateur ‚Äìhelp.  Les param√®tres les plus int√©ressants pour nous sont: <br><br><pre> <code class="swift hljs">-source-filename=&lt;string&gt; <span class="hljs-comment"><span class="hljs-comment">//   -pos=&lt;string&gt; //   -end-pos=&lt;string&gt; //   -kind //  </span></span></code> </pre> <br>  Ils peuvent √™tre sp√©cifi√©s dans le sch√©ma comme arguments.  Vous pouvez maintenant d√©finir des points d'arr√™t pour qu'ils s'arr√™tent aux endroits d'int√©r√™t lors du d√©marrage de l'outil.  De la mani√®re habituelle, en utilisant les commandes <i>p</i> et <i>po</i> dans la console Xcode, affiche les valeurs des variables correspondantes. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/329/254/23c/32925423cba91d5951178b9be63a70d5.png"><br><br><h2>  Impl√©mentation IsApplicable </h2><br>  La m√©thode isApplicable accepte un ResolvedRangeInfo avec des informations sur les n≈ìuds AST du fragment de code s√©lectionn√© √† l'entr√©e.  En sortie de la m√©thode, il est d√©cid√© d'afficher ou non l'outil dans le menu contextuel Xcode.  L'interface ResolvedRangeInfo compl√®te se trouve dans le <a href="">fichier include / swift / IDE / Utils.h</a> . <br><br>  Consid√©rez les champs de la classe ResolvedRangeInfo qui sont les plus utiles dans notre cas: <br><br><ul><li>  RangeKind - la premi√®re chose √† faire est de v√©rifier le type de la zone s√©lectionn√©e.  Si la zone n'est pas valide (non valide), vous pouvez retourner false.  Si le type nous convient, par exemple, SingleStatement ou MultiStatement, alors continuez; <br></li></ul><br><ul><li>  ContainedNodes - un tableau d'√©l√©ments AST qui tombent dans la plage s√©lectionn√©e.  Nous voulons nous assurer que l'utilisateur s√©lectionne la plage dans laquelle entre la construction if let.  Pour ce faire, nous prenons le premier √©l√©ment du tableau et v√©rifions que cet √©l√©ment correspond √† IfStmt (la classe qui d√©finit le n≈ìud AST du n≈ìud d'instruction du sous-type if).  Ensuite, voir condition.  Pour simplifier l'impl√©mentation, nous afficherons l'outil uniquement pour les expressions avec une condition.  Par le type de condition (CK_PatternBinding), nous d√©terminons que cela est autoris√©. <br></li></ul><br><img src="https://habrastorage.org/getpro/habr/post_images/e7f/ba1/e70/e7fba1e70c05ada9602ba90164c67db8.png"><br><br>  Pour tester isApplicable, ajoutez l'exemple de code au fichier <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">test / refactoring / RefactoringKind / basic.swift</a> . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0a1/663/046/0a1663046435877088f58d14329123f5.png"><br><br>  Pour que le test simule un appel √† notre outil, vous devez ajouter une ligne dans le fichier <a href="">tools / swift-refactor / swift-refactor.cpp</a> . <a href="">&nbsp;</a><br><br><img src="https://habrastorage.org/getpro/habr/post_images/a38/3a9/b3d/a383a9b3d80613dda377d5cd7f43411c.png"><br><br><h2>  Nous impl√©mentons performChange </h2><br>  Cette m√©thode est appel√©e lorsqu'un outil de refactoring est s√©lectionn√© dans le menu contextuel.  La m√©thode a acc√®s √† ResolvedRangeInfo, ainsi qu'√† isApplicable.  Nous utilisons ResolvedRangeInfo et √©crivons la logique de l'outil de conversion de code. <br><br>  Lors de la g√©n√©ration de code pour des jetons statiques (r√©gis par la syntaxe du langage), vous pouvez utiliser des entit√©s de l'espace de noms de jeton.  Par exemple, pour le mot cl√© guard, utilisez tok :: kw_guard.  Pour les jetons dynamiques (modifi√©s par le d√©veloppeur, par exemple, le nom de la fonction), vous devez les s√©lectionner dans le tableau des √©l√©ments AST. <br><br>  Pour d√©terminer o√π le code converti est ins√©r√©, nous utilisons la plage s√©lectionn√©e compl√®te √† l'aide de la construction RangeInfo.ContentRange. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/893/d2b/c31/893d2bc311ceba6313fad5d474f6ea2e.png"><br><br><h2>  Diagnostics et tests </h2><br>  Avant de terminer de travailler sur un outil, vous devez v√©rifier √† nouveau l'exactitude de son travail.  Les tests nous aideront √† nouveau.  Les tests peuvent √™tre ex√©cut√©s un √† la fois ou avec toutes les √©tendues disponibles.  La fa√ßon la plus simple d'ex√©cuter l'int√©gralit√© de la suite de tests Swift est d'utiliser la commande --test sur utils / build-script, qui ex√©cutera la suite de tests principale.  L'utilisation de utils / build-script reconstruira toutes les cibles, ce qui peut augmenter consid√©rablement le temps de cycle de d√©bogage. <br><br>  Assurez-vous d'ex√©cuter les tests de validation utils / build-script --validation-test avant d'apporter des modifications majeures au compilateur ou √† l'API. <br><br>  Il existe une autre fa√ßon d'ex√©cuter tous les tests unitaires du compilateur - via ninja, ninja check-swift depuis build / preset / swift-macosx-x86_64.  Cela prendra environ 15 minutes. <br><br>  Et enfin, l'option lorsque vous devez ex√©cuter des tests s√©par√©ment.  Pour appeler directement le script lit.py √† partir de LLVM, vous devez le configurer pour utiliser le r√©pertoire de construction local.  Par exemple: <br><br><pre> <code class="swift hljs">% $ {<span class="hljs-type"><span class="hljs-type">LLVM_SOURCE_ROOT</span></span>} /utils/lit/lit.py -sv $ {<span class="hljs-type"><span class="hljs-type">SWIFT_BUILD_DIR</span></span>} / test-macosx-x86_64 / <span class="hljs-type"><span class="hljs-type">Parse</span></span> /</code> </pre> <br>  Cela ex√©cutera les tests dans le r√©pertoire 'test / Parse /' pour macOS 64 bits.  L'option -sv fournit un indicateur de l'ex√©cution des tests et affiche les r√©sultats des tests ayant √©chou√© uniquement. <br><br>  Lit.py a d'autres fonctionnalit√©s utiles, telles que les tests de synchronisation et les tests de latence.  Vous pouvez afficher ces fonctionnalit√©s et d'autres avec lit.py -h.  Les plus utiles se trouvent <a href="">ici</a> . <br><br>  Pour ex√©cuter un test, √©crivez: <br><br><pre> <code class="swift hljs"> ./llvm/utils/lit/lit.py -sv ./build/<span class="hljs-type"><span class="hljs-type">Ninja</span></span>-<span class="hljs-type"><span class="hljs-type">RelWithDebInfoAssert</span></span>/swift-macosx-x86_64/test-macosx-x86_64/refactoring/<span class="hljs-type"><span class="hljs-type">RefactoringKind</span></span>/basic.swift</code> </pre> <br>  Si nous devons r√©cup√©rer les derni√®res modifications du compilateur, nous devons mettre √† jour toutes les d√©pendances et effectuer un rebase.  Pour mettre √† niveau, ex√©cutez ./utils/update-checkout. <br><br><h2>  Conclusions </h2><br>  Nous avons r√©ussi √† atteindre notre objectif - faire un outil qui n'√©tait pas auparavant dans l'IDE pour optimiser le travail.  Si vous avez √©galement des id√©es sur la fa√ßon d'am√©liorer les produits Apple et de faciliter la vie de toute la communaut√© iOS, n'h√©sitez pas √† adopter le contre-branding, car c'est plus facile qu'il n'y para√Æt √† premi√®re vue! <br><br>  En 2015, Apple a t√©l√©charg√© le code source de Swift dans le domaine public, ce qui a permis de plonger dans les d√©tails d'impl√©mentation de son compilateur.  De plus, avec Xcode 9, vous pouvez ajouter des outils de refactoring locaux.  Une connaissance de base de C ++ et d'un p√©riph√©rique de compilation est suffisante pour rendre votre IDE pr√©f√©r√© un peu plus pratique. <br><br>  L'exp√©rience d√©crite nous a √©t√© utile - en plus de cr√©er un outil qui simplifie le processus de d√©veloppement, nous avons acquis une connaissance vraiment hardcore du langage.  Une bo√Æte de Pandore l√©g√®rement ouverte avec des processus de bas niveau vous permet de voir les t√¢ches quotidiennes sous un nouvel angle. <br><br>  Nous esp√©rons que les connaissances acquises enrichiront √©galement votre compr√©hension du d√©veloppement! <br><br>  Le mat√©riel a √©t√© co-√©crit avec <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">@victoriaqb</a> - Victoria Kashlina, d√©veloppeur iOS. <br><br><h2>  Les sources </h2><br><ol><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Dispositif de compilateur Swift.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">2e partie</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Comment construire un outil bas√© sur un compilateur Swift?</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Le guide pas √† pas</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Dump du Swift AST pour un projet iOS</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Pr√©sentation du testeur de stress sourcekitd</a> <br></li><li>  <a href="">Test rapide</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">[SR-5744] Action de refactorisation pour convertir if-let en guard-let et vice versa # 24566</a> <br></li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr460227/">https://habr.com/ru/post/fr460227/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr460213/index.html">Comment acheter un billet le moins cher possible ou √™tre frapp√© par une surveillance des prix dynamiques</a></li>
<li><a href="../fr460215/index.html">Les informaticiens √©largissent la port√©e des connaissances sur les tests</a></li>
<li><a href="../fr460221/index.html">Comment poser des questions si vous √™tes un informaticien d√©butant</a></li>
<li><a href="../fr460223/index.html">Du Web et des banques au d√©veloppement iOS: l'exp√©rience personnelle du programmeur Apiqa</a></li>
<li><a href="../fr460225/index.html">√Ä propos du bureau pour le travail debout, la sant√© de la colonne vert√©brale et l'efficacit√© personnelle</a></li>
<li><a href="../fr460231/index.html">OpenGear - R√©duisez les temps d'arr√™t de votre entreprise √† l'aide d'un serveur de console avec une gestion hors bande</a></li>
<li><a href="../fr460233/index.html">Le jeu Cities: Skylines s'est av√©r√© √™tre Turing-complet: nous cr√©ons un additionneur 4 bits</a></li>
<li><a href="../fr460237/index.html">Escrocs eBay (une histoire de triche)</a></li>
<li><a href="../fr460239/index.html">Comment obtenir le pare-feu NextGen chez vous absolument gratuitement</a></li>
<li><a href="../fr460241/index.html">Enfer ou mar√©e haute: histoire de la litt√©rature scientifique populaire russe</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>