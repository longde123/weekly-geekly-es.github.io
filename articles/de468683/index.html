<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèø‚Äçüè´ üôéüèº üë©‚ÄçüöÄ Theorie und Praxis der Standardisierung von Docker-Diensten üè≥Ô∏è‚Äçüåà üò≤ üë≥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Informationen zum Thema Microservice-Anwendungsarchitektur, die bereits erfolgreich waren, reichen heute v√∂llig aus, um zu entscheiden, ob sie zu Ihre...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Theorie und Praxis der Standardisierung von Docker-Diensten</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/antiplagiat/blog/468683/"><p>  Informationen zum Thema Microservice-Anwendungsarchitektur, die bereits erfolgreich waren, reichen heute v√∂llig aus, um zu entscheiden, ob sie zu Ihrem Produkt passen oder nicht.  Und es ist √ºberhaupt kein Geheimnis, dass Unternehmen, die sich f√ºr diesen Weg entschieden haben, sich vielen technischen und kulturellen Herausforderungen stellen m√ºssen.  Eine der Problemquellen ist der Overhead, der sich √ºberall vervielfacht, und dies gilt auch f√ºr die Routine, die mit Produktionsprozessen verbunden ist. </p><br><p><img src="https://habrastorage.org/webt/6g/-f/o5/6g-fo54hrcctez4vg4-avzkijc0.jpeg"><br>  <sub><em><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Bildquelle:</a></em></sub> </p><br><p>  Wie Sie sich vorstellen k√∂nnen, ist Anti-Plagiat ein solches Unternehmen, in dem allm√§hlich das Verst√§ndnis entstand, dass wir mit Microservices unterwegs waren.  Aber bevor wir anfingen, den Kaktus zu essen, beschlossen wir, ihn zu reinigen und zu kochen.  Und da alle einzig wahren und korrekten L√∂sungen einzigartig sind, haben wir uns entschlossen, anstelle von universellen DevOps-Folien mit sch√∂nen Pfeilen nur unsere eigenen Erfahrungen zu teilen und zu erz√§hlen, wie wir bereits einen betr√§chtlichen Teil unseres besonderen Weges zum Erfolg zur√ºckgelegt haben, hoffe ich. </p><a name="habracut"></a><br><p>  Wenn Sie ein wirklich einzigartiges Produkt herstellen, das weit und breit aus Know-how besteht, besteht fast keine Chance, diesem speziellen Weg auszuweichen, da er aus vielen privaten besteht: ausgehend von den im Unternehmen entwickelten kulturellen und historischen Daten, die mit seiner eigenen Spezifit√§t und dem verwendeten technologischen Stapel enden . </p><br><p>  Eine der Aufgaben f√ºr jedes Unternehmen und Team besteht darin, das optimale Gleichgewicht zwischen Freiheiten und Regeln zu finden, und Microservices bringen dieses Problem auf eine neue Ebene.  Dies scheint der Idee von Microservices zu widersprechen, die eine gro√üe Freiheit bei der Auswahl der Technologien impliziert. Wenn Sie sich jedoch nicht direkt auf architektonische und technologische Fragen konzentrieren, sondern die Probleme der Produktion als Ganzes betrachten, ist das Risiko, irgendwo in der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Handlung des</a> ‚ÄûGartens der irdischen Freuden‚Äú zu sein, durchaus greifbar . </p><br><p>  In dem Buch "Erstellen von Microservices" bietet Sam Newman jedoch eine L√∂sung f√ºr dieses Problem, bei der er buchst√§blich auf den ersten Seiten von der Notwendigkeit spricht, die Kreativit√§t von Teams im Rahmen technischer Vereinbarungen einzuschr√§nken.  Einer der Schl√ºssel zum Erfolg, insbesondere im Zusammenhang mit einer begrenzten Freihandressource, ist die Standardisierung von allem, was nur verhandelt werden kann und was niemand wirklich die ganze Zeit tun m√∂chte.  Durch die Ausarbeitung von Vereinbarungen schaffen wir klare Spielregeln f√ºr alle Teilnehmer an der Produktion und dem Betrieb von Systemkomponenten.  Und wenn Sie die Spielregeln kennen, m√ºssen Sie zustimmen, dass das Spielen einfacher und unterhaltsamer sein sollte.  Das Befolgen dieser Regeln selbst kann jedoch zur Routine werden und den Teilnehmern Unbehagen bereiten, was direkt zu allen Arten von Abweichungen von ihnen und in der Folge zum Scheitern der gesamten Idee f√ºhrt.  Und der naheliegendste Ausweg besteht darin, alle Vereinbarungen in den Code aufzunehmen, da keine einzige Vorschrift das tun kann, was Automatisierung und praktische Tools verwenden k√∂nnen, deren Verwendung intuitiv und nat√ºrlich ist. </p><br><p>  In diese Richtung konnten wir immer mehr automatisieren, und je st√§rker unser Prozess wurde, desto mehr wurde er zu einem End-to-End-F√∂rderer f√ºr die Produktion von Bibliotheken und Mikrodiensten (oder nicht so). </p><br><p></p><div class="spoiler">  <b class="spoiler_title">Haftungsausschluss</b> <div class="spoiler_text">  Dieser Text ist kein Versuch, "wie es sollte" anzugeben, es gibt keine universellen L√∂sungen, nur eine Beschreibung unserer Position auf dem Evolutionspfad und der gew√§hlten Richtung.  All dies mag nicht f√ºr jeden geeignet sein, aber in unserem Fall ist es vor allem deshalb sinnvoll, weil: <br><br>  - Die Entwicklung im Unternehmen erfolgt in 90% der F√§lle in C #. <br>  - Es war nicht n√∂tig, bei Null anzufangen, was Teil der akzeptierten Standards, Ans√§tze und Technologien war - dies ist das Ergebnis von Erfahrung oder einfach eines historischen Erbes; <br>  - Repositories mit .NET-Projekten, im Gegensatz zu Teams, Dutzende (und es wird mehr geben); <br>  - Wir verwenden gerne eine sehr einfache CI-Pipeline, um eine Lieferantenbindung so weit wie m√∂glich zu vermeiden. <br>  - F√ºr einen gew√∂hnlichen .NET-Entwickler k√∂nnen die W√∂rter "Container", "Docker" und "Linux" immer noch Anf√§lle von leichtem existenziellem Horror verursachen, aber ich m√∂chte niemanden durch das Knie brechen. </div></div><br><h2 id="nemnogo-predystorii">  Ein kleiner Hintergrund </h2><br><p>  Im Fr√ºhjahr 2017 stellte Microsoft der Welt eine Vorschau auf .NET Core 2.0 vor, und dieses Jahr beeilten sich C # -Astrologen sofort, das Linux-Jahr zu erkl√§ren, also ... </p><br><p><img src="https://habrastorage.org/webt/ex/zm/0r/exzm0rw_jaawe48lclqgweok1rq.png"><br>  <sub><em><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Bildquelle:</a></em></sub> </p><br><p>  Seit einiger Zeit haben wir, ohne der Magie zu vertrauen, alles unter Windows und Linux gesammelt und getestet, Artefakte mit einigen SSH-Skripten ver√∂ffentlicht und versucht, alte CI / CD-Pipelines im Schweizer Messermodus zu konfigurieren.  Aber nach einiger Zeit stellten sie fest, dass wir etwas falsch machten.  Dar√ºber hinaus klangen Verweise auf Microservices und Container immer h√§ufiger.  Also haben wir uns auch entschlossen, die Hype-Welle zu reiten und diese Richtungen zu erkunden. </p><br><p>  Bereits in der Phase der Reflexion √ºber unsere m√∂gliche Zukunft im Bereich Mikroservice stellten sich eine Reihe von Fragen, die wir ignorierten und die wir in dieser Zukunft mit neuen Problemen riskierten, die wir uns im Austausch gegen gel√∂ste Probleme geschaffen h√§tten. </p><br><p>  Erstens hatten wir bei der Betrachtung der Betriebsseite der theoretischen Mikroservice-Welt ohne Regeln Angst vor der Aussicht auf Chaos mit allen daraus resultierenden Konsequenzen, einschlie√ülich nicht nur der unvorhersehbaren Qualit√§t des Ergebnisses, sondern auch der Konflikte zwischen Teams oder Entwicklern und Ingenieuren.  Der Versuch, einige Empfehlungen abzugeben, die nicht in der Lage waren, deren Einhaltung sicherzustellen, schien sofort ein leeres Unterfangen zu sein. </p><br><p>  Zweitens wusste niemand wirklich, wie man Container richtig erstellt und Docker-Dateien schreibt, die jedoch bereits begonnen haben, in unseren Repositories lebhaft zu schwirren.  Au√üerdem ‚Äûlesen viele irgendwo‚Äú, dass dort nicht alles so einfach ist.  Also musste jemand tiefer tauchen und es herausfinden und dann mit den besten Methoden f√ºr die Montage von Containern zur√ºckkehren.  Aber die Aussicht, die Rolle eines Vollzeit-Docker-Packers zu √ºbernehmen, der mit Stapeln von Docker-Dateien allein gelassen wurde, hat aus irgendeinem Grund niemanden im Unternehmen inspiriert.  Wie sich herausstellte, ist einmaliges Tauchen eindeutig nicht genug, und selbst wenn es auf den ersten Blick gut und richtig aussieht, kann es sich als falsch oder einfach nicht sehr gut herausstellen. </p><br><p>  Und drittens wollte ich sicherstellen, dass die mit den Diensten erhaltenen Bilder nicht nur unter dem Gesichtspunkt der Containerpraktiken korrekt sind, sondern auch in ihrem Verhalten vorhersehbar sind und alle erforderlichen Eigenschaften und Attribute aufweisen, um die Steuerung der gestarteten Container zu vereinfachen.  Mit anderen Worten, ich wollte Bilder mit Anwendungen erhalten, die gleicherma√üen konfiguriert sind und Protokolle schreiben, eine einzige Schnittstelle zum Abrufen von Metriken bereitstellen, einen konsistenten Satz von Beschriftungen haben und dergleichen.  Es war auch wichtig, dass die Baugruppe auf dem Computer des Entwicklers das gleiche Ergebnis wie die Baugruppe in jedem CI-System liefert, einschlie√ülich Bestehen von Tests und Generieren von Artefakten. </p><br><p>  So entstand das Verst√§ndnis, dass ein Prozess erforderlich sein w√ºrde, um neues Wissen, neue Praktiken und Standards zu verwalten und zu zentralisieren, und dass der Weg vom ersten Commit zu einem Docker-Image, das vollst√§ndig f√ºr die Produktinfrastruktur bereit ist, einheitlich und so automatisiert wie m√∂glich sein sollte und nicht √ºber die beginnenden Begriffe hinausgehen sollte mit dem Wort kontinuierlich. </p><br><h2 id="cli-vs-gui">  CLI vs.  GUI </h2><br><p>  Der Ausgangspunkt f√ºr eine neue Komponente, sei es ein Dienst oder eine Bibliothek, ist das Erstellen eines Repositorys.  Diese Phase kann in zwei Teile unterteilt werden: Erstellen und Konfigurieren des Repositorys auf dem Hosting des Versionskontrollsystems (wir haben Bitbucket) und Initialisieren mit dem Erstellen einer Dateistruktur.  Gl√ºcklicherweise gab es f√ºr beide bereits eine Reihe von Anforderungen.  Daher war es eine logische Aufgabe, sie im Code zu formalisieren. </p><br><p>  Also, was sollte unser Repository sein: </p><br><ul><li>  Befindet sich in einem der Projekte, in denen Name, Zugriffsrechte, Richtlinien zum Akzeptieren von Pull-Anforderungen usw.; </li><li>  Enthalten erforderliche Dateien und Verzeichnisse wie: <br><ul><li> Datei mit der Konfiguration und Informationen zum Repository von <code>SolutionInfo.props</code> (mehr dazu weiter unten); </li><li>  Projektquellcodes im <code>src</code> Verzeichnis; </li><li>  <code>.gitignore</code> , <code>README.md</code> usw.; </li></ul></li><li>  Enth√§lt die erforderlichen Git-Submodule. </li><li>  Das Projekt muss aus einer der Vorlagen abgeleitet werden. </li></ul><br><p>  Da die Bitbucket-REST-API die vollst√§ndige Kontrolle √ºber die Konfiguration von Repositorys bietet, wurde ein spezielles Dienstprogramm f√ºr die Interaktion mit diesen erstellt - der Repository-Generator.  Im Frage-Antwort-Modus erh√§lt sie vom Benutzer alle erforderlichen Daten und erstellt ein Repository, das alle unsere Anforderungen vollst√§ndig erf√ºllt, n√§mlich: </p><br><ul><li>  Definiert ein Projekt in Bitbucket zur Auswahl; </li><li>  Validiert den Namen gem√§√ü unserer Vereinbarung; </li><li>  Nimmt alle erforderlichen Einstellungen vor, die nicht vom Projekt geerbt werden k√∂nnen. </li><li>  Aktualisiert die Liste der benutzerdefinierten Vorlagen (wir verwenden <a href="">Dotnet-</a> Vorlagen) f√ºr das Projekt und schl√§gt eine Auswahl vor. </li><li>  F√ºllt die minimal erforderlichen Informationen zum Repository in der Konfigurationsdatei und in <code>*.md</code> Dokumenten aus. </li><li>  Es verbindet Submodule mit der CI / CD-Pipeline-Konfiguration (in unserem Fall <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Bamboo Specs</a> ) und Assembly-Skripten. </li></ul><br><p>  Mit anderen Worten, der Entwickler, der ein neues Projekt startet, startet das Dienstprogramm, f√ºllt mehrere Felder aus, w√§hlt den Projekttyp aus und erh√§lt beispielsweise die vollst√§ndig fertige ‚ÄûHallo Welt!‚Äú  Ein Dienst, der bereits mit dem CI-System verbunden ist. Von dort aus kann der Dienst sogar ver√∂ffentlicht werden, wenn Sie ein Commit durchf√ºhren, bei dem die Version auf ungleich Null ge√§ndert wird. </p><br><p>  Der erste Schritt wurde getan.  Keine manuelle Arbeit und Fehler, Suche nach Dokumentation, Registrierungen und SMS.  Fahren wir nun mit dem fort, was dort generiert wurde. </p><br><h2 id="struktura">  Struktur </h2><br><p>  Die Standardisierung der Repository-Struktur hat lange Zeit Wurzeln geschlagen und war erforderlich, um die Montage, die Integration in das CI-System und die Entwicklungsumgebung zu vereinfachen.  Zun√§chst gingen wir von der Idee aus, dass die Pipeline in CI so einfach und, wie Sie sich vorstellen k√∂nnen, standardisiert sein sollte, um die Portabilit√§t und Reproduzierbarkeit der Baugruppe sicherzustellen.  Das hei√üt, dass das gleiche Ergebnis sowohl in jedem CI-System als auch am Arbeitsplatz des Entwicklers leicht erzielt werden kann.  Daher wird alles, was sich nicht auf die Funktionen einer bestimmten kontinuierlichen Integrationsumgebung bezieht, einem speziellen Git-Submodul √ºbergeben und ist ein autarkes Build-System.  Genauer gesagt das Montage-Standardisierungssystem.  Die Pipeline selbst sollte in minimaler N√§herung nur das Skript <code>build.sh</code> , einen Bericht √ºber die Tests <code>build.sh</code> und gegebenenfalls eine Bereitstellung initiieren.  Lassen Sie uns der Klarheit <em>halber</em> sehen, was passiert, wenn Sie das <em>SampleService-</em> Repository in einem Projekt mit dem sprechenden Namen <em>Sandbox</em> generieren. </p><br><pre> <code class="plaintext hljs">. ‚îú‚îÄ‚îÄ [bamboo-specs] ‚îú‚îÄ‚îÄ [devops.build] ‚îÇ ‚îú‚îÄ‚îÄ build.sh ‚îÇ ‚îî‚îÄ‚îÄ ... ‚îú‚îÄ‚îÄ [docs] ‚îú‚îÄ‚îÄ [.scripts] ‚îú‚îÄ‚îÄ [src] ‚îÇ ‚îú‚îÄ‚îÄ [CodeAnalysis] ‚îÇ ‚îú‚îÄ‚îÄ [Sandbox.SampleService] ‚îÇ ‚îú‚îÄ‚îÄ [Sandbox.SampleService.Bootstrap] ‚îÇ ‚îú‚îÄ‚îÄ [Sandbox.SampleService.Client] ‚îÇ ‚îú‚îÄ‚îÄ [Sandbox.SampleService.Tests] ‚îÇ ‚îú‚îÄ‚îÄ Directory.Build.props ‚îÇ ‚îú‚îÄ‚îÄ NLog.config ‚îÇ ‚îú‚îÄ‚îÄ NuGet.Config ‚îÇ ‚îî‚îÄ‚îÄ Sandbox.SampleService.sln ‚îú‚îÄ‚îÄ .gitattributes ‚îú‚îÄ‚îÄ .gitignore ‚îú‚îÄ‚îÄ .gitmodules ‚îú‚îÄ‚îÄ CHANGELOG.md ‚îú‚îÄ‚îÄ README.md ‚îî‚îÄ‚îÄ SolutionInfo.props</code> </pre> <br><p>  Die ersten beiden Verzeichnisse sind Git-Submodule.  <code>bamboo-specs</code> ist "Pipeline as Code" f√ºr das Atlassian Bamboo CI-System (es k√∂nnte an seiner Stelle ein <code>devops.build</code> ). <code>devops.build</code> ist unser Build-System, auf das ich weiter unten n√§her eingehen werde.  Das Verzeichnis <code>.scripts</code> .  Das .NET-Projekt selbst befindet sich in <code>src</code> : <code>NuGet.Config</code> enth√§lt die Konfiguration des privaten <acronym>NuGet-</acronym> Repositorys, <code>NLog.config</code> Dev-Time-Konfiguration von <acronym>NLog</acronym> .  Wie Sie vielleicht erraten haben, ist die Verwendung von NLog in einem Unternehmen ebenfalls einer der Standards.  Von den interessanten Dingen hier ist die fast magische <code>Directory.Build.props</code> Datei.  Aus irgendeinem Grund kennen nur wenige Menschen eine solche M√∂glichkeit in .NET-Projekten, z. B. die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Anpassung der Assembly</a> .  Kurz gesagt, Dateien mit den Namen <code>Directory.Build.props</code> und <code>Directory.Build.targets</code> automatisch in Ihre Projekte importiert und erm√∂glichen es Ihnen, gemeinsame Eigenschaften f√ºr alle Projekte an einem Ort zu konfigurieren.  Auf diese Weise verbinden wir beispielsweise den <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">StyleCop.Analyzers-</a> Analysator und seine Konfiguration aus dem <code>CodeAnalysis</code> Verzeichnis mit allen Projekten im <code>CodeAnalysis</code> , legen Versionsregeln und einige allgemeine Attribute f√ºr Bibliotheken und Pakete fest ( <em>Firma</em> , <em>Copyright</em> usw.) und stellen auch eine Verbindung √ºber das <code>&lt;Import&gt;</code> Datei <code>SolutionInfo.props</code> , genau dieselbe Repository-Konfigurationsdatei, die oben beschrieben wurde.  Es enth√§lt bereits die aktuelle Version, Informationen zu den Autoren, die URL des Repositorys und dessen Beschreibung sowie verschiedene Eigenschaften, die sich auf das Verhalten des Assemblysystems und die daraus resultierenden Artefakte auswirken. </p><br><div class="spoiler">  <b class="spoiler_title">Beispiel `SolutionInfo.props`</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Project</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:xsi</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xsi:noNamespaceSchemaLocation</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"devops.build/SolutionInfo.xsd"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Product name --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Product</span></span></span><span class="hljs-tag">&gt;</span></span>Sandbox.SampleService<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Product</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Product version. Version 0.0.0 wouldn't be published! --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BaseVersion</span></span></span><span class="hljs-tag">&gt;</span></span>0.0.0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BaseVersion</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Project name which contains Main() --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">EntryProject</span></span></span><span class="hljs-tag">&gt;</span></span>Sandbox.SampleService.Bootstrap<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">EntryProject</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Exposed port --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ExposedPort</span></span></span><span class="hljs-tag">&gt;</span></span>4000/tcp<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ExposedPort</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- DOTNET_SYSTEM_GLOBALIZATION_INVARIANT value. See https://github.com/dotnet/corefx/blob/master/Documentation/architecture/globalization-invariant-mode.md --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">GlobalizationInvariant</span></span></span><span class="hljs-tag">&gt;</span></span>false<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">GlobalizationInvariant</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Project URL --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">RepositoryUrl</span></span></span><span class="hljs-tag">&gt;</span></span>https://bitbucket.contoso.com/projects/SND/repos/sandbox.sampleservice/<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">RepositoryUrl</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Documentation URL --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DocumentationUrl</span></span></span><span class="hljs-tag">&gt;</span></span>https://bitbucket.contoso.com/projects/SND/repos/sandbox.sampleservice/browse/README.md<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DocumentationUrl</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Your name here --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Authors</span></span></span><span class="hljs-tag">&gt;</span></span>User Name &amp;lt;username@contoso.com&amp;gt;<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Authors</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Project description --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Description</span></span></span><span class="hljs-tag">&gt;</span></span>The sample service for demo purposes.<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Description</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Bamboo plan key (required for Bamboo Specs --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BambooBlanKey</span></span></span><span class="hljs-tag">&gt;</span></span>SMPL<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BambooBlanKey</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Project</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Beispiel `Directory.Build.props`</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Project</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Import</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Condition</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Exists('..\SolutionInfo.props')"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Project</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"..\SolutionInfo.props"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">None</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Include</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(MSBuildThisFileDirectory)/CodeAnalysis/stylecop.json"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Link</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"stylecop.json"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">CopyToOutputDirectory</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Never"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PackageReference</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Include</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"StyleCop.Analyzers"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Version</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1.*"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">PrivateAssets</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"all"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CodeAnalysisRuleSet</span></span></span><span class="hljs-tag">&gt;</span></span>$(MSBuildThisFileDirectory)/CodeAnalysis/stylecop.ruleset<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CodeAnalysisRuleSet</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Enable XML docs generating--&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">GenerateDocumentationFile</span></span></span><span class="hljs-tag">&gt;</span></span>true<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">GenerateDocumentationFile</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Enable C# 7.x features --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">LangVersion</span></span></span><span class="hljs-tag">&gt;</span></span>latest<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">LangVersion</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- default base version --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BaseVersion</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Condition</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"'$(BaseVersion)' == ''"</span></span></span><span class="hljs-tag">&gt;</span></span>0.0.0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BaseVersion</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- default build number and format --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BuildNumber</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Condition</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"'$(BuildNumber)' == ''"</span></span></span><span class="hljs-tag">&gt;</span></span>0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BuildNumber</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BuildNumber</span></span></span><span class="hljs-tag">&gt;</span></span>$([System.String]::Format('{0:0000}',$(BuildNumber)))<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BuildNumber</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- default version suffix --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">VersionSuffix</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Condition</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"'$(VersionSuffix)' == ''"</span></span></span><span class="hljs-tag">&gt;</span></span>local<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">VersionSuffix</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- empty version suffix instead of 'prod' --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">VersionSuffix</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Condition</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"'$(VersionSuffix)' == 'prod'"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">VersionSuffix</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- format version prefix --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">VersionPrefix</span></span></span><span class="hljs-tag">&gt;</span></span>$(BaseVersion).$(BuildNumber)<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">VersionPrefix</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- disable IsPackable by default --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">IsPackable</span></span></span><span class="hljs-tag">&gt;</span></span>false<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">IsPackable</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PackageProjectUrl</span></span></span><span class="hljs-tag">&gt;</span></span>$(RepositoryUrl)<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PackageProjectUrl</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Company</span></span></span><span class="hljs-tag">&gt;</span></span>Contoso<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Company</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Copyright</span></span></span><span class="hljs-tag">&gt;</span></span>Copyright $([System.DateTime]::Now.Date.Year) Contoso Ltd<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Copyright</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Project</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> </div></div><br><h2 id="sborka">  Montage </h2><br><p>  Es ist sofort erw√§hnenswert, dass sowohl ich als auch meine Kollegen bereits recht erfolgreiche Erfahrungen mit der Verwendung verschiedener <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Build-Systeme gesammelt haben</a> .  Und anstatt ein vorhandenes Tool mit v√∂llig untypischen Funktionen zu gewichten, wurde beschlossen, ein anderes Tool zu erstellen, das auf unseren neuen Prozess spezialisiert ist, und das alte Tool in Ruhe zu lassen, um seine Aufgaben im Rahmen von Legacy-Projekten auszuf√ºhren.  Die Fixidee war der Wunsch, ein Tool zu erhalten, das den Code mithilfe eines einzigen Standardprozesses in ein Docker-Image verwandelt, das alle unsere Anforderungen erf√ºllt, w√§hrend Entwickler nicht mehr in die Feinheiten der Assembly eintauchen m√ºssen, aber die M√∂glichkeit einer Anpassung beibehalten m√ºssen. </p><br><p>  Die Auswahl eines geeigneten Rahmens hat begonnen.  Basierend auf den Anforderungen an die Reproduzierbarkeit des Ergebnisses sowohl auf Build-Maschinen mit Linux als auch auf Windows-Maschinen eines Entwicklers wurden die echte plattform√ºbergreifende und ein Minimum an vordefinierten Abh√§ngigkeiten zu einer Schl√ºsselbedingung.  Zu verschiedenen Zeiten konnte ich einige der Assembly-Frameworks f√ºr .NET-Entwickler recht gut kennenlernen: von MSBuild und seinen monstr√∂sen XML-Konfigurationen, die sp√§ter in <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Psake</a> (Powershell) √ºbersetzt wurden, bis hin zu exotischem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">FAKE</a> (F #).  Aber diesmal wollte ich etwas Frisches und Leichtes.  Dar√ºber hinaus wurde bereits entschieden, dass die Montage und das Testen vollst√§ndig in einer isolierten Containerumgebung durchgef√ºhrt werden sollten, sodass ich nicht vorhatte, etwas anderes als die Docker CLI- und Git-Befehle auszuf√ºhren, dh der gr√∂√üte Teil des Prozesses sollte in der Docker-Datei beschrieben worden sein. <br>  Zu diesem Zeitpunkt waren sowohl FAKE 5 als auch <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Cake</a> for .NET Core noch nicht fertig. Bei einer plattform√ºbergreifenden Entwicklung waren diese Projekte also mittelm√§√üig.  Aber mein geliebter <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">PowerShell 6 Core</a> wurde bereits ver√∂ffentlicht und ich habe ihn in vollem Umfang genutzt.  Deshalb habe ich mich entschlossen, mich wieder Psake zuzuwenden, und w√§hrend ich mich umdrehte, bin ich auf ein interessantes <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Invoke-Build-</a> Projekt gesto√üen, das ein Umdenken von Psake darstellt und, wie der Autor selbst betont, dasselbe ist, nur besser und einfacher.  So ist es.  Ich werde im Rahmen dieses Artikels nicht n√§her darauf eingehen, ich werde nur bemerken, dass mich die Kompaktheit darin besticht, wenn alle Grundfunktionen f√ºr diese Produktklasse verf√ºgbar sind: </p><br><ul><li>  Die Abfolge der Aktionen wird durch eine Reihe miteinander verbundener Aufgaben (Tasks) beschrieben, die anhand ihrer gegenseitigen Abh√§ngigkeiten und zus√§tzlichen Bedingungen gesteuert werden k√∂nnen. </li><li>  Es gibt mehrere n√ºtzliche Hilfsprogramme, z. B. exec {} f√ºr die korrekte Behandlung von Exit-Codes f√ºr Konsolenanwendungen. </li><li>  Jede Ausnahme oder Beendigung der Verwendung von Strg + C wird in einem speziellen integrierten Exit-Build-Block korrekt verarbeitet.  Dort k√∂nnen Sie beispielsweise alle tempor√§ren Dateien oder eine Testumgebung l√∂schen oder einen Bericht zeichnen, der f√ºr das Auge angenehm ist. </li></ul><br><p><img src="https://habrastorage.org/webt/nw/sg/0g/nwsg0gzd3fo0a-ep6b60pfqce98.png"></p><br><h2 id="universalnyy-dockerfile">  Generisches Dockerfile </h2><br><p>  Die Docker-Datei selbst und die Baugruppe mit <code>docker build</code> bieten relativ schwache Parametrierungsfunktionen, und die Flexibilit√§t dieser Tools ist kaum h√∂her als die eines Schaufelgriffs.  Dar√ºber hinaus gibt es eine Vielzahl von M√∂glichkeiten, um das ‚Äûfalsche‚Äú Bild zu gro√ü, zu unsicher, zu unintuitiv oder einfach unvorhersehbar zu machen.  Gl√ºcklicherweise bietet die <a href="">Microsoft-Dokumentation</a> bereits einige <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Beispiele f√ºr Dockerfile</a> , mit denen Sie die grundlegenden Konzepte schnell verstehen und Ihr erstes Dockerfile erstellen und sp√§ter schrittweise verbessern k√∂nnen.  Er verwendet bereits ein <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">mehrstufiges</a> Muster und erstellt ein spezielles ‚Äû <a href="">Test Runner</a> ‚Äú -Image, um Tests auszuf√ºhren. </p><br><h2 id="multi-stage-pattern-i-argumenty">  Mehrstufiges Muster und Argumente </h2><br><p>  Der erste Schritt besteht darin, die Montagestufen in kleinere zu unterteilen und neue hinzuzuf√ºgen.  Es lohnt sich daher, den Start von <code>dotnet build</code> als separate Phase hervorzuheben, da es f√ºr Projekte, die nur Bibliotheken enthalten, keinen Sinn macht, <code>dotnet publish</code> .  Jetzt k√∂nnen wir nach unserem Ermessen nur die erforderlichen Montageschritte mit ausf√ºhren <br> <code>dotnet build --target &lt;name&gt;</code> <br>  Zum Beispiel sammeln wir hier ein Projekt, das nur Bibliotheken enth√§lt.  Die Artefakte hier sind nur NuGet-Pakete, was bedeutet, dass es keinen Sinn macht, ein Laufzeit-Image zu erfassen. </p><br><p><img src="https://habrastorage.org/webt/vn/_a/a3/vn_aa3w7oodzrpythwrixomkhs8.png"></p><br><p>  Oder wir bauen bereits einen Service auf, aber aus dem Feature-Zweig.  Wir brauchen √ºberhaupt keine Artefakte einer solchen Baugruppe, es ist nur wichtig, die Tests und den Gesundheitscheck zu bestehen. </p><br><p><img src="https://habrastorage.org/webt/fo/ua/l1/foual199bsvqf2u7mk6xgjzbw9q.png"></p><br><p>  Als n√§chstes m√ºssen Sie die Verwendung von Basisbildern parametrisieren.  In der Docker-Datei kann die <code>ARG</code> Direktive seit einiger Zeit au√üerhalb der Erstellungsphasen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">platziert werden</a> , und die √ºbertragenen Werte k√∂nnen im Namen des Basisimages <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">verwendet werden</a> . </p><br><pre> <code class="plaintext hljs">ARG DOTNETCORE_VERSION=2.2 ARG ALPINE_VERSION= ARG BUILD_BASE=mcr.microsoft.com/dotnet/core/sdk:${DOTNETCORE_VERSION}-alpine${ALPINE_VERSION} ARG RUNTIME_BASE=mcr.microsoft.com/dotnet/core/runtime:${DOTNETCORE_VERSION}-alpine${ALPINE_VERSION} FROM ${BUILD_BASE} AS restore ... FROM ${RUNTIME_BASE} AS runtime ...</code> </pre> <br><p>  So bekamen wir neue und auf den ersten Blick nicht offensichtliche M√∂glichkeiten.  Wenn Sie ein Image mit einer ASP.NET Core-Anwendung erstellen m√∂chten, ben√∂tigt das Laufzeit-Image zun√§chst ein anderes: <code>mcr.microsoft.com/dotnet/core/aspnet</code> .  Der Parameter mit einem nicht standardm√§√üigen Basisabbild muss in der Konfiguration des <code>SolutionInfo.props</code> Repositorys gespeichert und w√§hrend der Assemblierung als Argument √ºbergeben werden.  Wir haben es dem Entwickler auch einfacher gemacht, andere Versionen der .NET Core-Images zu verwenden: beispielsweise Vorschauen oder sogar benutzerdefinierte (Sie wissen es nie!). </p><br><p>  Zweitens ist die M√∂glichkeit, die Docker-Datei zu "erweitern", noch interessanter, da sie Teil der Vorg√§nge in einer anderen Assembly ist, deren Ergebnis bei der Erstellung des Laufzeitabbilds zugrunde gelegt wird.  Einige unserer Dienste verwenden beispielsweise JavaScript und Vue.js, deren Code wir in einem separaten Image vorbereiten, indem wir dem Repository einfach eine solche ‚Äûexpandierende‚Äú Docker-Datei hinzuf√ºgen: </p><br><pre> <code class="plaintext hljs">ARG DOTNETCORE_VERSION=2.2 ARG ALPINE_VERSION= ARG RUNTIME_BASE=mcr.microsoft.com/dotnet/core/aspnet:${DOTNETCORE_VERSION}-alpine${ALPINE_VERSION} FROM node:alpine AS install WORKDIR /build COPY package.json . RUN npm install FROM install AS src COPY [".babelrc", ".eslintrc.js", ".stylelintrc", "./"] COPY ClientApp ./ClientApp FROM src AS publish RUN npm run build-prod FROM ${RUNTIME_BASE} AS appbase COPY --from=publish /build/wwwroot/ /app/wwwroot/</code> </pre> <br><p>  Sammeln wir dieses Image mit dem Tag, das wir an die Phase des Zusammenstellens des Laufzeitimages des ASP.NET-Dienstes als Argument f√ºr RUNTIME_BASE √ºbergeben.  So k√∂nnen Sie die Assembly beliebig erweitern, einschlie√ülich der Parametrisierung dessen, was Sie nicht nur im <code>docker build</code> tun k√∂nnen.  M√∂chten Sie das Hinzuf√ºgen von Volume parametrisieren?  Einfach: </p><br><pre> <code class="plaintext hljs">ARG DOTNETCORE_VERSION=2.2 ARG ALPINE_VERSION= ARG RUNTIME_BASE=mcr.microsoft.com/dotnet/core/aspnet:${DOTNETCORE_VERSION}-alpine${ALPINE_VERSION} FROM ${RUNTIME_BASE} AS runtime ARG VOLUME VOLUME ${VOLUME}</code> </pre> <br><p>  Wir starten die Assemblierung dieser Docker-Datei so oft, wie wir VOLUME-Direktiven hinzuf√ºgen m√∂chten.  Wir verwenden das resultierende Bild als Basis f√ºr den Service. </p><br><h2 id="zapusk-testov">  Ausf√ºhren von Tests </h2><br><p>  Anstatt Tests direkt in der Montagephase auszuf√ºhren, ist es korrekter und bequemer, dies in einem speziellen ‚ÄûTest Runner‚Äú -Container durchzuf√ºhren.  Ich m√∂chte kurz auf das Wesentliche dieses Ansatzes eingehen und stelle fest, dass Sie Folgendes tun k√∂nnen: </p><br><ul><li>  F√ºhren Sie alle geplanten Starts durch, auch wenn einer von ihnen abst√ºrzt. </li><li>  H√§ngen Sie das Host-Dateisystemverzeichnis in den Container ein, um einen Testbericht zu erhalten, der beim Erstellen des CI-Systems von entscheidender Bedeutung ist. </li><li>  F√ºhren Sie das Testen in einer tempor√§ren Umgebung durch, indem Sie den Namen des Netzwerks an den <code>docker run --network &lt;test_network_name&gt;</code> . </li></ul><br><p>  Der letzte Absatz bedeutet, dass wir jetzt nicht nur Komponententests, sondern auch Integrationstests ausf√ºhren k√∂nnen.  Wir beschreiben die Umgebung beispielsweise in <code>docker-compose.yaml</code> und f√ºhren sie f√ºr den gesamten Build aus.  Jetzt k√∂nnen Sie die Interaktion mit der Datenbank oder unserem anderen Dienst √ºberpr√ºfen und die Protokolle von ihnen speichern, falls Sie sie f√ºr die Analyse ben√∂tigen. </p><br><p>  Wir √ºberpr√ºfen immer das resultierende Laufzeitbild, um den Healthcheck zu bestehen, was auch eine Art Test ist.  Eine tempor√§re Testumgebung kann hier n√ºtzlich sein, wenn der zu testende Dienst Abh√§ngigkeiten von seiner Umgebung aufweist. </p><br><p>  Ich <code>dotnet build</code> auch fest, dass der Ansatz mit den Runner-Containern, die in der Phase mit <code>dotnet build</code> zusammengebaut wurden, dann gut zum Starten von <code>dotnet publish</code> , <code>dotnet pack</code> und <code>dotnet nuget push</code> .  Auf diese Weise k√∂nnen wir Baugruppenartefakte lokal speichern. </p><br><h2 id="healthcheck-i-zavisimosti-os">  Healthcheck und Betriebssystemabh√§ngigkeiten </h2><br><p>  Ziemlich schnell wurde klar, dass unsere standardisierten Dienstleistungen auf ihre Weise immer noch einzigartig sein w√ºrden.  Sie haben m√∂glicherweise unterschiedliche Anforderungen an vorinstallierte Pakete des Betriebssystems im Image und unterschiedliche Methoden zur √úberpr√ºfung des Integrit√§tspr√ºfens.  Und wenn Curl zum √úberpr√ºfen des Status einer Webanwendung geeignet ist, ist es f√ºr ein gRPC-Backend oder dar√ºber hinaus f√ºr einen kopflosen Dienst nutzlos und ein zus√§tzliches Paket im Container. </p><br><p>  Um Entwicklern die M√∂glichkeit zu geben, das Image anzupassen und seine Konfiguration zu erweitern, verwenden wir die Vereinbarung f√ºr mehrere spezielle Skripte, die im Repository neu definiert werden k√∂nnen: </p><br><pre> <code class="plaintext hljs">.scripts ‚îú‚îÄ‚îÄ healthcheck.sh ‚îú‚îÄ‚îÄ run.sh ‚îî‚îÄ‚îÄ runtime-deps.sh</code> </pre> <br><p>  Das Skript <code>healthcheck.sh</code> enth√§lt die Befehle, die zum √úberpr√ºfen des Status erforderlich sind: </p><br><ul><li><p>  F√ºr das Web mit Curl: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/ash set ‚Äìe curl -sIf -o /dev/null -w "%{http_code}\n" 127.0.0.1/health || exit 1</span></span></code> </pre> <br></li><li><p>  Andere Dienste, die unser eigenes Dienstprogramm cli verwenden: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/ash set ‚Äìe healthcheck || exit 1</span></span></code> </pre> <br></li></ul><br><p>  Mit <code>runtime-deps.sh</code> werden Abh√§ngigkeiten installiert und bei Bedarf alle anderen Aktionen auf dem Basisbetriebssystem ausgef√ºhrt, die f√ºr das normale Funktionieren der Anwendung im Container erforderlich sind.  Typische Beispiele: </p><br><ul><li><p>  F√ºr eine Webanwendung: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/ash apk add --no-cache curl icu-libs</span></span></code> </pre> <br></li><li><p>  F√ºr den gRPC-Service: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/ash apk add --no-cache libc6-compat</span></span></code> </pre> <br></li></ul><br><p>  Daher ist die Art und Weise, wie Abh√§ngigkeiten verwaltet und der Status √ºberpr√ºft werden, standardisiert, es besteht jedoch Raum f√ºr eine gewisse Flexibilit√§t.  Was <code>run.sh</code> , so ist es weiter. </p><br><h2 id="entrypoint-skript">  Einstiegspunkt-Skript </h2><br><p>  Ich bin sicher, dass sich jeder, der mindestens einmal seine Docker-Datei geschrieben hat, gefragt hat, welche Direktive er verwenden soll - <code>CMD</code> oder <code>ENTRYPOINT</code> .  Dar√ºber hinaus verf√ºgen diese Teams √ºber zwei Syntaxoptionen, die sich am dramatischsten auf das Ergebnis auswirken.  Ich werde den Unterschied nicht im Detail erkl√§ren und nach denen wiederholen, die bereits <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">alles gekl√§rt haben</a> .  Ich empfehle nur daran zu denken, dass es in 99% der Situationen richtig ist, ENTRYPOINT und die Exec-Syntax zu verwenden: </p><br><p>  ENTRYPOINT ["/ path / to / ausf√ºhrbare Datei"] </p><br><p>  Andernfalls kann die gestartete Anwendung Betriebssystembefehle wie SIGTERM usw. nicht korrekt verarbeiten, und Sie k√∂nnen auch in Form von Zombie-Prozessen und allem, was mit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">dem PID 1-Problem zusammenh√§ngt</a> , in Schwierigkeiten geraten.  Was aber, wenn Sie den Container starten m√∂chten, ohne die Anwendung zu starten?  Ja, Sie k√∂nnen den Einstiegspunkt √ºberschreiben: <br> <code>docker run --rm -it --entrypoint ash &lt;image_name&gt; &lt;params&gt;</code> <br>  Es sieht nicht allzu bequem und intuitiv aus, oder?  Aber es gibt gute Neuigkeiten: Sie k√∂nnen es besser machen!  Verwenden Sie n√§mlich ein <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Einstiegspunktskript</a> .  Mit einem solchen Skript k√∂nnen Sie beliebig komplexe ( <a href="">Beispiel-</a> ) Initialisierungen, die Verarbeitung von Parametern und alles, was Sie m√∂chten, durchf√ºhren. </p><br><p>  In unserem Fall wird standardm√§√üig das einfachste, aber gleichzeitig funktionale Szenario verwendet: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh set -e if [ ! -z "$1" ] &amp;&amp; $(command -v $1 &gt;/dev/null 2&gt;&amp;1) then exec $@ else exec /usr/bin/dotnet /app/${ENTRY_PROJECT}.dll $@ fi</span></span></code> </pre> <br><p>  Damit k√∂nnen Sie den Start des Containers sehr intuitiv steuern: <br>  <code>docker run &lt;image&gt; env</code> - f√ºhrt nur env im Bild aus und zeigt Umgebungsvariablen an. <br>  <code>docker run &lt;image&gt; -param1 value1</code> - Starten Sie den Dienst mit den angegebenen Argumenten. </p><br><p>  Unabh√§ngig davon m√ºssen Sie auf den Befehl <code>exec</code> achten: Wenn er vor dem Aufruf der ausf√ºhrbaren Anwendung vorhanden ist, erh√§lt er die begehrte PID 1 in Ihrem Container. </p><br><h2 id="chto-esche">  Was sonst </h2><br><p>  Nat√ºrlich hat das Build-System in mehr als anderthalb Jahren viele verschiedene Funktionen gesammelt.  Neben der Verwaltung der Startbedingungen in verschiedenen Phasen, der Speicherung von Artefakten, der Versionierung und anderen Funktionen wurde auch unser ‚ÄûStandard‚Äú f√ºr den Container entwickelt.  Es wurde mit wichtigen Attributen gef√ºllt, die es vorhersehbarer und administrativ bequemer machen: </p><br><ul><li>  Alle erforderlichen Bildbezeichnungen sind installiert: Versionen, Versionsnummern, Links zur Dokumentation, Autor und andere. </li><li>  Im Laufzeitcontainer wird die NLog-Konfiguration neu definiert, sodass nach der Ver√∂ffentlichung alle Protokolle sofort in strukturierter Form mit json dargestellt werden, dessen Version versioniert ist. </li><li>  Statische Analyseregeln und andere Standards werden automatisch auf dem neuesten Stand gehalten. </li></ul><br><p>  Ein solches Tool kann nat√ºrlich immer verbessert und weiterentwickelt werden.  Es h√§ngt alles von den Bed√ºrfnissen und der Vorstellungskraft ab.  Zus√§tzlich zu allem war es beispielsweise m√∂glich, zus√§tzliche CLI-Dienstprogramme in ein Image zu packen.  Der Entwickler kann sie einfach in das Image einf√ºgen und in der Konfigurationsdatei nur den erforderlichen Dienstprogrammnamen und den Namen des .NET-Projekts <code>healthcheck</code> aus dem es zusammengestellt werden soll (z. B. unser <code>healthcheck</code> ). </p><br><h2 id="zaklyuchenie">  Fazit </h2><br><p>  Hier wird nur ein Teil eines integrierten Standardisierungsansatzes beschrieben.  Die Dienste selbst, die aus unseren Vorlagen erstellt werden, blieben hinter den Kulissen und sind daher durch viele Kriterien, wie einen einzigen Konfigurationsansatz, allgemeine Methoden f√ºr den Zugriff auf Metriken, Codegenerierung usw., ziemlich einheitlich.        .          ,  . </p><br><p>             ,      Linux    ,   -      .       , ,          . , ,  ,    Code Style,      ,           . </p><br><p> ,    !   ,    ¬´  ¬ª,       ,             .      ,    Docker        . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de468683/">https://habr.com/ru/post/de468683/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de468663/index.html">End2 End Approach in automatischen Spracherkennungsaufgaben</a></li>
<li><a href="../de468665/index.html">Aber ist es Zeit, einen Bew√§sserungsapparat zu kaufen?</a></li>
<li><a href="../de468673/index.html">Workshop "Gew√§hrleistung der Sicherheit personenbezogener Daten" - 3. Oktober, St. Petersburg</a></li>
<li><a href="../de468677/index.html">Die Ank√ºndigung des Smartphones Xiaomi Mi Mix Alpha</a></li>
<li><a href="../de468679/index.html">Das ABC der Sicherheit in Kubernetes: Authentifizierung, Autorisierung, Pr√ºfung</a></li>
<li><a href="../de468687/index.html">Wir analysieren die neuen Initiativen der Zentralbank zur Regulierung des Aktienmarktes: 3 Investorengruppen, Einschr√§nkungen f√ºr Anf√§nger</a></li>
<li><a href="../de468689/index.html">Registrierung Ihres IT-Gesch√§fts in Singapur: Was soll ich tun?</a></li>
<li><a href="../de468691/index.html">Gef√§hrliche Treiber von Drittanbietern auf Ihrem System oder LOLDrivers</a></li>
<li><a href="../de468693/index.html">Wie Automatisierung Walmart-Mitarbeiter zerst√∂rt</a></li>
<li><a href="../de468695/index.html">Mein erster Hack: Eine Site, auf der Sie ein beliebiges Benutzerkennwort festlegen k√∂nnen</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>