<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ•´ğŸ¿ ğŸ™‡ğŸ» ğŸ§‘ğŸ¿â€ğŸ¤â€ğŸ§‘ğŸ½ Menambal kode Java pada produksi tanpa anestesi ğŸ›´ ğŸ‘¨ğŸ½ âœï¸</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Di sini saya akan berbicara tentang perangkat salah satu dari banyak alat yang membantu dalam pengembangan berbagai layanan untuk proyek Odnoklassniki...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Menambal kode Java pada produksi tanpa anestesi</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/odnoklassniki/blog/429040/"><img src="https://habrastorage.org/webt/di/gh/wc/dighwcvw92d2zysgdcdref8_ptg.png" alt="gambar"><br><br>  Di sini saya akan berbicara tentang perangkat salah satu dari banyak alat yang membantu dalam pengembangan berbagai layanan untuk proyek Odnoklassniki.  Di dalam perusahaan, kami menyebutnya "Hot Code Replace" (HCR), dan alat ini dirancang untuk memperbaiki bug yang kritis dan tidak rumit dalam menjalankan layanan produksi tanpa menghentikannya.  Ini adalah fitur yang sangat penting, karena ini memungkinkan Anda untuk menghindari proses yang agak membosankan dan menghabiskan waktu dalam menyusun versi baru dari layanan sampah, untuk menghindari kehadiran jeda yang cukup lama dalam ketersediaan setiap host, dan untuk menghindari pembilasan cache. <br><br>  Secara umum, ini menghemat banyak waktu dan mengurangi interval sejak kesalahan terdeteksi hingga koreksi dari jam ke menit.  Paling sering, seperti yang direncanakan, kesalahan kecil dalam kode diperbaiki, misalnya, programmer lupa untuk memeriksa nol dan untuk beberapa pengguna tindakan tertentu di situs mengarah ke kesalahan.  Yaitu, ketika koreksi dilakukan dengan mengubah beberapa baris dalam metode.  Dan demi perubahan kecil seperti itu, Anda tidak perlu lagi mengganggu kolega Anda dan menunggu berjam-jam untuk produksi. <br><a name="habracut"></a><br>  Sebagai contoh: <br><br><img src="https://habrastorage.org/webt/ra/dh/vz/radhvzc9u4d1q6dc8r4v6uhlekq.png" alt="gambar"><br>  Anda dapat dengan mudah memperbaikinya pada: <br><br><img src="https://habrastorage.org/webt/rp/9i/ta/rp9itax-od_0ahz3yg8dxdxvf7u.png" alt="gambar"><br>  Tentu saja, Anda dapat membuat lebih banyak perubahan, pada saat yang sama menambahkan kelas baru, dengan cepat membuat perubahan yang diminta manajer pada saat yang sama, tanpa menunggu pembaruan berikutnya.  Tapi ini sudah, jika Monsieur tahu banyak tentang penyimpangan. <br><br>  Lebih lanjut, adalah mungkin untuk menempatkan "tambalan" satu sama lain dan hingga tak terbatas. <br><br>  Tetapi alat ini tidak mahakuasa dan didasarkan pada fungsi standar yang ditawarkan oleh kelas Java: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">java.lang.instrument.Instrumentation dan metodenya batal redefineClasses (definisi ClassDefinition ...)</a> . <br><br>  Instrumentation.redefineClasses menggantikan kelas yang sebelumnya dimuat dengan kode byte baru.  Anda dapat membebani beberapa kelas dengan dependensi berbeda secara bersamaan.  Overloading tidak mengubah instance kelas yang ada, tidak mengubah inheritance, dan tidak menyentuh bidang instance atau kelas.  Anda hanya dapat mengubah tubuh metode, kumpulan konstanta dan atribut.  Anda dapat menambahkan kelas atau subclass baru.  Tanda tangan metode, bidang contoh, dan bidang kelas tidak dapat diubah.  Jika Anda mencoba membuat perubahan yang tidak kompatibel, redefineClasses pada prinsipnya tidak akan berfungsi dan akan menimbulkan kesalahan.  Harus diingat bahwa ketika kelas overload, eksekusi bagian kode overload tidak terganggu, bytecode baru akan digunakan saat metode yang sama dipanggil.  Dan karena itu, jika Anda mencoba untuk memperbaiki kode metode yang memiliki siklus yang sangat panjang di dalamnya, maka penggantian yang sebenarnya akan terjadi hanya setelah siklus ini berakhir. <br><br>  Jika cukup sederhana: Anda dapat mengubah kode hanya di dalam metode dan intinya. <br><br>  Dan di sini adalah contoh loop sementara, yang sampai metode selesai, tidak akan diperbaiki. <br><br><img src="https://habrastorage.org/webt/p7/rv/1a/p7rv1agfvd0f7phg4otdxedkohk.png" alt="gambar"><br><br>  Kesulitan utama adalah membuat alat yang bekerja di ekosistem Odnoklassniki, alat yang cocok dengan semua proses kerja yang ada.  Yang akan secara konsisten dan transparan berinteraksi dengan semua layanan di ratusan host, serta menjadi fleksibel dan mudah digunakan.  Alat ini harus mengatasi lusinan percobaan, pekerjaan, dan pembaruan yang terus-menerus terjadi pada produksi. <br><br>  Bagaimana proses menginstal tambalan terlihat seperti dari pengembang / admin mencoba untuk memperbaiki bug pada produksi, tetapi sehingga dapat dilakukan menggunakan beberapa prosedur standar dan dapat diandalkan pada lusinan server.  Kami menghilangkan proses menemukan dan memperbaiki kesalahan dalam kode. <br><br>  1. Brunch terpisah dibuat di GIT untuk perbaikan kode.  Menggunakan versi sangat penting bukan hanya karena kenyamanan, tetapi juga untuk penyelidikan selanjutnya. <br><br>  2. TeamCity meluncurkan proses pembuatan patch.  Pertama, perakitan proyek dibuat dari brunch yang ditentukan, dan kemudian perakitan baru dibandingkan dengan yang dipasang pada produksi.  Untuk melakukan ini, saya menulis plug-in untuk alat build, yang mengekstrak semua file dari arsip, membandingkan perbedaan dan memilih hanya file-file yang telah diubah atau ditambahkan.  Dalam hal ini, versi Java compiler di kedua majelis harus sama, karena  versi lain dari kompiler akan membuat file yang berbeda dan hampir semua file proyek akan dimasukkan dalam tambalan.  Sangat penting untuk membuat arsip kecil saja, di mana hanya file yang diperlukan saja yang akan didapat  Ini secara signifikan akan mempercepat proses pengiriman tambalan ke puluhan server.  Proses pembangunan tidak hanya cocok untuk tambalan kode proyek, tetapi Anda juga dapat mengganti pustaka yang ditambal dalam proyek.  Ketika membandingkan konten dari dua majelis, perbedaan akan ditemukan di perpustakaan (file jar). <br><br>  3. Jika perakitan berhasil, tambalan dikirim ke repositori khusus, dan di jendela hasil dikeluarkan kunci (atau hash), yang diperlukan untuk mengidentifikasi tambalan secara unik dan beberapa jaminan bahwa kode ini akan sampai ke produksi. <br><br><img src="https://habrastorage.org/webt/7v/c5/es/7vc5esvpyls4kbc-djqnyxp5owq.png" alt="gambar"><br><br>  Nah, dan lagi - Anda dapat menambal jumlah yang tidak terbatas kali dan membangun dengan nomor versi yang sama akan berbeda dengan hash. <br><br>  4. Selanjutnya, semua aktivitas ditransfer ke layanan konfigurasi, di mana di UI biasa Anda dapat menentukan untuk layanan mana, di mana host dan versi aplikasi yang Anda perlu tambal. <br><br><img src="https://habrastorage.org/webt/pd/qf/um/pdqfummd7yqcqr0igjjbdshtnqk.png" alt="gambar"><br><br>  Banyaknya parameter memberikan tingkat fleksibilitas pengaturan yang diperlukan, yang sangat penting di kebun binatang besar dari banyak server.  Katakanlah pada beberapa bagian server nomor versi aplikasi berbeda, dan Anda tidak perlu menambal kode ini sama sekali.  Atau, untuk verifikasi, Hot Code Rreplace pertama kali diluncurkan pada satu server, atau pada sekelompok server, dan kemudian didistribusikan di semua instance aplikasi. <br><br>  5. Melalui perubahan konfigurasi, layanan yang dipilih menerima informasi tentang apa yang perlu dipasang patch, versi dan hash verifikasi.  Idenya adalah bahwa semua layanan menerima perintah "instal patch" dan kemudian bertindak secara independen.  Mereka secara independen membandingkan versi mereka sendiri dan hanya jika versi cocok dan hash dari tambalan hilang atau berbeda, mereka secara mandiri mengunduh rakitan tambalan dari repositori.  Proses unduhan itu sendiri terjadi melalui HTTP, dan Anda dapat dengan cepat mengubah alamat repositori, jumlah upaya unduhan dan masa tunggu antar percobaan. <br><br>  6. Setiap aplikasi secara lokal memeriksa hash rakitan dan membukanya.  Pada saat yang sama, setiap file diperiksa untuk keberadaannya dalam array di antara yang dikembalikan oleh Instrumentation.getAllLoadedClasses (), semua kelas dan file baru ditulis ke yang baru - classpath sementara, dan classpath ini ditambahkan melalui Instrumentation.appendToSystemClassLoaderSearch (), dan kelas yang ada dibaca ke dalam memori dan melewati metode redefineClasses. <br><br>  7. Seluruh proses: kedatangan sinyal tentang perlunya menambal aplikasi, pengunduhan, verifikasi, pembongkaran dan aplikasi dicatat secara rinci, baik dalam log umum dengan aplikasi dan sendiri, sehingga Anda dapat dengan cepat dan tanpa gerakan yang tidak perlu memantau proses. <br><br>  8. Setelah tambalan berhasil diterapkan, proses berakhir dengan mengubah versi aplikasi menjadi tambalan dengan menambahkan baris yang dibuat khusus termasuk patch hash.  Jika untuk beberapa host versi tidak berubah ke yang diharapkan, kita pergi ke log Hot Code Replace untuk host itu dan melihat apa yang terjadi di sana.  Jika ini adalah masalah komunikasi, maka Anda dapat dengan aman mengulangi perintah tambalan dan host yang diinginkan akan mencoba lagi. <br><br>  Apa masalah yang mungkin dapat mencegah aplikasi dari patch?  Ada beberapa dari mereka, dan di antara mereka fungsi dari kelas Instrumentasi saya akan menempatkan di tempat terakhir.  Hingga saat ini, kode bengkok yang tidak memenuhi persyaratan ketat redefineClasses selalu di-flash oleh JVM tanpa konsekuensi apa pun untuk aplikasi tersebut.  Saat menerapkan metode redefineClasses, JVM sepenuhnya menghentikan aplikasi, tetapi proses ini membutuhkan waktu sepersekian detik.  Karena sama sekali tidak menakutkan. <br><br>  Momen paling berisiko adalah pengiriman tambalan ke server, yang diputuskan oleh pelatihan ulang tambahan.  Tetapi jika penelusuran ulang tidak membantu, maka Anda dapat mengulangi perintah untuk memanggil tambalan dan masing-masing host akan mencoba mengulangi prosesnya, tetapi instal tambalan hanya jika perlu, mis.  tambalan belum diinstal sebelumnya atau jika kunci hash telah berubah. <br><br>  Masalah potensial lainnya adalah ketika perbaikan tersebut memperbaiki satu kesalahan dan menambahkan yang baru.  Untuk meminimalkan risiko ini, pertama-tama kami unggah tambalan ke sejumlah server, lihat log, bagan, dan pantau hasilnya.  Dan baru setelah itu kami meluncurkan koreksi ke host lain. <br><br>  Apa yang harus dilakukan dengan memulai ulang aplikasi atau server?  Ini sudah tertanam dalam logika semua aplikasi teman sekelas: salah satu yang pertama dalam aplikasi apa pun adalah modul HCR.  Dan jika selama inisialisasi informasi tentang perlunya patch aplikasi diperhatikan, patch akan diterapkan terlebih dahulu. <br><br>  Dan sekarang sedikit tentang apa terdiri dari Hot Code Replace. <br><br><ol><li>  JavaAgent kami.  JavaAgent, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">jika ada yang lupa</a> , ini adalah arsip * .jar yang terpisah dan dibentuk secara khusus yang diambil oleh JVM ketika aplikasi mulai menggunakan parameter tambahan, misalnya: -javaagent: /path/to/lib/my-agent.jar Berkat fitur tambahan Javaagent- dan dimungkinkan untuk menggunakan sihir pengganti kode.  Di agen itulah kelas java.lang.instrument.Instrumentation tersedia.  Tapi, saya tidak menyumbat dia (agen) dengan kode tambahan, karena  Pembaruan agen adalah tugas yang tidak sepele, tetapi cukup memindahkan instance dari kelas Instrumentasi ke bidang statis dari kelas utilitas.  Dengan demikian, semua manipulasi dapat dimulai dari mana saja di aplikasi. </li><li>  Layanan konfigurasi - bertanggung jawab atas konfigurasi salah satu aplikasi kami dan oleh karena itu diinisialisasi dalam setiap aplikasi terlebih dahulu.  Di sanalah fungsi utama Hot Code Replace disembunyikan.  Pada startup aplikasi atau ketika mengubah konfigurasi HCR untuk aplikasi tertentu, kompatibilitas versi diperiksa dan semua manipulasi di atas dilakukan. </li><li>  TeamCity dan membangun skrip - untuk dengan mudah membuat "tambalan" dan hanya menyimpan kelas dan sumber daya yang dimodifikasi atau ditambahkan di dalamnya. </li></ol><br>  Apa kelebihan yang kita miliki dari alat ini?  Yang pertama adalah kecepatan memperbaiki kesalahan kritis pada prod.  Dari log, saya melihat bahwa rekan kerja secara bertahap mulai menggunakan HCR semakin sering, alih-alih menunggu rilis.  Berikutnya adalah kecepatan aplikasi.  Aplikasi tidak perlu dihentikan, JVM hanya membeku selama sepersekian detik dan semua benda Anda tetap di tempatnya masing-masing dan terus bekerja. <br><br>  Dan pengembang kami sembuh secara bebas dan bahagia dan memperbaiki kesalahan mereka dengan segera dan secara mandiri langsung dalam produksi tanpa memperhatikan jumlah server dan beban. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id429040/">https://habr.com/ru/post/id429040/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id429030/index.html">Logomachine membuat logo gratis per komentar</a></li>
<li><a href="../id429032/index.html">Splunk Essentials untuk Aplikasi Industri Layanan Keuangan, atau bagaimana Splunk memasuki pasar analitik keuangan</a></li>
<li><a href="../id429034/index.html">Beberapa cerita tentang programmer bawah tanah</a></li>
<li><a href="../id429036/index.html">Percayalah, saya tahu apa yang saya lakukan: adaptasi otomatis dari robot modular ke lingkungan pelaksanaan tugas</a></li>
<li><a href="../id429038/index.html">Rust News # 2 (Oktober 2018)</a></li>
<li><a href="../id429042/index.html">Kami sedang menguji SharxBase, platform virtualisasi perangkat lunak dan perangkat keras dari vendor Rusia SharxDC</a></li>
<li><a href="../id429044/index.html">Saham Apple telah mengalami kejatuhan terburuk sejak 2014. Investor besar telah kehilangan miliaran</a></li>
<li><a href="../id429046/index.html">Empat tahun pengembangan SObjectizer-5.5. Bagaimana SObjectizer berubah selama waktu ini?</a></li>
<li><a href="../id429048/index.html">Kiat untuk pemula hoster</a></li>
<li><a href="../id429050/index.html">Serangan pertukaran Gate.io cryptocurrency direkam</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>