<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üó®Ô∏è üå´Ô∏è üêî Como conectei computadores e usu√°rios a portas de dispositivos de rede no programa de monitoramento Network MACMonitor üë©üèª‚Äçüöí üë®üèΩ‚Äçüè≠ üåµ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sou desenvolvedor do software de monitoramento de rede Network MACMonitor . 


 No processo de desenvolvimento do programa, surgiu uma tarefa: determi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como conectei computadores e usu√°rios a portas de dispositivos de rede no programa de monitoramento Network MACMonitor</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/macmonitor/blog/416217/"><p>  Sou desenvolvedor do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">software de</a> monitoramento de rede <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Network MACMonitor</a> . </p><br><p>  No processo de desenvolvimento do programa, surgiu uma tarefa: determinar quais computadores os usu√°rios est√£o usando e associar essas informa√ß√µes √†s portas dos dispositivos de rede.  Neste artigo, quero escrever como consegui fazer isso. </p><br><p><img src="https://habrastorage.org/webt/ab/uf/qc/abufqc8euaofveu4dqt-htkaqrm.png" alt="imagem"></p><a name="habracut"></a><br><p>  Comecei com considera√ß√µes simples: para associar um usu√°rio a uma porta em um dispositivo de rede, voc√™ deve primeiro conectar o computador com o qual o usu√°rio est√° trabalhando nessa porta.  Como o programa Network MACMonitor permite encontrar endere√ßos mac nas portas dos dispositivos de rede, foi decidido conectar computadores √†s portas usando endere√ßos mac.  Em seguida, voc√™ precisa conectar usu√°rios a computadores.  Esta informa√ß√£o pode ser obtida interrogando computadores de qualquer maneira. </p><br><p>  Vi duas op√ß√µes para resolver esse problema: </p><br><ol><li>  Escreva um agente do Windows e interrogue-o usando o Network MACMonitor; </li><li>  Use a WMI (Instrumenta√ß√£o de Gerenciamento do Windows). </li></ol><br><p>  A vers√£o com o agente do Windows tem v√°rias desvantagens significativas para mim: </p><br><ul><li>  desenvolvimento de um protocolo seguro para intera√ß√£o em rede de um agente Windows com o Network MACMonitor; </li><li>  a necessidade de pr√©-instalar o agente nos computadores; </li><li>  usando uma linguagem de programa√ß√£o diferente (escrevo em Java), j√° que considero o Java inadequado para escrever um agente: devido ao grande consumo de mem√≥ria virtual e √† necessidade de instalar o JRE em todos os computadores. </li></ul><br><p>  Por causa de todas as desvantagens acima, decidi me debru√ßar sobre a op√ß√£o usando o WMI. </p><br><h3>  Desenvolvimento de cliente WMI </h3><br><p>  Como o Network MACMonitor √© escrito em Java, tentei encontrar uma biblioteca Java pronta para plataforma que implementa a funcionalidade do cliente WMI.  E ent√£o fiquei desapontado - n√£o existe tal biblioteca.  Todas as bibliotecas existentes s√£o wrappers nos utilit√°rios do Windows ou (biblioteca j-Interop) requerem manipula√ß√£o adicional do registro (altera√ß√£o de propriedade e permiss√µes nas ramifica√ß√µes do registro) para ativar o WMI por meio de um registro remoto.  Como n√£o havia uma biblioteca totalmente funcional para Java, decidi encontrar uma biblioteca ou um cliente WMI gravado em qualquer outra linguagem de programa√ß√£o.  E encontrou um cliente WMI para Linux.  Depois de baixar e verificar seu trabalho, percebi que √© poss√≠vel pesquisar computadores com Windows no Linux. </p><br><p>  Se isso for poss√≠vel, decidi escrever minha biblioteca em Java puro, o que me permitiria pesquisar o computador usando o WMI. </p><br><p>  Para escrever a biblioteca, era necess√°ria documenta√ß√£o clara sobre a opera√ß√£o do protocolo WMI.  Descobriu-se que existe essa documenta√ß√£o e √© de dom√≠nio p√∫blico. </p><br><p>  Comecei a me preparar para escrever a biblioteca olhando a pilha de rede do protocolo WMI. </p><br><table><tbody><tr><th>  Protocolo </th><th>  Especifica√ß√µes </th></tr><tr><td>  Instrumenta√ß√£o de Gerenciamento do Windows (WMI) </td><td>  MS-WMI, MS-WMIO </td></tr><tr><td>  Modelo de Objeto Distribu√≠do (DCOM) </td><td>  MS-DCOM </td></tr><tr><td>  Chamada de procedimento remoto (RPC) </td><td>  MS-RPCE </td></tr><tr><td>  Protocolo de controle de transmiss√£o (TCP) </td><td>  - </td></tr><tr><td>  Protocolo de Internet (IP) </td><td>  - </td></tr></tbody></table><br><p>  Para que o WMI funcione corretamente, todos os n√≠veis de pilha devem ser implementados. </p><br><p>  Como o WMI n√£o foi implementado em Java, passei para o pr√≥ximo protocolo na pilha - DCOM.  E aqui eu tive sorte.  Embora a biblioteca j-Interop acima mencionada n√£o implemente a funcionalidade WMI, a funcionalidade DCOM √© implementada nela.  Portanto, resta escrever uma implementa√ß√£o do protocolo WMI, ou seja, gravar uma implementa√ß√£o das especifica√ß√µes MS-WMI e MS-WMIO. </p><br><p>  Comecei implementando a especifica√ß√£o MS-WMIO, respons√°vel pelo formato de codifica√ß√£o de dados em pacotes de rede do protocolo WMI.  Pela especifica√ß√£o, aprendi que, ao codificar dados, √© usada a especifica√ß√£o de sintaxe estendida de Backus-Naur (ABNF, RFC 5234).  A especifica√ß√£o MS-WMIO descreve completamente o formato de codifica√ß√£o usando o ABNF.  Sabe-se que, se houver uma gram√°tica descrita no ABNF, √© poss√≠vel criar um analisador para essa gram√°tica.  Na Internet, encontrei um gerador de analisador ABNF para Java e o inseri com uma gram√°tica extra√≠da da especifica√ß√£o.  Como o analisador gerado trabalhava com seq√º√™ncias de caracteres, e o MS-WMIO descreve um formato de codifica√ß√£o bin√°ria, a id√©ia era simplesmente substituir o analisador gerado por seq√º√™ncias de caracteres por matrizes e caracteres com bytes.  Mas, analisando o n√∫mero de arquivos em que era necess√°ria uma substitui√ß√£o e tamb√©m aprendendo com a especifica√ß√£o do MS-WMIO que √†s vezes seria necess√°rio trabalhar com bits, percebi que seria muito dif√≠cil corrigir o analisador gerado e decidi abandonar essa id√©ia.  Eu pensei que escrever um analisador do zero seria mais r√°pido.  E agora o analisador estava pronto. </p><br><p>  Mas como verificar se o analisador foi gravado corretamente se a especifica√ß√£o MS-WMI, respons√°vel pela opera√ß√£o do protocolo WMI, ainda n√£o foi implementada?  Ent√£o o Wireshark, um analisador de tr√°fego de rede, me ajudou.  Depois de fazer solicita√ß√µes WMI usando as ferramentas padr√£o do Windows (wbemtest), tendo desabilitado a criptografia anteriormente, recebi pacotes de rede e os salvei em arquivos bin√°rios.  J√° era poss√≠vel usar esses arquivos como dados de teste para o analisador. </p><br><p>  Quando o analisador foi testado e os erros encontrados foram corrigidos, continuei implementando a especifica√ß√£o MS-WMI, que descreve a opera√ß√£o do protocolo WMI. </p><br><p>  A especifica√ß√£o MS-WMI √© dividida em servidor e cliente.  Implementei parcialmente a parte do cliente, na medida necess√°ria para pesquisar um computador via WMI.  Nesta parte, eu tamb√©m precisava do Wireshark, mas j√° analisava a sequ√™ncia de pacotes de rede durante a pesquisa WMI. </p><br><h3 id="popytka-polucheniya-neobhodimyh-dannyh-s-pomoschyu-wmi">  Tentando obter os dados necess√°rios usando o WMI </h3><br><p>  Depois de escrever a biblioteca WMI, tornou-se a tarefa de us√°-la no programa Network MACMonitor.  Surgiu a pergunta: que dados devem ser obtidos dos computadores?  Eu pensei que precisava obter o nome do computador, dom√≠nio, sistema operacional, tempo de ativa√ß√£o, endere√ßos mac, endere√ßos IP, usu√°rios ativos que trabalham no computador. </p><br><p>  Mas surgiu um problema muito importante: como identificar um computador exclusivamente durante a pesquisa WMI?  Eu considerei as seguintes op√ß√µes: </p><br><ul><li>  endere√ßo MAC, poss√≠vel altera√ß√£o, poss√≠vel n√£o exclusivo; </li><li>  nome e dom√≠nio do computador (grupo de trabalho), altera√ß√£o poss√≠vel, n√£o exclusiva (para grupo de trabalho); </li><li>  o n√∫mero de s√©rie do disco r√≠gido em que o sistema operacional est√° instalado, os direitos de administrador s√£o necess√°rios durante a pesquisa WMI, n√£o verifiquei a exclusividade, mas suspeito que n√£o √© poss√≠vel; </li><li>  o n√∫mero de s√©rie da placa-m√£e, n√£o exclusivo, √© poss√≠vel e com bastante frequ√™ncia; </li><li>  o identificador do sistema de computador (propriedade <em>UUID</em> WMI da classe <em>Win32_ComputerSystemProduct</em> ), a n√£o exclusividade √© poss√≠vel e com bastante frequ√™ncia; </li><li>  o tempo de instala√ß√£o do sistema operacional √© a melhor de todas as op√ß√µes, mas a unicidade √© poss√≠vel ao clonar o sistema ou ao implantar a partir de uma imagem. </li></ul><br><p>  Nenhuma op√ß√£o permite que voc√™ identifique exclusivamente o computador, ent√£o decidi identific√°-lo de tr√™s maneiras: </p><br><ul><li>  n√∫mero de s√©rie da placa m√£e, </li><li>  identificador do sistema de computador </li><li>  tempo de instala√ß√£o do sistema operacional. </li></ul><br><p>  Obviamente, esses tr√™s par√¢metros podem coincidir em computadores diferentes, mas com menos frequ√™ncia que um deles. </p><br><p>  Tamb√©m foi feita uma tentativa de obter usu√°rios ativos usando a classe WMI padr√£o: <em>Win32_LogonSession</em> .  Em seguida, o primeiro problema apareceu: o <em>Win32_LogonSession</em> mostra todas as sess√µes do usu√°rio, mesmo aquelas que j√° foram conclu√≠das.  Comecei a pensar em como filtrar as sess√µes ativas daquelas que terminavam.  Verificou que isso pode ser feito usando a classe <em>Win32_SessionProcess</em> , que associa inst√¢ncias das classes <em>Win32_LogonSession</em> ao <em>Win32_Process</em> .  Se o link para a sess√£o estiver presente na lista de inst√¢ncias da classe <em>Win32_SessionProcess</em> (h√° pelo menos um processo com o identificador desta sess√£o), ele estar√° ativo.  Em seguida, surgiu a pergunta sobre como associar uma sess√£o a um usu√°rio.  Isso pode ser feito usando a classe <em>Win32_LoggedOnUser</em> , que vincula inst√¢ncias das <em>classes Win32_LogonSession</em> e <em>Win32_UserAccount</em> .  Resta apenas obter inst√¢ncias da classe <em>Win32_UserAccount</em> que fornecem informa√ß√µes detalhadas sobre o usu√°rio. </p><br><p><img src="https://habrastorage.org/webt/gq/0x/vg/gq0xvgaauo2dtpkmzajpife-x5g.png" alt="imagem"></p><br><p>  Mas aqui fiquei desapontado.  Ao usar o WMI remotamente, descobriu-se que, ao tentar obter inst√¢ncias da classe <em>Win32_UserAccount</em> , √© poss√≠vel obter apenas usu√°rios de computadores locais.  Ou seja, descobriu-se que, usando as ferramentas WMI padr√£o, √© imposs√≠vel descobrir quais usu√°rios est√£o ativos no computador. </p><br><h3 id="razrabotka-wmi-provaydera">  Desenvolvimento de um provedor WMI. </h3><br><p>  Devido √† impossibilidade de identifica√ß√£o inequ√≠voca de computadores e √† impossibilidade de obter informa√ß√µes sobre usu√°rios ativos usando classes WMI padr√£o, decidiu-se expandir a funcionalidade do WMI.  Voc√™ pode fazer isso descrevendo suas classes WMI em um arquivo MOF e gravando um provedor WMI para obter inst√¢ncias dessas classes. </p><br><p>  Duas novas classes WMI foram descritas: <em>NMBY_InstallInfo</em> - para identificar um computador e <em>NMBY_LogonSession</em> - para identificar usu√°rios ativos de um computador. </p><br><p><img src="https://habrastorage.org/webt/5b/op/gi/5bopgiwlndpdgqpb7h2zdhqbyxg.png" alt="imagem"></p><br><p>  Em seguida, um provedor WMI foi escrito com o qual voc√™ pode obter inst√¢ncias dessas classes. </p><br><p>  Requisitos adicionais foram definidos para o provedor: </p><br><ul><li>  trabalhar em um sistema sem .NET; </li><li>  trabalhar no sistema operacional Windows XP e superior; </li><li>  a capacidade de obter informa√ß√µes usando uma conta n√£o administrativa. </li></ul><br><p>  Portanto, o provedor foi gravado em C ++ usando o WinApi. </p><br><p>  No processo de escrita do provedor, surgiram dificuldades devido √† pequena quantidade e qualidade da documenta√ß√£o sobre esse t√≥pico, mas, apesar disso, o fornecedor foi gravado com √™xito. </p><br><p>  Um provedor por escrito est√° dispon√≠vel na p√°gina de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">download</a> .  Pode ser instalado e usado gratuitamente. </p><br><h3 id="itog">  Sum√°rio </h3><br><p>  Como resultado, usando o programa Network MACMonitor, tornou-se poss√≠vel: </p><br><ul><li>  Associar usu√°rios a computadores </li></ul><br><p><img src="https://habrastorage.org/webt/u7/zn/op/u7znop78jhskuqgge9w7axw1i5g.png" alt="imagem"></p><br><ul><li>  Associar computadores a portas em dispositivos de rede </li></ul><br><p><img src="https://habrastorage.org/webt/ri/53/zq/ri53zqdcphgvs9q5xnyqtc2wdjs.png" alt="imagem"></p><br><ul><li>  Associar portas de dispositivos de rede a computadores e usu√°rios </li></ul><br><p><img src="https://habrastorage.org/webt/_0/t-/ks/_0t-kseg8qqmzmxobo4z138hb54.png" alt="imagem"></p><br><ul><li>  Exibir o hist√≥rico de registro do usu√°rio nos computadores. </li></ul><br><p><img src="https://habrastorage.org/webt/wp/u0/aa/wpu0aat6iwqqappksaq_vem9-yw.png" alt="imagem"></p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Site do programa</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt416217/">https://habr.com/ru/post/pt416217/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt416207/index.html">‚ÄúN√£o √© pior do que em Hogwarts‚Äù - futuros alunos falam sobre TI</a></li>
<li><a href="../pt416209/index.html">DeepMind n√£o pode parar: a IA pode jogar a Arena Quake III agora</a></li>
<li><a href="../pt416211/index.html">Neur√¥nios em 5 minutos</a></li>
<li><a href="../pt416213/index.html">Semin√°rio on-line aberto "Inje√ß√£o de depend√™ncia em angular"</a></li>
<li><a href="../pt416215/index.html">Food Design Digest Junho 2018</a></li>
<li><a href="../pt416219/index.html">Yandex come√ßou a indexar o Google Docs com senhas</a></li>
<li><a href="../pt416229/index.html">10 livros sobre marketing e t√≥picos relacionados que um designer deve ler</a></li>
<li><a href="../pt416231/index.html">Monitorando salas Zadarma Zabbix</a></li>
<li><a href="../pt416235/index.html">Criando componentes personalizados para o Bootstrap 4</a></li>
<li><a href="../pt416237/index.html">Como se tornar um designer: do freelancer de um albergue ao trabalho com as principais empresas e ao lan√ßamento do seu produto</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>