<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‡ğŸ» ğŸ‘©ğŸ¿â€ğŸš’ ğŸŸï¸ äº¤æœ‹å‹CIï¼Œå•å…ƒæµ‹è¯•å’Œæ•°æ®åº“ ğŸ¤ª ğŸ‡ ğŸ¥¦</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="æœ¬æ–‡æ˜¯å…³äºåœ¨CIä¸­æµ‹è¯•ä¸æ•°æ®åº“çš„äº¤äº’ã€‚ æˆ‘çœ‹åˆ°äº†ä¸€äº›ä½¿ç”¨dockerå’Œtestcontainerçš„è§£å†³æ–¹æ¡ˆï¼Œä½†æ˜¯æˆ‘æœ‰è‡ªå·±çš„å¹¶ä¸”æƒ³è¦å…±äº«ã€‚ 

 æˆ‘è¿‡å»çš„Javaé¡¹ç›®ä¸æ•°æ®åº“ç´§å¯†ç›¸å…³ã€‚ é‡è¯•ï¼Œå¤šçº¿ç¨‹å’Œé”å®šé”çš„é•¿æ—¶é—´å¤„ç†ã€‚ å¯¹äºæ­¤ä»»åŠ¡ï¼Œéœ€è¦æ›´æ­£å‡ ä¸ªæ£˜æ‰‹çš„SQLæŸ¥è¯¢ã€‚ æˆ‘æ›¾ç»ä¹ æƒ¯äºç”¨æµ‹è¯•è¦†ç›–æˆ‘çš„ä»£ç ï¼Œä½†æ˜¯...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>äº¤æœ‹å‹CIï¼Œå•å…ƒæµ‹è¯•å’Œæ•°æ®åº“</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/452722/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/p9/2f/hw/p92fhwlfahzagt8w9wzxpfclgzw.png" alt="å›¾ç‰‡"></div><br> æœ¬æ–‡æ˜¯å…³äºåœ¨CIä¸­æµ‹è¯•ä¸æ•°æ®åº“çš„äº¤äº’ã€‚ æˆ‘çœ‹åˆ°äº†ä¸€äº›ä½¿ç”¨dockerå’Œtestcontainerçš„è§£å†³æ–¹æ¡ˆï¼Œä½†æ˜¯æˆ‘æœ‰è‡ªå·±çš„å¹¶ä¸”æƒ³è¦å…±äº«ã€‚ <br><a name="habracut"></a><br> æˆ‘è¿‡å»çš„Javaé¡¹ç›®ä¸æ•°æ®åº“ç´§å¯†ç›¸å…³ã€‚ é‡è¯•ï¼Œå¤šçº¿ç¨‹å’Œé”å®šé”çš„é•¿æ—¶é—´å¤„ç†ã€‚ å¯¹äºæ­¤ä»»åŠ¡ï¼Œéœ€è¦æ›´æ­£å‡ ä¸ªæ£˜æ‰‹çš„SQLæŸ¥è¯¢ã€‚ æˆ‘æ›¾ç»ä¹ æƒ¯äºç”¨æµ‹è¯•è¦†ç›–æˆ‘çš„ä»£ç ï¼Œä½†æ˜¯åœ¨æ­¤ä¹‹å‰ï¼Œæ‰€æœ‰SQLéƒ½ç®€åŒ–ä¸ºåŸå§‹æŸ¥è¯¢ï¼Œå¹¶ä¸”å¯ä»¥åœ¨å†…å­˜çš„H2åŸºç¡€ä¸Šè¿è¡Œã€‚ è€Œè¿™é‡Œæ˜¯é“æ†ã€‚ <br><br> æˆ‘å¯ä»¥ç”¨æ‰‹æµ‹è¯•ç®€å•çš„SQLï¼Œç„¶åèƒ†æ€¯åœ°è¿›è¡Œè‡ªæˆ‘æµ‹è¯•ï¼Œä»¥è¯æ˜è‡ªå·±â€œæˆ‘ä¸æ˜¯æŸç§æ–¹å¼ï¼Œæˆ‘ä¼šåœ¨ç®€å•çš„ä»£ç ä¸­çŠ¯é”™è¯¯ã€‚â€ å®é™…ä¸Šï¼Œç”±äºæµ‹è¯•çš„å¯ç”¨æ€§ï¼Œé”™è¯¯å‡ºç°çš„é¢‘ç‡é™ä½äº†ã€‚ å¯ä»¥å°†è´£ä»»æ¨ç»™æµ‹è¯•äººå‘˜-å¦‚æœæˆ‘åœ¨æŸä¸ªåœ°æ–¹çŠ¯äº†ä¸€ä¸ªé”™è¯¯ï¼Œä»–ä»¬ä¼šå‘ç°ã€‚ <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/js/ro/nh/jsronhgbydvhziosboj6velwb5w.png" alt="å›¾ç‰‡"></div><br> æ ¹æ®å•å…ƒæµ‹è¯•çš„æ€æƒ³ï¼Œä»…å¯¹äºæµ‹è¯•å•ä¸ªæ¨¡å—æ‰éœ€è¦è¿›è¡Œæµ‹è¯•ï¼Œå¦‚æœæ¨¡å—ä½¿ç”¨äº†å¤–éƒ¨çš„ä¸œè¥¿ï¼Œåˆ™åº”å°†å…¶æ›¿æ¢ä¸ºå­˜æ ¹ã€‚ å®é™…ä¸Šï¼Œå½“å®ç°å­˜æ ¹å˜å¾—å¤ªå›°éš¾æ—¶ï¼Œå°†ç®€å•åœ°å¿½ç•¥è¯¥æ¨¡å—ã€‚ é€Ÿåº¦å’Œæ¨¡å—åŒ–å¾ˆé‡è¦ï¼Œä½†æ˜¯æ›´é‡è¦çš„æ˜¯ï¼Œå³ä½¿ä»£ç æœªå‡ºç°åœ¨è¦†ç›–ç‡æŒ‡æ ‡ä¸­ï¼Œä¹Ÿè¯·ä¸è¦å¯¹å…¶è¿›è¡Œæµ‹è¯•ã€‚ å› æ­¤ï¼Œè¯¥æ¨¡å—ä¸å†è¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªå•ç‹¬çš„ç±»ï¼Œè€Œæ˜¯ä¸€ä¸ªè¿æ¥çš„ç»„ä»¥åŠé…ç½®ã€‚ è¿™æ ·çš„è¯­å¥çš„ä¸»è¦ç›®çš„ä¸æ˜¯è¦è¾¾åˆ°å°†å•å…ƒæ‰©å±•åˆ°é›†ç¾¤çº§åˆ«çš„æ¦‚å¿µã€‚ <br><br> å¯¹äºæœ¬åœ°æµ‹è¯•ï¼Œæ¯ä¸ªå¼€å‘äººå‘˜éƒ½æœ‰è‡ªå·±çš„æ–¹æ¡ˆï¼Œä½†æ˜¯æµ‹è¯•æ˜¯åœ¨Jenkinsä¸Šè¿è¡Œçš„ï¼Œç›®å‰è¿˜æ²¡æœ‰ä¸æ•°æ®åº“çš„è¿æ¥ã€‚  CIéœ€è¦å•ç‹¬çš„ç”µè·¯ï¼Œè¿™ä¼¼ä¹æ˜¯æ˜¾è€Œæ˜“è§çš„ã€‚ ä½†æ˜¯åœ¨ä¸€ä¸ªç©ºçš„å›¾è¡¨ä¸Šï¼Œè¿è¡Œæµ‹è¯•ä¸æ˜¯å¾ˆæ­£ç¡®ï¼›åœ¨æ¯ä¸ªæµ‹è¯•ä¸­åˆ›å»ºæ•°æ®åº“ç»“æ„éå¸¸è€—æ—¶ï¼Œå¹¶ä¸”åœ¨æµ‹è¯•å’Œæˆ˜æ–—ä¸­éƒ½å­˜åœ¨ç»“æ„å·®å¼‚ã€‚ åœ¨é¢„å…ˆå‡†å¤‡å¥½çš„åŸºç¡€ä¸Šè¿è¡Œ-æˆ‘åœ¨åˆ†æ”¯æ–¹é¢é‡åˆ°å¾ˆå¤šé—®é¢˜ã€‚ æ‚¨å¯ä»¥åœ¨ä½¿ç”¨liquibaseè¿è¡Œæ‰€æœ‰æµ‹è¯•ä¹‹å‰å‡†å¤‡æ•°æ®åº“ï¼Œé¦–å…ˆå°†æ‰€æœ‰å†…å®¹æ¸…é™¤ä¸ºé›¶ï¼Œç„¶åæ›´æ–°ä¸ºæœ€æ–°ç‰ˆæœ¬ã€‚ <br><br> å›æ»šé€šå¸¸è¢«å¿˜è®°å®Œæˆï¼Œæ‚¨å¿…é¡»åŠ¨æ‰‹æµ‹è¯•ç¯å¢ƒæ‰èƒ½æ¸…ç†åŸºç¡€ã€‚ å’Œä»–ä¸€èµ·æµ‹è¯•ï¼ ç®—æ³•å¦‚ä¸‹ï¼š <br><br><ol><li> åˆ é™¤æ ¹ç›®å½•ä¸‹çš„æ‰€æœ‰å†…å®¹ï¼ˆå‡ºäºå®éªŒçš„çº¯æ­£ç›®çš„ï¼‰ </li><li> æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬ </li><li> æ‰§è¡Œå›æ»š1-2ç‰ˆæœ¬ </li><li> æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬ï¼ˆéœ€è¦åœ¨æ–°çš„æ•°æ®åº“ç»“æ„ä¸Šè¿›è¡Œæµ‹è¯•ï¼Œå¹¶æ£€æŸ¥å›æ»šæ˜¯å¦æ²¡æœ‰å¿˜è®°åˆ é™¤ä»»ä½•å†…å®¹ï¼Œè¿™å°†é˜»æ­¢æ›´æ–°å†æ¬¡æ»šåŠ¨ï¼‰ </li></ol><br> æŸäº›å¼€å‘äººå‘˜åœ¨å¼€å§‹æ¯ä¸ªæµ‹è¯•æ—¶éƒ½ä¸æƒ³è¿è¡Œå›æ»šæµ‹è¯•ã€‚ æˆ‘ä»¬è¿›è¡Œåˆ‡æ¢ã€‚ <br><br><pre><code class="kotlin hljs">project.ext.doRollbackTest = { <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>.parseBoolean(localConfig[<span class="hljs-string"><span class="hljs-string">'test.rollback.enabled'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> String) }</code> </pre> <br> è™½ç„¶å¯¹çŒ«è¿›è¡Œäº†åŸ¹è®­ï¼Œä½†ä¸€åˆ‡æ­£å¸¸ã€‚ ä½†æ˜¯ï¼Œä¸€ä¸ªåŠ¨æ€å¼€å‘çš„é¡¹ç›®ä¼šè‡ªè¡Œè°ƒæ•´-2ä¸ªæ‹‰åŠ¨ä»»åŠ¡ï¼ŒåŒæ—¶è¿›è¡Œç»„è£…ã€‚ ä¸€ä¸ªå®ä¾‹æ­£åœ¨æµ‹è¯•æŸäº›ä¸œè¥¿ï¼Œç¬¬äºŒä¸ªå®ä¾‹æ˜¯ä»è„šä¸‹æ•²æ‰“åº•åº§ã€‚ å®ƒå¯ä»¥é€šè¿‡ç®€å•ç¦æ­¢å¹¶è¡Œè£…é…æ¥è§£å†³ã€‚ <br><br><img src="https://habrastorage.org/webt/my/64/hm/my64hmqfabt8qg0jcuz-xwiddvi.png" alt="å›¾ç‰‡"><br><br> è¿˜æœ‰ä¸€æ¬¡å¤±è´¥-æˆ‘å†³å®šä½¿ç”¨Jenkinså¸æˆ·è¿›è¡Œæµ‹è¯•ï¼Œå› ä¸º å°±ä¸ªäººè€Œè¨€ï¼Œä¸€åˆ‡æ­£å¸¸ï¼Œå¹¶ä¸”ç”±äºä¸æ¸…æ¥šçš„åŸå› ï¼Œè¯·æ±‚æ± ä¸‹é™ã€‚ æˆ‘ä»¬å›æƒ³èµ·çƒ­çƒˆçš„è®¨è®ºï¼Œå³DevOpsæ˜¯ä¸€ç§æ–‡åŒ–ï¼Œå‡ºäºä¸ªäººç›®çš„ä½¿ç”¨æŠ€æœ¯å¸æˆ·æ˜¯ä¸å¯æ¥å—çš„ã€‚ <br><br><img src="https://habrastorage.org/webt/fr/lb/xf/frlbxfbj6ck-8pdbhff0v5kpeta.png" alt="å›¾ç‰‡"><br><br> ç´¯è®¡10ä¸ªè¯·æ±‚æ± ã€‚ æ‰€æœ‰æ”¶é›†çš„ï¼Œé‡æ–°åˆ†å‘çš„éƒ½å¯ä»¥åˆå¹¶ã€‚ ç¬¬ä¸€ä¸ªå»äº†ï¼Œä¸»è¦åˆ†æ”¯æ”¹å˜äº†-å…¶ä½™çš„ä¸€èµ·æ’é˜Ÿé‡å»ºã€‚ æ‚¨å¯ä»¥éšè¿›åº¦è¿›è¡Œåˆå¹¶ï¼Œä½†æ˜¯æœ‰ä¼˜å…ˆçº§ã€‚ ç”±äºä»£ç ä¸­çš„é”™è¯¯ï¼Œæ›´ç´§æ€¥çš„pullrequestsï¼Œè¾ƒä¸ç´§æ€¥çš„è¯·æ±‚ä¹ŸæŒ‚æ–­äº†ã€‚ é€šå¸¸ï¼Œå¹¶è¡ŒåŒ–ã€‚ <br><br> ç»„è£…åº”è¯¥å¾ˆç®€å•ï¼ŒåŒ…æ‹¬ç®€å•çš„æ­¥éª¤ï¼Œç”šè‡³å¯¹äºæ˜¨å¤©çš„å­¦ç”Ÿæ¥è¯´ä¹Ÿæ˜¯å¯ä»¥ç†è§£çš„ã€‚  99ï¼…çš„è¯·æ±‚å’Œé‡Šæ”¾æ± çš„ç»„è£…æ˜¯é¡ºåºçš„ï¼Œè€Œä¸æ˜¯å¹¶è¡Œçš„ï¼Œè¿™æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚ å¦‚æœæ£€æŸ¥çš„ç´¯ç§¯é‡ä¸è¶…è¿‡1-2 PRï¼Œåˆ™ç¦æ­¢åŒæ—¶è£…é…æ˜¯è¶³å¤Ÿçš„ã€‚ <br><br> å¯¹äºå¹¶è¡Œå¯åŠ¨ï¼Œæˆ‘ä»¬éœ€è¦æ¯ä¸ªå¯åŠ¨çš„æµ‹è¯•éƒ½å…·æœ‰ç‹¬å è®¿é—®æƒçš„åŸºç¡€æˆ–æ–¹æ¡ˆã€‚ <br><br> é€‰é¡¹ä¸€æ˜¯åŠ¨æ€åˆ†é…ã€‚ åœ¨æ•°æ®åº“ä¸­åˆ›å»ºæ¨¡å¼å¾ˆå¿«ã€‚ é€šè¿‡APIçš„äº‘ï¼Œæ‚¨å¯ä»¥åœ¨é‚£é‡Œåˆ†é…æ•°æ®åº“ã€‚ <br><br> å¦‚æœæ‚¨ä¸æ‰“ç®—åˆ é™¤æ—§æ•°æ®åº“ï¼Œåˆ™å¯ä»¥åœ¨æµ‹è¯•å¤±è´¥æ—¶å¿«é€Ÿå®Œæˆç£ç›˜ç©ºé—´ï¼Œç„¶åâ€œå¿˜è®°â€ä»¥é‡Šæ”¾èµ„æºã€‚ å®ƒæ˜¯â€œä½•æ—¶â€ï¼Œè€Œä¸æ˜¯â€œæ˜¯å¦â€ã€‚ <br><br> é€‰é¡¹äºŒ-å…·æœ‰å•ç‹¬ç®¡ç†æœåŠ¡çš„æ•°æ®åº“/æ¨¡å¼æ± ã€‚ åœ¨APIå¤–é¢ä¼¸å‡ºæ‰‹ï¼Œç»™æ—¶é—´å®šåŸºï¼Œåœ¨å­¦æœŸå‰æ”¶å›å…è´¹åŸºã€‚ å®ƒä¼šè¿”å›ä»€ä¹ˆï¼šå¸¦æœ‰æ•°æ®åº“æˆ–ä»…æœ‰å°‘é‡æ¶æ„çš„ä¸“ç”¨æœåŠ¡å™¨ï¼Œè¿™æ— å…³ç´§è¦ã€‚ æœ€ä¸»è¦çš„æ˜¯èµ„æºä¸ä¼šæ°¸è¿œä¸¢å¤±ã€‚ <br><br> é€‰é¡¹ä¸‰-è‡ªæˆ‘ç›‘ç®¡çš„åŸºç¡€/è®¡åˆ’åº“ã€‚ éœ€è¦èµ„æºæ¥äº¤æ¢æœ‰å…³é”å’Œæ•°æ®åº“æ± æœ¬èº«çš„ä¿¡æ¯ã€‚ <br><br> æˆ‘é€‰æ‹©äº†åä¸€ç§é€‰æ‹©ï¼Œå› ä¸ºå®ƒå¯¹æˆ‘æ¥è¯´æ›´å®¹æ˜“å›ºå®šï¼Œå¹¶ä¸”ä¸éœ€è¦ç‰¹åˆ«çš„æ”¯æŒã€‚ é€»è¾‘å¦‚ä¸‹-åˆ›å»ºå‡ ä¸ªç”µè·¯ï¼ˆä¾‹å¦‚10ä¸ªï¼‰ï¼Œå¹¶å°†æ‰€æœ‰å…³äºè¿æ¥å®ƒä»¬çš„å¿…è¦ä¿¡æ¯æ·»åŠ åˆ°å…±äº«èµ„æºä¸­ï¼Œæ¯ä¸ªæµ‹è¯•å®ä¾‹åœ¨å¼€å§‹ä¹‹å‰ä½œä¸€ä¸ªå¼€å§‹æ ‡è®°ï¼Œåœ¨ç»“æŸåå°†å…¶åˆ é™¤ã€‚ å¦‚æœæµ‹è¯•åœ¨å®Œæˆä¹‹å‰å´©æºƒï¼Œåˆ™åœ¨è¶…æ—¶ç»“æŸæ—¶ç”µè·¯å°†è¢«è§†ä¸ºç©ºé—²ã€‚ <br><br> é˜…è¯»è®¾ç½®ï¼š <br><br><pre> <code class="kotlin hljs"> project.ext.localConfig = new Properties() localConfig.load(file(<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${rootDir}</span></span></span><span class="hljs-string">/local.properties"</span></span>).newReader())</code> </pre><br> ä»gradleè„šæœ¬ä¸­ä½¿ç”¨sqléœ€è¦é©±åŠ¨ç¨‹åºåŠ è½½ï¼š <br><pre> <code class="kotlin hljs"> configurations { driver } dependencies { driver group: <span class="hljs-string"><span class="hljs-string">"oracle"</span></span>, name: <span class="hljs-string"><span class="hljs-string">"ojdbc6"</span></span>, version: <span class="hljs-string"><span class="hljs-string">"11.+"</span></span> } task initDriver { doLast { ClassLoader loader = GroovyObject.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>.classLoader configurations.driver.each { File file -&gt; loader.addURL(file.toURL()) } } }</code> </pre><br> è¿æ¥æ–¹å¼ï¼š <br><br><pre> <code class="kotlin hljs"> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> groovy.sql.Sql project.ext.createSqlInstance = { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Sql.newInstance( url: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.url"</span></span>], user: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.username"</span></span>], password: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.password"</span></span>], driver: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.driverClass"</span></span>]) }</code> </pre><br> å¯ä»¥é€šè¿‡æ•°æ®åº“è¡¨è¿›è¡Œä¿¡æ¯äº¤æ¢ã€‚ å¼•ç”¨è¡¨çš„åˆå§‹åŒ–ï¼ˆåº”è¯¥å·¥ä½œä¸€æ¬¡ï¼Œç„¶åè¯¥è¡¨å°†ä¸€ç›´å­˜åœ¨ç›´åˆ°æ—¶é—´ç»“æŸï¼‰ï¼š <br><br><pre> <code class="kotlin hljs"> task initDbPool { dependsOn initDriver doLast { Integer poolSize = <span class="hljs-number"><span class="hljs-number">10</span></span> Sql sql = createSqlInstance() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Sql String tableName = localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.referenceTable"</span></span>] String baseName = localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.baseName"</span></span>] String basePass = localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.basePass"</span></span>] String token = <span class="hljs-string"><span class="hljs-string">"{id}"</span></span> List tableExists = sql.rows(<span class="hljs-string"><span class="hljs-string">"select table_name from all_tables where table_name=?"</span></span>, [tableName]) assert tableExists.isEmpty() sql.execute(<span class="hljs-string"><span class="hljs-string">""" CREATE TABLE </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> ( ID NUMBER(2) NOT NULL PRIMARY KEY, METADATA VARCHAR2(200) NOT NULL, PROCESSED TIMESTAMP NULL, GUID VARCHAR2(36) NULL) """</span></span>, []) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Integer i = <span class="hljs-number"><span class="hljs-number">0</span></span> ; i &lt; poolSize ; i++) { String username = baseName.replace(token, i.toString()) String password = basePass.replace(token, i.toString()) sql.execute(<span class="hljs-string"><span class="hljs-string">""" CREATE USER </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string"> IDENTIFIED BY "</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${password}</span></span></span><span class="hljs-string">" DEFAULT TABLESPACE USERS TEMPORARY TABLESPACE TEMP PROFILE DEFAULT QUOTA UNLIMITED ON USERS """</span></span>, []) sql.execute(<span class="hljs-string"><span class="hljs-string">"grant connect to </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string">"</span></span>, []) sql.execute(<span class="hljs-string"><span class="hljs-string">"grant create sequence to </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string">"</span></span>, []) sql.execute(<span class="hljs-string"><span class="hljs-string">"grant create session to </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string">"</span></span>, []) sql.execute(<span class="hljs-string"><span class="hljs-string">"grant create table to </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string">"</span></span>, []) String metadata = JsonOutput.toJson([ <span class="hljs-string"><span class="hljs-string">"app.db.driverClass"</span></span>: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.driverClass"</span></span>], <span class="hljs-string"><span class="hljs-string">"app.db.url"</span></span>: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.url"</span></span>], <span class="hljs-string"><span class="hljs-string">"app.db.username"</span></span>: username, <span class="hljs-string"><span class="hljs-string">"app.db.password"</span></span>: password ]) sql.execute(<span class="hljs-string"><span class="hljs-string">""" INSERT INTO </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> (id, metadata) values (?, ?) """</span></span>, [i, metadata]) } } }</code> </pre><br> å¼€å‘äººå‘˜å…·æœ‰è‡ªå·±çš„è°ƒè¯•å’Œç»„è£…æ–¹æ¡ˆï¼Œå› æ­¤å¿…é¡»å…³é—­å¯¹æ± çš„ä½¿ç”¨ï¼š <br><br><pre> <code class="kotlin hljs"> project.ext.isCiBuild = { <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>.parseBoolean(localConfig[<span class="hljs-string"><span class="hljs-string">'pool.db.enabled'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> String) }</code> </pre><br> å–å…è´¹åŸºæ•°ï¼š <br><br><pre> <code class="kotlin hljs"> task lockDb { dependsOn initDriver onlyIf isCiBuild doLast { project.ext.lockUid = UUID.randomUUID().toString() String tableName = localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.referenceTable"</span></span>] Sql sql = createSqlInstance() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Sql sql.executeUpdate(<span class="hljs-string"><span class="hljs-string">"""UPDATE </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> SET GUID = ?, PROCESSED = SYSDATE WHERE ID IN ( SELECT ID FROM ( SELECT ID, ROW_NUMBER() OVER (ORDER BY PROCESSED) AS RN FROM </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> WHERE GUID IS NULL OR PROCESSED &lt; (SYSDATE - NUMTODSINTERVAL(?, 'MINUTE')) ) WHERE RN = 1 ) """</span></span>, [lockUid, <span class="hljs-number"><span class="hljs-number">15</span></span>]) def meta = sql.firstRow(<span class="hljs-string"><span class="hljs-string">"SELECT METADATA FROM </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> WHERE GUID = ?"</span></span>, [lockUid]) assert meta != <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-string"><span class="hljs-string">"No free databases in pool"</span></span> def slurper = new JsonSlurper() Map metadata = slurper.parseText(meta[<span class="hljs-string"><span class="hljs-string">"METADATA"</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> String) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Map localConfig.putAll(metadata) logger.info(<span class="hljs-string"><span class="hljs-string">"Database locked, {}"</span></span>, metadata) } } task unlockDb { dependsOn lockDb <span class="hljs-comment"><span class="hljs-comment">// init lockUid onlyIf isCiBuild doLast { try { String tableName = localConfig["pool.db.referenceTable"] Sql sql = createSqlInstance() as Sql sql.executeUpdate("UPDATE ${tableName} SET GUID = NULL WHERE GUID = ?", [lockUid]) logger.info("Database unlocked") } catch (ignored) { logger.error(ignored) } } }</span></span></code> </pre><br> å¦‚æœæ‚¨è¿ç»­ä¸¤æ¬¡å®Œæˆè£…é…ï¼Œåˆ™å¯ä»¥é€‰æ‹©ä¸åŒçš„æ–¹æ¡ˆï¼Œå¹¶ä¸”è£…é…å±æ€§æ–‡ä»¶æ—¶å°†ä¿ç•™ä¸åŒçš„å€¼ã€‚ å¯¹äºæœ¬åœ°å¯åŠ¨ï¼Œè®¾ç½®æ˜¯é™æ€çš„ã€‚ <br><br><pre> <code class="kotlin hljs"> configure([processResources, processTestResources]) { Task t -&gt; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (project.ext.isCiBuild()) { t.outputs.upToDateWhen { <span class="hljs-literal"><span class="hljs-literal">false</span></span> } } t.filesMatching(<span class="hljs-string"><span class="hljs-string">'**/*.properties'</span></span>) { filter(ReplaceTokens, tokens: localConfig, beginToken: <span class="hljs-string"><span class="hljs-string">'${'</span></span>, endToken: <span class="hljs-string"><span class="hljs-string">'}'</span></span>) } }</code> </pre><br> æµ‹è¯•å›æ»šçš„ä»»åŠ¡ï¼š <br><br><pre> <code class="kotlin hljs"> task restoreAfterRollbackTest(type: LiquibaseTask) { command = <span class="hljs-string"><span class="hljs-string">'update'</span></span> } task rollbackTest(type: LiquibaseTask) { dependsOn lockDb command = <span class="hljs-string"><span class="hljs-string">'rollback'</span></span> requiresValue = <span class="hljs-literal"><span class="hljs-literal">true</span></span> doFirst { project.ext.liquibaseCommandValue = localConfig[<span class="hljs-string"><span class="hljs-string">'test.rollback.tag'</span></span>] } doLast { project.ext.liquibaseCommandValue = <span class="hljs-literal"><span class="hljs-literal">null</span></span> } }</code> </pre><br> å¹¶è®¾ç½®æ‰§è¡Œé¡ºåºï¼š <br><br><pre> <code class="kotlin hljs"> configure([project]) { tasks.withType(LiquibaseTask.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>) { LiquibaseTask t -&gt; logger.info(<span class="hljs-string"><span class="hljs-string">"Liquibase task {} must run after {}"</span></span>, t.getName(), configLiquibase.getName()) (t <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Task).dependsOn configLiquibase <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isCiBuild()) { logger.info(<span class="hljs-string"><span class="hljs-string">"Liquibase task {} must run after {}"</span></span>, t.getName(), lockDb.getName()) (t <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Task).dependsOn lockDb (t <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Task).finalizedBy unlockDb } } <span class="hljs-comment"><span class="hljs-comment">//   CI: // 1.    0 (dropAll) // 2.     rollback (update) // 3. ,       (rollback tag) // 4.      (update) // 5.     if (doRollbackTest()) { def setTaskOrdering = { List&lt;Task&gt; lst -&gt; for (int i = 0; i &lt; lst.size() - 1; i++) { logger.info("Task {} must run after {}", lst[i + 1].getName(), lst[i].getName()) lst[i + 1].dependsOn lst[i] } } setTaskOrdering([ lockDb, configLiquibase, dropAll, update, rollbackTest, restoreAfterRollbackTest, processTestResources, test, ]) lockDb.finalizedBy unlockDb test.finalizedBy unlockDb } }</span></span></code> </pre><br> æ•°æ®åº“åˆ†é…å’Œå›æ»šæµ‹è¯•å¯ä»¥æ”¾åœ¨æµ‹è¯•å†…éƒ¨ã€‚ åœ¨å®Œæˆæ‰€æœ‰æµ‹è¯•ä¹‹å‰å’Œä¹‹åè¿è¡Œä»£ç çš„æ–¹å¼ï¼šåœ¨Junit5ä¸­ï¼Œè¿™æ˜¯TestNG BeforeSuiteä¸­çš„BeforeAllCallbackã€‚ <br><br> å¯¹äºâ€œä¸ºä»€ä¹ˆJavaç¨‹åºå‘˜åº”è¯¥æµ‹è¯•sqlâ€è¿™ä¸ªé—®é¢˜ï¼Œç­”æ¡ˆæ˜¯åº”è¯¥æµ‹è¯•ä»»ä½•ä»£ç ã€‚ æœ‰ä¾‹å¤–ï¼Œæœ‰äº›ä»£ç åœ¨ç»™å®šæ—¶é—´æ˜¯ä¸åˆç†çš„ã€‚ <br><br> æˆ‘æƒ³çŸ¥é“å…¶ä»–ç¨‹åºå‘˜å¦‚ä½•è§£å†³æµ‹è¯•ä¸æ•°æ®åº“äº¤äº’çš„é—®é¢˜ï¼Ÿ é›†è£…ç®±æ˜¯å¦å·²åˆ°è¾¾æ¯ä¸ªå®¶åº­ï¼Œè¿˜æ˜¯é›†æˆæµ‹è¯•é€šè¿‡äº†æµ‹è¯•äººå‘˜çš„è‚©è†€ï¼Ÿ <br><br><div class="spoiler">  <b class="spoiler_title">å®Œæ•´æ¸…å•</b> <div class="spoiler_text"><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> groovy.json.JsonOutput <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> groovy.json.JsonSlurper <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> groovy.sql.Sql <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.tools.ant.filters.ReplaceTokens <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.liquibase.gradle.LiquibaseTask plugins { id <span class="hljs-string"><span class="hljs-string">'java'</span></span> id <span class="hljs-string"><span class="hljs-string">'org.liquibase.gradle'</span></span> version <span class="hljs-string"><span class="hljs-string">'2.0.1'</span></span> } configurations { driver } repositories { jcenter() mavenCentral() maven { url = <span class="hljs-string"><span class="hljs-string">"http://www.datanucleus.org/downloads/maven2/"</span></span> } } dependencies { implementation <span class="hljs-string"><span class="hljs-string">'com.google.guava:guava:27.0.1-jre'</span></span> implementation <span class="hljs-string"><span class="hljs-string">'org.springframework:spring-core:5.1.7.RELEASE'</span></span> implementation <span class="hljs-string"><span class="hljs-string">'org.springframework:spring-context:5.1.7.RELEASE'</span></span> implementation <span class="hljs-string"><span class="hljs-string">'org.springframework:spring-jdbc:5.1.7.RELEASE'</span></span> testImplementation <span class="hljs-string"><span class="hljs-string">'junit:junit:4.12'</span></span> testImplementation <span class="hljs-string"><span class="hljs-string">'org.springframework:spring-test:5.1.7.RELEASE'</span></span> testRuntime <span class="hljs-string"><span class="hljs-string">'oracle:ojdbc6:11.+'</span></span> liquibaseRuntime <span class="hljs-string"><span class="hljs-string">'org.liquibase:liquibase-core:3.6.1'</span></span> liquibaseRuntime <span class="hljs-string"><span class="hljs-string">'oracle:ojdbc6:11.+'</span></span> liquibaseRuntime <span class="hljs-string"><span class="hljs-string">'org.yaml:snakeyaml:1.24'</span></span> driver group: <span class="hljs-string"><span class="hljs-string">"oracle"</span></span>, name: <span class="hljs-string"><span class="hljs-string">"ojdbc6"</span></span>, version: <span class="hljs-string"><span class="hljs-string">"11.+"</span></span> } project.ext.localConfig = new Properties() localConfig.load(file(<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${rootDir}</span></span></span><span class="hljs-string">/local.properties"</span></span>).newReader()) project.ext.isCiBuild = { <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>.parseBoolean(localConfig[<span class="hljs-string"><span class="hljs-string">'pool.db.enabled'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> String) } project.ext.doRollbackTest = { <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>.parseBoolean(localConfig[<span class="hljs-string"><span class="hljs-string">'test.rollback.enabled'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> String) } task configLiquibase { doLast { liquibase { activities { testdb { changeLogFile <span class="hljs-string"><span class="hljs-string">'changelog.yaml'</span></span> url localConfig[<span class="hljs-string"><span class="hljs-string">'app.db.url'</span></span>] driver localConfig[<span class="hljs-string"><span class="hljs-string">'app.db.driverClass'</span></span>] username localConfig[<span class="hljs-string"><span class="hljs-string">'app.db.username'</span></span>] password localConfig[<span class="hljs-string"><span class="hljs-string">'app.db.password'</span></span>] logLevel <span class="hljs-string"><span class="hljs-string">'debug'</span></span> classpath <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${project.projectDir}</span></span></span><span class="hljs-string">/db"</span></span> contexts <span class="hljs-string"><span class="hljs-string">'main'</span></span> } runList = <span class="hljs-string"><span class="hljs-string">'testdb'</span></span> } } } } task initDriver { doLast { ClassLoader loader = GroovyObject.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>.classLoader configurations.driver.each { File file -&gt; loader.addURL(file.toURL()) } } } project.ext.createSqlInstance = { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Sql.newInstance( url: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.url"</span></span>], user: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.username"</span></span>], password: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.password"</span></span>], driver: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.driverClass"</span></span>]) } task initDbPool { dependsOn initDriver doLast { Integer poolSize = <span class="hljs-number"><span class="hljs-number">10</span></span> Sql sql = createSqlInstance() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Sql String tableName = localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.referenceTable"</span></span>] String baseName = localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.baseName"</span></span>] String basePass = localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.basePass"</span></span>] String token = <span class="hljs-string"><span class="hljs-string">"{id}"</span></span> List tableExists = sql.rows(<span class="hljs-string"><span class="hljs-string">"select table_name from all_tables where table_name=?"</span></span>, [tableName]) assert tableExists.isEmpty() sql.execute(<span class="hljs-string"><span class="hljs-string">""" CREATE TABLE </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> ( ID NUMBER(2) NOT NULL PRIMARY KEY, METADATA VARCHAR2(200) NOT NULL, PROCESSED TIMESTAMP NULL, GUID VARCHAR2(36) NULL) """</span></span>, []) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Integer i = <span class="hljs-number"><span class="hljs-number">0</span></span> ; i &lt; poolSize ; i++) { String username = baseName.replace(token, i.toString()) String password = basePass.replace(token, i.toString()) sql.execute(<span class="hljs-string"><span class="hljs-string">""" CREATE USER </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string"> IDENTIFIED BY "</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${password}</span></span></span><span class="hljs-string">" DEFAULT TABLESPACE USERS TEMPORARY TABLESPACE TEMP PROFILE DEFAULT QUOTA UNLIMITED ON USERS """</span></span>, []) sql.execute(<span class="hljs-string"><span class="hljs-string">"grant connect to </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string">"</span></span>, []) sql.execute(<span class="hljs-string"><span class="hljs-string">"grant create sequence to </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string">"</span></span>, []) sql.execute(<span class="hljs-string"><span class="hljs-string">"grant create session to </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string">"</span></span>, []) sql.execute(<span class="hljs-string"><span class="hljs-string">"grant create table to </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string">"</span></span>, []) String metadata = JsonOutput.toJson([ <span class="hljs-string"><span class="hljs-string">"app.db.driverClass"</span></span>: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.driverClass"</span></span>], <span class="hljs-string"><span class="hljs-string">"app.db.url"</span></span>: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.url"</span></span>], <span class="hljs-string"><span class="hljs-string">"app.db.username"</span></span>: username, <span class="hljs-string"><span class="hljs-string">"app.db.password"</span></span>: password ]) sql.execute(<span class="hljs-string"><span class="hljs-string">""" INSERT INTO </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> (id, metadata) values (?, ?) """</span></span>, [i, metadata]) } } } task lockDb { dependsOn initDriver onlyIf isCiBuild doLast { project.ext.lockUid = UUID.randomUUID().toString() String tableName = localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.referenceTable"</span></span>] Sql sql = createSqlInstance() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Sql sql.executeUpdate(<span class="hljs-string"><span class="hljs-string">"""UPDATE </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> SET GUID = ?, PROCESSED = SYSDATE WHERE ID IN ( SELECT ID FROM ( SELECT ID, ROW_NUMBER() OVER (ORDER BY PROCESSED) AS RN FROM </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> WHERE GUID IS NULL OR PROCESSED &lt; (SYSDATE - NUMTODSINTERVAL(?, 'MINUTE')) ) WHERE RN = 1 ) """</span></span>, [lockUid, <span class="hljs-number"><span class="hljs-number">15</span></span>]) def meta = sql.firstRow(<span class="hljs-string"><span class="hljs-string">"SELECT METADATA FROM </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> WHERE GUID = ?"</span></span>, [lockUid]) assert meta != <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-string"><span class="hljs-string">"No free databases in pool"</span></span> def slurper = new JsonSlurper() Map metadata = slurper.parseText(meta[<span class="hljs-string"><span class="hljs-string">"METADATA"</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> String) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Map localConfig.putAll(metadata) logger.info(<span class="hljs-string"><span class="hljs-string">"Database locked, {}"</span></span>, metadata) } } task unlockDb { dependsOn lockDb <span class="hljs-comment"><span class="hljs-comment">// init lockUid onlyIf isCiBuild doLast { try { String tableName = localConfig["pool.db.referenceTable"] Sql sql = createSqlInstance() as Sql sql.executeUpdate("UPDATE ${tableName} SET GUID = NULL WHERE GUID = ?", [lockUid]) logger.info("Database unlocked") } catch (ignored) { logger.error(ignored) } } } configure([processResources, processTestResources]) { Task t -&gt; if (project.ext.isCiBuild()) { t.outputs.upToDateWhen { false } } t.filesMatching('**/*.properties') { filter(ReplaceTokens, tokens: localConfig, beginToken: '${', endToken: '}') } } task restoreAfterRollbackTest(type: LiquibaseTask) { command = 'update' } task rollbackTest(type: LiquibaseTask) { dependsOn lockDb command = 'rollback' requiresValue = true doFirst { project.ext.liquibaseCommandValue = localConfig['test.rollback.tag'] } doLast { project.ext.liquibaseCommandValue = null } } configure([project]) { tasks.withType(LiquibaseTask.class) { LiquibaseTask t -&gt; logger.info("Liquibase task {} must run after {}", t.getName(), configLiquibase.getName()) (t as Task).dependsOn configLiquibase if (isCiBuild()) { logger.info("Liquibase task {} must run after {}", t.getName(), lockDb.getName()) (t as Task).dependsOn lockDb (t as Task).finalizedBy unlockDb } } //   CI: // 1.    0 (dropAll) // 2.     rollback (update) // 3. ,       (rollback tag) // 4.      (update) // 5.     if (doRollbackTest()) { def setTaskOrdering = { List&lt;Task&gt; lst -&gt; for (int i = 0; i &lt; lst.size() - 1; i++) { logger.info("Task {} must run after {}", lst[i + 1].getName(), lst[i].getName()) lst[i + 1].dependsOn lst[i] } } setTaskOrdering([ lockDb, configLiquibase, dropAll, update, rollbackTest, restoreAfterRollbackTest, processTestResources, test, ]) lockDb.finalizedBy unlockDb test.finalizedBy unlockDb } }</span></span></code> </pre><br><pre> <code class="bash hljs">pool.db.enabled=<span class="hljs-literal"><span class="hljs-literal">false</span></span> test.rollback.enabled=<span class="hljs-literal"><span class="hljs-literal">true</span></span> pool.db.driverClass=oracle.jdbc.driver.OracleDriver pool.db.url=jdbc:oracle:thin:@localhost:1527:ORCLCDB pool.db.username=SYSTEM pool.db.password=Oradoc_db1 pool.db.referenceTable=c<span class="hljs-comment"><span class="hljs-comment">##test_user1.REF_TABLE pool.db.baseName=C##CI_SCHEMA_{id} pool.db.basePass=CI_SCHEMA_{id}_PASS app.db.driverClass= app.db.url= app.db.username= app.db.password= test.rollback.tag=version_1</span></span></code> </pre><br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN452722/">https://habr.com/ru/post/zh-CN452722/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN452706/index.html">1983å¹´ï¼Œè¿™å°æ¥è‡ªBella Labsçš„è®¡ç®—æœºæˆä¸ºç¬¬ä¸€å°è®¡ç®—æœºå¤§å¸ˆã€‚</a></li>
<li><a href="../zh-CN452712/index.html">æˆ‘ä»¬å¦‚ä½•åœ¨å›¢é˜Ÿä¸­å·¥ä½œï¼Œç»“æœå¦‚ä½•</a></li>
<li><a href="../zh-CN452714/index.html">æ³¨æ„ï¼ƒ5ï¼šæœ‰å…³äº§å“æ€ç»´ï¼Œè¡Œä¸ºå¿ƒç†å­¦å’Œç”Ÿäº§åŠ›çš„æ–‡ç« æ‘˜è¦</a></li>
<li><a href="../zh-CN452716/index.html">å¯»æ‰¾äººåŠ›èµ„æºçš„æœ€ä½³åº”ç”¨ç‚¹</a></li>
<li><a href="../zh-CN452718/index.html">PsyGuideï¼šæ³¨æ„ç¼ºé™·ã€‚ ï¼ƒ0001/1001</a></li>
<li><a href="../zh-CN452724/index.html">Phoenix LiveViewï¼šå½“JavaScriptä»£ç å¾ˆæœ‰è¶£æ—¶*</a></li>
<li><a href="../zh-CN452726/index.html">å¯çˆ±çš„éª¨å¤´3Dï¼šç”¨äºä¿®å¤é¢…éª¨ç¼ºæŸçš„è¶…å¼¹æ€§éª¨å¤´ææ–™</a></li>
<li><a href="../zh-CN452730/index.html">ä¿¡æ¯ç³»ç»Ÿçš„æ ‡å‡†æ®µåŸåˆ™è®¤è¯ã€‚ ç¥è¯ä¸ç°å®</a></li>
<li><a href="../zh-CN452734/index.html">ä½¿ç”¨Bitcodeè‡ªåŠ¨å°†iOSï¼ˆARMï¼‰åº”ç”¨ç¨‹åºè¿ç§»åˆ°macOSï¼ˆx86ï¼‰</a></li>
<li><a href="../zh-CN452736/index.html">SecureDialoguesä¸­çš„é‚®ä»¶åŠ å¯†</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>