<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíÜüèª üèÆ üë©üèª‚Äç‚öñÔ∏è Istio et Kubernetes en production. Partie 2. Tra√ßage üêè ‚òÆÔ∏è üë®‚Äçüë©‚Äçüë¶‚Äçüë¶</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans le dernier article, nous avons examin√© les composants de base de Service Mesh Istio, pris connaissance du syst√®me et r√©pondu aux questions de bas...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Istio et Kubernetes en production. Partie 2. Tra√ßage</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/avito/blog/433650/">  Dans le dernier <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article,</a> nous avons examin√© les composants de base de Service Mesh Istio, pris connaissance du syst√®me et r√©pondu aux questions de base qui se posent g√©n√©ralement au d√©but de la collaboration avec Istio.  Dans cette partie, nous verrons comment organiser la collecte d'informations de tra√ßage sur le r√©seau. <br><br><img src="https://habrastorage.org/webt/dz/-l/6j/dz-l6j3yddyja_gjqgvw-3_da2m.png"><br><a name="habracut"></a><br>  La premi√®re chose que de nombreux d√©veloppeurs et administrateurs syst√®me rencontrent lorsqu'ils entendent les mots Service Mesh.  En effet, nous ajoutons un serveur proxy sp√©cial √† chaque n≈ìud du r√©seau par lequel passe tout le trafic TCP.  Il semble que vous pouvez d√©sormais envoyer facilement des informations sur toutes les interactions r√©seau sur le r√©seau.  Malheureusement, en r√©alit√©, de nombreuses nuances doivent √™tre prises en compte.  Regardons-les. <br><br><h3>  Id√©e fausse num√©ro un: nous pouvons obtenir gratuitement des donn√©es sur les trajets sur le r√©seau </h3><br>  En fait, relativement gratuit, nous ne pouvons que connecter les n≈ìuds de notre syst√®me par des fl√®ches et le d√©bit de donn√©es qui passe entre les services (en fait, seulement le nombre d'octets par unit√© de temps).  Cependant, dans la plupart des cas, nos services communiquent √† l'aide d'une sorte de protocole au niveau de l'application, comme HTTP, gRPC, Redis, etc.  Et, bien s√ªr, nous voulons voir les informations de tra√ßage pr√©cis√©ment selon ces protocoles, nous voulons voir le taux de demandes, et non le taux de donn√©es.  Nous voulons comprendre la latence des demandes par notre protocole.  Enfin, nous voulons voir le chemin complet parcouru par la demande entre notre syst√®me et la r√©ception d'une r√©ponse de l'utilisateur.  Ce probl√®me n'est pas si facilement r√©solu. <br><br>  Pour commencer, regardons √† quoi ressemble l'envoi de plages de tra√ßage du point de vue de l'architecture dans Istio.  Comme nous nous en souvenons de la premi√®re partie, Istio a un composant s√©par√© pour collecter la t√©l√©m√©trie, qui est appel√© Mixer.  Cependant, dans la version actuelle 1.0. * L'envoi se fait directement √† partir de serveurs proxy, √† savoir avec le proxy envoy√©.  Envoy proxy prend en charge l'envoi de trav√©es de tra√ßage via le protocole zipkin hors de la bo√Æte.  D'autres protocoles peuvent √™tre connect√©s, mais uniquement via le plugin.  Avec Istio, nous obtenons imm√©diatement le proxy envoy√© assembl√© et configur√©, qui ne prend en charge que le protocole zipkin.  Si nous voulons utiliser, par exemple, le protocole Jaeger et envoyer des plages de tra√ßage via UDP, nous devrons assembler notre image istio-proxy.  Il existe un support pour les plugins personnalis√©s pour istio-proxy, mais il est toujours dans la version alpha.  Par cons√©quent, si nous voulons nous passer de nombreux param√®tres personnalis√©s, la gamme de technologies utilis√©es pour stocker et recevoir des plages de suivi est r√©duite.  En fait, des principaux syst√®mes, vous pouvez maintenant utiliser Zipkin lui-m√™me, ou Jaeger, mais envoyer tout l√†-bas en utilisant un protocole compatible Zipkin (qui est beaucoup moins efficace).  Le protocole zipkin lui-m√™me implique l'envoi de toutes les informations de tra√ßage aux collecteurs √† l'aide du protocole HTTP, ce qui est assez cher. <br><br>  Comme je l'ai dit, nous voulons suivre les protocoles au niveau de l'application.  Et cela signifie que les serveurs proxy situ√©s √† c√¥t√© de chaque service doivent comprendre quel type d'interaction se produit actuellement.  Par d√©faut, Istio d√©finit le type de tous les ports TCP ordinaires, ce qui signifie qu'aucune trace ne sera envoy√©e.  Pour que des traces soient envoy√©es, vous devez d'abord activer cette option dans la configuration de maillage principale et, tr√®s important, renommer tous les ports des entit√©s de service kubernetes conform√©ment au protocole utilis√© dans le service.  C'est, par exemple, comme ceci: <br><br><pre><code class="python hljs">apiVersion: v1 kind: Service metadata: name: nginx spec: ports: - port: <span class="hljs-number"><span class="hljs-number">80</span></span> targetPort: <span class="hljs-number"><span class="hljs-number">80</span></span> name: http selector: app: nginx</code> </pre> <br>  Vous pouvez √©galement utiliser des noms compos√©s, tels que http-magic (Istio voit http et reconna√Æt ce port comme point de terminaison http).  Le format est: proto-extra. <br><br>  Afin de ne pas patcher un grand nombre de configurations pour d√©finir un protocole, vous pouvez utiliser une solution de contournement sale: patcher un composant Pilot √† un moment o√π il <a href="">ex√©cute</a> simplement <a href="">la logique de d√©finition de protocole</a> .  √Ä la fin, bien s√ªr, vous devrez changer cette logique en standard et passer √† la convention de d√©nomination pour tous les ports. <br><br>  Afin de comprendre si le protocole est vraiment d√©fini correctement, vous devez aller dans l'un des conteneurs sidecar avec proxy d'envoi et faire une demande au port d'administration de l'interface d'envoy√© avec location / config_dump.  Dans la configuration r√©sultante, vous devez examiner l'op√©ration de champ de service souhait√©e.  Il est utilis√© dans Istio comme identifiant de la destination de la demande.  Afin de personnaliser la valeur de ce param√®tre dans Istio (nous le verrons ensuite dans notre syst√®me de suivi), vous devez sp√©cifier l'indicateur serviceCluster au stade du lancement du conteneur sidecar.  Par exemple, il peut √™tre calcul√© comme ceci √† partir de variables obtenues √† partir des kubernetes de l'API descendante: <br><br> <code>--serviceCluster ${POD_NAMESPACE}.$(echo ${POD_NAME} | sed -e 's/-[a-z0-9]*-[a-z0-9]*$//g')</code> <br> <br>  Un bon exemple pour comprendre comment fonctionne le tra√ßage dans l'envoy√© est <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . <br><br>  Le point de terminaison lui-m√™me pour l'envoi des plages de suivi doit √©galement √™tre sp√©cifi√© dans les indicateurs de d√©marrage du proxy envoy√©, par exemple: <code>--zipkinAddress tracing-collector.tracing:9411</code> <br><br><h3>  Id√©e fausse num√©ro deux: nous pouvons obtenir √† moindre co√ªt les pistes compl√®tes du passage des demandes pour le syst√®me hors de la bo√Æte </h3><br>  Ce n'est malheureusement pas le cas.  La complexit√© de la mise en ≈ìuvre d√©pend de la fa√ßon dont vous avez d√©j√† mis en ≈ìuvre l'interaction des services.  Pourquoi <br><br>  Le fait est que pour que istio-proxy comprenne la correspondance des demandes entrantes avec un service avec celles provenant du m√™me service, il ne suffit pas d'intercepter tout le trafic.  Vous devez avoir une sorte d'identifiant de lien.  Envoy proxy HTTP utilise des en-t√™tes sp√©ciaux, par lesquels envoy√© comprend quelle demande de service particuli√®re g√©n√®re des demandes sp√©cifiques √† d'autres services.  Liste de ces en-t√™tes: <br><br><ul><li>  x-request-id, </li><li>  x-b3-traceid, </li><li>  x-b3-spanid, </li><li>  x-b3-parentspanid, </li><li>  √©chantillonn√© x-b3, </li><li>  drapeaux x-b3, </li><li>  x-ot-span-context. </li></ul><br>  Si vous avez un seul point, par exemple, un client de base o√π vous pouvez ajouter une telle logique, alors tout va bien, il vous suffit d'attendre que tous les clients mettent √† jour cette biblioth√®que.  Mais si vous avez un syst√®me tr√®s h√©t√©rog√®ne et qu'il n'y a pas d'unification dans la campagne des services aux services sur le r√©seau, alors ce sera tr√®s probablement un gros probl√®me.  Sans l'ajout d'une telle logique, toutes les informations de tra√ßage ne seront que "fr√®re".  Autrement dit, nous obtenons toutes les interactions interservices, mais elles ne seront pas coll√©es dans une seule cha√Æne de passage √† travers le r√©seau. <br><br><h3>  Conclusion </h3><br>  Istio fournit un outil pratique pour collecter des informations de tra√ßage sur le r√©seau, cependant, vous devez comprendre que pour la mise en ≈ìuvre, vous devrez adapter votre syst√®me et prendre en compte les caract√©ristiques de la mise en ≈ìuvre d'Istio.  Par cons√©quent, vous devez r√©soudre deux points principaux: d√©terminer le protocole de couche application (qui devrait √™tre pris en charge par le proxy envoy√©) et configurer la transmission d'informations sur la connectivit√© des demandes au service √† partir des demandes du service (en utilisant des en-t√™tes, dans le cas du protocole HTTP).  Lorsque ces probl√®mes sont r√©solus, nous obtenons un outil puissant qui vous permet de collecter de mani√®re transparente des informations sur le r√©seau, m√™me dans des syst√®mes tr√®s h√©t√©rog√®nes √©crits dans de nombreux langages et cadres diff√©rents. <br><br>  Dans le prochain article sur Service Mesh, nous examinerons l'un des plus gros probl√®mes d'Istio - une consommation √©lev√©e de m√©moire par chaque conteneur proxy sidecar et discuterons de la mani√®re de le g√©rer. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr433650/">https://habr.com/ru/post/fr433650/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr433638/index.html">D√©composition de projet pour frontend</a></li>
<li><a href="../fr433642/index.html">Vous n'aimez pas les syst√®mes CRM? Vous ne savez tout simplement pas comment les faire cuire</a></li>
<li><a href="../fr433644/index.html">¬´Programmation en direct¬ª: comment s'est d√©roul√©e la demi-finale r√©gionale du CIPC √† l'Universit√© ITMO</a></li>
<li><a href="../fr433646/index.html">Staffcop: vue lat√©rale</a></li>
<li><a href="../fr433648/index.html">Le premier profit de l'histoire des services de streaming occidentaux: pourquoi ce n'est pas une si bonne nouvelle</a></li>
<li><a href="../fr433652/index.html">La 5G vue par les utilisateurs. Attentes et pr√©occupations</a></li>
<li><a href="../fr433658/index.html">IT in Germany - comment chercher du travail dans les grandes villes en Allemagne</a></li>
<li><a href="../fr433660/index.html">Comment j'ai parl√© √† DefCamp pour la cinqui√®me fois</a></li>
<li><a href="../fr433664/index.html">SATA SSD Enterprise dans le stockage Infortrend √† 2 contr√¥leurs - Mesure des performances</a></li>
<li><a href="../fr433666/index.html">Dictionnaire Funcorp</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>