<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ÑπÔ∏è ‚ôªÔ∏è üèì Testando anota√ß√µes @ NonNull / @ Nullable ‚è≤Ô∏è üê≤ üèê</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Em vez de "Dedicado a ..." 
 A tarefa descrita abaixo n√£o foi inovadora nem muito √∫til; a empresa em que trabalho n√£o receber√° lucro por isso, mas ser...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Testando anota√ß√µes @ NonNull / @ Nullable</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/464939/"><h3>  Em vez de "Dedicado a ..." </h3><br>  A tarefa descrita abaixo n√£o foi inovadora nem muito √∫til; a empresa em que trabalho n√£o receber√° lucro por isso, mas serei um b√¥nus. <br><br>  Mas essa tarefa era e, portanto, tinha que ser resolvida. <br><br><h3>  Introdu√ß√£o </h3><br>  No artigo, voc√™ encontrar√° muitas vezes a palavra Lombok, pe√ßo aos inimigos que n√£o cheguem a conclus√µes precipitadas. <br>  N√£o vou me "afogar" por Lombok ou por sua aus√™ncia. Eu, como Geralt Sapkovsky, tento ser neutro e posso ler c√≥digo com ou sem Lombok com calma e sem tremores no s√©culo. <br><br>  Mas no projeto atual, a biblioteca mencionada est√° presente, e algo me diz que nosso projeto n√£o √© o √∫nico. <br>  Ent√£o aqui. <br><a name="habracut"></a><br>  A √∫ltima vez em java, certamente h√° uma tend√™ncia para o annotashki.  Para a gl√≥ria do conceito de falha r√°pida, os par√¢metros dos m√©todos costumam ser anotados com a anota√ß√£o @NonNull (de modo que, se algo der errado, acontece). <br><br>  Existem muitas op√ß√µes de importa√ß√£o para isso (ou uma anota√ß√£o semelhante em ideologia), mas, como j√° ficou claro, focaremos na vers√£o <br><br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> lombok.NonNull;</code> </pre> <cut></cut><br>  Se voc√™ usar essa anota√ß√£o (ou semelhante), ter√° algum contrato que precisar√° verificar com um teste e qualquer analisador de c√≥digo est√°tico gentilmente informar√° (o Sonar informa exatamente). <br><br>  Testar essa anota√ß√£o com um teste de unidade √© bastante simples, o problema √© que esses testes se multiplicam no seu projeto na velocidade dos coelhos na primavera, e os coelhos, como voc√™ sabe, violam o princ√≠pio DRY. <br><br>  No artigo, escreveremos uma pequena estrutura de teste para testar o contrato de anota√ß√µes do @NonNull (e para que o Sonar n√£o brilhe nos seus olhos com uma luz vermelha desagrad√°vel). <br><br>  <b>PS</b> O nome da m√∫sica foi inspirado na m√∫sica da banda PowerWolf, que tocou (por golly) quando escrevi o nome (no original, o nome soa mais positivo) <br><br><h3>  Corpo principal </h3><br>  Inicialmente, testamos a anota√ß√£o da seguinte forma: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">methodNameWithNullArgumentThrowException</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { instance.getAnyType(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); fail(<span class="hljs-string"><span class="hljs-string">"Exception not thrown"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">final</span></span> NullPointerException e) { assertNotNull(e); } }</code> </pre> <br>  Eles chamaram o m√©todo e passaram nulos como um par√¢metro anotado com a anota√ß√£o @NonNull. <br>  Eles receberam NPE e ficaram satisfeitos (o Sonar tamb√©m ficou feliz). <br><br>  Ent√£o eles come√ßaram a fazer o mesmo, mas com uma declara√ß√£o mais elegante que funciona atrav√©s do Fornecedor (n√≥s amamos lambdas): <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@TestUnitRepeatOnce</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">methodNameWithNullArgumentThrowException</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ assertThrows(NullPointerException.class, () -&gt; instance.getAnyType(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>)); }</code> </pre> <br>  Elegante.  Na moda.  Juventude <br><br>  Parece poss√≠vel terminar, as anota√ß√µes s√£o testadas, e da√≠? <br><br>  O problema (n√£o o problema, mas ainda assim) desse m√©todo de teste "surgiu" quando um dia escrevi um teste para um m√©todo, funcionou com √™xito e, em seguida, notei que n√£o havia anota√ß√£o @NonNull no par√¢metro. <br><br>  √â compreens√≠vel: voc√™ chama o m√©todo de teste, sem descrever o comportamento das classes moque, atrav√©s de quando () / ent√£o ().  O encadeamento em execu√ß√£o entra com seguran√ßa no m√©todo, em algum lugar dentro dele captura o NPE, em um objeto desbloqueado (ou bloqueado, mas sem quando () / then ()) e trava, no entanto, com o NPE, como voc√™ alertou, o que significa que o teste √© verde <br><br>  Acontece que estamos testando neste caso, n√£o a anota√ß√£o, mas n√£o est√° claro o que.  Com o teste funcionando corretamente, n√£o precisamos nem nos aprofundar no m√©todo (caindo no limiar). <cut></cut><br>  As anota√ß√µes @NonNull do Lombok t√™m um recurso: se cairmos do NPE para anota√ß√µes, o nome do par√¢metro ser√° gravado no erro. <br><br>  N√≥s nos envolveremos nisso, depois de cairmos no NPE, verificaremos adicionalmente o texto do stacktrace, assim: <br><br><pre> <code class="java hljs">exception.getCause().getMessage().equals(parameter.getName())</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">E se de repente ...</b> <div class="spoiler_text">  Caso o Lombok atualize repentinamente e pare de escrever o nome do par√¢metro que recebeu nulo no stacktrace, revisaremos a palestra de Andrei Pangin sobre a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">JVM TI</a> e escreveremos um plug-in para a JVM, na qual transferimos o nome do par√¢metro. <br></div></div><br>  Tudo parece n√£o ser nada, agora checamos o que realmente √© necess√°rio, mas o problema dos ‚Äúcoelhos‚Äù n√£o est√° resolvido. <br><br>  Eu gostaria de ter uma ferramenta que pudesse ser dita, por exemplo, assim: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@TestUnitRepeatOnce</span></span> <span class="hljs-meta"><span class="hljs-meta">@SneakyThrows</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nonNullAnnotationTest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ assertNonNullAnnotation(YourPerfectClass.class); }</code> </pre> <br>  e ele pr√≥prio examinaria todos os m√©todos p√∫blicos da classe especificada e verificaria todos os par√¢metros @NonNull com um teste. <br><br>  Voc√™ dir√°, obtenha uma reflex√£o e verifique se o m√©todo @NonNull est√° ativado e se h√° um marcador nulo. <br><br>  Tudo n√£o seria nada, mas RetentionPolicy n√£o √© o √∫nico. <br><br>  Todas as anota√ß√µes t√™m um par√¢metro RetentionPolicy, que pode ser de tr√™s tipos: SOURCE, CLASS e RUNTIME; portanto, o Lombok possui RetentionPolicy.SOURCE por padr√£o, o que significa que essa anota√ß√£o n√£o √© vis√≠vel no tempo de execu√ß√£o e voc√™ n√£o a encontra atrav√©s da reflex√£o. <br><br>  Em nosso projeto, todos os par√¢metros de m√©todos p√∫blicos s√£o anotados (sem contar primitivos), se for entendido que o par√¢metro n√£o pode ser nulo, se o contr√°rio for assumido, o par√¢metro ser√° anotado por spring @Nullable.  Voc√™ pode se envolver nisso, procuraremos todos os m√©todos p√∫blicos e todos os par√¢metros neles que n√£o est√£o marcados com @Nullable e n√£o s√£o primitivos. <br>  Queremos dizer que, para todos os outros casos, a anota√ß√£o @NonNull deve estar nos par√¢metros. <br><br>  Por conveni√™ncia, sempre que poss√≠vel, espalharemos a l√≥gica por m√©todos privados; para come√ßar, obteremos todos os m√©todos p√∫blicos: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> List&lt;Method&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPublicMethods</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Class clazz)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Arrays.stream(clazz.getDeclaredMethods()) .filter(METHOD_FILTER) .collect(toList()); }</code> </pre> <br>  onde METHOD_FILTER √© um predicado regular no qual dizemos que: <br><br><ul><li>  O m√©todo deve ser p√∫blico </li><li>  N√£o deve ser sint√©tico (e isso acontece quando voc√™ tem um m√©todo com um par√¢metro bruto) </li><li>  N√£o deve ser abstrato (sobre classes abstratas separadamente e abaixo) </li><li>  O nome do m√©todo n√£o deve ser igual (no caso de algum tipo de pessoa m√° decidir preencher uma classe com substitu√≠dos igual a () na entrada de nossa estrutura POJO) </li></ul><br>  Depois de obter todos os m√©todos necess√°rios, come√ßamos a classific√°-los em um loop, <br>  se o m√©todo n√£o possui par√¢metros, este n√£o √© nosso candidato: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (method.getParameterCount() == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; }</code> </pre> <br>  Se houver par√¢metros, precisamos entender se eles est√£o anotados em @NonNull (mais precisamente, devem estar, de acordo com <br><br><div class="spoiler">  <b class="spoiler_title">l√≥gica</b> <div class="spoiler_text"><ul><li>  m√©todo p√∫blico </li><li>  not @Nullable </li><li>  n√£o primitivo </li></ul><br></div></div><br>  Para fazer isso, fa√ßa um mapa e coloque nossos par√¢metros de acordo com a sequ√™ncia do m√©todo, e ao lado deles, colocamos um sinalizador que diz se a anota√ß√£o @NonNull deve estar acima ou n√£o: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nonNullAnnotationCount = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> index = <span class="hljs-number"><span class="hljs-number">0</span></span>; val parameterCurrentMethodArray = method.getParameters(); val notNullAnnotationParameterMap = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap&lt;Integer, Boolean&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (val parameter : parameterCurrentMethodArray) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isNull(parameter.getAnnotation(Nullable.class)) &amp;&amp; isFalse(parameter.getType().isPrimitive())) { notNullAnnotationParameterMap.put(index++, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); nonNullAnnotationCount++; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { notNullAnnotationParameterMap.put(index++, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (nonNullAnnotationCount == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; }</code> </pre> <br>  esse mapa √© √∫til para chamarmos o m√©todo e pass√°-lo nulo para todos os par√¢metros com a anota√ß√£o @NonNull por sua vez, e n√£o apenas o primeiro. <br><br>  O par√¢metro nonNullAnnotationCount conta quantos par√¢metros no m√©todo devem ser anotados em @NonNull; ele determinar√° o n√∫mero de intera√ß√µes de integra√ß√£o de chamadas para cada m√©todo. <br><br>  A prop√≥sito, se n√£o houver anota√ß√µes @NonNull (existem par√¢metros, mas todos s√£o primitivos ou @Nullable), n√£o h√° nada para falar: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (nonNullAnnotationCount == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; }</code> </pre> <br>  Temos em m√£os um mapa de par√¢metros.  Sabemos quantas vezes chamar um m√©todo e em quais posi√ß√µes nulo, o assunto √© pequeno (como eu pensava ingenuamente sem entender), precisamos criar uma inst√¢ncia da classe e chamar m√©todos sobre eles. <br><br>  Os problemas come√ßam quando voc√™ percebe o qu√£o diferente √© uma inst√¢ncia: pode ser uma classe privada, pode ser uma classe com um construtor padr√£o, com um construtor com par√¢metros, com esse e tal construtor, uma classe abstrata, uma interface (com seus m√©todos padr√£o, que tamb√©m s√£o p√∫blicos e que tamb√©m precisam ser testados). <br><br>  E quando constru√≠mos a inst√¢ncia por gancho ou por bandido, precisamos passar os par√¢metros para o m√©todo de chamada e aqui tamb√©m: como criar uma inst√¢ncia da classe final?  e Enum?  e primitivo?  e uma matriz de primitivas (que tamb√©m √© um objeto e tamb√©m pode ser anotada). <br><br>  Bem, vamos fazer isso em ordem. <br><br>  O primeiro caso √© uma classe com um construtor privado: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ONLY_ONE_PRIVATE_CONSTRUCTOR_FILTER.test(clazz)) { notNullAnnotationParameterMap.put(currentNullableIndex, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); method.invoke(clazz, invokeMethodParameterArray); makeErrorMessage(method); }</code> </pre> <br>  ent√£o invocamos nosso m√©todo de invoca√ß√£o, passamos o clazz que veio de fora para o teste e uma matriz de par√¢metros em que null j√° est√° carregado na primeira posi√ß√£o com a flag da anota√ß√£o @NonNull (lembre-se, acima de termos criado o mapa @ NonNulls) execute um loop e crie uma matriz de par√¢metros, alterando alternadamente a posi√ß√£o do par√¢metro nulo e zerando o sinalizador antes de chamar o m√©todo, para que na pr√≥xima integra√ß√£o o outro par√¢metro se torne nulo. <br><br>  No c√≥digo, fica assim: <br><br><pre> <code class="java hljs">val invokeMethodParameterArray = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Object[parameterCurrentMethodArray.length]; <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> hasNullParameter = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> currentNullableIndex = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; invokeMethodParameterArray.length; i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (notNullAnnotationParameterMap.get(i) &amp;&amp; isFalse(hasNullParameter)) { currentNullableIndex = i; invokeMethodParameterArray[i] = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; hasNullParameter = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { mappingParameter(parameterCurrentMethodArray[i], invokeMethodParameterArray, i); } }</code> </pre> <br>  A primeira op√ß√£o de instancia√ß√£o foi resolvida. <br><br>  Interfaces adicionais, voc√™ n√£o pode obter e criar uma inst√¢ncia de uma interface (ela nem sequer tem um construtor). <br><br>  Portanto, com a interface, ser√° assim: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (INTERFACE_FILTER.test(clazz)) { notNullAnnotationParameterMap.put(currentNullableIndex, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); method.invoke(createInstanceByDynamicProxy(clazz, invokeMethodParameterArray), invokeMethodParameterArray); makeErrorMessage(method); }</code> </pre> <br>  createInstanceByDynamicProxy nos permite criar uma inst√¢ncia em uma classe se ela implementar pelo menos uma interface ou ela pr√≥pria uma interface <br><br><div class="spoiler">  <b class="spoiler_title">Nuance</b> <div class="spoiler_text">  lembre-se de que aqui √© fundamental que interfaces a classe implementa, a interface de tipo (e n√£o algumas compar√°veis) √© importante, na qual existem m√©todos que voc√™ implementa na classe de destino; caso contr√°rio, a inst√¢ncia o surpreender√° com seu tipo <br></div></div><br>  mas por dentro √© assim: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Object </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createInstanceByDynamicProxy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Class clazz, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Object[] invokeMethodParameterArray)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> newProxyInstance( currentThread().getContextClassLoader(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Class[]{clazz}, (proxy, method1, args) -&gt; { Constructor&lt;Lookup&gt; constructor = Lookup.class .getDeclaredConstructor(Class.class); constructor.setAccessible(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); constructor.newInstance(clazz) .in(clazz) .unreflectSpecial(method1, clazz) .bindTo(proxy) .invokeWithArguments(invokeMethodParameterArray); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } ); }</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Ancinho</b> <div class="spoiler_text">  A prop√≥sito, tamb√©m havia alguns ancinhos aqui, n√£o me lembro mais quais, havia muitos deles, mas voc√™ precisa criar um proxy por meio da Lookup.class <br></div></div><br>  A pr√≥xima inst√¢ncia (minha favorita) √© uma classe abstrata.  E aqui o proxy din√¢mico n√£o nos ajudar√° mais, pois se uma classe abstrata implementa algum tipo de interface, esse claramente n√£o √© o tipo que gostar√≠amos.  E assim, n√£o podemos pegar e criar newInstance () a partir de uma classe abstrata.  Aqui, o CGLIB vir√° em nosso aux√≠lio, uma biblioteca de primavera que cria proxies baseados em heran√ßa, mas o problema √© que a classe de destino deve ter um construtor padr√£o (sem par√¢metros) <br><br><div class="spoiler">  <b class="spoiler_title">Fofoca</b> <div class="spoiler_text">  Embora a julgar pela fofoca na Internet desde a Primavera 4, o CGLIB possa funcionar sem ela, e por isso: <b>Portanto, n√£o funciona!</b> <br></div></div>  A op√ß√£o para instanciar uma classe abstrata seria esta: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isAbstract(clazz.getModifiers())) { createInstanceByCGLIB(clazz, method, invokeMethodParameterArray); makeErrorMessage(); }</code> </pre> <br>  makeErrorMessage (), que j√° foi visto nos exemplos de c√≥digo, descarta o teste, se chamarmos o m√©todo com o par√¢metro anotado @NonNull passando nulo e ele n√£o cair, o teste n√£o funcionar√°, voc√™ dever√° soltar. <br><br>  Para o mapeamento de par√¢metros, temos um m√©todo comum que pode mapear e bloquear os par√¢metros do construtor e do m√©todo: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mappingParameter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Parameter parameter, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Object[] methodParam, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> index)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> InstantiationException, IllegalAccessException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isFinal(parameter.getType().getModifiers())) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parameter.getType().isEnum()) { methodParam[index] = Enum.valueOf( (Class&lt;Enum&gt;) (parameter.getType()), parameter.getType().getEnumConstants()[<span class="hljs-number"><span class="hljs-number">0</span></span>].toString() ); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parameter.getType().isPrimitive()) { mappingPrimitiveName(parameter, methodParam, index); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parameter.getType().getTypeName().equals(<span class="hljs-string"><span class="hljs-string">"byte[]"</span></span>)) { methodParam[index] = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[<span class="hljs-number"><span class="hljs-number">0</span></span>]; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { methodParam[index] = parameter.getType().newInstance(); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { methodParam[index] = mock(parameter.getType()); } }</code> </pre> <br>  Preste aten√ß√£o na cria√ß√£o de Enum (cereja no bolo), em geral, voc√™ n√£o pode simplesmente criar e enum. <br><br>  Aqui, para os par√¢metros finais, seu pr√≥prio mapeamento, para o n√£o final, e simplesmente no texto (c√≥digo). <br><br>  Bem, depois que criamos os par√¢metros para o construtor e para o m√©todo, formamos nossa inst√¢ncia: <br><br><pre> <code class="java hljs">val firstFindConstructor = clazz.getConstructors()[<span class="hljs-number"><span class="hljs-number">0</span></span>]; val constructorParameterArray = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Object[firstFindConstructor.getParameters().length]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; constructorParameterArray.length; i++) { mappingParameter(firstFindConstructor.getParameters()[i], constructorParameterArray, i); } notNullAnnotationParameterMap.put(currentNullableIndex, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); createAndInvoke(clazz, method, invokeMethodParameterArray, firstFindConstructor, constructorParameterArray); makeErrorMessage(method);</code> </pre> <cut></cut><br>  J√° sabemos ao certo que, desde que atingimos esse est√°gio do c√≥digo, significa que temos pelo menos um construtor, podemos usar qualquer um para criar uma inst√¢ncia, portanto, pegamos o primeiro que vemos, veja se ele possui par√¢metros no construtor e, se n√£o, chame assim: <br><br><pre> <code class="java hljs">method.invoke(spy(clazz.getConstructors()[<span class="hljs-number"><span class="hljs-number">0</span></span>].newInstance()), invokeMethodParameterArray);</code> </pre> <br><br>  Bem, se houver algo parecido com isto: <br><pre> <code class="java hljs">method.invoke(spy(clazz.getConstructors()[<span class="hljs-number"><span class="hljs-number">0</span></span>].newInstance()), invokeMethodParameterArray);</code> </pre> <cut></cut><br>  Essa √© a l√≥gica que ocorre no m√©todo createAndInvoke () que voc√™ viu um pouco mais alto. <br>  A vers√£o completa da classe de teste no spoiler, eu n√£o carreguei no git, como escrevi em um projeto em funcionamento, mas na verdade √© apenas uma classe que pode ser herdada em seus testes e usada. <br><br><div class="spoiler">  <b class="spoiler_title">C√≥digo fonte</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestUtil</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Predicate&lt;Method&gt; METHOD_FILTER = method -&gt; isPublic(method.getModifiers()) &amp;&amp; isFalse(method.isSynthetic()) &amp;&amp; isFalse(isAbstract(method.getModifiers())) &amp;&amp; isFalse(method.getName().equals(<span class="hljs-string"><span class="hljs-string">"equals"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Predicate&lt;Class&gt; ONLY_ONE_PRIVATE_CONSTRUCTOR_FILTER = clazz -&gt; clazz.getConstructors().length == <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; isFalse(clazz.isInterface()); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Predicate&lt;Class&gt; INTERFACE_FILTER = clazz -&gt; clazz.getConstructors().length == <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> BiPredicate&lt;Exception, Parameter&gt; LOMBOK_ERROR_FILTER = (exception, parameter) -&gt; isNull(exception.getCause().getMessage()) || isFalse(exception.getCause().getMessage().equals(parameter.getName())); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">assertNonNullAnnotation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Class clazz)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Throwable </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (val method : getPublicMethods(clazz)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (method.getParameterCount() == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nonNullAnnotationCount = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> index = <span class="hljs-number"><span class="hljs-number">0</span></span>; val parameterCurrentMethodArray = method.getParameters(); val notNullAnnotationParameterMap = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap&lt;Integer, Boolean&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (val parameter : parameterCurrentMethodArray) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isNull(parameter.getAnnotation(Nullable.class)) &amp;&amp; isFalse(parameter.getType().isPrimitive())) { notNullAnnotationParameterMap.put(index++, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); nonNullAnnotationCount++; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { notNullAnnotationParameterMap.put(index++, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (nonNullAnnotationCount == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> j = <span class="hljs-number"><span class="hljs-number">0</span></span>; j &lt; nonNullAnnotationCount; j++) { val invokeMethodParameterArray = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Object[parameterCurrentMethodArray.length]; <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> hasNullParameter = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> currentNullableIndex = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; invokeMethodParameterArray.length; i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (notNullAnnotationParameterMap.get(i) &amp;&amp; isFalse(hasNullParameter)) { currentNullableIndex = i; invokeMethodParameterArray[i] = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; hasNullParameter = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { mappingParameter(parameterCurrentMethodArray[i], invokeMethodParameterArray, i); } } <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ONLY_ONE_PRIVATE_CONSTRUCTOR_FILTER.test(clazz)) { notNullAnnotationParameterMap.put(currentNullableIndex, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); method.invoke(clazz, invokeMethodParameterArray); makeErrorMessage(method); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (INTERFACE_FILTER.test(clazz)) { notNullAnnotationParameterMap.put(currentNullableIndex, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); method.invoke(createInstanceByDynamicProxy(clazz, invokeMethodParameterArray), invokeMethodParameterArray); makeErrorMessage(method); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isAbstract(clazz.getModifiers())) { createInstanceByCGLIB(clazz, method, invokeMethodParameterArray); makeErrorMessage(); } val firstFindConstructor = clazz.getConstructors()[<span class="hljs-number"><span class="hljs-number">0</span></span>]; val constructorParameterArray = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Object[firstFindConstructor.getParameters().length]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; constructorParameterArray.length; i++) { mappingParameter(firstFindConstructor.getParameters()[i], constructorParameterArray, i); } notNullAnnotationParameterMap.put(currentNullableIndex, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); createAndInvoke(clazz, method, invokeMethodParameterArray, firstFindConstructor, constructorParameterArray); makeErrorMessage(method); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Exception e) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (LOMBOK_ERROR_FILTER.test(e, parameterCurrentMethodArray[currentNullableIndex])) { makeErrorMessage(method); } } } } } <span class="hljs-meta"><span class="hljs-meta">@SneakyThrows</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createAndInvoke</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Class clazz, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Method method, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Object[] invokeMethodParameterArray, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Constructor firstFindConstructor, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Object[] constructorParameterArray )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (firstFindConstructor.getParameters().length == <span class="hljs-number"><span class="hljs-number">0</span></span>) { method.invoke(spy(clazz.getConstructors()[<span class="hljs-number"><span class="hljs-number">0</span></span>].newInstance()), invokeMethodParameterArray); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { method.invoke(spy(clazz.getConstructors()[<span class="hljs-number"><span class="hljs-number">0</span></span>].newInstance(constructorParameterArray)), invokeMethodParameterArray); } } <span class="hljs-meta"><span class="hljs-meta">@SneakyThrows</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createInstanceByCGLIB</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Class clazz, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Method method, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Object[] invokeMethodParameterArray)</span></span></span><span class="hljs-function"> </span></span>{ MethodInterceptor handler = (obj, method1, args, proxy) -&gt; proxy.invoke(clazz, args); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (clazz.getConstructors().length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { val firstFindConstructor = clazz.getConstructors()[<span class="hljs-number"><span class="hljs-number">0</span></span>]; val constructorParam = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Object[firstFindConstructor.getParameters().length]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; constructorParam.length; i++) { mappingParameter(firstFindConstructor.getParameters()[i], constructorParam, i); } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (val constructor : clazz.getConstructors()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (constructor.getParameters().length == <span class="hljs-number"><span class="hljs-number">0</span></span>) { val proxy = Enhancer.create(clazz, handler); method.invoke(proxy.getClass().newInstance(), invokeMethodParameterArray); } } } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Object </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createInstanceByDynamicProxy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Class clazz, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Object[] invokeMethodParameterArray)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> newProxyInstance( currentThread().getContextClassLoader(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Class[]{clazz}, (proxy, method1, args) -&gt; { Constructor&lt;Lookup&gt; constructor = Lookup.class .getDeclaredConstructor(Class.class); constructor.setAccessible(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); constructor.newInstance(clazz) .in(clazz) .unreflectSpecial(method1, clazz) .bindTo(proxy) .invokeWithArguments(invokeMethodParameterArray); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } ); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">makeErrorMessage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ fail(<span class="hljs-string"><span class="hljs-string">"  @NonNull     DefaultConstructor  "</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">makeErrorMessage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Method method)</span></span></span><span class="hljs-function"> </span></span>{ fail(<span class="hljs-string"><span class="hljs-string">"    "</span></span> + method.getName() + <span class="hljs-string"><span class="hljs-string">"   @NonNull"</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> List&lt;Method&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPublicMethods</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Class clazz)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Arrays.stream(clazz.getDeclaredMethods()) .filter(METHOD_FILTER) .collect(toList()); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mappingParameter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Parameter parameter, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Object[] methodParam, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> index)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> InstantiationException, IllegalAccessException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isFinal(parameter.getType().getModifiers())) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parameter.getType().isEnum()) { methodParam[index] = Enum.valueOf( (Class&lt;Enum&gt;) (parameter.getType()), parameter.getType().getEnumConstants()[<span class="hljs-number"><span class="hljs-number">0</span></span>].toString() ); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parameter.getType().isPrimitive()) { mappingPrimitiveName(parameter, methodParam, index); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parameter.getType().getTypeName().equals(<span class="hljs-string"><span class="hljs-string">"byte[]"</span></span>)) { methodParam[index] = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[<span class="hljs-number"><span class="hljs-number">0</span></span>]; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { methodParam[index] = parameter.getType().newInstance(); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { methodParam[index] = mock(parameter.getType()); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mappingPrimitiveName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Parameter parameter, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Object[] methodParam, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> index)</span></span></span><span class="hljs-function"> </span></span>{ val name = parameter.getType().getName(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">"long"</span></span>.equals(name)) { methodParam[index] = <span class="hljs-number"><span class="hljs-number">0L</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">"int"</span></span>.equals(name)) { methodParam[index] = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">"byte"</span></span>.equals(name)) { methodParam[index] = (<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>) <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">"short"</span></span>.equals(name)) { methodParam[index] = (<span class="hljs-keyword"><span class="hljs-keyword">short</span></span>) <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">"double"</span></span>.equals(name)) { methodParam[index] = <span class="hljs-number"><span class="hljs-number">0.0</span></span>d; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">"float"</span></span>.equals(name)) { methodParam[index] = <span class="hljs-number"><span class="hljs-number">0.0f</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">"boolean"</span></span>.equals(name)) { methodParam[index] = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">"char"</span></span>.equals(name)) { methodParam[index] = <span class="hljs-string"><span class="hljs-string">'A'</span></span>; } } }</code> </pre> <br></div></div><br><h3>  Conclus√£o </h3><br>  Esse c√≥digo funciona e testa anota√ß√µes em um projeto real, no momento h√° apenas uma op√ß√£o poss√≠vel, quando tudo o que √© dito pode ser recolhido. <br><br>  Declare um levantador Lombock na classe (se houver um especialista que n√£o o coloque na classe Pojo, embora isso simplesmente n√£o aconte√ßa) e o campo em que o levantador for declarado n√£o ser√° final. <br><br>  Ent√£o a estrutura dir√° gentilmente que existe um m√©todo p√∫blico e que possui um par√¢metro no qual n√£o h√° anota√ß√£o @NonNull; a solu√ß√£o √© simples: declare o setter explicitamente e anote seu par√¢metro com base no contexto da l√≥gica @ NonNull / @ Nullable. <br><br>  Observe que, se voc√™ quiser que eu esteja vinculado ao nome do par√¢metro do m√©todo em seus testes (ou algo mais), no tempo de execu√ß√£o, os nomes das vari√°veis ‚Äã‚Äãnos m√©todos n√£o estar√£o dispon√≠veis por padr√£o, voc√™ encontrar√° arg [0] e arg [1], etc. . <br>  Para habilitar a exibi√ß√£o dos nomes dos m√©todos no Runtime, use o plug-in Maven: <br><br><pre> <code class="java hljs">&lt;plugin&gt; &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt; &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt; &lt;version&gt;${maven.compiler.plugin.version}&lt;/version&gt; &lt;configuration&gt; &lt;source&gt;${compile.target.source}&lt;/source/&gt; &lt;target&gt;${compile.target.source}&lt;/target&gt; &lt;encoding&gt;${project.build.sourceEncoding}&lt;/encoding&gt; &lt;compilerArgs&gt;&lt;arg&gt;-parameters&lt;/arg&gt;&lt;/compilerArgs&gt; &lt;/configuration&gt; &lt;/plugin&gt;</code> </pre><br>  e em particular esta chave: <br><br><pre> <code class="java hljs">&lt;compilerArgs&gt;&lt;arg&gt;-parameters&lt;/arg&gt;&lt;/compilerArgs&gt;</code> </pre> <br>  Espero que voc√™ esteja interessado. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt464939/">https://habr.com/ru/post/pt464939/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt464929/index.html">Carregamento lento da imagem do navegador (atributo de carregamento)</a></li>
<li><a href="../pt464931/index.html">Assembler insere ... em C #?</a></li>
<li><a href="../pt464933/index.html">Aplicativos para e-books no sistema operacional Android. Parte 4. Jogos</a></li>
<li><a href="../pt464935/index.html">Confort√°vel DevOpsSec: Nemesida WAF gratuito para NGINX com API e conta pessoal</a></li>
<li><a href="../pt464937/index.html">O resumo de materiais interessantes para o desenvolvedor m√≥vel n¬∫ 312 (de 19 a 25 de agosto)</a></li>
<li><a href="../pt464947/index.html">Eventos digitais em Moscou, de 25 de agosto a 1 de setembro</a></li>
<li><a href="../pt464949/index.html">Mais uma vez sobre o GCD, o algoritmo euclidiano e um pouco sobre a hist√≥ria dos algoritmos em geral. Claro que com exemplos Swift</a></li>
<li><a href="../pt464951/index.html">Quanto mais simples a tarefa, mais frequentemente me engano</a></li>
<li><a href="../pt464955/index.html">Iron Mike Tyson e o projeto blockchain Fight to Fame</a></li>
<li><a href="../pt464959/index.html">Analisando a frase do idioma russo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>