<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏽‍🤝‍👩🏼 👲🏾 🤲🏼 Escalonamento de privilégios no cliente EA Origin Windows (CVE-2019-19247 e CVE-2019-19248) 🐎 👨🏿‍🎓 ♍️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Saudações a todos que decidiram ler meu novo artigo sobre análise de vulnerabilidade. Na última vez, em uma curta série de três artigos, falei sobre v...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Escalonamento de privilégios no cliente EA Origin Windows (CVE-2019-19247 e CVE-2019-19248)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pm/blog/479704/">  Saudações a todos que decidiram ler meu novo artigo sobre análise de vulnerabilidade.  Na última vez, em uma curta série de três artigos, falei sobre vulnerabilidades do Steam ( <a href="https://habr.com/ru/company/pm/blog/462479/">1</a> , <a href="https://habr.com/ru/company/pm/blog/464367/">2</a> e <a href="https://habr.com/ru/company/pm/blog/469507/">3</a> ).  Neste artigo, falarei sobre as vulnerabilidades de um produto similar - Origin, que também é um iniciador de jogos.  As vulnerabilidades descobertas foram numeradas CVE-2019-19247 e CVE-2019-19248. <br><br><img src="https://habrastorage.org/webt/bi/b8/vt/bib8vt2hmgqzkyfv39xm5ri8wxk.jpeg"><br><br>  Desta vez, não haverá jogo com banana anban.  A história da comunicação com a divisão de segurança da Electronic Arts Inc foi inicialmente em nível profissional.  Quando fui contatado, eles me deram um número de registro, os relatórios foram cuidadosamente examinados e confirmados.  Nenhum dos meus e-mails foi ignorado e, para um pouco de discussão, uma confusão foi organizada.  A manutenção desses relatórios foi muito simples para mim, pela qual agradeço a Adrian Stone, Elise Murphy e outros funcionários da EA que trabalharam com meus relatórios.  <a href="https://www.ea.com/security/news/origin-security-update-in-collaboration-with-external-security-researchers">Postagem</a> e <a href="https://www.ea.com/security/news/easec-2019-001-elevation-of-privilege-vulnerability-in-origin-client">aviso de</a> <a href="https://www.ea.com/security/news/origin-security-update-in-collaboration-with-external-security-researchers">segurança do blog</a> . <br><br>  Agora para as vulnerabilidades.  Eu encontrei duas vulnerabilidades como "escalonamento de privilégios" (lpe - escalonamento de privilégios locais ou eop - escalonamento de privilégios) no cliente Windows Origin.  Esse tipo de vulnerabilidade permite que qualquer usuário do Windows obtenha mais direitos do que os originalmente emitidos pelo administrador.  Nesse caso, estamos falando de dois aprimoramentos "típicos" - de qualquer usuário ao NT AUTHORITY \ SYSTEM (uma conta com permissões máximas no sistema operacional).  A primeira vulnerabilidade é bastante entediante, portanto, na próxima seção, descreverei brevemente.  Mas o segundo foi bastante interessante, na seção dela vou lhe dizer exatamente como eu a procurei. <br><a name="habracut"></a><br><h2>  <font color="orange">CVE-2019-19248</font> </h2><br>  Esta vulnerabilidade consiste em duas partes: <br><br><ol><li> Criando uma pasta em um caminho arbitrário (com direitos de acesso total); </li><li>  Use a cláusula 1 para obter privilégios NT AUTHORITY \ SYSTEM. </li></ol><br>  Agora, sobre o primeiro ponto em mais detalhes: <br><br><h3>  Preparação do ambiente </h3><br>  É necessário fechar o cliente Origin e interromper o Serviço do Cliente Origin (em teoria, o serviço em si será interrompido se você fechar o cliente, apenas por precaução). <br><br>  Para a pasta "C: \ ProgramData \ Origin", os direitos são "Acesso Completo", o que nos permite excluir completamente seu conteúdo. <br><br><h3>  Link Building </h3><br>  Agora crie alguns links.  O primeiro link será do tipo Ponto de Nova Análise NTFS (Ponto de Montagem NTFS) - o tipo de links apontando de pasta para pasta: “C: \ ProgramData \ Origin” &lt;-&gt; “\ RPC Control”.  Para criar pontos de nova análise, não precisa de direitos de administrador.  Só é necessário que a pasta de origem esteja vazia e o usuário tenha permissões de gravação (elas foram limpas na última etapa, os direitos foram verificados lá).  "\ RPC Control" não é uma pasta no sistema de arquivos, mas um tipo especial de pasta - um diretório de objetos.  Você não pode vê-lo com um explorador comum, mas pode fazer um ponto de nova análise, aparentemente devido às abstrações comuns usadas nas entranhas do Windows. <br><br>  Agora criaremos o link simbólico usual "\ RPC Control \ CatalogCache" &lt;-&gt; "C: \ Path \ To \ Target \ Folder".  No sistema de arquivos, a criação de links simbólicos sem direitos de administrador é proibida, mas esta regra não se aplica aos diretórios de objetos.  Portanto, nosso link será criado com sucesso.  Como resultado de uma combinação desses dois links, as chamadas para "C: \ ProgramData \ Origin \ CatalogCache" serão redirecionadas para "C: \ Path \ To \ Target \ Folder". <br><br>  Leia mais sobre esses links <a href="https://github.com/googleprojectzero/symboliclink-testing-tools/blob/master/CreateSymlink/CreateSymlink_readme.txt">aqui</a> .  No mesmo repositório, <a href="https://github.com/googleprojectzero/symboliclink-testing-tools/releases">você pode baixar</a> utilitários para trabalhar com links. <br><br><h3>  Lançamento </h3><br>  Na última etapa, execute o cliente.  No início de seu trabalho, ele lançará o "Serviço de origem do cliente" e, descobrindo que não há nenhuma pasta "C: \ ProgramData \ Origin \ CatalogCache", ele tentará criá-lo.  Como resultado da navegação pelos links simbólicos, ele criará “C: \ Path \ To \ Target \ Folder” e concederá a essa pasta os direitos de “Acesso Total”. <br><br>  O que era necessário para ser obtido no primeiro ponto de operação.  Vamos para o segundo. <br><br><h3>  A operação de criar uma pasta em um caminho arbitrário </h3><br>  Aqui você pode trabalhar de várias maneiras. <br><br>  Simples e razoavelmente confiável é criar a pasta "C: \ Windows \ system32 \ LogonUI.exe.local".  “LogonUI.exe” (um aplicativo em execução no NT AUTHORITY \ SYSTEM, é responsável pela operação da tela de seleção do usuário e da tela de bloqueio) graças ao mecanismo “.local-redirection” (“dotlocal redirection”), ele carregará a biblioteca a partir dela no caminho “C: \ Windows \ system32 \ LogonUI.exe.local \ amd64_microsoft.windows.common-controls_6595b64144ccf1df_6.0.17134.648_none_fb45a0e93062a6d2 \ comctl32.dll. "  Em geral, o mecanismo em si é bastante comum, portanto pode ter muitos objetivos. <br><br>  Uma maneira longa, porém interessante, é subtrair o hash da senha do administrador por meio de fraudes especiais.  Mais detalhes <a href="https://googleprojectzero.blogspot.com/2017/08/windows-exploitation-tricks-arbitrary.html">aqui</a> . <br><br><h3>  Total </h3><br>  A vulnerabilidade é explorada com bastante facilidade, você só precisa trabalhar um pouco no segundo ponto - encontre o alvo e escreva uma dll adequada.  Além disso, Matt Nelson também relatou essa vulnerabilidade, e seus escritos podem ser encontrados <a href="https://enigma0x3.net/2019/12/10/cve-2019-19248-local-privilege-escalation-in-eas-origin-client/">aqui</a> . <br><br><h2>  <font color="orange">CVE-2019-19247</font> </h2><br>  Essa é uma das minhas vulnerabilidades favoritas.  Ele mostra com que cuidado você precisa se relacionar com a criptografia usada. <br><br>  Tudo começou com o fato de eu ter instalado o jogo através do Origin.  De alguma forma, tudo correu muito bem - alguns cliques e após alguns minutos de download do jogo podem ser iniciados.  Não imediatamente, mas eu entendi qual era o problema: o jogo foi instalado no caminho "C: \ Arquivos de Programas \ Nome_do_Jogo", mas não fez uma única pergunta pelo UAC.  Eu rapidamente verifiquei os direitos, tudo era padrão - um usuário comum não podia escrever em "C: \ Arquivos de Programas".  Um pouco mais de pesquisa e descobri que o jogo não é "prescrito" pelo próprio cliente Origin, mas pelo serviço de atendimento ao cliente Origin. <br><br>  Comecei a fazer suposições sobre como o cliente transmite informações para o serviço, a fim de verificar se algo pode ser explorado. <br><br>  O método de transmissão de informações acabou sendo simples - um pipe nomeado.  Aprendi sobre isso nos logs de instalação - em texto simples, foi indicado que o canal OriginClientService estava aceitando comandos para trabalhar com arquivos e pastas. <br><br>  IDA aberto, carregou o cliente lá. <br><br>  <b>* trabalho realizado na AID: 1 *</b> <br><br>  Muito rapidamente, descobri que os comandos eram enviados ao canal em geral em forma de texto.  Nas proximidades, encontrei uma lista de comandos e, sem mais delongas, enviei um comando do tipo "copiar" C: \ test \ payload.dll "" C: \ Windows \ pwn.dll "para o canal.  Antecipando um resultado rápido, verifico a pasta “C: \ Windows” e não encontro nada de novo nela.  Mas há algo novo nos logs - algumas palavras sobre o fato de o cliente no canal não ter passado na verificação da assinatura digital. <br><br>  IDA aberto, carregou o serviço lá. <br><br>  <b>* trabalho realizado na AID: 2 *</b> <br><br>  Eu descobri que as equipes não são esperadas de ninguém.  Ao conectar a um tubo, o serviço verifica quem está conectado a ele.  O processo pid é extraído da conexão, o caminho para o arquivo executável é extraído do pid, a assinatura é verificada quanto à exatidão e é emitida pela EA. <br>  Soa som, mas não o suficiente.  Você pode pegar o "Origin.exe" (arquivo executável do cliente), copiá-lo em algum lugar da sua pasta.  Coloque algumas dll da lista de importação "Origin.exe" nesta pasta.  Por exemplo, version.dll surgiu.  Eu chamei essa abordagem de "injeção reversa de DLL": em uma injeção regular de DLL, copiamos a DLL para o arquivo exe, mas agora fizemos o oposto.  Eu escrevo rapidamente dll proxy para version.dll, adicione código ao enviar o comando para o pipe.  A carga útil ainda não foi copiada.  Lemos os logs - "o que significa, o comando não pode ser descriptografado!?".  Eu pulei a criptografia. <br><br>  IDA aberto, carregou o cliente lá. <br><br>  <b>* trabalhos realizados na IDA: 3, desvio de assinatura: 1 *</b> <br><br>  Como o cliente envia comandos criptografados em seu trabalho usual, eu posso.  Lá eu olhei, depois olhei, o resultado é o seguinte: Criptografia AES, inicializando um vetor constante, a chave é lida no arquivo.  Nós praticamente copiamos esta peça e a IDA no código, compilamos, verificamos.  Novamente nada.  Mas os logs novamente fornecem informações úteis - você não pode especificar Arquivos de Programas como o caminho de destino. <br><br>  IDA aberto, carregou o serviço lá. <br><br>  <b>* trabalho realizado no IDA: 4, desvio de assinatura: 1, desvio de criptografia: 1 *</b> <br><br>  Portanto, é verdade que existem verificações para obter um comando de que os arquivos não podem ser copiados em qualquer lugar.  E caminhos com "\ .. \" não podem ser escritos.  Olhamos o que outras equipes são. <br>  Trabalhando com o registro - há novamente muitas restrições.  Mas iniciar arquivos parece interessante.  Pelo menos as verificações não são particularmente visíveis.  Edite o código, envie o comando "ExecuteProcess" C: \ test \ payload.exe "".  Bem, você entende ... Nada. <br><br>  Os logs novamente falam sobre a assinatura.  Oh, nós já vencemos.  Indicamos no código que chamamos nosso Origin.exe copiado para carregar nossa DLL proxy novamente, mas com direitos de sistema.  Adicione verificações e inicie o console.  Começamos e o console com os direitos NT AUTHORITY \ SYSTEM aparece - finalmente tudo funcionou. <br><br>  <b>* trabalho realizado no IDA: 4, desvio de assinatura: 2, desvio de criptografia: 1 *</b> <br><br>  Portanto, você precisa reiniciar, executar uma execução final e ainda admirar o console com direitos máximos.  Reinicie, verifique e ... nada.  Como assim?  Apenas funcionou. <br><br>  Os diagnósticos mostram que o Serviço de Cliente de Origem não foi iniciado, por isso estou iniciando-o.  Mas isso não começa.  Mais precisamente, ele inicia, mas fecha imediatamente.  Inicio o cliente Origin e o serviço é iniciado normalmente.  Depois disso, a exploração funcionará corretamente novamente.  Seria possível parar por aí, mas esse não é o meu caminho - eu quero fazer a exploração funcionar completamente. <br><br>  IDA aberto, carregou o serviço lá. <br><br>  <b>* trabalho realizado no IDA: 5, assinatura manual: 2, criptografia manual: 1 *</b> <br><br>  Acontece que, na inicialização, verifica com quais parâmetros o serviço foi iniciado.  Não há nada diretamente interessante lá.  Base64 do pid criptografado do processo cujo arquivo é verificado pela assinatura.  Parece complicado, mas já contornamos a criptografia e a assinatura também.  Estamos escrevendo algum código e uma exploração completa está pronta. <br><br><h3>  Total </h3><br>  A exploração está funcionando.  O trabalho foi realizado no IDA: 5 vezes, assinatura de desvio: 3 vezes, desvio de criptografia: 2 vezes. <br><br><h2>  <font color="orange">Conclusão</font> </h2><br>  Vulnerabilidades corrigidas: os desenvolvedores da EA introduziram um modo restrito de operação especial para o cliente, que estabelece sérias restrições ao trabalho com pastas e pipes do Origin. <br><br>  Vulnerabilidades da linha do tempo: <br><br>  <b>1 de abril de 2019</b> : relatório de relatório de vulnerabilidade com pipe; <br><br>  <b>7 de abril de 2019</b> : enviando um relatório de vulnerabilidade com uma pasta arbitrária; <br><br>  ... MUITAS LETRAS (contei 40) ... <br><br>  <b>10 de dezembro de 2019</b> : divulgação acordada. <br><br>  Obrigado a todos pela atenção, desejo a você os mesmos agentes de segurança. <br><br>  <a href="https://amonitoring.ru/article/origin_lpe_disclosure/">Este artigo em inglês.</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt479704/">https://habr.com/ru/post/pt479704/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt479690/index.html">Zork e Z-Machine: como os desenvolvedores transferiram o jogo dos mainframes para os computadores domésticos de 8 bits</a></li>
<li><a href="../pt479692/index.html">Indexando bilhões de vetores de texto</a></li>
<li><a href="../pt479696/index.html">Algumas palavras sobre Alter Table, ou como não fazê-lo</a></li>
<li><a href="../pt479700/index.html">CIMON-2: (des) Doomsday, ou como o IBM Watson subiu acima das nuvens</a></li>
<li><a href="../pt479702/index.html">Torradeira, Meu círculo e Freelansim se tornam parte da Habr</a></li>
<li><a href="../pt479708/index.html">Postagem não oficial sobre a rebranding da Habr + Competition</a></li>
<li><a href="../pt479712/index.html">Aprendizado de máquina como assistente de monitoramento inteligente</a></li>
<li><a href="../pt479714/index.html">Unificação de componentes visuais. Parte 1. Estilos</a></li>
<li><a href="../pt479716/index.html">Outro SuperApp "primeiro do mundo"</a></li>
<li><a href="../pt479718/index.html">Construindo um aplicativo de ambiente arduino usando o CI github</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>