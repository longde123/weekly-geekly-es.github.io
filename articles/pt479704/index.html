<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèΩ‚Äçü§ù‚Äçüë©üèº üë≤üèæ ü§≤üèº Escalonamento de privil√©gios no cliente EA Origin Windows (CVE-2019-19247 e CVE-2019-19248) üêé üë®üèø‚Äçüéì ‚ôçÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sauda√ß√µes a todos que decidiram ler meu novo artigo sobre an√°lise de vulnerabilidade. Na √∫ltima vez, em uma curta s√©rie de tr√™s artigos, falei sobre v...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Escalonamento de privil√©gios no cliente EA Origin Windows (CVE-2019-19247 e CVE-2019-19248)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pm/blog/479704/">  Sauda√ß√µes a todos que decidiram ler meu novo artigo sobre an√°lise de vulnerabilidade.  Na √∫ltima vez, em uma curta s√©rie de tr√™s artigos, falei sobre vulnerabilidades do Steam ( <a href="https://habr.com/ru/company/pm/blog/462479/">1</a> , <a href="https://habr.com/ru/company/pm/blog/464367/">2</a> e <a href="https://habr.com/ru/company/pm/blog/469507/">3</a> ).  Neste artigo, falarei sobre as vulnerabilidades de um produto similar - Origin, que tamb√©m √© um iniciador de jogos.  As vulnerabilidades descobertas foram numeradas CVE-2019-19247 e CVE-2019-19248. <br><br><img src="https://habrastorage.org/webt/bi/b8/vt/bib8vt2hmgqzkyfv39xm5ri8wxk.jpeg"><br><br>  Desta vez, n√£o haver√° jogo com banana anban.  A hist√≥ria da comunica√ß√£o com a divis√£o de seguran√ßa da Electronic Arts Inc foi inicialmente em n√≠vel profissional.  Quando fui contatado, eles me deram um n√∫mero de registro, os relat√≥rios foram cuidadosamente examinados e confirmados.  Nenhum dos meus e-mails foi ignorado e, para um pouco de discuss√£o, uma confus√£o foi organizada.  A manuten√ß√£o desses relat√≥rios foi muito simples para mim, pela qual agrade√ßo a Adrian Stone, Elise Murphy e outros funcion√°rios da EA que trabalharam com meus relat√≥rios.  <a href="https://www.ea.com/security/news/origin-security-update-in-collaboration-with-external-security-researchers">Postagem</a> e <a href="https://www.ea.com/security/news/easec-2019-001-elevation-of-privilege-vulnerability-in-origin-client">aviso de</a> <a href="https://www.ea.com/security/news/origin-security-update-in-collaboration-with-external-security-researchers">seguran√ßa do blog</a> . <br><br>  Agora para as vulnerabilidades.  Eu encontrei duas vulnerabilidades como "escalonamento de privil√©gios" (lpe - escalonamento de privil√©gios locais ou eop - escalonamento de privil√©gios) no cliente Windows Origin.  Esse tipo de vulnerabilidade permite que qualquer usu√°rio do Windows obtenha mais direitos do que os originalmente emitidos pelo administrador.  Nesse caso, estamos falando de dois aprimoramentos "t√≠picos" - de qualquer usu√°rio ao NT AUTHORITY \ SYSTEM (uma conta com permiss√µes m√°ximas no sistema operacional).  A primeira vulnerabilidade √© bastante entediante, portanto, na pr√≥xima se√ß√£o, descreverei brevemente.  Mas o segundo foi bastante interessante, na se√ß√£o dela vou lhe dizer exatamente como eu a procurei. <br><a name="habracut"></a><br><h2>  <font color="orange">CVE-2019-19248</font> </h2><br>  Esta vulnerabilidade consiste em duas partes: <br><br><ol><li> Criando uma pasta em um caminho arbitr√°rio (com direitos de acesso total); </li><li>  Use a cl√°usula 1 para obter privil√©gios NT AUTHORITY \ SYSTEM. </li></ol><br>  Agora, sobre o primeiro ponto em mais detalhes: <br><br><h3>  Prepara√ß√£o do ambiente </h3><br>  √â necess√°rio fechar o cliente Origin e interromper o Servi√ßo do Cliente Origin (em teoria, o servi√ßo em si ser√° interrompido se voc√™ fechar o cliente, apenas por precau√ß√£o). <br><br>  Para a pasta "C: \ ProgramData \ Origin", os direitos s√£o "Acesso Completo", o que nos permite excluir completamente seu conte√∫do. <br><br><h3>  Link Building </h3><br>  Agora crie alguns links.  O primeiro link ser√° do tipo Ponto de Nova An√°lise NTFS (Ponto de Montagem NTFS) - o tipo de links apontando de pasta para pasta: ‚ÄúC: \ ProgramData \ Origin‚Äù &lt;-&gt; ‚Äú\ RPC Control‚Äù.  Para criar pontos de nova an√°lise, n√£o precisa de direitos de administrador.  S√≥ √© necess√°rio que a pasta de origem esteja vazia e o usu√°rio tenha permiss√µes de grava√ß√£o (elas foram limpas na √∫ltima etapa, os direitos foram verificados l√°).  "\ RPC Control" n√£o √© uma pasta no sistema de arquivos, mas um tipo especial de pasta - um diret√≥rio de objetos.  Voc√™ n√£o pode v√™-lo com um explorador comum, mas pode fazer um ponto de nova an√°lise, aparentemente devido √†s abstra√ß√µes comuns usadas nas entranhas do Windows. <br><br>  Agora criaremos o link simb√≥lico usual "\ RPC Control \ CatalogCache" &lt;-&gt; "C: \ Path \ To \ Target \ Folder".  No sistema de arquivos, a cria√ß√£o de links simb√≥licos sem direitos de administrador √© proibida, mas esta regra n√£o se aplica aos diret√≥rios de objetos.  Portanto, nosso link ser√° criado com sucesso.  Como resultado de uma combina√ß√£o desses dois links, as chamadas para "C: \ ProgramData \ Origin \ CatalogCache" ser√£o redirecionadas para "C: \ Path \ To \ Target \ Folder". <br><br>  Leia mais sobre esses links <a href="https://github.com/googleprojectzero/symboliclink-testing-tools/blob/master/CreateSymlink/CreateSymlink_readme.txt">aqui</a> .  No mesmo reposit√≥rio, <a href="https://github.com/googleprojectzero/symboliclink-testing-tools/releases">voc√™ pode baixar</a> utilit√°rios para trabalhar com links. <br><br><h3>  Lan√ßamento </h3><br>  Na √∫ltima etapa, execute o cliente.  No in√≠cio de seu trabalho, ele lan√ßar√° o "Servi√ßo de origem do cliente" e, descobrindo que n√£o h√° nenhuma pasta "C: \ ProgramData \ Origin \ CatalogCache", ele tentar√° cri√°-lo.  Como resultado da navega√ß√£o pelos links simb√≥licos, ele criar√° ‚ÄúC: \ Path \ To \ Target \ Folder‚Äù e conceder√° a essa pasta os direitos de ‚ÄúAcesso Total‚Äù. <br><br>  O que era necess√°rio para ser obtido no primeiro ponto de opera√ß√£o.  Vamos para o segundo. <br><br><h3>  A opera√ß√£o de criar uma pasta em um caminho arbitr√°rio </h3><br>  Aqui voc√™ pode trabalhar de v√°rias maneiras. <br><br>  Simples e razoavelmente confi√°vel √© criar a pasta "C: \ Windows \ system32 \ LogonUI.exe.local".  ‚ÄúLogonUI.exe‚Äù (um aplicativo em execu√ß√£o no NT AUTHORITY \ SYSTEM, √© respons√°vel pela opera√ß√£o da tela de sele√ß√£o do usu√°rio e da tela de bloqueio) gra√ßas ao mecanismo ‚Äú.local-redirection‚Äù (‚Äúdotlocal redirection‚Äù), ele carregar√° a biblioteca a partir dela no caminho ‚ÄúC: \ Windows \ system32 \ LogonUI.exe.local \ amd64_microsoft.windows.common-controls_6595b64144ccf1df_6.0.17134.648_none_fb45a0e93062a6d2 \ comctl32.dll. "  Em geral, o mecanismo em si √© bastante comum, portanto pode ter muitos objetivos. <br><br>  Uma maneira longa, por√©m interessante, √© subtrair o hash da senha do administrador por meio de fraudes especiais.  Mais detalhes <a href="https://googleprojectzero.blogspot.com/2017/08/windows-exploitation-tricks-arbitrary.html">aqui</a> . <br><br><h3>  Total </h3><br>  A vulnerabilidade √© explorada com bastante facilidade, voc√™ s√≥ precisa trabalhar um pouco no segundo ponto - encontre o alvo e escreva uma dll adequada.  Al√©m disso, Matt Nelson tamb√©m relatou essa vulnerabilidade, e seus escritos podem ser encontrados <a href="https://enigma0x3.net/2019/12/10/cve-2019-19248-local-privilege-escalation-in-eas-origin-client/">aqui</a> . <br><br><h2>  <font color="orange">CVE-2019-19247</font> </h2><br>  Essa √© uma das minhas vulnerabilidades favoritas.  Ele mostra com que cuidado voc√™ precisa se relacionar com a criptografia usada. <br><br>  Tudo come√ßou com o fato de eu ter instalado o jogo atrav√©s do Origin.  De alguma forma, tudo correu muito bem - alguns cliques e ap√≥s alguns minutos de download do jogo podem ser iniciados.  N√£o imediatamente, mas eu entendi qual era o problema: o jogo foi instalado no caminho "C: \ Arquivos de Programas \ Nome_do_Jogo", mas n√£o fez uma √∫nica pergunta pelo UAC.  Eu rapidamente verifiquei os direitos, tudo era padr√£o - um usu√°rio comum n√£o podia escrever em "C: \ Arquivos de Programas".  Um pouco mais de pesquisa e descobri que o jogo n√£o √© "prescrito" pelo pr√≥prio cliente Origin, mas pelo servi√ßo de atendimento ao cliente Origin. <br><br>  Comecei a fazer suposi√ß√µes sobre como o cliente transmite informa√ß√µes para o servi√ßo, a fim de verificar se algo pode ser explorado. <br><br>  O m√©todo de transmiss√£o de informa√ß√µes acabou sendo simples - um pipe nomeado.  Aprendi sobre isso nos logs de instala√ß√£o - em texto simples, foi indicado que o canal OriginClientService estava aceitando comandos para trabalhar com arquivos e pastas. <br><br>  IDA aberto, carregou o cliente l√°. <br><br>  <b>* trabalho realizado na AID: 1 *</b> <br><br>  Muito rapidamente, descobri que os comandos eram enviados ao canal em geral em forma de texto.  Nas proximidades, encontrei uma lista de comandos e, sem mais delongas, enviei um comando do tipo "copiar" C: \ test \ payload.dll "" C: \ Windows \ pwn.dll "para o canal.  Antecipando um resultado r√°pido, verifico a pasta ‚ÄúC: \ Windows‚Äù e n√£o encontro nada de novo nela.  Mas h√° algo novo nos logs - algumas palavras sobre o fato de o cliente no canal n√£o ter passado na verifica√ß√£o da assinatura digital. <br><br>  IDA aberto, carregou o servi√ßo l√°. <br><br>  <b>* trabalho realizado na AID: 2 *</b> <br><br>  Eu descobri que as equipes n√£o s√£o esperadas de ningu√©m.  Ao conectar a um tubo, o servi√ßo verifica quem est√° conectado a ele.  O processo pid √© extra√≠do da conex√£o, o caminho para o arquivo execut√°vel √© extra√≠do do pid, a assinatura √© verificada quanto √† exatid√£o e √© emitida pela EA. <br>  Soa som, mas n√£o o suficiente.  Voc√™ pode pegar o "Origin.exe" (arquivo execut√°vel do cliente), copi√°-lo em algum lugar da sua pasta.  Coloque algumas dll da lista de importa√ß√£o "Origin.exe" nesta pasta.  Por exemplo, version.dll surgiu.  Eu chamei essa abordagem de "inje√ß√£o reversa de DLL": em uma inje√ß√£o regular de DLL, copiamos a DLL para o arquivo exe, mas agora fizemos o oposto.  Eu escrevo rapidamente dll proxy para version.dll, adicione c√≥digo ao enviar o comando para o pipe.  A carga √∫til ainda n√£o foi copiada.  Lemos os logs - "o que significa, o comando n√£o pode ser descriptografado!?".  Eu pulei a criptografia. <br><br>  IDA aberto, carregou o cliente l√°. <br><br>  <b>* trabalhos realizados na IDA: 3, desvio de assinatura: 1 *</b> <br><br>  Como o cliente envia comandos criptografados em seu trabalho usual, eu posso.  L√° eu olhei, depois olhei, o resultado √© o seguinte: Criptografia AES, inicializando um vetor constante, a chave √© lida no arquivo.  N√≥s praticamente copiamos esta pe√ßa e a IDA no c√≥digo, compilamos, verificamos.  Novamente nada.  Mas os logs novamente fornecem informa√ß√µes √∫teis - voc√™ n√£o pode especificar Arquivos de Programas como o caminho de destino. <br><br>  IDA aberto, carregou o servi√ßo l√°. <br><br>  <b>* trabalho realizado no IDA: 4, desvio de assinatura: 1, desvio de criptografia: 1 *</b> <br><br>  Portanto, √© verdade que existem verifica√ß√µes para obter um comando de que os arquivos n√£o podem ser copiados em qualquer lugar.  E caminhos com "\ .. \" n√£o podem ser escritos.  Olhamos o que outras equipes s√£o. <br>  Trabalhando com o registro - h√° novamente muitas restri√ß√µes.  Mas iniciar arquivos parece interessante.  Pelo menos as verifica√ß√µes n√£o s√£o particularmente vis√≠veis.  Edite o c√≥digo, envie o comando "ExecuteProcess" C: \ test \ payload.exe "".  Bem, voc√™ entende ... Nada. <br><br>  Os logs novamente falam sobre a assinatura.  Oh, n√≥s j√° vencemos.  Indicamos no c√≥digo que chamamos nosso Origin.exe copiado para carregar nossa DLL proxy novamente, mas com direitos de sistema.  Adicione verifica√ß√µes e inicie o console.  Come√ßamos e o console com os direitos NT AUTHORITY \ SYSTEM aparece - finalmente tudo funcionou. <br><br>  <b>* trabalho realizado no IDA: 4, desvio de assinatura: 2, desvio de criptografia: 1 *</b> <br><br>  Portanto, voc√™ precisa reiniciar, executar uma execu√ß√£o final e ainda admirar o console com direitos m√°ximos.  Reinicie, verifique e ... nada.  Como assim?  Apenas funcionou. <br><br>  Os diagn√≥sticos mostram que o Servi√ßo de Cliente de Origem n√£o foi iniciado, por isso estou iniciando-o.  Mas isso n√£o come√ßa.  Mais precisamente, ele inicia, mas fecha imediatamente.  Inicio o cliente Origin e o servi√ßo √© iniciado normalmente.  Depois disso, a explora√ß√£o funcionar√° corretamente novamente.  Seria poss√≠vel parar por a√≠, mas esse n√£o √© o meu caminho - eu quero fazer a explora√ß√£o funcionar completamente. <br><br>  IDA aberto, carregou o servi√ßo l√°. <br><br>  <b>* trabalho realizado no IDA: 5, assinatura manual: 2, criptografia manual: 1 *</b> <br><br>  Acontece que, na inicializa√ß√£o, verifica com quais par√¢metros o servi√ßo foi iniciado.  N√£o h√° nada diretamente interessante l√°.  Base64 do pid criptografado do processo cujo arquivo √© verificado pela assinatura.  Parece complicado, mas j√° contornamos a criptografia e a assinatura tamb√©m.  Estamos escrevendo algum c√≥digo e uma explora√ß√£o completa est√° pronta. <br><br><h3>  Total </h3><br>  A explora√ß√£o est√° funcionando.  O trabalho foi realizado no IDA: 5 vezes, assinatura de desvio: 3 vezes, desvio de criptografia: 2 vezes. <br><br><h2>  <font color="orange">Conclus√£o</font> </h2><br>  Vulnerabilidades corrigidas: os desenvolvedores da EA introduziram um modo restrito de opera√ß√£o especial para o cliente, que estabelece s√©rias restri√ß√µes ao trabalho com pastas e pipes do Origin. <br><br>  Vulnerabilidades da linha do tempo: <br><br>  <b>1 de abril de 2019</b> : relat√≥rio de relat√≥rio de vulnerabilidade com pipe; <br><br>  <b>7 de abril de 2019</b> : enviando um relat√≥rio de vulnerabilidade com uma pasta arbitr√°ria; <br><br>  ... MUITAS LETRAS (contei 40) ... <br><br>  <b>10 de dezembro de 2019</b> : divulga√ß√£o acordada. <br><br>  Obrigado a todos pela aten√ß√£o, desejo a voc√™ os mesmos agentes de seguran√ßa. <br><br>  <a href="https://amonitoring.ru/article/origin_lpe_disclosure/">Este artigo em ingl√™s.</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt479704/">https://habr.com/ru/post/pt479704/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt479690/index.html">Zork e Z-Machine: como os desenvolvedores transferiram o jogo dos mainframes para os computadores dom√©sticos de 8 bits</a></li>
<li><a href="../pt479692/index.html">Indexando bilh√µes de vetores de texto</a></li>
<li><a href="../pt479696/index.html">Algumas palavras sobre Alter Table, ou como n√£o faz√™-lo</a></li>
<li><a href="../pt479700/index.html">CIMON-2: (des) Doomsday, ou como o IBM Watson subiu acima das nuvens</a></li>
<li><a href="../pt479702/index.html">Torradeira, Meu c√≠rculo e Freelansim se tornam parte da Habr</a></li>
<li><a href="../pt479708/index.html">Postagem n√£o oficial sobre a rebranding da Habr + Competition</a></li>
<li><a href="../pt479712/index.html">Aprendizado de m√°quina como assistente de monitoramento inteligente</a></li>
<li><a href="../pt479714/index.html">Unifica√ß√£o de componentes visuais. Parte 1. Estilos</a></li>
<li><a href="../pt479716/index.html">Outro SuperApp "primeiro do mundo"</a></li>
<li><a href="../pt479718/index.html">Construindo um aplicativo de ambiente arduino usando o CI github</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>