<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>😴 👸🏾 🏤 SandboxEscaper / PoC-LPE: ¿qué hay dentro? 🙅🏾 😸 🍚</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Aquí está el error de alpc como 0day: https://t.co/m1T3wDSvPX Ya no me importa la vida. Tampoco quiero volver a enviarme a MSFT de todos modos. A la m...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>SandboxEscaper / PoC-LPE: ¿qué hay dentro?</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/421593/"><div class="oembed"><twitter-widget class="twitter-tweet twitter-tweet-rendered" id="twitter-widget-0" style="position: absolute; visibility: hidden; display: block; transform: rotate(0deg);"></twitter-widget><blockquote class="twitter-tweet twitter-tweet-error" data-lang="en_US" data-twitter-extracted-i1584478471921345586="true"><p lang="en" dir="ltr">  Aquí está el error de alpc como 0day: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://t.co/m1T3wDSvPX</a> Ya no me importa la vida.  Tampoco quiero volver a enviarme a MSFT de todos modos.  A la mierda toda esta mierda. </p>  - SandboxEscaper (@SandboxEscaper) <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">27 de agosto de 2018</a> </blockquote><script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></div><br>  En un habr ya hay <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">noticias sobre esta vulnerabilidad</a> , pero, desafortunadamente, sin detalles técnicos.  Le sugiero que mire dentro del <a href="">archivo</a> publicado (autor - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">SandboxEscaper</a> ). <br><br>  Debajo del cortador se encuentra la traducción del documento de descripción en el archivo. <br><a name="habracut"></a><br>
<h2>  Descripción de la vulnerabilidad </h2><br>  El servicio del Programador de tareas tiene una interfaz RPC (accesible a través del transporte ALPC) que admite el método SchRpcSetSecurity. <br><br>  Este es el prototipo de este método: <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">long</span></span> _SchRpcSetSecurity( [in][<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">wchar_t</span></span>* arg_1, <span class="hljs-comment"><span class="hljs-comment">//Task name [in][string] wchar_t* arg_2, //Security Descriptor string [in]long arg_3);</span></span></code> </pre> <br>  Las tareas creadas por el planificador de tareas crean el directorio / archivo correspondiente en c: \ windows \ system32 \ tareas.  Probablemente, este método está destinado a registrar tareas DACL'a ubicadas allí.  Pero la grabación ocurrirá después de la suplantación.  Sin embargo, por alguna razón, la implementación del método también verifica la presencia de un archivo .job en c: \ windows \ tareas y escribe un DACL <b>sin suplantación</b> .  Dado que el usuario (incluso el usuario del grupo de invitados) puede crear archivos en este directorio, simplemente podemos crear un enlace a cualquier otro archivo que podamos leer.  Al usar dicho enlace rígido, podemos forzar al servicio del planificador (que se ejecuta con privilegios de SYSTEM) a escribir una DACL arbitraria (consulte el segundo parámetro SchRpcSetSecurity) en un archivo de nuestra elección. <br><br>  Por lo tanto: para cualquier archivo que se pueda leer, puede cambiar el DACL, lo que le permite sobrescribirlo por completo. <br><br><h2>  Explotación de vulnerabilidad </h2><br>  ¡Esta vulnerabilidad nos da una primitiva realmente fuerte!  El problema principal es que después de la instalación (por defecto), muchos usuarios importantes solo pueden ser modificados por el usuario TrustedInstaller (pero no por el usuario SYSTEM). <br><br>  El archivo contiene una secuencia de comandos de PowerShell para enumerar archivos que puede controlar.  Solo corre: <br> <code>./enumerate.ps1 &gt;output.txt</code> <br> <br>  El sistema tiene muchos objetivos.  Puede controlar los archivos de programa, y ​​si un administrador u otro usuario utiliza su archivo de destino, los archivos que ha sobrescrito se pueden iniciar con los privilegios necesarios. <br><br>  El segundo problema es que, aunque podemos obtener el control de muchos archivos, escribir en ellos a menudo es imposible, porque estas DLL ya están cargadas en algún lugar para su ejecución.  Intentar escribir un DACL para un archivo cargado para su ejecución causará un error de acceso compartido.  Pero la vulnerabilidad se puede usar para otros tipos de archivos, que pueden ser un mejor objetivo que una DLL. <br><br>  Para la operación, se seleccionó el archivo C: \ Windows \ System32 \ DriverStore \ FileRepository \ prnms003.inf_amd64_4592475aca2acf83 \ Amd64 \ printconfig.dll (el nombre del directorio puede variar, esto se tiene en cuenta en PoC).  Parece que este archivo pertenece a la impresora XPS y no está cargado en el servicio de impresión de forma predeterminada (puede suceder que el archivo ya esté cargado ... pero más a menudo no lo está). <br><br>  Y cuando comenzamos el trabajo de impresión con la impresora XPS, el servicio cargará esta DLL, que podemos reescribir de antemano.  Tal vector de ataque (secuestro) se puede aplicar fácilmente para algo mejor.  Puedo intentar encontrar las mejores opciones ... solo házmelo saber. <br><br>  <i>Nota</i> : en una computadora portátil antigua, donde Windows 10 se ejecuta desde hace varios años, hay dos directorios prnms003.inf_amd64_ *.  La nueva versión no elimina la anterior, lo que significa que no hay garantía de que FindFirstFile (usado en PoC) encuentre el directorio actual.  Por lo tanto, puede expandir el código sobrescribiendo todos los printconfig.dll encontrados o verificar el atributo del último registro en el archivo y seleccionar uno más nuevo. <br><br><h2>  Demo </h2><br>  También puede encontrar un video con una demostración en el archivo: <br><div class="spoiler">  <b class="spoiler_title">Texto oculto</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/bv/7u/ex/bv7uexrpuukpd88dczokubk29mg.gif"><br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es421593/">https://habr.com/ru/post/es421593/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es421583/index.html">¿Dónde ir a la universidad para estudiar para un especialista en TI? + encuesta</a></li>
<li><a href="../es421585/index.html">¿Cómo decidió el concurso retro cosacos</a></li>
<li><a href="../es421587/index.html">[Ekaterimburgo, anuncio] Java Mitap - JUG.EKB</a></li>
<li><a href="../es421589/index.html">Metamorfosis: programación molecular de la forma.</a></li>
<li><a href="../es421591/index.html">Sistema de presupuesto para video vigilancia inalámbrica (Wi-Fi) autónoma (desde batería)</a></li>
<li><a href="../es421595/index.html">Cómo las personas de TI encuentran trabajo en los EE. UU. Y la UE: los 9 mejores recursos</a></li>
<li><a href="../es421599/index.html">Intel Crimson Canyon: NUC con gráficos discretos y procesador de 10 nm</a></li>
<li><a href="../es421601/index.html">Cuando en gcc hay direcciones de 16 bits, y de repente la memoria es de 256k</a></li>
<li><a href="../es421603/index.html">Google y DevOps: dos libros sobre SRE</a></li>
<li><a href="../es421607/index.html">"Ni siquiera intentamos ejecutar el código antiguo, no tenemos esa tarea en principio" - Roman Elizarov sobre el desarrollo de Kotlin</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>