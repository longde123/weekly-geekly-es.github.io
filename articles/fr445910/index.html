<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üñêÔ∏è üëºüèæ üöß Comment nous sommes devenus amis avec EF 6 MSSQL et PostgresSQL ü§∏üèæ üë©üèª‚Äçüé® üé´</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Il √©tait une fois un projet sur EF 6 avec le SGBD MSSQL. Et il fallait ajouter la possibilit√© de travailler avec PostgreSQL. Nous ne nous attendions p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment nous sommes devenus amis avec EF 6 MSSQL et PostgresSQL</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/crosstech/blog/445910/"><img src="https://habrastorage.org/webt/_a/jr/dp/_ajrdpk_rrdrsqmckt71xkfceve.jpeg" alt="image"><br><br>  Il √©tait une fois un projet sur EF 6 avec le SGBD MSSQL.  Et il fallait ajouter la possibilit√© de travailler avec PostgreSQL.  Nous ne nous attendions pas √† des probl√®mes ici, car il existe un grand nombre d'articles sur ce sujet, et sur les forums, vous pouvez trouver une discussion sur des probl√®mes similaires.  Cependant, en r√©alit√©, tout n'a pas √©t√© aussi simple, et dans cet article, nous parlerons de cette exp√©rience, des probl√®mes que nous avons rencontr√©s lors de l'int√©gration du nouveau fournisseur et de la solution que nous avons choisie. <br><a name="habracut"></a><br><h3>  Introduction </h3><br>  Nous avons un produit en bo√Æte, et il a une structure d√©j√† √©tablie.  Initialement, il a √©t√© configur√© pour fonctionner avec un SGBD - MSSQL.  Le projet dispose d'une couche d'acc√®s aux donn√©es avec impl√©mentation EF 6 (approche Code First).  Nous travaillons avec les migrations via EF 6 Migrations.  Les migrations sont cr√©√©es manuellement.  L'installation initiale de la base de donn√©es se produit √† partir de l'application console avec l'initialisation du contexte sur la cha√Æne de connexion, pass√©e en argument: <br><br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (args.Length == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Exception(<span class="hljs-string"><span class="hljs-string">"No arguments in command line"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> connectionString = args[<span class="hljs-number"><span class="hljs-number">0</span></span>]; Console.WriteLine(<span class="hljs-string"><span class="hljs-string">$"Initializing dbcontext via </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{connectionString}</span></span></span><span class="hljs-string">"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> context = MyDbContext(connectionString)) { Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Database created"</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { Console.WriteLine(e.Message); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span>; } }</code> </pre> <br>  Dans le m√™me temps, l'infrastructure EF et le domaine sont d√©crits dans un autre projet, qui est connect√© √† l'application console en tant que biblioth√®que.  Le constructeur de contexte dans le projet d'infrastructure ressemble √† ceci: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MyDbContext</span></span> : <span class="hljs-title"><span class="hljs-title">IdentityDbContext</span></span>&lt;<span class="hljs-title"><span class="hljs-title">User</span></span>, <span class="hljs-title"><span class="hljs-title">Role</span></span>, <span class="hljs-title"><span class="hljs-title">Key</span></span>, <span class="hljs-title"><span class="hljs-title">UserLogin</span></span>, <span class="hljs-title"><span class="hljs-title">UserRole</span></span>, <span class="hljs-title"><span class="hljs-title">UserClaim</span></span>&gt;, <span class="hljs-title"><span class="hljs-title">IUnitOfWork</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MyDbContext</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> connectionString</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">connectionString</span></span></span><span class="hljs-function">)</span></span> { Database.SetInitializer(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DbInitializer()); Database.Initialize(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); } }</code> </pre><br><h3>  Premier lancement </h3><br>  La premi√®re chose que nous avons faite a √©t√© de connecter deux packages au projet via nuget: Npgsql et EntityFramework6.Npgsql. <br><br>  Nous avons √©galement enregistr√© les param√®tres de Postgres dans l'App.config de notre application console. <br><br>  La section entityFramework a sp√©cifi√© la fabrique de postgres par d√©faut comme fabrique de connexions: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">entityFramework</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--&lt;defaultConnectionFactory type="System.Data.Entity.Infrastructure.SqlConnectionFactory, EntityFramework" /&gt;--&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">defaultConnectionFactory</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Npgsql.NpgsqlConnectionFactory, EntityFramework6.Npgsql"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">providers</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">provider</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">invariantName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"System.Data.SqlClient"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"System.Data.Entity.SqlServer.SqlProviderServices, EntityFramework.SqlServer"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">provider</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">invariantName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Npgsql"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Npgsql.NpgsqlServices, EntityFramework6.Npgsql"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">providers</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">entityFramework</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Dans la section DbProviderFactories, l'usine du nouveau fournisseur a √©t√© enregistr√©e: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system.data</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DbProviderFactories</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">add</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Npgsql Data Provider"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">invariant</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Npgsql"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">support</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"FF"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">description</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">".Net Framework Data Provider for Postgresql"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Npgsql.NpgsqlFactory, Npgsql"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DbProviderFactories</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system.data</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Et tout de suite, ils ont essay√© d'initialiser la base de donn√©es en sp√©cifiant l'adresse du serveur Postgres et les informations d'identification de l'administrateur du serveur dans la cha√Æne de connexion.  Le r√©sultat est la ligne suivante: <br><blockquote>  ¬´Server = localhost;  DataBase = TestPostgresDB;  S√©curit√© int√©gr√©e = faux;  ID utilisateur = postgres;  mot de passe = pa $$ w0rd ‚Äù </blockquote>  Comme pr√©vu, gr√¢ce au mode EF Migrations manuel, l'initialisation n'a pas r√©ussi et une erreur s'est produite ne correspondant pas √† l'image de la base de donn√©es du mod√®le actuel.  Afin de contourner la cr√©ation de la migration principale avec le nouveau fournisseur et tester l'initialisation de la base de donn√©es sur Postgres, nous avons l√©g√®rement ajust√© la configuration de notre infrastructure. <br><br>  Premi√®rement, nous avons activ√© les ¬´migrations automatiques¬ª - une option utile si un d√©veloppeur modifie les mod√®les de domaine et l'infrastructure EF de l'√©quipe: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Configuration</span></span> : <span class="hljs-title"><span class="hljs-title">DbMigrationsConfiguration</span></span>&lt;<span class="hljs-title"><span class="hljs-title">MyDbContext</span></span>&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Configuration</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { AutomaticMigrationsEnabled = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; ContextKey = <span class="hljs-string"><span class="hljs-string">"Project.Infrastructure.MyDbContext"</span></span>; } }</code> </pre><br>  Deuxi√®mement, nous avons sp√©cifi√© un nouveau fournisseur dans la m√©thode red√©finie InitializeDatabase de la classe h√©rit√©e CreateDatabaseIfNotExists, o√π nous commen√ßons les migrations: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DbInitializer</span></span> : <span class="hljs-title"><span class="hljs-title">CreateDatabaseIfNotExists</span></span>&lt;<span class="hljs-title"><span class="hljs-title">MyDbContext</span></span>&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InitializeDatabase</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">MyDbContext context</span></span></span><span class="hljs-function">)</span></span> { DbMigrator dbMigrator = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DbMigrator(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Configuration { <span class="hljs-comment"><span class="hljs-comment">//TargetDatabase = new DbConnectionInfo(context.Database.Connection.ConnectionString, "System.Data.SqlClient") TargetDatabase = new DbConnectionInfo(context.Database.Connection.ConnectionString, "Npgsql") }); // There some code for run migrations } }</span></span></code> </pre><br>  Ensuite, nous avons relanc√© notre application console avec la m√™me cha√Æne de connexion comme argument.  Cette fois, l'initialisation du contexte s'est d√©roul√©e sans erreur et nos mod√®les de domaine s'int√®grent en toute s√©curit√© dans la nouvelle base de donn√©es Postgres.  L'√©tiquette ¬´__MigrationHistory¬ª est apparue dans la nouvelle base de donn√©es, dans laquelle il y avait un seul enregistrement de la premi√®re migration cr√©√©e automatiquement. <br><br>  Pour r√©sumer: nous avons pu connecter un nouveau fournisseur √† un projet existant sans aucun probl√®me, mais en m√™me temps, nous avons modifi√© les param√®tres du m√©canisme de migration. <br><br><h3>  Activer le mode de migration manuelle </h3><br>  Comme mentionn√© ci-dessus, lorsque le mode de migration automatique est activ√©, vous privez votre √©quipe de d√©veloppement parall√®le dans les domaines d'acc√®s au domaine et aux donn√©es.  Pour nous, cette option √©tait inacceptable.  Par cons√©quent, nous devions mettre en place un mode manuel de migrations dans le projet. <br><br>  Tout d'abord, nous avons renvoy√© le champ AutomaticMigrationsEnabled √† false.  Ensuite, il a fallu g√©rer la cr√©ation de nouvelles migrations.  Nous avons compris que les migrations pour diff√©rents SGBD, au moins, devaient √™tre stock√©es dans diff√©rents dossiers de projet.  Par cons√©quent, nous avons d√©cid√© de cr√©er un nouveau dossier pour les migrations Postgres dans un projet d'infrastructure appel√© PostgresMigrations (le dossier avec les migrations MsSql, pour plus de clart√©, nous l'avons renomm√© MsSqlMigrations) et y avons copi√© le fichier de configuration de la migration MsSql.  Dans le m√™me temps, nous n'avons pas copi√© toutes les migrations MsSql existantes vers PostgresSql.  Premi√®rement, car ils contiennent tous un instantan√© de la configuration du fournisseur MsSql et, par cons√©quent, nous ne pourrons pas les utiliser sur le nouveau SGBD.  Deuxi√®mement, l'historique des modifications n'est pas important pour le nouveau SGBD, et nous pouvons nous en tirer avec le dernier instantan√© de l'√©tat des mod√®les de domaine. <br><br>  Nous pensions que tout √©tait pr√™t pour la formation de la premi√®re migration vers Postgres.  La base de donn√©es cr√©√©e lors de l'initialisation du contexte avec le mode de migration automatique activ√© a √©t√© supprim√©e.  Et, guid√©s par le fait que pour la premi√®re migration, vous devez cr√©er une base de donn√©es physique bas√©e sur l'√©tat actuel des mod√®les de domaine, nous avons heureusement not√© la commande Update-Database dans la console du gestionnaire de packages, en sp√©cifiant uniquement le param√®tre de cha√Æne de connexion.  En cons√©quence, nous avons obtenu une erreur li√©e √† la connexion au SGBD. <br><br>  Apr√®s avoir √©tudi√© en plus le principe de fonctionnement de la commande Update-Database, nous avons fait ce qui suit: <br><br><ul><li>  a ajout√© le code suivant aux param√®tres de configuration de la migration: <br><br>  pour MsSql: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Configuration</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { AutomaticMigrationsEnabled = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; ContextKey = <span class="hljs-string"><span class="hljs-string">"Project.Infrastructure.MyDbContext"</span></span>; MigrationsDirectory = <span class="hljs-string"><span class="hljs-string">@"MsSqlMigrations"</span></span>; }</code> </pre><br>  pour Postgres: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Configuration</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { AutomaticMigrationsEnabled = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; ContextKey = <span class="hljs-string"><span class="hljs-string">"Project.Infrastructure.MyDbContext"</span></span>; MigrationsDirectory = <span class="hljs-string"><span class="hljs-string">@"PostgresMigrations"</span></span>; }</code> </pre></li><li>  a indiqu√© le param√®tre n√©cessaire de la commande Update-Database en passant le nom du fournisseur </li><li>  param√®tres ajout√©s qui indiquent le projet contenant la description de l'infrastructure ef et le dossier avec la configuration de migration du nouveau fournisseur </li></ul><br>  En cons√©quence, nous avons obtenu cette commande: <br><blockquote>  Update-Database -ProjectName "Project.Infrastructure" -ConfigurationTypeName Project.Infrastructure.PostgresMigrations.Configuration -ConnectionString "Server = localhost;  DataBase = TestPostgresDB;  S√©curit√© int√©gr√©e = faux;  ID utilisateur = postgres;  mot de passe = pa $$ w0rd "-ConnectionProviderName" Npgsql " </blockquote>  Apr√®s avoir ex√©cut√© cette commande, nous avons pu ex√©cuter la commande Add-Migration avec des param√®tres similaires, en nommant la premi√®re migration InitialCreate: <br><blockquote>  Add-Migration -Name "InitialCreate" -ProjectName "CrossTech.DSS.Infrastructure" -ConfigurationTypeName CrossTech.DSS.Infrastructure.PostgresMigrations.Configuration -ConnectionString "Server = localhost;  DataBase = TestPostgresDB;  S√©curit√© int√©gr√©e = faux;  ID utilisateur = postgres;  mot de passe = pa $$ w0rd "-ConnectionProviderName" Npgsql " </blockquote>  Un nouveau fichier est apparu dans le dossier PostgresMigrations: 2017010120705068_InitialCreate.cs <br><br>  Ensuite, nous avons supprim√© la base de donn√©es cr√©√©e apr√®s l'ex√©cution de la commande Update-Database et lanc√© notre application console avec la cha√Æne de connexion indiqu√©e ci-dessus comme argument.  Et donc nous avons d√©j√† obtenu la base de donn√©es sur la base d'une migration cr√©√©e manuellement. <br><br>  Pour r√©sumer: nous avons pu, avec un effort minimal, ajouter la premi√®re migration pour le fournisseur Postgres et initialiser le contexte via l'application console, obtenant une nouvelle base de donn√©es, dans laquelle les modifications de notre premi√®re migration manuelle sont entr√©es. <br><br><h3>  Basculer entre les fournisseurs </h3><br>  Nous avions encore une question ouverte: comment configurer l'initialisation du contexte afin qu'il soit possible d'acc√©der √† un SGBD sp√©cifique lors de l'ex√©cution? <br><br>  La t√¢che √©tait qu'au stade d'initialisation du contexte, il √©tait possible de s√©lectionner l'une ou l'autre base de donn√©es cible du fournisseur souhait√©.  √Ä la suite de tentatives r√©p√©t√©es de configurer ce commutateur, nous avons trouv√© une solution qui ressemble √† ceci. <br><br>  Dans l'application console du projet dans app.config (et si vous n'utilisez pas app.config, puis machine.config), nous ajoutons une nouvelle cha√Æne de connexion avec le fournisseur et le nom de la connexion, et dans le constructeur de contexte, nous ¬´d√©posons¬ª le nom de connexion au lieu de la cha√Æne de connexion.  Dans le m√™me temps, nous connectons la cha√Æne de connexion elle-m√™me au contexte via le singleton de l'instance DbConfiguration.  Nous passons l'instance de la classe h√©rit√©e de DbConfiguration en tant que param√®tre. <br><br>  La classe DbConfiguration h√©rit√©e r√©sultante: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DbConfig</span></span> : <span class="hljs-title"><span class="hljs-title">DbConfiguration</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DbConfig</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> connectionName, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> connectionString, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> provideName</span></span></span><span class="hljs-function">)</span></span> { ConfigurationManager.ConnectionStrings.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConnectionStringSettings(connectionName, connectionString, provideName)); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (connectionName) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"PostgresDbConnection"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SetDefaultConnectionFactory(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NpgsqlConnectionFactory()); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SetProviderServices(provideName, NpgsqlServices.Instance); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SetProviderFactory(provideName, NpgsqlFactory.Instance); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"MsSqlDbConnection"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SetDefaultConnectionFactory(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SqlConnectionFactory()); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SetProviderServices(provideName, SqlProviderServices.Instance); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SetProviderFactory(provideName, SqlClientFactory.Instance); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SetDefaultConnectionFactory(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SqlConnectionFactory()); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } }</code> </pre><br>  Et l'initialisation du contexte lui-m√™me ressemble maintenant √† ceci: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> connectionName = args[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> connectionString = args[<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> provideName = args[<span class="hljs-number"><span class="hljs-number">2</span></span>]; DbConfiguration.SetConfiguration(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DbConfig(connectionName, connectionString, provideName)); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> context = MyDbContext(connectionName)) { Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Database created"</span></span>); }</code> </pre><br>  Et qui a suivi attentivement, il a probablement remarqu√© que nous devions faire un autre changement dans le code.  Il s'agit de la d√©finition de la base de donn√©es cible lors de l'initialisation de la base de donn√©es, qui se produit dans la m√©thode InitializeDatabase d√©crite pr√©c√©demment. <br><br>  Nous avons ajout√© un simple commutateur pour d√©terminer la configuration de migration d'un fournisseur particulier: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DbInitializer</span></span> : <span class="hljs-title"><span class="hljs-title">CreateDatabaseIfNotExists</span></span>&lt;<span class="hljs-title"><span class="hljs-title">MyDbContext</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> _connectionName; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DbInitializer</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> connectionName</span></span></span><span class="hljs-function">)</span></span> { _connectionName = connectionName; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InitializeDatabase</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">MyDbContext context</span></span></span><span class="hljs-function">)</span></span> { DbMigrationsConfiguration&lt;MyDbContext&gt; config; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (_connectionName) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"PostgresDbConnection"</span></span>: config = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PostgresMigrations.Configuration(); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"MsSqlDbConnection"</span></span>: config = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MsSqlMigrations.Configuration(); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: config = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (config == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; config.TargetDatabase = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DbConnectionInfo(_connectionName); DbMigrator dbMigrator = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DbMigrator(config); <span class="hljs-comment"><span class="hljs-comment">// There some code for run migrations } }</span></span></code> </pre><br>  Et le constructeur de contexte lui-m√™me a commenc√© √† ressembler √† ceci: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MyDbContext</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> connectionNameParam</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">connectionString</span></span></span><span class="hljs-function">)</span></span> { Database.SetInitializer(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DbInitializer(connectionName = connectionNameParam)); Database.Initialize(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); }</code> </pre><br>  Ensuite, nous avons lanc√© l'application console et sp√©cifi√© le param√®tre d'application MsSql en tant que fournisseur de SGBD.  Nous d√©finissons les arguments de l'application comme suit: <blockquote>  "MsSqlDbConnection" "Server = localhost \ SQLEXPRESS;  Base de donn√©es = TestMsSqlDB;  ID utilisateur = sa;  mot de passe = pa $$ w0rd "" System.Data.SqlClient " </blockquote><br>  La base de donn√©es MsSql a √©t√© cr√©√©e sans erreur. <br><br>  Ensuite, nous avons sp√©cifi√© les arguments de l'application: <br><blockquote>  "PostgresDbConnection" "Server = localhost;  DataBase = TestPostgresDB;  S√©curit√© int√©gr√©e = faux;  ID utilisateur = postgres;  mot de passe = pa $$ w0rd "" Npgsql " </blockquote>  La base de donn√©es Postgres a √©galement √©t√© cr√©√©e sans erreur. <br><br>  Donc, un sous-total de plus - pour qu'EF initialise le contexte de base de donn√©es pour un fournisseur sp√©cifique, vous avez besoin en runtime: <br><br><ul><li>  ¬´Indiquez¬ª le m√©canisme de migration vers ce fournisseur </li><li>  configurer les cha√Ænes de connexion au SGBD avant l'initialisation du contexte </li></ul><br><h3>  Nous travaillons avec les migrations de deux SGBD en √©quipe </h3><br>  Comme nous l'avons vu, la partie la plus int√©ressante commence apr√®s l'apparition de nouveaux changements dans le domaine.  Vous devez g√©n√©rer des migrations pour deux SGBD en tenant compte d'un fournisseur sp√©cifique. <br><br>  Ainsi, pour MSSQL Server, vous devez ex√©cuter des commandes s√©quentielles (pour Postgres, les commandes d√©crites ci-dessus, lors de la cr√©ation de la premi√®re migration): <br><br><ul><li>  mise √† jour de la base de donn√©es selon le dernier instantan√© <br><blockquote>  Update-Database -ProjectName "Project.Infrastructure" -ConfigurationTypeName Project.Infrastructure.MsSqlMigrations.Configuration -ConnectionString "Server = localhost;  DataBase = TestMsSqlDB;  S√©curit√© int√©gr√©e = faux;  ID utilisateur = sa;  mot de passe = pa $$ w0rd "-ConnectionProviderName" System.Data.SqlClient " </blockquote></li><li>  ajout d'une nouvelle migration <br><blockquote>  Add-Migration -Name "SomeMigrationName" -ProjectName "Project.Infrastructure" -ConfigurationTypeName Project.Infrastructure.MsSqlMigrations.Configuration -ConnectionString "Server = localhost;  DataBase = TestMsSqlDB;  S√©curit√© int√©gr√©e = faux;  ID utilisateur = sa;  mot de passe = pa $$ w0rd "-ConnectionProviderName" System.Data.SqlClient " </blockquote></li></ul><br>  Lorsque les d√©veloppeurs apportent des modifications au domaine en parall√®le, nous obtenons plusieurs conflits lors de la fusion de ces modifications dans le syst√®me de contr√¥le de version (pour plus de simplicit√©, nous appellerons git).  Cela est d√ª au fait que les migrations vers EF se font s√©quentiellement les unes apr√®s les autres.  Et si un d√©veloppeur cr√©e une migration, un autre d√©veloppeur ne r√©ussira tout simplement pas √† ajouter la migration de mani√®re s√©quentielle.  Chaque migration suivante stocke des informations sur la pr√©c√©dente.  Ainsi, il est n√©cessaire de mettre √† jour les soi-disant instantan√©s de mod√®le dans la migration vers le dernier cr√©√©. <br><br>  Dans le m√™me temps, la r√©solution des conflits sur les migrations EF dans une √©quipe revient √† prioriser l'importance des changements d'un d√©veloppeur particulier.  Et dont les changements sont plus prioritaires, ceux-ci devraient √™tre les premiers √† les remplir en git, et les autres d√©veloppeurs selon la hi√©rarchie convenue doivent faire ce qui suit: <br><br><ol><li>  supprimer les migrations locales cr√©√©es </li><li>  tirez les modifications du r√©f√©rentiel vers vous-m√™me, o√π d'autres coll√®gues de haute priorit√© ont d√©j√† d√©vers√© leurs migrations </li><li>  cr√©er une migration locale et t√©l√©charger les modifications r√©sultantes dans git </li></ol><br>  Pour autant que nous connaissions le m√©canisme de migration EF, nous pouvons juger que l'approche de d√©veloppement d'√©quipe d√©crite est la seule pour le moment.  Nous ne consid√©rons pas cette solution comme id√©ale, mais elle a droit √† la vie.  Et la question de trouver une alternative au m√©canisme EF Migrations est devenue urgente pour nous. <br><br><h3>  En conclusion </h3><br>  Travailler avec plusieurs SGBD utilisant EF6 en conjonction avec EF Migrations est r√©el, mais dans cette version, les gars de Microsoft n'ont pas pris en compte la possibilit√© d'un travail parall√®le de l'√©quipe utilisant des syst√®mes de contr√¥le de version. <br><br>  Il existe de nombreuses solutions alternatives EF Migrations sur le march√© (payantes et gratuites): DbUp, RoundhousE, ThinkingHome.Migrator, FluentMigrator, etc.  Et √† en juger par les critiques, ils ressemblent plus √† des d√©veloppeurs qu'√† EF Migrations. <br><br>  Heureusement, nous avons maintenant la possibilit√© de faire une sorte de mise √† niveau dans notre projet.  Et dans un avenir proche, nous passerons √† EF Core.  Nous avons pes√© les avantages et les inconv√©nients du m√©canisme EF Core Migrations et sommes arriv√©s √† la conclusion qu'il serait plus pratique pour nous de travailler avec une solution tierce, √† savoir Fluent Migrator. <br><br>  Nous esp√©rons que vous avez √©t√© int√©ress√© par notre exp√©rience.  Pr√™t √† accepter les commentaires et √† r√©pondre aux questions, bienvenue! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr445910/">https://habr.com/ru/post/fr445910/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr445898/index.html">√Ä propos de nouvelles id√©es, de vues √©troites et du bouche √† oreille</a></li>
<li><a href="../fr445900/index.html">Comment r√©sister √† des charges syst√®me accrues: parlez de pr√©parations √† grande √©chelle pour le Black Friday</a></li>
<li><a href="../fr445904/index.html">Types d'infinis et de tronc c√©r√©bral</a></li>
<li><a href="../fr445906/index.html">Ne mangez pas d'aspirine</a></li>
<li><a href="../fr445908/index.html">Golang et l'√©volution de l'interaction des bases de donn√©es</a></li>
<li><a href="../fr445912/index.html">Salut, Habr, nous sommes Advantech</a></li>
<li><a href="../fr445914/index.html">Docker est-il un jouet ou non? Ou est-ce vraiment le cas?</a></li>
<li><a href="../fr445918/index.html">20 ans de RollerCoaster Tycoon: une interview avec le cr√©ateur du jeu</a></li>
<li><a href="../fr445920/index.html">En direct: comment freiner le d√©veloppement iOS dans de grandes √©quipes</a></li>
<li><a href="../fr445922/index.html">Pourquoi regarder des √©missions en ligne si vous pouvez lire Habr</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>