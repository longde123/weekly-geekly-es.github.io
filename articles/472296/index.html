<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚õîÔ∏è üï∫üèø üë©üèª‚Äçüî¨ Sistema de protecci√≥n contra fugas para lavadora üîÉ üë®‚Äçüåæ üë©üèø‚Äçüè´</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduccion 
 Creo que cada casa tiene una lavadora. Por lo general, est√° conectado al suministro de agua a trav√©s de una manguera flexible. Pero una...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Sistema de protecci√≥n contra fugas para lavadora</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/472296/"><img src="https://habrastorage.org/webt/7q/2r/xp/7q2rxpr6f9jntwgc-3ai-qwqglo.jpeg"><br><br><h2>  Introduccion </h2><br>  Creo que cada casa tiene una lavadora.  Por lo general, est√° conectado al suministro de agua a trav√©s de una manguera flexible.  Pero una gran molestia puede suceder con una manguera: a veces explotan, lo que provocar√° una inundaci√≥n tanto en su apartamento como en sus vecinos.  Por lo tanto, las lavadoras est√°n conectadas al suministro de agua a trav√©s de un grifo especial, que debe abrirse antes del lavado y cerrarse despu√©s.  No s√© sobre usted, pero tengo esta gr√∫a en un lugar extremadamente inconveniente.  S√≠, y prefiero comenzar a lavar antes de irme a trabajar, de modo que la mayor parte del d√≠a la manguera est√© bajo presi√≥n y pueda explotar en un momento en que no estoy en casa.  ¬°Ser√≠a genial si la gr√∫a se abre y se cierra en el momento adecuado! <br><br>  La idea me pareci√≥ bastante capaz y decid√≠ implementarla: en microcontroladores y con una v√°lvula motorizada. <br><a name="habracut"></a><br>  Para comenzar, formul√© los requisitos para el sistema desarrollado: <br><br><ul><li>  monitorear el estado de la lavadora: abrir el agua al comienzo del lavado y cerrar al final; </li><li>  la capacidad de controlar manualmente la v√°lvula; </li><li>  funcionamiento con bater√≠a y cierre de la v√°lvula en caso de descarga de la bater√≠a; </li><li>  presencia de un sensor de fugas: cierre la v√°lvula en caso de detectar fugas. </li></ul><br>  Luego descubri√≥ en qu√© partes consistir√≠a: un monitor, que est√° instalado en la lavadora, y un controlador, que recibe se√±ales del monitor y controla una v√°lvula motorizada.  La comunicaci√≥n entre el monitor y el controlador se realiza a trav√©s de un canal de radio unidireccional. <br><br>  Parece que esto es suficiente para la tarea t√©cnica.  ¬°Empecemos! <br><br><h2>  Selecci√≥n de MCU </h2><br>  Como todo el sistema consta de dos dispositivos, deber√≠a haber dos microcontroladores.  Repas√© las tripas y encontr√© dos Atmega8: uno en el paquete DIP y otro en TQFP.  El que est√° en DIP - fue al monitor y TQFP - al controlador.  M√°s tarde result√≥ que el firmware del controlador cubierto ya no cabe en el Atmega8 de 8 KB, por lo que tuve que actualizar a Atmega328, un an√°logo completo, pero ahora hay cuatro veces m√°s memoria para el programa. <br>  Por cierto, uno de mis motivos para realizar tales proyectos es la eliminaci√≥n de la basura electr√≥nica, que he acumulado durante muchos a√±os.  Es cierto que al final del proyecto, la basura no se vuelve m√°s peque√±a.  ¬°Se vuelve a√∫n m√°s grande! <br><br><h2>  Primera parte  Monitor </h2><br><h3>  Interacci√≥n con una lavadora. </h3><br>  El primer problema: ¬øc√≥mo determinar qu√© est√° haciendo la lavadora ahora?  Al comienzo del proyecto, esta parte de la tarea me parec√≠a muy simple.  Todo lo que ten√≠a que hacer era determinar los momentos del comienzo y el final del lavado.  En el panel frontal de la m√°quina hay un LED que se ilumina y se apaga justo cuando es necesario.  Esperaba soldar un GPIO con el pie del microcontrolador, por lo que durante la depuraci√≥n, simplemente emul√© los eventos necesarios en el monitor con el bot√≥n.  Presion√© el bot√≥n: el LED se encendi√≥, comenz√≥ el lavado.  D√©jalo ir: lo contrario es cierto.  Sin embargo, despu√©s de analizar la lavadora, result√≥ que este LED es parte de la pantalla din√°mica y, por desgracia, no es tan f√°cil determinar si est√° encendido o apagado. <br><br>  Al girar el panel de control en mis manos (un par de d√≠as), descubr√≠ que estaba implementado en un controlador PIC.  Adem√°s, est√° conectado a la placa principal con patas que responden al hardware I2C.  S√≠, pens√©, puedes oler el bus I2C y as√≠ determinar qu√© hacer con la lavadora ahora.  Encontr√© el c√≥digo sniffer I2C para Atmega en Internet.  Por supuesto, tuve que tocar algo. <br><br>  Francamente: no pude distinguir el protocolo por completo (y no lo prob√© demasiado), pero result√≥ determinar los patrones del inicio y el final del lavado (adem√°s de encender y apagar la alimentaci√≥n) con bastante precisi√≥n.  Me tom√≥ alrededor de una semana. <br><br>  Modelo: <b>Candy GC4 1072 D.</b>  La computadora env√≠a peri√≥dicamente una serie de secuencias de cinco bytes a la unidad de visualizaci√≥n.  Las primeras cuatro secuencias est√°n en el formato: <br><br> <code>12 A7 00 ‚Äì NN ‚Äì X0 X1 X2 X3 X4 X5 X6 X7 ‚Äì CS</code> <br>  donde: 12 A7 00 - encabezado, NN - n√∫mero de secuencia, X [0..7] - 8 bytes de datos, CS - suma de verificaci√≥n.  La quinta secuencia es una basura de tama√±o variable, cuya esencia para m√≠ sigue siendo un misterio. <br><br>  Logr√© resolver los siguientes patrones: <br><br>  <b>Encendido</b> <br><br> <code>12 A7 00 ‚Äì 01 ‚Äì X0 X1 X2 X3 X4 X5 X6 X7 ‚Äì CS <br> 12 A7 00 ‚Äì 02 ‚Äì X0 X1 X2 X3 X4 X5 X6 X7 ‚Äì CS</code> <br>  donde X [0..7] al menos uno no es igual a 0 <br><br>  <b>START</b> <br><br> <code>12 A7 00 ‚Äì 03 ‚Äì X0 X1 X2 X3 01 01 01 01 ‚Äì CS</code> <br>  donde X [0..3] es cualquier n√∫mero <br><br>  <b>Parar</b> <br><br> <code>12 A7 00 ‚Äì 03 ‚Äì X0 X1 X2 X3 00 00 00 00 ‚Äì CS</code> <br>  donde X [0..3] es cualquier n√∫mero <br><br>  Se puede ver que estas no son secuencias estrictas, es decir, plantillas, por lo que tuve que jugar con el analizador. <br><br>  La l√≥gica del trabajo es aproximadamente la siguiente: si obtenemos la secuencia de ENCENDIDO, pero no hay INICIO, entonces comenzamos a transmitir paquetes con el estado 0. Si aparece la secuencia de INICIO, cambie el estado a 1. En otros casos, no hay casco. <br><br>  Hablaremos sobre los paquetes y el estado que sigue. <br><br>  Es divertido, pero cuando espi√© los paquetes I2C, no tuve la oportunidad de conectarme a la computadora sniffer.  Utilic√© para este Raspberry Pi c powerbank'om, que ten√≠a una caja de aluminio.  Entonces, tan pronto como este edificio entr√≥ en contacto con la carcasa de la lavadora, se sac√≥ un RCD en el escudo, las luces se apagaron en el apartamento y comenc√© a buscar una linterna con el matyuki.  :) Por qu√© sucedi√≥ esa basura, sigue siendo un misterio para m√≠. <br><br><h3>  Canal de radio </h3><br>  Inicialmente, no quer√≠a que los cables adicionales vinieran de la lavadora.  Es decir, se supon√≠a que la conexi√≥n era inal√°mbrica.  A partir de aqu√≠, hab√≠a tres posibles soluciones al problema: WiFi, Bluetooth y el m√≥dulo RF para Arduino.  Me decid√≠ por este √∫ltimo seleccionando el m√≥dulo FS1000A. <br><br>  Por supuesto, en Habr√© habr√° muchas personas que me reprochen esta elecci√≥n.  Insinuar√°n que en Ali-Express es posible comprar un m√≥dulo ESP con WiFi completo a bajo costo.  Pero pens√© que esto complicar√≠a mucho el proyecto y decid√≠ actuar de manera m√°s simple. <br><br>  Como sabe, el m√≥dulo RF FS1000A no se puede conectar directamente a la interfaz RS232: una secuencia larga de ceros o unos interrumpe la sincronizaci√≥n del receptor.  La biblioteca VirtualWire se cre√≥ para resolver este problema.  Sin embargo, esta biblioteca est√° escrita para Arduino, y yo programo exclusivamente de forma nativa bajo Atmega en C. Afortunadamente, el c√≥digo para Arduino es muy similar al C puro, y con modificaciones menores, la biblioteca fue portada con √©xito. <br><br>  Hubo algunas dificultades: al principio, los paquetes no quer√≠an llegar al receptor.  Culp√© a mis manos torcidas por todo, pero al conectar directamente los terminales del receptor y los controladores del transmisor, estaba convencido de que todo funciona en la parte del software.  El transmisor ordenado desde China result√≥ ser defectuoso.  Tuve que comprar otro kit.  Luego arregl√© el viejo y ahora tengo dos juegos de transmisor-receptor.  ¬øRecuerdas lo que escrib√≠ sobre reducir la basura? <br><br>  Los datos se han enviado, pero ¬øqu√© contienen exactamente estos datos?  Esto es lo que es el paquete transmitido: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> dst; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> src; <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> WMP_MSG_STATUS_ALIVE _BV(0) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> WMP_MSG_STATUS_VALVE _BV(1) uint8_t status; } wmp_msg_t; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> WMP_ADDR_MONITOR 0x4d504d57 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> WMP_ADDR_CONTROLLER 0x43504d57</span></span></code> </pre><br>  Las dos primeras palabras dobles son las direcciones f√≠sicas del receptor y el transmisor.  En mi caso, son estrictamente fijos: 0x43504d57 - receptor (controlador) y 0x4d504d57 - transmisor (monitor).  De hecho, los primeros 8 bytes son esta firma de paquete.  La informaci√≥n significativa se encuentra solo en el √∫ltimo byte: el indicador de bit.  El bit cero establecido de este indicador significa que el monitor est√° encendido y funcionando: siempre debe ser 1. El primer bit es el estado de la v√°lvula: 0 - la v√°lvula debe estar cerrada, 1 - abierta.  Eso es todo. <br><br>  Se supone que el monitor debe enviar peri√≥dicamente paquetes al controlador, confirmando su funcionamiento y la capacidad de servicio del canal de datos.  En caso de p√©rdida del canal de comunicaci√≥n, el controlador debe cerrar la v√°lvula de emergencia. <br><br>  La biblioteca VirtualWire monitorea la integridad de los datos transmitidos usando CRC32.  No tuve que hacer esfuerzos adicionales en esta direcci√≥n.  Belleza! <br><br><h3>  Construcci√≥n </h3><br>  Estructuralmente, el monitor est√° hecho en forma de una peque√±a placa, que est√° pegada al pegamento caliente "Uncle Liao snot" dentro del panel frontal de la lavadora. Mediante conectores, la placa se conecta al espacio entre la computadora y la pantalla.  La m√°quina en s√≠ no ha sufrido ninguna modificaci√≥n: en cualquier momento puede volver a su estado original. <br><br><h2>  Segunda parte  Controlador </h2><br><h3>  Canal de radio </h3><br>  Aqu√≠ todo es simple: el receptor del kit FS1000A y la parte del receptor de la biblioteca VirtualWire est√°n instalados.  El paquete se analiza y su estado se transmite a la salida.  El receptor VirtualWire ocupa TIMER1 en el microcontrolador. <br><br><h3>  Control de la v√°lvula </h3><br>  En la tienda en l√≠nea china, se seleccion√≥ una v√°lvula motorizada de 3/4 ‚Äùcon una fuente de alimentaci√≥n de 5 voltios y con sensores terminales conectados al cable.  Esta v√°lvula se instal√≥ entre la v√°lvula de bola y la manguera de la lavadora.  Para controlar la v√°lvula, en el mismo sitio chino, se orden√≥ un controlador de motor paso a paso de baja potencia en los controladores L9110.  Lo conect√© al controlador de la siguiente manera: <br><br><img src="https://habrastorage.org/webt/0a/dr/h9/0adrh9lsveasvy1hpqc6ogngsac.png"><br><br>  Desde el punto de vista del software, no hubo dificultades particulares: mediante las entradas VALVE_CLOSE y VALVE_OPEN determinamos el estado actual de la v√°lvula.  Si es necesario cambiar este estado, encienda el motor para abrirlo o cerrarlo y espere hasta que se establezca un 0 l√≥gico en la entrada correspondiente. Sin embargo, dado que abrir o cerrar toma alg√∫n tiempo, me gustar√≠a no perder el control sobre todo en ese momento dispositivo  Por lo tanto, en el temporizador Atmega, se cre√≥ un planificador primitivo y el control de la v√°lvula se transfiri√≥ a una tarea especial.  Al mismo tiempo, el m√≥dulo de software WatchDog especial mide el tiempo que tarda la v√°lvula en cambiar, y si es demasiado larga, se genera una se√±al sobre su mal funcionamiento.  M√°s tarde, se colgaron otras cosas interesantes en este programador, como el parpadeo de los LED y el sondeo del sensor de fugas.  Pero m√°s sobre eso m√°s tarde. <br><br>  Adem√°s, un LED de estado de tres colores y un interruptor de palanca de control manual de tres posiciones pertenecen al circuito de control de la v√°lvula.  En la posici√≥n central del interruptor de palanca, el control autom√°tico se activa de acuerdo con las se√±ales de la lavadora y otros sensores.  En caso de mal funcionamiento de la v√°lvula, los colores rojo y verde se iluminan alternativamente. <br><br><h3>  LED e indicaci√≥n de sonido </h3><br>  Con los LED, todo es simple: se aferran directamente a los puertos de E / S a trav√©s de resistencias limitantes.  Las corrientes all√≠ no son grandes, y los puertos en Atmega son bastante poderosos. <br><br>  Pero el sonido tuvo que retocar.  En primer lugar, no encontr√© un emisor piezoel√©ctrico grande y ruidoso.  Parece que tales personas existen en la naturaleza, pero tan pronto como atend√≠ la compra, result√≥ que la elecci√≥n ni siquiera fue excelente.  Lo mejor que consegu√≠ sonar muy tranquilo.  Tuve que navegar por Internet para obtener recetas. <br><br>  Me instal√© en un circuito con un transistor y un autotransformador, que oscila el voltaje de sonido de 5V a 50V.  Y luego result√≥ relativamente ruidoso.  No en todas las frecuencias, por supuesto, pero m√°s cerca de la resonancia. <br><br>  Fue solo durante la generaci√≥n del sonido que el brillo de los LED (jamb con alimentaci√≥n) disminuy√≥ ligeramente, pero el microcontrolador no se congel√≥ y el programa de control no se interrumpi√≥.  Pens√© que esta es una caracter√≠stica del dise√±o de depuraci√≥n y que todo funcionar√° bien en el tablero final.  Me equivoqu√©, no mejor√≥.  Peor, sin embargo, tambi√©n. <br><br><img src="https://habrastorage.org/webt/w8/ca/pb/w8capblzyb0abagztoygcputhsi.png"><br><br>  Otro problema fue que me qued√© sin temporizadores y en el fondo no pude generar sonido.  Tuve que preguntar el per√≠odo de chirrido con sue√±os.  Entonces, durante la generaci√≥n de sonido, Atmega no puede hacer nada m√°s que interrupciones, tambi√©n, tuvo que ser desactivado, de lo contrario el tono no es claro.  Pero esto result√≥ no ser muy aterrador ya que la salida de sonido no se cruzaba con otras tareas cr√≠ticas, como controlar una v√°lvula o recibir datos por radio. <br><br>  Adem√°s, seleccion√© las constantes de sue√±o para que correspondieran a las notas y se me ocurrieron varias combinaciones m√°s o menos armoniosas: "la v√°lvula est√° abierta", "la v√°lvula est√° cerrada", "el lavado ha terminado" y "fuga".  Te contar√© por separado sobre la se√±al de "lavado terminado" m√°s adelante. <br><br><h3>  Detector de fugas </h3><br>  El detector de fugas se plane√≥ originalmente para hacerse en el ADC incorporado del microcontrolador.  Los experimentos han demostrado que esta es una soluci√≥n que funciona perfectamente.  Sin embargo, me di cuenta de que a veces se agrega un condensador al sensor con contactos para que est√© conectado y si no hay ruptura en el cable en alguna parte.  Puede verificar la presencia de un capacitor (y medir su capacitancia) usando: cadena RC, comparador y reloj.  Como comparador, se usa una entrada GPIO convencional (tambi√©n es una entrada l√≥gica y cambia de 0 a 1 a un voltaje determinado), y hay suficientes horas en el microcontrolador. <br><br><img src="https://habrastorage.org/webt/sh/um/rn/shumrnvjljzhpc_m7fdyye9ugwi.png"><br><br>  Se supon√≠a que de vez en cuando verificar√≠a la presencia de un condensador en la l√≠nea y luego usar√≠a el ADC para determinar si los contactos del sensor est√°n en el agua.  Result√≥ que es suficiente medir solo la capacitancia del capacitor: si lo baja al agua, entonces el tiempo de carga aumentar√° y la descarga disminuir√°.  Adem√°s, el tiempo cambiar√° en una cantidad suficiente para que pueda detectarse con confianza. <br><br>  Para mi sistema, eleg√≠ medir el tiempo de carga: si el condensador no est√° conectado, entonces es cero, si est√° seco es relativamente peque√±o y si est√° en agua, entonces el tiempo de carga es mucho m√°s largo.  Los valores exactos se determinaron usando un platillo con agua y una serie de experimentos. <br><br>  El detector de fugas tiene su propio LED indicador rojo.  Si no se detecta el sensor, se ilumina y el comando para cerrar la v√°lvula se transmite al aire.  Uno solo tiene que restablecer la comunicaci√≥n con el sensor, el LED se apaga y la v√°lvula se puede abrir (si solo la m√°quina est√° en estado de lavado, por supuesto).  Otra cosa es si el sensor detecta agua.  En este caso, el indicador comienza a parpadear, se escucha un sonido intermitente desagradable y la v√°lvula se cierra a la fuerza.  Pero lo m√°s importante, el controlador nunca abandona este estado.  Una fuga se considera un accidente grave y el suministro de agua no se reanudar√° hasta que reinicie el dispositivo con fuerza. <br><br><h3>  Nutrici√≥n </h3><br>  La comida es la parte m√°s incomprensible para m√≠ en este proyecto.  Si estoy un poco versado en circuitos digitales, entonces en anal√≥gico, por decirlo suavemente, en realidad no.  Pero, gracias a los chinos: puedo comprar m√≥dulos listos para usar para convertidores DC-DC con controladores de carga de bater√≠a, y en base a ellos puedo pensar en algo viable. <br><br>  Desde el principio, se plane√≥ hacer que el dispositivo se autoalimentara, de modo que en caso de un corte de energ√≠a, aseg√∫rese de que se cierre el agua.  Adem√°s, ten√≠a una fuente de alimentaci√≥n de 9V que necesitaba ser conectada en alguna parte.  En total, el resultado introductorio fue el siguiente: <br><br><ul><li>  9V proviene de la red; </li><li>  3.4 ~ 3.7V proviene de la bater√≠a; </li><li>  para cargar la bater√≠a necesitas 5V; </li><li>  Se necesitan 5V para alimentar la l√≥gica y los circuitos de alimentaci√≥n; </li><li>  si falla la tensi√≥n de red, cambie la alimentaci√≥n de la bater√≠a; </li><li>  es necesario transmitir la se√±al de carga de la bater√≠a, el voltaje de la bater√≠a y la se√±al de funcionamiento de la red al controlador </li></ul><br>  El diagrama de bloques result√≥ como en la figura. <br><br><img src="https://habrastorage.org/webt/7g/ma/5l/7gma5lv_yub5aunjhing_cbnmjw.jpeg"><br><br>  Se utilizan dos diodos Schottky como elemento de conmutaci√≥n.  El controlador de carga tiene dos LED: CHARGE y STANDBY.  La se√±al del primero se conect√≥ al puerto GPIO del controlador para que el monitor pudiera saber que la bater√≠a se estaba cargando.  Adem√°s, se aplica una se√±al del primer convertidor CC-CC al puerto del microcontrolador para determinar si el dispositivo funciona con una red el√©ctrica o una bater√≠a.  Para controlar el nivel de carga, el voltaje de la bater√≠a se suministra al ADC del controlador.  Si el voltaje es demasiado bajo, el monitor cierra la v√°lvula y pasa al modo de espera: no responde a ning√∫n comando hasta que aparece el voltaje de la red. <br><br>  Desafortunadamente, hubo algunas jambas aqu√≠: por alguna raz√≥n, el motor de la v√°lvula toma parte de la energ√≠a de la bater√≠a.  Aparentemente, comet√≠ un error con la potencia del convertidor CC / CC de red o con el grosor de las pistas de potencia en la placa.  Como resultado: despu√©s de abrir o cerrar la v√°lvula, la bater√≠a comienza a cargarse. <br><br>  Para controlar el estado de la alimentaci√≥n hay un LED especial de dos colores.  Si es verde, el dispositivo est√° funcionando en la red.  Si es rojo, entonces de la bater√≠a.  Si es verde, pero el rojo parpadea, la bater√≠a se est√° cargando. <br><br><h3>  L√≥gica de trabajo </h3><br>  Bueno, tenemos todo el hardware y su soporte de software, ahora necesitamos de alguna manera hacer que todo esto interact√∫e entre s√≠.  Inicialmente, vi la implementaci√≥n de la l√≥gica del trabajo en forma de un bucle grande (lo que se llama el bucle principal) con un mont√≥n de ifs dentro. <br><br>  En el proceso, era necesario un planificador de tareas para acciones tan simples como: parpadear un LED, sondear un sensor de fugas, rastrear el tiempo de conmutaci√≥n de la v√°lvula y el control de potencia, que publiqu√© en TIMER0.  El planificador en s√≠ no inici√≥ las funciones asociadas con la tarea, sino que solo configur√≥ el bit de sincronizaci√≥n en uno en el descriptor asociado con la tarea.  La tarea todav√≠a se llevaba a cabo en el ciclo principal, logramos deshacernos de los intervalos de tiempo de seguimiento, lo que lo hizo muy simple. <br><br>  Desde el zool√≥gico, que verifica el estado de varios subsistemas del controlador y toma una decisi√≥n: era necesario negarse a abrir o cerrar la v√°lvula.  Es muy dif√≠cil depurar esto y es muy f√°cil confundirse.  En cambio, me gust√≥ la idea del antiguo libro de D. Hazerman: "C√≥mo hacer un robot usted mismo".  El libro sugiere que cada m√≥dulo genere sus propias se√±ales de control: hacia adelante, hacia atr√°s, rotaci√≥n, etc. Luego, solo se selecciona una de estas se√±ales que provenga de un bloque con una prioridad m√°s alta.  Hice casi lo mismo. <br><br>  Prioric√© los bloques de la siguiente manera: <br><br><ol><li>  Bloque de fugas </li><li>  Unidad de control de bater√≠a </li><li>  Unidad de control de v√°lvula manual </li><li>  Unidad de control de la v√°lvula de radio control </li><li>  Temporizador de v√°lvula Bloque WatchDog </li></ol><br>  Cada bloque genera tres comandos: INDEFINIDO, ABIERTO y CERRADO. <br><br>  El bloque de fugas tiene la m√°xima prioridad, pero no tiene el comando ABRIR, pero su comando CERRAR definitivamente cierra la v√°lvula, sin importar lo que digan otros bloques.  La unidad de control manual puede interrumpir cualquier se√±al de la unidad de canal de radio, lo que le permite controlar la v√°lvula independientemente de lo que nos indique la lavadora.  Bueno y as√≠ sucesivamente.  Es decir, ha aparecido una estructura jer√°rquica l√≥gica que es f√°cil de entender y depurar. <br><br>  Ahora, volvamos a la se√±al: "el lavado ha terminado".  Por desgracia, mi modelo de lavadora no tiene la oportunidad de informar sobre el final de su trabajo con la ayuda del sonido: los ingenieros de Candy no brindaron esa oportunidad.  Por otro lado, tengo un dispositivo adicional que tiene un emisor piezoel√©ctrico y en todo momento sabe lo que est√° haciendo la lavadora.  ¬øPor qu√© no hacer que informe el final del lavado?  Bueno, hagamos que el controlador suene fuerte y desagradable (a la frecuencia de resonancia) cuando la v√°lvula cierre la se√±al.  Agregue otro intervalo de protecci√≥n de cinco minutos para no escuchar este chirrido cada vez que enciende y apaga la m√°quina.  La v√°lvula est√° abierta durante cinco minutos: el lavado definitivamente ha comenzado. <br><br><h2>  Resultados </h2><br>  El desarrollo me llev√≥ cerca de un a√±o de trabajo sin prisas (muy sin prisas).  El dispositivo ha estado funcionando durante dos a√±os.  En funcionamiento, result√≥ ser bastante satisfactorio.  Pero no sin fallas.  Vamos a enumerarlos honestamente: <br><br><ol><li>  Arruin√© algo con la energ√≠a: el motor de la v√°lvula toma parte de la energ√≠a de la bater√≠a. </li><li>  El circuito de generaci√≥n de sonido dibuja la tensi√≥n de alimentaci√≥n.  Puede ver claramente c√≥mo los LED cambian el brillo cuando se reproduce el sonido. </li><li>  El canal de radio no es muy estable.  En primer lugar, la se√±al desaparece si una persona se encuentra cerca de la lavadora.  Y en segundo lugar, a veces la se√±al empeora por s√≠ sola.  En este caso, debe usar el interruptor de palanca manual, pero esto ocurre extremadamente raramente. </li><li>  La unidad de monitor en la lavadora colg√≥ un par de veces.  El bloque controlador no se colg√≥ ni una sola vez. </li><li>  El sonido del emisor piezoel√©ctrico fue muy ahogado dentro de la caja.  Perfor√© un agujero en el koprus: mejor√≥, pero en realidad no.  Tuve que soldar el emisor de la placa y pegarlo a la caja, directamente enfrente del agujero. </li></ol><br>  En general, considero que el desarrollo fue exitoso y muy √∫til.  Arranco la m√°quina por la ma√±ana y salgo tranquilamente al trabajo: s√© que en el momento correcto se cerrar√° el grifo del suministro de agua. <br><br>  El archivo con los archivos del proyecto se puede descargar <a href="">aqu√≠</a> . <br><br><h3>  Algunas fotos </h3><br><div class="spoiler">  <b class="spoiler_title">Vista superior con la cubierta superior retirada</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/pk/ac/1q/pkac1q7wwkmwbptyd814mobigx4.jpeg"><br></div></div><br><div class="spoiler"> <b class="spoiler_title"> ,   </b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/-z/3g/zq/-z3gzqv3s-dwhfuvlco9jkkqbcm.jpeg"><br></div></div><br><div class="spoiler"> <b class="spoiler_title">   </b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/kc/cv/sx/kccvsxlyr0qtrtirqf_c5hthamq.jpeg"><br></div></div><br><div class="spoiler"> <b class="spoiler_title">   </b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/bg/kh/yy/bgkhyyih1i083nb9omlxrqxo9be.jpeg"><br></div></div><br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/p5/qu/2y/p5qu2ygeapyr_ivwdguhkjmkcxs.jpeg"><br></div></div><br> <i>  <br> -  ¬´¬ª</i> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/472296/">https://habr.com/ru/post/472296/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../472280/index.html">La tarea de determinar la presencia de una palma en un esc√°ner de venas</a></li>
<li><a href="../472288/index.html">9 extensiones de navegador √∫tiles para desarrolladores (lista para 2020)</a></li>
<li><a href="../472290/index.html">Estructuras vs. Clases</a></li>
<li><a href="../472292/index.html">Bloqueo de contenido: el escenario mundial</a></li>
<li><a href="../472294/index.html">Crea juegos y videos en YouTube. Mi experimento de interacci√≥n y los ingresos de este</a></li>
<li><a href="../472298/index.html">El resumen de materiales frescos del mundo del front-end para la √∫ltima semana No. 385 (14-20 de octubre de 2019)</a></li>
<li><a href="../472300/index.html">Descenso de gradiente estoc√°stico (SGD) para la funci√≥n de p√©rdida logar√≠tmica (LogLoss) en un problema de clasificaci√≥n binaria</a></li>
<li><a href="../472304/index.html">NASA contrata ingenieros para desarrollar robot humanoide de pr√≥xima generaci√≥n</a></li>
<li><a href="../472306/index.html">PHP Digest No. 166 (7-21 de octubre de 2019)</a></li>
<li><a href="../472310/index.html">Identificaci√≥n del cliente en sitios sin contrase√±as y cookies: solicitud de est√°ndar</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>