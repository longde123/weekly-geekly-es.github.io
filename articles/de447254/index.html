<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üï¢ üöê üëèüèæ So verschieben Sie Parameter in Methoden ohne Parameter im sicheren Code üë≤üèº üëèüèø ü§¥üèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo Diesmal lachen wir weiter √ºber den normalen Methodenaufruf. Ich schlage vor, sich mit dem Methodenaufruf mit Parametern vertraut zu machen, ohne...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>So verschieben Sie Parameter in Methoden ohne Parameter im sicheren Code</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/447254/">  Hallo  Diesmal lachen wir weiter √ºber den normalen Methodenaufruf.  Ich schlage vor, sich mit dem Methodenaufruf mit Parametern vertraut zu machen, ohne Parameter zu √ºbergeben.  Wir werden auch versuchen, den Referenztyp in eine Zahl umzuwandeln - seine Adresse, ohne Zeiger und <i>unsicheren Code zu verwenden</i> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ua/80/z6/ua80z6gqkrpmrvr-y2-5k2u_h8a.jpeg" width="400"></div><a name="habracut"></a><br><h3>  Haftungsausschluss </h3><br>  Bevor Sie mit der Geschichte <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">fortfahren,</a> empfehle ich Ihnen dringend, den vorherigen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Beitrag √ºber StructLayout zu lesen</a> .  Hier werde ich einige Funktionen verwenden, die dort beschrieben wurden. <br><br>  Au√üerdem m√∂chte ich warnen, dass dieser Artikel kein Material enth√§lt, das in realen Projekten verwendet werden sollte. <br><br><h3>  Einige erste Informationen </h3><br>  Bevor wir mit dem √úben beginnen, erinnern wir uns daran, wie der C # -Code in Assembler-Code konvertiert wird. <br>  Lassen Sie uns ein einfaches Beispiel untersuchen. <br><br><pre><code class="plaintext hljs">public class Helper { public virtual void Foo(int param) { } } public class Program { public void Main() { Helper helper = new Helper(); var param = 5; helper.Foo(param); } }</code> </pre> <br>  Dieser Code enth√§lt nichts Schwieriges, aber die von JiT generierten Anweisungen enthalten mehrere wichtige Punkte.  Ich schlage vor, nur ein kleines Fragment des generierten Codes zu betrachten.  In meinen Beispielen werde ich Assembler-Code f√ºr 32-Bit-Maschinen verwenden. <br><br><pre> <code class="plaintext hljs">1: mov dword [ebp-0x8], 0x5 2: mov ecx, [ebp-0xc] 3: mov edx, [ebp-0x8] 4: mov eax, [ecx] 5: mov eax, [eax+0x28] 6: call dword [eax+0x10]</code> </pre><br>  In diesem kleinen Beispiel k√∂nnen Sie die Fastcall-Aufrufkonvention beobachten, bei der Register zum √úbergeben von Parametern verwendet werden (die ersten beiden Parameter von links nach rechts in den Registern ecx und edx) und die verbleibenden Parameter von rechts nach links durch den Stapel geleitet werden.  Der erste (implizite) Parameter ist die Adresse der Instanz der Klasse, f√ºr die die Methode aufgerufen wird (f√ºr nicht statische Methoden). <br><br>  In unserem Fall ist der erste Parameter die Adresse der Instanz, der zweite unser <b>int-</b> Wert. <br><br>  In der <b>ersten</b> Zeile sehen wir also die lokale Variable 5, hier gibt es nichts Interessantes. <br>  In der <b>zweiten</b> Zeile kopieren wir die Adresse der Helper-Instanz in das ecx-Register.  Dies ist die Adresse des Zeigers auf die Methodentabelle. <br>  In der <b>dritten</b> Zeile wird die lokale Variable 5 in das edx-Register kopiert <br>  In der <b>vierten</b> Zeile sehen wir das Kopieren der Methodentabellenadresse in das eax-Register <br>  <b>Die f√ºnfte</b> Zeile enth√§lt das Laden des Werts aus dem Speicher an die Adresse, die 40 Byte gr√∂√üer ist als die Adresse der Methodentabelle: der Beginn der Methodenadressen in der Methodentabelle.  (Die Methodentabelle enth√§lt verschiedene Informationen, die zuvor gespeichert wurden. Zum Beispiel die Adresse der Basisklassen-Methodentabelle, die EEClass-Adresse, verschiedene Flags, einschlie√ülich des Garbage Collector-Flags usw.)  Somit wird die Adresse der ersten Methode aus der Methodentabelle nun im eax-Register gespeichert. <br>  <i>Hinweis: In .NET Core wurde das Layout der Methodentabelle ge√§ndert.</i>  <i>Jetzt gibt es ein Feld (mit 32/64 Bit Offset f√ºr 32- bzw. 64-Bit-Systeme), das die Adresse des Beginns der Methodenliste enth√§lt.</i> <br>  In der <b>sechsten</b> Zeile wird die Methode von Anfang an mit Offset 16 aufgerufen, dh mit der f√ºnften in der Methodentabelle.  Warum ist unsere einzige Methode die f√ºnfte?  Ich erinnere Sie daran, dass das <b>Objekt</b> 4 virtuelle Methoden hat ( <i>ToString (), Equals (), GetHashCode () und Finalize ()</i> ), die alle Klassen haben werden. <br><br><h3>  Gehe zu √úbung; </h3><br>  Praktisch: <br>  Es ist Zeit, eine kleine Demonstration zu starten.  Ich schlage einen so kleinen Rohling vor (sehr √§hnlich dem Rohling aus dem vorherigen Artikel). <br><br><pre> <code class="plaintext hljs"> [StructLayout(LayoutKind.Explicit)] public class CustomStructWithLayout { [FieldOffset(0)] public Test1 Test1; [FieldOffset(0)] public Test2 Test2; } public class Test1 { public virtual int Useless(int param) { Console.WriteLine(param); return param; } } public class Test2 { public virtual int Useless() { return 888; } } public class Stub { public void Foo(int stub) { } }</code> </pre><br>  Und lassen Sie uns das Zeug so verwenden: <br><br><pre> <code class="plaintext hljs"> class Program { static void Main(string[] args) { Test2 fake = new CustomStructWithLayout { Test2 = new Test2(), Test1 = new Test1() }.Test2; Stub bar = new Stub(); int param = 55555; bar.Foo(param); fake.Useless(); Console.Read(); } }</code> </pre><br>  Wie Sie vielleicht erraten haben, wird aus den Erfahrungen des vorherigen Artikels die <i>nutzlose (int j)</i> Methode vom Typ <b>Test1</b> aufgerufen. <br><br>  Aber was wird angezeigt?  Ich glaube, der aufmerksame Leser hat diese Frage bereits beantwortet.  "55555" wird auf der Konsole angezeigt. <br><br>  Aber schauen wir uns noch die generierten Codefragmente an. <br><br><pre> <code class="plaintext hljs"> mov ecx, [ebp-0x20] mov edx, [ebp-0x10] cmp [ecx], ecx call Stub.Foo(Int32) mov ecx, [ebp-0x1c] mov eax, [ecx] mov eax, [eax+0x28] call dword [eax+0x10]</code> </pre><br>  Ich denke, Sie erkennen das <i>Aufrufmuster</i> der virtuellen Methode, es beginnt nach dem <i>Aufruf von Stub.Foo (Int32)</i> .  Wie wir sehen k√∂nnen, wird ecx erwartungsgem√§√ü mit der Adresse der Instanz gef√ºllt, auf der die Methode aufgerufen wird.  Da der Compiler jedoch der Meinung ist, dass wir eine Methode vom Typ Test2 aufrufen, die keine Parameter enth√§lt, wird nichts in edx geschrieben.  Wir haben jedoch vorher einen anderen Methodenaufruf.  Und dort haben wir edx verwendet, um Parameter zu √ºbergeben.  Und nat√ºrlich haben wir keine Anweisungen, diese klare Edx.  Wie Sie in der Konsolenausgabe sehen k√∂nnen, wurde der vorherige edx-Wert verwendet. <br><br>  Es gibt noch eine andere interessante Nuance.  Ich habe speziell den aussagekr√§ftigen Typ verwendet.  Ich schlage vor, den Parametertyp der Foo-Methode des Stub-Typs durch einen beliebigen Referenztyp zu ersetzen, z. B. eine Zeichenfolge.  Der Parametertyp der Methode <i>Useless ()</i> √§ndert sich jedoch nicht.  Unten sehen Sie das Ergebnis auf meinem Computer mit einigen klarstellenden Informationen: WinDBG und Rechner :) <br><br> <a href=""><img src="https://habrastorage.org/webt/lj/pt/5i/ljpt5isxjzejz0_kxhu0yyovyhw.jpeg"></a> <br>  <i>Klickbares Bild</i> <br><br>  Das Ausgabefenster zeigt die Adresse des Referenztyps in Dezimalschreibweise an. <br><br><h3>  Insgesamt </h3><br>  Wir haben das Wissen √ºber das Aufrufen von Methoden mithilfe der Fastcall-Konvention aktualisiert und sofort das wunderbare edx-Register verwendet, um einen Parameter in zwei Methoden gleichzeitig zu √ºbergeben.  Wir haben auch auf alle Typen gespuckt und mit dem Wissen, dass alles nur Bytes sind, leicht die Adresse des Objekts erhalten, ohne Zeiger und unsicheren Code zu verwenden.  Au√üerdem habe ich vor, die empfangene Adresse f√ºr noch weniger anwendbare Zwecke zu verwenden! <br><br>  Danke f√ºr die Aufmerksamkeit! <br><br>  PS C # -Code finden Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de447254/">https://habr.com/ru/post/de447254/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de447244/index.html">C301 und miniOTP-3, neue programmierbare Token von Token2</a></li>
<li><a href="../de447246/index.html">Prototyp in 1 Tag statt 2-3 Wochen: 3D-Druck im Okeanpribor-Konzern</a></li>
<li><a href="../de447248/index.html">Was wird in der Stratosph√§re erforscht?</a></li>
<li><a href="../de447250/index.html">Lernen, √ºber RabbitMQ zwischen Microservices auf Node.js zu kommunizieren</a></li>
<li><a href="../de447252/index.html">Hilf Duke, einen Ausweg zu finden</a></li>
<li><a href="../de447256/index.html">Das Wunder der Materialisierungsmagie: Nissan verbringt Sekunden statt Monate der Arbeit</a></li>
<li><a href="../de447258/index.html">Sicherheitswoche 15: Angriff auf Router mit DNS-Spoofing</a></li>
<li><a href="../de447260/index.html">Live-Freigabe in Visual Studio 2019</a></li>
<li><a href="../de447262/index.html">Beschleunigen Sie die Website mit JivoSite. Zur√ºckgestellter Online-Berater-Download</a></li>
<li><a href="../de447264/index.html">Service Grid entz√ºnden - Neustart</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>