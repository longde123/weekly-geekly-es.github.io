<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üí∏ üë®üèº‚Äçüîß ‚ûø Sketch + Node.js: g√©n√©rez des ic√¥nes pour de nombreuses plateformes et marques. 2e partie üë®üèΩ‚Äçüé® üì∞ üèáüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Il s'agit de la deuxi√®me partie de l'article sur la cr√©ation d'un outil capable d'exporter toutes les ic√¥nes plac√©es dans un fichier Sketch: dans diff...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Sketch + Node.js: g√©n√©rez des ic√¥nes pour de nombreuses plateformes et marques. 2e partie</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/badoo/blog/442886/"><img src="https://habrastorage.org/webt/na/kj/v5/nakjv5srowi99bsjteoqabwtoz8.png"><br><br>  Il s'agit de la deuxi√®me partie de l'article sur la cr√©ation d'un outil capable d'exporter toutes les ic√¥nes plac√©es dans un fichier Sketch: dans diff√©rents formats, pour diff√©rentes plateformes, avec la possibilit√© de tester A / B de chaque ic√¥ne. <br><br>  Vous pouvez lire la premi√®re partie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">du lien</a> . <br><br><img src="https://habrastorage.org/webt/s6/lt/2d/s6lt2dttycpvlqbolmyeyacaeas.png"><br><br>  La derni√®re fois, nous avons pr√©par√© des fichiers Sketch contenant toutes les ic√¥nes dans les bons styles et avec les noms corrects.  C'est au tour d'√©crire du code. <br><br>  Il suffit de dire que nous avons fait des essais et des erreurs.  Apr√®s que notre chef d'√©quipe <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Nihil Verma</a> , qui a jet√© les bases du script, ait d√©velopp√© le code source cl√©, j'ai commenc√© un processus qui a n√©cessit√© au moins trois phases de refactoring et de nombreuses modifications.  Pour cette raison, je n'entrerai pas dans les d√©tails de la cr√©ation du script et ne me concentrerai pas sur la fa√ßon dont il fonctionne aujourd'hui, dans sa forme finale. <br><a name="habracut"></a><br><h2>  Cr√©er un script </h2><br>  Le script de construction √©crit sur Node.js est assez simple dans son travail: en important des d√©pendances, en d√©clarant une liste de fichiers Sketch √† traiter (c'est une liste de marques, chacune ayant une liste de fichiers associ√©s) et en s'assurant que Sketch est install√© sur le client , le script traite les marques √† tour de r√¥le, effectuant une s√©rie d'actions avec chacune d'elles. <br><br><ol><li>  Prend des jetons de conception appropri√©s pour les marques (nous avons besoin de valeurs de couleur). <br></li><li>  Clone les fichiers Sketch associ√©s √† la marque, les d√©compresse pour extraire les fichiers JSON internes et traite certaines de leurs valeurs internes (plus d'informations plus loin). <br></li><li>  Lit les m√©tadonn√©es n√©cessaires √† partir de ces fichiers JSON ( <i>document.json</i> , <i>meta.json</i> et <i>pages / pageUniqueID.json</i> ).  Nous sommes int√©ress√©s par les listes de styles courants et de ressources / ic√¥nes contenues dans les fichiers. <br></li><li>  Apr√®s quelques manipulations suppl√©mentaires avec les fichiers JSON, il recr√©e l'archive et, √† l'aide de fichiers Sketch (clon√©s et mis √† jour), exporte et cr√©e les fichiers de sortie finaux pour trois plates-formes (iOS, Android, Web mobile). <br></li></ol><br>  Les parties pertinentes du script de construction peuvent √™tre trouv√©es ici: <br><br><pre><code class="plaintext hljs">// ... modules imports here const SKETCH_FILES = { badoo: ['icons_common'], blendr: ['icons_common', 'icons_blendr'], fiesta: ['icons_common', 'icons_fiesta'], hotornot: ['icons_common', 'icons_hotornot'], }; const SKETCH_FOLDER_PATH = path.resolve(__dirname, '../src/'); const SKETCH_TEMP_PATH = path.resolve(SKETCH_FOLDER_PATH, 'tmp'); const DESTINATION_PATH = path.resolve(__dirname, '../dist'); console.log('Build started...'); if (sketchtool.check()) { console.log(`Processing Sketch file via ${sketchtool.version()}`); build(); } else { console.info('You need Sketch installed to run this script'); process.exit(1); } // ---------------------------------------- function build() { // be sure to start with a blank slate del.sync([SKETCH_TEMP_PATH, DESTINATION_PATH]); // process all the brands declared in the list of Sketch files Object.keys(SKETCH_FILES).forEach(async (brand) =&gt; {   // get the design tokens for the brand   const brandTokens = getDesignTokens(brand);    // prepare the Sketch files (unzipped) and get a list of them   const sketchUnzipFolders = await prepareSketchFiles({     brand,     sketchFileNames: SKETCH_FILES[brand],     sketchFolder: SKETCH_FOLDER_PATH,     sketchTempFolder: SKETCH_TEMP_PATH   });   // get the Sketch metadata   const sketchMetadata = getSketchMetadata(sketchUnzipFolders);   const sketchDataSharedStyles = sketchMetadata.sharedStyles;   const sketchDataAssets = sketchMetadata.assetsMetadata;   generateAssetsPDF({     platform: 'ios',     brand,     brandTokens,     sketchDataSharedStyles,     sketchDataAssets   });   generateAssetsSVGDynamicMobileWeb({     platform: 'mw',     brand,     brandTokens,     sketchDataSharedStyles,     sketchDataAssets   });   generateAssetsVectorDrawableDynamicAndroid({     platform: 'android',     brand,     brandTokens,     sketchDataSharedStyles,     sketchDataAssets   }); }); }</code> </pre> <br>  En fait, le code du pipeline est beaucoup plus compliqu√©.  La raison de cette complexit√© r√©side dans les fonctions <code>prepareSketchFiles</code> , <code>getSketchMetadata</code> et <code>generateAssets[format][platform]</code> .  Ci-dessous, je vais essayer de les d√©crire plus en d√©tail. <br><br><h2>  Pr√©paration des fichiers d'esquisse </h2><br>  La premi√®re √©tape du processus d'assemblage est la pr√©paration des fichiers Sketch, qui seront ensuite utilis√©s pour exporter des ressources pour diff√©rentes plates-formes. <br><br>  Les fichiers associ√©s √† une marque particuli√®re (par exemple, dans le cas de Blendr, il s'agit des <i>fichiers</i> <i>icons_common.sketch</i> et <i>icons_blendr.sketch</i> ) sont clon√©s dans un dossier temporaire (plus pr√©cis√©ment, dans un sous-dossier nomm√© d'apr√®s la marque en cours de traitement) et d√©compress√©. <br><br>  Ensuite, les fichiers JSON sont trait√©s.  Un pr√©fixe est ajout√© au nom des ressources soumises aux tests A / B - ainsi, lors de l'exportation, elles seront enregistr√©es dans un sous-dossier avec un nom pr√©d√©fini (correspondant au nom unique de l'exp√©rience).  Vous pouvez comprendre si une ressource est soumise √† un test A / B par le nom de la page sur laquelle elle est stock√©e: si c'est le cas, le nom contiendra le pr√©fixe " <i>XP_</i> ". <br><br><img src="https://habrastorage.org/webt/k7/qo/df/k7qodfiyytkacnk1uknx_6gxhzw.png"><br><br>  Dans l'exemple ci-dessus, les ressources export√©es seront stock√©es dans un sous-dossier de ¬´ <i>this__is_an_experiment</i> ¬ª avec un nom de fichier de la forme ¬´ <i>nom-ic√¥ne [nom-variante] .ext</i> ¬ª. <br><br><h2>  Lecture des m√©tadonn√©es d'un croquis </h2><br>  La deuxi√®me √©tape importante consiste √† extraire toutes les m√©tadonn√©es n√©cessaires des fichiers Sketch, ou plut√¥t des fichiers JSON internes.  Comme nous l'avons vu ci-dessus, ce sont deux fichiers principaux ( <i>document.json</i> et <i>meta.json</i> ) et des fichiers de page ( <i>pages / pageUniqueId.json</i> ). <br><br>  Le fichier <i>document.json</i> est utilis√© pour obtenir la liste des styles courants qui appara√Æt sous la propri√©t√© de l'objet <i>layerStyles</i> : <br><br><pre> <code class="plaintext hljs">{ "_class": "document", "do_objectID": "45D2DA82-B3F4-49D1-A886-9530678D71DC", "colorSpace": 1, ... "layerStyles": {  "_class": "sharedStyleContainer",  "objects": [    {      "_class": "sharedStyle",      "do_objectID": "9BC39AAD-CDE6-4698-8EA5-689C3C942DB4",      "name": "features/feature-like",      "value": {        "_class": "style",        "fills": [          {            "_class": "fill",            "isEnabled": true,            "color": {              "_class": "color",              "alpha": 1,              "blue": 0.10588235408067703,              "green": 0.4000000059604645,              "red": 1            },            "fillType": 0,            "noiseIndex": 0,            "noiseIntensity": 0,            "patternFillType": 1,            "patternTileScale": 1          }        ],        "blur": {...},        "startMarkerType": 0,        "endMarkerType": 0,        "miterLimit": 10,        "windingRule": 1      }    },    ...</code> </pre> <br>  Nous stockons des informations de base sur chaque style dans un objet au format cl√©-valeur.  Il sera utilis√© plus tard lorsque nous aurons besoin d'extraire le nom du style sur la base d'un ID unique (propri√©t√© <code>do_objectID</code> dans Sketch): <br><br><pre> <code class="plaintext hljs">const parsedSharedStyles = {}; parsedDocument.layerStyles.objects.forEach((object) =&gt; { parsedSharedStyles[object.do_objectID] = {  name: object.name,  isFill: _.get(object, 'value.fills[0].color') !== undefined,  isBorder: _.get(object, 'value.borders[0].color') !== undefined, }; });</code> </pre> <br>  Maintenant, nous allons dans le fichier <i>meta.json</i> et obtenons une liste de pages.  Nous sommes int√©ress√©s par leur <code>unique-id</code> et leur <code>name</code> : <br><br><pre> <code class="plaintext hljs">{ "commit": "623a23f2c4848acdbb1a38c2689e571eb73eb823", "pagesAndArtboards": {  "EE6BE8D9-9FAD-4976-B0D8-AB33D2B5DBB7": {    "name": "Icons",    "artboards": {      "3275987C-CE1B-4369-B789-06366EDA4C98": {        "name": "badge-feature-like"      },      "C6992142-8439-45E7-A346-FC35FA01440F": {        "name": "badge-feature-crush"      },      ...      "7F58A1C4-D624-40E3-A8C6-6AF15FD0C32D": {        "name": "tabbar-livestream"      }      ...    }  },  "ACF82F4E-4B92-4BE1-A31C-DDEB2E54D761": {    "name": "XP_this__is_an_experiment",    "artboards": {      "31A812E8-D960-499F-A10F-C2006DDAEB65": {        "name": "this__is_an_experiment/tabbar-livestream[variant1]"      },      "20F03053-ED77-486B-9770-32E6BA73A0B8": {        "name": "this__is_an_experiment/tabbar-livestream[variant2]"      },      "801E65A4-3CC6-411B-B097-B1DBD33EC6CC": {        "name": "this__is_an_experiment/tabbar-livestream[control]"      }    }  },</code> </pre> <br>  Ensuite, nous lisons les fichiers JSON correspondant √† chaque page du dossier <i>pages</i> (je r√©p√®te que les noms de fichiers sont au <i>format [pageUniqueId] .json</i> ) et √©tudions les ressources stock√©es sur cette page (elles ressemblent √† des calques).  Ainsi, nous obtenons le <b>nom</b> , la <b>largeur / hauteur de</b> chaque ic√¥ne, les <b>m√©tadonn√©es</b> Sketch pour l'ic√¥ne de cette couche, et si nous avons affaire √† une page d' <b>exp√©rimentation</b> , alors le nom du <b>test A / B</b> et une <b>variante de</b> cette ic√¥ne. <br><br>  <i>Remarque</i> : l'objet page.json a un p√©riph√©rique tr√®s complexe, donc je ne m'attarderai pas dessus.  Si vous √™tes int√©ress√© par ce qu'il y a √† l'int√©rieur, je vous conseille de cr√©er un nouveau fichier Sketch vide, d'y ajouter du contenu et de l'enregistrer;  puis renommez son extension en ZIP, d√©compressez-la et examinez l'un des fichiers du dossier pages. <br><br>  Dans le processus de traitement des plans de travail, nous cr√©erons √©galement une <b>liste d'exp√©riences</b> (et de ressources connexes).  Nous en aurons besoin pour d√©terminer quelles variations de l'ic√¥ne sont utilis√©es dans quelle exp√©rience - les noms des variations de l'ic√¥ne sont attach√©s √† l'objet ¬´de base¬ª. <br><br>  Pour chaque fichier Sketch <code>assetsMetadata</code> marque en cours de traitement, nous cr√©ons un objet <code>assetsMetadata</code> qui ressemble √† ceci: <br><br><pre> <code class="plaintext hljs">{ "navigation-bar-edit": {  "do_objectID": "86321895-37CE-4B3B-9AA6-6838BEDB0977",  ...sketch_artboard_properties,  "name": "navigation-bar-edit",  "assetname": "navigation-bar-edit",  "source": "icons_common",  "width": 48,  "height": 48  "layers": [    {      "do_objectID": "A15FA03C-DEA6-4732-9F85-CA0412A57DF4",      "name": "Path",      ...sketch_layer_properties,      "sharedStyleID": "6A3C0FEE-C8A3-4629-AC48-4FC6005796F5",      "style": {        ...        "fills": [          {            "_class": "fill",            "isEnabled": true,            "color": {              "_class": "color",              "alpha": 1,              "blue": 0.8784313725490196,              "green": 0.8784313725490196,              "red": 0.8784313725490196            },          }        ],        "miterLimit": 10,        "startMarkerType": 0,        "windingRule": 1      },    },  ],  ... }, "experiment-name/navigation-bar-edit[variant]": {  "do_objectID": "00C0A829-D8ED-4E62-8346-E7EFBC04A7C7",  ...sketch_artboard_properties,  "name": "experiment-name/navigation-bar-edit[variant]",  "assetname": "navigation-bar-edit",  "source": "icons_common",  "width": 48,  "height": 48  ...</code> </pre> <br>  Comme vous pouvez le voir, dans l'exp√©rience, une seule ic√¥ne (dans ce cas, <i>navigation-bar-edit</i> ) peut correspondre √† de nombreuses ressources.  Dans le m√™me temps, la m√™me ic√¥ne peut appara√Ætre sous le m√™me nom dans un autre fichier Sketch associ√© √† la marque.  <b>C'est tr√®s utile</b> : nous utilisons cette astuce pour compiler un ensemble commun d'ic√¥nes, puis identifier des options sp√©cifiques en fonction de la marque.  C'est pourquoi nous avons d√©clar√© les fichiers Sketch associ√©s √† une marque particuli√®re en tant que tableau: <br><br><pre> <code class="plaintext hljs">const SKETCH_FILES = { badoo: ['icons_common'], blendr: ['icons_common', 'icons_blendr'], fiesta: ['icons_common', 'icons_fiesta'], hotornot: ['icons_common', 'icons_hotornot'], };</code> </pre> <br>  Dans ce cas, l'ordre est d'une importance fondamentale.  En fait, dans la fonction <code>getSketchMetadata</code> appel√©e par le script, nous ne <code>assetsMetadata</code> objets <code>assetsMetadata</code> un par un sous la forme d'un fichier de liste.  Au lieu de cela, nous effectuons une fusion profonde des objets - nous les combinons et <code>assetsMetadata</code> un seul objet <code>assetsMetadata</code> . <br><br>  En g√©n√©ral, ce n'est rien d'autre qu'une fusion ¬´logique¬ª de fichiers Sketch et de leurs ressources en un seul fichier.  Cependant, la logique n'est pas aussi simple qu'il y para√Æt.  Voici un diagramme que nous avons cr√©√© pour tenter de comprendre ce qui se passe lorsque des ic√¥nes portant le m√™me nom (et √©ventuellement soumises √† des tests A / B) dans diff√©rents fichiers sont associ√©es √† la m√™me marque: <br><br><img src="https://habrastorage.org/webt/yg/ug/-6/ygug-6xnds3cvysntithaenmbfw.png"><br><br><h2>  Cr√©ation de fichiers pr√™ts √† l'emploi dans diff√©rents formats pour diff√©rentes plateformes </h2><br>  La derni√®re √©tape de notre processus consiste √† cr√©er directement des fichiers d'ic√¥nes dans diff√©rents formats pour diff√©rentes plates-formes (PDF pour iOS, SVG / JSX pour Web et VectorDrawable pour Android). <br><br>  Comme vous pouvez le voir d'apr√®s le nombre de param√®tres transmis aux fonctions <code>generateAssets[format][platform]</code> , cette partie du pipeline est la plus complexe.  C'est l√† que le processus commence √† se d√©composer et √† changer en fonction de la plateforme.  Ci-dessous, vous verrez le d√©roulement logique du script dans son ensemble et comment la partie li√©e √† la g√©n√©ration de ressources est divis√©e en trois processus similaires mais diff√©rents: <br><br> <a href=""><img src="https://habrastorage.org/webt/jv/83/xy/jv83xyzcpvzmn4snh0xakkrfu8k.png"></a> <br><br>  Pour cr√©er des ressources pr√™tes √† l'emploi avec les couleurs correctes correspondant √† la marque en cours de traitement, nous devrons effectuer quelques manipulations suppl√©mentaires avec les fichiers JSON.  Nous parcourons toutes les couches auxquelles le style g√©n√©ral est appliqu√© et rempla√ßons les valeurs de couleur par les couleurs du jeton de conception de la marque. <br><br>  Pour g√©n√©rer des fichiers pour Android, vous devez effectuer une action suppl√©mentaire (√† ce sujet un peu plus tard): nous changeons la propri√©t√© de <code>fill-rule</code> de chaque couche de <code>even-odd</code> √† <code>non-zero</code> (ceci est contr√¥l√© par la propri√©t√© <code>windingRule</code> de l'objet JSON, dans laquelle 1 signifie "impair / pair" , et 0 est "diff√©rent de z√©ro"). <br><br>  Apr√®s avoir effectu√© ces manipulations, nous repla√ßons les fichiers JSON dans un fichier Sketch standard pour traiter et exporter des ressources avec des propri√©t√©s mises √† jour (les fichiers clon√©s et mis √† jour sont des fichiers Sketch ordinaires, ils peuvent √™tre ouverts, affich√©s, modifi√©s, enregistr√©s, etc. ) <br><br>  Apr√®s cela, nous utilisons SketchTool (envelopp√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sous Node</a> ) pour exporter automatiquement toutes les ressources dans des formats adapt√©s aux plates-formes.  Pour chacun des fichiers associ√©s √† la marque (ou plut√¥t, leurs versions clon√©es et mises √† jour), nous ex√©cutons la commande suivante: <br><br><pre> <code class="plaintext hljs">sketchtool.run(`export slices ${cloneSketchFile} --formats=svg --scales=1 --output=${destinationFolder} --overwriting`);</code> </pre> <br>  Comme vous pouvez le deviner, cette commande exporte les ressources vers le dossier de destination dans un format sp√©cifique, en utilisant √©ventuellement la mise √† l'√©chelle (nous conservons l'√©chelle d'origine pour l'instant).  La cl√© ici est l'option <code>-overwriting</code> : tout comme nous faisons une fusion profonde des objets <code>assetsMetadata</code> (correspondant aux fichiers Sketch ¬´logiques¬ª), lors de l'exportation, nous fusionnons de nombreux fichiers dans un r√©pertoire (li√© √† la marque / plateforme).  Cela signifie que si la ressource - identifi√©e par le nom de la couche - existait d√©j√† dans le fichier Sketch pr√©c√©dent, elle sera remplac√©e lors de la prochaine exportation.  Encore une fois, ce n'est rien de plus qu'une op√©ration de fusion normale. <br><br>  Cependant, dans cet exemple, certaines ressources peuvent se r√©v√©ler √™tre des ¬´fant√¥mes¬ª.  Cela se produit lorsque l'ic√¥ne du fichier est soumise √† un test A / B, mais est remplac√©e dans le fichier suivant.  Ensuite, les fichiers de variantes sont export√©s vers le dossier de destination, ont un lien correspondant √† la ressource dans l'objet <code>assetsMetadata</code> (avec leur cl√© et leurs propri√©t√©s), mais ne sont associ√©s √† aucune ressource de base (en raison de la fusion en profondeur des objets <code>assetsMetadata</code> ).  Ces fichiers seront supprim√©s ult√©rieurement, avant de terminer le processus. <br><br><hr><br>  Comme d√©j√† mentionn√©, diff√©rentes plates-formes n√©cessitent diff√©rents formats de sortie.  Les fichiers iOS s'adaptent aux PDF et nous pouvons les exporter directement √† l'aide de la commande SketchTool.  Les fichiers JSX sont requis pour Mobile Web et VectorDrawable pour Android.  Pour cette raison, nous exportons des ressources au format SVG vers un dossier temporaire et apr√®s cela nous les traitons. <br><br><h2>  PDF pour iOS </h2><br>  Curieusement, PDF est le seul (?) Format pris en charge par Xcode et OS / iOS pour l'importation et le rendu des ressources vectorielles ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">voici une br√®ve explication du</a> choix <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">d'</a> Apple). <br><br>  Comme nous pouvons exporter directement au format PDF via SketchTool, aucune √©tape suppl√©mentaire n'est requise: il suffit d'enregistrer les fichiers directement dans le dossier de destination, et c'est tout. <br><br><h2>  Fichiers Web React / JSX </h2><br>  Dans le cas du Web, nous utilisons la biblioth√®que SVGR Node, qui vous permet de convertir SVG en composants React.  Cependant, nous voulons faire quelque chose de brusquement: ¬´coloriser dynamiquement¬ª l'ic√¥ne lors de l'ex√©cution (les couleurs sont tir√©es des jetons).  Pour ce faire, avant la conversion, nous modifions les valeurs de <code>fill</code> des vecteurs auxquels le style g√©n√©ral a √©t√© pr√©c√©demment appliqu√© aux valeurs des jetons correspondant √† ce style. <br><br>  Donc, si le fichier <i>badge-feature-like.svg</i> export√© depuis Sketch ressemble √† ceci: <br><br><pre> <code class="plaintext hljs">&lt;?xml version="1.0" encoding="UTF-8"?&gt; &lt;svg width="128px" height="128px" viewBox="0 0 128 128" version="1.1" xmlns="&lt;a href="http://www.w3.org/2000/svg"&gt;http://www.w3.org/2000/svg&lt;/a&gt;" xmlns:xlink="&lt;a href="http://www.w3.org/1999/xlink"&gt;http://www.w3.org/1999/xlink&lt;/a&gt;"&gt; &lt;!-- Generator: sketchtool 52.2 (67145) -&lt;a href="http://www.bohemiancoding.com/sketch"&gt; http://www.bohemiancoding.com/sketch&lt;/a&gt; --&gt; &lt;title&gt;badge-feature-like&lt;/title&gt; &lt;desc&gt;Created with sketchtool.&lt;/desc&gt; &lt;g id="Icons" fill="none" fill-rule="evenodd"&gt;  &lt;g id="badge-feature-like"&gt;    &lt;circle id="circle" fill="#E71032" cx="64" cy="64" r="64"&gt;    &lt;path id="Shape" fill="#FFFFFF" d="M80.4061668,..."&gt;&lt;/path&gt;  &lt;/g&gt; &lt;/g&gt; &lt;/svg&gt;</code> </pre> <br>  alors l' <i>ic√¥ne</i> finale de ressource / <i>badge-fonction-like.js</i> ressemblera √† ceci: <br><br><pre> <code class="plaintext hljs">/* This file is generated automatically - DO NOT EDIT */ /* eslint-disable max-lines,max-len,camelcase */ const React = require('react'); module.exports = function badge_feature_like({ tokens }) { return (  &lt;svg data-origin="pipeline" viewBox="0 0 128 128"&gt;    &lt;g fill="none" fillRule="evenodd"&gt;      &lt;circle fill={tokens.TOKEN_COLOR_FEATURE_LIKED_YOU} cx={64} cy={64} r={64} /&gt;      &lt;path fill="#FFF" d="M80.4061668,..." /&gt;    &lt;/g&gt;  &lt;/svg&gt; ); };</code> </pre> <br>  Comme vous pouvez le voir, nous avons remplac√© la couleur de <code>fill</code> statique par une couleur dynamique qui prend des valeurs des jetons (elles peuvent √™tre mises √† disposition pour le composant React <code>&lt;Icon/&gt;</code> via l'API Context, mais c'est une autre histoire). <br><br>  Ce remplacement est possible gr√¢ce aux m√©tadonn√©es Sketch pour les actifs de l'objet <code>assetsMetadata</code> : en parcourant r√©cursivement les couches, vous pouvez cr√©er un s√©lecteur DOM (pour l'exemple ci-dessus, <code>#Icons</code> <code>#badge-feature-like #circle</code> ) et l'utiliser pour rechercher un n≈ìud dans l'arborescence SVG et remplacer sa valeur attribut <code>fill</code> (pour cela, nous avons besoin de la biblioth√®que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cheerio</a> ). <br><br><h2>  Fichiers vectoriels pour Android </h2><br>  Android prend en charge les graphiques vectoriels en utilisant le format vectoriel personnalis√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">VectorDrawable</a> .  Habituellement, la conversion de SVG en VectorDrawable se fait <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">directement dans Android Studio</a> .  Cependant, nous voulions automatiser enti√®rement le processus, donc nous cherchions un moyen de convertir en utilisant du code. <br><br>  Apr√®s avoir √©tudi√© divers outils et biblioth√®ques, nous avons <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">opt√©</a> pour <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">svg2vectordrawable</a> .  Il est non seulement activement pris en charge (en tout cas, plus actif que tout le monde), mais aussi plus fonctionnel que les autres. <br><br>  Les r√©alit√©s sont que VectorDrawable et SVG ne sont pas les m√™mes dans leurs fonctionnalit√©s: certaines fonctions SVG (par exemple, les d√©grad√©s radiaux et la mise en √©vidence complexe) ne sont pas prises en charge par VectorDrawable, tandis que d'autres ont commenc√© √† √™tre prises en charge assez r√©cemment (√† partir d'Android API 24).  L'un des probl√®mes qui en r√©sulte est que les anciennes versions (jusqu'√† 24) <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ne prennent pas en charge la valeur paire-impaire de l'attribut fill-rule</a> .  Cependant, chez Badoo, nous avons besoin du support pour Android 5 et sup√©rieur.  C'est pourquoi, √† l'une des √©tapes pr√©c√©dentes, nous avons amen√© le <code>fill</code> chaque vecteur des fichiers Sketch √† une valeur <code>non-zero</code> . <br><br>  En principe, les concepteurs peuvent effectuer cette action manuellement: <br><br><img src="https://habrastorage.org/webt/oj/ec/bp/ojecbp2no3lxsas5uwxcqmobcji.png"><br><br>  Mais c'est facile √† oublier et √† commettre une erreur.  Par cons√©quent, nous avons d√©cid√© d'ajouter une √©tape suppl√©mentaire au processus pour Android, au cours de laquelle tous les vecteurs dans JSON sont automatiquement convertis en <code>non-zero</code> .  Cela est fait de sorte que lors de l'exportation d'ic√¥nes vers SVG, elles soient d√©j√† au format requis, et chaque objet VectorDrawable cr√©√© est pris en charge par les appareils sur Android 5. <br><br>  Le fichier <i>badge-feature-like.xml termin√©</i> ressemble √† ceci: <br><br><pre> <code class="plaintext hljs">&lt;!-- This file is generated automatically - DO NOT EDIT --&gt; &lt;vector xmlns:android="&lt;a href="http://schemas.android.com/apk/res/android"&gt;http://schemas.android.com/apk/res/android&lt;/a&gt;" android:width="128dp" android:height="128dp" android:viewportWidth="128" android:viewportHeight="128"&gt; &lt;path  android:fillColor="?color_feature_liked_you"  android:pathData="M64 1a63 63 0 1 0 0 126A63 63 0 1 0 64 1z" /&gt; &lt;path  android:fillColor="#FFFFFF"  android:pathData="M80.406 ..." /&gt; &lt;/vector&gt;</code> </pre> <br>  Dans les fichiers VectorDrawable, nous ins√©rons des noms de variables pour les couleurs de <code>fill</code> , qui sont associ√©es aux jetons de conception via des styles courants dans les applications Android. <br><br> <a href=""><img src="https://habrastorage.org/webt/zu/n4/8q/zun48q0knfv8k9xy4amb6eqrxxa.png"></a> <br><br>  Il est √† noter qu'Android Studio a des exigences strictes pour l'organisation des ressources: pas de sous-dossiers et de majuscules dans les noms!  Nous avons donc d√ª trouver un nouveau format pour les noms d'ic√¥nes: dans le cas des ressources √† tester, ils ressemblent √† ceci: <code>ic_icon-name__experiment-name__variant-name</code> . <br><br><h2>  Dictionnaire JSON en tant que biblioth√®que de ressources </h2><br>  Une fois les fichiers de ressources enregistr√©s au format final, il ne reste plus qu'√† collecter toutes les m√©ta-informations obtenues lors de l'assemblage et √† les enregistrer dans un ¬´dictionnaire¬ª √† utiliser lorsque les ressources sont import√©es et utilis√©es par la base de code de diff√©rentes plateformes. <br><br>  Apr√®s avoir extrait une liste plate d'ic√¥nes de l'objet <code>assetsMetadata</code> nous le <code>assetsMetadata</code> v√©rifiant chacune d'elles: <br><br><ul><li>  S'agit-il d'une ressource r√©guli√®re (par exemple, <code>tabbar-livestream</code> );  si oui, alors laissez-le; <br></li><li>  s'il s'agit d'une option pour un test A / B (par exemple, <i>experiment / tabbar-livestream [variant]</i> ), nous associons son nom, son chemin, les noms du test A / B et sa variante √† la propri√©t√© <code>abtests</code> <br>  la ressource de base (dans notre cas, il s'agit de <i>tabbar-livestream</i> ), apr√®s quoi nous supprimons l'enregistrement de la variante de la liste / objet (seul l'√©l√©ment ¬´base¬ª compte); <br></li><li>  s'il s'agit d'un ¬´fant√¥me¬ª, supprimez le fichier et supprimez l'entr√©e de la liste / objet. <br></li></ul><br>  Apr√®s avoir termin√© ce processus, le dictionnaire contiendra une liste de toutes les ic√¥nes de base (et leurs tests A / B, le cas √©ch√©ant), et seulement eux.  Les informations sur chacun d'eux incluent le nom, la taille, le chemin d'acc√®s et, si l'ic√¥ne est soumise √† des tests A / B, des informations sur ses diff√©rentes options. <br><br>  Le dictionnaire est enregistr√© au format JSON dans le dossier de destination de la <i>marque</i> et de la <i>plateforme</i> .  Voici, par exemple, le fichier <i>assets.json</i> g√©n√©r√© pour l'application Blendr pour Mobile Web: <br><br><pre> <code class="plaintext hljs">{ "platform": "mw", "brand": "blendr", "assets": {    "badge-feature-like": {    "assetname": "badge-feature-like",    "path": "assets/badge-feature-like.jsx",    "width": 64,    "height": 64,    "source": "icons_common"  },  "navigation-bar-edit": {    "assetname": "navigation-bar-edit",    "path": "assets/navigation-bar-edit.jsx",    "width": 48,    "height": 48,    "source": "icons_common"  },  "tabbar-livestream": {    "assetname": "tabbar-livestream",    "path": "assets/tabbar-livestream.jsx",    "width": 128,    "height": 128,    "source": "icons_blendr",    "abtest": {      "this__is_an_experiment": {        "control": "assets/this__is_an_experiment/tabbar-livestream__control.jsx",        "variant1": "assets/this__is_an_experiment/tabbar-livestream__variant1.jsx",        "variant2": "assets/this__is_an_experiment/tabbar-livestream__variant2.jsx"      },      "a_second-experiment": {        "control": "assets/a_second-experiment/tabbar-livestream__control.jsx",        "variantA": "assets/a_second-experiment/tabbar-livestream__variantA.jsx"      }    }  },  ... } }</code> </pre> <br>  Il ne reste plus qu'√† emballer tous les dossiers de <i>ressources</i> dans des archives ZIP pour un t√©l√©chargement plus facile. <br><br><h2>  R√©sum√© </h2><br>  Le processus d√©crit dans l'article, du clonage et de la manipulation des fichiers Sketch √† l'exportation et √† la conversion des ressources dans des formats pris en charge par les plateformes et √† l'enregistrement des m√©ta-informations collect√©es dans la biblioth√®que de ressources, est r√©p√©t√© avec chaque marque annonc√©e dans le script de construction. <br><br>  Voici une capture d'√©cran montrant l'apparence des dossiers <i>src</i> et <i>dist une</i> fois le processus termin√©: <br><br><img src="https://habrastorage.org/webt/yg/nc/d9/ygncd9uupdngcnav-rmkrsq1dsg.png"><br><br>  √Ä ce stade, √† l'aide d'une commande simple, vous pouvez t√©l√©charger toutes les ressources (JSON, ZIP et fichiers de ressources) vers le stockage distant et les rendre disponibles pour toutes les plates-formes pour le t√©l√©chargement et l'utilisation dans la base de code. <br><br>  La mani√®re exacte dont les plateformes re√ßoivent et traitent les ressources (√† l'aide de scripts personnalis√©s cr√©√©s sp√©cifiquement √† cet effet) ne d√©passe pas le cadre de cet article.  Et cette question sera probablement trait√©e dans l'un des articles suivants par un de mes coll√®gues. <br><br><h2>  Conclusion (et le√ßons apprises) </h2><br>  J'ai toujours aim√© Sketch.  Pendant de nombreuses ann√©es, le programme a √©t√© l'outil par d√©faut pour les d√©veloppeurs et les concepteurs.  Par cons√©quent, j'√©tais tr√®s curieux d'apprendre des outils d'int√©gration comme <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">html-sketchapp</a> et d'autres outils similaires que nous pourrions utiliser dans le flux de travail et nos pipelines. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Comme beaucoup d'autres</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">j'ai toujours ≈ìuvr√©</a> pour un tel processus (id√©al): <br><br><img src="https://habrastorage.org/webt/kq/7l/n4/kq7ln4kr6txurb-mvh6brqbhnqe.png"><br><br>  Cependant, je dois admettre que j'ai commenc√© √† douter que Sketch soit un outil appropri√©, surtout compte tenu du syst√®me de conception.  Par cons√©quent, j'ai commenc√© √† regarder d'autres services, tels que Figma avec ses API ouvertes et Framer X avec une int√©gration pratique avec React, parce que je ne ressentais pas le mouvement de Sketch vers l'int√©gration avec le code (quel qu'il soit). <br><br>  Donc, ce projet m'a convaincu.  Pas compl√®tement, mais √† bien des √©gards. <br><br>  Bien que Sketch n'ouvre pas ses API, le dispositif m√™me de la structure interne de ses fichiers sert comme une sorte d'API ¬´non officielle¬ª.  Les cr√©ateurs peuvent utiliser des noms chiffr√©s ou masquer des cl√©s dans les objets JSON, mais √† la place, ils adh√®rent √† une convention de d√©nomination claire, lisible et conceptuelle.  Je ne pense pas que ce soit un accident. <br><br>  Le fait que les fichiers Sketch puissent √™tre g√©r√©s de cette mani√®re m'a ouvert la voie √† de nombreux d√©veloppements et am√©liorations futurs: des plugins pour v√©rifier le nom, la stylisation et la structure des couches pour les ic√¥nes √† l'int√©gration avec notre Wiki et la documentation de notre syst√®me de conception (mutuelle).  En cr√©ant des applications Node sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Electron</a> ou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Carlo</a> , nous pouvons faciliter la t√¢che des concepteurs pour effectuer de nombreuses t√¢ches de routine. <br><br>    (  ,  )   ,  Sketch-   Cosmos  ¬´ ¬ª ‚Äî      - Cosmos.   ,        (   ;    ,    ‚Äî ).    ,      ‚Äî  ,   ,  . <br><br>      ,  Sketch-  , ,    MVP-,       .    ,     ,     . , , -,  ‚Äî    ,             .  ,         . <br><br>  :       <i></i> ,      <i></i> .   ,       <i></i> . <br><br> ,    , ‚Äî   .  ,  ,       ,    (,         A/B-),            Node.js  Sketch. <br><br>   !     . <br><br><h2>  Remerciements </h2><br>        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> </a> (Mobile Web),     , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> </a> (Android)  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> </a> (iOS),           . <br><br> , !             . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr442886/">https://habr.com/ru/post/fr442886/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr442872/index.html">Comment j'ai trouv√© l'oeuf de P√¢ques dans la protection Android et que je n'ai pas trouv√© d'emploi chez Google</a></li>
<li><a href="../fr442876/index.html">Cartographie du bruit avec KSQL, Raspberry Pi et radio</a></li>
<li><a href="../fr442880/index.html">Points de contr√¥le virtuels: liste de contr√¥le de configuration</a></li>
<li><a href="../fr442882/index.html">[Vid√©o] "Les Piems ne sont pas n√©cessaires" et trois autres id√©es de gestion de projet</a></li>
<li><a href="../fr442884/index.html">D√©j√†, la technologie vous permet de parler avec la voiture en tant que personne</a></li>
<li><a href="../fr442888/index.html">Personnaliser la s√©lection sur css pur</a></li>
<li><a href="../fr442890/index.html">CYOD? COPE? BYOD?</a></li>
<li><a href="../fr442892/index.html">Programmation orient√©e d√©bogage ou tristesse aux yeux de l'int√©grateur</a></li>
<li><a href="../fr442896/index.html">La production additive en cycle complet dans une entreprise a√©ronautique est une question pour l'avenir proche</a></li>
<li><a href="../fr442898/index.html">Solutions au probl√®me des robots anti-spam ajout√©s aux groupes de t√©l√©grammes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>