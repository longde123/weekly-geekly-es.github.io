<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🈳 🤽🏾 👩‍👦 Testez-moi si vous le pouvez. Les développeurs YML rêvent-ils de tester ansible? 👨🏾‍🎨 👩🏿‍🔧 😈</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Il s'agit de la version texte de la présentation 2018-04-25 au Saint-Petersburg Linux User Group . L'exemple de configuration localise à https://githu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Testez-moi si vous le pouvez. Les développeurs YML rêvent-ils de tester ansible?</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/436960/"><p><img src="https://habrastorage.org/webt/ct/me/vo/ctmevotjzsrr0s-5_erinl_pedk.png" alt="schéma ci-dessous"></p><br><p>  Il s'agit de la version texte de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">la présentation</a> 2018-04-25 au <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Saint-Petersburg Linux User Group</a> .  L'exemple de configuration localise à <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/ultral/ansible-role-testing</a> </p><br><p>  Je suppose que vous <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">faites de la gestion de configuration, pas bash</a> .  Cela signifie que vous devez le tester un peu.  Avez-vous déjà testé des rôles ansibles?  Comment tu fais? </p><a name="habracut"></a><br><h1 id="how-to-do-it">  Comment faire </h1><br><p>  Dans mon cas, nous avons: </p><br><ul><li>  Beaucoup de différents rôles ansibles. </li><li>  Les hôtes Hyper-V en tant qu'hyperviseur. </li><li>  Un cloud privé avec une possibilité limitée de créer des VM à la demande. </li><li>  Un proxy pour l'accès à Internet. </li><li>  Test d'incapacité des rôles ansibles à l'intérieur de Docker, en raison d'une configuration role = whole VM </li><li>  Décision de mettre en œuvre une politique de construction écologique pour le référentiel git avec des rôles ansibles. </li></ul><br><p>  Comparons les solutions existantes pour les tests. </p><br><table><thead><tr><th>  Nom </th><th>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Cuisine d'essai</a> </th><th>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Molécule</a> </th><th>  Créer un nouveau </th></tr></thead><tbody><tr><td>  La langue </td><td>  rubis </td><td>  python </td><td>  bash / rubis </td></tr><tr><td>  Observateurs </td><td>  132 </td><td>  126 </td><td>  0 </td></tr><tr><td>  Les étoiles </td><td>  1413 </td><td>  1154 </td><td>  1 </td></tr><tr><td>  Fourches </td><td>  502 </td><td>  174 </td><td>  2 </td></tr><tr><td>  Licence </td><td>  Apache 2.0 </td><td>  MIT </td><td> Tout </td></tr><tr><td>  S'engage </td><td>  1929 </td><td>  1264 </td><td>  0 </td></tr><tr><td>  Communiqués </td><td>  101 </td><td>  121 </td><td>  0 </td></tr><tr><td>  Contributeurs </td><td>  109 </td><td>  82 </td><td>  5 </td></tr></tbody></table><br><table><thead><tr><th>  Nom </th><th>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">testinfra</a> </th><th>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">serverspec</a> </th><th>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">inspec</a> </th><th>  Goss </th></tr></thead><tbody><tr><td>  Github </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">philpep / testinfra</a> </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">mizzy / serverspec</a> </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">chef / inspec</a> </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">aelsabbahy / goss</a> </td></tr><tr><td>  La langue </td><td>  python </td><td>  rubis </td><td>  rubis </td><td>  aller </td></tr><tr><td>  Observateurs </td><td>  93 </td><td>  145 </td><td>  165 </td><td>  67 </td></tr><tr><td>  Les étoiles </td><td>  997 </td><td>  2105 </td><td>  1167 </td><td>  2170 </td></tr><tr><td>  Fourches </td><td>  138 </td><td>  361 </td><td>  330 </td><td>  156 </td></tr><tr><td>  Licence </td><td>  Apache 2.0 </td><td>  MIT </td><td>  Apache 2.0 </td><td>  Apache 2.0 </td></tr><tr><td>  S'engage </td><td>  380 </td><td>  1854 </td><td>  4609 </td><td>  309 </td></tr><tr><td>  Communiqués </td><td>  35 </td><td>  282 </td><td>  346 </td><td>  47 </td></tr><tr><td>  Contributeurs </td><td>  43 </td><td>  110 </td><td>  159 </td><td>  31 </td></tr></tbody></table><br><p>  Nous avons décidé de ne pas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">réinventer la roue</a> et de ne pas préparer de solution de production.  Notre équipe d'infrastructure avait de solides compétences en rubis et une grande expérience avec le rubis, nous avons donc choisi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Test Kitchen</a> &amp; <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">inspec</a> </p><br><h1 id="kitchen-ci">  Cuisine-ci </h1><br><p><img src="https://habrastorage.org/webt/ct/me/vo/ctmevotjzsrr0s-5_erinl_pedk.png" alt="schéma ci-dessous"></p><br><p>  L'idée principale est de créer une nouvelle VM, d'appliquer un rôle ansible et de faire des tests de fumée. </p><br><h1 id="green-build-policy">  Politique de construction écologique </h1><br><p><img src="https://habrastorage.org/webt/0i/pj/ky/0ipjkykp-b0bmksesauecyoxbdi.png" alt="Schéma de politique de construction écologique"></p><br><p>  Nous avons également mis en œuvre une politique de construction écologique.  Nous avons exécuté des tests pour chaque commit dans la branche master et si les tests sont corrects, lors de l'application des rôles ansibles. </p><br><h1 id="nested-virtualization">  Virtualisation imbriquée </h1><br><p>  Comme vous vous en souvenez, nous avions un cloud privé avec une possibilité limitée de créer des VM à la demande.  Nous avons décidé de créer des VM à l'intérieur des VM. </p><br><p><img src="https://habrastorage.org/webt/cy/5r/pn/cy5rpnk2a-hhcqzuyfszpfnvdfo.jpeg" alt="nous devons aller plus loin"></p><br><p>  Tout d'abord, nous avons essayé d'exécuter Virtualbox x32 sans imbriqué.  C'était une mauvaise idée à cause de la panique du noyau.  De plus, la grande majorité de nos machines virtuelles dans notre infrastructure sont des x86_64, nous avons donc décidé de poursuivre la recherche.  En conséquence, nous avons décidé d'utiliser la virtualisation imbriquée.  J'espère que cela a été pris en charge par nos serveurs hôtes. </p><br><h1 id="faced-issues">  Problèmes rencontrés </h1><br><p>  J'implémentais testkitchen et je rencontrais des problèmes. </p><br><h2 id="pass-proxy-settings-from-host-into-testkitchen-guest-vm">  Passer les paramètres de proxy de l'hôte à la machine virtuelle invitée testkitchen </h2><br><p>  Dans certaines combinaisons de test, nous avons configuré les paramètres du client proxy dans la machine virtuelle créée par testkitchen.  Cependant, le proxy n'a pas été configuré sur l'hôte de testkitchen et ansible ne peut pas utiliser de variables supplémentaires avec des valeurs vides </p><br><p>  <em>Solution:</em> créez un modèle erb pour définir le proxy par défaut si les variables ENV ne sont pas définies </p><br><pre><code class="plaintext hljs">&lt;%= ENV['http_proxy'].to_s.empty? ? 'http://proxy.example.com:3128' : ENV['http_proxy'] %&gt;</code> </pre> <br><h2 id="manage-network-settings-via-playbook">  Gérer les paramètres réseau via playbook </h2><br><p>  Certains rôles configurent les interfaces réseau.  La combinaison d'essai ressemblait à: </p><br><ul><li>  Déployer les paramètres réseau sur les machines virtuelles </li><li>  Recharger le réseau </li><li>  C'est raté </li></ul><br><p>  <em>Solution:</em> ajouter des interfaces aux machines virtuelles </p><br><h2 id="fail-if-suit-cases-contains---in-name">  Échec si les valises contiennent "-" dans le nom </h2><br><p>  Virtualbox ne peut pas utiliser "_" dans un nom de VM </p><br><p>  <em>Solution:</em> renommer les valises "vm_" =&gt; "vm-" </p><br><h2 id="oracle-test-fails-without--at-the-end-of-vm-name">  Le test Oracle échoue sans "."  à la fin du nom de la machine virtuelle </h2><br><p>  Nous utilisons le rôle dans la production, mais lorsque nous avons décidé de le tester, il a échoué.  Nous l'avons reproduit. </p><br><p>  Je voudrais montrer un indice. </p><br><pre> <code class="plaintext hljs">[root@vm-oracle vagrant]# getent ahosts vm-oracle 127.0.0.1 STREAM vm-oracle 127.0.0.1 DGRAM 127.0.0.1 RAW [root@vm-oracle vagrant]# getent ahosts vm-oracle. fe80::a00:27ff:febd:bd6a STREAM vm-oracle fe80::a00:27ff:febd:bd6a DGRAM fe80::a00:27ff:febd:bd6a RAW 10.0.2.15 STREAM 10.0.2.15 DGRAM 10.0.2.15 RAW [root@oracle vagrant]# getent ahosts oracle.example.com. 192.168.128.182 STREAM oracle.example.local 192.168.128.182 DGRAM 192.168.128.182 RAW</code> </pre> <br><p>  Avez-vous une idée de ce qui se passe? </p><br><p>  C'est un bug délicat: </p><br><ol><li>  nous avons activé l'écoute IPv4 uniquement dans les paramètres du programme d'écoute Oracle </li><li>  oracle utilisé FQDN </li><li>  linux contient une base de données spéciale "myhostname" pour résoudre le nom d'hôte, il est utilisé après la résolution de / etc / hosts &amp; dns </li><li>  Vagrant créé VM et mis à jour <code>/etc/hosts</code> </li></ol><br><p>  J'aimerais clarifier un peu plus: <br>  Que s'est-il passé en cas de <em>vm-oracle</em> ? </p><br><ol><li>  vagrant créé vm </li><li>  vagrant mis à jour <code>/etc/hosts</code> ( <em>vm-oracle</em> x2) </li><li>  écouteur Oracle a écouté IPv4 </li><li>  les auditeurs d'oracle ont résolu <em>vm-oracle.</em>  et obtenu IPv6 </li><li>  ÉCHEC </li></ol><br><p>  Que s'est-il passé en cas <em>vm-oracle.</em>  ? </p><br><ol><li>  vagrant créé vm </li><li>  vagrant mis à jour / etc / hosts ( <em>vm-oracle</em> &amp; <em>vm-oracle.</em> ) </li><li>  écouteur Oracle a écouté IPv4 </li><li>  les auditeurs d'oracle ont résolu <em>vm-oracle.</em>  et obtenu IPv4 </li><li>  Ok </li></ol><br><h2 id="oom-is-coming">  OOM arrive </h2><br><p>  Le MOO tuait au hasard des VM.  Testkitchen a échoué avec des erreurs étranges. </p><br><p>  <em>Solution:</em> augmenter la RAM </p><br><h2 id="slow-builds">  Constructions lentes </h2><br><p>  Ça fonctionnait lentement </p><br><p>  <em>Solutions:</em> </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Packer</a> .  Boîte vagabonde pré-construite avec des tâches courantes </li><li>  Accès simultané </li></ul><br><h1 id="conclusion">  Conclusion </h1><br><p>  D'une part, la mise en œuvre actuelle fonctionne, mais d'autre part, il y a quelques problèmes </p><br><ul><li>  n'est pas convivial. </li><li>  nous mélangeons rubis et python. </li><li>  il n'y a pas de contrôle d'indépendance. </li><li>  ça marche lentement. </li><li>  il est difficile de tracer les journaux à un seul travail. </li></ul><br><p>  En conséquence, la molécule et le docker pourraient être une solution assez intéressante. </p><br><h1 id="some-related-links">  Quelques liens connexes </h1><br><ul><li>  C'est un poteau croisé.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Original</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Version russe</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">présentation</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">exemple simple</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">http://kitchen.ci/</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/chef/kitchen-inspec</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://docs.chef.io/config_yml_kitchen.html</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://docs.chef.io/ctl_kitchen.html</a> </li><li>  <a href="">https://github.com/neillturner/kitchen-ansible/blob/master/provisioner_options.md</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr436960/">https://habr.com/ru/post/fr436960/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr436950/index.html">Startups au CES 2019: première partie</a></li>
<li><a href="../fr436952/index.html">Par souci d'argent: recherche et exploitation des vulnérabilités dans les terminaux de paiement mobiles</a></li>
<li><a href="../fr436954/index.html">Événements numériques à Moscou du 21 janvier au 27 janvier</a></li>
<li><a href="../fr436956/index.html">Sur la question des changements, des signes et de la vitesse MK</a></li>
<li><a href="../fr436958/index.html">Le bot de poker stratégique Libratus adapté aux simulations militaires</a></li>
<li><a href="../fr436962/index.html">Open source populaire - première partie: 3 outils pour travailler avec des données</a></li>
<li><a href="../fr436964/index.html">«Rostelecom. DataTalks "- un cours de conférences gratuites sur l'ingénierie et la gestion des données</a></li>
<li><a href="../fr436966/index.html">Optimisation du site Web pour GooglePage Speed ​​(toutes les fonctionnalités sont prises en compte après sa mise à jour) Partie 1</a></li>
<li><a href="../fr436968/index.html">Plan Daimler-BMW. Naturellement, pas sans Tesla</a></li>
<li><a href="../fr436970/index.html">À quoi servent les achats et à quoi cela ressemble-t-il du point de vue informatique?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>