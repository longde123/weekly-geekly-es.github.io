<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üîã üë∏üèæ üôå Nous enveloppons tout le trafic LAN en vpn sans limitation de vitesse ‚è∞ üêª üë®üèª‚ÄçüöÄ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans un article pr√©c√©dent, nous avons examin√© comment anonymiser tout le trafic Internet √† partir d'un seul h√¥te. Maintenant, augmentons le niveau de ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Nous enveloppons tout le trafic LAN en vpn sans limitation de vitesse</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/postuf/blog/475068/"><img src="https://habrastorage.org/webt/ln/tp/ju/lntpju4673cqk0xqk-l2d2glpsy.png"><br>  Dans un article pr√©c√©dent, nous avons <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">examin√©</a> comment anonymiser tout le trafic Internet √† partir d'un seul h√¥te.  Maintenant, augmentons le niveau de s√©curit√© en enveloppant l'ensemble du r√©seau local avec un VPN.  Dans le m√™me temps, nous nous d√©barrasserons du danger d'acc√©der √† Internet √† partir d'un appareil non encore configur√© et associerons l'adresse de notre fournisseur √† cet appareil. <br><br>  √Ä cet effet, vous pouvez simplement configurer le client VPN sur la passerelle, si le routeur le permet.  Mais une telle solution est lourde de cons√©quences sous la forme d'une diminution de la vitesse d'Internet, d'une charge accrue sur le routeur, de plus, certains clients envoient imm√©diatement tout le trafic via la connexion principale s'ils se d√©connectent du VPN.  N'oubliez pas que m√™me les principaux fournisseurs de VPN ne peuvent pas fournir une disponibilit√© √† 100% pour leurs serveurs. <br><br>  Alors, quels sont nos objectifs: <br><br><ul><li>  passer tout le trafic sortant via VPN </li><li>  faites-le aussi vite que possible </li><li>  ne d√©pend pas des probl√®mes temporaires du fournisseur VPN </li><li>  anonymat maximal sur Internet </li></ul><a name="habracut"></a><br><h1>  La pr√©paration </h1><br>  Nous avons besoin d'un routeur puissant qui peut crypter le trafic √† grande vitesse.  Il agira comme une passerelle VPN.  Nous avons trouv√© de merveilleux mini-PC sur AliExpress qui ont con√ßu cette t√¢che: Intel Celeron quadric≈ìur, prise en charge native d'AES-CBC, AES-XTS, AES-GCM, AES-ICM et jusqu'√† quatre ports RJ-45.  Et par d√©faut, pfSense a √©t√© install√© sur eux.  Nous travaillerons avec elle. <br><br>  Si votre FAI n√©cessite une configuration de connexion sp√©ciale, vous pouvez prendre deux autres routeurs et partager l'acc√®s √† Internet et au r√©seau local, et mettre une passerelle VPN entre eux.  Dans un autre cas, vous pouvez connecter directement le fil du fournisseur √† la passerelle VPN et, derri√®re, placer votre routeur domestique avec un r√©seau local.  La configuration initiale d'une connexion Internet sur pfSense d√©passe le cadre de cet article. <br><br><h1>  Personnalisation </h1><br>  L'article suppose que l'Internet est connect√© au premier port, votre PC ou votre r√©seau domestique au second, et qu'avant de configurer le VPN, vous avez pu acc√©der √† Internet. <br><br>  Pour √©viter d'autres probl√®mes, connectons-nous √† votre fournisseur VPN pr√©f√©r√© et trouvons des instructions pour configurer pfSense.  Si votre fournisseur ne fournit pas d'instructions pour la configuration manuelle dans pfSense, vous pouvez utiliser celui-ci de mon fournisseur pr√©f√©r√©: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">www.expressvpn.com/support/vpn-setup/pfsense-with-expressvpn-openvpn</a> - le point principal ne changera pas.  L'article ci-dessus avec des images d√©crit comment configurer compl√®tement un routeur nouvellement achet√© avec pfSense. <br><br>  Voici une courte liste de contr√¥le pour la configuration d'un nouveau VPN: <br><br><ul><li>  Syst√®me - Cert.  Manager - CAs.  Ajouter un certificat VPN CA </li><li>  Syst√®me - Cert.  Manager - Certificats.  Ajouter un certificat de serveur VPN </li><li>  VPN - OpenVPN - Clients.  Nous cr√©ons un nouveau client selon les instructions du fournisseur VPN </li><li>  Interfaces - Affectation.  Ajout de clients en tant qu'interfaces </li><li>  Syst√®me - Routage.  V√©rifiez que la passerelle est apparue. </li><li>  Pare-feu - NAT.  Ajouter des r√®gles NAT pour chaque client </li><li>  Pare-feu - R√®gles - LAN.  Ajouter la redirection de tout le trafic provenant du r√©seau via la passerelle </li><li>  Syst√®me - Routage.  Pour un VPN-a actif, dans les param√®tres de la passerelle, sp√©cifiez Monitor IP, ping vers lequel le VPN-a sera v√©rifi√© </li></ul><br>  Les VPN sont red√©marr√©s dans Status - OpenVPN.  Afficher les journaux dans √âtat - Journaux du package - OpenVPN. <br><br>  √Ä ce stade, nous nous arr√™tons et v√©rifions qu'il y a acc√®s √† Internet via VPN, et que lorsqu'il est d√©connect√© du VPN, l'acc√®s dispara√Æt compl√®tement.  S'il n'y a pas d'Internet, nous avons fait une erreur quelque part, nous regardons les journaux VPN, nous v√©rifions √† nouveau les param√®tres.  Si, apr√®s avoir d√©connect√© le VPN, le trafic commence √† passer par la passerelle principale, cela signifie qu'ils ont foir√© dans le pare-feu - R√®gles - LAN. <br><br>  Maintenant pour la partie int√©ressante.  Si votre fournisseur √©met 20 Mbit par seconde, puis la nuit - √† ce stade, vous avez d√©j√† re√ßu un r√©seau local compl√®tement ferm√© par le VPN-ohm, qui fonctionne √† la vitesse la plus √©lev√©e possible.  Mais que se passe-t-il si votre cha√Æne est plus large? <br><br><h1>  √âvolutif </h1><br>  Nous avons configur√© quelques clients VPN suppl√©mentaires pour diff√©rents serveurs selon les instructions ci-dessus.  Vous n'avez pas besoin d'ajouter des certificats de CA et de serveur, nous s√©lectionnons ceux d√©j√† ajout√©s.  De plus, nous n'effectuons pas l'√©tape avec Pare-feu - R√®gles - LAN, nous le ferons plus tard.  Le nombre requis de clients est √©tabli empiriquement par les r√©sultats des mesures de vitesse √† travers chaque serveur s√©par√©. <br><br>  Une fois termin√©, nous devrions avoir l'image suivante: <br><br>  - En VPN - OpenVPN - Clients cr√©√©s et clients activ√©s <br><br><img src="https://habrastorage.org/webt/du/mq/jb/dumqjbjk-nlnypzt7zgp7eupe_e.png" alt="VPN - OpenVPN - Clients"><br><br>  - Interfaces - Affectation des interfaces cr√©√©es et activ√©es pour chaque client <br><br><img src="https://habrastorage.org/webt/xq/_h/hs/xq_hhsew-s8lmaqjhc19usecbrw.png" alt="Interfaces - Affectation"><br><br>  - En √©tat - OpenVPN, tous les clients sont √† l'√©tat ¬´haut¬ª <br><br><img src="https://habrastorage.org/webt/h7/05/h1/h705h1a6q8rzuwptjuvf4qf2kdw.png" alt="Statut - OpenVPN"><br><br>  - Les passerelles sont apparues dans Syst√®me - Routage, et les adresses IP ping sont indiqu√©es pour elles. <br>  (Si vous ne savez pas √† qui envoyer un ping, ouvrez shodan.io et trouvez toutes les adresses IP Google) <br><br><img src="https://habrastorage.org/webt/86/zk/6r/86zk6r-1ktp7rf4b-ndtfq-xxw0.png" alt="Syst√®me - Routage"><br><br>  Passons maintenant √† Syst√®me - Routage - Groupes de passerelles.  Cliquez sur Ajouter.  Entrez un nom m√©morable dans le nom du groupe. <br><br><img src="https://habrastorage.org/webt/el/f-/zs/elf-zss6x4cssjpthizwalp7hxw.png" alt="Syst√®me - Routage - Groupes de passerelles"><br><br>  Faites maintenant attention au tableau de priorit√© de la passerelle.  Les groupes de passerelles fonctionnent comme suit: basculement par niveau, √©quilibrage au sein d'un niveau.  La colonne Niveau indique √† quel niveau cette passerelle sera utilis√©e.  L'option la plus simple consiste √† sp√©cifier toutes les passerelles VPN actives au premier niveau.  L'option pour un Internet lent est de cr√©er deux clients et de les placer au premier et au deuxi√®me niveau, mais dans ce cas, il n'y aura qu'une tol√©rance aux pannes. <br><br>  Trouvez le niveau de d√©clenchement ci-dessous.  Il s'agit de la condition dans laquelle une exclusion temporaire de la passerelle du groupe se produit.  Des options autres que Member Down vous permettent d'arr√™ter d'envoyer des paquets √† la passerelle un peu plus t√¥t qu'elle ne tombe compl√®tement - en d√©passant le seuil de perte de paquets et / ou par un ping √©lev√©.  Les seuils de perte et de ping sont d√©finis pour chaque passerelle individuellement dans le syst√®me - Routage - Passerelle. <br><br>  Une fois que vous avez choisi une option pratique pour organiser les passerelles en niveaux, cliquez sur Enregistrer. <br><br>  Il est temps de transf√©rer le trafic vers un nouveau groupe de passerelles.  Nous allons dans le Pare-feu - R√®gles - LAN, ouvrons la r√®gle de redirection cr√©√©e pr√©c√©demment, descendons dans la liste des passerelles et voyons le groupe que nous avons cr√©√© dans cette liste.  Nous le s√©lectionnons, enregistrons la r√®gle et appliquons les modifications.  C'est tout, maintenant chaque nouvelle connexion passera par un nouveau client VPN dans le groupe. <br><br>  Temps de test: ouvrez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">api.ipify.me</a> , d√©sactivez le cache et maintenez-le en vie, puis rechargez la page.  Si vous √™tes le seul utilisateur du r√©seau, pour chaque mise √† jour de page, vous devriez voir une nouvelle adresse IP diff√©rente de celle de votre domicile.  Si vous voyez la m√™me adresse, actualisez compl√®tement la page avec Ctrl + F5 (Commande + Maj + R sur les coquelicots), ou ouvrez un nouvel onglet priv√©.  Si cela n'aide pas, cela signifie que quelque part, ils ont fait une erreur dans les param√®tres du groupe ou n'ont pas modifi√© la passerelle dans les r√®gles de pare-feu. <br><br>  Maintenant sur le mauvais.  Malheureusement, cette solution a un petit bug insaisissable si vous l'utilisez devant le routeur du r√©seau local (et non le switch).  T√¥t ou tard, l'un des clients VPN tombe, l'expulse du groupe, et tout va bien jusqu'√† ce que le VPN remonte.  √âtant donn√© que tous les utilisateurs sont derri√®re NAT et que le routeur VPN ne voit qu'une seule adresse IP et 65 000 ports, au fil du temps, il associe tous les ports √† ces clients VPN qui ne sont jamais tomb√©s.  En cons√©quence, d√®s que le client VPN augmente, aucun trafic ne le traverse.  Le client est compl√®tement vivant, des pings et une certaine quantit√© stable de trafic de service le traversent, mais le trafic client ne le traverse pas.  En th√©orie, cela serait r√©solu en r√©initialisant la table de connexion, et pour cela, il y a m√™me une coche dans les param√®tres pfSense, mais dans mes recherches, cette coche a compl√®tement bloqu√© tout acc√®s au routeur, car les clients ont commenc√© √† tomber par cycles, tout en supprimant les connexions nouvellement √©tablies du Web interface, ce qui a rendu tr√®s difficile la r√©solution du probl√®me.  Sans cette coche, s'il y a plus de deux VPN, ils s'√©quilibraient, de sorte que l'acc√®s par au moins un √©tait toujours l√†.  Au final, j'ai configur√© la condition de surveillance ¬´si cinq minutes sur l'interface avaient moins de 1000 octets de trafic par seconde, dites-moi¬ª, et dans les cas particuli√®rement avanc√©s, je red√©marre manuellement le client zombie VPN afin de r√©initialiser la table de connexion. <br><br>  Nous avons donc obtenu un r√©seau qui est compl√®tement pass√© par plusieurs VPN distribu√©s.  En raison de la combinaison de plusieurs serveurs VPN diff√©rents, nous ne d√©pendons pas de la disponibilit√© de chacun d'eux individuellement, et la vitesse du r√©seau n'est limit√©e que par le cryptage de votre canal moins.  Si tout √† coup, un routeur ne vous suffit pas - ils peuvent √©galement √™tre mis √† l'√©chelle, mais c'est un sujet pour un article s√©par√©. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr475068/">https://habr.com/ru/post/fr475068/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr475054/index.html">SAP sur Microsoft Azure Tour √† Moscou</a></li>
<li><a href="../fr475060/index.html">Cr√©ation d'un service de suivi d'appels simple, partie 2</a></li>
<li><a href="../fr475062/index.html">Pr√©sentation de la connexion avec Apple - Syst√®me d'autorisation Apple</a></li>
<li><a href="../fr475064/index.html">.NET Core 3 pour Windows Desktop</a></li>
<li><a href="../fr475066/index.html">Les Chroniques de la faim du livre</a></li>
<li><a href="../fr475072/index.html">Des stagiaires √† travers les yeux de l'entreprise</a></li>
<li><a href="../fr475074/index.html">Introduction √† ECMAScript 2017 (ES8)</a></li>
<li><a href="../fr475076/index.html">Super-h√©ros sovi√©tiques, boogers tch√®ques et clone australien</a></li>
<li><a href="../fr475078/index.html">Pr√©sentation des wrappers de propri√©t√© dans SwiftUI</a></li>
<li><a href="../fr475082/index.html">Habr Weekly # 26 / Semaine de travail de quatre jours, GitLab est entr√© en politique, Yandex teste le robot de livraison Rover</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>