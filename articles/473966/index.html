<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèΩ‚Äçü§ù‚Äçüë©üèª üôâ üçê A petici√≥n de los desarrolladores integrados: detecci√≥n de errores en Amazon FreeRTOS üç¨ üßöüèΩ üÜò</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Cualquiera que programe microcontroladores probablemente sepa sobre FreeRTOS, o al menos haya o√≠do hablar de este sistema operativo. Los desarrollador...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>A petici√≥n de los desarrolladores integrados: detecci√≥n de errores en Amazon FreeRTOS</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/473966/">  Cualquiera que programe microcontroladores probablemente sepa sobre FreeRTOS, o al menos haya o√≠do hablar de este sistema operativo.  Los desarrolladores de Amazon decidieron mejorar las capacidades de este sistema operativo para trabajar con los servicios de Internet de las cosas de AWS.  As√≠ es como apareci√≥ Amazon FreeRTOS.  A nosotros, los desarrolladores del analizador de c√≥digo est√°tico PVS-Studio, se nos solicit√≥ por correo y en comentarios para verificar estos proyectos.  Bueno, ahora obt√©n lo que pediste.  Sigue leyendo para descubrir qu√© sali√≥ de √©l. <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/cee/9b7/a98/cee9b7a984f45dc365b4baea89adb019.png"></div><br><a name="habracut"></a><br><h2>  Brevemente sobre proyectos </h2><br>  Para empezar, le contar√© un poco sobre el precursor del proyecto que se est√° probando: FreeRTOS (el c√≥digo fuente est√° disponible aqu√≠ por <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">enlace</a> ).  Como dice Wikipedia, FreeRTOS es un sistema operativo multitarea en tiempo real para sistemas integrados. <br><br>  Est√° escrito en buena C, lo cual no es sorprendente: este sistema operativo deber√≠a funcionar en condiciones t√≠picas de los microcontroladores: baja potencia de procesamiento, una peque√±a cantidad de RAM y similares.  El lenguaje C le permite trabajar con recursos en un nivel bajo y tiene un alto rendimiento, por lo que es el m√°s adecuado para desarrollar dicho sistema operativo. <br><br>  Ahora volvamos a Amazon, que siempre est√° en movimiento desarrollando varias direcciones prometedoras.  Por ejemplo, Amazon est√° desarrollando un motor AAA de Amazon Lumberyard, que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">tambi√©n</a> hemos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">verificado</a> . <br><br>  Una de esas direcciones es Internet de las cosas (IoT).  Para desarrollarse en esta √°rea, Amazon decidi√≥ escribir su propio sistema operativo, y tomaron el n√∫cleo de FreeRTOS como base. <br><br>  El sistema resultante, Amazon FreeRTOS, est√° en condiciones de "proporcionar una conexi√≥n segura a los servicios web de Amazon, como AWS IoT Core o AWS IoT Greengrass".  El c√≥digo fuente de este proyecto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">est√° disponible</a> en Github. <br><br>  En este art√≠culo, descubriremos si hay errores en FreeRTOS y qu√© tan seguro es el sistema operativo Amazon en t√©rminos de an√°lisis de c√≥digo est√°tico. <br><br><h2>  El curso del cheque </h2><br>  La verificaci√≥n se realiz√≥ utilizando la herramienta autom√°tica de b√∫squeda de errores: el analizador de c√≥digo est√°tico PVS-Studio.  Es capaz de detectar errores en programas escritos en C, C ++, C # y Java. <br><br>  Antes del an√°lisis, tenemos que construir el proyecto.  De esta manera, estar√© seguro de que tengo todas las dependencias necesarias y que el proyecto est√° listo para ser verificado.  Uno puede verificar el proyecto de varias maneras, por ejemplo, usando un sistema de monitoreo de compilaci√≥n.  En este caso, realic√© el an√°lisis usando el complemento para Visual Studio; es bueno que los repositorios de ambos proyectos contengan los conjuntos de archivos de proyecto que facilitan la compilaci√≥n en Windows. <br><br>  Solo ten√≠a que construir proyectos para asegurarme de tener todo listo para la verificaci√≥n.  Luego ejecut√© el an√°lisis y ¬°voila!  - Tengo un informe del analizador listo para usar delante de m√≠. <br><br>  Las bibliotecas de terceros incluidas en estos proyectos tambi√©n pueden contener errores y, por supuesto, tambi√©n pueden afectar el programa.  Sin embargo, los he excluido del an√°lisis en aras de la pureza de la narrativa. <br><br>  Entonces, los proyectos se analizan, se reciben informes, se resaltan errores interesantes.  ¬°Es hora de recibir su opini√≥n! <br><br><h2>  Lo que FreeRTOS esconde </h2><br>  Inicialmente, esperaba escribir dos art√≠culos separados: uno para cada sistema operativo.  Ya me estaba frotando las manos?  mientras me preparaba para escribir un buen art√≠culo sobre FreeRTOS.  Anticip√°ndome al descubrimiento de al menos un par de jugosos errores (como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">CWE-457</a> ), estaba buscando advertencias dispersas del analizador y ... no encontr√© nada.  No encontr√© ning√∫n error interesante. <br><br>  Muchas de las advertencias emitidas por el analizador no eran relevantes para FreeRTOS.  Por ejemplo, tales advertencias eran fallas de 64 bits, como <i>enviar</i> <i>size_t</i> a <i>uint32_t</i> .  Est√° relacionado con el hecho de que FreeRTOS est√° destinado a funcionar en dispositivos con un tama√±o de puntero no mayor de 32 bits. <br><br>  He revisado a fondo todas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">las</a> advertencias <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">V1027 que</a> indican fundiciones entre punteros a estructuras no relacionadas.  Si las estructuras fundidas tienen la misma alineaci√≥n, entonces tal lanzamiento es un error.  ¬°Y no he encontrado un solo casting peligroso! <br><br>  Todos los dem√°s lugares sospechosos estaban asociados con el estilo de codificaci√≥n o ten√≠an un comentario que explicaba por qu√© se hizo de esa manera y por qu√© no fue un error. <br><br>  As√≠ que me gustar√≠a hacer un llamamiento a los desarrolladores de FreeRTOS.  Chicos, ustedes son geniales!  Apenas hemos visto proyectos tan limpios y de alta calidad como los suyos.  Y fue un placer leer el c√≥digo limpio, ordenado y bien documentado.  Felicitaciones a ustedes chicos. <br><br>  Aunque no pude encontrar ning√∫n error interesante ese d√≠a, sab√≠a que no me detendr√≠a all√≠.  Iba a casa con la firme confianza de que la versi√≥n de Amazon tendr√≠a 100% algo interesante, y que ma√±ana definitivamente recoger√≠a suficientes errores para el art√≠culo.  Como habr√°s adivinado, ten√≠a raz√≥n. <br><br><h2>  Lo que oculta Amazon FreeRTOS </h2><br>  La versi√≥n de Amazon del sistema result√≥ ser ... para decirlo suavemente, un poco peor.  El legado de FreeRTOS permaneci√≥ limpio mientras que las nuevas mejoras ocultaron muchos temas interesantes. <br><br>  Algunos fragmentos ten√≠an la l√≥gica del programa rota, algunos manejaban punteros incorrectamente.  En algunos lugares, el c√≥digo podr√≠a conducir a un comportamiento indefinido, y hubo casos en los que el programador simplemente no sab√≠a sobre el patr√≥n de un error que cometi√≥.  Incluso encontr√© varias vulnerabilidades potenciales graves. <br><br>  Parece que me he endurecido con la introducci√≥n.  ¬°Comencemos a descubrir errores! <br><br><h3>  Romper la l√≥gica del programa. </h3><br>  Comencemos con los lugares problem√°ticos que obviamente indican que el programa no funciona de la manera que el programador esperaba.  El manejo sospechoso de arreglos vendr√° primero: <br><br><pre><code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/** * @brief Pool of request and associated response buffers, * handles, and configurations. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> _requestPool_t _requestPool = { <span class="hljs-number"><span class="hljs-number">0</span></span> }; .... <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _scheduleAsyncRequest(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> reqIndex, <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> currentRange) { .... <span class="hljs-comment"><span class="hljs-comment">/* Set the user private data to use in the asynchronous callback context. */</span></span> _requestPool.pRequestDatas[reqIndex].pConnHandle = &amp;_connHandle; _requestPool.pRequestDatas[reqIndex].pConnConfig = &amp;_connConfig; _requestPool.pRequestDatas[reqIndex].reqNum = reqIndex; _requestPool.pRequestDatas[reqIndex].currRange = currentRange; _requestPool.pRequestDatas[reqIndex].currDownloaded = <span class="hljs-number"><span class="hljs-number">0</span></span>; _requestPool.pRequestDatas[reqIndex].numReqBytes = numReqBytes; .... _requestPool.pRequestDatas-&gt;scheduled = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; .... }</code> </pre> <br>  PVS-Studio emiti√≥ dos advertencias para este c√≥digo: <br><br><ul><li>  V619 La matriz '_requestPool.pRequestDatas' se est√° utilizando como puntero a un solo objeto.  iot_demo_https_s3_download_async.c 973 </li><li>  V574 El puntero '_requestPool.pRequestDatas' se usa simult√°neamente como una matriz y como un puntero a un solo objeto.  Verifique las l√≠neas: 931, 973. iot_demo_https_s3_download_async.c 973 </li></ul><br>  Por si acaso, perm√≠teme recordarte: el nombre de la matriz es el puntero a su primer elemento.  Es decir, si <i>_requestPool.pRequestDatas</i> es una matriz de estructuras, <i>_requestPool.pRequestDatas [i] .scheduled</i> es una evaluaci√≥n para el miembro <i>planificado</i> de la estructura de matriz <i>i. Y</i> si escribimos <i>_requestPool.pRequestDatas-&gt; planificado</i> , resultar√° que Se acceder√° al miembro de la primera estructura de matriz. <br><br>  En el extracto del c√≥digo anterior, eso es lo que sucede.  En la √∫ltima l√≠nea, se cambia el valor de solo el miembro de la primera estructura de matriz.  En s√≠ mismo, dicho acceso ya es sospechoso, pero aqu√≠ el caso es a√∫n m√°s claro: la matriz <i>_requestPool.pRequestDatas</i> se eval√∫a por √≠ndice en todo el cuerpo de la funci√≥n.  Pero al final se olvid√≥ la operaci√≥n de indexaci√≥n. <br><br>  Seg√∫n tengo entendido, la √∫ltima l√≠nea deber√≠a verse as√≠: <br><br><pre> <code class="cpp hljs">_requestPool.pRequestDatas[reqIndex].scheduled = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;</code> </pre> <br>  El siguiente error radica en una peque√±a funci√≥n, as√≠ que lo dar√© por completo: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* Return true if the string " pcString" is found * inside the token pxTok in JSON file pcJson. */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> BaseType_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prvGGDJsoneq</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * pcJson, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">jsmntok_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pxTok, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * pcString )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> ulStringSize = ( <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> ) pxTok-&gt;end - ( <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> ) pxTok-&gt;start; BaseType_t xStatus = pdFALSE; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( pxTok-&gt;type == JSMN_STRING ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( ( <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> ) <span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>( pcString ) == ulStringSize ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( ( <span class="hljs-keyword"><span class="hljs-keyword">int16_t</span></span> ) <span class="hljs-built_in"><span class="hljs-built_in">strncmp</span></span>( &amp;pcJson[ pxTok-&gt;start ], <span class="hljs-comment"><span class="hljs-comment">// &lt;= pcString, ulStringSize ) == 0 ) { xStatus = pdTRUE; } } } return xStatus; }</span></span></code> </pre> <br>  <b>Advertencia de PVS-Studio:</b> V642 [CWE-197] Guardar el resultado de la funci√≥n 'strncmp' dentro de la variable de tipo 'corto' es inapropiado.  Los bits significativos podr√≠an perderse rompiendo la l√≥gica del programa.  aws_greengrass_discovery.c 637 <br><br>  Echemos un vistazo a la definici√≥n de la funci√≥n strncmp: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">strncmp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *lhs, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *rhs, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> count )</span></span></span></span>;</code> </pre> <br>  En el ejemplo, el resultado del tipo <i>int</i> , que tiene un tama√±o de 32 bits, se convierte en una variable del tipo <i>int16_t</i> .  Con esta conversi√≥n de "estrechamiento", se perder√°n los bits m√°s antiguos del valor devuelto.  Por ejemplo, si la funci√≥n <i>strncmp</i> devuelve <i>0x00010000</i> , la unidad se perder√° durante la conversi√≥n y se ejecutar√° la condici√≥n. <br><br>  En realidad, es extra√±o ver un casting as√≠ en la condici√≥n.  ¬øPor qu√© se necesita aqu√≠, si un <i>int</i> ordinario se puede comparar con cero?  Por otro lado, si un programador quer√≠a que esta funci√≥n a veces se volviera <i>verdadera</i> incluso si no deber√≠a, ¬øpor qu√© no apoyar un comportamiento tan complicado con un comentario?  Pero de esta manera es una especie de puerta trasera.  De todos modos, me inclino a pensar que es un error.  Que piensas <br><br><h3>  Comportamiento indefinido y punteros </h3><br>  Aqu√≠ viene un gran ejemplo.  Cubre una posible desreferencia de puntero nulo: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> _networkReceiveCallback(....) { IotHttpsReturnCode_t status = IOT_HTTPS_OK; _httpsResponse_t* pCurrentHttpsResponse = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; IotLink_t* pQItem = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; .... <span class="hljs-comment"><span class="hljs-comment">/* Get the response from the response queue. */</span></span> IotMutex_Lock(&amp;(pHttpsConnection-&gt;connectionMutex)); pQItem = IotDeQueue_PeekHead(&amp;(pHttpsConnection-&gt;respQ)); IotMutex_Unlock(&amp;(pHttpsConnection-&gt;connectionMutex)); <span class="hljs-comment"><span class="hljs-comment">/* If the receive callback is invoked * and there is no response expected, * then this a violation of the HTTP/1.1 protocol. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pQItem == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { IotLogError(....); fatalDisconnect = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; status = IOT_HTTPS_NETWORK_ERROR; <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> iotCleanup; } .... iotCleanup : <span class="hljs-comment"><span class="hljs-comment">/* Report errors back to the application. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (status != IOT_HTTPS_OK) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( pCurrentHttpsResponse-&gt;isAsync &amp;&amp; pCurrentHttpsResponse-&gt;pCallbacks-&gt;errorCallback) { pCurrentHttpsResponse-&gt;pCallbacks-&gt;errorCallback(....); } pCurrentHttpsResponse-&gt;syncStatus = status; } .... }</code> </pre> <br>  <b>Advertencia de PVS-Studio:</b> V522 [CWE-690] Puede haber una desreferenciaci√≥n de un puntero nulo potencial 'pCurrentHttpsResponse'.  iot_https_client.c 1184 <br><br>  El √∫ltimo bloque <i>if</i> contiene desreferencias problem√°ticas.  Veamos qu√© est√° pasando aqu√≠. <br><br>  La funci√≥n comienza con las variables <i>pCurrentHttpsResponse</i> y <i>pQItem</i> inicializadas por el valor <i>NULL</i> y la variable de <i>estado</i> se inicializa por el valor <i>IOT_HTTPS_OK</i> , lo que significa que todo es correcto. <br><br>  Adem√°s, a <i>pQItem</i> se le asigna el valor, devuelto por la funci√≥n <i>IotDeQueue_PeekHead</i> , que devuelve el puntero al comienzo de la cola de doble enlace. <br><br>  ¬øQu√© pasa si la cola est√° vac√≠a?  En este caso, la funci√≥n <i>IotDeQueue_PeekHead</i> devolver√° <i>NULL:</i> <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> IotLink_t* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IotDeQueue_PeekHead</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> IotDeQueue_t* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pQueue)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> IotListDouble_PeekHead(pQueue); } .... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> IotLink_t* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IotListDouble_PeekHead</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> IotListDouble_t* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pList)</span></span></span><span class="hljs-function"> </span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment">/* @[declare_linear_containers_list_double_peekhead] */</span></span></span><span class="hljs-function"> </span></span>{ IotLink_t* pHead = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pList != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (IotListDouble_IsEmpty(pList) == <span class="hljs-literal"><span class="hljs-literal">false</span></span>) { pHead = pList-&gt;pNext; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pHead; }</code> </pre> <br>  Adem√°s, la condici√≥n <i>pQItem == NULL se</i> har√° verdadera y el flujo de control pasar√° <i>goto</i> a la parte inferior de la funci√≥n.  En este momento, el puntero <i>pCurrentHttpsResponse</i> permanecer√° nulo, mientras que el <i>estado</i> no ser√° igual a <i>IOT_HTTPS_OK</i> .  Al final, llegaremos a lo mismo <i>si</i> rama, y ‚Äã‚Äã... ¬°boom!  Bueno, sabes sobre las consecuencias de tal desreferencia. <br><br>  Esta bien  Fue un ejemplo un poco complicado.  Ahora le sugiero que eche un vistazo a una desreferenciaci√≥n potencial muy simple y comprensible: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PKI_mbedTLSSignatureToPkcs11Signature</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * pxSignaturePKCS, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * pxMbedSignature )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> xReturn = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> * pxNextLength; <span class="hljs-comment"><span class="hljs-comment">/* The 4th byte contains the length of the R component */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> ucSigComponentLength = pxMbedSignature[ <span class="hljs-number"><span class="hljs-number">3</span></span> ]; <span class="hljs-comment"><span class="hljs-comment">// &lt;= if( ( pxSignaturePKCS == NULL ) || ( pxMbedSignature == NULL ) ) { xReturn = FAILURE; } .... }</span></span></code> </pre> <br>  <b>Advertencia de PVS-Studio:</b> V595 [CWE-476] El puntero 'pxMbedSignature' se utiliz√≥ antes de que se verificara contra nullptr.  L√≠neas de verificaci√≥n: 52, 54. iot_pki_utils.c 52 <br><br>  Esta funci√≥n recibe punteros a <i>uint8_t</i> .  Ambos punteros se comprueban para <i>NULL</i> , lo cual es una buena pr√°ctica, tales situaciones deben resolverse de inmediato. <br><br>  Pero aqu√≠ est√° el problema: para el momento en que <i>pxMbedSignature</i> est√© marcado, ya se habr√° desreferenciado literalmente una l√≠nea arriba.  Ta-daa! <br><br>  Otro ejemplo de c√≥digo especulativo: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">CK_RV </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">vAppendSHA256AlgorithmIdentifierSequence</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * x32ByteHashedMessage, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * x51ByteHashOidBuffer )</span></span></span><span class="hljs-function"> </span></span>{ CK_RV xResult = CKR_OK; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> xOidSequence[] = pkcs11STUFF_APPENDED_TO_RSA_SIG; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( ( x32ByteHashedMessage == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ) || ( x51ByteHashOidBuffer == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ) ) { xResult = CKR_ARGUMENTS_BAD; } <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>( x51ByteHashOidBuffer, xOidSequence, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>( xOidSequence ) ); <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>( &amp;x51ByteHashOidBuffer[ <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>( xOidSequence ) ], x32ByteHashedMessage, <span class="hljs-number"><span class="hljs-number">32</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> xResult; }</code> </pre> <br>  <b>Advertencias de PVS-Studio:</b> <br><br><ul><li>  V1004 [CWE-628] El puntero 'x51ByteHashOidBuffer' se us√≥ de manera insegura despu√©s de que se verific√≥ contra nullptr.  L√≠neas de verificaci√≥n: 275, 280. iot_pkcs11.c 280 </li><li>  V1004 [CWE-628] El puntero 'x32ByteHashedMessage' se us√≥ de forma insegura despu√©s de que se verific√≥ contra nullptr.  L√≠neas de verificaci√≥n: 275, 281. iot_pkcs11.c 281 </li></ul><br>  El analizador advierte que los par√°metros de funci√≥n que son punteros, se usan de forma no segura despu√©s de su comprobaci√≥n de <i>NULL</i> .  De hecho, los argumentos est√°n marcados.  Pero en caso de que alguno de ellos no sea <i>NULL</i> , no se tomar√° ninguna acci√≥n excepto escribir en <i>xResult.</i>  Esta secci√≥n del c√≥digo dice: "S√≠, entonces los argumentos resultaron ser malos.  Vamos a notarlo ahora, y t√∫ ... sigue, sigue. <br><br>  Resultado: <i>NULL se</i> pasar√° a <i>memcpy.</i>  ¬øQu√© puede salir de eso?  ¬øD√≥nde se copiar√°n los valores y cu√°les?  De hecho, adivinar no ayudar√°, ya que el est√°ndar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">establece claramente</a> que tal llamada conduce a un comportamiento indefinido (consulte la secci√≥n 1). <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/cf7/7d6/856/cf77d6856666f6a1529a1744832bd5bf.png" alt="Figura 3"></div><br><br>  Hay otros ejemplos de manejo de punteros incorrectos en el informe del analizador que se encuentra en Amazon FreeRTOS, pero creo que los ejemplos dados son suficientes para mostrar las capacidades de PVS-Studio en la detecci√≥n de tales errores.  Echemos un vistazo a algo nuevo. <br><br><h3>  ¬°VERDADERO! = 1 </h3><br>  Hubo varios errores relacionados con el patr√≥n, que, desafortunadamente, a menudo se pasa por alto. <br><br>  El hecho es que el tipo <i>bool</i> (de C ++) es diferente del tipo <i>BOOL</i> (com√∫nmente usado en C).  El primero solo puede contener un valor <i>verdadero</i> o <i>falso</i> .  El segundo es el typedef de un tipo entero ( <i>int</i> , <i>long</i> y otros).  El valor <i>0</i> es "falso" y cualquier otro valor diferente de cero es "verdadero". <br><br>  Como no hay un tipo booleano incorporado en C, estas constantes se definen por conveniencia: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> FALSE 0 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> TRUE 1</span></span></code> </pre> <br>  Veamos el ejemplo. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mbedtls_hardware_poll</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">* data, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* output, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> len, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* olen)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> lStatus = MBEDTLS_ERR_ENTROPY_SOURCE_FAILED; HCRYPTPROV hProv = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* Unferenced parameter. */</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)data; <span class="hljs-comment"><span class="hljs-comment">/* * This is port-specific for the Windows simulator, * so just use Crypto API. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (TRUE == CryptAcquireContextA( &amp;hProv, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, PROV_RSA_FULL, CRYPT_VERIFYCONTEXT)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (TRUE == CryptGenRandom(hProv, len, output)) { lStatus = <span class="hljs-number"><span class="hljs-number">0</span></span>; *olen = len; } CryptReleaseContext(hProv, <span class="hljs-number"><span class="hljs-number">0</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> lStatus; }</code> </pre> <br>  <b>Advertencias de PVS-Studio:</b> <br><br><ul><li>  V676 [CWE-253] Es incorrecto comparar la variable de tipo BOOL con TRUE.  aws_entropy_hardware_poll.c 48 </li><li>  V676 [CWE-253] Es incorrecto comparar la variable de tipo BOOL con TRUE.  La expresi√≥n correcta es: 'FALSE! = CryptGenRandom (hProv, len, output)'.  aws_entropy_hardware_poll.c 51 </li></ul><br>  ¬øEncontr√≥ un error?  No lo dude, est√° aqu√≠ :) Las funciones <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><i>CryptAcquireContextA</i></a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><i>CryptGenRandom</i></a> son funciones est√°ndar del encabezado <i>wincrypt.h</i> .  Si tiene √©xito, devuelven el valor distinto de cero.  Perm√≠tanme enfatizar que no es <i>cero</i> .  Entonces, te√≥ricamente, podr√≠a ser cualquier valor diferente de cero: <i>1</i> , <i>314</i> , <i>42</i> , <i>420</i> . <br><br>  Aparentemente, el programador que estaba escribiendo la funci√≥n del ejemplo, no estaba pensando en eso, y al final, los valores resultantes se comparan con uno. <br><br>  ¬øQu√© posibilidades hay de que no se cumpla la condici√≥n <i>TRUE == CryptGenRandom (....)</i> ?  Es dificil de decir.  Quiz√°s, <i>CryptGenRandom</i> podr√≠a devolver 1 m√°s a menudo que otros valores, pero tal vez podr√≠a devolver solo 1. No podemos saber esto con certeza: la implementaci√≥n de esta funci√≥n criptogr√°fica est√° oculta a los ojos de los programadores mortales :) <br><br>  Es importante recordar que tales comparaciones son potencialmente peligrosas.  En lugar de: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (TRUE == GetBOOL())</code> </pre> <br>  Use una versi√≥n m√°s segura del c√≥digo: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (FALSE != GetBOOL())</code> </pre> <br><h3>  Problemas de optimizaci√≥n </h3><br>  Varias advertencias del analizador estaban relacionadas con estructuras de funcionamiento lento.  Por ejemplo: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _IotHttpsDemo_GetS3ObjectFileSize(....) { .... pFileSizeStr = <span class="hljs-built_in"><span class="hljs-built_in">strstr</span></span>(contentRangeValStr, <span class="hljs-string"><span class="hljs-string">"/"</span></span>); .... }</code> </pre> <br>  <b>Advertencia de PVS-Studio:</b> V817 Es m√°s eficiente buscar el car√°cter '/' en lugar de una cadena.  iot_demo_https_common.c 205 <br><br>  Es corto y simple, ¬øno?  La funci√≥n <i>strstr</i> se usa aqu√≠ para buscar solo un car√°cter, pasado en el par√°metro como una cadena (est√° entre comillas dobles). <br><br>  Este lugar puede optimizarse potencialmente reemplazando <i>strstr</i> por <i>strchr</i> : <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _IotHttpsDemo_GetS3ObjectFileSize(....) { .... pFileSizeStr = <span class="hljs-built_in"><span class="hljs-built_in">strchr</span></span>(contentRangeValStr, <span class="hljs-string"><span class="hljs-string">'/'</span></span>); .... }</code> </pre> <br>  De esta manera, la b√∫squeda funcionar√° un poco m√°s r√°pido.  Una cosa peque√±a pero agradable. <br><br>  Bueno, tales optimizaciones son buenas, pero el analizador tambi√©n ha encontrado otro lugar, que podr√≠a optimizarse de una manera mucho m√°s notable: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">vRunOTAUpdateDemo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (; ; ) { .... xConnectInfo.cleanSession = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; xConnectInfo.clientIdentifierLength = (<span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span>)<span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>(clientcredentialIOT_THING_NAME); xConnectInfo.pClientIdentifier = clientcredentialIOT_THING_NAME; .... } }</code> </pre> <br>  <b>Advertencia de PVS-Studio:</b> V814 Disminuci√≥n del rendimiento.  La funci√≥n 'strlen' se llam√≥ varias veces dentro del cuerpo de un bucle.  aws_iot_ota_update_demo.c 235 <br><br>  Hmm ... Dentro del bucle, con cada iteraci√≥n se llama <i>strlen</i> que eval√∫a la longitud de la misma l√≠nea cada vez.  No es la operaci√≥n m√°s efectiva :) <br><br>  Echemos un vistazo a la definici√≥n de <i>clientcredentialIOT_THING_NAME</i> : <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* * @brief Host name. * * @todo Set this to the unique name of your IoT Thing. */</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> clientcredentialIOT_THING_NAME </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">""</span></span></span></span></code> </pre> <br>  Se le pide al usuario que ingrese el nombre de su dispositivo aqu√≠.  Por defecto, est√° vac√≠o, y en este caso, todo est√° bien.  ¬øQu√© sucede si un usuario desea ingresar un nombre largo y hermoso all√≠?  Por ejemplo, me encantar√≠a llamar a mi creaci√≥n " <i>La m√°quina de caf√© apasionada y sofisticada BarBarista-N061E The Ultimate Edition</i> ".  ¬øTe imaginas c√≥mo ser√≠a mi sorpresa si mi hermosa cafetera comenzara a funcionar un poco m√°s despacio despu√©s de eso?  Molestia! <br><br>  Para corregir el error, vale la pena <i>sacarlo</i> fuera del bucle del cuerpo.  Despu√©s de todo, el nombre del dispositivo no cambia durante el funcionamiento del programa.  Oh, <i>constexpr</i> de C ++ <i>encajar√≠a</i> perfectamente aqu√≠ ... <br><br>  De acuerdo, bueno, no le demos al lirio.  Como not√≥ mi colega Andrey Karpov, los compiladores modernos saben lo que se <i>pierde</i> y √©l personalmente los observ√≥ usando una constante en c√≥digo binario si logran que la longitud de la l√≠nea no pueda cambiar.  Por lo tanto, existe una buena posibilidad de que en el modo de compilaci√≥n de lanzamiento, en lugar de una evaluaci√≥n de longitud de l√≠nea real, se use el valor preevaluado.  Sin embargo, esto no siempre funciona, por lo que escribir dicho c√≥digo no es una buena pr√°ctica. <br><br><h2>  Algunas palabras sobre MISRA </h2><br>  El analizador PVS-Studio tiene un gran conjunto de reglas para verificar que su c√≥digo cumpla con los est√°ndares MISRA C y MISRA C.  ¬øCu√°les son estos est√°ndares? <br><br>  MISRA es el est√°ndar de codificaci√≥n para sistemas integrados altamente responsables.  Contiene un conjunto de reglas y pautas estrictas para escribir c√≥digo y configurar un proceso de desarrollo.  Estas reglas son bastante numerosas y est√°n destinadas no solo a eliminar errores graves, sino tambi√©n a varios "olores de c√≥digo".  Tambi√©n est√° dirigido a escribir el c√≥digo m√°s comprensible y legible. <br><br>  Por lo tanto, el siguiente est√°ndar MISRA no solo ayuda a evitar errores y vulnerabilidades, sino tambi√©n a reducir significativamente la probabilidad de que aparezcan en el c√≥digo ya existente. <br><br>  MISRA se utiliza en las industrias aeroespacial, m√©dica, automotriz y militar, donde la vida humana depende de la calidad del software incorporado. <br><br>  Aparentemente, los desarrolladores de Amazon FreeRTOS conocen este est√°ndar y, en su mayor parte, lo siguen.  Tal enfoque es absolutamente razonable: si escribe un sistema operativo de base amplia para sistemas integrados, debe pensar en la seguridad. <br><br>  Sin embargo, he encontrado bastantes violaciones del est√°ndar MISRA.  No voy a dar ejemplos de reglas como "no usar uni√≥n" o "la funci√≥n solo debe tener un retorno al final del cuerpo"; desafortunadamente, no son espectaculares, como lo son la mayor√≠a de las reglas de MISRA.  Prefiero darle ejemplos de infracciones que podr√≠an tener graves consecuencias. <br><br>  Comencemos con las macros: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> FreeRTOS_ms_to_tick(ms) ( ( ms * configTICK_RATE_HZ + 500 ) / 1000 )</span></span></code> </pre> <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SOCKETS_htonl( ulIn ) ( ( uint32_t ) \ ( ( ( ulIn &amp; 0xFF ) </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;&lt; 24 ) | ( ( ulIn &amp; 0xFF00 ) &lt;&lt; 8 ) \ | ( ( ulIn &amp; 0xFF0000 ) &gt;&gt; 8 ) | ( ( ulIn &amp; 0xFF000000 ) &gt;&gt; 24 ) ) )</span></span></span></span></code> </pre> <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LEFT_ROTATE( x, c ) ( ( x </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;&lt; c ) | ( x &gt;&gt; ( 32 - c ) ) )</span></span></span></span></code> </pre> <br>  <b>Advertencias de PVS-Studio:</b> <br><br><ul><li>  V2546 [MISRA C 20.7] La ‚Äã‚Äãmacro y sus par√°metros deben encerrarse entre par√©ntesis.  Considere inspeccionar el par√°metro 'ms' de la macro 'FreeRTOS_ms_to_tick'.  FreeRTOS_IP.h 201 </li><li>  V2546 [MISRA C 20.7] La ‚Äã‚Äãmacro y sus par√°metros deben encerrarse entre par√©ntesis.  Considere inspeccionar el par√°metro 'ulIn' de la macro 'SOCKETS_htonl'.  iot_secure_sockets.h 512 </li><li>  V2546 [MISRA C 20.7] La ‚Äã‚Äãmacro y sus par√°metros deben encerrarse entre par√©ntesis.  Considere inspeccionar los par√°metros 'x', 'c' de la macro 'LEFT_ROTATE'.  iot_device_metrics.c 90 </li></ul><br>  S√≠, eso es exactamente lo que est√°s pensando.  Los par√°metros de estas macros no est√°n entre corchetes.  Si alguien escribe accidentalmente algo como <br><br><pre> <code class="cpp hljs">val = LEFT_ROTATE(A[i] | <span class="hljs-number"><span class="hljs-number">1</span></span>, B);</code> </pre> <br>  tal "llamada" de una macro se expandir√° en: <br><br><pre> <code class="cpp hljs">val = ( ( A[i] | <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; B ) | ( A[i] | <span class="hljs-number"><span class="hljs-number">1</span></span> &gt;&gt; ( <span class="hljs-number"><span class="hljs-number">32</span></span> - B ) ) );</code> </pre> <br>  ¬øRecuerdas las prioridades de las operaciones?  Primero, se realiza un cambio a nivel de bits, y solo despu√©s de eso, un "o" a nivel de bits.  Por lo tanto, la l√≥gica del programa se romper√°.  Un ejemplo m√°s simple: ¬øqu√© pasar√≠a si se pasa la expresi√≥n " <i>x + y</i> " en la macro <i>FreeRTOS_ms_to_tick</i> ?  Uno de los principales objetivos de MISRA es prevenir tales situaciones. <br><br>  Algunos podr√≠an argumentar: "Si tienes programadores que no saben sobre esto, ¬°ning√∫n est√°ndar puede ayudarte!"  No estar√© de acuerdo con eso.  Los programadores tambi√©n son personas, y no importa cu√°n experimentada sea una persona, tambi√©n pueden cansarse y cometer un error al final del d√≠a.  Esta es una de las razones por las cuales MISRA recomienda encarecidamente utilizar herramientas de an√°lisis autom√°tico para probar el cumplimiento de un proyecto. <br><br>  Perm√≠tanme dirigirme a los desarrolladores de Amazon FreeRTOS: PVS-Studio ha encontrado 12 macros inseguras m√°s, por lo que es necesario tener cuidado con ellas :) <br><br>  Otra violaci√≥n interesante de MISRA: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/** * @brief Callback for an asynchronous request to notify * that the response is complete. * * @param[in] 0pPrivData - User private data configured * with the HTTPS Client library request configuration. * @param[in] respHandle - Identifier for the current response finished. * @param[in] rc - Return code from the HTTPS Client Library * signaling a possible error. * @param[in] status - The HTTP response status. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> _responseCompleteCallback(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>* pPrivData, IotHttpsResponseHandle_t respHandle, IotHttpsReturnCode_t rc, <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> status) { <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>* pUploadSuccess = (<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>*)pPrivData; <span class="hljs-comment"><span class="hljs-comment">/* When the remote server response with 200 OK, the file was successfully uploaded. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (status == IOT_HTTPS_STATUS_OK) { *pUploadSuccess = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { *pUploadSuccess = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/* Post to the semaphore that the upload is finished. */</span></span> IotSemaphore_Post(&amp;(_uploadFinishedSem)); }</code> </pre> <br>  ¬øPuedes encontrar el error t√∫ mismo? <br><br>  <b>Advertencia de PVS-Studio:</b> V2537 [MISRA C 2.7] Las funciones no deben tener par√°metros no utilizados.  Considere inspeccionar el par√°metro: 'rc'.  iot_demo_https_s3_upload_async.c 234 <br><br>  Eche un vistazo m√°s de cerca: el par√°metro <i>rc</i> no se usa en ninguna parte del cuerpo de la funci√≥n.  Si bien el comentario de la funci√≥n dice claramente que este par√°metro es un c√≥digo de retorno de otra funci√≥n, y que puede indicar un error.  ¬øPor qu√© no se maneja este par√°metro de ninguna manera?  Algo est√° claramente mal aqu√≠. <br><br>  Sin embargo, incluso sin tales comentarios, los par√°metros no utilizados a menudo apuntan a la l√≥gica rota del programa.  De lo contrario, ¬øpor qu√© los necesita en la firma de la funci√≥n? <br><br>  Aqu√≠ he dado una peque√±a funci√≥n que es buena para un ejemplo en el art√≠culo.  Adem√°s de eso, encontr√© otros 10 par√°metros no utilizados.  Muchos de ellos se utilizan en funciones m√°s grandes, y no es f√°cil detectarlos. <br><br>  Sospechosamente, no se han encontrado antes.  Despu√©s de todo, los compiladores detectan f√°cilmente tales casos. <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b80/6c7/bb9/b806c7bb94c335ce2712e9b46cffc560.png" alt="Figura 1"></div><br><br><h2>  Conclusi√≥n </h2><br>  Estos no fueron todos los problemas encontrados por el analizador, pero el art√≠culo ya result√≥ ser bastante extenso.  Espero que, gracias a √©l, los desarrolladores de Amazon FreeRTOS puedan corregir algunas deficiencias e incluso quieran <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">probar PVS-Studio</a> por su cuenta.  De esta manera, ser√° m√°s conveniente investigar a fondo las advertencias.  Y, de hecho, trabajar con una interfaz conveniente es mucho m√°s f√°cil que mirar un informe de texto. <br><br>  ¬°Gracias por leer nuestros art√≠culos!  Nos vemos en la pr√≥xima publicaci√≥n: D <br><br>  PD: Dio la casualidad de que este art√≠culo fue publicado el 31 de octubre. ¬°Feliz Halloween, chicos y chicas! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/473966/">https://habr.com/ru/post/473966/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../473952/index.html">Mientras escrib√≠a AI para la estrategia por turnos</a></li>
<li><a href="../473956/index.html">Informaci√≥n secreta de una compa√±√≠a telef√≥nica de traficantes de drogas</a></li>
<li><a href="../473958/index.html">Japoneses de NICT introdujeron un cluster de fibra funcional con un ancho de banda de 1 Pbit / s</a></li>
<li><a href="../473960/index.html">Estrategias de localizaci√≥n de contenido</a></li>
<li><a href="../473962/index.html">El modo oscuro ahora est√° en todas partes. ¬øEs tan √∫til? (al final de la encuesta posterior)</a></li>
<li><a href="../473972/index.html">Por orden de desarrolladores integrados: buscando errores en Amazon FreeRTOS</a></li>
<li><a href="../473974/index.html">Intercom'19: una conferencia sobre automatizaci√≥n de comunicaciones de Voximplant se llevar√° a cabo el 14 de noviembre</a></li>
<li><a href="../473976/index.html">AWS Elasticsearch: producto fundamentalmente defectuoso</a></li>
<li><a href="../473978/index.html">Tal dolor, tal dolor, caja registradora como servicio 2: 0</a></li>
<li><a href="../473980/index.html">La tecnolog√≠a y el mundo real: 4 nuevas empresas que est√°n cambiando el futuro del dise√±o de interiores</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>