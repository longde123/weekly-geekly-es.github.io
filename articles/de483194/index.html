<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëãüèæ ‚òÅÔ∏è ‚è∏Ô∏è Bot gegen Geb√ºhr. Mit neuen Technologien zum Fu√üball gehen ‚ôêÔ∏è üõÇ üíç</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Einleitung 


 Hallo allerseits. In diesem Artikel beschreibe ich meinen Chatbot f√ºr den Telegrammnachrichtendienst und das soziale Netzwerk von VK un...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Bot gegen Geb√ºhr. Mit neuen Technologien zum Fu√üball gehen</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/483194/"><h2 id="vvedenie">  Einleitung </h2><br><p>  Hallo allerseits.  In diesem Artikel beschreibe ich meinen Chatbot f√ºr den Telegrammnachrichtendienst und das soziale Netzwerk von VK unter Verwendung von NodeJS. </p><br><p>  An dieser Stelle sollten viele Leser etwas ausbrechen: "Wie lange!"  oder "Was nochmal?!" <br>  Ja, √§hnliche Ver√∂ffentlichungen gab es bereits auf einer habr darunter.  Trotzdem glaube ich, dass der Artikel n√ºtzlich sein wird.  Kurz darauf, was die technische Implementierung des Bots darstellt: </p><br><ol><li>  Als Framework f√ºr die Anwendung gewinnt das <a href="https://nestjs.com/">NestJS-</a> Framework zunehmend an Beliebtheit. </li><li>  Die <a href="https://www.npmjs.com/package/telegraf">Telegraf-</a> Bibliothek f√ºr die Interaktion mit der Telegramm-API. </li><li>  Die <a href="https://www.npmjs.com/package/node-vk-bot-api">node-vk-bot-api-</a> Bibliothek f√ºr die Interaktion mit der VK-API. </li><li>  <a href="https://www.npmjs.com/package/typeorm">Typeorm-</a> Bibliothek zum Organisieren der Datenspeicherschicht. </li><li>  Tests mit <a href="https://www.npmjs.com/package/mocha">Mokka</a> und der Chai- <a href="https://www.npmjs.com/package/chai">Assert-</a> Bibliothek. </li><li>  CI mit Travis CI zum Testen und GitHub-Aktionen zum Bereitstellen von Docker-Images. </li></ol><br><p>  Als Nebenjob wollen wir versuchen, unsere Bot-Freunde mit Viber zusammenzubringen, um es so universell f√ºr die Verwendung in mehreren Messaging-Diensten zu machen. </p><br><p>  F√ºr diejenigen, die wissen wollen, was daraus wurde, ist cat willkommen. </p><a name="habracut"></a><br><h2 id="postanovka-zadachi">  Erkl√§rung des Problems </h2><br><p>  Als n√ºtzliche k√∂rperliche Aktivit√§t bevorzuge ich Fu√üball.  Nat√ºrlich auf Amateurebene.  Als Mitglied mehrerer Kan√§le und Chats in VK, Viber und Telegramm muss man oft folgendes Bild sehen: </p><br><p><img src="https://habrastorage.org/webt/jt/c7/h8/jtc7h8oxebenbzwymug3y2oi0oo.png" alt="Bild"></p><br><p>  Was wir hier sehen: </p><br><ol><li>  "P" f√ºgte sich hinzu. </li><li>  Nach ihm kamen 3 weitere Personen hinzu, darunter ein bestimmtes "C". </li><li>  "P" f√ºgte hinzu, sein Kamerad namens "Dimon". </li><li>  Danach war "P" nicht zu faul und errechnete, dass es im Moment bereits 5 Leute gibt. </li><li>  Diese Informationen waren jedoch nicht lange relevant, da ich mich auch dazu entschlossen habe, sie selbst auszuf√ºhren und hinzuzuf√ºgen. </li></ol><br><p>  In besonders vernachl√§ssigten F√§llen k√∂nnen Personen ein ‚Äû+‚Äú setzen und dann ihre Teilnahme stornieren, Freunde einladen, die nicht aus dem Chat kommen, oder sich f√ºr andere Chat-Teilnehmer anmelden und andere Aktivit√§ten ausf√ºhren.  Am Ende f√ºhrt dies dazu, dass, wenn irgendwann jeder zum Spielen kommt, sich herausstellt, dass: </p><br><ol><li>  Vasya hat +1 gesetzt, was nicht nur ihn selbst, sondern auch seinen Freund Gosh bedeutet. </li><li>  Kolya schrieb, dass er kommen w√ºrde, aber der Veranstalter Spiridon betrachtete mit seinen Augen nur die Pluspunkte. </li></ol><br><p>  Infolgedessen haben wir m√∂glicherweise eine ungleiche Anzahl von Teams, "Extra Gosh" und unerwartet erschien Kolya. </p><br><p>  Um solche Kollisionen zu vermeiden, habe ich einen einfachen Bot geschrieben, mit dem sich die Zusammensetzung der Teilnehmer im kommenden Spiel visuell darstellen l√§sst und der bequem hinzugef√ºgt / gel√∂scht werden kann. </p><br><p>  In meiner Grundimplementierung sollte der Bot meiner Meinung nach in der Lage sein: </p><br><ol><li>  In beliebig viele Chats eingebettet sein.  Speichern Sie Ihren Status f√ºr jeden Chat separat. </li><li>  Erstellen Sie <em>mit dem</em> Befehl <em>/ event_add</em> ein neues aktives Ereignis mit bestimmten Informationen und einer leeren Liste von Spielern.  Das zuvor aktive Ereignis sollte inaktiv werden. </li><li>  Der <em>Befehl / event_remove</em> sollte das derzeit aktive Ereignis abbrechen. </li><li>  Der Befehl <em>/ add</em> sollte dem aktuell aktiven Ereignis ein neues Mitglied hinzuf√ºgen.  Wenn der Befehl ohne zus√§tzlichen Text aufgerufen wird, sollte au√üerdem derjenige hinzugef√ºgt werden, der den Befehl eingegeben hat.  Andernfalls wird eine Person hinzugef√ºgt, deren Name beim Aufruf des Befehls angegeben wird. </li><li>  Mit dem Befehl <em>/ remove</em> wird eine Person gem√§√ü den f√ºr den Befehl <em>/ add</em> beschriebenen Regeln aus der Teilnehmerliste entfernt. </li><li>  Mit dem Befehl <em>/ info</em> k√∂nnen Sie sehen, wer sich bereits f√ºr das Spiel angemeldet hat. </li><li>  Es ist √§u√üerst w√ºnschenswert, dass der Bot in derselben Sprache wie der konfigurierte Player antwortet (oder standardm√§√üig in Englisch). </li></ol><br><p>  Um schnell zu sehen, was am Ende passiert ist, k√∂nnen Sie sofort zum letzten Abschnitt "Ergebnis und Schlussfolgerungen" gehen.  Wenn Sie an Implementierungsdetails interessiert sind, werden diese Informationen im Folgenden ausreichend detailliert beschrieben. </p><br><h2 id="proektirovanie-i-razrabotka">  Design und Entwicklung </h2><br><p>  Beim Entwerfen der Anwendung tauchte in meinem Kopf das folgende Schema auf: </p><br><p><img src="https://habrastorage.org/webt/v7/j4/gz/v7j4gzjufgbeuayina59yy8blia.jpeg" alt="Bild"></p><br><p>  Hier bestand die Hauptidee darin, alle Einzelheiten der Arbeit mit verschiedenen Nachrichtensystemen in die entsprechenden Adapter zu integrieren und die Logik der Interaktion mit Bibliotheken zusammenzufassen, die die entsprechenden APIs implementieren, Daten verarbeiten und in ein einziges Formular bringen. </p><br><h3 id="interfeys-i-modeli-soobscheniy">  Schnittstellen- und Nachrichtenmodelle </h3><br><p>  F√ºr Nachrichten konnte die folgende <em>IMessage-</em> Schnittstelle entworfen werden, die von Klassen erf√ºllt wird, die eingehende Nachrichtendaten f√ºr verschiedene Systeme und Methoden zum Arbeiten mit diesen Daten speichern: </p><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> interface IMessage { <span class="hljs-attr"><span class="hljs-attr">chatId</span></span>: number; lang: string; text: string; fullText: string; command: string; name: string; getReplyStatus: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> string; getReplyData: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> any; setStatus: <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">status: string</span></span></span><span class="hljs-function">) =&gt;</span></span> IMessage; withData: <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data: any</span></span></span><span class="hljs-function">) =&gt;</span></span> IMessage; answer: <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">args: any</span></span></span><span class="hljs-function">) =&gt;</span></span> string | <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>; }</code> </pre> <br><p>  Die Basisklasse <em>BaseMessage</em> , die diese Schnittstelle implementiert, hat die folgende Form: </p><br><div class="spoiler">  <b class="spoiler_title">Basisnachricht</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {IMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/i-message'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseMessage</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IMessage</span></span></span><span class="hljs-class"> </span></span>{ public chatId: number; public lang: string; public text: string; public fullText: string; public command: string; protected firstName: string; protected lastName: string; protected replyStatus: string; protected replyData: any; get name(): string { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> firstName: string = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.firstName || <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> lastName: string = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.lastName || <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${firstName}</span></span></span><span class="hljs-string"> </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${lastName}</span></span></span><span class="hljs-string">`</span></span>.trim(); } public getReplyStatus(): string { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.replyStatus; } public getReplyData(): any { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.replyData; } public setStatus(status: string): IMessage { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.replyStatus = status; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } public withData(data: any): IMessage { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.replyData = data; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } public answer(args: any): string | <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">'not implemented'</span></span>); } } }</code> </pre> </div></div><br><p>  Nachrichtenklasse f√ºr Telegramm: </p><br><div class="spoiler">  <b class="spoiler_title">Telegrammnachricht</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {BaseMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/base.message'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {IMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/i-message'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TelegramMessage</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseMessage</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IMessage</span></span></span><span class="hljs-class"> </span></span>{ private ctx: any; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(ctx) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ctx = ctx; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> {message} = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ctx.update; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.chatId = message.chat.id; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fullText = message.text; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.command = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ctx.command; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.text = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fullText.replace(<span class="hljs-string"><span class="hljs-string">`/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${</span></span><span class="hljs-keyword"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-string"><span class="hljs-subst">.command}</span></span></span><span class="hljs-string">`</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.lang = message.from.language_code; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.firstName = message.from.first_name; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.lastName = message.from.last_name; } public answer(args: any): string | <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ctx.replyWithHTML(args); } }</code> </pre> </div></div><br><p>  und f√ºr VK: </p><br><div class="spoiler">  <b class="spoiler_title">VKMessage</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {BaseMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/base.message'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {IMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/i-message'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">VKMessage</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseMessage</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IMessage</span></span></span><span class="hljs-class"> </span></span>{ private ctx: any; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(ctx) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ctx = ctx; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> {message} = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ctx; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.chatId = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getChatId(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ctx); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fullText = message.text; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.command = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ctx.command; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.text = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fullText.replace(<span class="hljs-string"><span class="hljs-string">`/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${</span></span><span class="hljs-keyword"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-string"><span class="hljs-subst">.command}</span></span></span><span class="hljs-string">`</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.lang = <span class="hljs-string"><span class="hljs-string">'ru'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.firstName = message.from.first_name; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.lastName = message.from.last_name; } public answer(args: any) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> answer: string = <span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${args}</span></span></span><span class="hljs-string">`</span></span>.replace(<span class="hljs-regexp"><span class="hljs-regexp">/&lt;\/?(strong|i)&gt;/gm</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ctx.reply(answer); } private getChatId({message, bot}): number { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> peerId: number = +<span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${message.peer_id}</span></span></span><span class="hljs-string">`</span></span>.replace(<span class="hljs-regexp"><span class="hljs-regexp">/[0-9]0+/</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> groupId: number = bot.settings.group_id; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> peerId + groupId; } }</code> </pre> </div></div><br><p>  Was Sie beachten sollten: </p><br><ol><li><p>  <em>chatId</em> ist die eindeutige Kennung f√ºr den Chat.  F√ºr Telegramm kommt es explizit in die Struktur jeder Nachricht.  Bei VK gibt es eine solche Kennung jedoch nicht explizit.  Wie zu sein  Um diese Frage zu beantworten, m√ºssen Sie verstehen, wie der Bot in VK funktioniert.  In diesem System handelt ein Bot in der Gruppenkorrespondenz im Namen der Community, f√ºr die er gestartet wurde.  Das hei√üt  Jede Bot-Nachricht enth√§lt eine <em>group_id-</em> Community- <em>ID</em> .  Zus√§tzlich kommt <em>peer_id</em> in der Nachricht (weitere Details k√∂nnen hier gelesen <a href="">werden</a> ) als die Kennung der Gruppenkonversation in unserem Fall.  Basierend auf diesen beiden IDs k√∂nnen Sie Ihre Chat-ID wie folgt erstellen: </p><br><pre> <code class="javascript hljs">private getChatId({message, bot}): number { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> peerId: number = +(<span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${message.peer_id}</span></span></span><span class="hljs-string">`</span></span>.replace(<span class="hljs-regexp"><span class="hljs-regexp">/[0-9]0+/</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> groupId: number = bot.settings.group_id; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> peerId + groupId; }</code> </pre> <br><p>  Diese Methode ist sicherlich nicht perfekt, aber auf die aktuelle Aufgabe anwendbar. </p><br></li><li><p>  <em>fullText</em> und <em>text</em> .  Wie der Name der Variablen <em>angibt</em> , enth√§lt <em>fullText</em> den vollst√§ndigen Text der Nachricht, w√§hrend <em>text</em> nur den Teil enth√§lt, der nach dem Namen des Befehls steht. </p><br></li></ol><br><p>  Dies ist praktisch, da Sie das vorgefertigte <em>Textfeld verwenden</em> k√∂nnen, um die darin enthaltenen Zusatzinformationen zu analysieren, z. B. das Datum des Ereignisses oder den Namen des Players. </p><br><ol><li>  Im Gegensatz zu Telegramm unterst√ºtzen VK-Nachrichten keine Tags zum Hervorheben von Text wie <code>&lt;b&gt;</code> oder <code>&lt;i&gt;</code> . Daher m√ºssen diese Tags beim Antworten mit regul√§ren Ausdr√ºcken gel√∂scht werden. </li></ol><br><h3 id="adaptery-dlya-priema-i-otpravki-soobscheniy">  Adapter zum Empfangen und Senden von Nachrichten </h3><br><p>  Nach der Erstellung der Schnittstellen- und Datenstrukturen f√ºr Telegramm- und VK-Nachrichten ist es an der Zeit, Dienste f√ºr die Verarbeitung eingehender Ereignisse zu implementieren. </p><br><p><img src="https://habrastorage.org/webt/gz/-z/2y/gz-z2y0x-x9_78hjdhg2mul9byu.jpeg" alt="Bild"></p><br><p>  Diese Dienste sollten Module von Drittanbietern f√ºr die Interaktion mit den Telegramm- und VK-APIs initialisieren und Mechanismen f√ºr lange Abfragen starten sowie eine Verbindung zwischen eingehenden Befehlen und internen Ereignissen herstellen, die im System auftreten, wenn Daten von Messaging-Diensten empfangen werden. </p><br><div class="spoiler">  <b class="spoiler_title">Telegrammservice</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Telegraf <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'telegraf'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Injectable} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/common'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> SocksAgent <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'socks5-https-client/lib/Agent'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {ConfigService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/config.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {AppEmitter} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/event-bus.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {TelegramMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./telegram.message'</span></span>; @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TelegramService</span></span></span><span class="hljs-class"> </span></span>{ private bot: Telegraf&lt;any&gt;; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(config: ConfigService, appEmitter: AppEmitter) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> botToken: string = config.get(<span class="hljs-string"><span class="hljs-string">'TELEGRAM_BOT_TOKEN'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bot = config.get(<span class="hljs-string"><span class="hljs-string">'TELEGRAM_USE_PROXY'</span></span>) ? <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Telegraf(botToken, { <span class="hljs-attr"><span class="hljs-attr">telegram</span></span>: {<span class="hljs-attr"><span class="hljs-attr">agent</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getProxy(config)}, }) : <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Telegraf(botToken); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getCommandEventMapping(appEmitter).forEach(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[command, event]</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bot.command(command, ctx =&gt; { ctx.command = command; appEmitter.emit(event, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TelegramMessage(ctx)); }); }); } public launch(): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bot.launch(); } private getProxy(config: ConfigService): SocksAgent { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SocksAgent({ <span class="hljs-attr"><span class="hljs-attr">socksHost</span></span>: config.get(<span class="hljs-string"><span class="hljs-string">'TELEGRAM_PROXY_HOST'</span></span>), <span class="hljs-attr"><span class="hljs-attr">socksPort</span></span>: config.get(<span class="hljs-string"><span class="hljs-string">'TELEGRAM_PROXY_PORT'</span></span>), <span class="hljs-attr"><span class="hljs-attr">socksUsername</span></span>: config.get(<span class="hljs-string"><span class="hljs-string">'TELEGRAM_PROXY_LOGIN'</span></span>), <span class="hljs-attr"><span class="hljs-attr">socksPassword</span></span>: config.get(<span class="hljs-string"><span class="hljs-string">'TELEGRAM_PROXY_PASSWORD'</span></span>), }); } private getCommandEventMapping( appEmitter: AppEmitter, ): <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>&lt;[string, string]&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ [<span class="hljs-string"><span class="hljs-string">'event_add'</span></span>, appEmitter.EVENT_ADD], [<span class="hljs-string"><span class="hljs-string">'event_remove'</span></span>, appEmitter.EVENT_REMOVE], [<span class="hljs-string"><span class="hljs-string">'info'</span></span>, appEmitter.EVENT_INFO], [<span class="hljs-string"><span class="hljs-string">'add'</span></span>, appEmitter.PLAYER_ADD], [<span class="hljs-string"><span class="hljs-string">'remove'</span></span>, appEmitter.PLAYER_REMOVE], ]; } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">VKService</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> VkBot <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'node-vk-bot-api'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Injectable} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/common'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {ConfigService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/config.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {AppEmitter} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/event-bus.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {VKMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./vk.message'</span></span>; @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">VKService</span></span></span><span class="hljs-class"> </span></span>{ private bot: VkBot&lt;any&gt;; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(config: ConfigService, appEmitter: AppEmitter) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> botToken: string = config.get(<span class="hljs-string"><span class="hljs-string">'VK_TOKEN'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bot = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> VkBot(botToken); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getCommandEventMapping(appEmitter).forEach(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[command, event]</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bot.command(<span class="hljs-string"><span class="hljs-string">`/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${command}</span></span></span><span class="hljs-string">`</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> ctx =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">from</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bot.execute(<span class="hljs-string"><span class="hljs-string">'users.get'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">user_ids</span></span>: ctx.message.from_id, }); ctx.message.from = <span class="hljs-keyword"><span class="hljs-keyword">from</span></span>; ctx.command = command; appEmitter.emit(event, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> VKMessage(ctx)); }); }); } public launch(): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bot.startPolling(); } private getCommandEventMapping( appEmitter: AppEmitter, ): <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>&lt;[string, string]&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ [<span class="hljs-string"><span class="hljs-string">'event_add'</span></span>, appEmitter.EVENT_ADD], [<span class="hljs-string"><span class="hljs-string">'event_remove'</span></span>, appEmitter.EVENT_REMOVE], [<span class="hljs-string"><span class="hljs-string">'info'</span></span>, appEmitter.EVENT_INFO], [<span class="hljs-string"><span class="hljs-string">'add'</span></span>, appEmitter.PLAYER_ADD], [<span class="hljs-string"><span class="hljs-string">'remove'</span></span>, appEmitter.PLAYER_REMOVE], ]; } }</code> </pre> </div></div><br><p>  Was Sie beachten sollten: </p><br><ol><li>  Aufgrund bestimmter Probleme beim Zugriff auf den Telegrammdienst (hi Roskomnadzor) musste optional ein Proxy verwendet werden, der das Paket <a href="https-client">socks5-https-client bereitstellt</a> . </li><li>  Bei der Verarbeitung eines Ereignisses wird dem Kontext ein Feld mit dem Wert des Befehls hinzugef√ºgt, mit dessen Text die Nachricht empfangen wurde. </li><li>  F√ºr VK m√ºssen Sie die Daten des Benutzers, der die Nachricht gesendet hat, separat √ºber einen separaten API-Aufruf herunterladen: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">from</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bot.execute(<span class="hljs-string"><span class="hljs-string">'users.get'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">user_ids</span></span>: ctx.message.from_id, });</code> </pre> </li></ol><br><h3 id="model-dannyh">  Datenmodell </h3><br><p>  Um die deklarierte Funktionalit√§t des Bots zu implementieren, gen√ºgten drei Modelle: </p><br><ol><li>  <code>Chat</code> - Chat oder Unterhaltung. </li><li>  <code>Event</code> - Ein Ereignis f√ºr einen Chat, der f√ºr ein bestimmtes Datum und eine bestimmte Uhrzeit geplant ist. </li><li>  <code>Player</code> - Teilnehmer oder Spieler, der an dem Ereignis teilnimmt. </li></ol><br><p><img src="https://habrastorage.org/webt/yj/dc/rw/yjdcrwzw4bsie2im9fuelyb590k.jpeg" alt="Datenschema"></p><br><p>  Implementierungen von Modellen unter Verwendung der <a href="https://www.npmjs.com/package/typeorm">typeorm-</a> Bibliothek sind: </p><br><div class="spoiler">  <b class="spoiler_title">Chat</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Entity, PrimaryGeneratedColumn, Column, OneToMany, JoinColumn, Index, } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'typeorm'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Event} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./event'</span></span>; @Entity() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Chat</span></span></span><span class="hljs-class"> </span></span>{ @PrimaryGeneratedColumn() id: number; @Index({<span class="hljs-attr"><span class="hljs-attr">unique</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>}) @Column() chatId: number; @OneToMany(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">type</span></span></span><span class="hljs-function"> =&gt;</span></span> Event, event =&gt; event.chat) @JoinColumn() events: Event[]; }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Ereignis</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Entity, PrimaryGeneratedColumn, Column, OneToMany, ManyToOne, JoinColumn, } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'typeorm'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Chat} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./chat'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Player} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./player'</span></span>; @Entity() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Event</span></span></span><span class="hljs-class"> </span></span>{ @PrimaryGeneratedColumn() id: number; @Column() date: <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>; @Column() active: boolean; @ManyToOne(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">type</span></span></span><span class="hljs-function"> =&gt;</span></span> Chat, chat =&gt; chat.events) chat: Chat; @OneToMany(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">type</span></span></span><span class="hljs-function"> =&gt;</span></span> Player, player =&gt; player.event) @JoinColumn() players: Player[]; }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Spieler</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Entity, PrimaryGeneratedColumn, Column, ManyToOne, JoinColumn, } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'typeorm'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Event} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./event'</span></span>; @Entity() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Player</span></span></span><span class="hljs-class"> </span></span>{ @PrimaryGeneratedColumn() id: number; @Column() name: string; @ManyToOne(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">type</span></span></span><span class="hljs-function"> =&gt;</span></span> Event, event =&gt; event.players) @JoinColumn() event: Event; }</code> </pre> </div></div><br><p>  Hier ist es notwendig, den Mechanismus des Bots f√ºr verschiedene Teams im Hinblick auf die Manipulation von <em>Chat-</em> , <em>Event-</em> und <em>Player-</em> Modellen noch einmal zu diskutieren. </p><br><ol><li>  Nach Erhalt eines Befehls wird <code>chatId</code> in der DB ein Chat mit der Chat- <code>chatId</code> .  Wenn es keinen entsprechenden Datensatz gibt, wird er erstellt. </li><li>  Um die Logik zu vereinfachen, kann jeder Chat nur ein aktives Ereignis ( <em>Ereignis</em> ) haben.  Das hei√üt  Beim Empfang des <code>/event_add</code> wird im System ein neues aktives Ereignis mit dem angegebenen Datum erstellt. <br>  Das aktuell aktive Ereignis (falls vorhanden) wird inaktiv. </li><li>  <code>/event_remove</code> findet das aktive Ereignis im aktuellen Chat und deaktiviert es. </li><li>  <code>/info</code> findet ein aktives Ereignis im aktuellen Chat, zeigt Informationen zu diesem Ereignis und eine Liste der Spieler an ( <em>Player</em> ). </li><li>  <code>/add</code> und <code>/remove</code> arbeiten mit dem aktiven Event und f√ºgen Spieler hinzu und entfernen sie daraus. </li></ol><br><p>  Der entsprechende Dienst zum Arbeiten mit Daten lautet wie folgt: </p><br><div class="spoiler">  <b class="spoiler_title">StorageService</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Injectable} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/common'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {InjectConnection} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/typeorm'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Connection, Repository, UpdateResult} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'typeorm'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Chat} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./models/chat'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Event} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./models/event'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Player} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./models/player'</span></span>; @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StorageService</span></span></span><span class="hljs-class"> </span></span>{ private chatRepository: Repository&lt;Chat&gt;; private eventRepository: Repository&lt;Event&gt;; private playerRepository: Repository&lt;Player&gt;; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(@InjectConnection() private readonly dbConnection: Connection) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.chatRepository = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dbConnection.getRepository(Chat); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.eventRepository = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dbConnection.getRepository(Event); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerRepository = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dbConnection.getRepository(Player); } public get connection() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dbConnection; } public <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> ensureChat(chatId: number): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;Chat&gt; { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> chat: Chat = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.chatRepository.findOne({chatId}); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (chat) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> chat; } chat = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Chat(); chat.chatId = chatId; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.chatRepository.save(chat); } public markChatEventsInactive(chat: Chat): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;UpdateResult&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dbConnection .createQueryBuilder() .update(Event) .set({<span class="hljs-attr"><span class="hljs-attr">active</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>}) .where({chat}) .execute(); } public appendChatActiveEvent(chat: Chat, <span class="hljs-attr"><span class="hljs-attr">date</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;Event&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> event: Event = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Event(); event.chat = chat; event.active = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; event.date = date; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.eventRepository.save(event); } public findChatActiveEvent(chat: Chat): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;Event | <span class="hljs-literal"><span class="hljs-literal">null</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.eventRepository.findOne({<span class="hljs-attr"><span class="hljs-attr">where</span></span>: {chat, <span class="hljs-attr"><span class="hljs-attr">active</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>}}); } public getPlayers(event: Event): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;Player[]&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerRepository.find({<span class="hljs-attr"><span class="hljs-attr">where</span></span>: {event}}); } public findPlayer(event: Event, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: string): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;Player | <span class="hljs-literal"><span class="hljs-literal">null</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerRepository.findOne({<span class="hljs-attr"><span class="hljs-attr">where</span></span>: {event, name}}); } public addPlayer(event: Event, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: string): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;Player&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> player: Player = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Player(); player.event = event; player.name = name; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerRepository.save(player); } public removePlayer(player: Player): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;Player&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerRepository.remove(player); } }</code> </pre> </div></div><br><h3 id="shablonizaciya-otvetov">  Vorlage Antwort </h3><br><p>  Zus√§tzlich zu dem beschriebenen <em>StorageService-</em> Dienst f√ºr die Arbeit mit Daten musste ein dedizierter <em>TemplateService-</em> Dienst implementiert werden, dessen Aufgaben derzeit folgende sind: </p><br><ol><li>  Herunterladen und Kompilieren von <a href="https://handlebarsjs.com/">Lenkervorlagen</a> f√ºr Antwortoptionen f√ºr verschiedene Befehle in verschiedenen Sprachen. </li><li>  Auswahl einer geeigneten Vorlage in Abh√§ngigkeit von aktuellem Ereignis, Antwortstatus und Benutzersprache. </li><li>  F√ºllen der Vorlage mit Daten, die als Ergebnis des Befehls erhalten wurden. </li></ol><br><div class="spoiler">  <b class="spoiler_title">TemplateService</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> path <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'path'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> fs <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'fs'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> handlebars <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'handlebars'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {readDirDeepSync} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'read-dir-deep'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Injectable, Logger} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/common'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> interface IParams { <span class="hljs-attr"><span class="hljs-attr">action</span></span>: string; status: string; lang?: string; } @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TemplateService</span></span></span><span class="hljs-class"> </span></span>{ private readonly DEFAULT_LANG: string = <span class="hljs-string"><span class="hljs-string">'en'</span></span>; private readonly TEMPLATE_PATH: string = <span class="hljs-string"><span class="hljs-string">'templates'</span></span>; private logger: Logger; private templatesMap: <span class="hljs-built_in"><span class="hljs-built_in">Map</span></span>&lt;string, (d: any) =&gt; string&gt;; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(logger: Logger) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.logger = logger; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.load(); } public apply(params: IParams, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: any): string { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.logger.log( <span class="hljs-string"><span class="hljs-string">`apply template: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${params.action}</span></span></span><span class="hljs-string"> </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${params.status}</span></span></span><span class="hljs-string"> </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${params.lang}</span></span></span><span class="hljs-string">`</span></span>, ); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> template = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getTemplate(params); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!template) { params.lang = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.DEFAULT_LANG; template = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getTemplate(params); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!template) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">'template-not-found'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> template(data); } private getTemplate(params: IParams): <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data: any</span></span></span><span class="hljs-function">) =&gt;</span></span> string { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> {lang, action, status} = params; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.templatesMap.get(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getTemplateKey(lang, action, status)); } private load() { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> templatesDir: string = path.join( process.cwd(), <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.TEMPLATE_PATH, ); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> templateFileNames: string[] = readDirDeepSync(templatesDir); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.templatesMap = templateFileNames.reduce(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">acc, fileName</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> template = fs.readFileSync(fileName, {<span class="hljs-attr"><span class="hljs-attr">encoding</span></span>: <span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>}); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> [, lang, action, status] = fileName .replace(<span class="hljs-regexp"><span class="hljs-regexp">/\.hbs$/</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>) .split(<span class="hljs-string"><span class="hljs-string">'/'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> acc.set( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getTemplateKey(lang, action, status), handlebars.compile(template), ); }, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Map</span></span>()); } private getTemplateKey( lang: string, <span class="hljs-attr"><span class="hljs-attr">action</span></span>: string, <span class="hljs-attr"><span class="hljs-attr">status</span></span>: string, ): string { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${lang}</span></span></span><span class="hljs-string">-</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${action}</span></span></span><span class="hljs-string">-</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${status}</span></span></span><span class="hljs-string">`</span></span>; } }</code> </pre> </div></div><br><p>  Was Sie beachten sollten: </p><br><ol><li><p>  Vorlagendateien befinden sich in einem separaten Verzeichnis <code>./templates</code> im Stammverzeichnis des Projekts und sind nach Sprache, Aktion (Befehl) und Antwortstatus strukturiert. </p><br><pre> <code class="plaintext hljs">- templates - en - event_add - invalid_date.hbs - success.hbs - event_info - ru</code> </pre> <br><p>  Bei der Initialisierung der Anwendung werden alle Antwortvorlagen in den Speicher geladen und f√ºllen eine Karte mit Schl√ºsseln, die die Vorlage eindeutig identifizieren: </p><br><pre> <code class="javascript hljs">private getTemplateKey(lang: string, <span class="hljs-attr"><span class="hljs-attr">action</span></span>: string, <span class="hljs-attr"><span class="hljs-attr">status</span></span>: string): string { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${lang}</span></span></span><span class="hljs-string">-</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${action}</span></span></span><span class="hljs-string">-</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${status}</span></span></span><span class="hljs-string">`</span></span>; }</code> </pre> <br></li><li><p>  Derzeit verf√ºgt das System √ºber zwei Vorlagens√§tze: f√ºr Russisch und Englisch. <br>  Fallback wird in der Standardsprache (Englisch) bereitgestellt, sofern die erforderliche Vorlage f√ºr die Sprache des aktuellen Ereignisses nicht vorhanden ist. </p><br></li><li><p>  <a href="https://handlebarsjs.com/">Lenkervorlagen</a> selbst, zum Beispiel: </p><br><pre> <code class="plaintext hljs">Player &lt;strong&gt;{{name}}&lt;/strong&gt; will take part in the game List of players: {{#each players}} {{index}}: &lt;i&gt;{{name}}&lt;/i&gt; {{/each}} Total: &lt;strong&gt;{{total}}&lt;/strong&gt;</code> </pre> <br><p>  Sie enthalten sowohl herk√∂mmliche Platzhalter als auch eine <a href="https://tlgrm.ru/docs/bots/api">Reihe g√ºltiger Tags</a> zum Formatieren von Antworten in Telegram. </p><br></li></ol><br><h3 id="servisy-obrabotki-komand-actions">  Befehlsverarbeitungsdienste (Aktionen) </h3><br><p>  Nach der Beschreibung der grundlegenden Support-Services ist es an der Zeit, die Gesch√§ftslogik des Bots selbst zu implementieren.  Der Zusammenhang zwischen den Modulen ist hier schematisch dargestellt: </p><br><p><img src="https://habrastorage.org/webt/b3/xl/vl/b3xlvlw5qc93vkc3n-nylnjwpqa.jpeg" alt="Handlungen"></p><br><p>  Die Aufgaben der <em>BaseAction-</em> Basisklasse umfassen: </p><br><ol><li>  Abonnieren Sie eine bestimmte Veranstaltung von <em>AppEmitter</em> . </li><li>  Die Gesamtfunktionalit√§t der Ereignisverarbeitung, n√§mlich: <br><ul><li>  suche nach einem bestehenden oder erstelle einen neuen chat, in dessen kontext das team bearbeitet wird. </li><li>  Ein Aufruf der <code>doAction</code> Vorlagenmethode, <code>doAction</code> Implementierung f√ºr jede Klasse der vererbenden <em>BaseAction individuell ist</em> . </li><li>  Anwenden von Vorlagen auf die resultierende <code>doAction</code> Antwort mithilfe des <em>TemplateService</em> . </li></ul></li></ol><br><div class="spoiler">  <b class="spoiler_title">Basisaktion</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Injectable, Logger} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/common'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {IMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/i-message'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {ConfigService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/config.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {AppEmitter} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/event-bus.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {TemplateService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/template.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {StorageService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/storage.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Chat} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/chat'</span></span>; @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseAction</span></span></span><span class="hljs-class"> </span></span>{ protected appEmitter: AppEmitter; protected config: ConfigService; protected logger: Logger; protected templateService: TemplateService; protected storageService: StorageService; protected event: string; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>( config: ConfigService, appEmitter: AppEmitter, logger: Logger, templateService: TemplateService, storageService: StorageService, ) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.config = config; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.logger = logger; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.appEmitter = appEmitter; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.templateService = templateService; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService = storageService; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setEvent(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.logger.log(<span class="hljs-string"><span class="hljs-string">`subscribe on "</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${</span></span><span class="hljs-keyword"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-string"><span class="hljs-subst">.event}</span></span></span><span class="hljs-string">" event`</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.appEmitter.on(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.event, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.handleEvent.bind(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>)); } protected setEvent(): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">'not implemented'</span></span>); } protected <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> doAction(chat: Chat, <span class="hljs-attr"><span class="hljs-attr">message</span></span>: IMessage): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;IMessage&gt; { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">'not implemented'</span></span>); } private <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> handleEvent(message: IMessage) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.logger.log(<span class="hljs-string"><span class="hljs-string">`"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${</span></span><span class="hljs-keyword"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-string"><span class="hljs-subst">.event}</span></span></span><span class="hljs-string">" event received`</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> chatId: number = message.chatId; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> chat: Chat = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.ensureChat(chatId); message = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.doAction(chat, message); message.answer( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.templateService.apply( { <span class="hljs-attr"><span class="hljs-attr">action</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.event, <span class="hljs-attr"><span class="hljs-attr">status</span></span>: message.getReplyStatus(), <span class="hljs-attr"><span class="hljs-attr">lang</span></span>: message.lang, }, message.getReplyData(), ), ); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (error) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.logger.error(error); message.answer(error.message); } } }</code> </pre> </div></div><br><p>  Die Aufgabe der <em>untergeordneten BaseAction-</em> Klassen besteht darin, die <code>doAction</code> Methode der Eingabe auszuf√ºhren: </p><br><ol><li>  <em>Chat</em> , der in der Basisklasse erstellt oder definiert wurde </li><li>  Ein Objekt, das dem <em>IMessage-</em> Protokoll entspricht. </li></ol><br><p>  Als Ergebnis der Ausf√ºhrung dieser Methode wird auch <em>IMessage</em> zur√ºckgegeben, jedoch mit dem festgelegten Status f√ºr die Auswahl der richtigen Vorlage und der Daten, die an der Antwortvorlage teilnehmen. </p><br><div class="spoiler">  <b class="spoiler_title">EventAddAction</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Injectable} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/common'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> statuses <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./statuses'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {parseEventDate, formatEventDate} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/utils'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {BaseAction} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./base.action'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Chat} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/chat'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Event} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/event'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {IMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/i-message'</span></span>; @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EventAddAction</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseAction</span></span></span><span class="hljs-class"> </span></span>{ protected setEvent(): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.event = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.appEmitter.EVENT_ADD; } protected <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> doAction(chat: Chat, <span class="hljs-attr"><span class="hljs-attr">message</span></span>: IMessage): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;IMessage&gt; { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.markChatEventsInactive(chat); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> eventDate: <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span> = parseEventDate(message.text.trim()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!eventDate) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message.setStatus(statuses.STATUS_INVALID_DATE); } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> event: Event = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.appendChatActiveEvent( chat, eventDate, ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message.setStatus(statuses.STATUS_SUCCESS).withData({ <span class="hljs-attr"><span class="hljs-attr">date</span></span>: formatEventDate(event.date), }); } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">EventRemoveAction</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Injectable} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/common'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> statuses <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./statuses'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {formatEventDate} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/utils'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {BaseAction} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./base.action'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Chat} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/chat'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Event} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/event'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {IMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/i-message'</span></span>; @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EventRemoveAction</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseAction</span></span></span><span class="hljs-class"> </span></span>{ protected setEvent(): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.event = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.appEmitter.EVENT_REMOVE; } protected <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> doAction(chat: Chat, <span class="hljs-attr"><span class="hljs-attr">message</span></span>: IMessage): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;IMessage&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> activeEvent: Event = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.findChatActiveEvent( chat, ); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.markChatEventsInactive(chat); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (activeEvent) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message.setStatus(statuses.STATUS_SUCCESS).withData({ <span class="hljs-attr"><span class="hljs-attr">date</span></span>: formatEventDate(activeEvent.date), }); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message.setStatus(statuses.STATUS_NO_EVENT); } } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">EventInfoAction</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Injectable, Logger} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/common'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> statuses <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./statuses'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {formatEventDate} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/utils'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {ConfigService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/config.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {AppEmitter} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/event-bus.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {TemplateService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/template.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {StorageService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/storage.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {BaseAction} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./base.action'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {PlayerHelper} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./player.helper'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Chat} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/chat'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Event} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/event'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Player} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/player'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {IMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/i-message'</span></span>; @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EventInfoAction</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseAction</span></span></span><span class="hljs-class"> </span></span>{ private playerHelper: PlayerHelper; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>( config: ConfigService, appEmitter: AppEmitter, logger: Logger, templateService: TemplateService, playerHelper: PlayerHelper, storageService: StorageService, ) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(config, appEmitter, logger, templateService, storageService); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerHelper = playerHelper; } protected setEvent(): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.event = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.appEmitter.EVENT_INFO; } protected <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> doAction(chat: Chat, <span class="hljs-attr"><span class="hljs-attr">message</span></span>: IMessage): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;IMessage&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> activeEvent: Event = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.findChatActiveEvent( chat, ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!activeEvent) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message.setStatus(statuses.STATUS_NO_EVENT); } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> players: Player[] = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.getPlayers( activeEvent, ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message.setStatus(statuses.STATUS_SUCCESS).withData({ <span class="hljs-attr"><span class="hljs-attr">date</span></span>: formatEventDate(activeEvent.date), ...(<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerHelper.getPlayersList(activeEvent)), }); } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">PlayerAddAction</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Injectable, Logger} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/common'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> statuses <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./statuses'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {ConfigService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/config.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {AppEmitter} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/event-bus.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {TemplateService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/template.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {StorageService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/storage.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {BaseAction} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./base.action'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {PlayerHelper} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./player.helper'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Chat} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/chat'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Event} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/event'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Player} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/player'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {IMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/i-message'</span></span>; @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PlayerAddAction</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseAction</span></span></span><span class="hljs-class"> </span></span>{ private playerHelper: PlayerHelper; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>( config: ConfigService, appEmitter: AppEmitter, logger: Logger, templateService: TemplateService, playerHelper: PlayerHelper, storageService: StorageService, ) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(config, appEmitter, logger, templateService, storageService); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerHelper = playerHelper; } protected setEvent(): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.event = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.appEmitter.PLAYER_ADD; } protected <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> doAction(chat: Chat, <span class="hljs-attr"><span class="hljs-attr">message</span></span>: IMessage): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;IMessage&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> activeEvent: Event = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.findChatActiveEvent( chat, ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!activeEvent) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message.setStatus(statuses.STATUS_NO_EVENT); } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> name: string = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerHelper.getPlayerName(message); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> existedPlayer: Player = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.findPlayer( activeEvent, name, ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (existedPlayer) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message .setStatus(statuses.STATUS_ALREADY_ADDED) .withData({name}); } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> newPlayer: Player = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.addPlayer( activeEvent, name, ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message.setStatus(statuses.STATUS_SUCCESS).withData({ <span class="hljs-attr"><span class="hljs-attr">name</span></span>: newPlayer.name, ...(<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerHelper.getPlayersList(activeEvent)), }); } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">PlayerRemoveAction</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Injectable, Logger} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/common'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> statuses <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./statuses'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {ConfigService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/config.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {AppEmitter} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/event-bus.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {TemplateService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/template.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {StorageService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/storage.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {BaseAction} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./base.action'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {PlayerHelper} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./player.helper'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Chat} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/chat'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Event} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/event'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Player} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/player'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {IMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/i-message'</span></span>; @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PlayerRemoveAction</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseAction</span></span></span><span class="hljs-class"> </span></span>{ private playerHelper: PlayerHelper; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>( config: ConfigService, appEmitter: AppEmitter, logger: Logger, templateService: TemplateService, playerHelper: PlayerHelper, storageService: StorageService, ) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(config, appEmitter, logger, templateService, storageService); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerHelper = playerHelper; } protected setEvent(): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.event = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.appEmitter.PLAYER_REMOVE; } protected <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> doAction(chat: Chat, <span class="hljs-attr"><span class="hljs-attr">message</span></span>: IMessage): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;IMessage&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> activeEvent: Event = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.findChatActiveEvent( chat, ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!activeEvent) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message.setStatus(statuses.STATUS_NO_EVENT); } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> name: string = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerHelper.getPlayerName(message); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> existedPlayer: Player = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.findPlayer( activeEvent, name, ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!existedPlayer) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message .setStatus(statuses.STATUS_NO_PLAYER) .withData({name}); } <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.removePlayer(existedPlayer); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message.setStatus(statuses.STATUS_SUCCESS).withData({ name, ...(<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerHelper.getPlayersList(activeEvent)), }); } }</code> </pre> </div></div><br><p>  Was Sie beachten sollten: </p><br><ol><li>  Mit <code>/remove</code> Befehlen <code>/add</code> und <code>/remove</code> k√∂nnen Sie den Player hinzuf√ºgen / entfernen, dessen Name nach dem Befehl steht.  Wenn der Name nicht angegeben ist, wird der Spieler, der das Team angerufen hat, hinzugef√ºgt / entfernt. </li><li>  In Reaktion auf die Befehle <code>/add</code> , <code>/remove</code> und <code>/info</code> wird eine aktualisierte Liste der Spieler f√ºr das aktive Ereignis angezeigt. </li></ol><br><p>  Die zur Implementierung von (1) und (2) erforderliche Funktionalit√§t wurde in eine spezielle Hilfsklasse verschoben: </p><br><div class="spoiler">  <b class="spoiler_title">SpielerHelfer</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Injectable} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/common'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {StorageService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/storage.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Event} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/event'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Player} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/player'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {IMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/i-message'</span></span>; @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PlayerHelper</span></span></span><span class="hljs-class"> </span></span>{ protected storageService: StorageService; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(storageService: StorageService) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService = storageService; } public getPlayerName(message: IMessage) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> name = message.text.trim(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> name.length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> ? name : message.name; } public <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> getPlayersList(event: Event) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> players: Player[] = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.getPlayers(event); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">total</span></span>: players.length, <span class="hljs-attr"><span class="hljs-attr">players</span></span>: players.map(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">player, index</span></span></span><span class="hljs-function">) =&gt;</span></span> ({ <span class="hljs-attr"><span class="hljs-attr">index</span></span>: index + <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: player.name, })), }; } }</code> </pre></div></div><br><h3 id="sobiraem-vse-vmeste">  Alles zusammen </h3><br><p>  Wie am Anfang des Artikels erw√§hnt, wird das <a href="https://nestjs.com/">NestJS-</a> Framework als Anwendungsframework verwendet.  Einmal hatte ich das Gl√ºck, pers√∂nlich an dem <a href="https://www.youtube.com/watch%3Fv%3Djo-1EUxMmxc">Bericht</a> des Erstellers dieser wundervollen Bibliothek teilzunehmen. </p><br><p>  Viele NodeJS-Boilerplates, -Handb√ºcher und -Bibliotheken s√ºndigen h√§ufig dadurch, dass sie keine vern√ºnftigen Initialisierungsstrategien und Verbindungen zwischen Modulen bieten.  Mit dem Anwachsen der Anwendung wird die Codebasis bei fehlender Beachtung zu einem Mischmasch von Anforderungen zwischen Modulen, was h√§ufig sogar zu zyklischen Abh√§ngigkeiten oder Beziehungen f√ºhrt, wo dies im Prinzip nicht der Fall sein sollte.        Dependency Injection   <a href="https://www.npmjs.com/package/awilix">awilix</a> ,  <a href="https://nestjs.com/">NestJS</a>  . </p><br><p>   DI      ,    NodeJS ,            ,        . </p><br><p><img src="https://habrastorage.org/webt/l2/gq/lc/l2gqlc0vig_zsywifjjopmt_4wc.jpeg" alt="  "></p><br><h2 id="konfiguraciya">  </h2><br><p>            . </p><br><ol><li> <code>TELEGRAM_BOT_TOKEN</code> ‚Äî    Telegram . </li><li> <code>TELEGRAM_USE_PROXY</code> ‚Äî          TelegramAPI. </li><li> <code>TELEGRAM_PROXY_HOST</code> ‚Äî       TelegramAPI. </li><li> <code>TELEGRAM_PROXY_PORT</code> ‚Äî       TelegramAPI. </li><li> <code>TELEGRAM_PROXY_LOGIN</code> ‚Äî       TelegramAPI. </li><li> <code>TELEGRAM_PROXY_PASSWORD</code> ‚Äî       TelegramAPI. </li><li> <code>VK_TOKEN</code> ‚Äî    VK . </li><li> <code>DATABASE_URL</code> ‚Äî    .   production . </li></ol><br><p>      : </p><br><ol><li> <code>TELEGRAM_BOT_TOKEN</code>       <a href="https://tlgrm.ru/docs/bots"> </a>      Telegram. </li><li> <code>VK_TOKEN</code> ‚Äî    ,  VK    .  Das hei√üt    ,             .       <a href="https://vk.com/dev/bots_docs">  </a>  . </li><li> <code>DATABASE_URL</code> ‚Äî  production      PostgreSQL.          DBaaS   <a href="https://www.elephantsql.com/">elephantsql</a>   . </li></ol><br><h2 id="ci"> CI </h2><br><p> " -   ‚Äî   ".    ,       <a href="https://travis-ci.org/">TravisCI</a>       : </p><br><pre> <code class="plaintext hljs">language: node_js node_js: - '8' - '10' - '12' script: - npm run lint - npm run build - npm run test:cov after_script: - npm install -g codecov - codecov</code> </pre> <br><p>                      <a href="https://codecov.io/">codecov</a> . </p><br><p>    <a href="https://www.docker.com/">Docker</a>      <a href="https://hub.docker.com/">Docker Hub</a>        <a href="https://habr.com/ru/users/Gonf/">Gonf</a>    <a href="https://habr.com/ru/post/476368/">  CI/CD   GitHub Actions  Python</a> .         Continuous Deployment,       Github: </p><br><pre> <code class="plaintext hljs">name: Release on: release: types: [published] jobs: build: runs-on: ubuntu-latest env: LOGIN: ${{ secrets.DOCKER_LOGIN }} NAME: ${{ secrets.DOCKER_NAME }} steps: - uses: actions/checkout@v1 - name: Install Node.js uses: actions/setup-node@v1 - name: Login to docker.io run: echo ${{ secrets.DOCKER_PWD }} | docker login -u ${{ secrets.DOCKER_LOGIN }} --password-stdin - name: npm install and build run: npm ci &amp;&amp; npm run build - name: Build the Docker image run: docker build -t $LOGIN/$NAME:${GITHUB_REF:10} -f Dockerfile . - name: Push image to docker.io run: docker push $LOGIN/$NAME:${GITHUB_REF:10}</code> </pre> <br><h2 id="rezultat-i-vyvody">    </h2><br><p>     .  Telegram     : <br>        . </p><br><p><img src="https://habrastorage.org/webt/mi/tr/nb/mitrnbq3hcwu33lizpvmbxuirl0.png" alt="demo1"></p><br><p>    . </p><br><p><img src="https://habrastorage.org/webt/4v/y-/lk/4vy-lkg-dungqdpmbou0gop2w4e.png" alt="demo2"></p><br><p>      . </p><br><p><img src="https://habrastorage.org/webt/w8/i2/oo/w8i2oog_swdu2sjvqsqihwu8ww4.png" alt="demo3"></p><br><p>     VK      <code>&lt;b&gt;</code>  <code>&lt;i&gt;</code> . <br>        . </p><br><p><img src="https://habrastorage.org/webt/ak/cu/fo/akcufo-5cwygqzcdfysm-uytzdi.png" alt="demo4"></p><br><p>      . </p><br><p><img src="https://habrastorage.org/webt/pg/ye/c7/pgyec7wg7kgltgjk7ton5wc7w64.png" alt="demo6"></p><br><p>   <a href="https://www.viber.com/">Viber</a> ,              .         ,    <a href="https://www.viber.com/">Viber</a>   webhooks  long-polling.    ,    Viber         .       <a href="https://github.com/Viber/sample-bot-isitup/issues/2"></a> .          (?) . </p><br><p>  Telegram            <code>@Tormozz48bot</code> . </p><br><p>     <a href="https://github.com/tormozz48/football-chat-bot-2"> Github</a> .   ,   . </p><br><p> PS    . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de483194/">https://habr.com/ru/post/de483194/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de483178/index.html">Hier ist ein Update zu Flutter 1.9 in Verbindung mit der Dart 2.5-Programmierung</a></li>
<li><a href="../de483182/index.html">F√ºnf interessante Methoden zur Verwendung von Array.reduce () (und eine langweilige Methode)</a></li>
<li><a href="../de483184/index.html">Automatisches Code-Upgrade auf TensorFlow 2</a></li>
<li><a href="../de483186/index.html">Einf√ºhrung in Java 13: Kommen wir zu den neuen Funktionen von JDK</a></li>
<li><a href="../de483190/index.html">Antworten des technischen Supports von 3CX: F√ºhren Sie ein Upgrade von fr√ºheren Versionen auf 3CX v16 durch</a></li>
<li><a href="../de483198/index.html">So verwaltet Alibaba Cloud Zehntausende von Kubernetes-Clustern mit ... Kubernetes</a></li>
<li><a href="../de483202/index.html">Einf√ºhrung in die REST-API - RESTful Web Services</a></li>
<li><a href="../de483204/index.html">Unterschiede zwischen REST und SOAP</a></li>
<li><a href="../de483206/index.html">REST-API-Entwicklung - Was steht bei Vertr√§gen an erster Stelle?</a></li>
<li><a href="../de483208/index.html">R√ºckblick auf Kaggle ML & DS Survey 2019. Oder wie viel ML-Spezialisten verdienen</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>