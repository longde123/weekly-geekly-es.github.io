<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëº üßùüèº üçß bobaflu - accessoires de programmation sur flutter üèê üôèüèª üõÇ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Cet article se concentrera sur l'impl√©mentation du client mobile Flutter. 


 Quel client mobile? 


 La publication pr√©c√©dente d√©crivait le syst√®me d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>bobaflu - accessoires de programmation sur flutter</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/440088/"><p><img src="https://habrastorage.org/webt/-n/0y/sv/-n0ysvv41yt_uwk8hh-fa1ui79e.png"></p><br><p> Cet article se concentrera sur l'impl√©mentation du client mobile Flutter. </p><br><p>  Quel client mobile? </p><br><p>  La publication pr√©c√©dente d√©crivait le syst√®me d'accessoires logiciels: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">bobaoskit - accessoires, dnssd et WebSocket</a> . </p><br><p> Un analogue d'un accessoire logiciel est un v√©ritable objet.  Ampoule, interrupteur, lecteur cd / cassette, radio, thermostat, capteur de temp√©rature, capteur de mouvement, etc ... Un ensemble d'accessoires est d√©termin√© par l'imagination et le code du programme.  Vous pouvez impl√©menter au moins un √©chiquier.  Pour une telle carte, vous devez avoir un champ de contr√¥le ( <code>control</code> ) <code>move</code> qui prend un objet <code>{ from: "e2", to: "e4" }</code> par exemple, et des champs de service pour r√©initialiser les chiffres, etc. ... Le script accessoire traitera la demande de contr√¥le du champ de <code>move</code> , accepter la d√©cision est de savoir s'il est possible de d√©placer la figure, et retournera (ou non) le statut avec la position des figures dans tout le champ. </p><br><p>  Les types d'accessoires actuellement pris en charge avec une fonctionnalit√© minimale sont les suivants: "interrupteur", "capteur de temp√©rature", "thermostat", "lecteur radio". </p><br><p>  Concernant les √©checs, il n'y aura plus de discussion.  Si c'est int√©ressant et dans ce cas, bienvenue au chat. </p><a name="habracut"></a><br><p>  Donc <code>bobaoskit.worker</code> .  Des objets accessoires existent dans la m√©moire de l'ordinateur, vous pouvez lire des informations √† leur sujet, vous pouvez envoyer manuellement une demande <code>JSON</code> au port <code>WebSocket</code> et voir les √©v√©nements entrants. </p><br><p>  Pour la gestion, j'ai cr√©√© l'application mobile la plus simple. </p><br><h2 id="pochemu-flutter">  Pourquoi papillonner? </h2><br><p>  Au cours des deux derni√®res ann√©es, une id√©e a v√©cu activement dans ma t√™te pour √©tudier la programmation pour les appareils mobiles.  Depuis que j'√©cris en <code>JavaScript</code> , j'ai √©tudi√© des solutions qui vous permettent de ne pas apprendre un nouveau langage de programmation. </p><br><p>  <code>Appcelerator</code>  Il a commenc√© l'√©tude avec lui.  Si la m√©moire ne change pas, le SDK est ouvert, mais l'IDE avec diff√©rents tarifs. <br>  <code>NativeScript</code>  Ici, j'ai d√©j√† cr√©√© une application simple affichant une liste avec des photos.  Cela n‚Äôest pas all√© plus loin. <br>  <code>ReactNative</code>  L'assaut le plus long des frameworks r√©pertori√©s jusqu'√† pr√©sent.  Le plus grand d√©fi est de commencer.  J'ai regard√© le cours.  Au d√©but, c'est clair, int√©ressant, il s'av√®re.  Mais le <code>redux</code> et la surpuissance ont √©chou√©.  Ensuite, il essayait r√©guli√®rement de commencer √† √©crire, mais <code>redux</code> obstin√©ment ne se permettait pas de ma√Ætriser. </p><br><p>  En cons√©quence, je n'√©tais alors attach√© √† aucune d√©cision (fin 2016).  Peut-√™tre parce qu'il n'y avait pas de t√¢che sp√©cifique, peut-√™tre pour d'autres raisons. </p><br><p>  Plus pr√®s de la chute du pass√© (2018), des travaux √©taient d√©j√† en cours sur le sdk pour les accessoires logiciels.  Naturellement, vous avez besoin d'une application mobile.  Tout a commenc√© avec mdns.  Une fois dans mon temps libre, j'ai mis √† jour ReactNative, trouv√© le plugin react-native-zeroconf, cr√©√© l'application.  Selon les instructions, install√©, fait un <code>link</code> , lanc√©.  L'application de d√©bogage d'Expo a d√©marr√©, qui ne prend pas en charge les modules natifs et, par cons√©quent, le plug-in mdns n'a pas fonctionn√©.  √Ä ce stade, il n'y avait pas assez de temps libre pour cr√©er une application native native React (et sans expo) et tester avec.  Le travail a √©t√© report√© de quelques mois. </p><br><p>  Dans le m√™me temps, de plus en plus de documents sont apparus sur le <code>flutter</code> sur le r√©seau.  Je me suis install√©.  L'installation est simple: <code>git clone</code> et ajoutez √† <code>PATH</code> .  Le reste est d√©j√† en train de configurer le SDK / Xcode Android (dans mon cas, le SDK Android est configur√© depuis longtemps. Je ne peux pas d√©velopper pour iOS, parce que je ne suis pas un utilisateur macOS) et le SDK Dart (vous pouvez l'installer s√©par√©ment, mais pas n√©cessairement, car il fait partie du flottement). </p><br><h2 id="principshema-raboty">  Principe / sch√©ma de travail </h2><br><ul><li>  Une fois lanc√©e, l'application recherche les services <code>_bobaoskit._tcp</code> sur le r√©seau local √† l'aide du plugin <a href="">flutter_mdns</a> .  Il existe plusieurs versions de ce plugin, toutes tirent leurs racines de celle <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">publi√©e</a> , mais il n'est pas compatible avec les nouvelles versions du SDK Dart, respectivement, de nombreuses compatibilit√© fourchues et ajout√©es.  J'ai choisi cette version car les autres n'ont pas r√©solu les h√¥tes de plusieurs services d√©couverts √† la fois. <br>  Lors de la d√©tection et de la d√©termination (onResolve), l'h√¥te est ajout√© √† la liste. <br>  La page avec la liste des services d√©couverts est <code>StatefulWidget</code> , respectivement, lorsqu'elle d√©tecte / perte de services, <code>setState() {...}</code> est appel√©e </li><li>  Lors du choix d'un h√¥te dans la liste, une nouvelle page est cr√©√©e (√©galement <code>StatefulWidget</code> ), √† laquelle l' <code>host</code> et le <code>port</code> service s√©lectionn√© sont transmis. <br>  L'objet <code>BobaosKit</code> responsable des communications est cr√©√©.  Les r√©ponses sont trait√©es par le biais de rappels, comme  alors que je n'ai pas beaucoup √©tudi√© la fl√©chette asynchrone.  Mais √† en juger par la documentation num√©ris√©e, <code>Futures</code> est un analogue de <code>Promise</code> in JS. <br>  Les fonctions sont enregistr√©es pour les √©v√©nements entrants (pas de r√©ponse).  <code>EventEmitter</code> pour Dart ici.  J'ai √©crit mon tr√®s simple. </li></ul><br><pre> <code class="plaintext hljs"> void registerListener(String name, Function cb) { this._events.add(new BobaosKitCallback(name, cb)); } void removeAllListeners() { this._events = []; } void emitEvent(String name, dynamic params) { // call all listeners List&lt;BobaosKitCallback&gt; foundCallbacks = this._events.where((t) =&gt; t.name == name).toList(); foundCallbacks.forEach((f) =&gt; f.cb(params)); } ... ... void listen() { this.ws.listen((text) { var json = jsonDecode(text); if (json.containsKey('response_id')) { .... } else { //   response_id -  this.emitEvent(json['method'], json['payload']); } }); }</code> </pre> <br><p>  √âv√©nements entrants - si l'accessoire a √©t√© supprim√©, ajout√©, √©tat mis √† jour.  Ou si tous les accessoires sont retir√©s ( <code>clear accessories</code> ). </p><br><p>  Fonctions enregistr√©es - pour la mise √† jour des listes, des widgets pour ces √©v√©nements. </p><br><ul><li>  Une demande est envoy√©e pour des informations sur tous les accessoires. </li></ul><br><p>  Un objet AccessoryInfo est cr√©√© pour chaque accessoire: </p><br><pre> <code class="plaintext hljs">import 'package:scoped_model/scoped_model.dart'; // AccessoryInfo extends Model // so, when accessory value is updated it descends down to // all widgets inside ScopedModelDescendant class AccessoryInfo extends Model { dynamic id; dynamic type; String name; String job_channel; List control; List status; bool selected; Map&lt;dynamic, dynamic&gt; currentState; AccessoryInfo(Map&lt;dynamic, dynamic&gt; obj) { this.id = obj['id']; this.type = obj['type']; this.name = obj['name']; this.job_channel = obj['job_channel']; this.control = obj['control']; this.status = obj['status']; this.currentState = {}; } void updateCurrentState(key, value) { currentState[key] = value; notifyListeners(); } void notify() { notifyListeners(); } }</code> </pre> <br><p>  cet objet est d√©j√† un mod√®le.  Initialement, j'ai √©crit <code>StatefulWidget</code> et <code>setState() {}</code> partout, mais <code>setState() {}</code> ne fonctionne que pour un widget dans lequel les √©couteurs sont enregistr√©s.  Mais pour une gestion d√©taill√©e des accessoires, j'ai cr√©√© initialement de nouvelles pages avec √©tat, et j'ai remarqu√© que le statut n'√©tait pas mis √† jour.  Comme solution - utilis√© <code>ScopedModel</code> . </p><br><p>  Apr√®s r√©ception de la liste des accessoires, nous envoyons pour chacun d'eux une demande de statut et ajoutons √† la liste <code>List &lt;AccessoryInfo&gt;</code> .  Appelez <code>setState() {}</code> , ajoutant ainsi un accessoire pris en charge √† l'interface.  Les types d'accessoires pris en charge sont d√©finis dans <code>ListView.builder</code> et dans <code>./lib/widgets/*.dart</code> .  <code>switch/temperature sensor/radio player/thermostat</code> actuellement pris en charge.  Le principal travail √† venir est d'en ajouter de nouveaux et d'am√©liorer les widgets existants. </p><br><ul><li>  Maintenant, comment cr√©er des √©l√©ments s√©par√©s pour chaque accessoire.  Par exemple, consid√©rons un interrupteur. </li></ul><br><pre> <code class="plaintext hljs"> @override Widget build(BuildContext context) { return new ScopedModel&lt;AccessoryInfo&gt;( model: info, child: ScopedModelDescendant&lt;AccessoryInfo&gt;( builder: (context, child, model) { var cardColor = Theme.of(context).cardColor; dynamic switchState = model.currentState['state']; if (switchState is bool) { if (switchState) { cardColor = Colors.deepPurple; } else { cardColor = Theme.of(context).cardColor; } } return Card( color: cardColor, child: ListTile( selected: false, leading: new Icon(Icons.lightbulb_outline), title: new Text("${model.name}"), onTap: () { // to control accessory value // get status value at first bobaos.getStatusValue( model.id, "state", (bool err, Object payload) { if (err) { return print('error ocurred $payload'); } if (payload is Map) { dynamic currentValue = payload['status']['value']; bool newValue; if (currentValue is bool) { // invert newValue = !currentValue; } else { newValue = false; } // then send new value bobaos.controlAccessoryValue( model.id, {"state": newValue}, (bool err, Object payload) { if (err) { return print('error ocurred $payload'); } }); } }); }, onLongPress: () { // TODO: dialog with additional funcs }, )); })); }</code> </pre> <br><p>  Pour un accessoire de type <code>switch</code> , un √©l√©ment est cr√©√© dans la liste g√©n√©rale des accessoires, lors de l'interaction avec lequel (onTap) une requ√™te est envoy√©e pour obtenir la valeur courante, puis pour commuter cette valeur.  <code>ScopedModel</code> permet de redessiner le widget pour les mises √† jour d'√©tat entrantes. </p><br><p>  Un gestionnaire de clic long n'est pas impl√©ment√© pour cet accessoire. </p><br><p>  Pour un lecteur radio, cela ressemble √† ceci: </p><br><pre> <code class="plaintext hljs"> onLongPress: () { Navigator.of(context).push(MaterialPageRoute( builder: (context) =&gt; AccRadioPlayerControl( info: info, bobaos: bobaos, ))); },</code> </pre> <br><p>  La page <code>AccRadioPlayerControl</code> , qui utilise √©galement <code>ScopedModel</code> pour g√©rer l'√©tat. </p><br><p>  Sur ce point, la description compl√®te de l'algorithme de fonctionnement du programme est √©puis√©e.  Aucune fonctionnalit√© suppl√©mentaire, telle que la m√©morisation du dernier h√¥te, le tri des accessoires en cat√©gories / chambres n'est impl√©ment√©e.  Pour le moment, tout est simple. </p><br><h2 id="problemy">  Les probl√®mes </h2><br><p>  Je vais d√©crire le principal probl√®me qui se pose actuellement.  Je ne comprends toujours pas comment d√©tecter une connexion <code>WebSocket</code> rompue. </p><br><p>  J'utilise: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">classe WebSocket</a> . </p><br><p>  Lorsque l'application / l'appareil est en mode veille pendant une longue p√©riode, la connexion est d√©connect√©e.  Vous devez revenir √† la toute premi√®re page et rouvrir le service d√©couvert. </p><br><h2 id="posleslovie">  Postface </h2><br><p>  D'une part, Flutter est assez rapide pour apprendre et se d√©velopper.  ScopedModel s'est av√©r√© plus compr√©hensible pour moi que redux. <br>  Dart s'est av√©r√© √™tre similaire √† JavaScript familier.  Taper + types dynamiques permettra √† tout le monde d'√©crire de mani√®re aussi pratique. </p><br><p>  Difficult√©s √† √©crire du code: imbrication importante des widgets.  L'enfer de rappel bien connu apr√®s le flutter est diff√©rent.  Le mode Vim et <code>%</code> seront utiles. </p><br><p>  Maintenant, quelques r√©flexions sur l'IoT.  R√©cemment, de plus en plus d'appareils / services intelligents qui n√©cessitent une inscription dans le cloud.  Points de vente chinois, pour l'utilisation desquels vous devez installer l'application, cr√©er un compte, et seulement apr√®s cela, vous pouvez l'utiliser. </p><br><p>  Assistants vocaux.  Alice de Yandex a besoin de son cloud dans lequel le texte reconnu est envoy√©.  Alexa d'Amazon fonctionne de mani√®re similaire. </p><br><p>  Le plus r√©ussi, √† mon avis, est fait par Apple HomeKit en collaboration avec Siri.  Le cloud est utilis√© pour la reconnaissance de texte.  Interaction avec les appareils - dans le r√©seau local. </p><br><p>  Mon avis est que le cloud doit exister pour sa fonction: t√©l√©commande, mise √† jour, etc ... Si l'appareil peut √™tre contr√¥l√© sur un r√©seau local, alors vous devez le faire. </p><br><h2 id="ssylki">  Les r√©f√©rences </h2><br><ol><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">R√©f√©rentiel d'applications</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Documentation de Bobaoskit</a> - d√©crit comment installer bobaoskit.worker et lancer l'accessoire du <code>radio player</code> . </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr440088/">https://habr.com/ru/post/fr440088/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr440074/index.html">Roskomos consid√®re qu'il n'est pas correct de comparer les moteurs Raptor Ilona Mask et RD-180</a></li>
<li><a href="../fr440076/index.html">Traduction et interpr√©tation de la publicit√© de l'anglais vers le russe</a></li>
<li><a href="../fr440078/index.html">Dispositif de compilateur Swift. Partie 4</a></li>
<li><a href="../fr440084/index.html">10 milliards d'exportations de logiciels est n√©gligeable</a></li>
<li><a href="../fr440086/index.html">Le monde des virus MS-DOS</a></li>
<li><a href="../fr440090/index.html">Comment fonctionnent r√©ellement les indicateurs techniques en bourse?</a></li>
<li><a href="../fr440092/index.html">Une enqu√™te math√©matique sur la fausset√© des √©lections des gouverneurs √† Primorye le 16 septembre 2018</a></li>
<li><a href="../fr440094/index.html">Les jardins fleuris sur Mars restent un r√™ve: le projet Mars One a fait faillite</a></li>
<li><a href="../fr440096/index.html">Vuln√©rabilit√© RunC affectant Kubernetes, Docker et containerd</a></li>
<li><a href="../fr440098/index.html">Le clair de lune est toujours enti√®rement automatique. Partie 2. S√©parateur. R√©frig√©rateur. Cube Des algorithmes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>