<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëÖ üéüÔ∏è üÉè Truques de processamento m√©trico em Kapacitor üë©‚Äçüç≥ ‚úãüèæ ‚ôèÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Provavelmente, hoje ningu√©m pergunta por que eles precisam coletar m√©tricas de servi√ßo. O pr√≥ximo passo l√≥gico √© configurar o alerta para as m√©tricas ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Truques de processamento m√©trico em Kapacitor</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ostrovok/blog/478702/">  Provavelmente, hoje ningu√©m pergunta por que eles precisam coletar m√©tricas de servi√ßo.  O pr√≥ximo passo l√≥gico √© configurar o alerta para as m√©tricas coletadas, que o notificar√£o de quaisquer desvios nos dados nos canais convenientes para voc√™ (correio, Slack, Telegram).  No servi√ßo de reserva on-line dos hot√©is <a href="https://www.habr.com/%3Futm_source%3Dhabr%26utm_medium%3Dpr%26utm_campaign%3DErmolaev_dec19%26utm_content%3Darticle">Ostrovok.ru</a> , todas as m√©tricas de nossos servi√ßos s√£o despejadas no InfluxDB e exibidas no Grafana. Tamb√©m √© definido um alerta b√°sico.  Para tarefas como "voc√™ precisa calcular algo e comparar com ele", usamos o Kapacitor. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/oe/cl/5h/oecl5hgip8nkmeau21l2qaem8ek.png"></div><br>  O Kapacitor faz parte da pilha TICK que pode lidar com m√©tricas do InfluxDB.  Ele pode conectar v√°rias dimens√µes entre si (ingressar), calcular algo √∫til a partir dos dados recebidos, escrever o resultado de volta ao InfluxDB, enviar um alerta ao Slack / Telegram / mail. <br><br>  Toda a pilha possui <a href="">documenta√ß√£o</a> detalhada e legal, mas sempre h√° coisas √∫teis que n√£o s√£o explicitamente especificadas nos manuais.  Neste artigo, decidi coletar v√°rias dicas √∫teis n√£o √≥bvias (a sintaxe b√°sica do TICKscipt √© descrita <a href="https://docs.influxdata.com/kapacitor/v1.5/tick/syntax/">aqui</a> ) e mostrar como elas podem ser aplicadas, usando um exemplo de solu√ß√£o de um dos nossos problemas. <br><br>  Vamos l√°! <br><a name="habracut"></a><br><h4>  float &amp; int, erros de c√°lculo </h4><br>  Problema absolutamente padr√£o, √© resolvido atrav√©s de castas: <br><br><pre><code class="python hljs">var alert_float = <span class="hljs-number"><span class="hljs-number">5.0</span></span> var alert_int = <span class="hljs-number"><span class="hljs-number">10</span></span> data|eval(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>: float(<span class="hljs-string"><span class="hljs-string">"value"</span></span>) &gt; alert_float OR float(<span class="hljs-string"><span class="hljs-string">"value"</span></span>) &lt; float(<span class="hljs-string"><span class="hljs-string">"alert_int"</span></span>))</code> </pre> <br><h4>  Usando default () </h4><br>  Se a tag / campo n√£o for preenchida, ocorrer√£o erros nos c√°lculos: <br><br><pre> <code class="python hljs">|default() .tag(<span class="hljs-string"><span class="hljs-string">'status'</span></span>, <span class="hljs-string"><span class="hljs-string">'empty'</span></span>) .field(<span class="hljs-string"><span class="hljs-string">'value'</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>)</code> </pre><br><h4>  jun√ß√£o de preenchimento (interno x externo) </h4><br>  Por padr√£o, a jun√ß√£o eliminar√° pontos onde n√£o h√° dados (internos). <br>  Com fill ('null'), a jun√ß√£o externa ser√° executada, ap√≥s a qual voc√™ precisar√° fazer default () e preencher os valores vazios: <br><br><pre> <code class="python hljs">var data = res1 |join(res2) .<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>(<span class="hljs-string"><span class="hljs-string">'res1'</span></span>, <span class="hljs-string"><span class="hljs-string">'res2) .fill('</span></span>null<span class="hljs-string"><span class="hljs-string">') |default() .field('</span></span>res1.value<span class="hljs-string"><span class="hljs-string">', 0.0) .field('</span></span>res2.value<span class="hljs-string"><span class="hljs-string">', 100.0)</span></span></code> </pre><br>  Ainda h√° uma nuance.  Se no exemplo acima uma das s√©ries (res1 ou res2) estiver vazia, a s√©rie final (dados) tamb√©m estar√° vazia.  Existem v√°rios tickets sobre esse t√≥pico no github ( <a href="https://github.com/influxdata/kapacitor/issues/1633">1633</a> , <a href="https://github.com/influxdata/kapacitor/issues/1871">1871</a> , <a href="https://github.com/influxdata/influxdb/issues/6967">6967</a> ) - estamos aguardando corre√ß√µes e sofrendo um pouco. <br><br><h4>  Usando condi√ß√µes nos c√°lculos (se estiver em lambda) </h4><br><pre> <code class="python hljs">|eval(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-string"><span class="hljs-string">"value"</span></span> &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, true, false)</code> </pre><br><h4>  Os √∫ltimos cinco minutos do pipeline no per√≠odo </h4><br>  Por exemplo, voc√™ precisa comparar os valores dos √∫ltimos cinco minutos com a semana anterior.  Voc√™ pode pegar dois pacotes de dados com dois lotes separados ou extrair parte dos dados de um per√≠odo maior: <br><br><pre> <code class="python hljs"> |where(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>: duration((unixNano(now()) - unixNano(<span class="hljs-string"><span class="hljs-string">"time"</span></span>))/<span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>u) &lt; <span class="hljs-number"><span class="hljs-number">5</span></span>m)</code> </pre><br>  Uma alternativa para os √∫ltimos cinco minutos pode ser usar o n√≥ BarrierNode, que corta os dados antes do tempo especificado: <br><br><pre> <code class="python hljs">|barrier() .period(<span class="hljs-number"><span class="hljs-number">5</span></span>m)</code> </pre><br><h2>  Exemplos de uso de padr√µes Go'sh na mensagem </h2><br>  Os modelos correspondem ao formato do pacote <a href="https://golang.org/pkg/text/template/">text.template</a> , abaixo est√£o algumas tarefas comuns. <br><br><h4>  se-mais </h4><br>  Colocamos as coisas em ordem, n√£o acionamos as pessoas com o texto mais uma vez: <br><br><pre> <code class="python hljs">|alert() ... .message( <span class="hljs-string"><span class="hljs-string">'{{ if eq .Level "OK" }}It is ok now{{ else }}Chief, everything is broken{{end}}'</span></span> )</code> </pre><br><h4>  Duas casas decimais na mensagem </h4><br>  Melhorando a legibilidade da mensagem: <br><br><pre> <code class="python hljs">|alert() ... .message( <span class="hljs-string"><span class="hljs-string">'now value is {{ index .Fields "value" | printf "%0.2f" }}'</span></span> )</code> </pre><br><h4>  Expandindo vari√°veis ‚Äã‚Äãna mensagem </h4><br>  Exibimos mais informa√ß√µes na mensagem para responder √† pergunta "Por que est√° gritando?" <br><br><pre> <code class="python hljs">var warnAlert = <span class="hljs-number"><span class="hljs-number">10</span></span> |alert() ... .message( <span class="hljs-string"><span class="hljs-string">'Today value less then '</span></span>+string(warnAlert)+<span class="hljs-string"><span class="hljs-string">'%'</span></span> )</code> </pre><br><h4>  Identificador de alerta exclusivo </h4><br>  A coisa certa quando h√° mais de um grupo nos dados; caso contr√°rio, apenas um alerta ser√° gerado: <br><br><pre> <code class="python hljs">|alert() ... .id(<span class="hljs-string"><span class="hljs-string">'{{ index .Tags "myname" }}/{{ index .Tags "myfield" }}'</span></span>)</code> </pre><br><h4>  Manipulador personalizado </h4><br>  A grande lista de manipuladores possui exec, que permite executar seu script com os par√¢metros passados ‚Äã‚Äã(stdin) - criatividade e muito mais! <br><br>  Uma de nossas ferramentas personalizadas √© um pequeno script python para enviar notifica√ß√µes para folga. <br>  Primeiro, quer√≠amos enviar uma foto de uma grafana protegida por autoriza√ß√£o na mensagem.  Depois - escreva OK no encadeamento para o alerta anterior do mesmo grupo, e n√£o como uma mensagem separada.  Um pouco mais tarde - para anexar o erro mais comum nos √∫ltimos X minutos √† mensagem. <br><br>  Um t√≥pico separado √© a comunica√ß√£o com outros servi√ßos e quaisquer a√ß√µes iniciadas por um alerta (somente se o seu monitoramento funcionar bem o suficiente). <br>  Um exemplo de descri√ß√£o de um manipulador, em que slack_handler.py √© nosso script auto-escrito: <br><br><pre> <code class="python hljs">topic: slack_graph id: slack_graph.alert match: level() != INFO AND changed() == TRUE kind: <span class="hljs-keyword"><span class="hljs-keyword">exec</span></span> options: prog: /sbin/slack_handler.py args: [<span class="hljs-string"><span class="hljs-string">"-c"</span></span>, <span class="hljs-string"><span class="hljs-string">"CHANNELID"</span></span>, <span class="hljs-string"><span class="hljs-string">"--graph"</span></span>, <span class="hljs-string"><span class="hljs-string">"--search"</span></span>]</code> </pre><br><h2>  Como estrear? </h2><br><h4>  Op√ß√£o de sa√≠da de log </h4><br><pre> <code class="python hljs">|log() .level(<span class="hljs-string"><span class="hljs-string">"error"</span></span>) .prefix(<span class="hljs-string"><span class="hljs-string">"something"</span></span>)</code> </pre><br>  Assista (cli): kapacitor -url <a href="http://host-or-ip/">host-or-ip</a> : 9092 logs lvl = error <br><br><h4>  Variante com httpOut </h4><br>  Mostra dados no pipeline atual: <br><br><pre> <code class="python hljs">|httpOut(<span class="hljs-string"><span class="hljs-string">'something'</span></span>)</code> </pre><br>  Assista (obtenha): <a href="http://host-or-ip/">host-ou-ip</a> : 9092 / kapacitor / v1 / tasks / task_name / something <br><br><h4>  Esquema de execu√ß√£o </h4><br><ul><li>  Cada tarefa retorna uma √°rvore de execu√ß√£o com n√∫meros √∫teis no formato <a href="https://www.graphviz.org/">graphviz</a> . </li><li>  Pegue o bloco de <a href="http://host-or-ip:9092/kapacitor/v1/tasks/task_name%3Fdot-view%3Dlabels">pontos</a> . </li><li>  N√≥s inserimos no visualizador, <a href="https://dreampuf.github.io/GraphvizOnline">aproveite</a> . <br></li></ul><br><br><h2>  Onde mais posso obter um ancinho </h2><br><h4>  carimbo de data / hora do influxdb na grava√ß√£o </h4><br>  Por exemplo, configuramos um alerta para a soma de solicita√ß√µes por hora (groupBy (1h)) e queremos registrar o alerta ocorrido no influxdb (para mostrar lindamente o fato de um problema no gr√°fico em grafana). <br><br>  influxDBOut () gravar√° o valor de tempo do alerta no registro de data e hora, respectivamente, o ponto no gr√°fico ser√° registrado mais cedo / mais tarde que o alerta veio. <br><br>  Quando a precis√£o √© necess√°ria: contornamos esse problema chamando um manipulador personalizado, que gravar√° dados no influxdb com o carimbo de data / hora atual. <br><br><h4>  janela de encaixe, criar e implantar </h4><br>  Na inicializa√ß√£o, o kapacitor pode carregar tarefas, modelos e manipuladores a partir do diret√≥rio especificado na configura√ß√£o no bloco [load]. <br><br>  Para criar corretamente uma tarefa, s√£o necess√°rios os seguintes itens: <br><br><ol><li>  Nome do arquivo - expande para id / script name </li><li>  Tipo - fluxo / lote </li><li>  dbrp - palavra-chave para indicar em qual banco de dados + pol√≠tica o script funciona (dbrp "supplier". "autogen") </li></ol><br>  Se n√£o houver linha com o dbrp em alguma tarefa em lote, todo o servi√ßo se recusar√° a iniciar e escrever honestamente sobre isso no log. <br><br>  No cron√≥grafo, pelo contr√°rio, essa linha n√£o deve ser, n√£o √© aceita pela interface e gera um erro. <br><br>  Hack ao criar o cont√™iner: o Dockerfile sai com -1 se houver linhas com //.+dbrp, que entender√£o imediatamente o motivo do arquivo ao criar a compila√ß√£o. <br><br><h4>  junte um a muitos </h4><br>  Exemplo de tarefa: voc√™ precisa ter o percentil 95 do tempo de opera√ß√£o do servi√ßo por semana, comparar cada minuto dos √∫ltimos 10 com esse valor. <br><br>  Voc√™ n√£o pode associar um a muitos, a √∫ltima / m√©dia / mediana por grupo de pontos transforma o n√≥ em fluxo; o erro "n√£o √© poss√≠vel adicionar bordas incompat√≠veis filho: lote -&gt; fluxo" retornar√°. <br><br>  O resultado do lote, como vari√°vel em uma express√£o lambda, tamb√©m n√£o √© substitu√≠do. <br><br>  Existe uma op√ß√£o para salvar os n√∫meros necess√°rios do primeiro lote em um arquivo via udf e carreg√°-lo atrav√©s do carregamento lateral. <br><br><h2>  O que n√≥s decidimos? </h2><br>  Temos cerca de 100 fornecedores de hot√©is, cada um deles pode ter v√°rias conex√µes, vamos cham√°-lo de canal.  Existem aproximadamente 300 desses canais; cada um deles pode cair.  De todas as m√©tricas registradas, monitoraremos a taxa de erros (solicita√ß√µes e erros). <br><br><h4>  Por que n√£o grafana? </h4><br>  Os alertas de erro configurados no grafan t√™m v√°rias desvantagens.  Alguns cr√≠ticos, outros podem fechar os olhos, dependendo da situa√ß√£o. <br><br>  O Grafana n√£o sabe calcular entre dimens√µes + alerta, mas precisamos de uma taxa (pedidos-erros) / pedidos. <br><br>  Os erros parecem cru√©is: <br><br><img src="https://habrastorage.org/webt/iq/0h/nq/iq0hnqauk_l0nm4akwynyeb0hbc.png"><br><br>  E menos cruel quando visualizado com solicita√ß√µes bem-sucedidas: <br><br><img src="https://habrastorage.org/webt/mw/vs/ok/mwvsok9hb7qfa3lifpna4_rrno4.png"><br><br>  Ok, podemos pr√©-calcular a taxa no servi√ßo antes da grafana e, em alguns casos, ele far√°.  Mas n√£o a nossa, porque  para cada canal, sua propor√ß√£o √© considerada "normal" e os alertas funcionam de acordo com valores est√°ticos (olhamos com os olhos, mudamos, se frequentemente alertas). <br><br>  Estes s√£o exemplos de "normal" para diferentes canais: <br><br><img src="https://habrastorage.org/webt/3f/d5/fg/3fd5fg6los9dg7pjlkuanfuv_mk.png"><br><br><img src="https://habrastorage.org/webt/hp/n-/q6/hpn-q6cnqtaugwlsmch1jvapnuc.png"><br><br>  Negligenciamos o par√°grafo anterior e assumimos que todos os fornecedores t√™m uma imagem "normal".  Agora est√° tudo bem, e podemos conviver com alertas na grafana? <br>  Podemos, mas realmente n√£o queremos, porque devemos escolher uma das op√ß√µes: <br>  a) fazer muitos gr√°ficos para cada canal separadamente (e acompanh√°-los dolorosamente) <br>  b) deixe um gr√°fico com todos os canais (e se perca em linhas coloridas e alertas ajustados) <br><br><img src="https://habrastorage.org/webt/sk/8c/-b/sk8c-bayyodb08xuchmfbfjhe8q.png"><br><br><h4>  Como voc√™ fez isso? </h4><br>  Novamente, a documenta√ß√£o tem um bom exemplo inicial ( <a href="https://docs.influxdata.com/kapacitor/v1.5/guides/join_backfill/">Calculando taxas entre s√©ries unidas</a> ), voc√™ pode espiar ou tomar como base tarefas similares. <br><br>  O que voc√™ fez como resultado: <br><br><ul><li>  junte dois epis√≥dios em poucas horas, agrupando por canal; </li><li>  preencher a s√©rie por grupos, se n√£o houver dados; </li><li>  comparar a mediana dos √∫ltimos 10 minutos com os dados anteriores; </li><li>  gritamos se encontrarmos algo; </li><li>  escreva taxas calculadas e ocorreu alertas no influxdb; </li><li>  envie uma mensagem √∫til para folga. </li></ul><br>  Na minha opini√£o, gerenciamos da melhor maneira poss√≠vel tudo o que gostar√≠amos de obter na sa√≠da (e at√© um pouco mais com manipuladores personalizados). <br><br>  No github.com, voc√™ pode ver o <a href="">c√≥digo de amostra</a> e o <a href="">diagrama m√≠nimo (graphviz) do</a> script resultante. <br><br><div class="spoiler">  <b class="spoiler_title">Exemplo do c√≥digo resultante:</b> <div class="spoiler_text"><pre> <code class="python hljs">dbrp <span class="hljs-string"><span class="hljs-string">"supplier"</span></span>.<span class="hljs-string"><span class="hljs-string">"autogen"</span></span> var name = <span class="hljs-string"><span class="hljs-string">'requests.rate'</span></span> var grafana_dash = <span class="hljs-string"><span class="hljs-string">'pczpmYZWU/mydashboard'</span></span> var grafana_panel = <span class="hljs-string"><span class="hljs-string">'26'</span></span> var period = <span class="hljs-number"><span class="hljs-number">8</span></span>h var todayPeriod = <span class="hljs-number"><span class="hljs-number">10</span></span>m var every = <span class="hljs-number"><span class="hljs-number">1</span></span>m var warnAlert = <span class="hljs-number"><span class="hljs-number">15</span></span> var warnReset = <span class="hljs-number"><span class="hljs-number">5</span></span> var reqQuery = <span class="hljs-string"><span class="hljs-string">'SELECT sum("count") AS value FROM "supplier"."autogen"."requests"'</span></span> var errQuery = <span class="hljs-string"><span class="hljs-string">'SELECT sum("count") AS value FROM "supplier"."autogen"."errors"'</span></span> var prevErr = batch |query(errQuery) .period(period) .every(every) .groupBy(<span class="hljs-number"><span class="hljs-number">1</span></span>m, <span class="hljs-string"><span class="hljs-string">'channel'</span></span>, <span class="hljs-string"><span class="hljs-string">'supplier'</span></span>) var prevReq = batch |query(reqQuery) .period(period) .every(every) .groupBy(<span class="hljs-number"><span class="hljs-number">1</span></span>m, <span class="hljs-string"><span class="hljs-string">'channel'</span></span>, <span class="hljs-string"><span class="hljs-string">'supplier'</span></span>) var rates = prevReq |join(prevErr) .<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>(<span class="hljs-string"><span class="hljs-string">'req'</span></span>, <span class="hljs-string"><span class="hljs-string">'err'</span></span>) .tolerance(<span class="hljs-number"><span class="hljs-number">1</span></span>m) .fill(<span class="hljs-string"><span class="hljs-string">'null'</span></span>) //   ,     |default() .field(<span class="hljs-string"><span class="hljs-string">'err.value'</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>) .field(<span class="hljs-string"><span class="hljs-string">'req.value'</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>) // <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>  <span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>:  ,     |eval(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-string"><span class="hljs-string">"err.value"</span></span> &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">100.0</span></span> * (float(<span class="hljs-string"><span class="hljs-string">"req.value"</span></span>) - float(<span class="hljs-string"><span class="hljs-string">"err.value"</span></span>)) / float(<span class="hljs-string"><span class="hljs-string">"req.value"</span></span>), <span class="hljs-number"><span class="hljs-number">100.0</span></span>)) .<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>(<span class="hljs-string"><span class="hljs-string">'rate'</span></span>) //      rates |influxDBOut() .quiet() .create() .database(<span class="hljs-string"><span class="hljs-string">'kapacitor'</span></span>) .retentionPolicy(<span class="hljs-string"><span class="hljs-string">'autogen'</span></span>) .measurement(<span class="hljs-string"><span class="hljs-string">'rates'</span></span>) //     <span class="hljs-number"><span class="hljs-number">10</span></span> ,   var todayRate = rates |where(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>: duration((unixNano(now()) - unixNano(<span class="hljs-string"><span class="hljs-string">"time"</span></span>)) / <span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>u) &lt; todayPeriod) |median(<span class="hljs-string"><span class="hljs-string">'rate'</span></span>) .<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>(<span class="hljs-string"><span class="hljs-string">'median'</span></span>) var prevRate = rates |median(<span class="hljs-string"><span class="hljs-string">'rate'</span></span>) .<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>(<span class="hljs-string"><span class="hljs-string">'median'</span></span>) var joined = todayRate |join(prevRate) .<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>(<span class="hljs-string"><span class="hljs-string">'today'</span></span>, <span class="hljs-string"><span class="hljs-string">'prev'</span></span>) |httpOut(<span class="hljs-string"><span class="hljs-string">'join'</span></span>) var trigger = joined |alert() .warn(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>: (<span class="hljs-string"><span class="hljs-string">"prev.median"</span></span> - <span class="hljs-string"><span class="hljs-string">"today.median"</span></span>) &gt; warnAlert) .warnReset(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>: (<span class="hljs-string"><span class="hljs-string">"prev.median"</span></span> - <span class="hljs-string"><span class="hljs-string">"today.median"</span></span>) &lt; warnReset) .flapping(<span class="hljs-number"><span class="hljs-number">0.25</span></span>, <span class="hljs-number"><span class="hljs-number">0.5</span></span>) .stateChangesOnly() //   message      .message( <span class="hljs-string"><span class="hljs-string">'{{ .Level }}: {{ index .Tags "channel" }} err/req ratio ({{ index .Tags "supplier" }}) {{ if eq .Level "OK" }}It is ok now{{ else }} '</span></span>+string(todayPeriod)+<span class="hljs-string"><span class="hljs-string">' median is {{ index .Fields "today.median" | printf "%0.2f" }}%, by previous '</span></span>+string(period)+<span class="hljs-string"><span class="hljs-string">' is {{ index .Fields "prev.median" | printf "%0.2f" }}%{{ end }} http://grafana.ostrovok.in/d/'</span></span>+string(grafana_dash)+ <span class="hljs-string"><span class="hljs-string">'?var-supplier={{ index .Tags "supplier" }}&amp;var-channel={{ index .Tags "channel" }}&amp;panelId='</span></span>+string(grafana_panel)+<span class="hljs-string"><span class="hljs-string">'&amp;fullscreen&amp;tz=UTC%2B03%3A00'</span></span> ) .id(<span class="hljs-string"><span class="hljs-string">'{{ index .Tags "name" }}/{{ index .Tags "channel" }}'</span></span>) .levelTag(<span class="hljs-string"><span class="hljs-string">'level'</span></span>) .messageField(<span class="hljs-string"><span class="hljs-string">'message'</span></span>) .durationField(<span class="hljs-string"><span class="hljs-string">'duration'</span></span>) .topic(<span class="hljs-string"><span class="hljs-string">'slack_graph'</span></span>) // <span class="hljs-string"><span class="hljs-string">"today.median"</span></span>   <span class="hljs-string"><span class="hljs-string">"value"</span></span>,        (keep) trigger |eval(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>: <span class="hljs-string"><span class="hljs-string">"today.median"</span></span>) .<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>(<span class="hljs-string"><span class="hljs-string">'value'</span></span>) .keep() |influxDBOut() .quiet() .create() .database(<span class="hljs-string"><span class="hljs-string">'kapacitor'</span></span>) .retentionPolicy(<span class="hljs-string"><span class="hljs-string">'autogen'</span></span>) .measurement(<span class="hljs-string"><span class="hljs-string">'alerts'</span></span>) .tag(<span class="hljs-string"><span class="hljs-string">'alertName'</span></span>, name)</code> </pre><br></div></div><br><h2>  Qual √© a conclus√£o? </h2><br>  O Kapacitor √© muito bom em monitorar alertas com v√°rios grupos, executando c√°lculos adicionais em m√©tricas j√° gravadas, executando a√ß√µes personalizadas e executando scripts (udf). <br><br>  O limite de entrada n√£o √© muito alto - tente se o grafana ou outras ferramentas n√£o satisfizerem totalmente a sua lista de desejos. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt478702/">https://habr.com/ru/post/pt478702/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt478690/index.html">Montagem din√¢mica e implanta√ß√£o de imagens do Docker com werf usando o site de exemplo da documenta√ß√£o com vers√£o</a></li>
<li><a href="../pt478692/index.html">Como o Java 8 √© suportado no Android</a></li>
<li><a href="../pt478694/index.html">Como recomendamos os cat√°logos mais recentes no cinema online ivi (+ c√≥digo Python)</a></li>
<li><a href="../pt478696/index.html">Como visitei o Urban Tech 2019. Relat√≥rio de eventos</a></li>
<li><a href="../pt478698/index.html">Fazemos um plano interativo do terreno em 15 minutos</a></li>
<li><a href="../pt478704/index.html">O que fazer se as correspond√™ncias j√° tiverem chegado ao Spam: 5 etapas pr√°ticas</a></li>
<li><a href="../pt478706/index.html">Arquiteto de alta carga. Novo curso da OTUS</a></li>
<li><a href="../pt478708/index.html">Como os randomizadores permitem dar nova vida a jogos antigos</a></li>
<li><a href="../pt478710/index.html">Implanta√ß√£o f√°cil e detalhada de aplicativos no cartucho Tarantool (parte 1)</a></li>
<li><a href="../pt478712/index.html">Como n√£o pagar pela hospedagem Java ou in√≠cio r√°pido com o Google App Engine</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>