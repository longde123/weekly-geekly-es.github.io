<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>♂️ 📋 🧑🏾‍🤝‍🧑🏼 介绍用于Kubernetes资源跟踪的kubedog库 📐 💟 😒</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="我们很高兴地宣布，面向DevOps专家（不仅限于kubedog）的Flant公司将进行新的开源开发。 这是一个Go编写的库和基于它的CLI，用于跟踪Kubernetes资源事件并收集其日志。 


 该库当前支持跟踪以下资源：Pod（和容器），Job，Deployment，StatefulSet和D...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>介绍用于Kubernetes资源跟踪的kubedog库</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/434160/"> 我们很高兴地宣布，面向DevOps专家（不仅限于<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><b>kubedog）的Flant</b></a>公司将进行新的开源开发。 这是一个Go编写的库和基于它的CLI，用于跟踪Kubernetes资源事件并收集其日志。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/-j/e0/zu/-je0zuivsq7vqj5nb7gpmdkhuzu.jpeg"></div><br> 该库当前支持跟踪以下资源：Pod（和容器），Job，Deployment，StatefulSet和DaemonSet。 事件和日志通过回调传输。 <a name="habracut"></a><br><br>  kubedog CLI有两种操作模式： <br><br><ul><li>  <b>推出跟踪</b> -跟踪资源，直到到达“就绪”状态为止；如果出现错误，则退出以方便在CI / CD中使用； </li><li>  <b>跟随</b>打印事件并记录到屏幕而没有退出，类似于<code>tail -f</code> 。 </li></ul><br><h2> 问题 </h2><br> 如果已经存在类似的项目，为什么为什么要开始编写新的库<i>（请参阅<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">本评论中的</a> “使用日志”）</i> ？ 我们的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">DevOps dapp实用程序中</a>使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Kubedog</a>来跟踪Helm图表<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">的推出</a> 。  Helm本身不知道如何监视其添加的资源状态，并且在Helm和分till之间的GRPC交互级别未提供日志传输。 在这种情况下，存在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">我们的问题3481</a> ， <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">我们</a>在该<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">问题</a>的框架内实施了对附加资源的跟踪...但是，由于所有工作都集中在新版本的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Helm 3</a>上，因此Helm项目现在不愿为Helm 2添加新功能。 因此，我们决定将kubedog分离到一个单独的项目中。 <br><br> 资源跟踪库<b>需要</b>什么？ <br><br><ul><li> 获取属于资源（例如，部署）的Pod的日志。 </li><li> 响应属于该资源的Pod组成的更改：添加来自新Pod的接收日志，禁用来自旧ReplicaSets的Pod的日志。 </li><li> 跟踪<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">事件</a> ，其中会解密各种错误。 例如，由于图像未知而无法创建Pod，或者创建了Pod，但是模板中指定的命令不在图像中。 </li><li> 另外一个需求是跟踪资源从<code>rollout</code>到<code>ready</code>模式的过渡。 每个资源对此都有自己的条件。 </li></ul><br> 您可能会猜到，在kubedog中，我们尝试<b>将上述所有因素都考虑在内</b> 。 <br><br> 在开始一些新工作时，他们会很好地分析现有的解决方案。 但事实证明，尽管有许多CLI形式的解决方案，但根本没有Go库。 因此，我们只能对现有CLI实用程序的主要功能进行较小的比较，以跟踪Kubernetes资源。 <br><br><h2> 现有解决方案 </h2><br><h3>  kubespy </h3><br>  → <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">GitHub</a></i> <br><br><ul><li> 能够仅监视部署和服务，并对新Pod做出反应。 </li><li> 有一个用于描述资源及其状态以及以json diff形式输出更改的跟踪模式。 </li><li> 更改以彩色表格形式显示，表示副本集和条件的状态。 </li><li> 不显示Pod日志。 </li><li> 它是用Go编写的，但不能用作库。 </li></ul><br><h3>  kubetail </h3><br>  → <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">GitHub</a></i> <br><br><ul><li> 一个bash脚本，调用kubectl。 </li><li> 能够显示现有Pod的日志。 </li><li> 它不会检测到新的Pod；如果发生回滚，则需要重新启动kubetail。 </li></ul><br><h3> 船尾 </h3><br>  → <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">GitHub</a></i> <br><br><ul><li> 显示通过pod-query过滤的Pod日志。 </li><li> 发现新豆荚。 </li><li> 日志线带有颜色，可以更好地感知。 </li><li> 显示使用容器中的名称添加和删除Pod的事件。 </li><li> 它不遵循事件，因此不显示Pod错误的原因。 </li><li> 它是用Go编写的，但不能用作库。 </li></ul><br><h3> 凯尔 </h3><br>  → <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">GitHub</a></i> <br><br><ul><li> 能够同时显示来自不同名称空间的不同资源的日志。 </li><li> 不监视事件，不显示错误原因，例如，对于Deployment。 </li><li> 不绘制Pod的原木。 </li><li> 它是用Go编写的，但不能用作库。 </li></ul><br><h3>  k8stail </h3><br>  → <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">GitHub</a></i> <br><br><ul><li> 通过名称空间和标签选择Pod。 </li><li> 跟踪新的，删除的。 </li><li> 不遵循事件，不会显示错误。 </li><li> 在Go中，但不在图书馆中。 </li></ul><br><h3> 酷狗 </h3><br>  → <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">GitHub</a></i> <br><br><ul><li>  CLI在两种模式下运行：无限跟踪和跟踪，直到资源变为READY状态为止。 </li><li> 跟踪一种资源。 </li><li> 对资源更改做出反应，订阅新Pod的日志。 </li><li> 能够监视Deployment，StatefulSet，DaemonSet，Job或单独的Pod。 </li><li> 用Go语言编写，您可以将其用作库来向程序添加资源，以监视资源状态并从容器接收日志。 </li></ul><br> 如果仔细观察，您可以说每个实用程序都在某种程度上胜过其竞争对手，并且没有一个赢家可以胜任其他任何人所能做的事情。 <br><br><h2> 太棒了！ </h2><br>  kubedog工作的实质如下：对于指定的资源，在事件和属于该资源的Pod上运行Watchers，并在出现Pod时运行其记录器。 资源发生的所有事情都通过调用回调广播给客户端。 <br><br> 让我们看一下DaemonSet的示例，该示例可用于使用该库的代码。  Deployment，StatefulSet和DaemonSet的回调接口相同*-这是<a href=""><code>ControllerFeed</code></a> ： <br><br><pre> <code class="plaintext hljs">type ControllerFeed interface { Added(ready bool) error Ready() error Failed(reason string) error EventMsg(msg string) error AddedReplicaSet(ReplicaSet) error AddedPod(ReplicaSetPod) error PodLogChunk(*ReplicaSetPodLogChunk) error PodError(ReplicaSetPodError) error }</code> </pre> <br>  *例外是<code>AddedReplicaSet</code> ，它仅对部署有意义（您无法定义此方法来跟踪DaemonsSet）。 <br><br> 其他接口方法的说明： <br><br><ul><li>  <code>Added</code>对应于选定资源的观察者的<code>watch.Added</code>事件； </li><li> 资源进入<code>Ready</code>状态时（例如，对于DaemonSet，这是更新的和可用的Pods的数量与“所需”的Pods的数量一致的时刻），将调用<code>Ready</code> 。 </li><li>  <code>Failed</code> -删除资源或接收到带有错误原因和错误说明的事件（例如<code>FailedCreate</code> ）时，将<code>FailedCreate</code> ； </li><li> 对于从资源或其<code>EventMsg</code>接收到的每个事件，都会调用<code>EventMsg</code> ：这些事件是有关资源创建，图像上传等的事件。 包括错误信息； </li><li>  <code>AddedPod</code>一种方法，您可以通过它捕捉创建新<code>AddedPod</code>的时刻； </li><li> 当另一条日志来自Kubernetes API时，将调用PodLogChunk。 </li><li> 如果Pod失败，将<code>PodError</code> 。 </li></ul><br> 每个回调可能会返回<code>StopTrack</code>类型<code>StopTrack</code>并且跟踪将完成。 因此，例如，在推出跟踪器中完成-“ <code>Ready</code> <a href=""><code> StopTrack</code></a> ，CLI完成其工作。 <br><br> 为了便于定义回调，在创建对象时，可以使用<code>ControllerFeedProto</code>结构来确定所需的回调方法。 <br><br> 例如，这就是<b>DaemonSet日志无休止的输出的样子，其中</b>没有有关事件和状态的其他信息： <br><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// kubedog     Kubernetes',    // . https://github.com/flant/kubedog/blob/master/pkg/kube/kube.go kubeClient, err := kubernetes.NewForConfig(config) if err != nil { return err } feed := &amp;tracker.ControllerFeedProto{ PodLogChunkFunc: func(chunk *tracker.ReplicaSetPodLogChunk) error { for _, line := range chunk.LogLines { fmt.Printf("&gt;&gt; po/%s %s: %s\n", chunk.PodName, chunk.ContainerName, line) } return nil }, } //    timeout   API   ,     .   ,     ,    Pod'. opts := tracker.Options{ Timeout: time.Second * time.Duration(300), LogsFromTime: time.Now(), } tracker.TrackDaemonSet(dsName, dsNamespace, kubeClient, feed, opts)</span></span></code> </pre> <br> 最后一个调用是一个<b>阻塞的</b>调用：它启动了一个无限循环，从Kubernetes接收事件并调用相应的回调。 您可以通过从回调返回<code>StopTrack</code>来以编程方式中断此循环。 <br><br><h2> 应用实例 </h2><br>  <a href="">可以</a>在dapp实用程序中<a href="">看到</a>将kubedog用作库。 在此运行现成的展示跟踪器，以检查Helm创建或更新的资源。 <br><br>  Kubedog CLI能够<b>帮助在CI / CD系统中进行部署</b> ，无论是否使用它：kubectl，Helm或其他。 毕竟，您可以运行<code>kubectl apply</code> ，然后运行<code>kubectl apply</code> <code>kubedog rollout track</code> ，并且如果资源有问题，则在<code>kubedog rollout track</code>日志中将看到错误。  kubedog的这种使用将有助于减少诊断推出问题的时间。 <br><br><h2> 接下来是什么？ </h2><br> 我们计划在支持更多资源的方向上开发库-例如，我真的很想关注Service and Ingress。 另外，应该对Event'ah中的<code>reason</code>分类进行工作，以便更准确地确定我们可以假定资源推出失败的时刻。 库开发的另一个载体是一次跟踪多个资源，例如通过<code>labelSelector</code>或通过名称空间。 我还希望支持各种注释，这些注释可以更改跟踪的性质，例如，对于Helm挂钩，但这对于dapp仍然更为重要。 <br><br> 在不久的将来，重点将放在库上，但是还计划对CLI进行改进：更便捷的命令和标志，日志颜色，有关删除Pod的消息，如船尾一样。 我们也正在考虑创建一个交互模式的可能性，其中一个窗口中包含部署状态表和事件，而另一个窗口中包含日志。 <br><br><h2> 怎么尝试？ </h2><br>  Bintray上提供了用于Linux和macOS的kubedog CLI构建。 <br><br> 真的很期待您在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">GitHub上的</a>反馈和问题！ <br><br><h2> 聚苯乙烯 </h2><br> 另请参阅我们的博客： <br><br><ul><li>  “ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Kubernetes的Kubebox和其他控制台外壳</a> ”； </li><li>  “ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">介绍日志仓库-一个用于在Kubernetes中处理日志的开源系统</a> ”； </li><li>  “我们<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">正式代表dapp-支持CI / CD的DevOps-utility</a> ”； </li><li>  “ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">使用Kubernetes作为可负担的服务提供基础设施</a> 。” </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN434160/">https://habr.com/ru/post/zh-CN434160/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN434146/index.html">十大IT电影</a></li>
<li><a href="../zh-CN434150/index.html">欧洲求职的特点</a></li>
<li><a href="../zh-CN434154/index.html">新年数据集2018：俄语的开放语义</a></li>
<li><a href="../zh-CN434156/index.html">Gerasimov的分形。 找到一个模式。 黑表</a></li>
<li><a href="../zh-CN434158/index.html">OZON Inside：感觉像一家初创企业</a></li>
<li><a href="../zh-CN434162/index.html">人脸识别Ivideon：最实惠的企业人脸识别系统</a></li>
<li><a href="../zh-CN434164/index.html">从IBM Notes / Domino迁移到Zimbra Collaboration Suite</a></li>
<li><a href="../zh-CN434166/index.html">联想YogaBook C930：可一次更换四个小工具的设备</a></li>
<li><a href="../zh-CN434168/index.html">2018年DotNext采访.NET能力中心负责人</a></li>
<li><a href="../zh-CN434170/index.html">如何在Pathfinder：Kingmaker中创建声音</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>