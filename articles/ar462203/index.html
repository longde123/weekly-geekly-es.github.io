<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>๐๏ธ ๐คผ ๐ก KVM (ุชุญุช) VDI ูุน ุงูุฃุฌูุฒุฉ ุงูุงูุชุฑุงุถูุฉ ููุฑุฉ ูุงุญุฏุฉ ุจุงุณุชุฎุฏุงู ุจุงุด ๐๐พ ๐ฉ๐ฝ ๐ฏ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ูู ูู ูุฐุง ุงูููุงู ูุ 
 ูุฏ ุชููู ูุฐู ุงูููุงูุฉ ุฐุงุช ุฃูููุฉ ููุณุคููู ุงููุธุงู ุงูุฐูู ูุงุฌููุง ูููุฉ ุฅูุดุงุก ุฎุฏูุฉ ูุธุงุฆู "ููุฑุฉ ูุงุญุฏุฉ". 

 ูุงุชุญุฉ 
 ุทููุจ ูู ูุณู ุฏุนู ุชูููููุฌ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>KVM (ุชุญุช) VDI ูุน ุงูุฃุฌูุฒุฉ ุงูุงูุชุฑุงุถูุฉ ููุฑุฉ ูุงุญุฏุฉ ุจุงุณุชุฎุฏุงู ุจุงุด</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl">
      <div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/462203/" style=";text-align:right;direction:rtl"><h4 style=";text-align:right;direction:rtl">  ูู ูู ูุฐุง ุงูููุงู ูุ </h4><br>  ูุฏ ุชููู ูุฐู ุงูููุงูุฉ ุฐุงุช ุฃูููุฉ ููุณุคููู ุงููุธุงู ุงูุฐูู ูุงุฌููุง ูููุฉ ุฅูุดุงุก ุฎุฏูุฉ ูุธุงุฆู "ููุฑุฉ ูุงุญุฏุฉ". <br><br><h4 style=";text-align:right;direction:rtl">  ูุงุชุญุฉ </h4><br>  ุทููุจ ูู ูุณู ุฏุนู ุชูููููุฌูุง ุงููุนูููุงุช ุจุดุฑูุฉ ูุงููุฉ ุชุชุทูุฑ ุฏููุงููููุงู ููุฏููุง ุดุจูุฉ ุฅูููููุฉ ุตุบูุฑุฉ ุชูุธูู "ูุญุทุงุช ุฎุฏูุฉ ุฐุงุชูุฉ" ูุงุณุชุฎุฏุงููุง ูู ูุจู ุนููุงุฆูุง ุงูุฎุงุฑุฌููู.  ูุงู ูู ุงูููุชุฑุถ ุฃู ูุชู ุงุณุชุฎุฏุงู ุจูุงูุงุช ุงููุญุทุฉ ููุชุณุฌูู ุนูู ุจูุงุจุงุช ุงูุดุฑูุฉ ุงูุฎุงุฑุฌูุฉ ูุชูุฒูู ุงูุจูุงูุงุช ูู ุงูุฃุฌูุฒุฉ ุงูุฎุงุฑุฌูุฉ ูุงูุนูู ูุน ุงูุจูุงุจุงุช ุงูุญููููุฉ. <br><br>  ูุงู ุงูุฌุงูุจ ุงูููู ูู ุญูููุฉ ุฃู ูุนุธู ุงูุจุฑุงูุฌ ูุชู "ุดุญุฐูุง" ููุธุงู MS Windows (ุนูู ุณุจูู ุงููุซุงู ุ "ุงูุฅุนูุงู") ุ ูุนูู ุงูุฑุบู ูู ุงูุชุญุฑู ูุญู ุงูุชูุณููุงุช ุงูููุชูุญุฉ ุ ูุธู MS Office ูู ุงููุนูุงุฑ ุงูููููู ูู ุชุจุงุฏู ุงููุณุชูุฏุงุช ุงูุฅููุชุฑูููุฉ.  ูุจุงูุชุงูู ุ ูู ูุชููู ูู ุฑูุถ MS Windows ุนูุฏ ุญู ูุฐู ุงููุดููุฉ. <br><a name="habracut"></a><br>  ูุงูุช ุงููุดููุฉ ุงูุฑุฆูุณูุฉ ูู ุฅููุงููุฉ ุชุฌููุน ุงูุจูุงูุงุช ุงููุฎุชููุฉ ูู ุฌูุณุงุช ุงููุณุชุฎุฏู ุ ููุง ูุฏ ูุคุฏู ุฅูู ุชุณุฑุจูุง ุฅูู ุฌูุงุช ุฎุงุฑุฌูุฉ.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ูุฐุง ุงููููู ุจุงููุนู ุงูุณูุงุญ MFC ูุฃุณูู</a> .  ูููู ุนูู ุนูุณ ูุคุณุณุฉ ุงูุชูููู ุงูุฃุตุบุฑ ุดุจู ุงููุถุงุฆูุฉ (ูุคุณุณุฉ ุงูุญูู ุงูุฐุงุชู) ุ ุณูุชู ูุนุงูุจุฉ ุงูููุธูุงุช ุบูุฑ ุงูุญููููุฉ ุฃูุซุฑ ูู ูุฐุง ุงูููุน ูู ุฃูุฌู ุงููุตูุฑ.  ูุงูุช ุงููุดููุฉ ุงูุญุฑุฌุฉ ุงูุชุงููุฉ ูู ุงูุญุงุฌุฉ ุฅูู ุงูุนูู ูุน ูุณุงุฆุท ุงูุชุฎุฒูู ุงูุฎุงุฑุฌูุฉ ุ ูุงูุชู ุณูููู ุนูููุง ุ ุจูู ุงููุณุงุฆู ุ ูุฌููุนุฉ ูู ุงูุจุฑุงูุฌ ุงูุถุงุฑุฉ.  ุชู ุงุนุชุจุงุฑ ุงุญุชูุงู ุฏุฎูู ุงูุจุฑุงูุฌ ุงูุถุงุฑุฉ ูู ุงูุฅูุชุฑูุช ุฃูู ุชุฑุฌูุญูุง ุจุณุจุจ ุชูููุฏ ุงููุตูู ุฅูู ุงูุฅูุชุฑูุช ุนุจุฑ ูุงุฆูุฉ ุจูุถุงุก ูู ุงูุนูุงููู ุ ูุงูุถู ููุธูู ุงูุฅุฏุงุฑุงุช ุงูุฃุฎุฑู ุฅูู ูุถุน ุงููุชุทูุจุงุช ุ ูุฌุนู ูุชุทูุจุงุชูู ูุฑุบุจุงุชูู ุ ููุงูุช ุงููุชุทูุจุงุช ุงูููุงุฆูุฉ ุชุจุฏู ููุง ููู: <br><br>  <b>ูู ูุชุทูุจุงุช</b> <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุจุนุฏ ุงูุงุณุชุฎุฏุงู ุ ูุฌุจ ุญุฐู ุฌููุน ุจูุงูุงุช ุงููุณุชุฎุฏู (ุจูุง ูู ุฐูู ุงููููุงุช ุงููุคูุชุฉ ูููุงุชูุญ ุงูุชุณุฌูู). </li><li style=";text-align:right;direction:rtl">  ูุฌุจ ุงูุงูุชูุงุก ูู ุฌููุน ุงูุนูููุงุช ุงูุชู ุฃุทูููุง ุงููุณุชุฎุฏู ูู ููุงูุฉ ุงูุนูู. </li><li style=";text-align:right;direction:rtl">  ุงููุตูู ุฅูู ุงูุฅูุชุฑูุช ูู ุฎูุงู ูุงุฆูุฉ ุจูุถุงุก ูู ุงูุนูุงููู. </li><li style=";text-align:right;direction:rtl">  ูููุฏ ุนูู ุงููุฏุฑุฉ ุนูู ุชุดุบูู ููุฏ ุงูุทุฑู ุงูุซุงูุซ. </li><li style=";text-align:right;direction:rtl">  ุฅุฐุง ูุงูุช ุงูุฌูุณุฉ ูู ูุถุน ุงูุฎููู ูุฃูุซุฑ ูู 5 ุฏูุงุฆู ุ ููุฌุจ ุฃู ุชูุชูู ุงูุฌูุณุฉ ุชููุงุฆููุง ุ ููุฌุจ ุฃู ุชุฌุฑู ุงููุญุทุฉ ุนูููุฉ ุชูุธูู. </li></ul><br>  <b>ูุชุทูุจุงุช ุงูุนููุงุก</b> <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุนุฏุฏ ูุญุทุงุช ุงูุนููู ููู ูุฑุน ูุง ูุฒูุฏ ุนู 4. </li><li style=";text-align:right;direction:rtl">  ุงูุญุฏ ุงูุฃุฏูู ูููุช ุงูุงูุชุธุงุฑ ูุงุณุชุนุฏุงุฏ ุงููุธุงู ุ ูู ุงููุญุธุฉ ุงูุชู ุฌูุณุช ูููุง ุนูู ุงููุฑุณู ุฅูู ุจุฏุงูุฉ ุงูุนูู ูุน ุจุฑูุงูุฌ ุงูุนููู. </li><li style=";text-align:right;direction:rtl">  ุงููุฏุฑุฉ ุนูู ุชูุตูู ุงูุฃุฌูุฒุฉ ุงูุทุฑููุฉ (ุงููุงุณุญุงุช ุงูุถูุฆูุฉ ุ ูุญุฑูุงุช ุฃูุฑุงุต ููุงุด) ูุจุงุดุฑุฉ ูู ูููุน ุงูุชุซุจูุช ูู "ูุญุทุฉ ุงูุฎุฏูุฉ ุงูุฐุงุชูุฉ". </li><li style=";text-align:right;direction:rtl">  ุฑุบุจุงุช ุงูุนููุงุก </li><li style=";text-align:right;direction:rtl">  ูุธุงูุฑุฉ ููุงุฏ ุฅุนูุงููุฉ (ุตูุฑ) ูู ููุช ุฅุบูุงู ุงููุฌูุน. </li></ul><cut></cut><br><h4 style=";text-align:right;direction:rtl">  ุฏููู ุงูุฅุจุฏุงุน </h4><br>  ุจุนุฏ ูุนุจูุง ุจูุง ููู ุงูููุงูุฉ ูุน Windows livecd ุ ุชูุตููุง ุฅูู ูุชูุฌุฉ ุจุงูุฅุฌูุงุน ุจุฃู ุงูุญู ุงููุงุชุฌ ูุง ููู ุจุซูุงุซ ููุงุท ูููุฉ ุนูู ุงูุฃูู.  ูุชู ุชุญููููุง ุฅูุง ููุชุฑุฉ ุทูููุฉ ุ ุฃู ุบูุฑ ุญูุฉ ุชูุงููุง ุ ุฃู ูุฑุชุจุท ุชุฎุตูุตูุง ุจุงูุฃูู ุงูุจุฑู.  ุฑุจูุง ุจุญุซูุง ุจุดูู ุณูุฆ ุ ูููููู ุชูุฏูู ุงููุดูุฑุฉ ููุฌููุนุฉ ูู ุจุนุถ ุงูุฃุฏูุงุช ุ ูุณุฃููู ููุชูุง. <br><br>  ุนูุงูุฉ ุนูู ุฐูู ุ ุจุฏุฃูุง ูุชุทูุน ุฅูู VDI ุ ูููู ุจุงููุณุจุฉ ููุฐู ุงููููุฉ ุ ูุฅู ูุนุธู ุงูุญููู ุฅูุง ููููุฉ ููุบุงูุฉ ุฃู ุชุชุทูุจ ุนูุงูุฉ ูุซููุฉ.  ูุฃุฑุฏุช ุฃุฏุงุฉ ุจุณูุทุฉ ุจุฃุฏูู ูุฏุฑ ูู ุงูุณุญุฑ ุ ูููู ุญู ูุนุธู ุงููุดููุงุช ุงูุฎุงุตุฉ ุจูุง ุจูุฌุฑุฏ ุฅุนุงุฏุฉ ุชุดุบูู / ุฅุนุงุฏุฉ ุชุดุบูู ุงูุฎุฏูุฉ.  ูุญุณู ุงูุญุธ ุ ูุงู ูุฏููุง ุฃุฌูุฒุฉ ุงูุฎุงุฏู ุ ูุฆุฉ ููุฎูุถุฉ ุงูููุงูุฉ ูู ุงููุฑูุน ุ ูู ุงูุฎุฏูุฉ ุงูุชู ุชูููุช ุนู ุงูุนูู ุ ูุงูุชู ูููููุง ุงุณุชุฎุฏุงููุง ูููุงุนุฏุฉ ุงูุชูููููุฌูุฉ. <br><br>  ูุง ูู ุงููุชูุฌุฉุ  ููููู ูู ุฃููู ูุงุฏุฑูุง ุนูู ุฅุฎุจุงุฑู ุจูุง ุญุฏุซ ูู ุงูููุงูุฉ ุ ูุฃู ุงูุชุฌูุน ุงููุทูู ุงูุฏูููุฑุงุทู ุ ูููู ูู ุนูููุฉ ุงูุจุญุซ ุ ูููุง ุจุชุทููุฑ ูุฎุทุท ูุซูุฑ ููุงูุชูุงู ุฃุธูุฑ ููุณู ุฌูุฏูุง ูู ุงูุงุฎุชุจุงุฑุงุช ุงููุนูููุฉ ุ ุฑุบู ุฃูู ูู ูุฏุฎู ูู ุณูุณูุฉ. <br><br>  ุจุนุถ ุฅุฎูุงุก ุงููุณุฆูููุฉ: ูุง ูุฏุนู ุงููุคูู ุฃู ุงูุญู ุงูููุชุฑุญ ูุญู ุฌููุน ุงูููุงู ุชูุงููุง ูููุนููุง ุทูุนูุง ููุน ุงูุฃุบููุฉ.  ููุงูู ุงููุคูู ููุฏููุง ุนูู ุงูุชุตุฑูุญ ุงูุฐู ููุงุฏู ุฃู ุณูู ุฅูุฌููุด ุจุฑุด ูู ุฒูุฑุฉ ุดููุฎุช.  ูุธุฑูุง ูุฃู ุงูุญู ูู ูุนุฏ ููุฏ ุงูุชุทููุฑ ุ ูุง ููููู ุงูุงุนุชูุงุฏ ุนูู ุฅุตูุงุญ ุงูุฎูู ุฃู ุงูุชุบููุฑ ูู ุงููุธููุฉ ุ ููู ุดูุก ูู ูุฏูู.  ููุชุฑุถ ุงููุคูู ุฃูู ุนูู ุงูุฃูู ุนูู ุฏุฑุงูุฉ ุจู KVM ููุฑุฃุช ููุงูุฉ ูุฑุงุฌุนุฉ ุนูู ุจุฑูุชูููู Spice ุ ูุฃูู ุนููุช ููููุงู ูุน Centos ุฃู ุชูุฒูุน GNU Linux ุขุฎุฑ. <br><br>  ูู ูุฐู ุงูููุงูุฉ ุ ุฃูุฏ ุชุญููู ุงูุนููุฏ ุงูููุฑู ููุญู ุงููุงุชุฌ ุ ุฃู ุชูุงุนู ุงูุนููู ูุงูุฎุงุฏู ูุฌููุฑ ุงูุนูููุงุช ุนูู ุฏูุฑุฉ ุญูุงุฉ ุงูุฃุฌูุฒุฉ ุงูุงูุชุฑุงุถูุฉ ุถูู ุฅุทุงุฑ ุงูุญู ุงููุนูู.  ุฅุฐุง ูุงูุช ุงูููุงูุฉ ูุซูุฑุฉ ููุงูุชูุงู ููุฌูููุฑ ุ ูุณูู ุฃุตู ุชูุงุตูู ุชูููุฐ ุงูุตูุฑ ุงูุญูุฉ ูุฅูุดุงุก ุนููุงุก ุฑููุนูู ุนูู ุฃุณุงุณ Fedora ูุฃุฎุจุฑูู ุนู ุชูุงุตูู ุถุจุท ุงูุฃุฌูุฒุฉ ุงูุงูุชุฑุงุถูุฉ ูุฎูุงุฏู KVM ูุชุญุณูู ุงูุฃุฏุงุก ูุงูุฃูุงู. <br><br>  ุฅุฐุง ููุช ุชุฃุฎุฐ ูุฑูุฉ ููููุฉ ุ <br>  ุงูุฏูุงูุงุช ูุงููุฑุด ูุงูุบุฑุงุก ุ <br>  ูุฃูุซุฑ ูู ุฐูู ุจุจุฑุงุนุฉ ... <br>  ููููู ุฌุนู ูุงุฆุฉ ุฑูุจู! <br><br><h4 style=";text-align:right;direction:rtl">  ูุฎุทุท ููุตู ุงุฎุชุจุงุฑ ููุงุนุฏ ุงูุจุฏูุงุก </h4><br><img src="https://habrastorage.org/webt/pu/tu/rk/puturkaiwqcpbp4wld7ezdk_lcw.png"><br><br>  ุชูุน ุฌููุน ุงููุนุฏุงุช ุฏุงุฎู ุงูุดุจูุฉ ุงููุฑุนูุฉ ุ ููุท ููุงุฉ ุงูุฅูุชุฑูุช ุชูุทูุฆ.  ุชุงุฑูุฎูุงู ุ ูุงู ููุงู ุจุงููุนู ุฎุงุฏู ูููู ุ ุฅูู ุดูุก ุบูุฑ ุนุงุฏู.  ูููู ูู ุจูู ุงูุฃุดูุงุก ุงูุฃุฎุฑู ุ ุณูุชู ุชุตููุฉ ุญุฑูุฉ ุงููุฑูุฑ ูู ุงูุฃุฌูุฒุฉ ุงูุธุงูุฑูุฉ (abbr. VM ูุงุญููุง ูู ุงููุต).  ูุง ุดูุก ูููุน ูุถุน ูุฐู ุงูุฎุฏูุฉ ุนูู ุฎุงุฏู KVM ุ ุงูุดูุก ุงููุญูุฏ ุงูุฐู ุชุญุชุงุฌ ุฅูู ูุดุงูุฏุชู ูู ููู ูุชุบูุฑ ุงูุญูู ููู ุนูู ุงููุธุงู ุงููุฑุนู ูููุฑุต. <br><br>  ูุญุทุฉ ุงูุนููู - ูู ุงููุงูุน ุ "ูุญุทุงุช ุงูุฎุฏูุฉ ุงูุฐุงุชูุฉ" ุ "ุงููุงุฌูุฉ ุงูุฃูุงููุฉ" ูุฎุฏูุชูุง.  ูู ุตุงูุฑุฉ ูููููู IdeaCentre.  ูุง ูู ูุฐู ุงููุญุฏุฉ ุฌูุฏุฉ ูุ  ูุนู ุ ุงูุฌููุน ุชูุฑูุจุง ุ ุณุนุฏุงุก ุจุดูู ุฎุงุต ุจุงูุนุฏุฏ ุงููุจูุฑ ูู ููุตูุงุช USB ููุงุฑุฆุงุช ุงูุจุทุงูุงุช ุนูู ุงูููุญุฉ ุงูุฃูุงููุฉ.  ูู ูุฎุทุทูุง ุ ูุชู ุฅุฏุฎุงู ุจุทุงูุฉ SD ูุน ุญูุงูุฉ ุถุฏ ูุชุงุจุฉ ุงูุฃุฌูุฒุฉ ูู ูุงุฑุฆ ุงูุจุทุงูุงุช ุ ุญูุซ ูุชู ุชุณุฌูู ุงูุตูุฑุฉ ุงูุญูุฉ ุงููุนุฏูุฉ ูู Fedora 28. ุจุงูุทุจุน ุ ูุชู ุชูุตูู ุงูุดุงุดุฉ ูููุญุฉ ุงูููุงุชูุญ ูุงููุงูุณ ุจุงูุดุจูุฉ. <br><br>  Switch - ููุชุงุญ ุชุจุฏูู ุบูุฑ ููุญูู ุจุงูุฃุฌูุฒุฉ ูู ุงููุณุชูู ุงูุซุงูู ุ ููุฌุฏ ูู ุบุฑูุฉ ุงูุฎุงุฏู ููููุถ ุจุงูุฃุถูุงุก.  ุฅูู ุบูุฑ ูุชุตู ุจุฃู ุดุจูุงุช ุจุงุณุชุซูุงุก ุดุจูุฉ "ูุญุทุงุช ุงูุฎุฏูุฉ ุงูุฐุงุชูุฉ". <br><br>  KVM_Server ูู ุฌููุฑ ุงูุฏุงุฆุฑุฉ ุ ููู ุงุฎุชุจุงุฑุงุช ููุงุนุฏ ุงูุจุฏูุงุก ุ ูุงู Core 2 Quad Q9650 ุจุณุนุฉ 8 ุฌูุฌุงุจุงูุช ูู ุฐุงูุฑุฉ ุงููุตูู ุงูุนุดูุงุฆู ุจุณุญุจ 3 ูู ุงูุฃุฌูุฒุฉ ุงูุธุงูุฑูุฉ ุจูุธุงู Windows 10 ุจุซูุฉ.  ุงููุธุงู ุงููุฑุนู ูููุฑุต - adaptec 3405 2 ูุญุฑูุงุช Raid 1 + SSD.  ูู ุงูุชุฌุงุฑุจ ุงูููุฏุงููุฉ ูุฌูุงุฒ Xeon 1220 ุ ุชูููุช ูุญุฑูุงุช LSI 9260 + SSD ุงูุฃูุซุฑ ุฎุทูุฑุฉ ูู ุณุญุจ 5-6 VMs ุจุณูููุฉ.  ุณูู ูุญุตู ุนูู ุงูุฎุงุฏู ูู ุงูุฎุฏูุฉ ุงููุชูุงุนุฏุฉ ุ ูู ูููู ููุงู ุงููุซูุฑ ูู ุงูุชูุงููู ุงูุฑุฃุณูุงููุฉ.  ูุชู ูุดุฑ ูุธุงู ุงููุญุงูุงุฉ ุงูุงูุชุฑุงุถูุฉ KVM ูุน pool_Vm pool machine ุงูุธุงูุฑู ุนูู ูุฐุง ุงูุฎุงุฏู (ุงูุฎูุงุฏู). <br><br>  Vm ูู ุงูุฌูุงุฒ ุงูุธุงูุฑู ุ ุงูุฎูููุฉ ูู ุฎุฏูุชูุง.  ูุฐุง ูู ุนูู ุงููุณุชุฎุฏู. <br><br>  Enp5s0 ูู ูุงุฌูุฉ ุดุจูุฉ ุชุชุทูุน ุฅูู ุดุจูุฉ "ูุญุทุงุช ุงูุฎุฏูุฉ ุงูุฐุงุชูุฉ" ู dhcpd ู ntpd ู httpd ูุจุงุดุฑุฉ ุนูู ุฐูู ุ ูุชุณุชูุน xinetd ุฅูู ูููุฐ "ุงูุฅุดุงุฑุฉ". <br><br>  Lo0 ูู ูุงุฌูุฉ ุงูุงุณุชุฑุฌุงุน ุงูุฒุงุฆูุฉ.  ุงููุนูุงุฑ. <br><br>  Spice_console - ุดูุก ูุซูุฑ ููุงูุชูุงู ููุบุงูุฉ ุ ูุงูุญูููุฉ ูู ุฃูู ุ ุนูู ุนูุณ RDP ุงูููุงุณูููุฉ ุ ุนูุฏ ุชุดุบูู ุญุฒูุฉ ุจุฑูุชูููู KVM + Spice ุ ูุธูุฑ ููุงู ุฅุถุงูู - ูููุฐ ูุญุฏุฉ ุงูุชุญูู ูู ุงูุฌูุงุฒ ุงูุธุงูุฑู.  ูู ุงููุงูุน ุ ุนูุฏ ุงูุงุชุตุงู ุจูููุฐ TCP ูุฐุง ุ ูุญุตู ุนูู ูุญุฏุฉ Vm ุ ุฏูู ุงูุญุงุฌุฉ ููุงุชุตุงู ุจู Vm ูู ุฎูุงู ูุงุฌูุฉ ุดุจูุชูุง.  ูู ุงูุชูุงุนู ูุน Vm ูููู ุงูุฅุดุงุฑุงุช ุ ุงูุฎุงุฏู ูุฃุฎุฐ.  ุฃูุฑุจ ุงูุชูุงุธุฑูุฉ ูู ูุธููุฉ ูู IPKVM.  ุฃู  ูุชู ููู ุตูุฑุฉ ูุดุงุดุฉ VM ุฅูู ูุฐุง ุงููููุฐ ุ ููุชู ุฅุฑุณุงู ุงูุจูุงูุงุช ุงููุชุนููุฉ ุจุญุฑูุฉ ุงููุงูุณ ุฅูููุง ุ ููุณูุญ ูู ุงูุชูุงุนู (ุงูุฃูู ูู ุฐูู) ุนุจุฑ ุจุฑูุชูููู Spice ุจุฅุนุงุฏุฉ ุชูุฌูู ุฃุฌูุฒุฉ USB ุจุณูุงุณุฉ ุฅูู ุฌูุงุฒ ุงูุชุฑุงุถู ุ ููุง ูู ูุงู ูุฐุง ุงูุฌูุงุฒ ูุชุตูุงู ุจู Vm ููุณู.  ุชู ุงุฎุชุจุงุฑู ููุญุฑูุงุช ุงูุฃูุฑุงุต ุงููุญูููุฉ ูุงููุงุณุญุงุช ุงูุถูุฆูุฉ ููุงููุฑุงุช ุงูููุจ. <br><br>  Vnet0 ุ virbr0 ูุจุทุงูุงุช ุงูุดุจูุฉ ุงูุงูุชุฑุงุถูุฉ Vm ุชุดูู ุดุจูุฉ ูู ุงูุฃุฌูุฒุฉ ุงูุงูุชุฑุงุถูุฉ. <br><br><h4 style=";text-align:right;direction:rtl">  ููู ูุนููุ </h4><br>  ูู ูุญุทุฉ ุงูุนููู <br><br>  ูุชู ุชุญููู ูุญุทุฉ ุงูุนููู ูู ุงููุถุน ุงูุฑุณููู ูู ุตูุฑุฉ ุญูุฉ ูุนุฏูุฉ ูู ููุฏูุฑุง 28 ุ ูุชููู ุนููุงู IP ุนู ุทุฑูู dhcp ูู ูุณุงุญุฉ ุนููุงู ุงูุดุจูุฉ 169.254.24.0/24.  ุฃุซูุงุก ุนูููุฉ ุงูุชูููุฏ ุ ูุชู ุฅูุดุงุก ููุงุนุฏ ุฌุฏุงุฑ ุงูุญูุงูุฉ ุงูุชู ุชุณูุญ ุจุงูุงุชุตุงู ุจููุงูุฐ ุฎุงุฏู "ุงูุฅุดุงุฑุฉ" ู "ุงูุชูุงุจู".  ุจุนุฏ ุงูุชูุงู ุงูุชูุฒูู ุ ุชูุชุธุฑ ุงููุญุทุฉ ุฅุฐู ูุณุชุฎุฏู ุงูุนููู.  ุจุนุฏ ุฅุฐู ุงููุณุชุฎุฏู ุ ูุชู ุชุดุบูู ูุฏูุฑ ุณุทุญ ุงูููุชุจ "openbox" ููุชู ุชูููุฐ ุงูุจุฑูุงูุฌ ุงููุตู ูุจุฏุก ุงูุชุดุบูู ุงูุชููุงุฆู ููุงุจุฉ ุนู ุงููุณุชุฎุฏู ุงููุนุชูุฏ.  ูู ุจูู ุฃุดูุงุก ุฃุฎุฑู ุ ูููู ุจุฑูุงูุฌ ุงูุชุดุบูู ุงูุชููุงุฆู ุจุชุดุบูู ุงูุจุฑูุงูุฌ ุงููุตู remote.sh. <br><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">$ HOME / .config / openbox / scripts / remote.sh</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh server_ip=$(/usr/bin/cat /etc/client.conf |/usr/bin/grep "server_ip" \ |/usr/bin/cut -d "=" -f2) vdi_signal_port=$(/usr/bin/cat /etc/client.conf |/usr/bin/grep "vdi_signal_port" \ |/usr/bin/cut -d "=" -f2) vdi_spice_port=$(/usr/bin/cat /etc/client.conf |/usr/bin/grep "vdi_spice_port" \ |/usr/bin/cut -d "=" -f2) animation_folder=$(/usr/bin/cat /etc/client.conf |/usr/bin/grep "animation_folder" \ |/usr/bin/cut -d "=" -f2) process=/usr/bin/remote-viewer while true do if [ -z `/usr/bin/pidof feh` ] then /usr/bin/echo $animation_folder /usr/bin/feh -N -x -D1 $animation_folder &amp; else /usr/bin/echo fi /usr/bin/nc -i 1 $server_ip $vdi_signal_port |while read line do if /usr/bin/echo "$line" |/usr/bin/grep "RULE ADDED, CONNECT NOW!" then /usr/bin/killall feh pid_process=$($process "spice://$server_ip:$vdi_spice_port" \ "--spice-disable-audio" "--spice-disable-effects=animation" \ "--spice-preferred-compression=auto-glz" "-k" \ "--kiosk-quit=on-disconnect" | /bin/echo $!) /usr/bin/wait $pid_process /usr/bin/killall -u $USER exit else /usr/bin/echo $line &gt;&gt; /var/log/remote.log fi done done</span></span></code> </pre> <br></div></div><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">/etc/client.conf</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">server_ip=169.254.24.1 vdi_signal_port=5905 vdi_spice_port=5906 animation_folder=/usr/share/backgrounds/animation background_folder=/usr/share/backgrounds2/fedora-workstation</code> </pre><br></div></div><br>  ูุตู ูุชุบูุฑุงุช ููู client.conf <br>  server_ip - ุนููุงู KVM_Server <br>  vdi_signal_port - ูููุฐ KVM_Server ุงูุฐู xinetd "ูุฌูุณ" <br>  vdi_spice_port - ูููุฐ ุงูุดุจูุฉ KVM_Server ุ ุญูุซ ุณูุชู ุฅุนุงุฏุฉ ุชูุฌูู ุทูุจ ุงูุงุชุตุงู ูู ุนููู ุงููุดุงูุฏ ุนู ุจุนุฏ ุฅูู ูููุฐ ุงูุชูุงุจู ุงูุฎุงุต ุจู Vm ุงููุญุฏุฏ (ุงูุชูุงุตูู ุฃุฏูุงู) <br>  animation_folder - ุงููุฌูุฏ ุญูุซ ูุชู ุงูุชูุงุท ุงูุตูุฑ ูู ุงูุฑุณูู ุงููุชุญุฑูุฉ ููุฑุณูู ุงููุชุญุฑูุฉ ุงููุฑุงุก <br>  background_folder - ุงููุฌูุฏ ุญูุซ ูุชู ุงูุชูุงุท ุงูุตูุฑ ูู ุฃุฌู ุงูุนุฑูุถ ุงูุงุญุชูุงุทูุฉ.  ุงููุฒูุฏ ุนู ุงูุฑุณูู ุงููุชุญุฑูุฉ ูู ุงูุฌุฒุก ุงูุชุงูู ูู ุงูููุงูุฉ. <br><br>  ูุฃุฎุฐ ุงูุจุฑูุงูุฌ ุงููุตู remote.sh ุงูุฅุนุฏุงุฏุงุช ูู ููู ุงูุชูููู /etc/client.conf ููุณุชุฎุฏู nc ููุงุชุตุงู ุจูููุฐ "vdi_signal_port" ูุฎุงุฏู KVM ููุชููู ุฏูู ุจูุงูุงุช ูู ุงูุฎุงุฏู ุ ููู ุจูููุง ูุชููุน ุณูุณูุฉ "RULE ADDED ุ CONNECT NOW".  ุนูุฏ ุงุณุชูุงู ุงูุฎุท ุงููุฑุบูุจ ุ ุชุจุฏุฃ ุนูููุฉ ุงูุนุงุฑุถ ุนู ุจูุนุฏ ูู ูุถุน ุงููุดู ุ ููุง ูุคุฏู ุฅูู ุฅูุดุงุก ุงุชุตุงู ุจูููุฐ ุงูุฎุงุฏู "vdi_spice_port".  ูุชู ุชุนููู ุชูููุฐ ุงูุจุฑูุงูุฌ ุงููุตู ุญุชู ููุงูุฉ ุชูููุฐ ุงูุนุงุฑุถ ุนู ุจุนุฏ. <br><br>  ูููู ุงููุดุงูุฏ ุนู ุจุนุฏ ุงูุฐู ูุชุตู ุจูููุฐ "vdi_spice_port" ุ ูุธุฑูุง ูุฅุนุงุฏุฉ ุงูุชูุฌูู ูู ุฌุงูุจ ุงูุฎุงุฏู ุ ุจุงููุตูู ุฅูู ูููุฐ "spice_console" ูู ุงููุงุฌูุฉ lo0 ุ ุฃู  ุฅูู ูุญุฏุฉ ุชุญูู ุงูุฌูุงุฒ ุงูุธุงูุฑู ูุนูู ุงููุณุชุฎุฏู ูุชู ูุจุงุดุฑุฉ.  ุฃุซูุงุก ุงูุชุธุงุฑ ุงูุงุชุตุงู ุ ูุชู ุนุฑุถ ุฑุณูู ูุชุญุฑูุฉ ูุฒููุฉ ูููุณุชุฎุฏู ุ ูู ุดูู ุนุฑุถ ุดุฑุงุฆุญ ููููุงุช jpeg ุ ูุชู ุชุญุฏูุฏ ุงููุณุงุฑ ุฅูู ุงูุฏููู ูุน ุงูุตูุฑ ุจูุงุณุทุฉ ูููุฉ ูุชุบูุฑ animation_folder ูู ููู ุงูุชูููู. <br><br>  ูู ุญุงูุฉ ููุฏ ุงูุงุชุตุงู ุจูููุฐ "spice_console" ุงูุฎุงุต ุจุงูุฌูุงุฒ ุงูุธุงูุฑู ุ ููุง ูุดูุฑ ุฅูู ุฅููุงู ุชุดุบูู / ุฅุนุงุฏุฉ ุชุดุบูู ุงูุฌูุงุฒ ุงูุธุงูุฑู (ุฃู ุงูููุงูุฉ ุงููุนููุฉ ูุฌูุณุฉ ุงููุณุชุฎุฏู) ุ ูุชู ุฅููุงุก ุฌููุน ุงูุนูููุงุช ุงูุชู ุชุนูู ููุงุจุฉ ุนู ุงููุณุชุฎุฏู ุงููุตุฑุญ ุจู ุ ููุง ูุคุฏู ุฅูู ุฅุนุงุฏุฉ ุชุดุบูู lightdm ูุงูุนูุฏุฉ ุฅูู ุดุงุดุฉ ุงูุชูููุถ . <br><br><h4 style=";text-align:right;direction:rtl">  ูู ุฌุงูุจ ุฎุงุฏู KVM </h4><br>  ุนูู ูููุฐ "ุงูุฅุดุงุฑุฉ" ูู ุจุทุงูุฉ ุงูุดุจูุฉ ุ ููุชุธุฑ enp5s0 ุงุชุตุงู xinetd.  ุจุนุฏ ุงูุงุชุตุงู ุจูููุฐ "ุงูุฅุดุงุฑุฉ" ุ ูููู xinetd ุจุชุดุบูู ุงูุจุฑูุงูุฌ ุงููุตู vm_manager.sh ุฏูู ุชูุฑูุฑ ุฃู ูุนููุงุช ุฅุฏุฎุงู ุฅููู ูุฅุนุงุฏุฉ ุชูุฌูู ูุชูุฌุฉ ุงูุจุฑูุงูุฌ ุงููุตู ุฅูู ุฌูุณุฉ nc ููุญุทุฉ ุงูุนููู. <br><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">/etc/xinetd.d/test-server</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">service vdi_signal { port = 5905 socket_type = stream protocol = tcp <span class="hljs-built_in"><span class="hljs-built_in">wait</span></span> = no user = root server = /home/admin/scripts_vdi_new/vm_manager.sh }</code> </pre><br></div></div><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">/home/admin/scripts_vdi_new/vm_manager.sh</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/sh #&lt;SET LOCAL VARIABLES FOR SCRIPT&gt;# SRV_SCRIPTS_DIR=$(/usr/bin/cat /etc/vm_manager.conf \ |/usr/bin/grep "srv_scripts_dir" |/usr/bin/cut -d "=" -f2) /usr/bin/echo "SRV_SCRIPTS_DIR=$SRV_SCRIPTS_DIR" export SRV_SCRIPTS_DIR=$SRV_SCRIPTS_DIR SRV_POOL_SIZE=$(/usr/bin/cat /etc/vm_manager.conf \ |/usr/bin/grep "srv_pool_size" |/usr/bin/cut -d "=" -f2) /usr/bin/echo "SRV_POOL_SIZE=$SRV_POOL_SIZE" export "SRV_POOL_SIZE=$SRV_POOL_SIZE" SRV_START_PORT_POOL=$(/usr/bin/cat /etc/vm_manager.conf \ |/usr/bin/grep "srv_start_port_pool" |/usr/bin/cut -d "=" -f2) /usr/bin/echo SRV_START_PORT_POOL=$SRV_START_PORT_POOL export SRV_START_PORT_POOL=$SRV_START_PORT_POOL SRV_TMP_DIR=$(/usr/bin/cat /etc/vm_manager.conf \ |/usr/bin/grep "srv_tmp_dir" |/usr/bin/cut -d "=" -f2) /usr/bin/echo "SRV_TMP_DIR=$SRV_TMP_DIR" export SRV_TMP_DIR=$SRV_TMP_DIR date=$(/usr/bin/date) #&lt;/SET LOCAL VARIABLES FOR SCRIPT&gt;# /usr/bin/echo "# $date START EXECUTE VM_MANAGER.SH #" make_connect_to_vm() { #&lt;READING CLEAR.LIST AND CHECK PORT FOR NETWORK STATE&gt;# /usr/bin/echo "READING CLEAN.LIST AND CHECK PORT STATE" #&lt;CHECK FOR NO ONE PORT IN CLEAR.LIST&gt;# if [ -z `/usr/bin/cat $SRV_TMP_DIR/clear.list` ] then /usr/bin/echo "NO AVALIBLE PORTS IN CLEAN.LIST FOUND" /usr/bin/echo "Will try to make housekeeper, and create new vm" make_housekeeper else #&lt;MINIMUN ONE PORT IN CLEAR.LIST FOUND&gt;# /usr/bin/cat $SRV_TMP_DIR/clear.list |while read line do clear_vm_port=$(($line)) /bin/echo "FOUND PORT $clear_vm_port IN CLEAN.LIST. TRY NETSTAT" \ "CHECK FOR PORT=$clear_vm_port" #&lt;NETSTAT LISTEN CHECK FOR PORT FROM CLEAN.LIST&gt;# if /usr/bin/netstat -lnt |/usr/bin/grep ":$clear_vm_port" &gt; /dev/null then /bin/echo "$clear_vm_port IS LISTEN" #&lt;PORT IS LISTEN. CHECK FOR IS CONNECTED NOW&gt;# if /usr/bin/netstat -nt |/usr/bin/grep ":$clear_vm_port" \ |/usr/bin/grep "ESTABLISHED" &gt; /dev/null then #&lt;PORT LISTEN AND ALREADY CONNECTED! MOVE PORT FROM CLEAR.LIST # TO WASTE.LIST&gt;# /bin/echo "$clear_vm_port IS ALREADY CONNECTED, MOVE PORT TO WASTE.LIST" /usr/bin/sed -i "/$clear_vm_port/d" $SRV_TMP_DIR/clear.list /usr/bin/echo $clear_vm_port &gt;&gt; $SRV_TMP_DIR/waste.list else #&lt;PORT LISTEN AND NO ONE CONNECT NOW. MOVE PORT FROM CLEAR.LIST TO # CONN_WAIT.LIST AND CREATE IPTABLES RULES&gt;## /usr/bin/echo "OK, $clear_vm_port IS NOT ALREADY CONNECTED" /usr/bin/sed -i "/$clear_vm_port/d" $SRV_TMP_DIR/clear.list /usr/bin/echo $clear_vm_port &gt;&gt; $SRV_TMP_DIR/conn_wait.list $SRV_SCRIPTS_DIR/vm_connect.sh $clear_vm_port #&lt;TRY TO CLEAN VM IN WASTE.LIST AND CREATE NEW WM&gt;# /bin/echo "TRY TO CLEAN VM IN WASTE.LIST AND CREATE NEW VM" make_housekeeper /usr/bin/echo "# $date STOP EXECUTE VM_MANAGER.SH#" exit fi else #&lt;PORT IS NOT A LISTEN. MOVE PORT FROM CLEAR.LIST TO WASTE.LIST&gt;# /bin/echo " "$clear_vm_port" is NOT LISTEN. REMOVE PORT FROM CLEAR.LIST" /usr/bin/sed -i "/$clear_vm_port/d" $SRV_TMP_DIR/clear.list /usr/bin/echo $clear_vm_port &gt;&gt; $SRV_TMP_DIR/waste.list make_housekeeper fi done fi } make_housekeeper() { /usr/bin/echo "=Execute housekeeper=" /usr/bin/cat $SRV_TMP_DIR/waste.list |while read line do /usr/bin/echo "$line" if /usr/bin/netstat -lnt |/usr/bin/grep ":$line" &gt; /dev/null then /bin/echo "port_alive, vm is running" if /usr/bin/netstat -nt |/usr/bin/grep ":$line" \ |/usr/bin/grep "ESTABLISHED" &gt; /dev/null then /bin/echo "port_in_use can't delete vm!!!" else /bin/echo "port_not in use. Deleting vm" /usr/bin/sed -i "/$line/d" $SRV_TMP_DIR/waste.list /usr/bin/echo $line &gt;&gt; $SRV_TMP_DIR/recycle.list $SRV_SCRIPTS_DIR/vm_delete.sh $line fi else /usr/bin/echo "posible vm is already off. Deleting vm" /usr/bin/echo "MOVE VM IN OFF STATE $line FROM WASTE.LIST TO" \ "RECYCLE.LIST AND DELETE VM" /usr/bin/sed -i "/$line/d" $SRV_TMP_DIR/waste.list /usr/bin/echo $line &gt;&gt; $SRV_TMP_DIR/recycle.list $SRV_SCRIPTS_DIR/vm_delete.sh "$line" fi done create_clear_vm } create_clear_vm() { /usr/bin/echo "=Create new VM=" while [ $SRV_POOL_SIZE -gt 0 ] do new_vm_port=$(($SRV_START_PORT_POOL+$SRV_POOL_SIZE)) /usr/bin/echo "new_vm_port=$new_vm_port" if /usr/bin/grep "$new_vm_port" $SRV_TMP_DIR/clear.list &gt; /dev/null then /usr/bin/echo "$new_vm_port port is already defined in clear.list" else if /usr/bin/grep "$new_vm_port" $SRV_TMP_DIR/waste.list &gt; /dev/null then /usr/bin/echo "$new_vm_port port is already defined in waste.list" else if /usr/bin/grep "$new_vm_port" $SRV_TMP_DIR/recycle.list &gt; /dev/null then /usr/bin/echo "$new_vm_port PORT IS ALREADY DEFINED IN RECYCLE LIST" else if /usr/bin/grep "$new_vm_port" $SRV_TMP_DIR/conn_wait.list &gt; /dev/null then /usr/bin/echo "$new_vm_port PORT IS ALREADY DEFINED IN CONN_WAIT LIST" else /usr/bin/echo "PORT IN NOT DEFINED IN NO ONE LIST WILL CREATE" \ "VM ON PORT $new_vm_port" /usr/bin/echo $new_vm_port &gt;&gt; $SRV_TMP_DIR/recycle.list $SRV_SCRIPTS_DIR/vm_create.sh $new_vm_port fi fi fi fi SRV_POOL_SIZE=$(($SRV_POOL_SIZE-1)) done /usr/bin/echo "# $date STOP EXECUTE VM_MANAGER.SH #" } make_connect_to_vm |/usr/bin/tee -a /var/log/vm_manager.log</span></span></code> </pre><br></div></div><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">/etc/vm_manager.conf</b> <div class="spoiler_text" style=";text-align:right;direction:rtl">  srv_scripts_dir = / home / admin / scripts_vdi_new <br>  srv_pool_size = 4 <br>  srv_start_port_pool = 5920 <br>  srv_tmp_dir = / tmp / vm_state <br>  base_host = win10_2 <br>  input_iface = enp5s0 <br>  vdi_spice_port = 5906 <br>  count_conn_tryes = 10 <br></div></div><br><br>  ูุตู ูุชุบูุฑุงุช ููู ุงูุชูููู vm_manager.conf <br>  srv_scripts_dir - ูุฌูุฏ ูููุน ุงูุจุฑูุงูุฌ ุงููุตู vm_manager.sh ุ vm_connect.sh ุ vm_delete.sh ุ vm_create.sh ุ vm_clear.sh <br>  srv_pool_size - ุญุฌู ุชุฌูุน Vm <br>  srv_start_port_pool - ุงููููุฐ ุงูุฃููู ุ ูุจุนุฏ ุฐูู ุณุชุจุฏุฃ ููุงูุฐ ุงูุชูุงุจู ุงูุฎุงุตุฉ ุจูุญุฏุงุช ุงูุชุญูู ูู ุงูุฌูุงุฒ ุงูุธุงูุฑู <br>  srv_tmp_dir - ูุฌูุฏ ูููููุงุช ุงููุคูุชุฉ <br>  base_host - base Vm (ุตูุฑุฉ ุฐูุจูุฉ) ูุชู ูู ุฎูุงููุง ุงุณุชูุณุงุฎ Vm ูู ุงูุชุฌูุน <br>  input_iface - ูุงุฌูุฉ ุดุจูุฉ ุงูุฎุงุฏู ุ ุชุชุทูุน ูุญู ูุญุทุงุช ุงูุนููู <br>  vdi_spice_port - ูููุฐ ุดุจูุฉ ุงูุฎุงุฏู ุงูุฐู ุณูุชู ููู ุฅุนุงุฏุฉ ุชูุฌูู ุทูุจ ุงูุงุชุตุงู ูู ุนููู ุงูุนุงุฑุถ ุงูุจุนูุฏ ุฅูู ูููุฐ ุงูุชูุงุจู ุงูุฎุงุต ุจู Vm ุงููุญุฏุฏ <br>  count_conn_tryes - ูุคูุช ุงูุชุธุงุฑ ุ ูุจุนุฏ ุฐูู ูุนุชุจุฑ ุฃู ุงุชุตุงู Vm ูู ูุญุฏุซ (ููุญุตูู ุนูู ุงูุชูุงุตูู ุ ุฑุงุฌุน vm_connect.sh) <br><br>  ููุฑุฃ ุงูุจุฑูุงูุฌ ุงููุตู vm_manager.sh ููู ุงูุชูููู ูู ููู vm_manager.conf ุ ููููู ุญุงูุฉ ุงูุฃุฌูุฒุฉ ุงูุธุงูุฑูุฉ ูู ุงูุชุฌูุน ููููุง ูุนุฏุฉ ูุนููุงุช ุ ููู: ูู ุนุฏุฏ ุฃุฌูุฒุฉ VM ุงูุชู ูุชู ูุดุฑูุง ุ ูุง ุฅุฐุง ูุงูุช ููุงู VMs ูุธููุฉ ูุฌุงููุฉ.  ููููุงู ุจุฐูู ุ ูููู ุจูุฑุงุกุฉ ููู clear.list ุงูุฐู ูุญุชูู ุนูู ุฃุฑูุงู ููุงูุฐ "spice_console" ุงูุฎุงุตุฉ ุจุงูุฃุฌูุฒุฉ ุงูุธุงูุฑูุฉ "ุงูุชู ุชู ุฅูุดุงุคูุง ุญุฏูุซูุง" (ุงูุธุฑ ุฏูุฑุฉ ุฅูุดุงุก VM ุฃุฏูุงู) ููุชุญูู ูู ูุฌูุฏ ุงุชุตุงู ุซุงุจุช ุจูุง.  ุฅุฐุง ุชู ุงููุดู ุนู ูููุฐ ุจู ุงุชุตุงู ุดุจูุฉ ูุคุณุณ (ูุงูุฐู ูุฌุจ ุฃูุง ูููู ูุทูููุง) ุ ูุชู ุนุฑุถ ุชุญุฐูุฑ ููุชู ููู ุงููููุฐ ุฅูู ุงูููุงูุงุช. ูุงุฆูุฉ ุนูุฏ ุงูุนุซูุฑ ุนูู ุงููููุฐ ุงูุฃูู ูู ููู clear.list ุงูุฐู ูุง ููุฌุฏ ุจู ุงุชุตุงู ุญุงูููุง ุ ูููู vm_manager.sh ุจุงุณุชุฏุนุงุก ุงูุจุฑูุงูุฌ ุงููุตู vm_connect.sh ูููุฑ ูู ููุนููุฉ ุนุฏุฏ ูุฐุง ุงููููุฐ. <br><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">/home/admin/scripts_vdi_new/vm_connect.sh</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh date=$(/usr/bin/date) /usr/bin/echo "#" "$date" "START EXECUTE VM_CONNECT.SH#" #&lt;SET LOCAL VARIABLES FOR SCRIPT&gt;# free_port="$1" input_iface=$(/usr/bin/cat /etc/vm_manager.conf |/usr/bin/grep "input_iface" \ |/usr/bin/cut -d "=" -f2) /usr/bin/echo "input_iface=$input_iface" vdi_spice_port=$(/usr/bin/cat /etc/vm_manager.conf \ |/usr/bin/grep "vdi_spice_port" |/usr/bin/cut -d "=" -f2) /usr/bin/echo "vdi_spice_port=$vdi_spice_port" count_conn_tryes=$(/usr/bin/cat /etc/vm_manager.conf \ |/usr/bin/grep "count_conn_tryes" |/usr/bin/cut -d "=" -f2) /usr/bin/echo "count_conn_tryes=$count_conn_tryes" #&lt;/SET LOCAL VARIABLES FOR SCRIPT&gt;# #&lt;CREATE IPTABLES RULES AND SEND SIGNAL TO CONNECT&gt;# /usr/bin/echo "create rule for port" $free_port /usr/sbin/iptables -I INPUT -i $input_iface -p tcp -m tcp --dport \ $free_port -j ACCEPT /usr/sbin/iptables -I OUTPUT -o $input_iface -p tcp -m tcp --sport \ $free_port -j ACCEPT /usr/sbin/iptables -t nat -I PREROUTING -p tcp -i $input_iface --dport \ $vdi_spice_port -j DNAT --to-destination 127.0.0.1:$free_port /usr/bin/echo "RULE ADDED, CONNECT NOW!" #&lt;/CREATE IPTABLES RULES AND SEND SIGNAL TO CONNECT&gt;# #&lt;WAIT CONNECT ESTABLISHED AND ACTIVATE CONNECT TIMER&gt;# while [ $count_conn_tryes -gt 0 ] do if /usr/bin/netstat -nt |/usr/bin/grep ":$free_port" \ |/usr/bin/grep "ESTABLISHED" &gt; /dev/null then /bin/echo "$free_port NOW in use!!!" /usr/bin/sleep 1s /usr/sbin/iptables -t nat -D PREROUTING -p tcp -i $input_iface --dport \ $vdi_spice_port -j DNAT --to-destination 127.0.0.1:$free_port /usr/sbin/iptables -D INPUT -i $input_iface -p tcp -m tcp --dport \ $free_port -j ACCEPT /usr/sbin/iptables -D OUTPUT -o $input_iface -p tcp -m tcp --sport \ $free_port -j ACCEPT /usr/bin/sed -i "/$free_port/d" $SRV_TMP_DIR/conn_wait.list /usr/bin/echo $free_port &gt;&gt; $SRV_TMP_DIR/waste.list return else /usr/bin/echo "$free_port NOT IN USE" /usr/bin/echo "RULE ADDED, CONNECT NOW!" /usr/bin/sleep 1s fi count_conn_tryes=$((count_conn_tryes-1)) done #&lt;/WAIT CONNECT ESTABLISED AND ACTIVATE CONNECT TIMER&gt;# #&lt;IF COUNT HAS EXPIRED. REMOVE IPTABLES RULE AND REVERT \ # VM TO CLEAR.LIST&gt;# /usr/bin/echo "REVERT IPTABLES RULE AND REVERT VM TO CLEAN \ LIST $free_port" /usr/sbin/iptables -t nat -D PREROUTING -p tcp -i $input_iface --dport \ $vdi_spice_port -j DNAT --to-destination 127.0.0.1:$free_port /usr/sbin/iptables -D INPUT -i $input_iface -p tcp -m tcp --dport $free_port \ -j ACCEPT /usr/sbin/iptables -D OUTPUT -o $input_iface -p tcp -m tcp --sport \ $free_port -j ACCEPT /usr/bin/sed -i "/$free_port/d" $SRV_TMP_DIR/conn_wait.list /usr/bin/echo $free_port &gt;&gt; $SRV_TMP_DIR/clear.list #&lt;/COUNT HAS EXPIRED. REMOVE IPTABLES RULE AND REVERT VM \ #TO CLEAR.LIST&gt;# /usr/bin/echo "#" "$date" "END EXECUTE VM_CONNECT.SH#" # Attention! Must Be! sysctl net.ipv4.conf.all.route_localnet=1</span></span></code> </pre><br></div></div><br>  ููุฏู ุงูุจุฑูุงูุฌ ุงููุตู vm_connect.sh ููุงุนุฏ ุฌุฏุงุฑ ุงูุญูุงูุฉ ุงูุชู ุชูุดุฆ ุฅุนุงุฏุฉ ุชูุฌูู "vdi_spice_port" ููููุฐ ุงูุฎุงุฏู ุจูุงุฌูุฉ enp5s0 ุฅูู "ูููุฐ ูุญุฏุฉ ุงูุชุญูู ูู spice" ูู VM ุงูููุฌูุฏ ุนูู ูุงุฌูุฉ ุฎุงุฏู lo0 ุ ูุชูุฑูุฑูุง ููุนููุฉ ุจุฏุก ุงูุชุดุบูู.  ูุชู ููู ุงููููุฐ ุฅูู conn_wait.list ุ ููุนุชุจุฑ VM ูู ุงูุชุธุงุฑ ุงูุงุชุตุงู.  ูุชู ุฅุฑุณุงู ุฎุท RULE ADDED ุ CONNECT NOW ุฅูู ุฌูุณุฉ ูุญุทุฉ ุงูุนููู ุนูู ูููุฐ "ุงูุฅุดุงุฑุฉ" ุงูุฎุงุต ุจุงูุฎุงุฏู ุ ูุงูุฐู ูุชููุนู ุงูุจุฑูุงูุฌ ุงููุตู ุงูุจุนูุฏ.  ุชุจุฏุฃ ุฏูุฑุฉ ุงูุชุธุงุฑ ุงูุงุชุตุงู ุจุนุฏุฏ ุงููุญุงููุงุช ุงูุชู ุชุญุฏุฏูุง ูููุฉ ุงููุชุบูุฑ "count_conn_tryes" ูู ููู ุงูุชูููู.  ูู ุซุงููุฉ ูู ุฌูุณุฉ nc ุ ุณูุชู ุฅุนุทุงุก ุงูุณูุณูุฉ "RULE ADDED ุ CONNECT NOW" ูุณูุชู ุงูุชุญูู ูู ุงูุงุชุตุงู ุงูุฐู ุชู ุชุฃุณูุณู ุนูู ูููุฐ "spice_console". <br><br>  ุฅุฐุง ูุดู ุงูุงุชุตุงู ูุนุฏุฏ ูุนูู ูู ุงููุญุงููุงุช ุ ูุณูุชู ููู ูููุฐ spice_console ูุฑุฉ ุฃุฎุฑู ููุณุญ. ูุงุฆูุฉ ุงูุชูุงู ุชูููุฐ vm_connect.sh ุ ูุชู ุงุณุชุฆูุงู ุชูููุฐ vm_manager.sh ุ ูุงูุฐู ูุจุฏุฃ ุฏูุฑุฉ ุงูุชูุธูู. <br><br>  ุฅุฐุง ูุงูุช "ูุญุทุฉ ุงูุนููู" ุชุชุตู ุจูููุฐ spice_console ุนูู ุงููุงุฌูุฉ lo0 ุ ูุณูุชู ุญุฐู ููุงุนุฏ ุฌุฏุงุฑ ุงูุญูุงูุฉ ุงูุชู ุชูุดุฆ ุฅุนุงุฏุฉ ุชูุฌูู ุจูู ูููุฐ ุฎุงุฏู spice ููููุฐ spice_console ููุชู ุงูุญูุงุธ ุนูู ุงูุงุชุตุงู ุจุดูู ุฃูุจุฑ ูู ุฎูุงู ุขููุฉ ูุชุญุฏูุฏ ุญุงูุฉ ุฌุฏุงุฑ ุงูุญูุงูุฉ.  ูู ุญุงูุฉ ูุฌูุฏ ุงุชุตุงู ุบูุฑ ูุชุตู ุ ุณุชูุดู ุฅุนุงุฏุฉ ุงูุงุชุตุงู ุจูููุฐ spice_console.  ูุชู ููู ูููุฐ spice_console ุฅูู ูุงุฆูุฉ ุงูููุงูุงุช. ุชุนุชุจุฑ VM ูุชุณุฎุฉ ููุง ูููููุง ุงูุนูุฏุฉ ุฅูู ูุฌููุนุฉ ุงูุฃุฌูุฒุฉ ุงูุธุงูุฑูุฉ ุงููุธููุฉ ุฏูู ุงููุฑูุฑ ุนุจุฑ ุงูุชูุธูู.  ุงูุชูุงู ุชูููุฐ vm_connect.sh ุ ูุงุณุชุฆูุงู ุชูููุฐ vm_manager.sh ุ ูุงูุฐู ูุจุฏุฃ ุฏูุฑุฉ ุงูุชูุธูู. <br><br>  ุชุจุฏุฃ ุฏูุฑุฉ ุงูุชูุธูู ูู ุฎูุงู ุงููุธุฑ ุฅูู ููู ูุงุฆูุฉ ุงูููุงูุงุช ุ ุญูุซ ูุชู ููู ุฃุฑูุงู ูุญุฏุฉ ุงูุชุญูู ูู spice ูู ููุงูุฐ ุงูุฌูุงุฒ ุงูุธุงูุฑู ุงูุชู ุชู ุชุฃุณูุณ ุงูุงุชุตุงู ุจูุง.  ูุชู ุชุญุฏูุฏ ูุฌูุฏ ุงุชุตุงู ูุดุท ุนูู ูู ูููุฐ spice_console ูู ุงููุงุฆูุฉ.  ุฅุฐุง ูู ููู ููุงู ุงุชุตุงู ุ ูููุนุชุจุฑ ุฃู ุงูุฌูุงุฒ ุงูุธุงูุฑู ูู ูุนุฏ ููุฏ ุงูุงุณุชุฎุฏุงู ูุฃูู ุชู ููู ุงููููุฐ ุฅูู ูุงุฆูุฉ ุงูุชุฏููุฑ ุ ูุจุฏุฃุช ุนูููุฉ ุญุฐู ุงูุฌูุงุฒ ุงูุธุงูุฑู (ุงูุธุฑ ุฃุฏูุงู) ุงูุฐู ููุชูู ุฅููู ูุฐุง ุงููููุฐ.  ุฅุฐุง ุชู ุงูุชุดุงู ุงุชุตุงู ุดุจูุฉ ูุดุท ุนูู ุงููููุฐ ุ ููู ุงูููุชุฑุถ ุฃู ุงูุฌูุงุฒ ุงูุธุงูุฑู ููุฏ ุงูุงุณุชุฎุฏุงู ุ ููุง ูุชู ุงุชุฎุงุฐ ุฃู ุฅุฌุฑุงุก ุจุดุฃูู.  ุฅุฐุง ูู ูุชู ุงุณุชุบูุงู ุงููููุฐ ุ ููู ุงูููุชุฑุถ ุฃู ูุชู ุฅููุงู ุชุดุบูู VM ููู ุชุนุฏ ููุงู ุญุงุฌุฉ ุฅููู.  ูุชู ููู ุงููููุฐ ุฅูู recycle.list ูุชุจุฏุฃ ุนูููุฉ ุฅุฒุงูุฉ ุงูุฌูุงุฒ ุงูุธุงูุฑู.  ููููุงู ุจุฐูู ุ ูุชู ุงุณุชุฏุนุงุก ุงูุจุฑูุงูุฌ ุงููุตู vm_delete.sh ุ ุญูุซ ูุชู ููู ุฑูู "spice_console" ุฅูู ูููุฐ VM ููุนููุฉ ุ ูุงูุชู ูุฌุจ ุญุฐููุง. <br><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">/home/admin/scripts_vdi_new/vm_delete.sh</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh #&lt;Set local VARIABLES&gt;# port_to_delete="$1" date=$(/usr/bin/date) #&lt;/Set local VARIABLES&gt;# /usr/bin/echo "# $date START EXECUTE VM_DELETE.SH#" /usr/bin/echo "TRY DELETE VM ON PORT: $vm_port" #&lt;VM NAME SETUP&gt;# vm_name_part1=$(/usr/bin/cat /etc/vm_manager.conf |/usr/bin/grep 'base_host' \ |/usr/bin/cut -d'=' -f2) vm_name=$(/usr/bin/echo "$vm_name_part1""-""$port_to_delete") #&lt;/VM NAME SETUP&gt;# #&lt;SHUTDOWN AND DELETE VM&gt;# /usr/bin/virsh destroy $vm_name /usr/bin/virsh undefine $vm_name /usr/bin/rm -f /var/lib/libvirt/images_write/$vm_name.qcow2 /usr/bin/sed -i "/$port_to_delete/d" $SRV_TMP_DIR/recycle.list #&lt;/SHUTDOWN AND DELETE VM&gt;# /usr/bin/echo "VM ON PORT $vm_port HAS BEEN DELETE AND REMOVE" \ "FROM RECYCLE.LIST. EXIT FROM VM_DELETE.SH" /usr/bin/echo "# $date STOP EXECUTE VM_DELETE.SH#" exit</span></span></code> </pre><br></div></div><br>  ุชุนุชุจุฑ ุฅุฒุงูุฉ ุงูุฌูุงุฒ ุงูุธุงูุฑู ุนูููุฉ ุชุงููุฉ ุฅูู ุญุฏ ูุง ุ ููุญุฏุฏ ุงูุจุฑูุงูุฌ ุงููุตู vm_delete.sh ุงุณู ุงูุฌูุงุฒ ุงูุธุงูุฑู ุงูุฐู ูููู ุงููููุฐ ุงูุฐู ุชู ุชูุฑูุฑู ููุนููุฉ ุจุฏุก ุงูุชุดุบูู.  ูุชู ูุฑุถ VM ููุชููู ุ ุชุชู ุฅุฒุงูุฉ VM ูู ุจุฑูุงูุฌ Hypervisor ุ ููุชู ุญุฐู ุงููุฑุต ุงูุซุงุจุช ุงูุธุงูุฑู ููุฐุง ุงูุฌูุงุฒ.  ุชุชู ุฅุฒุงูุฉ ูููุฐ spice_console ูู ูุงุฆูุฉ ุงูุชุฏููุฑ.  ููุชูู ุชูููุฐ vm_delete.sh ุ ูุณุชุฃูู ุชูููุฐ vm_manager.sh <br><br>  ูุจุฏุฃ ุงูุจุฑูุงูุฌ ุงููุตู vm_manager.sh ุ ูู ููุงูุฉ ุงูุนูููุงุช ูุชูุธูู ุงูุฃุฌูุฒุฉ ุงูุธุงูุฑูุฉ ุบูุฑ ุงูุถุฑูุฑูุฉ ูู ูุงุฆูุฉ ุงูููุงูุงุช. ูุงุฆูุฉ ุฏูุฑุฉ ุฅูุดุงุก ุฃุฌูุฒุฉ ุงูุชุฑุงุถูุฉ ูู ุงูุชุฌูุน. <br><br>  ุชุจุฏุฃ ุงูุนูููุฉ ุจุชุญุฏูุฏ ููุงูุฐ spice_console ุงููุชุงุญุฉ ููุงุณุชุถุงูุฉ.  ููููุงู ุจุฐูู ุ ุงุณุชูุงุฏูุง ุฅูู ูุนููุฉ ููู ุงูุชูููู "srv_start_port_pool" ุงูุฐู ูุนูู ูููุฐ ุงูุจุฏุก ููุชุฌูุน "spice_console" ูู ุงูุฃุฌูุฒุฉ ุงูุธุงูุฑูุฉ ูุงููุนููุฉ "srv_pool_size" ุ ุงูุชู ุชุญุฏุฏ ุงูุญุฏ ุงูุฃูุตู ูุนุฏุฏ ุงูุฃุฌูุฒุฉ ุงูุธุงูุฑูุฉ ุ ูุชู ุชุนุฏุงุฏ ูุงูุฉ ูุชุบูุฑุงุช ุงููููุฐ ุงูููููุฉ ุจุงูุชุณูุณู.  ููู ูููุฐ ูุญุฏุฏ ุ ูุชู ุงูุจุญุซ ุนูู ูู clear.listุ waste.listุ conn_wait.listุ recycle.list.  ุฅุฐุง ุชู ุงูุนุซูุฑ ุนูู ูููุฐ ูู ุฃู ูู ูุฐู ุงููููุงุช ุ ูุนุชุจุฑ ุงููููุฐ ูุดุบููุงู ููุชู ุชุฎุทูู.  ุฅุฐุง ูู ูุชู ุงูุนุซูุฑ ุนูู ุงููููุฐ ูู ุงููููุงุช ุงููุญุฏุฏุฉ ุ ูุณูุชู ุฅุฏุฎุงูู ูู ููู recycle.list ูุชุจุฏุฃ ุนูููุฉ ุฅูุดุงุก ุฌูุงุฒ ุงูุชุฑุงุถู ุฌุฏูุฏ.  ููููุงู ุจุฐูู ุ ูุชู ุงุณุชุฏุนุงุก ุงูุจุฑูุงูุฌ ุงููุตู vm_create.sh ุงูุฐู ูุชู ูู ุฎูุงูู ุชูุฑูุฑ ุฑูู spice_console ูููููุฐ ุงูุฐู ุชุฑูุฏ ุฅูุดุงุก VM ูู ููุนููุฉ. <br><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">/home/admin/scripts_vdi_new/vm_create.sh</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh /usr/bin/echo "#" "$date" "START RUNNING VM_CREATE.SH#" new_vm_port=$1 date=$(/usr/bin/date) a=0 /usr/bin/echo SRV_TMP_DIR=$SRV_TMP_DIR #&lt;SET LOCAL VARIABLES FOR SCRIPT&gt;# base_host=$(/usr/bin/cat /etc/vm_manager.conf |/usr/bin/grep "base_host" \ |/usr/bin/cut -d "=" -f2) /usr/bin/echo "base_host=$base_host" #&lt;/SET LOCAL VARIABLES FOR SCRIPT&gt;# hdd_image_locate() { /bin/echo "Run STEP 1 - hdd_image_locate" hdd_base_image=$(/usr/bin/virsh dumpxml $base_host \ |/usr/bin/grep "source file" |/usr/bin/grep "qcow2" |/usr/bin/head -n 1 \ |/usr/bin/cut -d "'" -f2) if [ -z "$hdd_base_image" ] then /bin/echo "base hdd image not found!" else /usr/bin/echo "hdd_base_image found is a $hdd_base_image. Run next step 2" #&lt; CHECK FOR SNAPSHOT ON BASE HDD &gt;# if [ 0 -eq `/usr/bin/qemu-img info "$hdd_base_image" | /usr/bin/grep -c "Snapshot"` ] then /usr/bin/echo "base image haven't snapshot, run NEXT STEP 3" else /usr/bin/echo "base hdd image have a snapshot, can't use this image" exit fi #&lt;/ CHECK FOR SNAPSHOT ON BASE HDD &gt;# #&lt; CHECK FOR HDD IMAGE IS LINK CLONE &gt;# if [ 0 -eq `/usr/bin/qemu-img info "$hdd_base_image" |/usr/bin/grep -c "backing file" then /usr/bin/echo "base image is not a linked clone, NEXT STEP 4" /usr/bin/echo "Base image check complete!" else /usr/bin/echo "base hdd image is a linked clone, can't use this image" exit fi fi #&lt;/ CHECK FOR HDD IMAGE IS LINK CLONE &gt;# cloning } cloning() { # &lt;Step_1 turn the base VM off &gt;# /usr/bin/virsh shutdown $base_host &gt; /dev/null 2&gt;&amp;1 # &lt;/Step_1 turn the base VM off &gt;# #&lt;Create_vm_config&gt;# /usr/bin/echo "Free port for Spice VM is $new_vm_port" #&lt;Setup_name_for_new_VM&gt;# new_vm_name=$(/bin/echo $base_host"-"$new_vm_port) #&lt;/Setup_name_for_new_VM&gt;# #&lt;Make_base_config_as_clone_base_VM&gt;# /usr/bin/virsh dumpxml $base_host &gt; $SRV_TMP_DIR/$new_vm_name.xml #&lt;Make_base_config_as_clone_base_VM&gt;# ##&lt;Setup_New_VM_Name_in_config&gt;## /usr/bin/sed -i "s%&lt;name&gt;$base_host&lt;/name&gt;%&lt;name&gt;$new_vm_name&lt;/name&gt;%g" $SRV_TMP_DIR/$new_vm_name.xml #&lt;/Setup_New_VM_Name_in_config&gt;# #&lt;UUID Changing&gt;# old_uuid=$(/usr/bin/cat $SRV_TMP_DIR/$new_vm_name.xml |/usr/bin/grep "&lt;uuid&gt;") /usr/bin/echo old UUID $old_uuid new_uuid_part1=$(/usr/bin/echo "$old_uuid" |/usr/bin/cut -d "-" -f 1,2) new_uuid_part2=$(/usr/bin/echo "$old_uuid" |/usr/bin/cut -d "-" -f 4,5) new_uuid=$(/bin/echo $new_uuid_part1"-"$new_vm_port"-"$new_uuid_part2) /usr/bin/echo $new_uuid /usr/bin/sed -i "s%$old_uuid%$new_uuid%g" $SRV_TMP_DIR/$new_vm_name.xml #&lt;/UUID Changing&gt;# #&lt;Spice port replace&gt;# old_spice_port=$(/usr/bin/cat $SRV_TMP_DIR/$new_vm_name.xml \ |/usr/bin/grep "graphics type='spice' port=") /bin/echo old spice port $old_spice_port new_spice_port=$(/usr/bin/echo "&lt;graphics type='spice' port='$new_vm_port' autoport='no' listen='127.0.0.1'&gt;") /bin/echo $new_spice_port /usr/bin/sed -i "s%$old_spice_port%$new_spice_port%g" $SRV_TMP_DIR/$new_vm_name.xml #&lt;/Spice port replace&gt;# #&lt;MAC_ADDR_GENERATE&gt;# mac_new=$(/usr/bin/hexdump -n6 -e '/1 ":%02X"' /dev/random|/usr/bin/sed s/^://g) /usr/bin/echo New Mac is $mac_new #&lt;/MAC_ADDR_GENERATE&gt;# #&lt;GET OLD MAC AND REPLACE&gt;# mac_old=$(/usr/bin/cat $SRV_TMP_DIR/$new_vm_name.xml |/usr/bin/grep "mac address=") /usr/bin/echo old mac is $mac_old /usr/bin/sed -i "s%$mac_old%$mac_new%g" $SRV_TMP_DIR/$new_vm_name.xml #&lt;GET OLD MAC AND REPLACE&gt;# #&lt;new_disk_create&gt;# /usr/bin/qemu-img create -f qcow2 -b $hdd_base_image /var/lib/libvirt/images_write/$new_vm_name.qcow2 #&lt;/new_disk_create&gt;# #&lt;attach_new_disk_in_confiig&gt;# /usr/bin/echo hdd base image is $hdd_base_image /usr/bin/sed -i "s%&lt;source file='$hdd_base_image'/&gt;%&lt;source file='/var/lib/libvirt/images_write/$new_vm_name.qcow2'/&gt;%g" $SRV_TMP_DIR/$new_vm_name.xml #&lt;/attach_new_disk_in_confiig&gt;# starting_vm #&lt;/Create_vm config&gt;# } starting_vm() { /usr/bin/virsh define $SRV_TMP_DIR/$new_vm_name.xml /usr/bin/virsh start $new_vm_name while [ $a -ne 1 ] do if /usr/bin/virsh list --all |/usr/bin/grep "$new_vm_name" |/usr/bin/grep "running" &gt; /dev/null 2&gt;&amp;1 then a=1 /usr/bin/sed -i "/$new_vm_port/d" $SRV_TMP_DIR/recycle.list /usr/bin/echo $new_vm_port &gt;&gt; $SRV_TMP_DIR/clear.list /usr/bin/echo "#" "$date" "VM $new_vm_name IS STARTED #" else /usr/bin/echo "#VM $new_vm_name is not ready#" a=0 /usr/bin/sleep 2s fi done /usr/bin/echo "#$date EXIT FROM VM_CREATE.SH#" exit } hdd_image_locate</span></span></code> </pre><br></div></div><br>  ุนูููุฉ ุฅูุดุงุก ุฌูุงุฒ ุงูุชุฑุงุถู ุฌุฏูุฏ <br><br>  ููุฑุฃ ุงูุจุฑูุงูุฌ ุงููุตู vm_create.sh ูู ููู ุงูุชูููู ูููุฉ ุงููุชุบูุฑ "base_host" ุงูุฐู ูุญุฏุฏ ูููุฐุฌ ุงูุฌูุงุฒ ุงูุธุงูุฑู ุงูุฐู ุณูุชู ุฅุฌุฑุงุก ุนูููุฉ ุงูุงุณุชูุณุงุฎ ุนููู.  ุฅูุบุงุก ุชุญููู ุชูููู xml ูู VM ูู ูุงุนุฏุฉ ุจูุงูุงุช ุจุฑูุงูุฌ Hypervisor ุ ููููู ุจุฅุฌุฑุงุก ุณูุณูุฉ ูู ุงูุงุฎุชุจุงุฑุงุช qcow ูุตูุฑุฉ ูุฑุต VM ุ ูุนูุฏ ุงูุงูุชูุงุก ุจูุฌุงุญ ุ ูููู ุจุฅูุดุงุก ููู ุชูููู xml ูู VM ุงูุฌุฏูุฏ ูุตูุฑุฉ ูุฑุต "clone ูุฑุชุจุท" ูู VM ุงูุฌุฏูุฏ.  ุจุนุฏ ุฐูู ุ ูุชู ุชุญููู ุชูููู xml ุงูุฎุงุต ุจู VM ุงูุฌุฏูุฏ ูู ูุงุนุฏุฉ ุจูุงูุงุช ุจุฑูุงูุฌ hypervisor ููุจุฏุฃ ุชุดุบููู.  ูุชู ููู ูููุฐ spice_console ูู ูุงุฆูุฉ ุงูุชุฏููุฑ ุฅูู ูุงุฆูุฉ.  ููุชูู ุชูููุฐ vm_create.sh ูููุชูู ุชูููุฐ vm_manager.sh. <br>  ูู ุงููุฑุฉ ุงูุชุงููุฉ ุงูุชู ุชุชุตู ูููุง ุ ุชุจุฏุฃ ูู ุงูุจุฏุงูุฉ. <br><br>  ุจุงููุณุจุฉ ูุญุงูุงุช ุงูุทูุงุฑุฆ ุ ุชุดุชูู ุงููุฌููุนุฉ ุนูู ุจุฑูุงูุฌ ูุตู vm_clear.sh ูุงูุฐู ูุชู ุชุดุบููู ูุณุฑููุง ุนุจุฑ ุฌููุน ุฃุฌูุฒุฉ VM ูู ุงูุชุฌูุน ูุฅุฒุงูุชูุง ุจุชุตููุฑ ููู ุงูููุงุฆู.  ูุชูุญ ูู ุงูุงุชุตุงู ุจู ูู ูุฑุญูุฉ ุงูุชุญููู ุจุฏุก (ุชุญุช) VDI ูู ููุทุฉ ุงูุตูุฑ. <br><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">/home/admin/scripts_vdi_new/vm_clear.sh</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/sh #set VARIABLES# SRV_SCRIPTS_DIR=$(/usr/bin/cat /etc/vm_manager.conf \ |/usr/bin/grep "srv_scripts_dir" |/usr/bin/cut -d "=" -f2) /usr/bin/echo "SRV_SCRIPTS_DIR=$SRV_SCRIPTS_DIR" export SRV_SCRIPTS_DIR=$SRV_SCRIPTS_DIR SRV_TMP_DIR=$(/usr/bin/cat /etc/vm_manager.conf \ |/usr/bin/grep "srv_tmp_dir" |/usr/bin/cut -d "=" -f2) /usr/bin/echo "SRV_TMP_DIR=$SRV_TMP_DIR" export SRV_TMP_DIR=$SRV_TMP_DIR SRV_POOL_SIZE=$(/usr/bin/cat /etc/vm_manager.conf \ |/usr/bin/grep "srv_pool_size" |/usr/bin/cut -d "=" -f2) /usr/bin/echo "SRV_POOL_SIZE=$SRV_POOL_SIZE" SRV_START_PORT_POOL=$(/usr/bin/cat /etc/vm_manager.conf \ |/usr/bin/grep "srv_start_port_pool" |/usr/bin/cut -d "=" -f2) /usr/bin/echo SRV_START_PORT_POOL=$SRV_START_PORT_POOL #Set VARIABLES# /usr/bin/echo "= Cleanup ALL VM=" /usr/bin/mkdir $SRV_TMP_DIR /usr/sbin/service iptables restart /usr/bin/cat /dev/null &gt; $SRV_TMP_DIR/clear.list /usr/bin/cat /dev/null &gt; $SRV_TMP_DIR/waste.list /usr/bin/cat /dev/null &gt; $SRV_TMP_DIR/recycle.list /usr/bin/cat /dev/null &gt; $SRV_TMP_DIR/conn_wait.list port_to_delete=$(($SRV_START_PORT_POOL+$SRV_POOL_SIZE)) while [ "$port_to_delete" -gt "$SRV_START_PORT_POOL" ] do $SRV_SCRIPTS_DIR/vm_delete.sh $port_to_delete port_to_delete=$(($port_to_delete-1)) done /usr/bin/echo "= EXIT FROM VM_CLEAR.SH="</span></span></code> </pre><br></div></div><br>  ูู ูุฐุง ุฃูุฏ ุฃู ุฃููู ุงูุฌุฒุก ุงูุฃูู ูู ูุตุชู.  ูุฌุจ ุฃู ูููู ูุง ุณุจู ูุงููุงู ููุณุคููู ุงููุธุงู ููุญุงููุฉ underVDI ูู ุงูุนูู.  ุฅุฐุง ูุฌุฏ ุงููุฌุชูุน ูุฐุง ุงูููุถูุน ูุซูุฑูุง ููุงูุชูุงู ุ ูู ุงูุฌุฒุก ุงูุซุงูู ุ ุณุฃุชุญุฏุซ ุนู ุชุนุฏูู ูุฑุต ุญู Fedora ูุชุญููู ุฅูู ูุดู. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar462203/">https://habr.com/ru/post/ar462203/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar462181/index.html">ููุงุนุฏ ููุชูุงุตู ุงููุนุงู ูู ุฏุฑุฏุดุงุช ุงููุฌููุนุฉ</a></li>
<li><a href="../ar462185/index.html">ุงูุชูุช ุงูุซูุฑุฉ. ูู ููุงู ุจุฏูู ูุจุทุงุฑูุฉ ููุซููู ุฃูููุ</a></li>
<li><a href="../ar462189/index.html">ุญูุฑ ุงูุจูุงูุงุช ูุน travajs</a></li>
<li><a href="../ar462191/index.html">ูุชุญู ุฏุงุชุง ุขุฑุช: ุฌููุฉ ูู ุดูุงู ุฅูุทุงููุง</a></li>
<li><a href="../ar462197/index.html">ูุตุงุฆุญ ุญูู ููููุฉ ุชุญุฑูุฑ ุนููู ูุฒูุงุฏุฉ ุฅุจุฏุงุนู</a></li>
<li><a href="../ar462205/index.html">ุฑุจุญ PHDays 9 ุงูููุงุฌูุฉ: ููุงุฆุน ูุฑูู True0xA3</a></li>
<li><a href="../ar462209/index.html">ุญููู Polycom VideoConference. ุฐูุฑูุงุช ุจุนุฏ 6 ุณููุงุช ... ุงููุฑุญูุฉ 2. ุงูุฌุฒุก 1. RMX1500</a></li>
<li><a href="../ar462213/index.html">ุงูุชุนูู ูุงูุนูู: ุชุฌุฑุจุฉ ุงูุทูุงุจ ุงูุฌุงูุนููู ูู ูููุฉ ุชูููููุฌูุง ุงููุนูููุงุช ูุงูุจุฑูุฌุฉ</a></li>
<li><a href="../ar462221/index.html">ููู ุจุฎูุจุฉ ุฃูู ุฃูุง ุนูู Google Play</a></li>
<li><a href="../ar462227/index.html">ููุณูู ุ 9 ุฃุบุณุทุณ - ูุตุต ุงูุฎูููุฉ 4.0</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>