<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üè∫ üé∫ üßñ C√≥mo protest√© el indicador UPS ‚õ≥Ô∏è üëö üêÇ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A finales de los 90 obtuve UPS. Hermoso, con un indicador LED y un mont√≥n de botones, ten√≠a dos bater√≠as adentro y pod√≠a soportar la vida √∫til de mi c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C√≥mo protest√© el indicador UPS</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/397697/"><img src="https://habrastorage.org/files/4f0/b42/8eb/4f0b428ebdd6405db46834adaf3a9543.jpg" alt="durante la depuraci√≥n"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A finales de los 90 obtuve UPS. Hermoso, con un indicador LED y un mont√≥n de botones, ten√≠a dos bater√≠as adentro y pod√≠a soportar la vida √∫til de mi computadora en ese momento (¬°junto con el monitor!) Por hasta 15 minutos. Los tiempos en Kamchatka eran dif√≠ciles, las luces se apagaban regularmente, por lo que este dispositivo era muy √∫til. Pas√© por toda la crisis energ√©tica con √©l, y m√°s de una vez salv√≥ mis documentos de t√©rmino de la repentina p√©rdida de electricidad. Y tambi√©n, podr√≠a conectar una grabadora y, a la luz de una vela, escuchar la radio o sus cintas favoritas, prepar√°ndose una cena en una estufa de gas port√°til ...</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Naturalmente, el UPS se estaba rompiendo. La primera vez que su transformador se quem√≥. No el que es grande y est√° en el inversor, sino uno peque√±o, probablemente para medir el voltaje en la red. Al no encontrar la misma f√°brica, configur√© una propia y el dispositivo funcion√≥ durante m√°s tiempo. Entonces se detuvo. Durante mucho, mucho tiempo, no pude encontrar la raz√≥n. Tuve que soldar diferentes partes, verificar su rendimiento y soldarlas nuevamente. El problema no fue encontrado. El dispositivo destripado cay√≥ debajo de la cama durante un par de a√±os, hasta que, un buen d√≠a, se me ocurri√≥ la idea de aplicar 5 voltios directamente al controlador. Y he aqu√≠: hubo un pitido del altavoz incorporado y los n√∫meros aparecieron en el indicador LED. ¬°Estaba vivo! Adem√°s, es una cuesti√≥n de tecnolog√≠a: camin√© por el circuito de alimentaci√≥n con un volt√≠metro y descubr√≠ que se hab√≠a soldado un fusible en el tablero, ¬°que insolentemente parec√≠a una resistencia!El fusible (quemado naturalmente) fue reemplazado y el UPS volvi√≥ a la vida.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Desafortunadamente, mi reparaci√≥n y dos a√±os debajo de la cama no desaparecieron para el dispositivo por nada. De alguna manera incomprensible, el puerto se quem√≥ en el controlador, que fue responsable del brillo del LED verde "en l√≠nea" y del segmento m√°s bajo de todos los indicadores de segmento digital. No hay nada que hacer al respecto, tuve que aceptarlo. Despu√©s de un tiempo, dej√© Kamchatka y nuestros caminos se separaron. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pasaron los a√±os y, al llegar a visitar a mis padres, en la esquina m√°s alejada encontr√© mi bater√≠a ininterrumpida favorita: abandonada, sucia, sin bater√≠as y patas de goma. En ese momento, ya hab√≠a adquirido mi propia vivienda en otra ciudad, por lo que se tom√≥ la decisi√≥n de refugiarme en m√≠ mismo, restaurar su eficiencia y usarlo para el prop√≥sito previsto. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Desaf√≠o</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En primer lugar, el UPS fue lavado y secado. Luego, en cierta tienda de repuestos de radio, se compraron pies de goma adecuados y bater√≠as nuevas. Para mi gran sorpresa, se encontr√≥ un transformador adecuado en la misma tienda, a cambio de mi producto casero. Un par de d√≠as de trabajo, y la bater√≠a ininterrumpida lavada y actualizada chirri√≥ felizmente y comenz√≥ a cargar sus nuevas bater√≠as. Todo estaba bien, pero el indicador segu√≠a sin funcionar.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La idea de arreglarlo me vino antes. Despu√©s de dibujar todos los n√∫meros (y algunas letras) del indicador de siete segmentos en la hoja del cuaderno, me di cuenta de que es posible determinar el estado del segmento m√°s bajo por el estado del resto. El LED verde se puede encender cuando otros LED no est√°n encendidos. Hubo muchas reflexiones sobre c√≥mo se podr√≠a hacer esto: desde un simple chip ROM a un simple FPGA. Pero, como era estudiante y viv√≠a en Kamchatka, no tuve la oportunidad de adquirir algo m√°s complicado que la l√≥gica mezquina. La fijaci√≥n del indicador fue pospuesta.</font></font><br>
<br>
<img src="https://habrastorage.org/files/0d1/175/f43/0d1175f43d72446383ebd4f0dcb687db.jpg" alt="dibujar segmentos"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esta vez decid√≠ abordar el problema en serio. Habiendo hurgado en contenedores, nuevamente no encontr√© en m√≠ ni ROM, ni FPGA y ning√∫n CPLD. Pero, Arduino Pro Mini, o m√°s bien, su clon chino barato con Ali Express, cay√≥ en manos de. Compr√© Arduin para hacer una mini computadora basada en una tarjeta WiFi SD de Transcend. Desafortunadamente, la tarjeta muri√≥ durante los experimentos, y la placa con el microcontrolador permaneci√≥ inactiva. ¬°Nada, le encontramos un nuevo desaf√≠o! </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trabajo</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La visualizaci√≥n din√°mica se implementa en el m√≥dulo de visualizaci√≥n: las se√±ales de segmento son comunes a los cuatro indicadores, de modo que solo uno de ellos se enciende a la vez. Adem√°s: como con el quinto indicador, tambi√©n est√°n conectados tres LED. Cinco se√±ales de selecci√≥n le permiten especificar qu√© indicador (o l√≠nea de LED) se est√° utilizando ahora. Estas se√±ales de selecci√≥n se escanean secuencialmente a una velocidad bastante alta y, debido a la inercia de la visi√≥n, parece que todos los indicadores est√°n encendidos al mismo tiempo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al principio, quer√≠a sortear la soluci√≥n m√°s simple: un ciclo ordinario que verifica las se√±ales de seis segmentos de trabajo y enciende o apaga el s√©ptimo que no funciona. De hecho, esto es solo una emulaci√≥n de la ROM, que pens√© al principio.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para hacer esto, tuve que conectar seis segmentos de trabajo a la entrada del microcontrolador y un segmento que no funciona a la salida. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de esbozar una peque√±a matriz que compara los diversos estados de las entradas con la salida y el bucle que omite esta matriz, cargu√© todo en el controlador e inmediatamente tuve un problema: el segmento inferior siempre brillaba. Primer pensamiento: el cant en el programa. Sin embargo, no importa cu√°nto haya mirado el c√≥digo, no se encontraron errores. Al final, se entendi√≥ que mi ciclo no estaba sincronizado de ninguna manera con el cambio de indicadores. Si leemos el estado de los segmentos al final del ciclo de selecci√≥n de un indicador, entonces es probable que iluminemos o bajemos el siguiente segmento en el siguiente. El desastre</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sin pensarlo dos veces, solde cinco se√±ales de selecci√≥n de indicador a las entradas Arduino libres restantes, las configur√© para generar una interrupci√≥n y comenc√© a usar un controlador de interrupciones en lugar de un bucle. Se mejor√≥, pero no resolvi√≥ el problema. En los lugares correctos, el segmento ardi√≥ como deber√≠a, pero en aquellos lugares donde se supon√≠a que deb√≠a extinguirse, no hab√≠a un resplandor residual brillante.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de pensar un poco m√°s, decid√≠ que este efecto puede aparecer si el ciclo de b√∫squeda en la matriz del estado deseado para los segmentos lleva m√°s tiempo que el tiempo de grabaci√≥n del indicador. En este caso, tambi√©n salimos de nuestra fase y gestionamos el segmento del siguiente indicador. Es necesario que pase el menor tiempo posible entre el momento de recibir la interrupci√≥n desde la se√±al de selecci√≥n hasta el comando de control del segmento. Esto solo se puede hacer de una manera: eliminar el c√≥digo que toma la decisi√≥n sobre el estado del segmento del controlador de interrupciones, ejecutarlo en el bucle principal con una prioridad m√≠nima y guardar el resultado en una especie de b√∫fer global. El manejador de interrupciones solo tendr√° que leer el valor de este b√∫fer global y extinguir o iluminar el segmento, dependiendo de su contenido. En el peor de los casossolo podemos llegar tarde con el cambio en el estado del segmento en un indicador determinado, pero no subiremos al siguiente.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esa fue la decisi√≥n correcta. </font><font style="vertical-align: inherit;">Pero finalmente funcion√≥ solo despu√©s de sincronizar el ciclo de toma de decisiones con una interrupci√≥n usando spin-lock y prohib√≠ el procesamiento de interrupciones durante este ciclo. </font><font style="vertical-align: inherit;">¬°Y no solo gan√≥, sino que gan√≥ como deber√≠a!</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hubo otro problema con los indicadores: la mayor√≠a de las veces solo mostraban n√∫meros. </font><font style="vertical-align: inherit;">Sin embargo, despu√©s de encender el UPS, comenz√≥ el proceso de prueba, durante el cual, adem√°s de los n√∫meros, aparecieron dos palabras m√°s: TEST y PASS. </font><font style="vertical-align: inherit;">Y si, las letras T, E y P simplemente se pudieran agregar a la matriz de caracteres v√°lidos, y S fuera igual a 5, entonces la letra A no era nada, desde el punto de vista de mi programa, del ocho. </font><font style="vertical-align: inherit;">El ciclo de decisi√≥n simplemente encontr√≥ el patr√≥n apropiado en la matriz y dibuj√≥ el segmento inferior. </font><font style="vertical-align: inherit;">Era necesario pensar en algo para evitar esto.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y se me ocurri√≥. Durante la llegada de una se√±al sobre un cambio de indicador, es necesario determinar a qu√© indicador pertenece y guardar el estado de sus segmentos en una variable especialmente asignada para √©l. Ahora, en cualquier momento, puedo determinar con bastante precisi√≥n el contenido actual de los cuatro indicadores a la vez. Y si los s√≠mbolos P, 5 y 5 se muestran en el primero, tercero y cuarto, respectivamente, entonces el segundo s√≠mbolo es definitivamente A, y no necesita iluminar el segmento inferior. Por si acaso, tambi√©n agregu√© el procesamiento de la palabra FAIL, que nunca hab√≠a visto, pero que esperaba que apareciera.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todo, con el indicador digital terminado. Solo queda arreglar el LED verde en l√≠nea. Pero aqu√≠ me esperaba una sorpresa ... La idea era esta: el LED verde (en l√≠nea) siempre se ilumina solo. Si los LED amarillo (bater√≠a) o rojo (bater√≠a baja) est√°n encendidos, el verde no deber√≠a encenderse. Por lo tanto, soldamos cables de estos LED al microcontrolador, ponemos un simple if () con un "OR" l√≥gico y todo deber√≠a funcionar. Pero result√≥ que cuando el LED amarillo est√° encendido, de hecho, no se ilumina constantemente, sino que parpadea r√°pidamente. R√°pido, pero no lo suficiente para que if () salte y no encienda el LED verde. Result√≥ que cuando se trabaja desde la red, el LED verde se ilumina a pleno brillo, pero al cambiar a la bater√≠a, se quem√≥ a la mitad del brillo, pero a√∫n se quem√≥. Bueno, no es un problema, pens√©, pondr√© un filtro de paso bajo simple:Cortar√© todos los flashes r√°pidos, pero dejar√© solo los lentos que corresponden a la transici√≥n a la bater√≠a y viceversa. El an√°lisis del tiempo de parpadeo del LED amarillo trajo la siguiente sorpresa: el per√≠odo de los pulsos que se le suministra es muy inestable y puede alcanzar valores bastante grandes. Result√≥ que el filtro deber√≠a pasar se√±ales no superiores a 0.5-1 Hz. Esto no es muy bueno, ya que tenemos un retraso bastante grande al cambiar la se√±al en l√≠nea, pero es bastante tolerable.dado que tenemos un retraso bastante grande al cambiar la se√±al en l√≠nea, pero es bastante soportable.dado que tenemos un retraso bastante grande al cambiar la se√±al en l√≠nea, pero es bastante soportable.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Decid√≠ hacer el filtro muy simple. </font><font style="vertical-align: inherit;">Supervisamos 50 veces, a intervalos regulares, el estado de los LED amarillo y rojo. </font><font style="vertical-align: inherit;">Si uno de ellos se quema, entonces aumentamos el contador especial en uno. </font><font style="vertical-align: inherit;">Luego, verificamos el valor del contador, y si los LED de control se iluminan durante el 50% del tiempo verificado, entonces creemos que est√° encendido, y si es menos, entonces est√° apagado. </font><font style="vertical-align: inherit;">En el proceso de depuraci√≥n, tuve que reducir esta cifra al 10%. </font><font style="vertical-align: inherit;">¬øPor qu√©? No lo descubr√≠. </font></font><br>
<br>
<img src="https://habrastorage.org/files/88e/bd5/51b/88ebd551ba62430ba32362657836bd94.jpg" alt="asamblea final"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬°Y todo funcion√≥! </font><font style="vertical-align: inherit;">Solo quedaba montar bellamente la placa Arduino en la caja del UPS con cinta de doble cara y una pistola adhesiva.</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/Elb8pT4lWlQ" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para los curiosos:</font></font><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">el c√≥digo resultante</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdint.h&gt;</span></span></span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;avr/io.h&gt;</span></span></span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;avr/interrupt.h&gt;</span></span></span></span><font></font>
<font></font>
<font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> AVG_TIME    50</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> THS_TIME    45</span></span><font></font>
<font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SEG_A    _BV(0)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SEG_B    _BV(1)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SEG_C    _BV(2)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SEG_D    _BV(3)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SEG_E    _BV(4)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SEG_F    _BV(5)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SEG_G    _BV(6)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_LED_RED  SD_SEG_A</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_LED_YLW  SD_SEG_C</span></span><font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LD_SEL_LED  _BV(0)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LD_SEL_1    _BV(1)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LD_SEL_2    _BV(2)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LD_SEL_3    _BV(3)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LD_SEL_4    _BV(4)</span></span><font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> GET_SEL     (PINC &amp; 0x1f)</span></span><font></font>
<font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_NONE (0)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_0    (SD_SEG_A | SD_SEG_B | SD_SEG_C | SD_SEG_D | SD_SEG_E | SD_SEG_F)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_1    (SD_SEG_B | SD_SEG_C)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_2    (SD_SEG_A | SD_SEG_B | SD_SEG_D | SD_SEG_E | SD_SEG_G)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_3    (SD_SEG_A | SD_SEG_B | SD_SEG_C | SD_SEG_D | SD_SEG_G)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_4    (SD_SEG_B | SD_SEG_C | SD_SEG_F | SD_SEG_G)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_5    (SD_SEG_A | SD_SEG_C | SD_SEG_D | SD_SEG_F | SD_SEG_G)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_6    (SD_SEG_A | SD_SEG_C | SD_SEG_D | SD_SEG_E | SD_SEG_F | SD_SEG_G)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_7    (SD_SEG_A | SD_SEG_B | SD_SEG_C)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_8    (SD_SEG_A | SD_SEG_B | SD_SEG_C | SD_SEG_D | SD_SEG_E | SD_SEG_F | SD_SEG_G)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_9    (SD_SEG_A | SD_SEG_B | SD_SEG_C | SD_SEG_D | SD_SEG_F | SD_SEG_G)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_E    (SD_SEG_A | SD_SEG_D | SD_SEG_E | SD_SEG_F | SD_SEG_G)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_P    (SD_SEG_A | SD_SEG_B | SD_SEG_E | SD_SEG_F | SD_SEG_G)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_T    (SD_SEG_D | SD_SEG_E | SD_SEG_F | SD_SEG_G)</span></span><font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> GET_SYM     (~PIND &amp; 0x7f)</span></span><font></font>
<font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> BROKEN_SEG  (SD_SEG_D)</span></span><font></font>
<font></font>
<font></font>
<font></font>
<span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> sd_symbols[] = {                 <span class="hljs-comment"><span class="hljs-comment">// list of known symbols</span></span><font></font>
    SD_SYM_NONE,<font></font>
    SD_SYM_0, SD_SYM_1, SD_SYM_2, SD_SYM_3, SD_SYM_4,<font></font>
    SD_SYM_5, SD_SYM_6, SD_SYM_7, SD_SYM_8, SD_SYM_9,<font></font>
    SD_SYM_E, SD_SYM_P, SD_SYM_T<font></font>
};<font></font>
<span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> sel, symbol;            <span class="hljs-comment"><span class="hljs-comment">// current input signals</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> fb0, fb1, fb2, fb3, fb4;  <span class="hljs-comment"><span class="hljs-comment">// display frame buffer</span></span><font></font>
<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">// display routine</span></span><font></font>
ISR(PCINT1_vect) {<font></font>
    sel = GET_SEL;<font></font>
    symbol = GET_SYM;<font></font>
<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (((sel &amp; LD_SEL_LED) &amp;&amp; fb0) ||<font></font>
            ((sel &amp; LD_SEL_1) &amp;&amp; fb1) ||<font></font>
            ((sel &amp; LD_SEL_2) &amp;&amp; fb2) ||<font></font>
            ((sel &amp; LD_SEL_3) &amp;&amp; fb3) ||<font></font>
            ((sel &amp; LD_SEL_4) &amp;&amp; fb4)){<font></font>
        PORTD &amp;= ~BROKEN_SEG;<font></font>
    }<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {<font></font>
        PORTD |= BROKEN_SEG;<font></font>
    }<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">//</span></span>
<span class="hljs-comment"><span class="hljs-comment">// entry point</span></span>
<span class="hljs-comment"><span class="hljs-comment">//</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">
</span></span>{
    <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> cur_time;
    <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> led_on_time;
    <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> last_symbol_1, last_symbol_2, last_symbol_3, last_symbol_4;
    <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i;<font></font>
<font></font>
    <span class="hljs-comment"><span class="hljs-comment">// setup GPIO ports</span></span>
    DDRC = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
    DDRD = BROKEN_SEG;<font></font>
<font></font>
    <span class="hljs-comment"><span class="hljs-comment">// setup pin change interrupt</span></span><font></font>
    PCICR |= _BV(PCIE1);<font></font>
    PCMSK1 |= _BV(PCINT8) | _BV(PCINT9) | _BV(PCINT10) | _BV(PCINT11) | _BV(PCINT12);<font></font>
<font></font>
    cur_time = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
    led_on_time = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
    last_symbol_1 = last_symbol_2 = last_symbol_3 = last_symbol_4 = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
    fb0 = fb1 = fb2 = fb3 = fb4 = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>) {
        <span class="hljs-comment"><span class="hljs-comment">// sync with display strobe</span></span><font></font>
        sei();<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (sel == <span class="hljs-number"><span class="hljs-number">0</span></span>) {}<font></font>
        cli();<font></font>
<font></font>
        <span class="hljs-comment"><span class="hljs-comment">// if select one of segment indicator</span></span>
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sel &amp; (LD_SEL_1 | LD_SEL_2 | LD_SEL_3 | LD_SEL_4)) {
            <span class="hljs-comment"><span class="hljs-comment">// looking for displayed symbol</span></span>
            <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">14</span></span>; i++) {
                <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> sd_symbol = sd_symbols[i];
                <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((symbol &amp; ~BROKEN_SEG) == (sd_symbol &amp; ~BROKEN_SEG)) {
                    <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> val;
                    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sd_symbol &amp; BROKEN_SEG) {<font></font>
                        val = <span class="hljs-number"><span class="hljs-number">1</span></span>;<font></font>
                    } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {<font></font>
                        val = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
                    }<font></font>
<font></font>
                    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sel &amp; LD_SEL_1) {<font></font>
                        last_symbol_1 = sd_symbol;<font></font>
                        fb1 = val;<font></font>
                    } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sel &amp; LD_SEL_2) {<font></font>
                        last_symbol_2 = sd_symbol;<font></font>
                        fb2 = val;<font></font>
                    } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sel &amp; LD_SEL_3) {<font></font>
                        last_symbol_3 = sd_symbol;<font></font>
                        fb3 = val;<font></font>
                    } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sel &amp; LD_SEL_4) {<font></font>
                        last_symbol_4 = sd_symbol;<font></font>
                        fb4 = val;<font></font>
                    }<font></font>
<font></font>
                    <span class="hljs-comment"><span class="hljs-comment">// PASS workaround</span></span>
                    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((last_symbol_1 == SD_SYM_P) &amp;&amp;(last_symbol_2 == SD_SYM_8) &amp;&amp;<font></font>
                            (last_symbol_3 == SD_SYM_5) &amp;&amp; (last_symbol_4 == SD_SYM_5)) {<font></font>
                        fb2 = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
                    }<font></font>
                    <span class="hljs-comment"><span class="hljs-comment">// FAIL workaround</span></span>
                    <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((last_symbol_1 == SD_SYM_E) &amp;&amp;(last_symbol_2 == SD_SYM_8) &amp;&amp;<font></font>
                            (last_symbol_3 == SD_SYM_1) &amp;&amp; (last_symbol_4 == SD_SYM_1)) {<font></font>
                        fb1 = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
                        fb2 = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
                        fb4 = <span class="hljs-number"><span class="hljs-number">1</span></span>;<font></font>
                    }<font></font>
<font></font>
                    <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;<font></font>
                }<font></font>
            }<font></font>
        }<font></font>
        <span class="hljs-comment"><span class="hljs-comment">// if select LED line</span></span>
        <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sel &amp; LD_SEL_LED) {
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cur_time++ &gt; AVG_TIME) {
                <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (led_on_time &lt; THS_TIME) {<font></font>
                    fb0 = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
                } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {<font></font>
                    fb0 = <span class="hljs-number"><span class="hljs-number">1</span></span>;<font></font>
                }<font></font>
                cur_time = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
                led_on_time = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
            } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {
                <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((symbol &amp; (SD_LED_RED | SD_LED_YLW)) == <span class="hljs-number"><span class="hljs-number">0</span></span>) {<font></font>
                    led_on_time++;<font></font>
                }<font></font>
            }<font></font>
        }<font></font>
<font></font>
        <span class="hljs-comment"><span class="hljs-comment">// reset sync flag</span></span>
        sel = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
}<font></font>
</code></pre><br>
</div></div></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es397697/">https://habr.com/ru/post/es397697/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es397687/index.html">En algunas computadoras port√°tiles con Windows 10 no puede enviar Linux</a></li>
<li><a href="../es397689/index.html">¬øPor qu√© siempre nos sentimos ocupados?</a></li>
<li><a href="../es397691/index.html">Compre como PRO, hermano</a></li>
<li><a href="../es397693/index.html">Los cient√≠ficos primero compilaron un modelo 3D del cerebro de Drosophila</a></li>
<li><a href="../es397695/index.html">¬øQu√© son los plastificantes y con qu√© comen?</a></li>
<li><a href="../es397699/index.html">Los beneficios de la caligraf√≠a y otros mitos educativos.</a></li>
<li><a href="../es397701/index.html">Tarjeta de video que lleva mi nombre: c√≥mo convertirse en un overclocker profesional</a></li>
<li><a href="../es397703/index.html">Galardonados con el Premio Shnobel 2016</a></li>
<li><a href="../es397705/index.html">Bater√≠as de iones de litio y pol√≠mero de litio: trucos de marketing y errores comunes</a></li>
<li><a href="../es397707/index.html">Cerebelo incre√≠ble</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>