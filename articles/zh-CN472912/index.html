<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏿‍🚀 ❓ 🤰🏽 用于人类的ClickHouse数据库或Alien Technology 🚷 👨🏽‍🔬 👨🏻‍🔬</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ICD信息技术局远程服务通道能力中心负责人Alexey Lizunov 



 作为ELK堆栈（ElasticSearch，Logstash，Kibana）的替代方法，我们正在研究将ClickHouse数据库用作日志的数据仓库。 

 在本文中，我们想谈谈使用ClickHouse数据库的经验以及试...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>用于人类的ClickHouse数据库或Alien Technology</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mkb/blog/472912/">  <b>ICD信息技术局远程服务通道能力中心负责人Alexey Lizunov</b> <br><br><img src="https://habrastorage.org/webt/bs/gu/k0/bsguk03an99lspkpmtkoks2bkvg.png"><br><br> 作为ELK堆栈（ElasticSearch，Logstash，Kibana）的替代方法，我们正在研究将ClickHouse数据库用作日志的数据仓库。 <br><br> 在本文中，我们想谈谈使用ClickHouse数据库的经验以及试验操作的初步结果。 应当立即指出，结果令人印象深刻。 <br><br><a name="habracut"></a><br><img src="https://habrastorage.org/webt/uy/mc/ip/uymcipeis_jm2piqsaqdjmu9_l8.jpeg"><br><br> 接下来，我们将更详细地描述系统的配置方式及其组成部分。 但是，现在我想谈谈整个数据库，以及为什么要注意它。  ClickHouse数据库是Yandex的高性能分析柱数据库。 它用于Yandex服务，最初是Yandex.Metrica的主要数据仓库。 开源系统是免费的。 从开发人员的角度来看，我一直对他们的实现方式很感兴趣，因为那里有大量的大数据。 度量用户界面本身非常灵活且快速。 初识该数据库时，印象是：“好，最后！ 发“为人”！ 从安装过程开始，以发送请求结束。” <br><br> 该数据库的进入阈值非常低。 即使是普通的开发人员也可以在几分钟内安装该数据库并开始使用它。 一切正常。 即使是Linux新手，也可以快速完成安装并进行简单的操作。 早先，当大数据，Hadoop，Google BigTable，HDFS一词出现时，通常的开发人员就想到了他们谈论的是数TB，PB的问题，一些超人参与了这些系统的设置和开发，然后随着ClickHouse数据库的出现，我们得到了一个简单易懂的工具，可用来解决以前无法完成的一系列任务。 只需一辆相当普通的汽车，五分钟即可安装。 也就是说，我们有一个数据库，例如MySql，但仅用于存储数十亿条记录！ 某种SQL主管。 好像人们得到了外国人的武器。 <br><br><h4> 关于我们的日志收集系统 </h4><br> 为了收集信息，使用了标准格式的Web应用程序的IIS日志文件（我们也从事解析应用程序日志的工作，但是与我们一起进行试运行阶段的主要目标是收集IIS日志）。 <br><br> 由于各种原因，我们未能完全放弃ELK堆栈，而我们继续使用LogStash和Filebeat组件，它们已被证明自己性能良好，并且运行十分可靠且可预测。 <br><br> 下图显示了常规的日志记录方案： <br><br><img src="https://habrastorage.org/webt/ah/kr/qg/ahkrqgjij-tfce_455jhjikjfg8.jpeg"><br><br> 将数据写入ClickHouse数据库的功能是不大批量（每秒一次）插入记录。 显然，这是您第一次使用ClickHouse数据库时遇到的最“有问题”的部分：该方案有点复杂。 <br>  LogStash插件在这里起到了很大作用，可以直接将数据插入ClickHouse。 该组件与数据库本身部署在同一服务器上。 因此，一般来讲，不建议这样做，而是从实际角度出发，以免在将同一服务器上部署服务器时不产生单独的服务器。 我们没有发现与数据库有任何故障或资源冲突。 此外，应注意的是，插件在发生错误的情况下具有重新启动机制。 并且在出现错误的情况下，该插件将无法插入的数据包写入磁盘（文件格式很方便：编辑后，您可以使用clickhouse-client轻松插入已更正的数据包）。 <br><br> 下表列出了该方案中使用的软件的完整列表： <br><br><div class="spoiler">  <b class="spoiler_title">使用软件列表</b> <div class="spoiler_text"><div class="scrollable-table"><table><tbody><tr><td>  <b>职称</b> <br></td><td>  <b>内容描述</b> <br></td><td>  <b>发行链接</b> <br></td></tr><tr><td><p>  Nginx的 </p><br></td><td><p> 反向代理限制端口访问和授权 </p><br><br><p> 当前未在电路中使用。 </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://nginx.org/en/download.html</a> </p><br></td><td><p>  <a href="">https://nginx.org/download/nginx-1.16.0.tar.gz</a> </p><br></td></tr><tr><td><p> 文件拍 </p><br></td><td><p> 传输文件日志。 </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://www.elastic.co/downloads/beats/filebeat</a> （适用于Windows 64位版本）。 </p><br></td><td><p>  <a href="">https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-7.3.0-windows-x86_64.zip</a> </p><br></td></tr><tr><td><p>  Logstash </p><br></td><td><p> 日志收集器。 </p><br><br><p> 用于从FileBeat收集日志，以及从RabbitMQ队列收集日志（对于DMZ中的服务器）。 </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://www.elastic.co/products/logstash</a> </p><br></td><td><p>  <a href="">https://artifacts.elastic.co/downloads/logstash/logstash-7.0.1.rpm</a> </p><br></td></tr><tr><td><p>  Logstash-输出-Clickhouse </p><br></td><td><p>  Loagstash插件，用于批量将日志传输到ClickHouse数据库 </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://github.com/mikechris/logstash-output-clickhouse</a> </p><br></td><td><p>  / usr / share / logstash / bin / logstash-plugin安装logstash-output-clickhouse </p><br><p>  / usr / share / logstash / bin / logstash-plugin安装logstash-filter-prune </p><br><p>  / usr / share / logstash / bin / logstash-plugin安装logstash-filter-multiline </p><br></td></tr><tr><td><p>  Clickhouse </p><br></td><td><p> 日志存储库<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://clickhouse.yandex/docs/ru/</a> </p><br></td><td><p>  <a href="">https://packagecloud.io/Altinity/clickhouse/packages/el/7/clickhouse-server-19.5.3.8-1.el7.x86_64.rpm</a> </p><br><p>  <a href="">https://packagecloud.io/Altinity/clickhouse/packages/el/7/clickhouse-client-19.5.3.8-1.el7.x86_64.rpm</a> </p><br><p> 注意事项 自2018年8月以来，用于RHEL的“常规” rpm程序集已出现在Yandex存储库中，因此您可以尝试使用它们。 在安装时，我们使用了Altinity编译的软件包。 </p><br></td></tr><tr><td><p> 格拉法纳 </p><br></td><td><p> 日志可视化。 配置仪表盘 </p><br><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://grafana.com/</a> </p><br></td><td><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://grafana.com/grafana/download</a> </p><br><br><p>  Redhat＆Centos（64位）-最新版本 </p><br></td></tr><tr><td><p> 适用于Grafana 4.6的ClickHouse数据源 </p><br></td><td><p> 具有ClickHouse数据源的Grafana插件 </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://grafana.com/plugins/vertamedia-clickhouse-datasource</a> </p><br></td><td><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://grafana.com/api/plugins/vertamedia-clickhouse-datasource/versions/1.8.1/下载</a> </p><br></td></tr><tr><td><p>  Logstash </p><br></td><td><p> 将路由器从FileBeat记录到RabbitMQ队列。 </p><br><p> 注意事项 不幸的是，FileBeat在RabbitMQ中没有直接输出，因此需要Logstash形式的中间链接 </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://www.elastic.co/products/logstash</a> </p><br></td><td><p>  <a href="">https://artifacts.elastic.co/downloads/logstash/logstash-7.0.1.rpm</a> </p><br></td></tr><tr><td><p>  Rabbitmq </p><br></td><td><p> 消息队列 这是DMZ中的日志条目缓冲区 </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://www.rabbitmq.com/download.html</a> </p><br></td><td><p>  <a href="">https://github.com/rabbitmq/rabbitmq-server/releases/download/v3.7.14/rabbitmq-server-3.7.14-1.el7.noarch.rpm</a> </p><br></td></tr><tr><td><p>  Erlang运行时（RabbitMQ必需） </p><br></td><td><p>  Erlang运行时。  RabbitMQ工作所需的 </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">http://www.erlang.org/download.html</a> </p><br></td><td><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://www.rabbitmq.com/install-rpm.html#install-erlang</a> <a href="">http://www.erlang.org/downloads/21.3</a> </p><br></td></tr></tbody></table></div><br></div></div><br> 下表中显示了ClickHouse数据库的服务器配置： <br><div class="scrollable-table"><table><tbody><tr><td>  <b>职称</b> <br></td><td>  <b>价值</b> <br></td><td>  <b>注意事项</b> <br></td></tr><tr><td><p> 构型 </p><br></td><td><p> 硬盘：40GB <br> 内存：8GB <br> 处理器：Core 2 2Ghz </p><br></td><td><p> 您需要注意有关操作ClickHouse数据库的提示（ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://clickhouse.yandex/docs/ru/operations/tips/</a> ） </p><br></td></tr><tr><td><p> 全系统软件 </p><br></td><td><p> 操作系统：Red Hat Enterprise Linux Server（Maipo） </p><br><p>  JRE（Java 8） </p><br></td><td><p></p><br></td></tr></tbody></table></div><br> 如您所见，这是一个常规工作站。 <br><br> 用于存储日志的表的结构如下： <br><br><div class="spoiler">  <b class="spoiler_title">log_web.sql</b> <div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> log_web ( logdate <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>, logdatetime DateTime CODEC(Delta, LZ4HC), fld_log_file_name LowCardinality( <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> ), fld_server_name LowCardinality( <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> ), fld_app_name LowCardinality( <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> ), fld_app_module LowCardinality( <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> ), fld_website_name LowCardinality( <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> ), serverIP LowCardinality( <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> ), method LowCardinality( <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> ), uriStem <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, uriQuery <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, port UInt32, username LowCardinality( <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> ), clientIP <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, clientRealIP <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, userAgent <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, referer <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, response <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, subresponse <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, win32response <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, timetaken UInt64 , uriQuery__utm_medium <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> , uriQuery__utm_source <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> , uriQuery__utm_campaign <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> , uriQuery__utm_term <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> , uriQuery__utm_content <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> , uriQuery__yclid <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> , uriQuery__region <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">Engine</span></span> = MergeTree() <span class="hljs-keyword"><span class="hljs-keyword">PARTITION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> toYYYYMM(logdate) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> (fld_app_name, fld_app_module, logdatetime) <span class="hljs-keyword"><span class="hljs-keyword">SETTINGS</span></span> index_granularity = <span class="hljs-number"><span class="hljs-number">8192</span></span>;</code> </pre> <br></div></div><br> 我们使用默认值进行分区（按月）和索引的粒度。 实际上，所有字段都与用于注册http请求的IIS日志条目相对应。 分别地，用于存储utm标记的单独字段（在从查询字符串字段插入表中的阶段对它们进行了解析）。 <br><br> 还在表中添加了几个系统字段，用于存储有关系统，组件，服务器的信息。 有关这些字段的说明，请参见下表。 在一个表中，我们存储多个系统的日志。 <br><br><div class="scrollable-table"><table><tbody><tr><td>  <b>职称</b> <br></td><td>  <b>内容描述</b> <br></td><td>  <b>例子</b> <br></td></tr><tr><td><p>  fld_app_name </p><br></td><td><p> 应用程序/系统名称 <br> 有效值： </p><br><ul><li>  site1.domain.com外部站点1 </li><li>  site2.domain.com外部站点2 </li><li>  internal-site1.domain.local内部站点1 </li></ul><br></td><td>  site1.domain.com <br></td></tr><tr><td><p>  fld_app_module </p><br></td><td><p> 系统模块 <br> 有效值： </p><br><ul><li> 网站-网站 </li><li>  svc-网站服务 </li><li>  intgr-Web集成服务 </li><li>  bo-管理员（后台） </li></ul><br></td><td><p> 网络 </p><br></td></tr><tr><td><p>  fld_website_name </p><br></td><td><p>  IIS中的网站名称 </p><br><p> 可以在一台服务器上部署多个系统，甚至可以在一个系统模块上部署多个实例。 </p><br></td><td><p> 网络主 </p><br></td></tr><tr><td><p>  fld_server_name </p><br></td><td><p> 服务器名称 </p><br></td><td><p>  web1.domain.com </p><br></td></tr><tr><td><p>  fld_log_file_name </p><br></td><td><p> 服务器上日志文件的路径 </p><br></td><td>  C：\ inetpub \日志\ LogFiles <br>  \ W3SVC1 \ u_ex190711.log <br></td></tr></tbody></table></div><br> 这使您可以在Grafana中有效地构建图形。 例如，查看来自特定系统前端的请求。 这类似于Yandex.Metrica中的站点计数器。 <br><br> 以下是有关使用数据库两个月的一些统计信息。 <br><br><div class="spoiler">  <b class="spoiler_title">按系统和组件划分的记录数</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> fld_app_name, fld_app_module, <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(fld_app_name) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> rows_count <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> log_web <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> fld_app_name, fld_app_module <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> TOTALS <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> fld_app_name <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span>, rows_count <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> ┌─fld_app_name─────┬─fld_app_module─┬─rows_count─┐ │ site1.domain.ru │ web │ <span class="hljs-number"><span class="hljs-number">131441</span></span> │ │ site2.domain.ru │ web │ <span class="hljs-number"><span class="hljs-number">1751081</span></span> │ │ site3.domain.ru │ web │ <span class="hljs-number"><span class="hljs-number">106887543</span></span> │ │ site3.domain.ru │ svc │ <span class="hljs-number"><span class="hljs-number">44908603</span></span> │ │ site3.domain.ru │ intgr │ <span class="hljs-number"><span class="hljs-number">9813911</span></span> │ │ site4.domain.ru │ web │ <span class="hljs-number"><span class="hljs-number">772095</span></span> │ │ site5.domain.ru │ web │ <span class="hljs-number"><span class="hljs-number">17037221</span></span> │ │ site5.domain.ru │ intgr │ <span class="hljs-number"><span class="hljs-number">838559</span></span> │ │ site5.domain.ru │ bo │ <span class="hljs-number"><span class="hljs-number">7404</span></span> │ │ site6.domain.ru │ web │ <span class="hljs-number"><span class="hljs-number">595877</span></span> │ │ site7.domain.ru │ web │ <span class="hljs-number"><span class="hljs-number">27778858</span></span> │ └──────────────────┴────────────────┴────────────┘ Totals: ┌─fld_app_name─┬─fld_app_module─┬─rows_count─┐ │ │ │ <span class="hljs-number"><span class="hljs-number">210522593</span></span> │ └──────────────┴────────────────┴────────────┘ <span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> set. Elapsed: <span class="hljs-number"><span class="hljs-number">4.874</span></span> sec. Processed <span class="hljs-number"><span class="hljs-number">210.52</span></span> million <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>, <span class="hljs-number"><span class="hljs-number">421.67</span></span> MB (<span class="hljs-number"><span class="hljs-number">43.19</span></span> million <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>/s., <span class="hljs-number"><span class="hljs-number">86.51</span></span> MB/s.)</code> </pre> <br></div></div><div class="spoiler">  <b class="spoiler_title">磁盘上的数据量</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> formatReadableSize(<span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(data_uncompressed_bytes)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> uncompressed, formatReadableSize(<span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(data_compressed_bytes)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> compressed, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> total_rows <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> system.parts <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> = <span class="hljs-string"><span class="hljs-string">'log_web'</span></span> ┌─uncompressed─┬─compressed─┬─total_rows─┐ │ <span class="hljs-number"><span class="hljs-number">54.50</span></span> GiB │ <span class="hljs-number"><span class="hljs-number">4.86</span></span> GiB │ <span class="hljs-number"><span class="hljs-number">211427094</span></span> │ └──────────────┴────────────┴────────────┘ <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> set. Elapsed: <span class="hljs-number"><span class="hljs-number">0.035</span></span> sec.</code> </pre> <br></div></div><div class="spoiler">  <b class="spoiler_title">列中的数据压缩程度</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, formatReadableSize(data_uncompressed_bytes) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> uncompressed, formatReadableSize(data_compressed_bytes) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> compressed, data_uncompressed_bytes / data_compressed_bytes <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> compress_ratio <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> system.columns <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> = <span class="hljs-string"><span class="hljs-string">'log_web'</span></span> ┌─<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>───────────────────┬─uncompressed─┬─compressed─┬─────compress_ratio─┐ │ logdate │ <span class="hljs-number"><span class="hljs-number">401.53</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">1.80</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">223.16665968777315</span></span> │ │ logdatetime │ <span class="hljs-number"><span class="hljs-number">803.06</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">35.91</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">22.363966401202305</span></span> │ │ fld_log_file_name │ <span class="hljs-number"><span class="hljs-number">220.66</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">2.60</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">84.99905736932571</span></span> │ │ fld_server_name │ <span class="hljs-number"><span class="hljs-number">201.54</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">50.63</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">3.980924816977078</span></span> │ │ fld_app_name │ <span class="hljs-number"><span class="hljs-number">201.17</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">969.17</span></span> KiB │ <span class="hljs-number"><span class="hljs-number">212.55518183686877</span></span> │ │ fld_app_module │ <span class="hljs-number"><span class="hljs-number">201.17</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">968.60</span></span> KiB │ <span class="hljs-number"><span class="hljs-number">212.67805817411906</span></span> │ │ fld_website_name │ <span class="hljs-number"><span class="hljs-number">201.54</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">1.24</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">162.7204926761546</span></span> │ │ serverIP │ <span class="hljs-number"><span class="hljs-number">201.54</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">50.25</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">4.010824061219731</span></span> │ │ method │ <span class="hljs-number"><span class="hljs-number">201.53</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">43.64</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">4.617721053304486</span></span> │ │ uriStem │ <span class="hljs-number"><span class="hljs-number">5.13</span></span> GiB │ <span class="hljs-number"><span class="hljs-number">832.51</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">6.311522291936919</span></span> │ │ uriQuery │ <span class="hljs-number"><span class="hljs-number">2.58</span></span> GiB │ <span class="hljs-number"><span class="hljs-number">501.06</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">5.269731450124478</span></span> │ │ port │ <span class="hljs-number"><span class="hljs-number">803.06</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">3.98</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">201.91673864241824</span></span> │ │ username │ <span class="hljs-number"><span class="hljs-number">318.08</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">26.93</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">11.812513794583598</span></span> │ │ clientIP │ <span class="hljs-number"><span class="hljs-number">2.35</span></span> GiB │ <span class="hljs-number"><span class="hljs-number">82.59</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">29.132328640073343</span></span> │ │ clientRealIP │ <span class="hljs-number"><span class="hljs-number">2.49</span></span> GiB │ <span class="hljs-number"><span class="hljs-number">465.05</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">5.478382297052563</span></span> │ │ userAgent │ <span class="hljs-number"><span class="hljs-number">18.34</span></span> GiB │ <span class="hljs-number"><span class="hljs-number">764.08</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">24.57905114484208</span></span> │ │ referer │ <span class="hljs-number"><span class="hljs-number">14.71</span></span> GiB │ <span class="hljs-number"><span class="hljs-number">1.37</span></span> GiB │ <span class="hljs-number"><span class="hljs-number">10.736792723669906</span></span> │ │ response │ <span class="hljs-number"><span class="hljs-number">803.06</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">83.81</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">9.582334090987247</span></span> │ │ subresponse │ <span class="hljs-number"><span class="hljs-number">399.87</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">1.83</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">218.4831068635027</span></span> │ │ win32response │ <span class="hljs-number"><span class="hljs-number">407.86</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">7.41</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">55.050315514606815</span></span> │ │ timetaken │ <span class="hljs-number"><span class="hljs-number">1.57</span></span> GiB │ <span class="hljs-number"><span class="hljs-number">402.06</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">3.9947395692010637</span></span> │ │ uriQuery__utm_medium │ <span class="hljs-number"><span class="hljs-number">208.17</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">12.29</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">16.936148912472955</span></span> │ │ uriQuery__utm_source │ <span class="hljs-number"><span class="hljs-number">215.18</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">13.00</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">16.548367623199912</span></span> │ │ uriQuery__utm_campaign │ <span class="hljs-number"><span class="hljs-number">381.46</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">37.94</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">10.055156353418509</span></span> │ │ uriQuery__utm_term │ <span class="hljs-number"><span class="hljs-number">231.82</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">10.78</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">21.502540454070672</span></span> │ │ uriQuery__utm_content │ <span class="hljs-number"><span class="hljs-number">441.34</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">87.60</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">5.038260760449327</span></span> │ │ uriQuery__yclid │ <span class="hljs-number"><span class="hljs-number">216.88</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">16.58</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">13.07721335008116</span></span> │ │ uriQuery__region │ <span class="hljs-number"><span class="hljs-number">204.35</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">9.49</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">21.52661903446796</span></span> │ └────────────────────────┴──────────────┴────────────┴────────────────────┘ <span class="hljs-number"><span class="hljs-number">28</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> set. Elapsed: <span class="hljs-number"><span class="hljs-number">0.005</span></span> sec.</code> </pre> <br></div></div><br><h4> 所用组件的描述 <br><br>  FileBeat。 文件日志传输 </h4><br> 该组件监视磁盘上日志文件中的更改，并将信息传输到LogStash。 它安装在写入日志文件的所有服务器上（通常是IIS）。 它以尾部模式工作（即，仅将添加的记录传输到文件中）。 但是您可以分别配置整个文件传输。 当您需要从前几个月下载数据时，这很有用。 只需将日志文件放在一个文件夹中，他就会完整地读取它。 <br><br> 当服务停止时，数据将停止进一步传输到存储。 <br><br> 配置示例如下： <br><br><div class="spoiler">  <b class="spoiler_title">filebeat.yml</b> <div class="spoiler_text"><pre> <code class="sql hljs">filebeat.inputs: - type: log enabled: true paths: - C:/inetpub/logs/LogFiles/W3SVC1<span class="hljs-comment"><span class="hljs-comment">/*.log exclude_files: ['.gz$','.zip$'] tail_files: true ignore_older: 24h fields: fld_server_name: "site1.domain.ru" fld_app_name: "site1.domain.ru" fld_app_module: "web" fld_website_name: "web-main" - type: log enabled: true paths: - C:/inetpub/logs/LogFiles/__Import/access_log-* exclude_files: ['.gz$','.zip$'] tail_files: false fields: fld_server_name: "site2.domain.ru" fld_app_name: "site2.domain.ru" fld_app_module: "web" fld_website_name: "web-main" fld_logformat: "logformat__apache" filebeat.config.modules: path: ${path.config}/modules.d/*.yml reload.enabled: false reload.period: 2s output.logstash: hosts: ["log.domain.com:5044"] ssl.enabled: true ssl.certificate_authorities: ["C:/filebeat/certs/ca.pem", "C:/filebeat/certs/ca-issuing.pem"] ssl.certificate: "C:/filebeat/certs/site1.domain.ru.cer" ssl.key: "C:/filebeat/certs/site1.domain.ru.key" #================================ Processors ===================================== processors: - add_host_metadata: ~ - add_cloud_metadata: ~</span></span></code> </pre> <br></div></div><br><h4>  LogStash 日志采集器 </h4><br> 该组件用于接收来自FileBeat的日志条目（或通过RabbitMQ队列），解析分发包并将其插入ClickHouse数据库。 <br><br> 要插入ClickHouse，请使用Logstash-output-clickhouse插件。  Logstash插件具有一种检索请求的机制，但是如果定期关闭，最好停止服务本身。 停止时，消息将累积在RabbitMQ队列中，因此，如果长时间停止，则最好在服务器上停止Filebeats。 在不使用RabbitMQ的方案中（在本地网络上，Filebeat将日志直接发送到Logstash），Filebeats的工作原理是可以接受且安全的，因此对于它们而言，输出不可访问性不会带来任何后果。 <br><br> 配置示例如下： <br><br><div class="spoiler">  <b class="spoiler_title">log_web__filebeat_clickhouse.conf</b> <div class="spoiler_text"><pre> <code class="sql hljs">input { beats { port =&gt; 5044 type =&gt; 'iis' ssl =&gt; true ssl_certificate_authorities =&gt; ["/etc/logstash/certs/ca.cer", "/etc/logstash/certs/ca-issuing.cer"] ssl_certificate =&gt; "/etc/logstash/certs/server.cer" ssl_key =&gt; "/etc/logstash/certs/server-pkcs8.key" ssl_verify_mode =&gt; "peer" add_field =&gt; { "fld_server_name" =&gt; "%{[fields][fld_server_name]}" "fld_app_name" =&gt; "%{[fields][fld_app_name]}" "fld_app_module" =&gt; "%{[fields][fld_app_module]}" "fld_website_name" =&gt; "%{[fields][fld_website_name]}" "fld_log_file_name" =&gt; "%{source}" "fld_logformat" =&gt; "%{[fields][fld_logformat]}" } } rabbitmq { host =&gt; "queue.domain.com" port =&gt; 5671 user =&gt; "q-reader" password =&gt; "password" queue =&gt; "web_log" heartbeat =&gt; 30 durable =&gt; true ssl =&gt; true <span class="hljs-comment"><span class="hljs-comment">#ssl_certificate_path =&gt; "/etc/logstash/certs/server.p12" #ssl_certificate_password =&gt; "password" add_field =&gt; { "fld_server_name" =&gt; "%{[fields][fld_server_name]}" "fld_app_name" =&gt; "%{[fields][fld_app_name]}" "fld_app_module" =&gt; "%{[fields][fld_app_module]}" "fld_website_name" =&gt; "%{[fields][fld_website_name]}" "fld_log_file_name" =&gt; "%{source}" "fld_logformat" =&gt; "%{[fields][fld_logformat]}" } } } filter { if [message] =~ "^#" { drop {} } if [fld_logformat] == "logformat__iis_with_xrealip" { grok { match =&gt; ["message", "%{TIMESTAMP_ISO8601:log_timestamp} %{IP:serverIP} %{WORD:method} %{NOTSPACE:uriStem} %{NOTSPACE:uriQuery} %{NUMBER:port} %{NOTSPACE:username} %{IPORHOST:clientIP} %{NOTSPACE:userAgent} %{NOTSPACE:referer} %{NUMBER:response} %{NUMBER:subresponse} %{NUMBER:win32response} %{NUMBER:timetaken} %{NOTSPACE:xrealIP} %{NOTSPACE:xforwarderfor}"] } } else { grok { match =&gt; ["message", "%{TIMESTAMP_ISO8601:log_timestamp} %{IP:serverIP} %{WORD:method} %{NOTSPACE:uriStem} %{NOTSPACE:uriQuery} %{NUMBER:port} %{NOTSPACE:username} %{IPORHOST:clientIP} %{NOTSPACE:userAgent} %{NOTSPACE:referer} %{NUMBER:response} %{NUMBER:subresponse} %{NUMBER:win32response} %{NUMBER:timetaken}"] } } date { match =&gt; [ "log_timestamp", "YYYY-MM-dd HH:mm:ss" ] timezone =&gt; "Etc/UTC" remove_field =&gt; [ "log_timestamp", "@timestamp" ] target =&gt; [ "log_timestamp2" ] } ruby { code =&gt; "tstamp = event.get('log_timestamp2').to_i event.set('logdatetime', Time.at(tstamp).strftime('%Y-%m-%d %H:%M:%S')) event.set('logdate', Time.at(tstamp).strftime('%Y-%m-%d'))" } if [bytesSent] { ruby { code =&gt; "event['kilobytesSent'] = event['bytesSent'].to_i / 1024.0" } } if [bytesReceived] { ruby { code =&gt; "event['kilobytesReceived'] = event['bytesReceived'].to_i / 1024.0" } } ruby { code =&gt; "event.set('clientRealIP', event.get('clientIP'))" } if [xrealIP] { ruby { code =&gt; "event.set('clientRealIP', event.get('xrealIP'))" } } if [xforwarderfor] { ruby { code =&gt; "event.set('clientRealIP', event.get('xforwarderfor'))" } } mutate { convert =&gt; ["bytesSent", "integer"] convert =&gt; ["bytesReceived", "integer"] convert =&gt; ["timetaken", "integer"] convert =&gt; ["port", "integer"] add_field =&gt; { "clientHostname" =&gt; "%{clientIP}" } } useragent { source=&gt; "useragent" prefix=&gt; "browser" } kv { source =&gt; "uriQuery" prefix =&gt; "uriQuery__" allow_duplicate_values =&gt; false field_split =&gt; "&amp;" include_keys =&gt; [ "utm_medium", "utm_source", "utm_campaign", "utm_term", "utm_content", "yclid", "region" ] } mutate { join =&gt; { "uriQuery__utm_source" =&gt; "," } join =&gt; { "uriQuery__utm_medium" =&gt; "," } join =&gt; { "uriQuery__utm_campaign" =&gt; "," } join =&gt; { "uriQuery__utm_term" =&gt; "," } join =&gt; { "uriQuery__utm_content" =&gt; "," } join =&gt; { "uriQuery__yclid" =&gt; "," } join =&gt; { "uriQuery__region" =&gt; "," } } } output { #stdout {codec =&gt; rubydebug} clickhouse { headers =&gt; ["Authorization", "Basic abcdsfks..."] http_hosts =&gt; ["http://127.0.0.1:8123"] save_dir =&gt; "/etc/logstash/tmp" table =&gt; "log_web" request_tolerance =&gt; 1 flush_size =&gt; 10000 idle_flush_time =&gt; 1 mutations =&gt; { "fld_log_file_name" =&gt; "fld_log_file_name" "fld_server_name" =&gt; "fld_server_name" "fld_app_name" =&gt; "fld_app_name" "fld_app_module" =&gt; "fld_app_module" "fld_website_name" =&gt; "fld_website_name" "logdatetime" =&gt; "logdatetime" "logdate" =&gt; "logdate" "serverIP" =&gt; "serverIP" "method" =&gt; "method" "uriStem" =&gt; "uriStem" "uriQuery" =&gt; "uriQuery" "port" =&gt; "port" "username" =&gt; "username" "clientIP" =&gt; "clientIP" "clientRealIP" =&gt; "clientRealIP" "userAgent" =&gt; "userAgent" "referer" =&gt; "referer" "response" =&gt; "response" "subresponse" =&gt; "subresponse" "win32response" =&gt; "win32response" "timetaken" =&gt; "timetaken" "uriQuery__utm_medium" =&gt; "uriQuery__utm_medium" "uriQuery__utm_source" =&gt; "uriQuery__utm_source" "uriQuery__utm_campaign" =&gt; "uriQuery__utm_campaign" "uriQuery__utm_term" =&gt; "uriQuery__utm_term" "uriQuery__utm_content" =&gt; "uriQuery__utm_content" "uriQuery__yclid" =&gt; "uriQuery__yclid" "uriQuery__region" =&gt; "uriQuery__region" } } }</span></span></code> </pre> <br></div></div><div class="spoiler">  <b class="spoiler_title">pipelines.yml</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment"># This file is where you define your pipelines. You can define multiple. # For more information on multiple pipelines, see the documentation: # https://www.elastic.co/guide/en/logstash/current/multiple-pipelines.html - pipeline.id: log_web__filebeat_clickhouse path.config: "/etc/logstash/log_web__filebeat_clickhouse.conf"</span></span></code> </pre> <br></div></div><br><h4>  ClickHouse。 日志储存 </h4><br> 所有系统的日志都保存在一个表中（请参阅本文的开头）。 它用于存储有关请求的信息：所有参数对于不同的格式都是相似的，例如IIS日志，apache和nginx日志。 对于其中记录了例如错误，信息性消息，警告的应用程序日志，将提供具有相应结构的单独表（现在处于设计阶段）。 <br><br> 设计表时，确定主键（在存储期间对数据进行排序）非常重要。 数据压缩的程度和查询速度取决于此。 在我们的示例中，关键是 <br>  ORDER BY（fld_app_name，fld_app_module，logdatetime） <br> 即，通过系统名称，系统组件名称和事件日期。 活动的原始日期排在第一位。 将其移到最后一个位置后，查询开始以大约两倍的速度运行。 更改主键将需要重新创建表并重新加载数据，以便ClickHouse对磁盘上的数据进行重新排序。 这是一项困难的操作，因此建议您提前考虑排序关键字中应包含的内容。 <br><br> 还应注意，相对较新的版本出现了LowCardinality数据类型。 使用它时，对于基数较低的字段（很少的选项），压缩数据的大小会急剧减小。 <br><br> 现在使用版本19.6，我们计划尝试将版本更新为最新版本。 例如，它们包括诸如自适应粒度，跳过索引和DoubleDelta编解码器等出色的功能。 <br><br> 默认情况下，在安装过程中，配置日志级别设置为trace。 日志被轮换和存档，但扩展到1 GB。 如果不需要，则可以设置警告级别，然后日志的大小会急剧减少。 日志设置在config.xml文件中设置： <br><br><pre> <code class="xml hljs"><span class="hljs-comment"><span class="hljs-comment">&lt;!-- Possible levels: https://github.com/pocoproject/poco/blob/develop/Foundation/include/Poco/Logger. h#L105 --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">level</span></span></span><span class="hljs-tag">&gt;</span></span>warning<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">level</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">一些有用的命令</b> <div class="spoiler_text"><pre> <code class="sql hljs">      Debian,     Linux      Altinity.           : https://www.altinity.com/blog/2017/12/18/logstash-<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-clickhouse sudo yum <span class="hljs-keyword"><span class="hljs-keyword">search</span></span> clickhouse-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> sudo yum <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> clickhouse-server.noarch <span class="hljs-number"><span class="hljs-number">1.</span></span>   sudo systemctl <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> clickhouse-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-number"><span class="hljs-number">2.</span></span>   sudo systemctl <span class="hljs-keyword"><span class="hljs-keyword">stop</span></span> clickhouse-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-number"><span class="hljs-number">3.</span></span>   sudo systemctl <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> clickhouse-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span>        (   <span class="hljs-string"><span class="hljs-string">";"</span></span>) clickhouse-<span class="hljs-keyword"><span class="hljs-keyword">client</span></span> <span class="hljs-comment"><span class="hljs-comment">--multiline clickhouse-client --multiline --host 127.0.0.1 --password pa55w0rd clickhouse-client --multiline --host 127.0.0.1 --port 9440 --secure --user default --password pa55w0rd                /tmp/log_web_failed.json            : clickhouse-client --host 127.0.0.1 --password password --query="INSERT INTO log_web FORMAT JSONEachRow" &lt; /tmp/log_web_failed__fixed.json sudo mv /etc/logstash/tmp/log_web_failed.json /etc/logstash/tmp/log_web_failed__fixed.json sudo chown user_dev /etc/logstash/tmp/log_web_failed__fixed.json sudo clickhouse-client --host 127.0.0.1 --password password --query="INSERT INTO log_web FORMAT JSONEachRow" &lt; /etc/logstash/tmp/log_web_failed__fixed.json sudo mv /etc/logstash/tmp/log_web_failed__fixed.json /etc/logstash/tmp/log_web_failed__fixed_.json     quit; ##  TLS https://www.altinity.com/blog/2019/3/5/clickhouse-networking-part-2 openssl s_client -connect log.domain.com:9440 &lt; /dev/null</span></span></code> </pre> <br></div></div><br><h4>  LogStash  FileBeat日志路由器到RabbitMQ队列 </h4><br> 该组件用于将来自FileBeat的日志路由到RabbitMQ队列。 有两点： <br><br><ol><li> 不幸的是，FileBeat没有用于直接写入RabbitMQ的输出插件。 根据ish在其github上的判断，此类功能尚未计划实现。 有一个Kafka插件，但由于某些原因，我们不能在家中使用它。 </li><li> 有在DMZ中收集日志的要求。 基于它们，必须首先将日志添加到队列中，然后从外部使用LogStash从队列中读取条目。 </li></ol><br> 因此，正是针对DMZ中服务器位置的情况，您必须使用这种稍微复杂的方案。 配置示例如下： <br><br><div class="spoiler">  <b class="spoiler_title">iis_w3c_logs__filebeat_rabbitmq.conf</b> <div class="spoiler_text"><pre> <code class="sql hljs">input { beats { port =&gt; 5044 type =&gt; 'iis' ssl =&gt; true ssl_certificate_authorities =&gt; ["/etc/pki/tls/certs/app/ca.pem", "/etc/pki/tls/certs/app/ca-issuing.pem"] ssl_certificate =&gt; "/etc/pki/tls/certs/app/queue.domain.com.cer" ssl_key =&gt; "/etc/pki/tls/certs/app/queue.domain.com-pkcs8.key" ssl_verify_mode =&gt; "peer" } } output { <span class="hljs-comment"><span class="hljs-comment">#stdout {codec =&gt; rubydebug} rabbitmq { host =&gt; "127.0.0.1" port =&gt; 5672 exchange =&gt; "monitor.direct" exchange_type =&gt; "direct" key =&gt; "%{[fields][fld_app_name]}" user =&gt; "q-writer" password =&gt; "password" ssl =&gt; false } }</span></span></code> </pre> <br></div></div><br><h4>  RabbitMQ。 消息队列 </h4><br> 此组件用于在DMZ中缓冲日志条目。 通过一堆Filebeat→LogStash进行记录。 通过LogStash从DMZ外部进行读取。 通过RabboitMQ运行时，每秒大约处理4000条消息。 <br><br> 根据系统名称配置消息路由，即基于FileBeat配置数据。 所有消息都属于一个队列。 如果出于某种原因停止了队列服务，则不会导致消息丢失：FileBeats将收到连接错误并暂停临时发送。 从队列中读取的LogStash也将收到网络错误，并等待连接恢复。 当然，在这种情况下，数据将不再写入数据库。 <br><br> 以下说明用于创建和配置队列： <br><br><pre> <code class="sql hljs">sudo /usr/local/bin/rabbitmqadmin/rabbitmqadmin <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exchange</span></span> <span class="hljs-comment"><span class="hljs-comment">--vhost=/ name=monitor.direct type=direct sudo /usr/local/bin/rabbitmqadmin/rabbitmqadmin declare queue --vhost=/ name=web_log durable=true sudo /usr/local/bin/rabbitmqadmin/rabbitmqadmin --vhost="/" declare binding source="monitor.direct" destination_type="queue" destination="web_log" routing_key="site1.domain.ru" sudo /usr/local/bin/rabbitmqadmin/rabbitmqadmin --vhost="/" declare binding source="monitor.direct" destination_type="queue" destination="web_log" routing_key="site2.domain.ru"</span></span></code> </pre> <br><h4> 格拉法纳 仪表板 </h4><br> 该组件用于可视化监视数据。 在这种情况下，您必须安装用于Grafana 4.6+插件的ClickHouse数据源。 我们必须对其进行一些调整，以提高在仪表板上处理SQL过滤器的效率。 <br><br> 例如，我们使用变量，并且如果未在过滤器字段中设置变量，我们希望它不生成WHERE形式的条件（uriStem =``AND uriStem！=''）。 在这种情况下，ClickHouse将读取uriStem列。 通常，我们尝试了不同的选项，最后修复了插件（宏$ valueIfEmpty），以便在值为空的情况下返回1，而无需提及列本身。 <br><br> 现在您可以将此查询用于图表 <br><br><pre> <code class="sql hljs">$columns(response, count(*) c) from $table where $adhoc and $valueIfEmpty($fld_app_name, 1, fld_app_name = '$fld_app_name') and $valueIfEmpty($fld_app_module, 1, fld_app_module = '$fld_app_module') and $valueIfEmpty($fld_server_name, 1, fld_server_name = '$fld_server_name') and $valueIfEmpty($uriStem, 1, uriStem like '%$uriStem%') and $valueIfEmpty($clientRealIP, 1, clientRealIP = '$clientRealIP')</code> </pre> <br> 将其转换为此类SQL（请注意，空uriStem字段仅转换为1） <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t, groupArray((response, c)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> groupArr <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> (intDiv(toUInt32(logdatetime), <span class="hljs-number"><span class="hljs-number">60</span></span>) * <span class="hljs-number"><span class="hljs-number">60</span></span>) * <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t, response, <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> default.log_web <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> (logdate &gt;= toDate(<span class="hljs-number"><span class="hljs-number">1565061982</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (logdatetime &gt;= toDateTime(<span class="hljs-number"><span class="hljs-number">1565061982</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (fld_app_name = <span class="hljs-string"><span class="hljs-string">'site1.domain.ru'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (fld_app_module = <span class="hljs-string"><span class="hljs-string">'web'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> t, response <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> t <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span>, response <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> t <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> t <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span></code> </pre> <br><h4> 结论 </h4><br>  ClickHouse数据库的出现已成为市场中的标志性事件。 很难想象一下，我们免费获得了一个强大而实用的工具来处理大数据。 当然，随着需求的增加（例如，分片和复制到多个服务器），该方案将变得更加复杂。 但是乍一看，使用该数据库非常好。 可以看出，该产品是为“人们”制作的。 <br><br> 与初步估计相比，与ElasticSearch相比，存储和处理日志的成本降低了五倍至十倍。 换句话说，如果对于当前数据量，我们必须配置一个由多台计算机组成的集群，那么在使用ClickHouse时，我们仅需要一台低功耗计算机。 是的，当然，ElasticSearch还具有用于压缩磁盘上数据的机制以及其他可以显着减少资源消耗的功能，但是与ClickHouse相比，这将是昂贵的。 <br><br> 在没有任何特殊优化的情况下，在默认设置下，加载数据和从数据库检索数据的速度非常快。 到目前为止，我们只有少量数据（大约2亿条记录），但是服务器本身很薄弱。 将来，我们可以将此工具用于与日志存储无关的其他目的。 例如，对于端到端分析，在安全领域，机器学习。 <br><br> 最后，介绍了一些利弊。 <br><br><h4> 缺点 </h4><br><ol><li> 大捆下载记录。 一方面，这是一项功能，但仍然必须使用其他组件来缓冲记录。 这个任务并不总是那么简单，但是仍然可以解决。 我想简化这个计划。 </li><li> 一些奇特的功能或新功能通常会在新版本中中断。 这引起了人们的关注，减少了升级到新版本的愿望。 例如，Kafka表引擎是一项非常有用的功能，可让您直接从Kafka读取事件，而无需使用使用者。 但是从github上的Issues数量来看，我们仍然对在生产中使用此引擎持谨慎态度。 但是，如果您不向侧面剧烈移动并使用基本功能，则它会稳定运行。 </li></ol><br><h4> 优点 </h4><br><ol><li> 它不会减慢速度。 </li><li> 低进入门槛。 </li><li> 开源的 </li><li> 它是免费的。 </li><li> 很好地扩展（现成的分片/复制） </li><li> 它已包含在通信部推荐的俄​​文软件注册簿中。 </li><li>  Yandex提供官方支持。 </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN472912/">https://habr.com/ru/post/zh-CN472912/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN472896/index.html">打印机制造的直升机：科学家首次“印刷”了大型直升机发动机箱</a></li>
<li><a href="../zh-CN472902/index.html">Windows for IoT：增强的硬件支持和新的智能设备功能</a></li>
<li><a href="../zh-CN472904/index.html">亚马逊如何将股票变成游戏</a></li>
<li><a href="../zh-CN472908/index.html">达加兹：情节（第2部分）</a></li>
<li><a href="../zh-CN472910/index.html">使用智能手机查找标牌和包裹上的文字</a></li>
<li><a href="../zh-CN472916/index.html">后端，机器学习和无服务器是7月Habr会议上最有趣的部分</a></li>
<li><a href="../zh-CN472918/index.html">俄罗斯和独联体国家的ZX Spectrum：如何追求在线转化离线</a></li>
<li><a href="../zh-CN472922/index.html">防御者程序员胜于熵</a></li>
<li><a href="../zh-CN472926/index.html">加速收益定律（第1部分）</a></li>
<li><a href="../zh-CN472930/index.html">硅谷天体物理学家量化时尚</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>