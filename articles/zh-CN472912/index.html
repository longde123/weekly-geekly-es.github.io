<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘¨ğŸ¿â€ğŸš€ â“ ğŸ¤°ğŸ½ ç”¨äºäººç±»çš„ClickHouseæ•°æ®åº“æˆ–Alien Technology ğŸš· ğŸ‘¨ğŸ½â€ğŸ”¬ ğŸ‘¨ğŸ»â€ğŸ”¬</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ICDä¿¡æ¯æŠ€æœ¯å±€è¿œç¨‹æœåŠ¡é€šé“èƒ½åŠ›ä¸­å¿ƒè´Ÿè´£äººAlexey Lizunov 



 ä½œä¸ºELKå †æ ˆï¼ˆElasticSearchï¼ŒLogstashï¼ŒKibanaï¼‰çš„æ›¿ä»£æ–¹æ³•ï¼Œæˆ‘ä»¬æ­£åœ¨ç ”ç©¶å°†ClickHouseæ•°æ®åº“ç”¨ä½œæ—¥å¿—çš„æ•°æ®ä»“åº“ã€‚ 

 åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬æƒ³è°ˆè°ˆä½¿ç”¨ClickHouseæ•°æ®åº“çš„ç»éªŒä»¥åŠè¯•...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ç”¨äºäººç±»çš„ClickHouseæ•°æ®åº“æˆ–Alien Technology</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mkb/blog/472912/">  <b>ICDä¿¡æ¯æŠ€æœ¯å±€è¿œç¨‹æœåŠ¡é€šé“èƒ½åŠ›ä¸­å¿ƒè´Ÿè´£äººAlexey Lizunov</b> <br><br><img src="https://habrastorage.org/webt/bs/gu/k0/bsguk03an99lspkpmtkoks2bkvg.png"><br><br> ä½œä¸ºELKå †æ ˆï¼ˆElasticSearchï¼ŒLogstashï¼ŒKibanaï¼‰çš„æ›¿ä»£æ–¹æ³•ï¼Œæˆ‘ä»¬æ­£åœ¨ç ”ç©¶å°†ClickHouseæ•°æ®åº“ç”¨ä½œæ—¥å¿—çš„æ•°æ®ä»“åº“ã€‚ <br><br> åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬æƒ³è°ˆè°ˆä½¿ç”¨ClickHouseæ•°æ®åº“çš„ç»éªŒä»¥åŠè¯•éªŒæ“ä½œçš„åˆæ­¥ç»“æœã€‚ åº”å½“ç«‹å³æŒ‡å‡ºï¼Œç»“æœä»¤äººå°è±¡æ·±åˆ»ã€‚ <br><br><a name="habracut"></a><br><img src="https://habrastorage.org/webt/uy/mc/ip/uymcipeis_jm2piqsaqdjmu9_l8.jpeg"><br><br> æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†æ›´è¯¦ç»†åœ°æè¿°ç³»ç»Ÿçš„é…ç½®æ–¹å¼åŠå…¶ç»„æˆéƒ¨åˆ†ã€‚ ä½†æ˜¯ï¼Œç°åœ¨æˆ‘æƒ³è°ˆè°ˆæ•´ä¸ªæ•°æ®åº“ï¼Œä»¥åŠä¸ºä»€ä¹ˆè¦æ³¨æ„å®ƒã€‚  ClickHouseæ•°æ®åº“æ˜¯Yandexçš„é«˜æ€§èƒ½åˆ†ææŸ±æ•°æ®åº“ã€‚ å®ƒç”¨äºYandexæœåŠ¡ï¼Œæœ€åˆæ˜¯Yandex.Metricaçš„ä¸»è¦æ•°æ®ä»“åº“ã€‚ å¼€æºç³»ç»Ÿæ˜¯å…è´¹çš„ã€‚ ä»å¼€å‘äººå‘˜çš„è§’åº¦æ¥çœ‹ï¼Œæˆ‘ä¸€ç›´å¯¹ä»–ä»¬çš„å®ç°æ–¹å¼å¾ˆæ„Ÿå…´è¶£ï¼Œå› ä¸ºé‚£é‡Œæœ‰å¤§é‡çš„å¤§æ•°æ®ã€‚ åº¦é‡ç”¨æˆ·ç•Œé¢æœ¬èº«éå¸¸çµæ´»ä¸”å¿«é€Ÿã€‚ åˆè¯†è¯¥æ•°æ®åº“æ—¶ï¼Œå°è±¡æ˜¯ï¼šâ€œå¥½ï¼Œæœ€åï¼ å‘â€œä¸ºäººâ€ï¼ ä»å®‰è£…è¿‡ç¨‹å¼€å§‹ï¼Œä»¥å‘é€è¯·æ±‚ç»“æŸã€‚â€ <br><br> è¯¥æ•°æ®åº“çš„è¿›å…¥é˜ˆå€¼éå¸¸ä½ã€‚ å³ä½¿æ˜¯æ™®é€šçš„å¼€å‘äººå‘˜ä¹Ÿå¯ä»¥åœ¨å‡ åˆ†é’Ÿå†…å®‰è£…è¯¥æ•°æ®åº“å¹¶å¼€å§‹ä½¿ç”¨å®ƒã€‚ ä¸€åˆ‡æ­£å¸¸ã€‚ å³ä½¿æ˜¯Linuxæ–°æ‰‹ï¼Œä¹Ÿå¯ä»¥å¿«é€Ÿå®Œæˆå®‰è£…å¹¶è¿›è¡Œç®€å•çš„æ“ä½œã€‚ æ—©å…ˆï¼Œå½“å¤§æ•°æ®ï¼ŒHadoopï¼ŒGoogle BigTableï¼ŒHDFSä¸€è¯å‡ºç°æ—¶ï¼Œé€šå¸¸çš„å¼€å‘äººå‘˜å°±æƒ³åˆ°äº†ä»–ä»¬è°ˆè®ºçš„æ˜¯æ•°TBï¼ŒPBçš„é—®é¢˜ï¼Œä¸€äº›è¶…äººå‚ä¸äº†è¿™äº›ç³»ç»Ÿçš„è®¾ç½®å’Œå¼€å‘ï¼Œç„¶åéšç€ClickHouseæ•°æ®åº“çš„å‡ºç°ï¼Œæˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ªç®€å•æ˜“æ‡‚çš„å·¥å…·ï¼Œå¯ç”¨æ¥è§£å†³ä»¥å‰æ— æ³•å®Œæˆçš„ä¸€ç³»åˆ—ä»»åŠ¡ã€‚ åªéœ€ä¸€è¾†ç›¸å½“æ™®é€šçš„æ±½è½¦ï¼Œäº”åˆ†é’Ÿå³å¯å®‰è£…ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªæ•°æ®åº“ï¼Œä¾‹å¦‚MySqlï¼Œä½†ä»…ç”¨äºå­˜å‚¨æ•°åäº¿æ¡è®°å½•ï¼ æŸç§SQLä¸»ç®¡ã€‚ å¥½åƒäººä»¬å¾—åˆ°äº†å¤–å›½äººçš„æ­¦å™¨ã€‚ <br><br><h4> å…³äºæˆ‘ä»¬çš„æ—¥å¿—æ”¶é›†ç³»ç»Ÿ </h4><br> ä¸ºäº†æ”¶é›†ä¿¡æ¯ï¼Œä½¿ç”¨äº†æ ‡å‡†æ ¼å¼çš„Webåº”ç”¨ç¨‹åºçš„IISæ—¥å¿—æ–‡ä»¶ï¼ˆæˆ‘ä»¬ä¹Ÿä»äº‹è§£æåº”ç”¨ç¨‹åºæ—¥å¿—çš„å·¥ä½œï¼Œä½†æ˜¯ä¸æˆ‘ä»¬ä¸€èµ·è¿›è¡Œè¯•è¿è¡Œé˜¶æ®µçš„ä¸»è¦ç›®æ ‡æ˜¯æ”¶é›†IISæ—¥å¿—ï¼‰ã€‚ <br><br> ç”±äºå„ç§åŸå› ï¼Œæˆ‘ä»¬æœªèƒ½å®Œå…¨æ”¾å¼ƒELKå †æ ˆï¼Œè€Œæˆ‘ä»¬ç»§ç»­ä½¿ç”¨LogStashå’ŒFilebeatç»„ä»¶ï¼Œå®ƒä»¬å·²è¢«è¯æ˜è‡ªå·±æ€§èƒ½è‰¯å¥½ï¼Œå¹¶ä¸”è¿è¡Œååˆ†å¯é ä¸”å¯é¢„æµ‹ã€‚ <br><br> ä¸‹å›¾æ˜¾ç¤ºäº†å¸¸è§„çš„æ—¥å¿—è®°å½•æ–¹æ¡ˆï¼š <br><br><img src="https://habrastorage.org/webt/ah/kr/qg/ahkrqgjij-tfce_455jhjikjfg8.jpeg"><br><br> å°†æ•°æ®å†™å…¥ClickHouseæ•°æ®åº“çš„åŠŸèƒ½æ˜¯ä¸å¤§æ‰¹é‡ï¼ˆæ¯ç§’ä¸€æ¬¡ï¼‰æ’å…¥è®°å½•ã€‚ æ˜¾ç„¶ï¼Œè¿™æ˜¯æ‚¨ç¬¬ä¸€æ¬¡ä½¿ç”¨ClickHouseæ•°æ®åº“æ—¶é‡åˆ°çš„æœ€â€œæœ‰é—®é¢˜â€çš„éƒ¨åˆ†ï¼šè¯¥æ–¹æ¡ˆæœ‰ç‚¹å¤æ‚ã€‚ <br>  LogStashæ’ä»¶åœ¨è¿™é‡Œèµ·åˆ°äº†å¾ˆå¤§ä½œç”¨ï¼Œå¯ä»¥ç›´æ¥å°†æ•°æ®æ’å…¥ClickHouseã€‚ è¯¥ç»„ä»¶ä¸æ•°æ®åº“æœ¬èº«éƒ¨ç½²åœ¨åŒä¸€æœåŠ¡å™¨ä¸Šã€‚ å› æ­¤ï¼Œä¸€èˆ¬æ¥è®²ï¼Œä¸å»ºè®®è¿™æ ·åšï¼Œè€Œæ˜¯ä»å®é™…è§’åº¦å‡ºå‘ï¼Œä»¥å…åœ¨å°†åŒä¸€æœåŠ¡å™¨ä¸Šéƒ¨ç½²æœåŠ¡å™¨æ—¶ä¸äº§ç”Ÿå•ç‹¬çš„æœåŠ¡å™¨ã€‚ æˆ‘ä»¬æ²¡æœ‰å‘ç°ä¸æ•°æ®åº“æœ‰ä»»ä½•æ•…éšœæˆ–èµ„æºå†²çªã€‚ æ­¤å¤–ï¼Œåº”æ³¨æ„çš„æ˜¯ï¼Œæ’ä»¶åœ¨å‘ç”Ÿé”™è¯¯çš„æƒ…å†µä¸‹å…·æœ‰é‡æ–°å¯åŠ¨æœºåˆ¶ã€‚ å¹¶ä¸”åœ¨å‡ºç°é”™è¯¯çš„æƒ…å†µä¸‹ï¼Œè¯¥æ’ä»¶å°†æ— æ³•æ’å…¥çš„æ•°æ®åŒ…å†™å…¥ç£ç›˜ï¼ˆæ–‡ä»¶æ ¼å¼å¾ˆæ–¹ä¾¿ï¼šç¼–è¾‘åï¼Œæ‚¨å¯ä»¥ä½¿ç”¨clickhouse-clientè½»æ¾æ’å…¥å·²æ›´æ­£çš„æ•°æ®åŒ…ï¼‰ã€‚ <br><br> ä¸‹è¡¨åˆ—å‡ºäº†è¯¥æ–¹æ¡ˆä¸­ä½¿ç”¨çš„è½¯ä»¶çš„å®Œæ•´åˆ—è¡¨ï¼š <br><br><div class="spoiler">  <b class="spoiler_title">ä½¿ç”¨è½¯ä»¶åˆ—è¡¨</b> <div class="spoiler_text"><div class="scrollable-table"><table><tbody><tr><td>  <b>èŒç§°</b> <br></td><td>  <b>å†…å®¹æè¿°</b> <br></td><td>  <b>å‘è¡Œé“¾æ¥</b> <br></td></tr><tr><td><p>  Nginxçš„ </p><br></td><td><p> åå‘ä»£ç†é™åˆ¶ç«¯å£è®¿é—®å’Œæˆæƒ </p><br><br><p> å½“å‰æœªåœ¨ç”µè·¯ä¸­ä½¿ç”¨ã€‚ </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://nginx.org/en/download.html</a> </p><br></td><td><p>  <a href="">https://nginx.org/download/nginx-1.16.0.tar.gz</a> </p><br></td></tr><tr><td><p> æ–‡ä»¶æ‹ </p><br></td><td><p> ä¼ è¾“æ–‡ä»¶æ—¥å¿—ã€‚ </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://www.elastic.co/downloads/beats/filebeat</a> ï¼ˆé€‚ç”¨äºWindows 64ä½ç‰ˆæœ¬ï¼‰ã€‚ </p><br></td><td><p>  <a href="">https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-7.3.0-windows-x86_64.zip</a> </p><br></td></tr><tr><td><p>  Logstash </p><br></td><td><p> æ—¥å¿—æ”¶é›†å™¨ã€‚ </p><br><br><p> ç”¨äºä»FileBeatæ”¶é›†æ—¥å¿—ï¼Œä»¥åŠä»RabbitMQé˜Ÿåˆ—æ”¶é›†æ—¥å¿—ï¼ˆå¯¹äºDMZä¸­çš„æœåŠ¡å™¨ï¼‰ã€‚ </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://www.elastic.co/products/logstash</a> </p><br></td><td><p>  <a href="">https://artifacts.elastic.co/downloads/logstash/logstash-7.0.1.rpm</a> </p><br></td></tr><tr><td><p>  Logstash-è¾“å‡º-Clickhouse </p><br></td><td><p>  Loagstashæ’ä»¶ï¼Œç”¨äºæ‰¹é‡å°†æ—¥å¿—ä¼ è¾“åˆ°ClickHouseæ•°æ®åº“ </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://github.com/mikechris/logstash-output-clickhouse</a> </p><br></td><td><p>  / usr / share / logstash / bin / logstash-pluginå®‰è£…logstash-output-clickhouse </p><br><p>  / usr / share / logstash / bin / logstash-pluginå®‰è£…logstash-filter-prune </p><br><p>  / usr / share / logstash / bin / logstash-pluginå®‰è£…logstash-filter-multiline </p><br></td></tr><tr><td><p>  Clickhouse </p><br></td><td><p> æ—¥å¿—å­˜å‚¨åº“<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://clickhouse.yandex/docs/ru/</a> </p><br></td><td><p>  <a href="">https://packagecloud.io/Altinity/clickhouse/packages/el/7/clickhouse-server-19.5.3.8-1.el7.x86_64.rpm</a> </p><br><p>  <a href="">https://packagecloud.io/Altinity/clickhouse/packages/el/7/clickhouse-client-19.5.3.8-1.el7.x86_64.rpm</a> </p><br><p> æ³¨æ„äº‹é¡¹ è‡ª2018å¹´8æœˆä»¥æ¥ï¼Œç”¨äºRHELçš„â€œå¸¸è§„â€ rpmç¨‹åºé›†å·²å‡ºç°åœ¨Yandexå­˜å‚¨åº“ä¸­ï¼Œå› æ­¤æ‚¨å¯ä»¥å°è¯•ä½¿ç”¨å®ƒä»¬ã€‚ åœ¨å®‰è£…æ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†Altinityç¼–è¯‘çš„è½¯ä»¶åŒ…ã€‚ </p><br></td></tr><tr><td><p> æ ¼æ‹‰æ³•çº³ </p><br></td><td><p> æ—¥å¿—å¯è§†åŒ–ã€‚ é…ç½®ä»ªè¡¨ç›˜ </p><br><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://grafana.com/</a> </p><br></td><td><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://grafana.com/grafana/download</a> </p><br><br><p>  Redhatï¼†Centosï¼ˆ64ä½ï¼‰-æœ€æ–°ç‰ˆæœ¬ </p><br></td></tr><tr><td><p> é€‚ç”¨äºGrafana 4.6çš„ClickHouseæ•°æ®æº </p><br></td><td><p> å…·æœ‰ClickHouseæ•°æ®æºçš„Grafanaæ’ä»¶ </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://grafana.com/plugins/vertamedia-clickhouse-datasource</a> </p><br></td><td><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://grafana.com/api/plugins/vertamedia-clickhouse-datasource/versions/1.8.1/ä¸‹è½½</a> </p><br></td></tr><tr><td><p>  Logstash </p><br></td><td><p> å°†è·¯ç”±å™¨ä»FileBeatè®°å½•åˆ°RabbitMQé˜Ÿåˆ—ã€‚ </p><br><p> æ³¨æ„äº‹é¡¹ ä¸å¹¸çš„æ˜¯ï¼ŒFileBeatåœ¨RabbitMQä¸­æ²¡æœ‰ç›´æ¥è¾“å‡ºï¼Œå› æ­¤éœ€è¦Logstashå½¢å¼çš„ä¸­é—´é“¾æ¥ </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://www.elastic.co/products/logstash</a> </p><br></td><td><p>  <a href="">https://artifacts.elastic.co/downloads/logstash/logstash-7.0.1.rpm</a> </p><br></td></tr><tr><td><p>  Rabbitmq </p><br></td><td><p> æ¶ˆæ¯é˜Ÿåˆ— è¿™æ˜¯DMZä¸­çš„æ—¥å¿—æ¡ç›®ç¼“å†²åŒº </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://www.rabbitmq.com/download.html</a> </p><br></td><td><p>  <a href="">https://github.com/rabbitmq/rabbitmq-server/releases/download/v3.7.14/rabbitmq-server-3.7.14-1.el7.noarch.rpm</a> </p><br></td></tr><tr><td><p>  Erlangè¿è¡Œæ—¶ï¼ˆRabbitMQå¿…éœ€ï¼‰ </p><br></td><td><p>  Erlangè¿è¡Œæ—¶ã€‚  RabbitMQå·¥ä½œæ‰€éœ€çš„ </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">http://www.erlang.org/download.html</a> </p><br></td><td><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://www.rabbitmq.com/install-rpm.html#install-erlang</a> <a href="">http://www.erlang.org/downloads/21.3</a> </p><br></td></tr></tbody></table></div><br></div></div><br> ä¸‹è¡¨ä¸­æ˜¾ç¤ºäº†ClickHouseæ•°æ®åº“çš„æœåŠ¡å™¨é…ç½®ï¼š <br><div class="scrollable-table"><table><tbody><tr><td>  <b>èŒç§°</b> <br></td><td>  <b>ä»·å€¼</b> <br></td><td>  <b>æ³¨æ„äº‹é¡¹</b> <br></td></tr><tr><td><p> æ„å‹ </p><br></td><td><p> ç¡¬ç›˜ï¼š40GB <br> å†…å­˜ï¼š8GB <br> å¤„ç†å™¨ï¼šCore 2 2Ghz </p><br></td><td><p> æ‚¨éœ€è¦æ³¨æ„æœ‰å…³æ“ä½œClickHouseæ•°æ®åº“çš„æç¤ºï¼ˆ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://clickhouse.yandex/docs/ru/operations/tips/</a> ï¼‰ </p><br></td></tr><tr><td><p> å…¨ç³»ç»Ÿè½¯ä»¶ </p><br></td><td><p> æ“ä½œç³»ç»Ÿï¼šRed Hat Enterprise Linux Serverï¼ˆMaipoï¼‰ </p><br><p>  JREï¼ˆJava 8ï¼‰ </p><br></td><td><p></p><br></td></tr></tbody></table></div><br> å¦‚æ‚¨æ‰€è§ï¼Œè¿™æ˜¯ä¸€ä¸ªå¸¸è§„å·¥ä½œç«™ã€‚ <br><br> ç”¨äºå­˜å‚¨æ—¥å¿—çš„è¡¨çš„ç»“æ„å¦‚ä¸‹ï¼š <br><br><div class="spoiler">  <b class="spoiler_title">log_web.sql</b> <div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> log_web ( logdate <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>, logdatetime DateTime CODEC(Delta, LZ4HC), fld_log_file_name LowCardinality( <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> ), fld_server_name LowCardinality( <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> ), fld_app_name LowCardinality( <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> ), fld_app_module LowCardinality( <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> ), fld_website_name LowCardinality( <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> ), serverIP LowCardinality( <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> ), method LowCardinality( <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> ), uriStem <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, uriQuery <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, port UInt32, username LowCardinality( <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> ), clientIP <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, clientRealIP <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, userAgent <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, referer <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, response <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, subresponse <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, win32response <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, timetaken UInt64 , uriQuery__utm_medium <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> , uriQuery__utm_source <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> , uriQuery__utm_campaign <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> , uriQuery__utm_term <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> , uriQuery__utm_content <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> , uriQuery__yclid <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> , uriQuery__region <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">Engine</span></span> = MergeTree() <span class="hljs-keyword"><span class="hljs-keyword">PARTITION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> toYYYYMM(logdate) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> (fld_app_name, fld_app_module, logdatetime) <span class="hljs-keyword"><span class="hljs-keyword">SETTINGS</span></span> index_granularity = <span class="hljs-number"><span class="hljs-number">8192</span></span>;</code> </pre> <br></div></div><br> æˆ‘ä»¬ä½¿ç”¨é»˜è®¤å€¼è¿›è¡Œåˆ†åŒºï¼ˆæŒ‰æœˆï¼‰å’Œç´¢å¼•çš„ç²’åº¦ã€‚ å®é™…ä¸Šï¼Œæ‰€æœ‰å­—æ®µéƒ½ä¸ç”¨äºæ³¨å†Œhttpè¯·æ±‚çš„IISæ—¥å¿—æ¡ç›®ç›¸å¯¹åº”ã€‚ åˆ†åˆ«åœ°ï¼Œç”¨äºå­˜å‚¨utmæ ‡è®°çš„å•ç‹¬å­—æ®µï¼ˆåœ¨ä»æŸ¥è¯¢å­—ç¬¦ä¸²å­—æ®µæ’å…¥è¡¨ä¸­çš„é˜¶æ®µå¯¹å®ƒä»¬è¿›è¡Œäº†è§£æï¼‰ã€‚ <br><br> è¿˜åœ¨è¡¨ä¸­æ·»åŠ äº†å‡ ä¸ªç³»ç»Ÿå­—æ®µï¼Œç”¨äºå­˜å‚¨æœ‰å…³ç³»ç»Ÿï¼Œç»„ä»¶ï¼ŒæœåŠ¡å™¨çš„ä¿¡æ¯ã€‚ æœ‰å…³è¿™äº›å­—æ®µçš„è¯´æ˜ï¼Œè¯·å‚è§ä¸‹è¡¨ã€‚ åœ¨ä¸€ä¸ªè¡¨ä¸­ï¼Œæˆ‘ä»¬å­˜å‚¨å¤šä¸ªç³»ç»Ÿçš„æ—¥å¿—ã€‚ <br><br><div class="scrollable-table"><table><tbody><tr><td>  <b>èŒç§°</b> <br></td><td>  <b>å†…å®¹æè¿°</b> <br></td><td>  <b>ä¾‹å­</b> <br></td></tr><tr><td><p>  fld_app_name </p><br></td><td><p> åº”ç”¨ç¨‹åº/ç³»ç»Ÿåç§° <br> æœ‰æ•ˆå€¼ï¼š </p><br><ul><li>  site1.domain.comå¤–éƒ¨ç«™ç‚¹1 </li><li>  site2.domain.comå¤–éƒ¨ç«™ç‚¹2 </li><li>  internal-site1.domain.localå†…éƒ¨ç«™ç‚¹1 </li></ul><br></td><td>  site1.domain.com <br></td></tr><tr><td><p>  fld_app_module </p><br></td><td><p> ç³»ç»Ÿæ¨¡å— <br> æœ‰æ•ˆå€¼ï¼š </p><br><ul><li> ç½‘ç«™-ç½‘ç«™ </li><li>  svc-ç½‘ç«™æœåŠ¡ </li><li>  intgr-Webé›†æˆæœåŠ¡ </li><li>  bo-ç®¡ç†å‘˜ï¼ˆåå°ï¼‰ </li></ul><br></td><td><p> ç½‘ç»œ </p><br></td></tr><tr><td><p>  fld_website_name </p><br></td><td><p>  IISä¸­çš„ç½‘ç«™åç§° </p><br><p> å¯ä»¥åœ¨ä¸€å°æœåŠ¡å™¨ä¸Šéƒ¨ç½²å¤šä¸ªç³»ç»Ÿï¼Œç”šè‡³å¯ä»¥åœ¨ä¸€ä¸ªç³»ç»Ÿæ¨¡å—ä¸Šéƒ¨ç½²å¤šä¸ªå®ä¾‹ã€‚ </p><br></td><td><p> ç½‘ç»œä¸» </p><br></td></tr><tr><td><p>  fld_server_name </p><br></td><td><p> æœåŠ¡å™¨åç§° </p><br></td><td><p>  web1.domain.com </p><br></td></tr><tr><td><p>  fld_log_file_name </p><br></td><td><p> æœåŠ¡å™¨ä¸Šæ—¥å¿—æ–‡ä»¶çš„è·¯å¾„ </p><br></td><td>  Cï¼š\ inetpub \æ—¥å¿—\ LogFiles <br>  \ W3SVC1 \ u_ex190711.log <br></td></tr></tbody></table></div><br> è¿™ä½¿æ‚¨å¯ä»¥åœ¨Grafanaä¸­æœ‰æ•ˆåœ°æ„å»ºå›¾å½¢ã€‚ ä¾‹å¦‚ï¼ŒæŸ¥çœ‹æ¥è‡ªç‰¹å®šç³»ç»Ÿå‰ç«¯çš„è¯·æ±‚ã€‚ è¿™ç±»ä¼¼äºYandex.Metricaä¸­çš„ç«™ç‚¹è®¡æ•°å™¨ã€‚ <br><br> ä»¥ä¸‹æ˜¯æœ‰å…³ä½¿ç”¨æ•°æ®åº“ä¸¤ä¸ªæœˆçš„ä¸€äº›ç»Ÿè®¡ä¿¡æ¯ã€‚ <br><br><div class="spoiler">  <b class="spoiler_title">æŒ‰ç³»ç»Ÿå’Œç»„ä»¶åˆ’åˆ†çš„è®°å½•æ•°</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> fld_app_name, fld_app_module, <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(fld_app_name) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> rows_count <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> log_web <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> fld_app_name, fld_app_module <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> TOTALS <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> fld_app_name <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span>, rows_count <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> â”Œâ”€fld_app_nameâ”€â”€â”€â”€â”€â”¬â”€fld_app_moduleâ”€â”¬â”€rows_countâ”€â” â”‚ site1.domain.ru â”‚ web â”‚ <span class="hljs-number"><span class="hljs-number">131441</span></span> â”‚ â”‚ site2.domain.ru â”‚ web â”‚ <span class="hljs-number"><span class="hljs-number">1751081</span></span> â”‚ â”‚ site3.domain.ru â”‚ web â”‚ <span class="hljs-number"><span class="hljs-number">106887543</span></span> â”‚ â”‚ site3.domain.ru â”‚ svc â”‚ <span class="hljs-number"><span class="hljs-number">44908603</span></span> â”‚ â”‚ site3.domain.ru â”‚ intgr â”‚ <span class="hljs-number"><span class="hljs-number">9813911</span></span> â”‚ â”‚ site4.domain.ru â”‚ web â”‚ <span class="hljs-number"><span class="hljs-number">772095</span></span> â”‚ â”‚ site5.domain.ru â”‚ web â”‚ <span class="hljs-number"><span class="hljs-number">17037221</span></span> â”‚ â”‚ site5.domain.ru â”‚ intgr â”‚ <span class="hljs-number"><span class="hljs-number">838559</span></span> â”‚ â”‚ site5.domain.ru â”‚ bo â”‚ <span class="hljs-number"><span class="hljs-number">7404</span></span> â”‚ â”‚ site6.domain.ru â”‚ web â”‚ <span class="hljs-number"><span class="hljs-number">595877</span></span> â”‚ â”‚ site7.domain.ru â”‚ web â”‚ <span class="hljs-number"><span class="hljs-number">27778858</span></span> â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ Totals: â”Œâ”€fld_app_nameâ”€â”¬â”€fld_app_moduleâ”€â”¬â”€rows_countâ”€â” â”‚ â”‚ â”‚ <span class="hljs-number"><span class="hljs-number">210522593</span></span> â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ <span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> set. Elapsed: <span class="hljs-number"><span class="hljs-number">4.874</span></span> sec. Processed <span class="hljs-number"><span class="hljs-number">210.52</span></span> million <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>, <span class="hljs-number"><span class="hljs-number">421.67</span></span> MB (<span class="hljs-number"><span class="hljs-number">43.19</span></span> million <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>/s., <span class="hljs-number"><span class="hljs-number">86.51</span></span> MB/s.)</code> </pre> <br></div></div><div class="spoiler">  <b class="spoiler_title">ç£ç›˜ä¸Šçš„æ•°æ®é‡</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> formatReadableSize(<span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(data_uncompressed_bytes)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> uncompressed, formatReadableSize(<span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(data_compressed_bytes)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> compressed, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> total_rows <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> system.parts <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> = <span class="hljs-string"><span class="hljs-string">'log_web'</span></span> â”Œâ”€uncompressedâ”€â”¬â”€compressedâ”€â”¬â”€total_rowsâ”€â” â”‚ <span class="hljs-number"><span class="hljs-number">54.50</span></span> GiB â”‚ <span class="hljs-number"><span class="hljs-number">4.86</span></span> GiB â”‚ <span class="hljs-number"><span class="hljs-number">211427094</span></span> â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> set. Elapsed: <span class="hljs-number"><span class="hljs-number">0.035</span></span> sec.</code> </pre> <br></div></div><div class="spoiler">  <b class="spoiler_title">åˆ—ä¸­çš„æ•°æ®å‹ç¼©ç¨‹åº¦</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, formatReadableSize(data_uncompressed_bytes) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> uncompressed, formatReadableSize(data_compressed_bytes) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> compressed, data_uncompressed_bytes / data_compressed_bytes <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> compress_ratio <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> system.columns <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> = <span class="hljs-string"><span class="hljs-string">'log_web'</span></span> â”Œâ”€<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€uncompressedâ”€â”¬â”€compressedâ”€â”¬â”€â”€â”€â”€â”€compress_ratioâ”€â” â”‚ logdate â”‚ <span class="hljs-number"><span class="hljs-number">401.53</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">1.80</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">223.16665968777315</span></span> â”‚ â”‚ logdatetime â”‚ <span class="hljs-number"><span class="hljs-number">803.06</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">35.91</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">22.363966401202305</span></span> â”‚ â”‚ fld_log_file_name â”‚ <span class="hljs-number"><span class="hljs-number">220.66</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">2.60</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">84.99905736932571</span></span> â”‚ â”‚ fld_server_name â”‚ <span class="hljs-number"><span class="hljs-number">201.54</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">50.63</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">3.980924816977078</span></span> â”‚ â”‚ fld_app_name â”‚ <span class="hljs-number"><span class="hljs-number">201.17</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">969.17</span></span> KiB â”‚ <span class="hljs-number"><span class="hljs-number">212.55518183686877</span></span> â”‚ â”‚ fld_app_module â”‚ <span class="hljs-number"><span class="hljs-number">201.17</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">968.60</span></span> KiB â”‚ <span class="hljs-number"><span class="hljs-number">212.67805817411906</span></span> â”‚ â”‚ fld_website_name â”‚ <span class="hljs-number"><span class="hljs-number">201.54</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">1.24</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">162.7204926761546</span></span> â”‚ â”‚ serverIP â”‚ <span class="hljs-number"><span class="hljs-number">201.54</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">50.25</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">4.010824061219731</span></span> â”‚ â”‚ method â”‚ <span class="hljs-number"><span class="hljs-number">201.53</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">43.64</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">4.617721053304486</span></span> â”‚ â”‚ uriStem â”‚ <span class="hljs-number"><span class="hljs-number">5.13</span></span> GiB â”‚ <span class="hljs-number"><span class="hljs-number">832.51</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">6.311522291936919</span></span> â”‚ â”‚ uriQuery â”‚ <span class="hljs-number"><span class="hljs-number">2.58</span></span> GiB â”‚ <span class="hljs-number"><span class="hljs-number">501.06</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">5.269731450124478</span></span> â”‚ â”‚ port â”‚ <span class="hljs-number"><span class="hljs-number">803.06</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">3.98</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">201.91673864241824</span></span> â”‚ â”‚ username â”‚ <span class="hljs-number"><span class="hljs-number">318.08</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">26.93</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">11.812513794583598</span></span> â”‚ â”‚ clientIP â”‚ <span class="hljs-number"><span class="hljs-number">2.35</span></span> GiB â”‚ <span class="hljs-number"><span class="hljs-number">82.59</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">29.132328640073343</span></span> â”‚ â”‚ clientRealIP â”‚ <span class="hljs-number"><span class="hljs-number">2.49</span></span> GiB â”‚ <span class="hljs-number"><span class="hljs-number">465.05</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">5.478382297052563</span></span> â”‚ â”‚ userAgent â”‚ <span class="hljs-number"><span class="hljs-number">18.34</span></span> GiB â”‚ <span class="hljs-number"><span class="hljs-number">764.08</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">24.57905114484208</span></span> â”‚ â”‚ referer â”‚ <span class="hljs-number"><span class="hljs-number">14.71</span></span> GiB â”‚ <span class="hljs-number"><span class="hljs-number">1.37</span></span> GiB â”‚ <span class="hljs-number"><span class="hljs-number">10.736792723669906</span></span> â”‚ â”‚ response â”‚ <span class="hljs-number"><span class="hljs-number">803.06</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">83.81</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">9.582334090987247</span></span> â”‚ â”‚ subresponse â”‚ <span class="hljs-number"><span class="hljs-number">399.87</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">1.83</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">218.4831068635027</span></span> â”‚ â”‚ win32response â”‚ <span class="hljs-number"><span class="hljs-number">407.86</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">7.41</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">55.050315514606815</span></span> â”‚ â”‚ timetaken â”‚ <span class="hljs-number"><span class="hljs-number">1.57</span></span> GiB â”‚ <span class="hljs-number"><span class="hljs-number">402.06</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">3.9947395692010637</span></span> â”‚ â”‚ uriQuery__utm_medium â”‚ <span class="hljs-number"><span class="hljs-number">208.17</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">12.29</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">16.936148912472955</span></span> â”‚ â”‚ uriQuery__utm_source â”‚ <span class="hljs-number"><span class="hljs-number">215.18</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">13.00</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">16.548367623199912</span></span> â”‚ â”‚ uriQuery__utm_campaign â”‚ <span class="hljs-number"><span class="hljs-number">381.46</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">37.94</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">10.055156353418509</span></span> â”‚ â”‚ uriQuery__utm_term â”‚ <span class="hljs-number"><span class="hljs-number">231.82</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">10.78</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">21.502540454070672</span></span> â”‚ â”‚ uriQuery__utm_content â”‚ <span class="hljs-number"><span class="hljs-number">441.34</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">87.60</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">5.038260760449327</span></span> â”‚ â”‚ uriQuery__yclid â”‚ <span class="hljs-number"><span class="hljs-number">216.88</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">16.58</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">13.07721335008116</span></span> â”‚ â”‚ uriQuery__region â”‚ <span class="hljs-number"><span class="hljs-number">204.35</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">9.49</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">21.52661903446796</span></span> â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ <span class="hljs-number"><span class="hljs-number">28</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> set. Elapsed: <span class="hljs-number"><span class="hljs-number">0.005</span></span> sec.</code> </pre> <br></div></div><br><h4> æ‰€ç”¨ç»„ä»¶çš„æè¿° <br><br>  FileBeatã€‚ æ–‡ä»¶æ—¥å¿—ä¼ è¾“ </h4><br> è¯¥ç»„ä»¶ç›‘è§†ç£ç›˜ä¸Šæ—¥å¿—æ–‡ä»¶ä¸­çš„æ›´æ”¹ï¼Œå¹¶å°†ä¿¡æ¯ä¼ è¾“åˆ°LogStashã€‚ å®ƒå®‰è£…åœ¨å†™å…¥æ—¥å¿—æ–‡ä»¶çš„æ‰€æœ‰æœåŠ¡å™¨ä¸Šï¼ˆé€šå¸¸æ˜¯IISï¼‰ã€‚ å®ƒä»¥å°¾éƒ¨æ¨¡å¼å·¥ä½œï¼ˆå³ï¼Œä»…å°†æ·»åŠ çš„è®°å½•ä¼ è¾“åˆ°æ–‡ä»¶ä¸­ï¼‰ã€‚ ä½†æ˜¯æ‚¨å¯ä»¥åˆ†åˆ«é…ç½®æ•´ä¸ªæ–‡ä»¶ä¼ è¾“ã€‚ å½“æ‚¨éœ€è¦ä»å‰å‡ ä¸ªæœˆä¸‹è½½æ•°æ®æ—¶ï¼Œè¿™å¾ˆæœ‰ç”¨ã€‚ åªéœ€å°†æ—¥å¿—æ–‡ä»¶æ”¾åœ¨ä¸€ä¸ªæ–‡ä»¶å¤¹ä¸­ï¼Œä»–å°±ä¼šå®Œæ•´åœ°è¯»å–å®ƒã€‚ <br><br> å½“æœåŠ¡åœæ­¢æ—¶ï¼Œæ•°æ®å°†åœæ­¢è¿›ä¸€æ­¥ä¼ è¾“åˆ°å­˜å‚¨ã€‚ <br><br> é…ç½®ç¤ºä¾‹å¦‚ä¸‹ï¼š <br><br><div class="spoiler">  <b class="spoiler_title">filebeat.yml</b> <div class="spoiler_text"><pre> <code class="sql hljs">filebeat.inputs: - type: log enabled: true paths: - C:/inetpub/logs/LogFiles/W3SVC1<span class="hljs-comment"><span class="hljs-comment">/*.log exclude_files: ['.gz$','.zip$'] tail_files: true ignore_older: 24h fields: fld_server_name: "site1.domain.ru" fld_app_name: "site1.domain.ru" fld_app_module: "web" fld_website_name: "web-main" - type: log enabled: true paths: - C:/inetpub/logs/LogFiles/__Import/access_log-* exclude_files: ['.gz$','.zip$'] tail_files: false fields: fld_server_name: "site2.domain.ru" fld_app_name: "site2.domain.ru" fld_app_module: "web" fld_website_name: "web-main" fld_logformat: "logformat__apache" filebeat.config.modules: path: ${path.config}/modules.d/*.yml reload.enabled: false reload.period: 2s output.logstash: hosts: ["log.domain.com:5044"] ssl.enabled: true ssl.certificate_authorities: ["C:/filebeat/certs/ca.pem", "C:/filebeat/certs/ca-issuing.pem"] ssl.certificate: "C:/filebeat/certs/site1.domain.ru.cer" ssl.key: "C:/filebeat/certs/site1.domain.ru.key" #================================ Processors ===================================== processors: - add_host_metadata: ~ - add_cloud_metadata: ~</span></span></code> </pre> <br></div></div><br><h4>  LogStash æ—¥å¿—é‡‡é›†å™¨ </h4><br> è¯¥ç»„ä»¶ç”¨äºæ¥æ”¶æ¥è‡ªFileBeatçš„æ—¥å¿—æ¡ç›®ï¼ˆæˆ–é€šè¿‡RabbitMQé˜Ÿåˆ—ï¼‰ï¼Œè§£æåˆ†å‘åŒ…å¹¶å°†å…¶æ’å…¥ClickHouseæ•°æ®åº“ã€‚ <br><br> è¦æ’å…¥ClickHouseï¼Œè¯·ä½¿ç”¨Logstash-output-clickhouseæ’ä»¶ã€‚  Logstashæ’ä»¶å…·æœ‰ä¸€ç§æ£€ç´¢è¯·æ±‚çš„æœºåˆ¶ï¼Œä½†æ˜¯å¦‚æœå®šæœŸå…³é—­ï¼Œæœ€å¥½åœæ­¢æœåŠ¡æœ¬èº«ã€‚ åœæ­¢æ—¶ï¼Œæ¶ˆæ¯å°†ç´¯ç§¯åœ¨RabbitMQé˜Ÿåˆ—ä¸­ï¼Œå› æ­¤ï¼Œå¦‚æœé•¿æ—¶é—´åœæ­¢ï¼Œåˆ™æœ€å¥½åœ¨æœåŠ¡å™¨ä¸Šåœæ­¢Filebeatsã€‚ åœ¨ä¸ä½¿ç”¨RabbitMQçš„æ–¹æ¡ˆä¸­ï¼ˆåœ¨æœ¬åœ°ç½‘ç»œä¸Šï¼ŒFilebeatå°†æ—¥å¿—ç›´æ¥å‘é€åˆ°Logstashï¼‰ï¼ŒFilebeatsçš„å·¥ä½œåŸç†æ˜¯å¯ä»¥æ¥å—ä¸”å®‰å…¨çš„ï¼Œå› æ­¤å¯¹äºå®ƒä»¬è€Œè¨€ï¼Œè¾“å‡ºä¸å¯è®¿é—®æ€§ä¸ä¼šå¸¦æ¥ä»»ä½•åæœã€‚ <br><br> é…ç½®ç¤ºä¾‹å¦‚ä¸‹ï¼š <br><br><div class="spoiler">  <b class="spoiler_title">log_web__filebeat_clickhouse.conf</b> <div class="spoiler_text"><pre> <code class="sql hljs">input { beats { port =&gt; 5044 type =&gt; 'iis' ssl =&gt; true ssl_certificate_authorities =&gt; ["/etc/logstash/certs/ca.cer", "/etc/logstash/certs/ca-issuing.cer"] ssl_certificate =&gt; "/etc/logstash/certs/server.cer" ssl_key =&gt; "/etc/logstash/certs/server-pkcs8.key" ssl_verify_mode =&gt; "peer" add_field =&gt; { "fld_server_name" =&gt; "%{[fields][fld_server_name]}" "fld_app_name" =&gt; "%{[fields][fld_app_name]}" "fld_app_module" =&gt; "%{[fields][fld_app_module]}" "fld_website_name" =&gt; "%{[fields][fld_website_name]}" "fld_log_file_name" =&gt; "%{source}" "fld_logformat" =&gt; "%{[fields][fld_logformat]}" } } rabbitmq { host =&gt; "queue.domain.com" port =&gt; 5671 user =&gt; "q-reader" password =&gt; "password" queue =&gt; "web_log" heartbeat =&gt; 30 durable =&gt; true ssl =&gt; true <span class="hljs-comment"><span class="hljs-comment">#ssl_certificate_path =&gt; "/etc/logstash/certs/server.p12" #ssl_certificate_password =&gt; "password" add_field =&gt; { "fld_server_name" =&gt; "%{[fields][fld_server_name]}" "fld_app_name" =&gt; "%{[fields][fld_app_name]}" "fld_app_module" =&gt; "%{[fields][fld_app_module]}" "fld_website_name" =&gt; "%{[fields][fld_website_name]}" "fld_log_file_name" =&gt; "%{source}" "fld_logformat" =&gt; "%{[fields][fld_logformat]}" } } } filter { if [message] =~ "^#" { drop {} } if [fld_logformat] == "logformat__iis_with_xrealip" { grok { match =&gt; ["message", "%{TIMESTAMP_ISO8601:log_timestamp} %{IP:serverIP} %{WORD:method} %{NOTSPACE:uriStem} %{NOTSPACE:uriQuery} %{NUMBER:port} %{NOTSPACE:username} %{IPORHOST:clientIP} %{NOTSPACE:userAgent} %{NOTSPACE:referer} %{NUMBER:response} %{NUMBER:subresponse} %{NUMBER:win32response} %{NUMBER:timetaken} %{NOTSPACE:xrealIP} %{NOTSPACE:xforwarderfor}"] } } else { grok { match =&gt; ["message", "%{TIMESTAMP_ISO8601:log_timestamp} %{IP:serverIP} %{WORD:method} %{NOTSPACE:uriStem} %{NOTSPACE:uriQuery} %{NUMBER:port} %{NOTSPACE:username} %{IPORHOST:clientIP} %{NOTSPACE:userAgent} %{NOTSPACE:referer} %{NUMBER:response} %{NUMBER:subresponse} %{NUMBER:win32response} %{NUMBER:timetaken}"] } } date { match =&gt; [ "log_timestamp", "YYYY-MM-dd HH:mm:ss" ] timezone =&gt; "Etc/UTC" remove_field =&gt; [ "log_timestamp", "@timestamp" ] target =&gt; [ "log_timestamp2" ] } ruby { code =&gt; "tstamp = event.get('log_timestamp2').to_i event.set('logdatetime', Time.at(tstamp).strftime('%Y-%m-%d %H:%M:%S')) event.set('logdate', Time.at(tstamp).strftime('%Y-%m-%d'))" } if [bytesSent] { ruby { code =&gt; "event['kilobytesSent'] = event['bytesSent'].to_i / 1024.0" } } if [bytesReceived] { ruby { code =&gt; "event['kilobytesReceived'] = event['bytesReceived'].to_i / 1024.0" } } ruby { code =&gt; "event.set('clientRealIP', event.get('clientIP'))" } if [xrealIP] { ruby { code =&gt; "event.set('clientRealIP', event.get('xrealIP'))" } } if [xforwarderfor] { ruby { code =&gt; "event.set('clientRealIP', event.get('xforwarderfor'))" } } mutate { convert =&gt; ["bytesSent", "integer"] convert =&gt; ["bytesReceived", "integer"] convert =&gt; ["timetaken", "integer"] convert =&gt; ["port", "integer"] add_field =&gt; { "clientHostname" =&gt; "%{clientIP}" } } useragent { source=&gt; "useragent" prefix=&gt; "browser" } kv { source =&gt; "uriQuery" prefix =&gt; "uriQuery__" allow_duplicate_values =&gt; false field_split =&gt; "&amp;" include_keys =&gt; [ "utm_medium", "utm_source", "utm_campaign", "utm_term", "utm_content", "yclid", "region" ] } mutate { join =&gt; { "uriQuery__utm_source" =&gt; "," } join =&gt; { "uriQuery__utm_medium" =&gt; "," } join =&gt; { "uriQuery__utm_campaign" =&gt; "," } join =&gt; { "uriQuery__utm_term" =&gt; "," } join =&gt; { "uriQuery__utm_content" =&gt; "," } join =&gt; { "uriQuery__yclid" =&gt; "," } join =&gt; { "uriQuery__region" =&gt; "," } } } output { #stdout {codec =&gt; rubydebug} clickhouse { headers =&gt; ["Authorization", "Basic abcdsfks..."] http_hosts =&gt; ["http://127.0.0.1:8123"] save_dir =&gt; "/etc/logstash/tmp" table =&gt; "log_web" request_tolerance =&gt; 1 flush_size =&gt; 10000 idle_flush_time =&gt; 1 mutations =&gt; { "fld_log_file_name" =&gt; "fld_log_file_name" "fld_server_name" =&gt; "fld_server_name" "fld_app_name" =&gt; "fld_app_name" "fld_app_module" =&gt; "fld_app_module" "fld_website_name" =&gt; "fld_website_name" "logdatetime" =&gt; "logdatetime" "logdate" =&gt; "logdate" "serverIP" =&gt; "serverIP" "method" =&gt; "method" "uriStem" =&gt; "uriStem" "uriQuery" =&gt; "uriQuery" "port" =&gt; "port" "username" =&gt; "username" "clientIP" =&gt; "clientIP" "clientRealIP" =&gt; "clientRealIP" "userAgent" =&gt; "userAgent" "referer" =&gt; "referer" "response" =&gt; "response" "subresponse" =&gt; "subresponse" "win32response" =&gt; "win32response" "timetaken" =&gt; "timetaken" "uriQuery__utm_medium" =&gt; "uriQuery__utm_medium" "uriQuery__utm_source" =&gt; "uriQuery__utm_source" "uriQuery__utm_campaign" =&gt; "uriQuery__utm_campaign" "uriQuery__utm_term" =&gt; "uriQuery__utm_term" "uriQuery__utm_content" =&gt; "uriQuery__utm_content" "uriQuery__yclid" =&gt; "uriQuery__yclid" "uriQuery__region" =&gt; "uriQuery__region" } } }</span></span></code> </pre> <br></div></div><div class="spoiler">  <b class="spoiler_title">pipelines.yml</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment"># This file is where you define your pipelines. You can define multiple. # For more information on multiple pipelines, see the documentation: # https://www.elastic.co/guide/en/logstash/current/multiple-pipelines.html - pipeline.id: log_web__filebeat_clickhouse path.config: "/etc/logstash/log_web__filebeat_clickhouse.conf"</span></span></code> </pre> <br></div></div><br><h4>  ClickHouseã€‚ æ—¥å¿—å‚¨å­˜ </h4><br> æ‰€æœ‰ç³»ç»Ÿçš„æ—¥å¿—éƒ½ä¿å­˜åœ¨ä¸€ä¸ªè¡¨ä¸­ï¼ˆè¯·å‚é˜…æœ¬æ–‡çš„å¼€å¤´ï¼‰ã€‚ å®ƒç”¨äºå­˜å‚¨æœ‰å…³è¯·æ±‚çš„ä¿¡æ¯ï¼šæ‰€æœ‰å‚æ•°å¯¹äºä¸åŒçš„æ ¼å¼éƒ½æ˜¯ç›¸ä¼¼çš„ï¼Œä¾‹å¦‚IISæ—¥å¿—ï¼Œapacheå’Œnginxæ—¥å¿—ã€‚ å¯¹äºå…¶ä¸­è®°å½•äº†ä¾‹å¦‚é”™è¯¯ï¼Œä¿¡æ¯æ€§æ¶ˆæ¯ï¼Œè­¦å‘Šçš„åº”ç”¨ç¨‹åºæ—¥å¿—ï¼Œå°†æä¾›å…·æœ‰ç›¸åº”ç»“æ„çš„å•ç‹¬è¡¨ï¼ˆç°åœ¨å¤„äºè®¾è®¡é˜¶æ®µï¼‰ã€‚ <br><br> è®¾è®¡è¡¨æ—¶ï¼Œç¡®å®šä¸»é”®ï¼ˆåœ¨å­˜å‚¨æœŸé—´å¯¹æ•°æ®è¿›è¡Œæ’åºï¼‰éå¸¸é‡è¦ã€‚ æ•°æ®å‹ç¼©çš„ç¨‹åº¦å’ŒæŸ¥è¯¢é€Ÿåº¦å–å†³äºæ­¤ã€‚ åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œå…³é”®æ˜¯ <br>  ORDER BYï¼ˆfld_app_nameï¼Œfld_app_moduleï¼Œlogdatetimeï¼‰ <br> å³ï¼Œé€šè¿‡ç³»ç»Ÿåç§°ï¼Œç³»ç»Ÿç»„ä»¶åç§°å’Œäº‹ä»¶æ—¥æœŸã€‚ æ´»åŠ¨çš„åŸå§‹æ—¥æœŸæ’åœ¨ç¬¬ä¸€ä½ã€‚ å°†å…¶ç§»åˆ°æœ€åä¸€ä¸ªä½ç½®åï¼ŒæŸ¥è¯¢å¼€å§‹ä»¥å¤§çº¦ä¸¤å€çš„é€Ÿåº¦è¿è¡Œã€‚ æ›´æ”¹ä¸»é”®å°†éœ€è¦é‡æ–°åˆ›å»ºè¡¨å¹¶é‡æ–°åŠ è½½æ•°æ®ï¼Œä»¥ä¾¿ClickHouseå¯¹ç£ç›˜ä¸Šçš„æ•°æ®è¿›è¡Œé‡æ–°æ’åºã€‚ è¿™æ˜¯ä¸€é¡¹å›°éš¾çš„æ“ä½œï¼Œå› æ­¤å»ºè®®æ‚¨æå‰è€ƒè™‘æ’åºå…³é”®å­—ä¸­åº”åŒ…å«çš„å†…å®¹ã€‚ <br><br> è¿˜åº”æ³¨æ„ï¼Œç›¸å¯¹è¾ƒæ–°çš„ç‰ˆæœ¬å‡ºç°äº†LowCardinalityæ•°æ®ç±»å‹ã€‚ ä½¿ç”¨å®ƒæ—¶ï¼Œå¯¹äºåŸºæ•°è¾ƒä½çš„å­—æ®µï¼ˆå¾ˆå°‘çš„é€‰é¡¹ï¼‰ï¼Œå‹ç¼©æ•°æ®çš„å¤§å°ä¼šæ€¥å‰§å‡å°ã€‚ <br><br> ç°åœ¨ä½¿ç”¨ç‰ˆæœ¬19.6ï¼Œæˆ‘ä»¬è®¡åˆ’å°è¯•å°†ç‰ˆæœ¬æ›´æ–°ä¸ºæœ€æ–°ç‰ˆæœ¬ã€‚ ä¾‹å¦‚ï¼Œå®ƒä»¬åŒ…æ‹¬è¯¸å¦‚è‡ªé€‚åº”ç²’åº¦ï¼Œè·³è¿‡ç´¢å¼•å’ŒDoubleDeltaç¼–è§£ç å™¨ç­‰å‡ºè‰²çš„åŠŸèƒ½ã€‚ <br><br> é»˜è®¤æƒ…å†µä¸‹ï¼Œåœ¨å®‰è£…è¿‡ç¨‹ä¸­ï¼Œé…ç½®æ—¥å¿—çº§åˆ«è®¾ç½®ä¸ºtraceã€‚ æ—¥å¿—è¢«è½®æ¢å’Œå­˜æ¡£ï¼Œä½†æ‰©å±•åˆ°1 GBã€‚ å¦‚æœä¸éœ€è¦ï¼Œåˆ™å¯ä»¥è®¾ç½®è­¦å‘Šçº§åˆ«ï¼Œç„¶åæ—¥å¿—çš„å¤§å°ä¼šæ€¥å‰§å‡å°‘ã€‚ æ—¥å¿—è®¾ç½®åœ¨config.xmlæ–‡ä»¶ä¸­è®¾ç½®ï¼š <br><br><pre> <code class="xml hljs"><span class="hljs-comment"><span class="hljs-comment">&lt;!-- Possible levels: https://github.com/pocoproject/poco/blob/develop/Foundation/include/Poco/Logger. h#L105 --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">level</span></span></span><span class="hljs-tag">&gt;</span></span>warning<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">level</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">ä¸€äº›æœ‰ç”¨çš„å‘½ä»¤</b> <div class="spoiler_text"><pre> <code class="sql hljs">      Debian,     Linux      Altinity.           : https://www.altinity.com/blog/2017/12/18/logstash-<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-clickhouse sudo yum <span class="hljs-keyword"><span class="hljs-keyword">search</span></span> clickhouse-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> sudo yum <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> clickhouse-server.noarch <span class="hljs-number"><span class="hljs-number">1.</span></span>   sudo systemctl <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> clickhouse-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-number"><span class="hljs-number">2.</span></span>   sudo systemctl <span class="hljs-keyword"><span class="hljs-keyword">stop</span></span> clickhouse-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-number"><span class="hljs-number">3.</span></span>   sudo systemctl <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> clickhouse-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span>        (   <span class="hljs-string"><span class="hljs-string">";"</span></span>) clickhouse-<span class="hljs-keyword"><span class="hljs-keyword">client</span></span> <span class="hljs-comment"><span class="hljs-comment">--multiline clickhouse-client --multiline --host 127.0.0.1 --password pa55w0rd clickhouse-client --multiline --host 127.0.0.1 --port 9440 --secure --user default --password pa55w0rd                /tmp/log_web_failed.json            : clickhouse-client --host 127.0.0.1 --password password --query="INSERT INTO log_web FORMAT JSONEachRow" &lt; /tmp/log_web_failed__fixed.json sudo mv /etc/logstash/tmp/log_web_failed.json /etc/logstash/tmp/log_web_failed__fixed.json sudo chown user_dev /etc/logstash/tmp/log_web_failed__fixed.json sudo clickhouse-client --host 127.0.0.1 --password password --query="INSERT INTO log_web FORMAT JSONEachRow" &lt; /etc/logstash/tmp/log_web_failed__fixed.json sudo mv /etc/logstash/tmp/log_web_failed__fixed.json /etc/logstash/tmp/log_web_failed__fixed_.json     quit; ##  TLS https://www.altinity.com/blog/2019/3/5/clickhouse-networking-part-2 openssl s_client -connect log.domain.com:9440 &lt; /dev/null</span></span></code> </pre> <br></div></div><br><h4>  LogStash  FileBeatæ—¥å¿—è·¯ç”±å™¨åˆ°RabbitMQé˜Ÿåˆ— </h4><br> è¯¥ç»„ä»¶ç”¨äºå°†æ¥è‡ªFileBeatçš„æ—¥å¿—è·¯ç”±åˆ°RabbitMQé˜Ÿåˆ—ã€‚ æœ‰ä¸¤ç‚¹ï¼š <br><br><ol><li> ä¸å¹¸çš„æ˜¯ï¼ŒFileBeatæ²¡æœ‰ç”¨äºç›´æ¥å†™å…¥RabbitMQçš„è¾“å‡ºæ’ä»¶ã€‚ æ ¹æ®ishåœ¨å…¶githubä¸Šçš„åˆ¤æ–­ï¼Œæ­¤ç±»åŠŸèƒ½å°šæœªè®¡åˆ’å®ç°ã€‚ æœ‰ä¸€ä¸ªKafkaæ’ä»¶ï¼Œä½†ç”±äºæŸäº›åŸå› ï¼Œæˆ‘ä»¬ä¸èƒ½åœ¨å®¶ä¸­ä½¿ç”¨å®ƒã€‚ </li><li> æœ‰åœ¨DMZä¸­æ”¶é›†æ—¥å¿—çš„è¦æ±‚ã€‚ åŸºäºå®ƒä»¬ï¼Œå¿…é¡»é¦–å…ˆå°†æ—¥å¿—æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ï¼Œç„¶åä»å¤–éƒ¨ä½¿ç”¨LogStashä»é˜Ÿåˆ—ä¸­è¯»å–æ¡ç›®ã€‚ </li></ol><br> å› æ­¤ï¼Œæ­£æ˜¯é’ˆå¯¹DMZä¸­æœåŠ¡å™¨ä½ç½®çš„æƒ…å†µï¼Œæ‚¨å¿…é¡»ä½¿ç”¨è¿™ç§ç¨å¾®å¤æ‚çš„æ–¹æ¡ˆã€‚ é…ç½®ç¤ºä¾‹å¦‚ä¸‹ï¼š <br><br><div class="spoiler">  <b class="spoiler_title">iis_w3c_logs__filebeat_rabbitmq.conf</b> <div class="spoiler_text"><pre> <code class="sql hljs">input { beats { port =&gt; 5044 type =&gt; 'iis' ssl =&gt; true ssl_certificate_authorities =&gt; ["/etc/pki/tls/certs/app/ca.pem", "/etc/pki/tls/certs/app/ca-issuing.pem"] ssl_certificate =&gt; "/etc/pki/tls/certs/app/queue.domain.com.cer" ssl_key =&gt; "/etc/pki/tls/certs/app/queue.domain.com-pkcs8.key" ssl_verify_mode =&gt; "peer" } } output { <span class="hljs-comment"><span class="hljs-comment">#stdout {codec =&gt; rubydebug} rabbitmq { host =&gt; "127.0.0.1" port =&gt; 5672 exchange =&gt; "monitor.direct" exchange_type =&gt; "direct" key =&gt; "%{[fields][fld_app_name]}" user =&gt; "q-writer" password =&gt; "password" ssl =&gt; false } }</span></span></code> </pre> <br></div></div><br><h4>  RabbitMQã€‚ æ¶ˆæ¯é˜Ÿåˆ— </h4><br> æ­¤ç»„ä»¶ç”¨äºåœ¨DMZä¸­ç¼“å†²æ—¥å¿—æ¡ç›®ã€‚ é€šè¿‡ä¸€å †Filebeatâ†’LogStashè¿›è¡Œè®°å½•ã€‚ é€šè¿‡LogStashä»DMZå¤–éƒ¨è¿›è¡Œè¯»å–ã€‚ é€šè¿‡RabboitMQè¿è¡Œæ—¶ï¼Œæ¯ç§’å¤§çº¦å¤„ç†4000æ¡æ¶ˆæ¯ã€‚ <br><br> æ ¹æ®ç³»ç»Ÿåç§°é…ç½®æ¶ˆæ¯è·¯ç”±ï¼Œå³åŸºäºFileBeaté…ç½®æ•°æ®ã€‚ æ‰€æœ‰æ¶ˆæ¯éƒ½å±äºä¸€ä¸ªé˜Ÿåˆ—ã€‚ å¦‚æœå‡ºäºæŸç§åŸå› åœæ­¢äº†é˜Ÿåˆ—æœåŠ¡ï¼Œåˆ™ä¸ä¼šå¯¼è‡´æ¶ˆæ¯ä¸¢å¤±ï¼šFileBeatså°†æ”¶åˆ°è¿æ¥é”™è¯¯å¹¶æš‚åœä¸´æ—¶å‘é€ã€‚ ä»é˜Ÿåˆ—ä¸­è¯»å–çš„LogStashä¹Ÿå°†æ”¶åˆ°ç½‘ç»œé”™è¯¯ï¼Œå¹¶ç­‰å¾…è¿æ¥æ¢å¤ã€‚ å½“ç„¶ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ•°æ®å°†ä¸å†å†™å…¥æ•°æ®åº“ã€‚ <br><br> ä»¥ä¸‹è¯´æ˜ç”¨äºåˆ›å»ºå’Œé…ç½®é˜Ÿåˆ—ï¼š <br><br><pre> <code class="sql hljs">sudo /usr/local/bin/rabbitmqadmin/rabbitmqadmin <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exchange</span></span> <span class="hljs-comment"><span class="hljs-comment">--vhost=/ name=monitor.direct type=direct sudo /usr/local/bin/rabbitmqadmin/rabbitmqadmin declare queue --vhost=/ name=web_log durable=true sudo /usr/local/bin/rabbitmqadmin/rabbitmqadmin --vhost="/" declare binding source="monitor.direct" destination_type="queue" destination="web_log" routing_key="site1.domain.ru" sudo /usr/local/bin/rabbitmqadmin/rabbitmqadmin --vhost="/" declare binding source="monitor.direct" destination_type="queue" destination="web_log" routing_key="site2.domain.ru"</span></span></code> </pre> <br><h4> æ ¼æ‹‰æ³•çº³ ä»ªè¡¨æ¿ </h4><br> è¯¥ç»„ä»¶ç”¨äºå¯è§†åŒ–ç›‘è§†æ•°æ®ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨å¿…é¡»å®‰è£…ç”¨äºGrafana 4.6+æ’ä»¶çš„ClickHouseæ•°æ®æºã€‚ æˆ‘ä»¬å¿…é¡»å¯¹å…¶è¿›è¡Œä¸€äº›è°ƒæ•´ï¼Œä»¥æé«˜åœ¨ä»ªè¡¨æ¿ä¸Šå¤„ç†SQLè¿‡æ»¤å™¨çš„æ•ˆç‡ã€‚ <br><br> ä¾‹å¦‚ï¼Œæˆ‘ä»¬ä½¿ç”¨å˜é‡ï¼Œå¹¶ä¸”å¦‚æœæœªåœ¨è¿‡æ»¤å™¨å­—æ®µä¸­è®¾ç½®å˜é‡ï¼Œæˆ‘ä»¬å¸Œæœ›å®ƒä¸ç”ŸæˆWHEREå½¢å¼çš„æ¡ä»¶ï¼ˆuriStem =``AND uriStemï¼=''ï¼‰ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒClickHouseå°†è¯»å–uriStemåˆ—ã€‚ é€šå¸¸ï¼Œæˆ‘ä»¬å°è¯•äº†ä¸åŒçš„é€‰é¡¹ï¼Œæœ€åä¿®å¤äº†æ’ä»¶ï¼ˆå®$ valueIfEmptyï¼‰ï¼Œä»¥ä¾¿åœ¨å€¼ä¸ºç©ºçš„æƒ…å†µä¸‹è¿”å›1ï¼Œè€Œæ— éœ€æåŠåˆ—æœ¬èº«ã€‚ <br><br> ç°åœ¨æ‚¨å¯ä»¥å°†æ­¤æŸ¥è¯¢ç”¨äºå›¾è¡¨ <br><br><pre> <code class="sql hljs">$columns(response, count(*) c) from $table where $adhoc and $valueIfEmpty($fld_app_name, 1, fld_app_name = '$fld_app_name') and $valueIfEmpty($fld_app_module, 1, fld_app_module = '$fld_app_module') and $valueIfEmpty($fld_server_name, 1, fld_server_name = '$fld_server_name') and $valueIfEmpty($uriStem, 1, uriStem like '%$uriStem%') and $valueIfEmpty($clientRealIP, 1, clientRealIP = '$clientRealIP')</code> </pre> <br> å°†å…¶è½¬æ¢ä¸ºæ­¤ç±»SQLï¼ˆè¯·æ³¨æ„ï¼Œç©ºuriStemå­—æ®µä»…è½¬æ¢ä¸º1ï¼‰ <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t, groupArray((response, c)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> groupArr <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> (intDiv(toUInt32(logdatetime), <span class="hljs-number"><span class="hljs-number">60</span></span>) * <span class="hljs-number"><span class="hljs-number">60</span></span>) * <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t, response, <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> default.log_web <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> (logdate &gt;= toDate(<span class="hljs-number"><span class="hljs-number">1565061982</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (logdatetime &gt;= toDateTime(<span class="hljs-number"><span class="hljs-number">1565061982</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (fld_app_name = <span class="hljs-string"><span class="hljs-string">'site1.domain.ru'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (fld_app_module = <span class="hljs-string"><span class="hljs-string">'web'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> t, response <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> t <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span>, response <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> t <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> t <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span></code> </pre> <br><h4> ç»“è®º </h4><br>  ClickHouseæ•°æ®åº“çš„å‡ºç°å·²æˆä¸ºå¸‚åœºä¸­çš„æ ‡å¿—æ€§äº‹ä»¶ã€‚ å¾ˆéš¾æƒ³è±¡ä¸€ä¸‹ï¼Œæˆ‘ä»¬å…è´¹è·å¾—äº†ä¸€ä¸ªå¼ºå¤§è€Œå®ç”¨çš„å·¥å…·æ¥å¤„ç†å¤§æ•°æ®ã€‚ å½“ç„¶ï¼Œéšç€éœ€æ±‚çš„å¢åŠ ï¼ˆä¾‹å¦‚ï¼Œåˆ†ç‰‡å’Œå¤åˆ¶åˆ°å¤šä¸ªæœåŠ¡å™¨ï¼‰ï¼Œè¯¥æ–¹æ¡ˆå°†å˜å¾—æ›´åŠ å¤æ‚ã€‚ ä½†æ˜¯ä¹ä¸€çœ‹ï¼Œä½¿ç”¨è¯¥æ•°æ®åº“éå¸¸å¥½ã€‚ å¯ä»¥çœ‹å‡ºï¼Œè¯¥äº§å“æ˜¯ä¸ºâ€œäººä»¬â€åˆ¶ä½œçš„ã€‚ <br><br> ä¸åˆæ­¥ä¼°è®¡ç›¸æ¯”ï¼Œä¸ElasticSearchç›¸æ¯”ï¼Œå­˜å‚¨å’Œå¤„ç†æ—¥å¿—çš„æˆæœ¬é™ä½äº†äº”å€è‡³åå€ã€‚ æ¢å¥è¯è¯´ï¼Œå¦‚æœå¯¹äºå½“å‰æ•°æ®é‡ï¼Œæˆ‘ä»¬å¿…é¡»é…ç½®ä¸€ä¸ªç”±å¤šå°è®¡ç®—æœºç»„æˆçš„é›†ç¾¤ï¼Œé‚£ä¹ˆåœ¨ä½¿ç”¨ClickHouseæ—¶ï¼Œæˆ‘ä»¬ä»…éœ€è¦ä¸€å°ä½åŠŸè€—è®¡ç®—æœºã€‚ æ˜¯çš„ï¼Œå½“ç„¶ï¼ŒElasticSearchè¿˜å…·æœ‰ç”¨äºå‹ç¼©ç£ç›˜ä¸Šæ•°æ®çš„æœºåˆ¶ä»¥åŠå…¶ä»–å¯ä»¥æ˜¾ç€å‡å°‘èµ„æºæ¶ˆè€—çš„åŠŸèƒ½ï¼Œä½†æ˜¯ä¸ClickHouseç›¸æ¯”ï¼Œè¿™å°†æ˜¯æ˜‚è´µçš„ã€‚ <br><br> åœ¨æ²¡æœ‰ä»»ä½•ç‰¹æ®Šä¼˜åŒ–çš„æƒ…å†µä¸‹ï¼Œåœ¨é»˜è®¤è®¾ç½®ä¸‹ï¼ŒåŠ è½½æ•°æ®å’Œä»æ•°æ®åº“æ£€ç´¢æ•°æ®çš„é€Ÿåº¦éå¸¸å¿«ã€‚ åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬åªæœ‰å°‘é‡æ•°æ®ï¼ˆå¤§çº¦2äº¿æ¡è®°å½•ï¼‰ï¼Œä½†æ˜¯æœåŠ¡å™¨æœ¬èº«å¾ˆè–„å¼±ã€‚ å°†æ¥ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ­¤å·¥å…·ç”¨äºä¸æ—¥å¿—å­˜å‚¨æ— å…³çš„å…¶ä»–ç›®çš„ã€‚ ä¾‹å¦‚ï¼Œå¯¹äºç«¯åˆ°ç«¯åˆ†æï¼Œåœ¨å®‰å…¨é¢†åŸŸï¼Œæœºå™¨å­¦ä¹ ã€‚ <br><br> æœ€åï¼Œä»‹ç»äº†ä¸€äº›åˆ©å¼Šã€‚ <br><br><h4> ç¼ºç‚¹ </h4><br><ol><li> å¤§æ†ä¸‹è½½è®°å½•ã€‚ ä¸€æ–¹é¢ï¼Œè¿™æ˜¯ä¸€é¡¹åŠŸèƒ½ï¼Œä½†ä»ç„¶å¿…é¡»ä½¿ç”¨å…¶ä»–ç»„ä»¶æ¥ç¼“å†²è®°å½•ã€‚ è¿™ä¸ªä»»åŠ¡å¹¶ä¸æ€»æ˜¯é‚£ä¹ˆç®€å•ï¼Œä½†æ˜¯ä»ç„¶å¯ä»¥è§£å†³ã€‚ æˆ‘æƒ³ç®€åŒ–è¿™ä¸ªè®¡åˆ’ã€‚ </li><li> ä¸€äº›å¥‡ç‰¹çš„åŠŸèƒ½æˆ–æ–°åŠŸèƒ½é€šå¸¸ä¼šåœ¨æ–°ç‰ˆæœ¬ä¸­ä¸­æ–­ã€‚ è¿™å¼•èµ·äº†äººä»¬çš„å…³æ³¨ï¼Œå‡å°‘äº†å‡çº§åˆ°æ–°ç‰ˆæœ¬çš„æ„¿æœ›ã€‚ ä¾‹å¦‚ï¼ŒKafkaè¡¨å¼•æ“æ˜¯ä¸€é¡¹éå¸¸æœ‰ç”¨çš„åŠŸèƒ½ï¼Œå¯è®©æ‚¨ç›´æ¥ä»Kafkaè¯»å–äº‹ä»¶ï¼Œè€Œæ— éœ€ä½¿ç”¨ä½¿ç”¨è€…ã€‚ ä½†æ˜¯ä»githubä¸Šçš„Issuesæ•°é‡æ¥çœ‹ï¼Œæˆ‘ä»¬ä»ç„¶å¯¹åœ¨ç”Ÿäº§ä¸­ä½¿ç”¨æ­¤å¼•æ“æŒè°¨æ…æ€åº¦ã€‚ ä½†æ˜¯ï¼Œå¦‚æœæ‚¨ä¸å‘ä¾§é¢å‰§çƒˆç§»åŠ¨å¹¶ä½¿ç”¨åŸºæœ¬åŠŸèƒ½ï¼Œåˆ™å®ƒä¼šç¨³å®šè¿è¡Œã€‚ </li></ol><br><h4> ä¼˜ç‚¹ </h4><br><ol><li> å®ƒä¸ä¼šå‡æ…¢é€Ÿåº¦ã€‚ </li><li> ä½è¿›å…¥é—¨æ§›ã€‚ </li><li> å¼€æºçš„ </li><li> å®ƒæ˜¯å…è´¹çš„ã€‚ </li><li> å¾ˆå¥½åœ°æ‰©å±•ï¼ˆç°æˆçš„åˆ†ç‰‡/å¤åˆ¶ï¼‰ </li><li> å®ƒå·²åŒ…å«åœ¨é€šä¿¡éƒ¨æ¨èçš„ä¿„â€‹â€‹æ–‡è½¯ä»¶æ³¨å†Œç°¿ä¸­ã€‚ </li><li>  Yandexæä¾›å®˜æ–¹æ”¯æŒã€‚ </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN472912/">https://habr.com/ru/post/zh-CN472912/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN472896/index.html">æ‰“å°æœºåˆ¶é€ çš„ç›´å‡æœºï¼šç§‘å­¦å®¶é¦–æ¬¡â€œå°åˆ·â€äº†å¤§å‹ç›´å‡æœºå‘åŠ¨æœºç®±</a></li>
<li><a href="../zh-CN472902/index.html">Windows for IoTï¼šå¢å¼ºçš„ç¡¬ä»¶æ”¯æŒå’Œæ–°çš„æ™ºèƒ½è®¾å¤‡åŠŸèƒ½</a></li>
<li><a href="../zh-CN472904/index.html">äºšé©¬é€Šå¦‚ä½•å°†è‚¡ç¥¨å˜æˆæ¸¸æˆ</a></li>
<li><a href="../zh-CN472908/index.html">è¾¾åŠ å…¹ï¼šæƒ…èŠ‚ï¼ˆç¬¬2éƒ¨åˆ†ï¼‰</a></li>
<li><a href="../zh-CN472910/index.html">ä½¿ç”¨æ™ºèƒ½æ‰‹æœºæŸ¥æ‰¾æ ‡ç‰Œå’ŒåŒ…è£¹ä¸Šçš„æ–‡å­—</a></li>
<li><a href="../zh-CN472916/index.html">åç«¯ï¼Œæœºå™¨å­¦ä¹ å’Œæ— æœåŠ¡å™¨æ˜¯7æœˆHabrä¼šè®®ä¸Šæœ€æœ‰è¶£çš„éƒ¨åˆ†</a></li>
<li><a href="../zh-CN472918/index.html">ä¿„ç½—æ–¯å’Œç‹¬è”ä½“å›½å®¶çš„ZX Spectrumï¼šå¦‚ä½•è¿½æ±‚åœ¨çº¿è½¬åŒ–ç¦»çº¿</a></li>
<li><a href="../zh-CN472922/index.html">é˜²å¾¡è€…ç¨‹åºå‘˜èƒœäºç†µ</a></li>
<li><a href="../zh-CN472926/index.html">åŠ é€Ÿæ”¶ç›Šå®šå¾‹ï¼ˆç¬¬1éƒ¨åˆ†ï¼‰</a></li>
<li><a href="../zh-CN472930/index.html">ç¡…è°·å¤©ä½“ç‰©ç†å­¦å®¶é‡åŒ–æ—¶å°š</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>