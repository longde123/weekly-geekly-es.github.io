<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçï üíï üïê Debian + Postfix + Dovecot + Multidomain + SSL + IPv6 + OpenVPN + Multi-interfaces + SpamAssassin-learn + Bind ü§≥üèø üçô üçó</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Este artigo √© sobre como configurar um servidor de email moderno. 
 Postfix + Dovecot. SPF + DKIM + rDNS. Com IPv6. 
 Com criptografia TLS. Com suport...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Debian + Postfix + Dovecot + Multidomain + SSL + IPv6 + OpenVPN + Multi-interfaces + SpamAssassin-learn + Bind</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/413689/">  Este artigo √© sobre como configurar um servidor de email moderno. <br>  Postfix + Dovecot.  SPF + DKIM + rDNS.  Com IPv6. <br>  Com criptografia TLS.  Com suporte para v√°rios dom√≠nios - pe√ßa um certificado SSL real. <br>  Com prote√ß√£o anti-spam e alta classifica√ß√£o anti-spam em outros servidores de email. <br>  Com suporte para m√∫ltiplas interfaces f√≠sicas. <br>  Com o OpenVPN, que se conecta atrav√©s do IPv4 e que fornece o IPv6. <br><br>  Se voc√™ n√£o deseja aprender todas essas tecnologias, mas deseja configurar esse servidor, este artigo √© para voc√™. <br><br>  N√£o h√° tentativas de explicar todos os detalhes do artigo.  A explica√ß√£o vai para o que n√£o est√° configurado de maneira padr√£o ou √© importante do ponto de vista do consumidor. <br><a name="habracut"></a><br>  A motiva√ß√£o para configurar um servidor de correio √© o meu sonho antigo.  Pode parecer bobagem, mas IMHO, √© muito melhor do que sonhar com um carro novo da sua marca favorita. <br><br>  A motiva√ß√£o para configurar o IPv6 √© dois.  Os profissionais de TI precisam aprender constantemente novas tecnologias para sobreviver.  Gostaria de dar a minha modesta contribui√ß√£o para a luta contra a censura. <br><br>  A motiva√ß√£o para configurar o OpenVPN √© apenas para o IPv6 funcionar na m√°quina local. <br>  A motiva√ß√£o para configurar v√°rias interfaces f√≠sicas √© que, no meu servidor, uma interface √© "lenta mas ilimitada" e a outra √© "r√°pida, mas com tarifa". <br><br>  A motiva√ß√£o para definir as configura√ß√µes do Bind √© que meu provedor fornece um servidor DNS inst√°vel e o Google tamb√©m falha.  Eu quero um servidor DNS est√°vel para uso pessoal. <br><br>  Motiva√ß√£o para escrever um artigo - um rascunho foi escrito h√° 10 meses e eu j√° o examinei duas vezes.  Se mesmo o autor precisa disso regularmente, h√° uma alta probabilidade de que outros precisem. <br><br>  N√£o h√° solu√ß√£o universal para o servidor de email.  Mas vou tentar escrever algo como "fa√ßa assim e depois, quando tudo funcionar como deveria - jogue fora o excesso". <br><br>  Existe um servidor de Colocation no tech.ru.  √â poss√≠vel comparar com OVH, Hetzner, AWS.  Para resolver esse problema, a coopera√ß√£o com o tech.ru ser√° muito mais eficaz. <br><br>  O Debian 9 est√° instalado no servidor. <br><br>  No servidor, existem 2 interfaces `eno1` e` eno2`.  O primeiro √© ilimitado e o segundo √© r√°pido, respectivamente. <br><br>  Existem 3 endere√ßos IP est√°ticos, XX.XX.XX.X0 e XX.XX.XX.X1 e XX.XX.XX.X2 na interface `eno1` e XX.XX.XX.X5 na interface` eno2`. <br><br>  Existe XXXX: XXXX: XXXX: XXXX :: / 64 um pool de endere√ßos IPv6 que s√£o atribu√≠dos √† interface `eno1` e a partir dela XXXX: XXXX: XXXX: XXXX: XXXX: 1: 2 :: / 96 em minha solicita√ß√£o atribu√≠da a` eno2`. <br><br>  Existem 3 dom√≠nios `domain1.com`,` domain2.com`, `domain3.com`.  Para `domain1.com` e` domain3.com`, existe um certificado SSL. <br><br>  Existe uma conta do Google na qual voc√™ deseja vincular a caixa de correio `vasya.pupkin @ domain1.com` (recebendo e enviando e-mails diretamente da interface do Gmail). <br>  Deve haver uma caixa de correio `support @ domain2.com ', uma c√≥pia do e-mail da qual eu quero ver no meu gmail.  E raramente √© poss√≠vel enviar algo em nome de `support @ domain2.com 'atrav√©s da interface da web. <br><br>  Deve haver uma caixa de correio `ivanov @ domain3.com`, que Ivanov usar√° em seu iPhone. <br><br>  As cartas enviadas devem cumprir todos os requisitos atuais de anti-spam. <br>  Deve haver o n√≠vel mais alto de criptografia fornecido nas redes p√∫blicas. <br>  Deve haver suporte ao IPv6 para o envio e o recebimento de emails. <br>  Deve haver um SpamAssassin que nunca excluir√° emails.  E ele saltar√° ou pular√° ou enviar√° a pasta Spam para o IMAP. <br>  O aprendizado autom√°tico do SpamAssassin deve ser configurado: se eu mover a letra para a pasta Spam, aprenderei disso;  se eu mover a carta da pasta Spam, aprenderei com isso.  Resultados de aprendizado do SpamAssassin - devem afetar o alcance da mensagem na pasta Spam. <br>  Os scripts php devem poder enviar email em nome de qualquer dom√≠nio neste servidor. <br>  Deve haver um servi√ßo openvpn com a capacidade de usar o IPv6 em um cliente que n√£o possui IPv6. <br><br>  Primeiro, voc√™ precisa configurar interfaces e roteamento, incluindo o IPv6. <br>  Em seguida, voc√™ precisar√° configurar o OpenVPN, que se conectar√° via IPv4 e fornecer√° ao cliente um endere√ßo IPv6 est√°tico-real.  Esse cliente ter√° acesso a todos os servi√ßos IPv6 no servidor e a qualquer recurso IPv6 na Internet. <br>  Ent√£o ser√° necess√°rio configurar o Postfix para enviar cartas + SPF + DKIM + rDNS e outros ninharias semelhantes. <br>  Ent√£o voc√™ precisar√° configurar o Dovecot e configurar o Multidomain. <br>  Voc√™ precisar√° configurar o SpamAssassin e configurar o treinamento. <br>  Por fim, instale o Bind. <br><br><h2>  ============== Multi-interfaces ============== </h2><br>  Para configurar as interfaces, voc√™ precisa registrar isso em "/ etc / network / interfaces". <br><br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># The loopback network interface auto lo iface lo inet loopback # The primary network interface allow-hotplug eno1 iface eno1 inet static address XX.XX.XX.X0/24 gateway XX.XX.XX.1 dns-nameservers 127.0.0.1 213.248.1.6 post-up ip route add XX.XX.XX.0/24 dev eno1 src XX.XX.XX.X0 table eno1t post-up ip route add default via XX.XX.XX.1 table eno1t post-up ip rule add table eno1t from XX.XX.XX.X0 post-up ip rule add table eno1t to XX.XX.XX.X0 auto eno1:1 iface eno1:1 inet static address XX.XX.XX.X1 netmask 255.255.255.0 post-up ip rule add table eno1t from XX.XX.XX.X1 post-up ip rule add table eno1t to XX.XX.XX.X1 post-up ip route add 10.8.0.0/24 dev tun0 src XX.XX.XX.X1 table eno1t post-down ip route del 10.8.0.0/24 dev tun0 src XX.XX.XX.X1 table eno1t auto eno1:2 iface eno1:2 inet static address XX.XX.XX.X2 netmask 255.255.255.0 post-up ip rule add table eno1t from XX.XX.XX.X2 post-up ip rule add table eno1t to XX.XX.XX.X2 iface eno1 inet6 static address X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">1:1::/64 gateway X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">:1 up ip -6 addr add X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">1:1:1:1/64 dev $IFACE up ip -6 addr add X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">1:1:1:2/64 dev $IFACE down ip -6 addr del X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">1:1:1:1/64 dev $IFACE down ip -6 addr del X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">1:1:1:2/64 dev $IFACE # The secondary network interface allow-hotplug eno2 iface eno2 inet static address XX.XX.XX.X5 netmask 255.255.255.0 post-up ip route add XX.XX.XX.0/24 dev eno2 src XX.XX.XX.X5 table eno2t post-up ip route add default via XX.XX.XX.1 table eno2t post-up ip rule add table eno2t from XX.XX.XX.X5 post-up ip rule add table eno2t to XX.XX.XX.X5 post-up ip route add 10.8.0.0/24 dev tun0 src XX.XX.XX.X5 table eno2t post-down ip route del 10.8.0.0/24 dev tun0 src XX.XX.XX.X5 table eno2t iface eno2 inet6 static address X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">1:2::/96 up ip -6 addr add X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">1:2:1:1/64 dev $IFACE up ip -6 addr add X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">1:2:1:2/64 dev $IFACE down ip -6 addr del X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">1:2:1:1/64 dev $IFACE down ip -6 addr del X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">1:2:1:2/64 dev $IFACE # OpenVPN network iface tun0 inet6 static address X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">1:3::/80</span></span></code> </pre> <br>  Essas configura√ß√µes podem ser aplicadas em qualquer servidor no tech.ru (com um pouco de coordena√ß√£o com o suporte) e funcionar√£o imediatamente como deveriam. <br><br>  Se a experi√™ncia de cria√ß√£o de coisas semelhantes para Hetzner, OVH - h√° namorada.  Mais dif√≠cil. <br><br>  eno1 √© o nome da placa de rede n¬∫ 1 (lenta mas ilimitada). <br>  eno2 √© o nome da placa de rede n¬∫ 2 (r√°pido, mas com tarifa). <br>  tun0 √© o nome da placa de rede virtual do OpenVPN. <br>  XX.XX.XX.X0 - IPv4 # 1 no eno1. <br>  XX.XX.XX.X1 - IPv4 # 2 no eno1. <br>  XX.XX.XX.X2 - IPv4 # 3 no eno1. <br>  XX.XX.XX.X5 - IPv4 # 1 no eno2. <br>  XX.XX.XX.1 - gateway IPv4. <br>  XXXX: XXXX: XXXX: XXXX :: / 64 - IPv6 para o servidor inteiro. <br>  XXXX: XXXX: XXXX: XXXX: 1: 2 :: / 96 - IPv6 para eno2, todo o resto vai para eno1 do lado de fora. <br>  XXXX: XXXX: XXXX: XXXX :: 1 - gateway IPv6 (vale a pena notar que voc√™ pode / precisa fazer um amigo aqui. Indique a op√ß√£o IPv6). <br>  dns-nameservers - 127.0.0.1 s√£o especificados (porque o bind est√° instalado localmente) e 213.248.1.6 (este √© do tech.ru). <br><br>  "Tabela eno1t" e "tabela eno2t" - o significado dessas regras de rota √© que o tr√°fego que passa por eno1 -&gt; passa por ele, e o tr√°fego que passa por eno2 -&gt; passa por ele.  E tamb√©m as conex√µes iniciadas pelo servidor passariam pelo eno1. <br><br><pre> <code class="bash hljs">ip route add default via XX.XX.XX.1 table eno1t</code> </pre> <br>  Com este comando, definimos que qualquer tr√°fego incompreens√≠vel que se enquadre em qualquer regra com a ‚Äútabela eno1t‚Äù marcada -&gt; envia para a interface eno1. <br><br><pre> <code class="bash hljs">ip route add XX.XX.XX.0/24 dev eno1 src XX.XX.XX.X0 table eno1t</code> </pre> <br>  Com este comando, definimos que direciona qualquer tr√°fego iniciado pelo servidor para a interface eno1. <br><br><pre> <code class="bash hljs">ip rule add table eno1t from XX.XX.XX.X0 ip rule add table eno1t to XX.XX.XX.X0</code> </pre> <br>  Com este comando, definimos as regras para marcar o tr√°fego por n√≥s mesmos. <br><br><pre> <code class="bash hljs">auto eno1:2 iface eno1:2 inet static address XX.XX.XX.X2 netmask 255.255.255.0 post-up ip rule add table eno1t from XX.XX.XX.X2 post-up ip rule add table eno1t to XX.XX.XX.X2</code> </pre> <br>  Este bloco define o segundo IPv4 para a interface eno1. <br><br><pre> <code class="bash hljs">ip route add 10.8.0.0/24 dev tun0 src XX.XX.XX.X1 table eno1t</code> </pre> <br>  Com este comando, definimos a rota dos clientes OpenVPN para o IPv4 local, exceto XX.XX.XX.X0. <br>  Por que esse comando √© suficiente para todos os IPv4 - eu ainda n√£o entendo. <br><br><pre> <code class="bash hljs">iface eno1 inet6 static address XXXX:XXXX:XXXX:XXXX:1:1::/64 gateway XXXX:XXXX:XXXX:XXXX::1</code> </pre> <br>  N√≥s definimos o endere√ßo para a pr√≥pria interface.  O servidor ir√° us√°-lo como um endere√ßo "de sa√≠da".  N√£o ser√° mais usado. <br><br>  Por que √© indicado ": 1: 1 ::" t√£o complicado?  Que o OpenVPN funcionou corretamente e somente para isso.  Mais sobre isso mais tarde. <br><br>  No t√≥pico gateway - √© assim que funciona.  Mas da maneira certa - aqui voc√™ deve especificar o comutador IPv6 ao qual o servidor est√° conectado. <br><br>  No entanto, por algum motivo, o IPv6 para de funcionar se eu fizer isso.  Talvez sejam alguns problemas do tech.ru. <br><br><pre> <code class="bash hljs">ip -6 addr add XXXX:XXXX:XXXX:XXXX:1:1:1:1/64 dev <span class="hljs-variable"><span class="hljs-variable">$IFACE</span></span></code> </pre> <br>  Isso est√° adicionando endere√ßos IPv6 √† interface.  Se voc√™ precisar de cem endere√ßos, significa cem linhas neste arquivo. <br><br><pre> <code class="bash hljs">iface eno1 inet6 static address XXXX:XXXX:XXXX:XXXX:1:1::/64 ... iface eno2 inet6 static address XXXX:XXXX:XXXX:XXXX:1:2::/96 ... iface tun0 inet6 static address XXXX:XXXX:XXXX:XXXX:1:3::/80</code> </pre> <br><blockquote>  Marcou os endere√ßos e sub-redes de todas as interfaces para que fique claro. <br>  eno1 - deve ser "/ 64" - porque esse √© todo o nosso conjunto de endere√ßos. <br>  tun0 - a sub-rede deve ser maior que eno1.  Caso contr√°rio, voc√™ n√£o poder√° configurar o gateway IPv6 para clientes OpenVPN. <br>  eno2 - a sub-rede deve ser maior que tun0.  Caso contr√°rio, os clientes OpenVPN n√£o poder√£o obter endere√ßos IPv6 locais. <br>  Para maior clareza, escolhi a etapa 16 da sub-rede, mas voc√™ pode at√© executar a etapa "1", se desejar. <br>  Por conseguinte, 64 + 16 = 80 e 80 + 16 = 96. <br><br>  Para maior clareza: <br>  XXXX: XXXX: XXXX: XXXX: 1: 1: AAAA: AAAA - s√£o endere√ßos que devem ser atribu√≠dos a sites ou servi√ßos espec√≠ficos na interface eno1. <br>  XXXX: XXXX: XXXX: XXXX: 1: 2: AAAA: AAAA - s√£o endere√ßos que devem ser atribu√≠dos a sites ou servi√ßos espec√≠ficos na interface eno2. <br>  XXXX: XXXX: XXXX: XXXX: 1: 3: AAAA: AAAA s√£o endere√ßos que devem ser atribu√≠dos aos clientes OpenVPN ou usados ‚Äã‚Äãcomo endere√ßos de servi√ßo OpenVPN. </blockquote><br><br>  Para configurar a rede - deve ser poss√≠vel reiniciar o servidor. <br>  As altera√ß√µes de IPv4 s√£o capturadas durante a execu√ß√£o (certifique-se de envolv√™-lo na tela - caso contr√°rio, este comando simplesmente soltar√° a rede no servidor): <br><br><pre> <code class="bash hljs">/etc/init.d/networking restart</code> </pre> <br>  No arquivo "/ etc / iproute2 / rt_tables", adicione no final: <br><br><pre> <code class="bash hljs">100 eno1t 101 eno2t</code> </pre> <br>  Sem isso, voc√™ n√£o pode usar tabelas personalizadas no arquivo "/ etc / network / interfaces". <br>  Os n√∫meros devem ser exclusivos e menores que 65535. <br><br>  As altera√ß√µes no IPv6 mudam facilmente sem a reinicializa√ß√£o, mas para isso voc√™ precisa aprender pelo menos tr√™s comandos: <br><br><pre> <code class="bash hljs">ip -6 addr ... ip -6 route ... ip -6 neigh ...</code> </pre> <br>  Configurando "/etc/sysctl.conf" <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Uncomment the next line to enable packet forwarding for IPv4 net.ipv4.ip_forward = 1 # Do not accept ICMP redirects (prevent MITM attacks) net.ipv4.conf.all.accept_redirects = 0 net.ipv6.conf.all.accept_redirects = 0 # Do not send ICMP redirects (we are not a router) net.ipv4.conf.all.send_redirects = 0 # For receiving ARP replies net.ipv4.conf.all.arp_filter = 0 net.ipv4.conf.default.arp_filter = 0 # For sending ARP net.ipv4.conf.all.arp_announce = 0 net.ipv4.conf.default.arp_announce = 0 # Enable IPv6 net.ipv6.conf.all.disable_ipv6 = 0 net.ipv6.conf.default.disable_ipv6 = 0 net.ipv6.conf.lo.disable_ipv6 = 0 # IPv6 configuration net.ipv6.conf.all.autoconf = 1 net.ipv6.conf.all.accept_ra = 0 # For OpenVPN net.ipv6.conf.all.forwarding = 1 net.ipv6.conf.all.proxy_ndp = 1 # For nginx on boot net.ipv6.ip_nonlocal_bind = 1</span></span></code> </pre> <br>  Essas s√£o as configura√ß√µes do sysctl do meu servidor.  Eu noto o importante. <br><br><pre> <code class="bash hljs">net.ipv4.ip_forward = 1</code> </pre> <br>  Sem isso, o OpenVPN n√£o funcionar√° de forma alguma. <br><br><pre> <code class="bash hljs">net.ipv6.ip_nonlocal_bind = 1</code> </pre> <br>  Qualquer pessoa que tentar vincular o IPv6 (por exemplo, nginx) logo ap√≥s a interface estar ativada receber√° um erro.  Que esse endere√ßo n√£o esteja dispon√≠vel. <br><br>  Para evitar tal situa√ß√£o, √© feita uma configura√ß√£o. <br><br><pre> <code class="bash hljs">net.ipv6.conf.all.forwarding = 1 net.ipv6.conf.all.proxy_ndp = 1</code> </pre> <br>  Sem essas configura√ß√µes de IPv6, o tr√°fego do cliente OpenVPN n√£o chega ao mundo. <br><br>  Outras configura√ß√µes s√£o irrelevantes ou n√£o me lembro por que s√£o. <br>  Mas por precau√ß√£o, deixo "como est√°". <br><br>  Para que as altera√ß√µes neste arquivo sejam detectadas sem a reinicializa√ß√£o do servidor, √© necess√°rio executar o comando: <br><br><pre> <code class="bash hljs">sysctl -p</code> </pre> <br>  Mais detalhes sobre as regras da "tabela": <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">habr.com/post/108690</a> <br><br><h2>  ============== OpenVPN ============== </h2><br>  O OpenVPN IPv4 n√£o funciona sem o iptables. <br><br>  Eu tenho estas tabelas de ip para VPN: <br><br><pre> <code class="bash hljs">iptables -A INPUT -p udp -s YY.YY.YY.YY --dport 1194 -j ACCEPT iptables -A FORWARD -i tun0 -o eno1 -j ACCEPT iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eno1 -j SNAT --to-source XX.XX.XX.X0 <span class="hljs-comment"><span class="hljs-comment">##iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eno1 -j MASQUERADE iptables -A FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT iptables -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT iptables -A INPUT -p udp --dport 1194 -j DROP iptables -A FORWARD -p udp --dport 1194 -j DROP</span></span></code> </pre> <br>  YY.YY.YY.YY √© o meu endere√ßo IPv4 est√°tico da m√°quina local. <br>  10.8.0.0/24 - rede IPv4 openvpn.  Endere√ßos IPv4 para clientes openvpn. <br>  A sequ√™ncia de regras √© importante. <br><br><pre> <code class="bash hljs">iptables -A INPUT -p udp -s YY.YY.YY.YY --dport 1194 -j ACCEPT iptables -A FORWARD -i tun0 -o eno1 -j ACCEPT ... iptables -A FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT iptables -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT iptables -A INPUT -p udp --dport 1194 -j DROP iptables -A FORWARD -p udp --dport 1194 -j DROP</code> </pre> <br>  Essa √© uma limita√ß√£o para que somente eu possa usar o OpenVPN do meu IP est√°tico. <br><br><pre> <code class="bash hljs">iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eno1 -j SNAT --to-source XX.XX.XX.X0 --  -- iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eno1 -j MASQUERADE</code> </pre> <br>  Para encaminhar pacotes IPv4 entre clientes OpenVPN e a Internet, √© necess√°rio registrar um desses comandos. <br><br>  Para casos diferentes, uma das op√ß√µes n√£o √© adequada. <br>  Ambas as equipes s√£o adequadas para o meu caso. <br>  Depois de ler a documenta√ß√£o, escolhi a primeira op√ß√£o, porque ela consome menos CPU. <br><br>  Para que todas as configura√ß√µes do iptables sejam selecionadas ap√≥s a reinicializa√ß√£o - voc√™ precisa salv√°-las em algum lugar. <br><br><pre> <code class="bash hljs">iptables-save &gt; /etc/iptables/rules.v4 ip6tables-save &gt; /etc/iptables/rules.v6</code> </pre> <br>  Tais nomes n√£o foram escolhidos por acaso.  O pacote iptables-persistent os utiliza. <br><br><pre> <code class="bash hljs">apt-get install iptables-persistent</code> </pre> <br>  Instalando o pacote principal do OpenVPN: <br><br><pre> <code class="bash hljs">apt-get install openvpn easy-rsa</code> </pre> <br>  Configure um modelo para certificados (substitua seus valores): <br><br><pre> <code class="bash hljs">make-cadir ~/openvpn-ca <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/openvpn-ca ln -s openssl-1.0.0.cnf openssl.cnf</code> </pre> <br>  Vamos editar as configura√ß√µes do modelo de certificado: <br><br><pre> <code class="bash hljs">mcedit vars</code> </pre> <br><pre> <code class="bash hljs">... <span class="hljs-comment"><span class="hljs-comment"># These are the default values for fields # which will be placed in the certificate. # Don't leave any of these fields blank. export KEY_COUNTRY="RU" export KEY_PROVINCE="Krasnodar" export KEY_CITY="Dinskaya" export KEY_ORG="Own" export KEY_EMAIL="admin@domain1.com" export KEY_OU="VPN" # X509 Subject Field export KEY_NAME="server" ...</span></span></code> </pre> <br>  Crie um certificado de servidor: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/openvpn-ca <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> vars ./clean-all ./build-ca ./build-key-server server ./build-dh openvpn --genkey --secret keys/ta.key</code> </pre> <br>  Vamos preparar a oportunidade para criar os arquivos "client-name.opvn" resultantes: <br><br><pre> <code class="bash hljs">mkdir -p ~/client-configs/files chmod 700 ~/client-configs/files cp /usr/share/doc/openvpn/examples/sample-config-files/client.conf ~/client-configs/base.conf mcedit ~/client-configs/base.conf</code> </pre> <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Client mode client # Interface tunnel type dev tun # TCP protocol proto tcp-client # Address/Port of VPN server remote XX.XX.XX.X0 1194 # Don't bind to local port/address nobind # Don't need to re-read keys and re-create tun at restart persist-key persist-tun # Remote peer must have a signed certificate remote-cert-tls server ns-cert-type server # Enable compression comp-lzo # Custom ns-cert-type server tls-auth ta.key 1 cipher DES-EDE3-CBC</span></span></code> </pre> <br>  Prepararemos um script que agrupar√° todos os arquivos em um √∫nico arquivo opvn. <br><br><pre> <code class="bash hljs">mcedit ~/client-configs/make_config.sh chmod 700 ~/client-configs/make_config.sh</code> </pre> <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash # First argument: Client identifier KEY_DIR=~/openvpn-ca/keys OUTPUT_DIR=~/client-configs/files BASE_CONFIG=~/client-configs/base.conf cat ${BASE_CONFIG} \ &lt;(echo -e '&lt;ca&gt;') \ ${KEY_DIR}/ca.crt \ &lt;(echo -e '&lt;/ca&gt;\n&lt;cert&gt;') \ ${KEY_DIR}/${1}.crt \ &lt;(echo -e '&lt;/cert&gt;\n&lt;key&gt;') \ ${KEY_DIR}/${1}.key \ &lt;(echo -e '&lt;/key&gt;\n&lt;tls-auth&gt;') \ ${KEY_DIR}/ta.key \ &lt;(echo -e '&lt;/tls-auth&gt;') \ &gt; ${OUTPUT_DIR}/${1}.ovpn</span></span></code> </pre> <br>  Criamos o primeiro cliente OpenVPN: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/openvpn-ca <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> vars ./build-key client-name <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/client-configs ./make_config.sh client-name</code> </pre> <br>  O arquivo "~ / client-configs / files / client-name.ovpn" √© enviado ao cliente. <br><br>  Para clientes iOS, voc√™ precisar√° executar o truque: <br>  O conte√∫do da tag tls-auth deve estar sem coment√°rios. <br>  E tamb√©m coloque "key-direction 1" imediatamente antes da tag "tls-auth". <br><br>  Configure a configura√ß√£o do servidor OpenVPN: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/openvpn-ca/keys cp ca.crt ca.key server.crt server.key ta.key dh2048.pem /etc/openvpn gunzip -c /usr/share/doc/openvpn/examples/sample-config-files/server.conf.gz | tee /etc/openvpn/server.conf mcedit /etc/openvpn/server.conf</code> </pre> <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Listen port port 1194 # Protocol proto tcp-server # IP tunnel dev tun0 tun-ipv6 push tun-ipv6 # Master certificate ca ca.crt # Server certificate cert server.crt # Server private key key server.key # Diffie-Hellman parameters dh dh2048.pem # Allow clients to communicate with each other client-to-client # Client config dir client-config-dir /etc/openvpn/ccd # Run client-specific script on connection and disconnection script-security 2 client-connect "/usr/bin/sudo -u root /etc/openvpn/server-clientconnect.sh" client-disconnect "/usr/bin/sudo -u root /etc/openvpn/server-clientdisconnect.sh" # Server mode and client subnets server 10.8.0.0 255.255.255.0 server-ipv6 X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">1:3::/80 topology subnet # IPv6 routes push "route-ipv6 X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">:/64" push "route-ipv6 2000::/3" # DNS (for Windows) # These are OpenDNS push "dhcp-option DNS 208.67.222.222" push "dhcp-option DNS 208.67.220.220" # Configure all clients to redirect their default network gateway through the VPN push "redirect-gateway def1 bypass-dhcp" push "redirect-gateway ipv6" #For iOS # Don't need to re-read keys and re-create tun at restart persist-key persist-tun # Ping every 10s. Timeout of 120s. keepalive 10 120 # Enable compression comp-lzo # User and group user vpn group vpn # Log a short status status openvpn-status.log # Logging verbosity ##verb 4 # Custom config tls-auth ta.key 0 cipher DES-EDE3-CBC</span></span></code> </pre> <br>  Isso √© necess√°rio para definir um endere√ßo est√°tico para cada cliente (n√£o √© necess√°rio, mas eu uso): <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Client config dir client-config-dir /etc/openvpn/ccd</span></span></code> </pre> <br>  Os detalhes mais dif√≠ceis e importantes. <br><br>  Infelizmente, o OpenVPN ainda n√£o √© capaz de configurar independentemente o gateway IPv6 para clientes. <br>  Temos que encaminhar isso manualmente para cada cliente. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Run client-specific script on connection and disconnection script-security 2 client-connect "/usr/bin/sudo -u root /etc/openvpn/server-clientconnect.sh" client-disconnect "/usr/bin/sudo -u root /etc/openvpn/server-clientdisconnect.sh"</span></span></code> </pre> <br>  Arquivo "/etc/openvpn/server-clientconnect.sh": <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh # Check client variables if [ -z "$ifconfig_pool_remote_ip" ] || [ -z "$common_name" ]; then echo "Missing environment variable." exit 1 fi # Load server variables . /etc/openvpn/variables ipv6="" # Find out if there is a specific config with fixed IPv6 for this client if [ -f "/etc/openvpn/ccd/$common_name" ]; then # Get fixed IPv6 from client config file ipv6=$(sed -nr 's/^.*ifconfig-ipv6-push[ \t]+([0-9a-fA-F\\:]+).*$/\1/p' "/etc/openvpn/ccd/$common_name") echo $ipv6 fi # Get IPv6 from IPv4 if [ -z "$ipv6" ]; then ipp=$(echo "$ifconfig_pool_remote_ip" | cut -d. -f4) if ! [ "$ipp" -ge 2 -a "$ipp" -le 254 ] 2&gt;/dev/null; then echo "Invalid IPv4 part." exit 1 fi hexipp=$(printf '%x' $ipp) ipv6="$prefix$hexipp" fi # Create proxy rule /sbin/ip -6 neigh add proxy $ipv6 dev eno1</span></span></code> </pre> <br><br>  Arquivo "/etc/openvpn/server-clientdisconnect.sh": <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh # Check client variables if [ -z "$ifconfig_pool_remote_ip" ] || [ -z "$common_name" ]; then echo "Missing environment variable." exit 1 fi # Load server variables . /etc/openvpn/variables ipv6="" # Find out if there is a specific config with fixed IPv6 for this client if [ -f "/etc/openvpn/ccd/$common_name" ]; then # Get fixed IPv6 from client config file ipv6=$(sed -nr 's/^.*ifconfig-ipv6-push[ \t]+([0-9a-fA-F\\:]+).*$/\1/p' "/etc/openvpn/ccd/$common_name") fi # Get IPv6 from IPv4 if [ -z "$ipv6" ]; then ipp=$(echo "$ifconfig_pool_remote_ip" | cut -d. -f4) if ! [ "$ipp" -ge 2 -a "$ipp" -le 254 ] 2&gt;/dev/null; then echo "Invalid IPv4 part." exit 1 fi hexipp=$(printf '%x' $ipp) ipv6="$prefix$hexipp" fi # Delete proxy rule /sbin/ip -6 neigh del proxy $ipv6 dev eno1</span></span></code> </pre> <br>  Ambos os scripts usam o arquivo "/ etc / openvpn / variables": <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Subnet prefix=X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">2: # netmask prefixlen=112</span></span></code> </pre> <br>  Por que est√° escrito aqui - acho dif√≠cil lembrar. <br><br>  Agora parece netmask estranho = 112 (deve haver 96). <br>  E o prefixo √© estranho, n√£o corresponde √† rede tun0. <br>  Mas tudo bem, deixo "como est√°". <br><br><pre> <code class="bash hljs">cipher DES-EDE3-CBC</code> </pre> <br>  Isso √© amador - eu escolhi esse m√©todo de criptografar a conex√£o. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Mais sobre como configurar o OpenVPN IPv4.</a> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Mais sobre como configurar o OpenVPN IPv6.</a> <br><br><h2>  ============== Postfix ============== </h2><br>  Instalando o pacote principal: <br><br><pre> <code class="bash hljs">apt-get install postfix</code> </pre> <br>  Ao instalar, selecione "site da internet". <br><br>  Meu "/etc/postfix/main.cf" fica assim: <br><br><pre> <code class="bash hljs">smtpd_banner = <span class="hljs-variable"><span class="hljs-variable">$myhostname</span></span> ESMTP <span class="hljs-variable"><span class="hljs-variable">$mail_name</span></span> (Debian/GNU) biff = no <span class="hljs-comment"><span class="hljs-comment"># appending .domain is the MUA's job. append_dot_mydomain = no readme_directory = no # See http://www.postfix.org/COMPATIBILITY_README.html -- default to 2 on # fresh installs. compatibility_level = 2 # TLS parameters smtpd_tls_cert_file=/etc/ssl/domain1.com.2018.chained.crt smtpd_tls_key_file=/etc/ssl/domain1.com.2018.key smtpd_use_tls=yes smtpd_tls_auth_only = yes smtp_bind_address = XX.XX.XX.X0 smtp_bind_address6 = X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">1:1:1:1 smtp_tls_security_level = may smtp_tls_ciphers = export smtp_tls_protocols = !SSLv2, !SSLv3 smtp_tls_loglevel = 1 smtpd_relay_restrictions = permit_mynetworks permit_sasl_authenticated defer_unauth_destination myhostname = domain1.com alias_maps = hash:/etc/aliases alias_database = hash:/etc/aliases myorigin = domain1.com mydestination = localhost relayhost = mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128 mailbox_size_limit = 0 recipient_delimiter = + inet_interfaces = all inet_protocols = ipv4 internal_mail_filter_classes = bounce # Storage type virtual_transport = lmtp:unix:private/dovecot-lmtp virtual_mailbox_domains = mysql:/etc/postfix/mysql-virtual-mailbox-domains.cf virtual_mailbox_maps = mysql:/etc/postfix/mysql-virtual-mailbox-maps.cf virtual_alias_maps = mysql:/etc/postfix/mysql-virtual-alias-maps.cf # SMTP-Auth settings smtpd_sasl_type = dovecot smtpd_sasl_path = private/auth smtpd_sasl_auth_enable = yes smtpd_recipient_restrictions = permit_sasl_authenticated, permit_mynetworks, #reject_invalid_hostname, #reject_unknown_recipient_domain, reject_unauth_destination, reject_rbl_client sbl.spamhaus.org, check_policy_service unix:private/policyd-spf smtpd_helo_restrictions = #reject_invalid_helo_hostname, #reject_non_fqdn_helo_hostname, reject_unknown_helo_hostname smtpd_client_restrictions = permit_mynetworks, permit_sasl_authenticated, reject_non_fqdn_helo_hostname, permit # SPF policyd-spf_time_limit = 3600 # OpenDKIM milter_default_action = accept milter_protocol = 6 smtpd_milters = unix:var/run/opendkim/opendkim.sock non_smtpd_milters = unix:var/run/opendkim/opendkim.sock # IP address per domain sender_dependent_default_transport_maps = pcre:/etc/postfix/sdd_transport.pcre</span></span></code> </pre> <br>  Vamos considerar os detalhes dessa configura√ß√£o. <br><br><pre> <code class="bash hljs">smtpd_tls_cert_file=/etc/ssl/domain1.com.2018.chained.crt smtpd_tls_key_file=/etc/ssl/domain1.com.2018.key</code> </pre> <br><br><hr><blockquote><div class="spoiler">  <b class="spoiler_title">Segundo os cidad√£os de Khabrovsk, este bloco cont√©m "desinforma√ß√£o e falsas teses".</b> <div class="spoiler_text">  Apenas 8 anos ap√≥s o in√≠cio da minha carreira, comecei a entender como o SSL funciona. <br><br>  Portanto, terei a liberdade de descrever como usar o SSL (sem responder √†s perguntas ‚ÄúComo funciona?‚Äù E ‚ÄúPor que funciona?‚Äù). <br><br>  A base da criptografia moderna √© a cria√ß√£o de um par de chaves (duas linhas muito longas de caracteres). <br><br>  Uma "chave" √© privada, a outra √© "p√∫blica".  Mantemos a chave privada com muito cuidado em segredo.  Distribu√≠mos a chave p√∫blica para todos. <br><br>  Usando uma chave p√∫blica, voc√™ pode criptografar uma sequ√™ncia de texto para que somente o propriet√°rio da chave privada possa descriptografar. <br>  Bem, essa √© toda a base da tecnologia. <br><br>  Etapa 1 - sites https. <br>  Ao acessar o site, o navegador descobre pelo servidor da Web que o site √© https e, portanto, solicita uma chave p√∫blica. <br>  O servidor da web fornece a chave p√∫blica.  Usando a chave p√∫blica, o navegador criptografa a solicita√ß√£o http e a envia. <br>  O conte√∫do da solicita√ß√£o http pode ser lido somente por algu√©m que tenha uma chave privada, ou seja, apenas o servidor para o qual a chamada √© feita. <br>  A solicita√ß√£o HTTP cont√©m pelo menos um URI.  Portanto, se o pa√≠s est√° tentando restringir o acesso n√£o a todo o site, mas a uma p√°gina espec√≠fica, para sites https, isso n√£o pode ser feito. <br><br>  Etapa 2 √© a resposta criptografada. <br>  O servidor da web fornece uma resposta que pode ser facilmente lida ao longo do caminho. <br>  A solu√ß√£o √© extremamente simples - o navegador gera localmente o mesmo par de chaves p√∫blico-privado para cada site https. <br>  E junto com a solicita√ß√£o da chave p√∫blica do site, ele envia sua chave p√∫blica local. <br>  O servidor da Web se lembra dele e, ao enviar a resposta http, ele criptografa com essa chave p√∫blica de um cliente espec√≠fico. <br>  Agora, a resposta http s√≥ pode ser descriptografada pelo propriet√°rio da chave privada do navegador do cliente (ou seja, o pr√≥prio cliente). <br><br>  Etapa n√∫mero 3 - estabele√ßa uma conex√£o segura atrav√©s de um canal p√∫blico. <br>  No exemplo n ¬∞ 2, existe uma vulnerabilidade - nada impede que os bem-intencionados interceptem a solicita√ß√£o http e editem as informa√ß√µes da chave p√∫blica. <br>  Assim, o intermedi√°rio ver√° quase todo o conte√∫do das mensagens enviadas e recebidas at√© que o canal de comunica√ß√£o mude. <br>  Combater isso √© extremamente simples - basta enviar a chave p√∫blica do navegador como uma mensagem criptografada com a chave p√∫blica do servidor da web. <br>  O servidor da Web envia, em primeiro lugar, uma resposta como "sua chave p√∫blica √© assim" e criptografa essa mensagem com a mesma chave p√∫blica. <br>  O navegador procura a resposta - se a mensagem "sua chave p√∫blica √© assim" √© recebida -, isso √© uma garantia de 100% de que esse canal de comunica√ß√£o √© seguro. <br>  Qu√£o seguro √© isso? <br>  A cria√ß√£o desse canal de comunica√ß√£o seguro ocorre em uma velocidade ping * 2.  Por exemplo, 20ms. <br>  Um invasor deve ter uma chave privada de uma das partes com anteced√™ncia.  Ou escolha uma chave privada por alguns milissegundos. <br>  Hackear uma chave privada moderna levar√° d√©cadas em um supercomputador. <br><br>  Etapa # 4 - banco de dados p√∫blico de chaves p√∫blicas. <br>  Obviamente, nesta hist√≥ria toda, existe a possibilidade de um invasor sentado no canal de comunica√ß√£o entre o cliente e o servidor. <br>  A oportunidade para o cliente √© apresentada pelo servidor e para o servidor a ser apresentado pelo cliente.  E emule um par de chaves nas duas dire√ß√µes. <br>  Em seguida, o invasor ver√° todo o tr√°fego e poder√° "editar" o tr√°fego. <br>  Por exemplo, altere o endere√ßo para onde enviar dinheiro ou copie a senha do banco online ou bloqueie o conte√∫do "censur√°vel". <br>  Para combater esses invasores, eles criaram um banco de dados p√∫blico com chaves p√∫blicas para cada site https. <br>  Cada navegador "sabe" sobre a exist√™ncia de cerca de 200 desses bancos de dados.  Isso √© pr√©-instalado em todos os navegadores. <br>  O "conhecimento" √© copiado por uma chave p√∫blica para cada certificado.  Ou seja, √© imposs√≠vel falsificar uma conex√£o com cada autoridade de certifica√ß√£o espec√≠fica. <br><br>  Agora, existe um entendimento simples de como usar o SSL para https. <br>  Se voc√™ mexer o c√©rebro, ficar√° claro como os servi√ßos especiais podem quebrar algo nesse design.  Mas isso lhes custar√° enormes esfor√ßos. <br>  E organiza√ß√µes menores que a NSA ou a CIA - √© quase imposs√≠vel decifrar o n√≠vel de prote√ß√£o existente, mesmo para vip. <br><br>  Tamb√©m adicionarei sobre conex√µes ssh.  N√£o h√° chaves p√∫blicas, o que fazer.  A quest√£o √© resolvida de duas maneiras. <br>  Op√ß√£o de senha ssh: <br>  Na primeira conex√£o, o cliente ssh deve avisar que aqui temos uma nova chave p√∫blica do servidor ssh. <br>  E com outras conex√µes, se o aviso "uma nova chave p√∫blica do servidor ssh" aparecer, significa que eles est√£o tentando ouvi-lo. <br>  Ou na primeira conex√£o que voc√™ ouviu, e agora voc√™ est√° conversando com o servidor sem intermedi√°rios. <br>  Na verdade, devido ao fato de o fato de as escutas telef√¥nicas serem reveladas com facilidade, rapidez e facilidade, esse ataque √© usado apenas em casos especiais para um cliente espec√≠fico. <br><br>  Op√ß√£o chave ssh: <br>  Tomamos uma unidade flash, escrevemos uma chave privada para o servidor ssh (para isso existem termos e v√°rias nuances significativas, mas estou escrevendo um programa educacional, n√£o instru√ß√µes de uso). <br>  Deixamos a chave p√∫blica na m√°quina onde o cliente ssh estar√° e tamb√©m a mantemos em segredo. <br>  Trazemos a unidade flash para o servidor, inserimos, copiamos a chave privada, queimamos a unidade flash e espalhamos a poeira pelo vento (ou pelo menos formata-a com zeros). <br>  Isso √© tudo - ap√≥s uma opera√ß√£o desse tipo, ser√° imposs√≠vel quebrar uma conex√£o ssh.  Obviamente, em 10 anos voc√™ pode ver o tr√°fego em um supercomputador - mas essa √© uma hist√≥ria diferente. <br><br>  Pe√ßo desculpas pelo offtopic. <br></div></div></blockquote>  Ent√£o agora que a teoria √© conhecida.  Vou falar sobre o fluxo de cria√ß√£o de um certificado SSL. <br><br>  Usando "openssl genrsa", criamos uma chave privada e "espa√ßos em branco" para a chave p√∫blica. <br>  Enviamos os "espa√ßos em branco" para uma empresa terceirizada, √† qual pagamos aproximadamente US $ 9 pelo certificado mais simples. <br><br>  Em algumas horas, recebemos dessa empresa terceirizada nossa chave "p√∫blica" e outro conjunto de v√°rias chaves p√∫blicas. <br><br>  Por que uma empresa terceirizada deve pagar pela emiss√£o da minha chave p√∫blica - uma quest√£o separada, que n√£o consideraremos aqui. <br><br>  Agora est√° claro qual √© o significado da inscri√ß√£o: <br><br><pre> <code class="plaintext hljs">smtpd_tls_key_file=/etc/ssl/domain1.com.2018.key</code> </pre> <br>  Na pasta "/ etc / ssl", todos os arquivos para perguntas sobre ssl s√£o armazenados. <br>  domain1.com - nome de dom√≠nio. <br>  2018 √© o ano da cria√ß√£o das chaves. <br>  "Chave" - ‚Äã‚Äãdesigna√ß√£o de que o arquivo √© chave privada. <br><br>  E o significado deste arquivo: <br><br>  smtpd_tls_cert_file = / etc / ssl / domain1.com.2018.chained.crt <br>  domain1.com - nome de dom√≠nio. <br>  2018 √© o ano da cria√ß√£o das chaves. <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">encadeado - uma designa√ß√£o de que existe uma cadeia de chaves p√∫blicas (a primeira √© a nossa chave p√∫blica e o restante √© o que veio da empresa que emitiu a chave p√∫blica). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">crt - designa√ß√£o de que existe um certificado pronto (chave p√∫blica com explica√ß√µes t√©cnicas).</font></font><br><br><pre> <code class="bash hljs">smtp_bind_address = XX.XX.XX.X0 smtp_bind_address6 = XXXX:XXXX:XXXX:XXXX:1:1:1:1</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Essa configura√ß√£o n√£o √© usada neste caso, mas √© escrita como um exemplo. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Porque um erro neste par√¢metro levar√° ao envio de spam do seu servidor (sem sua vontade). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ent√£o prove a todos que voc√™ n√£o √© o culpado.</font></font><br><br><pre> <code class="bash hljs">recipient_delimiter = +</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Talvez muitos n√£o saibam, portanto esse √© um s√≠mbolo padr√£o para pastoreio, e isso √© suportado pela maioria dos servidores de correio modernos. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por exemplo, se voc√™ tiver uma caixa de correio "nomedeusu√°rio@gmail.com", tente envi√°-la para "nomedeusu√°rio+spam@gmail.com" - veja o que acontece.</font></font><br><br><pre> <code class="bash hljs">inet_protocols = ipv4</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Talvez isso seja confuso. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mas isso n√£o √© justo. </font><font style="vertical-align: inherit;">Cada novo dom√≠nio √©, por padr√£o, apenas IPv4, ent√£o habilito o IPv6 para cada um individualmente.</font></font><br><br><pre> <code class="bash hljs">virtual_transport = lmtp:unix:private/dovecot-lmtp virtual_mailbox_domains = mysql:/etc/postfix/mysql-virtual-mailbox-domains.cf virtual_mailbox_maps = mysql:/etc/postfix/mysql-virtual-mailbox-maps.cf virtual_alias_maps = mysql:/etc/postfix/mysql-virtual-alias-maps.cf</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aqui, definimos que todo o correio recebido vai para dovecot. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">E as regras para dom√≠nio, caixa de correio, alias - procure no banco de dados. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/postfix/mysql-virtual-mailbox-domains.cf</font></font><br><br><pre> <code class="bash hljs">user = usermail password = mailpassword hosts = 127.0.0.1 dbname = servermail query = SELECT 1 FROM virtual_domains WHERE name=<span class="hljs-string"><span class="hljs-string">'%s'</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> /etc/postfix/mysql-virtual-mailbox-maps.cf </font></font><br><br><pre> <code class="bash hljs">user = usermail password = mailpassword hosts = 127.0.0.1 dbname = servermail query = SELECT 1 FROM virtual_users WHERE email=<span class="hljs-string"><span class="hljs-string">'%s'</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> /etc/postfix/mysql-virtual-alias-maps.cf </font></font><br><br><pre> <code class="bash hljs">user = usermail password = mailpassword hosts = 127.0.0.1 dbname = servermail query = SELECT destination FROM virtual_aliases WHERE <span class="hljs-built_in"><span class="hljs-built_in">source</span></span>=<span class="hljs-string"><span class="hljs-string">'%s'</span></span></code> </pre> <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># SMTP-Auth settings smtpd_sasl_type = dovecot smtpd_sasl_path = private/auth smtpd_sasl_auth_enable = yes</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Agora, o postfix sabe que voc√™ s√≥ pode aceitar e-mails para envio posterior por autoriza√ß√£o com dovecot. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Realmente n√£o entendo por que isso √© duplicado aqui. </font><font style="vertical-align: inherit;">J√° indicamos no virtual_transport tudo o que √© necess√°rio. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mas o sistema postfix √© muito antigo - provavelmente s√£o os castelos dos tempos antigos.</font></font><br><br><pre> <code class="bash hljs">smtpd_recipient_restrictions = ... smtpd_helo_restrictions = ... smtpd_client_restrictions = ...</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Isso √© configurado para cada servidor de correio √† sua maneira. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tenho 3 servidores de correio √† minha disposi√ß√£o e essas configura√ß√µes s√£o muito diferentes devido a diferentes requisitos de uso. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voc√™ deve configurar com cuidado - caso contr√°rio, o spam o inundar√° ou pior, o spam o inundar√°.</font></font><br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># SPF policyd-spf_time_limit = 3600</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Configurando para algum tipo de plugin relacionado √† verifica√ß√£o do SPF das mensagens recebidas. </font></font><br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># OpenDKIM milter_default_action = accept milter_protocol = 6 smtpd_milters = unix:var/run/opendkim/opendkim.sock non_smtpd_milters = unix:var/run/opendkim/opendkim.sock</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Configurando que todas as cartas enviadas devemos fornecer uma assinatura DKIM. </font></font><br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># IP address per domain sender_dependent_default_transport_maps = pcre:/etc/postfix/sdd_transport.pcre</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Este √© um detalhe importante no roteamento de email ao enviar emails de scripts php. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arquivo "/etc/postfix/sdd_transport.pcre":</font></font><br><br><pre> <code class="bash hljs">/^www-domain1@domain1\.com$/ domain1: /^www-domain2@domain1\.com$/ domain2: /^www-domain3@domain1\.com$/ domain3: /@domain1\.com$/ domain1: /@domain2\.com$/ domain2: /@domain3\.com$/ domain3:</code> </pre> <br><blockquote>  ‚Äî  .  ‚Äî ,   . <br> Postfix     ‚Äî        . <br><br>     postfix    ‚Äî    ¬´master.cf¬ª. <br><br>  4, 5, 6 ‚Äî  .       ‚Äî    . <br>     php       ¬´from¬ª.      . <br><br>     ‚Äî       nginx+fpm. <br><br>  ‚Äî       linux-user .    fpm-pool. <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O Fpm-pool usa qualquer vers√£o do php (isso √© √≥timo quando voc√™ pode usar uma vers√£o diferente do php e at√© mesmo um php.ini diferente no mesmo servidor para sites vizinhos). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Portanto, um usu√°rio do Linux em particular, "www-domain2", tem um site domain2.com. </font><font style="vertical-align: inherit;">Este site possui um c√≥digo para enviar cartas sem especificar o campo de. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Portanto, mesmo nesse caso, as cartas desaparecer√£o corretamente e nunca entrar√£o em spam.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Meu "/etc/postfix/master.cf" fica assim: </font></font><br><br><pre> <code class="bash hljs">... smtp inet n - y - - smtpd -o content_filter=spamassassin ... submission inet n - y - - smtpd -o syslog_name=postfix/submission -o smtpd_tls_security_level=encrypt -o smtpd_sasl_auth_enable=yes -o smtpd_client_restrictions=permit_sasl_authenticated,reject ... policyd-spf unix - nn - 0 spawn user=policyd-spf argv=/usr/bin/policyd-spf spamassassin unix - nn - - pipe user=spamd argv=/usr/bin/spamc -f -e /usr/sbin/sendmail -oi -f <span class="hljs-variable"><span class="hljs-variable">${sender}</span></span> <span class="hljs-variable"><span class="hljs-variable">${recipient}</span></span> ... domain1 unix - - n - - smtp -o smtp_bind_address=XX.XX.XX.X1 -o smtp_helo_name=domain1.com -o inet_protocols=all -o smtp_bind_address6=XXXX:XXXX:XXXX:XXXX:1:1:1:1 -o syslog_name=postfix-domain1 domain2 unix - - n - - smtp -o smtp_bind_address=XX.XX.XX.X5 -o smtp_helo_name=domain2.com -o inet_protocols=all -o smtp_bind_address6=XXXX:XXXX:XXXX:XXXX:1:2:1:1 -o syslog_name=postfix-domain2 domain3 unix - - n - - smtp -o smtp_bind_address=XX.XX.XX.X2 -o smtp_helo_name=domain3 -o inet_protocols=all -o smtp_bind_address6=XXXX:XXXX:XXXX:XXXX:1:1:5:1 -o syslog_name=postfix-domain3</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O arquivo n√£o √© completamente fornecido - ele j√° √© muito grande. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Observou apenas o que foi alterado.</font></font><br><br><pre> <code class="bash hljs">smtp inet n - y - - smtpd -o content_filter=spamassassin ... spamassassin unix - nn - - pipe user=spamd argv=/usr/bin/spamc -f -e /usr/sbin/sendmail -oi -f <span class="hljs-variable"><span class="hljs-variable">${sender}</span></span> <span class="hljs-variable"><span class="hljs-variable">${recipient}</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Estas s√£o as configura√ß√µes relacionadas ao spamassasin, sobre isso mais tarde. </font></font><br><br><pre> <code class="bash hljs">submission inet n - y - - smtpd -o syslog_name=postfix/submission -o smtpd_tls_security_level=encrypt -o smtpd_sasl_auth_enable=yes -o smtpd_client_restrictions=permit_sasl_authenticated,reject</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Permitimos que voc√™ se conecte ao servidor de correio pela porta 587. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para fazer isso, certifique-se de fazer login.</font></font><br><br><pre> <code class="bash hljs">policyd-spf unix - nn - 0 spawn user=policyd-spf argv=/usr/bin/policyd-spf</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ative a verifica√ß√£o do SPF. </font></font><br><br><pre> <code class="bash hljs">apt-get install postfix-policyd-spf-python</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Instale o pacote para verifica√ß√µes do SPF acima. </font></font><br><br><pre> <code class="bash hljs">domain1 unix - - n - - smtp -o smtp_bind_address=XX.XX.XX.X1 -o smtp_helo_name=domain1.com -o inet_protocols=all -o smtp_bind_address6=XXXX:XXXX:XXXX:XXXX:1:1:1:1 -o syslog_name=postfix-domain1</code> </pre> <br><blockquote>    .          IPv4/IPv6 . <br><br>    rDNS. rDNS ‚Äî   -   IP . <br>         ,  helo   rDNS  ,    email. <br><br>  helo    ,      ‚Äî   . <br><br> Helo   rDNS ‚Äî    . <br>        IP . <br>  OVH ‚Äî      rDNS. <br>  tech.ru ‚Äî    . <br>  AWS ‚Äî    . <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Inet_protocols" e "smtp_bind_address6" - √© assim que habilitamos o suporte ao IPv6. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para o IPv6, voc√™ tamb√©m precisa registrar o rDNS. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Syslog_name" - e √© para a conveni√™ncia de ler logs.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eu </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">recomendo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> comprar certificados </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">aqui</font></a><font style="vertical-align: inherit;"> . </font></font><br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configurando um monte de postfix + dovecot aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configura√ß√£o do SPF.</font></font></a> <br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ============== Pombal ============== </font></font></h2><br><pre> <code class="bash hljs">apt-get install dovecot-imapd dovecot-pop3d dovecot-lmtpd dovecot-mysql dovecot-antispam</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configure o mysql, instale os pr√≥prios pacotes. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arquivo "/etc/dovecot/conf.d/10-auth.conf"</font></font><br><br><pre> <code class="bash hljs">disable_plaintext_auth = yes auth_mechanisms = plain login</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A autoriza√ß√£o √© apenas criptografada. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arquivo "/etc/dovecot/conf.d/10-mail.conf"</font></font><br><br><pre> <code class="bash hljs">mail_location = maildir:/var/mail/vhosts/%d/%n</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aqui indicamos a localiza√ß√£o das letras. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quero que eles sejam armazenados em arquivos e agrupados por dom√≠nio. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arquivo "/etc/dovecot/conf.d/10-master.conf"</font></font><br><br><pre> <code class="bash hljs">service imap-login { inet_listener imap { port = 0 } inet_listener imaps { address = XX.XX.XX.X1, XX.XX.XX.X2, XX.XX.XX.X5, [XXXX:XXXX:XXXX:XXXX:1:1:1:1], [XXXX:XXXX:XXXX:XXXX:1:2:1:1], [XXXX:XXXX:XXXX:XXXX:1:1:5:1] port = 993 ssl = yes } } service pop3-login { inet_listener pop3 { port = 0 } inet_listener pop3s { address = XX.XX.XX.X1, XX.XX.XX.X2, XX.XX.XX.X5, [XXXX:XXXX:XXXX:XXXX:1:1:1:1], [XXXX:XXXX:XXXX:XXXX:1:2:1:1], [XXXX:XXXX:XXXX:XXXX:1:1:5:1] port = 995 ssl = yes } } service lmtp { unix_listener /var/spool/postfix/private/dovecot-lmtp { mode = 0600 user = postfix group = postfix } } service imap { } service pop3 { } service auth { unix_listener auth-userdb { mode = 0600 user = vmail } unix_listener /var/spool/postfix/private/auth { mode = 0666 user = postfix group = postfix } user = dovecot } service auth-worker { user = vmail } service dict { unix_listener dict { } }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Este √© o principal arquivo de configura√ß√µes dovecot. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aqui desconectamos conex√µes n√£o seguras. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">E habilite conex√µes seguras. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arquivo "/etc/dovecot/conf.d/10-ssl.conf"</font></font><br><br><pre> <code class="bash hljs">ssl = required ssl_cert = &lt;/etc/nginx/ssl/domain1.com.2018.chained.crt ssl_key = &lt;/etc/nginx/ssl/domain1.com.2018.key <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> XX.XX.XX.X5 { ssl_cert = &lt;/etc/nginx/ssl/domain2.com.2018.chained.crt ssl_key = &lt;/etc/nginx/ssl/domain2.com.2018.key }</code> </pre> <br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configure ssl. </font><font style="vertical-align: inherit;">Indicamos que o ssl √© necess√°rio. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">E o pr√≥prio certificado. </font><font style="vertical-align: inherit;">E um detalhe importante √© a diretiva "local". </font><font style="vertical-align: inherit;">Indica ao conectar-se a qual IPv4 local - qual certificado SSL usar. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A prop√≥sito, o IPv6 n√£o est√° configurado aqui, corrigirei essa omiss√£o como um thread posteriormente. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">XX.XX.XX.X5 (dom√≠nio2) - sem certificado. </font><font style="vertical-align: inherit;">Para conectar clientes, voc√™ deve especificar domain1.com. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">XX.XX.XX.X2 (dom√≠nio3) - existe um certificado, voc√™ pode especificar domain1.com ou domain3.com para conectar clientes.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Arquivo "/etc/dovecot/conf.d/15-lda.conf" </font></font><br><br><pre> <code class="bash hljs">protocol lda { mail_plugins = <span class="hljs-variable"><span class="hljs-variable">$mail_plugins</span></span> sieve }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Isso ser√° necess√°rio no futuro para spamassassin. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arquivo "/etc/dovecot/conf.d/20-imap.conf"</font></font><br><br><pre> <code class="bash hljs">protocol imap { mail_plugins = <span class="hljs-variable"><span class="hljs-variable">$mail_plugins</span></span> antispam }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Este √© um plugin antispam. </font><font style="vertical-align: inherit;">√â necess√°rio treinar spamassasin no momento da transfer√™ncia de / para a pasta Spam. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arquivo "/etc/dovecot/conf.d/20-pop3.conf"</font></font><br><br><pre> <code class="bash hljs">protocol pop3 { }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apenas esse arquivo √©. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arquivo "/etc/dovecot/conf.d/20-lmtp.conf"</font></font><br><br><pre> <code class="bash hljs">protocol lmtp { mail_plugins = <span class="hljs-variable"><span class="hljs-variable">$mail_plugins</span></span> sieve postmaster_address = admin@domain1.com }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configure lmtp. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arquivo "/etc/dovecot/conf.d/90-antispam.conf"</font></font><br><br><pre> <code class="bash hljs">plugin { antispam_backend = pipe antispam_trash = Trash;trash antispam_spam = Junk;Spam;SPAM antispam_pipe_program_spam_arg = --spam antispam_pipe_program_notspam_arg = --ham antispam_pipe_program = /usr/bin/sa-learn antispam_pipe_program_args = --username=%Lu }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configura√ß√µes de treinamento da Spamassasin no momento da transfer√™ncia de / para a pasta Spam. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arquivo "/etc/dovecot/conf.d/90-sieve.conf"</font></font><br><br><pre> <code class="bash hljs">plugin { sieve = ~/.dovecot.sieve sieve_dir = ~/sieve sieve_after = /var/lib/dovecot/sieve/default.sieve }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um arquivo que indica o que fazer com os e-mails recebidos. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arquivo "/var/lib/dovecot/sieve/default.sieve"</font></font><br><br><pre> <code class="bash hljs">require [<span class="hljs-string"><span class="hljs-string">"fileinto"</span></span>, <span class="hljs-string"><span class="hljs-string">"mailbox"</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> header :contains <span class="hljs-string"><span class="hljs-string">"X-Spam-Flag"</span></span> <span class="hljs-string"><span class="hljs-string">"YES"</span></span> { fileinto :create <span class="hljs-string"><span class="hljs-string">"Spam"</span></span>; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√â necess√°rio compilar o arquivo: "sievec default.sieve". </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arquivo "/etc/dovecot/conf.d/auth-sql.conf.ext"</font></font><br><br><pre> <code class="bash hljs">passdb { driver = sql args = /etc/dovecot/dovecot-sql.conf.ext } userdb { driver = static args = uid=vmail gid=vmail home=/var/mail/vhosts/%d/%n }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Especificando arquivos sql para autoriza√ß√£o. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">E o pr√≥prio arquivo √© uma forma de autoriza√ß√£o. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arquivo "/etc/dovecot/dovecot-sql.conf.ext"</font></font><br><br><pre> <code class="bash hljs">driver = mysql connect = host=127.0.0.1 dbname=servermail user=usermail password=password default_pass_scheme = SHA512-CRYPT password_query = SELECT email as user, password FROM virtual_users WHERE email=<span class="hljs-string"><span class="hljs-string">'%u'</span></span>;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Isso corresponde √†s mesmas configura√ß√µes do postfix. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arquivo "/etc/dovecot/dovecot.conf"</font></font><br><pre> <code class="bash hljs">protocols = imap lmtp pop3 listen = *, :: dict { } !include conf.d/*.conf !include_try local.conf</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O arquivo de configura√ß√£o principal. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O importante √© que especificemos aqui, adicione protocolos.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ============== SpamAssassin ============== </font></font></h2><br><pre> <code class="bash hljs">apt-get install spamassassin spamc</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Instale os pacotes. </font></font><br><br><pre> <code class="bash hljs">adduser spamd --disabled-login</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Adicione um usu√°rio em nome de quem. </font></font><br><br><pre> <code class="bash hljs">systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> spamassassin.service</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ative o servi√ßo de spamassassin de download autom√°tico na inicializa√ß√£o. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arquivo "/ etc / default / spamassassin":</font></font><br><br><pre> <code class="bash hljs">CRON=1</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ative a atualiza√ß√£o autom√°tica de regras por padr√£o. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arquivo "/etc/spamassassin/local.cf":</font></font><br><br><pre> <code class="bash hljs">report_safe 0 use_bayes 1 bayes_auto_learn 1 bayes_auto_expire 1 bayes_store_module Mail::SpamAssassin::BayesStore::MySQL bayes_sql_dsn DBI:mysql:sa:localhost:3306 bayes_sql_username sa bayes_sql_password password</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√â necess√°rio tornar o banco de dados "sa" no mysql com o usu√°rio "sa" com a senha "password" (substitua por algo adequado). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">report_safe - em vez de uma carta, um relat√≥rio sobre a mensagem de spam ser√° enviado. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">use_bayes s√£o massagens de spa em configura√ß√µes de aprendizado de m√°quina. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As configura√ß√µes restantes de spamassassin foram aplicadas anteriormente neste artigo. </font></font><br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O cen√°rio geral √© spamassassin</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sobre como mover novos e-mails de spam para a pasta IMAP Spam</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sobre um monte simples de Dovecot + SpamAssassin</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recomendo a leitura da teoria de aprender spamassasin ao mover letras nas pastas do imap (e n√£o a recomendo)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ============== Contatando a comunidade ============== </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eu tamb√©m gostaria de lan√ßar uma id√©ia na comunidade sobre como aumentar o n√≠vel de seguran√ßa das cartas encaminhadas. </font><font style="vertical-align: inherit;">Desde que eu estou t√£o imerso no t√≥pico do correio. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para que o usu√°rio possa criar um par de chaves em seu cliente (outlook, thunderbird, plugin do navegador, ...). </font><font style="vertical-align: inherit;">P√∫blico e privado. </font><font style="vertical-align: inherit;">P√∫blico - envie para o DNS. </font><font style="vertical-align: inherit;">Privado - salve no cliente. </font><font style="vertical-align: inherit;">Os servidores de email poder√£o usar a chave p√∫blica para enviar para um destinat√°rio espec√≠fico. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">E para se proteger contra spam com esses e-mails (sim, o servidor de e-mail n√£o poder√° ver o conte√∫do) - ser√° necess√°rio introduzir tr√™s regras:</font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Assinatura DKIM real obrigat√≥ria, SPF obrigat√≥rio, rDNS obrigat√≥rio. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Uma rede neural sobre o t√≥pico de treinamento antispam + DB no lado do cliente. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> O algoritmo de criptografia deve ser tal que o lado de envio precise gastar 100 vezes mais energia na CPU do que o lado de recebimento. </font></font></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Al√©m de cartas p√∫blicas - para desenvolver uma carta-convite padr√£o "para come√ßar a correspond√™ncia segura". </font><font style="vertical-align: inherit;">Um dos usu√°rios (caixa de correio) envia uma carta para a outra caixa de correio com um anexo. </font><font style="vertical-align: inherit;">Na carta, a proposta de texto para iniciar um canal de comunica√ß√£o seguro para correspond√™ncia e a chave p√∫blica do propriet√°rio da caixa de correio (com a chave privada no lado do cliente).</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voc√™ pode at√© criar um par de chaves especificamente para cada correspond√™ncia. O usu√°rio destinat√°rio pode aceitar esta oferta e enviar sua chave p√∫blica (tamb√©m feita especificamente para essa correspond√™ncia). Em seguida, o primeiro usu√°rio envia uma carta de controle de servi√ßo (criptografada com a chave p√∫blica do segundo usu√°rio) - ap√≥s o recebimento da qual o segundo usu√°rio pode considerar confi√°vel o canal de comunica√ß√£o formado. Em seguida, o segundo usu√°rio envia uma carta de controle - e o primeiro usu√°rio tamb√©m pode considerar o canal formado como protegido. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para combater a intercepta√ß√£o de chaves na estrada - √© necess√°rio no protocolo prever a possibilidade de transmitir pelo menos uma chave p√∫blica usando uma unidade flash. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">E o mais importante, que tudo funciona (a pergunta √© "quem pagar√° por isso?"):</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introduzir certificados de correio no valor de US $ 10 por 3 anos. </font><font style="vertical-align: inherit;">O que permitir√° ao remetente indicar no DNS que "minhas chaves p√∫blicas est√£o dispon√≠veis". </font><font style="vertical-align: inherit;">E eles ter√£o a oportunidade de iniciar uma conex√£o segura. </font><font style="vertical-align: inherit;">Ao mesmo tempo, tome esses compostos gratuitamente. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o gmail finalmente monetiza seus usu√°rios. </font><font style="vertical-align: inherit;">Por US $ 10 em 3 anos - o direito de criar canais de correspond√™ncia seguros.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ============== Conclus√£o ============== </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para testar o artigo inteiro, eu alugaria um servidor dedicado por um m√™s e compraria um dom√≠nio com um certificado SSL. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mas as circunst√¢ncias da vida se desenvolveram e esse problema se arrastou por 2 meses. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">E quando o tempo livre voltou a aparecer - decidi publicar o artigo como est√°, e n√£o arrisco o atraso da publica√ß√£o por mais um ano. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se houver muitas perguntas como "mas isso n√£o for descrito em detalhes suficientes" - provavelmente haver√° for√ßa para contratar um servidor dedicado com um novo dom√≠nio e um novo certificado SSL e descrever com mais detalhes e o mais importante - identifique todos os detalhes importantes ausentes. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tamb√©m gostaria de receber feedback sobre o t√≥pico de id√©ias sobre certificados de correio. Se voc√™ gostou da id√©ia, tentarei encontrar for√ßas para escrever um rascunho para o rfc.</font></font><br><br> <b>     ‚Äî     . <br>       ‚Äî     . <br>           .</b> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt413689/">https://habr.com/ru/post/pt413689/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt413675/index.html">Coringa 2018: Clube de desenvolvedores Java an√¥nimos</a></li>
<li><a href="../pt413677/index.html">Lan√ßamento do ROS no rob√¥ de auto balanceamento EduMIP</a></li>
<li><a href="../pt413679/index.html">Angular6. PWA. M√≥dulos de carregamento pregui√ßosos. Implantar automaticamente no Firebase</a></li>
<li><a href="../pt413681/index.html">A t√©cnica de desenvolver servidores altamente confi√°veis ‚Äã‚Äãno Go</a></li>
<li><a href="../pt413683/index.html">O ILV desbloqueou 7 milh√µes de endere√ßos IP. Permanecem bloqueados 4 milh√µes</a></li>
<li><a href="../pt413691/index.html">Iniciar</a></li>
<li><a href="../pt413693/index.html">Feito √† m√£o: teclado program√°vel para com√©rcio on-line fa√ßa voc√™ mesmo</a></li>
<li><a href="../pt413695/index.html">Seguran√ßa do Messenger: por que armazenar mensagens na blockchain pode ser uma boa ideia</a></li>
<li><a href="../pt413697/index.html">Como n√£o escrever c√≥digo</a></li>
<li><a href="../pt413699/index.html">"Quem agita a √°gua - 2": ou tudo o que voc√™ queria saber sobre osmose reversa</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>