<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚Ñ¢Ô∏è üìº üë®‚Äçüåæ Integra√ß√£o cont√≠nua no Unity: como reduzir o tempo de montagem e economizar recursos + linha de pagamento como presente üëü üò´ üë©üèø‚Äçü§ù‚Äçüë®üèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√° pessoal, estou em contato com Alexander Panov, especialista t√©cnico da Pixonic. Na empresa, sou respons√°vel por solu√ß√µes entre projetos e perif√©ri...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Integra√ß√£o cont√≠nua no Unity: como reduzir o tempo de montagem e economizar recursos + linha de pagamento como presente</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pixonic/blog/484172/"><img src="https://habrastorage.org/webt/gu/jv/tz/gujvtzrponhszxkg1z_lmobwdt8.png"><br><br>  Ol√° pessoal, estou em contato com Alexander Panov, especialista t√©cnico da Pixonic.  Na empresa, sou respons√°vel por solu√ß√µes entre projetos e perif√©ricos para projetos pr√≥ximos e hoje quero compartilhar minha experi√™ncia e melhores pr√°ticas. <br><br>  Plataformas de desenvolvimento e integra√ß√£o cont√≠nuos, ou CI / CD, agora s√£o usadas em todos os lugares nos setores em que processos t√©cnicos iterativos e que funcionam bem desempenham um papel decisivo.  Neste artigo, falaremos sobre o CI / CD para implementar nossos projetos Unity para o desenvolvimento de jogos para dispositivos m√≥veis: quais problemas encontramos, como conseguimos resolv√™-los, quais melhorias alcan√ßamos e como nossas montagens de pipeline s√£o registradas. <br><br>  Concordo imediatamente que usamos o TeamCity do <a href="https://habr.com/ru/company/JetBrains/">JetBrains</a> como servidor de CI, o GitHub como reposit√≥rio de reposit√≥rios do Git e o Nexus para armazenar artefatos de montagem. <br><a name="habracut"></a><br>  Ent√£o, enfrentamos os seguintes problemas: <br><br><ul><li>  <i>Falta de um padr√£o comum para a cria√ß√£o de assemblies:</i> quase todos os desenvolvedores tiveram acesso ao servidor TeamCity, como resultado dos scripts de assembly que foram escritos em diferentes linguagens de programa√ß√£o (BASH, PowerShell, Python), e a l√≥gica era frequentemente duplicada; </li><li>  <i>Frota fraca:</i> devido ao fato de que precisamos criar vers√µes para iOS, tivemos que usar uma frota de carros do Mac mini.  E como na Unity quase toda a montagem ocorre em uma √∫nica rosca, as montagens paralelas em uma m√°quina se mostraram problem√°ticas; </li><li>  <i>Um pouco de efici√™ncia operacional depurada:</i> devido √† baixa produtividade de nosso suporte t√©cnico, as montagens demoraram muito tempo; </li><li>  <i>Grandes filas aguardando montagem</i> com um n√∫mero suficiente de agentes do TeamCity; </li><li>  <i>Um pool de agentes separado para cada projeto:</i> devido aos diferentes ambientes instalados nos dispositivos, bem como aos arquivos de configura√ß√£o em conflito entre os projetos (arquivos de configura√ß√£o do servidor de cache etc.), era imposs√≠vel organizar um pool comum. </li></ul><br><h2>  O que voc√™ fez como resultado? </h2><br><ul><li>  <b>Reposit√≥rio para scripts de montagem</b> </li></ul><br>  Primeiro, criamos um reposit√≥rio √∫nico de scripts para assemblies no Python.  O lan√ßamento √© realizado no ambiente de gerenciamento do ambiente virtual Pipenv com proxy de bibliotecas de terceiros em seu servidor para atualiza√ß√£o r√°pida e controle de vers√£o das bibliotecas necess√°rias.  Assim, fornecemos um √∫nico ponto de entrada para montagens de todos os projetos existentes.  Reescrevemos todos os scripts em Python, unificamos as configura√ß√µes, levamos a um padr√£o comum e removemos duplicatas do c√≥digo. <br><br><ul><li>  <b>Nova frota de carros</b> </li></ul><br>  Foi necess√°rio reduzir o tempo de montagem, possivelmente reduzindo o n√∫mero de dispositivos utilizados. <br><br>  Inicialmente, t√≠nhamos um farm de 13 mini computadores Mac, mas essa solu√ß√£o est√° longe de ser √≥tima: devido √† peculiaridade das montagens no Unity, cerca de 80% do tempo de montagem ser√° realizado em apenas um thread.  Adicione a isso uma quantidade s√≥lida de acesso de grava√ß√£o ao disco r√≠gido e conclu√≠mos que um Mac mini mal consegue lidar com 1-2 montagens simult√¢neas. <br><br>  O resultado √© a necessidade de revisar o hardware. <br><br>  Ao pesquisar e comparar alternativas para assemblies Unity, observamos que os computadores baseados em AMD Ryzen, devido ao seu desempenho, permitem montar at√© 8 a 12 assemblies ao mesmo tempo, sem perda significativa de desempenho, em rela√ß√£o √† qual foi decidido comprar quatro desses dispositivos com seis SSDs e instalar dois agentes por disco r√≠gido. <br><br>  Uma compara√ß√£o de como foi e do que se tornou √© apresentada na tabela. <br><br><img src="https://habrastorage.org/webt/zt/u2/sf/ztu2sfkhfk_xhz3v2tke-upw8eu.png"><br><br>  Tempo m√©dio de constru√ß√£o: <br><br><img src="https://habrastorage.org/webt/x5/x0/5t/x5x05txnepni2gtkygvorspm_le.png"><br><br>  Al√©m disso, organizamos a prioriza√ß√£o da sele√ß√£o de agentes do TeamCity para reduzir o tempo que a montagem passou na fila.  Anteriormente, cada um dos nossos projetos tinha seu pr√≥prio pool de agentes e, devido √† natureza multiplataforma dos jogos, o ambiente dependente do projeto n√£o permitia a cria√ß√£o de um pool comum.  Agora, ap√≥s a reorganiza√ß√£o do sistema, deixamos v√°rios agentes atribu√≠dos aos projetos, que s√£o usados ‚Äã‚Äãpara montagens autom√°ticas, mas conseguimos adicionar v√°rios agentes comuns para todos os projetos: eles s√£o inclu√≠dos no trabalho quando todos os agentes anexados ao projeto desejado est√£o ocupados. <br><br><ul><li>  <b>Biblioteca BuildPipeline para Unity</b> </li></ul><br>  Eles iniciaram uma pequena biblioteca para o Unity, que possibilita definir builds em uma janela separada do editor do Unity e tamb√©m tem a capacidade de executar build builds no modo batchmode.  A partir da funcionalidade principal da biblioteca: permite adicionar e remover defini√ß√µes antes da montagem, desabilitar bibliotecas de terceiros ou arquivos espec√≠ficos, adicionar etapas personalizadas de pr√© e p√≥s-processamento, todas as suas configura√ß√µes s√£o armazenadas nos arquivos de configura√ß√£o, al√©m da possibilidade de heran√ßa. <br><br><img src="https://habrastorage.org/webt/87/qc/kv/87qckvdpssyfxuexcy7dirr9zw0.png"><br>  <i>A janela define na biblioteca BuildPipeline</i> <br><br><h2>  Nosso pipeline atual CI / CD </h2><br>  <b>Montagem PullRequest.</b>  Para cada confirma√ß√£o: <br><br><ol><li>  lan√ßamento do Unity para verificar erros de compila√ß√£o, definir atualiza√ß√µes e gerar solu√ß√µes; </li><li>  executando testes; </li><li>  lan√ßamento de um analisador est√°tico: com sua ajuda, √© realizada uma an√°lise incremental nos arquivos afetados pelo PullRequest atual; </li><li>  Uma mensagem sobre o resultado da verifica√ß√£o, que √© salva no GitHub. </li></ol><br>  <b>Etapas de constru√ß√£o do projeto do Unity:</b> <br><br>  1. Instalando o Pipenv e executando scripts para constru√ß√£o no Python: atualizando e instalando bibliotecas Python de terceiros em nosso servidor (proxy do reposit√≥rio <a href="https://pypi.org/">pypi.org</a> ) e, em seguida, executando o script de constru√ß√£o. <br><br>  2. Prepara√ß√£o preliminar para a montagem da Unidade: <br><br><ul><li>  exclus√£o da pasta Biblioteca, Bundles, ativos seletivos (por m√°scara e / ou arquivos espec√≠ficos), exclus√£o de solu√ß√µes (arquivos .sln) - se necess√°rio; </li><li>  Gerando um arquivo de informa√ß√µes de montagem: nome da filial, n√∫mero da montagem etc.  - para uso posterior na compila√ß√£o para depura√ß√£o e teste; </li><li>  configurando um servidor de cache do Unity para um projeto.  Cada projeto tem o seu pr√≥prio.  Cada desenvolvedor tamb√©m possui um servidor de cache configurado para preenchimento mais r√°pido: quando um desenvolvedor adiciona um novo ativo, ele aparece automaticamente no servidor de cache e no servidor de constru√ß√£o - assim, a importa√ß√£o de ativos √© muito mais r√°pida. </li></ul><br>  3. Executar o Unity para verificar erros de compila√ß√£o, atualizar define e gerar solu√ß√µes. <br><br>  4. Execute testes e saia deles se houver erros - se necess√°rio. <br><br>  5. Lan√ßamento do Unity BuildPipeline com a configura√ß√£o necess√°ria e par√¢metros adicionais do projeto. <br><br>  6. Para vers√µes do Android / iOS - inicie o Gradle / Xcode: <br><br><ul><li>  Gradle - GradleWrapper; </li><li>  Xcode - arquive o XcodeProject obtido ap√≥s o Unity e copie-o para o Mac mini.  Instale e atualize separadamente todos os certificados e arquivos de perfil de provisionamento necess√°rios.  Execute os comandos Limpar, Arquivar, Exportar. </li><li>  No est√°gio de exporta√ß√£o, √© poss√≠vel separar a assinatura da compila√ß√£o, o desenvolvedor e a AppStore.  Dependendo do que coletamos, selecione a lista desejada, ou cada uma delas.  Na sa√≠da, temos dois arquivos: Developer e Release - para instala√ß√£o nos dispositivos de teste e para upload na AppStore, respectivamente. </li></ul><br>  7. Despejando constru√ß√µes coletadas e arquivos relacionados (logs, resultados de testes, .obb, manifesto para instalar aplicativos iOS, arquivos dsym etc.) no armazenamento de artefato, para montagens independentes - fazendo upload da constru√ß√£o coletada no armazenamento de archive. <br><br>  8. Gerando uma p√°gina com um c√≥digo QR para instalar a compila√ß√£o, adicionando links do reposit√≥rio e informa√ß√µes da compila√ß√£o ao banco de dados para trabalhar mais com o aplicativo PixLauncher - falaremos sobre isso mais tarde. <br><br>  9. Mensagem para Slack sobre o resultado da montagem: para quem iniciou a montagem, bem como para os canais necess√°rios. <br><br><img src="https://habrastorage.org/webt/dd/uu/ap/dduuapzv8vkhqbirksspxw8eqra.png"><br>  <i>Essas mensagens chegam ao Slack</i> <br><br><h2>  Passos adicionais </h2><br>  Como etapa final do plano, as compila√ß√µes coletadas s√£o distribu√≠das aos dispositivos para mais testes e upload na loja. <br><br>  Para instalar vers√µes em dispositivos, escrevemos um pequeno aplicativo para Android e iOS - PixLauncher.  N√≥s o instalamos em todos os dispositivos em que existe a possibilidade de escolher uma vers√£o do TeamCity.  Por conveni√™ncia, voc√™ pode definir filtros nele - por exemplo, adicione uma configura√ß√£o aos seus favoritos e execute a√ß√µes com ela em um clique.  No caso de compila√ß√µes para Android, se necess√°rio, o arquivo na resolu√ß√£o .obb √© baixado automaticamente. <br><br>  Al√©m disso, organizamos a capacidade de instalar a compila√ß√£o por meio de notifica√ß√µes push: adicionamos um plug-in auto-escrito ao servidor TeamCity, que permite selecionar os endere√ßos MAC dos dispositivos conectados √† rede local na p√°gina de compila√ß√£o.  Em seguida, uma notifica√ß√£o por push √© enviada para esses dispositivos com um link para a instala√ß√£o - dessa forma, agora √© realizada em um clique. <br><br>  Portanto, o aplicativo permitiu acelerar a pesquisa da compila√ß√£o de controle de qualidade desejada pelo departamento e a instala√ß√£o em dispositivos para posterior verifica√ß√£o. <br><br><img src="https://habrastorage.org/webt/8t/nm/_b/8tnm_bbygilukr-n5krvxb1yq_c.png"><br>  <i>Apar√™ncia do aplicativo PixLauncher para iOS</i> <br><br><h2>  Por fim, o upload de compila√ß√µes para as lojas </h2><br>  Depois de todas as a√ß√µes executadas, a necessidade de um preenchimento garantido da compila√ß√£o e meta-informa√ß√µes sobre o aplicativo para as partes se forma naturalmente. <br><br>  Inicialmente, surgiram problemas principalmente com a AppStore: <br><br><ul><li>  preencher o port√£o √© feito apenas a partir de um dispositivo MacOS; </li><li>  Voc√™ deve enviar v√≠deos, capturas de tela e descri√ß√µes de aplicativos em mais de 25 idiomas. </li></ul><br>  Isso levou a grandes perdas de tempo para preenchimento e falhas no download de arquivos para o painel de administra√ß√£o.  Portanto, pensamos em automa√ß√£o de processos. <br><br>  Como resultado, temos o seguinte: <br><br><ol><li>  No Google Disk, adquirimos um tablet com uma descri√ß√£o do aplicativo em todos os idiomas; </li><li>  Os v√≠deos e capturas de tela do aplicativo s√£o organizados em pastas com uma determinada nomea√ß√£o; </li><li>  No Teamcity, para selecionar uma compila√ß√£o j√° montada, eles fizeram uma configura√ß√£o dependente da compila√ß√£o da vers√£o; </li><li>  Por meio da API do GooglePlay e do iTMSTransporter for Apple, preencha as compila√ß√µes e meta-informa√ß√µes sobre o aplicativo na loja para todos os idiomas necess√°rios.  Em caso de problemas (por exemplo, com uma rede) - fazemos v√°rias tentativas e enviamos uma mensagem ao Slack com o texto do erro. </li></ol><br><img src="https://habrastorage.org/webt/lf/qu/un/lfquunvooflyh40dlkshhvmhg2m.png"><br>  <i>√â assim que o upload da compila√ß√£o para a AppStore se parece</i> <br><br><h2>  Como resultado - alguns n√∫meros </h2><br><ul><li>  Agora, temos cerca de 400 montagens e at√© 60 instala√ß√µes de builds em dispositivos por dia; </li><li>  Existem 57 configura√ß√µes diferentes de compila√ß√£o no TeamCity; </li><li>  Utilizamos 22 agentes TeamCity, enquanto √© poss√≠vel expandir sem uma perda significativa no desempenho para 48 agentes; </li><li>  Existe a possibilidade de expans√£o horizontal da frota. </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt484172/">https://habr.com/ru/post/pt484172/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt484154/index.html">M√©todo para resolver o sistema de equa√ß√µes diofantinas</a></li>
<li><a href="../pt484160/index.html">Talento indescrit√≠vel: a R√∫ssia perde os melhores profissionais de TI</a></li>
<li><a href="../pt484164/index.html">A hist√≥ria dos livros e o futuro das bibliotecas</a></li>
<li><a href="../pt484166/index.html">VVVVVV ??? VVVVVV !!! :)</a></li>
<li><a href="../pt484168/index.html">Escrevemos nossa estrat√©gia de rolagem virtual a partir do Angular CDK</a></li>
<li><a href="../pt484174/index.html">Beber em castelo em condi√ß√µes "extremas" ou como participamos do show "DOZOR"</a></li>
<li><a href="../pt484176/index.html">Implementando o modelo de status no Unity</a></li>
<li><a href="../pt484178/index.html">Switch Ethernet inteligente para o planeta Terra</a></li>
<li><a href="../pt484180/index.html">PBX virtual Rostelecom: o que e como pode ser feito atrav√©s da API</a></li>
<li><a href="../pt484182/index.html">Xenobots: nanorob√¥s vivos de c√©lulas de sapo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>