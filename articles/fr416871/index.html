<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üï∑Ô∏è üë¨ ‚õ™Ô∏è J'en ai assez d'accepter les paiements via WebView. Que dois-je faire? ü§∂üèª üå©Ô∏è üí´</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Je vais au bureau en train - je dois passer par une station, et j'y serai presque. 

 Chaque matin, j'ach√®te des billets de train dans l'application e...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>J'en ai assez d'accepter les paiements via WebView. Que dois-je faire?</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yamoney/blog/416871/">  Je vais au bureau en train - je dois passer par une station, et j'y serai presque. <br><br>  Chaque matin, j'ach√®te des billets de train dans l'application et je souffre.  C'est moins cher l√†-bas, mais la diff√©rence de prix ne paie pas ma douleur quand je traverse ces trois minutes de stress.  Sans m√™me mentionner le temps de chargement de chacun des cinq √©crans de l'application, on ne peut que parler de la banque WebView avec une carte enregistr√©e, de la saisie du code par SMS en cours d'ex√©cution et des dysfonctionnements inattendus. <br><br>  C'est quand vous roulez dans un train, et ils disent "Quelque chose s'est mal pass√©" et annulent l'argent, mais ils ne donnent pas de billet.  Un retour arrive juste l√†, mais le train est d√©j√† parti.  Cela se produit plusieurs fois par mois, quelle que soit la qualit√© d'Internet.  Il n'est pas n√©cessaire de parler d'actions. <br><br><img src="https://habrastorage.org/webt/vk/cl/oz/vkclozwcg4inlgcwqn7equxs_hi.png"><br><br>  En ce moment, vous pensez - peut-√™tre qu'il existe un moyen plus simple?  Eh bien, ne pas avoir de vision du tout, beau et natif.  Et oui, il existe un tel moyen.  D√©tails sous la coupe. <br><a name="habracut"></a><br>  <b>tl; dr</b> Nous avons cr√©√© une interface pour accepter les paiements via Apple Pay, Google Pay, la banque mobile Sberbank et Yandex.Money dans iOS et Android.  Non, vous n'avez pas √† dessiner de formulaires de paiement.  Oui, c'est aussi en open source. <br><br>  En g√©n√©ral, il existe environ deux sc√©narios pour accepter des paiements dans des applications mobiles. <br><br>  Le premier est via une WebView avec une page de paiement.  Vous pouvez donc accepter les paiements via un portefeuille, une carte bancaire, un mobile ou toute autre chose.  Le probl√®me est que WebView n'a pas acc√®s aux cookies du navigateur, ce qui signifie qu'il n'a pas d'autorisation pour certains modes de paiement, vous ne pourrez donc pas payer. <br><br>  Dans le deuxi√®me sc√©nario, le commer√ßant transmet les donn√©es de la carte via son backend - pour cela, vous devez vous conformer √† PCI DSS, qui est cher, long et difficile. <br><br><h2>  SDK mobile </h2><br>  Le SDK mobile de Yandex.Kassi est une biblioth√®que pour iOS et Android que nous avons cr√©√©e pour simplifier la vie des commer√ßants, des d√©veloppeurs d'applications et de ceux qui se soucient de leurs utilisateurs.  En fait, le SDK mobile est un outil de tokenisation des cartes bancaires et autres instruments de paiement.  La tokenisation est l'√©change de donn√©es qui est n√©cessaire pour effectuer un paiement pour un identifiant unique - un token. <br><br>  Au printemps, nous avons d√©ploy√© la premi√®re version du SDK - il y avait le paiement par carte et √† partir du portefeuille Yandex.Money.  Maintenant, tout va encore mieux - dans la version de juillet, ils ont ajout√© Google Pay, Apple Pay et les paiements via Sberbank avec confirmation par SMS. <br><br><h2>  √Ä propos des avantages </h2><br><img src="https://habrastorage.org/webt/1v/pt/9y/1vpt9yly6mhhzyl8ncqv374pbki.gif" align="left">  Le principal avantage est que l'acheteur paie n'importe quoi, mais pour un commer√ßant, il ressemble √† un jeton qui peut √™tre utilis√© √† la place des donn√©es de paiement. <br><br>  Il n'est pas encore n√©cessaire de passer la certification pour la conformit√© PCI DSS - les donn√©es de la carte seront trait√©es sur notre p√©rim√®tre.  Chaque ann√©e, nous passons par la certification, respectons toutes les r√®gles des r√©gulateurs et √©liminons les magasins connect√©s √† la caisse.  C'est donc possible. <br><br>  Avec le SDK, les paiements sur Android et iOS semblent familiers aux utilisateurs, et maintenant ils n'ont plus besoin de quitter le contexte de l'application au moment du paiement.  Ceux qui paient √† partir d'un portefeuille √©lectronique n'ont pas non plus besoin de se connecter - si l'utilisateur est connect√© √† l'application Money, il vous suffit de s√©lectionner le compte dont vous avez besoin via Yandex.Passport. <br><br><h2>  Comment commencer √† utiliser √† la maison? </h2><br>  Si pour g√©n√©raliser compl√®tement, alors deux choses doivent √™tre faites: <br><br><ul><li>  Int√©grez l'API de paiement Yandex.Cash - pour recevoir des paiements; </li><li>  Connectez le SDK mobile - pour la tokenisation et l'interface native. </li></ul><br>  Pour ajouter Apple Pay, il suffit d'activer l'acceptation des paiements par carte bancaire et d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">√©mettre des cl√©s</a> dans le compte d√©veloppeur Apple. <br><br>  Google Pay est un peu diff√©rent.  Besoin: <br><br><ol><li>  Pr√©parez une version de test de l'APK. </li><li>  Remplissez la liste de contr√¥le d'int√©gration - confirmez que votre application ne va pas conqu√©rir le monde, et quelques autres choses. </li><li>  Remplissez l'ensemble pour v√©rification sur Google Pay. </li></ol><br>  Google v√©rifiera tout et autorisera (ou non) √† publier l'application sur Google Play. <br><br>  Le SDK mobile est int√©gr√© √† l'application cliente afin que les paiements natifs fonctionnent √† travers lui.  Cela fonctionne comme ceci: les d√©tails de la carte vont directement √† notre p√©rim√®tre PCI DSS, sans tomber dans le backend du magasin.  Nous v√©rifions, traitons et retournons au marchand un jeton de paiement d'une dur√©e de vie de 30 minutes - il peut √™tre utilis√© une fois. <br><br><img src="https://habrastorage.org/webt/i_/ys/q7/i_ysq7ohb0g2qmlcpstlkjduzzu.png"><br>  <i>Sch√©ma d'interaction utilisateur, commer√ßant, SDK mobile et API Ya.Kassa</i> <br><br>  Avec la participation de SDK, le paiement se d√©roule en trois √©tapes: <br><br><ol><li>  Initiation du paiement et r√©ception d'un token.  L'application lance un paiement via le SDK et re√ßoit un jeton de paiement √† la sortie. </li><li>  Cr√©ez un paiement.  Le jeton va au serveur, qui initie le paiement via l'API. </li><li>  Demander l'√©tat du paiement.  Cela est n√©cessaire pour dessiner la fen√™tre correcte avec succ√®s ou erreurs. </li></ol><br><h4>  Pourquoi est-ce bien? </h4><br><ol><li>  L'architecture est homog√®ne dans diff√©rents sc√©narios de paiement. </li><li>  Pas besoin de travailler avec une carte de cr√©dit sur le backend du magasin. </li></ol><br><h2>  A propos du d√©veloppement et des tests </h2><br>  Dans la version iOS, nous utilisons VIPER et des microservices. <br><br>  Le module de tokenisation est la pierre angulaire du SDK mobile - il contr√¥le le processus afin que le commer√ßant ne voie que le token pour la sortie de l'API Yandex.Kassi, quel que soit le prix pay√© par l'utilisateur.  Un autre module de tokenisation d√©cide quelle fen√™tre afficher maintenant l'utilisateur et fait des requ√™tes POST au serveur.  Nous avons √©crit notre wrapper pour l'API pour travailler avec les requ√™tes HTTP / HTTPS √† YandexMoneyCoreApi - cela a rendu la vie plus facile. <br><br>  Les services sont des stockages et des objets qui fonctionnent avec l'API client Yandex.Kassi. <br>  Leur code s'est av√©r√© propre et concis, sans un grand nombre de succursales et de sorties anticip√©es, car le service de d√©veloppement a r√©ussi √† r√©fl√©chir √† l'avance √† l'ensemble de l'architecture.  Les services SDK ont une quantit√© concentr√©e de programmation fonctionnelle - ici, nous avons r√©v√©l√© ses capacit√©s dans leur int√©gralit√©.  L√† o√π nous devions travailler avec Functor, Monad, Applicative Functor, Promise ordinaire nous a aid√©s. <br><br><pre><code class="hljs pgsql">let <span class="hljs-keyword"><span class="hljs-keyword">method</span></span> = PaymentOptions.<span class="hljs-keyword"><span class="hljs-keyword">Method</span></span>(oauthToken: clientApplicationKey, passportAuthorization: passportToken, gatewayId: gatewayId, amount: amount, currency: currency) let paymentOptions = <span class="hljs-keyword"><span class="hljs-keyword">session</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">perform</span></span>(apiMethod: <span class="hljs-keyword"><span class="hljs-keyword">method</span></span>).responseApi() let allItems = getItems &lt;^&gt; paymentOptions let items = paymentMethodHandler.filterPaymentMethods &lt;^&gt; allItems let itemsWithEmptyError = items .recover(<span class="hljs-keyword"><span class="hljs-keyword">on</span></span>: .<span class="hljs-keyword"><span class="hljs-keyword">global</span></span>(), mapError) .<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>(makeErrors) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> itemsWithEmptyError</code> </pre> <br>  La seule difficult√© est apparue avec VIPER - nous avons commenc√© √† ajouter de nouveaux types de paiement et nous avons r√©alis√© que le module central se d√©veloppait rapidement.  Quand il y avait environ 1000 lignes dedans, nous avons d√©cid√© que nous devions faire quelque chose avec cela et r√©viser l'architecture. <br><br>  Nous avons aim√© l'id√©e d'un module central pour le processus, et nous avons d√©cid√© de l'abandonner.  Dans d'autres projets, nous utilisons une machine √† √©tats finis d√©terministe pour d√©crire le processus, mais ici cela ne r√©soudrait pas les probl√®mes, car l'impl√©mentation de beaucoup de choses resterait dans le m√™me module.  Nous avons donc d√©cid√© d'appliquer le mod√®le de ¬´strat√©gie¬ª pour isoler les processus de chaque instrument de paiement.  Une fois que l'utilisateur a s√©lectionn√© un mode de paiement, nous cr√©ons une strat√©gie pour le mode de paiement, qui contr√¥le la carte de transition et d√©cide du processus √† suivre. <br><br><h3>  Application de d√©monstration </h3><br><img src="https://habrastorage.org/webt/jq/dd/go/jqddgovdbutq7q1gijnex5do6ho.gif" align="left">  Nous l'avons fait. <br><br>  Tout a commenc√© avec le fait que le service de test avait besoin de quelque chose pour tester le SDK mobile.  Sans application de test, les gars n'ont pas pu v√©rifier le fonctionnement du SDK, et il n'y avait aucun d√©veloppeur pour les deux plates-formes parmi les testeurs. <br><br>  Au cours du processus, il s'est av√©r√© qu'en plus de tester les t√¢ches, une application de d√©monstration est un bon moyen de montrer √† nos partenaires ce qu'est un SDK mobile.  Quiconque ne sait pas programmer en Swift ou Kotlin (lire: toute personne) peut voir comment fonctionne le SDK.  Par cons√©quent, nous avons t√©l√©charg√© l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">application de d√©monstration sur Google Play</a> et la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=http://itms-services//%3Faction%3Ddownload-manifest%26url%3D">version iOS sur le site Web Yandex.Cash.</a> <br><br>  Il s'est av√©r√© une chose dans laquelle vous pouvez voir comment diff√©rentes m√©thodes de paiement fonctionnent, jouer avec les param√®tres ou le montrer √† quelqu'un qui est responsable du choix d'un agr√©gateur de paiement.  Ne soyez pas timide. <br><br><h2>  Open source </h2><br>  Quelques mois apr√®s le lancement, nous avons distribu√© la biblioth√®que tr√®s mal √† l'aise - partag√© un lien vers le site ou envoy√© des fichiers par courrier.  Les bons gars ne font pas cela - ils publient tout sur GitHub sous la licence MIT.  Nous avons donc fait exactement cela. <br><br>  En plus de la magie de la tokenisation, les marchands peuvent personnaliser les couleurs, modifier les logos ou apporter d'autres modifications √† la biblioth√®que.  Et pour le rendre tr√®s pratique, nous avons publi√© un SDK mobile dans CocoaPods pour les d√©veloppeurs iOS et dans Maven pour les gars Android. <br><br>  Si vous acceptez d√©j√† les paiements via la Caisse, mais que vous voulez maintenant le faire encore mieux et de mani√®re plus productive - connectez le SDK mobile.  Si vous venez d'ouvrir un magasin, connectez le caissier.  Nous allons bien. <br><br><h2>  Liens utiles </h2><br>  ‚Üí <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Biblioth√®que pour applications mobiles</a> <br>  ‚Üí <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Documentation SDK</a> <br>  ‚Üí <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">SDK pour iOS</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Android</a> sur GitHub. <br>  ‚Üí <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Maven</a> <br><br>  C‚Äôest tout.  Posez des questions dans les commentaires! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr416871/">https://habr.com/ru/post/fr416871/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr416857/index.html">Nous construisons des temples - dans le code et dans la vie. Mon exp√©rience dans le d√©veloppement de ma deuxi√®me application Android</a></li>
<li><a href="../fr416859/index.html">Meet All at Once React Boilerplate par Maximilian Stoiber v3.6.0</a></li>
<li><a href="../fr416863/index.html">Une nouvelle fa√ßon de pr√©senter les exposants</a></li>
<li><a href="../fr416865/index.html">Design r√©tro pour la premi√®re console portable de la lointaine 1979</a></li>
<li><a href="../fr416867/index.html">Les chercheurs ont cr√©√© un dispositif pour les attaques locales contre les syst√®mes SCADA</a></li>
<li><a href="../fr416877/index.html">Gestion de l'infrastructure d'impression</a></li>
<li><a href="../fr416879/index.html">Bureau Agile: o√π h√©berger des milliers de d√©veloppeurs?</a></li>
<li><a href="../fr416881/index.html">Introduction aux contrats intelligents. Leurs limites potentielles et r√©elles</a></li>
<li><a href="../fr416883/index.html">Comment j'ai √©crit mon Postcrossing</a></li>
<li><a href="../fr416885/index.html">Le service de remise en forme a de nouveau ¬´rendu toutes les apparences¬ª des gouvernements, des services militaires et sp√©ciaux</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>