<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🌶️ 💪🏼 🔥 通过QEMU的IP-KVM 🏓 👈🏻 🤦🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="在没有KVM的服务器上加载操作系统时，进行故障排除并非易事。 我们使用恢复映像和虚拟机创建IP上的KVM。 

 如果远程服务器上的操作系统出现问题，管理员将下载恢复映像并执行必要的工作。 当已知故障原因并且恢复映像和服务器上安装的操作系统来自同一系列时，此方法可以正常工作。 如果故障原因尚不清楚，...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>通过QEMU的IP-KVM</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/selectel/blog/464565/"><img src="https://habrastorage.org/webt/jr/rx/m6/jrrxm6jhxdczns-5x0qym8maw_u.png"><br><br> 在没有KVM的服务器上加载操作系统时，进行故障排除并非易事。 我们使用恢复映像和虚拟机创建IP上的KVM。 <br><br> 如果<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">远程服务器上</a>的操作系统出现问题，管理员将下载恢复映像并执行必要的工作。 当已知故障原因并且恢复映像和服务器上安装的操作系统来自同一系列时，此方法可以正常工作。 如果故障原因尚不清楚，则需要监视加载操作系统的进度。 <br><a name="habracut"></a><br><h2> 远程KVM </h2><br> 您可以使用内置工具（例如IPMI或Intel®vPro™）或使用称为IP-KVM的外部设备来访问服务器控制台。 在某些情况下，所有列出的技术都不可用。 但是，这还没有结束。 如果可以将服务器远程重启到基于Linux操作系统的恢复映像中，则可以快速组织IP KVM。 <br><br> 恢复映像是驻留在RAM中的完整操作系统。 因此，我们可以运行任何软件，包括虚拟机（VM）。 也就是说，您可以启动VM，服务器操作系统将在其中运行。 例如，可以通过VNC安排对VM控制台的访问。 <br><br> 要在VM内启动服务器操作系统，必须将服务器磁盘指定为VM磁盘。 在Linux系列操作系统上，物理磁盘以<b>/ dev / sdX</b>形式的块设备表示，可以像常规文件一样进行<b>处理</b> 。 <br><br> 一些虚拟机管理程序（例如QEMU和VirtualBox）允许您以原始格式存储VM数据，即，仅存储没有虚拟机管理程序元数据的数据。 因此，可以使用服务器的物理磁盘启动VM。 <br><br> 此方法需要资源来运行恢复映像和其中的VM。 但是，具有四个或更多GB的RAM，这将不是问题。 <br><br><h2> 环境准备 </h2><br> 作为虚拟机，您可以使用轻量级且简单的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">QEMU</a>程序，该程序通常不是恢复映像的一部分，因此必须单独安装。 我们为客户提供的恢复映像基于<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Arch Linux</a> ，该系统使用<b>pacman</b>软件包管理器。 <br><br> 首先，您需要确保恢复映像正在使用最新的软件。 您可以使用以下命令检查和更新所有操作系统组件： <br><br> <code>pacman -Suy</code> <br> <br> 更新之后，必须安装QEMU。 通过pacman进行的安装命令如下所示： <br><br> <code>pacman -S qemu</code> <br> <br> 检查qemu是否正确安装： <br><br> <code>root@sel-rescue ~ # qemu-system-x86_64 --version <br> QEMU emulator version 4.0.0 <br> Copyright (c) 2003-2019 Fabrice Bellard and the QEMU Project developers</code> <br> <br> 如果是这样，则恢复映像已准备就绪。 <br><br><h2> 虚拟机启动 </h2><br> 首先，您需要确定分配给VM的资源量，并找出到物理磁盘的路径。 在本例中，我们将为虚拟机分配两个内核和两个GB的RAM，并且磁盘位于路径<b>/ dev / sda</b>和<b>/ dev / sdb上</b> 。 运行VM： <br><br> <code>qemu-system-x86_64 \ <br> -m 2048M \ <br> -net nic -net user \ <br> -enable-kvm \ <br> -cpu host,nx \ <br> -M pc \ <br> -smp 2 \ <br> -vga std \ <br> -drive file=/dev/sda,format=raw,index=0,media=disk \ <br> -drive file=/dev/sdb,format=raw,index=1,media=disk \ <br> -vnc :0,password \ <br> -monitor stdio</code> <br> <br> 关于每个参数的含义： <br><br><ul><li>  <b>-m 2048M-</b>每个VM分配2 GB的RAM; </li><li>  <b>-net nic -net用户</b> -使用NAT（网络地址转换）通过管理程序添加简单的网络连接； </li><li>  <b>-enable-kvm-启用</b>完整的KVM虚拟化（内核虚拟机）； </li><li>  <b>-cpu host-</b>告诉虚拟处理器获取所有服务器处理器功能； </li><li>  <b>-M pc</b> -PC设备类型； </li><li>  <b>-smp 2-</b>虚拟处理器必须是双核； </li><li>  <b>-vga std-</b>选择不支持大屏幕分辨率的标准视频卡； </li><li>  <b>-驱动器文件= / dev / sda，格式=原始，索引= 0，媒体=磁盘</b> <br><ul><li>  <b>file = / dev / sdX-</b>代表服务器磁盘的块设备的路径； </li><li>  <b>格式=原始</b> -在指定文件中标记所有数据均以“原始”格式，即磁盘上的格式； </li><li>  <b>index = 0-</b>磁盘号，每个下一个磁盘应增加一个； </li><li>  <b>media = disk-</b>虚拟机应将此存储识别为磁盘； </li></ul></li><li>  <b>-vnc：0，密码</b> -运行默认的VNC服务器0.0.0.0:5900，使用密码作为授权； </li><li>  <b>-monitor stdio-</b>管理员将通过标准输入/输出流与qemu通信。 </li></ul><br> 如果一切正常，则QEMU监视器将启动： <br><br> <code>QEMU 4.0.0 monitor - type 'help' for more information <br> (qemu)</code> <br> <br> 我们指出授权是使用密码进行的，但未指定密码本身。 您可以通过将change vnc password命令发送到QEMU监视器来执行此操作。 重要说明：密码​​不能超过8个字符。 <br><br> <code>(qemu) change vnc password <br> Password: ******</code> <br> <br> 之后，我们可以使用您指定的密码通过服务器的IP地址与任何VNC客户端（例如Remmina）连接。 <br><br><img src="https://habrastorage.org/webt/hz/c8/gv/hzc8gv9gh83yjki7t3ycmiazdds.png" title="通过VNC连接的参数"><br><br><img src="https://habrastorage.org/webt/um/qs/sh/umqsshwhmcbnd0c2uc_u0nte-la.png" title="VNC客户端可帮助找出操作系统为何无法启动的原因。"><br><br> 现在，我们不仅在加载阶段看到了可能的错误，而且可以对付它们。 <br><br> 在工作结束时，您必须完成虚拟机。 可以在操作系统内部通过<b>发送</b>关闭信号来完成此操作，也可以将<b>system_powerdown</b>命令提供给QEMU监视器。 这等效于单击关闭按钮：虚拟机内部的操作系统将平稳关闭。 <br><br><h2> 操作系统安装 </h2><br> 虚拟机具有对服务器磁盘的完全访问权限，因此可用于手动安装操作系统。 唯一的限制是RAM的数量：并非总是可以将ISO映像放置在RAM中。 我们选择四个GB的RAM将图像存储在<b>/ mnt中</b> ： <br><br> <code>mount -t tmpfs -o size=4G tmpfs /mnt</code> <br> <br> 我们还将加载FreeBSD 12.0操作系统的安装映像： <br><br> <code>wget -P /mnt ftp://ftp.freebsd.org/pub/FreeBSD/releases/amd64/amd64/ISO-IMAGES/12.0/FreeBSD-12.0-RELEASE-amd64-bootonly.iso</code> <br> <br> 现在，您可以启动VM： <br><br> <code>qemu-system-x86_64 \ <br> -m 2048M \ <br> -net nic -net user \ <br> -enable-kvm \ <br> -cpu host,nx \ <br> -M pc \ <br> -smp 2 \ <br> -vga std \ <br> -drive file=/dev/sda,format=raw,index=0,media=disk \ <br> -drive file=/dev/sdb,format=raw,index=1,media=disk \ <br> -vnc :0,password \ <br> -monitor stdio \ <br> -cdrom /mnt/FreeBSD-12.0-RELEASE-amd64-bootonly.iso \ <br> -boot d <br></code> <br><br>  -boot <b>d</b>标志设置从CD驱动器的引导。 我们通过VNC客户端连接，我们看到了FreeBSD加载器。 <br><br><img src="https://habrastorage.org/webt/j4/jb/hh/j4jbhhidggiupbszepsduhffn0g.png" title="FreeBSD引导程序。"><br><br> 由于使用DHCP来访问Internet，因此在配置之后，有必要引导到新安装的系统并更正网络设置。 在某些情况下，可能需要安装网络适配器驱动程序，因为服务器中安装的网卡和VM中模拟的网卡是不同的。 <br><br><h2> 结论 </h2><br> 这种对服务器控制台进行远程访问的组织方法消耗了服务器的部分资源，但是，它对服务器的硬件组件没有任何特殊要求，因此几乎可以在任何条件下执行。 使用此解决方案可以极大地促进软件故障的诊断并恢复远程服务器的运行状况。 </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN464565/">https://habr.com/ru/post/zh-CN464565/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN464555/index.html">在漏洞赏金上赚钱的简单方法</a></li>
<li><a href="../zh-CN464557/index.html">XD Design Bobby Pro：我们一直在等待的翻拍</a></li>
<li><a href="../zh-CN464559/index.html">大运会交通工具的特点和非常热情的亚历克斯</a></li>
<li><a href="../zh-CN464561/index.html">使用Redux模式编写iOS应用程序</a></li>
<li><a href="../zh-CN464563/index.html">信息安全-您需要了解什么并被认为是优秀的信息安全专家？</a></li>
<li><a href="../zh-CN464571/index.html">脑+ 30卢布的VPS =？</a></li>
<li><a href="../zh-CN464579/index.html">计算机视觉夏令营-英特尔计算机视觉暑期学校</a></li>
<li><a href="../zh-CN464581/index.html">“凯撒”和英语单词的25种类型</a></li>
<li><a href="../zh-CN464583/index.html">庞大的3D数据集可帮助机器人理解事物</a></li>
<li><a href="../zh-CN464591/index.html">化学炸鸡。 详细分析</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>