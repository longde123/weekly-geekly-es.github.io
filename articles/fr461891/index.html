<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë¥üèæ üè§ ü§±üèΩ Comment nous nous sommes fait des amis dans l'infrastructure bancaire √† l'aide de ManageIQ üßòüèø üë®‚Äçüë©‚Äçüëß üìå</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Il y a quelques ann√©es, les principales tendances √©taient l'automatisation, les pratiques DevOps et l'acc√©l√©ration de la livraison de valeurs sur le m...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment nous nous sommes fait des amis dans l'infrastructure bancaire √† l'aide de ManageIQ</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/homecredit/blog/461891/"><p>  Il y a quelques ann√©es, les principales tendances √©taient l'automatisation, les pratiques DevOps et l'acc√©l√©ration de la livraison de valeurs sur le march√©.  Home Credit Bank a d√©cid√© de suivre le rythme et de se diriger vers le d√©veloppement technologique, d'autant plus que le murmure ouvert d'utilisateurs fatigu√©s d'attendre plusieurs jours pour attendre de nouvelles ressources pour leurs importants projets se r√©pandait plus fort sur l'espace ouvert. </p><br><p>  Nous avons d√©cid√© de commencer par le processus d'approbation des demandes par les d√©partements, ce qui, comme dans de nombreuses grandes entreprises, a n√©cessit√© du temps et des efforts.  Comme premi√®re t√¢che, nous avons choisi le processus de cr√©ation d'une machine virtuelle quel que soit l'environnement de virtualisation.  En dressant une liste de t√¢ches, nous avons r√©alis√© qu'il serait n√©cessaire de s'int√©grer √† d'autres syst√®mes utilis√©s dans l'infrastructure de notre banque, par exemple, via l'API. </p><br><p><img src="https://habrastorage.org/webt/tt/h7/br/tth7br6euodgo1dklwgmaqhdxu4.png" alt="image"></p><a name="habracut"></a><br><p> La solution la plus appropri√©e √©tait <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ManageIQ</a> .  Il s'agit d'un projet que Red Hat a acquis en 2012 et sur la base de celui-ci a cr√©√© le produit commercial <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Red Hat CloudForms</a> .  Dans le m√™me temps, ManageIQ est rest√© dans le statut de produit open source et se d√©veloppe en parall√®le avec CloudForms. </p><br><p>  ManageIQ est √©crit en Ruby et prend en charge un grand nombre de fournisseurs diff√©rents de virtualisation, de clouds publics et de conteneurisation.  Pour le moment, nous utilisons une version de Gaprindashvili en configuration haute disponibilit√© dans Home. </p><br><h2>  Comment le processus a chang√© </h2><br><p>  Auparavant, chaque √©quipe avait besoin de param√®tres distincts dans son domaine de responsabilit√©.  Apr√®s une pr√©paration pr√©liminaire, toutes les donn√©es ont √©t√© collect√©es et envoy√©es √† l'administrateur, qui a d√©ploy√© et configur√© la machine virtuelle.  Il a ensuite fallu informer, par exemple, l'√©quipe de surveillance qu'un nouvel h√¥te √©tait apparu et qu'il fallait l'ajouter √† la surveillance.  Les retards de communication, la charge de travail des sp√©cialistes, les erreurs dues au facteur humain, pourraient √©tirer ce processus √† plusieurs jours. </p><br><p>  Apr√®s avoir int√©gr√© l'ensemble du processus dans ManageIQ, nous avons obtenu les r√©sultats suivants: </p><br><div class="scrollable-table"><table><thead><tr><th>  Type de ressource virtuelle </th><th>  Avant de pr√©senter ManageIQ </th><th>  Apr√®s avoir impl√©ment√© ManageIQ </th></tr></thead><tbody><tr><td>  Machine virtuelle Linux dans VMware / oVirt </td><td>  √Ä un </td><td>  ~ 10 minutes </td></tr><tr><td>  Environnement de machine virtuelle Rancher </td><td>  travail </td><td>  ~ 15 minutes </td></tr><tr><td>  Machine virtuelle Windows dans VMware </td><td>  semaines </td><td>  ~ 25 minutes </td></tr></tbody></table></div><br><p>  La diff√©rence de temps est due au fait que dans le second cas, un temps suppl√©mentaire est n√©cessaire pour pr√©parer l'h√¥te √† travailler avec Docker, t√©l√©charger et int√©grer des images pour les conteneurs d'infrastructure d'Artifactory, car √† ce stade, il n'y a toujours pas acc√®s au Docker Hub.  Dans le cas de Windows, la diff√©rence est obtenue du fait que, tout d'abord, le temps de cr√©ation d'une machine virtuelle Linux sans personnalisation est d'environ 2 minutes, et celui d'une machine virtuelle Windows est de 6 minutes.  Deuxi√®mement, la personnalisation de Windows lui-m√™me prend environ 10 minutes, contre 2 minutes pour Linux. </p><br><p>  10 minutes n'est pas si rapide, √©tant donn√© qu'environ 2-3 minutes sont consacr√©es directement au processus de cr√©ation d'une machine virtuelle.  Pour le temps restant, ManageIQ parvient √† effectuer les op√©rations suivantes: </p><br><ol><li>  Le syst√®me collecte les param√®tres sp√©cifi√©s par l'utilisateur dans le bon de commande et les d√©compose en variables. </li><li>  Une nouvelle demande de modification est cr√©√©e dans le syst√®me de gestion des incidents, qui affiche des donn√©es sur la nouvelle ressource. </li><li>  Le syst√®me de requ√™te de nom de ressource ManageIQ envoie une valeur pour une nouvelle ressource. </li><li>  Le syst√®me de gestion des adresses IP √©met une nouvelle adresse en fonction des param√®tres saisis. </li><li>  Un nouvel enregistrement DNS est enregistr√© sur le serveur DNS local. </li><li>  En fonction des param√®tres, de l'environnement et de la charge des ressources, le type de virtualisation et le cluster √† placer sont s√©lectionn√©s. </li><li>  Ensuite, le processus de cr√©ation d'une machine virtuelle avec les param√®tres sp√©cifi√©s. </li><li>  Lorsque la machine virtuelle est d√©ploy√©e √† partir du mod√®le, vous devez ex√©cuter des scripts qui d√©finiront les param√®tres finaux: <br><ul><li>  extension du disque √† une taille sp√©cifi√©e, </li><li>  g√©n√©rer un nouveau mot de passe root, le changer sur un h√¥te Linux et √©crire dans un gestionnaire de mots de passe, </li><li>  cr√©er un fichier de configuration YAML pour Puppet dans GitLab, </li><li>  ex√©cuter des runbooks qui apportent les param√®tres et les mises √† jour n√©cessaires pour les machines virtuelles Windows ou </li><li>  lancez Puppet, qui mettra √† jour et configurera les machines Linux. </li></ul></li><li>  Apr√®s tout cela, la demande de changement cr√©√©e √† l'√©tape 2 est ferm√©e.  De nouvelles donn√©es y sont ajout√©es, telles que l'adresse IP et le nom d'h√¥te. </li><li>  Une nouvelle unit√© est enregistr√©e dans la base de gestion des ressources de calcul (CMDB). </li><li>  La machine virtuelle est enregistr√©e dans Zabbix et ajout√©e √† la surveillance. </li><li>  Le client et les autres parties int√©ress√©es re√ßoivent un e-mail contenant des informations sur la nouvelle unit√© cr√©√©e √† l'aide de ManageIQ. </li></ol><br><h2 id="chto-vnutri">  √Ä l'int√©rieur </h2><br><p>  Explorons les d√©tails techniques du produit.  Par d√©faut, ManageIQ peut cr√©er une machine virtuelle √† partir d'un mod√®le.  En quoi cela diff√®re-t-il de ce que nous faisons, par exemple, dans vCenter?  La bonne r√©ponse n'est rien.  ManageIQ utilise les m√™mes m√©thodes que les syst√®mes de virtualisation, mais le fait √† partir d'un seul endroit.  En plus de cela, vous pouvez ajouter vos propres scripts qui ne correspondent pas √† l'ensemble de fonctionnalit√©s standard.  Ainsi, si vous avez des ressources, par exemple, dans Azure public, dans vCenter, qui est d√©ploy√© sur votre propre mat√©riel, plus le cluster Kubernetes tourne ailleurs, alors tout cela peut √™tre facilement g√©r√© √† partir de ManageIQ. </p><br><p>  En plus d'une grande vari√©t√© de fournisseurs d'int√©gration, ManageIQ dispose d'outils pratiques de personnalisation.  Cela, par exemple, en cr√©ant des formulaires pratiques pour r√©soudre votre probl√®me: </p><br><p><img src="https://habrastorage.org/webt/ku/7y/l3/ku7yl3xi9trq-9wndv-ad_vlpvu.png"></p><br><p>  Gr√¢ce √† cela, il a √©t√© possible de construire une interface √† part enti√®re pour commander une machine virtuelle, en y int√©grant tous les param√®tres n√©cessaires: </p><br><p><img src="https://habrastorage.org/webt/v7/ey/tf/v7eytf_hbcxxjcpw4hvrzuwyzve.png"></p><br><p>  Nous s√©lectionnons la quantit√© de ressources informatiques, OS, remplissons toutes les informations suppl√©mentaires n√©cessaires √† l'int√©gration avec des syst√®mes externes.  De plus, en utilisant des m√©canismes internes (√† leur sujet un peu plus tard), le syst√®me choisit o√π les nouvelles ressources seront plac√©es: le centre de donn√©es, le cluster, l'h√¥te et le magasin de donn√©es sont s√©lectionn√©s en fonction de tous les param√®tres saisis et les ressources sont charg√©es. </p><br><p>  N'oubliez pas que les gens peuvent commander trop de ressources ou pas du tout ce dont ils ont vraiment besoin.  Ici, le syst√®me de demandes et de confirmations entre en jeu: </p><br><p><img src="https://habrastorage.org/webt/mj/yv/28/mjyv28hsy0ggf6t68jjdkgc8mwc.png"></p><br><p>  Toutes les ressources command√©es par l'utilisateur doivent √™tre approuv√©es par la personne responsable.  Dans Home, un groupe d'architectes le fait. </p><br><h2 id="struktura-avtomatizacii">  Structure d'automatisation </h2><br><p>  Si vous d√©composez tous les processus d'automatisation dans ManageIQ en petites parties, vous remarquerez une certaine structure. </p><br><h3 id="automate-domain">  Automatiser le domaine </h3><br><img align="right" src="https://habrastorage.org/webt/xy/ea/c_/xyeac_nx3if-e4txuiuriic4h0w.png"><br><p>  Le magasin de donn√©es h√©berge tous les domaines de ManageIQ. </p><br><p>  Par d√©faut, il existe un domaine ManageIQ, qui est verrouill√© et ressemble √† un mod√®le de r√©f√©rence.  Si vous devez apporter des modifications, un autre domaine est cr√©√©, dans lequel les √©l√©ments du domaine ManageIQ sont copi√©s et modifi√©s pour vos propres t√¢ches. </p><br><h3 id="automate-namespace">  Automatiser l'espace de noms </h3><br><img align="right" src="https://habrastorage.org/webt/yf/e1/t3/yfe1t3kjxb4rhvenndkfkwtsad4.png"><br><p>  √Ä l'int√©rieur, les domaines sont divis√©s en parties responsables des processus individuels: il peut s'agir de la section responsable de la gestion de l'infrastructure (Infrastructure) ou de l'utilisation des services (Service).  Nous avons notre propre espace de noms, qui contient tout ce qui concerne les syst√®mes de la banque. </p><br><p>  Examinez la structure plus en d√©tail √† l'aide de l'exemple du processus d'approvisionnement pour une nouvelle machine virtuelle.  Il est d√©crit dans la classe Automate appel√©e <em>VMProvision_VM</em> . </p><br><h3 id="automate-class">  Automatiser la classe </h3><br><p>  La classe a une structure qui comprend des <strong>instances</strong> , des <strong>m√©thodes</strong> , des <strong>propri√©t√©s</strong> et un <strong>sch√©ma</strong> .  Du point de vue de l'automatisation, Schema pr√©sente le plus d'int√©r√™t: <br><img src="https://habrastorage.org/webt/vm/jt/lf/vmjtlfd9qpyrqpdpemtxfw2yczs.png"></p><br><p>  La disposition est similaire au pipeline dans les syst√®mes CI / CD.  Il d√©crit les √©tapes qui seront effectu√©es dans le processus d'automatisation. </p><br><h3 id="automate-instance">  Automatiser l'instance </h3><br><img align="right" src="https://habrastorage.org/webt/ie/wj/fj/iewjfjuzq9rplkcszwsh7wemsqu.png"><br><p>  La classe d√©crite ci-dessus a deux instances d'automatisation.  Chacun d'eux h√©rite du circuit des √©tapes pour lesquelles la <em>valeur par d√©faut</em> est d√©finie.  Les √©tapes qui ont des valeurs nulles sont d√©crites dans l'instance. </p><br><p><img src="https://habrastorage.org/webt/wy/sl/5c/wysl5c2zze_9_sfplsnykplbf_m.png"></p><br><p>  Dans l'instance, des valeurs sont apparues pour les √©tapes qui √©taient vides dans la description du sch√©ma.  Vous pouvez √©galement voir qui et quand avez effectu√© la derni√®re modification. </p><br><p>  Voyons ce que repr√©sente l'une des valeurs Value: <br><img src="https://habrastorage.org/webt/rd/j_/v7/rdj_v7hc3wgt7dty2zckjltiacg.png"></p><br><p>  Il s'agit d'une classe Automate appel√©e M√©thodes, qui poss√®de une instance Automate.  Son diagramme d√©crit l'attribut <em>ipam_base_uri</em> et la m√©thode d' <em>ex√©cution</em> .  La m√©thode d'ex√©cution, √† son tour, appelle la m√©thode Automate <em>acqu√©rir_ip</em> . </p><br><h3 id="automate-method">  Automatiser la m√©thode </h3><br><p>  Il s'agit d'un script Ruby qui permet √† une machine virtuelle de communiquer via l'API REST avec d'autres syst√®mes.  Par exemple, comme c'est le cas avec le syst√®me de gestion de l'espace d'adressage IPAM.  Dans IPAM, nous obtenons l'adresse, le masque, le sous-r√©seau et le VLAN pour la machine virtuelle.  La difficult√© est que la machine peut √™tre d√©ploy√©e dans un environnement de test ou productive, pour des applications ou des bases de donn√©es.  Ou peut-√™tre que le service de s√©curit√© a d√©cid√© de le placer dans la boucle PCI-DSS.  Toutes ces informations sont collect√©es au stade de la cr√©ation de la VM ou transmises dans les param√®tres de l'instance appel√©e (dans la capture d'√©cran ci-dessus, vous pouvez voir que le param√®tre contient l'URI par lequel la m√©thode acc√®de √† IPAM): </p><br><div class="spoiler">  <b class="spoiler_title">Voici du code Ruby</b> <div class="spoiler_text"><pre><code class="ruby hljs">base_uri = $evm.object[<span class="hljs-string"><span class="hljs-string">'ipam_base_uri'</span></span>] prov = $evm.root[<span class="hljs-string"><span class="hljs-string">"miq_provision"</span></span>] site = prov.get_option(<span class="hljs-symbol"><span class="hljs-symbol">:site</span></span>) app = prov.get_option(<span class="hljs-symbol"><span class="hljs-symbol">:dialog_dropdown_list_information_system</span></span>) crq = prov.get_option(<span class="hljs-symbol"><span class="hljs-symbol">:crq</span></span>) descr = prov.get_option(<span class="hljs-symbol"><span class="hljs-symbol">:dialog_textarea_box_usernotes</span></span>) owner = $evm.root[<span class="hljs-string"><span class="hljs-string">'user'</span></span>].name scope = prov.get_option(<span class="hljs-symbol"><span class="hljs-symbol">:dialog_dropdown_scope</span></span>) environment = prov.get_option(<span class="hljs-symbol"><span class="hljs-symbol">:landscape</span></span>)</code> </pre> <br><p>  <em>$ evm.root</em> est une m√©thode qui renvoie tout ce qui peut √™tre stock√© dans ManageIQ.  Il peut s'agir d'informations sur l'utilisateur, l'environnement, les variables, la requ√™te en cours ('miq_request'), etc.  Nous sommes int√©ress√©s par le processus de fourniture actuel. <br><img src="https://habrastorage.org/webt/4m/hz/lm/4mhzlmb6p_lvkagsl7apu41mpdm.png"></p><br><p>  Ensuite, nous pouvons r√©cup√©rer les valeurs n√©cessaires: <em>get_option (: site)</em> r√©cup√®re la valeur qui a √©t√© transf√©r√©e √† l'une des √©tapes pr√©c√©dentes, et, par exemple, <em>get_option (: dialog_dropdown_list_information_system)</em> r√©cup√®re √† partir du formulaire que l'utilisateur remplit lors de la commande de nouvelles ressources. <br>  Toutes les valeurs re√ßues sont transmises par des variables dans le corps de la requ√™te au format JSON: </p><br><pre> <code class="ruby hljs">options = { <span class="hljs-symbol"><span class="hljs-symbol">verify:</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">headers:</span></span> {<span class="hljs-string"><span class="hljs-string">"Content-Type"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"application/json"</span></span>}, <span class="hljs-symbol"><span class="hljs-symbol">body:</span></span> { <span class="hljs-string"><span class="hljs-string">"site"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{site}</span></span></span><span class="hljs-string">"</span></span>, <span class="hljs-string"><span class="hljs-string">"env"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{env}</span></span></span><span class="hljs-string">"</span></span>, <span class="hljs-string"><span class="hljs-string">"app"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{app}</span></span></span><span class="hljs-string">"</span></span>, <span class="hljs-string"><span class="hljs-string">"scope"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{scope}</span></span></span><span class="hljs-string">"</span></span>, <span class="hljs-string"><span class="hljs-string">"role"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{role}</span></span></span><span class="hljs-string">"</span></span>, <span class="hljs-string"><span class="hljs-string">"crq"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{crq}</span></span></span><span class="hljs-string">"</span></span>, <span class="hljs-string"><span class="hljs-string">"descr"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{descr}</span></span></span><span class="hljs-string">"</span></span>, <span class="hljs-string"><span class="hljs-string">"owner"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{owner}</span></span></span><span class="hljs-string">"</span></span>, }.to_json, }</code> </pre> <br><p>  En utilisant cet ensemble de param√®tres, IPAM d√©terminera sans ambigu√Øt√© dans quel VLAN la machine virtuelle doit √™tre situ√©e et renverra les param√®tres r√©seau. </p></div></div><br><p>  En plus d'obtenir des donn√©es pour la configuration de machine virtuelle correcte, ManageIQ peut √©galement g√©n√©rer des informations suppl√©mentaires afin de d√©finir certains param√®tres au stade de ce que l'on appelle le post-approvisionnement (apr√®s le d√©ploiement et le lancement de la machine virtuelle).  Dans Home, nous utilisons Puppet pour g√©rer les configurations d'h√¥te Linux.  Pour chaque unit√© informatique, cr√©ez un fichier GAML en YAML avec un ensemble de groupes: </p><br><div class="spoiler">  <b class="spoiler_title">Un peu plus de code Ruby</b> <div class="spoiler_text"><pre> <code class="ruby hljs">options = { <span class="hljs-symbol"><span class="hljs-symbol">headers:</span></span> {<span class="hljs-string"><span class="hljs-string">"Private-Token"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{api_token}</span></span></span><span class="hljs-string">"</span></span>, <span class="hljs-string"><span class="hljs-string">"Content-Type"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"application/json"</span></span>}, } body = { <span class="hljs-string"><span class="hljs-string">"branch"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{branch}</span></span></span><span class="hljs-string">"</span></span>, <span class="hljs-string"><span class="hljs-string">"author_email"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"email@your.domain"</span></span>, <span class="hljs-string"><span class="hljs-string">"author_name"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"ManageIQ Bot"</span></span>, <span class="hljs-string"><span class="hljs-string">"content"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"commit_message"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"New host created by ManageIQ"</span></span>, } descr = prov.get_option(<span class="hljs-symbol"><span class="hljs-symbol">:long_description</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> descr.<span class="hljs-keyword"><span class="hljs-keyword">include</span></span>?(<span class="hljs-string"><span class="hljs-string">'rancher'</span></span>) &amp;&amp; descr.<span class="hljs-keyword"><span class="hljs-keyword">include</span></span>?(<span class="hljs-string"><span class="hljs-string">'test'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> body[<span class="hljs-symbol"><span class="hljs-symbol">:content</span></span>] = <span class="hljs-string"><span class="hljs-string">"---\ngroups:\n - </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{yaml_server}</span></span></span><span class="hljs-string">\n - rancher\n - user-devops-UDCR"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unless</span></span> descr.<span class="hljs-keyword"><span class="hljs-keyword">include</span></span>?(<span class="hljs-string"><span class="hljs-string">'test'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> descr.<span class="hljs-keyword"><span class="hljs-keyword">include</span></span>?(<span class="hljs-string"><span class="hljs-string">'rancher'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> body[<span class="hljs-symbol"><span class="hljs-symbol">:content</span></span>] = <span class="hljs-string"><span class="hljs-string">"---\ngroups:\n - </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{yaml_server}</span></span></span><span class="hljs-string">\n - rancher\n"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unless</span></span> descr.<span class="hljs-keyword"><span class="hljs-keyword">include</span></span>?(<span class="hljs-string"><span class="hljs-string">'rancher'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> body[<span class="hljs-symbol"><span class="hljs-symbol">:content</span></span>] = <span class="hljs-string"><span class="hljs-string">"---\ngroups:\n - </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{yaml_server}</span></span></span><span class="hljs-string">\n - </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{$is_id}</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> </div></div><br><p>  Les groupes d√©pendent du type de machine virtuelle, de l'environnement dans lequel elle est cr√©√©e et du syst√®me d'information. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/1i/hv/ig/1ihvigmykpbqlihq2l8oturxxk0.png"></div><br><p>  Une fois la proc√©dure termin√©e avec succ√®s, l'utilisateur re√ßoit un e-mail contenant des informations: <br><img src="https://habrastorage.org/webt/qf/j-/br/qfj-brpfqe1ukkcvrw_jdtdpigm.png"></p><br><p>  Le texte de la lettre peut √©galement √™tre ajust√© en ajoutant les informations n√©cessaires. <br>  Si une erreur se produit √† l'une des √©tapes critiques du processus, vous pouvez ajouter une condition qui indique explicitement que le processus doit √™tre interrompu.  Si l'erreur n'a pas de cons√©quences fatales, indiquez √©galement ce qui peut √™tre poursuivi malgr√© le probl√®me. </p><br><h2 id="logirovanie">  Journalisation </h2><br><p>  ManageIQ √©crit des journaux de tout ce qui peut √™tre suivi.  Le processus d'automatisation est √©crit dans automation.log.  En outre, il existe des journaux d'API, divers fournisseurs de cloud, des journaux de s√©curit√©, m√™me la sortie de la commande sup√©rieure est enregistr√©e. </p><br><p>  Pour chaque √©v√©nement du circuit, vous pouvez configurer une entr√©e de journal de leur d√©but et de leur fin: <br><img src="https://habrastorage.org/webt/tv/z0/yy/tvz0yyygspvyltb6d_x4ja00hpg.png"></p><br><p>  De plus, vous pouvez √©crire vos messages dans les journaux: </p><br><pre> <code class="ruby hljs">$evm.log(<span class="hljs-symbol"><span class="hljs-symbol">:info</span></span>, <span class="hljs-string"><span class="hljs-string">"Call job status uri: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{item_uri}</span></span></span><span class="hljs-string">/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{job_id}</span></span></span><span class="hljs-string">/api/json"</span></span>)</code> </pre> <br><p>  Ceci est tr√®s utile lors de l'acc√®s aux syst√®mes par API pour comprendre pourquoi quelque chose s'est mal pass√©.  Ou, pour suivre l'√©tat actuel d'un long processus, tel que l'ex√©cution d'un travail Jenkins ou du Runbook SCCM: </p><br><pre> <code class="ruby hljs">$evm.log(<span class="hljs-symbol"><span class="hljs-symbol">:info</span></span>, <span class="hljs-string"><span class="hljs-string">"acquire_osname --- naming jobStatus: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{jobStatus}</span></span></span><span class="hljs-string">"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> jobStatus.to_s == <span class="hljs-string"><span class="hljs-string">"Completed"</span></span></code> </pre> <br><p>  Vous pouvez utiliser les fonctions standard des exceptions pour √©crire dans les journaux: </p><br><pre> <code class="ruby hljs">raise ‚ÄúVM <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> specified‚Äù <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> vm.<span class="hljs-literal"><span class="hljs-literal">nil</span></span>?</code> </pre> <br><p>  Par d√©faut, tous les journaux sont stock√©s dans la section / var / log / manageiq / *, mais d'apr√®s ma propre exp√©rience, je peux dire que rechercher un probl√®me via tail et grep n'est pas la solution la plus pratique.  √âtant donn√© que ManageIQ √©crit de nombreux journaux diff√©rents, vous devez prendre soin de rediriger les journaux, par exemple, vers la pile ELK. </p><br><h2 id="manageiq-api">  API ManageIQ </h2><br><p>  En plus d'une interface Web conviviale, ManageIQ dispose d'une API fonctionnelle.  Avec lui, par exemple, nous avons r√©solu le probl√®me de la d√©termination dynamique de l'identifiant du mod√®le √† sp√©cifier </p><br><div class="spoiler">  <b class="spoiler_title">lors de la cr√©ation d'une VM:</b> <div class="spoiler_text"><pre> <code class="ruby hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_template</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(vendor, os, ems)</span></span></span></span> user = <span class="hljs-string"><span class="hljs-string">'</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{user}</span></span></span><span class="hljs-string">'</span></span> pass = <span class="hljs-string"><span class="hljs-string">'</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{pass}</span></span></span><span class="hljs-string">'</span></span> options = { <span class="hljs-symbol"><span class="hljs-symbol">verify:</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">headers:</span></span> {<span class="hljs-string"><span class="hljs-string">"Accept"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"*/*"</span></span>, <span class="hljs-string"><span class="hljs-string">"accept-encoding"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"gzip, deflate"</span></span>}, <span class="hljs-symbol"><span class="hljs-symbol">basic_auth:</span></span> { <span class="hljs-symbol"><span class="hljs-symbol">username:</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{user}</span></span></span><span class="hljs-string">"</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">password:</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{pass}</span></span></span><span class="hljs-string">"</span></span> }, } response = HTTParty.get(<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{host}</span></span></span><span class="hljs-string">/api/templates?filter[]=vendor=%27</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{vendor}</span></span></span><span class="hljs-string">%27&amp;filter[]=name=%27%2A</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{os}</span></span></span><span class="hljs-string">%2A%27&amp;filter[]=ems_id=%27</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{ems}</span></span></span><span class="hljs-string">%27"</span></span>, options).to_s link = JSON.parse(response) link[<span class="hljs-string"><span class="hljs-string">"resources"</span></span>].each <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|r|</span></span> $url = r[<span class="hljs-string"><span class="hljs-string">"href"</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> response = HTTParty.get($url,options).to_s template = [<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{JSON.parse(response)[</span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">'id'</span></span></span></span><span class="hljs-string"><span class="hljs-subst">]}</span></span></span><span class="hljs-string">"</span></span>+<span class="hljs-string"><span class="hljs-string">", "</span></span>+<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{JSON.parse(response)[</span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">'name'</span></span></span></span><span class="hljs-string"><span class="hljs-subst">]}</span></span></span><span class="hljs-string">"</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> template <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> </div></div><br><p>  En utilisant une requ√™te POST et en sp√©cifiant des filtres pour la recherche, nous obtenons le mod√®le souhait√©. <br>  En plus de r√©soudre des probl√®mes internes, vous pouvez cr√©er de nouvelles m√©thodes API √† utiliser par des syst√®mes externes.  Au d√©but de l'article, le processus de commande d'une nouvelle machine virtuelle √† l'aide de l'interface Web a √©t√© montr√©.  Et voici √† quoi √ßa ressemble si vous le faites avec </p><br><div class="spoiler">  <b class="spoiler_title">Demande POST:</b> <div class="spoiler_text"><pre> <code class="ruby hljs">curl -X POST \ <span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/Manageiq.hostname/api</span></span><span class="hljs-regexp"><span class="hljs-regexp">/service_catalogs/</span></span><span class="hljs-number"><span class="hljs-number">4</span></span>/service_templates/<span class="hljs-number"><span class="hljs-number">31</span></span> \ -H <span class="hljs-string"><span class="hljs-string">'Authorization: Basic Token-Value'</span></span> \ -H <span class="hljs-string"><span class="hljs-string">'Content-Type: application/json'</span></span> \ -d <span class="hljs-string"><span class="hljs-string">'{ "action": "order", "resource": { "radio_button_vcpu": "a_2", "radio_button_vram": "a_2", "hdd_size": "40", "dropdown_os": "CentOS", "text_box_filter": "dns", "dropdown_list_information_system": "DNS ", "text_box_validator": "OK (DNS )", "textarea_box_usernotes": " ", "dropdown_env": "production", "date_control_retirement_dt": "2022-05-21", "dropdown_scope": "-" } }'</span></span></code> </pre> </div></div><br><h2 id="zaklyuchenie">  Conclusion </h2><br><h3 id="plyusy">  Avantages: </h3><br><ul><li>  Flexibilit√© incroyable: ManageIQ vous permet non seulement de personnaliser le processus d'automatisation selon vos besoins, mais permet √©galement de changer sa partie visuelle en ajoutant des boutons, des champs, etc. </li><li>  √âditeur de code int√©gr√© avec mise en √©vidence de la syntaxe et validation du code.  Cela m'a sembl√© une tr√®s bonne solution, si vous avez besoin de r√©parer rapidement quelque chose. </li><li>  Un grand nombre de sources avec lesquelles le syst√®me peut fonctionner.  Clouds: Amazon EC2, Google Compute Engine, Azure, OpenStack, VMware vCloud.  Infrastructure: Microsoft SCVMM, OpenStack Platform Director, Red Hat Virtualization, VMware vCenter.  Conteneurs: Kubernetes, OpenShift. </li></ul><br><h3 id="minusy">  Inconv√©nients: </h3><br><ul><li>  Les grandes capacit√©s de l'outil comportent √©galement un point n√©gatif.  Toute la documentation n'est pas bien structur√©e et il est parfois difficile de savoir o√π chercher ce dont vous avez besoin.  Cependant, il convient de noter que la situation √©volue pour le mieux, la documentation est compl√©t√©e et am√©lior√©e. </li><li>  Petite communaut√©.  Si vous rencontrez un probl√®me tr√®s sp√©cifique, vous ne pourrez peut-√™tre pas rapidement "google" la r√©ponse.  Ou pas du tout r√©ussir. </li><li>  Un paragraphe qui d√©coule des deux pr√©c√©dents.  Certaines choses de base, param√®tres et sc√©narios peuvent √™tre trouv√©s dans la documentation ou sur Internet, mais des questions plus sp√©cifiques et plus √©troites ont n√©cessit√© beaucoup de temps pour comprendre et √©tudier, y compris la m√©thode de piquer scientifique: sourire:. </li></ul><br><h3 id="kak-u-nas-seychas">  Comme nous l'avons maintenant: </h3><br><p>  √âtant donn√© que ManageIQ peut tirer pleinement parti du langage Ruby, nous avons pu l'int√©grer pour qu'il fonctionne avec les API suivantes: </p><br><ul><li>  Gestionnaire de mots de passe  Il g√©n√®re un mot de passe root conform√©ment aux exigences du service de s√©curit√©, l'√©crit dans sa base de donn√©es et ManageIQ l'utilise dans le syst√®me d'exploitation; </li><li>  Services Service Center Orchestration pour la gestion des enregistrements DNS et des noms d'h√¥te; </li><li>  BMC Remedy.  L'ensemble du processus est enregistr√© sous forme de commentaires sur la demande.  Apr√®s une ex√©cution r√©ussie, la demande est ferm√©e; </li><li>  CMDB  Des informations sur les nouvelles unit√©s de configuration sont cr√©√©es dans la base de donn√©es avec toutes les donn√©es n√©cessaires. </li><li>  Zabbix  Selon l'affiliation au syst√®me d'information et √† l'environnement, des h√¥tes sont ajout√©s aux groupes de surveillance correspondants. </li><li>  Rancher.  Impl√©mentation de la cr√©ation de nouveaux environnements, l'installation d'agents et l'enregistrement des h√¥tes dans les environnements existants. </li><li>  Jenkins  Jenkins ex√©cute des travaux pour configurer les machines virtuelles dans oVirt; </li><li>  LDAP  Cr√©ez de nouveaux groupes qui sont utilis√©s pour contr√¥ler l'acc√®s dans les environnements Rancher et pour configurer les strat√©gies dans Vault; </li><li>  Vault  Chez Home, l'int√©gration de ce produit dans les processus bancaires vient de commencer, mais nous avons d√©j√† √©labor√© des m√©thodes pour cr√©er de nouveaux groupes, politiques et sections de stockage; </li><li>  Puppet et IPAM ont √©t√© mentionn√©s pr√©c√©demment. </li></ul><br><p>  Les fonctionnalit√©s et les capacit√©s du syst√®me sont tr√®s √©tendues, et je me suis familiaris√© avec bon nombre d'entre elles et continue de me familiariser avec le processus de mise en ≈ìuvre du syst√®me. <br>  Par exemple, je n'ai pas mentionn√© que le syst√®me a la possibilit√© de cr√©er vos propres tableaux de bord avec des statistiques, des param√®tres de facturation ou des boutons, auxquels vous pouvez attacher des scripts individuels ou des scripts entiers.  Vous pouvez ajouter vos propres champs pour enregistrer des informations suppl√©mentaires sur les services et les machines virtuelles, etc. </p><br><h3 id="k-chemu-stremitsya-houm">  Ce que Home s'efforce de faire: </h3><br><ul><li>  Une mise √† niveau vers la version Hammer, dans laquelle en mode HA, vous pouvez essayer de travailler avec Ansible int√©gr√©. </li><li>  Le passage de la coordination de chaque unit√© de ressources virtuelles √† la gestion.  Les √©quipes pourront recevoir de nouvelles VM encore plus rapidement si le quota n'est pas √©puis√©. </li><li>  D√©veloppement de nouvelles m√©thodes pour la fourniture ult√©rieure √† des syst√®mes externes. </li><li>  Par exemple, divers SaaS comme jenkins, logstash, etc. </li><li>  Impl√©mentation de nouvelles m√©thodes API dans un portail existant pour les propri√©taires de syst√®mes d'information.  Les utilisateurs n'auront pas besoin de r√©fl√©chir √† la mani√®re de s'int√©grer au nouvel √©l√©ment d'infrastructure, ils l'utiliseront simplement comme un service pour obtenir de nouvelles ressources ou modifier celles existantes. </li></ul><br><p>  <em>√Ä la toute fin, je voudrais vous rappeler que les outils sont excellents, mais n'oubliez pas l'importance de l'interaction entre les diff√©rentes √©quipes.</em>  <em>Les changements d√©crits dans l'article n'auraient pas √©t√© possibles sans une communication bien √©tablie et une interaction constante sur les questions √©mergentes de toutes les parties int√©ress√©es.</em> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr461891/">https://habr.com/ru/post/fr461891/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr461877/index.html">Java vs Kotlin pour Android: avis des d√©veloppeurs</a></li>
<li><a href="../fr461879/index.html">Le livre "Linux en action"</a></li>
<li><a href="../fr461881/index.html">Guide de journalisation Node.js</a></li>
<li><a href="../fr461885/index.html">EDS est un autre type de fraude</a></li>
<li><a href="../fr461887/index.html">Entr√©e dans Aeronet Episode 2: Homing Drone</a></li>
<li><a href="../fr461895/index.html">Apprenez en voyage - comment nous avons conduit lors de la premi√®re journ√©e europ√©enne de l'analyse commerciale</a></li>
<li><a href="../fr461897/index.html">Comment nous maintenons la stabilit√© de l'application Lamoda</a></li>
<li><a href="../fr461899/index.html">G√©n√©ration d'√©v√©nements, CQRS et Laravel</a></li>
<li><a href="../fr461901/index.html">Trois ans d'autotests: comment augmenter la vitesse et pas seulement</a></li>
<li><a href="../fr461903/index.html">Adversaire myst√©rieux: emprunts flous</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>