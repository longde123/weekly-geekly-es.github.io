<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôâ üçÅ üòã GraphQL et Golang üë©‚Äçüç≥ üçñ ‚ÄºÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="La technologie GraphQL au cours des derni√®res ann√©es, apr√®s que la soci√©t√© Facebook l'a transf√©r√©e dans la cat√©gorie open-source, est devenue tr√®s pop...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>GraphQL et Golang</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/444346/">  La technologie GraphQL au cours des derni√®res ann√©es, apr√®s que la soci√©t√© Facebook l'a transf√©r√©e dans la cat√©gorie open-source, est devenue tr√®s populaire.  L'auteur du document, dont nous publions la traduction aujourd'hui, dit qu'il a essay√© de travailler avec GraphQL dans Node.js et, d'apr√®s sa propre exp√©rience, √©tait convaincu que cette technologie, en raison de ses capacit√©s et de sa simplicit√© remarquables, n'attire pas accidentellement autant d'attention.  R√©cemment, alors qu'il √©tait engag√© dans un nouveau projet, il est pass√© de Node.js √† Golang.  Puis il a d√©cid√© de tester la collaboration de Golang et GraphQL. <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/webt/jp/qa/qv/jpqaqvlt5xh7d7mlhwpxvvwhptq.jpeg"></a> <br><a name="habracut"></a><br><h2>  <font color="#3AC1EF">Informations pr√©liminaires</font> </h2><br>  Vous pouvez apprendre de la d√©finition officielle de GraphQL qu'il s'agit d'un langage de requ√™te pour l'API et d'un runtime pour ex√©cuter de telles requ√™tes sur des donn√©es existantes.  GraphQL fournit une description compl√®te et compr√©hensible des donn√©es dans une certaine API, permet aux clients de demander exactement les informations dont ils ont besoin, et rien de plus, simplifie le d√©veloppement de l'API au fil du temps et offre aux d√©veloppeurs des outils puissants. <br><br>  Il n'y a pas beaucoup de biblioth√®ques GraphQL pour Golang.  En particulier, j'ai essay√© des biblioth√®ques comme <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Thunder</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">graphql</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">graphql-go</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">gqlgen</a> .  Je dois noter que le meilleur de tout ce que j'ai essay√© √©tait la biblioth√®que gqlgen. <br><br>  La biblioth√®que gqlgen est toujours en version b√™ta, au moment de la r√©daction de ce document, il s'agissait de la version <a href="">0.7.2</a> .  La biblioth√®que √©volue rapidement.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Ici</a> vous pouvez d√©couvrir les plans de son d√©veloppement.  Maintenant, le sponsor officiel de gqlgen est le projet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">99designs</a> , ce qui signifie que cette biblioth√®que, tr√®s probablement, se d√©veloppera encore plus rapidement qu'auparavant.  Les principaux d√©veloppeurs de cette biblioth√®que sont <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">vektah</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">neelance</a> , tandis que neelance, en plus, travaille sur la biblioth√®que graphql-go. <br><br>  Parlons de la biblioth√®que gqlgen en supposant que vous avez d√©j√† des connaissances de base de GraphQL. <br><br><h2>  <font color="#3AC1EF">Fonctionnalit√©s de Gqlgen</font> </h2><br>  Dans la description de gqlgen, vous pouvez d√©couvrir ce que nous avons devant nous est une biblioth√®que pour cr√©er rapidement des serveurs GraphQL strictement typ√©s dans Golang.  Cette phrase me semble tr√®s prometteuse, car elle signifie que lorsque je travaille avec cette biblioth√®que, je ne rencontrerai pas quelque chose comme <code>map[string]interface{}</code> , car une approche bas√©e sur un typage strict est utilis√©e ici. <br><br>  De plus, cette biblioth√®que utilise une approche bas√©e sur un sch√©ma de donn√©es.  Cela signifie que les API sont d√©crites √† l'aide du langage de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">d√©finition de sch√©ma</a> GraphQL.  Ce langage poss√®de ses propres outils de g√©n√©ration de code puissants qui cr√©ent automatiquement du code GraphQL.  Dans ce cas, le programmeur ne peut impl√©menter que la logique de base des m√©thodes d'interface correspondantes. <br><br>  Cet article est divis√© en deux parties.  Le premier est consacr√© aux m√©thodes de travail de base et le second aux m√©thodes avanc√©es. <br><br><h2>  <font color="#3AC1EF">Les principales m√©thodes de travail: configuration, demandes de r√©ception et de modification de donn√©es, abonnements</font> </h2><br>  En tant qu'application exp√©rimentale, nous utiliserons un site o√π les utilisateurs pourront publier des vid√©os, ajouter des captures d'√©cran et des critiques, rechercher des vid√©os et afficher des listes d'enregistrements associ√©s √† d'autres enregistrements.  Commen√ßons √† travailler sur ce projet: <br><br><pre> <code class="go hljs">mkdir -p $GOPATH/src/github.com/ridhamtarpara/<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>-graphql-demo/</code> </pre> <br>  Cr√©ez le fichier de sch√©ma de donn√©es suivant ( <code>schema.graphql</code> ) dans le r√©pertoire racine du projet: <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> User {   id: ID!   name: String!   email: String! } <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Video {   id: ID!   name: String!   description: String!   user: User!   url: String!   createdAt: Timestamp!   screenshots: [Screenshot]   related(limit: Int = <span class="hljs-number"><span class="hljs-number">25</span></span>, offset: Int = <span class="hljs-number"><span class="hljs-number">0</span></span>): [Video!]! } <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Screenshot {   id: ID!   videoId: ID!   url: String! } input NewVideo {   name: String!   description: String!   userId: ID!   url: String! } <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Mutation {   createVideo(input: NewVideo!): Video! } <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Query {   Videos(limit: Int = <span class="hljs-number"><span class="hljs-number">25</span></span>, offset: Int = <span class="hljs-number"><span class="hljs-number">0</span></span>): [Video!]! } scalar Timestamp</code> </pre> <br>  Il d√©crit les mod√®les de donn√©es de base, une mutation ( <code>Mutation</code> , description de la demande de modification des donn√©es), qui est utilis√©e pour publier de nouveaux fichiers vid√©o sur le site, et une requ√™te ( <code>Query</code> ) pour obtenir une liste de tous les fichiers vid√©o.  En savoir plus sur le sch√©ma GraphQL <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> .  De plus, nous avons d√©clar√© ici l'un de nos propres types de donn√©es scalaires.  Nous ne sommes pas satisfaits des 5 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">types de</a> donn√©es scalaires standard ( <code>Int</code> , <code>Float</code> , <code>String</code> , <code>Boolean</code> et <code>ID</code> ) qui sont dans GraphQL. <br><br>  Si vous devez utiliser vos propres types, vous pouvez les d√©clarer dans <code>schema.graphql</code> (dans notre cas, ce type est <code>Timestamp</code> ) et fournir leurs d√©finitions dans le code.  Lorsque vous utilisez la biblioth√®que gqlgen, vous devez fournir des m√©thodes de marshaling et de d√©marshaling pour tous vos propres types scalaires et configurer le mappage √† l'aide de <code>gqlgen.yml</code> . <br><br>  Il convient de noter que dans la derni√®re version de la biblioth√®que, il y a eu un changement important.  √Ä savoir, la d√©pendance √† l'√©gard des fichiers binaires compil√©s en a √©t√© supprim√©e.  Par cons√©quent, le fichier <code>scripts/gqlgen.go</code> doit √™tre ajout√© au projet <code>scripts/gqlgen.go</code> contenu suivant: <br><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// +build ignore package main import "github.com/99designs/gqlgen/cmd" func main() { cmd.Execute() }</span></span></code> </pre> <br>  Apr√®s cela, vous devez initialiser <code>dep</code> : <br><br><pre> <code class="go hljs">dep init</code> </pre> <br>  Il est maintenant temps de profiter des capacit√©s de g√©n√©ration de code de la biblioth√®que.  Ils vous permettent de cr√©er tout le code passe-partout ennuyeux, qui, cependant, ne peut pas √™tre qualifi√© de compl√®tement inint√©ressant.  Pour d√©marrer le m√©canisme de g√©n√©ration automatique de code, ex√©cutez la commande suivante: <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">go</span></span> run scripts/gqlgen.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span> init</code> </pre> <br>  √Ä la suite de son ex√©cution, les fichiers suivants seront cr√©√©s: <br><br><ul><li>  <code>gqlgen.yml</code> : fichier de configuration pour g√©rer la g√©n√©ration de code. <br></li><li>  <code>generated.go</code> : code g√©n√©r√©. <br></li><li>  <code>models_gen.go</code> : tous les mod√®les et types de donn√©es du sch√©ma fourni. <br></li><li>  <code>resolver.go</code> : voici le code que le programmeur cr√©e. <br></li><li>  <code>server/server.go</code> : point d'entr√©e avec <code>http.Handler</code> pour d√©marrer le serveur GraphQL. <br></li></ul><br>  Jetez un ≈ìil au mod√®le g√©n√©r√© pour le type de <code>Video</code> (fichier <code>generated_video.go</code> ): <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Video <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { ID          <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>  <span class="hljs-string"><span class="hljs-string">`json:"id"`</span></span> Name        <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>  <span class="hljs-string"><span class="hljs-string">`json:"name"`</span></span> User        User  <span class="hljs-string"><span class="hljs-string">`json:"user"`</span></span> URL         <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>  <span class="hljs-string"><span class="hljs-string">`json:"url"`</span></span> CreatedAt   <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>  <span class="hljs-string"><span class="hljs-string">`json:"createdAt"`</span></span> Screenshots []*Screenshot <span class="hljs-string"><span class="hljs-string">`json:"screenshots"`</span></span> Related     []Video  <span class="hljs-string"><span class="hljs-string">`json:"related"`</span></span> }</code> </pre> <br>  Ici, vous pouvez voir que l' <code>ID</code> est une cha√Æne, <code>CreatedAt</code> est √©galement une cha√Æne.  Les autres mod√®les associ√©s sont configur√©s en cons√©quence.  Cependant, dans les applications r√©elles, cela n'est pas n√©cessaire.  Si vous utilisez n'importe quel type de donn√©es SQL, vous devez, par exemple, que le champ <code>ID</code> soit, selon la base de donn√©es utilis√©e, de type <code>int</code> ou <code>int64</code> . <br><br>  Par exemple, j'utilise PostgreSQL dans cette application de d√©monstration, donc bien s√ªr, j'ai besoin que le champ <code>ID</code> soit de type <code>int</code> et <code>CreatedAt</code> type <code>time.Time</code> .  Cela conduit au fait que nous devons d√©finir notre propre mod√®le et dire √† gqlgen que nous devons utiliser notre mod√®le au lieu d'en g√©n√©rer un nouveau.  Voici le contenu du fichier <code>models.go</code> : <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Video <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { ID          <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-string"><span class="hljs-string">`json:"id"`</span></span> Name        <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-string"><span class="hljs-string">`json:"name"`</span></span> Description <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>    <span class="hljs-string"><span class="hljs-string">`json:"description"`</span></span> User        User <span class="hljs-string"><span class="hljs-string">`json:"user"`</span></span> URL         <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-string"><span class="hljs-string">`json:"url"`</span></span> CreatedAt   time.Time <span class="hljs-string"><span class="hljs-string">`json:"createdAt"`</span></span> Related     []Video } <span class="hljs-comment"><span class="hljs-comment">//    int  ID func MarshalID(id int) graphql.Marshaler { return graphql.WriterFunc(func(w io.Writer) {   io.WriteString(w, strconv.Quote(fmt.Sprintf("%d", id))) }) } //        func UnmarshalID(v interface{}) (int, error) { id, ok := v.(string) if !ok {   return 0, fmt.Errorf("ids must be strings") } i, e := strconv.Atoi(id) return int(i), e } func MarshalTimestamp(t time.Time) graphql.Marshaler { timestamp := t.Unix() * 1000 return graphql.WriterFunc(func(w io.Writer) {   io.WriteString(w, strconv.FormatInt(timestamp, 10)) }) } func UnmarshalTimestamp(v interface{}) (time.Time, error) { if tmpStr, ok := v.(int); ok {   return time.Unix(int64(tmpStr), 0), nil } return time.Time{}, errors.TimeStampError }</span></span></code> </pre> <br>  Nous indiquons √† la biblioth√®que qu'elle doit utiliser ces mod√®les (fichier <code>gqlgen.yml</code> ): <br><br><pre> <code class="go hljs">schema: - schema.graphql exec: filename: generated.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span> model: filename: models_gen.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span> resolver: filename: resolver.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: Resolver models: Video:   model: github.com/ridhamtarpara/<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>-graphql-demo/api.Video ID:   model: github.com/ridhamtarpara/<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>-graphql-demo/api.ID Timestamp:   model: github.com/ridhamtarpara/<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>-graphql-demo/api.Timestamp</code> </pre> <br>  Le point de tout cela est que nous avons maintenant nos propres d√©finitions d' <code>ID</code> et d' <code>Timestamp</code> avec des m√©thodes de marshaling et de d√©marshaling et de mappage dans le fichier <code>gqlgen.yml</code> .  Maintenant que l'utilisateur fournit la cha√Æne en tant <code>UnmarshalID()</code> , la m√©thode <code>UnmarshalID()</code> convertit cette cha√Æne en un entier.  Lors de l'envoi d'une r√©ponse, la m√©thode <code>MarshalID()</code> convertit le nombre en cha√Æne.  La m√™me chose se produit avec <code>Timestamp</code> ou avec tout autre type scalaire d√©clar√© par le programmeur. <br><br>  Il est maintenant temps de mettre en ≈ìuvre la logique d'application.  Ouvrez le fichier <code>resolver.go</code> et ajoutez-y des descriptions des mutations et des requ√™tes.  Il existe d√©j√† un code passe-partout g√©n√©r√© automatiquement que nous devons remplir de sens.  Voici le code de ce fichier: <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(r *mutationResolver)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateVideo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ctx context.Context, input NewVideo)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(api.Video, error)</span></span></span></span> { newVideo := api.Video{   URL:         input.URL,   Name:        input.Name,   CreatedAt:   time.Now().UTC(), } rows, err := dal.LogAndQuery(r.db, <span class="hljs-string"><span class="hljs-string">"INSERT INTO videos (name, url, user_id, created_at) VALUES($1, $2, $3, $4) RETURNING id"</span></span>,   input.Name, input.URL, input.UserID, newVideo.CreatedAt) <span class="hljs-keyword"><span class="hljs-keyword">defer</span></span> rows.Close() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> || !rows.Next() {   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> api.Video{}, err } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err := rows.Scan(&amp;newVideo.ID); err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> {   errors.DebugPrintf(err)   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> errors.IsForeignKeyError(err) {     <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> api.Video{}, errors.UserNotExist   }   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> api.Video{}, errors.InternalServerError } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> newVideo, <span class="hljs-literal"><span class="hljs-literal">nil</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(r *queryResolver)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Videos</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ctx context.Context, limit *</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">, offset *</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">([]api.Video, error)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> video api.Video <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> videos []api.Video rows, err := dal.LogAndQuery(r.db, <span class="hljs-string"><span class="hljs-string">"SELECT id, name, url, created_at, user_id FROM videos ORDER BY created_at desc limit $1 offset $2"</span></span>, limit, offset) <span class="hljs-keyword"><span class="hljs-keyword">defer</span></span> rows.Close();   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> {   errors.DebugPrintf(err)   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, errors.InternalServerError } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> rows.Next() {   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err := rows.Scan(&amp;video.ID, &amp;video.Name, &amp;video.URL, &amp;video.CreatedAt, &amp;video.UserID); err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> {     errors.DebugPrintf(err)     <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, errors.InternalServerError   }   videos = <span class="hljs-built_in"><span class="hljs-built_in">append</span></span>(videos, video) } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> videos, <span class="hljs-literal"><span class="hljs-literal">nil</span></span> }</code> </pre> <br>  Maintenant, testons la mutation. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f7b/a2c/01f/f7ba2c01f766ebc31ed90880376136f1.png"></div>  <i><font color="#999999">Mutation createVideo</font></i> <br><br>  √áa marche!  Mais pourquoi n'y a-t-il rien dans les informations <code>user</code> (objet <code>user</code> )?  Lorsque vous travaillez avec GraphQL, des concepts similaires au chargement ¬´paresseux¬ª (paresseux) et ¬´gourmand¬ª (impatient) sont applicables.  √âtant donn√© que ce syst√®me est extensible, vous devez sp√©cifier quels champs doivent √™tre remplis ¬´avec avidit√©¬ª et lesquels sont ¬´paresseux¬ª. <br><br>  J'ai sugg√©r√© √† l'√©quipe de l'organisation o√π je travaille la ¬´r√®gle d'or¬ª suivante qui s'applique lors de l'utilisation de gqlgen: ¬´N'incluez pas dans le mod√®le les champs qui doivent √™tre charg√©s uniquement s'ils sont demand√©s par le client.¬ª <br><br>  Dans notre cas, je dois t√©l√©charger des donn√©es sur les clips vid√©o associ√©s (et m√™me des informations utilisateur) uniquement si le client demande ces champs.  Mais puisque nous avons inclus ces champs dans le mod√®le, gqlgen suppose que nous fournissons ces donn√©es en recevant des informations sur la vid√©o.  En cons√©quence, nous obtenons maintenant des structures vides. <br><br>  Parfois, il arrive qu'un certain type de donn√©es soit n√©cessaire √† chaque fois, il est donc impossible de le t√©l√©charger √† l'aide d'une demande distincte.  Pour cela, afin d'am√©liorer les performances, vous pouvez utiliser quelque chose comme des jointures SQL.  Une fois (cela ne s'applique toutefois pas √† l'exemple consid√©r√© ici), j'ai d√ª t√©l√©charger ses m√©tadonn√©es avec la vid√©o.  Ces entit√©s √©taient stock√©es √† diff√©rents endroits.  Par cons√©quent, si mon syst√®me recevait une demande de t√©l√©chargement d'une vid√©o, je devais faire une autre demande pour obtenir des m√©tadonn√©es.  Mais, comme je connaissais cette exigence (c'est-√†-dire que je savais que le client et la vid√©o et ses m√©tadonn√©es sont toujours n√©cessaires du c√¥t√© client), j'ai pr√©f√©r√© utiliser la technique de chargement gourmand pour am√©liorer les performances. <br><br>  R√©√©crivons le mod√®le et g√©n√©rons √† nouveau le code gqlgen.  Afin de ne pas compliquer l'histoire, nous √©crivons uniquement des m√©thodes pour le champ <code>user</code> (fichier <code>models.go</code> ): <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Video <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { ID          <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-string"><span class="hljs-string">`json:"id"`</span></span> Name        <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-string"><span class="hljs-string">`json:"name"`</span></span> Description <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>    <span class="hljs-string"><span class="hljs-string">`json:"description"`</span></span> UserID      <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-string"><span class="hljs-string">`json:"-"`</span></span> URL         <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-string"><span class="hljs-string">`json:"url"`</span></span> CreatedAt   time.Time <span class="hljs-string"><span class="hljs-string">`json:"createdAt"`</span></span> }</code> </pre> <br>  Nous avons ajout√© un <code>UserID</code> et supprim√© la structure <code>User</code> .  R√©g√©n√©rez maintenant le code: <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">go</span></span> run scripts/gqlgen.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span> -v</code> </pre> <br>  Gr√¢ce √† cette commande, les m√©thodes d'interface suivantes seront cr√©√©es pour r√©soudre les structures non d√©finies.  De plus, vous devrez d√©terminer les √©l√©ments suivants dans le r√©solveur (fichier g√©n√©r√©.go): <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> VideoResolver <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> { User(ctx context.Context, obj *api.Video) (api.User, error) Screenshots(ctx context.Context, obj *api.Video) ([]*api.Screenshot, error) Related(ctx context.Context, obj *api.Video, limit *<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, offset *<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) ([]api.Video, error) }</code> </pre> <br>  Voici la d√©finition (fichier <code>resolver.go</code> ): <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(r *videoResolver)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">User</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ctx context.Context, obj *api.Video)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(api.User, error)</span></span></span></span> { rows, _ := dal.LogAndQuery(r.db,<span class="hljs-string"><span class="hljs-string">"SELECT id, name, email FROM users where id = $1"</span></span>, obj.UserID) <span class="hljs-keyword"><span class="hljs-keyword">defer</span></span> rows.Close() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> !rows.Next() {   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> api.User{}, <span class="hljs-literal"><span class="hljs-literal">nil</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> user api.User <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err := rows.Scan(&amp;user.ID, &amp;user.Name, &amp;user.Email); err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> {   errors.DebugPrintf(err)   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> api.User{}, errors.InternalServerError } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> user, <span class="hljs-literal"><span class="hljs-literal">nil</span></span> }</code> </pre> <br>  Maintenant, les r√©sultats du test de mutation se pr√©senteront comme indiqu√© ci-dessous. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/25a/41d/aaa/25a41daaa86b8db5407bd432312c3028.png"></div><br>  <i><font color="#999999">Mutation createVideo</font></i> <br><br>  Ce que nous venons de discuter, ce sont les principes fondamentaux de GraphQL, apr√®s avoir ma√Ætris√© lequel, vous pouvez d√©j√† √©crire quelque chose de vous-m√™me.  Cependant, avant de vous lancer dans des exp√©riences avec GraphQL et Golang, il sera utile de parler des abonnements, qui sont directement li√©s √† ce que nous faisons ici. <br><br><h3>  <font color="#3AC1EF">‚ñç Abonnements</font> </h3><br>  GraphQL offre la possibilit√© de s'abonner aux modifications de donn√©es qui se produisent en temps r√©el.  La biblioth√®que gqlgen permet, en temps r√©el, √† l'aide de sockets web, de travailler avec des √©v√©nements d'abonnement. <br><br>  L'abonnement doit √™tre d√©crit dans le fichier <code>schema.graphql</code> .  Voici la description de l'abonnement √† l'√©v√©nement de publication vid√©o: <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Subscription {   videoPublished: Video! }</code> </pre> <br>  Maintenant, ex√©cutez √† nouveau la g√©n√©ration automatique de code: <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">go</span></span> run scripts/gqlgen.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span> -v</code> </pre> <br>  Comme d√©j√† mentionn√©, lors de la cr√©ation automatique de code dans le fichier g√©n√©r√©.go, une interface est cr√©√©e qui doit √™tre impl√©ment√©e dans le module de reconnaissance.  Dans notre cas, cela ressemble √† ceci (fichier <code>resolver.go</code> ): <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> videoPublishedChannel <span class="hljs-keyword"><span class="hljs-keyword">map</span></span>[<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]<span class="hljs-keyword"><span class="hljs-keyword">chan</span></span> api.Video <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { videoPublishedChannel = <span class="hljs-keyword"><span class="hljs-keyword">map</span></span>[<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]<span class="hljs-keyword"><span class="hljs-keyword">chan</span></span> api.Video{} } <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> subscriptionResolver <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span>{ *Resolver } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(r *subscriptionResolver)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">VideoPublished</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ctx context.Context)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(&lt;-</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">chan</span></span></span></span><span class="hljs-function"><span class="hljs-params"> api.Video, error)</span></span></span></span> { id := randx.String(<span class="hljs-number"><span class="hljs-number">8</span></span>) videoEvent := <span class="hljs-built_in"><span class="hljs-built_in">make</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">chan</span></span> api.Video, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> {   &lt;-ctx.Done() }() videoPublishedChannel[id] = videoEvent <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> videoEvent, <span class="hljs-literal"><span class="hljs-literal">nil</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(r *mutationResolver)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateVideo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ctx context.Context, input NewVideo)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(api.Video, error)</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">//   ... for _, observer := range videoPublishedChannel {   observer &lt;- newVideo } return newVideo, nil }</span></span></code> </pre> <br>  Maintenant, lorsque vous cr√©ez une nouvelle vid√©o, vous devez d√©clencher un √©v√©nement.  Dans notre exemple, cela se fait dans la ligne <code>for _, observer := range videoPublishedChannel</code> . <br><br>  Il est maintenant temps de v√©rifier votre abonnement. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f71/d7f/42b/f71d7f42b147f59d227a25e577ef57fb.gif"></div><br>  <i><font color="#999999">V√©rifier l'abonnement</font></i> <br><br>  GraphQL, bien s√ªr, poss√®de certaines capacit√©s pr√©cieuses, mais comme on dit, tout ce qui brille n'est pas or.  √Ä savoir, nous parlons du fait que quelqu'un qui utilise GraphQL doit prendre soin de l'autorisation, de la complexit√© des demandes, de la mise en cache, du probl√®me des demandes N + 1, de la limitation de la vitesse d'ex√©cution des requ√™tes et d'autres choses.  Sinon, un syst√®me d√©velopp√© √† l'aide de GraphQL peut faire face √† une baisse s√©rieuse des performances. <br><br><h2>  <font color="#3AC1EF">Techniques avanc√©es: authentification, chargeurs de donn√©es, complexit√© des requ√™tes</font> </h2><br>  Chaque fois que je lis des manuels comme celui-ci, j'ai l'impression qu'apr√®s les avoir ma√Ætris√©s, j'apprends tout ce que je dois savoir sur une certaine technologie et j'ai la capacit√© de r√©soudre des probl√®mes de toute complexit√©. <br><br>  Mais lorsque je commence √† travailler sur mes propres projets, je me retrouve g√©n√©ralement dans des situations impr√©vues qui ressemblent √† des erreurs de serveur ou √† des demandes en cours depuis des si√®cles, ou √† d'autres situations de blocage.  Par cons√©quent, pour ce faire, je dois mieux me plonger dans ce qui, tout r√©cemment, semblait parfaitement compr√©hensible.  Dans ce m√™me manuel, j'esp√®re que cela pourra √™tre √©vit√©.  C'est pourquoi dans cette section, nous examinerons quelques techniques avanc√©es pour travailler avec GraphQL. <br><br><h3>  <font color="#3AC1EF">‚ñç Authentification</font> </h3><br>  Lorsque vous travaillez avec l'API REST, nous avons un syst√®me d'authentification et des outils d'autorisation standard lorsque vous travaillez avec un certain point de terminaison.  Mais lorsque vous utilisez GraphQL, un seul point de terminaison est utilis√©, par cons√©quent, les t√¢ches d'authentification peuvent √™tre r√©solues √† l'aide de directives de sch√©ma.  Modifiez le fichier <code>schema.graphql</code> comme suit: <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Mutation {   createVideo(input: NewVideo!): Video! @isAuthenticated } directive @isAuthenticated on FIELD_DEFINITION</code> </pre> <br>  Nous avons cr√©√© la directive <code>isAuthenticated</code> et l' <code>isAuthenticated</code> appliqu√©e √† l'abonnement <code>createVideo</code> .  Apr√®s la prochaine session de g√©n√©ration automatique de code, vous devez d√©finir une d√©finition pour cette directive.  Maintenant, les directives sont impl√©ment√©es sous forme de m√©thodes de structures, et non sous forme d'interfaces, nous devons donc les d√©crire.  J'ai √©dit√© le code g√©n√©r√© automatiquement situ√© dans le fichier <code>server.go</code> et cr√©√© une m√©thode qui renvoie la configuration GraphQL pour le fichier <code>server.go</code> .  Voici le fichier <code>resolver.go</code> : <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NewRootResolvers</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(db *sql.DB)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Config</span></span></span></span> { c := Config{   Resolvers: &amp;Resolver{     db: db,   }, } <span class="hljs-comment"><span class="hljs-comment">//   c.Directives.IsAuthenticated = func(ctx context.Context, obj interface{}, next graphql.Resolver) (res interface{}, err error) {   ctxUserID := ctx.Value(UserIDCtxKey)   if ctxUserID != nil {     return next(ctx)   } else {     return nil, errors.UnauthorisedError   } } return c }</span></span></code> </pre> <br>  Voici le fichier <code>server.go</code> : <br><br><pre> <code class="go hljs">rootHandler:= dataloaders.DataloaderMiddleware(   db,   handler.GraphQL(     go_graphql_demo.NewExecutableSchema(go_graphql_demo.NewRootResolvers(db)   ) ) http.Handle(<span class="hljs-string"><span class="hljs-string">"/query"</span></span>, auth.AuthMiddleware(rootHandler))</code> </pre> <br>  Nous lisons l' <code>ID</code> utilisateur dans le contexte.  Ne trouvez-vous pas cela √©trange?  Comment ce sens est-il entr√© dans son contexte et pourquoi est-il m√™me apparu dans son contexte?  Le fait est que gqlgen fournit des contextes de requ√™te uniquement au niveau de l'impl√©mentation, nous n'avons donc aucun moyen de lire les donn√©es de requ√™te HTTP, telles que les en-t√™tes ou les cookies, dans les programmes de reconnaissance ou les directives.  Par cons√©quent, vous devez ajouter vos propres m√©canismes interm√©diaires au syst√®me, recevoir ces donn√©es et les mettre en contexte. <br><br>  Nous devons maintenant d√©crire notre propre m√©canisme d'authentification interm√©diaire pour obtenir les donn√©es d'authentification de la demande et les v√©rifier. <br><br>  Aucune logique n'est d√©finie ici.  Au lieu de cela, pour les donn√©es d'autorisation, √† des fins de d√©monstration, l' <code>ID</code> utilisateur <code>ID</code> simplement transmis ici.  Ce m√©canisme est ensuite combin√© dans <code>server.go</code> avec une nouvelle m√©thode de chargement de configuration. <br><br>  Maintenant, la description de la directive a du sens.  Nous ne traitons pas les demandes d'utilisateurs non autoris√©s dans le code du middleware, car ces demandes seront trait√©es par la directive.  Voici √† quoi √ßa ressemble. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6f6/a26/09c/6f6a2609cec8936c024fd68c7ed30096.png"></div><br>  <i><font color="#999999">Travailler avec un utilisateur non autoris√©</font></i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/267/b92/378/267b923783521a82738973f82600a2a4.png"></div><br>  <i><font color="#999999">Travailler avec un utilisateur autoris√©</font></i> <br><br>  Lorsque vous travaillez avec des directives de sch√©ma, vous pouvez m√™me passer des arguments: <br><br><pre> <code class="go hljs">directive @hasRole(role: Role!) on FIELD_DEFINITION enum Role { ADMIN USER }</code> </pre> <br><h3>  <font color="#3AC1EF">‚ñç Chargeurs de donn√©es</font> </h3><br>  Il me semble que tout cela semble assez int√©ressant.  Vous t√©l√©chargez des donn√©es lorsque vous en avez besoin.  Les clients ont la capacit√© de g√©rer les donn√©es; exactement ce qui est n√©cessaire provient du stockage.  Mais tout a un prix. <br><br>  Quel est le prix √† payer pour ces opportunit√©s?  Jetez un ≈ìil aux journaux de t√©l√©chargement de toutes les vid√©os.  A savoir, nous parlons du fait que nous avons 8 vid√©os et 5 utilisateurs. <br><br><pre> <code class="go hljs">query{ Videos(limit: <span class="hljs-number"><span class="hljs-number">10</span></span>){   name   user{     name   } } }</code> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/562/7c1/b5c/5627c1b5c34f74aec26381f8b0431147.png"></div><br>  <i><font color="#999999">D√©tails du t√©l√©chargement de la vid√©o</font></i> <br><br><pre> <code class="go hljs">Query: Videos : SELECT id, name, description, url, created_at, user_id FROM videos ORDER BY created_at desc limit $<span class="hljs-number"><span class="hljs-number">1</span></span> offset $<span class="hljs-number"><span class="hljs-number">2</span></span> Resolver: User : SELECT id, name, email FROM users where id = $<span class="hljs-number"><span class="hljs-number">1</span></span> Resolver: User : SELECT id, name, email FROM users where id = $<span class="hljs-number"><span class="hljs-number">1</span></span> Resolver: User : SELECT id, name, email FROM users where id = $<span class="hljs-number"><span class="hljs-number">1</span></span> Resolver: User : SELECT id, name, email FROM users where id = $<span class="hljs-number"><span class="hljs-number">1</span></span> Resolver: User : SELECT id, name, email FROM users where id = $<span class="hljs-number"><span class="hljs-number">1</span></span> Resolver: User : SELECT id, name, email FROM users where id = $<span class="hljs-number"><span class="hljs-number">1</span></span> Resolver: User : SELECT id, name, email FROM users where id = $<span class="hljs-number"><span class="hljs-number">1</span></span> Resolver: User : SELECT id, name, email FROM users where id = $<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br>  Que se passe-t-il ici?  Pourquoi y a-t-il 9 demandes (1 demande est associ√©e √† la table vid√©o et 8 - √† la table utilisateur)?  √áa a l'air horrible.  Mon c≈ìur s'est presque arr√™t√© quand j'ai pens√© que notre API existante devrait √™tre remplac√©e par ceci ... Vrai, les chargeurs de donn√©es peuvent compl√®tement faire face √† ce probl√®me. <br><br>  Ceci est connu comme le probl√®me N + 1. Nous parlons du fait qu'il y a une requ√™te pour obtenir toutes les donn√©es et pour chaque √©l√©ment de donn√©es (N) il y aura une autre requ√™te dans la base de donn√©es. <br><br>  Il s'agit d'un probl√®me tr√®s grave en termes de performances et de ressources: bien que ces demandes soient parall√®les, elles drainent les ressources syst√®me. <br><br>  Pour r√©soudre ce probl√®me, nous utiliserons la biblioth√®que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">dataloaden</a> de l'auteur de la biblioth√®que gqlgen.  Cette biblioth√®que vous permet de g√©n√©rer du code Go.  Tout d'abord, g√©n√©rez un chargeur de donn√©es pour l'entit√© <code>User</code> : <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">go</span></span> get github.com/vektah/dataloaden dataloaden github.com/ridhamtarpara/<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>-graphql-demo/api.User</code> </pre> <br>  Nous avons √† notre disposition le fichier <code>userloader_gen.go</code> , qui a des m√©thodes comme <code>Fetch</code> , <code>LoadAll</code> et <code>Prime</code> . <br><br>  Maintenant, pour obtenir des r√©sultats g√©n√©raux, nous devons d√©finir la m√©thode <code>Fetch</code> (fichier <code>dataloader.go</code> ): <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DataloaderMiddleware</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(db *sql.DB, next http.Handler)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">http</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Handler</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> http.HandlerFunc(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span></span></span> {   userloader := UserLoader{     wait : <span class="hljs-number"><span class="hljs-number">1</span></span> * time.Millisecond,     maxBatch: <span class="hljs-number"><span class="hljs-number">100</span></span>,     fetch: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ids []</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">([]*api.User, []error)</span></span></span></span> {       <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sqlQuery <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-built_in"><span class="hljs-built_in">len</span></span>(ids) == <span class="hljs-number"><span class="hljs-number">1</span></span> {         sqlQuery = <span class="hljs-string"><span class="hljs-string">"SELECT id, name, email from users WHERE id = ?"</span></span>       } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {         sqlQuery = <span class="hljs-string"><span class="hljs-string">"SELECT id, name, email from users WHERE id IN (?)"</span></span>       }       sqlQuery, arguments, err := sqlx.In(sqlQuery, ids)       <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> {         log.Println(err)       }       sqlQuery = sqlx.Rebind(sqlx.DOLLAR, sqlQuery)       rows, err := dal.LogAndQuery(db, sqlQuery, arguments...)       <span class="hljs-keyword"><span class="hljs-keyword">defer</span></span> rows.Close();       <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> {         log.Println(err)       }       userById := <span class="hljs-keyword"><span class="hljs-keyword">map</span></span>[<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>]*api.User{}       <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> rows.Next() {         user:= api.User{}         <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err := rows.Scan(&amp;user.ID, &amp;user.Name, &amp;user.Email); err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> {           errors.DebugPrintf(err)           <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, []error{errors.InternalServerError}         }         userById[user.ID] = &amp;user       }       users := <span class="hljs-built_in"><span class="hljs-built_in">make</span></span>([]*api.User, <span class="hljs-built_in"><span class="hljs-built_in">len</span></span>(ids))       <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i, id := <span class="hljs-keyword"><span class="hljs-keyword">range</span></span> ids {         users[i] = userById[id]         i++       }       <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> users, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>     },   }   ctx := context.WithValue(r.Context(), CtxKey, &amp;userloader)   r = r.WithContext(ctx)   next.ServeHTTP(w, r) }) }</code> </pre> <br>  Ici, nous attendons 1 ms.  avant d'ex√©cuter la demande et de collecter les demandes dans des packages contenant jusqu'√† 100 demandes.  Maintenant, au lieu d'ex√©cuter une demande pour chaque utilisateur individuellement, le chargeur attendra le temps sp√©cifi√© avant d'acc√©der √† la base de donn√©es.  Ensuite, vous devez modifier la logique de reconnaissance en la reconfigurant √† l'aide de la demande d'utilisation du chargeur de donn√©es (fichier <code>resolver.go</code> ): <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(r *videoResolver)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">User</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ctx context.Context, obj *api.Video)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(api.User, error)</span></span></span></span> { user, err := ctx.Value(dataloaders.CtxKey).(*dataloaders.UserLoader).Load(obj.UserID) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> *user, err }</code> </pre> <br>  Voici comment les journaux s'en occupent dans une situation similaire √† celle d√©crite ci-dessus: <br><br><pre> <code class="go hljs">Query: Videos : SELECT id, name, description, url, created_at, user_id FROM videos ORDER BY created_at desc limit $<span class="hljs-number"><span class="hljs-number">1</span></span> offset $<span class="hljs-number"><span class="hljs-number">2</span></span> Dataloader: User : SELECT id, name, email from users WHERE id IN ($<span class="hljs-number"><span class="hljs-number">1</span></span>, $<span class="hljs-number"><span class="hljs-number">2</span></span>, $<span class="hljs-number"><span class="hljs-number">3</span></span>, $<span class="hljs-number"><span class="hljs-number">4</span></span>, $<span class="hljs-number"><span class="hljs-number">5</span></span>)</code> </pre> <br>  Seules deux requ√™tes de base de donn√©es sont ex√©cut√©es ici, par cons√©quent, tout le monde est maintenant satisfait.  Il est int√©ressant de noter que seuls 5 identifiants d'utilisateurs sont envoy√©s √† la demande, bien que des donn√©es soient demand√©es pour 8 vid√©os.  Cela sugg√®re que le chargeur de donn√©es supprime les enregistrements en double. <br><br><h3> <font color="#3AC1EF">‚ñç </font> </h3><br> GraphQL   API  ,    .    ,   API   DOS-. <br><br>     ,     . <br><br>   <code>Video</code>  ,   .      GraphQL  <code>Video</code> .           .   ‚Äî  . <br><br>  ,      ‚Äî   : <br><br><pre> <code class="go hljs">{ Videos(limit: <span class="hljs-number"><span class="hljs-number">10</span></span>, offset: <span class="hljs-number"><span class="hljs-number">0</span></span>){   name   url   related(limit: <span class="hljs-number"><span class="hljs-number">10</span></span>, offset: <span class="hljs-number"><span class="hljs-number">0</span></span>){     name     url     related(limit: <span class="hljs-number"><span class="hljs-number">10</span></span>, offset: <span class="hljs-number"><span class="hljs-number">0</span></span>){       name       url       related(limit: <span class="hljs-number"><span class="hljs-number">100</span></span>, offset: <span class="hljs-number"><span class="hljs-number">0</span></span>){         name         url       }     }   } } }</code> </pre> <br>           100,        .  (, , )    ,         . <br><br>  gqlgen      ,     .     ,       ( <code>handler.ComplexityLimit(300)</code>   )   GraphQL     (300   ).  ,     ( <code>server.go</code> ): <br><br><pre> <code class="go hljs">rootHandler:= dataloaders.DataloaderMiddleware( db, handler.GraphQL(   go_graphql_demo.NewExecutableSchema(go_graphql_demo.NewRootResolvers(db)),   handler.ComplexityLimit(<span class="hljs-number"><span class="hljs-number">300</span></span>) ), )</code> </pre> <br>       ,   ,        .        12.   ,       ,   ,      ( ,  ,  ,   ,     ).    <code>resolver.go</code> : <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NewRootResolvers</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(db *sql.DB)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Config</span></span></span></span> { c := Config{   Resolvers: &amp;Resolver{     db: db,   }, } <span class="hljs-comment"><span class="hljs-comment">//  countComplexity := func(childComplexity int, limit *int, offset *int) int {   return *limit * childComplexity } c.Complexity.Query.Videos = countComplexity c.Complexity.Video.Related = countComplexity //   c.Directives.IsAuthenticated = func(ctx context.Context, obj interface{}, next graphql.Resolver) (res interface{}, err error) {   ctxUserID := ctx.Value(UserIDCtxKey)   if ctxUserID != nil {     return next(ctx)   } else {     return nil, errors.UnauthorisedError   } } return c }</span></span></code> </pre> <br>     ,     ,       . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d0a/702/045/d0a7020450bf5115f69c6a1ba61beca4.png"></div><br> <i><font color="#999999">    </font></i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/057/fec/7e3/057fec7e30f98b63aed8bbb6aec5193f.png"></div><br> <i><font color="#999999">      </font></i> <br><br>       ,   ,   <code>related</code>  . , , ,      ,             . <br><br><h2>  <font color="#3AC1EF">R√©sum√©</font> </h2><br> ,        ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">GitHub</a> .         .       ,     ,      . <br><br>  <b>Chers lecteurs!</b>     GraphQL  ,   Go? <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/files/1ba/550/d25/1ba550d25e8846ce8805de564da6aa63.png"></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr444346/">https://habr.com/ru/post/fr444346/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr444336/index.html">Listes de capture Swift: quelle est la diff√©rence entre les liens faibles, forts et non poss√©d√©s?</a></li>
<li><a href="../fr444338/index.html">Encapsulation dans Python 3</a></li>
<li><a href="../fr444340/index.html">Caract√©ristiques de l'utilisation du type de donn√©es Symbol en JavaScript</a></li>
<li><a href="../fr444342/index.html">D√©veloppement d'applications JavaScript simples et modernes √† l'aide de Webpack et de technologies Web avanc√©es</a></li>
<li><a href="../fr444344/index.html">10 √©tapes pour r√©ussir un projet Python</a></li>
<li><a href="../fr444348/index.html">En quoi les composants React fonctionnels sont-ils diff√©rents des composants bas√©s sur les classes?</a></li>
<li><a href="../fr444350/index.html">Pour une raison quelconque, MVP (produit minimum viable) ne d√©marre pas</a></li>
<li><a href="../fr444352/index.html">Kontur.Kampus: nous vous invitons √† un camp √©tudiant gratuit de d√©veloppement industriel pr√®s de Saint-P√©tersbourg</a></li>
<li><a href="../fr444356/index.html">Tutoriel React, partie 24: Le√ßon sur les seconds formulaires</a></li>
<li><a href="../fr444358/index.html">Enumerable: comment g√©n√©rer une valeur commerciale</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>