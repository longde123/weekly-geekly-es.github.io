<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üòê üïäÔ∏è üë©üèø‚Äçü§ù‚Äçüë®üèΩ So sparen Sie mit einer testgetriebenen Entwicklung Geld f√ºr einen Therapeuten ‚ÜïÔ∏è ‚óΩÔ∏è ‚òùÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hattest du jemals diesen Zustand? 


 Ich m√∂chte Ihnen anhand eines bestimmten Beispiels zeigen, wie TDD die Codequalit√§t verbessern kann. 
 Weil alle...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>So sparen Sie mit einer testgetriebenen Entwicklung Geld f√ºr einen Therapeuten</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/leroy_merlin/blog/456662/">  Hattest du jemals diesen Zustand? <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/bl/td/so/bltdsone5ewlnnqa_aamnii9rl8.jpeg" alt="Bild"></div><br>  Ich m√∂chte Ihnen anhand eines bestimmten Beispiels zeigen, wie TDD die Codequalit√§t verbessern kann. <br>  Weil alles, was ich w√§hrend des Studiums kennengelernt habe, ziemlich theoretisch war. <br>  So kam es, dass ich zwei fast identische Anwendungen schrieb: eine wurde im klassischen Stil geschrieben, da ich TDD damals nicht kannte, und die zweite - nur mit TDD. <br><br>  Im Folgenden werde ich zeigen, wo die gr√∂√üten Unterschiede waren. <br><br>  Pers√∂nlich war mir das wichtig, denn jedes Mal, wenn jemand einen Fehler in meinem Code fand, bekam ich ein schweres Minus f√ºr das Selbstwertgef√ºhl.  Ja, ich habe verstanden, dass Fehler normal sind, jeder schreibt sie, aber das Gef√ºhl der Minderwertigkeit ist nicht verschwunden.  W√§hrend der Weiterentwicklung des Dienstes wurde mir manchmal klar, dass ich selbst einen so geschrieben habe, dass es mich juckte, alles rauszuwerfen und erneut zu schreiben.  Und wie es passiert ist, ist unverst√§ndlich.  Irgendwie war am Anfang alles in Ordnung, aber nach ein paar Features und nach einer Weile kann man Architektur nicht ohne Tr√§nen betrachten.  Obwohl es scheint, dass jeder Schritt der √Ñnderung logisch war.  Das Gef√ºhl, dass ich das Produkt meiner eigenen Arbeit nicht mochte, floss reibungslos in das Gef√ºhl ein, dass der Programmierer von mir war, entschuldigen Sie, wie eine Kugel aus Schei√üe. <br><br>  Es stellte sich heraus, dass ich nicht der einzige bin und viele meiner Kollegen √§hnliche Empfindungen haben.  Und dann beschloss ich, entweder normal schreiben zu lernen oder meinen Beruf zu wechseln.  Ich habe eine testgetriebene Entwicklung versucht, um etwas an meinem Programmieransatz zu √§ndern. <br><br>  Mit Blick auf die Ergebnisse mehrerer Projekte kann ich sagen, dass TDD eine sauberere Architektur bietet, aber die Entwicklung verlangsamt.  Und es ist nicht immer geeignet und nicht f√ºr jedermann. <br><a name="habracut"></a><br><h1>  Was ist wieder TDD? </h1><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f39/01c/4ed/f3901c4ed2fee96d90b1a40fc30e9270.jpg" alt="Bild"></div><br><br>  TDD - Entwicklung durch Testen.  Wiki-Artikel <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> . <br>  Der klassische Ansatz besteht darin, zuerst eine Anwendung zu schreiben und sie dann mit Tests abzudecken. <br><br>  TDD-Ansatz - zuerst schreiben wir Tests f√ºr die Klasse, dann die Implementierung.  Wir bewegen uns durch die Abstraktionsebenen - von der h√∂chsten zur angewendeten - und teilen die Anwendung gleichzeitig in Ebenenklassen auf, aus denen wir das gew√ºnschte Verhalten <b>ordnen</b> , ohne von einer bestimmten Implementierung abh√§ngig zu sein. <br><br>  Und wenn ich das zum ersten Mal lesen w√ºrde, w√ºrde ich auch nichts verstehen. <br>  Zu viele abstrakte W√∂rter: Schauen wir uns ein Beispiel an. <br>  Wir werden eine echte Fr√ºhlingsanwendung in Java schreiben, wir werden sie in TDD schreiben und ich werde versuchen, meinen Denkprozess w√§hrend des Entwicklungsprozesses zu zeigen und am Ende Schlussfolgerungen zu ziehen, ob es sinnvoll ist, Zeit mit TDD zu verbringen oder nicht. <br><br><h1>  Praktische Aufgabe </h1><br>  Nehmen wir an, wir haben so viel Gl√ºck, dass wir die ToR von dem haben, was wir entwickeln m√ºssen.  Normalerweise k√ºmmern sich Analysten nicht darum, und es sieht ungef√§hr so ‚Äã‚Äãaus: <br><br>  <i>Es ist notwendig, einen Mikroservice zu entwickeln, der die M√∂glichkeit des Verkaufs von Waren mit anschlie√üender Lieferung an den Kunden zu Hause berechnet.</i>  <i>Informationen zu dieser Funktion m√ºssen an ein DATA-System eines Drittanbieters gesendet werden.</i> <br><br>  Die Gesch√§ftslogik lautet wie folgt: Ein Artikel steht mit Lieferung zum Verkauf, wenn: <br><br><ul><li>  Produkt ist auf Lager </li><li>  Der Auftragnehmer (zum Beispiel die Firma DostavchenKO) hat die M√∂glichkeit, diese zum Auftraggeber zu bringen </li><li>  Produktfarbe - nicht blau (wir m√∂gen kein Blau) </li></ul><br>  Unser Microservice wird √ºber eine http-Anfrage √ºber eine √Ñnderung der Warenmenge im Ladenregal informiert. <br><br>  Diese Benachrichtigung ist ein Ausl√∂ser f√ºr die Berechnung der Verf√ºgbarkeit. <br><br>  Plus, damit das Leben nicht Honig zu sein scheint: <br><br><ul><li>  Der Benutzer sollte in der Lage sein, bestimmte Produkte manuell zu deaktivieren. </li><li>  Um keine Spam-Daten zu versenden, m√ºssen Sie nur Verf√ºgbarkeitsdaten f√ºr die Produkte senden, die sich ge√§ndert haben. </li></ul><br>  Wir lesen ein paar Mal TK - und gehen. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/10/xa/vc/10xavc46--r-thnqp--lbfzw4co.png"></div><br><br><h1>  Integrationstest </h1><br>  In TDD ist eine der wichtigsten Fragen, die Sie zu allem, was Sie schreiben, stellen m√ºssen: "Was will ich von ...?" <br><br>  Und die erste Frage, die wir stellen, betrifft nur die gesamte Anwendung. <br>  Die Frage ist also: <br><br>  <i>Was m√∂chte ich von meinem Microservice?</i> <br><br>  Die Antwort lautet: <br><br>  Eigentlich viele Dinge.  Selbst eine solche einfache Logik bietet viele Optionen, ein Versuch zu schreiben, der, und noch mehr, Tests f√ºr alle zu erstellen, eine unm√∂gliche Aufgabe sein kann.  Um die Frage auf Anwendungsebene zu beantworten, werden daher nur die Haupttestf√§lle ausgew√§hlt. <br><br>  Das hei√üt, wir gehen davon aus, dass alle Eingabedaten ein g√ºltiges Format haben, Systeme von Drittanbietern normal reagieren und zuvor keine Informationen zum Produkt vorhanden waren. <br><br>  <i>Also m√∂chte ich:</i> <br><br><ul><li>  Es ist eine Veranstaltung eingetroffen, bei der kein Produkt im Regal steht.  Benachrichtigen Sie, dass die Lieferung nicht verf√ºgbar ist. </li><li>  Die Veranstaltung kam, dass das gelbe Produkt auf Lager ist, DostavchenKO ist bereit, es zu nehmen.  Benachrichtigen Sie √ºber die Verf√ºgbarkeit von Waren. </li><li>  Zwei Nachrichten kamen hintereinander - beide mit einer positiven Warenmenge im Laden.  Nur eine Nachricht gesendet. </li><li>  Zwei Nachrichten sind eingetroffen: In der ersten befindet sich ein Produkt im Gesch√§ft, in der zweiten - es ist nicht mehr vorhanden.  Wir senden zwei Nachrichten: zuerst - verf√ºgbar, dann - nein. </li><li>  Ich kann das Produkt manuell deaktivieren und es werden keine Benachrichtigungen mehr gesendet. </li><li>  ... </li></ul><br>  Die Hauptsache hier ist, rechtzeitig anzuhalten: Wie ich bereits geschrieben habe, gibt es zu viele Optionen, und es macht keinen Sinn, alle hier zu beschreiben - nur die grundlegendsten.  Wenn wir in Zukunft Tests f√ºr Gesch√§ftslogik schreiben, wird ihre Kombination wahrscheinlich alles abdecken, was wir uns hier einfallen lassen.  Die Hauptmotivation hierbei ist, sicherzustellen, dass die Anwendung bei Bedarf funktioniert, wenn diese Tests bestanden werden. <br><br>  All diese Wunschliste werden wir nun in Tests destillieren.  Da dies auf Anwendungsebene eine Wunschliste ist, werden wir au√üerdem Tests durchf√ºhren, um den Federkontext zu erh√∂hen, das hei√üt, ziemlich schwer. <br>  Und dies leider f√ºr viele TDD-Zwecke, denn um einen solchen Integrationstest zu schreiben, ben√∂tigen Sie eine Menge Aufwand, den die Leute nicht immer bereit sind, auszugeben.  Und ja, dies ist der schwierigste Schritt, aber glauben Sie mir, nachdem Sie ihn durchlaufen haben, schreibt sich der Code fast von selbst und Sie werden sicher sein, dass Ihre Anwendung genau so funktioniert, wie Sie es m√∂chten. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/r2/hg/db/r2hgdbqezd8esoynflanwv-so8e.jpeg"></div><br>  W√§hrend der Beantwortung der Frage k√∂nnen Sie bereits mit dem Schreiben von Code in der generierten Spring-Initialisierungsklasse beginnen.  Die Testnamen sind nur unsere Wunschliste.  Erstellen Sie vorerst nur leere Methoden: <br><br><pre><code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">notifyNotAvailableIfProductQuantityIsZero</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">notifyAvailableYellowProductIfPositiveQuantityAndDostavchenkoApproved</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">notifyOnceOnSeveralEqualProductMessages</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">notifyFirstAvailableThenNotIfProductQuantityMovedFromPositiveToZero</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">noNotificationOnDisabledProduct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{}</code> </pre> <br>  In Bezug auf die Benennung von Methoden: Ich rate Ihnen dringend, sie informativ zu gestalten und nicht test1 (), test2 (), da Sie sp√§ter, wenn Sie vergessen, welche Klasse Sie geschrieben haben und wof√ºr sie verantwortlich ist, stattdessen die M√∂glichkeit haben Versuchen Sie, den Code direkt zu analysieren. √ñffnen Sie einfach den Test und lesen Sie die Vertragsmethode, die die Klasse erf√ºllt. <br><br><h2>  F√ºllen Sie die Tests aus </h2><br>  Die Hauptidee ist, alles Externe zu emulieren, um zu √ºberpr√ºfen, was im Inneren passiert. <br><br>  "Extern" in Bezug auf unseren Service ist alles, was NICHT der Microservice selbst ist, sondern der direkt mit ihm kommuniziert. <br><br>  In diesem Fall ist das √Ñu√üere: <br><br><ul><li>  Das System, das unser Service √ºber √Ñnderungen der Warenmenge informiert </li><li>  Kunde, der die Ware manuell trennt </li><li>  DostavchenKO-System eines Drittanbieters </li></ul><br>  Um die Anforderungen der ersten beiden zu emulieren, verwenden wir springendes MockMvc. <br>  Um DostavchenKO zu emulieren, verwenden wir wiremock oder MockRestServiceServer. <br><br>  Daher sieht unser Integrationstest folgenderma√üen aus: <br><br><div class="spoiler">  <b class="spoiler_title">Integrationstest</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(SpringRunner.class) <span class="hljs-meta"><span class="hljs-meta">@SpringBootTest</span></span> <span class="hljs-meta"><span class="hljs-meta">@AutoConfigureMockMvc</span></span> <span class="hljs-meta"><span class="hljs-meta">@AutoConfigureWireMock</span></span>(port = <span class="hljs-number"><span class="hljs-number">8090</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TddExampleApplicationTests</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> MockMvc mockMvc; <span class="hljs-meta"><span class="hljs-meta">@Before</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ WireMock.reset(); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">notifyNotAvailableIfProductQuantityIsZero</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ stubNotification( <span class="hljs-comment"><span class="hljs-comment">// language=JSON "{\n" + " \"productId\": 111,\n" + " \"available\": false\n" + "}"); performQuantityUpdateRequest( // language=JSON "{\n" + " \"productId\": 111,\n" + " \"color\" : \"red\", \n" + " \"productQuantity\": 0\n" + "}"); verify(1, postRequestedFor(urlEqualTo("/notify"))); } @Test public void notifyAvailableYellowProductIfPositiveQuantityAndDostavchenkoApproved() throws Exception { stubDostavchenko("112"); stubNotification( // language=JSON "{\n" + " \"productId\": 112,\n" + " \"available\": true\n" + "}"); performQuantityUpdateRequest( // language=JSON "{\n" + " \"productId\": 112,\n" + " \"color\" : \"Yellow\", \n" + " \"productQuantity\": 10\n" + "}"); verify(1, postRequestedFor(urlEqualTo("/notify"))); } @Test public void notifyOnceOnSeveralEqualProductMessages() throws Exception { stubDostavchenko("113"); stubNotification( // language=JSON "{\n" + " \"productId\": 113,\n" + " \"available\": true\n" + "}"); for (int i = 0; i &lt; 5; i++) { performQuantityUpdateRequest( // language=JSON "{\n" + " \"productId\": 113,\n" + " \"color\" : \"Yellow\", \n" + " \"productQuantity\": 10\n" + "}"); } verify(1, postRequestedFor(urlEqualTo("/notify"))); } @Test public void notifyFirstAvailableThenNotIfProductQuantityMovedFromPositiveToZero() throws Exception { stubDostavchenko("114"); stubNotification( // language=JSON "{\n" + " \"productId\": 114,\n" + " \"available\": true\n" + "}"); performQuantityUpdateRequest( // language=JSON "{\n" + " \"productId\": 114,\n" + " \"color\" : \"Yellow\",\n" + " \"productQuantity\": 10\n" + "}"); stubNotification( // language=JSON "{\n" + " \"productId\": 114,\n" + " \"available\": false\n" + "}"); performQuantityUpdateRequest( // language=JSON "{\n" + " \"productId\": 114,\n" + " \"color\" : \"Yellow\",\n" + " \"productQuantity\": 0\n" + "}"); verify(2, postRequestedFor(urlEqualTo("/notify"))); } @Test public void noNotificationOnDisabledProduct() throws Exception { stubNotification( // language=JSON "{\n" + " \"productId\": 115,\n" + " \"available\": false\n" + "}"); disableProduct(115); for (int i = 0; i &lt; 5; i++) { performQuantityUpdateRequest( // language=JSON "{\n" + " \"productId\": 115,\n" + " \"color\" : \"Yellow\",\n" + " \"productQuantity\": " + i + "\n" + "}"); } verify(1, postRequestedFor(urlEqualTo("/notify"))); } private void disableProduct(int productId) throws Exception { mockMvc.perform( post("/disableProduct?productId=" + productId) ).andDo( print() ).andExpect( status().isOk() ); } private void performQuantityUpdateRequest(String content) throws Exception { mockMvc.perform( post("/product-quantity-update") .contentType(MediaType.APPLICATION_JSON) .content(content) ).andDo( print() ).andExpect( status().isOk() ); } private void stubNotification(String content) { stubFor(WireMock.post(urlEqualTo("/notify")) .withHeader("Content-Type", equalTo(MediaType.APPLICATION_JSON_UTF8_VALUE)) .withRequestBody(equalToJson(content)) .willReturn(aResponse().withStatus(HttpStatus.OK_200))); } private void stubDostavchenko(final String productId) { stubFor(get(urlEqualTo("/isDeliveryAvailable?productId=" + productId)) .willReturn(aResponse().withStatus(HttpStatus.OK_200).withBody("true"))); } }</span></span></code> </pre> </div></div><br><h1>  Was ist gerade passiert? </h1><br>  Wir haben einen Integrationstest geschrieben, dessen Durchgang uns die Funktionsf√§higkeit des Systems gem√§√ü den Hauptnutzergeschichten garantiert.  Und wir haben es getan, bevor wir mit der Implementierung des Dienstes beginnen. <br><br>  Einer der Vorteile dieses Ansatzes ist, dass ich w√§hrend des Schreibprozesses zum <b>echten</b> DostavchenKO gehen musste, um von dort eine <b>echte</b> Antwort auf die <b>echte</b> Anfrage zu erhalten, die wir in unserem Stub gestellt haben.  Es ist sehr gut, dass wir uns gleich zu Beginn der Entwicklung darum gek√ºmmert haben und nicht, nachdem der Code geschrieben wurde.  Und hier stellt sich heraus, dass das Format nicht das im TOR angegebene ist oder der Dienst im Allgemeinen nicht verf√ºgbar ist oder etwas anderes. <br><br>  Ich m√∂chte auch darauf hinweisen, dass wir nicht nur keine <b>einzige</b> Codezeile geschrieben haben, die sp√§ter zum Produkt f√ºhrt, sondern auch nicht einmal davon ausgegangen sind, wie unser Microservice im Inneren angeordnet sein wird: Welche Schichten wird es geben, ob Wir verwenden die Basis, wenn ja, welche usw. Zum Zeitpunkt des Schreibens des Tests sind wir von der Implementierung abstrahiert, und wie wir sp√§ter sehen werden, kann dies eine Reihe von architektonischen Vorteilen bringen. <br><br>  Im Gegensatz zum kanonischen TDD, bei dem die Implementierung unmittelbar nach dem Test geschrieben wird, dauert der Integrationstest nicht lange.  Tats√§chlich wird es erst am Ende der Entwicklung gr√ºn, bis absolut alles geschrieben ist, einschlie√ülich der Dateien. <br>  Wir gehen weiter. <br><br><h1>  Controller </h1><br>  Nachdem wir den Integrationstest geschrieben haben und nun sicher sind, dass wir nach dem Bestehen der Aufgabe nachts ruhig schlafen k√∂nnen, ist es Zeit, mit dem Programmieren der Ebenen zu beginnen.  Und die erste Schicht, die wir implementieren werden, ist der Controller.  Warum genau er?  Weil dies der Einstiegspunkt in das Programm ist.  Wir m√ºssen uns von oben nach unten bewegen, von der ersten Ebene, mit der der Benutzer interagieren wird, bis zur letzten. <br>  Es ist wichtig. <br><br>  Und wieder beginnt alles mit der gleichen Frage: <br><br>  <i>Was m√∂chte ich vom Controller?</i> <br><br>  Die Antwort lautet: <br><br>  Wir wissen, dass der Controller mit der Kommunikation mit dem Benutzer, der Validierung und Konvertierung von Eingabedaten befasst ist und keine Gesch√§ftslogik enth√§lt.  Die Antwort auf diese Frage k√∂nnte also ungef√§hr so ‚Äã‚Äãlauten: <br><br>  <i>Ich m√∂chte:</i> <br><br><ul><li>  BAD_REQUEST wurde an den Benutzer zur√ºckgegeben, wenn versucht wurde, ein Produkt mit einer ung√ºltigen ID zu trennen </li><li>  BAD_REQUEST beim Versuch, eine Waren√§nderung mit ung√ºltiger ID zu benachrichtigen </li><li>  BAD_REQUEST beim Versuch, eine negative Menge zu benachrichtigen </li><li>  INTERNAL_SERVER_ERROR, wenn DostavchenKO nicht verf√ºgbar ist </li><li>  INTERNAL_SERVER_ERROR, wenn nicht an DATA gesendet werden kann </li></ul><br>  Da wir f√ºr alle oben genannten Elemente zus√§tzlich zum http-Code benutzerfreundlich sein m√∂chten, m√ºssen Sie eine benutzerdefinierte Nachricht anzeigen, die das Problem beschreibt, damit der Benutzer das Problem versteht. <br><br><ul><li>  200, wenn die Verarbeitung erfolgreich war </li><li>  INTERNAL_SERVER_ERROR mit einer Standardnachricht in allen anderen F√§llen, um Stackrace nicht zu gl√§nzen </li></ul><br>  Bis ich anfing, √ºber TDD zu schreiben, dachte ich zuletzt dar√ºber nach, was mein System f√ºr den Benutzer in einem speziellen und auf den ersten Blick unwahrscheinlichen Fall herausbringen w√ºrde.  Ich habe aus einem einfachen Grund nicht gedacht: Das Schreiben einer Implementierung ist so schwierig, dass absolut alle Randf√§lle ber√ºcksichtigt werden. Manchmal ist nicht gen√ºgend RAM im Gehirn vorhanden.  Und nach der schriftlichen Implementierung ist es immer noch ein Vergn√ºgen, den Code auf etwas zu analysieren, das Sie m√∂glicherweise nicht im Voraus in Betracht gezogen haben: Wir alle denken, dass wir sofort den perfekten Code schreiben.  Es gibt zwar keine Implementierung, aber es besteht keine Notwendigkeit, dar√ºber nachzudenken, und es gibt keine Schmerzen, dies zu √§ndern, wenn dies der Fall ist.  Nachdem Sie den Test zuerst geschrieben haben, m√ºssen Sie nicht warten, bis die Sterne konvergieren. Nach dem Zur√ºckziehen zum Produkt f√§llt eine bestimmte Anzahl von Systemen aus, und der Kunde kommt mit der Aufforderung, etwas zu reparieren, zu Ihnen gerannt.  Dies gilt nicht nur f√ºr die Steuerung. <br><br><h2>  Schreiben Sie Tests </h2><br>  Mit den ersten drei ist alles klar: Wir verwenden die Fr√ºhlingsvalidierung. Wenn eine ung√ºltige Anforderung eintrifft, l√∂st die Anwendung eine Ausnahme aus, die wir in einem Ausnahmebehandler abfangen.  Hier funktioniert, wie sie sagen, alles von selbst, aber woher wei√ü der Controller, dass ein System eines Drittanbieters nicht verf√ºgbar ist? <br><br>  Es ist klar, dass der Controller selbst nichts √ºber Systeme von Drittanbietern wissen sollte, weil  Welches System zu fragen ist und was die Gesch√§ftslogik ist, das hei√üt, es muss eine Art Vermittler geben.  Dieser Vermittler ist der Dienst.  Und wir werden Tests auf dem Controller schreiben, indem wir den Mock dieses Dienstes verwenden und in bestimmten F√§llen sein Verhalten emulieren.  Der Dienst muss den Controller also irgendwie dar√ºber informieren, dass das System nicht verf√ºgbar ist.  Sie k√∂nnen dies auf verschiedene Arten tun, aber am einfachsten, um eine benutzerdefinierte Ausf√ºhrung zu starten.  Wir werden einen Test f√ºr dieses Controller-Verhalten schreiben. <br><br><div class="spoiler">  <b class="spoiler_title">Test auf Kommunikationsfehler mit einem DATA-System eines Drittanbieters</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(SpringRunner.class) <span class="hljs-meta"><span class="hljs-meta">@WebMvcTest</span></span> <span class="hljs-meta"><span class="hljs-meta">@AutoConfigureMockMvc</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ControllerTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@MockBean</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> UpdateProcessorService updateProcessorService; <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returnServerErrorOnDataCommunicationError</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ doThrow(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DataCommunicationException()).when(updateProcessorService).processUpdate(any(Update.class)); performUpdate( <span class="hljs-comment"><span class="hljs-comment">//language=JSON "{\n" + " \"productId\": 1,\n" + " \"color\": \"red\",\n" + " \"productQuantity\": 10\n" + "}" ).andDo( print() ).andExpect( status().isInternalServerError() ).andExpect( content().json("{\n" + " \"errors\": [\n" + " {\n" + " \"message\": \"Can't communicate with Data system\"\n" + " }\n" + " ]\n" + "}") ); } }</span></span></code> </pre><br></div></div><br>  Zu diesem Zeitpunkt erschienen mehrere Dinge f√ºr sich: <br><br><ul><li>  Ein Service, der in die Steuerung eingespeist wird und an den die Verarbeitung einer eingehenden Nachricht f√ºr eine neue Warenmenge delegiert wird. </li><li>  Die Methode dieses Dienstes und dementsprechend seine Unterschrift, die diese Verarbeitung durchf√ºhrt. </li><li>  Die Erkenntnis, dass die Methode eine benutzerdefinierte Ausf√ºhrung ausl√∂sen sollte, wenn das System nicht verf√ºgbar ist. </li><li>  Diese benutzerdefinierte Ausf√ºhrung selbst. </li></ul><br>  Warum alleine?  Denn wie Sie sich erinnern, haben wir noch keine Implementierung geschrieben.  Und all diese Entit√§ten tauchten bei der Programmierung von Tests auf.  Damit der Compiler nicht schw√∂rt, m√ºssen wir in echtem Code alles erstellen, was oben beschrieben wurde.  Gl√ºcklicherweise hilft uns fast jede IDE dabei, die erforderlichen Entit√§ten zu generieren.  Wir schreiben also eine Art Test - und die Anwendung ist mit Klassen und Methoden gef√ºllt. <br><br>  Insgesamt sind die Tests f√ºr die Steuerung wie folgt: <br><br><div class="spoiler">  <b class="spoiler_title">Tests</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(SpringRunner.class) <span class="hljs-meta"><span class="hljs-meta">@WebMvcTest</span></span> <span class="hljs-meta"><span class="hljs-meta">@AutoConfigureMockMvc</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ControllerTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@InjectMocks</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Controller controller; <span class="hljs-meta"><span class="hljs-meta">@MockBean</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> UpdateProcessorService updateProcessorService; <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> MockMvc mvc; <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returnBadRequestOnDisableWithInvalidProductId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ mvc.perform( post(<span class="hljs-string"><span class="hljs-string">"/disableProduct?productId=-443"</span></span>) ).andDo( print() ).andExpect( status().isBadRequest() ).andExpect( content().json(getInvalidProductIdJsonContent()) ); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returnBadRequestOnNotifyWithInvalidProductId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ performUpdate( <span class="hljs-comment"><span class="hljs-comment">//language=JSON "{\n" + " \"productId\": -1,\n" + " \"color\": \"red\",\n" + " \"productQuantity\": 0\n" + "}" ).andDo( print() ).andExpect( status().isBadRequest() ).andExpect( content().json(getInvalidProductIdJsonContent()) ); } @Test public void returnBadRequestOnNotifyWithNegativeProductQuantity() throws Exception { performUpdate( //language=JSON "{\n" + " \"productId\": 1,\n" + " \"color\": \"red\",\n" + " \"productQuantity\": -10\n" + "}" ).andDo( print() ).andExpect( status().isBadRequest() ).andExpect( content().json("{\n" + " \"errors\": [\n" + " {\n" + " \"message\": \"productQuantity is invalid\"\n" + " }\n" + " ]\n" + "}") ); } @Test public void returnServerErrorOnDostavchenkoCommunicationError() throws Exception { doThrow(new DostavchenkoException()).when(updateProcessorService).processUpdate(any(Update.class)); performUpdate( //language=JSON "{\n" + " \"productId\": 1,\n" + " \"color\": \"red\",\n" + " \"productQuantity\": 10\n" + "}" ).andDo( print() ).andExpect( status().isInternalServerError() ).andExpect( content().json("{\n" + " \"errors\": [\n" + " {\n" + " \"message\": \"DostavchenKO communication exception\"\n" + " }\n" + " ]\n" + "}") ); } @Test public void returnServerErrorOnDataCommunicationError() throws Exception { doThrow(new DataCommunicationException()).when(updateProcessorService).processUpdate(any(Update.class)); performUpdate( //language=JSON "{\n" + " \"productId\": 1,\n" + " \"color\": \"red\",\n" + " \"productQuantity\": 10\n" + "}" ).andDo( print() ).andExpect( status().isInternalServerError() ).andExpect( content().json("{\n" + " \"errors\": [\n" + " {\n" + " \"message\": \"Can't communicate with Data system\"\n" + " }\n" + " ]\n" + "}") ); } @Test public void return200OnSuccess() throws Exception { performUpdate( //language=JSON "{\n" + " \"productId\": 1,\n" + " \"color\": \"red\",\n" + " \"productQuantity\": 10\n" + "}" ).andDo( print() ).andExpect( status().isOk() ); } @Test public void returnServerErrorOnUnexpectedException() throws Exception { doThrow(new RuntimeException()).when(updateProcessorService).processUpdate(any(Update.class)); performUpdate( //language=JSON "{\n" + " \"productId\": 1,\n" + " \"color\": \"red\",\n" + " \"productQuantity\": 10\n" + "}" ).andDo( print() ).andExpect( status().isInternalServerError() ).andExpect( content().json("{\n" + " \"errors\": [\n" + " {\n" + " \"message\": \"Internal Server Error\"\n" + " }\n" + " ]\n" + "}") ); } @Test public void returnTwoErrorMessagesOnInvalidProductIdAndNegativeQuantity() throws Exception { performUpdate( //language=JSON "{\n" + " \"productId\": -1,\n" + " \"color\": \"red\",\n" + " \"productQuantity\": -10\n" + "}" ).andDo( print() ).andExpect( status().isBadRequest() ).andExpect( content().json("{\n" + " \"errors\": [\n" + " { \"message\": \"productQuantity is invalid\" },\n" + " { \"message\": \"productId is invalid\" }\n" + " ]\n" + "}") ); } private ResultActions performUpdate(String jsonContent) throws Exception { return mvc.perform( post("/product-quantity-update") .contentType(MediaType.APPLICATION_JSON_UTF8_VALUE) .content(jsonContent) ); } private String getInvalidProductIdJsonContent() { return //language=JSON "{\n" + " \"errors\": [\n" + " {\n" + " \"message\": \"productId is invalid\"\n" + " }\n" + " ]\n" + "}"; } }</span></span></code> </pre> </div></div><br>  Jetzt k√∂nnen wir die Implementierung schreiben und sicherstellen, dass alle Tests erfolgreich bestanden wurden: <br><div class="spoiler">  <b class="spoiler_title">Implementierung</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RestController</span></span> <span class="hljs-meta"><span class="hljs-meta">@AllArgsConstructor</span></span> <span class="hljs-meta"><span class="hljs-meta">@Validated</span></span> <span class="hljs-meta"><span class="hljs-meta">@Slf</span></span>4j <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Controller</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> UpdateProcessorService updateProcessorService; <span class="hljs-meta"><span class="hljs-meta">@PostMapping</span></span>(<span class="hljs-string"><span class="hljs-string">"/product-quantity-update"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updateQuantity</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@RequestBody @Valid Update update)</span></span></span><span class="hljs-function"> </span></span>{ updateProcessorService.processUpdate(update); } <span class="hljs-meta"><span class="hljs-meta">@PostMapping</span></span>(<span class="hljs-string"><span class="hljs-string">"/disableProduct"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">disableProduct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@RequestParam(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"productId"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> @</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Min</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> Long productId) </span></span>{ updateProcessorService.disableProduct(Long.valueOf(productId)); } }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Ausnahmehandler</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@ControllerAdvice</span></span> <span class="hljs-meta"><span class="hljs-meta">@Slf</span></span>4j <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApplicationExceptionHandler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@ExceptionHandler</span></span>(ConstraintViolationException.class) <span class="hljs-meta"><span class="hljs-meta">@ResponseBody</span></span> <span class="hljs-meta"><span class="hljs-meta">@ResponseStatus</span></span>(HttpStatus.BAD_REQUEST) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ErrorResponse </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onConstraintViolationException</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConstraintViolationException exception)</span></span></span><span class="hljs-function"> </span></span>{ log.info(<span class="hljs-string"><span class="hljs-string">"Constraint Violation"</span></span>, exception); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ErrorResponse(exception.getConstraintViolations().stream() .map(constraintViolation -&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ErrorResponse.Message( ((PathImpl) constraintViolation.getPropertyPath()).getLeafNode().toString() + <span class="hljs-string"><span class="hljs-string">" is invalid"</span></span>)) .collect(Collectors.toList())); } <span class="hljs-meta"><span class="hljs-meta">@ExceptionHandler</span></span>(value = MethodArgumentNotValidException.class) <span class="hljs-meta"><span class="hljs-meta">@ResponseBody</span></span> <span class="hljs-meta"><span class="hljs-meta">@ResponseStatus</span></span>(value = HttpStatus.BAD_REQUEST) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ErrorResponse </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onMethodArgumentNotValidException</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(MethodArgumentNotValidException exception)</span></span></span><span class="hljs-function"> </span></span>{ log.info(exception.getMessage()); List&lt;ErrorResponse.Message&gt; fieldErrors = exception.getBindingResult().getFieldErrors().stream() .map(fieldError -&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ErrorResponse.Message(fieldError.getField() + <span class="hljs-string"><span class="hljs-string">" is invalid"</span></span>)) .collect(Collectors.toList()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ErrorResponse(fieldErrors); } <span class="hljs-meta"><span class="hljs-meta">@ExceptionHandler</span></span>(DostavchenkoException.class) <span class="hljs-meta"><span class="hljs-meta">@ResponseBody</span></span> <span class="hljs-meta"><span class="hljs-meta">@ResponseStatus</span></span>(HttpStatus.INTERNAL_SERVER_ERROR) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ErrorResponse </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onDostavchenkoCommunicationException</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DostavchenkoException exception)</span></span></span><span class="hljs-function"> </span></span>{ log.error(<span class="hljs-string"><span class="hljs-string">"DostavchenKO communication exception"</span></span>, exception); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ErrorResponse(Collections.singletonList( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ErrorResponse.Message(<span class="hljs-string"><span class="hljs-string">"DostavchenKO communication exception"</span></span>))); } <span class="hljs-meta"><span class="hljs-meta">@ExceptionHandler</span></span>(DataCommunicationException.class) <span class="hljs-meta"><span class="hljs-meta">@ResponseBody</span></span> <span class="hljs-meta"><span class="hljs-meta">@ResponseStatus</span></span>(HttpStatus.INTERNAL_SERVER_ERROR) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ErrorResponse </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onDataCommunicationException</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DataCommunicationException exception)</span></span></span><span class="hljs-function"> </span></span>{ log.error(<span class="hljs-string"><span class="hljs-string">"DostavchenKO communication exception"</span></span>, exception); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ErrorResponse(Collections.singletonList( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ErrorResponse.Message(<span class="hljs-string"><span class="hljs-string">"Can't communicate with Data system"</span></span>))); } <span class="hljs-meta"><span class="hljs-meta">@ExceptionHandler</span></span>(Exception.class) <span class="hljs-meta"><span class="hljs-meta">@ResponseBody</span></span> <span class="hljs-meta"><span class="hljs-meta">@ResponseStatus</span></span>(HttpStatus.INTERNAL_SERVER_ERROR) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ErrorResponse </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onException</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Exception exception)</span></span></span><span class="hljs-function"> </span></span>{ log.error(<span class="hljs-string"><span class="hljs-string">"Error while processing"</span></span>, exception); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ErrorResponse(Collections.singletonList( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ErrorResponse.Message(HttpStatus.INTERNAL_SERVER_ERROR.getReasonPhrase()))); } }</code> </pre> <br></div></div><br><h1>  Was ist gerade passiert? </h1><br>  <b>In TDD m√ºssen Sie nicht den gesamten Code im Kopf behalten.</b> <br><br>  Lassen Sie uns noch einmal sagen: Behalten Sie nicht die gesamte Architektur im RAM.  Schauen Sie sich nur eine Schicht an.  Er ist einfach. <br><br>  Im √ºblichen Prozess reicht das Gehirn nicht aus, da es viele Implementierungen gibt.  Wenn Sie ein Superheld sind, der alle Nuancen eines gro√üen Projekts in Ihrem Kopf ber√ºcksichtigen kann, ist TDD nicht erforderlich.  Ich wei√ü nicht wie.  Je gr√∂√üer das Projekt, desto mehr irre ich mich. <br><br>  Nachdem Sie erkannt haben, dass Sie nur verstehen m√ºssen, was die n√§chste Schicht ben√∂tigt, kommt die Erleuchtung ins Leben.  Tatsache ist, dass Sie mit diesem Ansatz keine unn√∂tigen Dinge tun k√∂nnen.  Hier sprichst du mit einem M√§dchen.  Sie sagt etwas √ºber ein Problem bei der Arbeit.  Und Sie denken, wie Sie es l√∂sen k√∂nnen, Sie zerbrechen sich den Kopf.  Und sie muss es nicht l√∂sen, sie muss es nur sagen.  Und alle.  Sie wollte nur etwas teilen.  Es ist von unsch√§tzbarem Wert, dies in der ersten Phase von listen () zu lernen.  F√ºr alles andere ... na ja, wissen Sie. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/qx/bk/fb/qxbkfb93hkn7folrvbn1pjd8hxm.png"></div><br><h1>  Service </h1><br>  Als n√§chstes implementieren wir den Service. <br><br>  <i>Was wollen wir vom Service?</i> <br><br>  Wir m√∂chten, dass er sich mit Gesch√§ftslogik befasst, d.h. <br><br><ol><li>  Er wusste, wie man Waren trennt, <u>und benachrichtigte auch √ºber</u> : </li><li>  Verf√ºgbarkeit, wenn das Produkt nicht getrennt ist, auf Lager ist, die Farbe des Produkts gelb ist und DostavchenKO zur Lieferung bereit ist. </li><li>  Unzug√§nglichkeit, wenn die Ware unabh√§ngig von irgendetwas nicht verf√ºgbar ist. </li><li>  Unzug√§nglichkeit, wenn das Produkt blau ist. </li><li>  Unzug√§nglichkeit, wenn DostavchenKO sich weigert, es zu tragen. </li><li>  Unzug√§nglichkeit, wenn die Ware manuell getrennt wird. </li><li>  Als N√§chstes soll der Dienst die Ausf√ºhrung ausl√∂sen, wenn eines der Systeme nicht verf√ºgbar ist. </li><li>  Und um keine DATEN zu spammen, m√ºssen Sie auch das verz√∂gerte Senden von Nachrichten organisieren, n√§mlich: </li><li>  Wenn wir fr√ºher verf√ºgbare Waren f√ºr Waren verschickt haben und jetzt berechnet haben, was verf√ºgbar ist, dann senden wir nichts. </li><li>  Und wenn es vorher nicht verf√ºgbar ist, aber jetzt verf√ºgbar ist, senden wir es. </li><li>  Und du musst es irgendwo aufschreiben ... </li></ol><br>  <b>STOP!</b> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/if/ek/y1/ifeky128w2kgpc2gw2jcxwvzkia.jpeg"></div><br>  Denken Sie nicht, dass unser Service zu viel zu tun hat? <br><br>  Nach unserer Wunschliste zu urteilen, wei√ü er, wie man Waren abschaltet, ber√ºcksichtigt die Zug√§nglichkeit und stellt sicher, dass er keine zuvor gesendeten Nachrichten sendet.  Dies ist kein hoher Zusammenhalt.  Es ist notwendig, heterogene Funktionalit√§ten in verschiedene Klassen zu verschieben, und daher sollte es bereits drei Dienste geben: Der eine befasst sich mit der Trennung von Waren, der andere berechnet die M√∂glichkeit der Lieferung und gibt sie an einen Dienst weiter, der entscheidet, ob er gesendet wird oder nicht.  Auf diese Weise wei√ü der Gesch√§ftslogikdienst √ºbrigens nichts √ºber das DATA-System, was ebenfalls ein klares Plus ist. <br><br>  Nach meiner Erfahrung ist es oftmals leicht, architektonische Momente zu √ºbersehen, nachdem ich mich intensiv mit der Implementierung befasst habe.  Wenn wir den Service sofort schreiben w√ºrden, ohne dar√ºber nachzudenken, was er tun soll, und was noch wichtiger ist, als es NICHT sein sollte, w√ºrde sich die Wahrscheinlichkeit erh√∂hen, dass sich Verantwortungsbereiche √ºberschneiden.  Ich m√∂chte in meinem eigenen Namen hinzuf√ºgen, dass mir dieses Beispiel in der Praxis passiert ist und der qualitative Unterschied zwischen den Ergebnissen von TDD und sequentiellen Programmierans√§tzen mich dazu inspiriert hat, diesen Beitrag zu schreiben. <br><br><h1>  Gesch√§ftslogik </h1><br>  Wenn wir aus den gleichen Gr√ºnden wie dem hohen Zusammenhalt √ºber den Gesch√§ftslogikdienst nachdenken, verstehen wir, dass wir eine weitere Abstraktionsebene zwischen ihm und dem echten DostavchenKO ben√∂tigen.  Und da wir den Service <b>zuerst</b> entwerfen, k√∂nnen wir vom DostavchenKO-Kunden einen solchen internen Vertrag verlangen, den wir wollen.  Beim Schreiben eines Tests f√ºr die Gesch√§ftslogik werden wir verstehen, was wir vom Kunden mit der folgenden Signatur erwarten: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isAvailableForTransportation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Long productId)</span></span></span><span class="hljs-function"> </span></span>{...}</code> </pre><br>  Auf der Service-Ebene spielt es f√ºr uns keine Rolle, wie der echte DostavchenKO antwortet: In Zukunft wird die Aufgabe des Kunden diese Informationen irgendwie aus ihm herausholen.  Einmal mag es einfach sein, aber manchmal wird es notwendig sein, mehrere Anfragen zu stellen: Im Moment sind wir davon abstrahiert. <br><br>  Wir m√∂chten eine √§hnliche Unterschrift von einem Dienst, der sich mit nicht verbundenen Waren befasst: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isProductEnabled</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Long productId)</span></span></span><span class="hljs-function"> </span></span>{...}</code> </pre><br>  Die Fragen ‚ÄûWas m√∂chte ich vom Gesch√§ftslogikdienst?‚Äú, Die in den Tests aufgezeichnet wurden, sehen also wie folgt aus: <br><br><div class="spoiler">  <b class="spoiler_title">Servicetests</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(MockitoJUnitRunner.class) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UpdateProcessorServiceTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@InjectMocks</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> UpdateProcessorService updateProcessorService; <span class="hljs-meta"><span class="hljs-meta">@Mock</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ManualExclusionService manualExclusionService; <span class="hljs-meta"><span class="hljs-meta">@Mock</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> DostavchenkoClient dostavchenkoClient; <span class="hljs-meta"><span class="hljs-meta">@Mock</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> AvailabilityNotifier availabilityNotifier; <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">notifyAvailableIfYellowProductIsEnabledAndReadyForTransportation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Update testProduct = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Update(<span class="hljs-number"><span class="hljs-number">1L</span></span>, <span class="hljs-number"><span class="hljs-number">10L</span></span>, <span class="hljs-string"><span class="hljs-string">"Yellow"</span></span>); when(dostavchenkoClient.isAvailableForTransportation(testProduct.getProductId())).thenReturn(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); when(manualExclusionService.isProductEnabled(testProduct.getProductId())).thenReturn(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); updateProcessorService.processUpdate(testProduct); verify(availabilityNotifier, only()).notify(eq(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProductAvailability(testProduct.getProductId(), <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>))); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">notifyNotAvailableIfProductIsAbsent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Update testProduct = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Update(<span class="hljs-number"><span class="hljs-number">1L</span></span>, <span class="hljs-number"><span class="hljs-number">0L</span></span>, <span class="hljs-string"><span class="hljs-string">"Yellow"</span></span>); updateProcessorService.processUpdate(testProduct); verify(availabilityNotifier, only()).notify(eq(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProductAvailability(testProduct.getProductId(), <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>))); verifyNoMoreInteractions(manualExclusionService); verifyNoMoreInteractions(dostavchenkoClient); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">notifyNotAvailableIfProductIsBlue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Update testProduct = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Update(<span class="hljs-number"><span class="hljs-number">1L</span></span>, <span class="hljs-number"><span class="hljs-number">10L</span></span>, <span class="hljs-string"><span class="hljs-string">"Blue"</span></span>); updateProcessorService.processUpdate(testProduct); verify(availabilityNotifier, only()).notify(eq(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProductAvailability(testProduct.getProductId(), <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>))); verifyNoMoreInteractions(manualExclusionService); verifyNoMoreInteractions(dostavchenkoClient); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">notifyNotAvailableIfProductIsDisabled</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Update testProduct = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Update(<span class="hljs-number"><span class="hljs-number">1L</span></span>, <span class="hljs-number"><span class="hljs-number">10L</span></span>, <span class="hljs-string"><span class="hljs-string">"Yellow"</span></span>); when(manualExclusionService.isProductEnabled(testProduct.getProductId())).thenReturn(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); updateProcessorService.processUpdate(testProduct); verify(availabilityNotifier, only()).notify(eq(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProductAvailability(testProduct.getProductId(), <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>))); verifyNoMoreInteractions(dostavchenkoClient); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">notifyNotAvailableIfProductIsNotReadyForTransportation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Update testProduct = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Update(<span class="hljs-number"><span class="hljs-number">1L</span></span>, <span class="hljs-number"><span class="hljs-number">10L</span></span>, <span class="hljs-string"><span class="hljs-string">"Yellow"</span></span>); when(dostavchenkoClient.isAvailableForTransportation(testProduct.getProductId())).thenReturn(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); when(manualExclusionService.isProductEnabled(testProduct.getProductId())).thenReturn(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); updateProcessorService.processUpdate(testProduct); verify(availabilityNotifier, only()).notify(eq(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProductAvailability(testProduct.getProductId(), <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>))); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span>(expected = DostavchenkoException.class) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">throwCustomExceptionIfDostavchenkoCommunicationFailed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Update testProduct = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Update(<span class="hljs-number"><span class="hljs-number">1L</span></span>, <span class="hljs-number"><span class="hljs-number">10L</span></span>, <span class="hljs-string"><span class="hljs-string">"Yellow"</span></span>); when(dostavchenkoClient.isAvailableForTransportation(testProduct.getProductId())) .thenThrow(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RestClientException(<span class="hljs-string"><span class="hljs-string">"Something's wrong"</span></span>)); when(manualExclusionService.isProductEnabled(testProduct.getProductId())).thenReturn(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); updateProcessorService.processUpdate(testProduct); } }</code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Zu diesem Zeitpunkt wurden sie von selbst geboren: </font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> DostavchenKO Kunde mit servicefreundlicher Singatura </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ein Dienst, bei dem die Logik des verz√∂gerten Sendens implementiert werden muss, an den der entworfene Dienst die Ergebnisse seiner Arbeit √ºbermittelt </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Service von nicht verbundenen Waren und deren Unterschrift </font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Implementierung: </font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implementierung</font></font></b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RequiredArgsConstructor</span></span> <span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@Slf</span></span>4j <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UpdateProcessorService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> AvailabilityNotifier availabilityNotifier; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> DostavchenkoClient dostavchenkoClient; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ManualExclusionService manualExclusionService; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processUpdate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Update update)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (update.getProductQuantity() &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { availabilityNotifier.notify(getNotAvailableProduct(update.getProductId())); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">"Blue"</span></span>.equals(update.getColor())) { availabilityNotifier.notify(getNotAvailableProduct(update.getProductId())); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!manualExclusionService.isProductEnabled(update.getProductId())) { availabilityNotifier.notify(getNotAvailableProduct(update.getProductId())); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> availableForTransportation = dostavchenkoClient.isAvailableForTransportation(update.getProductId()); availabilityNotifier.notify(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProductAvailability(update.getProductId(), availableForTransportation)); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception exception) { log.warn(<span class="hljs-string"><span class="hljs-string">"Problems communicating with DostavchenKO"</span></span>, exception); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DostavchenkoException(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> ProductAvailability </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getNotAvailableProduct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Long productId)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProductAvailability(productId, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); } }</code> </pre><br></div></div><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Produkte deaktivieren </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es ist Zeit f√ºr eine der unvermeidlichen TDD-Phasen - das Refactoring. </font><font style="vertical-align: inherit;">Wenn Sie sich erinnern, sah der Servicevertrag nach der Implementierung des Controllers folgenderma√üen aus:</font></font><br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">disableProduct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> productId)</span></span></span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Und jetzt haben wir beschlossen, die Trennungslogik in einen separaten Dienst zu verschieben. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Von diesem Service wollen wir zu diesem Zeitpunkt Folgendes:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Die F√§higkeit, Waren auszuschalten. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Wir m√∂chten, dass er zur√ºcksendet, dass die Ware getrennt wird, wenn er zuvor getrennt wurde. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Wir m√∂chten, dass er zur√ºcksendet, dass die Ware verf√ºgbar ist, wenn zuvor keine Unterbrechung aufgetreten ist. </font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Mit Blick auf die Wunschliste, die eine direkte Folge des Vertrags zwischen dem Gesch√§ftslogikdienst und dem geplanten Dienst ist, m√∂chte ich Folgendes beachten: </font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erstens k√∂nnen Sie sofort erkennen, dass die Anwendung m√∂glicherweise Probleme hat, wenn jemand das nicht verbundene Produkt wieder ausschalten m√∂chte, da dieser Dienst derzeit einfach nicht wei√ü, wie dies zu tun ist. </font><font style="vertical-align: inherit;">Und das bedeutet, dass es sich vielleicht lohnt, dieses Problem mit dem Analysten zu besprechen, der die Aufgabe f√ºr die Entwicklung festgelegt hat. </font><font style="vertical-align: inherit;">Ich verstehe, dass in diesem Fall diese Frage unmittelbar nach der ersten Lesung des ToR h√§tte gestellt werden m√ºssen, aber wir entwerfen ein ziemlich einfaches System. In gr√∂√üeren Projekten ist dies m√∂glicherweise nicht so offensichtlich. </font><font style="vertical-align: inherit;">Dar√ºber hinaus wussten wir nicht, dass wir eine Einheit haben w√ºrden, die nur f√ºr die Funktionalit√§t der Trennung von Waren verantwortlich ist: Ich erinnere mich, dass wir nur im Entwicklungsprozess geboren wurden.</font></font></li><li> -,       .           ‚Äî   ,         .  ,  , ,       ,      ,      , . . ProductAvailability.    ,      . . .,  ,   god object,    ,        ,      ,     TDD,          ,     .   ,  , ¬´¬ª ‚Äî     : ¬´    ...¬ª     , ,  TDD,     . </li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tests und Implementierung sind sehr einfach: </font></font><br><br><div class="spoiler">  <b class="spoiler_title">Tests</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@SpringBootTest</span></span> <span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(SpringRunner.class) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ManualExclusionServiceTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ManualExclusionService service; <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ManualExclusionRepository manualExclusionRepository; <span class="hljs-meta"><span class="hljs-meta">@Before</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">clearDb</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ manualExclusionRepository.deleteAll(); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">disableItem</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Long productId = <span class="hljs-number"><span class="hljs-number">100L</span></span>; service.disableProduct(productId); assertThat(service.isProductEnabled(productId), is(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returnEnabledIfProductWasNotDisabled</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ assertThat(service.isProductEnabled(<span class="hljs-number"><span class="hljs-number">100L</span></span>), is(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>)); assertThat(service.isProductEnabled(<span class="hljs-number"><span class="hljs-number">200L</span></span>), is(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>)); } }</code> </pre> <br></div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implementierung</font></font></b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@AllArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ManualExclusionService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ManualExclusionRepository manualExclusionRepository; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isProductEnabled</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Long productId)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> !manualExclusionRepository.exists(productId); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">disableProduct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> productId)</span></span></span><span class="hljs-function"> </span></span>{ manualExclusionRepository.save(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ManualExclusion(productId)); } }</code> </pre><br></div></div><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Lazy Submission Service </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir sind also zum letzten Dienst gekommen, der sicherstellt, dass das DATA-System nicht mit denselben Nachrichten gespammt wird. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ich m√∂chte Sie daran erinnern, dass das Ergebnis der Arbeit des Gesch√§ftslogikdienstes, dh das ProductAvailability-Objekt, in dem nur zwei Felder vorhanden sind: productId und isAvailable, bereits darauf √ºbertragen wurde. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nach der guten alten Tradition beginnen wir dar√ºber nachzudenken, was wir von diesem Service erwarten:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> In jedem Fall zum ersten Mal eine Benachrichtigung senden. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Senden einer Benachrichtigung, wenn sich die Verf√ºgbarkeit des Produkts ge√§ndert hat. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Wir senden nichts, wenn nicht. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Wenn das Senden an ein Drittanbieter-System mit einer Ausnahme beendet wurde, sollte die Benachrichtigung, die die Ausnahme verursacht hat, nicht in die Datenbank der gesendeten Benachrichtigungen aufgenommen werden. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Bei der Ausf√ºhrung von der DATA-Seite muss der Dienst au√üerdem seine DataCommunicationException ausl√∂sen. </font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hier ist alles relativ einfach, aber ich m√∂chte einen Punkt erw√§hnen: </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir ben√∂tigen Informationen √ºber das, was wir zuvor gesendet haben, was bedeutet, dass wir ein Repository haben, in dem wir fr√ºhere Berechnungen zur Verf√ºgbarkeit von Waren speichern. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das ProductAvailability-Objekt eignet sich nicht zum Speichern, da zumindest keine Kennung vorhanden ist. Daher ist es logisch, eine weitere zu erstellen. </font><font style="vertical-align: inherit;">Die Hauptsache hier ist, nicht auszuflippen und diesen Bezeichner nicht zusammen mit @Document (wir werden MongoDb als Basis verwenden) und Indizes in ProductAvailability selbst hinzuzuf√ºgen.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sie m√ºssen verstehen, dass das ProductAvailability-Objekt mit allen wenigen Feldern in der Phase des Entwurfs von Klassen erstellt wurde, die in der Aufrufhierarchie h√∂her sind als die, die wir derzeit entwerfen. Diese Klassen m√ºssen nichts √ºber datenbankspezifische Felder wissen, da diese Informationen beim Entwerfen nicht erforderlich waren. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aber das ist alles Gerede.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Interessanterweise bedeutet das Hinzuf√ºgen neuer Felder dazu, dass diese Tests auch √ºberarbeitet werden m√ºssen, was m√∂glicherweise einige Anstrengungen erfordert, da wir bereits eine Reihe von Tests mit der ProductAvailability geschrieben haben, die wir jetzt auf den Service √ºbertragen. </font><font style="vertical-align: inherit;">Dies bedeutet, dass es viel weniger Menschen geben wird, die aus ProductAvailability ein Gottobjekt machen m√∂chten, als wenn sie die Implementierung sofort geschrieben h√§tten: Im Gegenteil, das Hinzuf√ºgen eines Felds zu einem vorhandenen Objekt w√§re einfacher als das Erstellen einer anderen Klasse.</font></font><br><br><div class="spoiler">  <b class="spoiler_title">Tests</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(SpringRunner.class) <span class="hljs-meta"><span class="hljs-meta">@SpringBootTest</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LazyAvailabilityNotifierTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> LazyAvailabilityNotifier lazyAvailabilityNotifier; <span class="hljs-meta"><span class="hljs-meta">@MockBean</span></span> <span class="hljs-meta"><span class="hljs-meta">@Qualifier</span></span>(<span class="hljs-string"><span class="hljs-string">"dataClient"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> AvailabilityNotifier availabilityNotifier; <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> AvailabilityRepository availabilityRepository; <span class="hljs-meta"><span class="hljs-meta">@Before</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">clearDb</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ availabilityRepository.deleteAll(); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">notifyIfFirstTime</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ sendNotificationAndVerifyDataBase(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProductAvailability(<span class="hljs-number"><span class="hljs-number">1L</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">notifyIfAvailabilityChanged</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ProductAvailability oldProductAvailability = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProductAvailability(<span class="hljs-number"><span class="hljs-number">1L</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); sendNotificationAndVerifyDataBase(oldProductAvailability); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ProductAvailability newProductAvailability = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProductAvailability(<span class="hljs-number"><span class="hljs-number">1L</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); sendNotificationAndVerifyDataBase(newProductAvailability); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doNotNotifyIfAvailabilityDoesNotChanged</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ProductAvailability productAvailability = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProductAvailability(<span class="hljs-number"><span class="hljs-number">1L</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); sendNotificationAndVerifyDataBase(productAvailability); sendNotificationAndVerifyDataBase(productAvailability); sendNotificationAndVerifyDataBase(productAvailability); sendNotificationAndVerifyDataBase(productAvailability); verify(availabilityNotifier, only()).notify(eq(productAvailability)); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doNotSaveIfSentWithException</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ doThrow(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RuntimeException()).when(availabilityNotifier).notify(anyObject()); <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> exceptionThrown = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { availabilityNotifier.notify(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProductAvailability(<span class="hljs-number"><span class="hljs-number">1L</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (RuntimeException exception) { exceptionThrown = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } assertTrue(<span class="hljs-string"><span class="hljs-string">"Exception was not thrown"</span></span>, exceptionThrown); assertThat(availabilityRepository.findAll(), hasSize(<span class="hljs-number"><span class="hljs-number">0</span></span>)); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span>(expected = DataCommunicationException.class) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">wrapDataException</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ doThrow(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RestClientException(<span class="hljs-string"><span class="hljs-string">"Something wrong"</span></span>)).when(availabilityNotifier).notify(anyObject()); lazyAvailabilityNotifier.notify(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProductAvailability(<span class="hljs-number"><span class="hljs-number">1L</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendNotificationAndVerifyDataBase</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ProductAvailability productAvailability)</span></span></span><span class="hljs-function"> </span></span>{ lazyAvailabilityNotifier.notify(productAvailability); verify(availabilityNotifier).notify(eq(productAvailability)); assertThat(availabilityRepository.findAll(), hasSize(<span class="hljs-number"><span class="hljs-number">1</span></span>)); assertThat(availabilityRepository.findAll().get(<span class="hljs-number"><span class="hljs-number">0</span></span>), hasProperty(<span class="hljs-string"><span class="hljs-string">"productId"</span></span>, is(productAvailability.getProductId()))); assertThat(availabilityRepository.findAll().get(<span class="hljs-number"><span class="hljs-number">0</span></span>), hasProperty(<span class="hljs-string"><span class="hljs-string">"availability"</span></span>, is(productAvailability.isAvailable()))); } }</code> </pre> <br></div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implementierung</font></font></b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-meta"><span class="hljs-meta">@AllArgsConstructor</span></span> <span class="hljs-meta"><span class="hljs-meta">@Slf</span></span>4j <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LazyAvailabilityNotifier</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AvailabilityNotifier</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> AvailabilityRepository availabilityRepository; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> AvailabilityNotifier availabilityNotifier; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">notify</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ProductAvailability productAvailability)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> AvailabilityPersistenceObject persistedProductAvailability = availabilityRepository .findByProductId(productAvailability.getProductId()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (persistedProductAvailability == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { notifyWith(productAvailability); availabilityRepository.save(createObjectFromProductAvailability(productAvailability)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (persistedProductAvailability.isAvailability() != productAvailability.isAvailable()) { notifyWith(productAvailability); persistedProductAvailability.setAvailability(productAvailability.isAvailable()); availabilityRepository.save(persistedProductAvailability); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">notifyWith</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ProductAvailability productAvailability)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { availabilityNotifier.notify(productAvailability); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (RestClientException exception) { log.error(<span class="hljs-string"><span class="hljs-string">"Couldn't notify"</span></span>, exception); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DataCommunicationException(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> AvailabilityPersistenceObject </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createObjectFromProductAvailability</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ProductAvailability productAvailability)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AvailabilityPersistenceObject(productAvailability.getProductId(), productAvailability.isAvailable()); } }</code> </pre> <br></div></div><br><h1>  Fazit </h1><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/eq/cq/u-/eqcqu-xh6fu5mybs440rhhfob-g.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ein √§hnlicher Antrag musste in der Praxis geschrieben werden. Und es stellte sich heraus, dass es zuerst ohne TDD geschrieben wurde, dann sagte das Unternehmen, dass es nicht notwendig sei, und nach sechs Monaten √§nderten sich die Anforderungen, und es wurde beschlossen, es erneut von Grund auf neu zu schreiben (der Vorteil ist die Microservice-Architektur, und es war nicht so be√§ngstigend, etwas wegzuwerfen). . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn ich dieselbe Anwendung mit unterschiedlichen Techniken schreibe, kann ich ihre Unterschiede erkennen. In meiner Praxis habe ich gesehen, wie TDD beim Aufbau der Architektur hilft, scheint mir korrekter.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ich kann davon ausgehen, dass der Grund daf√ºr nicht die Erstellung von Tests vor der Implementierung ist, sondern dass wir, nachdem wir die Tests zu Beginn geschrieben haben, zun√§chst dar√ºber nachdenken, was die erstellte Klasse tun wird. Auch wenn es keine Implementierung gibt, k√∂nnen wir in den aufgerufenen Objekten wirklich den genauen Vertrag ‚Äûordnen‚Äú, den das Objekt, das sie aufruft, ben√∂tigt, ohne die Versuchung zu haben, schnell irgendwo etwas hinzuzuf√ºgen und eine Entit√§t zu erhalten, die viele Aufgaben gleichzeitig erledigt.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Als einer der Hauptvorteile von TDD f√ºr mich selbst kann ich hervorheben, dass ich wirklich mehr Vertrauen in das Produkt habe, das ich produziere. Dies kann auf die Tatsache zur√ºckzuf√ºhren sein, dass der durchschnittliche Code, der auf TDD geschrieben wurde, wahrscheinlich besser durch Tests abgedeckt wird. Nachdem ich jedoch mit dem Schreiben auf TDD begonnen hatte, wurde meine Anzahl der √Ñnderungen am Code nach dem Geben reduziert seine Pr√ºfung fast auf Null. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Und im Allgemeinen hatte ich das Gef√ºhl, als Entwickler besser zu werden. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anwendungscode finden Sie </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hier</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . F√ºr diejenigen, die verstehen m√∂chten, wie es in Schritten erstellt wurde, empfehle ich, auf die Historie der Commits zu achten, nachdem sie analysiert haben, was hoffentlich den Prozess der Erstellung einer typischen TDD-Anwendung verst√§ndlicher macht. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hier ist eine sehr n√ºtzliche</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ein Video</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , das ich jedem empfehlen kann, der in die Welt von TDD eintauchen m√∂chte. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Anwendungscode verwendet eine formatierte Zeichenfolge wie json wieder. </font><font style="vertical-align: inherit;">Dies ist erforderlich, um zu √ºberpr√ºfen, wie die Anwendung json auf POJO-Objekten analysiert. </font><font style="vertical-align: inherit;">Wenn Sie IDEA verwenden, kann die erforderliche Formatierung mithilfe von JSON-Sprachinjektionen schnell und problemlos erreicht werden.</font></font><br><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Was sind die Nachteile des Ansatzes? </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es ist eine lange Zeit, sich zu entwickeln. Mein Kollege, der im Standardparadigma programmiert, k√∂nnte es sich leisten, den Service den Testern zum Testen ohne Tests zur Verf√ºgung zu stellen und sie auf dem Weg hinzuzuf√ºgen. Es war sehr schnell. Auf TDD funktioniert dies nicht. Wenn Sie enge Fristen haben, sind Ihre Manager ungl√ºcklich. Hier ist der Kompromiss zwischen sofort gut, aber lange und nicht sehr gut, aber schnell. Ich w√§hle die erste f√ºr mich, weil die zweite dadurch l√§nger ist. Und mit gro√üen Nerven. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Meiner Meinung nach ist TDD nicht geeignet, wenn Sie viel umgestalten m√ºssen: Im Gegensatz zu einer von Grund auf neu erstellten Anwendung ist es nicht offensichtlich, wie Sie vorgehen und was Sie zuerst tun sollen. Es kann sich herausstellen, dass Sie an einem Klassentest arbeiten, wodurch dieser gel√∂scht wird.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TDD ist keine Silberkugel. </font><font style="vertical-align: inherit;">Dies ist eine Geschichte √ºber klaren, lesbaren Code, der Leistungsprobleme verursachen kann. </font><font style="vertical-align: inherit;">Sie haben beispielsweise N Klassen erstellt, die wie in Fowler jeweils ihre eigenen Aufgaben ausf√ºhren. </font><font style="vertical-align: inherit;">Und dann stellt sich heraus, dass jeder, um seine Arbeit zu erledigen, zur Basis gehen muss. </font><font style="vertical-align: inherit;">Und Sie werden N Abfragen in der Datenbank haben. </font><font style="vertical-align: inherit;">Anstatt zum Beispiel 1 Gottobjekt zu machen und 1 Mal zu gehen. </font><font style="vertical-align: inherit;">Wenn Sie um Millisekunden k√§mpfen, m√ºssen Sie dies bei Verwendung von TDD ber√ºcksichtigen: Der lesbare Code ist nicht immer der schnellste. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Und schlie√ülich ist es ziemlich schwierig, auf diese Methode umzusteigen - Sie m√ºssen sich selbst beibringen, anders zu denken. </font><font style="vertical-align: inherit;">Der gr√∂√üte Teil der Schmerzen befindet sich im ersten Stadium. </font><font style="vertical-align: inherit;">Den ersten Integrationstest habe ich 1,5 Tage geschrieben. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nun, der letzte. </font><font style="vertical-align: inherit;">Wenn Sie TDD verwenden und Ihr Code </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">immer noch nicht sehr ist</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dann ist die Angelegenheit m√∂glicherweise nicht in der Methodik enthalten. </font><font style="vertical-align: inherit;">Aber es hat mir geholfen.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/je/ix/2n/jeix2nwpo0ui_ehjeisprshkrvk.jpeg"></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de456662/">https://habr.com/ru/post/de456662/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de456650/index.html">Auswahl eines Budget-Taschenoszilloskops</a></li>
<li><a href="../de456652/index.html">Die Zeit wartet nicht: Dann kann Windows 10 Timeline f√ºr den Kriminalisten n√ºtzlich sein</a></li>
<li><a href="../de456654/index.html">Nicht so be√§ngstigendes ERP-Projekt wie gemalt</a></li>
<li><a href="../de456656/index.html">Lektionen zu SDL 2: Lektion 4 - Dehnen von PNG</a></li>
<li><a href="../de456658/index.html">Wachstum: wie wir F√§higkeiten in einem Team bewerten</a></li>
<li><a href="../de456664/index.html">Wen Sie verklagen m√ºssen, wenn ein Roboter Ihr Geld verliert</a></li>
<li><a href="../de456666/index.html">WebTotem oder wie wir das Internet sicherer machen wollen</a></li>
<li><a href="../de456668/index.html">Microsoft ML Spark: Eine Spark-Erweiterung, die SparkML humaner und LightGBM als Bonus macht</a></li>
<li><a href="../de456670/index.html">√úber die Spionageauthentifizierungsmethode</a></li>
<li><a href="../de456672/index.html">Nginx-Rezepte: Asynchrone Benachrichtigungen von PostgreSQL an den Websocket</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>