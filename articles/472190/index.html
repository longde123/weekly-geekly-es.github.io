<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíâ üçû üñ§ Ejecute scripts PHP a trav√©s de php-fpm sin un servidor web. O su cliente FastCGI (bajo el cap√≥) üç∫ üëÇüèø ü§ß</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Doy la bienvenida a todos los lectores de "Habr". 
 Descargo de responsabilidad 


 El art√≠culo result√≥ ser bastante largo y para aquellos que no quie...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Ejecute scripts PHP a trav√©s de php-fpm sin un servidor web. O su cliente FastCGI (bajo el cap√≥)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/472190/"><p>  Doy la bienvenida a todos los lectores de "Habr". </p><br><h4 id="diskleymer">  Descargo de responsabilidad </h4><br><p>  El art√≠culo result√≥ ser bastante largo y para aquellos que no quieren leer los antecedentes, pero quieren ir al grano, les pido directamente al cap√≠tulo "Soluci√≥n". </p><br><h3 id="vstuplenie">  Entrada </h3><br><p>  En este art√≠culo me gustar√≠a hablar sobre la soluci√≥n de un problema no est√°ndar que tuve que enfrentar durante el proceso de trabajo.  Es decir, necesit√°bamos ejecutar un mont√≥n de scripts php en un bucle.  No discutir√© las razones y la controversia de tal soluci√≥n arquitect√≥nica en este art√≠culo, porque  de hecho, no se trataba de eso en absoluto, era solo una tarea, ten√≠a que resolverse y la soluci√≥n me pareci√≥ lo suficientemente interesante como para compartirla contigo, especialmente porque no encontr√© ning√∫n man√° en Internet (bueno, por supuesto, excepto por las especificaciones oficiales).  Speck, por supuesto, es bueno y, por supuesto, todo est√° en ellos, pero creo que estar√° de acuerdo en que si no est√° particularmente familiarizado con el tema, e incluso tiene un tiempo limitado, comprenderlos sigue siendo un placer. </p><a name="habracut"></a><br><h3 id="dlya-kogo-eta-statya">  ¬øPara qui√©n es este art√≠culo? </h3><br><p>  Para todos los que trabajan con la web y el protocolo <strong>FastCgi solo</strong> saben que este es el protocolo seg√∫n el cual el servidor web ejecuta scripts php, pero quiere estudiarlo con m√°s detalle y mirar debajo del cap√≥. </p><br><h3 id="obosnovanie-zachem-eta-statya">  Justificaci√≥n (por qu√© este art√≠culo) </h3><br><p>  En general, como escrib√≠ anteriormente, cuando nos enfrentamos con la necesidad de ejecutar muchos scripts php sin la participaci√≥n de un servidor web (aproximadamente hablando de otro script php), lo primero que se me ocurri√≥ fue ... </p><br><pre><code class="php hljs">shell_exec(<span class="hljs-string"><span class="hljs-string">'php \path\to\script.php'</span></span>)</code> </pre> <br><p>  Pero al comienzo de cada script, se crear√° un entorno, se lanzar√° un proceso separado, en general, de alguna manera parec√≠a costoso para los recursos.  Esta implementaci√≥n fue rechazada.  La segunda cosa que me vino a la mente es, por supuesto, <strong>php-fpm</strong> , es genial, solo inicia el entorno una vez, monitorea la memoria, registra todo all√≠ correctamente, inicia y detiene los scripts, en general todo funciona bien y, por supuesto, nos gust√≥ de esta manera m√°s </p><br><p>  Pero es mala suerte, en teor√≠a sab√≠amos c√≥mo funciona, en t√©rminos generales (ya que result√≥ ser muy general), pero result√≥ bastante dif√≠cil implementar este protocolo en la pr√°ctica sin la participaci√≥n de un servidor web.  La lectura de las especificaciones y un par de horas de intentos fallidos mostraron que llevar√≠a tiempo implementarlo, lo que no ten√≠amos en ese momento.  No hay man√° para la implementaci√≥n de esta empresa en la que esta interacci√≥n podr√≠a describirse de manera simple y clara, tampoco pudimos tomar ninguna especificaci√≥n, de las soluciones ya preparadas encontramos un script de Python y una lib de Pykhov en el github, que al final no quer√≠a ser arrastrado a mi proyecto (tal vez no es correcto, pero en realidad no, nos encantan todo tipo de bibliotecas de terceros e incluso las que no son muy populares, y por lo tanto no se han probado).  En general, como resultado de esta idea, rechazamos e implementamos todo esto a trav√©s del viejo y bueno conejomq. </p><br><p>  Aunque el problema finalmente se resolvi√≥, todav√≠a decid√≠ entender FastCgi en detalle, y adem√°s decid√≠ escribir un art√≠culo sobre √©l, que describir√° de manera simple y detallada c√≥mo hacer que <strong>php-fpm</strong> ejecute un script php sin un servidor web, o mejor dicho, el servidor web tendr√° un script diferente, luego lo llamar√© el cliente Fcgi.  En general, espero que este art√≠culo ayude a aquellos que se enfrentan a la misma tarea que nosotros y despu√©s de leerlo podr√° escribir r√°pidamente todo lo que necesite. </p><br><h3 id="tvorcheskiy-poisk-lozhnyy-put">  B√∫squeda creativa (ruta falsa) </h3><br><p>  Entonces el problema est√° indicado, debemos proceder a la soluci√≥n.  Naturalmente, como cualquier programador "normal", para resolver un problema sobre el que no est√° escrito en ning√∫n lado qu√© hacer y qu√© ingresar a la consola, no le√≠ ni traduje la especificaci√≥n, pero inmediatamente se me ocurri√≥ mi propia soluci√≥n "brillante".  Su esencia es la siguiente, s√© que <strong>nginx</strong> (usamos nginx y para no escribir m√°s <strong>tonter√≠as</strong> : un servidor web, escribir√© nginx, ya que es m√°s comprensivo) transfiere algo a <strong>php-fpm</strong> , <strong>tambi√©n</strong> procesa <strong>php-fpm</strong> a ejecuta un script en base a √©l, bueno, todo parece ser simple, lo tomar√© y prometo que transmite <strong>nginx</strong> y <strong>pasar√©</strong> lo mismo. </p><br><p>  Great <strong>netcat</strong> ayudar√° aqu√≠ (utilidad UNIX para trabajar con tr√°fico de red, que en mi opini√≥n puede hacer casi cualquier cosa).  Entonces configuramos <strong>netcat</strong> para escuchar en el puerto local y configuramos <strong>nginx</strong> para que funcione con archivos php a trav√©s del socket (por supuesto, el socket en el mismo puerto que <strong>netcat</strong> escucha) </p><br><p>  escuchando el puerto 9000 </p><br><pre> <code class="plaintext hljs">nc -l 9000</code> </pre> <br><p>  Puede verificar que todo est√© bien, puede comunicarse con la direcci√≥n 127.0.0.1:9000 a trav√©s de un navegador y la siguiente imagen debe ser </p><br><img src="https://habrastorage.org/webt/ux/9s/_f/ux9s_fkir12e0yn3arj010nnezw.png"><br><p>  configure <strong>nginx</strong> para que procese los scripts php a trav√©s de un socket en el puerto 9000 (en la configuraci√≥n '/ etc / nginx / sites-available / default', por supuesto, pueden diferir) </p><br><pre> <code class="plaintext hljs">location ~ \.php$ { include snippets/fastcgi-php.conf; fastcgi_pass 127.0.0.1:9000; }</code> </pre><br><p>  Despu√©s de estas manipulaciones, verificaremos qu√© sucedi√≥ contactando el script php a trav√©s del navegador </p><br><img src="https://habrastorage.org/webt/u_/hf/j1/u_hfj1xa4tnqyb35rdmfu5nf-na.png"><br><p>  Se puede ver que <strong>nginx</strong> envi√≥ variables de entorno, as√≠ como caracteres no imprimibles, es decir, los datos se transmitieron en codificaci√≥n binaria, lo que significa que no se pueden copiar y enviar tan f√°cilmente al <strong>socket php-fpm</strong> .  Si los guarda en un archivo, por ejemplo, se guardan en codificaci√≥n hexadecimal, parecer√° que esto se aplica </p><br><img src="https://habrastorage.org/webt/le/7e/9y/le7e9ycpkn8n3mezj7ksa9xhkki.png"><br><p>  Pero esto tampoco nos da mucho, probablemente puramente te√≥ricamente se pueden convertir a codificaci√≥n binaria, de alguna manera (ni siquiera puedo imaginar c√≥mo) enviarlos al z√≥calo fpm, e incluso existe la posibilidad de que esta bicicleta funcione de alguna manera, e incluso comience alg√∫n tipo de un gui√≥n, pero de alguna manera es todo feo e inc√≥modo. </p><br><p>  Qued√≥ claro que este camino estaba completamente equivocado, puedes ver por ti mismo cu√°n miserable se ve todo esto, y a√∫n m√°s, todas estas acciones no nos permitir√°n controlar la conexi√≥n, ni nos acercar√°n a comprender la interacci√≥n entre <strong>php-fpm</strong> y <strong>nginx</strong> . </p><br><p>  ¬°Todo se ha ido, la especificaci√≥n no se puede evitar! </p><br><h3 id="reshenie-tut-sobstvenno-nachinaetsya-vsya-sol-dannoy-stati">  Soluci√≥n (aqu√≠ comienza toda la sal de este art√≠culo) </h3><br><h4 id="teoreticheskaya-podgotovka">  Entrenamiento te√≥rico </h4><br><p>  Ahora consideremos c√≥mo de todos modos hay una conexi√≥n y un intercambio de datos entre <strong>nginx</strong> y <strong>php-fpm</strong> .  Una peque√±a teor√≠a, toda la comunicaci√≥n se lleva a cabo como ya est√° claro a trav√©s de sockets, consideraremos m√°s espec√≠ficamente una conexi√≥n a trav√©s de un socket TCP. </p><br><p>  La unidad de informaci√≥n en el protocolo <strong>FastCgi</strong> es un <strong>registro cgi</strong> .  El servidor env√≠a dichos registros a la aplicaci√≥n y recibe exactamente los mismos registros en respuesta. </p><br><h5 id="nemnogo-teorii-struktury">  Un poco de teor√≠a (estructura) </h5><br><p>  A continuaci√≥n, considere la estructura del registro.  Para comprender en qu√© consiste un registro, debe comprender c√≥mo son las estructuras C y comprender sus designaciones.  Para aquellos que no saben m√°s, esto se describir√° brevemente (pero suficiente para comprender).  Tratar√© de describirlo de la manera m√°s simple posible, no tiene sentido entrar en detalles aqu√≠, y me temo que me confundir√© con los detalles, lo principal es tener un entendimiento com√∫n. </p><br><p>  Las estructuras son simplemente una colecci√≥n de bytes, y una notaci√≥n para ellos les permite ser interpretadas.  Es decir, solo tiene una secuencia de ceros y unos, y algunos datos est√°n encriptados en esta secuencia, pero mientras no tenga una anotaci√≥n para esta secuencia, estos datos no tienen valor para usted, porque  No puedes interpretarlos. </p><br><pre> <code class="plaintext hljs">//     1101111000000010010110000010011100010000</code> </pre> <br><p>  Lo que es visible aqu√≠, tenemos algunos bits, qu√© tipo de bits no tenemos idea.  Bueno, intentemos, por ejemplo, dividirlos en bytes y representarlos en un sistema decimal </p><br><pre> <code class="plaintext hljs">//   5  11011110 00000010 01011000 00100111 00010000 //    222 2 88 39 16</code> </pre> <br><p>  Bueno, los interpretamos y obtuvimos algunos resultados, digamos que estos datos son responsables de cu√°nto debe un determinado departamento por la electricidad.  Resulta que en la casa 222 el apartamento n√∫mero 2 debe pagar 88 rublos.  ¬øY qu√© m√°s para dos d√≠gitos, qu√© hacer con ellos solo para soltar?  Por supuesto que no!  El hecho es que no ten√≠amos una notaci√≥n (formato) que nos dijera c√≥mo interpretar los datos e interpretarlos a nuestra manera, en este sentido recibimos no solo resultados in√∫tiles, sino tambi√©n da√±inos.  Como resultado, el apartamento 2 pag√≥ absolutamente no lo que deber√≠a.  (los ejemplos son ciertamente exagerados y solo sirven para explicar m√°s claramente la situaci√≥n) </p><br><p>  Ahora veamos c√≥mo debemos interpretar estos datos correctamente, teniendo una notaci√≥n (formato).  Adem√°s, llamar√© a las cosas por su nombre, a saber notaci√≥n = formato ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠ formatos</a> ). </p><br><pre> <code class="plaintext hljs">//  "Cnn" //  //C -   (char) (8 ) //n -  short (16 ) //      11011110 0000001001011000 0010011100010000 //    222 600 10000</code> </pre> <br><p>  Ahora todo converge en la casa No. 222, el apartamento 600 para la electricidad deber√≠a ser de 1000 rublos. Creo que ahora la importancia del formato es clara, y ahora est√° claro qu√© aspecto tiene una estructura similar.  (preste atenci√≥n, aqu√≠ el objetivo no es explicar en detalle cu√°les son estas estructuras, sino dar una comprensi√≥n general de lo que es y c√≥mo funciona) </p><br><p>  El s√≠mbolo de esta estructura ser√° </p><br><pre> <code class="plaintext hljs">struct { unsigned char houseNumber; unsigned char flatNumperA1; unsigned char flatNumperA2; unsigned char summB1; unsigned char summB2; }; // ,           // houseNumber -  // flatNumperA1 &amp;&amp; flatNumperA2 -  // summB1 &amp;&amp; summB2 -  </code> </pre> <br><h5 id="esche-nemnogo-teorii-fastcgi-zapisi">  Algo m√°s de teor√≠a (entradas FastCgi) </h5><br><p>  Como dije anteriormente, la unidad de informaci√≥n en el protocolo FastCgi son los registros.  El servidor env√≠a los registros a la aplicaci√≥n y recibe los mismos registros en respuesta.  Un registro consta de un encabezado y un cuerpo con datos. </p><br><p>  Estructura del encabezado: </p><br><ol><li>  la versi√≥n del protocolo (siempre 1) se denota por 1 byte ('C') </li><li>  tipo de registro  Para abrir, cerrar la conexi√≥n, etc. No considerar√© todo, solo considerar√© lo que se necesita para una tarea espec√≠fica, si se necesitan otras, agradecemos la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">especificaci√≥n</a> aqu√≠.  Est√° indicado por 1 byte ('C'). </li><li>  El ID de solicitud, un n√∫mero arbitrario, se denota por 2 bytes ('n') </li><li>  La longitud del cuerpo del registro (datos), indicado por 2 bytes ('n') </li><li>  la longitud de los datos de alineaci√≥n y los datos reservados, un byte cada uno (no es necesario prestar especial atenci√≥n para no distraerse del principal en nuestro caso siempre habr√° 0) </li></ol><br><p>  El siguiente es el cuerpo del registro: </p><br><ol><li>  los datos en s√≠ (aqu√≠ son precisamente las variables que se transfieren) pueden ser bastante grandes (hasta 65535 bytes) </li></ol><br><p>  Aqu√≠ hay un ejemplo del registro binario FastCgi m√°s simple con formato </p><br><pre> <code class="plaintext hljs">struct { // unsigned char version; unsigned char type; unsigned char idA1; unsigned char idA2; unsigned char bodyLengthB1; unsigned char bodyLengthB2; unsigned char paddingLength; unsigned char reserved; //  unsigned char contentData; // 65535  unsigned char paddingData; };</code> </pre> <br><h4 id="praktika">  Practica </h4><br><h5 id="skript-klient-i-peredayuschiy-soket">  Cliente de script y socket de transmisi√≥n </h5><br><p>  Para la transferencia de datos, utilizaremos la extensi√≥n de socket php est√°ndar.  Y lo primero que hay que hacer es configurar <strong>php-fpm</strong> para escuchar en el puerto del host local, por ejemplo 9000. Esto se hace en la mayor√≠a de los casos en el archivo '/etc/php/7.3/fpm/pool.d/www.conf', la ruta de acceso por supuesto Depende de la configuraci√≥n de su sistema.  All√≠ debe registrar algo como lo siguiente (traigo todo el calzado para que pueda navegar, la secci√≥n principal es escuchar aqu√≠) </p><br><pre> <code class="plaintext hljs">; The address on which to accept FastCGI requests. ; Valid syntaxes are: ; 'ip.add.re.ss:port' - to listen on a TCP socket to a specific IPv4 address on ; a specific port; ; '[ip:6:addr:ess]:port' - to listen on a TCP socket to a specific IPv6 address on ; a specific port; ; 'port' - to listen on a TCP socket to all addresses ; (IPv6 and IPv4-mapped) on a specific port; ; '/path/to/unix/socket' - to listen on a unix socket. ; Note: This value is mandatory. ;listen = /run/php/php7.3-fpm.sock listen = 127.0.0.1:9002</code> </pre> <br><p>  Despu√©s de configurar fpm, el siguiente paso es conectarse al z√≥calo </p><br><pre> <code class="php hljs">$service_port = <span class="hljs-number"><span class="hljs-number">9000</span></span>; $address = <span class="hljs-string"><span class="hljs-string">'127.0.0.1'</span></span>; $socket = socket_create(AF_INET, SOCK_STREAM, SOL_TCP); $result = socket_connect($socket, $address, $service_port);</code> </pre> <br><h4 id="nachalo-zaprosa-fcgi_begin_request">  Inicio de la solicitud FCGI_BEGIN_REQUEST </h4><br><p>  Para abrir una conexi√≥n, debemos enviar una entrada con el tipo FCGI_BEGIN_REQUEST = 1 El t√≠tulo de la entrada ser√° as√≠ (para convertir los valores num√©ricos a una cadena binaria con el formato especificado, se utilizar√° el paquete de funciones php) </p><br><pre> <code class="php hljs">socket_write($socket, pack(<span class="hljs-string"><span class="hljs-string">'CCnnCx'</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>)); <span class="hljs-comment"><span class="hljs-comment">//  - 1 //  - 1 - FCGI_BEGIN_REQUEST //id - 1 //   - 8  // - 0</span></span></code> </pre> <br><p>  El cuerpo de grabaci√≥n para abrir una conexi√≥n debe contener un rol de grabaci√≥n y una bandera que controle la conexi√≥n. </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//      //struct { // unsigned char roleB1; // unsigned char roleB0; // unsigned char flags; // unsigned char reserved[5]; //}; //php  socket_write($socket, pack('nCxxxxx', 1, 0)); // - 1 -  // - 1 -    1   </span></span></code> </pre> <br><p>  Entonces, el registro para abrir la conexi√≥n se envi√≥ con √©xito, <strong>php-fpm</strong> lo aceptar√° y seguir√° esperando de nosotros un registro adicional en el que necesitemos transferir datos para implementar el entorno y ejecutar el script. </p><br><h4 id="peredacha-parametrov-okruzheniya-fcgi_params">  Par√°metros de entorno de paso FCGI_PARAMS </h4><br><p>  En este registro, pasaremos todos los par√°metros necesarios para implementar el entorno, as√≠ como el nombre del script que necesitaremos ejecutar. </p><br><p>  Configuraci√≥n m√≠nima del entorno requerida </p><br><pre> <code class="php hljs">$url = <span class="hljs-string"><span class="hljs-string">'/path/to/script.php'</span></span> $env = [ <span class="hljs-string"><span class="hljs-string">'REQUEST_METHOD'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'GET'</span></span>, <span class="hljs-string"><span class="hljs-string">'SCRIPT_FILENAME'</span></span> =&gt; $url, ];</code> </pre> <br><p>  Lo primero que debemos hacer aqu√≠ es preparar las variables necesarias, es decir, los pares nombre =&gt; valor que pasaremos a la aplicaci√≥n. </p><br><p>  La estructura del valor del nombre de los pares ser√° tal </p><br><pre> <code class="plaintext hljs">//          128  typedef struct { unsigned char nameLength; unsigned char valueLength; unsigned char nameData unsigned char valueData; }; //    1 </code> </pre> <br><p>  Primero hay 1 byte: el nombre es largo, luego 1 byte es el valor </p><br><pre> <code class="plaintext hljs">//         128  typedef struct { unsigned char nameLengthA1; unsigned char nameLengthA2; unsigned char nameLengthA3; unsigned char nameLengthA4; unsigned char valueLengthB1; unsigned char valueLengthB2; unsigned char valueLengthB3; unsigned char valueLengthB4; unsigned char nameData unsigned char valueData; }; //    4 </code> </pre> <br><p>  En nuestro caso, tanto el nombre como los significados son cortos y se ajustan a la primera opci√≥n, por lo que lo consideraremos. </p><br><p>  Codificar nuestras variables de acuerdo con el formato </p><br><pre> <code class="php hljs">$keyValueFcgiString = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($env <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $key =&gt; $value) { <span class="hljs-comment"><span class="hljs-comment">//        //  128         $keyLen = strlen($key); $lenKeyChar = $keyLen &lt; 128 ? chr($keyLen) : pack('N', $keyLen); $valLen = strlen($value); $valLenChar = $valLen &lt; 128 ? chr($valLen) : pack('N', $valLen); $keyValueFcgiString .= $lenKeyChar . $valLenChar . $key . $value; }</span></span></code> </pre> <br><p>  Aqu√≠ los valores de menos de 128 bits est√°n codificados por la funci√≥n <em>chr ($ keyLen)</em> , m√°s que el <em>paquete ('N', $ valLen)</em> , donde 'N' representa 4 bytes.  Y luego todo esto se une en una l√≠nea de acuerdo con el formato de la estructura.  El cuerpo de la grabaci√≥n est√° listo. </p><br><p>  En el encabezado del registro, transferimos todo igual que en el registro anterior, excepto el tipo (ser√° FCGI_PARAMS = 4) y la longitud de los datos (ser√° igual a la longitud de los pares nombre =&gt; valor, o la longitud de la cadena $ keyValueFcgiString que formamos anteriormente). </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//  socket_write($socket, pack('CCnnCx', 1, 4, 1, strlen($keyValueFcgiString), 0)); // body socket_write($socket, $keyValueFcgiString); //             //  body socket_write($socket, pack('CCnnCx', 1, 4, 1, 0, 0));</span></span></code> </pre> <br><h4 id="poluchenie-otveta-fcgi_params">  Obteniendo una respuesta de FCGI_PARAMS </h4><br><p>  En realidad, despu√©s de todo lo anterior, y todo lo que espera ha sido enviado a la aplicaci√≥n, comienza a funcionar y solo podemos tomar el resultado de este trabajo desde el socket. <br>  Recuerde que en respuesta obtenemos las mismas notas y tambi√©n tenemos que interpretarlas. </p><br><p>  Obtenemos el encabezado, siempre es de 8 bytes (recibiremos datos por byte) </p><br><pre> <code class="php hljs">$buf = <span class="hljs-string"><span class="hljs-string">''</span></span>; $arrData = []; $len = <span class="hljs-number"><span class="hljs-number">8</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ($len) { socket_recv($socket, $buf, <span class="hljs-number"><span class="hljs-number">1</span></span>, MSG_WAITALL); <span class="hljs-comment"><span class="hljs-comment">//   1       $arrData[] = $buf; $len--; } //      'CCnnCx' $protocol = unpack('C', $arrData[0]); $type = unpack('C', $arrData[1]); $id = unpack('n', $arrData[2] . $arrData[3]); $dataLen = unpack('n', $arrData[4] . $arrData[5])[1]; //   ,        (unpack  ,    ) $foo = unpack('C', $arrData[6]); var_dump($dataLen); //     </span></span></code> </pre> <br><p>  Ahora, de acuerdo con la longitud del cuerpo de respuesta recibida, haremos otra lectura desde el socket </p><br><pre> <code class="php hljs">$buf2 = <span class="hljs-string"><span class="hljs-string">''</span></span>; $result = []; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ($dataLen) { socket_recv($socket, $buf2, <span class="hljs-number"><span class="hljs-number">1</span></span>, MSG_WAITALL); $result[] = $buf2; $dataLen--; } var_dump(implode(<span class="hljs-string"><span class="hljs-string">''</span></span>, $result)); <span class="hljs-comment"><span class="hljs-comment">//       socket_close($socket);</span></span></code> </pre> <br><p>  ¬°Hurra, funcion√≥!  Por fin eso! <br>  ¬øQu√© tenemos en la respuesta, si por ejemplo en este archivo </p><br><pre> <code class="php hljs">$url = <span class="hljs-string"><span class="hljs-string">'/path/to/script.php'</span></span> <span class="hljs-comment"><span class="hljs-comment">//    </span></span></code> </pre> <br><p>  nosotros escribiremos </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"My fcgi script"</span></span>;</code> </pre> <br><p>  entonces en la respuesta obtenemos como resultado </p><br><p><img src="https://habrastorage.org/webt/dq/pc/ox/dqpcox1zbmcutdzxxeh69i_hbsc.png" alt="imagen"></p><br><h3 id="itogi">  Resumen </h3><br><p>  No escribir√© mucho aqu√≠, as√≠ que result√≥ el largo art√≠culo.  Espero que ella ayude a alguien.  Y dar√© el gui√≥n final en s√≠ mismo, result√≥ ser bastante peque√±o.  Por supuesto, puede hacer bastante en esta forma, y ‚Äã‚Äãno tiene manejo de errores y todo esto, pero no lo necesita, lo necesita como ejemplo para mostrar lo b√°sico. </p><br><div class="spoiler">  <b class="spoiler_title">Versi√≥n completa del gui√≥n</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $url = <span class="hljs-string"><span class="hljs-string">'/path/to/script.php'</span></span>; $env = [ <span class="hljs-string"><span class="hljs-string">'REQUEST_METHOD'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'GET'</span></span>, <span class="hljs-string"><span class="hljs-string">'SCRIPT_FILENAME'</span></span> =&gt; $url, ]; $service_port = <span class="hljs-number"><span class="hljs-number">9000</span></span>; $address = <span class="hljs-string"><span class="hljs-string">'127.0.0.1'</span></span>; $socket = socket_create(AF_INET, SOCK_STREAM, SOL_TCP); $result = socket_connect($socket, $address, $service_port); <span class="hljs-comment"><span class="hljs-comment">//  //     php-fpm //    ,   (    ), id ,   ,     socket_write($socket, pack('CCnnCx', 1, 1, 1, 8, 0)); //     // ,     socket_write($socket, pack('nCxxxxx', 1, 0)); $keyValueFcgiString = ''; foreach ($env as $key =&gt; $value) { //        //  128         $keyLen = strlen($key); $lenKeyChar = $keyLen &lt; 128 ? chr($keyLen) : pack('N', $keyLen); $valLen = strlen($value); $valLenChar = $valLen &lt; 128 ? chr($valLen) : pack('N', $valLen); $keyValueFcgiString .= $lenKeyChar . $valLenChar . $key . $value; } // ,      php-fpm           //      //1- ( ), 4-  (,    - FCGI_PARAMS), id  ( ),    (   -),     socket_write($socket, pack('CCnnCx', 1, 4, 1, strlen($keyValueFcgiString), 0)); //      socket_write($socket, $keyValueFcgiString); //  socket_write($socket, pack('CCnnCx', 1, 4, 1, 0, 0)); $buf = ''; $arrData = []; $len = 8; while ($len) { socket_recv($socket, $buf, 1, MSG_WAITALL); //   1       $arrData[] = $buf; $len--; } //      'CCnnCx' $protocol = unpack('C', $arrData[0]); $type = unpack('C', $arrData[1]); $id = unpack('n', $arrData[2] . $arrData[3]); $dataLen = unpack('n', $arrData[4] . $arrData[5])[1]; //   ,        (unpack  ,    ) $foo = unpack('C', $arrData[6]); $buf2 = ''; $result = []; while ($dataLen) { socket_recv($socket, $buf2, 1, MSG_WAITALL); $result[] = $buf2; $dataLen--; } var_dump(implode('', $result)); //       socket_close($socket);</span></span></code> </pre></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/472190/">https://habr.com/ru/post/472190/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../472178/index.html">Holivar Historia de Runet. Parte 7. YouTube: comediantes, chillidos y Silicon Valley</a></li>
<li><a href="../472182/index.html">Anuncio de .NET Core 3.1 Preview 1</a></li>
<li><a href="../472184/index.html">SSH remoto: consejos y trucos</a></li>
<li><a href="../472186/index.html">Principio abierto-cerrado</a></li>
<li><a href="../472188/index.html">Lo que necesita saber sobre la verificaci√≥n de cheques de la tienda de aplicaciones (recibo de la tienda de aplicaciones)</a></li>
<li><a href="../472196/index.html">"Sugar" hecho en casa para un proyecto de Android o "C√≥mo no hacerlo"</a></li>
<li><a href="../472198/index.html">Localizaci√≥n de mensajes push en aplicaciones m√≥viles.</a></li>
<li><a href="../472200/index.html">Modernizaci√≥n de la clase de inform√°tica en una escuela rusa sobre frambuesa: barata y alegre</a></li>
<li><a href="../472202/index.html">Windows 10 + Python = C√≥digo VS + WSL</a></li>
<li><a href="../472204/index.html">Experimentos simples con el microcontrolador STM32F103 (Blue Tablet)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>