<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèø‚Äçüíº üç≠ üç§ No√ß√µes b√°sicas de escalonamento de privil√©gios do Windows ‚úåÔ∏è üë©‚Äç‚öñÔ∏è ü§ù</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Decidi por mim e por aqueles que considerariam √∫til coletar tudo o que sei, mas n√£o me lembro do t√≥pico neste artigo. Compartilhe dicas. A principal f...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>No√ß√µes b√°sicas de escalonamento de privil√©gios do Windows</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/418441/"> Decidi por mim e por aqueles que considerariam √∫til coletar tudo o que sei, mas n√£o me lembro do t√≥pico neste artigo.  Compartilhe dicas.  A principal fonte deste artigo √© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">essa</a> . <br><br>  Traduzi livremente e acrescentei um pouco de mim mesmo, o que reuni e aprendi de outras fontes. <br><br>  Em geral, aqui est√£o algumas maneiras de nos ajudar a alcan√ßar nossa meta de escala√ß√£o de privil√©gios. <br><a name="habracut"></a><br>  O ponto de partida para este breve artigo √© um shell sem privil√©gios (conta).  Talvez tenhamos utilizado uma explora√ß√£o ou realizado um ataque e conseguido esse shell. <br><br>  Basicamente, no momento inicial, n√£o entendemos a m√°quina: o que faz, a que est√° conectada, a qual n√≠vel de privil√©gios temos, ou mesmo que sistema operacional √©. <br><br>  Primeiro, precisamos obter as informa√ß√µes necess√°rias para entender onde estamos e o que temos: <br><br><pre><code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">systeminfo</span></span> | findstr /B /C:<span class="hljs-string"><span class="hljs-string">" "</span></span> /C:<span class="hljs-string"><span class="hljs-string">" "</span></span></code> </pre> <br>  Este comando permite determinar, como voc√™ pode ver, o nome e a vers√£o do sistema operacional.  Voc√™ pode execut√°-lo sem par√¢metros, ent√£o a sa√≠da do comando ser√° mais completa, mas isso √© suficiente para n√≥s. <br><br>  Em seguida, √© importante descobrir o nome da m√°quina e o nome de usu√°rio com o qual estamos conectados. <br><br><ul><li>  hostname √© o nome de usu√°rio. </li><li>  eco% nome de usu√°rio% - nome de usu√°rio. </li></ul><br>  A seguir, vamos ver quais usu√°rios ainda est√£o neste host e obter informa√ß√µes mais detalhadas sobre seus usu√°rios. <br><br><ul><li>  usu√°rios da rede - outros usu√°rios </li><li>  net user user1 - informa√ß√µes detalhadas sobre o usu√°rio, onde user1 √© o nome do seu usu√°rio. </li></ul><br>  Depois de receber informa√ß√µes sobre a conta, veremos informa√ß√µes sobre a intera√ß√£o de rede deste host. <br><br>  Primeiro, d√™ uma olhada nas interfaces dispon√≠veis e na tabela de roteamento. <br><br><ul><li>  ipconfig / all - informa√ß√µes sobre as interfaces dispon√≠veis. </li><li>  impress√£o de rota - tabela de roteamento </li><li>  arp -A - tabela de entradas arp </li></ul><br>  A seguir, veremos as conex√µes de rede ativas e as regras de firewall. <br><br><ul><li>  netstat -ano - conex√µes de rede ativas. </li></ul><br>  -a - iniciar com este par√¢metro exibe todas as conex√µes TCP ativas, bem como as portas TCP e UDP ouvidas pelo sistema; <br>  -n - o par√¢metro permite mostrar conex√µes TCP ativas com endere√ßos e n√∫meros de porta; <br>  -o - igual √† chave anterior, exibe conex√µes TCP ativas, mas os c√≥digos de processo s√£o adicionados √†s estat√≠sticas, j√° √© poss√≠vel determinar exatamente qual aplicativo usa a conex√£o. <br><br><ul><li>  netsh firewall show state - status do firewall </li><li>  netsh firewall show config - configura√ß√£o de firewall </li></ul><br>  Por fim, examinamos brevemente o que funciona em um host comprometido: tarefas agendadas, processos em execu√ß√£o, servi√ßos em execu√ß√£o e drivers instalados. <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">schtasks</span></span> /query /fo LIST /v</code> </pre> <br>  onde <br>  / query - Exibe dados sobre todas as tarefas agendadas, <br>  / fo LIST - Lista a sa√≠da. <br>  / v - Imprimir detalhes do trabalho. <br><br>  O comando a seguir associa processos em execu√ß√£o a servi√ßos em execu√ß√£o. <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">tasklist</span></span> /SVC</code> </pre> <br>  onde <br>  / SVC - Servi√ßos de mapeamento para cada processo. <br><br>  Veja tamb√©m uma lista de servi√ßos do Windows em execu√ß√£o. <br><br><pre> <code class="hljs dos"><span class="hljs-built_in"><span class="hljs-built_in">net</span></span> <span class="hljs-built_in"><span class="hljs-built_in">start</span></span></code> </pre> <br>  Tamb√©m √© √∫til ver informa√ß√µes sobre os drivers de um sistema comprometido. <br><br><pre> <code class="hljs">DRIVERQUERY</code> </pre> <br>  Em seguida, quero mencionar provavelmente o comando mais √∫til do Windows - wmic.  O comando WMIC (Comando da Instrumenta√ß√£o de Gerenciamento do Windows) √© usado para obter informa√ß√µes sobre o hardware e o sistema, gerenciar processos e seus componentes e alterar as configura√ß√µes usando os recursos da Instrumenta√ß√£o de Gerenciamento do Windows (WMI).  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Boa descri√ß√£o</a> <br><br>  Infelizmente, algumas configura√ß√µes do Windows n√£o permitem o acesso ao WMIC por padr√£o, se o usu√°rio n√£o for membro do grupo Administradores (o que √© realmente uma boa ideia).  Qualquer vers√£o do XP n√£o permitia acesso ao WMIC a partir de uma conta n√£o privilegiada. <br><br>  Por outro lado, o Windows 7 Professional e o Windows 8 Enterprise permitiram que usu√°rios com privil√©gios baixos usassem o WMIC por padr√£o. <br><br>  Como de costume - par√¢metros do programa: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">wmic</span></span> /?</code> </pre> <br>  <a href="">Um bom script para coletar informa√ß√µes atrav√©s do wmic.</a> <br><br>  Antes de prosseguir, vale a pena percorrer as informa√ß√µes coletadas.  Tamb√©m vale a pena prestar aten√ß√£o nos patches instalados no sistema, pois qualquer informa√ß√£o sobre os orif√≠cios no sistema nos dar√° suporte adicional para aumentar nossos privil√©gios.  O HotFix pode procurar vulnerabilidades de escala√ß√£o de privil√©gios. <br><br>  A seguir, consideraremos uma instala√ß√£o silenciosa.  Se for necess√°rio instalar e configurar uma grande frota de m√°quinas, como regra geral, o pessoal t√©cnico n√£o passar√° de uma m√°quina para outra para configurar cada uma.  Existem v√°rias solu√ß√µes para instala√ß√£o aut√¥noma.  N√£o √© t√£o importante para n√≥s o que s√£o esses m√©todos e como eles funcionam, mas o importante √© que eles deixem os arquivos de configura√ß√£o usados ‚Äã‚Äãpara o processo de instala√ß√£o que cont√™m muitas informa√ß√µes confidenciais, como a chave do produto do sistema operacional e a senha do administrador.  O que mais nos interessa √© a senha de administrador, que podemos usar para aumentar nossos privil√©gios. <br><br>  Como regra, estes s√£o os seguintes diret√≥rios: <br><br><ul><li>  c: \ sysprep.inf </li><li>  c: \ sysprep \ sysprep.xml </li><li>  % WINDIR% \ Pantera \ Unattend \ Unattended.xml </li><li>  % WINDIR% \ Panther \ Unattended.xml </li></ul><br>  Mas vale a pena conferir todo o sistema. <br><br>  Esses arquivos cont√™m senhas em texto n√£o criptografado ou codificado em BASE64. <br>  Exemplos: <br><br>  Sysprep.inf - senha em texto n√£o criptografado. <br><br><img src="https://habrastorage.org/webt/fq/1t/qm/fq1tqm53bjiwjlwsbrevzdcy6qw.png">  " <br><br>  Sysprep.xml - senha codificada em base64. <br><br><img src="https://habrastorage.org/webt/rh/2r/gk/rh2rgkl3wtby-9lagcxmfrnrlgu.png">  " <br><br>  Unattended.xml - senha codificada em base64. <br><br><img src="https://habrastorage.org/webt/5e/1p/gl/5e1pglvwtogk0kd0xn4cmey_hlo.png"><br><br>  Al√©m disso, para hosts conectados ao dom√≠nio, voc√™ pode procurar o arquivo Group.xml, que cont√©m a senha criptografada AES256, mas que pode ser descriptografada, porque  a chave √© publicada no msdn (https://msdn.microsoft.com/en-us/library/cc422924.aspx) e em outras fontes.  Mas esse √© o caso se a pol√≠tica de criar usu√°rios locais em hosts ou, por exemplo, definir uma senha para um administrador local for usada. <br><br>  Por exemplo, eu tenho aqui: <br><br><img src="https://habrastorage.org/webt/jy/wu/4g/jywu4g6xzymrbkwwniw4m_3uckg.png"><br><br>  Depois de aberto, procuramos o par√¢metro "cpassword". <br><br><img src="https://habrastorage.org/webt/i9/ow/hk/i9owhkwprnwlpmltga00uj-awx4.png"><br><br>  Em seguida, voc√™ precisa descriptografar esta sequ√™ncia.  Usamos, por exemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">CrypTool</a> .  Primeiro, decodifique o Base64. <br>  Os recursos da Base64 s√£o que seu comprimento deve ser m√∫ltiplo de 4. Portanto, consideramos blocos de 4 e, se n√£o houver caracteres suficientes no √∫ltimo bloco, adicionamos os caracteres ausentes com "=". <br>  Eu tenho 2 "=". <br><br><img src="https://habrastorage.org/webt/bm/sc/73/bmsc73fsqblniktrnrsyugqowhi.png"><br><br>  Em seguida, descriptografamos.  Usando a tecla acima. <br><br><img src="https://habrastorage.org/webt/-f/n0/nt/-fn0ntf9um-zfyfoqpn7uwafoay.png"><br><br>  Removemos os pontos extras que separam os caracteres e obtemos a senha. <br><br>  Al√©m do Group.xml, aqui est√£o alguns outros arquivos de prefer√™ncias de pol√≠tica que podem ter um conjunto adicional de atributos do cPassword: <br><br><ul><li>  Services \ Services.xml </li><li>  ScheduledTasks \ ScheduledTasks.xml </li><li>  Printers \ Printers.xml </li><li>  Drives \ Drives.xml </li><li>  DataSources \ DataSources.xml </li></ul><br>  No entanto, todos gostamos de solu√ß√µes automatizadas, para que possamos chegar √† linha de chegada o mais r√°pido poss√≠vel.  Existem duas op√ß√µes principais aqui, dependendo do tipo de shell / acesso que temos.  H√° um m√≥dulo metasploit que pode ser executado por meio de uma sess√£o estabelecida (https://www.rapid7.com/db/modules/post/windows/gather/credentials/gpp) ou voc√™ pode usar Get-GPPPassword, que faz parte do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">PowerSploit</a> . <br><br>  Ok, em seguida.  Procuraremos o estranho par√¢metro de registro "AlwaysInstallElevated".  Essa op√ß√£o permite que usu√°rios sem privil√©gios instalem arquivos .msi do NT AUTHORITY \ SYSTEM. <br><br>  Para poder usar isso, precisamos verificar se as duas chaves do Registro est√£o instaladas e, se houver, podemos obter um shell do SISTEMA.  Verifique: <br><br><pre> <code class="hljs tex">reg query HKLM<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SOFTWARE</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Policies</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Microsoft</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Windows</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Installer</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">AlwaysInstallElevated</span></span></span></span></code> </pre> <br><pre> <code class="hljs tex">reg query HKCU<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SOFTWARE</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Policies</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Microsoft</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Windows</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Installer</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">AlwaysInstallElevated</span></span></span></span></code> </pre> <br>  O Metasploit inclui um m√≥dulo especial exploit / windows / local / always_install_elevated, que cria um arquivo MSI com um arquivo execut√°vel especial embutido nele, que √© extra√≠do e executado pelo instalador com privil√©gios de sistema.  Ap√≥s sua execu√ß√£o, o arquivo msi interrompe a instala√ß√£o para impedir o registro de a√ß√µes no sistema.  Al√©m disso, se voc√™ iniciar a instala√ß√£o com a op√ß√£o / quiet, nem receber√° um erro. <br><br>  Bem, alguns comandos √∫teis de pesquisa no sistema: <br><br>  O comando abaixo procurar√° no sistema de arquivos por nomes de arquivos contendo palavras-chave espec√≠ficas.  Voc√™ pode especificar qualquer n√∫mero de palavras-chave. <br><br><pre> <code class="hljs markdown">dir /s <span class="hljs-emphasis"><span class="hljs-emphasis">*pass*</span></span> == <span class="hljs-emphasis"><span class="hljs-emphasis">*cred*</span></span> == <span class="hljs-emphasis"><span class="hljs-emphasis">*vnc*</span></span> == <span class="hljs-emphasis"><span class="hljs-emphasis">*.config*</span></span></code> </pre> <br>  Procurando tipos de arquivos espec√≠ficos por palavra-chave, este comando pode gerar muita sa√≠da. <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">findstr</span></span> /si password <span class="hljs-regexp"><span class="hljs-regexp">*.xml</span></span> <span class="hljs-regexp"><span class="hljs-regexp">*.ini</span></span> <span class="hljs-regexp"><span class="hljs-regexp">*.txt</span></span></code> </pre> <br>  Da mesma forma, os dois comandos abaixo podem ser usados ‚Äã‚Äãpara saudar o registro por palavras-chave, neste caso, "senha". <br><br><pre> <code class="hljs pgsql">reg query HKLM /f <span class="hljs-keyword"><span class="hljs-keyword">password</span></span> /t REG_SZ /s</code> </pre> <br><pre> <code class="hljs pgsql">reg query HKCU /f <span class="hljs-keyword"><span class="hljs-keyword">password</span></span> /t REG_SZ /s</code> </pre> <br>  No momento, j√° temos o suficiente para iniciar o sistema.  Mas h√° mais alguns ataques direcionados para obter o resultado desejado: veremos os servi√ßos e permiss√µes do Windows para arquivos e pastas.  Nosso objetivo aqui √© usar permiss√µes fracas para aprimorar os privil√©gios da sess√£o. <br><br>  Verificaremos muitos direitos de acesso, accesschk.exe, que √© uma ferramenta do Microsoft Sysinternals Suite, nos ajudar√° com isso.  O Microsoft Sysinternals cont√©m muitas ferramentas excelentes.  O pacote pode ser baixado no site de tecnologia da Microsoft (https://docs.microsoft.com/ru-ru/sysinternals/downloads/sysinternals-suite). <br><br>  Podemos verificar o n√≠vel de privil√©gio necess√°rio para cada servi√ßo usando accesschk. <br><br>  Podemos ver as permiss√µes que cada n√≠vel de usu√°rio possui. <br><br><img src="https://habrastorage.org/webt/jo/pf/q2/jopfq2pwodrwtcexiainzaji4yk.png"><br><br>  O Accesschk pode verificar automaticamente se temos acesso de grava√ß√£o a um servi√ßo do Windows com um n√≠vel de usu√°rio espec√≠fico.  Como regra, como um usu√°rio com baixos privil√©gios, queremos verificar os "Usu√°rios".  Certifique-se de verificar a quais grupos de usu√°rios voc√™ pertence. <br><br>  -c O nome √© um servi√ßo do Windows, por exemplo ssdpsrv (especifique "*" para exibir todos os servi√ßos) <br>  -d Processa apenas diret√≥rios <br>  -e Exibe apenas n√≠veis de integridade especificados explicitamente (somente Windows Vista) <br>  -k O nome √© uma chave de registro, por exemplo, hklm \ software <br>  -n Exibe apenas objetos que n√£o possuem regras de acesso <br>  -p O nome ou identificador do processo (PID) √© especificado como o nome, por exemplo cmd.exe (especifique "*" como o nome para exibir todos os processos) <br>  -q Omitir cabe√ßalho <br>  -r Imprime apenas objetos que t√™m acesso de leitura <br>  -s Processamento recursivo <br>  -v Imprime informa√ß√µes detalhadas <br>  -w Listar apenas objetos que t√™m acesso de grava√ß√£o <br><br><img src="https://habrastorage.org/webt/4z/1r/u6/4z1ru6mikuprkxybtdzohmzgl5s.png"><br><br>  H√° tamb√©m outro comando interessante: <br><br><pre> <code class="hljs dos">autorunsc.exe -a | <span class="hljs-built_in"><span class="hljs-built_in">findstr</span></span> /n /R "File\ <span class="hljs-keyword"><span class="hljs-keyword">not</span></span>\ found"</code> </pre> <br>  Permite encontrar uma entrada de registro sobre um arquivo que foi iniciado automaticamente, mas que j√° est√° ausente do sistema.  O registro poder√° permanecer se, por exemplo, o servi√ßo for exclu√≠do incorretamente.  A cada inicializa√ß√£o, o sistema tenta executar esse arquivo sem √™xito.  Voc√™ tamb√©m pode tirar proveito dessa situa√ß√£o para expandir sua autoridade.  Apenas substitua este arquivo pelo nosso. <br><br>  Em seguida, consideramos duas vulnerabilidades: <br><br>  Primeiro: replique os resultados de um post escrito por Parvez da GreyHatHacker;  ‚ÄúElevando privil√©gios explorando permiss√µes de pasta fracas‚Äù (http://www.greyhathacker.net/?p=738). <br><br>  Este exemplo √© um caso especial de seq√ºestro de dll.  Os programas geralmente n√£o podem funcionar por conta pr√≥pria, eles t√™m muitos recursos que precisam conectar (principalmente dll, mas tamb√©m seus pr√≥prios arquivos).  Se um programa ou servi√ßo baixa um arquivo de um diret√≥rio ao qual temos acesso de grava√ß√£o, podemos abusar dele para iniciar um shell com privil√©gios sob os quais o programa √© executado. <br><br>  Normalmente, um aplicativo Windows usa caminhos de pesquisa predefinidos para encontrar a dll e verifica esses caminhos em uma ordem espec√≠fica.  O sequestro de DLL geralmente ocorre colocando DLLs maliciosos ao longo de um desses caminhos.  Esse problema pode ser corrigido indicando para o aplicativo caminhos absolutos para a dll necess√°ria. <br><br>  Ordem de pesquisa DLL: <br><br><ol><li>  O diret√≥rio a partir do qual o aplicativo est√° sendo executado </li><li>  Diret√≥rio do sistema de 32 bits (C: \ Windows \ System32) </li><li>  Diret√≥rio do sistema de 16 bits (C: \ Windows \ System) </li><li>  Diret√≥rio do Windows (C: \ Windows) </li><li>  Diret√≥rio de trabalho atual (CWD) </li><li>  Diret√≥rios na vari√°vel de ambiente PATH (sistema e usu√°rio) </li></ol><br>  √Äs vezes, os aplicativos tentam baixar arquivos DLL que est√£o faltando na m√°quina.  Isso pode acontecer por v√°rios motivos, por exemplo, se a biblioteca dll for necess√°ria apenas para determinados plug-ins ou componentes que n√£o est√£o instalados.  Nesse caso, Parvez descobriu que alguns servi√ßos do Windows est√£o tentando carregar bibliotecas DLL que n√£o existem nas configura√ß√µes padr√£o. <br><br>  Como a dll n√£o existe, acabamos passando por todos os caminhos de pesquisa.  Como usu√°rio com um n√≠vel de privil√©gio baixo, temos poucas chances de colocar uma dll maliciosa nos itens 1 a 4, 5. Mas se tivermos acesso de grava√ß√£o a qualquer um dos diret√≥rios, nossas chances de vit√≥ria s√£o grandes. <br><br>  Vamos ver como ele funciona na pr√°tica. No nosso exemplo, usaremos o servi√ßo IKEEXT (IPSec IKE e AuthIP key modules) que tenta fazer o download do wlbsctrl.dll. <br><br>  Qualquer diret√≥rio em "C: \" fornecer√° acesso de grava√ß√£o para usu√°rios autenticados, isso nos d√° uma chance. <br><br><pre> <code class="hljs tex">C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Users</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">user</span></span></span></span>1<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Desktop</span></span></span></span>&gt; accesschk.exe -dqv "C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Python</span></span></span></span>27"</code> </pre> <br><pre> <code class="hljs pgsql">C:\Python27 Medium Mandatory <span class="hljs-keyword"><span class="hljs-keyword">Level</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">Default</span></span>) [<span class="hljs-keyword"><span class="hljs-keyword">No</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">Write</span></span>-Up] RW BUILTIN\Administrators FILE_ALL_ACCESS RW NT AUTHORITY\<span class="hljs-keyword"><span class="hljs-keyword">SYSTEM</span></span> FILE_ALL_ACCESS R BUILTIN\Users FILE_LIST_DIRECTORY FILE_READ_ATTRIBUTES FILE_READ_EA FILE_TRAVERSE SYNCHRONIZE READ_CONTROL RW NT AUTHORITY\Authenticated Users FILE_ADD_FILE FILE_ADD_SUBDIRECTORY FILE_LIST_DIRECTORY FILE_READ_ATTRIBUTES FILE_READ_EA FILE_TRAVERSE FILE_WRITE_ATTRIBUTES FILE_WRITE_EA <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> SYNCHRONIZE READ_CONTROL</code> </pre><br><pre> <code class="hljs tex">C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Users</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">user</span></span></span></span>1<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Desktop</span></span></span></span>&gt; icacls "C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Python</span></span></span></span>27"</code> </pre> <br><pre> <code class="hljs tex">C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Python</span></span></span></span>27 BUILTIN<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Administrators</span></span></span></span>:(ID)F BUILTIN<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Administrators</span></span></span></span>:(OI)(CI)(IO)(ID)F NT AUTHORITY<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SYSTEM</span></span></span></span>:(ID)F NT AUTHORITY<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SYSTEM</span></span></span></span>:(OI)(CI)(IO)(ID)F BUILTIN<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Users</span></span></span></span>:(OI)(CI)(ID)R NT AUTHORITY<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Authenticated</span></span></span></span> Users:(ID)C NT AUTHORITY<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Authenticated</span></span></span></span> Users:(OI)(CI)(IO)(ID)C</code> </pre><br>  F - acesso completo. <br>  (OI) - heran√ßa por objetos. <br>  (CI) - heran√ßa por cont√™ineres. <br>  (IO) - apenas heran√ßa. <br>  (NP) - uma proibi√ß√£o da distribui√ß√£o de heran√ßa. <br>  (I) - herda permiss√µes do cont√™iner pai. <br><br>  Antes de prosseguir com a a√ß√£o, voc√™ deve verificar o status do servi√ßo IKEEXT.  Nesse caso, podemos ver que est√° definido como "AUTO_START"! <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">sc</span></span> qc IKEEXT</code> </pre> <br><pre> <code class="hljs tex">[SC] QueryServiceConfig SUCCESS SERVICE_NAME: IKEEXT TYPE : 20 WIN32_SHARE_PROCESS START_TYPE : 2 AUTO_START ERROR_CONTROL : 1 NORMAL BINARY_PATH_NAME : C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Windows</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system</span></span></span></span>32<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">svchost</span></span></span></span>.exe -k netsvcs LOAD_ORDER_GROUP : TAG : 0 DISPLAY_NAME : IKE and AuthIP IPsec Keying Modules DEPENDENCIES : BFE SERVICE_START_NAME : LocalSystem</code> </pre> <br>  Agora sabemos que temos as condi√ß√µes necess√°rias e podemos criar uma dll maliciosa e interceptar o shell! <br><br>  Usamos Metasploit -&gt; msfvenom, por exemplo. <br><br><img src="https://habrastorage.org/webt/ac/-m/_z/ac-m_z8lymihvi6r6g3dsxmebr8.png"><br><br>  Depois de transferir o evil.dll para o computador de destino, tudo o que precisamos fazer √© renome√°-lo para wlbsctrl.dll e mov√™-lo para "C: \ Python27".  Feito isso, precisamos aguardar pacientemente a reinicializa√ß√£o da m√°quina (ou podemos tentar for√ßar a reinicializa√ß√£o) e obteremos o shell do sistema. <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">copy</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">evil</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.dll</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">C</span></span>:\<span class="hljs-selector-tag"><span class="hljs-selector-tag">Python27</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">wlbsctrl</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.dll</span></span></code> </pre> <br>  Depois disso, resta apenas aguardar a reinicializa√ß√£o do sistema. <br><br>  Para o nosso √∫ltimo exemplo, consideraremos as tarefas planejadas.  Vou descrever o princ√≠pio, porque  todos podem ter casos diferentes. <br><br>  Encontramos o processo, servi√ßo, aplicativo iniciado pelo agendador de tarefas do SYSTEM. <br>  Verificamos os direitos de acesso √† pasta em que nosso destino est√° localizado. <br><br><pre> <code class="hljs powershell">accesschk.exe <span class="hljs-literal"><span class="hljs-literal">-dqv</span></span> <span class="hljs-string"><span class="hljs-string">"__"</span></span></code> </pre> <br>  √â claro que esse √© um problema s√©rio de configura√ß√£o, mas ainda pior √© o fato de qualquer usu√°rio autenticado (usu√°rio autenticado) ter acesso de grava√ß√£o a essa pasta.  Neste exemplo, podemos simplesmente substituir o execut√°vel bin√°rio pelo arquivo gerado pelo metasploit. <br><br>  Pode ser codificado opcionalmente. <br><br><img src="https://habrastorage.org/webt/7c/p6/qv/7cp6qviajkpgxvibpruzsgqhjv4.png"><br><br>  Agora, resta apenas fazer o download do arquivo execut√°vel malicioso e substitu√≠-lo na pasta do arquivo execut√°vel.  Feito isso, podemos ir para a cama com seguran√ßa e fazer uma caminhada sist√™mica de manh√£ cedo. <br><br>  Esses dois exemplos devem nos dar uma id√©ia das vulnerabilidades que devem ser procuradas ao considerar permiss√µes para arquivos e pastas.  Levar√° algum tempo para aprender todos os caminhos do caminho do bin para servi√ßos do Windows, tarefas agendadas e tarefas de execu√ß√£o autom√°tica. <br><br>  Por fim, algumas dicas para usar o accesschk.exe. <br><br>  Encontre todas as permiss√µes fracas para pastas no disco. <br><br><pre> <code class="hljs swift">accesschk.exe -uwdqs <span class="hljs-type"><span class="hljs-type">Users</span></span> <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>:\ accesschk.exe -uwdqs <span class="hljs-string"><span class="hljs-string">"Authenticated Users"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>:\</code> </pre><br>  Encontre todas as permiss√µes fracas para arquivos no disco. <br><br><pre> <code class="hljs swift">accesschk.exe -uwqs <span class="hljs-type"><span class="hljs-type">Users</span></span> <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>:\*.* accesschk.exe -uwqs <span class="hljs-string"><span class="hljs-string">"Authenticated Users"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>:\*.*</code> </pre> <br>  Como tudo. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt418441/">https://habr.com/ru/post/pt418441/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt418429/index.html">Minha experi√™ncia profissional para o papel do treinador √°gil na Europa, parte dois</a></li>
<li><a href="../pt418431/index.html">Problemas imagin√°rios - a raiz do software ruim</a></li>
<li><a href="../pt418433/index.html">4 de agosto Peter. A primeira busca de bicicleta para programadores</a></li>
<li><a href="../pt418437/index.html">Oc equipe para o resgate</a></li>
<li><a href="../pt418439/index.html">No√ß√µes b√°sicas progressivas sobre aplicativos da Web</a></li>
<li><a href="../pt418443/index.html">GObject: encapsulamento, instancia√ß√£o, introspec√ß√£o</a></li>
<li><a href="../pt418445/index.html">Canais do Django - a resposta para a web moderna</a></li>
<li><a href="../pt418447/index.html">Por que o Moscow Python Conf √© agora ++</a></li>
<li><a href="../pt418449/index.html">M√≥dulos bin√°rios para Python</a></li>
<li><a href="../pt418451/index.html">Aulas de impress√£o 3D. Suporte eficaz e altera√ß√£o da altura da camada na pr√°tica do 3Dtool</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>