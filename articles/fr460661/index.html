<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üç© üé§ üë®‚Äçüëß‚Äçüëß Tout ce que vous devez savoir sur Node.js üéß üßì üíΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, Habr! Je vous pr√©sente la traduction de l'article "Tout ce que vous devez savoir sur Node.js" de Jorge Ram√≥n. 





 De nos jours, la plate-f...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Tout ce que vous devez savoir sur Node.js</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/460661/"><p>  Bonjour, Habr!  Je vous pr√©sente la traduction de l'article <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">"Tout ce que vous devez savoir sur Node.js"</a> de Jorge Ram√≥n. </p><br><p><img src="https://habrastorage.org/webt/ua/qz/gr/uaqzgrarpig3cxhjdiuiutbxbms.jpeg"></p><br><p>  De nos jours, la plate-forme Node.js est l'une des plates-formes les plus populaires pour cr√©er des API REST efficaces et √©volutives.  Il convient √©galement pour la cr√©ation d'applications mobiles hybrides, de programmes de bureau et m√™me pour l'IoT. </p><br><p>  Je travaille avec la plateforme Node.js depuis plus de 6 ans et j'adore √ßa.  Ce message essaie principalement d'√™tre un guide sur le fonctionnement r√©el de Node.js. </p><a name="habracut"></a><br><p>  Commen√ßons !! </p><br><p>  <strong>Ce qui sera discut√©:</strong> </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Monde avant Node.js</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Probl√®me C10K</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Node.js et la boucle d'√©v√©nements</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Le probl√®me des t√¢ches gourmandes en CPU</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Les travailleurs et leurs flux</a> </li></ul><br><a name="p1"></a><br><h3 id="mir-do-nodejs">  Monde avant Node.js </h3><br><p>  <strong>Serveur multithread</strong> </p><br><p>  Les applications Web √©crites suivant l'architecture client / serveur fonctionnent comme suit - le client demande la ressource n√©cessaire au serveur et le serveur envoie la ressource en r√©ponse.  Dans ce sch√©ma, le serveur r√©pond √† la demande et met fin √† la connexion. </p><br><p>  Ce mod√®le est efficace car chaque requ√™te adress√©e au serveur consomme des ressources (m√©moire, temps processeur, etc.).  Afin de traiter chaque demande ult√©rieure du client, le serveur doit terminer le traitement de la pr√©c√©dente. </p><br><p>  Est-ce √† dire que le serveur ne peut traiter qu'une seule demande √† la fois?  Pas vraiment!  Lorsque le serveur re√ßoit une nouvelle demande, il cr√©e un <strong>thread</strong> distinct pour le traiter. </p><br><p>  <em>Le flux</em> , en termes simples, est le temps et les ressources que le CPU alloue pour ex√©cuter un petit bloc d'instructions.  Cela dit, le serveur peut traiter plusieurs demandes √† la fois, mais une seule par thread.  Un tel mod√®le est √©galement appel√© mod√®le de <strong>thread par demande</strong> . </p><br><p><img src="https://habrastorage.org/webt/mm/ns/gn/mmnsgnzvz7aptv62xrbo6zxju-w.jpeg"></p><br><p>  Pour traiter N requ√™tes, le serveur a besoin de N threads.  Si le serveur re√ßoit N + 1 requ√™tes, il doit attendre jusqu'√† ce qu'un des threads soit disponible. </p><br><p>  Dans la figure ci-dessus, le serveur peut traiter jusqu'√† 4 requ√™tes (threads) √† la fois et lorsqu'il re√ßoit les 3 requ√™tes suivantes, ces requ√™tes doivent attendre jusqu'√† ce que l'un de ces 4 threads devienne disponible. </p><br><p>  Une fa√ßon de se d√©barrasser des restrictions est d'ajouter plus de ressources (m√©moire, c≈ìurs de processeur, etc.) au serveur, mais ce n'est pas la meilleure solution .... </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/yb/qz/zl/ybqzzljzkgej-kirqwza-43amcw.gif"></div><br><p>  Et, bien s√ªr, n'oubliez pas les limites technologiques. </p><br><p>  <strong>Blocage entr√©e / sortie</strong> </p><br><p>  Le nombre limit√© de threads sur le serveur n'est pas le seul probl√®me.  Vous vous demandez peut-√™tre pourquoi un seul thread ne peut pas traiter plusieurs demandes en m√™me temps?  tout cela en raison du <strong>blocage des op√©rations d'E / S.</strong> </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ei/ao/02/eiao02s-dtpki8au6sybf8-dmbu.gif"></div><br><p>  Supposons que vous d√©veloppez une boutique en ligne et que vous ayez besoin d'une page o√π l'utilisateur peut afficher une liste de tous les produits. </p><br><p>  L'utilisateur frappe sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">http://yourstore.com/products</a> et le serveur rend un fichier HTML avec tous les produits de la base de donn√©es en r√©ponse.  Pas du tout compliqu√©, non? </p><br><p>  Mais que se passe-t-il en coulisses? </p><br><ul><li> Lorsqu'un utilisateur frappe sur <code>/products</code> m√©thode ou une fonction particuli√®re doit √™tre ex√©cut√©e afin de traiter la demande.  Un petit morceau de code (le v√¥tre ou votre framework) analyse l'URL de la requ√™te et recherche une m√©thode ou une fonction appropri√©e.  <strong>Le flux est en cours d'ex√©cution</strong> . <img width="20" src="https://habrastorage.org/webt/o1/sw/x5/o1swx5v-gnn2ptqjjzonhq3oew0.png"></li><li>  Maintenant, la m√©thode ou la fonction souhait√©e est ex√©cut√©e, comme dans le premier paragraphe, le <strong>thread fonctionne.</strong> <img width="20" src="https://habrastorage.org/webt/o1/sw/x5/o1swx5v-gnn2ptqjjzonhq3oew0.png"></li><li>  Puisque vous √™tes un bon d√©veloppeur, vous enregistrez tous les journaux syst√®me dans un fichier, et bien s√ªr, pour √™tre s√ªr que le routeur ex√©cute la m√©thode / fonction souhait√©e - vous enregistrez √©galement la ligne "M√©thode X en cours d'ex√©cution !!". Mais tout cela bloque les op√©rations le <strong>flux d'</strong> entr√©e / sortie <strong>est en attente</strong> . <img width="20" src="https://habrastorage.org/webt/bq/lm/cq/bqlmcq7ntk4kpr2gncodmxpqqee.png"></li><li>  Tous les journaux sont enregistr√©s et les lignes de fonction suivantes sont ex√©cut√©es.  <strong>Le fil fonctionne √† nouveau</strong> . <img width="20" src="https://habrastorage.org/webt/o1/sw/x5/o1swx5v-gnn2ptqjjzonhq3oew0.png"></li><li>  Il est temps d'acc√©der √† la base de donn√©es et d'obtenir tous les produits - une simple requ√™te comme les <code>SELECT * FROM products</code> fait son travail, mais devinez quoi?  Oui, il s'agit d'une op√©ration d'E / S bloquante.  <strong>Le flux attend</strong> . <img width="20" src="https://habrastorage.org/webt/bq/lm/cq/bqlmcq7ntk4kpr2gncodmxpqqee.png"></li><li>  Vous avez re√ßu un tableau ou une liste de tous les produits, mais assurez-vous d'avoir promis tout cela.  <strong>Le flux attend</strong> . <img width="20" src="https://habrastorage.org/webt/bq/lm/cq/bqlmcq7ntk4kpr2gncodmxpqqee.png"></li><li>  Vous avez maintenant tous les produits et il est temps de rendre le mod√®le pour la future page, mais avant cela, vous devez les lire.  <strong>Le flux attend</strong> . <img width="20" src="https://habrastorage.org/webt/bq/lm/cq/bqlmcq7ntk4kpr2gncodmxpqqee.png"></li><li>  Le moteur de rendu fait son travail et envoie une r√©ponse au client.  <strong>Le fil fonctionne √† nouveau</strong> . <img width="20" src="https://habrastorage.org/webt/o1/sw/x5/o1swx5v-gnn2ptqjjzonhq3oew0.png"></li><li>  Le flux est libre, comme un oiseau dans le ciel. <img width="20" src="https://habrastorage.org/webt/wr/vg/0_/wrvg0_hul5qltn9qpyg9fv6beua.png"></li></ul><br><p>  Les op√©rations d'E / S sont-elles lentes?  Eh bien, cela d√©pend du sp√©cifique.  Regardons le tableau: </p><br><div class="scrollable-table"><table><tbody><tr><th>  <b>Fonctionnement</b> </th><th>  <b>Cycles CPU</b> </th></tr><tr><td>  Registres CPU </td><td>  3 mesures </td></tr><tr><td>  Cache L1 </td><td>  8 mesures </td></tr><tr><td>  Cache L2 </td><td>  12 mesures </td></tr><tr><td>  RAM </td><td>  150 mesures </td></tr><tr><td>  Disque </td><td>  30 000 000 mesures </td></tr><tr><td>  R√©seau </td><td>  250 000 000 mesures </td></tr></tbody></table></div><br><p>  Les op√©rations de lecture du r√©seau et du disque sont trop lentes.  Imaginez le nombre de demandes ou d'appels vers des API externes que votre syst√®me pourrait g√©rer pendant cette p√©riode. </p><br><p>  Pour r√©sumer: les op√©rations d'E / S font attendre le thread et gaspillent les ressources. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/bg/qm/k1/bgqmk13cgzyfg7vmynzpkxdxbdc.gif"></div><br><a name="p2"></a><br><h3 id="problema-c10k">  Probl√®me C10K </h3><br><p>  <strong>Le probl√®me</strong> </p><br><p>  <b>C10k</b> (eng. <i>C10k; connexions 10k</i> - probl√®me de 10 000 connexions) </p><br><p>  Au d√©but des ann√©es 2000, les machines serveur et client √©taient lentes.  Le probl√®me est survenu lors du traitement de 10 000 connexions client √† la m√™me machine en parall√®le. </p><br><p>  Mais pourquoi le mod√®le traditionnel de thread par demande (thread sur demande) ne pouvait-il pas r√©soudre ce probl√®me?  Eh bien, utilisons un peu de math√©matiques. </p><br><p>  L'impl√©mentation native des threads alloue plus de 1 Mo de m√©moire par flux, ce qui laisse - pour 10 mille threads, 10 Go de RAM sont requis et cela uniquement pour la pile de flux.  Oui, et n'oubliez pas, nous sommes au d√©but des ann√©es 2000 !! </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/af/99/xc/af99xcxnykot0wq-zv20o-6cvps.jpeg"></div><br><p>  Aujourd'hui, les ordinateurs serveurs et clients fonctionnent plus rapidement et plus efficacement et presque tous les langages de programmation ou framework peuvent faire face √† ce probl√®me.  Mais en fait, le probl√®me n'est pas r√©gl√©.  Pour 10 millions de connexions client √† une machine, le probl√®me revient √† nouveau (mais maintenant c'est le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">probl√®me C10M</a> ). </p><br><p>  <strong>Sauvetage JavaScript?</strong> </p><br><p>  Attention Spoilers <img width="70" src="https://habrastorage.org/webt/vl/iw/8n/vliw8nxrmg8paobiiyvuozjxpdc.png">  !!! <br>  Node.js r√©sout r√©ellement le probl√®me C10K ... mais comment?! </p><br><p>  Le JavaScript c√¥t√© serveur n'√©tait pas quelque chose de nouveau et d'inhabituel au d√©but des ann√©es 2000, √† cette √©poque, il y avait d√©j√† des impl√©mentations au-dessus de la JVM (machine virtuelle java) - RingoJS et AppEngineJS, qui travaillaient sur le mod√®le de thread par demande. </p><br><p>  Mais s'ils ne pouvaient pas r√©soudre le probl√®me, comment Node.js?!  Tout cela parce que JavaScript est <strong>monothread</strong> . </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/lp/nx/vh/lpnxvhxjbmqmkzmblpqqmfcxq0s.gif"></div><br><a name="p3"></a><br><h3 id="nodejs-i-cikl-sobytiy">  Node.js et la boucle d'√©v√©nements </h3><br><p>  <strong>Node.js</strong> </p><br><p>  Node.js est une plate-forme serveur qui fonctionne sur le moteur Google Chrome - V8, qui peut compiler du code JavaScript en code machine. </p><br><p>  Node.js utilise un mod√®le <strong>pilot√© par les √©v√©nements</strong> et une architecture d' <strong>E / S non bloquante</strong> , ce qui le rend l√©ger et efficace.  Ce n'est pas un framework, ni une biblioth√®que, c'est un runtime JavaScript. </p><br><p>  √âcrivons un petit exemple: </p><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// Importing native http module const http = require('http'); // Creating a server instance where every call // the message 'Hello World' is responded to the client const server = http.createServer(function(request, response) { response.write('Hello World'); response.end(); }); // Listening port 8080 server.listen(8080);</span></span></code> </pre> <br><p>  <strong>E / S non bloquantes</strong> </p><br><p>  Node.js utilise des op√©rations d'entr√©e / sortie non bloquantes, qu'est-ce que cela signifie: </p><br><ul><li>  Le thread principal ne sera pas bloqu√© par les op√©rations d'E / S. </li><li>  Le serveur continuera de traiter les demandes. </li><li>  Nous devrons travailler avec du <strong>code asynchrone</strong> . </li></ul><br><p>  √âcrivons un exemple dans lequel le serveur envoie une page HTML en r√©ponse √† une demande √† <code>/home</code> et pour toutes les autres demandes - ¬´Hello World¬ª.  Pour envoyer une page HTML, vous devez d'abord la lire √† partir d'un fichier. </p><br><p> <code>home.html</code> </p> <br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span>This is home page<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p> <code>index.js</code> </p> <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> http = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'http'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> fs = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'fs'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> server = http.createServer(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">request, response</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (request.url === <span class="hljs-string"><span class="hljs-string">'/home'</span></span>) { fs.readFile(<span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${ __dirname }</span></span></span><span class="hljs-string">/home.html`</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, content</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!err) { response.setHeader(<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>, <span class="hljs-string"><span class="hljs-string">'text/html'</span></span>); response.write(content); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { response.statusCode = <span class="hljs-number"><span class="hljs-number">500</span></span>; response.write(<span class="hljs-string"><span class="hljs-string">'An error has ocurred'</span></span>); } response.end(); }); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { response.write(<span class="hljs-string"><span class="hljs-string">'Hello World'</span></span>); response.end(); } }); server.listen(<span class="hljs-number"><span class="hljs-number">8080</span></span>);</code> </pre> <br><p>  Si l'URL demand√©e est <code>/home</code> , le module natif <code>fs</code> est utilis√© pour lire le fichier <code>home.html</code> . </p><br><p>  Les fonctions qui entrent dans <code>http.createServer</code> et <code>fs.readFile</code> comme arguments sont des <strong>rappels</strong> .  Ces fonctions seront ex√©cut√©es √† un moment donn√© dans le futur (la premi√®re d√®s que le serveur re√ßoit la demande, et la seconde lorsque le fichier est lu sur le disque et plac√© dans le tampon). </p><br><p>  Pendant que le fichier est lu depuis le disque, Node.js peut traiter d'autres requ√™tes et m√™me relire le fichier et tout cela en un seul flux ... mais comment?! </p><br><p>  <strong>Boucle d'√©v√©nement</strong> </p><br><p>  <strong>La boucle d'√©v√©nements</strong> est la magie qui se produit √† l'int√©rieur de Node.js.  C'est litt√©ralement une boucle sans fin et en fait un thread. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/f_/sc/go/f_scgo68j5gpf0xsnzklzdr9cjc.jpeg"></div><br><p>  <strong>Libuv</strong> est une biblioth√®que C qui impl√©mente ce mod√®le et fait partie du noyau Node.js.  Vous pouvez en savoir plus sur libuv <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . </p><br><p>  Un cycle d'√©v√©nements comporte 6 phases, chaque ex√©cution des 6 phases est appel√©e un <strong>tick</strong> . </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/2k/xy/eq/2kxyeqk7srzdocs9egzl5zlpwhm.png"></div><br><ul><li>  <strong>timers</strong> : dans cette phase, les rappels planifi√©s par les m√©thodes <code>setTimeout()</code> et <code>setInterval()</code> sont ex√©cut√©s; </li><li>  <strong>rappels en attente</strong> : presque tous les <strong>rappels</strong> sont ex√©cut√©s, √† l'exception <code>close</code> √©v√©nements de <code>close</code> , des temporisateurs et de <code>setImmediate()</code> ; </li><li>  <strong>inactif, pr√©parer</strong> : utilis√© uniquement √† des fins internes; </li><li>  <strong>sondage</strong> : responsable de la r√©ception de nouveaux √©v√©nements d'E / S.  Node.js peut bloquer √† ce stade; </li><li>  <strong>check</strong> : les rappels provoqu√©s par la m√©thode <code>setImmediate()</code> sont ex√©cut√©s √† ce stade; </li><li>  <strong>fermer les rappels</strong> : par exemple <code>socket.on('close', ...)</code> ; </li></ul><br><p>  Eh bien, il n'y a qu'un seul thread, et ce thread est une boucle d'√©v√©nements, mais alors qui effectue toutes les E / S? </p><br><p>  Faites attention <img width="60" src="https://habrastorage.org/webt/92/8i/lj/928iljyzpqhkbczypvvqgkx0zc0.png">  !!! <br>  Lorsqu'une boucle d'√©v√©nement doit effectuer une op√©ration d'E / S, elle utilise le thread OS du pool de threads et lorsque la t√¢che est termin√©e, le rappel est mis en file d'attente pendant la phase de <em>rappels en attente</em> . </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/lz/z7/uw/lzz7uwcdvm1xd1yr6utj7cae36g.png"></div><br><p>  N'est-ce pas cool? </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/it/yo/bh/ityobhc10qgnkk5m9yk5xp94ble.gif"></div><br><a name="p4"></a><br><h3 id="problema-cpu-yomkih-zadach">  Le probl√®me des t√¢ches gourmandes en CPU </h3><br><p>  Node.js semble parfait!  Vous pouvez cr√©er ce que vous voulez. </p><br><p>  √âcrivons une API pour calculer les nombres premiers. </p><br><p>  Un nombre premier est un nombre entier (naturel) sup√©rieur √† un et divisible par seulement 1 et par lui-m√™me. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/nl/kn/7f/nlkn7fwr_kxhtktm-_gt0ci7ask.jpeg"></div><br><p>  √âtant donn√© un nombre N, l'API doit calculer et renvoyer les premiers N premiers de la liste (ou du tableau). </p><br><p> <code>primes.js</code> </p> <br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isPrime</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">n</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> i = <span class="hljs-number"><span class="hljs-number">2</span></span>, s = <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.sqrt(n); i &lt;= s; i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(n % i === <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> n &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nthPrime</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">n</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> counter = n; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> iterator = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = []; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(counter &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { isPrime(iterator) &amp;&amp; result.push(iterator) &amp;&amp; counter--; iterator++; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { isPrime, nthPrime };</code> </pre> <br><p> <code>index.js</code> </p> <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> http = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'http'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> url = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'url'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> primes = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./primes'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> server = http.createServer(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">request, response</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { pathname, query } = url.parse(request.url, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pathname === <span class="hljs-string"><span class="hljs-string">'/primes'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> result = primes.nthPrime(query.n || <span class="hljs-number"><span class="hljs-number">0</span></span>); response.setHeader(<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>, <span class="hljs-string"><span class="hljs-string">'application/json'</span></span>); response.write(<span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(result)); response.end(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { response.statusCode = <span class="hljs-number"><span class="hljs-number">404</span></span>; response.write(<span class="hljs-string"><span class="hljs-string">'Not Found'</span></span>); response.end(); } }); server.listen(<span class="hljs-number"><span class="hljs-number">8080</span></span>);</code> </pre> <br><p>  <code>prime.js</code> est l'impl√©mentation des calculs n√©cessaires: la fonction <code>isPrime</code> v√©rifie si le nombre est premier, et nthPrime renvoie N de tels nombres. </p><br><p>  Le fichier <code>index.js</code> est responsable de la cr√©ation du serveur et utilise le module <code>prime.js</code> pour traiter chaque demande de <code>/primes</code> .  Le nombre N est jet√© √† travers la cha√Æne de requ√™te dans l'URL. </p><br><p>  Pour obtenir les 20 premiers nombres premiers, nous devons faire une demande √† <code>http://localhost:8080/primes?n=20</code> . </p><br><p>  Supposons que 3 clients nous frappent et tentent d'acc√©der √† notre API d'E / S non bloquante: </p><br><ul><li>  La premi√®re interroge 5 nombres premiers toutes les secondes. </li><li>  Le second demande 1000 nombres premiers chaque seconde </li><li>  Le troisi√®me demande 10 000 000 000 de nombres premiers, mais ... </li></ul><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/pz/rx/bl/pzrxblziplf06w7-kzbyojhafhg.gif"></div><br><p>  Lorsque le troisi√®me client envoie une demande, le thread principal est bloqu√© et c'est le principal sympt√¥me du probl√®me des <strong>t√¢ches gourmandes en CPU</strong> .  Lorsque le thread principal est occup√© √† effectuer une t√¢che ¬´lourde¬ª, il devient inaccessible aux autres t√¢ches. </p><br><p>  Mais qu'en est-il de libuv?  Si vous vous souvenez, cette biblioth√®que aide Node.js √† effectuer des op√©rations d'entr√©e / sortie √† l'aide de threads du syst√®me d'exploitation en √©vitant de bloquer le thread principal et vous avez absolument raison, c'est la solution √† notre probl√®me, mais pour que cela soit possible, notre module doit √™tre √©crit dans la langue C ++ pour que libuv puisse fonctionner avec. </p><br><p>  Heureusement, √† partir de la version 10.5, le module natif <strong>Worker Threads</strong> a √©t√© ajout√© √† Node.js. </p><br><a name="p5"></a><br><h3 id="vorkery-i-ih-potoki">  Les travailleurs et leurs flux </h3><br><p>  Comme nous l'indique la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation</a> : </p><br><blockquote>  Les travailleurs sont utiles pour effectuer des op√©rations JavaScript gourmandes en CPU;  ne les utilisez pas pour les op√©rations d'entr√©e / sortie, les m√©canismes d√©j√† int√©gr√©s dans Node.js g√®rent plus efficacement ces t√¢ches que le thread de travail. </blockquote><p>  <strong>Correction du code</strong> </p><br><p>  Il est temps de r√©√©crire notre code: </p><br><p> <code>primes-workerthreads.js</code> </p> <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { workerData, parentPort } = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'worker_threads'</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isPrime</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">n</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> i = <span class="hljs-number"><span class="hljs-number">2</span></span>, s = <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.sqrt(n); i &lt;= s; i++) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(n % i === <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> n &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nthPrime</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">n</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> counter = n; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> iterator = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = []; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(counter &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { isPrime(iterator) &amp;&amp; result.push(iterator) &amp;&amp; counter--; iterator++; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } parentPort.postMessage(nthPrime(workerData.n));</code> </pre> <br><p> <code>index-workerthreads.js</code> </p> <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> http = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'http'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> url = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'url'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { Worker } = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'worker_threads'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> server = http.createServer(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">request, response</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { pathname, query } = url.parse(request.url, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pathname === <span class="hljs-string"><span class="hljs-string">'/primes'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> worker = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Worker(<span class="hljs-string"><span class="hljs-string">'./primes-workerthreads.js'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">workerData</span></span>: { <span class="hljs-attr"><span class="hljs-attr">n</span></span>: query.n || <span class="hljs-number"><span class="hljs-number">0</span></span> } }); worker.on(<span class="hljs-string"><span class="hljs-string">'error'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ response.statusCode = <span class="hljs-number"><span class="hljs-number">500</span></span>; response.write(<span class="hljs-string"><span class="hljs-string">'Oops there was an error...'</span></span>); response.end(); }); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result; worker.on(<span class="hljs-string"><span class="hljs-string">'message'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">message</span></span></span><span class="hljs-function">) </span></span>{ result = message; }); worker.on(<span class="hljs-string"><span class="hljs-string">'exit'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ response.setHeader(<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>, <span class="hljs-string"><span class="hljs-string">'application/json'</span></span>); response.write(<span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(result)); response.end(); }); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { response.statusCode = <span class="hljs-number"><span class="hljs-number">404</span></span>; response.write(<span class="hljs-string"><span class="hljs-string">'Not Found'</span></span>); response.end(); } }); server.listen(<span class="hljs-number"><span class="hljs-number">8080</span></span>);</code> </pre> <br><p>  Dans le <code>index-workerthreads.js</code> , chaque demande √† <code>/primes</code> cr√©e une instance de la classe <code>Worker</code> (√† partir du module natif <code>worker_threads</code> ) pour t√©l√©charger et ex√©cuter le <code>primes-workerthreads.js</code> dans le thread de travail.  Lorsque la liste des nombres premiers est calcul√©e et pr√™te, l'√©v√©nement de <code>message</code> est d√©clench√© - le r√©sultat tombe dans le flux principal car le travailleur n'a plus de travail, il d√©clenche √©galement l'√©v√©nement de <code>exit</code> , permettant au flux principal d'envoyer des donn√©es au client. </p><br><p>  <code>primes-workerthreads.js</code> a un peu chang√©.  Il importe <code>workerData</code> (il s'agit d'une copie des param√®tres transmis depuis le thread principal) et <code>parentPort</code> via lequel le r√©sultat du travail du travailleur est renvoy√© au thread principal. </p><br><p>  Essayons maintenant √† nouveau notre exemple et voyons ce qui se passe: </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/zu/vk/gh/zuvkghy8dnhjryfdf5b62ped8dw.gif"></div><br><p>  Le thread principal n'est plus bloqu√© <img width="115" src="https://habrastorage.org/webt/nn/hs/r3/nnhsr3jiw_4aed53jye8gokutpy.png">  !!!!! </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/tt/ij/el/ttijelgt36k_vbengx3qjaaajlc.gif"></div><br><p>  Maintenant, tout fonctionne comme il se doit, mais produire des travailleurs sans raison n'est toujours pas une bonne pratique; cr√©er des fils n'est pas un plaisir bon march√©.  Assurez-vous de cr√©er un pool de threads avant cela. </p><br><h4 id="zaklyuchenie">  Conclusion </h4><br><p>  Node.js est une technologie puissante qui doit √™tre explor√©e autant que possible. <br>  Ma recommandation personnelle - soyez toujours curieux!  Si vous savez comment quelque chose fonctionne de l'int√©rieur, vous pouvez travailler plus efficacement avec. </p><br><p>  C'est tout pour les gars d'aujourd'hui.  J'esp√®re que ce message vous a √©t√© utile et que vous avez appris quelque chose de nouveau sur Node.js. </p><br><p>  Merci d'avoir lu et √† bient√¥t dans les prochains articles. <img width="20" src="https://habrastorage.org/webt/bd/lk/kd/bdlkkdf7adtljydvhxyw22y3cfi.png">  . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr460661/">https://habr.com/ru/post/fr460661/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr460645/index.html">Faire le bien faire le mal: √©crire du code diabolique avec Go, partie 1</a></li>
<li><a href="../fr460647/index.html">R√©soudre un travail avec pwnable.kr 05 - mot de passe. R√©√©crire la table des liens de proc√©dure via la vuln√©rabilit√© de cha√Æne de format</a></li>
<li><a href="../fr460651/index.html">R√©union de la Society of Anonymous Testers: TMS, monitoring monitoring, search quality evaluation and native iOS tests</a></li>
<li><a href="../fr460655/index.html">Comment j'ai bris√© Telegram</a></li>
<li><a href="../fr460659/index.html">Utilisation de tuyaux pour pivoter</a></li>
<li><a href="../fr460665/index.html">Projet de FAQ: Pourquoi les normes C ++ sont-elles publi√©es tous les trois ans?</a></li>
<li><a href="../fr460667/index.html">Automatisation des tests de services payants sur iOS</a></li>
<li><a href="../fr460669/index.html">Comment assurer la s√©curit√© du d√©veloppement, gagner du temps et des nerfs</a></li>
<li><a href="../fr460671/index.html">Propri√©t√© et emprunt en D</a></li>
<li><a href="../fr460673/index.html">Exposez la magie de DiffUtil</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>