<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>♾ 🙃 🔄 Wie ich Docker in Docker gestartet habe und was dabei herausgekommen ist 🔌 👨🏾‍⚕️ 👨🏻‍🎤</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo allerseits! In meinem vorherigen Artikel habe ich versprochen, über den Start von Docker in Docker und die praktischen Aspekte der Anwendung die...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Wie ich Docker in Docker gestartet habe und was dabei herausgekommen ist</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/477464/"><p>  Hallo allerseits!  In meinem <a href="https://habr.com/ru/post/458606/">vorherigen Artikel habe</a> ich versprochen, über den Start von Docker in Docker und die praktischen Aspekte der Anwendung dieser Lektion zu sprechen.  Es ist Zeit, unser Versprechen zu halten.  Ein erfahrener Devo würde vielleicht argumentieren, dass diejenigen, die Docker in Docker benötigen, einfach den Docker-Dämonen-Sockel vom Host in den Container werfen und dies ist in 99% der Fälle ausreichend.  Aber beeilen Sie sich nicht, mir Kekse zuzuwerfen, denn wir werden über den tatsächlichen Start von Docker in Docker sprechen.  Diese Lösung hat viele mögliche Anwendungsbereiche. In diesem Artikel geht es um eines davon. Lehnen Sie sich zurück und strecken Sie die Arme vor sich. </p><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/5-/ym/00/5-ym00wdppyt-ylvtsiazzzusle.jpeg" alt="Bild"></div><a name="habracut"></a><br><h2 id="nachalo">  Starten Sie </h2><br><p>  Alles begann an einem verregneten Septemberabend, als ich einen Mietwagen von Digital Ocean für 5 US-Dollar aufräumte. Dieser hing eng zusammen, weil Docker alle 24 Gigabyte des verfügbaren Speicherplatzes mit seinen Bildern und Containern füllte.  Die Ironie bestand darin, dass all diese Bilder und Container vorübergehend waren und nur zum Testen der Leistung meiner Anwendung bei jedem Erscheinen einer neuen Version einer Bibliothek oder eines Frameworks benötigt wurden.  Ich habe versucht, Shell-Skripte zu schreiben und den Zeitplan für die Müllbereinigung zu konfigurieren, aber das hat nicht gespart: Jedes Mal, wenn sich herausstellte, dass der Festplattenspeicher meines Servers aufgebraucht war, hing der Server (bestenfalls).  Irgendwann stieß ich auf einen Artikel über das Ausführen von Jenkins in einem Container und das Erstellen und Löschen von Assembly-Pipelines über den Docker-Daemon-Socket.  Die Idee hat mir gefallen, aber ich habe mich entschlossen, mit dem direkten Start von Docker in Docker zu experimentieren.  Es schien mir damals eine völlig logische Entscheidung zu sein, Docker-Images auszupumpen und Container mit allen Anwendungen zu erstellen, die ich zum Testen in einem anderen Container benötige (nennen wir es einen Staging-Container).  Die Idee war, einen Staging-Container mit dem Flag -rm auszuführen, der beim Anhalten automatisch den gesamten Container mit seinem gesamten Inhalt löscht.  Ich habe mit dem Docker-Image vom Docker selbst gestöbert ( <a href="https://hub.docker.com/_/docker">https://hub.docker.com/_/docker</a> ), aber es stellte sich als zu umfangreich heraus und ich konnte es nicht zum gewünschten Zweck zum Laufen bringen. </p><br><h2 id="praktika-shishki">  Übe.  Beulen </h2><br><p>  Ich machte mich daran, den Container nach Bedarf zum Laufen zu bringen, und setzte meine Experimente fort, die zu einer Vielzahl von Zapfen führten.  Das Ergebnis meiner Selbstquälerei war der folgende Algorithmus: </p><br><ol><li><p>  Wir starten den Docker-Container in einem interaktiven Modus. </p><br><pre><code class="bash hljs">docker run --privileged -it docker:18.09.6</code> </pre> <br><p>  Achten Sie auf die Version des Behälters, einen Schritt nach rechts oder links und Ihr DinD verwandelt sich in einen Kürbis.  Tatsächlich bricht mit der Veröffentlichung einer neuen Version ziemlich oft alles zusammen. <br>  Wir müssen sofort in die Schale kommen. </p><br></li><li><p>  Versuchen Sie herauszufinden, welche Container ausgeführt werden (Antwort: keine), aber führen Sie den Befehl trotzdem aus: </p><br><pre> <code class="bash hljs">docker ps</code> </pre> <br><p>  Sie werden ein wenig überrascht sein, aber es stellt sich heraus, dass der Docker-Dämon nicht einmal ausgeführt wird: </p><br><pre> <code class="bash hljs">error during connect: Get http://docker:2375/v1.40/containers/json: dial tcp: lookup docker on 192.168.65.1:53: no such host</code> </pre> <br></li><li><p>  Lass es uns selbst machen: </p><br><pre> <code class="bash hljs">dockerd &amp;</code> </pre> <br><p>  Eine weitere unangenehme Überraschung: </p><br><pre> <code class="bash hljs">failed to start daemon: Error initializing network controller: error obtaining controller instance: failed to create NAT chain DOCKER: Iptables not found</code> </pre> <br></li><li><p>  Installieren Sie die Pakete iptables und bash (die Arbeit mit bash ist angenehmer als mit sh): </p><br><pre> <code class="bash hljs">apk add --no-cache iptables bash</code> </pre> <br></li><li><p>  Wir fangen an zu prügeln.  Endlich sind wir wieder in der gewohnten Schale </p><br></li><li><p>  versuchen Sie Docker erneut zu starten: </p><br><pre> <code class="bash hljs">dockerd &amp;</code> </pre> <br><p>  Wir sollten ein langes Protokoll sehen, das endet: </p><br><pre> <code class="bash hljs">INFO[2019-11-25T19:51:19.448080400Z] Daemon has completed initialization INFO[2019-11-25T19:51:19.474439300Z] API listen on /var/run/docker.sock</code> </pre> <br></li><li><p>  Drücken Sie die Eingabetaste.  Wir sind zurück in der Bash. </p><br></li></ol><br><p>  Von nun an können wir versuchen, andere Container in unserem Docker-Container zu starten, aber was ist, wenn wir einen anderen Docker-Container in unserem Docker-Container anheben möchten oder etwas schief geht und der Container "herausfliegt"?  Fangen Sie noch einmal von vorne an. </p><br><h2 id="sobstvennyy-dind-konteyner-i-novye-eksperimenty">  Eigener DinD-Container und neue Experimente </h2><br><p></p><div style="text-align:center;"> <a href="https://github.com/alekslitvinenk/dind"><img src="https://habrastorage.org/getpro/habr/post_images/8c7/43e/3fa/8c743e3fa9173abdf6916f4e02b349ac.png"></a> </div><br>  Um die obigen Schritte nicht immer wieder zu wiederholen, habe ich einen eigenen DinD-Container angelegt: <p></p><br><p>  <a href="https://github.com/alekslitvinenk/dind">https://github.com/alekslitvinenk/dind</a> </p><br><p>  Die funktionierende DinD-Lösung gab mir die Möglichkeit, Docker rekursiv in Docker auszuführen und mutigere Experimente durchzuführen. <br>  Ein solches (erfolgreiches) Experiment mit MySQL und Nodejs werde ich jetzt beschreiben. <br>  Die ungeduldigsten können sehen, wie es hier war <br></p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/Fn7Fb8bCHSc" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  Also fangen wir an: </p><br><ol><li><p>  Starten Sie DinD interaktiv.  In dieser DinD-Version müssen wir alle Ports, die unsere untergeordneten Container verwenden können, manuell zuordnen (daran arbeite ich bereits). </p><br><pre> <code class="bash hljs">docker run --privileged -it \ -p 80:8080 \ -p 3306:3306 \ alekslitvinenk/dind</code> </pre> <br><p>  Wir befinden uns in einer Bash, von wo aus wir sofort anfangen können, Hilfscontainer auf den Markt zu bringen. </p><br></li><li><p>  Wir starten MySQL: </p><br><pre> <code class="bash hljs">docker run --name mysql -e MYSQL_ROOT_PASSWORD=strongpassword -d -p 3306:3306 mysql</code> </pre> <br></li><li><p>  Wir stellen die Verbindung zur Datenbank auf dieselbe Weise her, wie wir sie lokal herstellen würden.  Stellen Sie sicher, dass alles funktioniert. </p><br></li><li><p>  Wir starten den zweiten Container: </p><br><pre> <code class="bash hljs">docker run -d --rm -p 8080:8080 alekslitvinenk/hello-world-nodejs-server</code> </pre> <br><p>  Beachten Sie, dass die Portzuordnung hier genau <strong>8080: 8080 lautet</strong> , da wir bereits Port 80 vom Host auf den übergeordneten Container auf Port 8080 abgebildet haben. </p><br></li><li><p>  Wir gehen im Browser zu localhost und sind überzeugt, dass der Server "Hello World!" Antwortet. </p><br></li></ol><br><p>  In meinem Fall war das Experiment mit den beigefügten Docker-Containern recht positiv, und ich werde das Projekt weiterentwickeln und für die Inszenierung verwenden.  Es scheint mir, dass dies eine viel leichtere Lösung ist als die gleichen Kubernetes und Jenkins X. Aber das ist meine subjektive Meinung. </p><br><p>  Ich denke, das ist alles für den heutigen Artikel.  Im nächsten Artikel werde ich detailliertere Experimente mit dem rekursiven Start von Docker in Docker und dem Mounten von Verzeichnissen in verschachtelten Containern beschreiben. </p><br><p>  <strong>PS</strong> Wenn Sie dieses Projekt nützlich finden, geben Sie es bitte auf dem GitHub mit einem Sternchen an, geben Sie es heraus und teilen Sie es Ihren Freunden mit. </p><br><p>  <strong>Edit1 Behobene</strong> Fehler, die sich auf 2 Videos konzentrierten </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de477464/">https://habr.com/ru/post/de477464/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de477450/index.html">9 Ansätze zur Erkennung von Anomalien</a></li>
<li><a href="../de477452/index.html">Die zweite Programmiermeisterschaft: Wir analysieren die Aufgaben der ML-Strecke</a></li>
<li><a href="../de477454/index.html">Konfigurationsdateien. Libconfig-Bibliothek und Definition nicht verwendeter Einstellungen</a></li>
<li><a href="../de477458/index.html">Vor- und Nachteile des IT-Lebens in Schottland</a></li>
<li><a href="../de477460/index.html">Ausgabe Nr. 26: IT-Schulungen - Aktuelle Fragen und Herausforderungen führender Unternehmen</a></li>
<li><a href="../de477468/index.html">Ein großartiger Überblick über die Wärmebildkamera Seek Thermal SHOT: Wärmekontrolle von Wohngebäuden</a></li>
<li><a href="../de477470/index.html">Über die Rolle von Testaufgaben im Leben des Entwicklers</a></li>
<li><a href="../de477474/index.html">Leben und Sitten der Träumer</a></li>
<li><a href="../de477476/index.html">Heterogene Programmierung und OneAPI Toolkit. Stellen Sie einem Intel-Experten eine Frage</a></li>
<li><a href="../de477478/index.html">Heimautomatisierung mit Unterstützung für industrielle Programmiersprachen oder BluePill x405</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>