<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🙇🏻 🔚 🔪 Versuchen Sie Micronaut oder Darling, ich habe das Framework reduziert 👨‍👨‍👦 ☣️ 🏓</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Versuchen Sie Micronaut oder Darling, ich habe das Framework reduziert 


 Über das Mikronaut-Framework erhaschte ich einen Blick auf die Newsletter-Ü...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Versuchen Sie Micronaut oder Darling, ich habe das Framework reduziert</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/427595/"><h2 id="probuem-micronaut-ili-dorogaya-ya-umenshil-freymvork">  Versuchen Sie Micronaut oder Darling, ich habe das Framework reduziert </h2><br><p>  Über das Mikronaut-Framework erhaschte ich einen Blick auf die Newsletter-Übersicht.  Er fragte sich, was für ein Tier er war.  Der Rahmen steht im Gegensatz zur Feder, die mit allen notwendigen Werkzeugen gefüllt ist. </p><br><p><img src="https://habrastorage.org/webt/eu/iq/eq/euiqeqqehjcvuto1psel_ajypw4.jpeg" alt="Micronaut"></p><br><p> Im Vorgriff auf die bevorstehende Konferenz für Entwickler, auf der sie nur darüber sprechen und zeigen, wie Mikronaut in Ihren Mikrodiensten verwendet wird, habe ich mich entschlossen, mich mindestens einmal fertig zu machen und zumindest einen gewissen Kontext mit einigen Problemen und Fragen im Kopf zu haben.  Machen Sie sozusagen Hausaufgaben.  Ich beschloss, ein paar Abende lang ein kleines Haustierprojekt zu machen (wie es geht).  Am Ende des Artikels befindet sich ein Link zum Repository aller Projektquellen. </p><a name="habracut"></a><br><blockquote>  Micronaut ist ein JVM-Framework, das drei Entwicklungssprachen unterstützt: Java, Kotlin, Groovy.  Es wurde von OCI entwickelt, der gleichen Firma, die Grails uns gegeben hat.  Es verfügt über eine Optimierung in Form einer CLI-Anwendung und einer Reihe empfohlener Bibliotheken (verschiedene Reactive-http- und Datenbank-Clients). <br><br>  Es gibt einen DI, der die Ideen von Spring implementiert und wiederholt und eine Reihe seiner Chips hinzufügt - Asynchronität, Unterstützung für AWS Lambda, Client Side Load Balancing. </blockquote><p>  <em>Die Idee des Dienstes:</em> Einer meiner Freunde kaufte einmal mit einem Narren ein halbes Dutzend verschiedenster Kryptowährungen und investierte in sie einen imprägnierten Urlaub und einen Vorrat aus einer Winterjacke.  Wir alle wissen, dass die Volatilität all dieser Kryptowährungssubstanzen wild ist und das Thema selbst im Allgemeinen unvorhersehbar ist. Ein Freund entschied sich schließlich, sich um seine Nerven zu kümmern und einfach einzutauchen, was mit seinem „Vermögen“ passiert.  Aber manchmal willst du immer noch schauen, aber was ist da mit all dem, plötzlich ist es schon reich.  So entstand die Idee eines einfachen Panels (eines Dashboards wie Grafana oder etwas Einfacheres), einer bestimmten Webseite mit trockenen Informationen, wie viel das alles in einer Fiat-Währung (USD, RUR) kostet. </p><br><h3 id="disclaimers">  Haftungsausschluss </h3><br><ol><li>  Wir werden die Zweckmäßigkeit, unsere eigene Lösung zu schreiben, über Bord lassen. Wir müssen nur das neue Framework auf etwas schlauerem als HelloWorld ausprobieren. </li><li>  Berechnungsalgorithmus, erwartete Fehler, Fehler usw.  (zumindest für die erste Phase des Produkts), die Gültigkeit der Wahl des Krypto-Austauschs zum Abrufen von Informationen, das "Investment" -Krypto-Portfolio eines Freundes, kommt ebenfalls nicht in Frage und wird weder diskutiert noch eingehend analysiert. </li></ol><br><p>  Also eine kleine Reihe von Anforderungen: </p><br><ol><li>  Webdienst (Zugriff von außen über http) </li><li>  Anzeigen einer Seite in einem Browser mit einer Zusammenfassung des Gesamtwerts des Kryptowährungsportfolios </li><li>  Möglichkeit zum Konfigurieren des Portfolios (wählen Sie das JSON-Format zum Laden und Entladen der Portfoliostruktur).  Eine bestimmte REST-API zum Aktualisieren und Laden eines Portfolios, d.h.  2 API: zum Speichern / Aktualisieren - POST, zum Entladen - GET.  Die Portfoliostruktur ist im Wesentlichen ein einfaches Typenschild <br><pre><code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">BTC</span></span> –  0<span class="hljs-selector-class"><span class="hljs-selector-class">.00005</span></span> . <span class="hljs-selector-tag"><span class="hljs-selector-tag">XEM</span></span> –  4<span class="hljs-selector-class"><span class="hljs-selector-class">.5</span></span> . ...</code> </pre> </li><li>  Wir beziehen Daten aus Krypto-Börsen und Geldwechselquellen (für Fiat-Währungen). </li><li>  Regeln zur Berechnung des Gesamtwerts des Portfolios: <br><img src="https://habrastorage.org/webt/95/ai/fn/95aifnv4r6bngnaeqrb9tlu2hfy.png" alt="Formeln zur Berechnung des Gesamtwerts der Portfolios"><br></li></ol><br><br><p>  Natürlich ist alles, was in Absatz 5 geschrieben steht, Gegenstand gesonderter Streitigkeiten und Zweifel, aber es sollte sein, dass das Unternehmen es so wollte. </p><br><h2 id="start-proekta">  Projektstart </h2><br><p>  Also gehen wir auf die offizielle Website des Frameworks und sehen, wie wir beginnen können, uns zu entwickeln.  Die offizielle Seite bietet an, das sdkman-Tool zu installieren.  Ein Stück, das die Entwicklung und Verwaltung von Projekten auf dem Mikronaut-Framework (und anderen anderen, einschließlich zum Beispiel Grails) erleichtert. <br></p><br><img src="https://habrastorage.org/webt/af/rd/3z/afrd3zhw_oodv3s1kroj5vx6bgu.png" alt="Der gleiche Manager gehört SDKs"><br><br>  Eine kleine Bemerkung: Wenn Sie die Projektinitialisierung nur ohne Schlüssel starten, ist standardmäßig der Gradle-Kollektor ausgewählt.  Löschen Sie den Ordner, versuchen Sie es erneut, diesmal mit dem Schlüssel: <br><pre> <code class="hljs powershell">mn create<span class="hljs-literal"><span class="hljs-literal">-app</span></span> com.room606.cryptonaut <span class="hljs-literal"><span class="hljs-literal">-b</span></span>=maven</code> </pre> <br><p>  Ein interessanter Punkt ist, dass sdkman Ihnen wie die Spring Tool Suite bereits in der Phase der Erstellung eines Projekts die Möglichkeit bietet, festzulegen, welche „Cubes“ Sie zu Beginn verwenden möchten.  Ich habe nicht viel damit experimentiert, ich habe es auch mit einer Standardvoreinstellung erstellt. </p><br><p>  Schließlich öffnen wir das Projekt in Intellij Idea und bewundern die Quellen, Ressourcen und Datenträger, die uns mit dem Assistenten zum Erstellen des Mikronaut-Projekts zur Verfügung gestellt wurden. <br></p><br><img src="https://habrastorage.org/webt/8n/oh/ko/8nohkocdymxsv2ctnkqlvnvr1x4.png" alt="Die Struktur des nackten Projekts"><br><br>  Auge klammert sich an Dockerfile <br><pre> <code class="hljs powershell">FROM openjdk:<span class="hljs-number"><span class="hljs-number">8</span></span>u171<span class="hljs-literal"><span class="hljs-literal">-alpine3</span></span>.<span class="hljs-number"><span class="hljs-number">7</span></span> RUN apk -<span class="hljs-literal"><span class="hljs-literal">-no</span></span><span class="hljs-literal"><span class="hljs-literal">-cache</span></span> add curl COPY target/cryptonaut*.jar cryptonaut.jar CMD java <span class="hljs-variable"><span class="hljs-variable">$</span></span>{JAVA_OPTS} <span class="hljs-literal"><span class="hljs-literal">-jar</span></span> cryptonaut.jar</code> </pre> <br><p>  Nun, es macht Spaß und ist lobenswert.  Wir erhielten sofort ein Tool zur schnellen Ausgabe der Anwendung an die Prod / INT / QA / egal-Umgebung.  Dafür ein mentales Pluszeichen für das Projekt. </p><br><p>  Es reicht aus, das Projekt von Maven zu sammeln, dann das Docker-Image zu sammeln und es in Ihrer Docker-Registrierung zu veröffentlichen oder einfach die Image-Binärdatei als Option in Ihr CI-System zu exportieren. </p><br><p>  Im Ressourcenordner haben wir außerdem ein Leerzeichen mit Anwendungskonfigurationsparametern (analog zu application.properties in Spring) sowie eine Konfigurationsdatei für die Logback-Bibliothek vorbereitet.  Cool! </p><br><p>  Wir gehen zum Einstiegspunkt der Bewerbung und studieren die Klasse.  Wir sehen ein Bild, das uns von Spring Boot schmerzlich vertraut ist.  Auch hier haben die Entwickler des Frameworks nichts erfunden und erfunden. </p><br><pre> <code class="hljs java"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ Micronaut.run(Application.class); }</code> </pre> <br><p>  Vergleichen Sie mit dem bekannten Spring-Code. </p><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">String[] args</span></span></span><span class="hljs-function">)</span></span> { SpringApplication.run(Application.class, args); }</code> </pre> <br><p>  Das heißt,  Wir erhöhen auch den IoC-Container mit allen Bohnen, die in der Arbeit enthalten sind, wenn sie benötigt werden.  Nachdem wir gemäß der offiziellen Dokumentation ein wenig gelaufen sind, beginnen wir langsam mit der Entwicklung. </p><br><p>  <em>Wir werden brauchen:</em> </p><br><ol><li>  Domänenmodelle </li><li>  Controller zur Implementierung der REST-API. </li><li>  Datenspeicherschicht (Datenbankclient oder ORM oder etwas anderes) </li><li>  Ein Code für Verbraucher von Daten aus dem Austausch von Kryptowährungen sowie von Daten aus dem Austausch von Fiat-Währungen.  Das heißt,  Wir müssen die einfachsten Clients für Dienste von Drittanbietern schreiben.  Im Frühjahr passte das bekannte RestTemplate gut zu dieser Rolle. </li><li>  Minimale Konfiguration für flexibles Management und Anwendungsstart (überlegen wir, was und wie wir die Konfiguration vornehmen) </li><li>  Tests!  Ja, um Code sicher neu zu refachen und neue Funktionen zu implementieren, müssen wir uns der Stabilität der alten sicher sein </li><li>  Caching.  Dies ist keine Grundvoraussetzung, aber etwas, das für eine gute Leistung gut wäre, und in unserem Szenario gibt es Orte, an denen das Caching definitiv ein gutes Werkzeug ist. <br>  Spoiler: Hier wird alles sehr schlecht. </li></ol><br><h3 id="modeli-predmetnoy-oblasti">  Domänenmodelle </h3><br><p>  Für unsere Zwecke reichen die folgenden Modelle aus: Modelle eines Kryptowährungsportfolios, der Wechselkurs eines Paares von Fiat-Währungen, Kryptowährungspreise in Fiat-Währung und der Gesamtwert des Portfolios. </p><br><p>  Unten ist der Code nur einiger Modelle aufgeführt, der Rest kann <a href="">im Repository</a> angezeigt werden.  Und ja, ich war zu faul, um <code>Lombok</code> in diesem Projekt zu verarschen. </p><br><pre> <code class="hljs java">Portfolio.java <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.room606.cryptonaut.domain; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.math.BigDecimal; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Collections; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Map; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.TreeMap; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Portfolio</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, BigDecimal&gt; coins = Collections.emptyMap(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Map&lt;String, BigDecimal&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCoins</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TreeMap&lt;&gt;(coins); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setCoins</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Map&lt;String, BigDecimal&gt; coins)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.coins = coins; }</code> </pre> <br><pre> <code class="hljs cs">FiatRate.java package com.room606.cryptonaut.domain; import java.math.BigDecimal; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">FiatRate</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String counter; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> BigDecimal <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FiatRate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">String </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">base</span></span></span></span><span class="hljs-function"><span class="hljs-params">, String counter, BigDecimal </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">base</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.counter = counter; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getBase</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setBase</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">String </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">base</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">base</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCounter</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> counter; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setCounter</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">String counter</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.counter = counter; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BigDecimal </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getValue</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setValue</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">BigDecimal </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } }</code> </pre> <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">Price</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.java</span></span> ... <span class="hljs-selector-tag"><span class="hljs-selector-tag">Prices</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.java</span></span> () ... <span class="hljs-selector-tag"><span class="hljs-selector-tag">Total</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.java</span></span> ...</code> </pre> <br><h3 id="kontrollery">  Controller </h3><br><p>  Wir versuchen, einen Controller zu schreiben, der die einfachste API implementiert und den Wert von Kryptowährungen gemäß den angegebenen Buchstabencodes von Münzen ausgibt. <br>  Das heißt, </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">GET</span></span> /cryptonaut/restapi/prices.json?coins=BTC&amp;coins=ETH&amp;fiatCurrency=RUR</code> </pre> <br><p>  Sollte etwas produzieren wie: </p><br><pre> <code class="hljs json">{<span class="hljs-attr"><span class="hljs-attr">"prices"</span></span>:[{<span class="hljs-attr"><span class="hljs-attr">"coin"</span></span>:<span class="hljs-string"><span class="hljs-string">"BTC"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"value"</span></span>:<span class="hljs-number"><span class="hljs-number">407924.043300000000</span></span>},{<span class="hljs-attr"><span class="hljs-attr">"coin"</span></span>:<span class="hljs-string"><span class="hljs-string">"ETH"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"value"</span></span>:<span class="hljs-number"><span class="hljs-number">13040.638266000000</span></span>}],<span class="hljs-attr"><span class="hljs-attr">"fiatCurrency"</span></span>:<span class="hljs-string"><span class="hljs-string">"RUR"</span></span>}</code> </pre> <br><p>  Laut <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Dokumentation</a> ist nichts kompliziert und erinnert an die gleichen <code>Spring</code> Ansätze und Konventionen: </p><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.room606.cryptonaut.rest; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.room606.cryptonaut.domain.Price; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.room606.cryptonaut.domain.Prices; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.room606.cryptonaut.markets.FiatExchangeRatesService; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.room606.cryptonaut.markets.CryptoMarketDataService; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.micronaut.http.MediaType; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.micronaut.http.<span class="hljs-keyword"><span class="hljs-keyword">annotation</span></span>.*; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.List; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.stream.Collectors; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.stream.Stream; <span class="hljs-meta"><span class="hljs-meta">@Controller(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/cryptonaut/restapi/"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MarketDataController</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> CryptoMarketDataService cryptoMarketDataService; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> FiatExchangeRatesService fiatExchangeRatesService; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MarketDataController(CryptoMarketDataService cryptoMarketDataService, FiatExchangeRatesService fiatExchangeRatesService) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.cryptoMarketDataService = cryptoMarketDataService; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fiatExchangeRatesService = fiatExchangeRatesService; } <span class="hljs-meta"><span class="hljs-meta">@Get(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/prices.json"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-meta"><span class="hljs-meta">@Produces(MediaType.APPLICATION_JSON)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Prices pricesAsJson(<span class="hljs-meta"><span class="hljs-meta">@QueryValue(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"coins"</span></span></span><span class="hljs-meta">)</span></span> String[] coins, <span class="hljs-meta"><span class="hljs-meta">@QueryValue(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"fiatCurrency"</span></span></span><span class="hljs-meta">)</span></span> String fiatCurrency) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> getPrices(coins, fiatCurrency); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Prices getPrices(String[] coins, String fiatCurrency) { List&lt;Price&gt; prices = Stream.of(coins) .map(coin -&gt; new Price(coin, cryptoMarketDataService.getPrice(coin, fiatCurrency))) .collect(Collectors.toList()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new Prices(prices, fiatCurrency); } }</code> </pre> <br><p>  Das heißt,  Wir geben unser <code>POJO</code> ruhig als zurückgegebenen Typ an und ohne Serializer / Deserializer zu konfigurieren, auch ohne zusätzliche Anmerkungen aufzuhängen. Micronaut erstellt den richtigen http-Body mit den Daten aus der Box.  Vergleichen wir mit <code>Spring</code> Way: </p><br><pre> <code class="hljs kotlin"><span class="hljs-meta"><span class="hljs-meta">@RequestMapping(value = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/prices.json"</span></span></span><span class="hljs-meta">, method = RequestMethod.GET, produces = MediaType.APPLICATION_JSON_UTF8_VALUE)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ResponseEntity&lt;Prices&gt; pricesAsJson(<span class="hljs-meta"><span class="hljs-meta">@RequestParam(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"userId"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String[] coins, <span class="hljs-meta"><span class="hljs-meta">@RequestParam(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"fiatCurrency"</span></span></span><span class="hljs-meta">)</span></span> String fiatCurrency) {</code> </pre> <br><p>  Im Allgemeinen hatte ich keine Probleme mit den Controllern, sie funktionierten laut Dokumentation nur wie erwartet.  Ihre Schreibweise war intuitiv und einfach.  Wir gehen weiter. </p><br><h3 id="sloy-hraneniya-dannyh">  Datenspeicherschicht </h3><br><p>  Für die erste Version der Anwendung speichern wir nur das Portfolio des Benutzers.  Im Allgemeinen behalten wir nur ein Portfolio eines Benutzers.  Einfach ausgedrückt, wir werden noch nicht die Unterstützung vieler Benutzer haben, nur eines Hauptbenutzers mit seinem Portfolio an Kryptowährungen.  Das ist großartig! </p><br><p>  Um die Datenpersistenz zu implementieren, bietet die Dokumentation Optionen mit JPA-Verbindung sowie fragmentarische Beispiele für die Verwendung verschiedener Clients zum Lesen aus der Datenbank (Abschnitt „12.1.5 Konfigurieren von Postgres“).  <code>JPA</code> entschieden verworfen, und es wurde bevorzugt, Abfragen selbst zu schreiben und zu bearbeiten.  Die Datenbankkonfiguration wurde zu application.yml hinzugefügt ( <code>Postgres</code> wurde als RDBMS ausgewählt), gemäß der Dokumentation: </p><br><pre> <code class="hljs pgsql">postgres: reactive: client: port: <span class="hljs-number"><span class="hljs-number">5432</span></span> host: localhost <span class="hljs-keyword"><span class="hljs-keyword">database</span></span>: cryptonaut <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: crypto <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>: r1ch13r1ch maxSize: <span class="hljs-number"><span class="hljs-number">5</span></span></code> </pre> <br><p>  Abhängig von der <code>postgres-reactive</code> Bibliothek wurde hinzugefügt.  Dies ist ein Client für die asynchrone und synchrone Arbeit mit der Datenbank. </p><br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>io.micronaut.configuration<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>postgres-reactive<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>1.0.0.M4<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">scope</span></span></span><span class="hljs-tag">&gt;</span></span>compile<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">scope</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Schließlich wurde die Datei <code>docker-compose.yml</code> zum <code>docker-compose.yml</code> / <code>docker-compose.yml</code> hinzugefügt, um die zukünftige Umgebung unserer Anwendung <code>docker-compose.yml</code> , in der die Datenbankkomponente hinzugefügt wurde: </p><br><pre> <code class="hljs pgsql">db: image: postgres:<span class="hljs-number"><span class="hljs-number">9.6</span></span> <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">always</span></span> environment: POSTGRES_USER: crypto POSTGRES_PASSWORD: r1ch13r1ch POSTGRES_DB: cryptonaut ports: - <span class="hljs-number"><span class="hljs-number">5432</span></span>:<span class="hljs-number"><span class="hljs-number">5432</span></span> volumes: - ${PWD}/../db/init_tables.<span class="hljs-keyword"><span class="hljs-keyword">sql</span></span>:/docker-entrypoint-initdb.d/<span class="hljs-number"><span class="hljs-number">1.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>_init_tables.<span class="hljs-keyword"><span class="hljs-keyword">sql</span></span></code> </pre> <br><p>  Unten finden Sie das Initialisierungsskript für die Datenbank mit einer sehr einfachen Tabellenstruktur: </p><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> portfolio ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">serial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> coin_amt_primary_key PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span>, coin <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">16</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span>, amount <span class="hljs-built_in"><span class="hljs-built_in">NUMERIC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> );</code> </pre> <br><p>  Versuchen wir nun, einen Code zu werfen, der das Portfolio des Benutzers aktualisiert.  Unsere Portfoliokomponente sieht folgendermaßen aus: </p><br><pre> <code class="hljs java"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.room606.cryptonaut; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.room606.cryptonaut.domain.Portfolio; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.math.BigDecimal; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Optional; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PortfolioService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">Portfolio </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">savePortfolio</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Portfolio portfolio)</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">Portfolio </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loadPortfolio</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">Optional&lt;BigDecimal&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">calculateTotalValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Portfolio portfolio, String fiatCurrency)</span></span></span></span>; }</code> </pre> <br><p>  Mit Blick auf die <code>Postgres reactive client</code> Methoden von <code>Postgres reactive client</code> werfen wir diese Klasse: </p><br><pre> <code class="hljs java"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.room606.cryptonaut; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.room606.cryptonaut.domain.Portfolio; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.room606.cryptonaut.markets.CryptoMarketDataService; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.micronaut.context.annotation.Requires; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.reactiverse.pgclient.Numeric; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.reactiverse.reactivex.pgclient.*; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.inject.Inject; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.math.BigDecimal; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.HashMap; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.List; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Map; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Optional; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.stream.Collectors; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PortfolioServiceImpl</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PortfolioService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> PgPool pgPool; ... <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String UPDATE_COIN_AMT = <span class="hljs-string"><span class="hljs-string">"INSERT INTO portfolio (coin, amount) VALUES (?, ?) ON CONFLICT (coin) "</span></span> + <span class="hljs-string"><span class="hljs-string">"DO UPDATE SET amount = ?"</span></span>; ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Portfolio </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">savePortfolio</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Portfolio portfolio)</span></span></span><span class="hljs-function"> </span></span>{ List&lt;Tuple&gt; records = portfolio.getCoins() .entrySet() .stream() .map(entry -&gt; Tuple.of(entry.getKey(), Numeric.create(entry.getValue()), Numeric.create(entry.getValue()))) .collect(Collectors.toList()); pgPool.preparedBatch(UPDATE_COIN_AMT, records, pgRowSetAsyncResult -&gt; { <span class="hljs-comment"><span class="hljs-comment">//   pgRowSetAsyncResult.cause().printStackTrace(); }); return portfolio; } ... }</span></span></code> </pre> <br><p>  Startet eine Umgebung, versuchen wir, unser Portfolio im Voraus über eine umsichtig implementierte API zu aktualisieren: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">package</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">com</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.room606</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.cryptonaut</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.rest</span></span>; <span class="hljs-selector-tag"><span class="hljs-selector-tag">import</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">com</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.room606</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.cryptonaut</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.PortfolioService</span></span>; <span class="hljs-selector-tag"><span class="hljs-selector-tag">import</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">com</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.room606</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.cryptonaut</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.domain</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Portfolio</span></span>; <span class="hljs-selector-tag"><span class="hljs-selector-tag">import</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">io</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.micronaut</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.http</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.MediaType</span></span>; <span class="hljs-selector-tag"><span class="hljs-selector-tag">import</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">io</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.micronaut</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.http</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.annotation</span></span>.*; <span class="hljs-selector-tag"><span class="hljs-selector-tag">import</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">javax</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.inject</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Inject</span></span>; @<span class="hljs-keyword"><span class="hljs-keyword">Controller</span></span>("/<span class="hljs-keyword"><span class="hljs-keyword">cryptonaut</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">restapi</span></span>/") public class ConfigController { @<span class="hljs-keyword"><span class="hljs-keyword">Inject</span></span> private PortfolioService portfolioService; @<span class="hljs-keyword"><span class="hljs-keyword">Post</span></span>("/<span class="hljs-keyword"><span class="hljs-keyword">portfolio</span></span>") @Produces(MediaType.APPLICATION_JSON) @Consumes(MediaType.APPLICATION_JSON) public Portfolio savePortfolio(@Body Portfolio portfolio) { <span class="hljs-selector-tag"><span class="hljs-selector-tag">return</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">portfolioService</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.savePortfolio</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">portfolio</span></span>); }</code> </pre> <br><p>  Führen Sie eine <code>curl</code> Anfrage durch: </p><br><pre> <code class="hljs erlang">curl http://localhost:<span class="hljs-number"><span class="hljs-number">8080</span></span>/cryptonaut/restapi/portfolio -X POST -H <span class="hljs-string"><span class="hljs-string">"Content-Type: application/json"</span></span> --data '{<span class="hljs-string"><span class="hljs-string">"coins"</span></span>: {<span class="hljs-string"><span class="hljs-string">"XRP"</span></span>: <span class="hljs-string"><span class="hljs-string">"35.5"</span></span>, <span class="hljs-string"><span class="hljs-string">"LSK"</span></span>: <span class="hljs-string"><span class="hljs-string">"5.03"</span></span>, <span class="hljs-string"><span class="hljs-string">"XEM"</span></span>: <span class="hljs-string"><span class="hljs-string">"16.23"</span></span>}}' -v</code> </pre> <br><p>  Und ... den Fehler in den Protokollen abfangen: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">io</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.reactiverse</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.pgclient</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.PgException</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">syntax</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">error</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">at</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">or</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">near</span></span> "," <span class="hljs-selector-tag"><span class="hljs-selector-tag">at</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">io</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.reactiverse</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.pgclient</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.impl</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.PrepareStatementCommand</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.handleErrorResponse</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">PrepareStatementCommand</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.java</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:74)</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">at</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">io</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.reactiverse</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.pgclient</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.impl</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.codec</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.decoder</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.MessageDecoder</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.decodeError</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">MessageDecoder</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.java</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:250)</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">at</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">io</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.reactiverse</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.pgclient</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.impl</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.codec</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.decoder</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.MessageDecoder</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.decodeMessage</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">MessageDecoder</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.java</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:139)</span></span> ...</code> </pre> <br><p>  Nachdem wir unsere Rüben zerkratzt haben, finden wir im offiziellen Dock keine Lösung. Wir versuchen, das Dock in der <code>postgres-reactive</code> Bibliothek selbst zu googeln. Dies stellt sich als die richtige Lösung heraus, da Beispiele und die richtige Abfragesyntax im Detail angegeben sind.  Es stellte sich heraus, dass es sich um Platzhalterparameter handelte. Sie müssen nummerierte Beschriftungen der Form <code>$x ($1, $2, etc.)</code> .  Die Lösung besteht also darin, die Zielanforderung neu zu schreiben: </p><br><pre> <code class="hljs sql">private static final String UPDATE_COIN_AMT = "<span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> portfolio (coin, amount) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> ($<span class="hljs-number"><span class="hljs-number">1</span></span>, $<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> CONFLICT (coin) <span class="hljs-string"><span class="hljs-string">" + "</span></span><span class="hljs-keyword"><span class="hljs-keyword">DO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> amount = $<span class="hljs-number"><span class="hljs-number">3</span></span><span class="hljs-string"><span class="hljs-string">";</span></span></code> </pre> <br><p>  Wir starten die Anwendung neu, versuchen die gleiche <code>REST</code> Anfrage ... Prost.  Die Daten werden addiert.  Fahren wir mit dem Lesen fort. </p><br><p>  Wir stehen vor der einfachsten Aufgabe, ein Portfolio von Kryptowährungen eines Benutzers aus der Datenbank zu lesen und sie einem POJO-Objekt zuzuordnen.  Für diese Zwecke verwenden wir die Methode pgPool.query (SELECT_COINS_AMTS, pgRowSetAsyncResult): </p><br><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Portfolio loadPortfolio() { Map&lt;String, BigDecimal&gt; coins = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> HashMap&lt;&gt;(); pgPool.query(SELECT_COINS_AMTS, pgRowSetAsyncResult -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pgRowSetAsyncResult.succeeded()) { PgRowSet <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span> = pgRowSetAsyncResult.result(); PgIterator pgIterator = <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>.iterator(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (pgIterator.hasNext()) { <span class="hljs-keyword"><span class="hljs-keyword">Row</span></span> <span class="hljs-keyword"><span class="hljs-keyword">row</span></span> = pgIterator.next(); coins.put(<span class="hljs-keyword"><span class="hljs-keyword">row</span></span>.getString("coin"), <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> BigDecimal(<span class="hljs-keyword"><span class="hljs-keyword">row</span></span>.getFloat("amount"))); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>.println("Failure: " + pgRowSetAsyncResult.cause().getMessage()); } }); Portfolio portfolio = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Portfolio(); portfolio.setCoins(coins); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> portfolio; }</code> </pre> <br><p>  All dies verbinden wir mit dem Controller, der für das Kryptowährungsportfolio verantwortlich ist: </p><br><pre> <code class="hljs kotlin"><span class="hljs-meta"><span class="hljs-meta">@Controller(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/cryptonaut/restapi/"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConfigController</span></span></span><span class="hljs-class"> </span></span>{ ... <span class="hljs-meta"><span class="hljs-meta">@Get(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/portfolio"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-meta"><span class="hljs-meta">@Produces(MediaType.APPLICATION_JSON)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Portfolio loadPortfolio() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> portfolioService.loadPortfolio(); } ...</code> </pre> <br><p>  Starten Sie den Dienst neu.  Zum Testen füllen wir zunächst genau dieses Portfolio mit mindestens einigen Daten: </p><br><pre> <code class="hljs erlang">curl http://localhost:<span class="hljs-number"><span class="hljs-number">8080</span></span>/cryptonaut/restapi/portfolio -X POST -H <span class="hljs-string"><span class="hljs-string">"Content-Type: application/json"</span></span> --data '{<span class="hljs-string"><span class="hljs-string">"coins"</span></span>: {<span class="hljs-string"><span class="hljs-string">"XRP"</span></span>: <span class="hljs-string"><span class="hljs-string">"35.5"</span></span>, <span class="hljs-string"><span class="hljs-string">"LSK"</span></span>: <span class="hljs-string"><span class="hljs-string">"5.03"</span></span>, <span class="hljs-string"><span class="hljs-string">"XEM"</span></span>: <span class="hljs-string"><span class="hljs-string">"16.23"</span></span>}}' -v</code> </pre> <br><p>  Testen Sie nun endlich unseren Code aus der Datenbank: </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">curl</span></span> http://localhost:8080/cryptonaut/restapi/portfolio -v</code> </pre> <br><p>  Und ... wir bekommen ... etwas Seltsames: </p><br><pre> <code class="hljs json">{<span class="hljs-attr"><span class="hljs-attr">"coins"</span></span>:{}}</code> </pre> <br><p>  Ziemlich seltsam, nicht wahr?  Wir überprüfen die Anfrage zehnmal, versuchen erneut, die <code>curl</code> Anfrage zu stellen, und starten sogar unseren Service neu.  Das Ergebnis ist immer noch dasselbe ... Nachdem wir die Signatur der Methode erneut gelesen und uns daran erinnert haben, dass wir einen <code>Reactive Pg client</code> , kommen wir zu dem Schluss, dass es sich um Asynchronisation handelt.  Nachdenkliches Debag bestätigte dies!  Es war ein wenig gemächliches De-Code wert, wie voila, wir haben nicht leere Daten! </p><br><p>  Wenn wir uns wieder dem Bibliotheksdock zuwenden und die Ärmel hochkrempeln, schreiben wir den Code mit einem echten Blockierungscode neu, der jedoch vollständig vorhersehbar ist: </p><br><pre> <code class="hljs pgsql">Map&lt;String, BigDecimal&gt; coins = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> HashMap&lt;&gt;(); PgIterator pgIterator = pgPool.rxPreparedQuery(SELECT_COINS_AMTS).blockingGet().iterator(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (pgIterator.hasNext()) { <span class="hljs-keyword"><span class="hljs-keyword">Row</span></span> <span class="hljs-keyword"><span class="hljs-keyword">row</span></span> = pgIterator.next(); coins.put(<span class="hljs-keyword"><span class="hljs-keyword">row</span></span>.getString("coin"), <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> BigDecimal(<span class="hljs-keyword"><span class="hljs-keyword">row</span></span>.getValue("amount").toString())); }</code> </pre> <br><p>  Jetzt bekommen wir, was wir erwarten.  Wir haben dieses Problem entschieden, fahren Sie fort. </p><br><h3 id="pishem-klient-dlya-polucheniya-dannyh-po-rynkam">  Wir schreiben einen Kunden, um Marktdaten zu erhalten </h3><br><p>  Hier möchte ich natürlich das Problem mit der geringsten Anzahl von Fahrrädern lösen.  Das Ergebnis sind zwei Lösungen: </p><br><ul><li>  vorgefertigte Client-Bibliotheken für den Zugriff auf bestimmte Krypto-Austausche </li><li>  einen eigenen Kundencode für die Beantragung des Wechselkurses.  Was aus der Box kam, ist Micronaut. </li></ul><br><p>  Mit vorgefertigten Bibliotheken ist nicht alles so interessant.  Ich stelle nur fest, dass während einer Schnellsuche das Projekt <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://github.com/knowm/XChange</a> ausgewählt wurde. </p><br><p>  Im Prinzip ist die Bibliotheksarchitektur so einfach wie drei Cent - es gibt eine Reihe von Schnittstellen zum Empfangen von Daten, die Hauptschnittstellen und Modellklassen wie <code>Ticker</code> (Sie können <code>bid</code> , <code>ask</code> , alle Arten von Open Price, Close Price usw. herausfinden), <code>CurrencyPair</code> , <code>Currency</code> .  Außerdem initialisieren Sie die Implementierungen selbst im Code, nachdem Sie zuvor die Abhängigkeit mit der Implementierung verbunden haben, die sich auf einen bestimmten Kryptoaustausch bezieht.  Und die Hauptklasse, über die wir operieren, ist <code>MarketDataService.java</code> </p><br><p>  Zum Beispiel sind wir für unsere Experimente zunächst einmal mit einer solchen „Konfiguration“ zufrieden: </p><br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.knowm.xchange<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>xchange-core<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>4.3.10<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.knowm.xchange<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>xchange-bittrex<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>4.3.10<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Im Folgenden finden Sie den Code, der eine Schlüsselfunktion ausführt - die Berechnung der Kosten einer bestimmten Kryptowährung in Fiat-Begriffen (siehe Formeln, die am Anfang des Artikels im Anforderungsblock beschrieben sind): </p><br><pre> <code class="hljs java"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.room606.cryptonaut.markets; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.room606.cryptonaut.exceptions.CryptonautException; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.knowm.xchange.currency.Currency; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.knowm.xchange.currency.CurrencyPair; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.knowm.xchange.dto.marketdata.Ticker; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.knowm.xchange.exceptions.CurrencyPairNotValidException; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.knowm.xchange.service.marketdata.MarketDataService; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.inject.Inject; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.inject.Singleton; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.IOException; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.math.BigDecimal; <span class="hljs-meta"><span class="hljs-meta">@Singleton</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CryptoMarketDataService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> FiatExchangeRatesService fiatExchangeRatesService; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> MarketDataService marketDataService; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CryptoMarketDataService</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(FiatExchangeRatesService fiatExchangeRatesService, MarketDataServiceFactory marketDataServiceFactory)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fiatExchangeRatesService = fiatExchangeRatesService; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.marketDataService = marketDataServiceFactory.getMarketDataService(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BigDecimal </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPrice</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String coinCode, String fiatCurrencyCode)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> CryptonautException </span></span>{ BigDecimal price = getPriceForBasicCurrency(coinCode, Currency.USD.getCurrencyCode()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Currency.USD.equals(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Currency(fiatCurrencyCode))) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> price; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> price.multiply(fiatExchangeRatesService.getFiatPrice(Currency.USD.getCurrencyCode(), fiatCurrencyCode)); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> BigDecimal </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPriceForBasicCurrency</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String coinCode, String fiatCurrencyCode)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> CryptonautException </span></span>{ Ticker ticker = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { ticker = marketDataService.getTicker(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CurrencyPair(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Currency(coinCode), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Currency(fiatCurrencyCode))); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ticker.getBid(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (CurrencyPairNotValidException e) { ticker = getTicker(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Currency(coinCode), Currency.BTC); Ticker ticker2 = getTicker(Currency.BTC, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Currency(fiatCurrencyCode)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ticker.getBid().multiply(ticker2.getBid()); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException e) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CryptonautException(<span class="hljs-string"><span class="hljs-string">"Failed to get price for Pair "</span></span> + coinCode + <span class="hljs-string"><span class="hljs-string">"/"</span></span> + fiatCurrencyCode + <span class="hljs-string"><span class="hljs-string">": "</span></span> + e.getMessage(), e); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Ticker </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTicker</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Currency base, Currency counter)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> CryptonautException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> marketDataService.getTicker(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CurrencyPair(base, counter)); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (CurrencyPairNotValidException | IOException e) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CryptonautException(<span class="hljs-string"><span class="hljs-string">"Failed to get price for Pair "</span></span> + base.getCurrencyCode() + <span class="hljs-string"><span class="hljs-string">"/"</span></span> + counter.getCurrencyCode() + <span class="hljs-string"><span class="hljs-string">": "</span></span> + e.getMessage(), e); } } }</code> </pre> <br><p>  Alles wurde so weit wie möglich über unsere eigenen Schnittstellen durchgeführt, um die spezifischen Implementierungen des Projekts <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://github.com/knowm/XChange</a> leicht zu ignorieren. </p><br><p>  Angesichts der Tatsache, dass an vielen, wenn nicht allen Kryptowährungsbörsen nur ein begrenzter Satz von Fiat-Währungen im Umlauf ist (USD, EUR, vielleicht ist das alles ..), muss für die endgültige Antwort auf die Frage des Benutzers eine weitere Datenquelle hinzugefügt werden - Fiat-Wechselkurse und auch ein optionaler Konverter.  Das heißt,  Um die Frage zu beantworten, wie viel WTF-Kryptowährung jetzt in RUR (Zielwährung, Zielwährung) kostet, müssen Sie zwei Unterfragen beantworten: WTF / BaseCurrency (wir betrachten USD als solchen), BaseCurrency / RUR, multiplizieren Sie diese beiden Werte und geben Sie sie als Ergebnis an. </p><br><p>  Für unsere erste Version des Dienstes unterstützen wir nur USD und RUR als Zielwährungen. <br>  Um RUR zu unterstützen, wäre es daher ratsam, Quellen zu verwenden, die für den geografischen Standort des Dienstes relevant sind (wir werden ihn ausschließlich in Russland hosten und nutzen).  Kurz gesagt, der Leitzins der Zentralbank wird zu uns passen.  Im Internet wurde eine Open Source für solche Daten gefunden, die als JSON verwendet werden können.  Großartig. </p><br><p>  Nachfolgend finden Sie die Antwort des Dienstes auf die aktuelle Wechselkursanforderung: </p><br><pre> <code class="hljs objectivec">{ <span class="hljs-string"><span class="hljs-string">"Date"</span></span>: <span class="hljs-string"><span class="hljs-string">"2018-10-16T11:30:00+03:00"</span></span>, <span class="hljs-string"><span class="hljs-string">"PreviousDate"</span></span>: <span class="hljs-string"><span class="hljs-string">"2018-10-13T11:30:00+03:00"</span></span>, <span class="hljs-string"><span class="hljs-string">"PreviousURL"</span></span>: <span class="hljs-string"><span class="hljs-string">"\/\/www.cbr-xml-daily.ru\/archive\/2018\/10\/13\/daily_json.js"</span></span>, <span class="hljs-string"><span class="hljs-string">"Timestamp"</span></span>: <span class="hljs-string"><span class="hljs-string">"2018-10-15T23:00:00+03:00"</span></span>, <span class="hljs-string"><span class="hljs-string">"Valute"</span></span>: { <span class="hljs-string"><span class="hljs-string">"AUD"</span></span>: { <span class="hljs-string"><span class="hljs-string">"ID"</span></span>: <span class="hljs-string"><span class="hljs-string">"R01010"</span></span>, <span class="hljs-string"><span class="hljs-string">"NumCode"</span></span>: <span class="hljs-string"><span class="hljs-string">"036"</span></span>, <span class="hljs-string"><span class="hljs-string">"CharCode"</span></span>: <span class="hljs-string"><span class="hljs-string">"AUD"</span></span>, <span class="hljs-string"><span class="hljs-string">"Nominal"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"Name"</span></span>: <span class="hljs-string"><span class="hljs-string">"ђІЃ‚Ђ°»№Ѓє№ ґѕ»»°Ђ"</span></span>, <span class="hljs-string"><span class="hljs-string">"Value"</span></span>: <span class="hljs-number"><span class="hljs-number">46.8672</span></span>, <span class="hljs-string"><span class="hljs-string">"Previous"</span></span>: <span class="hljs-number"><span class="hljs-number">46.9677</span></span> }, <span class="hljs-string"><span class="hljs-string">"AZN"</span></span>: { <span class="hljs-string"><span class="hljs-string">"ID"</span></span>: <span class="hljs-string"><span class="hljs-string">"R01020A"</span></span>, <span class="hljs-string"><span class="hljs-string">"NumCode"</span></span>: <span class="hljs-string"><span class="hljs-string">"944"</span></span>, <span class="hljs-string"><span class="hljs-string">"CharCode"</span></span>: <span class="hljs-string"><span class="hljs-string">"AZN"</span></span>, <span class="hljs-string"><span class="hljs-string">"Nominal"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"Name"</span></span>: <span class="hljs-string"><span class="hljs-string">"ђ·µЂ±°№ґ¶°ЅЃє№ ј°Ѕ°‚"</span></span>, <span class="hljs-string"><span class="hljs-string">"Value"</span></span>: <span class="hljs-number"><span class="hljs-number">38.7567</span></span>, <span class="hljs-string"><span class="hljs-string">"Previous"</span></span>: <span class="hljs-number"><span class="hljs-number">38.8889</span></span> }, <span class="hljs-string"><span class="hljs-string">"GBP"</span></span>: { <span class="hljs-string"><span class="hljs-string">"ID"</span></span>: <span class="hljs-string"><span class="hljs-string">"R01035"</span></span>, <span class="hljs-string"><span class="hljs-string">"NumCode"</span></span>: <span class="hljs-string"><span class="hljs-string">"826"</span></span>, <span class="hljs-string"><span class="hljs-string">"CharCode"</span></span>: <span class="hljs-string"><span class="hljs-string">"GBP"</span></span>, <span class="hljs-string"><span class="hljs-string">"Nominal"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"Name"</span></span>: <span class="hljs-string"><span class="hljs-string">"¤ѓЅ‚ Ѓ‚µЂ»ЅіѕІ ЎѕµґЅµЅЅѕіѕ єѕЂѕ»µІЃ‚І°"</span></span>, <span class="hljs-string"><span class="hljs-string">"Value"</span></span>: <span class="hljs-number"><span class="hljs-number">86.2716</span></span>, <span class="hljs-string"><span class="hljs-string">"Previous"</span></span>: <span class="hljs-number"><span class="hljs-number">87.2059</span></span> }, ...</code> </pre> <br><p>  Im Folgenden finden Sie den <code>CbrExchangeRatesClient</code> Clientcode: </p><br><pre> <code class="hljs pgsql">package com.room606.cryptonaut.markets.clients; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.fasterxml.jackson.databind.JsonNode; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.fasterxml.jackson.databind.ObjectMapper; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.fasterxml.jackson.databind.ObjectReader; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.room606.cryptonaut.exceptions.CryptonautException; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.micronaut.http.HttpRequest; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.micronaut.http.client.Client; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.micronaut.http.client.RxHttpClient; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.inject.Inject; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.inject.Singleton; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.IOException; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.math.BigDecimal; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.*; @Singleton <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> CbrExchangeRatesClient { private static final String CBR_DATA_URI = "https://www.cbr-xml-daily.ru/daily_json.js"; @Client(CBR_DATA_URI) @Inject private RxHttpClient httpClient; private final ObjectReader objectReader = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ObjectMapper().reader(); <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Map&lt;String, BigDecimal&gt; getRates() { try { //<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ratesCache.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>("fiatRates"); HttpRequest&lt;?&gt; req = HttpRequest.<span class="hljs-keyword"><span class="hljs-keyword">GET</span></span>(""); String response = httpClient.retrieve(req, String.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>).blockingSingle(); JsonNode <span class="hljs-type"><span class="hljs-type">json</span></span> = objectReader.readTree(response); String usdPrice = <span class="hljs-type"><span class="hljs-type">json</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>("Valute").<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>("USD").<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>("Value").asText(); String eurPrice = <span class="hljs-type"><span class="hljs-type">json</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>("Valute").<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>("EUR").<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>("Value").asText(); String gbpPrice = <span class="hljs-type"><span class="hljs-type">json</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>("Valute").<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>("GBP").<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>("Value").asText(); Map&lt;String, BigDecimal&gt; prices = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> HashMap&lt;&gt;(); prices.put("USD", <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> BigDecimal(usdPrice)); prices.put("GBP", <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> BigDecimal(gbpPrice)); prices.put("EUR", <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> BigDecimal(eurPrice)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> prices; } catch (IOException e) { throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CryptonautException("Failed to obtain exchange rates: " + e.getMessage(), e); } } }</code> </pre> <br><p>  Hier injizieren wir <code>RxHttpClient</code> , eine Komponente aus dem <code>Micronaut</code> .  Es gibt uns auch die Wahl, asynchrone Anforderungsverarbeitung oder Blockierung durchzuführen.  Wir wählen die klassische Blockierung: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">httpClient</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.retrieve</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">req</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">String</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.class</span></span>)<span class="hljs-selector-class"><span class="hljs-selector-class">.blockingSingle</span></span>();</code> </pre> <br><h3 id="konfiguraciya">  Konfiguration </h3><br><p>  In einem Projekt können Sie Dinge hervorheben, die sich ändern und die Geschäftslogik oder bestimmte Aspekte beeinflussen.  Lassen Sie uns eine Liste der unterstützten Fiat-Währungen als Eigenschaft erstellen und diese zu Beginn der Anwendung einfügen. </p><br><p>  Mit dem folgenden Code werden Währungscodes verworfen, für die wir den Portfoliowert noch nicht berechnen können: </p><br><pre> <code class="hljs javascript">public BigDecimal getFiatPrice(<span class="hljs-built_in"><span class="hljs-built_in">String</span></span> baseCurrency, <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> counterCurrency) throws NotSupportedFiatException { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!supportedCounterCurrencies.contains(counterCurrency)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NotSupportedFiatException(<span class="hljs-string"><span class="hljs-string">"Counter currency not supported: "</span></span> + counterCurrency); } <span class="hljs-built_in"><span class="hljs-built_in">Map</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>, BigDecimal&gt; rates = cbrExchangeRatesClient.getRates(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> rates.get(baseCurrency); }</code> </pre> <br><p>  Dementsprechend ist es unsere Absicht, den Wert aus <code>application.yml</code> irgendwie in die Variable supportCounterCurrencies einzufügen. </p><br><p>  In der ersten Version wurde ein solcher Code unter das Feld der Klasse FiatExchangeRatesService.java geschrieben: </p><br><pre> <code class="hljs kotlin"><span class="hljs-meta"><span class="hljs-meta">@Value(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"</span></span><span class="hljs-subst"><span class="hljs-meta"><span class="hljs-meta-string"><span class="hljs-subst">${cryptonaut.currencies:RUR}</span></span></span></span><span class="hljs-meta"><span class="hljs-meta-string">"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String supportedCurrencies; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> List&lt;String&gt; supportedCounterCurrencies = Arrays.asList(supportedCurrencies.split(<span class="hljs-string"><span class="hljs-string">"[,]"</span></span>, -<span class="hljs-number"><span class="hljs-number">1</span></span>));</code> </pre> <br><p>  Hier entspricht der <code>placeholder</code> der folgenden Struktur des Dokuments <code>application.yml</code> : </p><br><pre> <code class="hljs pgsql">micronaut: application: <span class="hljs-type"><span class="hljs-type">name</span></span>: cryptonaut #Uncomment <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> port <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>: port: <span class="hljs-number"><span class="hljs-number">8080</span></span> postgres: reactive: client: port: <span class="hljs-number"><span class="hljs-number">5432</span></span> host: localhost <span class="hljs-keyword"><span class="hljs-keyword">database</span></span>: cryptonaut <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: crypto <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>: r1ch13r1ch maxSize: <span class="hljs-number"><span class="hljs-number">5</span></span> # app / business logic specific properties cryptonaut: currencies: "RUR"</code> </pre> <br><p>  Anwendungsstart, schneller Rauchtest ... Fehler! </p><br><pre> <code class="hljs dos">Caused by: io.micronaut.context.exceptions.BeanInstantiationException: Error instantiating bean of <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> [com.room606.cryptonaut.markets.CryptoMarketDataService] <span class="hljs-built_in"><span class="hljs-built_in">Path</span></span> Taken: new MarketDataController([CryptoMarketDataService cryptoMarketDataService],FiatExchangeRatesService fiatExchangeRatesService) --&gt; new CryptoMarketDataService([FiatExchangeRatesService fiatExchangeRatesService],MarketDataServiceFactory marketDataServiceFactory) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> io.micronaut.context.DefaultBeanContext.doCreateBean(DefaultBeanContext.java:<span class="hljs-number"><span class="hljs-number">1266</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> io.micronaut.context.DefaultBeanContext.createAndRegisterSingleton(DefaultBeanContext.java:<span class="hljs-number"><span class="hljs-number">1677</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> io.micronaut.context.DefaultBeanContext.getBeanForDefinition(DefaultBeanContext.java:<span class="hljs-number"><span class="hljs-number">1447</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> io.micronaut.context.DefaultBeanContext.getBeanInternal(DefaultBeanContext.java:<span class="hljs-number"><span class="hljs-number">1427</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> io.micronaut.context.DefaultBeanContext.getBean(DefaultBeanContext.java:<span class="hljs-number"><span class="hljs-number">852</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> io.micronaut.context.AbstractBeanDefinition.getBeanForConstructorArgument(AbstractBeanDefinition.java:<span class="hljs-number"><span class="hljs-number">943</span></span>) ... <span class="hljs-number"><span class="hljs-number">36</span></span> common frames omitted Caused by: java.lang.NullPointerException: null <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> com.room606.cryptonaut.markets.FiatExchangeRatesService.&lt;init&gt;(FiatExchangeRatesService.java:<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> com.room606.cryptonaut.markets.$FiatExchangeRatesServiceDefinition.build(Unknown Source) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> io.micronaut.context.DefaultBeanContext.doCreateBean(DefaultBeanContext.java:<span class="hljs-number"><span class="hljs-number">1252</span></span>) ... <span class="hljs-number"><span class="hljs-number">41</span></span> common frames omitted</code> </pre> <br><p>    <code>Micronaut</code>    <code>Spring</code>        ,        <code>compile time</code> .       ,     : </p><br><pre> <code class="hljs kotlin"><span class="hljs-meta"><span class="hljs-meta">@Value(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"</span></span><span class="hljs-subst"><span class="hljs-meta"><span class="hljs-meta-string"><span class="hljs-subst">${cryptonaut.currencies:RUR}</span></span></span></span><span class="hljs-meta"><span class="hljs-meta-string">"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String supportedCurrencies; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;String&gt; supportedCounterCurrencies; <span class="hljs-meta"><span class="hljs-meta">@PostConstruct</span></span> void <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>() { supportedCounterCurrencies = Arrays.asList(supportedCurrencies.split(<span class="hljs-string"><span class="hljs-string">"[,]"</span></span>, -<span class="hljs-number"><span class="hljs-number">1</span></span>)); }</code> </pre> <br><p> ,    – <code>javax.annotation.PostConstruct</code> ,        ,    ,     ,        .     . </p><br><p>  , ,        Spring.    micronaut    <code>@Property</code>       <code>Map&lt;String, String&gt;</code> ,  <code>@Configuration</code>    , <code>Random Properties</code> (,      <code>ID</code>  , ,   -   )    <code>PropertySourceLoader</code> , ..   .    <code>Spring</code> –   <code>ApplicationContext</code> ( <code>xml</code> , <code>web</code> , <code>groovy</code> , <code>ClassPath</code> etc.) ,              . </p><br><h3 id="testy">  </h3><br><p>       ,   micronaut.   Embedded Server feature,       <code>Groovy</code>    <code>Spock</code> .      <code>Java</code> ,  groovy-   . ,    <code>EmbeddedServer</code> + <code>HttpClient</code>   <code>Micronaut</code>      API — </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">GET</span></span> /cryptonaut/restapi/portfolio/total.json?fiatCurrency={x}</code> </pre> <br><p>  API,              . </p><br><p>    : </p><br><pre> <code class="hljs axapta"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PortfolioReportsControllerTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> EmbeddedServer <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> HttpClient <span class="hljs-keyword"><span class="hljs-keyword">client</span></span>; @Inject <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> PortfolioService portfolioService; @BeforeClass <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> setupServer() { <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> = ApplicationContext.run(EmbeddedServer.class); <span class="hljs-keyword"><span class="hljs-keyword">client</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> .getApplicationContext() .createBean(HttpClient.class, <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>.getURL()); } @AfterClass <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> stopServer() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>.stop(); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">client</span></span> != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">client</span></span>.stop(); } } @Test <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> total() { <span class="hljs-comment"><span class="hljs-comment">//</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment"> Seems like code smell. I don't like it.. portfolioService = server.getApplicationContext().getBean(PortfolioService.class); Portfolio portfolio = new Portfolio(); Map&lt;String, BigDecimal&gt; coins = new HashMap&lt;&gt;(); BigDecimal amt1 = new BigDecimal("570.05"); BigDecimal amt2 = new BigDecimal("2.5"); coins.put("XRP", amt1); coins.put("QTUM", amt2); portfolio.setCoins(coins); portfolioService.savePortfolio(portfolio); HttpRequest request = HttpRequest.GET("/cryptonaut/restapi/portfolio/total.json?fiatCurrency=USD"); HttpResponse&lt;Total&gt; rsp = client.toBlocking().exchange(request, Total.class); assertEquals(200, rsp.status().getCode()); assertEquals(MediaType.APPLICATION_JSON_TYPE, rsp.getContentType().get()); Total val = rsp.body(); assertEquals("USD", val.getFiatCurrency()); assertEquals(TEST_VALUE.toString(), val.getValue().toString()); assertEquals(amt1.toString(), val.getPortfolio().getCoins().get("XRP").toString()); assertEquals(amt2.toString(), val.getPortfolio().getCoins().get("QTUM").toString()); } }</span></span></code> </pre> <br><p>      ,       mock   <code>PortfolioService.java</code> : </p><br><pre> <code class="hljs java"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.room606.cryptonaut; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.room606.cryptonaut.domain.Portfolio; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.micronaut.context.annotation.Requires; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.inject.Singleton; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.math.BigDecimal; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Optional; <span class="hljs-meta"><span class="hljs-meta">@Singleton</span></span> <span class="hljs-meta"><span class="hljs-meta">@Requires</span></span>(env=<span class="hljs-string"><span class="hljs-string">"test"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MockPortfolioService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PortfolioService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Portfolio portfolio; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> BigDecimal TEST_VALUE = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BigDecimal(<span class="hljs-string"><span class="hljs-string">"56.65"</span></span>); <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Portfolio </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">savePortfolio</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Portfolio portfolio)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.portfolio = portfolio; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> portfolio; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Portfolio </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loadPortfolio</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> portfolio; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Optional&lt;BigDecimal&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">calculateTotalValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Portfolio portfolio, String fiatCurrency)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Optional.of(TEST_VALUE); } }</code> </pre> <br><p>       <code>@Requires(env="test")</code> ,        <code>Application Context</code>  . -,     micronaut     test,     ,        . ,            ,   <code>PortfolioServiceImpl</code>     <code>@Requires(notEnv="test")</code> .               –      .  <code>Micronaut</code>            . </p><br><p>  ,   –   ,     ,   –        <code>mockito</code> .       : </p><br><pre> <code class="hljs java"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">priceForUsdDirectRate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ when(marketDataServiceFactory.getMarketDataService()).thenReturn(marketDataService); String coinCode = <span class="hljs-string"><span class="hljs-string">"ETH"</span></span>; String fiatCurrencyCode = <span class="hljs-string"><span class="hljs-string">"USD"</span></span>; BigDecimal priceA = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BigDecimal(<span class="hljs-string"><span class="hljs-string">"218.58"</span></span>); Ticker targetTicker = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Ticker.Builder().bid(priceA).build(); when(marketDataService.getTicker(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CurrencyPair(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Currency(coinCode), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Currency(fiatCurrencyCode)))).thenReturn(targetTicker); CryptoMarketDataService cryptoMarketDataService = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CryptoMarketDataService(fiatExchangeRatesService, marketDataServiceFactory); assertEquals(priceA, cryptoMarketDataService.getPrice(coinCode, fiatCurrencyCode)); }</code> </pre> <br><h3 id="keshirovanie">  </h3><br><p>  ,       .            .    ,          . ,         ,      -   IP.     ,            <code>@Cacheable</code>    . <br></p><br><img src="https://habrastorage.org/webt/yz/xn/mc/yzxnmcojgibaurai_jflh202xic.jpeg" alt="Cache"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hier war jedoch alles völlig erfolglos. </font><font style="vertical-align: inherit;">Die Dokumentation in diesem Aspekt ist verwirrend. Nach dem Scrollen durch einige Bildschirme finden Sie Konfigurationen, die sich widersprechen ( </font></font><code>appliction.yml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">Als Cache wurde Redis ausgewählt, das ebenfalls im Docker-Container daneben angehoben wurde. </font><font style="vertical-align: inherit;">Hier ist seine Konfiguration:</font></font><br><pre> <code class="hljs mel">redis: <span class="hljs-keyword"><span class="hljs-keyword">image</span></span>: <span class="hljs-string"><span class="hljs-string">'bitnami/redis:latest'</span></span> environment: - ALLOW_EMPTY_PASSWORD=yes ports: - <span class="hljs-string"><span class="hljs-string">'6379:6379'</span></span></code> </pre> <br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Und hier ist ein Code, der von @Cacheable kommentiert wurde: </font></font></p><br><pre> <code class="hljs vbscript">@Cacheable(<span class="hljs-string"><span class="hljs-string">"fiatRates"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Map&lt;<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>, BigDecimal&gt; getRates() { HttpRequest&lt;?&gt; req = HttpRequest.<span class="hljs-keyword"><span class="hljs-keyword">GET</span></span>(<span class="hljs-string"><span class="hljs-string">""</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> <span class="hljs-built_in"><span class="hljs-built_in">response</span></span> = httpClient.retrieve(req, <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>).blockingSingle(); try { JsonNode json = objectReader.readTree(<span class="hljs-built_in"><span class="hljs-built_in">response</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> usdPrice = json.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-string"><span class="hljs-string">"Valute"</span></span>).<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-string"><span class="hljs-string">"USD"</span></span>).<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-string"><span class="hljs-string">"Value"</span></span>).asText(); <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> eurPrice = json.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-string"><span class="hljs-string">"Valute"</span></span>).<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-string"><span class="hljs-string">"EUR"</span></span>).<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-string"><span class="hljs-string">"Value"</span></span>).asText(); <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> gbpPrice = json.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-string"><span class="hljs-string">"Valute"</span></span>).<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-string"><span class="hljs-string">"GBP"</span></span>).<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-string"><span class="hljs-string">"Value"</span></span>).asText(); Map&lt;<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>, BigDecimal&gt; prices = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap&lt;&gt;(); prices.put(<span class="hljs-string"><span class="hljs-string">"USD"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BigDecimal(usdPrice)); prices.put(<span class="hljs-string"><span class="hljs-string">"GBP"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BigDecimal(gbpPrice)); prices.put(<span class="hljs-string"><span class="hljs-string">"EUR"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BigDecimal(eurPrice)); return prices; } catch (IOException e) { throw <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RuntimeException(e); } }</code> </pre> <br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aber mit </font></font><code>application.yml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">war das wichtigste Rätsel. </font><font style="vertical-align: inherit;">Ich habe alle möglichen Konfigurationen ausprobiert. </font><font style="vertical-align: inherit;">Hier ist einer:</font></font></p><br><pre> <code class="hljs pgsql">caches: fiatrates: expireAfterWrite: "1h" redis: caches: fiatRates: expireAfterWrite: "1h" port: <span class="hljs-number"><span class="hljs-number">6379</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>: localhost</code> </pre> <br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Hier ist einer: </font></font></p><br><pre> <code class="hljs objectivec"><span class="hljs-meta"><span class="hljs-meta">#cache redis: uri: localhost:6379 caches: fiatRates: expireAfterWrite: </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"1h"</span></span></span></span></code> </pre> <br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Und sogar versucht, die Großbuchstaben im Cache-Namen zu entfernen. </font><font style="vertical-align: inherit;">Als Ergebnis habe ich beim Starten der Anwendung das gleiche Ergebnis erhalten: "Unerwarteter Fehler aufgetreten: Kein Cache für Name konfiguriert: fiatRates":</font></font></p><br><pre> <code class="hljs sql">ERROR imhsnetty.RoutingInBoundHandler - Unexpected error occurred: No <span class="hljs-keyword"><span class="hljs-keyword">cache</span></span> configured <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: fiatRates io.micronaut.context.exceptions.ConfigurationException: <span class="hljs-keyword"><span class="hljs-keyword">No</span></span> <span class="hljs-keyword"><span class="hljs-keyword">cache</span></span> configured <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: fiatRates <span class="hljs-keyword"><span class="hljs-keyword">at</span></span> io.micronaut.cache.DefaultCacheManager.getCache(DefaultCacheManager.java:<span class="hljs-number"><span class="hljs-number">67</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">at</span></span> io.micronaut.cache.interceptor.CacheInterceptor.interceptSync(CacheInterceptor.java:<span class="hljs-number"><span class="hljs-number">176</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">at</span></span> io.micronaut.cache.interceptor.CacheInterceptor.intercept(CacheInterceptor.java:<span class="hljs-number"><span class="hljs-number">128</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">at</span></span> io.micronaut.aop.MethodInterceptor.intercept(MethodInterceptor.java:<span class="hljs-number"><span class="hljs-number">41</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">at</span></span> io.micronaut.aop.chain.InterceptorChain.proceed(InterceptorChain.java:<span class="hljs-number"><span class="hljs-number">147</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">at</span></span> com.room606.cryptonaut.markets.clients.$CbrExchangeRatesClientDefinition$Intercepted.getRates(<span class="hljs-literal"><span class="hljs-literal">Unknown</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Source</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">at</span></span> com.room606.cryptonaut.markets.FiatExchangeRatesService.getFiatPrice(FiatExchangeRatesService.java:<span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">at</span></span> com.room606.cryptonaut.rest.MarketDataController.index(MarketDataController.java:<span class="hljs-number"><span class="hljs-number">34</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">at</span></span> com.room606.cryptonaut.rest.$MarketDataControllerDefinition$$exec2.invokeInternal(<span class="hljs-literal"><span class="hljs-literal">Unknown</span></span> ...</code> </pre> <br><p>     <code>GitHub</code> -   <code>SO</code>    .          .  , .          ,       .   boilerplate-,    -  <code>Redis</code> -   ,    ,   Spring Boot  ,         . </p><br><h3 id="sidim-v-kustah-s-sekundomerom">      </h3><br><p>          ,      <code>Micronaut</code> –    ,             Spring-. <br></p><br><img src="https://habrastorage.org/webt/6z/nu/h5/6znuh5vgxk7g0vueo5vs1ktkznc.jpeg" alt="Benchmarking"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Hier sollten Sie natürlich mit einem Dutzend Haftungsausschlussklauseln angeben: Ich bin kein Benchmark-Spezialist, was die Methode zum Starten und Messen der Startzeit, die experimentellen Bedingungen (Maschinenlast, Hardwarekonfiguration, Betriebssystem usw.) betrifft. </font></font><br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Der letzte Punkt: </font></font></p><br><p> <strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Betriebssystem:</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 16.04.1-Ubuntu x86_64 x86_64 x86_64 GNU / Linux- </font></font><br> <strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CPU:</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Intel® Core (TM) i7-7700HQ-CPU bei 2,80 GHz </font></font><br> <strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mem:</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 2 </font><font style="vertical-align: inherit;">x </font><font style="vertical-align: inherit;">8 GB DDR4, Geschwindigkeit: 2400 MHz </font></font><br> <strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SSD-Festplatte:</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> PCIe NVMe M </font><strong><font style="vertical-align: inherit;">SSD</font></strong><font style="vertical-align: inherit;"> 2, 256 GB</font></font></p><br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Meins </font></font><del><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Verteidigung </font></font></del><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Technik: </font></font></p><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Eine Schubkarre einlösen </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Schalten Sie das Auto ein </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Bewerbungsstart </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Parallel dazu fragt der Client-Code in einer Schleife eine API ab, die einfach eine Zeile in der Antwort zurückgibt </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Sobald eine Antwort von der API empfangen wird, stoppt der „Timer“. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Das Ergebnis in Millisekunden wird sorgfältig auf dem Tablet eingegeben </font></font></li></ol><br><p>             –  <code>Rest Controller</code>    –  IoC-,     . </p><br><p>    “ ”    : </p><br><table><thead><tr><th></th><th> Micronaut </th><th> Spring Boot </th></tr></thead><tbody><tr><td> Avg.(ms) </td><td> 2708.4 </td><td> 2735.2 </td></tr><tr><td>   cryptonaut    (ms) </td><td>  1082 </td><td>  - - </td></tr></tbody></table><br><p>  ,         –  <strong>27</strong>    <code>Micronaut</code> . ,               . </p><br><h3 id="chto-po-itogu">   ? </h3><br><p>   .  ,   , ,      –  .            .      Groovy-,    ,    .     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><code>SO</code></a>     Spring.  ,  ,                .         —       .           Spring. </p><br><p> <strong>   :</strong> </p><br><ul><li>      Micronaut –  service-discovery,    AWS </li><li>  </li><li>      Java.    Kotlin   Groovy. </li></ul><br><p>     <a href=""></a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de427595/">https://habr.com/ru/post/de427595/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de427585/index.html">Das Rezept für ein beliebtes und erfolgreiches MMO-Spiel.</a></li>
<li><a href="../de427587/index.html">Konzentriertes Java für eineinhalbtausend Menschen. Wie war Joker 2018?</a></li>
<li><a href="../de427589/index.html">Wir schreiben einen Online-Chat auf Websockets mit Swoole</a></li>
<li><a href="../de427591/index.html">Architektur als Belastung</a></li>
<li><a href="../de427593/index.html">Schnellbefehlsmagie in Vivaldi 2.1</a></li>
<li><a href="../de427601/index.html">5 + 1 Fall, in dem die REST-API-Spezifikation eine große Rolle spielt</a></li>
<li><a href="../de427603/index.html">Wie man endlich anfängt, Tests zu schreiben und es nicht bereut</a></li>
<li><a href="../de427605/index.html">Wie die Crowdsourcing-Plattform von Yandex Drohnen trainiert und die Servicequalität bewertet</a></li>
<li><a href="../de427607/index.html">Rechenzentrum in der Schweiz: wie am Schnürchen arbeiten</a></li>
<li><a href="../de427609/index.html">Lösen der Gleichung mit ganzzahliger Division ohne rohe Gewalt</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>