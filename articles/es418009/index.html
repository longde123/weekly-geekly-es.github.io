<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßîüèº üîü ü§æüèø Node.js y representaci√≥n del servidor en Airbnb ü§≥üèª ‚ûñ ‚õ¥Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="El material, cuya traducci√≥n publicamos hoy, est√° dedicado a la historia de c√≥mo Airbnb optimiza las partes del servidor de las aplicaciones web con e...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Node.js y representaci√≥n del servidor en Airbnb</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/418009/">  El material, cuya traducci√≥n publicamos hoy, est√° dedicado a la historia de c√≥mo Airbnb optimiza las partes del servidor de las aplicaciones web con el ojo puesto en el uso cada vez mayor de las tecnolog√≠as de representaci√≥n del servidor.  En el transcurso de varios a√±os, la compa√±√≠a cambi√≥ gradualmente todo su front-end a una arquitectura <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">uniforme</a> , seg√∫n la cual las p√°ginas web son estructuras jer√°rquicas de componentes React llenas de datos de su API.  En particular, durante este proceso hubo un abandono sistem√°tico de Ruby on Rails.  De hecho, Airbnb planea cambiar a un nuevo servicio basado √∫nicamente en Node.js, gracias al cual las p√°ginas totalmente preparadas que se muestran en el servidor se entregar√°n a los navegadores de los usuarios.  Este servicio generar√° la mayor parte del c√≥digo HTML para todos los productos de Airbnb.  El motor de renderizado en cuesti√≥n difiere de la mayor√≠a de los servicios de back-end utilizados por la compa√±√≠a debido al hecho de que no est√° escrito en Ruby o Java.  Sin embargo, difiere de los servicios tradicionales Node.js altamente cargados, alrededor de los cuales se construyen los modelos mentales y las herramientas auxiliares utilizadas en Airbnb. <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://habrastorage.org/webt/rg/zm/64/rgzm64dbdvumj6ycekqpoxbqxhw.png"></a> <br><a name="habracut"></a><br>
<h2>  <font color="#3AC1EF">Plataforma Node.js</font> </h2><br>  Pensando en la plataforma Node.js, puede imaginar c√≥mo una determinada aplicaci√≥n, construida teniendo en cuenta las capacidades de esta plataforma para el procesamiento de datos as√≠ncrono, sirve de manera r√°pida y eficiente a cientos o miles de conexiones paralelas.  El servicio extrae los datos que necesita de todas partes y los procesa un poco para satisfacer las necesidades de una gran cantidad de clientes.  El propietario de dicha aplicaci√≥n no tiene motivos para quejarse, conf√≠a en el modelo ligero de procesamiento de datos simult√°neo que utiliza (en este material usamos la palabra "simult√°neo" para transmitir el t√©rmino "concurrente", para el t√©rmino "paralelo" - "paralelo").  Ella resuelve perfectamente la tarea establecida para ella. <br><br>  La representaci√≥n del lado del servidor (SSR) cambia las ideas b√°sicas que conducen a una visi√≥n similar del problema.  Por lo tanto, la representaci√≥n del servidor requiere muchos recursos inform√°ticos.  El c√≥digo en el entorno Node.js se ejecuta en un solo hilo, como resultado, para resolver problemas computacionales (a diferencia de las tareas de E / S), el c√≥digo se puede ejecutar simult√°neamente, pero no en paralelo.  La plataforma Node.js es capaz de manejar una gran cantidad de operaciones de E / S paralelas, sin embargo, cuando se trata de computaci√≥n, la situaci√≥n cambia. <br><br>  Dado que cuando se aplica la representaci√≥n del lado del servidor, la parte computacional de la tarea de procesamiento de solicitudes aumenta en comparaci√≥n con la parte relacionada con la entrada / salida, simult√°neamente las solicitudes entrantes afectar√°n la velocidad de respuesta del servidor debido al hecho de que compiten por los recursos del procesador.  Cabe se√±alar que cuando se utiliza la representaci√≥n asincr√≥nica, la competencia por los recursos todav√≠a est√° presente.  El renderizado asincr√≥nico resuelve la capacidad de respuesta de un proceso o navegador, pero no mejora la situaci√≥n con demoras o concurrencia.  En este art√≠culo, nos centraremos en un modelo simple que incluye exclusivamente cargas computacionales.  Si hablamos de una carga mixta, que incluye tanto operaciones de entrada / salida como de c√°lculo, las solicitudes entrantes simult√°neamente aumentar√°n el retraso, pero teniendo en cuenta la ventaja de un mayor rendimiento del sistema. <br><br>  Considere un comando de la forma <code>Promise.all([fn1, fn2])</code> .  Si <code>fn1</code> o <code>fn1</code> son promesas resueltas por el subsistema de E / S, entonces durante la ejecuci√≥n de este comando es posible lograr la ejecuci√≥n paralela de las operaciones.  Se ve as√≠: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/96e/6f8/d81/96e6f8d8187475775542576cabbc51ca.png"></div><br>  <i><font color="#999999">Ejecuci√≥n paralela de operaciones mediante el subsistema de entrada / salida.</font></i> <br><br>  Si <code>fn1</code> y <code>fn1</code> son tareas computacionales, se ejecutar√°n de la siguiente manera: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8e8/03d/803/8e803d80347cb302f3e86af0bbcd1e84.png"></div><br>  <i><font color="#999999">Tareas inform√°ticas</font></i> <br><br>  Una de las operaciones tendr√° que esperar la finalizaci√≥n de la segunda operaci√≥n, ya que solo hay un hilo en Node.js. <br><br>  En el caso de la representaci√≥n del servidor, este problema ocurre cuando el proceso del servidor tiene que procesar varias solicitudes simult√°neas.  El procesamiento de tales solicitudes se retrasar√° hasta que se procesen las solicitudes recibidas antes.  As√≠ es como se ve. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/135/03e/54f/13503e54f4aa44cd1481c0848e7406c7.png"></div><br>  <i><font color="#999999">Procesando solicitudes concurrentes</font></i> <br><br>  En la pr√°ctica, el procesamiento de solicitudes a menudo consta de muchas fases asincr√≥nicas, incluso si implican una carga computacional grave en el sistema.  Esto puede conducir a una situaci√≥n a√∫n m√°s dif√≠cil con la alternancia de tareas para procesar tales solicitudes. <br><br>  Supongamos que nuestras consultas est√°n compuestas por una cadena de tareas similar a esta: <code>renderPromise().then(out =&gt; formatResponsePromise(out)).then(body =&gt; res.send(body))</code> .  Cuando un par de solicitudes llega al sistema, con un peque√±o intervalo entre ellas, podemos observar la siguiente imagen. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/958/ecf/070/958ecf0704405b06a60e230631ac7730.png"></div><br>  <i><font color="#999999">Procesando solicitudes que llegan en un peque√±o intervalo, el problema de la lucha por los recursos del procesador</font></i> <br><br>  En este caso, se tarda aproximadamente el doble de tiempo en procesar cada solicitud que en procesar una solicitud individual.  Con un aumento en el n√∫mero de solicitudes procesadas simult√°neamente, la situaci√≥n empeora a√∫n m√°s. <br><br>  Adem√°s, uno de los objetivos t√≠picos de la implementaci√≥n de SSR es la capacidad de usar el mismo c√≥digo o un c√≥digo muy similar tanto en el cliente como en el servidor.  La seria diferencia entre estos entornos es que el entorno del cliente es esencialmente un entorno en el que opera un cliente, y los entornos de servidor, por su naturaleza, son entornos multicliente.  Lo que funciona bien en el cliente, como singletones u otros enfoques para almacenar el estado global de la aplicaci√≥n, conduce a errores, fugas de datos y, en general, a confusi√≥n, al procesar muchas solicitudes que llegan al servidor. <br><br>  Estas caracter√≠sticas se convierten en problemas en una situaci√≥n en la que necesita procesar m√∫ltiples solicitudes al mismo tiempo.  Todo funciona normalmente con cargas m√°s bajas en un entorno acogedor del entorno de desarrollo, que es utilizado por un cliente en la persona de un programador. <br><br>  Esto lleva a una situaci√≥n que es muy diferente de los ejemplos cl√°sicos de la aplicaci√≥n Node.js.  Cabe se√±alar que utilizamos el tiempo de ejecuci√≥n de JavaScript para el rico conjunto de bibliotecas disponibles en √©l, y debido al hecho de que es compatible con los navegadores, y no por el bien de su modelo para el procesamiento simult√°neo de datos.  En esta aplicaci√≥n, el modelo as√≠ncrono de procesamiento simult√°neo de datos demuestra todos sus inconvenientes, no compensados ‚Äã‚Äãpor las ventajas, que son muy pocas o ninguna. <br><br><h2>  <font color="#3AC1EF">Tutoriales del proyecto Hypernova</font> </h2><br>  Nuestro nuevo servicio de renderizado, Hyperloop, ser√° el servicio principal con el que interactuar√°n los usuarios de Airbnb.  Como resultado, su confiabilidad y rendimiento juegan un papel crucial para garantizar la conveniencia de trabajar con un recurso.  Cuando introducimos Hyperloop en producci√≥n, tenemos en cuenta la experiencia que obtuvimos al trabajar con nuestro sistema de renderizado de servidores anterior: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Hypernova</a> . <br><br>  Hypernova no funciona como nuestro nuevo servicio.  Este es un sistema de representaci√≥n puro.  Se llama desde nuestro servicio monol√≠tico Rail, llamado Monorail, y solo devuelve fragmentos de HTML para componentes renderizados espec√≠ficos.  En muchos casos, este "fragmento" representa la mayor parte de la p√°gina, y Rails proporciona solo el dise√±o de la p√°gina.  Con la tecnolog√≠a heredada, partes de una p√°gina se pueden vincular mediante ERB.  En cualquier caso, sin embargo, Hypernova no carga los datos necesarios para formar la p√°gina.  Esta es la tarea de Rails. <br><br>  Por lo tanto, Hyperloop e Hypernova tienen un rendimiento inform√°tico similar.  Al mismo tiempo, Hypernova, como servicio de producci√≥n y procesando vol√∫menes significativos de tr√°fico, proporciona un buen campo para las pruebas, lo que lleva a comprender c√≥mo se comportar√° el reemplazo de Hypernova en condiciones de combate. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/cee/51a/2f7/cee51a2f7e198d242ce8e5294f4e972f.png"></div><br>  <i><font color="#999999">Flujo de trabajo de Hypernova</font></i> <br><br>  As√≠ es como funciona Hypernova.  Las solicitudes de los usuarios llegan a nuestra aplicaci√≥n principal de Rails, Monorail, que recopila las propiedades de los componentes React que deben mostrarse en una p√°gina y realiza una solicitud a Hypernova, pasando estas propiedades y nombres de componentes.  Hypernova renderiza componentes con propiedades para generar el c√≥digo HTML que debe devolverse a la aplicaci√≥n Monorail, que luego incrusta este c√≥digo en la plantilla de p√°gina y lo env√≠a todo al cliente. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/86d/d7d/35b/86dd7d35b582f66de058a0aa60f5ad0a.png"></div><br>  <i><font color="#999999">Enviar una p√°gina terminada a un cliente</font></i> <br><br>  En el caso de una emergencia (esto podr√≠a ser un error o el tiempo de espera de respuesta) en Hypernova, hay una opci√≥n alternativa, cuando se usa que los componentes y sus propiedades se incrustan en la p√°gina sin el HTML generado en el servidor, despu√©s de lo cual todo esto se env√≠a al cliente y se procesa all√≠ con suerte exitoso.  Esto nos llev√≥ al hecho de que no consideramos que el servicio Hypernova sea una parte cr√≠tica del sistema.  Como resultado, podr√≠amos permitir la aparici√≥n de un cierto n√∫mero de fallas y situaciones en las que se activa un tiempo de espera.  Al ajustar los tiempos de espera de solicitud, nosotros, en base a las observaciones, los establecemos en aproximadamente el nivel P95.  Como resultado, no es sorprendente que el sistema haya funcionado con una tasa de respuesta de tiempo de espera base inferior al 5%. <br><br>  En situaciones en las que el tr√°fico alcanz√≥ valores m√°ximos, pudimos ver que hasta el 40% de las solicitudes a Hypernova se cerraron por tiempos de espera en Monorail.  En el lado de Hypernova, vimos picos de <code>BadRequestError: Request aborted</code> menor altura.  Estos errores, adem√°s, exist√≠an en condiciones normales, mientras que en la operaci√≥n normal, debido a la arquitectura de la soluci√≥n, los errores restantes no eran particularmente notables. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/746/8c1/192/7468c11924fcf883eb3a6e73c734a263.png"></div><br>  <i><font color="#999999">Valores de tiempo de espera m√°ximo (l√≠neas rojas)</font></i> <br><br>  Dado que nuestro sistema podr√≠a funcionar sin Hypernova, no prestamos mucha atenci√≥n a estas caracter√≠sticas, se percib√≠an m√°s como problemas insignificantes, en lugar de serios problemas.  Explicamos estos problemas por las caracter√≠sticas de la plataforma, porque el lanzamiento de la aplicaci√≥n es lento debido a la operaci√≥n de recolecci√≥n de basura inicial bastante dif√≠cil, debido a las peculiaridades de la compilaci√≥n de c√≥digo y el almacenamiento en cach√© de datos, y por otras razones.  Esper√°bamos que las nuevas versiones de React o Node incluir√≠an mejoras de rendimiento que mitigar√≠an las deficiencias del lento lanzamiento del servicio. <br><br>  Sospech√© que lo que estaba sucediendo era muy probablemente el resultado de un equilibrio de carga deficiente o la consecuencia de problemas en el despliegue de la soluci√≥n, cuando se manifestaron retrasos crecientes debido a una carga computacional excesiva en los procesos.  Agregu√© una capa auxiliar al sistema para registrar informaci√≥n sobre el n√∫mero de solicitudes procesadas simult√°neamente por procesos individuales, as√≠ como para registrar casos en los que el proceso recibi√≥ m√°s de una solicitud de procesamiento. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ce1/5c2/70c/ce15c270c4ccdcd301f40fad7312e769.png"></div><br>  <i><font color="#999999">Resultados de la investigaci√≥n</font></i> <br><br>  Consideramos que el inicio lento del servicio es el culpable de los retrasos, pero en realidad el problema fue causado por solicitudes paralelas que luchaban por el tiempo de CPU.  Seg√∫n los resultados de la medici√≥n, result√≥ que el tiempo empleado por la solicitud en anticipaci√≥n de la finalizaci√≥n del procesamiento de otras solicitudes corresponde al tiempo dedicado a procesar la solicitud.  Adem√°s, esto signific√≥ que un aumento en los retrasos debido al procesamiento simult√°neo de solicitudes se ve igual que un aumento en los retrasos debido a un aumento en la complejidad computacional del c√≥digo, lo que conduce a un aumento en la carga del sistema al procesar cada solicitud. <br><br>  Esto, adem√°s, hizo m√°s obvio que el <code>BadRequestError: Request aborted</code> no pod√≠a explicarse con confianza por un inicio lento del sistema.  El error procedi√≥ del c√≥digo de an√°lisis del cuerpo de la solicitud y ocurri√≥ cuando el cliente cancel√≥ la solicitud antes de que el servidor pudiera leer completamente el cuerpo de la solicitud.  El cliente dej√≥ de funcionar, cerr√≥ la conexi√≥n, priv√°ndonos de los datos necesarios para continuar procesando la solicitud.  Es mucho m√°s probable que esto ocurriera porque comenzamos a procesar la solicitud, despu√©s de eso el bucle de eventos result√≥ ser una representaci√≥n bloqueada para otra solicitud, y luego volvimos a la tarea interrumpida para completarla, pero como resultado result√≥ que el cliente quien nos envi√≥ esta solicitud ya se ha desconectado, cancelando la solicitud.  Adem√°s, los datos transmitidos en las solicitudes a Hypernova eran bastante voluminosos, en promedio, en la regi√≥n de varios cientos de kilobytes, y esto, por supuesto, no contribuy√≥ a mejorar la situaci√≥n. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0b4/b62/bc6/0b4b62bc6a1b5e902413711b0d3272e0.png"></div><br>  <i><font color="#999999">Un error causado al desconectar un cliente que no esper√≥ una respuesta</font></i> <br><br>  Decidimos abordar este problema utilizando un par de herramientas est√°ndar con las que ten√≠amos una experiencia considerable.  Estamos hablando de un servidor proxy inverso ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">nginx</a> ) y un equilibrador de carga ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">HAProxy</a> ). <br><br><h2>  <font color="#3AC1EF">Proxying inversa y equilibrio de carga</font> </h2><br>  Para aprovechar la arquitectura del procesador multin√∫cleo, ejecutamos varios procesos Hypernova utilizando el m√≥dulo de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">cl√∫ster</a> Node.js incorporado.  Dado que estos procesos son independientes, podemos procesar simult√°neamente las solicitudes entrantes. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/9df/cbe/aae/9dfcbeaae2d82fa13007670288d8b461.png"></div><br>  <i><font color="#999999">Procesamiento paralelo de solicitudes que llegan simult√°neamente</font></i> <br><br>  El problema aqu√≠ es que cada proceso de nodo est√° completamente ocupado todo el tiempo que lleva procesar una solicitud, incluida la lectura del cuerpo de la solicitud enviada desde el cliente (el monorra√≠l desempe√±a su papel en este caso).  Aunque podemos leer muchas consultas en un solo proceso al mismo tiempo, cuando se trata de renderizar, conduce a una alternancia de operaciones computacionales. <br><br>  El uso de los recursos del proceso Node est√° vinculado a la velocidad del cliente y de la red. <br><br>  Como soluci√≥n a este problema, podemos considerar un servidor proxy inverso de almacenamiento en b√∫fer, que nos permitir√° mantener sesiones de comunicaci√≥n con los clientes.  La inspiraci√≥n para esta idea fue el servidor web unicornio, que usamos para nuestras aplicaciones Rails.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Los principios</a> declarados por unicornio explican perfectamente por qu√© esto es as√≠.  Para este prop√≥sito utilizamos nginx.  Nginx lee la solicitud del cliente al b√∫fer y pasa la solicitud al servidor de nodo solo despu√©s de que se haya le√≠do completamente.  Esta sesi√≥n de transferencia de datos se realiza en la m√°quina local, a trav√©s de la interfaz de bucle invertido o usando sockets de dominio Unix, y esto es mucho m√°s r√°pido y m√°s confiable que transferir datos entre computadoras separadas. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a20/50e/77b/a2050e77b5ff48219773729978481244.png"></div><br>  <i><font color="#999999">Nginx guarda las solicitudes y luego las env√≠a al servidor Node</font></i> <br><br>  Debido al hecho de que nginx ahora se dedica a leer solicitudes, pudimos lograr una carga m√°s uniforme de los procesos Node. <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/bea/eb0/875/beaeb08758e4926cb3072670993f606f.png"></div><br>  <i><font color="#999999">Proceso uniforme de carga usando nginx</font></i> <br><br>  Adem√°s, utilizamos nginx para manejar algunas solicitudes que no requieren acceso a los procesos Node.  La capa de detecci√≥n y enrutamiento de nuestro servicio utiliza solicitudes <code>/ping</code> que no crean una gran carga en el sistema para verificar la comunicaci√≥n entre los hosts.  Procesar todo esto en nginx elimina una fuente significativa de carga de trabajo adicional (aunque peque√±a) para Node.js. <br><br>  La pr√≥xima mejora se refiere al equilibrio de carga.  Necesitamos tomar decisiones informadas sobre la distribuci√≥n de solicitudes entre procesos Node.  El m√≥dulo de <code>cluster</code> distribuye las solicitudes de acuerdo con el algoritmo round-robin, en la mayor√≠a de los casos con intentos de omitir los procesos que no responden a las solicitudes.  Con este enfoque, cada proceso recibe una solicitud en orden de prioridad. <br><br>  El m√≥dulo de <code>cluster</code> distribuye conexiones, no solicitudes, por lo que todo esto no funciona como lo necesitamos.  La situaci√≥n empeora a√∫n m√°s cuando se utilizan conexiones persistentes.  Cualquier conexi√≥n permanente del cliente est√° vinculada a un √∫nico flujo de trabajo espec√≠fico, lo que complica la distribuci√≥n eficiente de las tareas. <br><br>  El algoritmo round-robin es bueno cuando hay poca variabilidad en los retrasos de solicitud.  Por ejemplo, en la situaci√≥n ilustrada a continuaci√≥n. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/883/4f2/ed5/8834f2ed56f7410de5f306f15e66e5e9.png"></div><br>  <i><font color="#999999">Algoritmo de round-robin y conexiones a trav√©s de las cuales se reciben solicitudes de forma estable</font></i> <br><br>  Este algoritmo ya no es tan bueno cuando tiene que procesar solicitudes de diferentes tipos, para cuyo procesamiento pueden requerirse costos de tiempo completamente diferentes.  La solicitud m√°s reciente enviada a un proceso determinado se ve obligada a esperar la finalizaci√≥n del procesamiento de todas las solicitudes enviadas antes, incluso si hay otro proceso que tenga la capacidad de procesar dicha solicitud. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/037/381/8c8/0373818c8632668b96f2ae77c32c9be2.png"></div><br>  <i><font color="#999999">Carga de proceso desigual</font></i> <br><br>  Si distribuye las consultas que se muestran arriba de manera m√°s racional, obtendr√° algo como lo que se muestra en la figura a continuaci√≥n. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/944/8a3/b32/9448a3b328094d81d73480e6b0e9d6d6.png"></div><br>  <i><font color="#999999">Distribuci√≥n racional de solicitudes por hilos</font></i> <br><br>  Con este enfoque, la espera se minimiza y es posible enviar respuestas a las solicitudes m√°s r√°pido. <br><br>  Esto se puede lograr colocando solicitudes en una cola y asign√°ndolas a un proceso solo cuando no est√° ocupado procesando otra solicitud.  Para este prop√≥sito usamos HAProxy. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fda/2cc/367/fda2cc367f401ef351cad7bff55a13ea.png"></div><br>  <i><font color="#999999">HAProxy y balanceo de carga de proceso</font></i> <br><br>  Cuando utilizamos HAProxy para equilibrar la carga en Hypernova, eliminamos por completo los picos de tiempo de espera, as√≠ como los errores <code>BadRequestErrors</code> . <br><br>  Las solicitudes simult√°neas tambi√©n fueron la causa principal de demoras durante la operaci√≥n normal; este enfoque redujo tales demoras.  Una de las consecuencias de esto fue que ahora solo el 2% de las solicitudes se cerraron por tiempo de espera, y no el 5%, con la misma configuraci√≥n de tiempo de espera.  El hecho de que pudimos pasar de una situaci√≥n con un 40% de errores a una situaci√≥n con un tiempo de espera que se activa en el 2% de los casos mostr√≥ que nos estamos moviendo en la direcci√≥n correcta.  Como resultado, hoy nuestros usuarios ven la pantalla de carga del sitio web con mucha menos frecuencia.  Cabe se√±alar que la estabilidad del sistema ser√° de particular importancia para nosotros con la transici√≥n esperada a un nuevo sistema que no tiene el mismo mecanismo de respaldo que Hypernova. <br><br><h2>  <font color="#3AC1EF">Detalles sobre el sistema y su configuraci√≥n</font> </h2><br>  Para que todo esto funcione, debe configurar la aplicaci√≥n nginx, HAProxy y Node.  Aqu√≠ hay <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">un ejemplo de una</a> aplicaci√≥n similar que usa nginx y HAProxy, analizando cu√°l puede entender el dispositivo del sistema en cuesti√≥n.  Este ejemplo se basa en el sistema que utilizamos en producci√≥n, pero est√° simplificado y modificado para que pueda ejecutarse en primer plano en nombre de un usuario sin privilegios.  En producci√≥n, todo debe configurarse utilizando alg√∫n tipo de supervisor (usamos runit o, m√°s a menudo, kubernetes). <br><br>  <a href="">La configuraci√≥n nginx es</a> bastante est√°ndar, utiliza un servidor que escucha en el puerto 9000, configurado para las solicitudes de proxy al servidor HAProxy, que escucha en el puerto 9001 (en nuestra configuraci√≥n, usamos sockets de dominio Unix). <br><br>  Adem√°s, este servidor intercepta las solicitudes al punto final <code>/ping</code> para atender directamente las solicitudes destinadas a verificar la conectividad de la red.         nginx ,     <code>worker_processes</code>  1,     nginx ‚Äî           HAProxy  Node-.  ,       ,    ,  Hypernova,     ( ).             . <br><br>  Node.js <code>cluster</code>        .        HAProxy,        <code>cluster</code> ,    .        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">pool-hall</a> .  ‚Äî ,        ,   ,   <code>cluster</code> ,        .  <a href=""></a>   <code>pool-hall</code>     ,      . <br><br>  <a href=""> HAProxy</a> ,     9001       ,    9002  9005.     ‚Äî <code>maxconn 1</code> ,     .          .       HAProxy (    8999). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/232/d95/515/232d95515b1541bccfab440f8fe12cc8.png"></div><br> <i><font color="#999999">  HAProxy</font></i> <br><br> HAProxy            .    ,    <code>maxconn</code> .    <code>static-rr</code> (static round-robin),  ,  ,       .   ,      round-robin, ,        , ,   ,     .     ,          ,   .      . <br><br> ,       ,        .       (   ).         ,   ,     ,   ,     .  ,                   ,        . <br><br><h2> <font color="#3AC1EF">  HAProxy</font> </h2><br>         HAProxy.       ,         ,    ,               .  ,    ,    (  )   .      ,        ,    <code>cluster</code> .     ,    . <br><br>       <code>ab</code> (Apache Benchmark)   10000   .       -   .       : <br><br><pre> <code class="hljs powershell">ab <span class="hljs-literal"><span class="hljs-literal">-l</span></span> <span class="hljs-literal"><span class="hljs-literal">-c</span></span> &lt;CONCURRENCY&gt; <span class="hljs-literal"><span class="hljs-literal">-n</span></span> <span class="hljs-number"><span class="hljs-number">10000</span></span> http://&lt;HOSTNAME&gt;:<span class="hljs-number"><span class="hljs-number">9000</span></span>/render</code> </pre> <br>     15    4-  -,    <code>ab</code>     ,        .       ( <code>concurrency=5</code> ),    ( <code>concurrency=13</code> ),     ,        ( <code>concurrency=20</code> ).      ,      . <br><br>         ,  -,      .          ,      .       ,  ,   ,     ,       .  ,     ,       ,     . <br><br>    ,   ‚Äî      . <br><br>     <code>maxconn 1</code>     ,  ,         . <br><br>      HTTP  TCP  ,    ,     ,  .   ,      <code>maxconn</code> ,       .     ,            ,          (, ,    ). <br><br>  ,         , ,   ,  ,      ,       . <br><br>    ‚Äî  ,     .    <code>option redispatch</code>    <code>retries 3</code> ,    ,          ,   , ,    ,   .            . <br><br>     ,  - ,       .        ,       .   ,          ,     .     100    ,        10 ,    ,    .        ,      .   ,            <code>accept</code> . <br><br>      ,        ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">backlog</a> )    ,    .       SYN-ACK ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="></a> ,   , ,        ACK  ).      ,      ,     ,       ,      . <br><br>      ,   ,    ,   ,       .    ,       ,      1.   <code>maxconn</code>                .     0  ,   ,     ,  ,           ,     .       ,     .         -  ,      ,         .  <code>abortonclose</code>        ,    .  ,        <code>abortonclose</code> .            nginx. <br><br>  ,     ,    .       (    )   ,       ,        ,     ,       ,  .  HAProxy          ,      ,        (       ).               ,     ,         ,    HTML.          ,   ,       .  ,       ,       (     ,  ,     ).            ,   ,            .   ,  ,   ,  .           HAProxy,            MAINT    HAProxy. <br><br>   ,     ,   ,  <code>server.close</code>  Node.js    ,     HAProxy   ,       ,      ,      .     ,     ,       ,     ,   ,     . <br><br>  ,  ,    <code>balance first</code> ,           (   <code>worker1</code> )        15%   ,    ,   ,     <code>balance static-rr</code> .        ,       ¬´¬ª .      .     (12 ),  , , -      .   ,  ,       ,   ¬´¬ª     ¬´¬ª.        . <br><br> , ,      Node <code>server.maxconnections</code> , ( ,   ),   ,  ,   ,         .        ,    <code>maxconnection</code> ,      ,  ,    .     JavaScript,          (        ).  ,    ,        ,          .  ,     ,   ,      HAProxy  Node    ,       .     ,        ,         . <br><br>   ,      ,   , , <a href=""></a> . <br><br><h2> <font color="#3AC1EF"></font> </h2><br>     Node.js      .     , , ,    -.      Node.js    .   , ,       ,    ,   ,        , ,  nginx  HAProxy. <br><br> ,   Airbnb  ,   Node.js     . <br><br>  <b>Estimados lectores!</b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ¬øUtiliza renderizado del lado del servidor en sus proyectos? </font></font><br><br><div style="text-align:center;"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://habrastorage.org/files/1ba/550/d25/1ba550d25e8846ce8805de564da6aa63.png"></a> </div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es418009/">https://habr.com/ru/post/es418009/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es417997/index.html">Comience con usted mismo, o 60 d√≠as Kubuntu</a></li>
<li><a href="../es417999/index.html">Ingl√©s: Perspectiva del ingeniero</a></li>
<li><a href="../es418001/index.html">5 modelos de trabajo en equipo efectivo</a></li>
<li><a href="../es418005/index.html">Los desarrolladores de software no est√°n de acuerdo con la definici√≥n de "hardware especial" del FSB</a></li>
<li><a href="../es418007/index.html">Desarrollo multiplataforma con .NET, programaci√≥n reactiva, patr√≥n MVVM y generaci√≥n de c√≥digo</a></li>
<li><a href="../es418011/index.html">P√°ginas individuales y SEO. Secretos de optimizaci√≥n</a></li>
<li><a href="../es418013/index.html">El Intel Core i7-8086K (parte 3)</a></li>
<li><a href="../es418015/index.html">Nuevo Vasyuki. Desarrollo innovador de Mosc√∫ hasta 2100</a></li>
<li><a href="../es418017/index.html">An√°lisis del comportamiento del troyano Pegasus en la red.</a></li>
<li><a href="../es418023/index.html">Los punteros en C son m√°s abstractos de lo que piensas</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>