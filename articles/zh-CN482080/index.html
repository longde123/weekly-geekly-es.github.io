<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>❗️ 🙎🏼 🎹 Wi-Fi和LoRa之间的UDP网关 🐙 🐥 🎹</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="我们在Wi-Fi和LoRa之间建立UDP网关 





 我有一个儿时的梦想-为每个家庭“无Wi-Fi”设备提供一张网络票，即IP地址和端口。 一段时间后，我意识到我不应该推迟它。 我们必须采取行动。 
 职权范围 


 使它成为安装了LoRa模块的M5Stack网关（图1）。 网关将连接到Wi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Wi-Fi和LoRa之间的UDP网关</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/482080/"><h1 id="delaem-shlyuz-mezhdu-wi-fi-i-lora-dlya-udp"> 我们在Wi-Fi和LoRa之间建立UDP网关 </h1><br><p><img src="https://habrastorage.org/webt/7r/6w/qs/7r6wqsteous5ebxb2pjrlplmqbm.png"></p><br><p> 我有一个儿时的梦想-为每个家庭“无Wi-Fi”设备提供一张网络票，即IP地址和端口。 一段时间后，我意识到我不应该推迟它。 我们必须采取行动。 </p><br><h2 id="tehnicheskoe-zadanie"> 职权范围 </h2><br><p> 使它成为安装了LoRa模块的M5Stack网关（图1）。 网关将连接到Wi-Fi网络，在该网络中可通过DHCP获得本地IP地址。 网关将在LoRa-ether上以一定的频率（用于Wi-Fi的SSID模拟）和可接受端口的范围广播其名称，以便其他设备知道存在可以连接的网络以及可以在哪个范围内选择空闲端口。 由于这将是原型，因此这次不进行身份验证。 新的客户端设备将找到可用的LoRa网络并向其传输所选端口。 网关从新客户端收到端口后，将检查端口是否空闲，如果是，它将注册一个新客户端并开始在其自己的异步UDP服务器上侦听此端口。 注册后，客户将收到同意或拒绝使用声明的端口的信息。 操作步骤如表1所示。 </p><br><p><img src="https://habrastorage.org/webt/cz/am/ab/czamabsepozwcixjn0rdwe7hmw8.png"><br> 图1 </p><br><p> 表1 </p><br><div class="scrollable-table"><table><thead><tr><th> 侧面 </th><th> 方向和数据 </th><th> 侧面 </th><th> 会议 </th></tr></thead><tbody><tr><td>  [客户] </td><td>  &lt;-信标信号- </td><td>  [网关] </td><td>  0xA1 </td></tr><tr><td>  [客户] </td><td>  -选择的端口-&gt; </td><td>  [网关] </td><td>  0xB1 </td></tr><tr><td>  [客户] </td><td>  &lt;-同意或拒绝- </td><td>  [网关] </td><td>  0xA2 </td></tr><tr><td>  [客户] </td><td>  -UPD套件-&gt; </td><td>  [网关] </td><td>  0xB2 </td></tr><tr><td>  [客户] </td><td>  &lt;-UPD软件包- </td><td>  [网关] </td><td>  0xA3 </td></tr><tr><td>  [网络] </td><td>  &lt;-UPD软件包- </td><td>  [网关] </td><td>  0xC1 </td></tr></tbody></table></div><br><p> 摆在我面前的是M5Stack的各种模块，很无聊。 让我们来看看 <del> 和她一起玩 </del>  。 模块概念本身很漂亮！ 我能说什么 但是，我的第一个修订版的模块中，一个可怕的内置天线在柔性印刷电路板上制成，并粘在机壳的侧壁上。 我曾经对这些模块进行过现场测试（您可以在YouTube的俄语频道上观看）： </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/2mWAu6X_v-U" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p> 自然，我必须去除这些残留物并焊接Ra-01随附的标准螺旋形天线。 经过这样的定制后，通信范围明显改善，但出现了一个侧面问题-天线的直径大于模块之间的允许距离。 在项目期间，我不得不放弃最终模块。 </p><a name="habracut"></a><br><h2 id="pervye-trudnosti-ot-sihronnoy-tugosti"> 最初的困难 <del> 从共时的紧张感 </del></h2><br><p> 似乎采用<strong>WiFiUdp.h</strong>库，其中的所有内容都是为了使UDP服务器舒适地存在。 该库旨在提升一个同步服务器，不幸的是，该服务器无法同时服务于多个连接。 这样的库不适合当前任务。 我不得不喝很多杯茶，并且寻找一个可以使我们产生一个异步UDP服务器的库，该服务器能够同时支持许多连接。 发现了这样的库<strong>-AsyncUDP.h</strong> 。 同步服务器和异步服务器有什么区别？ 让我们看一下图2中的六个情节，其中琐碎地显示了套接字操作选项。 </p><br><p><img src="https://habrastorage.org/webt/fa/ay/fv/faayfvfxtqvi8nu5s_ks4ssbava.jpeg"></p><br><p> 图2 </p><br><p> 主演： </p><br><p>  <strong>一个</strong>扮演<strong>套筒</strong>角色的<strong>人</strong> ; </p><br><p>  <strong>鸽子</strong>在<strong>复合</strong>中的作用; </p><br><p>  <strong>Pismo</strong>作为<strong>数据</strong> 。 </p><br><h3 id="epizod-a-sinhronnyy-soket-bez-taymauta"> 情节A.没有超时的同步套接字 </h3><br><p> 一个人会一直站着，直到鸽子给他带来一封信。 </p><br><h3 id="epizod-b-sinhronnyy-soket-s-taymautom">  Episode B.带有超时的同步套接字 </h3><br><p> 一个人在等待鸽子同意的时间，如果他没有准时到达，那人将离开。 </p><br><h3 id="epizod-c-sinhronnyy-soket-s-mnogopotochnostyu"> 第C集：同步多线程套接字 </h3><br><p> 一个人在休息室休息，看着鸽子自己发信。 </p><br><h3 id="epizod-d-asinhronnyy-soket-kogda-nechego-eschyo-poluchat"> 第D集：异步套接字（没有其他可接收的内容） </h3><br><p> 一个人会做自己喜欢的事情，但不会忘记鸽子。 </p><br><h3 id="epizod-e-asinhronnyy-soket-kogda-est-chto-poluchit"> 第E集：异步套接字（当有东西要接收时） </h3><br><p> 那人短暂地专心于事务，收到了鸽子的来信。 </p><br><h3 id="epizod-f-asinhronnyy-soket-s-mnogopotochnostyu"> 第F集：异步多线程套接字 </h3><br><p> 一个人去做生意，看着鸽子自己发信。 </p><br><p> 如果小心的话，您可能应该已经注意到，每集鸽子的项圈都有一定的颜色。 这绝非偶然。 在第A集和第B集中，服务器上只能使用一个插座，仅此而已。 第C集已经有两个插槽。 第D，E和F集已经有三个插槽。  “为什么有两个，但这里有三个？”  -你问。 这是有条件的2和3，实际上是2，而不是2，可以是20，而不是3，是200。任务是证明异步套接字不像同步套接字那样消耗铁。 </p><br><h2 id="kuda-skolko-chego-vmeschaetsya"> 什么地方合适？ </h2><br><p> 让我们看一下表1，该表显示了UDP数据包的结构，并考虑了可以采取的措施。 </p><br><p> 表1. UDP数据包结构 </p><br><div class="scrollable-table"><table><thead><tr><th> 位 </th><th>  0-15 </th><th>  16-31 </th></tr></thead><tbody><tr><td>  0-31 </td><td> 源端口 </td><td> 目的端口 </td></tr><tr><td>  32-63 </td><td> 数据报长度 </td><td> 校验和 </td></tr><tr><td>  64 -... </td><td> 资料 </td><td></td></tr></tbody></table></div><br><p> 在此表的开头添加另一个“ <strong>会话”</strong>字段（1个字节）。 这对于这个项目就足够了。 根据会话，设备将知道接下来如何处理程序包。 现在，我们将为这些会话提供代码，并将它们写在表2中。 </p><br><p> 表2.会话描述 </p><br><div class="scrollable-table"><table><thead><tr><th> 代号 </th><th> 职称 </th><th> 解说 </th></tr></thead><tbody><tr><td>  0xA1 </td><td> 灯塔 </td><td> 网关以一定频率广播LoRa网络的名称和允许的端口范围。 这是必要的，以便新客户端看到可用的网络，并且当前客户端在没有传输时可以确定信号级别。 </td></tr><tr><td>  0xB1 </td><td> 申请书 </td><td> 客户端找到网络后，它将发送首选端口。 </td></tr><tr><td>  0xA2 </td><td> 同意或拒绝 </td><td> 如果客户端请求的端口是空闲的，则服务器将以同意的方式进行响应，否则以拒绝的方式进行响应。 </td></tr><tr><td>  0xB2 </td><td> 上链 </td><td> 客户端将UDP数据包发送到网关时。 </td></tr><tr><td>  0xA3 </td><td> 下行链接 </td><td> 网关何时将UDP数据包发送到客户端。 </td></tr><tr><td>  0xC1 </td><td> 继续上行 </td><td> 网关向本地网络发送UDP数据包时。 </td></tr></tbody></table></div><br><p> 好啊 现在让我们讨论表3中的会话组成。 </p><br><p> 表3.会话 </p><br><div class="scrollable-table"><table><thead><tr><th> 会话名称 </th><th> 组成 </th></tr></thead><tbody><tr><td> 灯塔 </td><td> 会话代码（1字节）+ LoRa网络名称（4字节）+起始端口（2字节）+结束端口（2字节） </td></tr><tr><td> 申请书 </td><td> 传输码（1字节）+ LoRa网络名称（4字节）+首选端口（2字节） </td></tr><tr><td> 同意或拒绝 </td><td> 传输码（1字节）+ LoRa网络名称（4字节）+首选端口（2字节）+结果（1字节） </td></tr><tr><td> 上链 </td><td> 传输代码（1字节）+ LoRa网络名称（4字节）+远程IP地址（4字节）+远程端口（2字节）+本地IP地址（4字节）+本地端口（2字节）+数据大小（2字节）+数据 </td></tr><tr><td> 下行链接 </td><td> 传输代码（1字节）+ LoRa网络名称（4字节）+远程IP地址（4字节）+远程端口（2字节）+本地IP地址（4字节）+本地端口（2字节）+数据大小（2字节）+数据 </td></tr><tr><td> 继续上行 </td><td> 远程IP地址（4字节）+远程端口（2字节）+数据大小（2字节）+数据 </td></tr></tbody></table></div><br><p> 为Arduino和M5Stack编写了两个客户端。 您可以在<a href="https://youtu.be/g4aHpgWcJnY" rel="nofollow">视频中</a>看到它的工作原理。 公寓内没有问题，我尚未进行现场测试。 </p><br><p> 源代码可在GitHub上找到： </p><br><p> 了解有关M5Stack基本单元的更多信息，并在<a href="http://ru.m5stack.com/%3Fsearch%3D%25D0%25BA%25D0%25BB%25D0%25B0%25D1%2581%25D1%2581%25D0%25B8%25D1%2587%25D0%25B5%25D1%2581%25D0%25BA%25D0%25B8%25D0%25B9" rel="nofollow">此处</a>购买<a href="http://ru.m5stack.com/%3Fsearch%3D%25D0%25BA%25D0%25BB%25D0%25B0%25D1%2581%25D1%2581%25D0%25B8%25D1%2587%25D0%25B5%25D1%2581%25D0%25BA%25D0%25B8%25D0%25B9" rel="nofollow">。</a> </p><br><p> 您可以<a href="http://ru.m5stack.com/%3Fsearch%3Dlora" rel="nofollow">在此处</a>为基本单元选择LoRa无线模块 </p><br><p>  <strong>如果这个项目对您有用，我会很高兴。</strong>  <strong>非常感谢您的宝贵时间！</strong> </p><br><p> 参考和（或）资料来源： </p><br><ul><li>  <a href="https://qna.habr.com/q/388343" rel="nofollow">Habr问答“什么是异步套接字？”</a> </li><li>  <a href="https://ru.wikipedia.org/wiki/UDP" rel="nofollow">维基百科“ UDP”</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN482080/">https://habr.com/ru/post/zh-CN482080/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN482066/index.html">用工作故事替换用户故事</a></li>
<li><a href="../zh-CN482068/index.html">我是否需要从SSD创建RAID阵列以及为此需要哪些控制器</a></li>
<li><a href="../zh-CN482070/index.html">五个有助于维持大脑表现的习惯</a></li>
<li><a href="../zh-CN482076/index.html">客户，信任asoshnikov</a></li>
<li><a href="../zh-CN482078/index.html">IT项目和IT团队的风险</a></li>
<li><a href="../zh-CN482084/index.html">假期读什么</a></li>
<li><a href="../zh-CN482086/index.html">引导程序分析</a></li>
<li><a href="../zh-CN482088/index.html">拥抱开发人员，或者我如何去KotlinConf</a></li>
<li><a href="../zh-CN482094/index.html">软件架构师：为什么需要它，什么是诅咒</a></li>
<li><a href="../zh-CN482096/index.html">VR和创造力：Dell Precision工作站如何帮助英国设计研究生院的学生</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>