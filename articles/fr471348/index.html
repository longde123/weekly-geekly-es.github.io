<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üö¥üèª üåµ ü•™ Applications TypeScript √† pile compl√®te ‚è∏Ô∏è üññüèª ü•ä</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, Habr! Je vous pr√©sente la traduction de l'article "Full Type Stack TypeScript Apps - Part 1: Developing Backend APIs with Nest.js" par Ana Ri...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Applications TypeScript √† pile compl√®te</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/471348/"><p>  Bonjour, Habr!  Je vous pr√©sente la traduction de l'article <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">"Full Type Stack TypeScript Apps - Part 1: Developing Backend APIs with Nest.js"</a> par <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Ana Ribeiro</a> . </p><br><h2 id="chast-1-razrabotka-servernogo-api-s-pomoschyu-nestjs">  Partie 1: D√©veloppement de l'API serveur √† l'aide de Nest.JS </h2><br><p>  TL; DR: il s'agit d'une s√©rie d'articles sur la cr√©ation d'une application Web TypeScript √† l'aide d'Angular et de Nest.JS.  Dans la premi√®re partie, nous √©crirons une simple API serveur utilisant Nest.JS.  La deuxi√®me partie de cette s√©rie est consacr√©e √† l'application frontale utilisant Angular.  Vous pouvez trouver le code final d√©velopp√© dans cet article dans ce <a href="">r√©f√©rentiel GitHub.</a> </p><br><h3 id="chto-takoe-nestjs-i-pochemu-imenno-angular">  Qu'est-ce que Nest.Js et pourquoi Angular? </h3><br><p>  Nest.js est un cadre pour la cr√©ation d'applications de serveur Web Node.js. </p><br><p>  Une particularit√© est qu'il r√©sout un probl√®me qu'aucun autre framework ne r√©sout: la structure du projet node.js. <a name="habracut"></a>  Si vous avez d√©j√† d√©velopp√© sous node.js, vous savez que vous pouvez faire beaucoup avec un seul module (par exemple, le middleware Express peut tout faire, de l'authentification √† la validation), ce qui peut finalement conduire √† un "g√¢chis" non pris en charge .  Comme vous le verrez ci-dessous, nest.js nous aidera √† cela en fournissant des classes sp√©cialis√©es dans divers probl√®mes. </p><br><p>  Nest.js est fortement inspir√© par Angular.  Par exemple <cut></cut>  les deux plates-formes utilisent des gardes pour autoriser ou emp√™cher l'acc√®s √† certaines parties de vos applications, et les deux plates-formes fournissent une interface CanActivate pour impl√©menter ces gardes.  Cependant, il est important de noter que, malgr√© certains concepts similaires, les deux structures sont ind√©pendantes l'une de l'autre.  Autrement dit, dans cet article, nous allons cr√©er une API ind√©pendante pour notre front-end, qui peut √™tre utilis√©e avec n'importe quel autre framework (React, Vue.JS et ainsi de suite). </p><br><h3 id="veb-prilozhenie-dlya-on-layn-zakazov">  Application Web pour les commandes en ligne </h3><br><p>  Dans ce guide, nous allons cr√©er une application simple dans laquelle les utilisateurs peuvent passer des commandes dans un restaurant.  Il impl√©mentera cette logique: </p><br><ul><li>  tout utilisateur peut afficher le menu; </li><li>  seul un utilisateur autoris√© peut ajouter des marchandises au panier (passer une commande) </li><li>  seul l'administrateur peut ajouter de nouveaux √©l√©ments de menu. </li></ul><br><p>  Par souci de simplicit√©, nous n'interagirons pas avec une base de donn√©es externe et n'impl√©menterons pas la fonctionnalit√© de notre panier. </p><cut></cut><br><h3 id="sozdanie-faylovoy-struktury-proekta-nestjs">  Cr√©ation de la structure de fichiers du projet Nest.js </h3><br><p>  Pour installer Nest.js, nous devons installer Node.js (v.8.9.x ou sup√©rieur) et NPM.  T√©l√©chargez et installez Node.js pour votre syst√®me d'exploitation √† partir du site Web officiel (NPM est inclus).  Une fois tout install√©, v√©rifiez les versions: </p><br><pre><code class="bash hljs">node -v <span class="hljs-comment"><span class="hljs-comment"># v12.11.1 npm -v # 6.11.3</span></span></code> </pre> <br><p>  Il existe diff√©rentes fa√ßons de cr√©er un projet avec Nest.js;  ils se trouvent dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation</a> .  Nous utiliserons <code>nest-cli</code> .  Installez-le: </p><br><p> <code>npm i -g @nestjs/cli</code> </p> <br><p>  Ensuite, cr√©ez notre projet avec une simple commande: </p><br><p> <code>nest new nest-restaurant-api</code> </p> <br><p>  dans le processus, nest nous demandera de choisir un gestionnaire de paquets: <code>npm</code> ou <code>yarn</code> </p><br><p>  Si tout s'est bien pass√©, <code>nest</code> cr√©era la structure de fichiers suivante: </p><br><pre> <code class="plaintext hljs">nest-restaurant-api ‚îú‚îÄ‚îÄ src ‚îÇ ‚îú‚îÄ‚îÄ app.controller.spec.ts ‚îÇ ‚îú‚îÄ‚îÄ app.controller.ts ‚îÇ ‚îú‚îÄ‚îÄ app.module.ts ‚îÇ ‚îú‚îÄ‚îÄ app.service.ts ‚îÇ ‚îî‚îÄ‚îÄ main.ts ‚îú‚îÄ‚îÄ test ‚îÇ ‚îú‚îÄ‚îÄ app.e2e-spec.ts ‚îÇ ‚îî‚îÄ‚îÄ jest-e2e.json ‚îú‚îÄ‚îÄ .gitignore ‚îú‚îÄ‚îÄ .prettierrc ‚îú‚îÄ‚îÄ nest-cli.json ‚îú‚îÄ‚îÄ package.json ‚îú‚îÄ‚îÄ package-lock.json ‚îú‚îÄ‚îÄ README.md ‚îú‚îÄ‚îÄ tsconfig.build.json ‚îú‚îÄ‚îÄ tsconfig.json ‚îî‚îÄ‚îÄ tslint.json</code> </pre> <br><p>  allez dans le r√©pertoire cr√©√© et d√©marrez le serveur de d√©veloppement: </p><br><pre> <code class="bash hljs"> <span class="hljs-comment"><span class="hljs-comment">#    cd nest-restaurant-api #   npm run start:dev</span></span></code> </pre> <br><p>  Ouvrez un navigateur et entrez <code>http://localhost:3000</code> .  Sur l'√©cran, nous verrons: <br><img src="https://habrastorage.org/webt/xl/pk/tl/xlpktlb_nkwfh6-akeba7wtnmjc.png"></p><br><p>  Dans le cadre de ce didacticiel, nous ne testerons pas notre API (bien que vous deviez √©crire des tests pour toute application pr√™te √† l'emploi).  De cette fa√ßon, vous pouvez effacer le r√©pertoire de <code>test</code> et supprimer le <code>src/app.controller.spec.ts</code> (qui est celui de test).  Par cons√©quent, notre dossier source contient les fichiers suivants: </p><br><ul><li>  <code>src/app.controller.ts</code> et <code>src/app.module.ts</code> : ces fichiers sont responsables de la cr√©ation <code>Hello world</code> message <code>Hello world</code> long de la route <code>/</code> .  Parce que  ce point d'entr√©e n'est pas important pour cette application nous les supprimons.  Bient√¥t, vous apprendrez plus en d√©tail ce que sont les <strong>contr√¥leurs</strong> et les <strong>services</strong> . </li><li>  <code>src/app.module.ts</code> : contient une description d'une classe de type <strong>module</strong> , qui est charg√©e de d√©clarer l'importation, l'exportation des contr√¥leurs et des fournisseurs vers l'application nest.js.  Chaque application a au moins un module, mais vous pouvez cr√©er plus d'un module pour des applications plus complexes (plus dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation</a> . Notre application ne contiendra qu'un seul module </li><li>  <code>src/main.ts</code> : c'est le fichier responsable du d√©marrage du serveur. </li></ul><br><blockquote><cut text=""></cut>  Remarque: apr√®s avoir supprim√© <code>src/app.controller.ts</code> et <code>src/app.module.ts</code> vous ne pourrez pas d√©marrer notre application.  Ne vous inqui√©tez pas, nous allons le r√©parer bient√¥t </blockquote><br><h3 id="sozdanie-tochek-vhoda-endpoints">  Cr√©er des points d'entr√©e (points d'extr√©mit√©) </h3><br><br><p>  Notre API sera disponible sur la route <code>/items</code> .  Ce point d'entr√©e permet aux utilisateurs de recevoir des donn√©es et aux administrateurs de g√©rer le menu.  Cr√©ons-le. </p><br><p>  Pour ce faire, cr√©ez un r√©pertoire appel√© <code>items</code> dans <code>src</code> .  Tous les fichiers associ√©s √† la route <code>/items</code> seront stock√©s dans ce nouveau r√©pertoire. </p><br><h4 id="sozdanie-kontrollerov">  Cr√©ation de contr√¥leurs </h4><br><p>  dans <code>nest.js</code> , comme dans de nombreux autres frameworks, les contr√¥leurs sont responsables du mappage des routes avec des fonctionnalit√©s.  Pour cr√©er un contr√¥leur dans <code>nest.js</code> utilisez le d√©corateur <code>nest.js</code> comme suit: <code>@Controller(${ENDPOINT})</code> .  De plus, afin de mapper diverses m√©thodes <code>HTTP</code> , telles que <code>GET</code> et <code>POST</code> , des d√©corateurs <code>@Get</code> , <code>@Post</code> , <code>@Delete</code> , etc. sont utilis√©s. </p><br><p>  Dans notre cas, nous devons cr√©er un contr√¥leur qui retourne les plats disponibles dans le restaurant et que les administrateurs utiliseront pour g√©rer le contenu du menu.  Cr√©ons un fichier appel√© <code>items.controller.tc</code> dans le r√©pertoire <code>src/items</code> avec le contenu suivant: </p><br><pre> <code class="plaintext hljs"> import { Get, Post, Controller } from '@nestjs/common'; @Controller('items') export class ItemsController { @Get() async findAll(): Promise&lt;string[]&gt; { return ['Pizza', 'Coke']; } @Post() async create() { return 'Not yet implemented'; } }</code> </pre> <br><p>  afin de rendre notre nouveau contr√¥leur disponible dans notre application, enregistrez-le dans le module: </p><br><pre> <code class="plaintext hljs"> import { Module } from '@nestjs/common'; import { ItemsController } from './items/items.controller'; @Module({ imports: [], controllers: [ItemsController], providers: [], }) export class AppModule {}</code> </pre> <br><p>  Lancez notre application: <code>npm run start:dev</code> et ouvrez dans le navigateur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">http: // localhost: 3000 / items</a> , si vous avez tout fait correctement, alors nous devrions voir la r√©ponse √† notre demande get: <code>['Pizza', 'Coke']</code> . </p><br><p>  <em>Note du traducteur: pour cr√©er de nouveaux contr√¥leurs, ainsi que d'autres √©l√©ments de <code>nest.js</code> : services, fournisseurs, etc., il est plus pratique d'utiliser la commande <code>nest generate</code> du <code>nest-cli</code> .</em>  <em>Par exemple, pour cr√©er le contr√¥leur d√©crit ci-dessus, vous pouvez utiliser la commande <code>nest generate controller items</code> , √† la suite de quoi nest cr√©era les <code>src/items/items.controller.tc</code> <code>src/items/items.controller.spec.tc</code> et <code>src/items/items.controller.tc</code> contenu suivant:</em> </p><br><pre> <code class="plaintext hljs"> import { Get, Post, Controller } from '@nestjs/common'; @Controller('items') export class ItemsController {}</code> </pre> <br><p>  <em>et enregistrez-le dans <code>app.molule.tc</code></em> </p><br><h4 id="dobavlenie-servisa-service">  Ajout d'un service </h4><br><p>  Maintenant, lors de l'acc√®s √† <code>/items</code> notre application renvoie le m√™me tableau pour chaque demande, que nous ne pouvons pas changer.  Le traitement et la sauvegarde des donn√©es ne sont pas l'affaire du contr√¥leur; √† cet effet, les services sont destin√©s √† nest.js <br>  Les services dans nest sont des <code>@Injectable</code> <br>  Le nom du d√©corateur parle de lui-m√™me, l'ajout de ce d√©corateur √† la classe le rend injectable dans d'autres composants, tels que les contr√¥leurs. <br>  Cr√©ons notre service.  Cr√©ez le fichier <code>items.service.ts</code> dans le dossier <code>items.service.ts</code> avec le contenu suivant: </p><br><pre> <code class="plaintext hljs"> import { Injectable } from '@nestjs/common'; @Injectable() export class ItemsService { private readonly items: string[] = ['Pizza', 'Coke']; findAll(): string[] { return this.items; } create(item: string) { this.items.push(item); } }</code> </pre> <br><p>  et changez le contr√¥leur <code>ItemsController</code> (d√©clar√© dans <code>items.controller.ts</code> ) pour utiliser notre service: </p><br><pre> <code class="plaintext hljs"> import { Get, Post, Body, Controller } from '@nestjs/common'; import { ItemsService } from './items.service'; @Controller('items') export class ItemsController { constructor(private readonly itemsService: ItemsService) {} @Get() async findAll(): Promise&lt;string[]&gt; { return this.itemsService.findAll(); } @Post() async create(@Body() item: string) { this.itemsService.create(item); } }</code> </pre> <br><p>  Dans la nouvelle version du contr√¥leur, nous avons appliqu√© le d√©corateur <code>@Body</code> √† l'argument de m√©thode <code>create</code> .  Cet argument est utilis√© pour faire correspondre automatiquement les donn√©es transmises via <code>req.body ['item']</code> √† l'argument lui-m√™me (dans ce cas, <code>item</code> ). <br>  Notre contr√¥leur re√ßoit √©galement une instance de la classe <code>ItemsService</code> , inject√©e via le constructeur.  D√©clarer <code>ItemsService</code> comme <code>private readonly</code> rend une instance immuable et visible uniquement √† l'int√©rieur de la classe. <br>  Et n'oubliez pas d'enregistrer notre service dans <code>app.module.ts</code> : </p><br><pre> <code class="plaintext hljs"> import { Module } from '@nestjs/common'; import { ItemsController } from './items/items.controller'; import { ItemsService } from './items/items.service'; @Module({ imports: [], controllers: [ItemsController], providers: [ItemsService], }) export class AppModule {}</code> </pre> <br><p>  Apr√®s toutes les modifications, envoyons une demande HTTP POST au menu: </p><br><pre> <code class="bash hljs"> curl -X POST -H <span class="hljs-string"><span class="hljs-string">'content-type: application/json'</span></span> -d <span class="hljs-string"><span class="hljs-string">'{"item": "Salad"}'</span></span> localhost:3000/items</code> </pre> <br><p>  Ensuite, nous v√©rifierons si de nouveaux plats sont apparus dans notre menu en faisant une demande GET (ou en ouvrant <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">http: // localhost: 3000 / items</a> dans un navigateur) </p><br><pre> <code class="bash hljs"> curl localhost:3000/items</code> </pre> <br><h4 id="sozdanie-marshruta-dlya-korziny-pokupok">  Cr√©ation d'un itin√©raire de panier d'achat </h4><br><p>  Maintenant que nous avons la premi√®re version du point d'entr√©e <code>/items</code> notre API, impl√©mentons la fonctionnalit√© de panier.  Le processus de cr√©ation de cette fonctionnalit√© n'est pas tr√®s diff√©rent de l'API d√©j√† cr√©√©e.  Par cons√©quent, afin de ne pas encombrer le manuel, nous allons cr√©er un composant qui r√©pond avec un statut OK lors de l'acc√®s. </p><br><p>  Tout d'abord, dans le dossier <code>./src/shopping-cart/</code> cr√©ez le <code>shoping-cart.controller.ts</code> : </p><br><pre> <code class="plaintext hljs"> import { Post, Controller } from '@nestjs/common'; @Controller('shopping-cart') export class ShoppingCartController { @Post() async addItem() { return 'This is a fake service :D'; } }</code> </pre> <br><p>  Enregistrez ce contr√¥leur dans notre module ( <code>app.module.ts</code> ): </p><br><pre> <code class="plaintext hljs"> import { Module } from '@nestjs/common'; import { ItemsController } from './items/items.controller'; import { ShoppingCartController } from './shopping-cart/shopping-cart.controller'; import { ItemsService } from './items/items.service'; @Module({ imports: [], controllers: [ItemsController, ShoppingCartController], providers: [ItemsService], }) export class AppModule {}</code> </pre> <br><p>  Pour v√©rifier ce point d'entr√©e, ex√©cutez la commande suivante, apr√®s vous √™tre assur√© que l'application est en cours d'ex√©cution: </p><br><pre> <code class="bash hljs"> curl -X POST localhost:3000/shopping-cart</code> </pre> <br><h4 id="dobavlenie-opisaniya--interface-typescript-dlya-items">  Ajout d'un script d'interface pour les √©l√©ments </h4><br><p>  Retour √† notre service d' <code>items</code> .  Maintenant, nous enregistrons uniquement le nom du plat, mais ce n'est clairement pas suffisant, et, bien s√ªr, nous voudrons avoir plus d'informations (par exemple, le co√ªt du plat).  Je pense que vous conviendrez que le stockage de ces donn√©es sous forme de tableau de cha√Ænes n'est pas une bonne id√©e? <br>  Pour r√©soudre ce probl√®me, nous pouvons cr√©er un tableau d'objets.  Mais comment sauvegarder la structure des objets?  Ici, l'interface TypeScript nous aidera, dans laquelle nous d√©finirons la structure de l'objet <code>items</code> .  Cr√©ez un nouveau fichier nomm√© <code>item.interface.ts</code> dans le dossier <code>src/items</code> : </p><br><pre> <code class="plaintext hljs"> export interface Items { readonly name: string; readonly price: number; }</code> </pre> <br><p>  <code>items.service.ts</code> ensuite <code>items.service.ts</code> fichier <code>items.service.ts</code> : </p><br><pre> <code class="plaintext hljs">import { Injectable } from '@nestjs/common'; import { Item } from './item.interface'; @Injectable() export class ItemsService { private readonly items: Item[] = []; findAll(): Item[] { return this.items; } create(item: Item) { this.items.push(item); } }</code> </pre> <br><p>  Et aussi dans <code>items.controller.ts</code> : </p><br><pre> <code class="plaintext hljs">import { Get, Post, Body, Controller } from '@nestjs/common'; import { ItemsService } from './items.service'; import { Item } from './item.interface'; @Controller('items') export class ItemsController { constructor(private readonly itemsService: ItemsService) {} @Get() async findAll(): Promise&lt;Item[]&gt; { return this.itemsService.findAll(); } @Post() async create(@Body() item: Item) { this.itemsService.create(item); } }</code> </pre> <br><h4 id="validaciya-vhodnyh-dannyh-v-nestjs">  Validation de l'entr√©e dans Nest.js </h4><br><p>  Malgr√© le fait que nous ayons d√©termin√© la structure de l'objet <code>item</code> , notre application ne retournera pas d'erreur si nous envoyons une requ√™te POST invalide (tout type de donn√©es non d√©fini dans l'interface).  Par exemple, pour une telle demande: </p><br><pre> <code class="bash hljs"> curl -H <span class="hljs-string"><span class="hljs-string">'Content-Type: application/json'</span></span> -d <span class="hljs-string"><span class="hljs-string">'{ "name": 3, "price": "any" }'</span></span> http://localhost:3000/items</code> </pre> <br><p>  le serveur doit r√©pondre avec un √©tat de 400 (mauvaise demande), mais √† la place, notre application r√©pondra avec un √©tat de 200 (OK). </p><br><p>  Pour r√©soudre ce probl√®me, cr√©ez un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">DTO (Data Transfer Object)</a> et un composant Pipe (canal). </p><br><p>  DTO est un objet qui d√©finit comment les donn√©es doivent √™tre transf√©r√©es entre les processus.  Nous d√©crivons le DTO dans le <code>src/items/create-item.dto.ts</code> : </p><br><pre> <code class="plaintext hljs"> import { IsString, IsInt } from 'class-validator'; export class CreateItemDto { @IsString() readonly name: string; @IsInt() readonly price: number; }</code> </pre> <br><p>  Les tuyaux dans <code>Nest.js</code> sont les composants utilis√©s pour la validation.  Pour notre API, cr√©ez un canal dans lequel il v√©rifie si les donn√©es envoy√©es √† la m√©thode correspondent au DTO.  Un canal peut √™tre utilis√© par diff√©rents contr√¥leurs, alors cr√©ez le r√©pertoire <code>src/common/</code> avec le fichier <code>validation.pipe.ts</code> : </p><br><pre> <code class="plaintext hljs"> import { ArgumentMetadata, BadRequestException, Injectable, PipeTransform, } from '@nestjs/common'; import { validate } from 'class-validator'; import { plainToClass } from 'class-transformer'; @Injectable() export class ValidationPipe implements PipeTransform&lt;any&gt; { async transform(value, metadata: ArgumentMetadata) { const { metatype } = metadata; if (!metatype || !this.toValidate(metatype)) { return value; } const object = plainToClass(metatype, value); const errors = await validate(object); if (errors.length &gt; 0) { throw new BadRequestException('Validation failed'); } return value; } private toValidate(metatype): boolean { const types = [String, Boolean, Number, Array, Object]; return !types.find(type =&gt; metatype === type); } }</code> </pre> <br><blockquote>  Remarque: Nous devons installer deux modules: <code>class-validator</code> <code>class-transformer</code> .  Pour ce faire, ex√©cutez <code>npm install class-validator class-transformer</code> dans la console et red√©marrez le serveur. </blockquote><p>  Adaptation de <code>items.controller.ts</code> pour une utilisation avec notre nouveau tube et DTO: </p><br><pre> <code class="plaintext hljs"> import { Get, Post, Body, Controller, UsePipes } from '@nestjs/common'; import { CreateItemDto } from './create-item.dto'; import { ItemsService } from './items.service'; import { Item } from './item.interface'; import { ValidationPipe } from '../common/validation.pipe'; @Controller('items') export class ItemsController { constructor(private readonly itemsService: ItemsService) {} @Get() async findAll(): Promise&lt;Item[]&gt; { return this.itemsService.findAll(); } @Post() @UsePipes(new ValidationPipe()) async create(@Body() createItemDto: CreateItemDto) { this.itemsService.create(createItemDto); } }</code> </pre> <br><p>  V√©rifions √† nouveau notre code, maintenant l'entr√©e <code>/items</code> n'accepte les donn√©es que si elles sont d√©finies dans le DTO.  Par exemple: </p><br><pre> <code class="bash hljs"> curl -H <span class="hljs-string"><span class="hljs-string">'Content-Type: application/json'</span></span> -d <span class="hljs-string"><span class="hljs-string">'{ "name": "Salad", "price": 3 }'</span></span> http://localhost:3000/items</code> </pre> <br><p>  Collez des donn√©es non valides (donn√©es qui ne peuvent pas √™tre v√©rifi√©es dans <code>ValidationPipe</code> ), par cons√©quent, nous obtenons la r√©ponse: </p><br><pre> <code class="plaintext hljs"> {"statusCode":400,"error":"Bad Request","message":"Validation failed"}</code> </pre> <br><h5 id="sozdanie-middleware">  Cr√©ation de middleware </h5><br><p>  Selon <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">la page du guide de d√©marrage rapide Auth0</a> , la m√©thode recommand√©e pour v√©rifier le jeton JWT √©mis par Auth0 consiste √† utiliser le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">middleware Express</a> fourni par <code>express-jwt</code> .  Ce middleware automatise une grande partie du travail. </p><br><p>  Cr√©ons un fichier <code>authentication.middleware.ts</code> dans le r√©pertoire <code>src / common</code> avec le code suivant: </p><br><pre> <code class="plaintext hljs"> import { NestMiddleware } from '@nestjs/common'; import * as jwt from 'express-jwt'; import { expressJwtSecret } from 'jwks-rsa'; export class AuthenticationMiddleware implements NestMiddleware { use(req, res, next) { jwt({ secret: expressJwtSecret({ cache: true, rateLimit: true, jwksRequestsPerMinute: 5, jwksUri: 'https://${DOMAIN}/.well-known/jwks.json', }), audience: 'http://localhost:3000', issuer: 'https://${DOMAIN}/', algorithm: 'RS256', })(req, res, err =&gt; { if (err) { const status = err.status || 500; const message = err.message || 'Sorry, we were unable to process your request.'; return res.status(status).send({ message, }); } next(); }); }; }</code> </pre> <br><p>  Remplacez <code>${DOMAIN}</code> par la valeur de <em>domaine</em> des param√®tres de l'application Auth0 </p><br><blockquote>  Note du traducteur: dans une application r√©elle, supprimez <code>DOMAIN</code> en une constante et d√©finissez sa valeur via <code>env</code> (environnement virtuel) </blockquote><p>  Installez les <code>jwks-rsa</code> <code>express-jwt</code> et <code>jwks-rsa</code> : </p><br><pre> <code class="bash hljs"> npm install express-jwt jwks-rsa</code> </pre> <br><p>  Il est n√©cessaire de connecter le middleware cr√©√© (gestionnaire) √† notre application.  Pour ce faire, dans le fichier <code>./src/app.module.ts</code> : </p><br><pre> <code class="plaintext hljs"> import { Module, MiddlewareConsumer, RequestMethod } from '@nestjs/common'; import { AuthenticationMiddleware } from './common/authentication.middleware'; import { ItemsController } from './items/items.controller'; import { ShoppingCartController } from './shopping-cart/shopping-cart.controller'; import { ItemsService } from './items/items.service'; @Module({ imports: [], controllers: [ItemsController, ShoppingCartController], providers: [ItemsService], }) export class AppModule { public configure(consumer: MiddlewareConsumer) { consumer .apply(AuthenticationMiddleware) .forRoutes( { path: '/items', method: RequestMethod.POST }, { path: '/shopping-cart', method: RequestMethod.POST }, ); } }</code> </pre> <br><p>  Le code ci-dessus indique que les requ√™tes POST vers les itin√©raires <code>/items</code> et <code>/shopping-cart</code> sont prot√©g√©es par le <em>middleware Express</em> , qui v√©rifie le jeton d'acc√®s dans la requ√™te. </p><br><p>  Red√©marrez le serveur de d√©veloppement ( <code>npm run start:dev</code> ) et appelez l'API Nest.js: </p><br><pre> <code class="bash hljs"> <span class="hljs-comment"><span class="hljs-comment">#     curl -X POST http://localhost:3000/shopping-cart #      TOKEN="eyJ0eXAiO...Mh0dpeNpg" # and issue a POST request with it curl -X POST -H 'authorization: Bearer '$TOKEN http://localhost:3000/shopping-cart</span></span></code> </pre> <br><h5 id="upravlenie-rolyami-s-auth0">  Gestion des r√¥les avec Auth0 </h5><br><p>  Pour le moment, tout utilisateur disposant d'un jeton v√©rifi√© peut publier un √©l√©ment dans notre API.  Cependant, nous aimerions que seuls les utilisateurs disposant de droits d'administrateur puissent le faire.  Pour impl√©menter cette fonction, nous utilisons les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">r√®gles (r√®gles) Auth0</a> . </p><br><p>  Alors, allez dans le panneau de configuration Auth0, dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">la section <em>R√®gles</em></a> .  L√†, cliquez sur le bouton <code>+ CREATE RULE</code> et s√©lectionnez "D√©finir les r√¥les pour un utilisateur" comme mod√®le de r√®gle. </p><br><p><img src="https://habrastorage.org/webt/qa/bz/6m/qabz6mavaqzu_qfeh9vxn8xkn4w.png"></p><br><p>  Cela fait, nous obtenons un fichier JavaScript avec un mod√®le de r√®gle qui ajoute le r√¥le d'administrateur √† tout utilisateur qui a un e-mail appartenant √† un certain domaine.  Modifions quelques d√©tails dans ce mod√®le pour obtenir un exemple fonctionnel.  Pour notre application, nous ne donnerons √† l'administrateur qu'un acc√®s √† notre propre adresse e-mail.  Nous devrons √©galement modifier l'emplacement de stockage des informations sur le statut d'administrateur. </p><br><p>  √Ä l'heure actuelle, ces informations sont stock√©es dans un jeton d'identification (utilis√© pour fournir des informations sur l'utilisateur), mais un jeton d'acc√®s doit √™tre utilis√© pour acc√©der aux ressources de l'API.  Le code apr√®s les modifications devrait ressembler √† ceci: </p><br><pre> <code class="javascript hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">user, context, callback</span></span></span><span class="hljs-function">) </span></span>{ user.app_metadata = user.app_metadata || {}; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (user.email &amp;&amp; user.email === <span class="hljs-string"><span class="hljs-string">'${YOUR_EMAIL}'</span></span>) { user.app_metadata.roles = [<span class="hljs-string"><span class="hljs-string">'admin'</span></span>]; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { user.app_metadata.roles = [<span class="hljs-string"><span class="hljs-string">'user'</span></span>]; } auth0.users .updateAppMetadata(user.user_id, user.app_metadata) .then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ context.accessToken[<span class="hljs-string"><span class="hljs-string">'http://localhost:3000/roles'</span></span>] = user.app_metadata.roles; callback(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, user, context); }) .catch(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err</span></span></span><span class="hljs-function">) </span></span>{ callback(err); }); }</code> </pre> <br><blockquote>  Remarque: remplacez <code>${YOUR_EMAIL}</code> par votre adresse e-mail.  Il est important de noter qu'en r√®gle g√©n√©rale, lorsque vous traitez des e-mails dans les r√®gles Auth0, il est id√©al de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">forcer la v√©rification des e-mails</a> .  Dans ce cas, cela n'est pas obligatoire car nous utilisons notre propre adresse e-mail. <br><br>  Note du traducteur: le fragment de code ci-dessus est entr√© dans le navigateur sur la page de configuration de la r√®gle Auth0 </blockquote><p>  Pour v√©rifier si le jeton transmis √† notre API est le jeton administrateur, nous devons cr√©er un <em>gardien</em> Nest.js.  Dans le dossier <code>src/common</code> , cr√©ez le fichier <code>admin.guard.ts</code> </p><br><pre> <code class="plaintext hljs"> import { Injectable, CanActivate, ExecutionContext } from '@nestjs/common'; @Injectable() export class AdminGuard implements CanActivate { canActivate(context: ExecutionContext): boolean { const user = context.getArgs()[0].user['http://localhost:3000/roles'] || ''; return user.indexOf('admin') &gt; -1; } }</code> </pre> <br><p>  Maintenant, si nous r√©p√©tons le processus de connexion d√©crit ci-dessus et utilisons l'adresse e-mail d√©finie dans la r√®gle, nous obtiendrons un nouveau <code>access_token</code> .  Pour v√©rifier le contenu de ce <code>access_token</code> , copiez et collez le jeton dans le champ <code>Encoded</code> du site <code>https://jwt.io/</code> .  Nous verrons que la section de charge utile de ce jeton contient le tableau suivant: </p><br><pre> <code class="plaintext hljs"> "http://localhost:3000/roles": [ "admin" ]</code> </pre> <br><p>  Si notre jeton inclut vraiment ces informations, nous continuons l'int√©gration avec Auth0.  Alors, ouvrez <code>items.controller.ts</code> et ajoutez notre nouvelle garde l√†-bas: </p><br><pre> <code class="plaintext hljs"> import { Get, Post, Body, Controller, UsePipes, UseGuards, } from '@nestjs/common'; import { CreateItemDto } from './create-item.dto'; import { ItemsService } from './items.service'; import { Item } from './item.interface'; import { ValidationPipe } from '../common/validation.pipe'; import { AdminGuard } from '../common/admin.guard'; @Controller('items') export class ItemsController { constructor(private readonly itemsService: ItemsService) {} @Get() async findAll(): Promise&lt;Item[]&gt; { return this.itemsService.findAll(); } @Post() @UseGuards(new AdminGuard()) @UsePipes(new ValidationPipe()) async create(@Body() createItemDto: CreateItemDto) { this.itemsService.create(createItemDto); } }</code> </pre> <br><p>  Maintenant, avec notre nouveau jeton, nous pouvons ajouter de nouveaux √©l√©ments via notre API: </p><br><pre> <code class="bash hljs"> <span class="hljs-comment"><span class="hljs-comment">#    npm run start:dev #  POST       curl -X POST -H 'Content-Type: application/json' \ -H 'authorization: Bearer '$TOKEN -d '{ "name": "Salad", "price": 3 }' http://localhost:3000/items</span></span></code> </pre> <br><blockquote>  Note du traducteur: pour v√©rification, vous pouvez voir ce que nous avons dans les articles: <br><pre> <code class="plaintext hljs">curl -X GET http://localhost:3000/items</code> </pre> <br></blockquote><br><h4 id="itogi">  R√©sum√© </h4><br><p>  F√©licitations!  Nous venons de terminer la construction de notre API Nest.JS et nous pouvons maintenant nous concentrer sur le d√©veloppement de la partie frontale de notre application!  N'oubliez pas de consulter la deuxi√®me partie de cette s√©rie: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Applications TypeScript √† pile compl√®te - Partie 2: D√©veloppement d'applications angulaires frontales.</a> </p><br><blockquote>  Note du traducteur: La traduction de la deuxi√®me partie est en cours. </blockquote><p>  Pour r√©sumer, dans cet article, nous avons utilis√© diverses fonctionnalit√©s de Nest.js et TypeScript: modules, contr√¥leurs, services, interfaces, canaux, middleware et guard pour cr√©er API  J'esp√®re que vous avez une bonne exp√©rience et √™tes pr√™t √† continuer √† d√©velopper notre application.  Si quelque chose ne vous est pas clair, la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation officielle nest.js</a> est une bonne source de r√©ponses </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr471348/">https://habr.com/ru/post/fr471348/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr471336/index.html">Holivar. Histoire de Runet. Partie 6. Serrures: Lurk, Tape, 282nd et Chinese path</a></li>
<li><a href="../fr471340/index.html">Drimsim vs Mate 20 Pro Round! Mais pour qui?</a></li>
<li><a href="../fr471342/index.html">Avalonia √©l√©gant</a></li>
<li><a href="../fr471344/index.html">Encore une fois √† propos d'ImmutableList en Java</a></li>
<li><a href="../fr471346/index.html">Le condens√© de mati√®res fra√Æches du monde du front-end de la derni√®re semaine n ¬∞ 384 (7-13 octobre 2019)</a></li>
<li><a href="../fr471350/index.html">Ing√©nierie inverse des amplificateurs op√©rationnels √† faible bruit √† partir d'un ordinateur analogique en 1969</a></li>
<li><a href="../fr471352/index.html">R√©daction de pr√©sentations dans LaTeX</a></li>
<li><a href="../fr471358/index.html">Comment √©crire un contrat intelligent avec Python sur l'ontologie? Partie 4: API native</a></li>
<li><a href="../fr471360/index.html">M√©thode de duplication. 11 exemples tir√©s de la conception d'ICE</a></li>
<li><a href="../fr471364/index.html">Gestion automatis√©e des tests avec Telegram</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>