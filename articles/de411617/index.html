<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöÑ üëéüèæ üöµüèΩ Mediensystem f√ºr Toyota Prius (Restayl) üó≥Ô∏è üöà üë®üèº‚Äçüéì</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dies ist der erste (einleitende) Artikel in der Reihe dar√ºber, wie ich das Mediensystem des Autos verfeinern werde. Das Projekt selbst ist in Bearbeit...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Mediensystem f√ºr Toyota Prius (Restayl)</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/411617/"><img src="https://habrastorage.org/webt/pw/a0/k_/pwa0k_aaxeguedncth7a5fdkm70.jpeg"><br><br>  Dies ist der erste (einleitende) Artikel in der Reihe dar√ºber, wie ich das Mediensystem des Autos verfeinern werde.  Das Projekt selbst ist in Bearbeitung, es gibt keine Zeit, wie alle anderen auch, liebe Leser, bitte haben Sie etwas Geduld, denn ich verspreche oft nicht, Artikel zu nieten. <br><br>  Alles begann damit, dass ich einen Prius hatte. <br><br>  Und das erste, was mir aufgefallen ist, waren die Probleme bei der Aktualisierung der Navigation.  Die folgenden sind sehr d√ºrftig, aber an einigen Stellen notwendige Funktionen eines Ger√§ts namens "Multifunktionsdisplay" (bei gew√∂hnlichen Menschen - der Kopf).  Und dies vor dem Hintergrund einer gro√üen Anzahl chinesischer Radios mit Android an Bord und vielen Annehmlichkeiten.  Ihre regelm√§√üige Installation impliziert jedoch den Entzug solcher "Br√∂tchen" als Diagramm der Energieverteilung und der Klimatisierung. <br><br>  Die Idee war geboren, das Android-Radio irgendwie enger mit dem Auto zu verbinden, als die chinesischen Br√ºder vermuten.  √úber diesen und den Artikel. <br><a name="habracut"></a><br><h3>  Ausgangssituation </h3><br>  Also.  An Bord befindet sich ein 7-Zoll-Display mit einem resistiven Touchscreen, das √ºber TX + - und TX- -Leitungen mit anderen elektronischen Ger√§ten verbunden ist.  Und es gibt bereits 3 solcher Paare vom Kopf. In der Schaltung hei√üt dieses Wunder AVC-LAN und sieht so aus: <br><br><img src="https://habrastorage.org/webt/ml/uo/le/mluolei1uqdz85xpjdh43hxjyvk.png"><br><br><h2>  Teil 1: Innen schauen </h2><br>  Wie Sie sehen k√∂nnen, befindet sich der Kopf in der L√ºcke des Netzwerks zwischen dem Router und der weiteren Funkkette, dem Verst√§rker (ich habe ihn separat), und ein separater Kanal sollte an die Navigationseinheit angeschlossen werden.  An anderer Stelle h√§ngt eine Parkeinheit, die in meinen Pl√§nen in keiner Weise erw√§hnt wird.  Gut, gut ... Ich habe beschlossen, die N√§he damit auf bessere Zeiten zu verschieben.  Dar√ºber hinaus ist das Parken eher eine Spielfunktion als ein echtes Bed√ºrfnis. <br><br>  Nachdem wir alle unn√∂tigen Elemente entfernt haben, erhalten wir ungef√§hr das folgende Blockdiagramm der Ger√§te: <br><br><img src="https://habrastorage.org/webt/qb/az/gl/qbazglszcggkjhudk80w91l9tdg.png"><br><br><h3>  Reflexionen </h3><br>  Es gab eine Idee, die Navigationseinheit einfach durch etwas Android zu ersetzen, aber sie starb aus, als ich tiefer verstand, wie sie mit dem Kopf kommunizieren.  Zus√§tzlich zu AVC-LAN sind diese Module auch √ºber die GVIF-Leitung (Gigabit Video InterFace) verbunden, und dasselbe Gesicht von Konverterherstellern kann versehentlich Risse bekommen, wenn ich f√ºr mehr als 100 US-Dollar auch einen Videosignalkonverter in GVIF kaufe. ‚ÄûOhne Gesicht zu leben, muss sein es mag schwierig sein, aber ... "- klang in meinem Kopf nach dem Motiv eines ber√ºhmten Liedes, und die Entscheidung gefiel mir nicht. <br><br>  Es gab L√∂sungen im Netzwerk mit der Installation eines chinesischen Radios anstelle eines Funkempf√§ngers.  Dies passte nicht zu mir, da die beiden Anzeigen eine unangemessene Redundanz aufweisen.  IMHO. <br><br><h2>  L√∂sung </h2><br>  Die folgende L√∂sung wurde geboren: Ersetzen Sie den gesamten Kopf und schlie√üen Sie das Android-Radio ab, indem Sie sich mit dem Prius anfreunden. <br><br><ol><li>  Entwerfen Sie einen USB &lt;-&gt; AVC-LAN-Hardwarekonverter </li><li>  Entwickeln Sie eine Firmware daf√ºr, damit sie sich wie ein USB-HID verbindet. </li><li>  Machen Sie es so zusammengesetzt, dass eine der Funktionen wie eine normale Hardwaretastatur erkannt wird (um sie √ºber die Schaltfl√§chen auf dem Bedienfeld als native Steuerung zu verwenden). </li><li>  Entwickeln Sie eine Android-Anwendung mit Funktionen, die dem nativen Priusovsky √§hnlich (oder √ºberlegen) sind </li><li>  Richten Sie die R√ºckfahrkamera aus </li><li>  L√∂sen Sie Probleme im mechanischen Teil (Installation an einem normalen Ort) </li></ol><br>  Dabei muss eine weitere Anwendung f√ºr Android entwickelt werden - ein gew√∂hnlicher Sniffer, damit Pakete in AVC-LAN bequemer r√ºckg√§ngig gemacht werden k√∂nnen.  Zur gleichen Zeit und √ºben. <br><br>  Es sollte so aussehen: <br><br><img src="https://habrastorage.org/webt/_x/7j/f2/_x7jf2mr_9mp0ow3yxwds8yuhuc.png"><br><br>  Als Hardware-Basis wurde beschlossen, ein Trainingsboard f√ºr den SM32F103 zu verwenden: <br><br><img src="https://habrastorage.org/webt/oo/u8/1y/oou81yrznrr2hcnayb2emjfb_lw.jpeg"><br><br>  Bestellt bei AliExpress f√ºr 2,05 USD. <br><br><div class="spoiler">  <b class="spoiler_title">Oder Suchspoiler</b> <div class="spoiler_text">  Vielleicht wurde das Los bereits vom Verk√§ufer gel√∂scht, also gebe ich die magische Zeichenfolge, um nach Ali zu suchen: <br>  STM32F103C8T6 ARM STM32 Minimum System Development Board-Modul <br></div></div><br>  Was ich an ihr mag: <br><br><ul><li>  USB-Hardwaremodul (Ger√§t) an Bord des Prozessors </li><li>  Angemessener USB-Stack des Herstellers (im Gegensatz zum Freescale-Ovsky bei Nacht nicht in Erinnerung bleiben). </li><li>  Kostenlose GPIO-Anschl√ºsse, √ºber die normale Tasten an den Seiten des Monitors angeschlossen werden k√∂nnen.  M√∂glicherweise werden dadurch die Hardwaretasten des Radios unter dem Bedienfeld ausgeblendet.  Ich wei√ü nicht, was sie sein wird </li><li>  Und darauf k√∂nnen Sie den AVC-LAN-Konverter in logische Ebenen h√§ngen </li></ul><br>  Ich werde in der Reihenfolge der Umsetzung weiter beschreiben, was vor allem auf mein pers√∂nliches Wissen zur√ºckzuf√ºhren ist.  Das hei√üt,  Ich versuchte die Orte zu erkennen, an denen sie nicht ganz am Anfang waren, und am Ende zu verlassen, was sicherlich passieren sollte. <br><br>  In jedem Fall sind mehrere Artikel in verschiedenen Hubs geplant.  Das Projekt stellt sich als viel FullStack heraus - von der Hardwareverbindung bis zur Android-Anwendung. <br><br><h2>  Teil 2: USB, HID, Deskriptoren und alles, um einen Pilotprototyp zu erhalten </h2><br>  Der erste Schritt war, dass ich ein paar Ger√§te und Telefone besorgen wollte, damit das Ger√§t das Paket auf das Telefon √ºbertragen konnte, und das - um es in der Anwendung anzuzeigen. <br>  Wie Gagarin sagte: Lass uns gehen! <br><br><h3>  USB HID Composite-Ger√§t auf STM32 </h3><br>  Ich entschied mich daf√ºr, das ST-Beispiel von meinen Aufgaben anzupassen und ein USB-Ger√§t zu erhalten, das vom Host als Teil der Tastatur und ‚Äûetwas anderes‚Äú erkannt wird - das RAW HID-Ger√§t.  Die erste ist, wie bereits erw√§hnt, f√ºr die native Android-Steuerung vorgesehen, die zweite f√ºr den direkten Austausch von AVC-LAN-Paketen mit dem Programm auf dem Ger√§t. <br><br>  Basierend auf CubeMX von STM und nachdem ich viele Artikel zur Implementierung von benutzerdefiniertem HID gelesen hatte, fand ich eine unangenehme Sache im Netzwerk: Das Problem der Erstellung von Verbundger√§ten ist praktisch nicht vorhanden oder sehr selten. <br><br><div class="spoiler">  <b class="spoiler_title">Quellcodes werden sp√§ter sein</b> <div class="spoiler_text">  Ich lade die Quellcodes noch nicht hoch, da das Projekt jetzt in einem experimentellen Trainingsmodus implementiert wird.  Wenn das Projekt erfolgreich abgeschlossen wurde, ziehen Sie sie auf Github und bearbeiten Sie den Artikel mit einem Link zu ihnen. <br>  In der Form, in der sie sich befinden, macht das Hochladen keinen Sinn - ohne mich gibt es im Internet genug Chaos. <br></div></div><br><h4>  USB, Composite, HID </h4><br>  Nur ein paar Worte zu diesem Thema.  Es wird davon ausgegangen, dass Sie mit dem USB-Standard mehr oder weniger vertraut sind.  Wenn nicht, ist es besser, sich zuerst mit Beispielen aus CubeMX vertraut zu machen und mit ihnen zu experimentieren. <br><br>  Also haben wir: <br><br>  Beispiel f√ºr die Implementierung eines STM-USB-Stacks und einer Maus.  Dort haben wir einige Deskriptoren und einen funktionalen Endpunkt konfiguriert.  Dies gilt zus√§tzlich zu einem Paar von 0x00 und 0x80 zur Steuerung des gesamten Ger√§ts. <br><br>  Um mein Projekt zu implementieren, muss der Tastaturendpunkt bidirektional sein (ich wei√ü nicht warum - es ist n√ºtzlich) und einige weitere Endpunkte, die zum Datenaustausch mit der zweiten RAW-Funktion verwendet werden.  F√ºgen Sie sie hinzu. <br><br>  Wir machen den Punkt bidirektional, indem wir den OUT-Punkt zum Deskriptor hinzuf√ºgen: <br><br><div class="spoiler">  <b class="spoiler_title">Konfigurationsdeskriptor.</b> <div class="spoiler_text">  Achten Sie beim Bearbeiten eines Deskriptors auf Indizes und Gr√∂√üen. <br>  (2c5cf968121f0d8fa43a6755c09e15ef3a317791): <br><br><pre><code class="cpp hljs"><span class="hljs-number"><span class="hljs-number">0x07</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*bLength: Endpoint Descriptor size*/</span></span> USB_DESC_TYPE_ENDPOINT, <span class="hljs-comment"><span class="hljs-comment">/*bDescriptorType:*/</span></span> HID_EPOUT_ADDR, <span class="hljs-comment"><span class="hljs-comment">/*bEndpointAddress: Endpoint Address (IN)*/</span></span> <span class="hljs-number"><span class="hljs-number">0x03</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*bmAttributes: Interrupt endpoint*/</span></span> HID_EPOUT_SIZE, <span class="hljs-comment"><span class="hljs-comment">/*wMaxPacketSize: 4 Byte max */</span></span> <span class="hljs-number"><span class="hljs-number">0x00</span></span>, HID_FS_BINTERVAL,</code> </pre> <br></div></div><br>  Und noch ein paar Punkte hinzuf√ºgen: <br><br><div class="spoiler">  <b class="spoiler_title">Konfigurationsdeskriptor</b> <div class="spoiler_text">  (bc2bd583c98715e106fcb3ab07b266bc9221be36): <br><br><pre> <code class="cpp hljs"> <span class="hljs-comment"><span class="hljs-comment">/* 59 */</span></span> <span class="hljs-number"><span class="hljs-number">0x07</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*bLength: Endpoint Descriptor size*/</span></span> USB_DESC_TYPE_ENDPOINT, <span class="hljs-comment"><span class="hljs-comment">/*bDescriptorType:*/</span></span> HID_EPIN_ADDR2, <span class="hljs-comment"><span class="hljs-comment">/*bEndpointAddress: Endpoint Address (IN)*/</span></span> <span class="hljs-number"><span class="hljs-number">0x03</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*bmAttributes: Interrupt endpoint*/</span></span> HID_EPIN_SIZE, <span class="hljs-comment"><span class="hljs-comment">/*wMaxPacketSize: 4 Byte max */</span></span> <span class="hljs-number"><span class="hljs-number">0x00</span></span>, HID_FS_BINTERVAL, <span class="hljs-comment"><span class="hljs-comment">/*bInterval: Polling Interval (10 ms)*/</span></span> <span class="hljs-comment"><span class="hljs-comment">/* 66 */</span></span> <span class="hljs-number"><span class="hljs-number">0x07</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*bLength: Endpoint Descriptor size*/</span></span> USB_DESC_TYPE_ENDPOINT, <span class="hljs-comment"><span class="hljs-comment">/*bDescriptorType:*/</span></span> HID_EPOUT_ADDR2, <span class="hljs-comment"><span class="hljs-comment">/*bEndpointAddress: Endpoint Address (IN)*/</span></span> <span class="hljs-number"><span class="hljs-number">0x03</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*bmAttributes: Interrupt endpoint*/</span></span> HID_EPOUT_SIZE, <span class="hljs-comment"><span class="hljs-comment">/*wMaxPacketSize: 4 Byte max */</span></span> <span class="hljs-number"><span class="hljs-number">0x00</span></span>, HID_FS_BINTERVAL, <span class="hljs-comment"><span class="hljs-comment">/*bInterval: Polling Interval (10 ms)*/</span></span></code> </pre><br></div></div><br>  Es war ein Konfigurationsdeskriptor.  Jetzt wird der Host sicher sein, dass wir eine Art zusammengesetztes HID-Ger√§t haben, und Sie k√∂nnen Daten an alle diese Punkte senden.  Das ist aber nicht so. <br>  Um dies wahr zu machen: <br><br>  1. Unser Controller verf√ºgt √ºber einen speziell zugewiesenen Speicher, der zusammen mit CAN- und USB-Modulen getaktet wird.  Da das USB-Modul unabh√§ngig am Empfang / Senden eines Datenpakets beteiligt ist, m√ºssen Sie f√ºr jeden einzelnen Endpunkt Puffer in diesem Speicher festlegen: <br><br><div class="spoiler">  <b class="spoiler_title">USBD_LL_Init in der Datei usbd_conf.c</b> <div class="spoiler_text"><pre> <code class="cpp hljs"> HAL_PCDEx_PMAConfig((PCD_HandleTypeDef*)pdev-&gt;pData , <span class="hljs-number"><span class="hljs-number">0x00</span></span> , PCD_SNG_BUF, <span class="hljs-number"><span class="hljs-number">0x18</span></span>); HAL_PCDEx_PMAConfig((PCD_HandleTypeDef*)pdev-&gt;pData , <span class="hljs-number"><span class="hljs-number">0x80</span></span> , PCD_SNG_BUF, <span class="hljs-number"><span class="hljs-number">0x58</span></span>); HAL_PCDEx_PMAConfig((PCD_HandleTypeDef*)pdev-&gt;pData , HID_EPOUT_ADDR , PCD_SNG_BUF, <span class="hljs-number"><span class="hljs-number">0x100</span></span>); HAL_PCDEx_PMAConfig((PCD_HandleTypeDef*)pdev-&gt;pData , HID_EPIN_ADDR , PCD_SNG_BUF, <span class="hljs-number"><span class="hljs-number">0x140</span></span>); HAL_PCDEx_PMAConfig((PCD_HandleTypeDef*)pdev-&gt;pData , HID_EPOUT_ADDR2 , PCD_SNG_BUF, <span class="hljs-number"><span class="hljs-number">0x180</span></span>); HAL_PCDEx_PMAConfig((PCD_HandleTypeDef*)pdev-&gt;pData , HID_EPIN_ADDR2 , PCD_SNG_BUF, <span class="hljs-number"><span class="hljs-number">0x1B0</span></span>);</code> </pre><br></div></div><br>  Pufferadressen sind willk√ºrlich, wenn sie sich nur nicht √ºberlappen w√ºrden. <br><br>  Aus irgendeinem Grund wird der ST-Stapel mit der Erwartung geschrieben, dass das Ger√§t nicht mehr als einen bidirektionalen Endpunkt hat. Daher werden wir den Stapel ein wenig √§ndern: <br><br><h4>  √úbertragen </h4><br>  Benennen Sie die Prozedur USBD_HID_SendReport in USBD_HID_SendReportEP um und f√ºgen Sie einen weiteren Parameter hinzu - die Endpunktnummer.  Wir belassen die Prozedur aus Gr√ºnden der Abw√§rtskompatibilit√§t mit dem alten Namen, rufen jedoch im Hauptteil USBD_HID_SendReportEP mit einer Konstante in Form eines Endpunkts auf.  Die L√∂sung ist immer noch nicht die √§sthetischste, aber sie wird f√ºr das Experiment funktionieren, und selbst wenn sie bestehen bleibt, wird sie ein bestimmtes Projekt nicht beeintr√§chtigen. <br><br><div class="spoiler">  <b class="spoiler_title">usbd_hid.c</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> USBD_HID_SendReportEP (USBD_HandleTypeDef *pdev, <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> ep, <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *report, <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> len) { ... ,   USBD_HID_SendReport } <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> USBD_HID_SendReport (USBD_HandleTypeDef *pdev, <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *report, <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> len) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> USBD_HID_SendReportEP(pdev,HID_EPIN_ADDR,report,len); }</code> </pre><br></div></div><br>  Jetzt ist alles bereit, Daten zu senden, es bleibt nur zum richtigen Zeitpunkt, um diese Funktion aufzurufen. <br><br><h4>  Finalisierung </h4><br>  Aus Gr√ºnden der Reihenfolge suchen wir nach dem Projekt und rufen USBD_LL_CloseEP erneut auf, jedoch nach den neu erstellten Endpunkten. <br><br><h4>  Rezeption </h4><br>  Damit die Endpunkte moralisch so funktionieren, dass sie funktionieren, m√ºssen Sie USBD_LL_PrepareReceive f√ºr sie aufrufen.  Ich empfehle dem Leser, die Suche nach dem Projekt f√ºr diese Zeile durchzugehen und diese Aufrufe an Ihre Bed√ºrfnisse anzupassen. <br><br>  Ich habe diesen h√§sslichen Tintenfisch in meinem Code: <br><br><div class="spoiler">  <b class="spoiler_title">usbd_core.c</b> <div class="spoiler_text"><pre> <code class="cpp hljs">USBD_LL_PrepareReceive(pdev, HID_EPOUT_ADDR+(epnum&amp;<span class="hljs-number"><span class="hljs-number">0x7F</span></span>)<span class="hljs-number"><span class="hljs-number">-1</span></span> , hhid-&gt;Report_buf, USBD_HID_OUTREPORT_BUF_SIZE);</code> </pre><br></div></div><br>  Das hei√üt,  Ich ging davon aus, dass die Anzahl der Endpunkte hintereinander liegt.  Das ist schlecht, IMHO.  Tu das nicht.  Mag aber auch nicht ST. <br><br>  Sie m√ºssen nur noch in die Datei usbd_hid.c und speziell in die Funktion USBD_HID_DataOut gehen und sicherstellen, dass der Aufruf des empfangenen Datenhandlers Ihren pers√∂nlichen Vorstellungen √ºber das Sch√∂ne entspricht.  Es ist mir auch nicht gelungen, daher werden Code und Beschreibung lang und unverst√§ndlich sein.  Einfacher selbst zu machen. <br><br><h4>  Bericht </h4><br>  Alles, an dieser Stelle haben wir ein zusammengesetztes Ger√§t, das Daten √ºber zwei bidirektionale Punkte austauschen kann.  Beim letzten Schlag haben wir die Neugier des HID-Fahrers ‚Äûzum Schweigen gebracht‚Äú und einen solchen Berichtsdeskriptor beschrieben: <br><br><pre> <code class="cpp hljs">__ALIGN_BEGIN <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> HID_ReportDesc2[<span class="hljs-number"><span class="hljs-number">33</span></span>] __ALIGN_END = { <span class="hljs-number"><span class="hljs-number">0x06</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xff</span></span>, <span class="hljs-comment"><span class="hljs-comment">// USAGE_PAGE (Vendor Defined Page 1) 0x09, 0x01, // USAGE (Vendor Usage 1) 0xa1, 0x01, // COLLECTION (Application) 0x85, 0x01, // REPORT_ID (1) 0x15, 0x00, // LOGICAL_MINIMUM (0) 0x26, 0xff, 0x00, // LOGICAL_MAXIMUM (255) 0x75, 0x08, // REPORT_SIZE (8) 0x95, 0x1f, // REPORT_COUNT (31) 0x09, 0x00, // USAGE (Undefined) 0x81, 0x00, // INPUT (Data,Ary,Abs) 0x85, 0x02, // REPORT_ID (2) 0x09, 0x01, // USAGE (Vendor Usage 1) 0x75, 0x08, // REPORT_SIZE (8) 0x95, 0x1f, // REPORT_COUNT (31) 0x91, 0x00, // OUTPUT (Data,Ary,Abs) 0xc0 // END_COLLECTION };</span></span></code> </pre><br>  Dieser Bericht teilt dem HID-Treiber mit: Es werden ungef√§hr 31 Datenbytes vorhanden sein.  Sie m√ºssen nicht herausfinden, was sie sind - geben Sie sie einfach an das Programm weiter, das dieses Ger√§t ge√∂ffnet hat.  In einem physischen Bericht entspricht das Nullbyte dem Berichtsindex (REPORT_ID (2)).  Dementsprechend werden insgesamt 32 Bytes kommen. <br><br>  Und geben Sie die Daten dazu in usbd-hid.c ein, Funktion USBD_HID_Setup .: <br><br><div class="spoiler">  <b class="spoiler_title">usbd-hid.c</b> <div class="spoiler_text"><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (req-&gt;bRequest) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> USB_REQ_GET_DESCRIPTOR: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( req-&gt;wValue &gt;&gt; <span class="hljs-number"><span class="hljs-number">8</span></span> == HID_REPORT_DESC) { <span class="hljs-comment"><span class="hljs-comment">// </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment"> !!!   ,     req-&gt;wIndex !!! THIDDescPtrLen * rep = (req-&gt;wIndex==1)?&amp;HID_ReportDesc:&amp;HID_ReportDesc2; len = MIN(rep-&gt;len , req-&gt;wLength); pbuf = rep-&gt;ptr; }</span></span></code> </pre></div></div><br><h3>  Weiter im Programm: </h3><br><ol><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Montage des AVC-LAN-Logikpegelwandlers und Anschluss an die Karte.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Analyse der physikalischen Schicht von AVC-LAN, reale Wellenformen.</a> </li><li>  Verarbeitung der Schnittstelle auf Controller-Ebene und Senden von Paketen mit Berichten </li><li>  End-to-End-Schnittstelle und Reverse Engineering Prius.  Paket Sniffer (oder meine erste Android App) </li></ol><br><h4>  PS </h4><br><ul><li>  Ich habe beschlossen, einen Artikel zu schreiben, weil ich (fast) gezwungen war, davon zu √ºberzeugen, dass dies geteilt werden sollte.  Selbst wenn ich das Projekt nicht beende, k√∂nnen einige der neuesten Informationen jemandem auch auf "rohe" Weise helfen. </li><li>  Kritik am Projekt ist willkommen, wie  Ich selbst kann mir noch nicht ganz vorstellen, dass es klappen wird. </li><li>  Kritik am Artikel, Design, Pr√§sentation - vor allem, weil  Dies ist der erste Artikel f√ºr die Ressource.  Mit der Fortsetzung der Arbeit m√∂chte ich meine Gedanken in der f√ºr die Leser √ºblichen und leicht verdaulichen Form ausdr√ºcken </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de411617/">https://habr.com/ru/post/de411617/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de411601/index.html">Was sind Sklerometrie und Tribometer? Und wie spart es Ger√§te in der Produktion?</a></li>
<li><a href="../de411605/index.html">"DAS_". Wie das B√ºro der Kuzbass IT-Unternehmen eingerichtet ist</a></li>
<li><a href="../de411609/index.html">5 NASA-Fotos, die die Welt ver√§ndert haben</a></li>
<li><a href="../de411611/index.html">Das Gesetz von Spring-Ozerov - von Worten zu Taten</a></li>
<li><a href="../de411613/index.html">Kampf der Titanen: Vergleich der Flaggschiff-Leser des PocketBook 740 und des Amazon Kindle Oasis 2017</a></li>
<li><a href="../de411621/index.html">SpaceX wird in Los Angeles eine Big Fucking Rocket bauen</a></li>
<li><a href="../de411623/index.html">Wissenschaftler haben ein Enzym geschaffen, das Plastik abbaut</a></li>
<li><a href="../de411625/index.html">Radio-86RK auf dem ESP-01S</a></li>
<li><a href="../de411629/index.html">Wie wir den Intercity-Busfahrplan wiederhergestellt haben</a></li>
<li><a href="../de411631/index.html">Das Telegramm in Russland kann aufgrund von Durovs Pl√§nen, eine eigene Kryptow√§hrung zu starten, blockiert werden</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>