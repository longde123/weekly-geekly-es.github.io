<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë≤üèª üòµ üèÇüèª Stockage efficace de centaines de millions de petits fichiers. Solution auto-h√©berg√©e üë©üèª‚Äçüé§ üßëüèª üè¨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ch√®re communaut√©, cet article se concentrera sur le stockage et la livraison efficaces de centaines de millions de petits fichiers. √Ä ce stade, la sol...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Stockage efficace de centaines de millions de petits fichiers. Solution auto-h√©berg√©e</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/484312/"><img src="https://habrastorage.org/webt/32/yq/2a/32yq2adas-fjtcztdzu7fhyhiss.png"><br><br>  Ch√®re communaut√©, cet article se concentrera sur le stockage et la livraison efficaces de centaines de millions de petits fichiers.  √Ä ce stade, la solution finale pour les syst√®mes de fichiers compatibles POSIX avec prise en charge compl√®te des verrous, y compris ceux en cluster, et m√™me sans b√©quilles, est propos√©e. <br><br>  C'est pourquoi j'ai √©crit √† cet effet mon propre serveur sp√©cialis√©. <br>  Au cours de cette t√¢che, il a √©t√© possible de r√©soudre le probl√®me principal, tout en √©conomisant de l'espace disque et de la RAM, que notre syst√®me de fichiers de cluster a impitoyablement consomm√©.  En fait, un tel nombre de fichiers est nuisible √† tout syst√®me de fichiers en cluster. <a name="habracut"></a><br><br>  L'id√©e est la suivante: <br><br>  En termes simples, les petits fichiers sont t√©l√©charg√©s via le serveur, ils sont enregistr√©s directement dans l'archive et sont √©galement lus √† partir de celui-ci, et les gros fichiers sont plac√©s √† proximit√©.  Sch√©ma: 1 dossier = 1 archive, au total nous avons plusieurs millions d'archives avec de petits fichiers, et non plusieurs centaines de millions de fichiers.  Et tout cela est enti√®rement impl√©ment√©, sans aucun script ni pliage de fichiers dans des archives tar / zip. <br><br>  Je vais essayer de le raccourcir, je m'excuse √† l'avance si le message sera volumineux. <br><br>  Tout a commenc√© avec le fait que je ne pouvais pas trouver un serveur appropri√© dans le monde qui pourrait enregistrer les donn√©es re√ßues via le protocole HTTP directement dans les archives, de sorte qu'il n'y avait pas d'inconv√©nients inh√©rents aux archives ordinaires et aux r√©f√©rentiels d'objets.  Et la raison de la recherche √©tait un cluster de 10 serveurs qui est devenu une origine √† grande √©chelle, dans laquelle 250 000 000 de petits fichiers s'√©taient d√©j√† accumul√©s, et la tendance √† la croissance n'allait pas s'arr√™ter. <br><br>  <b>Ceux qui n'aiment pas lire les articles et un peu de documentation sont plus faciles:</b> <br><br>  <a href="" rel="nofollow">ici</a> et <a href="" rel="nofollow">ici</a> . <br><br>  <b>Mettre √† jour</b>  <b>Suppression de nginx de l'image docker.</b> <br><br>  Et docker en m√™me temps: <br><pre><code class="bash hljs">docker run -d --restart=always -e bindaddr=127.0.0.1:9699 \ -e host=localhost -e root=/var/storage -v /var/storage:/var/storage --name wzd \ -p 80:9699 eltaline/wzd</code> </pre> <br>  Suivant: <br><br>  <b>Mettre √† jour</b>  <b>Dans la version 1.1.0, la m√©thode d'authentification HTTPS / POST / IP, etc., est d√©j√† apparue.</b> <br><br>  S'il y a beaucoup de fichiers, des ressources importantes sont n√©cessaires et, plus offensivement, certains d'entre eux sont gaspill√©s.  Par exemple, lorsque vous utilisez un syst√®me de fichiers en cluster (dans ce cas, MooseFS), un fichier, quelle que soit sa taille r√©elle, prend toujours au moins 64 Ko.  Autrement dit, pour les fichiers de 3, 10 ou 30 Ko, 64 Ko sont requis sur le disque.  Si un quart de milliard de fichiers, on perd de 2 √† 10 t√©raoctets.  Il ne sera pas possible de cr√©er de nouveaux fichiers √† l'infini car il y a une limitation dans MooseFS lui-m√™me: pas plus d'un milliard avec une r√©plique de chaque fichier. <br><br>  √Ä mesure que le nombre de fichiers augmente, vous avez besoin de beaucoup de RAM pour les m√©tadonn√©es.  Les d√©charges de m√©tadonn√©es fr√©quentes et importantes contribuent √©galement √† l'usure des disques SSD. <br><br>  <b>Serveur WZD.</b>  <b>Nous mettons les disques en ordre.</b> <br><br>  Le serveur est √©crit en Go.  Tout d'abord, je devais r√©duire le nombre de fichiers.  Comment faire  En raison de l'archivage, mais dans ce cas sans compression, car mes fichiers sont des images solides et √©cr√™t√©es.  BoltDB est venu √† la rescousse, qui devait encore √™tre priv√© de d√©fauts, cela se refl√®te dans la documentation. <br><br>  Au total, au lieu d'un quart de milliard de fichiers, dans mon cas, il ne reste que 10 millions d'archives Bolt.  Si j'avais l'occasion de changer la structure actuelle de remplissage des fichiers de r√©pertoire, il serait alors possible de r√©duire √† environ 1 million de fichiers. <br><br>  Tous les petits fichiers sont emball√©s dans les archives Bolt, recevant automatiquement les noms des r√©pertoires dans lesquels ils se trouvent, et tous les gros fichiers restent c√¥te √† c√¥te avec les archives, cela n'a aucun sens de les emballer, cela est personnalisable.  Petit - archive, grand - laissez inchang√©.  Le serveur fonctionne de mani√®re transparente avec les deux. <br><br>  <b>Architecture et fonctionnalit√©s du serveur wZD.</b> <br><br><img src="https://habrastorage.org/webt/uu/yu/t1/uuyut1do539zyzy3qs9atm_h9xg.png"><br><br>  Le serveur ex√©cute Linux, BSD, Solaris et OSX.  J'ai test√© uniquement l'architecture AMD64 sous Linux, mais elle devrait √©galement convenir pour ARM64, PPC64, MIPS64. <br><br>  <b>Caract√©ristiques cl√©s:</b> <br><br><ul><li>  Multithreading; </li><li>  Multi-serveur, offrant une tol√©rance aux pannes et un √©quilibrage de charge; </li><li>  Transparence maximale pour l'utilisateur ou le d√©veloppeur; </li><li>  M√©thodes HTTP prises en charge: GET, HEAD, PUT et DELETE; </li><li>  Gestion des comportements de lecture et d'√©criture via les en-t√™tes clients; </li><li>  Prise en charge d'h√¥tes virtuels personnalisables; </li><li>  Prend en charge l'int√©grit√© des donn√©es CRC lors de l'√©criture / lecture; </li><li>  Tampons semi-dynamiques pour une consommation de m√©moire minimale et un r√©glage optimal des performances du r√©seau; </li><li>  Compaction de donn√©es retard√©e </li><li>  De plus, un archiveur wZA multithread est propos√© pour la migration de fichiers sans arr√™ter le service. </li></ul><br>  <b>Exp√©rience r√©elle:</b> <br><br>  J'ai d√©velopp√© et test√© le serveur et l'archiveur sur des donn√©es en direct pendant assez longtemps, maintenant il fonctionne avec succ√®s sur un cluster qui comprend 250 000 000 de petits fichiers (images) situ√©s dans 15 000 000 r√©pertoires sur des disques SATA s√©par√©s.  Un cluster de 10 serveurs est un serveur Origin install√© derri√®re un r√©seau CDN.  Pour sa maintenance, 2 serveurs Nginx + 2 serveurs wZD sont utilis√©s. <br><br>  Pour ceux qui d√©cident d'utiliser ce serveur, il est judicieux de planifier la structure du r√©pertoire avant utilisation, le cas √©ch√©ant.  R√©servez imm√©diatement que le serveur n'est pas con√ßu pour tout pousser dans l'archive 1 Bolt. <br><br>  <b>Test de performance:</b> <br><br>  Plus la taille du fichier archiv√© est petite, plus les op√©rations GET et PUT sont rapides sur celui-ci.  Comparez le temps total pendant lequel le client HTTP √©crit dans des fichiers normaux et dans des archives Bolt, et lit √©galement.  Il compare le travail avec des fichiers de taille 32 Ko, 256 Ko, 1024 Ko, 4096 Ko et 32 ‚Äã‚Äã768 Ko. <br><br>  Lorsque vous travaillez avec des archives Bolt, l'int√©grit√© des donn√©es de chaque fichier est v√©rifi√©e (CRC est utilis√©), avant l'√©criture et √©galement apr√®s l'√©criture, la lecture est effectu√©e √† la vol√©e et le recomptage, cela introduit naturellement des retards, mais l'essentiel est la s√©curit√© des donn√©es. <br><br>  J'ai effectu√© des tests de performances sur les SSD, car sur les disques SATA, les tests ne montrent pas de diff√©rence claire. <br><br>  <b>Mise √† jour (v1.1.0), am√©lioration des performances de 5 √† 25%.</b> <br><br>  <b>Graphiques bas√©s sur les r√©sultats des tests:</b> <br><br><img src="https://habrastorage.org/webt/mi/ok/np/mioknp3lbcmd6vd87l255wksyg0.png"><br><img src="https://habrastorage.org/webt/zz/7b/k_/zz7bk_uhudvy71kyrdk5qe6fulc.png"><br><br>  Comme vous pouvez le voir, pour les petits fichiers, la diff√©rence de temps de lecture et d'√©criture entre les fichiers archiv√©s et non archiv√©s est faible. <br><br>  Nous obtiendrons une image compl√®tement diff√©rente avec le test de lecture et d'√©criture de fichiers de 32 Mo: <br><br><img src="https://habrastorage.org/webt/mo/br/xw/mobrxwox3c6o-kq3qjnj7vdaymu.png"><br><br>  La diff√©rence de temps entre la lecture des fichiers est de 5 √† 25 ms.  Avec l'enregistrement, les choses sont pires, la diff√©rence est d'environ 150 ms.  Mais dans ce cas, il n'est pas n√©cessaire de t√©l√©charger de gros fichiers, cela n'a tout simplement pas de sens, ils peuvent vivre s√©par√©ment des archives. <br><br>  * Techniquement, ce serveur peut √©galement √™tre utilis√© pour des t√¢ches n√©cessitant NoSQL. <br><br>  <b>M√©thodes de base pour travailler avec le serveur wZD:</b> <br><br>  T√©l√©chargez le fichier r√©gulier: <br><pre> <code class="bash hljs">curl -X PUT --data-binary @test.jpg http://localhost/<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>/test.jpg</code> </pre> <br>  T√©l√©chargement d'un fichier dans l'archive Bolt (si le param√®tre serveur fmaxsize n'est pas d√©pass√©, ce qui d√©termine la taille de fichier maximale pouvant √™tre incluse dans l'archive, s'il est d√©pass√©, le fichier sera charg√© comme d'habitude √† c√¥t√© de l'archive): <br><pre> <code class="bash hljs">curl -X PUT -H <span class="hljs-string"><span class="hljs-string">"Archive: 1"</span></span> --data-binary @test.jpg http://localhost/<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>/test.jpg</code> </pre> <br>  T√©l√©chargement d'un fichier (s'il y a des fichiers du m√™me nom sur le disque et dans l'archive, alors lors du t√©l√©chargement, la priorit√© par d√©faut est donn√©e au fichier d√©compress√©): <br><pre> <code class="bash hljs">curl -o test.jpg http://localhost/<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>/test.jpg</code> </pre> <br>  T√©l√©chargement d'un fichier √† partir de l'archive Bolt (forc√©): <br><pre> <code class="bash hljs">curl -o test.jpg -H <span class="hljs-string"><span class="hljs-string">"FromArchive: 1"</span></span> http://localhost/<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>/test.jpg</code> </pre> <br><br>  Une description des autres m√©thodes se trouve dans la documentation. <br><br>  <a href="" rel="nofollow">Documentation WZD</a> <br>  <a href="" rel="nofollow">Documentation WZA</a> <br><br>  Jusqu'√† pr√©sent, le serveur ne prend en charge que HTTP, il ne fonctionne pas encore avec HTTPS.  La m√©thode POST n'est pas non plus prise en charge (il n'a pas encore √©t√© d√©cid√© si elle est n√©cessaire ou non). <br><br>  Quiconque plonge dans le code source y trouvera un caramel, tout le monde ne l'aime pas, mais je n'ai pas li√© le code principal aux fonctions du framework Web, √† l'exception du gestionnaire d'interruption, de sorte qu'√† l'avenir je puisse r√©√©crire rapidement sur presque n'importe quel moteur. <br><br>  <b>√Ä faire:</b> <br><br><ul><li>  D√©veloppement de notre propre r√©plicateur et distributeur + g√©o pour la possibilit√© d'utilisation dans de grands syst√®mes sans cluster FS (Tout pour un adulte) </li><li>  La possibilit√© d'inverser compl√®tement les m√©tadonn√©es de restauration lorsqu'elles sont compl√®tement perdues (si vous utilisez un distributeur) </li><li>  Protocole natif pour la possibilit√© d'utiliser des connexions r√©seau permanentes et des pilotes pour diff√©rents langages de programmation </li><li>  Fonctionnalit√©s avanc√©es de l'utilisation du composant NoSQL </li><li>  Compressions de diff√©rents types (gzip, zstd, snappy) pour les fichiers ou les valeurs dans les archives Bolt et pour les fichiers ordinaires </li><li>  Cryptage de diff√©rents types de fichiers ou de valeurs dans les archives Bolt et pour les fichiers ordinaires </li><li>  Conversion vid√©o de serveur retard√©e, y compris GPU </li></ul><br>  C'est tout, j'esp√®re que ce serveur sera utile pour quelqu'un, licence BSD-3, double copyright, car il n'y aurait pas d'entreprise o√π je travaille, je n'√©crirais pas non plus de serveur.  Je suis d√©veloppeur au singulier.  Je serais reconnaissant pour les bogues trouv√©s et les demandes de fonctionnalit√©s. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr484312/">https://habr.com/ru/post/fr484312/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr484300/index.html">Powershell fonctionnel avec des classes - pas un oxymore, je le garantis</a></li>
<li><a href="../fr484302/index.html">Slurm DevOps - une meilleure m√©sange fonctionnelle en 3 jours qu'une belle grue dans un avenir lointain</a></li>
<li><a href="../fr484304/index.html">La Chine a adopt√© son "paquet de printemps"</a></li>
<li><a href="../fr484306/index.html">La capacit√© d'apprentissage peut √™tre ind√©cidable</a></li>
<li><a href="../fr484310/index.html">Biblioth√®que JavaScript Webix vue par un d√©butant. Partie 2. Travailler avec des formulaires</a></li>
<li><a href="../fr484320/index.html">Cr√©ation d'un microservice sur Quarkus, Kotlin et Gradle</a></li>
<li><a href="../fr484326/index.html">Aller √† Londres ou mon stage chez Jump Trading</a></li>
<li><a href="../fr484328/index.html">Paul Graham annonce un nouveau langage de programmation Bel</a></li>
<li><a href="../fr484330/index.html">[Nginx] Comment battre response_status = 0</a></li>
<li><a href="../fr484332/index.html">Concentrez-vous sur la gestion des t√¢ches. Comment nous faisons notre syst√®me de gestion</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>