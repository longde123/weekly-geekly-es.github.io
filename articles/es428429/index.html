<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üïé ü§üüèª üî≥ GOST R 34.10 firma electr√≥nica de documentos PDF en la suite ofim√°tica LibreOffice üèí üëù üôçüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A pesar de todos los incendios , ha llegado el momento de cumplir con nuestro deber c√≠vico: pagar impuestos. Pagaremos impuestos a trav√©s del portal d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>GOST R 34.10 firma electr√≥nica de documentos PDF en la suite ofim√°tica LibreOffice</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/428429/"><img src="https://habrastorage.org/webt/ds/ly/0g/dsly0gpk3xho5hfte1ksa3pmprg.png" align="left">  A pesar de todos los <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">incendios</a> , ha llegado el momento de cumplir con nuestro deber c√≠vico: pagar impuestos.  Pagaremos impuestos a trav√©s del portal de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Servicios</a> del <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Estado</a> .  Ingresaremos a la cuenta personal del portal de Servicios del Estado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">utilizando una</a> firma electr√≥nica ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">terminolog√≠a</a> del portal de Servicios del Estado), es decir.  tener a mano un certificado obtenido en un centro de certificaci√≥n acreditado (CA) y una clave privada.  Ambos los <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">guardo en el token PKCS # 11</a> con soporte para la criptograf√≠a rusa: <br><a name="habracut"></a><br><img src="https://habrastorage.org/webt/kb/hc/so/kbhcsojl7sh1w4rnu9au8johwje.png"><br><br>  Y as√≠, habiendo cumplido con mi deber c√≠vico, decid√≠ verificar una vez m√°s el funcionamiento de la firma electr√≥nica en la suite de oficina de oficina <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://www.google.ru/url%3Fsa%3Dt%26rct%3Dj%26q%3D%26esrc%3Ds%26source%3Dweb%26cd%3D1%26cad%3Drja%26uact%3D8%26ved%3D2ahUKEwj4kPyNm7HeAhUE_SoKHU-iA7AQFjAAegQIAxAC%26url%3D">libre</a> . <br><br>  ¬øPor qu√© decid√≠ hacer esto?  Para acceder al portal de servicios estatales, utilizo Linux y el navegador Redfox, que es un navegador Mozilla Firefox modificado con soporte de criptograf√≠a rusa.  Como saben, la suite ofim√°tica libreoffice tambi√©n utiliza la tienda NSS como una tienda de certificados. <br><br>  El navegador Redfox-52 se instal√≥ en la carpeta / usr / local / lib64 / firefox-52. <br><br>  Para conectar las bibliotecas del paquete NSS (Network Security Services) con soporte para algoritmos GOST, establezca el valor de la variable LD_LIBRARY_PATH de la siguiente manera: <br><br><pre><code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$export</span></span> LD_LIBRARY_PATH=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/lib64/firefox-52:<span class="hljs-variable"><span class="hljs-variable">$LD_LIBRARY_PATH</span></span> $</code> </pre> <br>  Como almac√©n de certificados, libreoffice generalmente usa un almac√©n de certificados de Firefox, el cliente de correo electr√≥nico Thunderbird o el paquete integrado Seamonkey.  Nada le impide usar el almac√©n de certificados del navegador GoogleChrome / Cromium o crear su propia tienda independiente (Herramientas-&gt; Opciones-&gt; Seguridad-&gt; Certificado): <br><br><img src="https://habrastorage.org/webt/fu/we/8r/fuwe8rrzfjin4gzvntoag8itdfc.png"><br><br>  Despu√©s de seleccionar el almacenamiento, las bibliotecas se conectan, ejecutan libreoffice, crean un archivo impar e intentan firmarlo (Archivo-&gt; Firmas digitales-&gt; Firmas digitales). <br><br>  Los certificados en el repositorio de Firefox / NSS se muestran y verifican con √©xito: <br><br><img src="https://habrastorage.org/webt/se/ic/bn/seicbnhqivgte6wakn7kym63lck.png"><br><br>  Sin embargo, la firma despu√©s de seleccionar el certificado y presionar el bot√≥n OK no se forma: <br><br><img src="https://habrastorage.org/webt/di/l0/id/dil0idhl4l_x4zetlzrdiguxkr8.png"><br><br>  Parece que libreoffice no quiere entender los algoritmos criptogr√°ficos rusos, a pesar del hecho de que NSS se usa desde el navegador Redfox, que comprende los algoritmos GOST, lo que se confirma mediante una verificaci√≥n de certificado exitosa. <br><br>  Hacemos el segundo intento: esta vez intentaremos firmar el archivo PDF.  Para hacer esto, exporte el documento preparado en formato PDF.  Para firmar un archivo PDF, naturalmente necesita descargarlo (Archivo-&gt; Firmas digitales-&gt; Firmar PDF).  Despu√©s de descargarlo, intentamos firmarlo (Archivo-&gt; Firmas digitales-&gt; Firmas digitales) (ver arriba, seleccione el certificado, especifique, por ejemplo, el prop√≥sito de firmar el documento): <br><br><img src="https://habrastorage.org/webt/s1/eg/wz/s1egwzum3-s8q8krjgljjl8xjo4.png"><br><br>  Y se forma la firma !!!  Vemos que la firma, que se forma sobre la base del certificado "Prueba 12 512" con la clave GOST R 34.10-2012 512 bits.  La firma es correcta. <br><br>  Saliendo de la oficina libre.  Ejecute libreoffice nuevamente, cargue el archivo pdf firmado, verifique las firmas.  Todo esta bien.  Ver certificados de firmantes.  Todo esta bien.  Milagros!  Firmar archivos PDF funciona.  Ponemos la segunda, tercera firma ... Todo funciona.  Pero algo es inquietante.  Hacemos un chequeo adicional. <br><br>  Abra el archivo PDF firmado (utilic√© el editor incorporado de mc - Midnight Commander - administrador de archivos de consola para Linux).  Encuentre la firma electr√≥nica (/ Type / Sig /): <br><br><img src="https://habrastorage.org/webt/q3/kh/ja/q3khjadn38etedwmwo7jdmiyrhk.png"><br><br>  Como puede ver, la firma se almacena en forma hexadecimal simb√≥lica.  Lo copiamos y lo guardamos en un archivo.  Para convertir el archivo a binario (codificaci√≥n DER), utilizamos la utilidad xxd: <br><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$xxd</span></span> ‚Äìp ‚Äìr &lt;    PDF&gt; &gt; &lt;&gt;.der $</code> </pre> <br>  El archivo resultante contiene una firma de formato PKCS # 7 con codificaci√≥n DER desconectada.  Ahora esta firma se puede ver con cualquier asn1-prase, por ejemplo, con la utilidad openssl.  Pero como estamos hablando del paquete NSS, usaremos la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">utilidad</a> derdump o la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">utilidad pp</a> : <br><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$pp</span></span> ‚Äìt p7 ‚Äìu ‚Äìi pkcs7_detach.p7 PKCS <span class="hljs-comment"><span class="hljs-comment">#7 Content Info: PKCS #7 Signed Data: Version: 1 (0x1) Digest Algorithm List: Digest Algorithm (1): SHA-256 Content Information: PKCS #7 Data: &lt;no content&gt; Certificate List: Certificate (1): Data: Version: 3 (0x2) Serial Number: 4107 (0x100b) Signature Algorithm: GOST R 34.10-2012 signature with GOST R 34.11-2012-512 Issuer: "E=ca_12_512@lissi.ru,OGRN=1234567890123,INN=1234 56789012,CN= 12_512,O= 12_512,L=GnuPG  -2012-512,ST= ,C=RU" Validity: Not Before: Sat Sep 08 07:17:56 2018 Not After : Tue Sep 12 07:17:56 2023 Subject: "C=RU,ST= ,CN=  ,SN=,givenName= ,E=xx@xx.ru,L= ,STREET=,INN=123456789012,SNILS=12345678901" Subject Public Key Info: Public Key Algorithm: GOST R 34.10-2012 512 Public Key: . . . Digest Encryption Algorithm: GOST R 34.10-2012 Key 512 Encrypted Digest: 34:9d:6f:37:e6:60:00:ed:fe:ef:f7:96:db:52:66:e1: 47:4c:5d:da:7f:9f:f3:20:50:ac:73:6c:97:db:f9:8d: 43:9b:8f:40:61:99:d3:4b:17:08:b8:34:e3:1e:92:76: b1:0c:dd:37:01:1e:2a:30:45:68:06:af:3d:33:5e:2f: 71:c8:17:b3:a9:8a:6b:2f:78:9e:e4:b2:00:59:6f:5a: a0:c5:9e:be:1e:4b:ca:d5:64:25:50:1a:6f:f9:55:b8: 3a:cf:37:a0:04:eb:89:b4:6c:39:77:27:92:de:61:c7: b1:d3:a5:2f:ef:66:9b:f5:71:42:77:0a:d2:10:7f:50 $</span></span></code> </pre> <br>  Y luego qued√≥ claro que no todo es tan bueno.  S√≠, el algoritmo de cifrado impl√≠cito: GOST R 34.10-2012 Algoritmo de firma clave 512 de acuerdo con el certificado seleccionado para la firma, pero la firma se genera a partir de un hash calculado utilizando el algoritmo SHA-256 (Algoritmo impl√≠cito (1): SHA-256).  Y esto es incorrecto desde el punto: el hash para GOST R 34.10-2012 Key 512 debe considerarse de acuerdo con el algoritmo GOST R 34.11-2012-512. <br><br>  Vayamos al an√°lisis del c√≥digo fuente de libreoffice: el diablo no es tan terrible como est√° pintado.  En este art√≠culo, consideramos el uso del paquete NSS para generar una firma electr√≥nica.  Si alguien prefiere la plataforma MS Windows, use CryptoAPI (y, en consecuencia, GOST-CSP), puede, por analog√≠a con este material, realizar la revisi√≥n correspondiente. <br><br>  El an√°lisis mostr√≥ que los cambios deber√°n realizarse en solo dos archivos: <br>  - <i>~ / libreoffice-5.3.7.2 / vcl / source / gdi / pdfwriter_impl.cxx</i> <br>  - <i>~ / libreoffice-5.3.7.2 / xmlsecurity / source / pdfio / pdfdocument.cxx</i> <br><br>  Estos cambios est√°n asociados con la selecci√≥n correcta de la funci√≥n hash para los certificados GOST.  La elecci√≥n de una funci√≥n hash se determinar√° seg√∫n el tipo de clave de certificado.  Elegir un algoritmo hash, por ejemplo, en PDFWriter :: Sign (archivo pdfwriter_impl.cxx) se ver√° as√≠: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> PDFWriter::Sign(PDFSignContext&amp; rContext) { <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> _WIN32 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* */</span></span></span><span class="hljs-meta"> SECKEYPublicKey *pubk = NULL; SECOidTag hashAlgTag; HASH_HashType hashType; int hashLen; CERTCertificate *cert = CERT_DecodeCertFromPackage(reinterpret_cast</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;char *&gt;(rContext.m_pDerEncoded), rContext.m_nDerEncoded); if (!cert) { SAL_WARN("vcl.pdfwriter", "CERT_DecodeCertFromPackage failed"); return false; } /*    */ pubk = CERT_ExtractPublicKey(cert); if (pubk == NULL) return NULL; /*   */ switch(pubk-&gt;keyType){ case gost3410Key: hashAlgTag = SEC_OID_GOSTHASH; hashType = HASH_AlgGOSTHASH; hashLen = SHA256_LENGTH; break; case gost3410Key_256: hashAlgTag = SEC_OID_GOST3411_2012_256; hashType = HASH_AlgGOSTHASH_12_256; hashLen = SHA256_LENGTH; break; case gost3410Key_512: hashAlgTag = SEC_OID_GOST3411_2012_512; hashLen = SHA256_LENGTH * 2; hashType = HASH_AlgGOSTHASH_12_512; break; default: hashAlgTag = SEC_OID_SHA256; hashType = HASH_AlgSHA256; hashLen = SHA256_LENGTH; break; } /* */ HashContextScope hc(HASH_Create(hashType)); . . . }</span></span></span></span></code> </pre> <br>  Otros cambios en la l√≥gica son similares a estos.  Se encuentra el parche para el archivo ~ / libreoffice-5.3.7.2 / vcl / source / gdi / pdfwriter_impl.cxx <br><br><div class="spoiler">  <b class="spoiler_title">aqui:</b> <div class="spoiler_text"><pre> <code class="diff hljs"><span class="hljs-comment"><span class="hljs-comment">--- pdfwriter_impl_ORIG.cxx 2017-10-25 17:25:39.000000000 +0300 +++ pdfwriter_impl.cxx 2018-10-31 19:48:32.078482227 +0300 @@ -6698,6 +6698,9 @@ CERTCertificate *cert, SECItem *digest) { + SECKEYPublicKey *pubk = NULL; + SECOidTag hashAlgTag; + NSSCMSMessage *result = NSS_CMSMessage_Create(nullptr); if (!result) { @@ -6732,8 +6735,31 @@ NSS_CMSMessage_Destroy(result); return nullptr; } - + pubk = CERT_ExtractPublicKey(cert); + if (pubk == NULL) + return NULL; + switch(pubk-&gt;keyType){ + case gost3410Key: + hashAlgTag = SEC_OID_GOSTHASH; +fprintf(stderr, "CreateCMSMessage: gost3410Key Use HASH_AlgGOSTHASH_=%d\n", hashAlgTag); + break; + case gost3410Key_256: + hashAlgTag = SEC_OID_GOST3411_2012_256; +fprintf(stderr, "CreateCMSMessage: gost3410Key_256 Use HASH_AlgGOSTHASH_=%d\n", hashAlgTag); + break; + case gost3410Key_512: + hashAlgTag = SEC_OID_GOST3411_2012_512; +fprintf(stderr, "CreateCMSMessage: gost3410Key_512 Use HASH_AlgGOSTHASH_=%d\n", hashAlgTag); + break; + default: + hashAlgTag = SEC_OID_SHA256; + break; + } +/* *cms_signer = NSS_CMSSignerInfo_Create(result, cert, SEC_OID_SHA256); +*/ + *cms_signer = NSS_CMSSignerInfo_Create(result, cert, hashAlgTag); + if (!*cms_signer) { SAL_WARN("vcl.pdfwriter", "NSS_CMSSignerInfo_Create failed"); @@ -6773,8 +6799,8 @@ NSS_CMSMessage_Destroy(result); return nullptr; } + if (NSS_CMSSignedData_SetDigestValue(*cms_sd, hashAlgTag, digest) != SECSuccess) - if (NSS_CMSSignedData_SetDigestValue(*cms_sd, SEC_OID_SHA256, digest) != SECSuccess) { SAL_WARN("vcl.pdfwriter", "NSS_CMSSignedData_SetDigestValue failed"); NSS_CMSSignedData_Destroy(*cms_sd); @@ -6982,6 +7008,10 @@ bool PDFWriter::Sign(PDFSignContext&amp; rContext) { #ifndef _WIN32 + SECKEYPublicKey *pubk = NULL; + SECOidTag hashAlgTag; + HASH_HashType hashType; + int hashLen; CERTCertificate *cert = CERT_DecodeCertFromPackage(reinterpret_cast&lt;char *&gt;(rContext.m_pDerEncoded), rContext.m_nDerEncoded); @@ -6990,8 +7020,33 @@ SAL_WARN("vcl.pdfwriter", "CERT_DecodeCertFromPackage failed"); return false; } + pubk = CERT_ExtractPublicKey(cert); + if (pubk == NULL) + return NULL; + switch(pubk-&gt;keyType){ + case gost3410Key: + hashAlgTag = SEC_OID_GOSTHASH; + hashType = HASH_AlgGOSTHASH; + hashLen = SHA256_LENGTH; + break; + case gost3410Key_256: + hashAlgTag = SEC_OID_GOST3411_2012_256; + hashType = HASH_AlgGOSTHASH_12_256; + hashLen = SHA256_LENGTH; + break; + case gost3410Key_512: + hashAlgTag = SEC_OID_GOST3411_2012_512; + hashLen = SHA256_LENGTH * 2; + hashType = HASH_AlgGOSTHASH_12_512; + break; + default: + hashAlgTag = SEC_OID_SHA256; + hashType = HASH_AlgSHA256; + hashLen = SHA256_LENGTH; + break; + } + HashContextScope hc(HASH_Create(hashType)); - HashContextScope hc(HASH_Create(HASH_AlgSHA256)); if (!hc.get()) { SAL_WARN("vcl.pdfwriter", "HASH_Create failed"); @@ -7005,15 +7060,18 @@ HASH_Update(hc.get(), static_cast&lt;const unsigned char*&gt;(rContext.m_pByteRange2), rContext.m_nByteRange2); SECItem digest; - unsigned char hash[SHA256_LENGTH]; + unsigned char hash[SHA256_LENGTH * 2]; + digest.data = hash; - HASH_End(hc.get(), digest.data, &amp;digest.len, SHA256_LENGTH); + HASH_End(hc.get(), digest.data, &amp;digest.len, hashLen); + hc.clear(); #ifdef DBG_UTIL { FILE *out = fopen("PDFWRITER.hash.data", "wb"); - fwrite(hash, SHA256_LENGTH, 1, out); + fwrite(hash, hashLen, 1, out); + fclose(out); } #endif @@ -7078,8 +7136,8 @@ fclose(out); } #endif + HashContextScope ts_hc(HASH_Create(hashType)); - HashContextScope ts_hc(HASH_Create(HASH_AlgSHA256)); if (!ts_hc.get()) { SAL_WARN("vcl.pdfwriter", "HASH_Create failed"); @@ -7090,16 +7148,19 @@ HASH_Begin(ts_hc.get()); HASH_Update(ts_hc.get(), ts_cms_signer-&gt;encDigest.data, ts_cms_signer-&gt;encDigest.len); SECItem ts_digest; - unsigned char ts_hash[SHA256_LENGTH]; + unsigned char ts_hash[SHA256_LENGTH * 2]; + ts_digest.type = siBuffer; ts_digest.data = ts_hash; - HASH_End(ts_hc.get(), ts_digest.data, &amp;ts_digest.len, SHA256_LENGTH); + HASH_End(ts_hc.get(), ts_digest.data, &amp;ts_digest.len, hashLen); + ts_hc.clear(); #ifdef DBG_UTIL { FILE *out = fopen("PDFWRITER.ts_hash.data", "wb"); - fwrite(ts_hash, SHA256_LENGTH, 1, out); + fwrite(ts_hash, hashLen, 1, out); + fclose(out); } #endif @@ -7111,7 +7172,8 @@ src.messageImprint.hashAlgorithm.algorithm.data = nullptr; src.messageImprint.hashAlgorithm.parameters.data = nullptr; - SECOID_SetAlgorithmID(nullptr, &amp;src.messageImprint.hashAlgorithm, SEC_OID_SHA256, nullptr); + SECOID_SetAlgorithmID(nullptr, &amp;src.messageImprint.hashAlgorithm, hashAlgTag, nullptr); + src.messageImprint.hashedMessage = ts_digest; src.reqPolicy.type = siBuffer; @@ -7340,11 +7402,13 @@ // Write ESSCertIDv2.hashAlgorithm. aCertID.hashAlgorithm.algorithm.data = nullptr; aCertID.hashAlgorithm.parameters.data = nullptr; - SECOID_SetAlgorithmID(nullptr, &amp;aCertID.hashAlgorithm, SEC_OID_SHA256, nullptr); + SECOID_SetAlgorithmID(nullptr, &amp;aCertID.hashAlgorithm, hashAlgTag, nullptr); + // Write ESSCertIDv2.certHash. SECItem aCertHashItem; - unsigned char aCertHash[SHA256_LENGTH]; - HashContextScope aCertHashContext(HASH_Create(HASH_AlgSHA256)); + unsigned char aCertHash[SHA256_LENGTH*2]; + HashContextScope aCertHashContext(HASH_Create(hashType)); + if (!aCertHashContext.get()) { SAL_WARN("vcl.pdfwriter", "HASH_Create() failed"); @@ -7354,7 +7418,8 @@ HASH_Update(aCertHashContext.get(), reinterpret_cast&lt;const unsigned char *&gt;(rContext.m_pDerEncoded), rContext.m_nDerEncoded); aCertHashItem.type = siBuffer; aCertHashItem.data = aCertHash; - HASH_End(aCertHashContext.get(), aCertHashItem.data, &amp;aCertHashItem.len, SHA256_LENGTH); + HASH_End(aCertHashContext.get(), aCertHashItem.data, &amp;aCertHashItem.len, hashLen); + aCertID.certHash = aCertHashItem; // Write ESSCertIDv2.issuerSerial. IssuerSerial aSerial;</span></span></code> </pre> <br></div></div><br>  Se encuentra el parche para el archivo ~ / libreoffice-5.3.7.2 / xmlsecurity / source / pdfio / pdfdocument.cxx <br><br><div class="spoiler">  <b class="spoiler_title">aqui:</b> <div class="spoiler_text"><pre> <code class="diff hljs"><span class="hljs-comment"><span class="hljs-comment">--- pdfdocument_ORIG.cxx 2017-10-25 17:25:39.000000000 +0300 +++ pdfdocument.cxx 2018-10-31 19:49:34.174485641 +0300 @@ -2400,6 +2400,19 @@ case SEC_OID_PKCS1_SHA512_WITH_RSA_ENCRYPTION: eOidTag = SEC_OID_SHA512; break; + case SEC_OID_GOST3410_SIGN_256: + case SEC_OID_GOST3411_2012_256: + eOidTag = SEC_OID_GOST3411_2012_256; + break; + case SEC_OID_GOST3410_SIGN_512: + case SEC_OID_GOST3411_2012_512: + eOidTag = SEC_OID_GOST3411_2012_512; + break; + case SEC_OID_GOST3410_SIGNATURE: + case SEC_OID_GOSTHASH: + eOidTag = SEC_OID_GOSTHASH; + break; + default: break; } @@ -2453,6 +2466,16 @@ case SEC_OID_SHA512: nMaxResultLen = msfilter::SHA512_HASH_LENGTH; break; + case SEC_OID_GOST3411_2012_256: + nMaxResultLen = msfilter::SHA256_HASH_LENGTH; + break; + case SEC_OID_GOST3411_2012_512: + nMaxResultLen = msfilter::SHA512_HASH_LENGTH; + break; + case SEC_OID_GOSTHASH: + nMaxResultLen = msfilter::SHA256_HASH_LENGTH; + break; + default: SAL_WARN("xmlsecurity.pdfio", "PDFDocument::ValidateSignature: unrecognized algorithm"); return false;</span></span></code> </pre> <br></div></div><br>  Despu√©s de hacer los cambios, creamos el paquete libreoffice.  Los cambios realizados afectaron a tres bibliotecas (/ usr / lib64 / libreoffice / program): <br><br><ul><li>  <i>libvcllo.so</i> ; </li><li>  <i>libxmlsecurity.so</i> ; </li><li>  <i>libxsec-xmlsec.so</i> </li></ul><br>  Estas tres bibliotecas fueron reemplazadas en la distribuci√≥n de libreoffice instalada (/ usr / lib64 / libreoffice / program). <br><br>  Despu√©s de eso, la firma y verificaci√≥n de la firma GOST en los archivos PDF se realiz√≥ sin problemas.  Y aqu√≠, en uno de los sitios, uno capta la atenci√≥n de este extracto: <br><blockquote>  El Servicio de Impuestos Federales tiene un excelente <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">servicio</a> para obtener un extracto del Registro Estatal Unificado de Entidades Legales para cualquier entidad legal, y de forma absolutamente gratuita.  Se puede obtener un extracto en forma de documento PDF firmado por una firma electr√≥nica calificada.  Y dicho extracto puede enviarse a un banco comercial, agencia gubernamental, y no se le solicitar√° en papel.  En general, muy c√≥modo. </blockquote>  Ordenamos, recibimos y verificamos: <br><br><img src="https://habrastorage.org/webt/ye/rt/ul/yertuldamhhmiwc6wmveofj1a60.png"><br><br>  Vale la pena recordar que no debe olvidar instalar en el repositorio una cadena de certificados de confianza para el certificado del firmante.  Pero esto es natural. <br><br>  Eso es todo, ahora existe la posibilidad de usar una firma electr√≥nica (una o m√°s) en archivos PDF.  Es muy conveniente tanto al coordinar documentos como al almacenar documentos. <br><br>  Y si alguien est√° acostumbrado a trabajar con la firma electr√≥nica cl√°sica en formato PKCS # 7 conectada y desconectada, se ha <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">preparado</a> una versi√≥n actualizada (para las plataformas Linux y Windows) del paquete de gr√°ficos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">GUINSSPY</a> : <br><br><img src="https://habrastorage.org/webt/qw/rz/h_/qwrzh_squqc7zzcd0qibmoakuyi.png"><br><br>  El desarrollo se realiz√≥ en Python3 y si no hubo problemas en la plataforma Linux, entonces en MS Windows tuve que sudar con las codificaciones.  De hecho, fue un desarrollo separado y esto requiere un art√≠culo separado.  Todos estos matices se pueden ver en el c√≥digo fuente. <br><br>  Con esta utilidad, puede crear un almac√©n de certificados para libreoffice, administrar certificados, firmar archivos, etc. <br><br><img src="https://habrastorage.org/webt/3g/ge/zc/3ggezcie8_pq5mbnpnd_jtz9z14.png"><br><br>  La utilidad tambi√©n le permite crear una solicitud de certificado con la generaci√≥n de un par de claves, que luego puede transferirse al centro de certificaci√≥n, e instalar el certificado recibido en el repositorio: <br><br><img src="https://habrastorage.org/webt/xh/st/fx/xhstfxznuqdaoqk_rhl2llwthdk.png"><br><br>  Y si los fabricantes de tenedores dom√©sticos de Linux modificaron varios paquetes (NSS, Firefox, Thunderbiird, GnuPG / SMIME, SSH, KMail, Kleopatra, LibreOffice, OpenSSL, etc., etc.) para trabajar con criptograf√≠a rusa, entonces puede Se tratar√≠a de la sustituci√≥n de importaciones en el campo de la criptograf√≠a. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es428429/">https://habr.com/ru/post/es428429/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es428415/index.html">Descripci√≥n general del controlador de nube TP-Link Omada OC200</a></li>
<li><a href="../es428417/index.html">Aprendizaje autom√°tico en MatLab / Octave: ejemplos de algoritmos admitidos por f√≥rmulas</a></li>
<li><a href="../es428419/index.html">Arrastra y desliza en RecyclerView. Parte 2: arrastrar y soltar controladores, cuadr√≠culas y animaciones personalizadas</a></li>
<li><a href="../es428421/index.html">Sistema flexible para probar y recopilar m√©tricas de programas utilizando el conjunto de pruebas LLVM como ejemplo</a></li>
<li><a href="../es428423/index.html">C√≥mo un acuerdo de $ 34 mil millones entre IBM y Red Hat cambiar√° el mercado de TI: expertos y analistas</a></li>
<li><a href="../es428431/index.html">M√°s que capas conc√©ntricas</a></li>
<li><a href="../es428433/index.html">Abogados de pruebas privadas</a></li>
<li><a href="../es428435/index.html">¬øQu√© leer en PHP en ruso?</a></li>
<li><a href="../es428437/index.html">Cartera de manzana Qu√© es y c√≥mo integrar su tarjeta en ella</a></li>
<li><a href="../es428439/index.html">Sin conjunto</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>