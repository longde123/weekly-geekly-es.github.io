<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🛐 👩🏾‍🤝‍👨🏼 💅🏼 Les bases du routage statique dans Mikrotik RouterOS 📯 🔰 👷🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Le routage est le processus de recherche du chemin optimal pour la transmission de paquets sur les réseaux TCP / IP. Tout périphérique connecté à un r...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Les bases du routage statique dans Mikrotik RouterOS</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/443788/"><p>  Le routage est le processus de recherche du chemin optimal pour la transmission de paquets sur les réseaux TCP / IP.  Tout périphérique connecté à un réseau IPv4 contient un processus et des tables de routage. </p><br><p>  Cet article n'est pas un HOWTO, il décrit le routage statique dans RouterOS à titre d'exemple, j'ai intentionnellement omis le reste des paramètres (par exemple, srcnat pour accéder à Internet), donc la compréhension de ce matériel nécessite un certain niveau de connaissance des réseaux et de RouterOS. </p><a name="habracut"></a><br><h3 id="kommutaciya-i-marshrutizaciya">  Commutation et routage </h3><br><p><img src="https://habrastorage.org/webt/5v/h7/a2/5vh7a2relrje9g9e5kbonuogsqw.png"></p><br><p>  La commutation est le processus d'échange de paquets au sein d'un segment de couche 2 (Ethernet, ppp, ...).  Si l'appareil voit que le destinataire du paquet se trouve sur le même sous-réseau Ethernet que lui, il reconnaît l'adresse mac à l'aide du protocole arp et envoie le paquet directement, en contournant le routeur.  Une connexion ppp (point à point) ne peut avoir que deux membres et le paquet est toujours envoyé à la même adresse 0xff. </p><br><p>  Le routage est le processus de transmission des paquets entre les segments de la couche 2.  Si le périphérique veut envoyer un paquet, dont le destinataire est en dehors du segment Ethernet, il regarde sa table de routage et transmet le paquet à une passerelle qui sait où envoyer le paquet plus loin (ou peut-être qu'il ne sait pas, l'expéditeur d'origine du paquet n'est pas au courant de cela). </p><br><p>  La façon la plus simple de considérer un routeur est comme un périphérique connecté à deux segments Layer2 ou plus et capable de transférer des paquets entre eux, déterminant la route optimale à partir de la table de routage. </p><br><p>  Si tout est clair pour vous ou si vous le saviez déjà, poursuivez votre lecture.  Je recommande fortement aux autres de lire un petit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article</a> très complet. </p><br><h3 id="marshrutizaciya-v-routeros-i-packetflow">  Routage dans RouterOS et PacketFlow </h3><br><p>  Presque toutes les fonctionnalités liées au routage statique se trouvent dans le package <em>système</em> .  Le package de <em>routage</em> ajoute la prise en charge des algorithmes de routage dynamique (RIP, OSPF, BGP, MME), des filtres de routage et BFD. </p><br><p> Le menu principal pour configurer le routage: <code>[IP]-&gt;[Route]</code> .  Les schémas complexes peuvent nécessiter un étiquetage préliminaire des paquets avec une étiquette de routage dans: <code>[IP]-&gt;[Firewall]-&gt;[Mangle]</code> (chaînes <code>PREROUTING</code> et <code>OUTPUT</code> ). </p><br><p>  Il y a trois endroits sur PacketFlow où les décisions sont prises concernant le routage des paquets IP: <br><img src="https://habrastorage.org/webt/pk/ie/mp/pkiempktzjkwz6tcwrnwyl1c1dc.png"></p><br><ol><li>  Routage des paquets reçus par le routeur.  À ce stade, il est décidé que le paquet ira au processus local ou sera envoyé plus loin au réseau.  Les paquets de transit reçoivent une <em>interface de sortie</em> </li><li>  Routage des paquets sortants locaux.  Les paquets sortants reçoivent une <em>interface de sortie</em> </li><li>  Une étape de routage supplémentaire pour les paquets sortants vous permet de modifier la décision de routage dans <code>[Output|Mangle]</code> </li></ol><br><ul><li>  Le chemin des paquets dans les blocs 1, 2 dépend des règles dans <code>[IP]-&gt;[Route]</code> </li><li>  Le chemin des paquets aux étapes 1, 2 et 3 dépend des règles dans <code>[IP]-&gt;[Route]-&gt;[Rules]</code> </li><li>  Le chemin des paquets dans les blocs 1, 3 peut être affecté à l'aide de <code>[IP]-&gt;[Firewall]-&gt;[Mangle]</code> </li></ul><br><h3 id="rib-fib-routing-cache">  RIB, FIB, cache de routage </h3><br><p><img src="https://habrastorage.org/webt/fw/jc/ku/fwjckuzqzyxo4udazveb8uhotuq.png"></p><br><p>  <strong>Base d'informations de routage</strong> <br>  Base dans laquelle sont collectées les routes issues des protocoles de routage dynamique, les routes provenant de ppp et dhcp, les routes statiques et connectées.  Cette base de données contient toutes les routes sauf celles filtrées par l'administrateur. </p><br><p>  <em>Par convention</em> , nous pouvons supposer que <code>[IP]-&gt;[Route]</code> affiche RIB. </p><br><p>  <strong>Base d'informations de transfert</strong> <br><img src="https://habrastorage.org/webt/kt/jn/q1/ktjnq1ebrd0--d9afkseuixtap8.png"></p><br><p>  La base où les meilleurs itinéraires de RIB vont.  Toutes les routes de la FIB sont actives et sont utilisées pour transmettre des paquets.  Si la route devient inactive (désactivée par l'administrateur (système), ou si l'interface via laquelle le paquet doit être envoyé est inactive), la route est supprimée de la FIB. </p><br><p>  Pour prendre une décision concernant le routage, les données de paquets IP suivantes sont utilisées dans la table FIB: </p><br><ul><li>  Adresse source </li><li>  Adresse de destination </li><li>  Interface source </li><li>  Marque de routage </li><li>  ToS (DSCP) </li></ul><br><p>  L'entrée dans le package FIB passe par les étapes suivantes: </p><br><ul><li>  Le package est-il conçu pour le processus de routeur local? </li><li>  Le package relève-t-il du système PBR ou des règles utilisateur? <br><ul><li>  Si c'est le cas, le paquet est envoyé à la table de routage spécifiée. </li></ul></li><li>  Le paquet est envoyé à la table principale </li></ul><br><p>  <em>Par convention</em> , nous pouvons supposer que <code>[IP]-&gt;[Route Active=yes]</code> affiche FIB. </p><br><p>  <strong>Cache de routage</strong> <br>  Le mécanisme de mise en cache des itinéraires.  Le routeur se souvient de l'endroit où les paquets ont été envoyés, et s'il y en a de semblables (vraisemblablement à partir de la même connexion), il les démarre sur la même route, sans archiver le FIB.  Le cache d'itinéraire est périodiquement effacé. </p><br><p>  Pour les administrateurs, RouterOS n'avait pas les moyens de visualiser et de gérer le cache de routage, mais avec lui, vous pouvez le désactiver dans <code>[IP]-&gt;[Settings]</code> . </p><br><p>  <em>Ce mécanisme a été supprimé du noyau Linux 3.6, mais le noyau 3.3.5 est toujours utilisé dans RouterOS, peut-être que le cache de routage est l'une des raisons.</em> </p><br><h3 id="dialog-dobavleniya-marshruta">  Boîte de dialogue Ajouter un itinéraire </h3><br><p> <code>[IP]-&gt;[Route]-&gt;[+]</code> <br> <img src="https://habrastorage.org/webt/th/lb/el/thlbel_kvf2gk-s2125imh_z7cg.png"></p><br><ol><li>  Le sous-réseau pour lequel vous souhaitez créer un itinéraire (par défaut: 0.0.0.0/0) </li><li>  IP de passerelle ou interface vers laquelle le paquet sera envoyé (il peut y en avoir plusieurs, voir ECMP ci-dessous) </li><li>  Vérification de la disponibilité de la passerelle </li><li>  Type d'enregistrement </li><li>  Distance (métrique) pour l'itinéraire </li><li>  Table de routage </li><li>  IP pour les paquets sortants locaux via cette route </li><li>  L'objectif de Scope et Target Scope est écrit à la fin de l'article. </li></ol><br><p>  <strong>Drapeaux de route</strong> <br><img src="https://habrastorage.org/webt/ai/ro/iv/airoivo1bmk3lgbqj_hivpbjdyc.png"></p><br><ul><li>  X - La route est désactivée par l'administrateur ( <code>disabled=yes</code> ) </li><li>  A - La route est utilisée pour transmettre des paquets. </li><li>  D - Route ajoutée dynamiquement (BGP, OSPF, RIP, MME, PPP, DHCP, connecté) </li><li>  C - Le sous-réseau est connecté directement au routeur </li><li>  S - Route statique </li><li>  r, b, o, m - La route a été ajoutée par l'un des protocoles de routage dynamique </li><li>  B, U, P - Route de filtrage (élimine les paquets au lieu de transmettre) </li></ul><br><h3 id="chto-ukazyvat-v-gateway-ip-adres-ili-interfeys">  Que spécifier dans la passerelle: adresse IP ou interface? </h3><br><p>  Le système vous permet de spécifier les deux, alors qu'il ne jure pas et ne donne pas d'indices si vous avez fait quelque chose de mal. </p><br><p>  <strong>Adresse IP</strong> <br>  L'adresse de la passerelle doit être accessible via Layer2.  Pour Ethernet, cela signifie que le routeur doit avoir une adresse IP du même sous-réseau sur l'une des interfaces actives, pour ppp - que l'adresse de la passerelle est répertoriée sur l'une des interfaces actives comme adresse de sous-réseau. <br>  Si la condition de disponibilité pour la couche 2 n'est pas remplie, la route est considérée comme inactive et ne tombe pas dans le FIB. </p><br><p>  <strong>Interface</strong> <br>  Tout est plus compliqué et le comportement du routeur dépend du type d'interface: </p><br><ul><li>  PPP (Async, PPTP, L2TP, SSTP, PPPoE, OpenVPN *) la connexion suppose qu'il n'y a que deux participants et le paquet sera toujours envoyé à la passerelle pour transmission, si la passerelle détecte qu'il est le destinataire lui-même, elle transfèrera le paquet à son processus local. <br><img src="https://habrastorage.org/webt/90/-g/xk/90-gxkgtlplrv8sstcs4r70bxx4.png"></li><li>  Ethernet suppose qu'il y a beaucoup de participants et enverra des requêtes à l'interface arp avec l'adresse du récepteur de paquets, c'est le comportement attendu et tout à fait normal pour les routes connectées. <br>  Mais lorsque vous essayez d'utiliser l'interface comme route pour un sous-réseau distant, vous obtenez la situation suivante: la route est active, le ping passe à la passerelle, mais n'atteint pas le destinataire à partir du sous-réseau spécifié.  Si vous regardez l'interface à travers un renifleur, vous verrez des demandes d'arp avec des adresses d'un sous-réseau distant. <br><img src="https://habrastorage.org/webt/62/si/qp/62siqpa8gbtxi-8x4eymxgv19vi.png"></li></ul><br><p><img src="https://habrastorage.org/webt/i6/-n/nb/i6-nnbyrlylq0jk6pqwefb_2qz8.png"></p><br><p>  Essayez de spécifier l'adresse IP comme passerelle dans la mesure du possible.  Les exceptions sont les routes connectées (créées automatiquement) et les interfaces PPP (Async, PPTP, L2TP, SSTP, PPPoE, OpenVPN *). </p><br><p>  <em>OpenVPN ne contient pas d'en-tête PPP, mais vous pouvez utiliser le nom d'interface OpenVPN pour créer l'itinéraire.</em> </p><br><h3 id="more-specific-route">  Itinéraire plus spécifique </h3><br><p>  La règle de base du routage.  Une route qui décrit un sous-réseau plus petit (avec le plus grand masque de sous-réseau) a une priorité plus élevée pour décider du routage des paquets.  La position des entrées dans la table de routage n'est pas liée à la sélection - la règle de base est Plus spécifique. </p><br><p><img src="https://habrastorage.org/webt/sm/cy/i9/smcyi9gkebkm8iq-yjcbev8-vs0.png"></p><br><p>  Toutes les routes du schéma spécifié sont actives (situées dans la FIB), car  pointer vers différents sous-réseaux et ne sont pas en conflit les uns avec les autres. </p><br><p>  Si l'une des passerelles devient indisponible, la route associée sera considérée comme inactive (supprimée de la FIB) et les paquets seront recherchés parmi les routes restantes. </p><br><p>  Une route avec un sous-réseau de 0.0.0.0/0 a parfois une signification particulière et est appelée «Route par défaut» ou «Passerelle de dernier recours».  En fait, il n'y a rien de magique et il inclut simplement toutes les adresses IPv4 possibles, mais ces noms décrivent bien son objectif - il indique une passerelle où transférer des paquets pour lesquels il n'y a pas d'autres itinéraires plus précis. </p><br><p>  Le masque de sous-réseau maximal possible pour IPv4 est / 32; cette route pointe vers un hôte spécifique et peut être utilisée dans la table de routage. </p><br><p>  <em>La compréhension de l'itinéraire plus spécifique est fondamentale pour tout périphérique TCP / IP.</em> </p><br><h3 id="distance">  La distance </h3><br><p>  Les distances (ou métriques) sont nécessaires pour le filtrage administratif des routes vers un sous-réseau accessible via plusieurs passerelles.  Une route avec une métrique inférieure est considérée comme une priorité et sera dans la FIB.  Si une route avec une métrique inférieure cesse d'être active, alors dans la FIB, elle sera remplacée par une route avec une métrique plus élevée. <br><img src="https://habrastorage.org/webt/dz/yz/mh/dzyzmhb2y_fjqpbkbp2juyhfxsi.png"></p><br><p>  S'il existe plusieurs routes vers le même sous-réseau avec la même métrique, le routeur n'ajoutera qu'une seule d'entre elles à la table FIB, guidée par sa logique interne. </p><br><p>  La métrique peut prendre une valeur de 0 à 255: <br><img src="https://habrastorage.org/webt/rh/fk/j1/rhfkj1shnnjhqmvwhcc7o0itq8i.png"></p><br><ul><li>  0 - Métrique pour les itinéraires connectés.  L'administrateur ne peut pas définir la distance 0 </li><li>  1-254 - Mesures disponibles pour l'administrateur pour définir les itinéraires.  Les métriques avec une valeur inférieure ont priorité. </li><li>  255 - Métrique à la disposition de l'administrateur pour définir les itinéraires.  Contrairement à 1-254, un itinéraire avec une métrique de 255 reste toujours inactif et ne tombe pas dans la FIB </li><li>  Mesures spéciales.  Les itinéraires reçus des protocoles de routage dynamique ont des valeurs métriques standard </li></ul><br><h3 id="check-gateway">  Vérifier la passerelle </h3><br><p>  Vérifier la passerelle - Extension MikroTik RoutesOS pour vérifier la disponibilité de la passerelle via icmp ou arp.  Une fois toutes les 10 secondes (ne peut pas être modifiée), une demande est envoyée à la passerelle, si la réponse ne vient pas deux fois, la route est considérée comme indisponible et est supprimée du FIB.  Si la passerelle de vérification a désactivé la route de vérification, elle continue et la route redevient active après une vérification réussie. <br><img src="https://habrastorage.org/webt/a_/km/vd/a_kmvd8xeoeyrnjqz78ciry1ja4.png"></p><br><p>  La passerelle de vérification désactive l'entrée dans laquelle elle est configurée et toutes les autres entrées (dans toutes les tables de routage et les routes ecmp) avec la passerelle spécifiée. </p><br><p>  En général, la vérification de la passerelle fonctionne correctement s'il n'y a aucun problème de perte de paquets vers la passerelle.  La passerelle de vérification ne sait pas ce qui se passe avec la communication en dehors de la passerelle vérifiée, car ces outils supplémentaires sont nécessaires: scripts, routage récursif, protocoles de routage dynamique. </p><br><p>  La plupart des VPN et des protocoles de tunnellisation contiennent des outils intégrés pour vérifier l'activité de connexion, l'activation des passerelles de contrôle pour eux est une charge supplémentaire (mais très faible) sur les performances du réseau et de l'appareil. </p><br><h3 id="ecmp-marshruty">  Itinéraires ECMP </h3><br><p>  Multi-Path à coût égal - envoi de paquets au destinataire à l'aide de plusieurs passerelles en même temps avec l'algorithme Round Robin. </p><br><p>  Un itinéraire ECMP est créé par l'administrateur en spécifiant plusieurs passerelles pour un sous-réseau (ou automatique, s'il existe deux itinéraires équivalents OSPF). <br><img src="https://habrastorage.org/webt/4v/gz/yh/4vgzyh240kmasdj186yz2c3ovws.png"></p><br><p>  ECMP est utilisé pour équilibrer la charge entre deux canaux, en théorie, s'il y a deux canaux dans une route ecmp, alors pour chaque paquet, le canal sortant doit être différent.  Mais le mécanisme de cache de routage envoie des paquets à partir de la connexion le long de la route vers laquelle le premier paquet est allé, en conséquence, nous obtenons une sorte d'équilibrage de chargement par connexion. </p><br><p>  Si vous désactivez le cache de routage, les paquets de la route ECMP seront correctement divisés, mais il y a un problème avec NAT.  La règle NAT traite uniquement le premier paquet de la connexion (les autres sont traités automatiquement) et la situation est que les paquets avec une adresse source partent de différentes interfaces. <br><img src="https://habrastorage.org/webt/gj/cw/bl/gjcwblj73dmsczyhyqyuchcpdw0.png"></p><br><p>  La passerelle de vérification (bogue RouterOS) ne fonctionne pas dans les routes ECMP.  Mais vous pouvez contourner cette limitation si vous créez des itinéraires supplémentaires pour la vérification, ce qui désactivera les entrées dans ECMP. </p><br><h3 id="filtraciya-sredstvami-routing">  Filtrage de routage </h3><br><p>  L'option Type détermine ce qu'il faut faire avec le package: </p><br><ul><li>  unicast - envoyer à la passerelle spécifiée (interface) </li><li>  trou noir - laissez tomber le paquet </li><li>  interdire, inaccessible - abandonner le paquet et envoyer un message icmp à l'expéditeur </li></ul><br><p>  Le filtrage est généralement utilisé lorsque vous devez sécuriser l'envoi de paquets de la mauvaise manière, bien sûr, vous pouvez filtrer cela via un pare-feu. </p><br><h3 id="para-primerov">  Quelques exemples </h3><br><p>  Pour corriger les choses de base sur le routage. </p><br><p>  <strong>Routeur domestique typique</strong> <br><img src="https://habrastorage.org/webt/2a/fk/xx/2afkxxlv7lhluitqufsybt3s5pg.png"></p><br><pre> <code class="plaintext hljs">/ip route add dst-address=0.0.0.0/0 gateway=10.10.10.1</code> </pre> <br><ol><li>  Route statique vers 0.0.0.0/0 (route par défaut) </li><li>  Route connectée sur l'interface avec le fournisseur </li><li>  Route connectée sur l'interface LAN </li></ol><br><p>  <strong>Routeur domestique PPPoE typique</strong> <br><img src="https://habrastorage.org/webt/im/wn/8p/imwn8pafrqins6erowkhiek2dqa.png"></p><br><ol><li>  Route statique vers la route par défaut, ajoutée automatiquement depuis  cela est indiqué dans les propriétés de connexion </li><li>  Route connectée pour la connexion PPP </li><li>  Route connectée sur l'interface LAN </li></ol><br><p>  <strong>Routeur domestique typique avec deux fournisseurs et redondance</strong> <br><img src="https://habrastorage.org/webt/wq/2a/v0/wq2av0eskridghrj9yroknjz76o.png"></p><br><pre> <code class="plaintext hljs">/ip route add dst-address=0.0.0.0/0 gateway=10.10.10.1 distance=1 check-gateway=ping add dst-address=0.0.0.0/0 gateway=10.20.20.1 distance=2</code> </pre> <br><ol><li>  Route statique vers la route par défaut via le premier fournisseur avec métrique 1 et vérification de la disponibilité de la passerelle </li><li>  Route statique vers la route par défaut via le deuxième fournisseur avec la métrique 2 </li><li>  Itinéraires connectés </li></ol><br><p>  Le trafic vers 0.0.0.0/0 passe par 10.10.10.1, alors que cette passerelle est disponible, sinon elle passe à 10.20.20.1 </p><br><p>  <em>Un tel schéma peut être considéré comme une réservation de canal, mais il n'est pas sans inconvénients.</em>  <em>Si une interruption se produit en dehors de la passerelle du fournisseur (par exemple, à l'intérieur du réseau de l'opérateur), votre routeur n'en sera pas informé et continuera à considérer l'itinéraire comme actif.</em> </p><br><p>  <strong>Routeur domestique typique avec deux fournisseurs, redondance et ECMP</strong> <br><img src="https://habrastorage.org/webt/un/fj/aw/unfjawyzmjdzo6_ekmmg93vlsk8.png"></p><br><pre> <code class="plaintext hljs">/ip route add dst-address=0.0.0.0/0 gateway=10.10.10.1 check-gateway=ping add dst-address=0.0.0.0/0 gateway=10.20.20.1 check-gateway=ping add dst-address=0.0.0.0/0 gateway=10.10.10.1,10.20.20.1 distance=1</code> </pre> <br><ol><li>  Itinéraires statiques pour vérifier la passerelle chack </li><li>  Route ECMP </li><li>  Itinéraires connectés </li></ol><br><p>  Itinéraires pour vérifier le bleu (la couleur des itinéraires inactifs), mais cela n'interfère pas avec le fonctionnement de la passerelle de contrôle.  Dans la version actuelle (6.44) RoS, la priorité automatique est donnée à la route ECMP, mais il est préférable d'ajouter des routes de test à d'autres tables de routage (option <code>routing-mark</code> ) </p><br><p>  Il n'y aura pas d'augmentation de vitesse sur Speedtest et d'autres sites similaires (ECMP divise le trafic par les connexions, pas par paquets), mais les applications p2p devraient se charger plus rapidement. </p><br><p>  <strong>Filtrage par routage</strong> <br><img src="https://habrastorage.org/webt/gv/bj/nh/gvbjnhvblrebv9051hd_x8adklo.png"></p><br><pre> <code class="plaintext hljs">/ip route add dst-address=0.0.0.0/0 gateway=10.10.10.1 add dst-address=192.168.200.0/24 gateway=10.30.30.1 distance=1 add dst-address=192.168.200.0/24 gateway=10.10.10.1 distance=2 type=blackhole</code> </pre> <br><ol><li>  Route statique vers la route par défaut </li><li>  Route statique vers 192.168.200.0/24 via le tunnel ipip </li><li>  Interdiction de la route statique vers 192.168.200.0/24 via le routeur du fournisseur </li></ol><br><p>  Une option de filtrage dans laquelle le trafic tunnel ne va pas au routeur du fournisseur lorsque l'interface ipip est désactivée.  De tels régimes sont rarement nécessaires, car  il est possible d'implémenter le blocage via le pare-feu. </p><br><p>  <strong>Boucle de routage</strong> <br>  Une boucle de routage est une situation où un paquet s'exécute entre les routeurs avant l'expiration de ttl.  Habituellement, c'est la conséquence d'une erreur de configuration, dans les grands réseaux, elle est traitée par la mise en œuvre de protocoles de routage dynamique, dans les petits réseaux - par des soins. </p><br><p>  Cela ressemble à ceci: <br><img src="https://habrastorage.org/webt/ii/h8/-v/iih8-vpacnim4b6flslcvy-v0eg.png"></p><br><p>  Exemple (le plus simple) comment obtenir un résultat similaire: <br><img src="https://habrastorage.org/webt/ky/9v/gv/ky9vgvnxvno8x79cbu79be0_buu.png"></p><br><p>  L'exemple de boucle de routage n'a aucune utilité pratique, mais il montre que les routeurs n'ont aucune idée de la table de routage de leurs voisins. </p><br><h3 id="policy-base-routing-i-dopolnitelnye-tablicy-marshrutizacii">  Routage de base de règles et tables de routage supplémentaires </h3><br><p>  Lors du choix d'un itinéraire, le routeur utilise un seul champ de l'en-tête du paquet (adresse Dst.) - il s'agit du routage de base.  Le routage basé sur d'autres conditions, telles que l'adresse source, le type de trafic (ToS), l'équilibrage sans ECMP, fait référence au routage de base de politique (PBR) et utilise des tables de routage supplémentaires. </p><br><p><img src="https://habrastorage.org/webt/cf/31/fj/cf31fjsrsjd2aszbzkl_hmg9wuw.png"></p><br><p>  <em>Un itinéraire plus spécifique</em> est la règle de base pour choisir un itinéraire dans une table de routage. </p><br><p>  Par défaut, toutes les règles de routage sont ajoutées à la table principale.  Un administrateur peut créer un nombre arbitraire de tables de routage supplémentaires et acheminer des paquets vers celles-ci.  Les règles des différents tableaux n'entrent pas en conflit les unes avec les autres.  Si le package ne trouve pas de règle appropriée dans la table spécifiée, il ira à la table principale. </p><br><p>  Exemple de distribution via Firewall: <br><img src="https://habrastorage.org/webt/uw/nd/jz/uwndjzt8mtfett8l84vg-n65p90.png"></p><br><ul><li>  192.168.100.10 -&gt; 8.8.8.8 <br><ol><li>  Le trafic provenant de 192.168.100.10 reçoit le <em>label via-isp1</em> dans <code>[Prerouting|Mangle]</code> </li><li>  Au stade du routage, dans la table <em>via-isp1, une route</em> est recherchée jusqu'au 8.8.8.8 </li><li>  L'itinéraire est trouvé, le trafic est envoyé à la passerelle 10.10.10.1 </li></ol></li><li>  192.168.200.20 -&gt; 8.8.8.8 <br><ol><li>  Le trafic provenant de 192.168.200.20 reçoit le <em>label via-isp2</em> dans <code>[Prerouting|Mangle]</code> </li><li>  Au stade du routage, la table <em>via-isp2 recherche</em> un itinéraire jusqu'à 8.8.8.8 </li><li>  L'itinéraire est trouvé, le trafic est envoyé vers la passerelle 10.20.20.1 </li></ol></li><li>  Si l'une des passerelles (10.10.10.1 ou 10.20.20.1) devient indisponible, le paquet ira à la table <em>principale</em> et y recherchera une route appropriée </li></ul><br><h3 id="problemy-terminologii">  Problèmes de terminologie </h3><br><p>  RouterOS a certains problèmes de terminologie. <br>  Lorsque vous travaillez avec des règles dans <code>[IP]-&gt;[Routes]</code> table de routage est indiquée, bien qu'elle indique que l'étiquette: <br><img src="https://habrastorage.org/webt/8i/kh/kh/8ikhkhsxvmlwnh9hd9g-quxnk18.png"></p><br><p>  Dans <code>[IP]-&gt;[Routes]-&gt;[Rule]</code> tout est correct, dans l'étiquette de condition de l'action de table: <br><img src="https://habrastorage.org/webt/0m/hl/5j/0mhl5jj73m7rfm4rvtb5qwpbix4.png"></p><br><h3 id="kak-otpravit-paket-v-opredelennuyu-tablicu-marshrutizacii">  Comment envoyer un paquet à une table de routage spécifique </h3><br><p>  RouterOS fournit plusieurs outils: </p><br><ul><li>  Règles dans <code>[IP]-&gt;[Routes]-&gt;[Rules]</code> </li><li>  Étiquettes de <code>action=mark-routing</code> ( <code>action=mark-routing</code> ) dans <code>[IP]-&gt;[Firewall]-&gt;[Mangle]</code> </li><li>  VRF </li></ul><br><p>  <strong>Règles <code>[IP]-&gt;[Route]-&gt;[Rules]</code></strong> <br>  Les règles sont traitées séquentiellement, si le paquet correspond aux conditions de la règle, il ne va pas plus loin. </p><br><p>  Les règles de routage vous permettent d'étendre les capacités de routage, en s'appuyant non seulement sur l'adresse du destinataire, mais également sur l'adresse source et l'interface vers laquelle le paquet a été reçu. </p><br><p><img src="https://habrastorage.org/webt/hg/ip/py/hgippyt0pgilh0l9zouqqqpbsoe.png"></p><br><p>  Les règles consistent en conditions et actions: </p><br><ul><li>  Conditions.  Ils répètent pratiquement la liste des signes par lesquels le paquet est vérifié dans le FIB; seul ToS est manquant. </li><li>  Actions <br><ul><li>  recherche - envoyer un paquet à une table </li><li>  recherche uniquement dans la table - verrouille le package dans la table, si l'itinéraire n'est pas trouvé, le package n'ira pas à la table principale </li><li>  drop - déposez le paquet </li><li>  inaccessible - supprimer le paquet de notification de l'expéditeur </li></ul></li></ul><br><p>  Dans la FIB, le trafic vers les processus locaux est traité en contournant les règles <code>[IP]-&gt;[Route]-&gt;[Rules]</code> : <br><img src="https://habrastorage.org/webt/yk/f4/gt/ykf4gt4ywwzgbklpyzlyulije8k.png"></p><br><p>  <strong>Marquage <code>[IP]-&gt;[Firewall]-&gt;[Mangle]</code></strong> <br>  Les étiquettes de route vous permettent de définir la passerelle pour le paquet en utilisant presque toutes les conditions du pare-feu: <br><img src="https://habrastorage.org/webt/la/dh/or/ladhorisauzv81cnmffmkjo6_hi.png"></p><br><p>  <em>Pratiquement, car tous n'ont pas de sens et certains peuvent fonctionner de manière instable.</em> </p><br><p><img src="https://habrastorage.org/webt/6b/_m/om/6b_mom-f6nde0zyuy-mr62asho4.png"></p><br><p>  Il existe deux façons de marquer un package: </p><br><ul><li>  Définir immédiatement la <em>marque de routage</em> </li><li>  Définir d'abord la <em>marque de connexion</em> , puis en fonction de la <em>marque de connexion</em> définir la <em>marque de</em> <em>routage</em> </li></ul><br><p>  Dans un article sur le pare-feu, j'ai écrit que la deuxième option est préférable car  réduit la charge sur le processeur, dans le cas du marquage de routes - ce n'est pas entièrement vrai.  Ces méthodes de marquage ne sont pas toujours équivalentes et sont généralement utilisées pour résoudre divers problèmes. </p><br><h3 id="primery-ispolzovaniya">  Exemples d'utilisation </h3><br><p>  Nous passons à des exemples d'utilisation de Policy Base Routing, il est beaucoup plus facile de leur montrer pourquoi tout cela est nécessaire. </p><br><p>  <strong>Trafic sortant (sortie) MultiWAN et réponse</strong> <br>  Un problème commun avec la configuration MultiWAN: Mikrotik est accessible à partir d'Internet uniquement via le fournisseur "actif". <br><img src="https://habrastorage.org/webt/ob/1p/ph/ob1pph0eph9qvz9nqvt759mptiq.png"></p><br><p>  Peu importe pour le routeur à quelle adresse IP la demande est arrivée; lors de la génération d'une réponse, il recherchera une route dans la table de routage où la route via isp1 est active.  En outre, un tel paquet sera très probablement filtré sur le chemin vers le destinataire. </p><br><p>  <em>Un autre point intéressant.</em>  <em>Si la source "simple" nat est configurée sur l'interface ether1: <code>/ip fi nat add out-interface=ether1 action=masquerade</code> paquet ira au réseau avec src.</em>  <em>address = 10.10.10.100, ce qui aggravera encore la situation.</em> </p><br><p>  Il existe plusieurs façons de résoudre le problème, mais chacune d'entre elles nécessitera des tables de routage supplémentaires: <br><img src="https://habrastorage.org/webt/g9/65/vy/g965vychbnzbsksplywfc3npi90.png"></p><br><pre> <code class="plaintext hljs">/ip route add dst-address=0.0.0.0/0 gateway=10.10.10.1 check-gateway=ping distance=1 add dst-address=0.0.0.0/0 gateway=10.20.20.1 check-gateway=ping distance=2 add dst-address=0.0.0.0/0 gateway=10.10.10.1 routing-mark=over-isp1 add dst-address=0.0.0.0/0 gateway=10.20.20.1 routing-mark=over-isp2</code> </pre> <br><p>  <strong>Utilisation de <code>[IP]-&gt;[Route]-&gt;[Rules]</code></strong> <br>  Spécifiez la table de routage qui sera utilisée pour les paquets avec l'adresse IP source spécifiée. <br><img src="https://habrastorage.org/webt/na/lm/b3/nalmb3u0yrde35z0mzdjm1xygr4.png"></p><br><pre> <code class="plaintext hljs">/ip route rule add src-address=10.10.10.100/32 action=lookup-only-in-table table=over-isp1 add src-address=10.20.20.200/32 action=lookup-only-in-table table=over-isp2</code> </pre> <br><p>  <em>Vous pouvez utiliser <code>action=lookup</code> , mais pour le trafic sortant local, cette option exclut complètement les connexions provenant de la mauvaise interface.</em> </p><br><ul><li>  Le système génère un paquet de réponse avec Src.  Adresse: 10.20.20.200 </li><li>  À l'étape de décision de routage (2), <code>[IP]-&gt;[Routes]-&gt;[Rules]</code> est vérifié et le paquet est envoyé à la table de routage <em>over-isp2</em> </li><li>  Conformément à la table de routage, le paquet doit être envoyé à la passerelle 10.20.20.1 via l'interface ether2 </li></ul><br><p><img src="https://habrastorage.org/webt/k-/zf/sg/k-zfsgxxdpqbufnwoobbno8d_aq.png"></p><br><p>  Cette méthode ne nécessite pas de traqueur de connexion fonctionnel, contrairement à l'utilisation de la table Mangle. </p><br><p>  <strong>Utilisation de <code>[IP]-&gt;[Firewall]-&gt;[Mangle]</code></strong> <br>  La connexion commence avec le paquet entrant, donc nous le marquons ( <code>action=mark-connection</code> ), pour les paquets sortants de la connexion marquée, nous définissons l'étiquette de route ( <code>action=mark-routing</code> ). <br><img src="https://habrastorage.org/webt/lg/4v/ni/lg4vni1mt8eteade7mcitz_3s3g.png"></p><br><pre> <code class="plaintext hljs">/ip firewall mangle #   add chain=input in-interface=ether1 connection-state=new action=mark-connection new-connection-mark=from-isp1 add chain=input in-interface=ether2 connection-state=new action=mark-connection new-connection-mark=from-isp2 #      add chain=output connection-mark=from-isp1 action=mark-routing new-routing-mark=over-isp1 passthrough=no add chain=output connection-mark=from-isp2 action=mark-routing new-routing-mark=over-isp2 passthrough=no</code> </pre> <br><p> <em>      ip,     <code>dst-address</code>  .</em> </p><br><ul><li>   ether2    .    <code>[INPUT|Mangle]</code>         <em>from-isp2</em> </li><li>      Src. Address: 10.20.20.200 </li><li>   Routing Decision(2)          10.20.20.1   ether1.        <code>[OUTPUT|Filter]</code> </li><li>   <code>[OUTPUT|Mangle]</code>       <em>from-isp2</em>      <em>over-isp2</em> </li><li>   Routing Adjusment(3)             </li><li>            10.20.20.1   ether2 </li></ul><br><p><img src="https://habrastorage.org/webt/rd/mr/qs/rdmrqst9dam9m7r9s4jsnudwdly.png"></p><br><h3 id="multiwan-i-otvetnyy-dst-nat-trafik"> MultiWAN   dst-nat  </h3><br><p>  ,        ( web)             . </p><br><pre> <code class="plaintext hljs">/ip firewall nat add chain=dstnat proto=tcp dst-port=80,443 in-interface=ether1 action=dst-nat to-address=192.168.100.100 add chain=dstnat proto=tcp dst-port=80,443 in-interface=ether2 action=dst-nat to-address=192.168.100.100</code> </pre> <br><p>     ,      Firewall Mangle,     : <br><img src="https://habrastorage.org/webt/3w/9i/pq/3w9ipqogda4itpjkpvqbw7ewxrg.png"></p><br><pre> <code class="plaintext hljs">/ip firewall mangle add chain=prerouting connection-state=new in-interface=ether1 protocol=tcp dst-port=80,443 action=mark-connection new-connection-mark=web-input-isp1 add chain=prerouting connection-state=new in-interface=ether2 protocol=tcp dst-port=80,443 action=mark-connection new-connection-mark=web-input-isp2 add chain=prerouting connection-mark=web-input-isp1 in-interface=ether3 action=mark-routing new-routing-mark=over-isp1 passthrough=no add chain=prerouting connection-mark=web-input-isp2 in-interface=ether3 action=mark-routing new-routing-mark=over-isp2 passthrough=no</code> </pre> <br><p><img src="https://habrastorage.org/webt/fb/qf/np/fbqfnpzfpcshxwzl2ruppyjh5qw.png"><br> <em>    NAT,      .</em> </p><br><h3 id="multiwan-i-ishodyaschie-soedineniya"> MultiWAN    </h3><br><p>    PBR    vpn (  SSTP)     . </p><br><p><img src="https://habrastorage.org/webt/pt/jg/m3/ptjgm36vdijiuvygzwl8csvwg5q.png"></p><br><p>   : </p><br><pre> <code class="plaintext hljs">/ip route add dst-address=0.0.0.0/0 gateway=192.168.100.1 routing-mark=over-isp1 add dst-address=0.0.0.0/0 gateway=192.168.200.1 routing-mark=over-isp2 add dst-address=0.0.0.0/0 gateway=192.168.0.1 routing-mark=over-isp3 add dst-address=0.0.0.0/0 gateway=192.168.100.1 distance=1 add dst-address=0.0.0.0/0 gateway=192.168.200.1 distance=2 add dst-address=0.0.0.0/0 gateway=192.168.0.1 distance=3</code> </pre> <br><p>  : </p><br><pre> <code class="plaintext hljs">/ip firewall mangle add chain=output dst-address=10.10.10.100 proto=tcp dst-port=443 action=mark-routing new-routing-mark=over-isp1 passtrough=no add chain=output dst-address=10.10.10.101 proto=tcp dst-port=443 action=mark-routing new-routing-mark=over-isp2 passtrough=no add chain=output dst-address=10.10.10.102 proto=tcp dst-port=443 action=mark-routing new-routing-mark=over-isp3 passtrough=no</code> </pre> <br><p>   NAT,        Src. Address: </p><br><pre> <code class="plaintext hljs">/ip firewall nat add chain=srcnat out-interface=ether1 action=masquerade add chain=srcnat out-interface=ether2 action=masquerade add chain=srcnat out-interface=ether3 action=masquerade</code> </pre> <br><p> : </p><br><ul><li>     SSTP </li><li>   Routing Decision (2)     ,     main.       Src. Address    ether1 </li><li>  <code>[Output|Mangle]</code>        </li><li>         Routing Adjusment        </li><li>       Src. Address  ether1,   <code>[Nat|Srcnat]</code>       </li></ul><br><p> ,        : <br><img src="https://habrastorage.org/webt/i9/gd/x0/i9gdx0o9s0iqnr4shoxdtfqnh2i.png"></p><br><p> Connection Tracker   <code>[Mangle]</code>  <code>[Srcnat]</code> ,       ,      <code>Replay Dst. Address</code>    NAT: <br><img src="https://habrastorage.org/webt/ps/op/qa/psopqak9ysxfem9lebg7woyizk4.png"></p><br><p>  VPN  (      )         : <br><img src="https://habrastorage.org/webt/s7/nc/jz/s7ncjzninvkxn_a6-p3wdd5ywnw.png"></p><br><p> <strong> </strong> <br>   ,         : </p><br><pre> <code class="plaintext hljs">/ip route add dst-address=10.10.10.100 gateway=192.168.100.1 add dst-address=10.10.10.101 gateway=192.168.200.1 add dst-address=10.10.10.102 gateway=192.168.0.1</code> </pre> <br><p>              . ,        vpn      ,     6   <code>[IP]-&gt;[Routes]</code>  <code>type=blackhole</code> .    — 3   <code>[IP]-&gt;[Route]-&gt;[Rules]</code> . </p><br><h3 id="raspredelenie-soedineniy-polzovateley-po-kanalam-svyazi">       </h3><br><p> ,  .      : </p><br><pre> <code class="plaintext hljs">/ip route add dst-address=0.0.0.0/0 gateway=10.10.10.1 dist=1 check-gateway=ping add dst-address=0.0.0.0/0 gateway=10.20.20.1 dist=2 check-gateway=ping add dst-address=0.0.0.0/0 gateway=10.10.10.1 dist=1 routing-mark=over-isp1 add dst-address=0.0.0.0/0 gateway=10.20.20.1 dist=1 routing-mark=over-isp2</code> </pre> <br><p> <strong> <code>[IP]-&gt;[Route]-&gt;[Rules]</code></strong> <br><img src="https://habrastorage.org/webt/-m/4o/jv/-m4ojve7wspajkjoc00afbpsbru.png"></p><br><pre> <code class="plaintext hljs">/ip route rules add src-address=192.168.100.0/25 action=lookup-only-in-table table=over-isp1 add src-address=192.168.100.128/25 action=lookup-only-in-table table=over-isp2</code> </pre> <br><p>   <code>action=lookup</code> ,           main     .     —   . </p><br><p> <strong>   <code>[IP]-&gt;[Firewall]-&gt;[Mangle]</code></strong> <br>     ip .       . <em>  layer7,      ,      ,       .</em> <br><img src="https://habrastorage.org/webt/u8/k5/yi/u8k5yito7_iuseo5cki-nhkaz5o.png"></p><br><pre> <code class="plaintext hljs">/ip firewall mangle add chain=prerouting src-address-list=users-over-isp1 dst-address-type=!local action=mark-routing new-routing-mark=over-isp1 add chain=prerouting src-address-list=users-over-isp2 dst-address-type=!local action=mark-routing new-routing-mark=over-isp2</code> </pre> <br><p> ""        <code>[IP]-&gt;[Route]-&gt;[Rules]</code> : </p><br><pre> <code class="plaintext hljs">/ip route rules add routing-mark=over-isp1 action=lookup-only-in-table table=over-isp1 add routing-mark=over-isp2 action=lookup-only-in-table table=over-isp2</code> </pre> <br><p>   <code>[IP]-&gt;[Firewall]-&gt;[Filter]</code> : </p><br><pre> <code class="plaintext hljs">/ip firewall filter add chain=forward routing-mark=over-isp1 out-interface=!ether1 action=reject add chain=forward routing-mark=over-isp2 out-interface=!ether2 action=reject</code> </pre> <br><p> <strong>  <code>dst-address-type=!local</code></strong> <br>   <code>dst-address-type=!local</code>           (dns, winbox, ssh, ...).       ,          ,   <code>dst-address-table</code> . </p><br><p>     <code>[IP]-&gt;[Route]-&gt;[Rules]</code>   ,      .   ,    FIB    <code>[PREROUTING|Mangle]</code>           main,    .    Routing Rules,            User PBR      . </p><br><p> <strong> <code>[IP]-&gt;[Firewall]-&gt;[Mangle action=route]</code></strong> <br>      <code>[Prerouting|Mangle]</code>            ,    : </p><br><pre> <code class="plaintext hljs">/ip firewall mangle add chain=prerouting src-address=192.168.100.0/25 action=route gateway=10.10.10.1 add chain=prerouting src-address=192.168.128.0/25 action=route gateway=10.20.20.1</code> </pre> <br><p>  <code>route</code>        ( <code>[IP]-&gt;[Route]-&gt;[Rules]</code> ).          ,    <code>action=route</code>    <code>action=mark-route</code> ,     (    <code>passtrough</code> ),   . <br> <em> wiki            ,               .</em> </p><br><h3 id="dinamicheskaya-balansirovka-na-osnove-ppc">     PPC </h3><br><p> Per Connection Classificator —     ECMP.    ECMP       (ECMP     ,     Routing Cache   ). </p><br><p> PCC  <em> </em>  ip ,    32-     <em></em> .       <em></em>    ,    . <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a> .  ,  . <br><img src="https://habrastorage.org/webt/md/xn/kz/mdxnkzst4p7nxatp2bnvjbrlsoe.png"></p><br><p>    : </p><br><pre> <code class="plaintext hljs">192.168.100.10: 192+168+100+10 = 470 % 3 = 2 192.168.100.11: 192+168+100+11 = 471 % 3 = 0 192.168.100.12: 192+168+100+12 = 472 % 3 = 1</code> </pre> <br><p>      src.address   : <br><img src="https://habrastorage.org/webt/sq/dn/rt/sqdnrtcsgypqle5ftv2rg23xvmg.png"></p><br><pre> <code class="plaintext hljs">#  /ip route add dst-address=0.0.0.0/0 gateway=10.10.10.1 dist=1 check-gateway=ping add dst-address=0.0.0.0/0 gateway=10.20.20.1 dist=2 check-gateway=ping add dst-address=0.0.0.0/0 gateway=10.30.30.1 dist=3 check-gateway=ping add dst-address=0.0.0.0/0 gateway=10.10.10.1 dist=1 routing-mark=over-isp1 add dst-address=0.0.0.0/0 gateway=10.20.20.1 dist=1 routing-mark=over-isp2 add dst-address=0.0.0.0/0 gateway=10.30.30.1 dist=1 routing-mark=over-isp3 #    /ip firewall mangle add chain=prerouting in-interface=br-lan dst-address-type=!local connection-state=new per-connection-classifier=src-address:3/0 action=mark-connection new-connection-mark=conn-over-isp1 add chain=prerouting in-interface=br-lan dst-address-type=!local connection-state=new per-connection-classifier=src-address:3/1 action=mark-connection new-connection-mark=conn-over-isp2 add chain=prerouting in-interface=br-lan dst-address-type=!local connection-state=new per-connection-classifier=src-address:3/2 action=mark-connection new-connection-mark=conn-over-isp3 add chain=prerouting in-interface=br-lan connection-mark=conn-over-isp1 action=mark-routing new-routing-mark=over-isp1 add chain=prerouting in-interface=br-lan connection-mark=conn-over-isp2 action=mark-routing new-routing-mark=over-isp2 add chain=prerouting in-interface=br-lan connection-mark=conn-over-isp3 action=mark-routing new-routing-mark=over-isp3</code> </pre> <br><p>      : <code>in-interface=br-lan</code> ,    <code>action=mark-routing</code>               . </p><br><h3 id="pereklyuchenie-kanalov-svyazi">    </h3><br><p> Check ping —  ,        IP ,                 ,            ,   check ping          . <br>           BGP,                 . </p><br><p>   ,        ip    ,      ,  google dns: 8.8.8.8. 8.8.4.4.    Mikrotik      . </p><br><p> <strong>    </strong> <br>      Multihop BGP               MikroTik,          check gateway       . </p><br><p>         scope/target scope       : <br><img src="https://habrastorage.org/webt/_m/kz/aw/_mkzawioocf0friubndc9q2pofw.png"></p><br><ol><li>           scope      main      target scope </li><li>     ,        </li><li>   connected        </li></ol><br><p>        ,    : <br><img src="https://habrastorage.org/webt/s4/jo/tv/s4jotv0vsxcofu8pcod2uzugfo4.png"></p><br><ul><li> 1-3  connected    ,       </li><li> 4-6   connected   ""  </li></ul><br><p>        RIB,   FIB    : <code>0.0.0.0/0 via 10.10.10.1 on ether1</code> . </p><br><p> <strong>      </strong> <br><img src="https://habrastorage.org/webt/f1/gd/hj/f1gdhjwli1fqi4yk7i-cfdyf2l0.png"></p><br><p> : <br><img src="https://habrastorage.org/webt/d8/bb/ae/d8bbaepprp0wswv54ly0ryzphhc.png"></p><br><pre> <code class="plaintext hljs">/ip route add dst-address=0.0.0.0/0 gateway=8.8.8.8 check-gateway=ping distance=1 target-scope=10 add dst-address=8.8.8.8 gateway=10.10.10.1 scope=10 add dst-address=0.0.0.0/0 gateway=10.20.20.1 distance=2</code> </pre> <br><p>  ,      10.10.10.1: <br><img src="https://habrastorage.org/webt/k6/nq/a9/k6nqa98jmecubjxx8e2zndbclcc.png"></p><br><p> Check gateway          ping'   8.8.8.8,  (   main)    10.10.10.1. </p><br><p>      10.10.10.1  8.8.8.8,    ,   (  ping)  8.8.8.8    10.10.10.1: <br><img src="https://habrastorage.org/webt/hj/v2/tg/hjv2tg5bnkaae2gyr7iunr74kt4.png"></p><br><p>      ether1,    ,    8.8.8.8    : <br><img src="https://habrastorage.org/webt/rt/_d/ad/rt_dadf8--ghn5pmgyg7q1ya258.png"></p><br><p>  ,    NetWatch      8.8.8.8.    NetWatch            .     : </p><br><pre> <code class="plaintext hljs">/ip route add dst-address=8.8.8.8 gateway=10.20.20.1 distance=100 type=blackhole</code> </pre> <br><p><img src="https://habrastorage.org/webt/ks/6e/k3/ks6ek3swyj9uyiih0bkbef1i6eu.png"></p><br><p>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a> ,    NetWatch   . </p><br><p>  ,      8.8.8.8       ,       dns    . </p><br><h3 id="para-slov-pro-virtual-routing-and-forwarding-vrf">    Virtual Routing and Forwarding (VRF) </h3><br><p>  VRF         ,        (    MPLS)    L3VPN     : <br><img src="https://habrastorage.org/webt/hk/0l/ep/hk0lep0gncmeajzj1pkp2wix6yk.png"></p><br><p>  VRF  Mikrotik         ,   ip      VRF,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> </a> . </p><br><p>   vrf: <br><img src="https://habrastorage.org/webt/gl/g8/k8/glg8k8isgjjsgyjodp7-rnqq5fi.png"></p><br><pre> <code class="plaintext hljs">/ip route vrf add interfaces=ether1 routing-mark=vrf1 add interfaces=ether2 routing-mark=vrf2 /ip address add address=192.168.100.1/24 interface=ether1 network=192.168.100.0 add address=192.168.200.1/24 interface=ether2 network=192.168.200.0</code> </pre> <br><p>     ether2 ,   ping      vrf (  ),   ping    : <br><img src="https://habrastorage.org/webt/pz/a7/h_/pza7h_xts_jyk6czos89h47q45u.png"></p><br><p>            main (  vrf   route leaking): <br><img src="https://habrastorage.org/webt/on/p-/5z/onp-5z4cvah-erroi_flwnjn2ik.png"></p><br><pre> <code class="plaintext hljs">/ip route add distance=1 gateway=172.17.0.1@main routing-mark=vrf1 add distance=1 gateway=172.17.0.1%wlan1 routing-mark=vrf2</code> </pre> <br><p> <em>    route leaking:   : <code>172.17.0.1@main</code>    : <code>172.17.0.1%wlan1</code> .</em> </p><br><p>        <code>[PREROUTING|Mangle]</code> : <br><img src="https://habrastorage.org/webt/ge/w3/pa/gew3paz7vdzqkzc0-pt0mz5b6yg.png"></p><br><pre> <code class="plaintext hljs">/ip firewall mangle add chain=prerouting in-interface=ether1 action=mark-connection new-connection-mark=from-vrf1 passthrough=no add chain=prerouting connection-mark=from-vrf1 routing-mark=!vrf1 action=mark-routing new-routing-mark=vrf1 passthrough=no add chain=prerouting in-interface=ether2 action=mark-connection new-connection-mark=from-vrf2 passthrough=no add chain=prerouting connection-mark=from-vrf2 routing-mark=!vrf1 action=mark-routing new-routing-mark=vrf2 passthrough=no</code> </pre> <br><p><img src="https://habrastorage.org/webt/i8/dd/kx/i8ddkxzzdogtht7gvzyo-rzcr-g.png"></p><br><p> <strong>   </strong> <br>            VRF  netmap: <br><img src="https://habrastorage.org/webt/yl/vx/kb/ylvxkbg-tyalsczpx9datttwgs0.png"></p><br><p>  : </p><br><pre> <code class="plaintext hljs">/ip route vrf add interfaces=ether1 routing-mark=vrf1 add interfaces=ether2 routing-mark=vrf2 /ip address add address=192.168.100.1/24 interface=ether1 network=192.168.100.0 add address=192.168.100.1/24 interface=ether2 network=192.168.100.0 add address=192.168.0.1/24 interface=ether3 network=192.168.0.0</code> </pre> <br><p>  firewall: </p><br><pre> <code class="plaintext hljs">#        /ip firewall mangle add chain=prerouting dst-address=192.168.101.0/24 in-interface=ether3 action=mark-routing new-routing-mark=vrf1 passthrough=no add chain=prerouting dst-address=192.168.102.0/24 in-interface=ether3 action=mark-routing new-routing-mark=vrf2 passthrough=no # netmap   ""     /ip firewall nat add chain=dstnat dst-address=192.168.101.0/24 in-interface=ether3 action=netmap to-addresses=192.168.100.0/24 add chain=dstnat dst-address=192.168.102.0/24 in-interface=ether3 action=netmap to-addresses=192.168.100.0/24</code> </pre> <br><p>     : </p><br><pre> <code class="plaintext hljs">#      route leaking,       connected  /ip route add distance=1 dst-address=192.168.0.0/24 gateway=ether3 routing-mark=vrf1 add distance=1 dst-address=192.168.0.0/24 gateway=ether3 routing-mark=vrf2</code> </pre> <br><p> <strong>    dhcp    </strong> <br> VRF   ,       (  dhcp client)    . </p><br><p>    vrf: </p><br><pre> <code class="plaintext hljs">/ip route vrf add interface=ether1 routing-mark=over-isp1</code> </pre> <br><p>     (  )   <em>over-isp1</em> : </p><br><pre> <code class="plaintext hljs">/ip firewall mangle add chain=output out-interface=!br-lan action=mark-routing new-routing-mark=over-isp1 passthrough=no add chain=prerouting in-interface=br-lan dst-address-type=!local action=mark-routing new-routing-mark=over-isp1 passthrough=no</code> </pre> <br><p> ,      : </p><br><pre> <code class="plaintext hljs">/interface bridge add name=bare /ip route add dst-address=0.0.0.0/0 gateway=bare</code> </pre> <br><p>            Routing decision (2)  <code>[OUTPUT|Mangle]</code>    ,         0.0.0.0/0   main   . <br><img src="https://habrastorage.org/webt/ff/p-/qh/ffp-qhi41y5wxswp6wzrtp69bjk.png"></p><br><h3 id="cepochki-connected-in-i-dynamic-in-v-routing---filters">  <code>connected-in</code>  <code>dynamic-in</code>  <code>[Routing] -&gt; [Filters]</code> </h3><br><p>   (  ) —           (      <em>routing</em> ),        : </p><br><ul><li> connected-in —  connected  </li><li> dynamic-in —     PPP  DCHP </li></ul><br><p>      ,     : distance, routing-mark, comment, scope, target scope, ... </p><br><p>         -  Routing Filters (  ),    Routing Filters,           .     Routing Filters      . </p><br><p> <strong> Routing Mark   </strong> <br>    .     VPN            .     -      : </p><br><pre> <code class="plaintext hljs">#  vpn    default route    /interface pptp-client add connect-to=XXXX add-default-route=yes default-route-distance=101 ... add connect-to=YYYY add-default-route=yes default-route-distance=100 ... #             /routing filter add chain=dynamic-in distance=100 prefix=0.0.0.0/0 action=passthrough set-routing-mark=over-vpn1 add chain=dynamic-in distance=101 prefix=0.0.0.0/0 action=passthrough set-routing-mark=over-vpn2</code> </pre> <br><p> <em>  ,  ,    vrf  ppp ,    0.0.0.0/0     main.      .</em> </p><br><p> <strong> Connected </strong> <br>    : </p><br><pre> <code class="plaintext hljs">/route filter add chain=connected-in prefix=192.168.100.0/24 action=reject</code> </pre> <br><h3 id="instrumenty-otladki">   </h3><br><p> RouterOS      : </p><br><ul><li> <code>[Tool]-&gt;[Torch]</code> —      </li><li> <code>/ip route check</code> —        ,      </li><li> <code>/ping routing-table=&lt;name&gt;</code>  <code>/tool traceroute routing-table=&lt;name&gt;</code> — ping       </li><li> <code>action=log</code>  <code>[IP]-&gt;[Firewall]</code> —  ,       packet flow,         </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr443788/">https://habr.com/ru/post/fr443788/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr443770/index.html">Conception pilotée par domaine: objets de valeur et noyau d'entité dans la pratique</a></li>
<li><a href="../fr443774/index.html">Comment la neurobiologie interfère dans les élections présidentielles américaines</a></li>
<li><a href="../fr443780/index.html">Projet MCDM. Partie 1. Concept</a></li>
<li><a href="../fr443782/index.html">Les développeurs peuvent désormais utiliser l'API réseau de Valve pour leurs jeux Steam</a></li>
<li><a href="../fr443786/index.html">Analyse du deuxième concours de quiz Android sur le stand HeadHunter au Mobius 2018 Moscou</a></li>
<li><a href="../fr443790/index.html">Erreur du survivant</a></li>
<li><a href="../fr443792/index.html">Erreurs typiques lors de l'utilisation de PostgreSQL. 2e partie</a></li>
<li><a href="../fr443798/index.html">Piratage Zotero: stockage synchronisé illimité et son utilisation fluide avec rmarkdown</a></li>
<li><a href="../fr443804/index.html">C # est un langage de bas niveau?</a></li>
<li><a href="../fr443808/index.html">Analytique des filles à faible responsabilité sociale (chargée de Power BI, Qlik Sense, Tableau)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>