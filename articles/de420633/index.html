<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü¶é ü¶à üåù Schreiben eines GeoIP-Exporters f√ºr Prometheus mit Visualisierungen in Grafana in 15 Minuten üìÄ üë©‚Äçüöí üéº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo an alle! 


 Ich m√∂chte Ihnen mitteilen, wie einfach es ist, Ihren Exporteur f√ºr Prometheus auf Golang zu schreiben, und anhand eines Beispiels ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Schreiben eines GeoIP-Exporters f√ºr Prometheus mit Visualisierungen in Grafana in 15 Minuten</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/420633/"><p><img src="https://habrastorage.org/webt/gq/e3/ss/gqe3ssl-nxvojbk1gnvm794kihi.png"></p><br><p>  Hallo an alle! </p><br><p>  Ich m√∂chte Ihnen mitteilen, wie einfach es ist, Ihren Exporteur f√ºr Prometheus auf Golang zu schreiben, und anhand eines Beispiels eines kleinen Programms zeigen, wie dies √ºberwacht werden kann, von wo aus die aktuellen TCP-Verbindungen geografisch installiert werden. </p><a name="habracut"></a><br><h1 id="0-disclaimer">  0. Haftungsausschluss </h1><br><p>  Ich m√∂chte gleich zu Beginn sofort sozusagen den <em>Umfang</em> dieser Ver√∂ffentlichung skizzieren und sagen, dass sie <em>nicht</em> aussagt, so dass es sp√§ter keine Fragen mehr gibt: </p><br><ul><li> Ja, dies ist keine Visualisierung von <em>Kunden</em> .  Dies ist eine Visualisierung von <em>Remoteverbindungen</em> .  Das hei√üt, die Verbindungen werden nicht in diejenigen unterteilt, in denen der Remoteserver die Verbindung initiiert hat, und diejenigen, die von diesem Computer initiiert wurden, und es wird alles auf der Karte angezeigt - beispielsweise der Server mit dem Repository, auf dem von nun an Updates auf Ihren Computer heruntergeladen werden. </li><li>  Ja, ich verstehe, dass es im Netzwerk Anonymisierungstools gibt, die die tats√§chliche IP des Clients verbergen.  Der Zweck dieses Tools besteht nicht darin, die genauen GPS-Koordinaten eines Kunden zu identifizieren, sondern zumindest eine allgemeine Vorstellung von dessen Geografie zu haben. </li><li>  whois liefert Informationen, die genauer sind als das Land der IP-Adresse, aber hier war ich durch das Limit des Plugins f√ºr Grafan verbunden, das nur L√§nder, aber keine St√§dte wiedergibt. </li></ul><br><h1 id="1-pishem-back-end-eksporter-na-go">  1. Wir schreiben "Backend": Der Exporteur ist unterwegs </h1><br><p>  Als erstes m√ºssen wir einen Exporteur schreiben, der tats√§chlich Daten von unserem Server sammelt und an Prometheus sendet.  Die Auswahl der Sprachen ist gro√üartig: Prometheus hat <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Client-Bibliotheken</a> zum Schreiben von Exporteuren in vielen g√§ngigen Sprachen, aber ich habe Go gew√§hlt, zum einen, weil es so "einheimischer" ist (da Prometheus darauf geschrieben ist), und zum anderen, weil es selbst Ich benutze in meiner DevOps-Praxis. </p><br><p>  Gut genug Texte, lasst uns zum Code kommen.  Beginnen wir mit dem Schreiben von ‚ÄûBottom-up‚Äú: Zuerst die Funktionen zum Bestimmen des Landes anhand der IP-Adresse und der Liste der Remote-IP-Adressen und dann das Senden an Prometheus. </p><br><h2 id="11-opredelyaem-stranu-po-ip-adresu">  1.1.  Wir bestimmen das Land anhand der IP-Adresse </h2><br><p> Nun, es ist absolut alles in der Stirn, ich habe nicht philosophiert und nur den <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">freegeoip.net-</a> Dienst verwendet, dessen API zum Zeitpunkt des Schreibens dieses Artikels bereits veraltet war. Jetzt bieten sie an, sich kostenlos zu registrieren und 10.000 Anfragen pro Monat zu stellen (was f√ºr unsere Zwecke ausreicht) )  Hier ist alles einfach: Es gibt einen Endpunkt des Formulars <code>http://api.ipstack.com/&lt;IP&gt;?access_key=&lt;API_KEY&gt;</code> , der uns einfach json mit dem Feld <code>country_code</code> , das wir ben√∂tigen - das ist alles, was wir f√ºr die Visualisierung ben√∂tigen. <br>  Schreiben wir also ein Paket, um das Land per IP zu ziehen. </p><br><div class="spoiler">  <b class="spoiler_title">Wir importieren die erforderlichen Bibliotheken und erstellen eine Struktur, in die das resultierende JSON-Objekt 'entpackt' wird.</b> <div class="spoiler_text"><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// Package geo implements function for searching // for a country code by IP address. package geo import ( "encoding/json" "fmt" "io/ioutil" "net/http" ) // Type GeoIP stores whois info. type GeoIP struct { Ip string `json:""` CountryCode string `json:"country_code"` CountryName string `json:""` RegionCode string `json:"region_code"` RegionName string `json:"region_name"` City string `json:"city"` Zipcode string `json:"zipcode"` Lat float32 `json:"latitude"` Lon float32 `json:"longitude"` MetroCode int `json:"metro_code"` AreaCode int `json:"area_code"` }</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">... und die Funktion selbst, die uns den L√§ndercode zur√ºckgibt.</b> <div class="spoiler_text"><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// Function GetCode returns country code by IP address. func GetCode(address string) (string, error) { response, err = http.Get("http://api.ipstack.com/" + address + "?access_key=&lt;API_KEY&gt;&amp;format=1&amp;legacy=1") if err != nil { fmt.Println(err) return "", err } defer response.Body.Close() body, err = ioutil.ReadAll(response.Body) if err != nil { fmt.Println(err) return "", err } err = json.Unmarshal(body, &amp;geo) if err != nil { fmt.Println(err) return "", err } return geo.CountryCode, nil }</span></span></code> </pre> </div></div><br><p>  Achten Sie auf den Parameter <code>legacy=1</code> , ich muss ihn aus Gr√ºnden der Abw√§rtskompatibilit√§t verwenden.  Wenn Sie ihre API verwenden, verwenden Sie nat√ºrlich die neueste Version. </p><br><h2 id="12-formiruem-spisok-tcp-soedineniy">  1.2.  Erstellen Sie eine Liste der TCP-Verbindungen </h2><br><p>  Hier verwenden wir das Paket <code>github.com/shirou/gopsutil/net</code> und filtern Verbindungen mit dem Status <code>ESTABLISHED</code> , wobei lokale IP-Adressen und Adressen aus einer benutzerdefinierten schwarzen Liste ausgeschlossen werden, die beim Start an den Exporteur √ºbergeben werden k√∂nnen (z. B. um alle Ihre eigenen √∂ffentlichen IP-Adressen auszuschlie√üen). </p><br><div class="spoiler">  <b class="spoiler_title">Paket mit Funktion, die map [string] int zur√ºckgibt: Anzahl der Verbindungen aus dem Land.</b> <div class="spoiler_text"><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// Package conn implements function for collecting // active TCP connections. package conn import ( "log" "github.com/gree-gorey/geoip-exporter/pkg/geo" "github.com/shirou/gopsutil/net" ) // Type Connections stores map of active connections: country code -&gt; number of connections. type Connections struct { ConnectionsByCode map[string]int `json:"connections_by_code"` } // Function RunJob retrieves active TCP connections. func (c *Connections) RunJob(p *Params) { if p.UseWg { defer p.Wg.Done() } c.GetActiveConnections(p.BlackList) } // Function GetActiveConnections retrieves active TCP connections. func (c *Connections) GetActiveConnections(blackList map[string]bool) { cs, err := net.Connections("tcp") if err != nil { log.Println(err) } c.ConnectionsByCode = make(map[string]int) for _, conn := range cs { if _, ok := blackList[conn.Raddr.IP]; !ok &amp;&amp; (conn.Status == "ESTABLISHED") &amp;&amp; (conn.Raddr.IP != "127.0.0.1") { code, err := geo.GetCode(conn.Raddr.IP) if code != "" &amp;&amp; err == nil { _, ok := c.ConnectionsByCode[code] if ok == true { c.ConnectionsByCode[code] += 1 } else { c.ConnectionsByCode[code] = 1 } } } } }</span></span></code> </pre> </div></div><br><h2 id="13-i-nakonec-otpravlyaem-vse-v-prometheus">  1.3.  Und zum Schluss senden Sie alles an Prometheus </h2><br><p>  Genauer gesagt wird er selbst alles nehmen.  Wir h√∂ren uns nur den Port an und geben ihm die gesammelten Metriken. <br>  Erstellen Sie mit <code>github.com/prometheus/client_golang/prometheus</code> eine Metrik vom Typ <code>Gauge</code> .  Eigentlich k√∂nnten Sie einen <code>Counter</code> erstellen, genau dann w√ºrden wir <code>rate</code> verwenden <code>rate</code> wenn wir die Datenbank abfragen.  Vielleicht ist letzteres aus Sicht von Prometheus effektiver, aber als ich diesen Exporteur schrieb (vor sechs Monaten), fing ich gerade an, Prometheus <code>Gauge</code> und <code>Gauge</code> war genug f√ºr mich: </p><br><pre> <code class="go hljs">location = prometheus.NewGaugeVec( prometheus.GaugeOpts{ Name: <span class="hljs-string"><span class="hljs-string">"job_location"</span></span>, Help: <span class="hljs-string"><span class="hljs-string">"Location connections number"</span></span>, }, []<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>{<span class="hljs-string"><span class="hljs-string">"location"</span></span>}, )</code> </pre> <br><p>  Nachdem wir die Metriken unter Verwendung der vorherigen Abs√§tze gesammelt haben, aktualisieren wir unseren Vektor: </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> code, number := <span class="hljs-keyword"><span class="hljs-keyword">range</span></span> c.ConnectionsByCode { location.With(prometheus.Labels{<span class="hljs-string"><span class="hljs-string">"location"</span></span>: code}).Set(<span class="hljs-keyword"><span class="hljs-keyword">float64</span></span>(number)) }</code> </pre> <br><p>  Wir beginnen dies alles mit einer Endlosschleife in einer separaten Goroutine und binden einfach den Port in den Hauptport und warten darauf, dass Prometheus unsere Metriken √ºbernimmt: </p><br><pre> <code class="go hljs">prometheus.MustRegister(location) http.Handle(<span class="hljs-string"><span class="hljs-string">"/metrics"</span></span>, prometheus.Handler()) log.Fatal(http.ListenAndServe(*addr, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>))</code> </pre> <br><p>  Eigentlich kann der gesamte Code im <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Repository auf GitHub</a> angezeigt werden. Ich m√∂chte hier nicht alles hintereinander kopieren. </p><br><h1 id="2-front-end-grafana">  2. "Frontend": Grafana </h1><br><p>  Aber zuerst m√ºssen Sie Prometheus nat√ºrlich anweisen, unsere Metriken zu sammeln: </p><br><pre> <code class="hljs 1c"> - job_name: 'GeoIPExporter' scrape_interval: <span class="hljs-number"><span class="hljs-number">10</span></span>s static_configs: - targets: ['127.0.0.1:<span class="hljs-number"><span class="hljs-number">9300</span></span>']</code> </pre> <br><p>  (oder mithilfe der Serviceerkennung, wenn Sie beispielsweise Kubernetes haben).  Prometheus kann dazu gebracht werden, die Konfiguration erneut zu lesen, indem ein <code>HUP</code> Signal gesendet wird: </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> pgrep <span class="hljs-string"><span class="hljs-string">"^prometheus</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$</span></span></span><span class="hljs-string">"</span></span> | xargs <span class="hljs-literal"><span class="hljs-literal">-i</span></span> kill <span class="hljs-literal"><span class="hljs-literal">-HUP</span></span> {}</code> </pre> <br><p>  Wir gehen in der Benutzeroberfl√§che darauf ein und √ºberpr√ºfen, ob die Metriken erfasst wurden: </p><br><p><img src="https://habrastorage.org/webt/5g/h_/l3/5gh_l30rao_r6ojiqarwfulix8a.png"></p><br><p>  Okay, jetzt ist Grafan an der Reihe.  Wir verwenden das <code>grafana-worldmap-panel</code> Plugin, das vorinstalliert sein muss: </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> grafana<span class="hljs-literal"><span class="hljs-literal">-cli</span></span> plugins install grafana<span class="hljs-literal"><span class="hljs-literal">-worldmap</span></span><span class="hljs-literal"><span class="hljs-literal">-panel</span></span></code> </pre> <br><p>  Gehen Sie als n√§chstes zu ihr in der Benutzeroberfl√§che und klicken Sie auf Panel hinzuf√ºgen -&gt; Worldmap-Panel.  Geben Sie auf der Registerkarte Metriken die folgende Abfrage ein: </p><br><pre> <code class="hljs lisp">sum(<span class="hljs-name"><span class="hljs-name">job_location</span></span>) by (<span class="hljs-name"><span class="hljs-name">location</span></span>)</code> </pre> <br><p>  Und geben Sie das Legendenformat an: <code>{{location}}</code> .  Alles sollte ungef√§hr so ‚Äã‚Äãaussehen: </p><br><p><img src="https://habrastorage.org/webt/cu/kt/_i/cukt_i2hl1ffyfmc8fzh0gez-fg.png"></p><br><p>  Wechseln Sie als N√§chstes zur Registerkarte Worldmap und konfigurieren Sie alles wie im Screenshot dargestellt: </p><br><p><img src="https://habrastorage.org/webt/7b/a3/5k/7ba35kxctwe4buw3coyyjtsugnm.png"></p><br><p>  Und alle!  Viel Spa√ü mit unserer Karte. </p><br><p>  Auf so einfache Weise k√∂nnen Sie eine sch√∂ne Karte der Verbindungen in Grafan erstellen. </p><br><p>  Vielen Dank f√ºr Ihre Aufmerksamkeit und freuen uns auf Ihre Kommentare. </p><br><h2 id="todo">  Todo </h2><br><p>  Um das Tool f√ºr den vorgesehenen Zweck zu verwenden, m√ºssen Sie es nat√ºrlich vervollst√§ndigen: Filtern Sie die Adressen lokaler Subnetze heraus und vieles mehr.  √úbrigens, wenn jemand interessiert ist und diesen Exporter entwickeln m√∂chte - willkommen im Repository auf GitHub! </p><br><h2 id="links">  Links </h2><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Prometheus-Client-Bibliotheken</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Geolocation-API</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Psutil f√ºr Golang</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Worldmap Panel Plugin f√ºr Grafana</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">GitHub-Projekt-Repository</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de420633/">https://habr.com/ru/post/de420633/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de420623/index.html">Verteilte C ++ - Anwendungen mit minimalem Aufwand</a></li>
<li><a href="../de420625/index.html">KDD 2018, Erster Tag, Tutorials</a></li>
<li><a href="../de420627/index.html">C # Asynchrone Programmierung: Wie geht es Ihnen mit der Leistung?</a></li>
<li><a href="../de420629/index.html">PHP Digest Nr. 137 (6. - 20. August 2018)</a></li>
<li><a href="../de420631/index.html">Wir haben keine Angst vor "Wolken"</a></li>
<li><a href="../de420635/index.html">KI, praktischer Kurs. Das Grundmodell zum Erkennen von Emotionen in Bildern</a></li>
<li><a href="../de420637/index.html">WANHAO D9 / 300 3D-Drucker Test: Video</a></li>
<li><a href="../de420639/index.html">Akka Antimuster: zu viele Schauspieler</a></li>
<li><a href="../de420641/index.html">Der technische Support von 3CX antwortet: Sichern und Wiederherstellen von 3CX √ºber die Befehlszeile</a></li>
<li><a href="../de420643/index.html">Fast alles ist gleich, nur 10 mal billiger</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>