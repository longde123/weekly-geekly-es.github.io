<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üç´ ‚ô£Ô∏è üîÆ Melhorando o desempenho do Zabbix + PostgreSQL com particionamento e indexa√ß√£o üéá üì¨ üôÄ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="H√° cerca de um ano, meus colegas e eu fomos encarregados de resolver o problema usando o popular sistema de monitoramento de infraestrutura de rede - ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Melhorando o desempenho do Zabbix + PostgreSQL com particionamento e indexa√ß√£o</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/468463/">  H√° cerca de um ano, meus colegas e eu fomos encarregados de resolver o problema usando o popular sistema de monitoramento de infraestrutura de rede - Zabbix.  Ap√≥s estudar a documenta√ß√£o, imediatamente procedemos ao teste de carregamento: quer√≠amos avaliar quantos par√¢metros o Zabbix pode funcionar sem quedas percept√≠veis de desempenho.  Somente o PostgreSQL foi usado como DBMS. <br><br>  Durante os testes, foram identificados alguns recursos arquiteturais do layout do banco de dados e o comportamento do pr√≥prio sistema de monitoramento, que, por padr√£o, n√£o permitem que o sistema de monitoramento alcance sua pot√™ncia m√°xima.  Como resultado, algumas medidas de otimiza√ß√£o foram desenvolvidas, conduzidas e testadas principalmente em termos de ajuste do banco de dados. <br><br>  Quero compartilhar os resultados do trabalho realizado neste artigo.  Este artigo ser√° √∫til para os administradores de Zabbix e PostgreSQL DBA, bem como para todos que desejam entender e entender melhor o popular DBMS PosgreSQL. <br><br>  Um pequeno spoiler: em uma m√°quina fraca com uma carga de 200 mil par√¢metros por minuto, conseguimos reduzir o iowait da CPU de 20% para 2%, reduzir o tempo de grava√ß√£o em partes nas tabelas de dados prim√°rias em 250 vezes e nas tabelas de dados agregadas em 32 vezes, reduzir o tamanho dos √≠ndices 5 a 10 vezes e acelere o recebimento de amostras hist√≥ricas em alguns casos at√© 18 vezes. <br><a name="habracut"></a><br><h4>  Teste de carga </h4><br>  O teste de carga foi realizado de acordo com o esquema: um servidor Zabbix, um proxy Zabbix ativo, dois agentes.  Cada agente foi configurado para fornecer 50 toneladas de n√∫meros inteiros e 50 toneladas de par√¢metros de sequ√™ncia por minuto (um total de 200 toneladas de par√¢metros por minuto ou 3333 par√¢metros por segundo).  Para gerar par√¢metros do agente, usamos um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">plug-in para o Zabbix.Para</a> verificar quantos par√¢metros um agente pode gerar, voc√™ precisa usar um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">script especial do mesmo autor do plug-in zabbix_module_stress</a> .  O administrador da web do Zabbix tem dificuldades em registrar modelos grandes, portanto, dividimos os par√¢metros em 20 modelos com 5 toneladas de par√¢metros (2500 num√©rico e 2500 string). <br><br><div class="spoiler">  <b class="spoiler_title">Modelo de gerador de script para teste de carga em python</b> <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> argparse <span class="hljs-string"><span class="hljs-string">"""     .   20   5000    ( 2500  :  echo,  ;  ping,  ) """</span></span> TEMP_HEAD = <span class="hljs-string"><span class="hljs-string">""" &lt;?xml version="1.0" encoding="UTF-8"?&gt; &lt;zabbix_export&gt; &lt;version&gt;2.0&lt;/version&gt; &lt;date&gt;2015-08-17T23:15:01Z&lt;/date&gt; &lt;groups&gt; &lt;group&gt; &lt;name&gt;Templates&lt;/name&gt; &lt;/group&gt; &lt;/groups&gt; &lt;templates&gt; &lt;template&gt; &lt;template&gt;Template Zabbix Srv Stress {count} passive {char}&lt;/template&gt; &lt;name&gt;Template Zabbix Srv Stress {count} passive {char}&lt;/name&gt; &lt;description/&gt; &lt;groups&gt; &lt;group&gt; &lt;name&gt;Templates&lt;/name&gt; &lt;/group&gt; &lt;/groups&gt; &lt;applications/&gt; &lt;items&gt; """</span></span> TEMP_END = <span class="hljs-string"><span class="hljs-string">"""&lt;/items&gt; &lt;discovery_rules/&gt; &lt;macros/&gt; &lt;templates/&gt; &lt;screens/&gt; &lt;/template&gt; &lt;/templates&gt; &lt;/zabbix_export&gt; """</span></span> TEMP_ITEM = <span class="hljs-string"><span class="hljs-string">"""&lt;item&gt; &lt;name&gt;{k}&lt;/name&gt; &lt;type&gt;0&lt;/type&gt; &lt;snmp_community/&gt; &lt;multiplier&gt;0&lt;/multiplier&gt; &lt;snmp_oid/&gt; &lt;key&gt;{k}&lt;/key&gt; &lt;delay&gt;1m&lt;/delay&gt; &lt;history&gt;3&lt;/history&gt; &lt;trends&gt;365&lt;/trends&gt; &lt;status&gt;0&lt;/status&gt; &lt;value_type&gt;{t}&lt;/value_type&gt; &lt;allowed_hosts/&gt; &lt;units/&gt; &lt;delta&gt;0&lt;/delta&gt; &lt;snmpv3_contextname/&gt; &lt;snmpv3_securityname/&gt; &lt;snmpv3_securitylevel&gt;0&lt;/snmpv3_securitylevel&gt; &lt;snmpv3_authprotocol&gt;0&lt;/snmpv3_authprotocol&gt; &lt;snmpv3_authpassphrase/&gt; &lt;snmpv3_privprotocol&gt;0&lt;/snmpv3_privprotocol&gt; &lt;snmpv3_privpassphrase/&gt; &lt;formula&gt;1&lt;/formula&gt; &lt;delay_flex/&gt; &lt;params/&gt; &lt;ipmi_sensor/&gt; &lt;data_type&gt;0&lt;/data_type&gt; &lt;authtype&gt;0&lt;/authtype&gt; &lt;username/&gt; &lt;password/&gt; &lt;publickey/&gt; &lt;privatekey/&gt; &lt;port/&gt; &lt;description/&gt; &lt;inventory_link&gt;0&lt;/inventory_link&gt; &lt;applications/&gt; &lt;valuemap/&gt; &lt;logtimefmt/&gt; &lt;/item&gt; """</span></span> TMP_FNAME_DEFAULT = <span class="hljs-string"><span class="hljs-string">"Template_App_Zabbix_Server_Stress_{count}_passive_{char}.xml"</span></span> chars = <span class="hljs-string"><span class="hljs-string">"ABCDEFGHIJKLMNOPQRSTUVWXYZ"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">"__main__"</span></span>: parser = argparse.ArgumentParser( description=<span class="hljs-string"><span class="hljs-string">'     zabbix'</span></span>) parser.add_argument(<span class="hljs-string"><span class="hljs-string">'--items'</span></span>, dest=<span class="hljs-string"><span class="hljs-string">'items'</span></span>, type=int, default=<span class="hljs-number"><span class="hljs-number">1000</span></span>, help=<span class="hljs-string"><span class="hljs-string">'-   (default: 1000)'</span></span>) parser.add_argument(<span class="hljs-string"><span class="hljs-string">'--templates'</span></span>, dest=<span class="hljs-string"><span class="hljs-string">'templates'</span></span>, type=int, default=<span class="hljs-number"><span class="hljs-number">1</span></span>, help=<span class="hljs-string"><span class="hljs-string">f'-  [1-</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{len(chars)}</span></span></span><span class="hljs-string">] (default: 1)'</span></span>) args = parser.parse_args() items_count = args.items tmps_count = args.templates <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> (tmps_count &gt;= <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> tmps_count &lt;= len(chars)): sys.exit(<span class="hljs-string"><span class="hljs-string">f"Templates must be in range 1 - </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{len(chars)}</span></span></span><span class="hljs-string">"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(tmps_count): fname = TMP_FNAME_DEFAULT.format(count=items_count, char=chars[i]) <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(fname, <span class="hljs-string"><span class="hljs-string">"w"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> output: output.write(TEMP_HEAD.format(count=items_count, char=chars[i])) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> k,t <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> [(<span class="hljs-string"><span class="hljs-string">'stress.ping[{}-I-{:06d}]'</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>), (<span class="hljs-string"><span class="hljs-string">'stress.echo[{}-S-{:06d}]'</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>)]: <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> j <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(int(items_count/<span class="hljs-number"><span class="hljs-number">2</span></span>)): output.write(TEMP_ITEM.format(k=k.format(chars[i],j),t=t)) output.write(TEMP_END)</code> </pre> <br></div></div><br>  A m√©trica da CPU iostat √© um bom indicador do desempenho do Zabbix - reflete a fra√ß√£o da unidade de tempo durante a qual o processador aguarda o acesso ao disco.  Quanto mais alto, mais o disco √© ocupado com opera√ß√µes de leitura e grava√ß√£o, o que indiretamente afeta a degrada√ß√£o do desempenho do sistema de monitoramento como um todo.  I.e.  este √© um sinal claro de que algo est√° errado com o monitoramento.  A prop√≥sito, nos espa√ßos abertos da rede, a pergunta bastante popular √© ‚Äúcomo remover o gatilho do iostat no Zabbix‚Äù, ent√£o esse √© um ponto doloroso, porque existem muitas raz√µes para aumentar o valor da m√©trica iowait. <br><br>  Aqui est√° a imagem para a m√©trica da CPU iowait que recebemos tr√™s dias depois inicialmente: <br><br><img src="https://habrastorage.org/webt/dc/md/yo/dcmdyote_ghzxca-o9sft88ptxq.png"><br><br>  Mas que quadro para a mesma m√©trica tamb√©m obtivemos dentro de tr√™s dias no final, depois de todas as medidas de otimiza√ß√£o que foram feitas, que ser√£o discutidas abaixo: <br><br><img src="https://habrastorage.org/webt/do/cs/fc/docsfcjjczkhgxoubjayslrohuw.png"><br><br>  Como pode ser visto nos gr√°ficos, o indicador cpu iowait caiu de quase 20% para 2%, o que indiretamente acelerou o tempo de execu√ß√£o de todas as solicita√ß√µes de adi√ß√£o e leitura de dados.  Agora vamos ver por que, com as configura√ß√µes padr√£o do banco de dados, o desempenho geral do sistema de monitoramento diminui e como corrigi-lo. <br><br><h4>  Raz√µes para a queda no desempenho do Zabbix </h4><br>  Com o ac√∫mulo de mais de 10 milh√µes de valores de par√¢metros em cada tabela de dados prim√°rios, percebeu-se que o desempenho do sistema de monitoramento cai acentuadamente, devido aos seguintes motivos: <br><br><ul><li>  a m√©trica iowait para a CPU do servidor √© aumentada em mais de 20%, o que indica um aumento no tempo durante o qual a CPU espera acessar as opera√ß√µes de leitura e grava√ß√£o de disco </li><li>  √≠ndices de tabelas nas quais os dados de monitoramento s√£o bastante inflados </li><li>  a m√©trica de utiliza√ß√£o √© aumentada para 100% para um disco com dados de monitoramento, o que indica a carga completa do disco com opera√ß√µes de leitura e grava√ß√£o </li><li>  valores obsoletos n√£o t√™m tempo para serem exclu√≠dos das tabelas de hist√≥rico ao serem limpos de acordo com a programa√ß√£o da governanta </li></ul><br>  A situa√ß√£o √© agravada no in√≠cio de cada hora, quando, al√©m disso, s√£o calculadas estat√≠sticas hor√°rias agregadas - ao mesmo tempo, √© realizada a leitura e grava√ß√£o ativas das p√°ginas de √≠ndice do disco, a exclus√£o de dados desatualizados do hist√≥rico, o que leva ao mesmo resultado - uma queda no desempenho do banco de dados e um aumento no tempo de execu√ß√£o pedidos (no limite, um pedido com dura√ß√£o de at√© 5 minutos foi anotado!). <br><br>  Uma pequena ajuda na organiza√ß√£o de um data warehouse de monitoramento no Zabbix.  Al√©m disso, armazena dados prim√°rios e dados agregados em diferentes tabelas, com a separa√ß√£o dos tipos de par√¢metros.  Cada tabela armazena um campo itemid (uma refer√™ncia impl√≠cita a um item de dados registrado no sistema), um registro de data e hora para registrar o valor do rel√≥gio no formato de registro de data e hora unix (milissegundos em uma coluna separada) e um valor em uma coluna separada (a exce√ß√£o √© a tabela de log, possui mais campos - semelhante ao log de eventos ): <br><div class="scrollable-table"><table><tbody><tr><th>  Nome da tabela </th><th>  Nomea√ß√£o </th><th>  Tipo de dados </th></tr><tr><td>  hist√≥ria </td><td>  Dados Prim√°rios de Monitoramento </td><td>  num√©rico (16,4) </td></tr><tr><td>  history_uint </td><td>  Dados Prim√°rios de Monitoramento </td><td>  num√©rico (20,0) </td></tr><tr><td>  history_str </td><td>  Dados Prim√°rios de Monitoramento </td><td>  varchar (255) </td></tr><tr><td>  history_text </td><td>  Dados Prim√°rios de Monitoramento </td><td>  texto </td></tr><tr><td>  history_logs </td><td>  Dados Prim√°rios de Monitoramento </td><td>  campos de texto e int </td></tr><tr><td>  tend√™ncias </td><td>  Dados de Monitoramento Agregados </td><td>  num√©rico (16,4) </td></tr><tr><td>  trends_uint </td><td>  Dados de Monitoramento Agregados </td><td>  num√©rico (20,0) </td></tr></tbody></table></div><h4>  Atividades de otimiza√ß√£o </h4><br>  Para melhorar o desempenho do banco de dados PostgreSQL, v√°rias medidas de otimiza√ß√£o foram realizadas, as principais das quais s√£o particionamento e altera√ß√£o de √≠ndices.  No entanto, vale mencionar algumas palavras sobre algumas medidas importantes e √∫teis que podem acelerar o trabalho de qualquer banco de dados no sistema de gerenciamento de banco de dados PostgreSQL. <br><br>  <b>Nota importante.</b>  No momento da coleta do material do artigo, usamos o Zabbix vers√£o 4.0, embora a vers√£o 4.2 j√° tenha sido lan√ßada e a vers√£o 4.4 esteja sendo preparada para a libera√ß√£o.  Por que √© importante mencionar isso?  Como a partir da vers√£o 4.2, o Zabbix come√ßou a oferecer suporte a uma extens√£o poderosa especial para trabalhar com s√©ries temporais do TimescaleDB, mas at√© agora no modo experimental: para todas as vantagens de usar essa extens√£o, acredita-se que algumas solicita√ß√µes come√ßaram a funcionar mais lentamente e ainda existem problemas de desempenho n√£o resolvidos (haver√° resolvido na vers√£o 4.4) - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">leia este artigo</a> .  <i>No pr√≥ximo artigo, pretendo escrever sobre os resultados dos testes de carga j√° usando a extens√£o TimescaleDB em compara√ß√£o com este caso de solu√ß√£o.</i>  A vers√£o do PostgreSQL foi usada 10, mas todas as informa√ß√µes fornecidas s√£o relevantes para as vers√µes 11 e 12 (estamos aguardando!). <br><br>  Portanto, as primeiras coisas primeiro: <br><br><ul><li>  configurando um arquivo de configura√ß√£o usando o utilit√°rio pgtune </li><li>  colocando o banco de dados em um disco f√≠sico separado </li><li>  Particionando Tabelas de Hist√≥rico com pg_pathman </li><li>  alterando tipos de √≠ndice de tabelas de hist√≥rico para brin (clock) e btree-gin (itemid) </li><li>  coleta e an√°lise de estat√≠sticas de execu√ß√£o de consultas pg_stat_statements </li><li>  definindo par√¢metros de monitoramento de disco f√≠sico </li><li>  melhoria de desempenho de hardware </li><li>  cria√ß√£o de um cluster distribu√≠do (material fora do escopo deste artigo) </li></ul><br><br><h4>  Configurando um arquivo de configura√ß√£o usando o utilit√°rio pgtune </h4><br>  De fato, o PostgreSQL √© um DBMS bastante leve.  Seu arquivo de configura√ß√£o padr√£o √© configurado para que, como diz meu colega, "trabalhe at√© na m√°quina de caf√©", ou seja,  em um ferro muito modesto.  Portanto, √© necess√°rio configurar o PostgreSQL para a configura√ß√£o do servidor, levando em considera√ß√£o a quantidade de mem√≥ria, o n√∫mero de processadores, o tipo de uso pretendido do banco de dados, o tipo de disco (HDD ou SSD) e o n√∫mero de conex√µes. <br><br>  Infelizmente, n√£o existe uma f√≥rmula √∫nica para ajustar todos os DBMSs, mas existem certas regras e padr√µes que s√£o adequados para a maioria das configura√ß√µes (o ajuste mais fino j√° √© o trabalho de um especialista).  Para simplificar a vida do DBA, foi escrito o utilit√°rio <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">pgtune</a> , que foi complementado pela <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">vers√£o web</a> por <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">le0pard</a> , autor de um livro interessante e √∫til sobre administra√ß√£o do PostgreSQL. <br><br>  Um exemplo de execu√ß√£o do utilit√°rio no console com 100 conex√µes (o Zabbix possui um administrador da Web exigente) para o tipo de aplicativo "Data warehouses": <br><br><pre>  pgtune -i postgresql.conf -o new_postgresql.conf -T DW -c 100 </pre><br><div class="spoiler">  <b class="spoiler_title">Os par√¢metros de configura√ß√£o que o utilit√°rio pgtune altera com uma descri√ß√£o da finalidade (os valores s√£o fornecidos como exemplo)</b> <div class="spoiler_text"><pre> # DB Version: 11
 # Tipo de SO: linux
 # Tipo de banco de dados: web
 # Mem√≥ria total (RAM): 8 GB
 # CPUs num: 1
 # Conex√µes num: 100
 # Armazenamento de dados: hdd<font></font>
<font></font>
 max_connections = 100 # n√∫mero m√°ximo de conex√µes simult√¢neas com o banco de dados
 shared_buffers = tamanho de mem√≥ria de 2 GB # para v√°rios buffers (principalmente cache de blocos de tabela e de √≠ndice) na mem√≥ria compartilhada
 effective_cache_size = 6GB # tamanho m√°ximo de mem√≥ria necess√°ria para execu√ß√£o da consulta usando √≠ndices
 maintenance_work_mem = 512MB # afeta a velocidade das opera√ß√µes VACUUM, ANALYZE, CREATE INDEX
 checkpoint_completion_target = 0.7 # hora prevista para concluir o procedimento do ponto de verifica√ß√£o
 wal_buffers = 16MB # quantidade de mem√≥ria usada pela mem√≥ria compartilhada para manter os logs de transa√ß√µes
 default_statistics_target = 100 # quantidade de estat√≠sticas coletadas pelo comando ANALYZE - ao aumentar, o otimizador cria consultas mais lentamente, mas melhor
 random_page_cost = 4 # custo condicional do acesso do √≠ndice √†s p√°ginas de dados - afeta a decis√£o de usar o √≠ndice
 effective_io_concurrency = 2 # n√∫mero de opera√ß√µes de E / S ass√≠ncronas que o DBMS tentar√° executar em uma sess√£o separada
 work_mem = 10485kB # a quantidade de mem√≥ria usada para classifica√ß√£o e tabelas de hash antes de usar arquivos tempor√°rios no disco
 min_wal_size = 1GB # limites abaixo do n√∫mero de arquivos WAL que ser√£o reciclados para uso futuro
 max_wal_size = 2GB # limita no topo o n√∫mero de arquivos WAL que ser√£o reciclados para uso futuro </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">Algumas op√ß√µes √∫teis de configura√ß√£o do postgresql</b> <div class="spoiler_text"><pre> # gerenciamento de manipuladores de solicita√ß√£o simult√¢neos
 max_worker_processes = 8 # o n√∫mero m√°ximo de processos em segundo plano - pelo menos um por banco de dados
 max_parallel_workers_per_gather = 4 # n√∫mero m√°ximo de processos paralelos em uma √∫nica solicita√ß√£o
 max_parallel_workers = 8 # o n√∫mero m√°ximo de processos de trabalho que o sistema pode suportar para opera√ß√µes paralelas<font></font>
<font></font>
 # logging settings (uma maneira f√°cil de descobrir o tempo de execu√ß√£o das solicita√ß√µes sem usar a extens√£o pg_stat_statements)
 log_min_duration_statement = 3000 # grava nos logs a dura√ß√£o da execu√ß√£o de todos os comandos cujo tempo de opera√ß√£o&gt; = do valor especificado em ms
 log_duration = off # registra a dura√ß√£o de cada comando conclu√≠do
 log_statement = 'none' # qual comando SQL deve ser gravado no log, valores: none (desativado), ddl, mod e all (todos os comandos)
 debug_print_plan = off # sa√≠da da √°rvore do plano de consulta para an√°lise posterior<font></font>
<font></font>
 # extrair o m√°ximo do banco de dados e estar pronto para obt√™-lo por qualquer falha (para os mais reprimidos, que ignoram a exist√™ncia de ssd e um cluster distribu√≠do)
 #fsync = off # grava√ß√£o f√≠sica no disco de altera√ß√µes, desativar o fsync aumenta a velocidade, mas pode levar a falhas permanentes
 #synchronous_commit = off # permite que voc√™ responda ao cliente antes mesmo de as informa√ß√µes da transa√ß√£o estarem no WAL - uma alternativa quase segura para desativar o fsync
 #full_page_writes = off # shutdown acelera as opera√ß√µes normais, mas pode causar corrup√ß√£o ou corrup√ß√£o de dados se o sistema travar </pre></div></div><br><h4>  Listando um banco de dados em um disco f√≠sico separado </h4><br>  <i>Esse item √© opcional e, em vez disso, √© uma solu√ß√£o de transi√ß√£o para um cluster distribu√≠do completo, mas ser√° √∫til conhecer essa possibilidade.</i>  Para acelerar o banco de dados, voc√™ pode coloc√°-lo em um disco separado.  Montamos o disco inteiro no diret√≥rio base, onde todos os bancos de dados PostgreSQL s√£o armazenados, mas em geral isso pode ser feito de maneira diferente: crie uma nova base de tabelas e transfira o banco de dados (ou apenas parte dela - as tabelas de dados de monitoramento prim√°rio e agregado) para essa base de tabelas em um disco separado. <br><br><div class="spoiler">  <b class="spoiler_title">Exemplo de montagem</b> <div class="spoiler_text">  Primeiro, voc√™ precisa formatar o disco com o sistema de arquivos ext4 e conect√°-lo ao servidor.  Monte o disco para o banco de dados com o r√≥tulo noatime: <br><br><pre>  mount / dev / sdc1 / var / lib / pgsql / 10 / data / base -o noatime </pre><br>  Para montagem permanente, adicione a linha ao arquivo / etc / fstab: <br><br><pre> # onde UUID √© o identificador do disco, voc√™ pode v√™-lo usando o utilit√°rio blkid
 UUID = 121efe29-70bf-410b-bc71-90704568ce3b / var / lib / pgsql / 10 / data / banco de dados ext4 padr√µes, noatime 0 0 </pre><br></div></div><br><h4>  Particionando tabelas de hist√≥rico com pg_pathman </h4><br>  Um dos problemas que encontramos durante o teste de estresse do Zabbix - PostgreSQL n√£o consegue excluir dados obsoletos do banco de dados.  Usando o particionamento, √© poss√≠vel dividir a tabela em suas partes constituintes, reduzindo assim o tamanho dos √≠ndices e partes constituintes da supertabela, o que afeta positivamente a velocidade do banco de dados como um todo. <br><br>  O particionamento resolve dois problemas ao mesmo tempo: <br><br>  1. acelere a remo√ß√£o de dados obsoletos excluindo tabelas inteiras <br><br>  2. √≠ndices de divis√£o para cada tabela composta <br><br>  Existem quatro mecanismos para particionar no PostgreSQL: <br><br>  1. restri√ß√£o_exclus√£o padr√£o <br><br>  2. extens√£o pg_partman ( <i>n√£o confunda com pg_pathman</i> ) <br><br>  3. extens√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">pg_pathman</a> <br><br>  4. criar e manter manualmente parti√ß√µes por n√≥s mesmos <br><br>  A solu√ß√£o de particionamento mais conveniente, confi√°vel e otimizada, em nossa opini√£o, √© a extens√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">pg_pathman</a> .  Com esse m√©todo de particionamento, o planejador de consultas determina de maneira flex√≠vel em quais parti√ß√µes procurar dados.  <i>H√° rumores de que na 12¬™ vers√£o do PostgreSQL haver√° uma excelente parti√ß√£o j√° pronta para uso.</i> <br><br>  Assim, come√ßamos a escrever dados de monitoramento para cada dia em uma tabela herdada separada da supertabela e a remo√ß√£o de valores de par√¢metros obsoletos come√ßou a ocorrer atrav√©s da remo√ß√£o de todas as tabelas obsoletas de uma s√≥ vez, o que √© muito mais f√°cil para um DBMS para custos de m√£o-de-obra.  A exclus√£o foi feita chamando a fun√ß√£o de usu√°rio do banco de dados como um par√¢metro de monitoramento do servidor Zabbix √†s 2 da manh√£, com uma indica√ß√£o do intervalo aceit√°vel de armazenamento de estat√≠sticas. <br><br><div class="spoiler">  <b class="spoiler_title">Instale e configure o particionamento para o PostgreSQL 10</b> <div class="spoiler_text">  Instale e configure a extens√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">pg_pathman a</a> partir do reposit√≥rio OS padr√£o (para obter instru√ß√µes sobre como construir a vers√£o mais recente da extens√£o a partir das fontes, procure no mesmo reposit√≥rio no github): <br><br><pre> yum install pg_pathman10
 nano /var/pgsqldb/postgresql.conf
 shared_preload_libraries = 'pg_pathman' # important - escreva aqui pg_pathman por √∫ltimo na lista
</pre><br>  Reinicializamos o DBMS, criamos a extens√£o para o banco de dados e configuramos o particionamento (1 dia para os dados prim√°rios de monitoramento e 3 dias para os dados de monitoramento agregados - isso pode ser feito por 1 dia): <br><br><pre> systemctl restart postgresql-10.service
 psql -d zabbix -U postgres
 CRIAR EXTENS√ÉO pg_pathman;
 # configure um dia para as tabelas de dados de monitoramento prim√°rio
 # 1552424400 - contagem regressiva como carimbo de data e hora unix, 86400 - segundos em dias
 selecione create_range_partitions ('history', 'clock', 1552424400, 86400);
 selecione create_range_partitions ('history_uint', 'clock', 1552424400, 86400);
 selecione create_range_partitions ('history_text', 'clock', 1552424400, 86400);
 selecione create_range_partitions ('history_str', 'clock', 1552424400, 86400);
 selecione create_range_partitions ('history_log', 'clock', 1552424400, 86400);
 # configure por tr√™s dias para tabelas de dados de monitoramento agregadas
 # 1552424400 - contagem regressiva como carimbo de data e hora unix, 259200 - segundos em tr√™s dias
 selecione create_range_partitions ('tend√™ncias', 'rel√≥gio', 1545771600, 259200);  
 selecione create_range_partitions ('trends_uint', 'clock', 1545771600, 259200); 
</pre><br>  <i>Se ainda n√£o houver dados em nenhuma das tabelas, ao chamar a fun√ß√£o create_range_partitions, mais um argumento adicional p_count = 0_ deve ser passado.</i> <br><br>  Consultas √∫teis para monitorar e gerenciar parti√ß√µes: <br><br><pre> # lista geral de tabelas particionadas, armazenamento de configura√ß√£o principal:
 selecione * em pathman_config;
 # representa√ß√£o com todas as se√ß√µes existentes, assim como seus pais e limites de intervalo:
 selecione * em pathman_partition_list;
 # par√¢metros adicionais que substituem o comportamento padr√£o do pg_pathman:
 selecione * em pathman_config_params;
 # copie o conte√∫do de volta para a tabela pai e exclua as parti√ß√µes:
 selecione drop_partitions ('table_name' :: regclass, false);
</pre><br>  Script √∫til para visualizar estat√≠sticas sobre o n√∫mero e tamanho das parti√ß√µes: <br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">/*       */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> nspname <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> schemaname, relname, relkind, <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (reltuples <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>), pg_size_pretty(pg_relation_size(C.oid)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">"size"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_class C <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_namespace N <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (N.oid = C.relnamespace) <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> nspname <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-string"><span class="hljs-string">'pg_catalog'</span></span>, <span class="hljs-string"><span class="hljs-string">'information_schema'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (relname <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> <span class="hljs-string"><span class="hljs-string">'history%'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> relname <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> <span class="hljs-string"><span class="hljs-string">'trends%'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> relkind = <span class="hljs-string"><span class="hljs-string">'r'</span></span> <span class="hljs-comment"><span class="hljs-comment">-- and reltuples &gt; 0 -- and pg_relation_size(C.oid) &gt;= 0 ORDER BY schemaname, relname</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Ajuste autom√°tico da exclus√£o de parti√ß√µes obsoletas (ahtung - uma grande fun√ß√£o SQL)</b> <div class="spoiler_text">  Para configurar a exclus√£o autom√°tica de parti√ß√µes, voc√™ precisa criar uma fun√ß√£o no banco de dados <br>  (texto amplo, removi o realce da sintaxe): <br><br><pre> CRIAR OU SUBSTITUIR FUN√á√ÉO public.delete_old_partitions (history_days inteiro, trends_days inteiro, str_days inteiro)
  DEVOLU√á√ÉO texto
  LANGUAGE plpgsql
 Fun√ß√£o $ AS $
 / *
 A fun√ß√£o exclui todas as parti√ß√µes anteriores ao n√∫mero de dias especificado:
 history_days - para parti√ß√µes history_x, history_uint_x
 trends_days - para parti√ß√µes trends_x, trends_uint_x
 str_days - para parti√ß√µes history_str_x, history_text_x, history_log_x
 * /
 declarar clock_today_start int;
 declarar clock_delete_less_history int = 0;
 declarar clock_delete_less_trends int = 0;
 declarar clock_delete_less_strings int = 0;
 clock_delete_less int = 0;
 declarar iterador int = 0;
 declarar result_str text = '';
 declare buf_table_size text;
 declarar buf_table_len text;
 declarar texto nome_da_parti√ß√£o;
 declare clock_max text;
 declarar texto err_detail;
 declarar t_start timestamp = clock_timestamp ();
 declarar t_end timestamp;
 come√ßar
     se $ 1 &lt;= 0 retornar 'ups, algo errado: o argumento history_days deve ser um valor inteiro positivo';  fim se;
     se $ 2 &lt;= 0 retornar 'ups, algo errado: o argumento trends_days deve ser um valor inteiro positivo';  fim se;
     se $ 3 &lt;= 0 retornar 'ups, algo errado: o argumento str_days deve ser um valor inteiro positivo';  fim se;
     clock_today_start = extract (√©poca de date_trunc ('dia', agora ())) :: int;
     clock_delete_less_history = extract (√©poca de date_trunc ('dia', agora ()) - ($ 1 :: texto || 'dias') :: intervalo) :: int;
     clock_delete_less_trends = extract (√©poca de date_trunc ('dia', agora ()) - ($ 2 :: texto || 'dias') :: intervalo) :: int;
     clock_delete_less_strings = extract (√©poca de date_trunc ('dia', agora ()) - ($ 3 :: texto || 'dias') :: intervalo) :: int;
     clock_delete_less = menos (clock_delete_less_history, clock_delete_less_trends, clock_delete_less_strings);
     - aviso de aumento 'clock_today_start% (%)', to_timestamp (clock_today_start), clock_today_start;
     - aviso de aumento 'clock_delete_less_history% (%)% days', to_timestamp (clock_delete_less_history), clock_delete_less_history, $ 1;
     - aviso de aumento 'clock_delete_less_trends% (%)% days', to_timestamp (clock_delete_less_trends), clock_delete_less_trends, $ 2;
     - aviso de aumento 'clock_delete_less_strings% (%)% days', to_timestamp (clock_delete_less_strings), clock_delete_less_strings, $ 3;
     para partition_name, clock_max na parti√ß√£o selecionada, range_max de pathman_partition_list em que 
     range_max :: int &lt;= greatest (clock_delete_less_history, clock_delete_less_trends, clock_delete_less_strings) e 
     (partition :: texto como 'history%' ou partition :: texto como 'trends%') ordene pela parti√ß√£o asc
     la√ßo
         if (nome da parti√ß√£o ~ 'history_uint_ \ d' e clock_max :: int &lt;= clock_delete_less_history)
         ou (partition_name ~ 'history_ \ d' e clock_max :: int &lt;= clock_delete_less_history)
         ou (partition_name ~ 'trends_ \ d' e clock_max :: int &lt;= clock_delete_less_trends)
         ou (partition_name ~ 'history_log_ \ d' e clock_max :: int &lt;= clock_delete_less_strings)
         ou (partition_name ~ 'history_str_ \ d' e clock_max :: int &lt;= clock_delete_less_strings)
         ou (partition_name ~ 'history_text_ \ d' e clock_max :: int &lt;= clock_delete_less_strings)
         ent√£o 
             iterador = iterador + 1;
             aumentar aviso '%', formato ('!!! excluir% s% s', nome da parti√ß√£o, clock_max);
             selecione max (reltuples :: int), pg_size_pretty (sum (pg_relation_size (pg_class.oid)))) como "tamanho" de pg_class, em que relname como partition_name ||  '%' em estrito buf_table_len, buf_table_size;
             if result_str! = '' ent√£o result_str = result_str ||  ',';  fim se;
             result_str = result_str ||  formato ('% s (dt &lt;% s, len% s,% s)', nome_da_parti√ß√£o, to_char (to_timestamp (clock_max :: int), 'AAAA-MM-DD'), buf_table_len, buf_table_size);
             executar formato ('soltar tabela se existir% s', nome_da_parti√ß√£o);
         fim se;
     loop final;
     se iterador = 0 ent√£o result_str = format ('n√£o h√° parti√ß√µes para excluir mais antigas, ent√£o% s data', to_char (to_timestamp (clock_delete_less), 'YYYY-MM-DD')); 
     else result_str = formato ('% s exclu√≠das parti√ß√µes em% s segundos:', iterador, trunc (extract (segundos de (clock_timestamp () - t_start)) :: numeric, 3)) ||  result_str;
     fim se;
     - aviso de aumento '%', result_str;
     retornar result_str;
 exce√ß√£o quando outros
    obter diagn√≥sticos empilhados err_detail = PG_EXCEPTION_CONTEXT;
    formato de retorno ('ups, algo errado:% s [c√≥digo de erro% s],% s', sqlerrm, sqlstate, err_detail);
 fim; 
 $ fun√ß√£o $;
</pre><br>  Para chamar automaticamente a fun√ß√£o de parti√ß√£o de limpeza autom√°tica, voc√™ precisa criar um item de dados para o host do servidor zabbix do tipo "Database Monitor" com as seguintes configura√ß√µes: <br><br><pre> - tipo: monitor de banco de dados
 - nome: delete_old_history_partitions
 - chave: db.odbc.select [delete_old_history_partitions, zabbix]
 - express√£o sql: selecione delete_old_partitions (3, 30, 30);
 # aqui, os par√¢metros da chamada da fun√ß√£o delete_old_partitions indicam o tempo de armazenamento em dias 
 # para valores num√©ricos, valores num√©ricos agregados e valores de sequ√™ncia
 - tipo de dados: texto
 - intervalo de atualiza√ß√£o: 0
 - intervalo do usu√°rio: agendado em h2
 - per√≠odo de armazenamento hist√≥rico: 90 dias
 - grupo de elementos de dados: banco de dados
</pre><br>  Como resultado, obteremos estat√≠sticas sobre a limpeza de parti√ß√µes aproximadamente do seguinte tipo: <br><br><pre>  2019-09-16 02:00:00, exclu√≠do 3 parti√ß√µes em 0,024 segundos: trends_78 (dt &lt;2019-08-17, len 1, 48 kB), history_193 (dt &lt;2019-09-13, len 85343, 9448 kB ), history_uint_186 (dt &lt;2019-09-13, len 27969, 3480 kB)
</pre><br>  <b>Importante!</b>  Ap√≥s configurar a exclus√£o autom√°tica de parti√ß√µes atrav√©s do elemento de dados e da fun√ß√£o do usu√°rio, √© necess√°rio desativar o hist√≥rico e a limpeza de tend√™ncias no agendador de tarefas do Zabbix: <i>atrav√©s do item de menu do zabbix, selecione "Administra√ß√£o" -&gt; "Geral" -&gt; selecione "Limpar hist√≥rico" na lista no canto -&gt; desativar todas as caixas de sele√ß√£o nas se√ß√µes "Hist√≥rico" e "Din√¢mica das altera√ß√µes".</i> <br></div></div><br><h4>  Alterando tipos de √≠ndice de tabelas de hist√≥rico para brin (clock) e btree-gin (itemid) </h4><br>  Agradecimentos especiais a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">erogov</a> pela <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">excelente s√©rie de artigos sobre os √≠ndices do PostgreSQL</a> .  <i>E de fato toda a equipe do PostgresPRO.</i>                            . <br><br>  ,            btree(itemid, clock) ‚Äî    ,     ,   ¬´¬ª  ,    ‚Äî  10 . <br><br> <i>          ,              ,       .</i> <br><br>           :  brin   clock   btree-gin   itemid     . <br><br> <i> brin      ,      - , ..   .   btree-gin ‚Äî    gin     ,        btree .. gin        ,    .</i>  btree-gin     PostgreSQL. <br><br>              Zabbix    .             : <br><div class="scrollable-table"><table><tbody><tr><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Nome da Parti√ß√£o </font></font></th><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> O n√∫mero de linhas na MLN </font></font></th><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tamanho em MB </font></font></th></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> history_uint_1 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 81,3 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 4119 </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> history_uint_2 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 74,9 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 4426 </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> history_uint_3 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 100,7 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 5387 </font></font></td></tr></tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Para avaliar os resultados, tr√™s tipos de consultas foram realizadas: </font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para um par√¢metro espec√≠fico itemid data do √∫ltimo m√™s, de fato os √∫ltimos tr√™s dias (total de 1660 registros) </font></font><br><br><pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">explicar analisar selecionar * do history_uint em que itemid = 313300</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
and clock&gt; = extract (√©poca de '2019-03-09 00:00:00' :: timestamp) :: int</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
e clock &lt;= extract (√©poca de '2019-04-09 12:00:00' :: timestamp) :: int;</font></font><font></font>
</pre></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para um dado de par√¢metro espec√≠fico por 12 horas de um dia (649 entradas no total) </font></font><br><br><pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">explicar analisar selecionar * do hist√≥rico_texto em que itemid = 310650</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
and clock&gt; = extract (√©poca de '2019-04-09 00:00:00' :: timestamp) :: int</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
e clock &lt;= extract (√©poca de '2019-04-09 12:00:00' :: timestamp) :: int;</font></font><font></font>
</pre></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para um dado de par√¢metro espec√≠fico por uma hora (61 registros no total): </font></font><br><br><pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">explicar analisar contar contagem (*) de history_text em que itemid = 336540</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
and clock&gt; = extract (√©poca de '2019-04-08 11:00:00' :: timestamp) :: int</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
e clock &lt;= extract (√©poca de '2019-04-08 12:00:00' :: timestamp) :: int;</font></font><font></font>
</pre></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Os resultados dos testes foram tabulados abaixo: </font></font><br><div class="scrollable-table"><table><tbody><tr><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tipo de √≠ndice </font></font></th><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tamanho em MB * </font></font></th><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> solicita√ß√£o 1 ** em ms </font></font></th><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> solicita√ß√£o 2 ** em ms </font></font></th><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> solicita√ß√£o 3 ** em ms </font></font></th></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> btree (rel√≥gio, itemid) </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 14741 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 7154,3 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 2205,3 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1860,4 </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">brin (rel√≥gio), </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">btree-gin (itemid)</font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0,42 e 1329 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 2958,2 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1820,4 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 102,1 </font></font></td></tr></tbody></table></div> *         <br> **   1 ‚Äî   3 ,   2 ‚Äî   12 ,   3 ‚Äî     <br><br>    ,          100   ,      btree    brin  btree-gin           . <br><br>               history_uint  trends_uint (     2000   ). <br><div class="scrollable-table"><table><tbody><tr><th>  </th><th>     ,  </th><th>     ,  </th></tr><tr><td> trends_uint </td><td> 2201.48 </td><td> 8.72 </td></tr><tr><td> trends_uint </td><td> 1997.27 </td><td> 62.16 </td></tr></tbody></table></div><br>            zabbix  ,           zabbix       ,            10 .        ¬´¬ª  btree    ‚Äî           ( utilization),                  CPU ( iowait). <br><br> <b>,</b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para que o √≠ndice btree-gin possa trabalhar com o tipo de dados bigint (in8), que √© a coluna itemid, √© necess√°rio registrar uma fam√≠lia de operadores bigint para o √≠ndice btree-gin. </font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Registrando uma fam√≠lia de operadores bigint para o √≠ndice btree-gin</font></font></b> <div class="spoiler_text"><pre>/*<font></font>
     gin    biginteger  integer    .<font></font>
 -   gin     int2, int4, int8,<font></font>
       bigint     ,     bigint (&lt;= 2147483647)<font></font>
        intger_ops,  :<font></font>
create index on tablename using gin(columnname int8_family_ops) with (fastupdate = false);<font></font>
*/<font></font>
<font></font>
--       btree_gin<font></font>
CREATE EXTENSION btree_gin;<font></font>
<font></font>
CREATE OPERATOR FAMILY integer_ops using gin;<font></font>
<font></font>
CREATE OPERATOR CLASS int4_family_ops<font></font>
FOR TYPE int4 USING gin FAMILY integer_ops<font></font>
AS<font></font>
    OPERATOR 1 &lt;,<font></font>
    OPERATOR 2 &lt;=,<font></font>
    OPERATOR 3 =,<font></font>
    OPERATOR 4 &gt;=,<font></font>
    OPERATOR 5 &gt;,<font></font>
    FUNCTION 1 btint4cmp(int4,int4),<font></font>
    FUNCTION 2 gin_extract_value_int4(int4, internal),<font></font>
    FUNCTION 3 gin_extract_query_int4(int4, internal, int2, internal, internal),<font></font>
    FUNCTION 4 gin_btree_consistent(internal, int2, anyelement, int4, internal, internal),<font></font>
    FUNCTION 5 gin_compare_prefix_int4(int4,int4,int2, internal),<font></font>
STORAGE int4;<font></font>
<font></font>
CREATE OPERATOR CLASS int8_family_ops<font></font>
FOR TYPE int8 USING gin FAMILY integer_ops<font></font>
AS<font></font>
    OPERATOR 1 &lt;,<font></font>
    OPERATOR 2 &lt;=,<font></font>
    OPERATOR 3 =,<font></font>
    OPERATOR 4 &gt;=,<font></font>
    OPERATOR 5 &gt;,<font></font>
    FUNCTION 1 btint8cmp(int8,int8),<font></font>
    FUNCTION 2 gin_extract_value_int8(int8, internal),<font></font>
    FUNCTION 3 gin_extract_query_int8(int8, internal, int2, internal, internal),<font></font>
    FUNCTION 4 gin_btree_consistent(internal, int2, anyelement, int4, internal, internal),<font></font>
    FUNCTION 5 gin_compare_prefix_int8(int8,int8,int2, internal),<font></font>
STORAGE int8;<font></font>
<font></font>
ALTER OPERATOR FAMILY integer_ops USING gin add<font></font>
  OPERATOR 1 &lt;(int4,int8),<font></font>
  OPERATOR 2 &lt;=(int4,int8),<font></font>
  OPERATOR 3 =(int4,int8),<font></font>
  OPERATOR 4 &gt;=(int4,int8),<font></font>
  OPERATOR 5 &gt;(int4,int8);<font></font>
<font></font>
ALTER OPERATOR FAMILY integer_ops USING gin add<font></font>
  OPERATOR 1 &lt;(int8,int4),<font></font>
  OPERATOR 2 &lt;=(int8,int4),<font></font>
  OPERATOR 3 =(int8,int4),<font></font>
  OPERATOR 4 &gt;=(int8,int4),<font></font>
  OPERATOR 5 &gt;(int8,int4);<font></font>
</pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Este script redistribui todos os √≠ndices no banco de dados PostgreSQL para Zabbix da configura√ß√£o padr√£o para a configura√ß√£o ideal descrita acima.</font></font></b> <div class="spoiler_text"><pre>/*<font></font>
        <font></font>
*/<font></font>
<font></font>
--   <font></font>
drop index history_1;<font></font>
drop index history_uint_1;<font></font>
drop index history_str_1;<font></font>
drop index history_text_1;<font></font>
drop index history_log_1;<font></font>
--          PK <font></font>
-- (   ,         )<font></font>
alter table trends drop constraint trends_pk;<font></font>
alter table trends_uint drop constraint trends_uint_pk;<font></font>
<font></font>
--     bree-gin   itemid    <font></font>
--   btree-gin  bigint       <font></font>
-- https://habr.com/ru/company/postgrespro/blog/340978/#comment_10545932<font></font>
--    create extension btree_gin;<font></font>
create index on history using gin(itemid int8_family_ops) with (fastupdate = false);<font></font>
create index on history_uint using gin(itemid int8_family_ops) with (fastupdate = false);<font></font>
create index on history_str using gin(itemid int8_family_ops) with (fastupdate = false);<font></font>
create index on history_text using gin(itemid int8_family_ops) with (fastupdate = false);<font></font>
create index on history_log using gin(itemid int8_family_ops) with (fastupdate = false);<font></font>
create index on trends using gin(itemid int8_family_ops) with (fastupdate = false);<font></font>
create index on trends_uint using gin(itemid int8_family_ops) with (fastupdate = false);<font></font>
<font></font>
--     bree-gin   itemid    <font></font>
--     brin    128 ,    <font></font>
--           ,<font></font>
--      https://habr.com/ru/company/postgrespro/blog/346460/<font></font>
create index on history using brin(clock) with (pages_per_range = 128);<font></font>
create index on history_uint using brin(clock) with (pages_per_range = 128);<font></font>
create index on history_str using brin(clock) with (pages_per_range = 128);<font></font>
create index on history_text using brin(clock) with (pages_per_range = 128);<font></font>
create index on history_log using brin(clock) with (pages_per_range = 128);<font></font>
create index on trends using brin(clock) with (pages_per_range = 128);<font></font>
create index on trends_uint using brin(clock) with (pages_per_range = 128);<font></font>
</pre><br></div></div><br>   brin        100 .    (100 .  history  100 .  history_uint)  ,            512      ,      128 ,           .     brin    ,        -       ,   ,       . <br><br>     ,   ,     Zabbix:   ¬´ ¬ª           .        .       ,     .     ,    history   btree(itemid, clock desc)      ,       ¬´¬ª          ,   ,  . <br><br>      : <br><br><ol><li>             ¬´ ¬ª      100  (..   ,     ¬´ ¬ª    ) </li><li>     Zabbix ,                  ,          ¬´ ¬ª </li><li>   ,     ,            ¬´ ¬ª     (  ,   web- Zabbix             ¬´ ¬ª ‚Äî ,    5000    ,      web-      ). </li></ol><br><h4>       pg_stat_statements </h4><br> Pg_stat_statements ‚Äî          .     ,         PostgreSQL. <br><br><div class="spoiler"> <b class="spoiler_title">  pg_stat_statements</b> <div class="spoiler_text">    psql: <br><br><pre> CREATE EXTENSION pg_stat_statements; </pre><br>       postgresql.conf: <br><br><pre>shared_preload_libraries = 'pg_stat_statements'<font></font>
pg_stat_statements.max = 10000 #   sql ,     (     );<font></font>
pg_stat_statements.track = all # all -   (    ), top -   /, none -  <font></font>
pg_stat_statements.save = true #     <font></font>
</pre><br>  : <br><br><pre> SELECT pg_stat_statements_reset(); </pre><br>          : <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">substring</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">query</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'[^(]*'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> query_sub, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(calls) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> calls, <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span>(mean_time) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> mean_time <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pg_stat_statements <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">query</span></span> ~ <span class="hljs-string"><span class="hljs-string">'insert into'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">query</span></span> ~ <span class="hljs-string"><span class="hljs-string">'update trends'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">substring</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">query</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'[^(]*'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> calls <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span></code> </pre> </div></div><br><h4>      </h4><br>      Zabbix      vfs.dev.read  vfs.dev.write.        .              utilization,    await      . <br><br>         iowait  cpu      sql ,        zabbix           .           ,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">lesovsky</a>  :   iostat       json  ,          . <br><br>  Pull request   ,         <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">    fork</a> . <br><br>            Zabbix    iowait cpu   utiliztion        (  ).     (sda ‚Äî  , sdc ‚Äî   ): <br><br><img src="https://habrastorage.org/webt/oa/nj/fa/oanjfa3hajssftbq22dk8njiwj0.png"><br><br><h4>    </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Depois de configurar o DBMS, a indexa√ß√£o e o particionamento, voc√™ pode prosseguir para a escala vertical - para melhorar as caracter√≠sticas de hardware do servidor: adicione RAM, altere as unidades para estado s√≥lido e adicione n√∫cleos de processador. </font><font style="vertical-align: inherit;">Esse √© um aumento de desempenho garantido, mas √© melhor fazer isso somente ap√≥s a otimiza√ß√£o do software.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Criando um cluster distribu√≠do </font></font></h4><br>         ‚Äî   :   ,   -.          <s>(      )</s> ,        Zabbix   pg_pathman       TimescaleDB. <br><br>    ,        ! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt468463/">https://habr.com/ru/post/pt468463/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt468445/index.html">Firefox e Chrome criptografam consultas DNS e evitam a censura</a></li>
<li><a href="../pt468447/index.html">Laragon - WAMP com dom√≠nios locais autom√°ticos</a></li>
<li><a href="../pt468453/index.html">MBLT19 :: relat√≥rios, batalha e teste de produtos</a></li>
<li><a href="../pt468455/index.html">√ìtimo GPS e seu lado sombrio</a></li>
<li><a href="../pt468459/index.html">Vis√£o geral do detector de radar por assinatura: nosso carro-chefe Playme Silent 2</a></li>
<li><a href="../pt468465/index.html">Vis√£o do advogado: como as empresas de TI podem rescindir um contrato com um cliente governamental t√≥xico</a></li>
<li><a href="../pt468471/index.html">Vis√£o geral do AngularConnect 2019. Parte 1</a></li>
<li><a href="../pt468479/index.html">‚ÄúAs pessoas pensam que o livre √© in√∫til. Pareceu-me que eu poderia convenc√™-los ‚Äù- Yuri Yartsev sobre a escola Russol</a></li>
<li><a href="../pt468481/index.html">Como o S7 foi o primeiro na R√∫ssia a vender passagens a√©reas online</a></li>
<li><a href="../pt468485/index.html">Quando voc√™ quer uma interface gr√°fica bonita, mas a gpu n√£o √©</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>