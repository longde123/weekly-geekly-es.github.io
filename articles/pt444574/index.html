<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíö ‚ùî üé© Miniatura Macintosh Plus üç£ üëÜüèº üë©‚Äçüë¶</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nos primeiros dias dos computadores dom√©sticos, havia uma empresa chamada Apple. Ela acabara de fazer grandes progressos com a linha de computadores A...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Miniatura Macintosh Plus</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/444574/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/160/d50/755/160d50755b66bf8a810c5b9f62491add.jpg" alt="imagem"></div><br>  Nos primeiros dias dos computadores dom√©sticos, havia uma empresa chamada Apple.  Ela acabara de fazer grandes progressos com a linha de computadores Apple II, mas precisava de inova√ß√£o para se manter no topo do mercado de computadores em ritmo acelerado.  A empresa j√° trabalhou na linha Lisa, inspirada em mini computadores e destinada a usu√°rios corporativos, o que significa que tinha um pre√ßo adequado, mas para o consumidor m√©dio parecia muito caro.  Como um projeto adicional, o Macintosh foi desenvolvido, que deveria ser a realiza√ß√£o da id√©ia de uma nova gera√ß√£o de computadores para ‚Äúpessoas de rua‚Äù e custou cerca de US $ 500.  O projeto foi assumido por Steve Jobs e, sob sua lideran√ßa, o hardware ficou mais avan√ßado, o software recebeu uma GUI em vez de uma interface de texto e o pre√ßo subiu para quase US $ 2.500.  Embora o equipamento obtido por esse pre√ßo tenha sido um pouco decepcionante, por exemplo, n√£o possu√≠a aceleradores gr√°ficos e recursos de som de outras m√°quinas, mas o software justificava o pre√ßo.  O primeiro Macintosh foi o Mac 128K, e seu sucesso levou √† cria√ß√£o de modelos mais avan√ßados deste Mac compacto, em particular o Macintosh 512K, Macintosh Plus e Macintosh SE Series. <br><br>  Embora o desenvolvimento do Macintosh tenha ocorrido por volta de 1984, muito antes de eu come√ßar a entender os computadores, eu tinha alguns pontos fracos no Macintosh compacto: o primeiro computador que meus pais compraram foi o Macintosh Plus.  Mais tarde, foi complementado com um disco r√≠gido SCSI de 20 MB e nesta m√°quina eu escrevi meus primeiros programas b√°sicos.  Quando eu ainda morava na Holanda, comprei uma m√°quina SE / 30 quebrada e a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">transformei</a> em um servidor Linux, capaz de executar o software Mac.  No entanto, deixei este carro na Holanda e aqui, em Xangai, n√£o tenho mais o hardware cl√°ssico da Apple. <br><br>  Embora seja √≥bvio que n√£o preciso mais do Mac Plus na vida cotidiana, gostei da ideia de t√™-lo em m√£os em caso de ataques de nostalgia. <a name="habracut"></a>  Talvez eu possa ter uma pequena parte da experi√™ncia do Macintosh se eu mesmo criar uma c√≥pia pequena dessa m√°quina.  Se j√° tenho alguma experi√™ncia na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">cria√ß√£o de vers√µes menores de hardware antigo</a> , por que n√£o tentar aplicar esse processo para criar o vener√°vel Mac Plus? <br><br><h1>  Exibi√ß√£o </h1><br>  O que devo usar para construir uma m√°quina dessas?  No come√ßo, tive a id√©ia de pegar um Raspberry Pi ou algo semelhante, adicionar uma tela LCD de 2,5 polegadas, um emulador como PCE ou MiniVMac, imprimir um estojo em uma impressora 3D e considerar o trabalho realizado.  Mas n√£o acho que essa ideia valha a pena: a m√°quina para o meu gosto n√£o ser√° apenas muito grande, mas o projeto em si √© muito simples.  No Mac 128K original, mesmo quando o resultado final era muito baixo, os desenvolvedores conseguiram fazer alguns truques para economizar dinheiro.  A montagem simples de uma r√©plica do ‚Äúferro‚Äù padr√£o √© contr√°ria ao esp√≠rito do design original.  Ent√£o eu fui ao Taobao para mais ingredientes ex√≥ticos! <br><br><img align="right" src="https://habrastorage.org/getpro/habr/post_images/42f/7cf/4ba/42f7cf4ba397243640f69ed0864bb72e.png"><br>  Eu decidi come√ßar com a exibi√ß√£o.  Por sua vez, o Mac tinha uma tela de alta resolu√ß√£o, por isso era muito importante escolher a tela certa.  Geralmente, quando se trata de escolher monitores no mercado chin√™s de eletr√¥nicos, o sortimento √© grande.  Infelizmente, o "grande sortimento" consiste em telas de alta resolu√ß√£o, mas tamb√©m em tamanhos grandes ou em telas pequenas de pequena resolu√ß√£o.  Idealmente, eu precisava de uma resolu√ß√£o de 512x342 pixels;  esta √© a resolu√ß√£o nativa do Mac e em uma tela semelhante eu posso exibir tudo sem aplicar zoom.  Infelizmente, n√£o existem telas prontas dessa resolu√ß√£o no mercado;  o anal√≥gico mais pr√≥ximo ser√° algo como 640x480.  Por alguma raz√£o, as telas desta resolu√ß√£o s√£o bem grandes: a menor tem uma diagonal de 3,5 polegadas.  Portanto, se eu quiser tornar o Mac o menor poss√≠vel, tenho que reduzir a resolu√ß√£o. <br><br>  Tendo decidido que √© poss√≠vel reduzir um pouco a resolu√ß√£o, obtive uma variedade de um conjunto bastante grande de telas.  Uma das primeiras telas vistas foi o x163qln01 - uma tela OLED de 1,63 polegadas fabricada pela AUO.  √â um pouco caro (cerca de US $ 25 por tela), mas geralmente pode ser encontrado no Taobao, e a folha de dados pelo menos documenta os contatos, tamanhos e requisitos de energia.  Parece que essa tela foi projetada para algum tipo de marca de rel√≥gio inteligente no Android e, para um pouco de google, at√© encontrei algumas sequ√™ncias de inicia√ß√£o que podem ser usadas. <br><br>  O √∫nico problema (exceto o conector, cujos contatos est√£o localizados a uma dist√¢ncia de 0,5 mm um do outro) era que o monitor n√£o usa uma interface paralela e n√£o SPI, mas a interface MIPI.  Vou ter que lidar com isso mais tarde. <br><br>  Depois de selecionar a tela, voc√™ pode ir para o processador.  Eu escolhi o m√≥dulo ESP32-Wrover.  Este m√≥dulo cont√©m um ESP32 (um chip WiFi com duas CPUs de 32 bits operando a uma frequ√™ncia de 240 MHz e com aproximadamente meio megabyte de RAM), 4 mem√≥ria flash MiB e 4 PSRAM MiB.  Sugeri que os dois n√∫cleos da CPU fossem r√°pidos o suficiente para emular um Mac e que eu poderia usar 4 MiB de PSRAM como RAM do Mac.  Embora 4 MiB de mem√≥ria flash n√£o sejam muito, eles devem ser suficientes para o emulador, al√©m de um pequeno disco r√≠gido com software e programas do sistema.  Tamb√©m me beneficio do fato de trabalhar na Espressif, portanto esse equipamento √© bastante familiar para mim;  Al√©m disso, posso pegar alguns m√≥dulos do trabalho, em vez de compr√°-los e aguardar a entrega. <br><br>  Portanto, tudo est√° quase pronto para funcionar - a tela OLED ainda precisava de componentes para a fonte de alimenta√ß√£o; portanto, o n√∫mero de componentes aumentou por um estabilizador de queda de baixa tens√£o (LDO) e outros chips de fonte de alimenta√ß√£o.  Para o Mac, o som tamb√©m era necess√°rio, ent√£o peguei um chip e um alto-falante baratos e adquiri o m√≥dulo FT232 padr√£o para alimenta√ß√£o e depura√ß√£o.  Todos esses componentes s√£o muito pequenos e permitem reduzir o corpo do dispositivo;  o resultado deve ser um modelo ligeiramente superior a 1/6 de um Mac real. <br><br><h1>  Controle de exibi√ß√£o </h1><br>  Embora eu n√£o possa reclamar da resolu√ß√£o, tamanho e brilho da tela, acabou sendo mais dif√≠cil exibir pixels nela.  O MIPI n√£o era suportado pelo sil√≠cio ESP32, ent√£o eu precisava encontrar outra maneira de me comunicar com ele.  MIPI DSI √© um padr√£o desenvolvido pela <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">MIPI Alliance</a> e n√£o est√° aberto;  como esse √© um hobby para mim, tive que coletar informa√ß√µes de documentos vazados e testar dispositivos existentes.  Felizmente, um ano ou dois atr√°s, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Mike Harrison fez</a> engenharia reversa da interface MIPI DSI usada para controlar os monitores do iPod ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">1</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">2</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">3</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">4</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">5</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">site</a> ) e tamb√©m encontrou v√°rias c√≥pias das especifica√ß√µes.  Isso tornou minha vida muito mais f√°cil: pelo menos, me ajuda a descobrir o que enviar para a tela. <br><br>  Embora exista muito mais na interface (e para descobrir isso, voc√™ deve assistir a todos os v√≠deos aos quais forneci os links acima), a camada MIPI f√≠sica √© bastante f√°cil de explicar.  O MIPI usa quatro fios: dois barramentos de dados e dois barramentos de rel√≥gio.  Ele tamb√©m possui dois modos de transmiss√£o de sinal: modo Low Power (LP) e modo High Speed ‚Äã‚Äã(HS). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/23d/c2b/af2/23dc2baf2a437935e2144183e57c8c09.png"></div><br>  No modo de baixa pot√™ncia, os fios s√£o usados ‚Äã‚Äãseparadamente para transmitir estruturas de dados de controle, bem como para indicar que certos comandos t√™m um efeito direto no receptor f√≠sico, por outro lado.  A queda de tens√£o neste modo √© bastante grande em compara√ß√£o com o modo de alta velocidade: para um sinal alto, a tens√£o √© de aproximadamente 1,2 V e, para um sinal baixo, √© de aproximadamente 0 V. Como o modo de baixa energia possui mais estados de sinal, ele executa fun√ß√µes como enviar o destinat√°rio do pedido para alternar para o modo de alta velocidade ou sair dele.  No gr√°fico acima, as linhas azuis indicam a transmiss√£o de dados no modo de baixa energia. <br><br>  No modo de alta velocidade, dois barramentos de rel√≥gio (CLKP / CLKN), bem como dois barramentos de dados (DP / DN) funcionam como barramentos diferenciais: um bar √© sempre oposto ao outro.  O receptor detecta as diferen√ßas entre os dois barramentos e, com base neles, define o valor transmitido: 1 se estiver acima de DP e 0 se estiver acima de DN.  Como o nome indica, o modo de alta velocidade fornece transfer√™ncia de dados muito r√°pida com uma frequ√™ncia de clock de at√© 1,5 GHz.  Para conseguir isso sem muita interfer√™ncia eletromagn√©tica e consumo de energia, o padr√£o usa o seguinte truque: usa tens√µes muito baixas: a tens√£o nos pares √©, em m√©dia, 200 mV, com desvios de ¬± 100 mV por barramento para indicar zeros e uns.  No gr√°fico acima, os bits vermelhos s√£o transmitidos no modo de alta velocidade. <br><br>  Do ponto de vista da transfer√™ncia dos pr√≥prios dados no modo de alta velocidade, a interface pode ser essencialmente considerada uma interface SPI bastante estranha e diferencial: h√° um sinal de rel√≥gio e um canal de transmiss√£o de dados, e a cada ciclo de rel√≥gio o valor dos dados √© transmitido para a interface.  A diferen√ßa do SPI (exceto que os sinais s√£o diferenciais) √© que o bit de dados √© transmitido apenas quando o estado dos barramentos CLK muda, e n√£o apenas, por exemplo, na borda de ataque.  Outra diferen√ßa √© que o in√≠cio de uma transmiss√£o n√£o √© reconhecido quando o sinal no barramento / CS fica baixo, mas sim um sinal em banda: cada transmiss√£o de dados come√ßa com uma √∫nica "palavra m√°gica" e o receptor determina esse valor para entender quando a transmiss√£o come√ßa. <br><br>  Para garantir que essa interface interaja com o ESP32, terei que executar uma mudan√ßa de n√≠vel.  Queria alimentar o ESP32 a partir de uma fonte de 3,0 V para que todos os GPIOs tamb√©m tivessem 3,0 ou 0 V. Para adaptar isso aos n√≠veis de sinal da interface MIPI, escolhi a solu√ß√£o mais barata: usei apenas redes divis√≥rias de resistores. <br><br>  Para calcular os valores do resistor, criei equa√ß√µes para os tr√™s estados de tens√£o de sa√≠da que me interessam (1,1 V para o sinal de alta pot√™ncia baixa, 0,07 V para o sinal de baixa velocidade alta, 0,33 V para o sinal de alta velocidade; as tens√µes foram escolhidas como para que na maioria dos casos permane√ßam dentro da especifica√ß√£o) e dos tr√™s estados de entrada que devem ger√°-los.  Eu tenho as equa√ß√µes.  Teoricamente, era poss√≠vel resolv√™-los manualmente, mas no final os abandonei no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">WolframAlpha</a> e obtive os valores exigidos do resistor. <br><br><pre>            3v
 G -R1 - + R3
 G-R2 - + - + ----&gt;
            R4
            GND<font></font>
<font></font>
 R4 * (1,9 / R1 + 1,9 / R3) = 1,1, 
 (1 / (1 / R4 + 1 / R1 + 1 / R2)) * (2,93 / R3) = 0,07, 
 (1 / (1 / R4 + 1 / R1)) * 2,67 * (1 / R3 + 1 / R2) = 0,33, 
 R2 = 1000<font></font>
<font></font>
 R1 = 280, R2 = 1K, R3 = 3K6, R4 = 150 </pre><br><br>  Nesse ponto, percebi que voc√™ tamb√©m pode trapacear um pouco: como no modo de alta velocidade, os barramentos s√£o diferenciais, a tela analisar√° apenas a diferen√ßa entre os dois barramentos para determinar os dados transmitidos.  Isso significa que eu posso salvar o GPIO mantendo uma tens√£o fixa em um dos barramentos e aplicando um sinal alto ou baixo no outro.  Para fazer isso, eu precisava de um segundo tipo de rede de resistores: <br><br><pre>            3v
            R3
 G-R1 - + - + ----&gt;
            R4
            GND<font></font>
<font></font>
 R4 * (1,9 / R1 + 1,9 / R3) = 1,1,
 (1 / (1 / R4 + 1 / R1)) * (2,8 / R3) = 0,2,
 R4 = 150<font></font>
<font></font>
 R1 = 320, R3 = 1500, R4 = 150 </pre><br><br>  Outra tarefa foi criar um circuito de rel√≥gio.  O SPI normal transmite um pouco na borda principal do barramento de clock.  (Ou na extremidade traseira, dependendo da configura√ß√£o.) O MIPI transmite um pouco nas extremidades dianteira e traseira do sinal do rel√≥gio.  Embora o m√≥dulo SPI do equipamento ESP32 n√£o possa gerar esses sinais por si s√≥, podemos converter um para outro usando um simples D-trigger, cuja sa√≠da invertida est√° conectada √† entrada.  Cada pulso de clock na entrada alterar√° o n√≠vel de sa√≠da, conforme exigido. <br><br><h1>  Diagrama de circuito </h1><br>  Tendo lidado com o equipamento de exibi√ß√£o, terminamos a parte mais dif√≠cil.  Agora tudo o que precisamos fazer √© adicionar o resto.  Vamos come√ßar com a fonte de energia.  √â bem simples: eu alimento todo o circuito de 5V de um conversor USB para serial, que tamb√©m pode ser usado como uma interface de depura√ß√£o / programa√ß√£o.  Essa tens√£o √© utilizada para gerar os +4,6 V, -3,4 V e 1,8 V exigidos pela tela OLED, bem como 3,0 V para alimentar o ESP32.  Tens√µes de +4,6 V e -3,4 V s√£o geradas pelo chip TPS65631, e o circuito de refer√™ncia √© mostrado na folha de dados da tela OLED.  Outras tens√µes s√£o geradas por um par de LDOs simples. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/70a/d6a/f70/70ad6af70745587d6804e09451e192da.png"></div><br>  O Macintosh tamb√©m tinha som.  Pelos padr√µes modernos, sua qualidade n√£o √© muito alta (22 kHz, 8 bits), mas os sons de seus programas agora s√£o lend√°rios, portanto, no meu projeto, n√£o pude recus√°-los.  O ESP32 possui um DAC interno de 8 bits, usado para criar ondas sonoras anal√≥gicas geradas pelo emulador.  Em seguida, eles s√£o alimentados ao NS8002, que √© um amplificador de som da classe AB de 2 watts montado no pequeno formato SOIC8.  √â barato, requer muito poucos componentes de suporte e cria som mais do que suficiente para chamar a aten√ß√£o para o pequeno Mac. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/05d/461/dea/05d461deabf92b53b75f1e3290cef040.png"></div><br>  Um dos aspectos que tornou o Macintosh t√£o revolucion√°rio foi o fato de ser um dos primeiros computadores comerciais com um mouse.  A equipe do Macintosh pensou no mouse com tanto cuidado que quase todo o sistema operacional se baseia em elementos de interface do usu√°rio controlados pelo mouse e, ao contr√°rio, por exemplo, do IBM PC, o Macintosh inteiro pode ser controlado por um mouse.  Obviamente, meu pequeno Mac tamb√©m precisava desse importante perif√©rico.  Ainda me lembro dos mouses de esferas vendidos com o primeiro Macintosh, mas n√£o fiquei muito satisfeito com a necessidade de limpar os roletes com muita frequ√™ncia;  √© por esse motivo que esses dispositivos mec√¢nicos foram completamente substitu√≠dos por mouses √≥pticos.  A vantagem disso √© que os detalhes desses novos mouses √≥pticos s√£o bastante simples de encontrar: por exemplo, n√£o demorou muito para encontrar o vendedor dos sensores de mouse para jogos ADNS9500 e da √≥ptica correspondente. <br><br>  Outro aspecto conveniente √© que o sensor √≥ptico do mouse √© um dispositivo profundamente integrado: requer apenas alguns componentes externos para funcionar, e isso √© refletido no diagrama.  Foram adicionados v√°rios capacitores para estabilizar a tens√£o, um transistor MOS (copiado diretamente da folha de dados) para ligar o diodo laser e outros detalhes padr√£o.  O sensor do mouse transmite dados atrav√©s de um sinal SPI de quatro fios, e eu usei um desses fios para enviar o sinal do bot√£o do mouse: quando clico no bot√£o, o contato MISO √© pressionado um pouco.  O valor desse resistor pull-up n√£o √© suficiente para o mouse parar de transmitir dados, mas o suficiente para superar o resistor pull-up, que normalmente puxa o barramento para cima; portanto, quando o sensor cria tr√™s estados no barramento MISO, o ESP32 pode reconhecer o pressionamento de um bot√£o. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/786/dc7/476/786dc7476e66ab6f8c477114a34f531b.png"></div><br>  Finalmente, voc√™ precisa conectar a tela OLED.  J√° conclu√≠mos todo o trabalho dif√≠cil de calcular os valores de todos os resistores, portanto o circuito deve falar mais ou menos por si mesmo.  O chip adicionado √© um D-flip-flop e √© usado para reduzir pela metade a velocidade do rel√≥gio: como mencionado acima, o padr√£o MIPI exige um novo bit cada vez que a polaridade do sinal do rel√≥gio √© invertida, enquanto o ESP32 transmite um novo bit apenas na parte frontal ou traseira frente. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/784/48e/7a6/78448e7a69765e0d224d6b36281a3f20.png"></div><br>  Depois de desenhar um diagrama esquem√°tico, passei a criar um design de placa de circuito.  A tela que eu selecionei deveria ser montada na placa que a controla e o conector deve estar na parte traseira dessa placa de circuito.  Embora isso n√£o tenha deixado muito espa√ßo para outros componentes, eu ainda queria colocar todos os outros componentes do outro lado. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7ef/ab4/18e/7efab418e1c2d82cd2c906ca8e91e66a.jpg"></div><br>  √â √≥timo ter uma boa vis√£o e uma pistola de ar quente: isso me permitiu usar os componentes 0603 e colocar tudo no espa√ßo limitado da placa.  Seria especialmente dif√≠cil conectar o conector da tela e o chip de pot√™ncia OLED QFN a um ferro de solda convencional. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/090/5db/fb3/0905dbfb3162f4d093b2e32d7a1aff8c.jpg"></div><br>  Percebi que o sensor do mouse e seus componentes ocupariam muito espa√ßo na placa, ent√£o decidi soldar todos os componentes no pr√≥prio sensor.  Gra√ßas a isso, tudo pode ser colocado no mouse. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4d9/51b/a17/4d951ba1796a5b89dc7288e6bbdf0c58.jpg"></div><br><br><h1>  De software </h1><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e08/7b1/5f8/e087b15f8fd3a27bcfd01de4de161aef.jpg"></div><br>  Obviamente, o software √© um elemento importante o suficiente desta montagem: voc√™ deve emular todo o Macintosh.  No entanto, o Macintosh n√£o √© uma m√°quina t√£o complicada.  De fato, ele consiste em um microcontrolador 68000, um controlador de transfer√™ncia serial Zilog Z8530 que controla a porta serial, 6522 VIA para E / S interna e para fornecer uma interface com um teclado, al√©m de v√°rias matrizes l√≥gicas program√°veis ‚Äã‚Äã(PAL) contendo l√≥gica para a exibi√ß√£o e o som.  Ele tamb√©m possui um chip Integrated Woz Machine que fornece uma interface com uma unidade de disquete.  Este √© um chip bastante complicado;  no entanto, n√£o pretendo emular um disquete; portanto, ser√° suficiente emular o IWM, retornando constantemente que n√£o h√° disco na unidade.  Em vez disso, pretendo emular totalmente o chip SCR NCR 5380, conectado a um disco r√≠gido SCSI emulado, que ser√° lido na mem√≥ria flash ESP32-Wrover incorporada. <br><br>  Al√©m disso, o sistema ter√° muito poucos programas com acesso direto ao equipamento: os programadores de Mac foram instru√≠dos desde o in√≠cio a usar as camadas de abstra√ß√£o de hardware no n√≠vel do SO para manter a compatibilidade com vers√µes futuras do equipamento Mac.  Em geral, isso significa que, se eu conseguir emular o hardware a tal ponto que o sistema operacional inicialize e esteja satisfeito com tudo, a maioria dos programas funcionar√° sem problemas. <br><br>  Ent√£o eu decidi que voc√™ poderia tentar escrever um emulador do zero.  Mais precisamente, n√£o completamente do zero;  68000 √© um animal bastante complicado e eu n√£o queria reinventar <i>a</i> roda.  Em vez disso, pesquisei na Internet e descobri que o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">MAME</a> tem um emulador de 68K baseado em CK, conveniente e r√°pido, chamado Musashi, que atende perfeitamente √†s minhas necessidades.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ser√° necess√°rio conjurar um pouco para transferir c√≥digos de opera√ß√£o em vez da RAM para a mem√≥ria flash, mas, para o resto, quase nada √© necess√°rio para a porta para o ESP32. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No entanto, n√£o planejei desenvolver o projeto inteiro no ESP32: como o chip suporta o OpenOCD, que oferece recursos de depura√ß√£o bastante amplos, o ciclo "baixado-testado-carregado-fixo" ser√° mon√≥tono demais. Portanto, decidi primeiro desenvolver tudo na minha m√°quina Linux, sem esquecer as limita√ß√µes do ESP32. Ent√£o comecei a usar a folha de dados para diferentes chips, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">informa√ß√µes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sobre o </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">Linux-68K</font></a><font style="vertical-align: inherit;"> para a m√°quina, bem como informa√ß√µes da s√©rie Inside Macintosh que podem ser encontradas na Internet. Quando n√£o consegui descobrir o que fazer a seguir, pude olhar sob o cap√¥ de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">outros </font></font></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">emuladores de </font></font></a> <font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">c√≥digo </font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">aberto</font></a></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Armado com tudo isso, escolhendo o gcc como compilador e o libsdl como a biblioteca para trabalhar com gr√°ficos, comecei a trabalhar. </font><font style="vertical-align: inherit;">Em resumo, depois de um tempo, receberei um emulador MacPlus simples, mas geralmente funcional: mouse, v√≠deo, disco r√≠gido SCSI e som:</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d9c/436/b8f/d9c436b8f1bf87e4ddeca8b928090c0e.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como meu hardware ainda n√£o estava pronto, decidi portar meu emulador para o ESP-Wrover-Kit do devboard. </font><font style="vertical-align: inherit;">Eu ainda tinha v√°rias dessas placas em m√£os e, al√©m do m√≥dulo Wrover, que eu usarei de qualquer maneira, elas t√™m uma tela conveniente de 320x240 que pode ser usada para testar o v√≠deo.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/824/21d/c95/82421dc95010e61d82c8465df2301c1d.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ap√≥s a instala√ß√£o, o emulador de Mac ganhou bastante dinheiro nessa placa; de fato, geralmente √© bem pr√≥ximo dos 7,8 MHz em que o Mac Plus roda. (7,8 MHz ser√° um pouco mais r√°pido que o Mac Plus; j√° que nesta parte da mem√≥ria os ciclos de buffer de quadro e sistema de som s√£o consumidos, a frequ√™ncia pode ser reduzida em 35%.) </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Obviamente, o emulador no devboard √© um bom passo √† frente, mas no final, tudo deve funcionar na tela que eu comprei, e n√£o na tela do devboard. E mais uma coisa: a tela do devkit tem uma tela de 320x240 e corta a parte s√≥lida da tela do Mac. A tela que usarei tem um tamanho de 320x320 e, portanto, √© maior apenas na vertical: como posso exibir uma tela de 512x342 Mac?</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">H√° apenas uma maneira de colocar 512x342 pixels em uma tela de 320x320, e isso √© dimensionado. De fato, tiramos uma imagem, compactamos, diminu√≠mos e depois exibimos. No entanto, o dimensionamento pode ser feito de v√°rias maneiras diferentes, e considerando que a imagem em preto e branco gerada pelo sistema operacional pressup√µe que cada pixel crie um ponto de luz claramente definido na tela, ou seja, existem v√°rias maneiras de estragar tudo. Preciso perder o m√≠nimo de pixels poss√≠vel. Ou seja, voc√™ precisa aumentar a resolu√ß√£o da tela OLED.</font></font><br><br>  Mas como fazer isso?<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√â improv√°vel que voc√™ possa abrir a tela OLED e colocar mais alguns pixels dentro. No entanto, isso n√£o √© necess√°rio; a resolu√ß√£o da tela OLED j√° √© tr√™s vezes a declarada. O motivo √© que essa tela √© colorida: cada "pixel" virtual possui subpixels vermelhos, verdes e azuis. Al√©m disso, nessa tela espec√≠fica, os subpixels s√£o alinhados com um tri√¢ngulo. Aqui est√° uma captura de tela em close com tr√™s pixels ativados:</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d51/597/1e1/d515971e1bab244debdf6e3da2ff960d.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como voc√™ pode ver, pixels s√£o conjuntos triangulares de tr√™s subpixels; </font><font style="vertical-align: inherit;">dependendo da coluna, os tri√¢ngulos apontam para baixo ou para cima. </font><font style="vertical-align: inherit;">Basicamente, isso significa que a resolu√ß√£o de sub-pixels da tela √© de 480 x 640 pixels. </font><font style="vertical-align: inherit;">Embora isso ainda n√£o seja suficiente para exibir 512x342 pixels, a diferen√ßa √© t√£o pequena que, se voc√™ selecionar a pequena escala correta, a exibi√ß√£o ser√° o mais leg√≠vel poss√≠vel para uma tela de 1,63 polegadas exibindo uma GUI projetada para uma tela de 9 polegadas:</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/cfa/bf6/817/cfabf6817fcd374ca27afcf19244d6a6.jpg"></div><br><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Habita√ß√£o </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ent√£o agora eu tenho uma tela e um software que emulam muito bem o Macintosh Plus, al√©m de um microcontrolador no qual ele pode ser executado. O que est√° faltando? Obviamente, caixas para tudo isso! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Decidi imprimi-lo em uma impressora Formlabs 1+ SLA 3D do meu trabalho. Para fazer isso, primeiro preciso de um modelo. Eu queria cri√°-lo do zero. Obviamente, √© melhor ter um Macintosh Plus real √† m√£o. Na verdade, eu tenho, mas estamos separados por meio continente ... Felizmente, consegui encontrar uma solu√ß√£o quase igualmente boa: uma pessoa gentil indicou as dimens√µes do Mac 128K original (cujo corpo √© quase o mesmo do Plus) no wiki do </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iFixit</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ainda crio todos os meus modelos 3D no OpenScad e, depois de atormentar e xingar, consegui fazer com que todas as curvas parecessem como deveriam. </font><font style="vertical-align: inherit;">Eu tenho um lindo modelo de Mac em uma escala de 1: 6.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c00/29f/772/c0029f7728baf02093072b9a886ba572.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tamb√©m criei o mouse a partir de imagens com o iFixit, mas como um sensor suficientemente grande do mouse √≥ptico deve caber nele, ele n√£o pode ser dimensionado para 1/6 de um mouse real. </font><font style="vertical-align: inherit;">A escala est√° mais pr√≥xima de 2/5, portanto, o mouse parece grande em compara√ß√£o com o pequeno Mac, mas √© muito mais conveniente para dedos humanos sem escala.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7af/f29/846/7aff29846237b0b754bafd8caa526ad1.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ent√£o, tudo o que resta √© imprimir os modelos. </font><font style="vertical-align: inherit;">Exportei a constru√ß√£o para v√°rios arquivos STL e os imprimi no Formlabs 1+. </font><font style="vertical-align: inherit;">O resultado final foi bom o suficiente; </font><font style="vertical-align: inherit;">S√≥ lamento n√£o ter adicionado travas nas duas partes do design. </font><font style="vertical-align: inherit;">Este problema foi resolvido com uma gota de supercola.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d3e/be4/eae/d3ebe4eae5427f564e366961b385cff6.jpg" alt="imagem"></div><br><br><h1>  Resultado </h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ent√£o, eu tinha todos os componentes e s√≥ conseguia mont√°-los. Os conectores PCB na parte frontal do chassi s√£o protegidos com v√°rios clipes. O conversor de USB para serial, usado como mecanismo de inicializa√ß√£o e fonte de alimenta√ß√£o, √© conectado √† parte traseira e tamb√©m suporta v√°rios terminais. Esqueci de fazer algo para montar dentro do alto-falante, mas consegui consert√°-lo no gabinete com super cola. O mouse est√° conectado por um conjunto de fios finos. (Sim, eles s√£o um tanto inconsistentes com o esquema de cores ... assim que encontrar um cabo multicore mais bonito, eu o corrigirei.)</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1e8/5d2/efa/1e85d2efa496b34b17d3b655b73f459f.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ao desenvolver tudo em um computador, voc√™ percebe a verdadeira escala do produto apenas quando o projeto √© totalmente materializado, por exemplo, quando voc√™ recebe placas de circuito impresso da f√°brica ou ap√≥s imprimir na impressora 3D do design do gabinete em que trabalha h√° semanas. </font><font style="vertical-align: inherit;">Claro, eu sabia que tudo seria seis vezes menor que o Mac original, mas somente depois de juntar tudo e ver o carro ao vivo, percebi o que isso significa. </font><font style="vertical-align: inherit;">O Mac realmente era pequeno!</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/160/d50/755/160d50755b66bf8a810c5b9f62491add.jpg"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b03/2ee/25e/b032ee25e2fabeb081533d97bd368034.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">E, apesar do tamanho pequeno e da falta de um teclado, ele √© capaz de executar a maioria dos programas pelos quais o Mac √© famoso. </font><font style="vertical-align: inherit;">Aqui est√° uma demonstra√ß√£o. </font><font style="vertical-align: inherit;">Nos primeiros 20 segundos, uma verifica√ß√£o de mem√≥ria √© executada e, por experi√™ncia, sei que uma verifica√ß√£o t√£o longa n√£o √© um bug: o Mac Plus original demorou o mesmo tempo para carregar, mesmo ap√≥s a atualiza√ß√£o.</font></font><br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/oMH8GGEcqQU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ent√£o, o que h√° de bom neste Mac Plus? Embora tenha gostado de cri√°-lo, devo admitir que, sem um teclado, ele n√£o pode ser usado com todo o seu potencial. Al√©m disso, ele n√£o possui os meios de comunica√ß√£o: planejei implementar o AppleTalk via WiFi, mas n√£o obtive sucesso devido √†s peculiaridades que n√£o consegui emular no pr√≥prio chip controlador de barramento serial do Mac original. No entanto, tendo o projeto conclu√≠do nesse estado, finalmente posso realizar meu sonho antigo e coloc√°-lo na mesa do Mac com as torradeiras do protetor de tela After Dark voando pela tela:</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b51/a98/7fe/b51a987fe61c1d827d9075b83bf36b2b.gif"></div><br>  ,    open-source,     ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Github</a> .    Beer-Ware license,        ,  .   -  -   ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a>   . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt444574/">https://habr.com/ru/post/pt444574/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt444564/index.html">Desenvolvimento de produtos digitais com modelos mentais</a></li>
<li><a href="../pt444566/index.html">Sikorsky realizou uma demonstra√ß√£o de um helic√≥ptero n√£o tripulado com um homem a bordo</a></li>
<li><a href="../pt444568/index.html">Os 10 principais erros de projetos C ++ encontrados em 2018</a></li>
<li><a href="../pt444570/index.html">Os 10 principais erros nos projetos C ++ para 2018</a></li>
<li><a href="../pt444572/index.html">LED piscando</a></li>
<li><a href="../pt444576/index.html">Como o sistema de tipos aprimora seu c√≥digo JavaScript</a></li>
<li><a href="../pt444578/index.html">Top 3D Expo 2019: Yousef Hesuani, da 3dbio - impress√£o 3D de √≥rg√£os e tecidos</a></li>
<li><a href="../pt444580/index.html">Infraestrutura FBO Sheremetyevo: como as aeronaves leves se preparam para o voo</a></li>
<li><a href="../pt444582/index.html">Otimizador de pol√≠tica de seguran√ßa NGFW da Palo Alto Networks</a></li>
<li><a href="../pt444584/index.html">O Android oferecer√° aos usu√°rios europeus um navegador e um mecanismo de pesquisa de escolha</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>