<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚öΩÔ∏è üçå üõ≥Ô∏è Wie ich die Bildverarbeitung auf Android 15 Mal beschleunigt habe üìù üí™üèæ üë®üèº‚Äçüé§</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Wie kann die Bildverarbeitung zur Laufzeit optimiert werden, wenn 6 Bilder erstellt werden m√ºssen, von denen jedes aus 15 bis 16 PNGs besteht, die nac...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Wie ich die Bildverarbeitung auf Android 15 Mal beschleunigt habe</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/439596/"><p>  Wie kann die Bildverarbeitung zur Laufzeit optimiert werden, wenn 6 Bilder erstellt werden m√ºssen, von denen jedes aus 15 bis 16 PNGs besteht, die nacheinander √ºberlagert werden, ohne dass unterwegs eine OutOfMemoryException empfangen wird? </p><br><p><img src="https://habrastorage.org/webt/n4/ir/yg/n4irygl0boui-gzrxl1lolvdezg.jpeg" alt="Bild"></p><a name="habracut"></a><br><p>  Bei der Entwicklung meiner Haustieranwendung bin ich auf das Problem der Bildverarbeitung gesto√üen.  Ich konnte Google keine guten Googlecases zur Verf√ºgung stellen, daher musste ich auf meinem Rechen laufen und selbst ein Fahrrad erfinden. <br>  Auch w√§hrend der Entwicklung gab es eine Migration von Java nach Kotlin, so dass der Code irgendwann √ºbersetzt wird. </p><br><h4 id="zadacha">  Herausforderung </h4><br><p> <em>Bewerbung f√ºr das Training im Fitnessstudio.</em>  <em>Es ist notwendig, eine Karte der Muskelarbeit zu erstellen, die auf den Ergebnissen des Trainings in der Anwendungslaufzeit basiert.</em> <em><br></em>  <em>Zwei Geschlechter: M und G. Betrachten Sie Option M, denn f√ºr M ist alles gleich.</em> <em><br></em>  <em>Es sollten 6 Bilder gleichzeitig erstellt werden: 3 Perioden (eine Trainingseinheit pro Woche und Monat) x 2 Ansichten (vorne, hinten)</em> </p><br><p><img src="https://habrastorage.org/webt/ad/i1/2_/adi12_wz_nqagmag3vg2qxfvgta.jpeg" alt="Bild"></p><br><p>  Jedes dieser Bilder besteht aus 15 Bildern von Muskelgruppen f√ºr eine Vorderansicht und 14 f√ºr eine R√ºckansicht.  Plus 1 Bild des Fundaments (Kopf, H√§nde und F√º√üe).  Insgesamt m√ºssen Sie zum Sammeln der Vorderansicht 16 Bilder von hinten √ºberlagern - 15. </p><br><p>  Nur 23 Muskelgruppen f√ºr beide Seiten (f√ºr diejenigen mit 15 + 14! = 23, eine kleine Erkl√§rung - einige Muskeln sind auf beiden Seiten ‚Äûsichtbar‚Äú). </p><br><p>  Algorithmus in erster N√§herung: </p><br><ol><li>  Basierend auf den Daten aus abgeschlossenen Workouts wird HashMap &lt;String, Float&gt; erstellt, String ist der Name der Muskelgruppe, Float ist der Belastungsgrad von 0 bis 10. </li><li>  Jeder der 23 Muskeln ist in der Farbe von 0 (nicht beteiligt) bis 10 (max. Belastung) neu gestrichen. </li><li>  √úberlagern Sie neu gestrichene Muskelbilder in zwei Bildern (vorne, hinten). </li><li>  Wir speichern alle 6 Bilder. </li></ol><br><p><img src="https://habrastorage.org/webt/rg/d-/s-/rgd-s-voieskh-uscrujasgqvte.jpeg" alt="Bild"></p><br><p>  Zum Speichern von 31 (16 + 15) Bildern mit einer Gr√∂√üe von 1500 x 1500 Pixel im 24-Bit-Modus sind 31 x 1500 x 1500 x 24 Bit = 199 MB RAM erforderlich.  Wenn Sie ~ 30-40 MB √ºberschreiten, erhalten Sie eine OutOfMemoryException.  Dementsprechend k√∂nnen Sie nicht alle Bilder von Ressourcen gleichzeitig laden, da Sie Ressourcen freigeben m√ºssen, um den Empfang nicht zu erhalten.  Dies bedeutet, dass Sie Bilder nacheinander √ºberlagern m√ºssen.  Der Algorithmus wandelt sich in Folgendes um: </p><br><p>  Basierend auf den Daten aus abgeschlossenen Workouts werden HashMap &lt;String, Float&gt;, String - Muskel, Float - Last von 0 bis 10 erstellt. </p><br><p>  Der Zyklus f√ºr jedes der 6 Bilder: </p><br><ol><li>  Ich habe die Ressource BitmapFactory.decodeResource () erhalten. </li><li>  Jeder der 23 Muskeln ist in der Farbe von 0 (nicht beteiligt) bis 10 (max. Belastung) neu gestrichen. </li><li>  √úberlagern Sie neu gestrichene Muskelbilder auf einer Leinwand. </li><li>  Bitmap.recycle () hat eine Ressource freigegeben. </li></ol><br><p>  Wir f√ºhren die Aufgabe in einem separaten Thread mit AsyncTask aus.  In jeder Aufgabe werden nacheinander zwei Bilder erstellt: eine Vorderansicht und eine R√ºckansicht. </p><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BitmapMusclesTask</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AsyncTask</span></span></span><span class="hljs-class">&lt;Void, Void, DoubleMusclesBitmaps&gt; {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> final WeakReference&lt;HashMap&lt;String, Float&gt;&gt; musclesMap; BitmapMusclesTask(HashMap&lt;String, Float&gt; musclesMap) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.musclesMap = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WeakReference&lt;&gt;(musclesMap); } @<span class="hljs-function"><span class="hljs-function">Override </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> DoubleMusclesBitmaps </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doInBackground</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Void... voids)</span></span></span><span class="hljs-function"> </span></span>{ DoubleMusclesBitmaps bitmaps = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DoubleMusclesBitmaps(); bitmaps.bitmapBack = createBitmapMuscles(musclesMap.get(), <span class="hljs-literal"><span class="hljs-literal">false</span></span>); bitmaps.bitmapFront = createBitmapMuscles(musclesMap.get(), <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bitmaps; } @<span class="hljs-function"><span class="hljs-function">Override </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onPostExecute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DoubleMusclesBitmaps bitmaps)</span></span></span><span class="hljs-function"> </span></span>{ super.onPostExecute(bitmaps); Uri uriBack = saveBitmap(bitmaps.bitmapBack); Uri uriFront = saveBitmap(bitmaps.bitmapFront); bitmaps.bitmapBack.recycle(); bitmaps.bitmapFront.recycle(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (listener != null) listener.onUpdate(uriFront, uriBack); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DoubleMusclesBitmaps</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Bitmap bitmapFront; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Bitmap bitmapBack; }</code> </pre> <br><p>  Die Hilfsklasse DoubleMusclesBitmaps wird nur ben√∂tigt, um zwei Bitmap-Variablen zur√ºckzugeben: Vorderansicht und R√ºckansicht.  Mit Blick auf die Zukunft wird die Java-Klasse DoubleMusclesBitmaps in Kotlin durch Pair &lt;Bitmap, Bitmap&gt; ersetzt. </p><br><h3 id="risovanie">  Zeichnen </h3><br><p>  Farben color.xml in Wertressourcen. </p><br><pre> <code class="css hljs">&lt;?<span class="hljs-selector-tag"><span class="hljs-selector-tag">xml</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">version</span></span>="1<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span>" <span class="hljs-selector-tag"><span class="hljs-selector-tag">encoding</span></span>="<span class="hljs-selector-tag"><span class="hljs-selector-tag">utf-8</span></span>"?&gt; &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">resources</span></span>&gt; &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">name</span></span>="<span class="hljs-selector-tag"><span class="hljs-selector-tag">muscles_color0</span></span>"&gt;<span class="hljs-selector-id"><span class="hljs-selector-id">#BBBBBB</span></span>&lt;/<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span>&gt; &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">name</span></span>="<span class="hljs-selector-tag"><span class="hljs-selector-tag">muscles_color1</span></span>"&gt;<span class="hljs-selector-id"><span class="hljs-selector-id">#ffb5cf</span></span>&lt;/<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span>&gt; &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">name</span></span>="<span class="hljs-selector-tag"><span class="hljs-selector-tag">muscles_color2</span></span>"&gt;<span class="hljs-selector-id"><span class="hljs-selector-id">#fda9c6</span></span>&lt;/<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span>&gt; &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">name</span></span>="<span class="hljs-selector-tag"><span class="hljs-selector-tag">muscles_color3</span></span>"&gt;<span class="hljs-selector-id"><span class="hljs-selector-id">#fa9cbe</span></span>&lt;/<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span>&gt; &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">name</span></span>="<span class="hljs-selector-tag"><span class="hljs-selector-tag">muscles_color4</span></span>"&gt;<span class="hljs-selector-id"><span class="hljs-selector-id">#f890b5</span></span>&lt;/<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span>&gt; &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">name</span></span>="<span class="hljs-selector-tag"><span class="hljs-selector-tag">muscles_color5</span></span>"&gt;<span class="hljs-selector-id"><span class="hljs-selector-id">#f583ac</span></span>&lt;/<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span>&gt; &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">name</span></span>="<span class="hljs-selector-tag"><span class="hljs-selector-tag">muscles_color6</span></span>"&gt;<span class="hljs-selector-id"><span class="hljs-selector-id">#f377a4</span></span>&lt;/<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span>&gt; &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">name</span></span>="<span class="hljs-selector-tag"><span class="hljs-selector-tag">muscles_color7</span></span>"&gt;<span class="hljs-selector-id"><span class="hljs-selector-id">#f06a9b</span></span>&lt;/<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span>&gt; &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">name</span></span>="<span class="hljs-selector-tag"><span class="hljs-selector-tag">muscles_color8</span></span>"&gt;<span class="hljs-selector-id"><span class="hljs-selector-id">#ee5e92</span></span>&lt;/<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span>&gt; &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">name</span></span>="<span class="hljs-selector-tag"><span class="hljs-selector-tag">muscles_color9</span></span>"&gt;<span class="hljs-selector-id"><span class="hljs-selector-id">#eb518a</span></span>&lt;/<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span>&gt; &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">name</span></span>="<span class="hljs-selector-tag"><span class="hljs-selector-tag">muscles_color10</span></span>"&gt;<span class="hljs-selector-id"><span class="hljs-selector-id">#e94581</span></span>&lt;/<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span>&gt; &lt;/<span class="hljs-selector-tag"><span class="hljs-selector-tag">resources</span></span>&gt;</code> </pre> <br><p>  Erstellen Sie eine Ansicht </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Bitmap </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createBitmapMuscles</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(HashMap&lt;String, Float&gt; musclesMap, Boolean isFront)</span></span></span><span class="hljs-function"> </span></span>{ Bitmap musclesBitmap = Bitmap.createBitmap(<span class="hljs-number"><span class="hljs-number">1500</span></span>, <span class="hljs-number"><span class="hljs-number">1500</span></span>, Bitmap.Config.ARGB_8888); Canvas resultCanvas = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Canvas(musclesBitmap); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (HashMap.Entry entry : musclesMap.entrySet()) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> color = Math.round((<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>) entry.getValue()); <span class="hljs-comment"><span class="hljs-comment">//         color = context.getResources().getColor(context.getResources() .getIdentifier("muscles_color" + color, "color", context.getPackageName())); drawMuscleElement(resultCanvas, entry.getKey(), color); } return musclesBitmap; }</span></span></code> </pre> <br><p>  Einzelne Muskelauflage </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">drawMuscleElement</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Canvas resultCanvas, String drawableName, @ColorInt </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> color)</span></span></span><span class="hljs-function"> </span></span>{ PorterDuff.Mode mode = PorterDuff.Mode.SRC_IN; Paint paint = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Paint(Paint.ANTI_ALIAS_FLAG); Bitmap bitmapDst = BitmapFactory.decodeResource(context.getResources(), context.getResources().getIdentifier(drawableName, <span class="hljs-string"><span class="hljs-string">"drawable"</span></span>, context.getPackageName())); bitmapDst = Bitmap.createScaledBitmap(bitmapDst, <span class="hljs-number"><span class="hljs-number">1500</span></span>, <span class="hljs-number"><span class="hljs-number">1500</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); paint.setColorFilter(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PorterDuffColorFilter(color, mode)); resultCanvas.drawBitmap(bitmapDst, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, paint); bitmapDst.recycle();<span class="hljs-comment"><span class="hljs-comment">//  }</span></span></code> </pre> <br><p>  Wir beginnen mit der Erzeugung von 3 Bildpaaren. </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> BitmapMusclesTask taskLast; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> BitmapMusclesTask taskWeek; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> BitmapMusclesTask taskMonth; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startImageGenerating</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ taskLast = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BitmapMusclesTask(mapLast); taskLast.execute(); taskWeek = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BitmapMusclesTask(mapWeek); taskWeek.execute(); taskMonth = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BitmapMusclesTask(mapMonth); taskMonth.execute(); }</code> </pre> <br><p>  Wir starten startImageGenerating (): </p><br><pre> <code class="plaintext hljs">&gt; start 1549350950177 &gt; finish 1549350959490 diff=9313 ms</code> </pre> <br><p>  Es ist zu beachten, dass das Lesen von Ressourcen viel Zeit in Anspruch nimmt.  F√ºr jedes Bildpaar werden 29 PNG-Dateien aus Ressourcen dekodiert.  In meinem Fall verbringt die Funktion BitmapFactory.decodeResource () von den Gesamtkosten f√ºr die Erstellung von Bildern ~ 75% der Zeit: ~ 6960 ms. </p><br><p>  Nachteile: </p><br><ol><li>  Ich bekomme von Zeit zu Zeit eine OutOfMemoryException. </li><li>  Die Verarbeitung dauert mehr als 9 Sekunden und befindet sich auf dem Emulator (!). Im "durchschnittlichen" Telefon (alte Mine) wurden 20 Sekunden erreicht. </li><li>  AsyncTask mit allen resultierenden [Speicher-] Lecks. </li></ol><br><p>  Vorteile: <br>  Mit Wahrscheinlichkeit (1-OutOfMemoryException) werden Bilder gezeichnet. </p><br><h3 id="asynctask-v-intentservice">  AsyncTask in IntentService </h3><br><p>  Um AsyncTask zu verlassen, wurde beschlossen, zu IntentServie zu wechseln, in dem die Aufgabe zum Erstellen von Bildern ausgef√ºhrt wurde.  Nach Abschluss des Dienstes erhalten wir, wenn BroadcastReceiver ausgef√ºhrt wird, den Uri aller sechs generierten Bilder. Andernfalls wurden die Bilder einfach gespeichert, sodass der Benutzer beim n√§chsten √ñffnen der Anwendung nicht auf den Erstellungsprozess warten muss.  Zur gleichen Zeit √§nderte sich die Betriebszeit nicht, aber mit einem Minus - Speicherlecks herausgefunden, gab es zwei weitere Minuspunkte. </p><br><p>  Es ist nat√ºrlich unm√∂glich, Benutzer dazu zu zwingen, die Erstellung von Bildern f√ºr einen solchen Zeitraum zu erwarten.  Muss optimiert werden. </p><br><p>  M√∂glichkeiten zur Optimierung skizzieren: </p><br><ol><li>  Bildverarbeitung. </li><li>  LruCache hinzuf√ºgen. </li></ol><br><h3 id="obrabotka-izobrazheniy">  Bildverarbeitung </h3><br><p>  Alle Quell-PNG-Ressourcen sind 1500 x 1500 Pixel gro√ü.  Reduzieren Sie sie auf 1080x1080. <br>  Wie Sie auf dem zweiten Foto sehen k√∂nnen, sind alle Quellcodes quadratisch, die Muskeln sind vorhanden und die wirklich n√ºtzlichen Pixel nehmen einen kleinen Bereich ein.  Die Tatsache, dass alle Muskelgruppen bereits vorhanden sind, ist f√ºr den Programmierer praktisch, f√ºr die Leistung jedoch nicht rational.  Wir beschneiden (schneiden) den √úberschuss in allen Quellcodes und zeichnen die Position (x, y) jeder Muskelgruppe auf, um sie anschlie√üend an der richtigen Stelle anzuwenden. </p><br><p>  Beim ersten Ansatz wurden alle 29 Bilder von Muskelgruppen neu gestrichen und auf die Basis gelegt.  Die Basis umfasste nur den Kopf, die H√§nde und Teile der Beine.  Wir √§ndern die Basis: Jetzt umfasst sie neben Kopf, Armen und Beinen alle anderen Muskelgruppen.  Wir malen alles in grau color_muscle0.  Dies erm√∂glicht es, die nicht beteiligten Muskelgruppen nicht neu zu streichen und nicht aufzuerlegen. </p><br><p>  Jetzt sehen alle Quellen so aus: </p><br><p><img src="https://habrastorage.org/webt/ya/zy/c3/yazyc3i8kbg590hw4qquapexzic.jpeg" alt="Bild"></p><br><h3 id="lrucache">  Lrucache </h3><br><p>  Nach der zus√§tzlichen Verarbeitung der Originalbilder nahmen einige etwas Speicherplatz in Anspruch, was zu dem Gedanken f√ºhrte, LruCache wiederzuverwenden (nicht nach jeder √úberlagerung mit der .recycle () -Methode freizugeben).  Wir erstellen eine Klasse zum Speichern von Quellbildern, die gleichzeitig die Funktion des Lesens aus Ressourcen √ºbernimmt: </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">class </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LruCacheBitmap</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(val context: Context)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> val lruCache: LruCache&lt;String, Bitmap&gt; init { val maxMemory = (Runtime.getRuntime().maxMemory() / <span class="hljs-number"><span class="hljs-number">1024</span></span>).toInt() val cacheSize = maxMemory / <span class="hljs-number"><span class="hljs-number">4</span></span> lruCache = object : LruCache&lt;String, Bitmap&gt;(cacheSize) { override fun sizeOf(key: String, bitmap: Bitmap): Int { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bitmap.byteCount } } } fun getBitmap(drawableName: String): Bitmap? { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lruCache.get(drawableName) != null) lruCache.get(drawableName) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> decodeMuscleFile(drawableName) } fun clearAll() { lruCache.evictAll() } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> fun decodeMuscleFile(drawableName: String): Bitmap? { val bitmap = BitmapFactory.decodeResource(context.resources, context.resources.getIdentifier(drawableName, <span class="hljs-string"><span class="hljs-string">"drawable"</span></span>, context.packageName)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bitmap != null) { lruCache.put(drawableName, bitmap) } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bitmap } }</code> </pre> <br><p>  Bilder werden vorbereitet, die Ressourcendecodierung wird optimiert. <br>  Wir werden den reibungslosen √úbergang von Java zu Kotlin nicht diskutieren, aber es ist passiert. </p><br><h2 id="korutiny">  Coroutinen </h2><br><p>  Der Code, der IntentService verwendet, funktioniert, aber die Lesbarkeit des Codes mit R√ºckrufen kann nicht als angenehm bezeichnet werden. </p><br><p>  F√ºgen Sie den Wunsch hinzu, Kotlins Coroutinen in Arbeit zu betrachten.  Wir f√ºgen das Verst√§ndnis hinzu, dass es nach ein paar Monaten angenehmer sein wird, Ihren synchronen Code zu lesen, als nach dem Ort zu suchen, an dem die Uri-Dateien der generierten Bilder zur√ºckgegeben werden k√∂nnen. </p><br><p>  Die Beschleunigung der Bildverarbeitung veranlasste die Idee, die Funktion an mehreren neuen Stellen in der Anwendung zu verwenden, insbesondere bei der Beschreibung von √úbungen, und zwar nicht nur nach dem Training. </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> val errorHandler = CoroutineExceptionHandler { _, e -&gt; e.printStackTrace()} <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> val job = SupervisorJob() <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> val scope = CoroutineScope(Dispatchers.Main + job + errorHandler) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> var uries: HashMap&lt;String, Uri?&gt; = HashMap() fun startImageGenerating() = scope.launch { ... val imgMuscle = ImgMuscle() uries = withContext(Dispatchers.IO) { imgMuscle.createMuscleImages() } ... }</code> </pre><br><p>  Das Standardpaket aus errorHandler, Job und Scope ist Scout Coroutine mit einem Fehlerhandler, wenn Coroutine kaputt geht. </p><br><p>  uries - HashMap, die 6 Bilder f√ºr die sp√§tere Ausgabe an die Benutzeroberfl√§che in sich speichert: <br>  uries ["last_back"] = Uri? <br>  uries ["last_front"] = Uri? <br>  uries ["week_back"] = Uri? <br>  uries ["week_front"] = Uri? <br>  uries ["month_back"] = Uri? <br>  uries ["month_front"] = Uri? </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ImgMuscle</span></span></span><span class="hljs-class"> {</span></span> val lruBitmap: <span class="hljs-function"><span class="hljs-function">LruCacheBitmap suspend fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createMuscleImages</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">: HashMap&lt;String, Uri?&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> suspendCoroutine { continuation -&gt; val resultUries = HashMap&lt;String, Uri?&gt;() ... <span class="hljs-comment"><span class="hljs-comment">//    continuation.resume(resultUries) } } }</span></span></code> </pre><br><p>  Wir messen die Bearbeitungszeit. </p><br><pre> <code class="plaintext hljs">&gt;start 1549400719844 &gt;finish 1549400720440 diff=596 ms</code> </pre> <br><h4 id="s-9313-ms-obrabotka-umenshilas-do-596-ms">  Ab 9313 ms verringerte sich die Verarbeitung auf 596 ms. </h4><br><p>  Wenn Sie Ideen f√ºr zus√§tzliche Optimierungen haben, k√∂nnen Sie diese gerne kommentieren. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de439596/">https://habr.com/ru/post/de439596/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de439586/index.html">SPBm-Protokoll als Grundlage des Extreme Automated Campus</a></li>
<li><a href="../de439588/index.html">ESET hat neue Versionen des DanaBot-Trojaners entdeckt</a></li>
<li><a href="../de439590/index.html">Quals: Saudi und Oman National Cyber ‚Äã‚ÄãSecurity CTF 2019. WriteUp</a></li>
<li><a href="../de439592/index.html">Automatisierung ethischer Aktivit√§ten</a></li>
<li><a href="../de439594/index.html">Fr√ºhlingsanmerkungen: AOP Magic</a></li>
<li><a href="../de439598/index.html">Microsoft sprach √ºber die Kosten f√ºr kostenpflichtigen Support f√ºr Windows 7</a></li>
<li><a href="../de439600/index.html">Finnland fasst vorl√§ufige Versuchsergebnisse mit garantiertem Grundeinkommen zusammen</a></li>
<li><a href="../de439602/index.html">Ethik im digitalen Raum - die Grundregeln der internationalen digitalen Beziehungen</a></li>
<li><a href="../de439604/index.html">Wie ist der Barcode angeordnet?</a></li>
<li><a href="../de439606/index.html">Pilotproduktion von Elektronik zum Mindestpreis</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>