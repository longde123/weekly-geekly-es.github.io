<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§ë üì™ üöñ Utilisation de Consul pour faire √©voluer les services avec √©tat ü§∂üèª üë§ ‚ùì</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Le 22 septembre, nous avons organis√© notre premier mitap non standard pour les d√©veloppeurs de syst√®mes tr√®s charg√©s. C'√©tait tr√®s cool, beaucoup de r...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Utilisation de Consul pour faire √©voluer les services avec √©tat</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pixonic/blog/424777/">  <i>Le 22 septembre, nous avons organis√© notre premier <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">mitap non standard</a> pour les d√©veloppeurs de syst√®mes tr√®s charg√©s.</i>  <i>C'√©tait tr√®s cool, beaucoup de retours positifs sur les rapports et a donc d√©cid√© non seulement de les t√©l√©charger, mais aussi de les d√©crypter pour Habr.</i>  <i>Aujourd'hui, nous publions un discours d'Ivan Bubnov, DevOps de BIT.GAMES.</i>  <i>Il a parl√© de la mise en ≈ìuvre du service de d√©couverte Consul dans un projet √† forte charge d√©j√† en cours pour la possibilit√© de mise √† l'√©chelle rapide et de basculement de services avec √©tat.</i>  <i>Et aussi sur l'organisation d'un espace de noms flexible pour les applications backend et les pi√®ges.</i>  <i>Maintenant un mot √† Ivan.</i> <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/X4VYCrOCD3A" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  J'administre l'infrastructure de production du studio BIT.GAMES et raconte l'histoire de l'introduction du consul de Hashicorp dans notre projet "Guild of Heroes" - RPG fantastique avec pvp asynchrone pour appareils mobiles.  Disponible sur Google Play, App Store, Samsung, Amazon.  DAU environ 100 000, en ligne de 10 √† 13 mille.  Nous cr√©ons le jeu dans Unity, nous √©crivons donc le client en C # et utilisons notre propre langage de script BHL pour la logique du jeu.  Nous √©crivons la partie serveur dans Golang (qui y est pass√©e de PHP).  Vient ensuite l'architecture sch√©matique de notre projet. <br><a name="habracut"></a><br><img src="https://habrastorage.org/webt/dd/-v/gu/dd-vgufl1o4g4sjqu8luww4f56k.png"><br>  <i>En fait, il y a beaucoup plus de services, il n'y a que les bases de la logique du jeu.</i> <br><br>  Alors ce que nous avons.  Parmi les services apatrides, ce sont: <br><br><ul><li>  nginx, que nous utilisons comme Frontend et Load Balancers et distribuons les clients √† nos backends par coefficients de pond√©ration; </li><li>  gamed - backends, applications compil√©es de Go.  C'est l'axe central de notre architecture, ils effectuent la part du lion du travail et communiquent avec tous les autres services backend. </li></ul><br>  Parmi les services Stateful, les principaux que nous avons sont: <br><br><ul><li>  Redis, que nous utilisons pour mettre en cache les informations chaudes (nous l'utilisons √©galement pour organiser le chat en jeu et stocker les notifications pour nos joueurs); </li><li>  Percona Server for Mysql est un r√©f√©rentiel d'informations persistantes (probablement le plus grand et le plus lent de toute architecture).  Nous utilisons le fork de MySQL et nous en parlerons plus en d√©tail aujourd'hui. </li></ul><br>  Au cours du processus de conception, nous (comme tout le monde) esp√©rions que le projet serait couronn√© de succ√®s et pr√©voyions un m√©canisme de partage.  Il se compose de deux entit√©s de base de donn√©es MAINDB et des fragments eux-m√™mes. <br><br><img src="https://habrastorage.org/webt/y2/sj/h-/y2sjh-qfoxlosksflpkvxuq3cxk.png"><br><br>  MAINDB est une sorte de table des mati√®res - il stocke des informations sur quelles donn√©es de tesson particuli√®res sur la progression du joueur sont stock√©es.  Ainsi, la cha√Æne compl√®te de r√©cup√©ration d'informations ressemble √† ceci: le client acc√®de au frontend, qui √† son tour le redistribue en poids √† l'un des backends, le backend va √† MAINDB, localise le fragment du lecteur, puis s√©lectionne les donn√©es directement √† partir du fragment lui-m√™me. <br><br>  Mais quand nous avons con√ßu, nous n'√©tions pas un gros projet, nous avons donc d√©cid√© de faire des tessons des tessons uniquement nominalement.  Ils √©taient tous situ√©s sur le m√™me serveur physique et tr√®s probablement sur un partitionnement de base de donn√©es au sein du m√™me serveur. <br><br>  Pour la sauvegarde, nous avons utilis√© la r√©plication ma√Ætre-esclave classique.  Ce n'√©tait pas une tr√®s bonne solution (je dirai pourquoi un peu plus tard), mais le principal inconv√©nient de cette architecture √©tait que tous nos backends connaissaient les autres services backend exclusivement par des adresses IP.  Et en cas d'un autre accident ridicule dans le centre de donn√©es du type " <i>d√©sol√©, notre ing√©nieur a touch√© le c√¢ble sur votre serveur pendant qu'il en r√©parait un autre et nous avons mis tr√®s longtemps √† comprendre pourquoi votre serveur ne nous contactait pas</i> ", des mouvements consid√©rables √©taient n√©cessaires de notre part.  Tout d'abord, il s'agit de la reconstruction et de la pr√©-installation de backends √† partir du serveur de sauvegarde IP pour l'emplacement de celui qui a √©chou√©.  Deuxi√®mement, apr√®s l'incident, il est n√©cessaire de restaurer notre ma√Ætre √† partir de la sauvegarde de la r√©serve, car il √©tait dans un √©tat incoh√©rent et de le mettre dans un √©tat coordonn√© en utilisant la m√™me r√©plication.  Ensuite, nous avons √† nouveau remont√© les backends et recharg√©.  Tout cela, bien s√ªr, a provoqu√© des temps d'arr√™t. <br><br>  Il y a eu un moment o√π notre directeur technique (dont je le remercie beaucoup) a dit: "Les gars, arr√™tez de souffrir, nous devons changer quelque chose, cherchons des solutions."  Tout d'abord, nous voulions parvenir √† un processus simple, compr√©hensible et surtout - facilement g√©r√© de mise √† l'√©chelle et de migration d'un endroit √† l'autre de nos bases de donn√©es si n√©cessaire.  De plus, nous voulions atteindre une haute disponibilit√© en automatisant les basculements. <br><br><img src="https://habrastorage.org/webt/lb/96/ys/lb96yszgjsbjtriury8zxqr0loa.png"><br><br>  L'axe central de notre recherche est devenu Consul de Hashicorp.  Premi√®rement, nous avons √©t√© inform√©s, et deuxi√®mement, nous avons √©t√© tr√®s attir√©s par sa simplicit√©, sa convivialit√© et son excellente pile technologique dans une seule bo√Æte: service de d√©couverte avec contr√¥le de sant√©, stockage de valeur-cl√© et la chose la plus importante que nous voulions utiliser √©tait DNS qui nous r√©sout les adresses du domaine service.consul. <br><br>  Consul fournit √©galement d'excellentes interfaces utilisateur Web et API REST pour g√©rer tout cela. <br><br>  Quant √† la haute disponibilit√©, nous avons choisi deux utilitaires pour le basculement automatique: <br><br><ul><li>  MHA pour MySQL </li><li>  Redis-sentinel </li></ul><br><img src="https://habrastorage.org/webt/bc/e5/dg/bce5dg_dxoi0irv9gic5e4d1jki.png"><br><br>  Dans le cas de MHA pour MySQL, nous avons vers√© des agents dans des n≈ìuds avec des bases de donn√©es et ceux-ci ont surveill√© leur √©tat.  Il y a eu un certain d√©lai avec l'√©chec du ma√Ætre, apr√®s quoi un esclave d'arr√™t a √©t√© cr√©√© pour maintenir la coh√©rence et notre ma√Ætre de sauvegarde du ma√Ætre apparu dans un √©tat incoh√©rent n'a pas r√©cup√©r√© les donn√©es.  Et nous avons ajout√© un hook Web √† ces agents, qui y ont enregistr√© la nouvelle IP du ma√Ætre de sauvegarde dans Consul lui-m√™me, apr√®s quoi il est entr√© dans la d√©livrance du DNS. <br><br>  Avec Redis-sentinel, tout est encore plus simple.  Puisqu'il r√©alise lui-m√™me la part du lion du travail, il ne nous restait plus qu'√† prendre en compte dans le bilan de sant√© que Redis-sentinel devait se d√©rouler exclusivement sur le n≈ìud ma√Ætre. <br><br>  Au d√©but, tout fonctionnait parfaitement, comme une horloge.  Nous n'avons eu aucun probl√®me au banc d'essai.  Mais cela valait la peine de p√©n√©trer dans l'environnement naturel du transfert de donn√©es d'un centre de donn√©es charg√©, en pensant √† certains OOM-kills (c'est hors de la m√©moire, dans lequel le processus est tu√© par le noyau du syst√®me) et en restaurant le service ou des choses plus sophistiqu√©es qui affectent la disponibilit√© du service - comment avons-nous imm√©diatement obtenu un risque s√©rieux de faux positifs ou aucune r√©ponse garantie du tout (si vous essayez de tordre certains contr√¥les pour tenter d'√©chapper aux faux positifs). <br><br><img src="https://habrastorage.org/webt/a9/8t/7i/a98t7i3cvbb18duz7mkcr8f4vqg.png"><br><br>  Tout d'abord, tout d√©pend de la difficult√© √† r√©diger le bon bilan de sant√©.  Il semble que la t√¢che soit assez banale - v√©rifiez que le service fonctionne sur votre serveur et le port pingani.  Mais, comme l'a montr√© la pratique ult√©rieure, la r√©daction d'un bilan de sant√© lors de la mise en ≈ìuvre de Consul est un processus extr√™mement complexe et long.  Parce que tant de facteurs qui affectent la disponibilit√© de votre service dans le centre de donn√©es ne peuvent pas √™tre pr√©vus - ils ne sont d√©tect√©s qu'apr√®s un certain temps. <br><br>  En outre, le centre de donn√©es n'est pas une structure statique qui vous submerge et il fonctionne comme pr√©vu.  Mais nous, malheureusement (ou heureusement), ne l'avons d√©couvert que plus tard, mais pour l'instant nous √©tions inspir√©s et confiants de pouvoir tout mettre en ≈ìuvre en production. <br><br><img src="https://habrastorage.org/webt/c3/kt/uz/c3ktuzba_fzzjqodfbfsdv6sj6k.png"><br><br>  En ce qui concerne la mise √† l'√©chelle, je dirai bri√®vement: nous avons essay√© de trouver un v√©lo fini, mais ils sont tous con√ßus pour des architectures sp√©cifiques.  Et, comme dans le cas de Jetpants, nous n'avons pas pu remplir les conditions qu'il imposait √† l'architecture d'un stockage persistant des informations. <br><br>  Par cons√©quent, nous avons pens√© √† notre propre liaison de script et report√© cette question.  Nous avons d√©cid√© d'agir de mani√®re coh√©rente et de commencer par la mise en place du Consul. <br><br><img src="https://habrastorage.org/webt/99/em/bk/99embkj_f7vdi-kta4rdme6ga6k.png"><br><br>  Consul est un cluster d√©centralis√© et distribu√© qui fonctionne sur la base du protocole Gossip et de l'algorithme de consensus Raft. <br><br>  Nous avons un equorum ind√©pendant de cinq serveurs (cinq pour √©viter la situation de split-brain).  Pour chaque n≈ìud, nous renversons l'agent Consul en mode agent et renversons tous les contr√¥les de sant√© (c'est-√†-dire qu'il n'y en avait pas de tels que nous t√©l√©chargions un contr√¥le de sant√© sur un serveur sp√©cifique et d'autres sur des serveurs sp√©cifiques).  Le bilan de sant√© a √©t√© r√©dig√© de mani√®re √† ne passer que l√† o√π il y a un service. <br><br>  Nous avons √©galement utilis√© un autre utilitaire afin de ne pas avoir √† apprendre notre backend pour r√©soudre les adresses d'un domaine sp√©cifique sur un port non standard.  Nous avons utilis√© Dnsmasq - il offre la possibilit√© de r√©soudre de mani√®re totalement transparente les adresses sur les n≈ìuds de cluster dont nous avons besoin (qui, pour ainsi dire, n'existent pas, mais existent exclusivement au sein du cluster).  Nous avons pr√©par√© un script automatique pour remplir Ansible, t√©l√©charg√© le tout en production, optimis√© l'espace de noms, v√©rifi√© que tout √©tait termin√©.  Et, en croisant les doigts, nous avons recharg√© nos backends, auxquels on acc√©dait non pas par des adresses IP, mais par ces noms du domaine server.consul. <br><br>  Tout a commenc√© la premi√®re fois, notre joie n'a pas de limites.  Mais il √©tait trop t√¥t pour se r√©jouir, car en une heure, nous avons remarqu√© que sur tous les n≈ìuds o√π se trouvent nos backends, l'indicateur de charge moyenne est pass√© de 0,7 √† 1,0, ce qui est un indicateur plut√¥t gras. <br><br><img src="https://habrastorage.org/webt/em/ua/v_/emuav_oozpbvjdoa7yg1ldfeag0.png"><br><br>  Je suis mont√© sur le serveur pour voir ce qui se passait et il est devenu √©vident que le CPU mangeait Consul.  Ici, nous avons commenc√© √† comprendre, √† commencer √† chamaniser avec strace (un utilitaire pour les syst√®mes Unix qui vous permet de suivre quel syscall le processus est en cours d'ex√©cution), √† vider les statistiques Dnsmasq pour comprendre ce qui se passe sur ce n≈ìud, et il s'est av√©r√© que nous avons manqu√© un point tr√®s important.  Lors de la planification de l'int√©gration, nous avons manqu√© la mise en cache des enregistrements DNS et il s'est av√©r√© que notre backend a tir√© Dnsmasq pour chacun de ses mouvements, et que, √† son tour, s'est tourn√© vers Consul et tout cela a entra√Æn√© 940 requ√™tes DNS maladives par seconde. <br><br>  La sortie semblait √©vidente - il suffit de tordre ttl et tout ira mieux.  Mais ici, il √©tait impossible d'√™tre fanatique, car nous voulions impl√©menter cette structure afin d'obtenir un espace de noms dynamique facilement contr√¥l√© et changeant rapidement (par cons√©quent, nous ne pouvions pas d√©finir, par exemple, 20 minutes).  Nous avons tordu ttl aux valeurs optimales maximales pour nous, nous avons r√©ussi √† r√©duire le taux de requ√™te par seconde √† 540, mais cela n'a pas affect√© l'indicateur de consommation du processeur. <br><br>  Ensuite, nous avons d√©cid√© de sortir de mani√®re d√©licate, en utilisant un fichier d'h√¥tes personnalis√©. <br><br><img src="https://habrastorage.org/webt/0p/li/01/0pli01ivofxzndxm9pa9xrtvu6m.png"><br><br>  C'est bien que nous ayons tout pour cela: un excellent syst√®me de mod√®les de Consul, qui, bas√© sur l'√©tat du cluster et le script de mod√®le, g√©n√®re un fichier de toute sorte, n'importe quelle configuration est tout ce que vous voulez.  De plus, Dnsmasq poss√®de un param√®tre de configuration addn-hosts qui vous permet d'utiliser un fichier d'h√¥tes non syst√®me comme le m√™me fichier d'h√¥tes suppl√©mentaire. <br><br>  Ce que nous avons fait, encore une fois pr√©par√© le script dans Ansible, l'a t√©l√©charg√© en production et il a commenc√© √† ressembler √† ceci: <br><br><img src="https://habrastorage.org/webt/p6/qe/3i/p6qe3iaqlloehk1ld7ptisb_0dg.png"><br><br>  Il y avait un √©l√©ment suppl√©mentaire et un fichier statique sur le disque, qui est assez rapidement r√©g√©n√©r√©.  Maintenant, la cha√Æne semblait assez simple: gamed s'est tourn√© vers Dnsmasq, et cela √† son tour (au lieu de tirer sur l'agent Consula, qui demanderait aux serveurs o√π nous avions tel ou tel n≈ìud) a simplement regard√© le fichier.  Cela a r√©solu le probl√®me de consommation du processeur par Consul. <br><br>  Maintenant, tout a commenc√© √† ressembler √† ce que nous avions pr√©vu - absolument transparent pour notre production, pratiquement sans consommer de ressources. <br><br>  Nous √©tions assez tourment√©s ce jour-l√† et avec une grande appr√©hension, nous sommes rentr√©s chez nous.  Ils n'ont pas eu peur en vain, car la nuit, une alerte de la surveillance m'a r√©veill√© et m'a inform√© que nous avions une explosion d'erreurs assez importante (quoique √† court terme). <br><br><img src="https://habrastorage.org/webt/yg/yj/z_/ygyjz_upz8khxqgriqbsye0_xma.png"><br><br>  En traitant les journaux le matin, j'ai vu que toutes les erreurs √©taient du m√™me type d'h√¥te inconnu.  On ne savait pas pourquoi Dnsmasq ne pouvait pas utiliser l'un ou l'autre service √† partir d'un fichier - il semblait qu'il n'existait pas du tout.  Pour essayer de comprendre ce qui se passait, j'ai ajout√© une mesure personnalis√©e pour recr√©er le fichier - maintenant je savais exactement l'heure √† laquelle il serait r√©g√©n√©r√©.  De plus, le mod√®le Consul lui-m√™me dispose d'une excellente option de sauvegarde, c'est-√†-dire  Vous pouvez voir l'√©tat pr√©c√©dent du fichier r√©g√©n√©r√©. <br><br>  Au cours de la journ√©e, l'incident s'est r√©p√©t√© plusieurs fois et il est devenu clair qu'√† un moment donn√© (bien qu'il soit de nature sporadique et non syst√©matique), le fichier des h√¥tes sans services sp√©cifiques serait restitu√©.  Il s'est av√©r√© que dans un centre de donn√©es particulier (je ne ferai pas d'anti-publicit√©), il y a des r√©seaux plut√¥t instables - en raison des r√©seaux qui s'effondrent, nous avons cess√© de fa√ßon impr√©visible de passer des contr√¥les de sant√©, ou m√™me les n≈ìuds sont tomb√©s du cluster.  Cela ressemblait √† ceci: <br><br><img src="https://habrastorage.org/webt/3v/_q/ve/3v_qvengzywl6bqdchzxs2fshl4.png"><br><br>  Le n≈ìud est tomb√© hors du cluster, l'agent Consul en a √©t√© imm√©diatement inform√© et le mod√®le Consul a imm√©diatement r√©g√©n√©r√© le fichier hosts sans le service dont nous avions besoin.  C'√©tait g√©n√©ralement inacceptable, car le probl√®me est ridicule: si le service n'est pas disponible pendant quelques secondes, configurez des d√©lais d'attente et des retraits (ils ne se sont pas connect√©s une fois, mais la deuxi√®me fois, il s'est av√©r√©).  Mais nous avons provoqu√© une nouvelle structure chez le vendeur lorsque le service dispara√Æt tout simplement de la vue et qu'il n'y avait aucun moyen de s'y connecter. <br><br>  Nous avons commenc√© √† penser √† quoi faire et √† tordre le param√®tre de d√©lai d'expiration dans Consul, apr√®s quoi il est identifi√© apr√®s combien le n≈ìud tombe.  Nous avons r√©ussi √† r√©soudre ce probl√®me avec un indicateur assez petit, les n≈ìuds ont cess√© de tomber, mais cela n'a pas aid√© avec le contr√¥le de sant√©. <br><br>  Nous avons commenc√© √† penser √† choisir diff√©rents param√®tres pour le bilan de sant√©, essayant de comprendre en quelque sorte quand et comment cela se produit.  Mais √©tant donn√© que tout s'est produit de fa√ßon sporadique et impr√©visible, nous n'avons pas pu le faire. <br><br>  Ensuite, nous sommes all√©s au mod√®le Consul et avons d√©cid√© de lui donner un d√©lai d'attente, apr√®s quoi il r√©agit √† un changement d'√©tat du cluster.  Encore une fois, il √©tait impossible d'√™tre fanatique, car nous pouvions arriver √† une situation o√π le r√©sultat ne serait pas meilleur que le DNS classique, lorsque nous visions un tout autre. <br><br>  Et une fois de plus, notre directeur technique est venu √† la rescousse et a d√©clar√©: ¬´Les gars, essayons de renoncer √† toute cette interactivit√©, nous sommes tous en production et il n'y a pas de temps pour la recherche, nous devons r√©soudre ce probl√®me.  Profitons de choses simples et compr√©hensibles. ¬ª  Nous sommes donc arriv√©s √† l'id√©e d'utiliser le stockage de valeurs-cl√©s comme source pour g√©n√©rer un fichier d'h√¥tes. <br><br><img src="https://habrastorage.org/webt/ar/qm/kx/arqmkxvbfzahdo6qrlom1htydq4.png"><br><br>  √Ä quoi cela ressemble: nous refusons tous les contr√¥les de sant√© dynamiques, r√©√©crivons notre mod√®le-script afin qu'il g√©n√®re un fichier bas√© sur les donn√©es enregistr√©es dans le stockage de valeurs-cl√©s.  Dans le stockage de valeur-cl√©, nous d√©crivons l'ensemble de notre infrastructure sous la forme du nom de cl√© (c'est le nom du service dont nous avons besoin) et de la valeur de cl√© (c'est le nom du n≈ìud dans le cluster).  C'est-√†-dire  si le n≈ìud est pr√©sent dans le cluster, alors nous obtenons tr√®s facilement son adresse IP et l'√©crivons dans le fichier hosts. <br><br>  Nous avons tout test√©, rempli en production et c'est devenu une solution miracle dans une situation sp√©cifique.  Encore une fois, nous avons √©t√© assez tourment√©s pendant toute la journ√©e, nous sommes rentr√©s chez nous, mais nous sommes revenus d√©j√† repos√©s, enthousiastes, car ces probl√®mes ne se reproduisaient plus et n'ont pas √©t√© r√©p√©t√©s dans la soumission depuis un an.  D'o√π je conclus personnellement que c'√©tait la bonne d√©cision (sp√©cialement pour nous). <br><br>  Alors.  Nous avons finalement obtenu ce que nous voulions et organis√© un espace de noms dynamique pour nos backends.  De plus, nous sommes all√©s vers une haute disponibilit√©. <br><br><img src="https://habrastorage.org/webt/m9/k0/nu/m9k0nueo_w_79ywwhcco0tgnq5u.png"><br><br>  Mais le fait est que nous avons assez peur de l'int√©gration de Consul et en raison des probl√®mes que nous avons rencontr√©s, nous avons pens√© et d√©cid√© que l'impl√©mentation du basculement automatique n'√©tait pas une bonne solution, car l√† encore nous risquons de faux positifs ou √©checs.  Ce processus est opaque et incontr√¥lable. <br><br>  Par cons√©quent, nous avons suivi une voie plus simple (ou complexe): nous avons d√©cid√© de laisser le basculement √† la conscience de l'administrateur de service, mais nous lui avons donn√© un autre outil suppl√©mentaire.  Nous avons remplac√© la r√©plication ma√Ætre esclave par la r√©plication ma√Ætre ma√Ætre en mode lecture seule.  Cela supprime une √©norme quantit√© de maux de t√™te dans le processus de failover'ov - lorsque vous obtenez un assistant, tout ce que vous devez faire est de modifier la valeur dans le stockage k / v √† l'aide de l'interface utilisateur Web ou de la commande dans l'API et avant de supprimer le mode lecture seule ma√Ætre de sauvegarde. <br><br>  Une fois l'incident termin√©, le ma√Ætre contacte et revient automatiquement √† un √©tat coordonn√© sans aucune action inutile.  Nous nous sommes arr√™t√©s √† cette option et nous l'utilisons comme auparavant - pour nous, c'est aussi pratique que possible, et surtout aussi simple, clair et contr√¥l√© que possible. <br><br><img src="https://habrastorage.org/webt/mr/fn/tc/mrfntctgtpanvrkqhlqmbm9liue.png"><br>  <i>Interface Web du Consul</i> <br><br>  √Ä droite se trouve le stockage k / v et nos services sont visibles, que nous utilisons dans le jeu;  valeur est le nom du n≈ìud. <br><br>  Quant √† la mise √† l'√©chelle, nous avons commenc√© √† l'impl√©menter lorsque les fragments √©taient d√©j√† encombr√©s sur un serveur, les bases ont augment√©, sont devenues lentes, le nombre de joueurs a augment√©, nous avons √©chang√© et nous avons eu la t√¢che de distribuer tous les fragments √† nos diff√©rents serveurs distincts. <br><br><img src="https://habrastorage.org/webt/0b/yc/zg/0byczgl-2ugpi8z_dgwzytcmrw4.png"><br><br>  √Ä quoi cela ressemblait: en utilisant l'utilitaire XtraBackup, nous avons restaur√© notre sauvegarde sur une nouvelle paire de serveurs, apr√®s quoi le nouveau ma√Ætre a √©t√© suspendu avec un esclave sur l'ancien.  Il est venu √† un √©tat coh√©rent, nous avons chang√© la valeur de cl√© dans k / v-storage du nom du n≈ìud de l'ancien ma√Ætre au nom du n≈ìud du nouveau ma√Ætre.  Ensuite (lorsque nous avons cru que tout s'√©tait bien pass√© et que tous jouaient avec leurs s√©lections, mises √† jour, insertions, ils √©taient all√©s au nouveau ma√Ætre), nous n'avions qu'√† tuer la r√©plication et cr√©er la base de donn√©es tr√®s recherch√©e en production, comme nous aimons tous le faire avec des bases de donn√©es inutiles. <br><br><img src="https://habrastorage.org/webt/1x/6k/pw/1x6kpwybgw6-wsgscd6r1kylk-u.png"><br><br>  Nous avons donc fait √©clater les √©clats.  L'ensemble du processus de d√©placement a pris de 40 minutes √† une heure et n'a caus√© aucun temps d'arr√™t √† personne, il √©tait compl√®tement transparent pour nos backends et en lui-m√™me √©tait compl√®tement transparent pour les joueurs (sauf que d√®s qu'ils se d√©pla√ßaient, il devenait plus facile et plus agr√©able pour eux de jouer). <br><br><img src="https://habrastorage.org/webt/gm/du/bj/gmdubjovhtlet9n2-bljkeqz7oq.png"><br><br>  En ce qui concerne les processus de basculement, le temps de commutation est ici de 20 √† 40 secondes, plus le temps de r√©action de l'administrateur syst√®me en service.  Voil√† √† quoi tout cela ressemble avec nous maintenant. <br><br>  Ce que je voudrais dire en conclusion - malheureusement, nos espoirs d'une automatisation absolue et compl√®te se sont effondr√©s dans la dure r√©alit√© du support de transmission de donn√©es dans un centre de donn√©es charg√© et des facteurs al√©atoires que nous ne pouvions pas pr√©voir. <br><br>  Deuxi√®mement, il nous a une fois de plus appris qu'une m√©sange simple et √©prouv√©e entre les mains de votre administrateur syst√®me est meilleure qu'une grue √† r√©action automatique √† √©chelle r√©duite quelque part au-del√† des nuages, que vous ne comprenez m√™me pas si elle se d√©sagr√®ge, ou vraiment commenc√© √† √©voluer. <br><br>  L'introduction de toute infrastructure, l'automatisation de votre production ne devraient pas causer de maux de t√™te inutiles au personnel qui la dessert;  cela ne devrait pas augmenter de mani√®re significative le co√ªt de la maintenance de la production de l'infrastructure - la solution doit √™tre simple, claire, transparente pour vos clients, pratique et contr√¥l√©e. <br><br><h3>  Questions du public </h3><br>  <b>Comment √©crivez-vous k / v avec des serveurs - un script ou le corrigez-vous simplement?</b> <br><br> K/v-     Consul-   -  ,     http- RESTful API  Web UI. <br><br>     ,   -             ,     ,   . <br><br> <b>       ,     Redis?</b> <br><br>        ,    - . <br><br> -,          backend. -,      backend',       ‚Äî    .  C'est-√†-dire       ,     MAINDB        ,   .        .                  -  ,       . <br><br>      - ,       inmemory key-value    -. <br><br> <b>   ?</b> <br><br>    MySQL ‚Äî Percona server. <br><br> <b>            ?      Maria,     MHA for MySQL,    Galera.</b> <br><br>      Galera.    -   ¬´ ¬ª       Galera       ,     .       ,       . <br><br>    ,     ‚Äî         ,         ,     -  ,    ,         ,   . <br><br><h3>    Pixonic DevGAMM Talks </h3><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">CICD:        </a> ( ,   Pixonic); </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">     -  Quake Champions</a> ( , backend- Saber Interactive); </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> -  - Tacticool</a> ( , Lead Software Engineer  PanzerDog); </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> ECS, C# Job System  SRP    </a> ( , Field Engineer  Unity); </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> KISS  </a> ( , Lead Game Programmer  1C Game Studios); </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">      </a> ( , Deputy Technical Officer  Pixonic). </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Cucumber  :  BDD-    </a> ( , Technical Product Manager  ALICE Platform). </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr424777/">https://habr.com/ru/post/fr424777/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr424763/index.html">Un √©diteur de texte n'est pas votre plus haute math√©matique, vous devez penser ici</a></li>
<li><a href="../fr424765/index.html">Gestion des √©tats dans les applications Flutter</a></li>
<li><a href="../fr424767/index.html">Nous faisons un g√¢teau de Habr. Encore une fois</a></li>
<li><a href="../fr424771/index.html">Exp√©rience personnelle: d'une id√©e et d'une feuille blanche √† une version provisoire d'un site</a></li>
<li><a href="../fr424773/index.html">Biopharma et mod√©lisation num√©rique: exp√©rience et pratique d'Amgen</a></li>
<li><a href="../fr424779/index.html">SPA multi-page en Python</a></li>
<li><a href="../fr424781/index.html">Enseignement et test de r√©seaux de neurones sur PyTorch avec Ignite</a></li>
<li><a href="../fr424787/index.html">Entretien avec Aaron Patterson, pr√©sident de la conf√©rence RubyRussia 2018</a></li>
<li><a href="../fr424789/index.html">Comment d√©ployer une application Ruby on Rails avec HAProxy Ingress, unicorn / puma et des sockets Web</a></li>
<li><a href="../fr424791/index.html">Extension des capacit√©s r√©seau d'un relais programmable √† l'aide du WI-FI</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>