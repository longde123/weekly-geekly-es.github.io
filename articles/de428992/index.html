<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>😏 🙇🏻 👩‍🌾 Selektiver Bypass von Sperren auf Routern mit Padavan- und Keenetic OS-Firmware 🌜 👩🏿‍🤝‍👨🏻 👨🏽‍⚕️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Es wurde eine Vielzahl von Anweisungen mit verschiedenen Optionen zur Umgehung des Blockierens von Internetressourcen veröffentlicht. Das Thema verlie...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Selektiver Bypass von Sperren auf Routern mit Padavan- und Keenetic OS-Firmware</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/428992/">  Es wurde eine Vielzahl von Anweisungen mit verschiedenen Optionen zur Umgehung des Blockierens von Internetressourcen veröffentlicht.  Das Thema verliert aber nicht an Relevanz.  Noch häufiger werden auf gesetzlicher Ebene Initiativen angehört, um Artikel über Methoden zur Umgehung von Sperren zu blockieren.  Und es gab Gerüchte, dass Roskomnadzor eine weitere Packung Steuergeld für „bessere“ Schlösser erhalten wird.  Erfahrene Benutzer werden aus dem Artikel nichts Neues oder Nützliches lernen.  Andere erhalten jedoch eine vorgefertigte Schritt-für-Schritt-Anleitung für die einfache und effektive selektive Umgehung von Sperren auf gängigen Routern mit Padavan- und Keenetic-Firmware. <br><br><img src="https://habrastorage.org/webt/is/kb/td/iskbtdxuaisqiyg3r4tsrjhj6aw.jpeg"><br><a name="habracut"></a><br><h1>  Inhalt </h1><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Einführung</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Wie schaffen Sie es, Sperren nach der Konfiguration zu umgehen?</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Arbeitsprinzip</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Padavan Router konfigurieren</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Konfigurieren eines Routers mit Keenetic OS</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Grundlegende Methoden zur Fehlerdiagnose nach der Konfiguration</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Zusätzlicher Bypass zum Filtern von DNS-Abfragen durch den Anbieter</a> </li></ul><br><a name="con1"></a><h1>  Einführung </h1><br>  Ich habe die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Zolg-</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Schloss-Bypass-Option</a> ungefähr zwei Jahre lang verwendet.  Viele Anweisungen im Netzwerk basieren darauf.  Meins einschließlich. <br><br>  Alles war gut, aber "das Beste ist immer der Feind des Guten."  Erstens sind einige neue Programme zu "intelligent" geworden und lösen Domänen mit ihren eigenen Methoden auf, wobei der DNS-Server des Routers umgangen wird.  Dies erlaubt dnsmasq auf dem Router nicht, die Adresse zum Entsperren zum ipset-Set hinzuzufügen, und führt zu einem logischen Ergebnis - die Ressource bleibt gesperrt.  In Android 9 wird native Unterstützung für DNS-over-TLS, d. H.  Diese Methode zum Umgehen der Sperre funktioniert nicht mehr (wenn das andere Gerät zuvor noch nicht auf dnsmasq zugegriffen hat).  Zweitens führt die Aktualisierung der gesamten Domain-Liste von Antizapret jedes Mal zu unvorhersehbaren Ergebnissen.  Die Liste kann Domänen enthalten, die nicht wirklich blockiert sind und deren Betrieb über den Hauptkanal wichtig ist.  Sie müssen ständig auf dem Laufenden sein und die generierten Dateien mit Ihren Händen bearbeiten.  Drittens habe ich es satt, eine riesige Liste von Domains mit Zehntausenden von Casinos und dergleichen mitzuschleppen, die einfach nicht benötigt werden.  Mit der Zeit wurde mir klar, dass ich nur eine kleine spezifische Liste blockierter Ressourcen benötigte. <br><br>  Seit einem Jahr verwende ich eine leicht modifizierte Entsperrmethode, mit der ich voll und ganz zufrieden bin: <br><br><ul><li>  Einfachheit und einfache Steuerung (nach der Konfiguration). </li><li>  Volle Kontrolle darüber, welche Ressourcen Sie entsperren müssen. </li><li>  Mindestanforderungen an Prozessorressourcen und Router-RAM. </li><li>  Breite Abdeckung von Nuancen beim Umgehen von Schlössern. </li></ul><br>  Es ist wichtig zu beachten, dass meine Option nicht für den Fall vorgesehen ist, dass Sie Hunderte und Tausende von Domains entsperren müssen.  Denn wenn der Router gestartet wird, wird jede Domäne aus der angegebenen Liste aufgelöst.  Je mehr Domains in der Liste enthalten sind, desto länger dauert die Initialisierung vieler zu entsperrender ipsets. <br><br>  Die Basis für die Umgehung von Sperren ist dieselbe - das Tor-Netzwerk.  Die Verwendung ist auf zwei einfache Faktoren zurückzuführen - kostenlos, und die Wahrscheinlichkeit, dass Tor in Russland blockiert wird, liegt im Gegensatz zu jedem VPN-Dienst nahe Null.  Tor ist die Grundlage des Drogenhandels in Russland von der Mitte bis zum Boden.  Locking Tor wird zu einer Suche nach neuen Tools für den Markt und einer Verringerung der Anonymität führen, was die erfolgreiche Aktivierung der Arbeit der lokalen Strafverfolgungsbehörden zur Folge haben wird.  Letztendlich wird sich dies wie ein Virus negativ auf das Oberglied auswirken.  Angesichts der neuesten erstaunlichen Nachrichten über die Beziehung hochrangiger Regierungsbeamter zum weltweiten Drogenhandel mit Russland ist Tors Blockierung in Russland nur ein Tabu, obwohl es trivial ist.  Weder Roskomnadzor, egal wie viele Milliarden dieser Agentur zugewiesen sind, kein einziges Gericht in Russland hat die Erlaubnis "von oben", Tor zu blockieren.  Und es überrascht niemanden und erschreckt niemanden, obwohl Russland einfach in Drogen ertrinkt (jedes Schulkind weiß, was es tun wird, und nach 30 Minuten ist es in jeder Stadt mit 10.000 Einwohnern tatsächlich möglich, praktisch frei Drogen zu bekommen in irgendeiner Menge - solch eine böse Wahrheit des Lebens).  Im aktuellen Modus ist die Wahrscheinlichkeit, das Tor-Netzwerk zu blockieren, geringer als die Wahrscheinlichkeit, das Museum der Eremitage zu blockieren. <br><br>  Die Anweisungen lassen sich leicht an Router mit OpenWrt anpassen.  Kleine Änderungen machen es auch einfach, Tor durch OpenVPN zu ersetzen. <br><br><a name="con11"></a><h1>  Wie schaffen Sie es, Sperren nach der Konfiguration zu umgehen? </h1><br>  Alles ist sehr einfach.  Sie haben die Datei /opt/etc/unblock.txt - eine einfache Liste zum Entsperren.  Sie können eine Domain, IP-Adresse, einen Adressbereich oder eine CIDR entsperren.  Eine Zeile - ein Element.  Leere Zeilen sind zulässig, und Sie können das Zeichen # am Zeilenanfang zum Ignorieren verwenden. <br><br><div class="spoiler">  <b class="spoiler_title">Hier ist ein Beispiel meiner persönlichen Datei</b> <div class="spoiler_text"><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">###- rutracker.org rutor.info rutor.is mega-tor.org kinozal.tv nnm-club.me nnm-club.ws tfile.me tfile-home.org tfile1.cc megatfile.cc megapeer.org megapeer.ru tapochek.net tparser.org tparser.me rustorka.com uniongang.tv fast-torrent.ru ###    rezka.ag hdrezka.ag hdrezka.me filmix.co filmix.cc seasonvar.ru ### lib.rus.ec flibusta.is flibs.me flisland.net flibusta.site ### telegram.org tdesktop.com tdesktop.org tdesktop.info tdesktop.net telesco.pe telegram.dog telegram.me t.me telegra.ph web.telegram.org desktop.telegram.org updates.tdesktop.com venus.web.telegram.org flora.web.telegram.org vesta.web.telegram.org pluto.web.telegram.org aurora.web.telegram.org 149.154.160.0/20 91.108.4.0/22 91.108.8.0/22 91.108.12.0/22 91.108.16.0/22 91.108.56.0/22 109.239.140.0/24 67.198.55.0/24 ### 7-zip.org edem.tv 4pna.com 2019.vote ### Tor check.torproject.org ###   IP ( #   ) #195.82.146.214 ###   CIDR ( #   ) #103.21.244.0/22 ###    ( #   ) #100.100.100.200-100.100.100.210</span></span></code> </pre> <br></div></div><br>  Nach dem Bearbeiten dieser Datei führen Sie einfach den Befehl aus, um die neue Konfiguration anzuwenden: <br><br><pre> <code class="bash hljs">unblock_update.sh</code> </pre> <br>  Alle Ressourcen aus unblock.txt werden entsperrt, ohne dass der Router neu gestartet werden muss. <br><br><a name="con12"></a><h1>  Arbeitsprinzip </h1><br><ul><li>  Durch die Initialisierung des Routers wird ein leerer Satz von ipset-IP-Adressen mit der Bezeichnung "Entsperren" erstellt. </li><li>  Der Firewall wird eine Regel zum Umleiten aller Pakete mit Zielen vom Entsperren zum Tor-Dienst hinzugefügt. </li><li>  Der Tor-Dienst wird im transparenten Proxy-Modus gestartet. </li><li>  Das spezielle Skript unblock_ipset.sh wird gestartet, das alle Domänen aus unblock.txt auflöst und ihre IP-Adressen zum Unblock-Set hinzufügt.  IP-Adressen, Bereiche und CIDRs aus dieser Datei werden ebenfalls zum Entsperren hinzugefügt. </li><li>  Dnsmasq wird mit der zusätzlichen Konfigurationsdatei unblock.dnsmasq gestartet, die angibt, dass beim Auflösen Domänen-IP-Adressen aus unblock.txt zum Unblock-Satz hinzugefügt werden. </li><li>  cron führt unblock_ipset.sh mit einer bestimmten Häufigkeit aus, um mögliche Fälle mit Nuancen teilweise zu kompensieren. </li><li>  Bei Bedarf werden alle Domänen aus unblock.txt (und nur sie) über dnscrypt-proxy aufgelöst, wenn der Anbieter DNS filtert. </li></ul><br><a name="con2"></a><h1>  Padavan Router konfigurieren </h1><br>  Sie benötigen einen Router mit installierter Padavan-Firmware und einen bereits konfigurierten Entware-Paketmanager.  Unter Windows können Sie den <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">PuTTY-</a> Client verwenden, um über SSH eine Verbindung zum Router herzustellen. <br><br>  Stellen Sie sicher, dass Sie Entware verwenden, nicht die ältere Entware-ng.  Zeigen Sie den Inhalt des Ordners / opt / var / opkg-lists an.  Es wird eine Entware- oder Entware-ng-Datei geben.  Im zweiten Fall müssen Sie die Padavan-Firmware Ihres Routers auf die neueste Version aktualisieren und den Entware-Paketmanager neu installieren.  Fahren Sie erst dann mit den schrittweisen Anweisungen fort. <br><br>  Wie die Überprüfungen zeigten, werden hauptsächlich diejenigen, die Entware anfangs falsch konfiguriert haben (d. H. Skripte von init.d werden nicht geladen), in den internen Speicher des Routers geladen.  Wenn Sie über Xiaomi Mi Router 3 oder 3G verfügen und nicht sicher sind, ob Entware in Ihrem internen Speicher ordnungsgemäß funktioniert (automatischer Start), richten Sie einfach alles erneut ein.  Nimm PROMETHEUS.  Aktualisiert das Skript (1).  Aktualisieren Sie den Quellcode (2).  Sammeln und flashen Sie die aktuellste Firmware (4).  Zurücksetzen der Firmware-Einstellungen (NVRAM und Dateispeicherung) - Erweitert&gt; Administration&gt; Einstellungen.  Konfigurieren Sie den Internetzugang auf dem Router und aktivieren Sie SSH.  Führen Sie in PROMETHEUS Firmware&gt; RWFS-Formatierung.  Wählen Sie im Abschnitt "R / W"&gt; "UBIFS" die Option "Erweitert"&gt; "Administration"&gt; "Einstellungen"&gt; "Dateisystem bereitstellen".  Starten Sie den Router neu.  Alle aktuellen Entware-Startskripte aus dem internen Speicher werden automatisch registriert und alles funktioniert wie eine Uhr. <br><br>  Für Tests habe ich den beliebten Xiaomi Mi Router 3G (Entware ist im internen Speicher installiert) mit der neuesten Firmware - 32a93db - verwendet.  Alles funktioniert auch mit dem legendären Baby WT3020 AD / F / H für 10 US-Dollar. <br><br><img src="https://habrastorage.org/webt/th/kf/2k/thkf2kvtt2rhtnbxvmx0qri7dsk.jpeg"><br><br><h3>  1. Installieren Sie die erforderliche Software auf dem Router </h3><br><pre> <code class="bash hljs">opkg update opkg install mc tor tor-geoip <span class="hljs-built_in"><span class="hljs-built_in">bind</span></span>-dig cron</code> </pre> <br>  <b>mc</b> - Midnight Commander-Dateimanager.  Es wird nur wegen des praktischen mcedit-Editors benötigt.  Wenn Sie es gewohnt sind, einen anderen Texteditor zu verwenden, kann mc nicht installiert werden. <br>  <b>tor</b> - Tor Service. <br>  <b>tor-geoip</b> - Geo-IP-Datenbank für Tor. <br>  <b>bind-dig</b> - DNS-Client (analog zu nslookup und host). <br>  <b>cron</b> - Taskplaner. <br><cut></cut><br><h3>  2. Initialisieren Sie ipset und erstellen Sie mehrere Entsperr-IP-Adressen (start_script.sh). </h3><br>  Schließen Sie die erforderlichen Module an und erstellen Sie beim <b>Starten</b> des Routers einen leeren Adressensatz mit dem Namen " <b>Entsperren"</b> .  Öffnen Sie dazu die Datei <b>/etc/storage/start_script.sh</b> im Editor: <br><br><pre> <code class="bash hljs">mcedit /etc/storage/start_script.sh</code> </pre> <br>  Am Ende hinzufügen: <br><br><pre> <code class="bash hljs">modprobe ip_set modprobe ip_set_hash_ip modprobe ip_set_hash_net modprobe ip_set_bitmap_ip modprobe ip_set_list_set modprobe xt_set ipset create unblock <span class="hljs-built_in"><span class="hljs-built_in">hash</span></span>:net</code> </pre> <br>  Verwenden Sie zum Einfügen aus dem Puffer Umschalt + Einfügen, Speichern - F2, Beenden - F10. <br><br><img src="https://habrastorage.org/webt/tr/zp/cq/trzpcqqnadbonhsb0x3ebe7ltpo.png"><br><br>  Wenn Sie möchten, können Sie die Datei start_script.sh über die Weboberfläche des Routers bearbeiten - "Erweitert"&gt; "Personalisierung"&gt; "Skripte"&gt; "Vor dem Initialisieren des Routers ausführen".  Klicken Sie nach der Bearbeitung auf "Übernehmen". <br><br><img src="https://habrastorage.org/webt/yr/aa/8q/yraa8qgcfwu-vesrp3wvvne2vui.png"><br><br><h3>  3. Tor einrichten </h3><br>  Löschen Sie den Inhalt der Tor-Konfigurationsdatei: <br><br><pre> <code class="bash hljs">cat /dev/null &gt; /opt/etc/tor/torrc</code> </pre> <br>  Öffnen Sie die Tor-Konfigurationsdatei: <br><br><pre> <code class="bash hljs">mcedit /opt/etc/tor/torrc</code> </pre> <br>  Fügen Sie den Inhalt ein (Umschalt + Einfügen): <br><br><pre> <code class="bash hljs">User admin PidFile /opt/var/run/tor.pid ExcludeExitNodes {RU},{UA},{AM},{KG},{BY} StrictNodes 1 TransPort 192.168.0.1:9141 ExitRelay 0 ExitPolicy reject *:* ExitPolicy reject6 *:* GeoIPFile /opt/share/tor/geoip GeoIPv6File /opt/share/tor/geoip6 DataDirectory /opt/var/lib/tor</code> </pre> <br>  Ersetzen Sie gegebenenfalls <b>192.168.0.1</b> durch die interne Adresse Ihres Routers (LAN).  Kurze Konfigurationsbeschreibung: <br><br><ul><li>  Ausgabeknoten ausschließen: Russland, Ukraine, Armenien Kirgisistan, Weißrussland. </li><li>  Hängen Sie einen transparenten Proxy an die Adresse 192.168.0.1, Port 9141. </li><li>  Verweigere, ein Ausgangspunkt zu sein. </li></ul><br><h3>  4. Die Liste der Domänen (und nicht nur), die die Sperre umgehen sollen (unblock.txt) </h3><br>  unblock.txt ist eine einfache Liste zum Entsperren.  Sie können eine Domain, IP-Adresse, einen Bereich oder eine CIDR entsperren.  Eine Zeile - ein Element.  Leere Zeilen (einschließlich Leerzeichen und Tabulatoren) werden ignoriert.  Sie können das Zeichen # am Anfang einer Zeile verwenden, um es zu ignorieren. <br><br>  Erstellen Sie die Datei <b>/opt/etc/unblock.txt</b> : <br><br><pre> <code class="bash hljs">mcedit /opt/etc/unblock.txt</code> </pre> <br>  Jede Zeile kann einen Domänennamen, eine IP-Adresse, einen Bereich oder eine CIDR enthalten.  Sie können das Zeichen # verwenden, um Zeilen zu kommentieren. <br><br><div class="spoiler">  <b class="spoiler_title">Hier ist ein Beispiel meiner persönlichen Datei</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">###- rutracker.org rutor.info rutor.is mega-tor.org kinozal.tv nnm-club.me nnm-club.ws tfile.me tfile-home.org tfile1.cc megatfile.cc megapeer.org megapeer.ru tapochek.net tparser.org tparser.me rustorka.com uniongang.tv fast-torrent.ru ###    rezka.ag hdrezka.ag hdrezka.me filmix.co filmix.cc seasonvar.ru ### lib.rus.ec flibusta.is flibs.me flisland.net flibusta.site ### telegram.org tdesktop.com tdesktop.org tdesktop.info tdesktop.net telesco.pe telegram.dog telegram.me t.me telegra.ph web.telegram.org desktop.telegram.org updates.tdesktop.com venus.web.telegram.org flora.web.telegram.org vesta.web.telegram.org pluto.web.telegram.org aurora.web.telegram.org 149.154.160.0/20 91.108.4.0/22 91.108.8.0/22 91.108.12.0/22 91.108.16.0/22 91.108.56.0/22 109.239.140.0/24 67.198.55.0/24 ### 7-zip.org edem.tv 4pna.com 2019.vote ### Tor check.torproject.org ###   IP ( #   ) #195.82.146.214 ###   CIDR ( #   ) #103.21.244.0/22 ###    ( #   ) #100.100.100.200-100.100.100.210</span></span></code> </pre> <br></div></div><br><h3>  5. Ein Skript zum Auffüllen einer Reihe von IP-Adressen zum Entsperren einer bestimmten Liste von Domänen (unblock_ipset.sh) </h3><br>  Erstellen Sie das Skript <b>/opt/bin/unblock_ipset.sh</b> : <br><br><pre> <code class="bash hljs">mcedit /opt/bin/unblock_ipset.sh</code> </pre> <br>  Fügen Sie den Inhalt ein (Umschalt + Einfügen): <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh until ADDRS=$(dig +short google.com @localhost) &amp;&amp; [ -n "$ADDRS" ] &gt; /dev/null 2&gt;&amp;1; do sleep 5; done while read line || [ -n "$line" ]; do [ -z "$line" ] &amp;&amp; continue [ "${line:0:1}" = "#" ] &amp;&amp; continue cidr=$(echo $line | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}/[0-9]{1,2}') if [ ! -z "$cidr" ]; then ipset -exist add unblock $cidr continue fi range=$(echo $line | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}-[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}') if [ ! -z "$range" ]; then ipset -exist add unblock $range continue fi addr=$(echo $line | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}') if [ ! -z "$addr" ]; then ipset -exist add unblock $addr continue fi dig +short $line @localhost | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' | awk '{system("ipset -exist add unblock "$1)}' done &lt; /opt/etc/unblock.txt</span></span></code> </pre> <br>  Ausführungsrechte geben: <br><br><pre> <code class="bash hljs">chmod +x /opt/bin/unblock_ipset.sh</code> </pre> <br>  Das Skript ist recht einfach, das ist der Kern seiner Arbeit ... Wir warten darauf, dass die Domain-Auflösung von google.com funktioniert (wenn dies nicht erfolgt, wird beim Hochfahren des Routers nicht viel entsperrt, da der Router noch initialisiert wird).  Wir lesen die Zeilen in der Datei unblock.txt.  Beim Lesen von Zeilen werden Leerzeichen und Tabulatoren am Anfang und am Ende automatisch gelöscht.  Überspringen Sie die leeren Zeilen.  Überspringen Sie die Zeilen, die mit dem Zeichen # beginnen.  Wir suchen in der Zeile CIDR.  Wenn CIDR gefunden wird, fügen Sie es hinzu, um die Blockierung aufzuheben.  Wir suchen im Sortiment.  Wenn es gefunden wird, fügen Sie es hinzu, um die Blockierung aufzuheben.  Wir suchen nach der IP-Adresse in der Zeichenfolge.  Wenn IP gefunden wird, fügen Sie es hinzu, um die Blockierung aufzuheben.  Lassen Sie uns eine Zeile durch dig auflösen.  Alle IP-Adressen des Ergebnisses werden zum Entsperren hinzugefügt. <br><br><h3>  6. Ein Skript zum Generieren einer zusätzlichen dnsmasq-Konfigurationsdatei aus einer bestimmten Liste von Domänen (unblock_dnsmasq.sh) </h3><br>  Erstellen Sie das Skript <b>/opt/bin/unblock_dnsmasq.sh</b> : <br><br><pre> <code class="bash hljs">mcedit /opt/bin/unblock_dnsmasq.sh</code> </pre> <br>  Fügen Sie den Inhalt ein (Umschalt + Einfügen): <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh cat /dev/null &gt; /opt/etc/unblock.dnsmasq while read line || [ -n "$line" ]; do [ -z "$line" ] &amp;&amp; continue [ "${line:0:1}" = "#" ] &amp;&amp; continue echo $line | grep -Eq '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' &amp;&amp; continue echo "ipset=/$line/unblock" &gt;&gt; /opt/etc/unblock.dnsmasq done &lt; /opt/etc/unblock.txt</span></span></code> </pre> <br>  Ausführungsrechte geben: <br><br><pre> <code class="bash hljs">chmod +x /opt/bin/unblock_dnsmasq.sh</code> </pre> <br>  Das Skript ist recht einfach, das ist die Essenz seiner Arbeit ... Wir lesen die Zeilen nacheinander aus /opt/etc/unblock.txt.  Beim Lesen von Zeilen werden Leerzeichen und Tabulatoren am Anfang und am Ende automatisch gelöscht.  Überspringen Sie die leeren Zeilen.  Überspringen Sie die Zeilen, die mit # beginnen.  Wir überspringen die Zeilen, die die IP-Adresse (IP, Bereich, CIDR) enthalten, d. H.  Wir sind nur an Strings mit Domainnamen interessiert.  In der Datei /opt/etc/unblock.dnsmasq fügen wir Zeilen der Form "ipset = / domain_name / unblock" hinzu.  Dies bedeutet, dass nach dem Ermitteln der IP-Adressen einer bestimmten Domäne diese automatisch zum Entsperrungssatz hinzugefügt werden. <br><br>  Stellen Sie sicher, dass Sie das Skript ausführen, um die Datei unblock.dnsmasq zu generieren: <br><br><pre> <code class="bash hljs">unblock_dnsmasq.sh</code> </pre> <br>  Stellen Sie sicher, dass die Datei unblock.dnsmasq erstellt wurde: <br><br><pre> <code class="bash hljs">cat /opt/etc/unblock.dnsmasq</code> </pre> <br><h3>  7. Das Skript zur manuellen erzwungenen Aktualisierung des Systems nach dem Bearbeiten der Domänenliste (unblock_update.sh) </h3><br>  Erstellen Sie das Skript <b>/opt/bin/unblock_update.sh</b> : <br><br><pre> <code class="bash hljs">mcedit /opt/bin/unblock_update.sh</code> </pre> <br>  Fügen Sie den Inhalt ein (Umschalt + Einfügen): <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh ipset flush unblock /opt/bin/unblock_dnsmasq.sh restart_dhcpd sleep 3 /opt/bin/unblock_ipset.sh &amp;</span></span></code> </pre> <br>  Ausführungsrechte geben: <br><br><pre> <code class="bash hljs">chmod +x /opt/bin/unblock_update.sh</code> </pre> <br><h3>  8. Skript zum automatischen Auffüllen einer Reihe von Entsperrungen beim Booten eines Routers (S99unblock) </h3><br>  Erstellen Sie das Skript <b>/opt/etc/init.d/S99unblock</b> : <br><br><pre> <code class="bash hljs">mcedit /opt/etc/init.d/S99unblock</code> </pre> <br>  Fügen Sie den Inhalt ein (Umschalt + Einfügen): <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh [ "$1" != "start" ] &amp;&amp; exit 0 /opt/bin/unblock_ipset.sh &amp;</span></span></code> </pre><br>  Ausführungsrechte geben: <br><br><pre> <code class="bash hljs">chmod +x /opt/etc/init.d/S99unblock</code> </pre> <br><h3>  9. Weiterleiten von Paketen mit Zielen von Unblock an Tor (post_iptables_script.sh) </h3><br>  Öffnen Sie die Datei <b>/etc/storage/post_iptables_script.sh</b> im Editor: <br><br><pre> <code class="bash hljs">mcedit /etc/storage/post_iptables_script.sh</code> </pre> <br>  Am Ende hinzufügen: <br><br><pre> <code class="bash hljs">iptables -t nat -A PREROUTING -i br0 -p tcp -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set unblock dst -j REDIRECT --to-port 9141</code> </pre> <br><img src="https://habrastorage.org/webt/af/u2/dl/afu2dld3v0nrhtjwfekvo6i-wsi.png"><br><br>  Wenn Sie möchten, können Sie die Datei post_iptables_script.sh über die Weboberfläche des Routers bearbeiten - "Erweitert"&gt; "Personalisierung"&gt; "Skripte"&gt; "Nach Neustart der Firewall-Regeln ausführen".  Klicken Sie nach der Bearbeitung auf "Übernehmen". <br><br><img src="https://habrastorage.org/webt/pv/be/ot/pvbeotspo0xhzrukgp3dgvu5aws.png"><br><br>  Sie können derselben Datei hinzufügen (dies ist optional), um alle Anforderungen an den externen Port 53 an sich selbst umzuleiten.  Dies ist erforderlich, damit Clients im lokalen Netzwerk keine DNS-Dienste von Drittanbietern verwenden.  Anfragen werden über den regulären DNS-Server gesendet. <br><br><pre> <code class="bash hljs">iptables -t nat -I PREROUTING -i br0 -p udp --dport 53 -j DNAT --to 192.168.0.1 iptables -t nat -I PREROUTING -i br0 -p tcp --dport 53 -j DNAT --to 192.168.0.1</code> </pre> <br>  Ersetzen Sie gegebenenfalls <b>192.168.0.1</b> durch die interne Adresse Ihres Routers (LAN). <br><br><h3>  10. Verbinden einer zusätzlichen Konfigurationsdatei mit dnsmasq </h3><br>  Wir müssen die erstellte Datei unblock.dnsmasq mit dnsmasq verbinden.  Öffnen Sie dazu die Datei <b>/etc/storage/dnsmasq/dnsmasq.conf</b> im Editor: <br><br><pre> <code class="bash hljs">mcedit /etc/storage/dnsmasq/dnsmasq.conf</code> </pre> <br>  Am Ende hinzufügen: <br><br><pre> <code class="bash hljs">conf-file=/opt/etc/unblock.dnsmasq</code> </pre> <br>  Wenn Sie möchten (dies ist optional), können Sie einen zusätzlichen Server für Auflösung und Zuverlässigkeit hinzufügen: <br><br><pre> <code class="bash hljs">server=8.8.8.8</code> </pre> <br>  Wenn Sie möchten, können Sie die Datei dnsmasq.conf über die Weboberfläche des Routers bearbeiten - "Erweitert"&gt; "LAN"&gt; "DHCP-Server"&gt; "Benutzerkonfigurationsdatei dnsmasq.conf".  Klicken Sie nach der Bearbeitung auf "Übernehmen". <br><br><img src="https://habrastorage.org/webt/x0/ar/4c/x0ar4cm6v9pgsluqabh74qck-s0.png"><br><br><h3>  11. Hinzufügen einer Aufgabe zu cron, um den Inhalt des Entsperrungssatzes regelmäßig zu aktualisieren </h3><br>  Dies ist eine zusätzliche Versicherung für den Fall, dass Programme / Geräte ihre eigene Auflösungsmethode verwenden und sich die IP-Adresse der Domäne geändert hat.  Sie müssen lediglich das Skript unblock_ipset.sh mit der gewünschten Häufigkeit ausführen.  Zum Beispiel werden wir jeden Tag um 6 Uhr morgens starten. <br><br>  Ersetzen Sie den Stammnamen durch admin in der Cron-Konfigurationsdatei: <br><br><pre> <code class="bash hljs">sed -i <span class="hljs-string"><span class="hljs-string">'s/root/admin/g'</span></span> /opt/etc/crontab</code> </pre> <br>  Öffnen Sie die Datei <b>/ opt / etc / crontab</b> im Editor: <br><br><pre> <code class="bash hljs">mcedit /opt/etc/crontab</code> </pre> <br>  Am Ende hinzufügen: <br><br><pre> <code class="bash hljs">00 06 * * * admin /opt/bin/unblock_ipset.sh</code> </pre> <br>  Wenn Sie möchten, können Sie alle anderen Vorlagenaufgaben auskommentieren.  So sieht Ihre Crontab-Datei aus: <br><br><img src="https://habrastorage.org/webt/hf/lb/fc/hflbfcv04lpvzlrjmehoc3l51ts.png"><br><br><h3>  12. Starten Sie den Router neu </h3><br>  Führen Sie den folgenden Befehl aus: <br><br><pre> <code class="bash hljs">reboot</code> </pre> <br>  Öffnen Sie nach dem Neustart die Website check.torproject.org in Ihrem Browser (sie sollte zu unblock.txt hinzugefügt werden).  Wenn Sie alles richtig gemacht haben, sehen Sie die Aufschrift „Herzlichen Glückwunsch.  Dieser Browser ist für die Verwendung von Tor konfiguriert. ": <br><br><img src="https://habrastorage.org/webt/wa/19/dz/wa19dzxbu8qtldwrvkeijfqna7q.png"><br><br><br><a name="con3"></a><h1>  Konfigurieren eines Routers mit Keenetic OS </h1><br>  Sie müssen über einen Keenetic / Zyxel-Router verfügen, auf dem der Entware Package Manager (OPKG) bereits konfiguriert ist.  Hier ist beispielsweise eine Liste einiger Router, die Entware unterstützen: Keenetic II, Keenetic III, Extra, Extra II, Giga II, Giga III, Omni, Omni II, Viva, Ultra, Ultra II, Omni (KN-1410), Extra (KN) -1710), Giga (KN-1010), Ultra (KN-1810), Viva (KN-1910), DSL (KN-2010), Duo (KN-2110).  Anweisungen zum Konfigurieren von Entware finden Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> (bis zu 10 Punkte). <br><br>  Wenn Sie zuvor (mit Firmware unter 2.07) bereits Entware-Unterstützung hinzugefügt haben, stellen Sie sicher, dass Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">die veraltete Entware-ng verwenden</a> . <br><br>  Stellen Sie sicher, dass "Netfilter Subsystem Kernel Modules" - Allgemeine Einstellungen&gt; Komponentensatz ändern aktiviert ist.  Wenn es nicht in der Liste der verfügbaren Komponenten enthalten ist, versuchen Sie zunächst, die IPv6-Protokollkomponente zu installieren.  Wenn dies nicht der Fall ist, versuchen Sie es ohne, aber es ist sehr wahrscheinlich, dass Sie nicht nach Reichweite und CIDR entsperren können (da das Hash: Net-Set nicht unterstützt wird). <br><br><img src="https://habrastorage.org/webt/vv/dh/hi/vvdhhirhcktuefrgbxh3fkx5i0i.png"><br><br>  Für Tests habe ich Keenetic Ultra (KN-1810) mit der neuesten Firmware verwendet - 2.14.C.0.0-4. <br><br>  <u>Wichtiger Hinweis.</u>  <u>Sie müssen den regulären DNS-Server im System deaktivieren. Stattdessen verwenden wir dnsmasq.</u>  <u>Sie verlieren die Möglichkeit, DNS-Dienste (Yandex.DNS / SkyDNS / AdGuard DNS) einzeln für Clients zuzuweisen, können sie jedoch bei Bedarf global über die dnsmasq-Einstellungen verwenden.</u> <br><br><h3>  1. Installieren Sie die erforderliche Software auf dem Router </h3><br><pre> <code class="bash hljs">opkg update opkg install mc tor tor-geoip <span class="hljs-built_in"><span class="hljs-built_in">bind</span></span>-dig cron dnsmasq-full ipset iptables</code> </pre> <br>  <b>mc</b> - Midnight Commander-Dateimanager.  Es wird nur wegen des praktischen mcedit-Editors benötigt.  Wenn Sie es gewohnt sind, einen anderen Texteditor zu verwenden, kann mc nicht installiert werden. <br>  <b>tor</b> - Tor Service. <br>  <b>tor-geoip</b> - Geo-IP-Datenbank für Tor. <br>  <b>bind-dig</b> - DNS-Client (analog zu nslookup und host). <br>  <b>cron</b> - Taskplaner. <br>  <b>dnsmasq-full</b> - DNS-Server. <br>  <b>ipset und iptables</b> sind <b>ipset- und iptables-</b> Konsolendienstprogramme (sie befinden sich möglicherweise bereits auf dem System und werden nicht benötigt, ich habe sie aus Sicherheitsgründen hinzugefügt). <br><br><h3>  2. Initialisieren Sie ipset und erstellen Sie mehrere Entsperr-IP-Adressen (100-ipset.sh). </h3><br>  Überprüfen Sie, ob Ihr Routersystem viel Hash unterstützt: net (wie sich herausstellte, haben es nicht alle Keenetic-Router): <br><br><pre> <code class="bash hljs">ipset create <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> <span class="hljs-built_in"><span class="hljs-built_in">hash</span></span>:net</code> </pre> <br>  Wenn das Team keine Fehler oder Meldungen gegeben hat, gibt es Unterstützung und befolgen Sie einfach die Anweisungen weiter.  Andernfalls (es liegt ein Fehler vor) müssen Sie im folgenden Skript <b>hash: net</b> durch <b>hash: ip</b> ersetzen.  In diesem Fall verlieren Sie die Möglichkeit, Reichweite und CIDR freizuschalten. <br><br>  Erstellen Sie beim <b>Starten</b> des Routers einen leeren <b>Adresssatz</b> mit der Bezeichnung " <b>Entsperren"</b> .  Erstellen Sie dazu die Datei <b>/opt/etc/ndm/fs.d/100-ipset.sh</b> : <br><br><pre> <code class="bash hljs">mcedit /opt/etc/ndm/fs.d/100-ipset.sh</code> </pre> <br>  Fügen Sie den Inhalt ein (Umschalt + Einfügen): <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh [ "$1" != "start" ] &amp;&amp; exit 0 ipset create unblock hash:net -exist exit 0</span></span></code> </pre> <br>  Verwenden Sie zum Einfügen aus dem Puffer Umschalt + Einfügen, Speichern - F2, Beenden - F10. <br><br>  Ausführungsrechte geben: <br><br><pre> <code class="bash hljs">chmod +x /opt/etc/ndm/fs.d/100-ipset.sh</code> </pre> <br><h3>  3. Tor einrichten </h3><br>  Löschen Sie den Inhalt der Tor-Konfigurationsdatei: <br><br><pre> <code class="bash hljs">cat /dev/null &gt; /opt/etc/tor/torrc</code> </pre> <br>  Öffnen Sie die Tor-Konfigurationsdatei: <br><br><pre> <code class="bash hljs">mcedit /opt/etc/tor/torrc</code> </pre> <br>  Fügen Sie den Inhalt ein (Umschalt + Einfügen): <br><br><pre> <code class="bash hljs">User root PidFile /opt/var/run/tor.pid ExcludeExitNodes {RU},{UA},{AM},{KG},{BY} StrictNodes 1 TransPort 192.168.0.1:9141 ExitRelay 0 ExitPolicy reject *:* ExitPolicy reject6 *:* GeoIPFile /opt/share/tor/geoip GeoIPv6File /opt/share/tor/geoip6 DataDirectory /opt/var/lib/tor</code> </pre> <br>  Ersetzen Sie gegebenenfalls <b>192.168.0.1</b> durch die interne Adresse Ihres Routers (LAN).  Kurze Konfigurationsbeschreibung: <br><br><ul><li>  Ausgabeknoten ausschließen: Russland, Ukraine, Armenien Kirgisistan, Weißrussland. </li><li>  Hängen Sie einen transparenten Proxy an die Adresse 192.168.0.1, Port 9141. </li><li>  Verweigere, ein Ausgangspunkt zu sein. </li></ul><br><h3>  4. Die Liste der Domänen (und nicht nur), die die Sperre umgehen sollen (unblock.txt) </h3><br>  unblock.txt ist eine einfache Liste zum Entsperren.  Sie können eine Domain, IP-Adresse, einen Bereich oder eine CIDR entsperren.  Eine Zeile - ein Element.  Leere Zeilen (einschließlich Leerzeichen und Tabulatoren) werden ignoriert.  Sie können das Zeichen # am Anfang einer Zeile verwenden, um es zu ignorieren. <br><br>  Erstellen Sie die Datei <b>/opt/etc/unblock.txt</b> : <br><br><pre> <code class="bash hljs">mcedit /opt/etc/unblock.txt</code> </pre> <br>  Jede Zeile kann einen Domänennamen, eine IP-Adresse, einen Bereich oder eine CIDR enthalten.  Sie können das Zeichen # verwenden, um Zeilen zu kommentieren. <br><br><div class="spoiler">  <b class="spoiler_title">Hier ist ein Beispiel meiner persönlichen Datei</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">###- rutracker.org rutor.info rutor.is mega-tor.org kinozal.tv nnm-club.me nnm-club.ws tfile.me tfile-home.org tfile1.cc megatfile.cc megapeer.org megapeer.ru tapochek.net tparser.org tparser.me rustorka.com uniongang.tv fast-torrent.ru ###    rezka.ag hdrezka.ag hdrezka.me filmix.co filmix.cc seasonvar.ru ### lib.rus.ec flibusta.is flibs.me flisland.net flibusta.site ### telegram.org tdesktop.com tdesktop.org tdesktop.info tdesktop.net telesco.pe telegram.dog telegram.me t.me telegra.ph web.telegram.org desktop.telegram.org updates.tdesktop.com venus.web.telegram.org flora.web.telegram.org vesta.web.telegram.org pluto.web.telegram.org aurora.web.telegram.org 149.154.160.0/20 91.108.4.0/22 91.108.8.0/22 91.108.12.0/22 91.108.16.0/22 91.108.56.0/22 109.239.140.0/24 67.198.55.0/24 ### 7-zip.org edem.tv 4pna.com 2019.vote ### Tor check.torproject.org ###   IP ( #   ) #195.82.146.214 ###   CIDR ( #   ) #103.21.244.0/22 ###    ( #   ) #100.100.100.200-100.100.100.210</span></span></code> </pre> <br></div></div><br><h3>  5. Ein Skript zum Auffüllen einer Reihe von IP-Adressen zum Entsperren einer bestimmten Liste von Domänen (unblock_ipset.sh) </h3><br>  Erstellen Sie das Skript <b>/opt/bin/unblock_ipset.sh</b> : <br><br><pre> <code class="bash hljs">mcedit /opt/bin/unblock_ipset.sh</code> </pre> <br>  Fügen Sie den Inhalt ein (Umschalt + Einfügen): <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh until ADDRS=$(dig +short google.com @localhost) &amp;&amp; [ -n "$ADDRS" ] &gt; /dev/null 2&gt;&amp;1; do sleep 5; done while read line || [ -n "$line" ]; do [ -z "$line" ] &amp;&amp; continue [ "${line:0:1}" = "#" ] &amp;&amp; continue cidr=$(echo $line | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}/[0-9]{1,2}') if [ ! -z "$cidr" ]; then ipset -exist add unblock $cidr continue fi range=$(echo $line | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}-[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}') if [ ! -z "$range" ]; then ipset -exist add unblock $range continue fi addr=$(echo $line | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}') if [ ! -z "$addr" ]; then ipset -exist add unblock $addr continue fi dig +short $line @localhost | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' | awk '{system("ipset -exist add unblock "$1)}' done &lt; /opt/etc/unblock.txt</span></span></code> </pre> <br>  Ausführungsrechte geben: <br><br><pre> <code class="bash hljs">chmod +x /opt/bin/unblock_ipset.sh</code> </pre> <br>  Das Skript ist recht einfach, das ist der Kern seiner Arbeit ... Wir warten darauf, dass die Domain-Auflösung von google.com funktioniert (wenn dies nicht erfolgt, wird beim Hochfahren des Routers nicht viel entsperrt, da der Router noch initialisiert wird).  Wir lesen die Zeilen in der Datei unblock.txt.  Beim Lesen von Zeilen werden Leerzeichen und Tabulatoren am Anfang und am Ende automatisch gelöscht.  Überspringen Sie die leeren Zeilen.  Überspringen Sie die Zeilen, die mit dem Zeichen # beginnen.  Wir suchen in der Zeile CIDR.  Wenn CIDR gefunden wird, fügen Sie es hinzu, um die Blockierung aufzuheben.  Wir suchen im Sortiment.  Wenn es gefunden wird, fügen Sie es hinzu, um die Blockierung aufzuheben.  Wir suchen nach der IP-Adresse in der Zeichenfolge.  Wenn IP gefunden wird, fügen Sie es hinzu, um die Blockierung aufzuheben.  Lassen Sie uns eine Zeile durch dig auflösen.  Alle IP-Adressen des Ergebnisses werden zum Entsperren hinzugefügt. <br><br><h3>  6. Ein Skript zum Generieren einer zusätzlichen dnsmasq-Konfigurationsdatei aus einer bestimmten Liste von Domänen (unblock_dnsmasq.sh) </h3><br>  Erstellen Sie das Skript <b>/opt/bin/unblock_dnsmasq.sh</b> : <br><br><pre> <code class="bash hljs">mcedit /opt/bin/unblock_dnsmasq.sh</code> </pre> <br>  Fügen Sie den Inhalt ein (Umschalt + Einfügen): <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh cat /dev/null &gt; /opt/etc/unblock.dnsmasq while read line || [ -n "$line" ]; do [ -z "$line" ] &amp;&amp; continue [ "${line:0:1}" = "#" ] &amp;&amp; continue echo $line | grep -Eq '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' &amp;&amp; continue echo "ipset=/$line/unblock" &gt;&gt; /opt/etc/unblock.dnsmasq done &lt; /opt/etc/unblock.txt</span></span></code> </pre> <br>  Ausführungsrechte geben: <br><br><pre> <code class="bash hljs">chmod +x /opt/bin/unblock_dnsmasq.sh</code> </pre> <br>  Das Skript ist recht einfach.  Wir lesen nacheinander die Zeilen aus /opt/etc/unblock.txt.  Beim Lesen von Zeilen werden Leerzeichen und Tabulatoren am Anfang und am Ende automatisch gelöscht.  Überspringen Sie die leeren Zeilen.  Überspringen Sie die Zeilen, die mit # beginnen.  Überspringen Sie Zeilen, die eine IP-Adresse (IP oder CIDR) enthalten, d. H.  Wir sind nur an Strings mit Domainnamen interessiert.  In der Datei /opt/etc/unblock.dnsmasq fügen wir Zeilen der Form "ipset = / domain_name / unblock" hinzu.  Dies bedeutet, dass nach dem Ermitteln der IP-Adressen einer bestimmten Domäne diese automatisch zum Entsperrungssatz hinzugefügt werden. <br><br>  Stellen Sie sicher, dass Sie das Skript ausführen, um die Datei unblock.dnsmasq zu generieren: <br><br><pre> <code class="bash hljs">unblock_dnsmasq.sh</code> </pre> <br>  Stellen Sie sicher, dass die Datei unblock.dnsmasq erstellt wurde: <br><br><pre> <code class="bash hljs">cat /opt/etc/unblock.dnsmasq</code> </pre> <br><h3>  7. Das Skript zur manuellen erzwungenen Aktualisierung des Systems nach dem Bearbeiten der Domänenliste (unblock_update.sh) </h3><br>  Erstellen Sie das Skript <b>/opt/bin/unblock_update.sh</b> : <br><br><pre> <code class="bash hljs">mcedit /opt/bin/unblock_update.sh</code> </pre> <br>  Fügen Sie den Inhalt ein (Umschalt + Einfügen): <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh ipset flush unblock /opt/bin/unblock_dnsmasq.sh /opt/etc/init.d/S56dnsmasq restart /opt/bin/unblock_ipset.sh &amp;</span></span></code> </pre> <br>  Ausführungsrechte geben: <br><br><pre> <code class="bash hljs">chmod +x /opt/bin/unblock_update.sh</code> </pre> <br><h3>  8. Skript zum automatischen Auffüllen einer Reihe von Entsperrungen beim Booten eines Routers (S99unblock) </h3><br>  Erstellen Sie das Skript <b>/opt/etc/init.d/S99unblock</b> : <br><br><pre> <code class="bash hljs">mcedit /opt/etc/init.d/S99unblock</code> </pre> <br>  Fügen Sie den Inhalt ein (Umschalt + Einfügen): <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh [ "$1" != "start" ] &amp;&amp; exit 0 /opt/bin/unblock_ipset.sh &amp;</span></span></code> </pre><br>  Ausführungsrechte geben: <br><br><pre> <code class="bash hljs">chmod +x /opt/etc/init.d/S99unblock</code> </pre> <br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 9. Weiterleiten von Paketen mit Zielen von Unblock an Tor (100-redirect.sh) </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erstellen Sie dazu die Datei </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/opt/etc/ndm/netfilter.d/100-redirect.sh</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br><br><pre> <code class="bash hljs">mcedit /opt/etc/ndm/netfilter.d/100-redirect.sh</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Fügen Sie den Inhalt ein (Umschalt + Einfügen): </font></font><br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh [ "$type" == "ip6tables" ] &amp;&amp; exit 0 if [ -z "$(iptables-save 2&gt;/dev/null | grep unblock)" ]; then ipset create unblock hash:net -exist iptables -w -t nat -A PREROUTING -i br0 -p tcp -m set --match-set unblock dst -j REDIRECT --to-port 9141 fi exit 0</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn Sie in Schritt 2 </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hash: ip</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und nicht </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hash: net verwendet haben</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , ersetzen Sie hash: net durch hash: ip. Tatsächlich duplizieren wir zusätzlich die Funktion zum Erstellen eines Satzes zum Entsperren aus zwei Schritten. Dies ist aus Sicherheitsgründen erforderlich, wenn die Skripte von fs.d noch nicht gestartet wurden und die Skripte netfilter.d bereits ausgeführt werden. Es ist in Ordnung, wenn die Entsperrung bereits früher erstellt wurde. Der Befehl wird einfach ignoriert. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sie können derselben Datei hinzufügen (dies ist optional), um alle Anforderungen an den externen Port 53 an sich selbst umzuleiten. Dies ist erforderlich, damit Clients im lokalen Netzwerk keine DNS-Dienste von Drittanbietern verwenden. Anfragen werden über den regulären DNS-Server gesendet. Fügen Sie vor der letzten Ausfahrt Folgendes hinzu:</font></font><br><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ -z <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$(iptables-save 2&gt;/dev/null | grep "udp \-\-dport 53 \-j DNAT")</span></span></span><span class="hljs-string">"</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> iptables -w -t nat -I PREROUTING -i br0 -p udp --dport 53 -j DNAT --to 192.168.0.1 <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ -z <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$(iptables-save 2&gt;/dev/null | grep "tcp \-\-dport 53 \-j DNAT")</span></span></span><span class="hljs-string">"</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> iptables -w -t nat -I PREROUTING -i br0 -p tcp --dport 53 -j DNAT --to 192.168.0.1 <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ersetzen Sie gegebenenfalls </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.0.1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> durch die interne Adresse Ihres Routers (LAN). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ausführungsrechte geben:</font></font><br><br><pre> <code class="bash hljs">chmod +x /opt/etc/ndm/netfilter.d/100-redirect.sh</code> </pre> <br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 10. Konfigurieren von dnsmasq und Anhängen einer zusätzlichen Konfigurationsdatei an dnsmasq </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Löschen Sie den Inhalt der dnsmasq-Konfigurationsdatei: </font></font><br><br><pre> <code class="bash hljs">cat /dev/null &gt; /opt/etc/dnsmasq.conf</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Öffnen Sie die dnsmasq-Konfigurationsdatei: </font></font><br><br><pre> <code class="bash hljs">mcedit /opt/etc/dnsmasq.conf</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Fügen Sie den Inhalt ein (Umschalt + Einfügen): </font></font><br><br><pre> <code class="bash hljs">user=nobody bogus-priv no-negcache clear-on-reload <span class="hljs-built_in"><span class="hljs-built_in">bind</span></span>-dynamic listen-address=192.168.0.1 listen-address=127.0.0.1 min-port=4096 cache-size=1536 expand-hosts <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>-async conf-file=/opt/etc/unblock.dnsmasq server=8.8.8.8</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ersetzen Sie gegebenenfalls </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.0.1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> durch die interne Adresse Ihres Routers (LAN).</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 11. Hinzufügen einer Aufgabe zu cron, um den Inhalt des Entsperrungssatzes regelmäßig zu aktualisieren </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dies ist eine zusätzliche Versicherung für den Fall, dass Programme / Geräte ihre eigene Auflösungsmethode verwenden und sich die IP-Adresse der Domäne geändert hat. </font><font style="vertical-align: inherit;">Sie müssen lediglich das Skript unblock_ipset.sh mit der gewünschten Häufigkeit ausführen. </font><font style="vertical-align: inherit;">Zum Beispiel werden wir jeden Tag um 6 Uhr morgens starten. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Öffnen Sie die Datei </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ opt / etc / crontab</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> im Editor </font><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="bash hljs">mcedit /opt/etc/crontab</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Am Ende hinzufügen: </font></font><br><br><pre> <code class="bash hljs">00 06 * * * root /opt/bin/unblock_ipset.sh</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn Sie möchten, können Sie alle anderen Vorlagenaufgaben auskommentieren. </font><font style="vertical-align: inherit;">So sieht Ihre Crontab-Datei aus:</font></font><br><br><img src="https://habrastorage.org/webt/le/y5/sl/ley5slcvjfvs-9odj9air9qdd8s.png"><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 12. Deaktivieren Sie den regulären DNS-Server und starten Sie den Router neu </font></font></h3><br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stellen Sie eine Verbindung</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> zur </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">Keenetic Router-CLI her</font></a><font style="vertical-align: inherit;"> (Port 23 für Telnet und 22 für SSH, wenn die Komponente „SSH-Server“ zum System hinzugefügt wird). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Führen Sie den folgenden Befehl aus:</font></font><br><br><pre> <code class="bash hljs">opkg dns-override system configuration save system reboot</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der in die Firmware integrierte DNS-Server wird deaktiviert und stattdessen wird dnsmasq von Entware verwendet. </font><font style="vertical-align: inherit;">Der Router prüft beim Booten, ob der opt-Ordner gemountet ist (gibt es ein USB-Flash-Laufwerk mit Entware). </font><font style="vertical-align: inherit;">Wenn dies der Fall ist, wird kein regulärer DNS-Server verwendet. </font><font style="vertical-align: inherit;">Wenn nicht, verwenden Sie.</font></font> Das heißt,<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn Sie das Flash-Laufwerk entfernen und den Router neu starten, funktioniert alles wie zuvor (vor dem Einrichten) für Sie. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Öffnen Sie nach dem Neustart die Website check.torproject.org in Ihrem Browser (sie sollte zu unblock.txt hinzugefügt werden). </font><font style="vertical-align: inherit;">Wenn Sie alles richtig gemacht haben, sehen Sie die Aufschrift „Herzlichen Glückwunsch. </font><font style="vertical-align: inherit;">Dieser Browser ist für die Verwendung von Tor konfiguriert. ":</font></font><br><br><img src="https://habrastorage.org/webt/wa/19/dz/wa19dzxbu8qtldwrvkeijfqna7q.png"><br><br><br><a name="con31"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Grundlegende Methoden zur Fehlerdiagnose nach der Konfiguration </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn die Prüfung mit der Site check.torproject.org (sie sollte zu unblock.txt hinzugefügt werden) erfolgreich ist, der Stub des Anbieters jedoch weiterhin für andere Ressourcen geöffnet wird (oder nicht geöffnet wird), stört der Anbieter höchstwahrscheinlich den DNS-Verkehr und ersetzt die Antworten - Sie Sie müssen die Filterung von DNS-Abfragen zusätzlich umgehen. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn nach der Konfiguration etwas nicht ordnungsgemäß funktioniert, verwenden Sie einfache Befehle, um den Problemschritt zu bestimmen. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zeigen Sie den Inhalt des Entsperrungssatzes an:</font></font><br><br><pre> <code class="bash hljs">ipset list unblock</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn das System meldet, dass keine solchen Sätze vorhanden sind, liegt der Fehler in Schritt 2 vor oder Sie haben das Netfilter-Modul im System nicht aktiviert (im Fall von Keenetic). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn sich herausstellt, dass das Set leer ist, hat das Skript unblock_ipset.sh nicht funktioniert, was wiederum vom S99unblock-Startskript gestartet werden sollte. Führen Sie dieses Skript unblock_ipset.sh manuell aus. Wenn der Satz voll ist, befindet sich der Fehler in Schritt 8. Wenn das Skript nicht ausgeführt werden kann (höchstwahrscheinlich wartet es auf die Auflösung von google.com), befindet sich der Fehler irgendwo auf der Seite des DNS-Servers, möglicherweise in Schritt 10 oder 6. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Suchen Sie in iptables nach einer Umleitung ::</font></font><br><br><pre> <code class="bash hljs">iptables-save 2&gt;/dev/null | grep unblock</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn es nicht vorhanden ist, liegt der Fehler in Schritt 9. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn alle Standorte überhaupt nicht funktionieren, d. H. </font><font style="vertical-align: inherit;">DNS funktioniert nicht, der Fehler befindet sich irgendwo in Stufe 6 oder 10. Möglicherweise in Stufe 9. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn alle Sites von unblock.txt nicht funktionieren (Timeout wird überschritten), aber alle anderen funktionieren, liegt das Problem irgendwo auf der Tor-Seite, Fehler in Stufe 3.</font></font><br><br><br><a name="con4"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Zusätzlicher Bypass zum Filtern von DNS-Abfragen durch den Anbieter </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn ein Anbieter den DNS-Verkehr stört, indem er Antworten für blockierte Ressourcen ersetzt, ist dies sehr einfach zu umgehen. </font><font style="vertical-align: inherit;">Dafür verwenden wir dnscrypt-proxy. </font><font style="vertical-align: inherit;">Wenn Sie möchten und Erfahrung haben, können Sie dnscrypt einfach durch stubby (DNS über TLS) ersetzen. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dnscrypt wird nur für Domains verwendet, die in unblock.txt aufgeführt sind. </font><font style="vertical-align: inherit;">Alle anderen Abfragen werden über reguläre DNS-Server durchgeführt. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn Sie sicher sind, dass Ihr Provider keine DNS-Abfragen filtert, müssen Sie diese zusätzliche Konfiguration nicht vornehmen. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sie sollten den Bypass der oben beschriebenen Sperren bereits konfiguriert haben. </font><font style="vertical-align: inherit;">Die folgenden Einstellungen sind für Padavan und Keenetic OS identisch. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Installieren Sie zusätzliche Software auf dem Router:</font></font><br><br><pre> <code class="bash hljs">opkg update opkg install dnscrypt-proxy2</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Öffnen Sie die Konfigurationsdatei dnscrypt-proxy: </font></font><br><br><pre> <code class="bash hljs">mcedit /opt/etc/dnscrypt-proxy.toml</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Suchen Sie die Parameter listen_addresses, fallback_resolver und cache und ändern Sie sie: </font></font><br><br><pre> <code class="bash hljs">listen_addresses = [<span class="hljs-string"><span class="hljs-string">'127.0.0.1:9153'</span></span>] fallback_resolver = <span class="hljs-string"><span class="hljs-string">'77.88.8.8:1253'</span></span> cache = <span class="hljs-literal"><span class="hljs-literal">false</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">77.88.8.8:1253 ist die Yandex-DNS-Serveradresse mit einem nicht standardmäßigen Port. </font><font style="vertical-align: inherit;">Es ist ein Backup für den Fall, dass dnscrypt-proxy Probleme hat. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Führen Sie dnscrypt-proxy aus:</font></font><br><br><pre> <code class="bash hljs">/opt/etc/init.d/S09dnscrypt-proxy2 start</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Stellen Sie sicher, dass dnscrypt-proxy funktioniert (als Antwort sollte eine Liste der IP-Adressen angezeigt werden): </font></font><br><br><pre> <code class="bash hljs">dig +short google.com @localhost -p 9153</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Öffnen Sie das Skript </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/opt/bin/unblock_ipset.sh</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> im Editor </font><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="bash hljs">mcedit /opt/bin/unblock_ipset.sh</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ersetzen Sie den Inhalt durch: </font></font><br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh until ADDRS=$(dig +short google.com @localhost -p 9153) &amp;&amp; [ -n "$ADDRS" ] &gt; /dev/null 2&gt;&amp;1; do sleep 5; done while read line || [ -n "$line" ]; do [ -z "$line" ] &amp;&amp; continue [ "${line:0:1}" = "#" ] &amp;&amp; continue cidr=$(echo $line | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}/[0-9]{1,2}') if [ ! -z "$cidr" ]; then ipset -exist add unblock $cidr continue fi range=$(echo $line | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}-[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}') if [ ! -z "$range" ]; then ipset -exist add unblock $range continue fi addr=$(echo $line | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}') if [ ! -z "$addr" ]; then ipset -exist add unblock $addr continue fi dig +short $line @localhost -p 9153 | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' | awk '{system("ipset -exist add unblock "$1)}' done &lt; /opt/etc/unblock.txt</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir haben eine kleine Änderung vorgenommen - jetzt verwendet dig for Resolving keinen regulären DNS-Server, sondern dnscrypt-proxy mit Port 9153. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Öffnen Sie das Skript </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/opt/bin/unblock_dnsmasq.sh</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> im Editor </font><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="bash hljs">mcedit /opt/bin/unblock_dnsmasq.sh</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ersetzen Sie den Inhalt durch: </font></font><br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh cat /dev/null &gt; /opt/etc/unblock.dnsmasq while read line || [ -n "$line" ]; do [ -z "$line" ] &amp;&amp; continue [ "${line:0:1}" = "#" ] &amp;&amp; continue echo $line | grep -Eq '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' &amp;&amp; continue echo "ipset=/$line/unblock" &gt;&gt; /opt/etc/unblock.dnsmasq echo "server=/$line/127.0.0.1#9153" &gt;&gt; /opt/etc/unblock.dnsmasq done &lt; /opt/etc/unblock.txt</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir haben eine kleine Änderung vorgenommen - jetzt werden beim Generieren der Datei unblock.dnsmasq zusätzliche Zeilen wie "server = / domain_name / 127.0.0.1 # 9153" hinzugefügt. </font><font style="vertical-align: inherit;">Dies bedeutet, dass das Auflösen von Domänen aus der Liste über dnscrypt-proxy erfolgt. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Führen Sie unblock_update.sh aus:</font></font><br><br><pre> <code class="bash hljs">unblock_update.sh</code> </pre> <br>  Fertig.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alle komplizierten Einstellungen sind dahinter. </font><font style="vertical-align: inherit;">Jetzt bearbeiten Sie die Liste unblock.txt nur bei Bedarf, fügen Domänen oder IP-Adressen zum Entsperren hinzu oder entfernen sie und aktivieren die mit dem Befehl unblock_update.sh vorgenommenen Änderungen. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UPDATE 04/01/2019</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Oft kommen persönliche Nachrichten auf den Artikel mit typischen Fragen. </font><font style="vertical-align: inherit;">Ich werde hier am häufigsten antworten. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wie stelle ich .onion Domain Zone Sites zur Verfügung? </font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In Torrc hinzufügen:</font></font><br><pre> <code class="bash hljs">VirtualAddrNetwork 10.254.0.0/16 DNSPort 127.0.0.1:9053 AutomapHostsOnResolve 1</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Um auf alle Domänen der Zwiebelzone zuzugreifen, fügen Sie dnsmasq.conf hinzu: </font></font><br><pre> <code class="bash hljs">server=/onion/127.0.0.1<span class="hljs-comment"><span class="hljs-comment">#9053 ipset=/onion/unblock</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Wenn Sie den Zugriff nicht auf alle Domänen der Zwiebelzone öffnen möchten, sondern nur auf bestimmte, fügen Sie die folgenden Einträge in die Datei dnsmasq.conf ein: </font></font><br><pre> <code class="bash hljs">server=/rutorc6mqdinc4cz.onion/127.0.0.1<span class="hljs-comment"><span class="hljs-comment">#9053 ipset=/rutorc6mqdinc4cz.onion/unblock server=/nnmclub5toro7u65.onion/127.0.0.1#9053 ipset=/nnmclub5toro7u65.onion/unblock server=/flibustahezeous3.onion/127.0.0.1#9053 ipset=/flibustahezeous3.onion/unblock</span></span></code> </pre> <br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wie umgehe ich Sperren für Clients eines VPN-Servers, der auf einem Router ausgeführt wird? </font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ersetzen Sie in Torrc die Zeile durch TransPort durch:</font></font><br><pre> <code class="bash hljs">TransPort 0.0.0.0:9141</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Fügen Sie eine zusätzliche Umleitung mit der erforderlichen Schnittstelle hinzu (INTERFACE - VPN-Netzwerkschnittstelle): </font></font><br><pre> <code class="bash hljs">iptables -t nat -A PREROUTING -i  -p tcp -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set unblock dst -j REDIRECT --to-port 9141</code> </pre> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de428992/">https://habr.com/ru/post/de428992/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de428982/index.html">Wie schreibe ich D auf ARM</a></li>
<li><a href="../de428984/index.html">Julia und Phasenporträts dynamischer Systeme</a></li>
<li><a href="../de428986/index.html">ThinkJava-Konferenz Nr. 8 in Charkow</a></li>
<li><a href="../de428988/index.html">Tipps der Natur - Bewölktes Nachtlicht</a></li>
<li><a href="../de428990/index.html">Konfigurationsbeispiele für UIViewController mit RouteComposer</a></li>
<li><a href="../de428994/index.html">Vernetzung in Android mit Corutin und Retrofit</a></li>
<li><a href="../de428996/index.html">Club der anonymen Weihnachtsmänner 2018-2019 auf Habrahabr</a></li>
<li><a href="../de428998/index.html">Verwendung der neuen experimentellen Profiler-Funktion in React</a></li>
<li><a href="../de429000/index.html">Warum Bill Gates die Toilette für 233 Milliarden Dollar erfunden hat</a></li>
<li><a href="../de429006/index.html">China: „World Assembly Shop“ ist nicht so einfach, wie es scheint</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>