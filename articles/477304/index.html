<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôãüèΩ ü§≥üèΩ üëåüèø CDN din√°mico para transmisi√≥n webRTC de baja latencia ‚úãüèæ üíπ üç®</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Habiendo analizado anteriormente la capacidad de las configuraciones de servidor est√°ndar en Digital Ocean en t√©rminos de transmisi√≥n WebRTC, hemos no...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>CDN din√°mico para transmisi√≥n webRTC de baja latencia</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flashphoner/blog/477304/"><p><img src="https://habrastorage.org/webt/qp/yd/gy/qpydgy2jfifixw87t9seev0eb7o.jpeg"></p><br><p>  Habiendo analizado anteriormente la capacidad de las <a href="https://habr.com/en/company/flashphoner/blog/476554/">configuraciones de servidor</a> est√°ndar <a href="https://habr.com/en/company/flashphoner/blog/476554/">en Digital Ocean</a> en t√©rminos de transmisi√≥n WebRTC, hemos notado que un servidor puede cubrir hasta 2000 espectadores.  En la vida real, los casos en que un servidor es insuficiente no son infrecuentes. </p><br><p>  Suponga que los aficionados al juego en Alemania est√°n viendo carreras de caballos en tiempo real en Australia.  Dado que las carreras de caballos no son solo un juego deportivo, sino que tambi√©n implican grandes ganancias con la condici√≥n de que las apuestas de campo se realicen en el momento adecuado, el video debe entregarse con la latencia m√°s baja posible. </p><br><p>  Otro ejemplo: una corporaci√≥n global, uno de los l√≠deres del mercado de FCMG con subsidiarias en Europa, Rusia y el sudeste asi√°tico, est√° organizando seminarios web de capacitaci√≥n para gerentes de ventas con transmisi√≥n en vivo desde la sede en el Mediterr√°neo.  Los espectadores deben poder ver y escuchar al presentador en tiempo real. <a name="habracut"></a></p><br><p>  Estos ejemplos presentan el mismo requisito: entregar transmisiones de medios de baja latencia a un gran n√∫mero de espectadores.  Esto requerir√° implementar una red de entrega de contenido: CDN. </p><br><p>  Cabe se√±alar que la tecnolog√≠a de entrega de flujo convencional que utiliza HLS no es adecuada, ya que puede agregar retrasos de hasta 30 segundos, que son cr√≠ticos para un espect√°culo en tiempo real.  Imagina que los caballos ya han terminado, los resultados se han publicado en el sitio web, mientras los fan√°ticos todav√≠a est√°n viendo el final de la carrera.  La tecnolog√≠a WebRTC est√° libre de esta desventaja y puede garantizar retrasos de menos de 1 segundo, lo que es posible incluso en todos los continentes gracias a los canales de comunicaci√≥n modernos. </p><br><p>  Para comenzar, veremos c√≥mo implementar el CDN m√°s simple para entregar transmisiones WebRTC y c√≥mo escalarlo despu√©s. </p><br><h2 id="cdn-principles">  Principios de CDN </h2><br><p>  Un servidor en CDN puede desempe√±ar uno de los siguientes roles: </p><br><ul><li>  Origin es el servidor creado para publicar transmisiones de medios.  Comparte transmisiones a otros servidores, as√≠ como a los usuarios. </li><li>  Transcoder es el servidor dedicado para transcodificar flujos.  Extrae secuencias del servidor de origen y pasa secuencias transcodificadas a Edge.  Veremos este papel en la siguiente parte. </li><li>  Edge es el servidor dise√±ado para compartir transmisiones a los usuarios.  Extrae transmisiones de los servidores de origen o transcodificador y no las pasa a otros servidores CDN. </li></ul><br><p>  El servidor Origin permite publicar transmisiones WebRTC y RTMP o capturar transmisiones de otras fuentes a trav√©s de RTMP, RTSP u otros m√©todos disponibles. </p><br><p>  Los usuarios pueden reproducir transmisiones desde servidores Edge a trav√©s de WebRTC, RTMP, RTSP, HLS. </p><br><p>  Para minimizar la latencia, es deseable transmitir transmisiones entre servidores CDN utilizando WebRTC. </p><br><p>  La CDN est√°tica se describe completamente en la etapa de configuraci√≥n.  De hecho, la configuraci√≥n de un CDN est√°tica es similar a la configuraci√≥n de un equilibrador de carga: todos los receptores se enumeran en la configuraci√≥n del servidor de origen corriente. </p><br><p>  Por ejemplo, tenemos un servidor Origin en Frankfurt, un Edge en Nueva York y uno en Singapur. </p><br><p><img src="https://habrastorage.org/webt/so/gg/1w/sogg1wq1m_67p9waxgdyjbtix4y.png" alt="Ejemplo de CDN est√°tica"></p><br><p>  En este caso, Origin se configurar√° m√°s o menos as√≠: </p><br><pre><code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">loadbalancer</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">mode</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"roundrobin"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">stream_distribution</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"webrtc"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">node</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ip</span></span></span><span class="hljs-tag">&gt;</span></span>edge1.thestaticcdn.com<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ip</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">wss</span></span></span><span class="hljs-tag">&gt;</span></span>443<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">wss</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">node</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">node</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ip</span></span></span><span class="hljs-tag">&gt;</span></span>edge2.thestaticcdn.com<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ip</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">wss</span></span></span><span class="hljs-tag">&gt;</span></span>443<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">wss</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">node</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">loadbalancer</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Aqu√≠ viene el primer problema con el CDN est√°tico: para incluir en este tipo de CDN un nuevo servidor Edge o excluir un servidor de un CDN, es necesario modificar la configuraci√≥n y reiniciar todos los servidores de Origin. </p><br><p>  Las transmisiones publicadas en Origin se transmiten a todos los servidores Edge enumerados en la configuraci√≥n.  La decisi√≥n sobre a qu√© servidor Edge se conectar√° el usuario tambi√©n se toma en el servidor Origin.  Aqu√≠ viene el segundo problema: si hay pocos o ning√∫n espectador, por ejemplo, en Singapur es temprano en la noche, mientras que en Nueva York es la mitad de la noche, las transmisiones se transmitir√°n a Edge 1 de todos modos.  El tr√°fico se est√° desperdiciando sin ning√∫n prop√≥sito, y no es gratuito. </p><br><p>  Estos dos problemas se pueden resolver con Dynamic CDN. </p><br><p>  Ahora, queremos configurar el CDN sin reiniciar todos los servidores de Origin y no queremos transmitir transmisiones a servidores Edge sin usuarios conectados.  En este caso, no es necesario mantener la lista completa de servidores CDN en alg√∫n lugar de la configuraci√≥n.  Cada servidor debe crear dicha lista de forma independiente.  Para hacer esto, debe conocer el estado actual de los otros servidores en cualquier momento espec√≠fico. </p><br><p>  Idealmente, especificar el punto de entrada (el servidor que comienza el CDN) en la configuraci√≥n deber√≠a ser suficiente.  Durante el inicio, cada servidor debe enviar una solicitud a este punto de entrada y obtener en respuesta la lista de nodos CDN y secuencias publicadas.  Si no se puede acceder al punto de entrada, el servidor debe esperar los mensajes de otros servidores. <br>  El servidor debe comunicar cualquier cambio en su estado a otros servidores en la CDN. </p><br><h2 id="the-simplest-cdn-in-the-centre-of-europe">  El CDN m√°s simple: en el centro de Europa. </h2><br><p>  Ahora vamos a intentar configurar e iniciar un CDN din√°mico.  Supongamos primero que necesitamos entregar transmisiones de medios a los espectadores en Europa que cubren hasta 5000 usuarios.  Supongamos que la fuente de transmisi√≥n tambi√©n se encuentra en Europa </p><br><p><img src="https://habrastorage.org/webt/xo/oi/rx/xooirxhid75yiqsfuff8sdu5xge.png"></p><br><p>  Vamos a implementar tres servidores en un centro de datos con sede en Europa.  Utilizaremos instancias de Flashphoner WebCallServer (servidor de video de transmisi√≥n WebRTC) como componentes de ensamblaje de CDN </p><br><p><img src="https://habrastorage.org/webt/ts/de/4x/tsde4xzznh96b-15pb7pephsqlc.png"></p><br><p>  Configuraci√≥n: </p><br><ul><li>  Origen UE </li></ul><br><pre> <code class="plaintext hljs">cdn_enabled=true cdn_ip=o-eu1.flashponer.com cdn_nodes_resolve_ip=false cdn_role=origin</code> </pre> <br><ul><li>  Edge 1 EU </li></ul><br><pre> <code class="plaintext hljs">cdn_enabled=true cdn_ip=e-eu1.flashphoner.com cdn_point_of_entry=o-eu1.flashponer.com cdn_nodes_resolve_ip=false cdn_role=edge</code> </pre> <br><ul><li>  Edge 2 EU </li></ul><br><pre> <code class="plaintext hljs">cdn_enabled=true cdn_ip=e-eu2.flashphoner.com cdn_point_of_entry=o-eu1.flashponer.com cdn_nodes_resolve_ip=false cdn_role=edge</code> </pre> <br><p>  El intercambio de mensajes entre nodos din√°micos de CDN se implementa a trav√©s de Websocket, y Secure Websocket ciertamente tambi√©n es compatible. </p><br><p>  Las transmisiones dentro de CDN se transmiten a trav√©s de WebRTC.  Por lo general, UDP se usa como transporte, pero si es necesario garantizar una buena calidad de transmisi√≥n con el canal entre los servidores no tan bueno, es posible cambiar a TCP.  Desafortunadamente, en este caso, la latencia aumenta. <br>  Reinicie los servidores, abra el ejemplo de transmisi√≥n bidireccional en el servidor <code>o-eu1</code> , publique el video c√≠clico del temporizador de cuenta regresiva de 10 minutos a 0 </p><br><p><img src="https://habrastorage.org/webt/6s/s1/uq/6ss1uquwqf-a0nctys-rsc6p4xo.png"></p><br><p>  Abra el ejemplo del reproductor en el servidor <code>e-eu1</code> , reproduzca la transmisi√≥n </p><br><p><img src="https://habrastorage.org/webt/fc/3p/st/fc3pst40kkeh0gh0dunrcktlksg.png"></p><br><p>  y hacer lo mismo en <code>e-eu2</code> </p><br><p><img src="https://habrastorage.org/webt/el/j5/ew/elj5ew8cqvaxpvmbmr14wwl1dvu.png"></p><br><p>  ¬°El CDN est√° funcionando!  Como puede ver en las capturas de pantalla, el tiempo en el video coincide con el segundo tanto en la parte de publicaci√≥n como en la parte de visualizaci√≥n gracias a WebRTC y buenos canales. </p><br><h2 id="and-beyond-we-go-connecting-america">  Y m√°s all√° vamos: conectando Am√©rica </h2><br><p>  Ahora vamos a entregar transmisiones a los espectadores en el continente americano teniendo en cuenta tambi√©n la publicaci√≥n </p><br><p><img src="https://habrastorage.org/webt/y6/8r/ig/y68rigg5xu5uq32qmvrb2_6yexq.png"></p><br><p>  Implementaremos tres servidores en un centro de datos estadounidense sin cerrar la parte europea de CDN </p><br><p><img src="https://habrastorage.org/webt/t5/q8/vh/t5q8vh5mlwgvixiq_l-zdin6bje.png"></p><br><p>  Configuraci√≥n: </p><br><ul><li>  Origen de EE. UU. </li></ul><br><pre> <code class="plaintext hljs">cdn_enabled=true cdn_ip=o-us1.flashponer.com cdn_point_of_entry=o-eu1.flashponer.com cdn_nodes_resolve_ip=false cdn_role=origin</code> </pre> <br><ul><li>  Edge 1 US </li></ul><br><pre> <code class="plaintext hljs">cdn_enabled=true cdn_ip=e-us1.flashphoner.com cdn_point_of_entry=o-eu1.flashponer.com cdn_nodes_resolve_ip=false cdn_role=edge</code> </pre> <br><ul><li>  Edge 2 US </li></ul><br><pre> <code class="plaintext hljs">cdn_enabled=true cdn_ip=e-us2.flashphoner.com cdn_point_of_entry=o-eu1.flashponer.com cdn_nodes_resolve_ip=false cdn_role=edge</code> </pre> <br><p>  Reinicie los servidores estadounidenses, verifique la publicaci√≥n </p><br><p><img src="https://habrastorage.org/webt/6s/s1/uq/6ss1uquwqf-a0nctys-rsc6p4xo.png"></p><br><p>  y la reproducci√≥n </p><br><p><img src="https://habrastorage.org/webt/4i/ur/_s/4iur_sn57za5_ypd9pssupfg8rm.png"></p><br><p>  Tenga en cuenta que el segmento europeo sigue funcionando.  Vamos a verificar si los usuarios estadounidenses podr√°n ver la transmisi√≥n publicada desde Europa.  Publicaci√≥n de la secuencia <code>test_eu</code> en el servidor <code>o-eu1</code> </p><br><p><img src="https://habrastorage.org/webt/yp/dk/0o/ypdk0o9fnrje0kbmtx7-duhrkuo.png"></p><br><p>  y jugarlo en <code>e-us1</code> </p><br><p><img src="https://habrastorage.org/webt/ld/6n/u3/ld6nu3rzicqjotfzz88goggo1lk.png"></p><br><p>  ¬°Y esto tambi√©n est√° funcionando!  En cuanto a la latencia, las capturas de pantalla demuestran nuevamente la sincron√≠a del temporizador en el video en la parte de publicaci√≥n y en la parte de visualizaci√≥n al segundo. </p><br><p>  Tenga en cuenta que reproducir en un servidor de Origin las transmisiones publicadas en otro servidor de Origin no es posible de manera predeterminada, pero si es necesario, esto se puede configurar en consecuencia. </p><br><pre> <code class="plaintext hljs">cdn_origin_to_origin_route_propagation=true</code> </pre> <br><h2 id="to-be-continued">  Para continuar </h2><br><p>  En resumen, hemos implementado un CDN simple y luego lo hemos escalado con √©xito a dos continentes publicando y reproduciendo transmisiones WebRTC de baja latencia.  Para este prop√≥sito, no modificamos los par√°metros de transmisi√≥n en la reproducci√≥n, que a menudo se necesita en la vida real: todos los espectadores tienen canales diferentes, y para mantener la calidad de transmisi√≥n se necesita, por ejemplo, para reducir la resoluci√≥n o la tasa de bits  Nos ocuparemos de esto en la siguiente parte ... </p><br><h2 id="related-links">  Enlaces relacionados </h2><br><p>  <a href="https://flashphoner.com/web-call-server-on-digital-ocean-marketplace">Imagen de Flashphoner WebCallServer en DigitalOcean Marketplace</a> : imagen de Web Call Server en DigitalOcean. </p><br><p>  <a href="https://flashphoner.com/cdn-for-low-latency-webrtc-streaming">CDN para transmisi√≥n WebRTC de baja latencia</a> : red de entrega de contenido basada en Web Call Server. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/477304/">https://habr.com/ru/post/477304/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../477292/index.html">Eventos digitales en San Petersburgo del 25 de noviembre al 1 de diciembre</a></li>
<li><a href="../477294/index.html">Python para AI: una combinaci√≥n hecha en el cielo</a></li>
<li><a href="../477296/index.html">Funci√≥n Buildargv con Ragel</a></li>
<li><a href="../477298/index.html">Qu√© hay dentro del aeropuerto: centros de control</a></li>
<li><a href="../477300/index.html">Qu√© hay dentro del mejor aeropuerto regional del pa√≠s: servicios de terminal</a></li>
<li><a href="../477306/index.html">De producci√≥n a salario a producci√≥n a pedido. La secuencia de pasos y un ejemplo de implementaci√≥n pr√°ctica.</a></li>
<li><a href="../477308/index.html">Clon Numpy</a></li>
<li><a href="../477310/index.html">CDN din√°mico para transmisi√≥n WebRTC de baja latencia</a></li>
<li><a href="../477312/index.html">Desarrollo de juegos en redes sociales.</a></li>
<li><a href="../477314/index.html">Env√≠o de eventos desde ViewModel a Activity / Fragment en MVVM</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>