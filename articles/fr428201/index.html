<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üï§ üè° ‚öóÔ∏è Trous de taupe en JavaScript üîß üñãÔ∏è üèÇüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, Habr! Je vous pr√©sente la traduction de l'article "Trous de ver en JavaScript" de Mathius Buus. 





 Les ordinateurs sont des machines int√©...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Trous de taupe en JavaScript</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/428201/"><p>  Bonjour, Habr!  Je vous pr√©sente la traduction de l'article <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">"Trous de ver en JavaScript"</a> de Mathius Buus. </p><br><p><img src="https://habrastorage.org/webt/ak/t9/k_/akt9k_w0hs5lodk-p8ezfr4f6pk.jpeg"></p><br><p>  Les ordinateurs sont des machines int√©ressantes.  En th√©orie, ils nous semblent √™tre des math√©maticiens m√©caniques id√©aux travaillant avec des nombres et effectuant bien des op√©rations d'addition, de multiplication et de soustraction. </p><br><p>  Cependant, une telle abstraction est assez trompeuse.  Cela nous √©loigne de la compr√©hension qu'un ordinateur traite diff√©rentes op√©rations math√©matiques √† diff√©rentes vitesses.  Si vous √©crivez en JavaScript (ou dans tout autre langage) et que vous vous souciez des performances des algorithmes que vous avez √©crits, il est tr√®s important de comprendre comment les ordinateurs fonctionnent sous le capot. </p><br><p> Si nous savons de quoi l'ordinateur est capable, nous pouvons utiliser les chemins les plus courts ou les trous de ver pour rendre nos programmes beaucoup plus rapides que pr√©vu. </p><a name="habracut"></a><br><h2 id="krotovaya-nora-v-operacii-polucheniya-ostatka-ot-deleniya">  Wormhole dans l'op√©ration d'obtention du reste de la division </h2><br><p>  Qu'est-ce que cela signifie exactement?  Regardons un exemple: imaginons que nous voulons impl√©menter une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">liste de sonnerie</a> .  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Une liste en anneau</a> est une liste de taille fixe dans laquelle des insertions plus grandes que la taille de la liste sont d√©plac√©es vers le haut de la liste et dans un cercle.  Les listes de sonnerie sont tr√®s pratiques pour de nombreuses choses - telles que la collecte de statistiques pour des intervalles de temps sp√©cifiques, la mise en m√©moire tampon des donn√©es, etc., mais regardez cette impl√©mentation: </p><br><pre><code class="hljs php"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">list</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Array</span></span>(<span class="hljs-number"><span class="hljs-number">15000</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">set</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(i, item)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  % -   ,     //        //    ,     i    list[i % list.length] = item }</span></span></code> </pre> <br><p>  √Ä quelle vitesse ce code s'ex√©cute-t-il?  Lan√ßons un test de vitesse simple </p><br><pre> <code class="hljs matlab">console.time() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> &lt; <span class="hljs-number"><span class="hljs-number">1e9</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span>++) { set(<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">i</span></span>) } console.timeEnd()</code> </pre><br><p>  Sur mon ordinateur, il a fallu environ 4 secondes pour 1 milliard d'inserts.  Pas mal. </p><br><p>  Cependant, appliquons un trou de ver de calcul et changeons la taille du tableau en nombre magique: </p><br><pre> <code class="hljs powershell">//     <span class="hljs-number"><span class="hljs-number">15000</span></span>  <span class="hljs-number"><span class="hljs-number">16384</span></span> const list = new Array(<span class="hljs-number"><span class="hljs-number">16384</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">set</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(i, item)</span></span></span></span> { //  % -   ,     //        //    ,     i    list[<span class="hljs-type"><span class="hljs-type">i</span></span> % <span class="hljs-type"><span class="hljs-type">list.length</span></span>] = item }</code> </pre><br><p>  Essayons de relancer le test de performances.  Sur mon ordinateur, le test s'est termin√© en environ 1,5 seconde.  Plus du double d'augmentation gr√¢ce √† un simple redimensionnement.  Afin de comprendre pourquoi cela se produit, nous devons comprendre ce qui suit, sous le capot, l'ordinateur fonctionne avec des nombres de base 2. Il est important de savoir si nous obtenons le reste de la division (% d'op√©ration).  Un tel calcul est beaucoup plus simple si le nombre est un multiple de 2 (2 ^ n) b 16384 c'est 2 ^ 14. En fait, l'ordinateur regarde le nombre sous forme binaire et prend simplement les n derniers bits. </p><br><p>  Par exemple: que se passera-t-il lorsqu'une telle op√©ration sera effectu√©e 353 500% 16 384?  353 500 en repr√©sentation binaire ressemblera √† 1010110010011011100. Depuis 16384 == 2 ^ 14 - nous devons prendre les 14 derniers bits - 10101 (10010011011100) ou 9 346. </p><br><p>  Nous pouvons utiliser ces connaissances par rapport √† un autre trou de ver.  Pour un ordinateur, il est tr√®s simple et rapide de prendre les n derniers bits.  En fait, il suffit de produire binaire et (op√©ration &amp;) avec le nombre (2 ^ n) - 1 </p><br><pre> <code class="hljs php"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">list</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Array</span></span>(<span class="hljs-number"><span class="hljs-number">16384</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">set</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(i, item)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//    &amp;( )  %    2 ^ n list[i &amp; (list.length - 1)] = i }</span></span></code> </pre> <br><p>  En ex√©cutant √† nouveau le test de performances sur mon ordinateur, nous verrons que le temps d'ex√©cution diminuera √† ~ 1 s ou qu'il y aura une multiplication par quatre des performances par rapport √† la premi√®re ex√©cution.  Et tout cela gr√¢ce √† une compr√©hension du fonctionnement de l'ordinateur. </p><br><p>  Les compilateurs intelligents ou les machines virtuelles peuvent effectuer ce type d'optimisation en transformant l'op√©ration consistant √† obtenir le reste dans les coulisses en une op√©ration au niveau du bit et vice versa.  En fait, la derni√®re machine virtuelle V8 Javascript (non impl√©ment√©e dans NodeJS) fait exactement cela. </p><br><h2 id="chislovye-krotovye-nory">  Trou de ver num√©rique </h2><br><p>  Une autre taupe utile est de comprendre comment fonctionne la lecture et l'√©criture des nombres.  Rappelez-vous comment nous avons utilis√© des ordinateurs 32 bits et comment nous avons obtenu 64 bits?  Et jusqu'√† 32 bits, nous avions 16 bits.  Qu'est-ce que cela signifie exactement?  Habituellement, nous pensons √† cela de cette fa√ßon - combien de RAM nous avons sur l'ordinateur.  2 ^ 32 = 4294967296 ou 4 Go, ce qui signifie que nous ne pouvons acc√©der qu'√† 4 Go de m√©moire sur un ordinateur 32 bits.  Lorsque nous √©crivons un programme JS, nous n'avons g√©n√©ralement pas besoin d'y penser, car nous n'utilisons g√©n√©ralement pas autant de m√©moire. </p><br><p>  Cependant, il est tr√®s important de comprendre la diff√©rence entre les ordinateurs 32 bits et 64 bits.  √âtant donn√© que les processeurs ont re√ßu des registres 64 bits sur les ordinateurs 64 bits, les op√©rations sont devenues 2 fois plus rapides que sur les ordinateurs 32 bits, o√π vous n'aviez que des registres 32 bits. </p><br><p>  Comment pouvons-nous utiliser les informations sur ce trou de ver? <br>  √âcrivons un programme simple qui copie un Uint8Array dans un autre.  Si vous n'√™tes pas familier avec les tableaux Unit8Arrays, ils sont tr√®s similaires aux tampons dans NodeJS, ou tout simplement "nettoyer" la m√©moire. </p><br><pre> <code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">copy</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(input, output)</span></span></span></span> { //    <span class="hljs-built_in"><span class="hljs-built_in">input</span></span>.length &lt;= <span class="hljs-built_in"><span class="hljs-built_in">output</span></span>.length <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-built_in"><span class="hljs-built_in">input</span></span>.length; i++) { //   <span class="hljs-number"><span class="hljs-number">8</span></span>-  (<span class="hljs-built_in"><span class="hljs-built_in">byte</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">output</span></span>[i] = <span class="hljs-built_in"><span class="hljs-built_in">input</span></span>[i] } }</code> </pre> <br><p>  Encore une fois, mesurons la vitesse en ex√©cutant un test de performances. </p><br><pre> <code class="hljs pgsql">//    <span class="hljs-number"><span class="hljs-number">1</span></span>MB Uint8Arrays     const input = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Uint8Array(<span class="hljs-number"><span class="hljs-number">1024</span></span> * <span class="hljs-number"><span class="hljs-number">1024</span></span>) const output = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Uint8Array(<span class="hljs-number"><span class="hljs-number">1024</span></span> * <span class="hljs-number"><span class="hljs-number">1024</span></span>) console.time() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">1e4</span></span>; i++) { <span class="hljs-keyword"><span class="hljs-keyword">copy</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">input</span></span>, output) } console.timeEnd()</code> </pre><br><p>  Sur mon ordinateur, le programme s'est termin√© en environ 7,5 secondes.  Comment pouvons-nous utiliser un trou de ver pour acc√©l√©rer?  En utilisant Uint8Array, nous ne copions que 8 bits √† la fois, mais ayant un ordinateur 64 bits, nous pouvons copier 64 bits d'informations en m√™me temps.  Nous pouvons le faire en JavaScript en convertissant notre Uint8Array en Float64Array avant la copie, ce qui ne nous co√ªtera rien. </p><br><pre> <code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">copy</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(input, output)</span></span></span></span> { //    <span class="hljs-built_in"><span class="hljs-built_in">input</span></span>.length &lt;= <span class="hljs-built_in"><span class="hljs-built_in">output</span></span>.length //       <span class="hljs-number"><span class="hljs-number">64</span></span>-  //        , //      <span class="hljs-number"><span class="hljs-number">64</span></span>-  //  BigInts   JavaScript,    BigInt64Array. const input64 = new Float64Array(<span class="hljs-built_in"><span class="hljs-built_in">input</span></span>.buffer, <span class="hljs-built_in"><span class="hljs-built_in">input</span></span>.byteOffset, <span class="hljs-built_in"><span class="hljs-built_in">input</span></span>.length / <span class="hljs-number"><span class="hljs-number">8</span></span>) const output64 = new Float64Array(<span class="hljs-built_in"><span class="hljs-built_in">output</span></span>.buffer, <span class="hljs-built_in"><span class="hljs-built_in">output</span></span>.byteOffset, <span class="hljs-built_in"><span class="hljs-built_in">output</span></span>.length / <span class="hljs-number"><span class="hljs-number">8</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; input64.length; i++) { //   <span class="hljs-number"><span class="hljs-number">64</span></span>-  output64[i] = input64[i] } }</code> </pre><br><p>  En ex√©cutant √† nouveau des tests de performances, nous obtenons un temps d'ex√©cution de 1 seconde, ce qui donne une augmentation de 8 fois la vitesse. </p><br><p>  Pour la copie, une solution acceptable serait d'utiliser la m√©thode array.set (otherArray) pour Uint8Array, qui nous permet de copier en code natif - ce qui est beaucoup plus rapide que tout autre trou de ver.  Pour r√©f√©rence, cela donnera un r√©sultat de ~ 0,2 sec d'ex√©cution dans notre test sur mon ordinateur, ce qui est 5 fois plus rapide que la solution pr√©c√©dente. </p><br><h2 id="galaktika-javascript-polna-krotovyh-nor">  Une galaxie de JavaScript regorge de trous de ver </h2><br><p>  L'utilisation des trous de ver ci-dessus vous aidera √† rendre beaucoup plus rapide des tonnes d'algorithmes du monde r√©el.  Il existe de nombreux autres trous de ver.  Mon pr√©f√©r√© est <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Math.clz32</a> , une m√©thode qui renvoie le nombre de bits de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">d√©but</a> z√©ro dans une repr√©sentation binaire 32 bits d'un nombre.  Nous pouvons utiliser cette m√©thode pour de nombreux algorithmes int√©ressants.  Je l'ai utilis√© pour acc√©l√©rer la mise en ≈ìuvre des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">champs</a> de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">bits de</a> 4 fois, ce qui a entra√Æn√© une diminution de la consommation de m√©moire de 4 fois et m'a permis de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">trier les nombres</a> dans certaines situations beaucoup plus rapidement. </p><br><p>  Comprendre les principes de base de l'ordinateur vous permet d'√©crire les programmes les plus rapides dont nous avons besoin.  Cette connaissance est importante m√™me lorsque vous √©crivez dans un langage de haut niveau tel que JavaScript. </p><br><p>  <strong>PS:</strong> </p><br><p>  Remerciements particuliers pour l'aide √† la traduction et √† l'ajustement de la traduction vers <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Olga Pereverzeva</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr428201/">https://habr.com/ru/post/fr428201/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr428187/index.html">Comment √©crire une extension pour GNOME Shell: mode Ne pas d√©ranger</a></li>
<li><a href="../fr428189/index.html">Qu'est-ce qu'un paladin?</a></li>
<li><a href="../fr428191/index.html">Que devrions-nous organiser un hackathon, ou comment nous avons men√© un hackathon interne</a></li>
<li><a href="../fr428193/index.html">√Ä propos des tourn√©es</a></li>
<li><a href="../fr428197/index.html">Finances personnelles efficaces. Niveau 1</a></li>
<li><a href="../fr428203/index.html">Nous regardons les graphiques: estimations et pr√©visions pour le march√© du cloud computing, donn√©es en 2018</a></li>
<li><a href="../fr428205/index.html">Lifehacks NaviHaka</a></li>
<li><a href="../fr428209/index.html">Livre de recettes du d√©veloppeur: recettes de conception pilot√©e par domaine (partie 2, structure et interaction)</a></li>
<li><a href="../fr428211/index.html">Le livre ¬´Architecture √©volutive. Soutien au changement continu "</a></li>
<li><a href="../fr428213/index.html">Comment interpr√©ter les pr√©dictions de mod√®le dans SHAP</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>