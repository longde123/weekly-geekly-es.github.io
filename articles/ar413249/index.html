<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>âœŠğŸ» ğŸ•¹ï¸ ğŸšƒ ÙƒØªØ§Ø¨Ø© ÙˆØ­Ø¯Ø© Ù†ÙˆØ§Ø© Ù„ÙŠÙ†ÙƒØ³: I2C ğŸ‘¨â€ğŸ‘¦ ğŸ¤¸ğŸ¼ ğŸ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ù‡Ø¨Ø± ØŒ Ù…Ø±Ø­Ø¨Ø§Ù‹! 

 ØªØ±ÙƒØ² Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‚Ø§Ù„Ø© Ø¹Ù„Ù‰ ØªØ·ÙˆÙŠØ± ÙˆØ­Ø¯Ø© Ù†ÙˆØ§Ø© Ù„ÙŠÙ†ÙƒØ³ I2C (Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø©). ÙÙŠÙ…Ø§ ÙŠÙ„ÙŠ ÙˆØµÙ Ù„Ø¹Ù…Ù„ÙŠØ© ØªÙ†ÙÙŠØ° Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ I2C ØŒ Ø­ÙŠØ« ÙŠÙ…ÙƒÙ†Ùƒ ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ÙƒØªØ§Ø¨Ø© ÙˆØ­Ø¯Ø© Ù†ÙˆØ§Ø© Ù„ÙŠÙ†ÙƒØ³: I2C</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/413249/" style=";text-align:right;direction:rtl">  Ù‡Ø¨Ø± ØŒ Ù…Ø±Ø­Ø¨Ø§Ù‹! <br><br>  ØªØ±ÙƒØ² Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‚Ø§Ù„Ø© Ø¹Ù„Ù‰ ØªØ·ÙˆÙŠØ± ÙˆØ­Ø¯Ø© Ù†ÙˆØ§Ø© Ù„ÙŠÙ†ÙƒØ³ I2C (Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø©).  ÙÙŠÙ…Ø§ ÙŠÙ„ÙŠ ÙˆØµÙ Ù„Ø¹Ù…Ù„ÙŠØ© ØªÙ†ÙÙŠØ° Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ I2C ØŒ Ø­ÙŠØ« ÙŠÙ…ÙƒÙ†Ùƒ Ø¨Ø³Ù‡ÙˆÙ„Ø© Ø¥Ø¶Ø§ÙØ© ØªÙ†ÙÙŠØ° Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ©. <br><br>  Ù†Ø­Ù† Ù†ØµÙ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„: ÙƒØªÙ„Ø© I2C Ù„Ù„Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø¬Ø¯ÙŠØ¯ "Ø³Ù„ÙƒÙŠÙ‹Ø§" Ø¥Ù„Ù‰ FPGA ØŒ Ø§Ù„Ø°ÙŠ ÙŠØ¹Ù…Ù„ Ø¨Ù†Ø¸Ø§Ù… Linux Ø§Ù„Ø¥ØµØ¯Ø§Ø± 3.18.19 ÙˆØ§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø·Ø±ÙÙŠØ© (EEPROM AT24C64 Ùˆ BME280). <br><br>  Ù…Ø¨Ø¯Ø£ ØªØ´ØºÙŠÙ„ I2C Ø¨Ø³ÙŠØ· Ù„Ù„ØºØ§ÙŠØ© ØŒ ÙˆÙ„ÙƒÙ† Ø¥Ø°Ø§ ÙƒÙ†Øª Ø¨Ø­Ø§Ø¬Ø© Ø¥Ù„Ù‰ ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ø¹Ø±ÙØ© ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Ù‡Ù†Ø§</a> . <br><br><img src="https://habrastorage.org/webt/jq/rh/yg/jqrhyg8bveyubub7hysu0gxrkms.png"><br>  <i>Ø§Ù„Ø´ÙƒÙ„ 1. Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ù„ØªÙˆÙ‚ÙŠØª Ø¥Ø´Ø§Ø±Ø§Øª Ø§Ù„Ù†Ø§Ù‚Ù„ I2C</i> <br><a name="habracut"></a><br>  Ù‚Ø¨Ù„ Ø§Ù„Ø¨Ø¯Ø¡ ÙÙŠ ØªØ·ÙˆÙŠØ± Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„ØªØ´ØºÙŠÙ„ ØŒ Ø¯Ø¹Ù†Ø§ Ù†Ø±Ù‰ ÙƒÙŠÙ ØªØªÙØ§Ø¹Ù„ ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¹ ÙˆØ­Ø¯Ø© kernel ØŒ Ù„Ù‡Ø°Ø§: <br><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  Ù†Ù†ÙØ° ØªØ·Ø¨ÙŠÙ‚Ù‹Ø§ ØµØºÙŠØ±Ù‹Ø§ Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØŒ ÙˆØ§Ù„ØºØ±Ø¶ Ù…Ù†Ù‡ Ù‚Ø±Ø§Ø¡Ø© Ù…Ø¹Ø±Ù ØªØ³Ø¬ÙŠÙ„ I2C Ø§Ù„ÙØ±ÙŠØ¯ Ù„Ù„Ø¬Ù‡Ø§Ø².  Ø³ØªØªÙŠØ­ Ù„Ùƒ Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·ÙˆØ© ÙÙ‡Ù… Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªÙŠ ÙŠØªÙ… Ù…Ù† Ø®Ù„Ø§Ù„Ù‡Ø§ Ø§Ù„ØªØ¨Ø§Ø¯Ù„ Ø¨ÙŠÙ† ÙˆØ­Ø¯Ø© kernel ÙˆØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø› </li><li style=";text-align:right;direction:rtl"> Ø¯Ø¹ÙˆÙ†Ø§ Ù†ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø®ÙŠØ§Ø± Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ø¦Ù„ I2C Ø¨ÙˆØ§Ø³Ø·Ø© ÙˆØ­Ø¯Ø© Ø§Ù„Ù†ÙˆØ§Ø© Ø› </li><li style=";text-align:right;direction:rtl">  Ø¥Ø¶Ø§ÙØ© ÙˆØ­Ø¯Ø© kernel Ø¥Ù„Ù‰ Ø§Ù„ØªØ¬Ù…ÙŠØ¹ ÙˆÙˆØµÙ Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø´Ø¬Ø±Ø© Ø§Ù„Ø¬Ù‡Ø§Ø² Ø› </li><li style=";text-align:right;direction:rtl">  Ù†Ù‚ÙˆÙ… Ø¨ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¹Ø§Ù… (Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¹Ø¸Ù…ÙŠ) Ù„Ù„Ø³Ø§Ø¦Ù‚ I2C Ù…Ø¹ Ø¨Ø¹Ø¶ Ø§Ù„ØªÙØ³ÙŠØ±Ø§Øª. </li></ol><br>  Ù„Ø³ÙˆØ¡ Ø§Ù„Ø­Ø¸ ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø±ÙØ§Ù‚ Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù„Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„Ù…Ø·ÙˆØ±.  Ø£ÙŠØ¶Ø§ ØŒ Ø£ÙˆØ¯ Ø£Ù† Ø£Ø´ÙŠØ± Ø¥Ù„Ù‰ Ø£Ù†Ù‡ ØªÙ… ØªØºÙŠÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ÙˆØ§Ù„Ø£Ø³Ù…Ø§Ø¡ ÙˆØ¨Ø·Ø§Ù‚Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø§ØµØ© Ø¨ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ­ÙƒÙ….  Ù„Ù… ÙŠØªÙ… ØªØ¶Ù…ÙŠÙ† Ø­ØªÙ‰ Ù†ØµÙ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø·ÙˆØ±Ø© ÙÙŠ Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¹Ø¸Ù…ÙŠ Ù„Ù„Ø³Ø§Ø¦Ù‚ ØŒ ÙˆÙ…Ø¹ Ø°Ù„Ùƒ ØŒ ÙØ¥Ù† Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ù‡Ùˆ Ù†Ù‚Ø·Ø© Ø§Ù†Ø·Ù„Ø§Ù‚ Ø¬ÙŠØ¯Ø© Ù„Ù„ØªØ·ÙˆÙŠØ±.  ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£Ù…Ø«Ù„Ø© Ø¹Ù„Ù‰ Ø¨Ø±Ø§Ù…Ø¬ ØªØ´ØºÙŠÙ„ I2C <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Ù‡Ù†Ø§</a> . <br><br><h3 style=";text-align:right;direction:rtl">  <b>Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø£ÙˆÙ„Ù‰</b> </h3><br>  Ø£ÙˆÙ„Ø§Ù‹ ØŒ Ø¯Ø¹Ù†Ø§ Ù†ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø£Ø¯Ø§Ø© i2cdetect.  Ù†ØªÙŠØ¬Ø© i2cdetect Ù‡ÙŠ ÙƒÙ…Ø§ ÙŠÙ„ÙŠ: <br><pre style=";text-align:right;direction:rtl"><code class="cpp hljs">./i2cdetect -y <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span> abcdef <span class="hljs-number"><span class="hljs-number">00</span></span>: â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” <span class="hljs-number"><span class="hljs-number">10</span></span>: â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” <span class="hljs-number"><span class="hljs-number">20</span></span>: â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” <span class="hljs-number"><span class="hljs-number">30</span></span>: â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” <span class="hljs-number"><span class="hljs-number">40</span></span>: â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” <span class="hljs-number"><span class="hljs-number">50</span></span>: <span class="hljs-number"><span class="hljs-number">50</span></span> â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” <span class="hljs-number"><span class="hljs-number">60</span></span>: â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” <span class="hljs-number"><span class="hljs-number">70</span></span>: â€” â€” â€” â€” â€” â€” â€” â€”</code> </pre> <br>  ØªØ¹Ø±Ø¶ Ø§Ù„Ø£Ø¯Ø§Ø© Ø¨Ø§Ù„ØªØªØ§Ø¨Ø¹ Ù†Ø§Ù‚Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¹Ù„Ù‰ I2C ØŒ ÙˆØ¹Ù†Ø¯ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ© (ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø§Ù„Ø© ØŒ ØªÙƒÙˆÙ† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ© Ù‡ÙŠ ACK) ØŒ ØªØ¹Ø±Ø¶ Ø±Ù‚Ù… Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø§Ù‚Ù„ ÙÙŠ ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ­ÙƒÙ…. <br><br>  Ø³Ù†ÙƒØªØ¨ Ø¨Ø±Ù†Ø§Ù…Ø¬Ù‹Ø§ ØµØºÙŠØ±Ù‹Ø§ ÙŠÙ‚Ø±Ø£ Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„ÙØ±ÙŠØ¯ Ù„Ù…Ø³ØªØ´Ø¹Ø± Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø© ÙˆÙŠØ¹Ø±Ø¶ Ù†ØªÙŠØ¬Ø© Ø¹Ù…Ù„Ù‡ ÙÙŠ ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ­ÙƒÙ….  ØªØ¨Ø¯Ùˆ Ø¨Ø³ÙŠØ·Ø© Ù„Ù„ØºØ§ÙŠØ©: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;fcntl.h&gt; #include &lt;sys/ioctl.h&gt; #include &lt;linux/i2c.h&gt; #include &lt;linux/i2c-dev.h&gt; #define I2C_ADAPTER "/dev/i2c-0" int read_buffer(int fd) { struct i2c_rdwr_ioctl_data data; struct i2c_msg messages[2]; unsigned char write_buf[1] = {0xD0}, read_buf[1] = {0x00}; unsigned char write[200]; /* * .addr -   () * .flags -     (0 - w, 1 - r) * .len - - /  * .buf -      */ messages[0].addr = 0x50; messages[0].flags = 0; messages[0].len = 1; messages[0].buf = write_buf; messages[1].addr = 0x50; messages[1].flags = 1; messages[1].len = 1; messages[1].buf = read_buf; data.msgs = messages; data.nmsgs = 2; if (ioctl(fd, I2C_RDWR, &amp;data) &lt; 0) printf("Cant send data!\n"); else printf("ID = 0x%x\n", read_buf[0]); } int main(int argc, char **argv) { int fd; /* * Open I2C file descriptor. */ fd = open(I2C_ADAPTER, O_RDWR); if (fd &lt; 0) { printf("Unable to open i2c file\n"); return 0; } read_buffer(fd); return 0; }</span></span></span></span></code> </pre><br>  ÙŠØµØ¨Ø­ Ù…Ù† Ø§Ù„ÙˆØ§Ø¶Ø­ Ø£Ù† ÙˆØ­Ø¯Ø© kernel ØªØ³ØªÙ‚Ø¨Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø´ÙƒÙ„ Ø­Ù‚ÙˆÙ„ Ø±Ø³Ø§Ù„Ø© i2c_rdwr_ioctl_data.  ÙŠØ­ØªÙˆÙŠ Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø¹Ù„Ù‰ Ø­Ù‚ÙˆÙ„ Ù…Ø«Ù„ i2c_msg Ùˆ nmsgs ØŒ ÙˆØ§Ù„ØªÙŠ ØªÙØ³ØªØ®Ø¯Ù… Ù„Ù„Ø¥Ø±Ø³Ø§Ù„: <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  .addr - Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø¬Ù‡Ø§Ø² Ø› </li><li style=";text-align:right;direction:rtl">  .flags - Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© (Ù‚Ø±Ø§Ø¡Ø© Ø£Ùˆ ÙƒØªØ§Ø¨Ø©) Ø› </li><li style=";text-align:right;direction:rtl">  .len - Ø·ÙˆÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø› </li><li style=";text-align:right;direction:rtl">  .buf- Ø§Ù„Ø­Ø§ÙØ¸Ø©. </li></ul><br><h3 style=";text-align:right;direction:rtl">  <b>Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø«Ø§Ù†ÙŠØ©</b> </h3><br>  Ø§Ù„Ø¢Ù† ØŒ Ø£Ù†Ø§ Ù„Ø§ Ø£Ø®ÙˆØ¶ ÙÙŠ Ø§Ù„Ø¯ÙˆØ§Ø®Ù„ ØŒ ÙˆØ§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø¥ØµØ¯Ø§Ø± ÙˆØ§Ø­Ø¯ Ù…Ù† Ø¨Ø±Ù†Ø§Ù…Ø¬ ØªØ´ØºÙŠÙ„ I2C. <br>  ÙƒÙ…Ø§ ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ Ø¨Ø§Ù„ÙØ¹Ù„ ØŒ ØªØªÙ„Ù‚Ù‰ ÙˆØ­Ø¯Ø© kernel Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙÙŠ Ø´ÙƒÙ„ Ù‡ÙŠÙƒÙ„.  Ø¹Ù„Ù‰ Ø³Ø¨ÙŠÙ„ Ø§Ù„Ù…Ø«Ø§Ù„ ØŒ Ø¶Ø¹ ÙÙŠ Ø§Ø¹ØªØ¨Ø§Ø±Ùƒ Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¹Ù†Ø¯ Ø¥Ø¬Ø±Ø§Ø¡ Ø¹Ù…Ù„ÙŠØ© ÙƒØªØ§Ø¨Ø© (Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„ØªØ§Ø¨Ø¹ Ù„Ù„Ø£Ø¬Ù‡Ø²Ø©): <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© TX TXO Ø§Ù„Ø£ÙˆÙ„: ÙŠØ£ØªÙŠ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¬Ù‡Ø§Ø² Ø£ÙˆÙ„Ø§Ù‹ ØŒ Ø«Ù… ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© Ø› </li><li style=";text-align:right;direction:rtl">  ÙŠØªÙ… Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø­Ø§Ù„Ø© Ù…Ù‚Ø§Ø·Ø¹Ø© ISR ÙˆÙŠØªÙ… ØªÙ…ÙƒÙŠÙ† Ø§Ù„Ù…Ù‚Ø§Ø·Ø¹Ø§Øª ÙÙŠ Ø³Ø¬Ù„ IER (ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø§Ù„Ø© ØŒ ÙŠØ­Ø¯Ø« Ù…Ù‚Ø§Ø·Ø¹Ø© Ø¹Ù†Ø¯Ù…Ø§ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ TX FIFO) </li><li style=";text-align:right;direction:rtl">  ÙŠØ³Ù…Ø­ Ø¨Ù†Ù‚Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªØ¹ÙŠÙŠÙ† Ø¨Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø§Ù‚Ù„. </li></ul><br>  Ø³ÙŠØªÙ… Ø¥Ø¬Ø±Ø§Ø¡ ÙƒØ§ÙØ© Ø¹Ù…Ù„ÙŠØ§Øª ØªØ¨Ø§Ø¯Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø§Ø­Ù‚Ø© ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ù…Ù‚Ø§Ø·Ø¹Ø©. <br>  ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙŠ ØªØ¹Ù…Ù„ Ø¹Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Ù‡Ù†Ø§</a> .  Ø£ÙŠØ¶Ù‹Ø§ ØŒ Ù‚Ø¯ Ù„Ø§ ÙŠÙƒÙˆÙ† Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„ØªØ­ÙƒÙ… FIFO ØŒ ÙˆÙ„ÙƒÙ† ÙÙ‚Ø· Ø³Ø¬Ù„ Ù†Ù‚Ù„ ÙˆØ§Ø­Ø¯ ØŒ ÙˆÙ„ÙƒÙ† Ù‡Ø°Ù‡ Ø­Ø§Ù„Ø© Ø®Ø§ØµØ© Ù…Ø¹ Ø­Ø¬Ù… FIFO ÙŠØ³Ø§ÙˆÙŠ ÙˆØ§Ø­Ø¯. <br><br><h3 style=";text-align:right;direction:rtl">  <b>Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø«Ø§Ù„Ø«Ø©</b> </h3><br>  Ø£Ø¶Ù ÙˆØ­Ø¯Ø© kernel Ø¥Ù„Ù‰ Ø§Ù„ØªØ¬Ù…ÙŠØ¹ ÙˆÙˆØµÙ Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø´Ø¬Ø±Ø© Ø§Ù„Ø¬Ù‡Ø§Ø²: <br><br>  1. Ù‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ù…ØµØ¯Ø± ÙÙŠ Ø§Ù„Ø¯Ù„ÙŠÙ„ Ø§Ù„ØªØ§Ù„ÙŠ: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs">cd drivers/i2c/busses/ vim i2c-skel.c :wq</code> </pre><br>  Ù†ØªÙŠØ¬Ø© Ù„Ø°Ù„Ùƒ ØŒ ÙŠØ¸Ù‡Ø± Ø§Ù„Ù…Ù„Ù: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs">drivers/i2c/busses/i2c-skel.c</code> </pre><br><br>  2. Ø£Ø¶Ù ØªÙƒÙˆÙŠÙ† Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¥Ù„Ù‰ <i>Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„ØªØ´ØºÙŠÙ„ / i2c / busses / Kconfig</i> : <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs">config I2C_SKEL tristate <span class="hljs-string"><span class="hljs-string">"I2C adapter"</span></span> help If you say yes to <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> option, support will be included <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> the I2C interface.</code> </pre><br>  3. Ø£Ø¶Ù <i>Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† / i2c / busses / Makefile</i> driver Ø¥Ù„Ù‰ Ø§Ù„ØªØ¬Ù…ÙŠØ¹: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs">obj-$(CONFIG_I2C_SKEL) += i2c-skel.o</code> </pre><br>  4. Ø¥Ø¶Ø§ÙØ© ÙˆØµÙ ÙƒØªÙ„Ø© I2C Ø¥Ù„Ù‰ devicetree (* .dts) ØŒ ÙˆØ£ÙŠØ¶Ù‹Ø§ Ø¯Ø¹Ù… Ø¬Ù‡Ø§Ø² eeprom Ø¹Ù„Ù‰ Ø§Ù„ÙÙˆØ±: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"> i2c: i2c@f8f01d00 { compatible = <span class="hljs-string"><span class="hljs-string">"skel,skel-i2c"</span></span>; <span class="hljs-meta"><span class="hljs-meta">#address-cells = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;1&gt;; #size-cells = &lt;0&gt;; reg = &lt;0x43c00000 0x100&gt;; interrupt-parent = &lt;&amp;ps7_scugic_0&gt;; interrupts = &lt;0 29 4&gt;; clock-names = "skel-i2c"; clocks = &lt;&amp;clkc 38&gt;; clock-frequency = &lt;100000&gt;; 24c64@50 { compatible = "at,24c64"; pagesize = &lt;32&gt;; reg = &lt;0x50&gt;; }; } ;</span></span></span></span></code> </pre><br>  Ù„Ù† ÙŠØªÙ… Ø§Ù„Ù†Ø¸Ø± ÙÙŠ Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„Ù…Ø°ÙƒÙˆØ±Ø© Ø£Ø¹Ù„Ø§Ù‡ Ø¨Ø§Ù„ØªÙØµÙŠÙ„ ØŒ ÙˆÙ„ÙƒÙ† ÙŠÙ…ÙƒÙ† Ù„Ù„Ù‚Ø±Ø§Ø¡ Ø§Ù„ÙØ¶ÙˆÙ„ÙŠÙŠÙ† Ø¥Ù„Ù‚Ø§Ø¡ Ù†Ø¸Ø±Ø© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Ù‡Ù†Ø§</a> . <br><br><h3 style=";text-align:right;direction:rtl">  <b>Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø±Ø§Ø¨Ø¹Ø©</b> </h3><br>  Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ù…Ø¨Ø¯Ø£ Ø§Ù„Ø³Ø§Ø¦Ù‚ ØŒ Ø¯Ø¹Ù†Ø§ Ù†Ø¨Ø¯Ø£ ÙÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°. <br>  Ø£ÙˆÙ„Ø§Ù‹ ØŒ Ù‚Ù… Ø¨ØªÙˆØµÙŠÙ„ Ù…Ù„ÙØ§Øª Ø§Ù„Ø±Ø£Ø³ ØŒ ÙˆÙˆØµÙ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ "Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©" ØŒ ÙˆÙƒØ°Ù„Ùƒ Ø¹Ø±Ø¶ Ø¨Ø±Ù†Ø§Ù…Ø¬ ØªØ´ØºÙŠÙ„ I2C. <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* i2c-skel.c: I2C bus driver. * * Name Surname &lt;name@surname.ru&gt; * * This file is licensed under the terms of the GNU General Public License * version 2. This program is licensed "as is" without any warranty of any * kind, whether express or implied. */</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;linux/module.h&gt; #include &lt;linux/kernel.h&gt; #include &lt;linux/platform_device.h&gt; #include &lt;linux/i2c.h&gt; #include &lt;linux/io.h&gt; #include &lt;linux/clk.h&gt; #include &lt;linux/interrupt.h&gt; #include &lt;linux/time.h&gt; #include &lt;linux/delay.h&gt; #include &lt;linux/device.h&gt; /* * Registers description. */ #define SKEL_I2C_ID 0x00 /* Core Identifier register */ #define SKEL_I2C_ISR 0x14 /* Interrupt Status Register */ #define SKEL_I2C_ISR_DNE BIT(0) /* One byte transaction done */ #define SKEL_I2C_ISR_ARB BIT(1) /* Arbitration lost */ #define SKEL_I2C_ISR_TXE BIT(2) /* RX FIFO nearly full */ #define SKEL_I2C_ISR_NACK BIT(3) /* No ACK */ #define SKEL_I2C_IER 0x18 /* Interrupt Enable Register */ #define SKEL_I2C_IER_DNE BIT(0) /* Enable DNE IRQ */ #define SKEL_I2C_IER_ARB BIT(1) /* Enable ARB LOSR IRQ */ #define SKEL_I2C_IER_TXE BIT(2) /* Enable TX FIFO EPMTY IRQ */ #define SKEL_I2C_IER_NACK BIT(3) /* Enable NACK IRQ */ #define SKEL_I2C_CTRL 0x1C /* Control Register */ #define SKEL_I2C_CTRL_EN BIT(0) /* Enable I2C controller */ #define SKEL_I2C_CTRL_START BIT(1) /* Send START condition */ #define SKEL_I2C_CTRL_R BIT(2) /* Read command */ #define SKEL_I2C_CTRL_W BIT(3) /* Write command */ #define SKEL_I2C_CTRL_STOP BIT(4) /* Send STOP cindition */ #define SKEL_I2C_TX 0x20 /* TX FIFO */ #define SKEL_I2C_RX 0x24 /* RX FIFO */ #define SKEL_I2C_CLK 0x28 /* Clock Prescale Register*/ #define SKEL_I2C_TIMEOUT 100000 #define SKEL_I2C_XFER_TIMEOUT (msecs_to_jiffies(500)) #define FIFO_SIZE_TX 1024 #define FIFO_SIZE_RX 1024 int presc = -1; module_param(presc, int, S_IRUGO | S_IWUSR); /* * skel_i2c - I2C device context * @base: pointer to register struct * @msg: pointer to current message * @mlen: number of bytes transferred in msg * @dev: device reference * @adap: i2c core abstraction * @msg_complete: xfer completion object * @clk: reference for i2c input clock * @err: error occured * @buf: ptr to msg buffer * @bus_clock: current i2c bus clock rate * @lock: spinlock for IRQ synchronization */ struct skel_i2c { void __iomem *base; struct i2c_msg *msg; size_t mlen; struct device *dev; struct i2c_adapter adap; struct completion msg_complete; struct clk *clk; u32 bus_clock; int err; u32 addr; u8 *buf; spinlock_t lock; };</span></span></span></span></code> </pre><br>  Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ­ÙƒÙ… Ù‡ÙŠ: <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  Ø³Ø¬Ù„ Ø§Ù„ØªØ­ÙƒÙ… (CTRL) - Ø³Ø¬Ù„ Ø§Ù„ØªØ­ÙƒÙ… Ø› </li><li style=";text-align:right;direction:rtl">  Ø³Ø¬Ù„ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù‚Ø§Ø·Ø¹Ø© (ISR) - Ø³Ø¬Ù„ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù‚Ø§Ø·Ø¹Ø© Ø› </li><li style=";text-align:right;direction:rtl">  ØªØ³Ø¬ÙŠÙ„ ØªÙ…ÙƒÙŠÙ† Ø§Ù„Ù…Ù‚Ø§Ø·Ø¹Ø© (IER) - ØªØ³Ø¬ÙŠÙ„ Ù‚Ù†Ø§Ø¹ Ø§Ù„Ù…Ù‚Ø§Ø·Ø¹Ø©. </li></ul><br>  Ù‚Ù„Ø¨ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ù‡Ùˆ Ù‡ÙŠÙƒÙ„ skel_i2c ØŒ Ø§Ù„Ø°ÙŠ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø­Ù‚ÙˆÙ„ Ù…Ø«Ù„: <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  .base - Ø§Ù„Ù…Ø¤Ø´Ø± Ø¥Ù„Ù‰ Ø¨Ø¯Ø§ÙŠØ© Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø› </li><li style=";text-align:right;direction:rtl">  .msg - Ù…Ø¤Ø´Ø± Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø› </li><li style=";text-align:right;direction:rtl">  .adap - ØªØ¬Ø±ÙŠØ¯ I2C <a href="">(Ø§Ù†Ù‚Ø±)</a> . </li></ul><br>  Ø¯Ø¹Ù†Ø§ Ù†Ù†ØªÙ‚Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø£ÙƒØ«Ø± Ø¹Ù…Ù„ÙŠØ© ØŒ ÙˆØµÙ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ØªÙŠ ÙŠØ¯Ø¹Ù…Ù‡Ø§ Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„ØªØ´ØºÙŠÙ„ ØŒ <br>  ÙˆØ¸Ø§Ø¦Ù Ù…Ø­ÙˆÙ„ I2C ÙˆÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø© I2C: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">of_device_id</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">skel_i2c_match</span></span></span><span class="hljs-class">[] = {</span></span> { .compatible = <span class="hljs-string"><span class="hljs-string">"skel,skel-i2c"</span></span>, }, { .compatible = <span class="hljs-string"><span class="hljs-string">"at,24c64"</span></span>, }, {}, }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> u32 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">skel_i2c_func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct i2c_adapter *adap)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> I2C_FUNC_I2C | I2C_FUNC_SMBUS_EMUL; } <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i2c_algorithm</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">skel_i2c_algo</span></span></span><span class="hljs-class"> = {</span></span> .master_xfer = skel_i2c_xfer, .functionality = skel_i2c_func, }; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">platform_driver</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">skel_i2c_driver</span></span></span><span class="hljs-class"> = {</span></span> .probe = skel_i2c_probe, .remove = skel_i2c_remove, .driver = { .name = <span class="hljs-string"><span class="hljs-string">"skel-i2c"</span></span>, .of_match_table = skel_i2c_match, }, }; module_platform_driver(skel_i2c_driver); MODULE_AUTHOR(<span class="hljs-string"><span class="hljs-string">"Name Surname"</span></span>); MODULE_DESCRIPTION(<span class="hljs-string"><span class="hljs-string">"I2C bus driver"</span></span>); MODULE_LICENSE(<span class="hljs-string"><span class="hljs-string">"GPL"</span></span>); MODULE_ALIAS(<span class="hljs-string"><span class="hljs-string">"platform:skel-i2c"</span></span>);</code> </pre><br>  Ù…Ù† Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù‡ÙŠØ§ÙƒÙ„ ÙˆØ§Ù„ÙˆØ¸Ø§Ø¦Ù ØŒ Ø§Ù„ØºØ±Ø¶ Ù…Ù†Ù‡Ø§ ÙˆØ§Ø¶Ø­ ØŒ Ù†Ø­Ù† Ù†ØµÙ Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙÙ‚Ø· Ù…Ù† Ø£Ø¹Ù„Ø§Ù‡: <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  skel_i2c_driver - ÙŠØµÙ Ø§Ø³Ù… Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„ØªØ´ØºÙŠÙ„ ØŒ ÙˆÙ‡Ùˆ Ø¬Ø¯ÙˆÙ„ Ø¨Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© ÙˆØ§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…Ø© Ø§Ù„ØªÙŠ ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡Ø§ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ ÙˆØ­Ø¯Ø© kernel Ø£Ùˆ Ø¥Ø²Ø§Ù„ØªÙ‡Ø§ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù…. </li></ul><br>  Ø­Ø§Ù† Ø§Ù„ÙˆÙ‚Øª Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„ØªØ´ØºÙŠÙ„ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… ØŒ Ù…Ù…Ø§ ÙŠØ¹Ù†ÙŠ ØªÙ†ÙÙŠØ° ÙˆØ¸ÙŠÙØ© ØªÙ‡ÙŠØ¦Ø© ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ­ÙƒÙ… ØŒ ÙˆØ£ÙŠØ¶Ù‹Ø§ ÙˆØµÙ skel_i2c_probe (ÙŠØ³Ù…Ù‰ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„ØªØ´ØºÙŠÙ„ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…) Ùˆ skel_i2c_remove (ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡ Ø¹Ù†Ø¯ Ø¥Ø²Ø§Ù„Ø© Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„ØªØ´ØºÙŠÙ„ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù…). <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">skel_i2c_init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct skel_i2c *rdev)</span></span></span><span class="hljs-function"> </span></span>{ u32 bus_clk_khz = rdev-&gt;bus_clock / <span class="hljs-number"><span class="hljs-number">1000</span></span>; u32 clk_khz = clk_get_rate(rdev-&gt;clk) / <span class="hljs-number"><span class="hljs-number">1000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> prescale; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> diff; prescale = clk_khz / (<span class="hljs-number"><span class="hljs-number">5</span></span> * bus_clk_khz) - <span class="hljs-number"><span class="hljs-number">1</span></span>; prescale = clamp(prescale, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0xFFFF</span></span>); diff = clk_khz / (<span class="hljs-number"><span class="hljs-number">5</span></span> * (prescale <span class="hljs-number"><span class="hljs-number">1</span></span>)) - bus_clk_khz; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">abs</span></span>(diff) &gt; bus_clk_khz / <span class="hljs-number"><span class="hljs-number">10</span></span>) { dev_err(rdev-&gt;dev, <span class="hljs-string"><span class="hljs-string">"Unsupported clock settings: clk: %d KHz, bus: %d KHz\n"</span></span>, clk_khz, bus_clk_khz); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -EINVAL; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (presc != <span class="hljs-number"><span class="hljs-number">-1</span></span>) i2c_write(presc, rdev-&gt;base, SKEL_I2C_CLK); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> i2c_write(prescale, rdev-&gt;base, SKEL_I2C_CLK); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">skel_i2c_probe</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct platform_device *pdev)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">skel_i2c</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rdev</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NULL</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">res</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> irq, ret; u32 val; rdev = devm_kzalloc(&amp;pdev-&gt;dev, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(*rdev), GFP_KERNEL); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!rdev) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -ENOMEM; res = platform_get_resource(pdev, IORESOURCE_MEM, <span class="hljs-number"><span class="hljs-number">0</span></span>); rdev-&gt;base = devm_ioremap_resource(&amp;pdev-&gt;dev, res); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (IS_ERR(rdev-&gt;base)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> PTR_ERR(rdev-&gt;base); irq = platform_get_irq(pdev, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (irq &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { dev_err(&amp;pdev-&gt;dev, <span class="hljs-string"><span class="hljs-string">"Missing interrupt resource\n"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> irq; } rdev-&gt;clk = devm_clk_get(&amp;pdev-&gt;dev, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (IS_ERR(rdev-&gt;clk)) { dev_err(&amp;pdev-&gt;dev, <span class="hljs-string"><span class="hljs-string">"Missing clock\n"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> PTR_ERR(rdev-&gt;clk); } rdev-&gt;dev = &amp;pdev-&gt;dev; init_completion(&amp;rdev-&gt;msg_complete); spin_lock_init(&amp;rdev-&gt;lock); val = of_property_read_u32(pdev-&gt;dev.of_node, <span class="hljs-string"><span class="hljs-string">"clock-frequency"</span></span>, &amp;rdev-&gt;bus_clock); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (val) { dev_err(&amp;pdev-&gt;dev, <span class="hljs-string"><span class="hljs-string">"Default to 100kHz\n"</span></span>); rdev-&gt;bus_clock = <span class="hljs-number"><span class="hljs-number">100000</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* default clock rate */</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rdev-&gt;bus_clock &gt; <span class="hljs-number"><span class="hljs-number">400000</span></span>) { dev_err(&amp;pdev-&gt;dev, <span class="hljs-string"><span class="hljs-string">"Invalid clock-frequency %d\n"</span></span>, rdev-&gt;bus_clock); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -EINVAL; } ret = devm_request_irq(&amp;pdev-&gt;dev, irq, skel_i2c_isr, <span class="hljs-number"><span class="hljs-number">0</span></span>, pdev-&gt;name, rdev); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ret) { dev_err(&amp;pdev-&gt;dev, <span class="hljs-string"><span class="hljs-string">"Failed to claim IRQ %d\n"</span></span>, irq); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ret; } ret = clk_prepare_enable(rdev-&gt;clk); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ret) { dev_err(&amp;pdev-&gt;dev, <span class="hljs-string"><span class="hljs-string">"Failed to enable clock\n"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ret; } skel_i2c_init(rdev); i2c_set_adapdata(&amp;rdev-&gt;adap, rdev); strlcpy(rdev-&gt;adap.name, pdev-&gt;name, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(rdev-&gt;adap.name)); rdev-&gt;adap.owner = THIS_MODULE; rdev-&gt;adap.algo = &amp;skel_i2c_algo; rdev-&gt;adap.dev.parent = &amp;pdev-&gt;dev; rdev-&gt;adap.dev.of_node = pdev-&gt;dev.of_node; platform_set_drvdata(pdev, rdev); ret = i2c_add_adapter(&amp;rdev-&gt;adap); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ret) { clk_disable_unprepare(rdev-&gt;clk); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ret; } dev_info(&amp;pdev-&gt;dev, <span class="hljs-string"><span class="hljs-string">"I2C probe complete\n"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">skel_i2c_remove</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct platform_device *pdev)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">skel_i2c</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rdev</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">platform_get_drvdata</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pdev</span></span></span><span class="hljs-class">);</span></span> clk_disable_unprepare(rdev-&gt;clk); i2c_del_adapter(&amp;rdev-&gt;adap); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre><br>  Ø£Ø¨Ø³Ø· ÙˆØ¸ÙŠÙØ© Ù‡ÙŠ skel_i2c_remove ØŒ ÙˆØ§Ù„ØªÙŠ ØªØ¹Ù…Ù„ Ø¹Ù„Ù‰ Ø¥ÙŠÙ‚Ø§Ù ØªØ´ØºÙŠÙ„ Ù…ØµØ¯Ø± Ø§Ù„Ø³Ø§Ø¹Ø© ÙˆØªØ­Ø±ÙŠØ± Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©.  ØªÙ‚ÙˆÙ… Ø§Ù„Ø¯Ø§Ù„Ø© skel_i2c_init Ø¨ØªÙ‡ÙŠØ¦Ø© ÙˆØ­Ø¯Ø© ØªØ­ÙƒÙ… I2C. <br><br>  ÙƒÙ…Ø§ Ø°ÙƒØ±Ù†Ø§ Ø³Ø§Ø¨Ù‚Ù‹Ø§ ØŒ ÙŠØ³Ø¬Ù„ skel_i2c_probe Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„ØªØ´ØºÙŠÙ„ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù….  ÙŠÙ…ÙƒÙ† ØªÙ‚Ø³ÙŠÙ… ØªØ³Ù„Ø³Ù„ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª ØŒ Ù…Ø´Ø±ÙˆØ·Ù‹Ø§ ØŒ Ø¥Ù„Ù‰ Ù…Ø±Ø­Ù„ØªÙŠÙ†: <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆØªØ³Ø¬ÙŠÙ„ Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ù…Ù‚Ø§Ø·Ø¹Ø© skel_i2c_isr Ø› </li><li style=";text-align:right;direction:rtl">  Ù…Ù„Ø¡ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù‡ÙŠÙƒÙ„ ÙˆØ§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¥Ø¬Ø±Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ù…Ø­ÙˆÙ„ I2C Ø¬Ø¯ÙŠØ¯. </li></ul><br>  Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„ØªØ´ØºÙŠÙ„ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… ØŒ ÙŠÙ…ÙƒÙ†Ùƒ ØªÙ†ÙÙŠØ° Ù…Ù†Ø·Ù‚ Ù†Ù‚Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">i2c_write</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> value, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *base, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> addr)</span></span></span><span class="hljs-function"> </span></span>{ writel(value, base addr); <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> defined DEBUG dev_dbg(rdev-&gt;dev, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"iowrite32(0x%x, base 0x%x);\n"</span></span></span><span class="hljs-meta">, value, addr); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> } static inline uint32_t i2c_read(void *base, uint32_t addr) { uint32_t reg = readl(base addr); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> defined DEBUG dev_dbg(rdev-&gt;dev, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/* ioread32(base 0x%x) == 0x%x */\n"</span></span></span><span class="hljs-meta">, addr, reg); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> return reg; } static irqreturn_t skel_i2c_isr(int irq, void *dev) { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (unlikely(int_stat &amp; skel_I2C_ISR_ARB)) { } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (unlikely(int_stat &amp; skel_I2C_ISR_NACK)) { } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (read) fill_rx_fifo(rdev); </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> fill_tx_fifo(rdev); complete(&amp;rdev-&gt;msg_complete); return IRQ_HANDLED; } static int skel_i2c_xfer_msg(struct skel_i2c *rdev, struct i2c_msg *msg) { unsigned long time; rdev-&gt;msg = msg; rdev-&gt;mlen = msg-&gt;len; rdev-&gt;addr = msg-&gt;addr; rdev-&gt;buf = msg-&gt;buf; rdev-&gt;err = 0; reinit_completion(&amp;rdev-&gt;msg_complete); skel_i2c_start_trans(rdev, msg); time = wait_for_completion_timeout(&amp;rdev-&gt;msg_complete, skel_I2C_XFER_TIMEOUT); </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (time == 0) rdev-&gt;err = -ETIMEDOUT; rdev-&gt;curr; return rdev-&gt;err; } static int skel_i2c_xfer(struct i2c_adapter *adap, struct i2c_msg *msgs, int num) { struct skel_i2c *rdev = i2c_get_adapdata(adap); int i, ret = 0; for (i = 0; (ret == 0) &amp;&amp; (i &lt; num); i) ret = skel_i2c_xfer_msg(rdev, msgs); skel_i2c_snd_stop(rdev); return ret ? : num; }</span></span></code> </pre><br>  ØªØµÙ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø£ÙˆÙ„Ù‰ ØªÙØ§Ø¹Ù„ ØªØ·Ø¨ÙŠÙ‚ Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¹ ÙˆØ­Ø¯Ø© Ù†ÙˆØ§Ø© Ø§Ù„Ù†Ø¸Ø§Ù….  Ø¨Ø¹Ø¯ Ø£Ù† Ù‚Ù…Ù†Ø§ Ø¨ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¹ÙˆØ§Ù…Ù„ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© Ù„Ù„Ø³Ø§Ø¦Ù‚ ØŒ Ù…Ù† Ø§Ù„Ø³Ù‡Ù„ Ø±Ø¤ÙŠØ© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªÙŠ ÙŠØªÙ… Ù…Ù† Ø®Ù„Ø§Ù„Ù‡Ø§ Ø§Ù„ØªØ¨Ø§Ø¯Ù„.  Ø¨Ø´ÙƒÙ„ Ø¹Ø§Ù… ØŒ ÙŠØªÙ… ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø­Ùˆ Ø§Ù„ØªØ§Ù„ÙŠ: <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  skel_i2c_xfer - ØªØ³ØªÙ‚Ø¨Ù„ Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ ÙˆØªÙ†Ù‚Ù„ ÙƒÙ„ Ø±Ø³Ø§Ù„Ø© Ø¨Ø§Ù„ØªØªØ§Ø¨Ø¹ Ø¥Ù„Ù‰ skel_i2c_xfer_msg.  Ø¥Ø°Ø§ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù†Ù‚Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØŒ ÙŠØªÙˆÙ‚Ù Ù†Ù‚Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø› </li><li style=";text-align:right;direction:rtl">  skel_i2c_xfer_msg - ØªÙ‚ÙˆÙ… Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø¨ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ© ÙˆØªØ¨Ø¯Ø£ Ø¨Ø¯Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø› </li><li style=";text-align:right;direction:rtl">  skel_i2c_isr - Ø±ÙˆØªÙŠÙ† Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù‚Ø§Ø·Ø¹Ø©.  Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø°ÙŠ ÙŠØªÙ… ÙÙŠÙ‡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ÙˆØ§ØªØµØ§Ù„Ø§Øª Ø§Ù„Ù†Ø§Ù‚Ù„.  Ø¥Ø°Ø§ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ / Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØŒ ÙŠØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ù„Ù… Ø§Ù„Ù…Ù†Ø¬Ø² Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø§Ù„ÙƒØ§Ù…Ù„Ø© ØŒ ÙˆØ§Ù„ØªÙŠ ØªØ´ÙŠØ± Ø¥Ù„Ù‰ Ø§ÙƒØªÙ…Ø§Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©. </li></ul><br>  Ù„Ø§ ØªØµÙ Ø§Ù„Ù…Ù‚Ø§Ù„Ø© Ø¨Ø¹Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© Ù„Ù„Ø¹Ù…Ù„.  Ø¹Ù„Ù‰ Ø³Ø¨ÙŠÙ„ Ø§Ù„Ù…Ø«Ø§Ù„ ØŒ ØªØ³Ù„Ø³Ù„ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØŒ Ø­ÙŠØ« Ø£Ù† ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©.  Ø±ÙƒØ²Ù†Ø§ Ø¹Ù„Ù‰ ØªÙ†ÙÙŠØ° Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø¹Ø§Ù… Ù…Ù† Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„ØªØ´ØºÙŠÙ„ ØŒ Ø¨ØºØ¶ Ø§Ù„Ù†Ø¸Ø± Ø¹Ù† Ù…ÙŠØ²Ø§Øª Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ØªØ­ÙƒÙ…. <br><br>  ÙŠØªÙ… Ø¥Ø±ÙØ§Ù‚ Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¹Ø¸Ù…ÙŠ Ù„Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„ÙƒØ§Ù…Ù„ Ø£Ø¯Ù†Ø§Ù‡.  Ù…Ù† ÙØ¶Ù„Ùƒ ØŒ Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª Ø£Ø®Ø·Ø§Ø¡ / Ø¹Ø¯Ù… Ø¯Ù‚Ø© ØŒ Ø£Ùˆ Ù„Ø¯ÙŠÙƒ Ø´ÙŠØ¡ Ù„ØªØ¶ÙŠÙÙ‡ ØŒ Ø§ÙƒØªØ¨Ù‡ ÙÙŠ PM Ø£Ùˆ ÙÙŠ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª. <br><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">Ù‡ÙŠÙƒÙ„ Ø¹Ø¸Ù…ÙŠ Ù„Ù„Ø³Ø§Ø¦Ù‚</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* i2c-skel.c: I2C bus driver. * * Name Surname &lt;name@surname.ru&gt; * * This file is licensed under the terms of the GNU General Public License * version 2. This program is licensed "as is" without any warranty of any * kind, whether express or implied. */</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;linux/module.h&gt; #include &lt;linux/kernel.h&gt; #include &lt;linux/platform_device.h&gt; #include &lt;linux/i2c.h&gt; #include &lt;linux/io.h&gt; #include &lt;linux/clk.h&gt; #include &lt;linux/interrupt.h&gt; #include &lt;linux/time.h&gt; #include &lt;linux/delay.h&gt; #include &lt;linux/device.h&gt; /* * Registers description. */ #define SKEL_I2C_ID 0x00 /* Core Identifier register */ #define SKEL_I2C_ISR 0x14 /* Interrupt Status Register */ #define SKEL_I2C_ISR_DNE BIT(0) /* One byte transaction done */ #define SKEL_I2C_ISR_ARB BIT(1) /* Arbitration lost */ #define SKEL_I2C_ISR_TXE BIT(2) /* RX FIFO nearly full */ #define SKEL_I2C_ISR_NACK BIT(3) /* No ACK */ #define SKEL_I2C_IER 0x18 /* Interrupt Enable Register */ #define SKEL_I2C_IER_DNE BIT(0) /* Enable DNE IRQ */ #define SKEL_I2C_IER_ARB BIT(1) /* Enable ARB LOSR IRQ */ #define SKEL_I2C_IER_TXE BIT(2) /* Enable TX FIFO EPMTY IRQ */ #define SKEL_I2C_IER_NACK BIT(3) /* Enable NACK IRQ */ #define SKEL_I2C_CTRL 0x1C /* Control Register */ #define SKEL_I2C_CTRL_EN BIT(0) /* Enable I2C controller */ #define SKEL_I2C_CTRL_START BIT(1) /* Send START condition */ #define SKEL_I2C_CTRL_R BIT(2) /* Read command */ #define SKEL_I2C_CTRL_W BIT(3) /* Write command */ #define SKEL_I2C_CTRL_STOP BIT(4) /* Send STOP cindition */ #define SKEL_I2C_TX 0x20 /* TX FIFO */ #define SKEL_I2C_RX 0x24 /* RX FIFO */ #define SKEL_I2C_CLK 0x28 /* Clock Prescale Register*/ #define SKEL_I2C_TIMEOUT 100000 #define SKEL_I2C_XFER_TIMEOUT (msecs_to_jiffies(500)) #define FIFO_SIZE_TX 1024 #define FIFO_SIZE_RX 1024 int presc = -1; module_param(presc, int, S_IRUGO | S_IWUSR); /* * skel_i2c - I2C device context * @base: pointer to register struct * @msg: pointer to current message * @mlen: number of bytes transferred in msg * @dev: device reference * @adap: i2c core abstraction * @msg_complete: xfer completion object * @clk: reference for i2c input clock * @err: error occured * @buf: ptr to msg buffer * @bus_clock: current i2c bus clock rate * @lock: spinlock for IRQ synchronization */ struct skel_i2c { void __iomem *base; struct i2c_msg *msg; size_t mlen; struct device *dev; struct i2c_adapter adap; struct completion msg_complete; struct clk *clk; u32 bus_clock; int err;; u32 addr; u8 *buf; spinlock_t lock; }; static const struct of_device_id skel_i2c_match[] = { { .compatible = "skel,skel-i2c", }, { .compatible = "at,24c64", }, {}, }; static inline void i2c_write(uint32_t value, void *base, uint32_t addr) { writel(value, base + addr); #if defined DEBUG dev_dbg(rdev-&gt;dev, "iowrite32(0x%x, base 0x%x);\n", value, addr); #endif } static inline uint32_t i2c_read(void *base, uint32_t addr) { uint32_t reg = readl(base + addr); #if defined DEBUG dev_dbg(rdev-&gt;dev, "/* ioread32(base 0x%x) == 0x%x */\n", addr, reg); #endif return reg; } static void skel_i2c_transfer(struct skel_i2c *rdev, u32 data) { i2c_write(data, rdev-&gt;base, SKEL_I2C_TX); } static void fill_tx_fifo(struct skel_i2c *rdev) { size_t tx_fifo_avail = FIFO_SIZE_TX; int bytes_to_transfer = min(tx_fifo_avail, rdev-&gt;mlen); while (bytes_to_transfer-- &gt; 0) { skel_i2c_transfer(rdev, *rdev-&gt;buf); rdev-&gt;mlen--; } } static void fill_rx_fifo(struct skel_i2c *rdev) { size_t rx_fifo_avail = FIFO_SIZE_RX; int receive = min(rx_fifo_avail, rdev-&gt;mlen); while (receive-- &gt; 0) { *rdev-&gt;buf = i2c_read(rdev-&gt;base, SKEL_I2C_RX); rdev-&gt;mlen--; } } void skel_i2c_snd_stop(struct skel_i2c *rdev) { u32 control = i2c_read(rdev-&gt;base, SKEL_I2C_CTRL); i2c_write(control | SKEL_I2C_CTRL_STOP, rdev-&gt;base, SKEL_I2C_CTRL); } static irqreturn_t skel_i2c_isr(int irq, void *dev) { struct skel_i2c *rdev = dev; u32 int_stat, read; int_stat = i2c_read(rdev-&gt;base, SKEL_I2C_ISR); read = rdev-&gt;msg-&gt;flags &amp; I2C_M_RD; if (unlikely(int_stat &amp; SKEL_I2C_ISR_ARB)) { } else if (unlikely(int_stat &amp; SKEL_I2C_ISR_NACK)) { } if (read) fill_rx_fifo(rdev); else fill_tx_fifo(rdev); complete(&amp;rdev-&gt;msg_complete); return IRQ_HANDLED; } static void skel_i2c_start_trans(struct skel_i2c *rdev, struct i2c_msg *msg) { } static int skel_i2c_xfer_msg(struct skel_i2c *rdev, struct i2c_msg *msg) { unsigned long time; rdev-&gt;msg = msg; rdev-&gt;mlen = msg-&gt;len; rdev-&gt;addr = msg-&gt;addr; rdev-&gt;buf = msg-&gt;buf; rdev-&gt;err = 0; reinit_completion(&amp;rdev-&gt;msg_complete); skel_i2c_start_trans(rdev, msg); time = wait_for_completion_timeout(&amp;rdev-&gt;msg_complete, SKEL_I2C_XFER_TIMEOUT); if (time == 0) rdev-&gt;err = -ETIMEDOUT; return rdev-&gt;err; } static int skel_i2c_init(struct skel_i2c *rdev) { u32 bus_clk_khz = rdev-&gt;bus_clock / 1000; u32 clk_khz = clk_get_rate(rdev-&gt;clk) / 1000; int prescale; int diff; prescale = clk_khz / (5 * bus_clk_khz) - 1; prescale = clamp(prescale, 0, 0xFFFF); diff = clk_khz / (5 * (prescale - 1)) - bus_clk_khz; if (abs(diff) &gt; bus_clk_khz / 10) { dev_err(rdev-&gt;dev, "Unsupported clock settings: clk: %d KHz, bus: %d KHz\n", clk_khz, bus_clk_khz); return -EINVAL; } if (presc != -1) i2c_write(presc, rdev-&gt;base, SKEL_I2C_CLK); else i2c_write(prescale, rdev-&gt;base, SKEL_I2C_CLK); return 0; } static int skel_i2c_xfer(struct i2c_adapter *adap, struct i2c_msg *msgs, int num) { struct skel_i2c *rdev = i2c_get_adapdata(adap); int i, ret = 0; for (i = 0; (ret == 0) &amp;&amp; (i &lt; num); i++) ret = skel_i2c_xfer_msg(rdev, msgs); skel_i2c_snd_stop(rdev); return ret ? : num; } static u32 skel_i2c_func(struct i2c_adapter *adap) { return I2C_FUNC_I2C | I2C_FUNC_SMBUS_EMUL; } static const struct i2c_algorithm skel_i2c_algo = { .master_xfer = skel_i2c_xfer, .functionality = skel_i2c_func, }; static int skel_i2c_probe(struct platform_device *pdev) { struct skel_i2c *rdev = NULL; struct resource *res; int irq, ret; u32 val; rdev = devm_kzalloc(&amp;pdev-&gt;dev, sizeof(*rdev), GFP_KERNEL); if (!rdev) return -ENOMEM; res = platform_get_resource(pdev, IORESOURCE_MEM, 0); rdev-&gt;base = devm_ioremap_resource(&amp;pdev-&gt;dev, res); if (IS_ERR(rdev-&gt;base)) return PTR_ERR(rdev-&gt;base); irq = platform_get_irq(pdev, 0); if (irq &lt; 0) { dev_err(&amp;pdev-&gt;dev, "Missing interrupt resource\n"); return irq; } rdev-&gt;clk = devm_clk_get(&amp;pdev-&gt;dev, NULL); if (IS_ERR(rdev-&gt;clk)) { dev_err(&amp;pdev-&gt;dev, "Missing clock\n"); return PTR_ERR(rdev-&gt;clk); } rdev-&gt;dev = &amp;pdev-&gt;dev; init_completion(&amp;rdev-&gt;msg_complete); spin_lock_init(&amp;rdev-&gt;lock); val = of_property_read_u32(pdev-&gt;dev.of_node, "clock-frequency", &amp;rdev-&gt;bus_clock); if (val) { dev_err(&amp;pdev-&gt;dev, "Default to 100kHz\n"); rdev-&gt;bus_clock = 100000; /* default clock rate */ } if (rdev-&gt;bus_clock &gt; 400000) { dev_err(&amp;pdev-&gt;dev, "Invalid clock-frequency %d\n", rdev-&gt;bus_clock); return -EINVAL; } ret = devm_request_irq(&amp;pdev-&gt;dev, irq, skel_i2c_isr, 0, pdev-&gt;name, rdev); if (ret) { dev_err(&amp;pdev-&gt;dev, "Failed to claim IRQ %d\n", irq); return ret; } ret = clk_prepare_enable(rdev-&gt;clk); if (ret) { dev_err(&amp;pdev-&gt;dev, "Failed to enable clock\n"); return ret; } skel_i2c_init(rdev); i2c_set_adapdata(&amp;rdev-&gt;adap, rdev); strlcpy(rdev-&gt;adap.name, pdev-&gt;name, sizeof(rdev-&gt;adap.name)); rdev-&gt;adap.owner = THIS_MODULE; rdev-&gt;adap.algo = &amp;skel_i2c_algo; rdev-&gt;adap.dev.parent = &amp;pdev-&gt;dev; rdev-&gt;adap.dev.of_node = pdev-&gt;dev.of_node; platform_set_drvdata(pdev, rdev); ret = i2c_add_adapter(&amp;rdev-&gt;adap); if (ret) { clk_disable_unprepare(rdev-&gt;clk); return ret; } dev_info(&amp;pdev-&gt;dev, "I2C probe complete\n"); return 0; } static int skel_i2c_remove(struct platform_device *pdev) { struct skel_i2c *rdev = platform_get_drvdata(pdev); clk_disable_unprepare(rdev-&gt;clk); i2c_del_adapter(&amp;rdev-&gt;adap); return 0; } static struct platform_driver skel_i2c_driver = { .probe = skel_i2c_probe, .remove = skel_i2c_remove, .driver = { .name = "skel-i2c", .of_match_table = skel_i2c_match, }, }; module_platform_driver(skel_i2c_driver); MODULE_AUTHOR("Name Surname"); MODULE_DESCRIPTION("I2C bus driver"); MODULE_LICENSE("GPL"); MODULE_ALIAS("platform:skel-i2c");</span></span></span></span></code> </pre><br></div></div><br>  Ø´ÙƒØ±Ø§ Ù„ÙƒÙ… Ø¹Ù„Ù‰ Ø§Ù‡ØªÙ…Ø§Ù…ÙƒÙ…! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar413249/">https://habr.com/ru/post/ar413249/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar413239/index.html">ÙƒÙŠÙÙŠØ© Ø¬Ø¹Ù„ Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ø°ÙƒÙŠ Ø£ÙƒØ«Ø± ØºØ¨Ø§Ø¡</a></li>
<li><a href="../ar413241/index.html">Ø§Ø¹ØªØ±Ø§Ø¶ ÙˆØ¸Ø§Ø¦Ù ÙÙŠ Ù†ÙˆØ§Ø© Ù„ÙŠÙ†ÙƒØ³ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ftrace</a></li>
<li><a href="../ar413243/index.html">Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ÙƒÙŠÙÙŠØ© Ø§Ù„Ø¬Ù…Ø¹ Ø¨ÙŠÙ† Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª ÙˆØ§Ù„Ø£Ø¹Ù…Ø§Ù„</a></li>
<li><a href="../ar413245/index.html">Ø¹Ù„Ù‰ Ù…Ø¹Ø¯Ø§Øª Dolby Atmos - ØµÙˆØª "Ø£ØµÙ„ÙŠ" ÙÙ‚Ø·. ÙŠØ­Ø¸Ø± Dolby Ø§Ù„Ù…Ø²Ø¬ ØºÙŠØ± Ø§Ù„Ø£ØµÙ„ÙŠ</a></li>
<li><a href="../ar413247/index.html">Ù„Ù…Ø§Ø°Ø§ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø£Ù†Ø¸Ù…Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ†ØŸ</a></li>
<li><a href="../ar413251/index.html">ØªÙØ§Ø¹Ù„ Ø³Ù„Ø³Ù„Ø© Ø§Ù„Ø¨Ù„Ù…Ø±Ø© ÙˆÙÙ„Ø§Ø¯ÙŠÙÙˆØ³ØªÙˆÙƒ</a></li>
<li><a href="../ar413253/index.html">Ø±ÙŠØªØ´Ø§Ø±Ø¯ Ù‡Ø§Ù…ÙŠÙ†Ø¬: Ø§Ù„ÙØµÙ„ 21. Ø§Ù„Ø£Ù„ÙŠØ§Ù Ø§Ù„Ø¨ØµØ±ÙŠØ©</a></li>
<li><a href="../ar413255/index.html">Ø±ÙŠØªØ´Ø§Ø±Ø¯ Ù‡Ø§Ù…ÙŠÙ†Ø¬: Ø§Ù„ÙØµÙ„ 27. Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ø§Ù„ØµØ§Ù„Ø­Ø©</a></li>
<li><a href="../ar413261/index.html">ÙƒÙŠÙ ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¨Ø­Ø«</a></li>
<li><a href="../ar413265/index.html">Ø¥Ù„Ù‰ Ø§Ù„Ø­Ù…Ø§Ù… Ù…Ø¹ ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>