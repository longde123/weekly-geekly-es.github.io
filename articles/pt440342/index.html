<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü•á üë©üèæ‚Äçüé§ üõÖ C√≥digo C # universal para NET e JavaScript ü§ôüèø üî∏ üë©üèº‚Äçü§ù‚Äçüë®üèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Em 2013, enquanto trabalhava no servi√ßo de fotos da GFRANQ, participei do desenvolvimento de um servi√ßo da web de mesmo nome para publica√ß√£o e process...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C√≥digo C # universal para NET e JavaScript</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/440342/"><p>  Em 2013, enquanto trabalhava no servi√ßo de fotos da GFRANQ, participei do desenvolvimento de um servi√ßo da web de mesmo nome para publica√ß√£o e processamento de fotos.  Filtros e transforma√ß√µes foram definidos no arquivo com par√¢metros e todo o processamento foi realizado no servidor.  Durante o desenvolvimento do servi√ßo, havia a necessidade de suportar essas transforma√ß√µes no lado do cliente para a visualiza√ß√£o.  Segundo Larry Wall, uma das virtudes de um programador √© a pregui√ßa.  Portanto, como programadores verdadeiramente pregui√ßosos, pensamos na possibilidade de usar o mesmo c√≥digo no servidor e no cliente.  Todo o desenvolvimento foi realizado em C #.  Depois de pesquisar as bibliotecas e algumas tentativas, conclu√≠mos com orgulho que isso era poss√≠vel e come√ßamos a escrever o c√≥digo universal. </p><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/ir/gs/y0/irgsy0wvrqkk5ybw0elxt5nagfk.png"></div><p></p><br><p> Por que este artigo √© necess√°rio?  De fato, seis anos se passaram desde 2013 e muitas tecnologias perderam sua relev√¢ncia, por exemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Script #</a> .  Por outro lado, novos surgiram.  Por exemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Bridge.NET</a> ou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Blazor com</a> base no sofisticado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">WebAssembly</a> . </p><br><p>  No entanto, algumas id√©ias ainda podem ser usadas.  Neste artigo, tentei descrev√™-los o mais detalhadamente poss√≠vel.  Espero que a men√ß√£o de Silverlight e Flash cause um sorriso com uma pitada de nostalgia, e n√£o um desejo de criticar as solu√ß√µes antigas.  De qualquer forma, eles contribu√≠ram para o desenvolvimento da ind√∫stria da web. </p><a name="habracut"></a><br><h2 id="contents">  Conte√∫do </h2><br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Conte√∫do</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Objetivo</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Descri√ß√£o dos filtros</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Descri√ß√£o das colagens</a> </li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Implementa√ß√£o</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Escolhendo uma plataforma para processamento de fotos</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Traduzindo C # para Javascript</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Vantagens</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Desvantagens</a> </li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Estrutura</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Usando alias</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Links para arquivos</a> </li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Notas sobre a implementa√ß√£o do .NET</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Usando descarte</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Usando bloqueio</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Armazenando m√°scaras na mem√≥ria</a> </li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Notas sobre implementa√ß√£o de JavaScript</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Minifica√ß√£o</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Minifica√ß√£o manual</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Minifica√ß√£o automatizada</a> </li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Modos de depura√ß√£o e lan√ßamento</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Propriedade crossOrigin</a> </li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Otimiza√ß√µes</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Usando os valores pr√©-calculados</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Convertendo uma imagem em uma matriz de pixels</a> </li></ul></li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Exemplos de c√≥digo</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Geral</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Detectando se uma string √© um n√∫mero</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Divis√£o inteira</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Girando e invertendo uma imagem usando a tela e o bitmap</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Carregamento de imagem s√≠ncrona e ass√≠ncrona</a> </li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Somente script #</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Detectando o tipo e a vers√£o de um navegador</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Renderizando uma linha tracejada</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Anima√ß√£o de rota√ß√£o</a> </li></ul></li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Conclus√£o</a> </li></ul><br><br><h2 id="goal">  Objetivo </h2><br><p>  O desafio √© implementar a colagem de fotos e a funcionalidade de edi√ß√£o de fotos com base em filtro no lado do cliente e, se poss√≠vel, no lado do servidor.  Para come√ßar, abordarei como os filtros e colagens s√£o implementados. </p><br><h3 id="description-of-filters">  Descri√ß√£o dos filtros </h3><br><p>  No contexto do nosso projeto, <strong>um filtro</strong> √© uma s√©rie de a√ß√µes realizadas no Photoshop e aplicadas a uma foto espec√≠fica.  Abaixo est√£o os exemplos de tais a√ß√µes: </p><br><ul><li>  Ajuste de brilho </li><li>  Ajuste de contraste </li><li>  Ajuste de satura√ß√£o </li><li>  Ajuste de curvas de cores </li><li>  Mascaramento em diferentes modos </li><li>  Enquadramento </li><li>  ... </li></ul><br><p>  Precisamos de um certo formato para descrever essas a√ß√µes.  Claro, existem formatos comuns como JSON e XML, mas foi decidido criar nosso pr√≥prio formato pelos seguintes motivos: </p><br><ul><li>  Necessidade de uma arquitetura de c√≥digo independente da plataforma (.NET, JavaScript, WinPhone etc.) </li><li>  Necessidade de um formato n√£o hier√°rquico simples de filtros, o que facilita a grava√ß√£o de um analisador </li><li>  Dados XML e JSON consomem mais mem√≥ria (nesse caso em particular) </li></ul><br><p>  Aqui est√° a apar√™ncia da sequ√™ncia de a√ß√µes para o filtro <strong>XPro Film</strong> : </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/y_/oy/ad/y_oyadt7qubbsa9an37h32ostqs.png"></div><br><p>  Al√©m de editar uma foto com um filtro, precis√°vamos cortar e girar a imagem.  Sim, eu sabia que existem plugins jQuery para cortar e rotacionar imagens, mas eles pareciam estar sobrecarregados e divergir da arquitetura universal do projeto. </p><br><h3 id="description-of-collages">  Descri√ß√£o das colagens </h3><br><p>  <strong>Uma colagem</strong> √© um arranjo de v√°rias fotos em miniatura em uma foto inteira (com ou sem o uso de m√°scara).  Tamb√©m era necess√°rio permitir aos usu√°rios arrastar e soltar as imagens dispon√≠veis na colagem, alterar sua posi√ß√£o e escala.  Sua colagem pode ficar assim: </p><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/084/250/1f8/0842501f87761a3c128b5f117719b10c.jpg"></div><br><p> O recurso de colagem implica o uso de um formato simples para armazenar ret√¢ngulos com coordenadas relativas de <code>0</code> a <code>1</code> , os endere√ßos das fotos e os dados de modifica√ß√£o da imagem.  As coordenadas relativas s√£o usadas porque as mesmas transforma√ß√µes do lado do cliente s√£o aplicadas a imagens de tamanho grande no lado do servidor. </p><br><h2 id="implementation">  Implementa√ß√£o </h2><br><p>  Tivemos que escolher a plataforma que permite aos usu√°rios trabalhar com filtros e colagens </p><br><h3 id="choosing-a-platform-for-photo-processing">  Escolhendo uma plataforma para processamento de fotos </h3><br><p>  Existem v√°rias tecnologias Rich Internet Application ( <strong>RIA</strong> ), como: </p><br><ul><li>  Adobe flash </li><li>  Microsoft silverlight </li><li>  HTML 5 + JavaScript </li><li>  Cliente nativo </li></ul><br><p>  Por raz√µes √≥bvias, Flash e HTML s√£o as √∫nicas tecnologias que merecem aten√ß√£o, pois o restante delas n√£o √© compat√≠vel com v√°rias plataformas.  Al√©m disso, o cliente Silverlight est√° come√ßando a morrer.  Embora eu realmente goste do conceito de <del>  sal </del>  NaCl, infelizmente, essa tecnologia √© suportada apenas pelo navegador Chrome e ainda n√£o se sabe quando ser√° suportada (e ser√° que ser√° sempre suportada) por outros navegadores populares.  <em>Nota de 2019: ser√° e o nome √© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">WebAssembly</a> .</em> </p><br><p>  A escolha foi feita em favor da plataforma HTML5 moderna e progressiva, cuja funcionalidade √© atualmente suportada pelo iOS, em oposi√ß√£o ao Flash.  Essa op√ß√£o tamb√©m se baseia no fato de existirem muitas bibliotecas, que permitem compilar o c√≥digo C # em Javascript.  Voc√™ tamb√©m pode usar o Visual Studio para esse fim.  Os detalhes s√£o fornecidos abaixo. </p><br><h3 id="translating-c-into-javascript">  Traduzindo C # para Javascript </h3><br><p>  O HTML 5 + JavaScript foi selecionado como plataforma na se√ß√£o anterior.  Portanto, deixa-nos uma quest√£o de saber se √© poss√≠vel escrever um c√≥digo C # universal que possa ser compilado em .NET e JavaScript. </p><br><p>  Assim, foram encontradas v√°rias bibliotecas para realizar a tarefa: </p><br><ul><li>  Jsil </li><li>  Sharpkit </li><li>  Script # </li><li>  E alguns outros dispon√≠veis <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">no GitHub</a> . </li></ul><br><p>  Como resultado, foi decidido usar o <strong>Script #</strong> devido ao fato de o JSIL trabalhar diretamente com assemblies e gerar c√≥digo menos puro (embora ele suporte uma ampla variedade de recursos da linguagem C #) e o SharpKit √© um produto comercial.  Para uma compara√ß√£o detalhada dessas ferramentas, consulte <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">a pergunta sobre stackoverflow</a> . </p><br><p>  Em resumo, o ScriptSharp comparado ao JavaScript escrito manualmente tem os seguintes pr√≥s e contras: </p><br><h4 id="advantages">  Vantagens </h4><br><ul><li>  Possibilidade de escrever um c√≥digo C # universal que possa ser compilado no .NET e em outras plataformas (WinPhone, Mono) </li><li>  Desenvolvimento em uma linguagem C # fortemente tipada que suporta OOP </li><li>  Suporte para recursos IDE (preenchimento autom√°tico e refatora√ß√£o) </li><li>  Capacidade de detectar a maioria dos erros no est√°gio de compila√ß√£o </li></ul><br><h4 id="disadvantages">  Desvantagens </h4><br><ul><li>  Redund√¢ncia e irregularidade do c√≥digo JavaScript gerado (devido ao mscorlib). </li><li>  Suporte apenas para ISO-2 (sem sobrecarga de fun√ß√£o ou infer√™ncia de tipo, extens√£o e gen√©ricos) </li></ul><br><h3 id="structure">  Estrutura </h3><br><p>  O processo de compila√ß√£o do mesmo c√≥digo C # no .NET e Javascript pode ser ilustrado pelo seguinte esquema: </p><br><div style="text-align:center;"><img src="https://habrastorage.org/storage2/8ba/bce/32c/8babce32c532d3b3954cdabebabb0e06.png" width="70%" alt="Tradu√ß√£o de C # para esquema .NET e JavaScript"></div><br><p>  Embora .NET e HTML5 sejam tecnologias completamente diferentes, eles tamb√©m t√™m recursos semelhantes.  Isso tamb√©m se aplica ao trabalho com gr√°ficos.  Por exemplo, o .NET suporta <strong>Bitmap</strong> , o JavaScript suporta o seu an√°logo - <strong>Canvas</strong> .  O mesmo acontece com <strong>gr√°ficos</strong> , <strong>contexto</strong> e matrizes de pixels.  Para combinar tudo isso em um c√≥digo, decidiu-se desenvolver a seguinte arquitetura: </p><br><div style="text-align:center;"><img src="https://habrastorage.org/storage2/89c/427/74c/89c42774cf90bdc873a0c34619cf7207.png" width="50%" alt="GraphicsContext comum do .NET e JavaScript"></div><br><p>  Obviamente, n√£o se limita a duas plataformas.  Como acompanhamento, est√° planejado adicionar suporte ao WinPhone e, talvez, Android e iOS. </p><br><p>  Note-se que existem dois tipos de opera√ß√µes gr√°ficas: </p><br><ul><li>  <strong>Usando fun√ß√µes da API</strong> ( <code>DrawImage</code> , <code>Arc</code> , <code>MoveTo</code> , <code>LineTo</code> ).  Alto desempenho e suporte √† acelera√ß√£o de hardware s√£o vantagens competitivas importantes.  A desvantagem √© que eles podem ser implementados de maneira diferente em plataformas diferentes. </li><li>  <strong>Pixel por pixel.</strong>  Suporte para a implementa√ß√£o de quaisquer efeitos e cobertura entre plataformas est√£o entre os benef√≠cios.  A desvantagem √© o baixo desempenho.  No entanto, voc√™ pode atenuar as desvantagens por paraleliza√ß√£o, sombreadores e tabelas pr√©-calculadas (discutiremos isso mais adiante na pr√≥xima se√ß√£o sobre otimiza√ß√£o). </li></ul><br><p>  Como voc√™ pode ver, a classe abstrata <strong>Graphics</strong> descreve todos os m√©todos para trabalhar com gr√°ficos;  esses m√©todos s√£o implementados para v√°rias plataformas na classe derivada.  Os aliases a seguir foram escritos para abstrair tamb√©m das classes Bitmap e Canvas.  A vers√£o WinPhone tamb√©m usa um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">padr√£o de adaptador</a> . </p><br><h4 id="using-alias">  Usando alias </h4><br><pre> <code class="cs hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> SCRIPTSHARP using System.Html; using System.Html.Media.Graphics; using System.Runtime.CompilerServices; using Bitmap = System.Html.CanvasElement; using Graphics = System.Html.Media.Graphics.CanvasContext2D; using ImageData = System.Html.Media.Graphics.ImageData; using Image = System.Html.ImageElement; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">elif</span></span></span><span class="hljs-meta"> DOTNET using System.Drawing; using System.Drawing.Imaging; using System.Drawing.Drawing2D; using Bitmap = System.Drawing.Bitmap; using Graphics = System.Drawing.Graphics; using ImageData = System.Drawing.Imaging.BitmapData; using Image = System.Drawing.Bitmap; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span></span></code> </pre> <br><p>  Infelizmente, √© imposs√≠vel criar aliases para tipos e matrizes n√£o seguros, ou seja, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Alias ‚Äã‚Äãpara ponteiro (byte *) em C #</a> : </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> PixelArray = <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>*, <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> PixelArray = <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[]</code> </pre> <br><p>  Para executar o processamento r√°pido de pixels usando c√≥digo C # n√£o gerenciado, ao mesmo tempo em que o compila no Script #, introduzimos o seguinte esquema com a ajuda de diretivas: </p><br><pre> <code class="cs hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> SCRIPTSHARP PixelArray data = context.GetPixelArray(); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">elif</span></span></span><span class="hljs-meta"> DOTNET byte* data = context.GetPixelArray(); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span></span></code> </pre> <br><p>  A matriz de <code>data</code> √© subseq√ºentemente usada para implementar v√°rias opera√ß√µes de pixel por pixel (como mascaramento, olho de peixe, ajuste de satura√ß√£o etc.), paralelamente e n√£o. </p><br><h4 id="links-to-files">  Links para arquivos </h4><br><p>  Um projeto separado √© adicionado √† solu√ß√£o para cada plataforma, mas, √© claro, Mono, Script # e at√© o Silverlight n√£o podem se referir aos assemblies .NET habituais.  Felizmente, o Visual Studio possui um mecanismo para adicionar links a arquivos, o que permite reutilizar o mesmo c√≥digo em projetos diferentes. </p><br><p>  As diretivas do compilador ( <code>DOTNET</code> , <code>SCRIPTSHARP</code> ) s√£o definidas nas propriedades do projeto em S√≠mbolos de compila√ß√£o condicional. </p><br><h3 id="notes-on-net-implementation">  Notas sobre a implementa√ß√£o do .NET </h3><br><p>  As abstra√ß√µes e aliases acima nos ajudaram a escrever o c√≥digo C # com baixa redund√¢ncia.  Al√©m disso, quero apontar os problemas com as plataformas .NET e JavaScript que enfrentamos ao desenvolver o c√≥digo da solu√ß√£o. </p><br><h4 id="using-dispose">  Usando descarte </h4><br><p>  Observe que a inclus√£o de qualquer inst√¢ncia de uma classe C #, que implementa a interface <code>IDisposable</code> , requer a chamada do m√©todo <strong><code>Dispose</code></strong> ou a aplica√ß√£o da <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">instru√ß√£o Using</a> .  Neste projeto, essas classes s√£o Bitmap e Contexto.  O que eu disse acima n√£o √© apenas a teoria, ele realmente tem uma aplica√ß√£o pr√°tica: o processamento de um grande n√∫mero de fotos de tamanho grande (at√© 2400 x 2400 dpi) no ASP.NET Developer Server x86 resultou em uma exce√ß√£o de falta de mem√≥ria.  O problema foi resolvido depois de adicionar <code>Dispose</code> nos lugares certos.  Alguns outros conselhos √∫teis sobre manipula√ß√£o de imagens s√£o fornecidos no artigo a seguir: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">20 Redimensionamento de armadilhas</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">vazamento de mem√≥ria .NET: Para descartar ou n√£o descartar, essa √© a quest√£o de 1 GB</a> . </p><br><h4 id="using-lock">  Usando bloqueio </h4><br><p>  Em JavaScript, h√° uma diferen√ßa entre a imagem j√° carregada com a tag <code>img</code> , para a qual voc√™ pode especificar o evento de origem e de carregamento, e a tela com tags de <code>canvas</code> , na qual √© poss√≠vel desenhar algo.  No .NET esses elementos s√£o representados pela mesma classe <code>Bitmap</code> .  Assim, os aliases Bitmap e Imagem no .NET apontam para a mesma classe <code>System.Drawing.Bitmap</code> conforme mostrado acima. </p><br><p>  No entanto, essa divis√£o em <code>img</code> e <code>canvas</code> em JavaScript tamb√©m foi muito √∫til na vers√£o .NET.  O ponto √© que os filtros usam m√°scaras pr√©-carregadas de diferentes threads;  portanto, o padr√£o de <strong>bloqueio</strong> √© necess√°rio para evitar a exce√ß√£o durante a sincroniza√ß√£o (a imagem √© copiada com <strong>bloqueio</strong> e o resultado √© usado sem bloqueio): </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Bitmap </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CloneImage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Image image</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> SCRIPTSHARP Bitmap result = (Bitmap)Document.CreateElement("canvas"); result.Width = image.Width; result.Height = image.Height; Graphics context = (Graphics)result.GetContext(Rendering.Render2D); context.DrawImage(image, 0, 0); return result; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> Bitmap result; lock (image) result = new Bitmap(image); return result; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> }</span></span></code> </pre> <br><p>  Afinal, o <strong>bloqueio</strong> tamb√©m deve ser usado ao acessar as propriedades de um objeto sincronizado (de fato, quaisquer propriedades s√£o m√©todos). </p><br><h4 id="storing-masks-in-memory">  Armazenando m√°scaras na mem√≥ria </h4><br><p>  Para acelerar o processamento, todas as m√°scaras potencialmente usadas para filtros s√£o carregadas na mem√≥ria quando o servidor √© iniciado.  Independentemente do formato da m√°scara, o Bitmap carregado no servidor usa <code>4 * 2400 * 2400</code> ou <code>‚âà24 MB</code> de mem√≥ria (o tamanho m√°ximo da imagem √© <code>2400 * 2400</code> ; o n√∫mero de bytes por pixel √© 4).  Todas as m√°scaras para filtros (‚âà30) e colagens (40) consumir√£o 1,5 GB - isso n√£o √© muito para o servidor;  no entanto, conforme o n√∫mero de m√°scaras aumenta, esse valor pode aumentar significativamente.  No futuro, possivelmente usaremos t√©cnicas de compacta√ß√£o para m√°scaras armazenadas na mem√≥ria (nos formatos .jpg e .png) seguidas de descompacta√ß√£o quando necess√°rio.  Na verdade, o tamanho pode ser reduzido em at√© 300 vezes.  Uma vantagem adicional dessa abordagem √© que a c√≥pia das imagens compactadas √© mais r√°pida em compara√ß√£o √†s grandes;  portanto, a opera√ß√£o de <strong>bloqueio</strong> levar√° menos tempo e os threads ser√£o bloqueados com menos frequ√™ncia. </p><br><h3 id="notes-on-javascript-implementation">  Notas sobre implementa√ß√£o de JavaScript </h3><br><h4 id="minification">  Minifica√ß√£o </h4><br><p>  Recusei-me a usar o termo "ofusca√ß√£o" pelo seguinte motivo: este termo √© pouco aplic√°vel a uma linguagem de c√≥digo-fonte totalmente aberto, que no nosso caso √© JavaScript.  No entanto, o anonimato dos identificadores pode atrapalhar a legibilidade e a l√≥gica do c√≥digo.  E o mais importante, essa t√©cnica reduzir√° significativamente o tamanho do script (a vers√£o compactada √© de ‚âà80 KB). </p><br><p>  Existem duas abordagens para a minifica√ß√£o do JavaScript: </p><br><ul><li>  <strong>Minifica√ß√£o manual,</strong> que √© executada no est√°gio de gera√ß√£o usando o ScriptSharp. </li><li>  <strong>Minifica√ß√£o automatizada,</strong> realizada ap√≥s o est√°gio de gera√ß√£o usando ferramentas externas, como o Google Closure Compiler, Yui e outras ferramentas. </li></ul><br><h5 id="manual-minification">  Minifica√ß√£o manual </h5><br><p>  Para encurtar os nomes dos m√©todos, classes e atributos, usamos essa sintaxe antes da declara√ß√£o das entidades mencionadas acima.  Obviamente, n√£o √© necess√°rio fazer isso se voc√™ estiver trabalhando com m√©todos chamados de scripts e classes externos (p√∫blico). </p><br><pre> <code class="cs hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> SCRIPTSHARP &amp;&amp; !DEBUG [ScriptName("a0")] #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span></span></code> </pre> <br><p>  De qualquer forma, as vari√°veis ‚Äã‚Äãlocais n√£o puderam ser minificadas.  Essas constru√ß√µes poluem o c√≥digo e prejudicam a legibilidade do c√≥digo, o que tamb√©m √© uma s√©ria desvantagem.  No entanto, essa t√©cnica pode reduzir significativamente a quantidade de c√≥digo JavaScript gerado e atrapalhar tamb√©m. </p><br><p>  Outra desvantagem √© que voc√™ precisa ficar de olho nesses nomes abreviados se eles renomearem os nomes de m√©todos e de campos (especialmente nomes substitu√≠dos nas classes filho), porque nesse caso o Script # n√£o se importar√° com nomes repetitivos.  No entanto, n√£o permitir√° classes duplicadas. </p><br><p>  A prop√≥sito, a funcionalidade de minifica√ß√£o para m√©todos e campos privados e internos j√° foi adicionada √† vers√£o desenvolvida do Script #. </p><br><h5 id="automated-minification">  Minifica√ß√£o automatizada </h5><br><p>  Embora existam muitas ferramentas para minifica√ß√£o de JavaScript, usei o Google Closure Compiler por sua marca e boa qualidade de compacta√ß√£o.  A desvantagem da ferramenta de minifica√ß√£o do Google √© que ela n√£o pode compactar arquivos CSS;  por outro lado, a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">YUI</a> enfrenta esse desafio com sucesso.  De fato, o Script # tamb√©m pode reduzir scripts, mas lida com esse desafio muito pior que o Google Closure. </p><br><p>  A ferramenta de minifica√ß√£o do Google possui v√°rios n√≠veis de compacta√ß√£o: espa√ßo em branco, simples e avan√ßado.  Escolhemos o n√≠vel Simples para o projeto;  embora, o n√≠vel Avan√ßado permita alcan√ßar a qualidade m√°xima de compacta√ß√£o, requer c√≥digo escrito dessa maneira para que os m√©todos sejam acess√≠veis de fora da classe.  Essa minifica√ß√£o foi parcialmente realizada manualmente usando o Script #. </p><br><h4 id="debug-and-release-modes">  Modos de depura√ß√£o e lan√ßamento </h4><br><p>  As bibliotecas de depura√ß√£o e vers√£o foram adicionadas √†s p√°ginas do ASP.NET da seguinte maneira: </p><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">if</span></span></span><span class="hljs-tag"> (</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Gfranq.JavaScriptFilters.HtmlHelper.IsDebug</span></span></span><span class="hljs-tag">) { %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Scripts/mscorlib.debug.js"</span></span></span><span class="hljs-tag"> &gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Scripts/imgProcLib.debug.js"</span></span></span><span class="hljs-tag"> &gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%</span></span></span><span class="hljs-tag"> } </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">else</span></span></span><span class="hljs-tag"> { %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Scripts/mscorlib.js"</span></span></span><span class="hljs-tag"> &gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Scripts/imgProcLib.js"</span></span></span><span class="hljs-tag"> &gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%</span></span></span><span class="hljs-tag"> } %&gt;</span></span></code> </pre> <br><p>  Neste projeto, reduzimos os scripts e os arquivos de descri√ß√£o do filtro. </p><br><h4 id="crossorigin-property">  Propriedade crossOrigin </h4><br><p>  Para acessar os pixels de uma imagem em particular, precisamos primeiro convert√™-la em tela.  Mas isso pode levar a um erro CORS (Cross Origin Request Security).  No nosso caso, o problema foi resolvido da seguinte maneira: </p><br><ul><li>  Configurando o <code>crossOrigin = ''</code> no lado do servidor. </li><li>  Adicionando um cabe√ßalho espec√≠fico ao pacote HTTP no lado do servidor. </li></ul><br><p>  Como o ScriptSharp n√£o suporta essa propriedade para elementos img, o seguinte c√≥digo foi gravado: </p><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Imported</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">AdvImage</span></span> { [IntrinsicProperty] <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> CrossOrigin { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty; } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { } } }</code> </pre> <br><p>  Ent√£o, vamos us√°-lo assim: </p><br><pre> <code class="plaintext hljs">((AdvImage)(object)result).CrossOrigin = "";</code> </pre> <br><p>  Essa t√©cnica permite adicionar qualquer recurso ao objeto sem erros de compila√ß√£o.  Particularmente, a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">propriedade <code>wheelDelta</code> ainda n√£o foi implementada</a> no ScriptSharp (pelo menos na vers√£o 0.7.5).  Esta propriedade indica a quantidade da roda de rolagem, usada para criar colagens.  √â por isso que foi implementado dessa maneira.  Um hack t√£o sujo com as propriedades n√£o √© bom;  normalmente, voc√™ precisa fazer altera√ß√µes no projeto.  Mas, apenas para constar, ainda n√£o descobri uma maneira de compilar o ScriptSharp a partir da fonte. </p><br><p>  Essas imagens requerem que o servidor retorne os seguintes cabe√ßalhos em seus cabe√ßalhos de resposta (em Global.asax): </p><br><pre> <code class="cs hljs">Response.AppendHeader(<span class="hljs-string"><span class="hljs-string">"Access-Control-Allow-Origin"</span></span>, <span class="hljs-string"><span class="hljs-string">"\*"</span></span>);</code> </pre> <br><p>  Para obter mais informa√ß√µes sobre a seguran√ßa de solicita√ß√£o de origem cruzada, visite <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">http://enable-cors.org/</a> . </p><br><h3 id="optimizations">  Otimiza√ß√µes </h3><br><h4 id="using-the-precalculated-values">  Usando os valores pr√©-calculados </h4><br><p>  Utilizamos a otimiza√ß√£o para algumas opera√ß√µes, como ajuste de brilho, contraste e curvas de cores, atrav√©s do c√°lculo preliminar dos componentes de cores resultantes (r, g, b) para todos os valores poss√≠veis e uso adicional das matrizes obtidas para alterar diretamente as cores dos pixels. .  Note-se que esse tipo de otimiza√ß√£o √© adequado apenas para opera√ß√µes nas quais a cor do pixel resultante n√£o √© afetada pelo pixel adjacente. </p><br><p>  O c√°lculo dos componentes de cores resultantes para todos os valores poss√≠veis: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">256</span></span>; i++) { r[i] = ActionFuncR(i); g[i] = ActionFuncG(i); b[i] = ActionFuncB(i); }</code> </pre> <br><p>  O uso de componentes de cores pr√©-calculados: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; data.Length; i += <span class="hljs-number"><span class="hljs-number">4</span></span>) { data[i] = r[data[i]]; data[i + <span class="hljs-number"><span class="hljs-number">1</span></span>] = g[data[i + <span class="hljs-number"><span class="hljs-number">1</span></span>]]; data[i + <span class="hljs-number"><span class="hljs-number">2</span></span>] = b[data[i + <span class="hljs-number"><span class="hljs-number">2</span></span>]]; }</code> </pre> <br><p>  Se essas opera√ß√µes da tabela forem uma por uma, n√£o ser√° necess√°rio calcular imagens intermedi√°rias - voc√™ pode passar apenas as matrizes do componente de cores.  Como o c√≥digo funcionava rapidamente no lado do cliente e do servidor, foi decidido deixar de lado a implementa√ß√£o dessa otimiza√ß√£o.  Al√©m disso, a otimiza√ß√£o causou algum comportamento indesejado.  No entanto, darei uma lista da otimiza√ß√£o: </p><br><table><tbody><tr><td>  C√≥digo original </td><td>  C√≥digo otimizado </td></tr><tr><td>  `` cs <br>  // C√°lculo de valores para a primeira tabela. <br>  for (int i = 0; i &lt;256; i ++) <br>  { <br>  r [i] = ActionFunc1R (i); <br>  g [i] = ActionFunc1G (i); <br>  b [i] = ActionFunc1B (i); <br>  } <br>  // ... <br><br>  // C√°lculo da imagem intermedi√°ria resultante. <br>  for (int i = 0; i &lt;data.Length; i + = 4) <br>  { <br>  dados [i] = r [dados [i]]; <br>  dados [i + 1] = g [dados [i + 1]]; <br>  dados [i + 2] = b [dados [i + 2]]; <br>  } <br>  // ... <br><br>  // C√°lculo de valores para a segunda tabela. <br>  for (int i = 0; i &lt;256; i ++) <br>  { <br>  r [i] = ActionFunc2R (i); <br>  g [i] = ActionFunc2G (i); <br>  b [i] = ActionFunc2B (i); <br>  } <br>  // ... <br><br>  // C√°lculo da imagem resultante. <br>  for (int i = 0; i &lt;data.Length; i + = 4) <br>  { <br>  dados [i] = r [dados [i]]; <br>  dados [i + 1] = g [dados [i + 1]]; <br>  dados [i + 2] = b [dados [i + 2]]; <br>  } <br>  `` `` <br><br></td><td>  `` cs <br>  // C√°lculo de valores para a primeira tabela. <br>  for (int i = 0; i &lt;256; i ++) <br>  { <br>  r [i] = ActionFunc1R (i); <br>  g [i] = ActionFunc1G (i); <br>  b [i] = ActionFunc1B (i); <br>  } <br>  // ... <br><br>  // C√°lculo de valores para a segunda tabela. <br>  tr = r.Clone (); <br>  tg = g.Clone (); <br>  clone (); <br>  for (int i = 0; i &lt;256; i ++) <br>  { <br>  r [i] = tr [ActionFunc2R (i)]; <br>  g [i] = tg [ActionFunc2G (i)]; <br>  b [i] = t [ActionFunc2B (i)]; <br>  } <br>  // ... <br><br>  // C√°lculo da imagem resultante. <br>  for (int i = 0; i &lt;data.Length; i + = 4) <br>  { <br>  dados [i] = r [dados [i]]; <br>  dados [i + 1] = g [dados [i + 1]]; <br>  dados [i + 2] = b [dados [i + 2]]; <br>  } <br>  `` `` <br><br></td></tr></tbody></table><br><p>  Mas mesmo isso n√£o √© tudo.  Se voc√™ der uma olhada na tabela √† direita, notar√° que novas matrizes s√£o criadas usando o m√©todo <code>Clone</code> .  Na verdade, voc√™ pode simplesmente mudar os ponteiros para as novas e antigas matrizes, em vez de copiar a pr√≥pria matriz (isso lembra a analogia do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">buffer duplo</a> ). </p><br><h4 id="converting-an-image-to-an-array-of-pixels">  Convertendo uma imagem em uma matriz de pixels </h4><br><p>  O criador de perfil JavaScript no Google Chrome revelou que a fun√ß√£o <code>GetImageData</code> (usada para converter a tela em uma matriz de pixels) √© executada por tempo suficiente.  A prop√≥sito, essas informa√ß√µes podem ser encontradas em v√°rios artigos sobre otimiza√ß√£o do Canvas em JavaScript. </p><br><p>  No entanto, o n√∫mero de chamadas dessa fun√ß√£o pode ser minimizado.  Ou seja, podemos usar a mesma matriz de pixels para opera√ß√µes pixel por pixel, por analogia com a otimiza√ß√£o anterior. </p><br><h2 id="code-examples">  Exemplos de c√≥digo </h2><br><p>  Nos exemplos abaixo, fornecerei os fragmentos de c√≥digo que achei interessantes e √∫teis.  Para evitar que o artigo seja muito longo, ocultei os exemplos em um spoiler. </p><br><h3 id="general">  Geral </h3><br><h4 id="detecting-whether-a-string-is-a-number">  Detectando se uma string √© um n√∫mero </h4><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsNumeric</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> n</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> !SCRIPTSHARP return ((Number)int.Parse(n)).ToString() != "NaN"; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> double number; return double.TryParse(n, out number); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> }</span></span></code> </pre> <br><h4 id="integer-division">  Divis√£o inteira </h4><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Div</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> n, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> k</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> result = n / k; <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> SCRIPTSHARP result = Math.Floor(n / k); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> return result; }</span></span></code> </pre> <br><h4 id="rotating-and-flipping-an-image-using-canvas-and-bitmap">  Girando e invertendo uma imagem usando a tela e o bitmap </h4><br><p>  Observe que, no html5, as imagens de tela podem ser giradas 90 e 180 graus apenas usando matrizes, enquanto o .NET fornece funcionalidade aprimorada.  Assim, uma fun√ß√£o precisa e precisa para trabalhar com pixels foi escrita. </p><br><p>  Tamb√©m √© importante notar que uma rota√ß√£o de 90 graus de qualquer lado na vers√£o .NET pode retornar resultados incorretos.  Portanto, voc√™ precisa criar um novo <code>Bitmap</code> depois de usar a fun√ß√£o <code>RotateFlip</code> . </p><br><div class="spoiler">  <b class="spoiler_title">C√≥digo fonte</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Bitmap </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RotateFlip</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Bitmap bitmap, RotFlipType rotFlipType</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> SCRIPTSHARP int t, i4, j4, w, h, c; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (rotFlipType == RotFlipType.RotateNoneFlipNone) return bitmap; GraphicsContext context; PixelArray data; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (rotFlipType == RotFlipType.RotateNoneFlipX) { context = GraphicsContext.GetContext(bitmap); data = context.GetPixelArray(); w = bitmap.Width; h = bitmap.Height; for (int i = 0; i &lt; h; i++) { c = (i + 1) * w * 4 - 4; for (int j = 0; j &lt; w / 2; j++) { i4 = (i * w + j) * 4; j4 = j * 4; t = (int)data[i4]; data[i4] = data[c - j4]; data[c - j4] = t; t = (int)data[i4 + 1]; data[i4 + 1] = data[c - j4 + 1]; data[c - j4 + 1] = t; t = (int)data[i4 + 2]; data[i4 + 2] = data[c - j4 + 2]; data[c - j4 + 2] = t; t = (int)data[i4 + 3]; data[i4 + 3] = data[c - j4 + 3]; data[c - j4 + 3] = t; } } context.PutImageData(); } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (rotFlipType == RotFlipType.Rotate180FlipNone || rotFlipType == RotFlipType.Rotate180FlipX) { context = GraphicsContext.GetContext(bitmap); data = context.GetPixelArray(); w = bitmap.Width; h = bitmap.Height; c = w * 4 - 4; int dlength4 = data.Length - 4; for (int i = 0; i &lt; data.Length / 4 / 2; i++) { i4 = i * 4; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (rotFlipType == RotFlipType.Rotate180FlipNone) j4 = i4; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> j4 = (Math.Truncate((double)i / w) * w + (w - i % w)) * 4; t = (int)data[j4]; data[j4] = data[dlength4 - i4]; data[dlength4 - i4] = t; t = (int)data[j4 + 1]; data[j4 + 1] = data[dlength4 - i4 + 1]; data[dlength4 - i4 + 1] = t; t = (int)data[j4 + 2]; data[j4 + 2] = data[dlength4 - i4 + 2]; data[dlength4 - i4 + 2] = t; t = (int)data[j4 + 3]; data[j4 + 3] = data[dlength4 - i4 + 3]; data[dlength4 - i4 + 3] = t; } context.PutImageData(); } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> { Bitmap tempBitmap = PrivateUtils.CreateCloneBitmap(bitmap); GraphicsContext tempContext = GraphicsContext.GetContext(tempBitmap); PixelArray temp = tempContext.GetPixelArray(); t = bitmap.Width; bitmap.Width = bitmap.Height; bitmap.Height = t; context = GraphicsContext.GetContext(bitmap); data = context.GetPixelArray(); w = tempBitmap.Width; h = tempBitmap.Height; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (rotFlipType == RotFlipType.Rotate90FlipNone || rotFlipType == RotFlipType.Rotate90FlipX) { c = w * h - w; for (int i = 0; i &lt; temp.Length / 4; i++) { t = Math.Truncate((double)i / h); </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (rotFlipType == RotFlipType.Rotate90FlipNone) i4 = i * 4; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> i4 = (t * h + (h - i % h)) * 4; j4 = (c - w * (i % h) + t) * 4; //j4 = (w * (h - 1 - i4 % h) + i4 / h) * 4; data[i4] = temp[j4]; data[i4 + 1] = temp[j4 + 1]; data[i4 + 2] = temp[j4 + 2]; data[i4 + 3] = temp[j4 + 3]; } } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (rotFlipType == RotFlipType.Rotate270FlipNone || rotFlipType == RotFlipType.Rotate270FlipX) { c = w - 1; for (int i = 0; i &lt; temp.Length / 4; i++) { t = Math.Truncate((double)i / h); </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (rotFlipType == RotFlipType.Rotate270FlipNone) i4 = i * 4; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> i4 = (t * h + (h - i % h)) * 4; j4 = (c + w * (i % h) - t) * 4; // j4 = w * (1 + i4 % h) - i4 / h - 1; data[i4] = temp[j4]; data[i4 + 1] = temp[j4 + 1]; data[i4 + 2] = temp[j4 + 2]; data[i4 + 3] = temp[j4 + 3]; } } context.PutImageData(); } return bitmap; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">elif</span></span></span><span class="hljs-meta"> DOTNET Bitmap result = null; switch (rotFlipType) { case RotFlipType.RotateNoneFlipNone: result = bitmap; break; case RotFlipType.Rotate90FlipNone: bitmap.RotateFlip(RotateFlipType.Rotate90FlipNone); result = new Image(bitmap); bitmap.Dispose(); break; case RotFlipType.Rotate270FlipNone: bitmap.RotateFlip(RotateFlipType.Rotate270FlipNone); result = new Image(bitmap); bitmap.Dispose(); break; case RotFlipType.Rotate180FlipNone: bitmap.RotateFlip(RotateFlipType.Rotate180FlipNone); result = bitmap; break; case RotFlipType.RotateNoneFlipX: bitmap.RotateFlip(RotateFlipType.RotateNoneFlipX); result = bitmap; break; case RotFlipType.Rotate90FlipX: bitmap.RotateFlip(RotateFlipType.Rotate90FlipX); result = new Image(bitmap); bitmap.Dispose(); break; case RotFlipType.Rotate180FlipX: bitmap.RotateFlip(RotateFlipType.Rotate180FlipX); result = bitmap; break; case RotFlipType.Rotate270FlipX: bitmap.RotateFlip(RotateFlipType.Rotate270FlipX); result = new Image(bitmap); bitmap.Dispose(); break; } return result; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> }</span></span></code> </pre> </div></div><br><h4 id="synchronous-and-asynchronous-image-loading">  Carregamento de imagem s√≠ncrona e ass√≠ncrona </h4><br><p>  Observe que, na vers√£o Script #, especificamos uma fun√ß√£o diferente <code>CollageImageLoad</code> , que √© chamada ap√≥s o carregamento de uma imagem, enquanto na vers√£o .NET esses processos ocorrem simultaneamente (de um sistema de arquivos ou da Internet). </p><br><div class="spoiler">  <b class="spoiler_title">C√≥digo fonte</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CollageData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> smallMaskPath, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> bigMaskPath, List&lt;CollageDataPart&gt; dataParts</span></span></span><span class="hljs-function">)</span></span> { SmallMaskImagePath = smallMaskPath; BigMaskImagePath = bigMaskPath; <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> SCRIPTSHARP CurrentMask = PrivateUtils.CreateEmptyImage(); CurrentMask.AddEventListener("load", CollageImageLoad, false); CurrentMask.Src = CurrentMaskImagePath; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> CurrentMask = PrivateUtils.LoadBitmap(CurrentMaskImagePath); </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (!CurrentMaskImagePath.Contains("http://") &amp;&amp; !CurrentMaskImagePath.Contains("https://")) CurrentMask = Bitmap(CurrentMaskImagePath); </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> { var request = WebRequest.Create(CurrentMaskImagePath); using (var response = request.GetResponse()) using (var stream = response.GetResponseStream()) CurrentMask = (Bitmap)Bitmap.FromStream(stream); } #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> DataParts = dataParts; }</span></span></code> </pre> </div></div><br><h3 id="script-only">  Somente script # </h3><br><h4 id="detecting-the-type-and-version-of-a-browser">  Detectando o tipo e a vers√£o de um navegador </h4><br><p>  Esta fun√ß√£o √© usada para determinar os recursos de arrastar e soltar em diferentes navegadores.  Eu tentei usar o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">modernizr</a> , mas ele retornou que o Safari e (no meu caso, era uma vers√£o do Win) o IE9 o implementava.  Na pr√°tica, esses navegadores falham ao implementar os recursos de arrastar e soltar corretamente. </p><br><div class="spoiler">  <b class="spoiler_title">C√≥digo fonte</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> BrowserVersion { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { DetectBrowserTypeAndVersion(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _browserVersion; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DetectBrowserTypeAndVersion</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_browserDetected) { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> userAgent = Window.Navigator.UserAgent.ToLowerCase(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userAgent.IndexOf(<span class="hljs-string"><span class="hljs-string">"opera"</span></span>) != <span class="hljs-number"><span class="hljs-number">-1</span></span>) _browser = BrowserType.Opera; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userAgent.IndexOf(<span class="hljs-string"><span class="hljs-string">"chrome"</span></span>) != <span class="hljs-number"><span class="hljs-number">-1</span></span>) _browser = BrowserType.Chrome; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userAgent.IndexOf(<span class="hljs-string"><span class="hljs-string">"safari"</span></span>) != <span class="hljs-number"><span class="hljs-number">-1</span></span>) _browser = BrowserType.Safari; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userAgent.IndexOf(<span class="hljs-string"><span class="hljs-string">"firefox"</span></span>) != <span class="hljs-number"><span class="hljs-number">-1</span></span>) _browser = BrowserType.Firefox; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userAgent.IndexOf(<span class="hljs-string"><span class="hljs-string">"msie"</span></span>) != <span class="hljs-number"><span class="hljs-number">-1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> numberIndex = userAgent.IndexOf(<span class="hljs-string"><span class="hljs-string">"msie"</span></span>) + <span class="hljs-number"><span class="hljs-number">5</span></span>; _browser = BrowserType.IE; _browserVersion = userAgent.Substring(numberIndex, userAgent.IndexOf(<span class="hljs-string"><span class="hljs-string">';'</span></span>, numberIndex)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> _browser = BrowserType.Unknown; _browserDetected = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } }</code> </pre> </div></div><br><h4 id="rendering-a-dash-dot-line">  Renderizando uma linha tracejada </h4><br><p>  Este c√≥digo √© usado para um ret√¢ngulo para cortar imagens.  Obrigado pelas id√©ias a todos que responderam a esta <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">pergunta no stackoverflow</a> . </p><br><div class="spoiler">  <b class="spoiler_title">C√≥digo fonte</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DrawDahsedLine</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GraphicsContext context, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x1, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y1, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x2, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y2, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] dashArray</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dashArray == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) dashArray = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[<span class="hljs-number"><span class="hljs-number">2</span></span>] { <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> dashCount = dashArray.Length; <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> dx = x2 - x1; <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> dy = y2 - y1; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> xSlope = Math.Abs(dx) &gt; Math.Abs(dy); <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> slope = xSlope ? dy / dx : dx / dy; context.MoveTo(x1, y1); <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> distRemaining = Math.Sqrt(dx * dx + dy * dy); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> dashIndex = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (distRemaining &gt;= <span class="hljs-number"><span class="hljs-number">0.1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> dashLength = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)Math.Min(distRemaining, dashArray[dashIndex % dashCount]); <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> step = Math.Sqrt(dashLength * dashLength / (<span class="hljs-number"><span class="hljs-number">1</span></span> + slope * slope)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xSlope) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dx &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) step = -step; x1 += step; y1 += slope * step; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dy &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) step = -step; x1 += slope * step; y1 += step; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dashIndex % <span class="hljs-number"><span class="hljs-number">2</span></span> == <span class="hljs-number"><span class="hljs-number">0</span></span>) context.LineTo(x1, y1); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> context.MoveTo(x1, y1); distRemaining -= dashLength; dashIndex++; } }</code> </pre> </div></div><br><h4 id="rotation-animation">  Anima√ß√£o de rota√ß√£o </h4><br><p>  <code>setInterval</code> fun√ß√£o <code>setInterval</code> √© usada para implementar a anima√ß√£o de rota√ß√£o de imagem.  Observe que a imagem resultante √© calculada durante a anima√ß√£o, para que n√£o haja atrasos no final da anima√ß√£o. </p><br><div class="spoiler">  <b class="spoiler_title">C√≥digo fonte</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Rotate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> cw</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_rotating &amp;&amp; !_flipping) { _rotating = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; _cw = cw; RotFlipType oldRotFlipType = _curRotFlipType; _curRotFlipType = RotateRotFlipValue(_curRotFlipType, _cw); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> currentStep = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> stepCount = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)(RotateFlipTimeSeconds * <span class="hljs-number"><span class="hljs-number">1000</span></span> / StepTimeTicks); Bitmap result = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; _interval = Window.SetInterval(<span class="hljs-keyword"><span class="hljs-keyword">delegate</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentStep &lt; stepCount) { <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> absAngle = GetAngle(oldRotFlipType) + currentStep / stepCount * Math.PI / <span class="hljs-number"><span class="hljs-number">2</span></span> * (_cw ? <span class="hljs-number"><span class="hljs-number">-1</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>); DrawRotated(absAngle); currentStep++; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Window.ClearInterval(_interval); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) Draw(result); _rotating = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }, StepTimeTicks); result = GetCurrentTransformResult(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_rotating) Draw(result); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DrawRotated</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> rotAngle</span></span></span><span class="hljs-function">)</span></span> { _resultContext.FillColor = FillColor; _resultContext.FillRect(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, _result.Width, _result.Height); _resultContext.Save(); _resultContext._graphics.Translate(_result.Width / <span class="hljs-number"><span class="hljs-number">2</span></span>, _result.Height / <span class="hljs-number"><span class="hljs-number">2</span></span>); _resultContext._graphics.Rotate(-rotAngle); _resultContext._graphics.Translate(-_origin.Width / <span class="hljs-number"><span class="hljs-number">2</span></span>, -_origin.Height / <span class="hljs-number"><span class="hljs-number">2</span></span>); _resultContext._graphics.DrawImage(_origin, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); _resultContext.Restore(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Draw</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Bitmap bitmap</span></span></span><span class="hljs-function">)</span></span> { _resultContext.FillColor = FillColor; _resultContext.FillRect(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, _result.Width, _result.Height); _resultContext.Draw2(bitmap, (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)((_result.Width - bitmap.Width) / <span class="hljs-number"><span class="hljs-number">2</span></span>), (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)((_result.Height - bitmap.Height) / <span class="hljs-number"><span class="hljs-number">2</span></span>)); }</code> </pre> </div></div><br><h2 id="conclusion">  Conclus√£o </h2><br><p>  Este artigo descreve como a linguagem C # (combinando c√≥digo n√£o gerenciado e compila√ß√£o para JavaScript) pode ser usada para criar uma solu√ß√£o realmente multiplataforma.  Apesar do foco no .NET e JavaScript, a compila√ß√£o para Android, iOS (usando Mono) e Windows Phone tamb√©m √© poss√≠vel com base nessa abordagem, que, √© claro, tem suas armadilhas.  O c√≥digo √© um pouco redundante devido √† sua universalidade, mas n√£o afeta o desempenho, pois as opera√ß√µes gr√°ficas geralmente levam muito mais tempo. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt440342/">https://habr.com/ru/post/pt440342/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt440328/index.html">A probabilidade de ganhar uma partida com a probabilidade conhecida de ganhar um ponto II</a></li>
<li><a href="../pt440330/index.html">Brevemente sobre abstra√ß√µes</a></li>
<li><a href="../pt440332/index.html">Banco de dados nas nuvens: para quem e por qu√™ - a opini√£o dos especialistas em Data Egret</a></li>
<li><a href="../pt440336/index.html">HTML perdemos</a></li>
<li><a href="../pt440338/index.html">Como garantir a disponibilidade de um servi√ßo da web na nuvem no caso de uma falha no data center</a></li>
<li><a href="../pt440344/index.html">InterNyet - como a Internet foi inventada na Uni√£o Sovi√©tica e por que n√£o funcionou</a></li>
<li><a href="../pt440346/index.html">No final de fevereiro, a Microsoft apresentar√° os √≥culos VR HoloLens 2</a></li>
<li><a href="../pt440350/index.html">Flying Bear Tornado 2 - um novo urso chegou</a></li>
<li><a href="../pt440352/index.html">Hack de massa VKontakte [XSS-worm]</a></li>
<li><a href="../pt440354/index.html">Eventos digitais em Moscou, de 18 a 24 de fevereiro</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>