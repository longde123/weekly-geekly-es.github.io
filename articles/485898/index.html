<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèæ üìÑ üë®‚Äçüíª Exporte Google Forms + descargue Google Script a trav√©s de REST API (Python) üõÄüèø üèáüèª üõ¥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ten√≠amos dos formularios de Google, 75 preguntas en cada uno, 5 usuarios comerciales que editaron activamente estos formularios, y tambi√©n un script d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Exporte Google Forms + descargue Google Script a trav√©s de REST API (Python)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/485898/"><img src="https://habrastorage.org/webt/gi/tl/nl/gitlnlklzpbmybk3jz3utl4_uow.png"><br><br>  Ten√≠amos dos formularios de Google, 75 preguntas en cada uno, 5 usuarios comerciales que editaron activamente estos formularios, y tambi√©n un script de Google que exportaba el formulario a JSON.  No es que sea dif√≠cil ejecutarlo cada vez con las manos, pero una vez que comience a automatizar su trabajo, contin√∫e en este pasatiempo hasta el final. <br><br>  En la documentaci√≥n oficial, el diablo se romper√° la pierna, as√≠ que debajo del gato veremos m√°s de cerca la descarga remota y el lanzamiento de Google Apps Script a trav√©s de la API REST usando Python. <br><a name="habracut"></a><br><h2>  Introduccion </h2><br>  En Doctor Near, estamos desarrollando una plataforma para bots de chat, en la que los formularios de Google se utilizan para describir escenarios.  En consecuencia, quiero obtener un JSON de los formularios con solo hacer clic en un bot√≥n que contiene nodos (puntos de formulario) y metadatos (transiciones entre nodos, tipos de nodos, su nombre).  Parece que el deseo es simple, pero Google no es compatible con esta funcionalidad y tiene que armar este "exportador" con sus propias manos.  Considere los pasos para crearlo. <br><br><h2>  PASO 1. Script de Google Apps </h2><br>  Google ha proporcionado la capacidad de interactuar con sus servicios (Hojas de c√°lculo, Documentos, Formularios) a trav√©s de Google Apps Script: scripts escritos en google script (.gs).  Este art√≠culo no proporciona un an√°lisis del lenguaje de script de google, por lo que dar√© un ejemplo de un script listo que crea JSON a partir de un formulario de Google existente.  El <a href="" rel="nofollow">c√≥digo de</a> usuario <a href="https://github.com/stevenschmatz" rel="nofollow">Steven Schmatz</a> fue tomado del github como base, por lo que le expreso mi gratitud. <br><br><div class="spoiler">  <b class="spoiler_title">C√≥digo de script</b> <div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// Steven Schmatz // Humanitas Labs // 13 October, 2016. // Roman Shekhovtsov // dr-telemed.ru // Autumn 2019 // Nikita Orekhov // dr-telemed.ru // Autumn 2019 /** * Converts the given form URL into a JSON object. */ function main() { form_url = "&lt;YOUR_FORM_URL&gt;" var form = FormApp.openByUrl(form_url); var items = form.getItems(); var result = { "metadata": getFormMetadata(form), "items": items.map(itemToObject), "count": items.length }; // sendEmail("&lt;YOUR_EMAIL&gt;", result) return result; } /** If we want to receive data by email * Sends JSON as text to recipient email * @param recipient: String * @param result: JSON */ function sendEmail(recipient, json_file){ var subject = "google form json import" var body = JSON.stringify(json_file); Logger.log(body); MailApp.sendEmail(recipient, subject, body); } /** * Returns the form metadata object for the given Form object. * @param form: Form * @returns (Object) object of form metadata. */ function getFormMetadata(form) { return { "title": form.getTitle(), "id": form.getId(), "description": form.getDescription(), "publishedUrl": form.getPublishedUrl(), "editorEmails": form.getEditors().map(function(user) { return user.getEmail() }), "count": form.getItems().length, "confirmationMessage": form.getConfirmationMessage(), "customClosedFormMessage": form.getCustomClosedFormMessage() }; } /** * Returns an Object for a given Item. * @param item: Item * @returns (Object) object for the given item. */ function itemToObject(item) { var data = {}; data.type = item.getType().toString(); // Downcast items to access type-specific properties var itemTypeConstructorName = snakeCaseToCamelCase("AS_" + item.getType().toString() + "_ITEM"); var typedItem = item[itemTypeConstructorName](); // Keys with a prefix of "get" have "get" stripped var getKeysRaw = Object.keys(typedItem).filter(function(s) {return s.indexOf("get") == 0}); getKeysRaw.map(function(getKey) { var propName = getKey[3].toLowerCase() + getKey.substr(4); // Image data, choices, and type come in the form of objects / enums if (["image", "choices", "type", "alignment"].indexOf(propName) != -1) {return}; // Skip feedback-related keys if ("getFeedbackForIncorrect".equals(getKey) || "getFeedbackForCorrect".equals(getKey) || "getGeneralFeedback".equals(getKey)) {return}; var propValue = typedItem[getKey](); data[propName] = propValue; }); // Bool keys are included as-is var boolKeys = Object.keys(typedItem).filter(function(s) { return (s.indexOf("is") == 0) || (s.indexOf("has") == 0) || (s.indexOf("includes") == 0); }); boolKeys.map(function(boolKey) { var propName = boolKey; var propValue = typedItem[boolKey](); data[propName] = propValue; }); // Handle image data and list choices switch (item.getType()) { case FormApp.ItemType.LIST: case FormApp.ItemType.CHECKBOX: data.choices = typedItem.getChoices().map(function(choice) { return choice.getValue() }); case FormApp.ItemType.MULTIPLE_CHOICE: data.choices = typedItem.getChoices().map(function(choice) { gotoPage = choice.getGotoPage() if (gotoPage == null) return choice.getValue() else return { "value": choice.getValue(), "gotoPage":choice.getGotoPage().getId() }; }); break; case FormApp.ItemType.IMAGE: data.alignment = typedItem.getAlignment().toString(); if (item.getType() == FormApp.ItemType.VIDEO) { return; } var imageBlob = typedItem.getImage(); data.imageBlob = { "dataAsString": "", //imageBlob.getDataAsString(), - BLOB too big "name": imageBlob.getName(), "isGoogleType": imageBlob.isGoogleType() }; break; case FormApp.ItemType.PAGE_BREAK: data.pageNavigationType = typedItem.getPageNavigationType().toString(); break; default: break; } // Have to do this because for some reason Google Scripts API doesn't have a // native VIDEO type if (item.getType().toString() === "VIDEO") { data.alignment = typedItem.getAlignment().toString(); } return data; } /** * Converts a SNAKE_CASE string to a camelCase string. * @param s: string in snake_case * @returns (string) the camelCase version of that string */ function snakeCaseToCamelCase(s) { return s.toLowerCase().replace(/(\_\w)/g, function(m) {return m[1].toUpperCase();}); }</span></span></code> </pre> <br></div></div><br>  Lo que sucede en el c√≥digo: <br><br><ul><li>  Funci√≥n <i>getFormMetadata</i> : devuelve JSON con metadatos de formulario </li><li>  Funci√≥n <i>itemToObject</i> : convierte el objeto <i>form.item</i> a JSON con los campos obligatorios </li><li>  Funci√≥n <i>sendEmail</i> : env√≠a un archivo JSON al correo especificado en texto </li><li>  funci√≥n <i>principal</i> : devuelve el JSON resultante </li><li>  la variable <i>form_url</i> en la funci√≥n <i>principal</i> es la direcci√≥n de nuestro formulario de google </li></ul><br><h2>  PASO 2. Probar el gui√≥n </h2><br>  Por el momento, el rendimiento del script se puede verificar de la siguiente manera: <br><br><ol><li>  <a href="https://script.google.com/home/start" rel="nofollow">crea</a> tu propio proyecto de script de aplicaci√≥n </li><li>  copia el c√≥digo en √©l </li><li>  en lugar de <i>&lt;YOUR_FORM_URL&gt;,</i> sustituimos la direcci√≥n de nuestro formulario del formulario <i><a href="https://docs.google.com/forms/d/FORM_IDENTIFICATOR/edit" rel="nofollow">docs.google.com/forms/d/FORM_IDENTIFICATOR/edit</a></i> </li><li>  descomentar la llamada a <i>sendEmail</i> en la funci√≥n <i>principal</i> </li><li>  en lugar de <i>&lt;YOUR_EMAIL&gt;</i> sustituimos la direcci√≥n de correo electr√≥nico a la que queremos recibir JSON </li><li>  guardar el proyecto </li><li>  ejecuta la funci√≥n <i>principal</i> </li><li>  Si esta es la primera ejecuci√≥n de la secuencia de comandos, el sistema le informar√° sobre la necesidad de dar permiso a la secuencia de comandos para enviar correos electr√≥nicos desde su direcci√≥n.  No tengas miedo.  Este es el procedimiento est√°ndar requerido para probar el script.  Vaya a ‚ÄúRevisar permisos‚Äù -&gt; seleccione su cuenta -&gt; ‚ÄúAvanzado‚Äù -&gt; ‚ÄúIr al proyecto PROJECT_NAME (inseguro)‚Äù -&gt; ‚ÄúPermitir‚Äù </li><li>  esperando que el script funcione </li><li>  mire en el buz√≥n y vea el archivo JSON en forma de texto </li></ol><br>  Todo estar√≠a bien, pero el uso adicional de los datos obtenidos implica la copia manual del correo, el procesamiento de este texto (en Python, por ejemplo) y el almacenamiento del archivo resultante.  No suena demasiado listo para la producci√≥n.  Automatizamos el lanzamiento de este script y obtenemos su resultado a trav√©s de la API de Google Apps Script, pero primero configuramos nuestro proyecto de Google en consecuencia. <br><br>  <b>Atenci√≥n:</b> para la conveniencia de comprender lo que est√° sucediendo, a continuaci√≥n me referir√© solo a dos p√°ginas, por lo tanto, se recomienda abrirlas en pesta√±as adyacentes: <br><br><ol><li>  Gui√≥n / <a href="https://script.google.com/home" rel="nofollow">P√°gina de</a> edici√≥n de guiones - <i>‚ÄúP√°gina 1‚Äù</i> </li><li>  P√°gina de Google Cloud Platform - <i>"P√°gina 2"</i> </li></ol><br><h2>  PASO 3. Configure Google Cloud Platform </h2><br>  Vamos a Google Cloud Platform (p√°gina 2), creamos un nuevo proyecto.  Es necesario crear un nuevo proyecto, porque el estado predeterminado del proyecto es Predeterminado, y Standart es necesario para nuestros prop√≥sitos.  M√°s detalles se pueden encontrar <a href="https://developers.google.com/apps-script/guides/cloud-platform-projects" rel="nofollow">aqu√≠</a> (punto 3). <br><br>  Regresamos a la p√°gina 2, vaya a la pesta√±a "API y servicios", luego a "Ventana de solicitud de acceso de OAuth".  Establezca el Tipo de usuario en "Externo". <br><br>  En la ventana que aparece, complete el "Nombre de la aplicaci√≥n". <br><br>  Abra la p√°gina de inicio en Google Cloud Platform.  Desde el bloque "Informaci√≥n del proyecto" copie el n√∫mero del proyecto. <br><br>  Vaya a la p√°gina 1. Abra el script creado anteriormente.  En la ventana de edici√≥n de script abierta, vaya a "Recursos" -&gt; "Proyecto de plataforma en la nube".  En el campo "Cambiar proyecto", ingrese el n√∫mero de proyecto copiado previamente.  Ahora este script est√° asociado con el proyecto creado. <br><br><h2>  PASO 4. API REST de Python </h2><br>  Es hora de automatizar el script usando la <a href="https://developers.google.com/apps-script/api/reference/rest" rel="nofollow">API REST</a> .  Python fue usado como el lenguaje. <br><br><h3>  Inicio de sesi√≥n de API de Apps Script </h3><br>  El c√≥digo debe tener acceso al proyecto, por lo que el primer y muy importante procedimiento es el inicio de sesi√≥n en la API de Apps Script.  Abra la p√°gina 2 -&gt; ‚ÄúAPI y servicios‚Äù -&gt; ‚ÄúCredenciales‚Äù -&gt; ‚ÄúCrear credenciales‚Äù -&gt; ‚ÄúIdentificador de cliente OAuth‚Äù -&gt; ‚ÄúOtros tipos‚Äù.  Llamamos a nuestro identificador, ve a √©l.  En la pesta√±a "Credenciales", seleccione "Descargar archivo JSON".  Esto cargar√° el archivo de clave para acceder desde el c√≥digo al proyecto en Google.  Colocamos este archivo en la carpeta de credenciales. <br><br>  Ahora debe dar permiso para usar la API (en nuestro caso, la API de script de aplicaciones) como parte de este proyecto.  Para hacer esto, vaya a "API y servicios" -&gt; "Biblioteca" -&gt; escriba "API de script de aplicaciones" en la b√∫squeda y haga clic en "Habilitar". <br><br>  Las aplicaciones que interact√∫an con Google tienen muchos permisos que el usuario debe otorgar al iniciarlo.  Esta copia depende de las funciones utilizadas por un script en particular y puede encontrarla yendo a la p√°gina 1 en la ventana de edici√≥n del script en "Archivo" -&gt; "Propiedades del proyecto" -&gt; "√Åmbitos".  Estos permisos deben conservarse para futuras referencias en el c√≥digo. <br><br>  En este caso, la funci√≥n de inicio de sesi√≥n se ver√° as√≠: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pickle <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os.path <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> googleapiclient.discovery <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> build <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> google_auth_oauthlib.flow <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> InstalledAppFlow <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> google.auth.transport.requests <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Request <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">login</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(config)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: creds = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-comment"><span class="hljs-comment"># The file token.pickle stores the user's access and refresh tokens, and is # created automatically when the authorization flow completes for the first # time. token_file = config['credentials_path'] + config['token_file'] credentials_file = config['credentials_path'] + config['credentials_file'] if os.path.exists(token_file): with open(token_file, 'rb') as token: creds = pickle.load(token) # If there are no (valid) credentials available, let the user log in. if not creds or not creds.valid: if creds and creds.expired and creds.refresh_token: creds.refresh(Request()) else: flow = InstalledAppFlow.from_client_secrets_file(credentials_file, config['SCOPES']) creds = flow.run_local_server(port=0) # Save the credentials for the next run with open(token_file, 'wb') as token: pickle.dump(creds, token) service = build('script', 'v1', credentials=creds) pprint('Login successful') return service except Exception as e: pprint(f'Login failure: {e}') return None</span></span></code> </pre><br>  Este bloque de c√≥digo es el procedimiento est√°ndar para comenzar con Google App Script. <br>  Usamos un token de autenticaci√≥n y, al iniciar sesi√≥n, creamos un token nuevo o usamos uno existente. <br><br>  Por conveniencia, se cre√≥ un archivo de configuraci√≥n JSON, que tiene la siguiente forma: <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"SCOPES"</span></span>: [<span class="hljs-string"><span class="hljs-string">"https://www.googleapis.com/auth/forms"</span></span>, <span class="hljs-string"><span class="hljs-string">"https://www.googleapis.com/auth/script.send_mail"</span></span>], <span class="hljs-attr"><span class="hljs-attr">"credentials_path"</span></span>: <span class="hljs-string"><span class="hljs-string">"credentials/"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"credentials_file"</span></span>: <span class="hljs-string"><span class="hljs-string">"google_test_project.json"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"token_file"</span></span>: <span class="hljs-string"><span class="hljs-string">"token.pickle"</span></span> }</code> </pre><br>  <b>Importante: el</b> token se crea para la autenticaci√≥n con un alcance espec√≠fico de permisos.  En otras palabras, al cambiar el alcance de los permisos, debe eliminar el token y crear uno nuevo al iniciar sesi√≥n. <br><br><h3>  C√≥digo de script de actualizaci√≥n remota </h3><br>  Ahora aprenderemos c√≥mo actualizar remotamente el c√≥digo del script, luego ejecutar este c√≥digo y obtener el resultado.  De hecho, adem√°s del c√≥digo que ejecutamos en el editor de Google, tambi√©n hay un <a href="https://developers.google.com/apps-script/concepts/manifests" rel="nofollow">archivo de manifiesto</a> que contiene los derechos de inicio, la configuraci√≥n de implementaci√≥n, etc.  M√°s informaci√≥n sobre su estructura se puede encontrar <a href="https://developers.google.com/apps-script/manifest/" rel="nofollow">aqu√≠</a> . <br>  Para ver el archivo de manifiesto predeterminado creado por Google para su script, vaya al editor de script en "Ver" -&gt; "Mostrar archivo de manifiesto".  El manifiesto aparecer√° en la lista de archivos relacionados con este script. <br><br>  El discurso sobre el manifiesto no fue sin raz√≥n: la actualizaci√≥n remota de scripts requiere la descarga del c√≥digo de ambos archivos (* .gs) y manifiesto (appscript.json). <br><br>  Primero, lea el c√≥digo del archivo .gs que queremos implementar: <br><br><pre> <code class="python hljs"> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">'export-google-form.gs'</span></span>, <span class="hljs-string"><span class="hljs-string">'r'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: sample_code = f.read()</code> </pre><br>  Ahora copie el manifiesto generado autom√°ticamente y modif√≠quelo un poco para nuestros prop√≥sitos.  La documentaci√≥n describe completamente la estructura del archivo de manifiesto, por lo que no me detendr√© en este punto.  Para que el script funcione, debe agregar la secci√≥n "executeApi" al manifiesto predeterminado, que se requiere para ejecutar el script de forma remota a trav√©s de la API.  En esta secci√≥n indicamos el c√≠rculo de personas que tienen la capacidad de ejecutarlo.  Permit√≠ el lanzamiento para todos los que han aprobado la autorizaci√≥n, que corresponde al identificador "CUALQUIERA": <br><br><pre> <code class="python hljs">MANIFEST = <span class="hljs-string"><span class="hljs-string">''' { "timeZone": "America/New_York", "exceptionLogging": "STACKDRIVER", "executionApi": { "access": "ANYONE" } } '''</span></span>.strip()</code> </pre><br>  El cuerpo de la solicitud de actualizaci√≥n debe contener una matriz de archivos con la siguiente estructura: <br><br><ul><li>  <i>nombre</i> : nombre del archivo que se crear√° en el servidor, sin extensi√≥n </li><li>  <i>tipo</i> : <i>tipo de</i> archivo (JSON para manifiesto, SERVER_JS para .gs) </li><li>  <i>fuente</i> : c√≥digo de archivo </li></ul><br><pre> <code class="python hljs">request = { <span class="hljs-string"><span class="hljs-string">'files'</span></span>: [{ <span class="hljs-string"><span class="hljs-string">'name'</span></span>: <span class="hljs-string"><span class="hljs-string">'hello'</span></span>, <span class="hljs-string"><span class="hljs-string">'type'</span></span>: <span class="hljs-string"><span class="hljs-string">'SERVER_JS'</span></span>, <span class="hljs-string"><span class="hljs-string">'source'</span></span>: sample_code }, { <span class="hljs-string"><span class="hljs-string">'name'</span></span>: <span class="hljs-string"><span class="hljs-string">'appsscript'</span></span>, <span class="hljs-string"><span class="hljs-string">'type'</span></span>: <span class="hljs-string"><span class="hljs-string">'JSON'</span></span>, <span class="hljs-string"><span class="hljs-string">'source'</span></span>: MANIFEST } ] }</code> </pre><br>  Finalmente, la solicitud de actualizaci√≥n en s√≠ misma debe contener el cuerpo (solicitud descrita anteriormente) y el ID del script.  Este √∫ltimo puede obtenerse yendo al "Archivo" -&gt; "Propiedades del proyecto" en el editor de script y copiando el "ID del script": <br><br><pre> <code class="python hljs">script_id = <span class="hljs-string"><span class="hljs-string">'qwertyuiopQWERTYUIOPasdfghjkl123456789zxcvbnmASDFGHJKL54'</span></span></code> </pre><br>  Para el objeto de servicio obtenido como resultado del inicio de sesi√≥n, obtenemos el campo projects () y llamamos al m√©todo updateContent (), despu√©s de lo cual llamamos al m√©todo execute () para el objeto HttpRequest recibido: <br><br><pre> <code class="python hljs">service.projects().updateContent( body=request, scriptId=script_id ).execute()</code> </pre><br>  Sin embargo, por ahora, ejecutar el c√≥digo dar√° como resultado un error: <br><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"error"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"code"</span></span>: <span class="hljs-number"><span class="hljs-number">403</span></span>, <span class="hljs-attr"><span class="hljs-attr">"message"</span></span>: <span class="hljs-string"><span class="hljs-string">"Request had insufficient authentication scopes."</span></span>, <span class="hljs-attr"><span class="hljs-attr">"status"</span></span>: <span class="hljs-string"><span class="hljs-string">"PERMISSION_DENIED"</span></span> }</code> </pre><br>  Como puede ver, no hay suficientes permisos en el √°guila pescadora de autenticaci√≥n, que indicamos anteriormente.  Pasamos a la documentaci√≥n oficial en la API, a saber, el m√©todo <a href="https://developers.google.com/apps-script/api/reference/rest/v1/projects/updateContent" rel="nofollow">updateContent</a> , que utilizamos para actualizar el script de forma remota.  La documentaci√≥n dice que usar este m√©todo requiere habilitar el acceso a script.projects: <br><br><pre> <code class="python hljs">https://www.googleapis.com/auth/script.projects</code> </pre> <br>  Agr√©guelo a nuestro archivo de configuraci√≥n en la secci√≥n ALCANCE.  Como escrib√≠ anteriormente, al cambiar el √°guila pescadora, es necesario eliminar el token generado autom√°ticamente. <br><br>  Genial  Por el momento, hemos aprendido a actualizar remotamente el script de Google.  Queda por ejecutarlo y obtener el resultado de la ejecuci√≥n. <br><br><h3>  Script ejecutado </h3><br>  La solicitud de <a href="https://developers.google.com/apps-script/api/reference/rest/v1/scripts/run" rel="nofollow">inicio del script</a> contiene scriptID y cuerpo con la siguiente estructura: <br><br><ul><li>  <i>funci√≥n</i> : nombre de la funci√≥n que queremos ejecutar </li><li>  <i>par√°metros</i> : <i>(opcional) un</i> conjunto de par√°metros de un tipo primitivo (cadena, matriz ...) pasados ‚Äã‚Äãa la funci√≥n </li><li>  <i>sessionState</i> : <i>(opcional)</i> se requiere solo para aplicaciones de Android </li><li>  <i>devMode</i> : <i>(opcional)</i> Verdadero si el usuario es el propietario del script y luego se lanzar√° la √∫ltima versi√≥n que la que se implement√≥ utilizando la API de Script de Apps.  (por defecto - Falso) </li></ul><br>  Para no unir la URL del formulario de Google en el script, pasaremos <i>form_url</i> a la funci√≥n <i>principal</i> como argumento. <br><br>  <b>Atencion</b>  Cuando probamos el script, la funci√≥n <i>principal</i> no aceptaba nada, por lo que cambiaremos las primeras l√≠neas de c√≥digo en el archivo .gs de la siguiente manera: <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">form_url</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> form = FormApp.openByUrl(form_url); .......</code> </pre><br>  Como nuestra aplicaci√≥n no es para Android y somos los propietarios del script, el cuerpo se ver√° as√≠: <br><br><pre> <code class="python hljs">body = { <span class="hljs-string"><span class="hljs-string">"function"</span></span>: <span class="hljs-string"><span class="hljs-string">"main"</span></span>, <span class="hljs-string"><span class="hljs-string">"devMode"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, <span class="hljs-string"><span class="hljs-string">"parameters"</span></span>: form_url }</code> </pre><br>  Ejecute el script y escriba el resultado de la ejecuci√≥n en la variable resp: <br><br><pre> <code class="python hljs">resp = service.scripts().run(scriptId=script_id, body=body).execute()</code> </pre><br>  Guarde resp en un archivo con el formato JSON conveniente: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">'habr_auto.json'</span></span>, <span class="hljs-string"><span class="hljs-string">'w'</span></span>, encoding=<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: json.dump(resp[<span class="hljs-string"><span class="hljs-string">'response'</span></span>][<span class="hljs-string"><span class="hljs-string">'result'</span></span>], f, ensure_ascii=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>, indent=<span class="hljs-number"><span class="hljs-number">4</span></span>)</code> </pre><br>  <b>Atencion</b>  Debido al hecho de que la solicitud script.run () est√° esperando el resultado a trav√©s del socket, cuando el tiempo de ejecuci√≥n excede el tiempo de espera, se producir√° un error del siguiente tipo: <br><br><pre> <code class="python hljs">socket.timeout: The read operation timed out</code> </pre><br>  Para evitar este comportamiento, recomiendo que al comienzo del programa establezca un l√≠mite en el tiempo de socket abierto, obviamente suficiente para que espere a que el script termine de ejecutarse.  En mi caso, 120 segundos son suficientes: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> socket socket.setdefaulttimeout(<span class="hljs-number"><span class="hljs-number">120</span></span>)</code> </pre><br>  Voila!  Ya est√° lista una tuber√≠a conveniente para la actualizaci√≥n remota y el lanzamiento de scripts de Google.  El c√≥digo completo adaptado para el lanzamiento desde la terminal se da en mi <a href="https://github.com/nikanor97/habr_google_script_api" rel="nofollow">github</a> . <br><br>  Adem√°s, dar√© el c√≥digo de las funciones principales a continuaci√≥n <br><br><div class="spoiler">  <b class="spoiler_title">login.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pprint <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pprint <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pickle <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os.path <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> googleapiclient.discovery <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> build <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> google_auth_oauthlib.flow <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> InstalledAppFlow <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> google.auth.transport.requests <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Request <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">login</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(config)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: creds = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-comment"><span class="hljs-comment"># The file token.pickle stores the user's access and refresh tokens, and is # created automatically when the authorization flow completes for the first # time. token_file = config['credentials_path'] + config['token_file'] credentials_file = config['credentials_path'] + config['credentials_file'] if os.path.exists(token_file): with open(token_file, 'rb') as token: creds = pickle.load(token) # If there are no (valid) credentials available, let the user log in. if not creds or not creds.valid: if creds and creds.expired and creds.refresh_token: creds.refresh(Request()) else: flow = InstalledAppFlow.from_client_secrets_file(credentials_file, config['SCOPES']) creds = flow.run_local_server(port=0) # Save the credentials for the next run with open(token_file, 'wb') as token: pickle.dump(creds, token) service = build('script', 'v1', credentials=creds) pprint('Login successful') return service except Exception as e: pprint(f'Login failure: {e}') return None</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">update_script.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pprint <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pprint <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sys <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> googleapiclient <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> errors <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> google_habr_login <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> login MANIFEST = <span class="hljs-string"><span class="hljs-string">''' { "timeZone": "America/New_York", "exceptionLogging": "STACKDRIVER", "executionApi": { "access": "ANYONE" } } '''</span></span>.strip() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">update_project</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(service, script_id, script_file_name)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># Read from file code we want to deploy with open(script_file_name, 'r') as f: sample_code = f.read() # Upload two files to the project request = { 'files': [{ 'name': 'hello', 'type': 'SERVER_JS', 'source': sample_code }, { 'name': 'appsscript', 'type': 'JSON', 'source': MANIFEST } ] } # Update files in the project service.projects().updateContent( body=request, scriptId=script_id ).execute() pprint('Project was successfully updated') def main(): try: args = sys.argv if len(args) != 4: raise TypeError('Wrong number of arguments. Three argument required: &lt;config_file_name&gt;, &lt;script_id&gt; and ' '&lt;script_file_name&gt;') config_file_name = args[1] script_id = args[2] script_file_name = args[3] with open(config_file_name, "r") as f: config = json.load(f) service = login(config) update_project(service, script_id, script_file_name) except (errors.HttpError, ) as error: # The API encountered a problem. pprint(error.content.decode('utf-8')) if __name__ == '__main__': main()</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">export_form.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pprint <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pprint <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> socket <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sys <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> googleapiclient <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> errors <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> google_habr_login <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> login socket.setdefaulttimeout(<span class="hljs-number"><span class="hljs-number">120</span></span>) <span class="hljs-comment"><span class="hljs-comment"># Get JSON, which is returned by script def get_json(service, file_name, script_id, form_url): pprint('Exporting form...') body = { "function": "main", "devMode": True, "parameters": form_url } # Get JSON from script resp = service.scripts().run(scriptId=script_id, body=body).execute() # Write out JSON to file with open(file_name, 'w', encoding='utf-8') as f: json.dump(resp['response']['result'], f, ensure_ascii=False, indent=4) pprint('Form was successfully exported') def main(): try: args = sys.argv if len(args) != 5: raise TypeError('Wrong number of arguments. Four arguments required: &lt;config_file_name&gt;, ' '&lt;result_file_name&gt;, &lt;script_id&gt; and &lt;google_form_url&gt;') config_file_name = args[1] file_name = args[2] script_id = args[3] form_url = args[4] with open(config_file_name, "r") as f: config = json.load(f) service = login(config) get_json(service, file_name, script_id, form_url) except (errors.HttpError, ) as error: # The API encountered a problem. pprint(error.content.decode('utf-8')) if __name__ == '__main__': main()</span></span></code> </pre><br></div></div><br>  Para comenzar, debe colocar el archivo JSON con las claves de acceso de Google en la carpeta de credenciales y la configuraci√≥n JSON en el mismo directorio que los scripts. <br><br>  Luego, si queremos actualizar el script de forma remota, en la llamada del terminal: <br><br><pre> <code class="bash hljs">python update_script.py &lt;config_file_name&gt; &lt;script_id&gt; &lt;script_file_name&gt;</code> </pre><br>  En este caso: <br><br><ul><li>  <i>config_file_name</i> : nombre del archivo JSON de configuraci√≥n </li><li>  <i>script_id</i> - ID del script </li><li>  <i>script_file_name</i> : el nombre del archivo .gs que se cargar√° en google </li></ul><br>  Para ejecutar el script, llame a: <br><br><pre> <code class="bash hljs">python export_form.py &lt;config_file_name&gt; &lt;result_file_name&gt; &lt;script_id&gt; &lt;google_form_url&gt;</code> </pre><br>  En este caso: <br><br><ul><li>  <i>config_file_name</i> : nombre del archivo JSON de configuraci√≥n </li><li>  <i>nombre_archivo_resultado</i> - el nombre del archivo JSON en el que se descargar√° el formulario </li><li>  <i>script_id</i> - ID del script </li><li>  <i>google_form_url</i> - url de formulario de google </li></ul><br>  Gracias por su atenci√≥n, esperando sus sugerencias y comentarios :) </div></div><p>Source: <a href="https://habr.com/ru/post/485898/">https://habr.com/ru/post/485898/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../485884/index.html">C√≥mo configurar Levitron chino</a></li>
<li><a href="../485886/index.html">C√≥mo (y por qu√©) analizar las claves y anuncios de la competencia de Yandex.Direct y Google Ads gratis</a></li>
<li><a href="../485888/index.html">Falsificaci√≥n de solicitud de servidor, operaci√≥n SSRF ciega</a></li>
<li><a href="../485892/index.html">El fin de la era del Tridente</a></li>
<li><a href="../485896/index.html">Base de datos paralela masiva Greenplum: un breve programa educativo</a></li>
<li><a href="../485904/index.html">Meetup de prueba de carga en Raiffeisenbank</a></li>
<li><a href="../485908/index.html">Gracias a la sorprendente falla en Ocarina of Time, fue posible agregar modelos de Star Fox 64</a></li>
<li><a href="../485910/index.html">Implementaci√≥n de API con AWS Elastic Beanstalk</a></li>
<li><a href="../485912/index.html">Por qu√© translit en los nombres es malo y otras caracter√≠sticas interesantes de nuestra percepci√≥n del c√≥digo</a></li>
<li><a href="../485914/index.html">Desarrollado por ZeroTier. Una gu√≠a pr√°ctica para construir redes virtuales. Parte 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>