<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ¤°ğŸ¾ ğŸ§”ğŸ¼ ğŸ‘©ğŸ¾â€ğŸ¤â€ğŸ‘¨ğŸ¼ å¦‚ä½•åœ¨JavaScriptä¸­å®ç°ç¼–ç¨‹è¯­è¨€ã€‚ ç¬¬3éƒ¨åˆ†ï¼šCPSè§£é‡Šå™¨ ğŸ‘¨ğŸ½â€ğŸŒ¾ ğŸ‘Š ğŸ”</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ä½ å¥½ æˆ‘å‘æ‚¨ä»‹ç»äº†å®ç°JavaScriptç¼–ç¨‹è¯­è¨€çš„æŒ‡å—ç¿»è¯‘çš„ç¬¬ä¸‰éƒ¨åˆ†-PLæ•™ç¨‹ ã€‚ 
 æ¥è‡ªç¿»è¯‘ 


 æˆ‘ä»¬å°†åˆ›å»ºè‡ªå·±çš„ç¼–ç¨‹è¯­è¨€-Î»è¯­è¨€ ï¼ˆåŸå§‹è¯­è¨€ -Î»anguageï¼‰ã€‚ åœ¨åˆ›å»ºè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨è®¸å¤šæœ‰è¶£çš„æŠ€æœ¯ï¼Œä¾‹å¦‚é€’å½’ä¸‹é™ï¼Œæ§ä»¶ä¼ é€’æ ·å¼å’ŒåŸºæœ¬çš„ä¼˜åŒ–æŠ€æœ¯ã€‚ å°†åˆ›å»ºä¸¤ä¸ªç‰ˆæœ¬çš„è§£é‡Šå™¨-å¸¸è§„å’ŒCPS...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>å¦‚ä½•åœ¨JavaScriptä¸­å®ç°ç¼–ç¨‹è¯­è¨€ã€‚ ç¬¬3éƒ¨åˆ†ï¼šCPSè§£é‡Šå™¨</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/444024/"><p> ä½ å¥½ æˆ‘å‘æ‚¨ä»‹ç»äº†å®ç°JavaScriptç¼–ç¨‹è¯­è¨€çš„æŒ‡å—ç¿»è¯‘çš„ç¬¬ä¸‰éƒ¨åˆ†<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">-PLæ•™ç¨‹</a> ã€‚ </p><br><h1 id="ot-perevodchika"> æ¥è‡ªç¿»è¯‘ </h1><br><p> æˆ‘ä»¬å°†åˆ›å»ºè‡ªå·±çš„ç¼–ç¨‹è¯­è¨€<strong>-Î»è¯­è¨€</strong> ï¼ˆåŸå§‹<strong>è¯­è¨€</strong> -Î»anguageï¼‰ã€‚ åœ¨åˆ›å»ºè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨è®¸å¤šæœ‰è¶£çš„æŠ€æœ¯ï¼Œä¾‹å¦‚é€’å½’ä¸‹é™ï¼Œæ§ä»¶ä¼ é€’æ ·å¼å’ŒåŸºæœ¬çš„ä¼˜åŒ–æŠ€æœ¯ã€‚ å°†åˆ›å»ºä¸¤ä¸ªç‰ˆæœ¬çš„è§£é‡Šå™¨-å¸¸è§„å’ŒCPSè§£é‡Šå™¨ï¼Œå³JavaScriptä¸­çš„åç¼–è¯‘å™¨ã€‚ </p><br><p> åŸè‘—çš„ä½œè€…æ˜¯<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Mihai Bazon</a> ï¼Œè‘—åçš„UglifyJSåº“ï¼ˆä¸€ç§ç”¨äºæœ€å°åŒ–å’Œæ ¼å¼åŒ–JSä»£ç çš„å·¥å…·ï¼‰çš„ä½œè€…ã€‚ </p><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">ç›®å½•å†…å®¹</b> <div class="spoiler_text"><ol><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å¦‚ä½•åœ¨JavaScriptä¸­å®ç°ç¼–ç¨‹è¯­è¨€ã€‚</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç¬¬1éƒ¨åˆ†ï¼šè§£æå™¨</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å¦‚ä½•åœ¨JavaScriptä¸­å®ç°ç¼–ç¨‹è¯­è¨€ã€‚</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç¬¬2éƒ¨åˆ†ï¼šç¿»è¯‘</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å¦‚ä½•åœ¨JavaScriptä¸­å®ç°ç¼–ç¨‹è¯­è¨€ã€‚</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç¬¬3éƒ¨åˆ†ï¼šCPSè§£é‡Šå™¨</a> </li><li> å¦‚ä½•åœ¨JavaScriptä¸­å®ç°ç¼–ç¨‹è¯­è¨€ã€‚ ç¬¬4éƒ¨åˆ†ï¼šJSä¸­çš„åç¼–è¯‘ </li></ol></div></div><br><p> PSè§£é‡Šå™¨å’Œç¼–è¯‘å™¨ä¸­å­˜åœ¨ä¸€ä¸ªé”™è¯¯ï¼šåœ¨<code>a() &amp;&amp; b()</code>æˆ–<code>a() || b()</code>ç­‰è¡¨è¾¾å¼ä¸­  <code>a() || b()</code>è¿™ä¸¤ä¸ªéƒ¨åˆ†å§‹ç»ˆæ‰§è¡Œã€‚ å½“ç„¶ï¼Œè¿™æ˜¯é”™è¯¯çš„ï¼Œå› ä¸º<code>a()</code>å¯¹äº<code>&amp;&amp;</code>è¿ç®—ç¬¦<code>a()</code> falseï¼Œæˆ–è€…å¯¹äº<code>||</code>ä¸ºfalseã€‚  ï¼Œåˆ™<code>b()</code>çš„å€¼ä¸èµ·ä½œç”¨ã€‚ è¿™å¹¶ä¸éš¾è§£å†³ã€‚ </p><br><h1 id="cps-interpretator">  CPSå£è¯‘å‘˜ </h1><br><p> æˆ‘ä»¬çš„Î»è¯­è¨€æœ‰ä¸¤ä¸ªç¼ºç‚¹ï¼š </p><br><ul><li> é€’å½’ä»…é™äºJSå †æ ˆï¼Œå› æ­¤æˆ‘ä»¬æ²¡æœ‰æ­£å¸¸çš„å¾ªç¯æ–¹æ³•ã€‚ </li><li> è§£é‡Šå™¨å¾ˆæ…¢ï¼Œå› æ­¤é€’å½’éå¸¸æ…¢ã€‚ </li></ul><br><p> ç°åœ¨ï¼Œæˆ‘ä»¬å°†çº æ­£ç¬¬ä¸€ä¸ªç¼ºé™·ï¼Œè€Œæ— éœ€æ³¨æ„è§£é‡Šå™¨ä¼šå˜å¾—æ›´æ…¢çš„äº‹å®ã€‚ æˆ‘ä»¬å°†ä»¥â€œè¿ç»­ä¼ é€’æ ·å¼â€ï¼ˆCPSï¼‰æ ·å¼é‡å†™è§£é‡Šå™¨ã€‚ </p><br><h2 id="chto-takoe-peredacha-prodolzheniya"> ä»€ä¹ˆæ˜¯â€œç»§ç»­è½¬ç§»â€ </h2><br><p> æ‚¨å§‹ç»ˆåœ¨NodeJSä¸­æ‰§è¡Œæ­¤æ“ä½œï¼š </p><br><pre> <code class="javascript hljs">fs.readFile(<span class="hljs-string"><span class="hljs-string">"file.txt"</span></span>, <span class="hljs-string"><span class="hljs-string">"utf8"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CC</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error, data</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-comment"><span class="hljs-comment">//   - "" //     'return', // 'readFile'  ,  . });</span></span></code> </pre> <br><p> æ¯ä¸€æ­¥éƒ½æœ‰ä¸€ä¸ªå›è°ƒï¼Œå½“æ‚¨éœ€è¦ç»§ç»­æ—¶å°†è¢«è°ƒç”¨ã€‚ è¿ç»­è½¬ç§»æ ·å¼ä½¿æ§ä»¶è½¬ç§»â€œæ˜¾å¼â€-æ‚¨æ— éœ€ä½¿ç”¨<code>return</code> ï¼Œ <code>throw</code> ï¼Œ <code>break</code>æˆ–<code>continue</code> ã€‚ ä»£ç ä¸­æ²¡æœ‰éšå¼è·³è½¬ã€‚ æ‚¨ç”šè‡³ä¸èƒ½ä½¿ç”¨å¸¦æœ‰å¼‚æ­¥åŠŸèƒ½çš„<code>for</code>æˆ–<code>while</code>å¾ªç¯ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦ä½¿ç”¨ç¼–ç¨‹è¯­è¨€ï¼Ÿ </p><br><p> ä»¥ä¼ é€’å»¶ç»­çš„æ–¹å¼ç¼–å†™ä»£ç æ—¢å›°éš¾åˆå®¹æ˜“å‡ºé”™ï¼Œä½†æ˜¯æˆ‘ä»¬åªä¼šä»¥è¿™ç§æ–¹å¼é‡å†™è§£é‡Šå™¨ã€‚ </p><br><h2 id="funkciya-evaluate">  <code>evaluate</code>åŠŸèƒ½ </h2><br><p>  <code>evaluate</code>å‡½æ•°å°†æ¥æ”¶ä¸‰ä¸ªå‚æ•°ï¼šè¡¨è¾¾å¼ï¼ˆASTï¼‰ï¼Œä¸Šä¸‹æ–‡ï¼ˆEnvironmentï¼‰å’Œåœ¨ç»“æœå‡ºç°æ—¶å°†è¢«è°ƒç”¨çš„å‡½æ•°ã€‚ è¿™æ˜¯ä»£ç ï¼Œæ¯ä¸ªç‰‡æ®µéƒ½æœ‰ä¸€ä¸ªè§£é‡Šï¼š </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">evaluate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">exp, env, callback</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (exp.type) {</code> </pre> <br><p> å¯¹äºå¸¸é‡ï¼Œæˆ‘ä»¬å°†åªè¿”å›å®ƒä»¬çš„å€¼ã€‚ ä½†æ˜¯è¯·è®°ä½ï¼Œæˆ‘ä»¬æ²¡æœ‰<code>return</code> -è€Œæ˜¯è°ƒç”¨å›è°ƒå¹¶ä¼ é€’å€¼ã€‚ </p><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"num"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"str"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"bool"</span></span>: callback(exp.value); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>;</code> </pre> <br><p>  <code>var</code>èŠ‚ç‚¹ä¹Ÿå¾ˆç®€å•-ä»ä¸Šä¸‹æ–‡ä¸­è·å–å˜é‡å¹¶å°†å…¶ä¼ é€’ç»™å‡½æ•°ï¼š </p><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"var"</span></span>: callback(env.get(exp.value)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>;</code> </pre> <br><p> å¯¹äº<code>assign</code>èŠ‚ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦è·å–å·¦è¡¨è¾¾å¼ï¼ˆ <code>right</code> ï¼‰çš„å€¼ã€‚ ä¸ºæ­¤ï¼Œæˆ‘ä»¬è°ƒç”¨<code>evaluate</code> ï¼Œä¼ å…¥ä¸€ä¸ªå°†è·å¾—ç»“æœçš„å‡½æ•°ï¼ˆç”¨äºè¡¨è¾¾å¼çš„å³ä¾§ï¼‰ã€‚ ç„¶åï¼Œæˆ‘ä»¬ä»…ä½¿ç”¨å˜é‡å€¼è°ƒç”¨<code>callback</code> ï¼Œåœ¨å½“å‰ä¸Šä¸‹æ–‡ä¸­è®¾ç½®å˜é‡ï¼š </p><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"assign"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (exp.left.type != <span class="hljs-string"><span class="hljs-string">"var"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">"Cannot assign to "</span></span> + <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(exp.left)); evaluate(exp.right, env, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">right</span></span></span><span class="hljs-function">)</span></span>{ callback(env.set(exp.left.value, right)); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>;</code> </pre> <br><p> å¯¹äº<code>binary</code>ç±»å‹çš„èŠ‚ç‚¹å‡ ä¹ç›¸åŒï¼Œä½†æ˜¯åœ¨è¿™é‡Œæˆ‘ä»¬éœ€è¦é¦–å…ˆè·å–<code>left</code>å­—æ®µçš„å€¼ï¼Œç„¶åæ‰æ˜¯<code>right</code>å­—æ®µçš„å€¼ã€‚ ç„¶åï¼Œæˆ‘ä»¬åªéœ€è°ƒç”¨å›è°ƒï¼Œå¹¶ä¼ é€’æ“ä½œç»“æœï¼š </p><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"binary"</span></span>: evaluate(exp.left, env, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">left</span></span></span><span class="hljs-function">)</span></span>{ evaluate(exp.right, env, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">right</span></span></span><span class="hljs-function">)</span></span>{ callback(apply_op(exp.operator, left, right)); }); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>;</code> </pre> <br><p>  <code>let</code>èŠ‚ç‚¹çœ‹èµ·æ¥æ›´å¤æ‚ï¼Œä½†å®é™…ä¸Šå¾ˆç®€å•ã€‚ æˆ‘ä»¬æœ‰ä¸€äº›å˜é‡ã€‚ å®ƒä»¬çš„<code>def</code>å­—æ®µï¼ˆåˆå§‹å€¼ï¼‰å¯èƒ½ä¸ºç©ºï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°†å…¶è®¾ç½®ä¸º<code>false</code> ã€‚ ä½†æ˜¯ï¼Œå¦‚æœæœ‰ä¸€ä¸ªå€¼ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦é€’å½’è°ƒç”¨<code>evaluate</code>ä»¥è·å¾—å®ƒã€‚ </p><br><p> å¦‚æœæ‚¨ä»¥å‰ä½¿ç”¨è¿‡NodeJSï¼Œé‚£ä¹ˆæ‚¨å·²ç»åšè¿‡å¾ˆå¤šæ¬¡äº†ã€‚ ç”±äºå­˜åœ¨å›è°ƒï¼Œå› æ­¤æ— æ³•å°†<code>for</code> ï¼Œå› æ­¤ï¼Œå¿…é¡»ä¸€æ¬¡è§£é‡Šä¸€ä¸ªè¡¨è¾¾å¼ï¼ˆå°†<code>evaluate</code>å‡½æ•°æƒ³è±¡ä¸ºå¼‚æ­¥çš„ï¼‰ã€‚ ä¸‹é¢çš„<code>loop</code>å‡½æ•°ï¼ˆç«‹å³è°ƒç”¨ï¼‰è·å–ä¸Šä¸‹æ–‡å’Œéœ€è¦å¤„ç†çš„å®šä¹‰ç¼–å·ï¼š </p><br><ul><li> å¦‚æœè¯¥æ•°ç›®ç­‰äºå˜é‡çš„æ•°ç›®ï¼ˆ <code>vars.length</code> ï¼‰ï¼Œåˆ™æ„å‘³ç€æˆ‘ä»¬å·²ç»å®šä¹‰äº†æ‰€æœ‰è¡¨è¾¾å¼ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥æ‰§è¡Œè¡¨è¾¾å¼çš„ä¸»ä½“ã€‚ è¯·æ³¨æ„ï¼Œè¿™ä¸€æ¬¡æˆ‘ä»¬ä¸è°ƒç”¨<code>callback</code> ï¼Œè€Œæ˜¯å°†å…¶ä¼ é€’ç»™<code>evaluate</code> ï¼Œç„¶åå°†å…¶è°ƒç”¨ã€‚ </li><li> å¦‚æœæ­¤æ•°å­—è¾ƒå°ï¼Œåˆ™éœ€è¦åœ¨å¤åˆ¶ä¸Šä¸‹æ–‡ä¹‹å‰è®¡ç®—å½“å‰å®šä¹‰å¹¶ä¼ é€’ä¸€ä¸ªå°†è°ƒç”¨<code>loop(scope, i + 1)</code>çš„å‡½æ•°ã€‚ <br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"let"</span></span>: (<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loop</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">env, i</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (i &lt; exp.vars.length) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> v = exp.vars[i]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (v.def) evaluate(v.def, env, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">value</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> scope = env.extend(); scope.def(v.name, value); loop(scope, i + <span class="hljs-number"><span class="hljs-number">1</span></span>); }); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> scope = env.extend(); scope.def(v.name, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); loop(scope, i + <span class="hljs-number"><span class="hljs-number">1</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { evaluate(exp.body, env, callback); } })(env, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>;</code> </pre> </li></ul><br><p>  <code>lambda</code>èŠ‚ç‚¹å°†åƒä»¥å‰ä¸€æ ·åœ¨å•ç‹¬çš„å‡½æ•°ä¸­è¿›è¡Œå¤„ç†ï¼š </p><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"lambda"</span></span>: callback(make_lambda(env, exp)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>;</code> </pre> <br><p> ä¸ºäº†è§£é‡Š<code>if</code> ï¼Œæˆ‘ä»¬é¦–å…ˆè§£é‡Šæ¡ä»¶ã€‚ å¦‚æœå®ƒä¸æ˜¯falseï¼Œé‚£ä¹ˆæˆ‘ä»¬è§£é‡Š<code>then</code>è¡¨è¾¾å¼ï¼Œåœ¨å¦ä¸€ç§æƒ…å†µä¸‹ï¼Œå¦‚æœå­˜åœ¨åˆ™è§£é‡Š<code>else</code> ï¼Œå¦åˆ™è¿”å›<code>false</code> ã€‚ å’Œä»¥å‰ä¸€æ ·ï¼Œåœ¨<code>else</code>æˆ‘ä»¬åªéœ€å°†<code>callback</code>ä½œä¸ºè¡¨è¾¾å¼çš„â€œæ‰§è¡Œåè¦æ‰§è¡Œçš„æ“ä½œâ€å³å¯ï¼š </p><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"if"</span></span>: evaluate(exp.cond, env, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">cond</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cond !== <span class="hljs-literal"><span class="hljs-literal">false</span></span>) evaluate(exp.then, env, callback); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (exp.else) evaluate(exp.else, env, callback); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> callback(<span class="hljs-literal"><span class="hljs-literal">false</span></span>); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>;</code> </pre> <br><p>  <code>prog</code>èŠ‚ç‚¹çš„è§£é‡Šä¸<code>let</code>èŠ‚ç‚¹çš„è§£é‡Šç±»ä¼¼ï¼Œä½†æ˜¯åŒºåˆ«åœ¨äºæˆ‘ä»¬ä¸éœ€è¦å¤åˆ¶ä¸Šä¸‹æ–‡æˆ–å®šä¹‰å˜é‡ã€‚ åŒæ ·ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ª<code>loop</code>å‡½æ•°ï¼Œéœ€è¦ä¸€ä¸ªè¡¨è¾¾å¼ç¼–å·ã€‚ å½“å®ƒç­‰äº<code>prog.length</code> ï¼Œæˆ‘ä»¬å°±å®Œæˆäº†æ‰€æœ‰è¡¨è¾¾å¼ï¼Œç„¶åç®€å•åœ°è¿”å›æœ€åä¸€ä¸ªè¡¨è¾¾å¼çš„ç»“æœï¼ˆç”¨å•è¯â€œ returnâ€è¡¨ç¤ºæˆ‘ç”¨å®ƒæ¥è°ƒç”¨<code>callback</code> ï¼‰ã€‚ è¯·æ³¨æ„ï¼Œæˆ‘ä»¬é€šè¿‡å°†æœ€åä¸€ä¸ªå€¼ä½œä¸ºå‚æ•°ä¼ é€’ç»™<code>loop</code>å‡½æ•°æ¥è®°ä½æœ€åä¸€ä¸ªå€¼ï¼ˆå¼€å§‹æ—¶ï¼Œå¯¹äºä¸»ä½“ä¸ºç©ºçš„æƒ…å†µï¼Œå®ƒä¸º<code>false</code> ï¼‰ï¼š </p><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"prog"</span></span>: (<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loop</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">last, i</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (i &lt; exp.prog.length) evaluate(exp.prog[i], env, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">val</span></span></span><span class="hljs-function">)</span></span>{ loop(val, i + <span class="hljs-number"><span class="hljs-number">1</span></span>); }); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { callback(last); } })(<span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>;</code> </pre> <br><p> å¯¹äºç±»å‹<code>call</code>çš„èŠ‚ç‚¹<code>call</code>æˆ‘ä»¬éœ€è¦è§£é‡Š<code>func</code> ï¼Œç„¶åæ‰€æœ‰å‚æ•°éƒ½æŒ‰é¡ºåºæ’åˆ—ã€‚ åŒæ ·ï¼Œè¿˜æœ‰ä¸€ä¸ª<code>loop</code>å‡½æ•°ï¼Œå…¶ä½œç”¨åŸç†ä¸<code>let</code>æˆ–<code>prog</code>ç›¸åŒï¼Œä¸åŒä¹‹å¤„åœ¨äºå®ƒç°åœ¨ä½œä¸ºç»“æœæ„å»ºä¸€ä¸ªæ•°ç»„ï¼š </p><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"call"</span></span>: evaluate(exp.func, env, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">func</span></span></span><span class="hljs-function">)</span></span>{ (<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loop</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">args, i</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (i &lt; exp.args.length) evaluate(exp.args[i], env, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">arg</span></span></span><span class="hljs-function">)</span></span>{ args[i + <span class="hljs-number"><span class="hljs-number">1</span></span>] = arg; loop(args, i + <span class="hljs-number"><span class="hljs-number">1</span></span>); }); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { func.apply(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, args); } })([ callback ], <span class="hljs-number"><span class="hljs-number">0</span></span>); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>;</code> </pre> <br><p> å¥½å§ï¼Œæ ‡å‡†ç»“å±€ï¼šå¦‚æœæˆ‘ä»¬ä¸çŸ¥é“è¯¥æ€ä¹ˆåŠï¼Œè¯·æŠ›å‡ºå¼‚å¸¸ï¼š </p><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">"I don't know how to evaluate "</span></span> + exp.type); } }</code> </pre> <br><p> æ‚¨å¯èƒ½ä¼šæ³¨æ„åˆ°ä¸Šé¢çš„æ¯ç§<code>case</code>ä»¥<code>return</code>å…³é”®å­—ç»“å°¾ã€‚ ä½†æ˜¯æ²¡æœ‰è¿”å›å€¼-ç»“æœæ€»æ˜¯ä¼ é€’ç»™<code>callback</code>å‡½æ•°ã€‚ </p><br><h3 id="novaya-funkciya-make_lambda"> æ–°çš„<code>make_lambda</code>å‡½æ•° </h3><br><p> åœ¨æ­¤è§£é‡Šå™¨ä¸­ï¼Œæ‰€æœ‰å‡½æ•°éƒ½å°†æ”¶åˆ°â€œ continuationâ€ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°-æˆ‘ä»¬å¿…é¡»è°ƒç”¨è¯¥å‡½æ•°æ‰èƒ½ä¼ é€’ç»“æœã€‚ å…¶åæ˜¯é€šå¸¸çš„å‡½æ•°å‚æ•°ã€‚ è¿™æ˜¯<code>make_lambda</code>å‡½æ•°çš„æ–°ä»£ç ï¼š </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">make_lambda</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">env, exp</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (exp.name) { env = env.extend(); env.def(exp.name, lambda); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lambda</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">callback</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> names = exp.vars; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> scope = env.extend(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; names.length; ++i) scope.def(names[i], i + <span class="hljs-number"><span class="hljs-number">1</span></span> &lt; <span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>.length ? <span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>[i + <span class="hljs-number"><span class="hljs-number">1</span></span>] : <span class="hljs-literal"><span class="hljs-literal">false</span></span>); evaluate(exp.body, scope, callback); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> lambda; }</code> </pre> <br><p> ä»–æ²¡ä»€ä¹ˆä¸åŒã€‚ å®ƒå°†æ–°å˜é‡æ·»åŠ åˆ°æ–°ä¸Šä¸‹æ–‡ä¸­ã€‚ å¦å¤–ï¼Œæˆ‘ä»¬å¿…é¡»è€ƒè™‘ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯<code>callback</code> ã€‚ æœ€åï¼Œ <code>evaluate</code>å‡½æ•°ç”¨äºåœ¨æ–°çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œå‡½æ•°ä»£ç ï¼Œä½†æ˜¯åƒä»¥å‰ä¸€æ ·ï¼Œæˆ‘ä»¬ä¼ é€’äº†ä¸€ä¸ª<code>callback</code> ã€‚ </p><br><p> é¡ºä¾¿è¯´ä¸€å¥ï¼Œè¿™æ˜¯æˆ‘ä½¿ç”¨<code>for</code>å¾ªç¯çš„å”¯ä¸€åœ°æ–¹ã€‚ è¿™æ˜¯å› ä¸ºåœ¨å¤„ç†<code>call</code>èŠ‚ç‚¹æ—¶å·²ç»è®¡ç®—å‡ºäº†å‚æ•°å€¼ã€‚ </p><br><h2 id="nativnye-funkcii"> æœ¬æœºåŠŸèƒ½ </h2><br><p> åœ¨æ­¤è§£é‡Šå™¨ä¸­ï¼Œæœ¬æœºå‡½æ•°æ¥æ”¶<code>callback</code>ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ã€‚ å®šä¹‰æœ¬æœºå‡½æ•°æ—¶ï¼Œå¿…é¡»è®°ä½è¿™ä¸€ç‚¹ã€‚ è¿™æ˜¯æ–°è§£é‡Šå™¨çš„ç¤ºä¾‹ä»£ç ï¼š </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> code = <span class="hljs-string"><span class="hljs-string">"sum = lambda(x, y) x + y; print(sum(2, 3));"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ast = parse(TokenStream(InputStream(code))); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> globalEnv = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Environment(); <span class="hljs-comment"><span class="hljs-comment">// define the "print" primitive function globalEnv.def("print", function(callback, txt){ console.log(txt); callback(false); // call the continuation with some return value // if we don't call it, the program would stop // abruptly after a print! }); // run the evaluator evaluate(ast, globalEnv, function(result){ // the result of the entire program is now in "result" });</span></span></code> </pre> <br><h2 id="malenkiy-test"> å°è€ƒ </h2><br><p> è®©æˆ‘ä»¬å°è¯•å†æ¬¡è®¡ç®—æ–æ³¢é‚£å¥‘æ•°ï¼š </p><br><pre> <code class="javascript hljs">fib = Î»(n) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> n &lt; <span class="hljs-number"><span class="hljs-number">2</span></span> then n <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> fib(n - <span class="hljs-number"><span class="hljs-number">1</span></span>) + fib(n - <span class="hljs-number"><span class="hljs-number">2</span></span>); time( Î»() println(fib(<span class="hljs-number"><span class="hljs-number">10</span></span>)) );</code> </pre> <br><p> ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬å°è¯•æ‰¾åˆ°ç¬¬27ä¸ªæ•°å­—ï¼Œåˆ™ä¼šå‡ºç°å †æ ˆæº¢å‡ºã€‚ æ€»çš„æ¥è¯´ï¼Œå †æ ˆçš„å¢é•¿é€Ÿåº¦ç°åœ¨è¦å¿«å¾—å¤šï¼Œå› æ­¤äº‹å®è¯æ˜ï¼Œç°åœ¨æˆ‘ä»¬åªèƒ½å°†æ–æ³¢é‚£å¥‘æ•°è®¡ç®—ä¸ºç¬¬12ä½ï¼ˆè‡³å°‘åœ¨æˆ‘çš„æµè§ˆå™¨ä¸­ï¼‰ã€‚ è¿™ä¸æ˜¯å¾ˆå¥½ï¼Œæ‰€ä»¥æ‚¨éœ€è¦ä»¥æŸç§æ–¹å¼ä¿®å¤å®ƒã€‚ </p><br><h1 id="zaschischaem-stek"> æˆ‘ä»¬ä¿æŠ¤å †æ ˆ </h1><br><p> åœ¨CPSè§£é‡Šå™¨ä¸­ï¼Œå †æ ˆçš„å¢é•¿é€Ÿåº¦æ›´å¿«ï¼Œå› ä¸ºè§£é‡Šå™¨å§‹ç»ˆä»¥é€’å½’æ–¹å¼è°ƒç”¨å‡½æ•°ï¼Œè€Œä¸ä¼šè¿”å›ç»“æœã€‚ å°½ç®¡æˆ‘ä»¬å·²ç»åœ¨è§£é‡Šå™¨ä¸­<code>return</code>äº†ï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦å®ƒä»¬ï¼Œä½†æ˜¯åœ¨éå¸¸æ·±å±‚æ¬¡çš„é€’å½’æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°†æ°¸è¿œæ— æ³•åˆ°è¾¾å®ƒä»¬ã€‚ </p><br><p> è®©æˆ‘ä»¬æƒ³è±¡ä¸€ä¸‹æˆ‘ä»¬çš„å †æ ˆå¦‚ä½•å¯»æ‰¾ä¸€ä¸ªéå¸¸ç®€å•çš„ç¨‹åºã€‚ æˆ‘å°†æ˜¾ç¤ºä¼ªä»£ç ï¼Œå¹¶ä¸”æ²¡æœ‰æ·»åŠ <code>env</code>å› ä¸ºå®ƒåœ¨è¿™é‡Œæ²¡æœ‰ä»»ä½•ä½œç”¨ï¼š </p><br><pre> <code class="python hljs">print(<span class="hljs-number"><span class="hljs-number">1</span></span> + <span class="hljs-number"><span class="hljs-number">2</span></span> * <span class="hljs-number"><span class="hljs-number">3</span></span>); <span class="hljs-comment"><span class="hljs-comment">## : evaluate( print(1 + 2 * 3), K0 ) evaluate( print, K1 ) K1(print) #  'var',      evaluate( 1 + 2 * 3, K2 ) evaluate( 2 * 3, K3 ) evaluate( 2, K4 ) K4(2) # 2  ,      evaluate( 3, K5 ) #    3,      K5(3) K3(6) #  2*3 evaluate( 1, K6 ) #  ,  K6(1) K2(7) #  1+2*3 print(K0, 7) # ,     'print' K0(false) #  . 'print'  'false'.</span></span></code> </pre> <br><p> åªæœ‰åœ¨æœ€åä¸€æ¬¡è°ƒç”¨ä¹‹åï¼Œé•¿æ—¶é—´çš„æ— ç”¨<code>return</code>åºåˆ—æ‰ä¼šå‡å°‘å †æ ˆã€‚ å¦‚æœæˆ‘ä»¬ä¸ºä¸€ä¸ªç®€å•çš„ç¨‹åºä½¿ç”¨äº†å¦‚æ­¤å¤šçš„å †æ ˆç©ºé—´ï¼Œé‚£ä¹ˆå¾ˆéš¾æƒ³è±¡<code>fib(13)</code>ä¼šå‘ç”Ÿä»€ä¹ˆã€‚ </p><br><h2 id="zaschita-steka"> å †æ ˆä¿æŠ¤ </h2><br><p> åœ¨æˆ‘ä»¬çš„æ–°è§£é‡Šå™¨ä¸­ï¼Œæ ¹æœ¬ä¸éœ€è¦å †æ ˆã€‚ åœ¨<code>callback</code>å‘ç”ŸæŸäº›è¡¨è¾¾å¼ä¹‹åï¼Œéœ€è¦åšçš„æ‰€æœ‰äº‹æƒ…éƒ½ä½œä¸ºå‚æ•°ä¼ é€’ã€‚ å› æ­¤ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼šå¦‚æœJavaScriptèƒ½å¤Ÿâ€œè½¬å‚¨â€å †æ ˆï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿ ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥åˆ é™¤å †æ ˆï¼Œå¹¶ä¸”æ— é™æ·±çš„é€’å½’å°†èµ·ä½œç”¨ã€‚ </p><br><p> å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªå¯ä»¥æ‰§è¡Œæ­¤æ“ä½œçš„<code>GUARD</code>å‡½æ•°ã€‚ å®ƒæœ‰ä¸¤ä¸ªå€¼ï¼šè¦è°ƒç”¨çš„å‡½æ•°å’Œéœ€è¦ä¼ é€’çš„å‚æ•°ã€‚ å®ƒæ£€æŸ¥ï¼šå¦‚æœå †æ ˆå¤ªæ·±ï¼Œå®ƒå°†æ¸…é™¤å †æ ˆå¹¶è°ƒç”¨ä¼ é€’çš„å‡½æ•°ã€‚ åœ¨å¦ä¸€ç§æƒ…å†µä¸‹ï¼Œå¥¹ä»€ä¹ˆä¹Ÿä¸åšã€‚ </p><br><p> ä½¿ç”¨æ–°åŠŸèƒ½ï¼Œæˆ‘ä»¬é‡å†™äº†è§£é‡Šå™¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ æˆ‘ä¸ä¼šå¯¹æ¯ç§æƒ…å†µè¿›è¡Œè¯„è®ºï¼Œè¿™é‡Œæœ‰å‰é¢æè¿°çš„ä»£ç ï¼Œä½†æ˜¯ä½¿ç”¨äº†<code>GUARD</code>å‡½æ•°ï¼š </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">evaluate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">exp, env, callback</span></span></span><span class="hljs-function">) </span></span>{ GUARD(evaluate, <span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (exp.type) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"num"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"str"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"bool"</span></span>: callback(exp.value); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"var"</span></span>: callback(env.get(exp.value)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"assign"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (exp.left.type != <span class="hljs-string"><span class="hljs-string">"var"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">"Cannot assign to "</span></span> + <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(exp.left)); evaluate(exp.right, env, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CC</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">right</span></span></span><span class="hljs-function">)</span></span>{ GUARD(CC, <span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>); callback(env.set(exp.left.value, right)); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"binary"</span></span>: evaluate(exp.left, env, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CC</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">left</span></span></span><span class="hljs-function">)</span></span>{ GUARD(CC, <span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>); evaluate(exp.right, env, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CC</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">right</span></span></span><span class="hljs-function">)</span></span>{ GUARD(CC, <span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>); callback(apply_op(exp.operator, left, right)); }); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"let"</span></span>: (<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loop</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">env, i</span></span></span><span class="hljs-function">)</span></span>{ GUARD(loop, <span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (i &lt; exp.vars.length) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> v = exp.vars[i]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (v.def) evaluate(v.def, env, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CC</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">value</span></span></span><span class="hljs-function">)</span></span>{ GUARD(CC, <span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> scope = env.extend(); scope.def(v.name, value); loop(scope, i + <span class="hljs-number"><span class="hljs-number">1</span></span>); }); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> scope = env.extend(); scope.def(v.name, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); loop(scope, i + <span class="hljs-number"><span class="hljs-number">1</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { evaluate(exp.body, env, callback); } })(env, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"lambda"</span></span>: callback(make_lambda(env, exp)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"if"</span></span>: evaluate(exp.cond, env, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CC</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">cond</span></span></span><span class="hljs-function">)</span></span>{ GUARD(CC, <span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cond !== <span class="hljs-literal"><span class="hljs-literal">false</span></span>) evaluate(exp.then, env, callback); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (exp.else) evaluate(exp.else, env, callback); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> callback(<span class="hljs-literal"><span class="hljs-literal">false</span></span>); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"prog"</span></span>: (<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loop</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">last, i</span></span></span><span class="hljs-function">)</span></span>{ GUARD(loop, <span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (i &lt; exp.prog.length) evaluate(exp.prog[i], env, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CC</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">val</span></span></span><span class="hljs-function">)</span></span>{ GUARD(CC, <span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>); loop(val, i + <span class="hljs-number"><span class="hljs-number">1</span></span>); }); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { callback(last); } })(<span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"call"</span></span>: evaluate(exp.func, env, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CC</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">func</span></span></span><span class="hljs-function">)</span></span>{ GUARD(CC, <span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>); (<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loop</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">args, i</span></span></span><span class="hljs-function">)</span></span>{ GUARD(loop, <span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (i &lt; exp.args.length) evaluate(exp.args[i], env, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CC</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">arg</span></span></span><span class="hljs-function">)</span></span>{ GUARD(CC, <span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>); args[i + <span class="hljs-number"><span class="hljs-number">1</span></span>] = arg; loop(args, i + <span class="hljs-number"><span class="hljs-number">1</span></span>); }); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { func.apply(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, args); } })([ callback ], <span class="hljs-number"><span class="hljs-number">0</span></span>); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">"I don't know how to evaluate "</span></span> + exp.type); } }</code> </pre> <br><p> å¯¹äºåŒ¿åå‡½æ•°ï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ ä¸€ä¸ªåç§°ï¼Œä»¥ä¾¿å¯ä»¥å°†å…¶ä¼ é€’ç»™<code>GUARD</code>å‡½æ•°ã€‚ æˆ‘ä½¿ç”¨çš„åç§°æ˜¯<code>CC</code> ï¼ˆ <code>current continuation</code> ï¼‰ã€‚ æ‚¨å¯ä»¥ä½¿ç”¨<code>arguments.callee</code> ï¼Œä½†è¿™æ˜¯ä¸€ä¸ªè¿‡æ—¶çš„APIã€‚ </p><br><p> å¦å¤–ï¼Œ <code>make_lambda</code>å˜åŒ–ç›¸åŒï¼š </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">make_lambda</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">env, exp</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (exp.name) { env = env.extend(); env.def(exp.name, lambda); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lambda</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">callback</span></span></span><span class="hljs-function">) </span></span>{ GUARD(lambda, <span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>); <span class="hljs-comment"><span class="hljs-comment">// &lt;--  var names = exp.vars; var scope = env.extend(); for (var i = 0; i &lt; names.length; ++i) scope.def(names[i], i + 1 &lt; arguments.length ? arguments[i + 1] : false); evaluate(exp.body, scope, callback); } return lambda; }</span></span></code> </pre> <br><p>  <code>GUARD</code>çš„å®ç°éå¸¸ç®€å•ã€‚ å¦‚ä½•æ‘†è„±å›°å¢ƒï¼Ÿ ä½¿ç”¨å¼‚å¸¸ã€‚ ä¸ºæ­¤ï¼Œå°†æœ‰ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œè¯¥å˜é‡å°†æŒ‡ç¤ºæˆ‘ä»¬å¯ä»¥æ‰§è¡Œå¤šå°‘é€’å½’ã€‚ å¦‚æœè¾¾åˆ°é›¶ï¼Œæˆ‘ä»¬å°†æŠ›å‡º<code>Continuation</code>å¯¹è±¡ï¼Œå…¶ä¸­å°†å­˜åœ¨ä¸€ä¸ªcontinuation-å‡½æ•°å’Œå‚æ•°ï¼š </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> STACKLEN; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GUARD</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">f, args</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (--STACKLEN &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Continuation(f, args); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Continuation</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">f, args</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.f = f; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.args = args; }</code> </pre> <br><p> æœ€åï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå°†æ•è·<code>Continuation</code>å¯¹è±¡çš„å¾ªç¯ã€‚ æˆ‘ä»¬å¿…é¡»é€šè¿‡æ­¤å¾ªç¯è°ƒç”¨è§£é‡Šå™¨ï¼Œä»¥ä¾¿ä¸€åˆ‡æ­£å¸¸ï¼š </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">f, args</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { STACKLEN = <span class="hljs-number"><span class="hljs-number">200</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> f.apply(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, args); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(ex) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ex <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> Continuation) f = ex.f, args = ex.args; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> ex; } }</code> </pre> <br><p>  <code>Execute</code>å‡½æ•°æ¥å—è¦è°ƒç”¨çš„å‡½æ•°åŠå…¶å‚æ•°ã€‚ å®ƒå¾ªç¯è¿è¡Œï¼Œä½†æ˜¯å¦‚æœå‡½æ•°æ­£å¸¸å·¥ä½œè€Œæ²¡æœ‰å †æ ˆæº¢å‡ºï¼Œè¯·æ³¨æ„<code>return</code> ï¼Œæˆ‘ä»¬ä¼šç«‹å³åœæ­¢ã€‚ æ¯å½“æˆ‘ä»¬å¼€å§‹å¾ªç¯è¿­ä»£æ—¶ï¼Œ <code>STACKLEN</code>é‡ç½®<code>STACKLEN</code> ã€‚ å€¼<code>200</code>åˆé€‚ã€‚ å½“æˆ‘ä»¬æ•è·<code>Continuation</code>å¯¹è±¡æ—¶ï¼Œæˆ‘ä»¬å°†æ›¿æ¢ä¸€ä¸ªæ–°çš„å‡½æ•°å’Œå‚æ•°ï¼Œç„¶åç»§ç»­å¾ªç¯ã€‚ å¦å¤–ï¼Œç”±äºå¼‚å¸¸ï¼Œå †æ ˆä¼šè¢«æ¸…é™¤ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥ç»§ç»­ã€‚ </p><br><p> è¦å¯åŠ¨è§£é‡Šå™¨ï¼Œæˆ‘ä»¬ç°åœ¨ä½¿ç”¨<code>Execute</code> ï¼š </p><br><pre> <code class="javascript hljs">Execute(evaluate, [ ast, globalEnv, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">result</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"*** Result:"</span></span>, result); }]);</code> </pre> <br><h2 id="test"> æµ‹éªŒ </h2><br><p>  <code>fib</code>å‡½æ•°ç°åœ¨å°†èµ·ä½œç”¨ï¼š </p><br><pre> <code class="python hljs">fib = Î»(n) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> n &lt; <span class="hljs-number"><span class="hljs-number">2</span></span> then n <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> fib(n - <span class="hljs-number"><span class="hljs-number">1</span></span>) + fib(n - <span class="hljs-number"><span class="hljs-number">2</span></span>); time( Î»() println(fib(<span class="hljs-number"><span class="hljs-number">20</span></span>)) ); <span class="hljs-comment"><span class="hljs-comment"># 6765, ~300ms</span></span></code> </pre> <br><p> é—æ†¾çš„æ˜¯ï¼Œä½†å¦‚æœæ‚¨å°è¯•æ‰¾åˆ°<code>fib(27)</code> ï¼Œå®ƒçš„æ—¶é—´å¤§çº¦æ˜¯æ™®é€šå£è¯‘å‘˜çš„å››å€ã€‚ ä½†æ˜¯ç°åœ¨æˆ‘ä»¬æœ‰äº†æ— é™é€’å½’ï¼š </p><br><pre> <code class="javascript hljs">sum = Î»(n, ret) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> n == <span class="hljs-number"><span class="hljs-number">0</span></span> then ret <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> sum(n - <span class="hljs-number"><span class="hljs-number">1</span></span>, ret + n); # compute <span class="hljs-number"><span class="hljs-number">1</span></span> + <span class="hljs-number"><span class="hljs-number">2</span></span> + ... + <span class="hljs-number"><span class="hljs-number">50000</span></span> time( Î»() println(sum(<span class="hljs-number"><span class="hljs-number">50000</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>)) ); # <span class="hljs-number"><span class="hljs-number">1250025000</span></span>, ~<span class="hljs-number"><span class="hljs-number">700</span></span>ms</code> </pre> <br><p> å½“ç„¶ï¼ŒÎ»è¯­è¨€æ¯”JavaScriptæ…¢å¾—å¤šã€‚ è¯•æƒ³ä¸€ä¸‹ï¼Œå¯¹å˜é‡çš„æ¯æ¬¡è®¿é—®éƒ½é€šè¿‡ä¸€ä¸ª<code>Environment</code>å¯¹è±¡ã€‚ å°è¯•ä¼˜åŒ–è§£é‡Šå™¨æ²¡æœ‰ä»»ä½•æ„ä¹‰-æˆ‘ä»¬ä¸ä¼šè·å¾—æ˜¾ç€çš„æ€§èƒ½æå‡ã€‚ ä¸ºäº†æé«˜æ€§èƒ½ï¼Œæœ‰ä¸€ç§è§£å†³æ–¹æ¡ˆï¼šåœ¨JSä¸­ç¼–è¯‘Î»è¯­è¨€ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬è¦åšçš„ã€‚ é¦–å…ˆï¼Œè®©æˆ‘ä»¬çœ‹çœ‹ä½¿ç”¨CPSè§£é‡Šå™¨å¯ä»¥åšäº›æœ‰è¶£çš„äº‹æƒ…ã€‚ </p><br><h1 id="prodolzheniya"> å»¶ç»­æ€§ </h1><br><p> ç°åœ¨ï¼Œè§£é‡Šå™¨ä»¥ä¼ è¾“è¿ç»­æ€§çš„æ–¹å¼å·¥ä½œï¼Œå¹¶ä¸”æ‰€æœ‰å‡½æ•°ï¼ˆÎ»è¯­è¨€å‡½æ•°å’Œæœ¬æœºJSå‡½æ•°ï¼‰éƒ½å°†ç»§ç»­å‡½æ•°ä½œä¸ºè¿”å›ç»“æœçš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆæ­¤å‚æ•°å¯¹äºJavaScriptå‡½æ•°æ˜¯å¿…éœ€çš„ï¼Œå°½ç®¡å¯¹äºÎ»è¯­è¨€å‡½æ•°ä¸å¯è§ï¼‰ã€‚ </p><br><p> å˜é‡<code>callback</code>æ„å‘³ç€æ•´ä¸ªç¨‹åºçš„ç»§ç»­ã€‚  <em>è¯¥ç¨‹åºæ¥ä¸‹æ¥å°†æ‰§è¡Œçš„æ‰€æœ‰æ“ä½œã€‚</em> æˆ‘ä»¬å°†è¿™ä¸ªå˜é‡ç§°ä¸ºâ€œå½“å‰å»¶ç»­â€ï¼Œå³ä»£ç ä¸­çš„<code>k</code> ã€‚ </p><br><p> å¦å¤–ï¼Œå¦‚æœæˆ‘ä»¬ä¸ç»§ç»­æ‰§è¡Œï¼Œåˆ™ç¨‹åºå°†åœæ­¢ã€‚ æˆ‘ä»¬æ— æ³•ä½¿ç”¨Î»è¯­è¨€æ¥æ‰§è¡Œæ­¤æ“ä½œï¼Œå› ä¸º<code>make_lambda</code>è°ƒç”¨å»¶ç»­ã€‚ ä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡æœ¬æœºå‡½æ•°æ¥åšåˆ°è¿™ä¸€ç‚¹ã€‚ æˆ‘åšäº†ä¸€ä¸ªå‡½æ•°æ¥å±•ç¤ºå®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼š </p><br><pre> <code class="javascript hljs">globalEnv.def(<span class="hljs-string"><span class="hljs-string">"halt"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">k</span></span></span><span class="hljs-function">)</span></span>{});</code> </pre> <br><p> è¿™æ˜¯ä»€ä¹ˆéƒ½ä¸åšçš„åŠŸèƒ½ã€‚ å¥¹æ”¶åˆ°å»¶ç»­ï¼ˆ <code>k</code> ï¼‰ï¼Œä½†æ²¡æœ‰è°ƒç”¨å®ƒï¼š </p><br><pre> <code class="python hljs">println(<span class="hljs-string"><span class="hljs-string">"foo"</span></span>); halt(); println(<span class="hljs-string"><span class="hljs-string">"bar"</span></span>);</code> </pre> <br><p> ç»“è®ºï¼š </p><br><pre> <code class="plaintext hljs">foo</code> </pre> <br><p> å¦‚æœåˆ é™¤<code>halt()</code>è°ƒç”¨ï¼Œåˆ™è¾“å‡ºå°†æ˜¯ï¼š <code>foo / bar / ***Result: false</code> ï¼ˆå› ä¸ºæœ€åä¸€ä¸ª<code>println</code>è¿”å›<code>false</code> ï¼‰ã€‚ ä½†æ˜¯ä½¿ç”¨<code>halt()</code>è¿™åªä¼šè¾“å‡º<code>foo</code> ã€‚  *ç°åœ¨ç”šè‡³æ²¡æœ‰ç»“æœï¼Œå› ä¸º<code>halt()</code>ä¸ä¼šå¼•èµ·å»¶ç»­ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬æ°¸è¿œä¸ä¼šè°ƒç”¨ä¼ é€’ç»™æˆ‘ä»¬<code>evaluate</code>çš„å›è°ƒ-æ˜¾ç¤ºå­—ç¬¦ä¸²<code>***Result</code>çš„å›è°ƒã€‚ è°ƒç”¨<code>evaluate</code>çš„å‡½æ•°ä¸ä¼šæ³¨æ„åˆ°ç¨‹åºå·²åœæ­¢ã€‚ åœ¨NodeJSä¸­ï¼Œè¿™å°†æ˜¯ä¸€é’ˆè§è¡€ã€‚ </p><br><hr><br><p> æƒ³è±¡ä¸€ä¸‹ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ª<code>sleepe</code>å‡½æ•°ï¼Œè¯¥å‡½æ•°å¯ä»¥åœ¨ä¸åœæ­¢æµè§ˆå™¨çš„æƒ…å†µä¸‹åœæ­¢ç¨‹åºï¼ˆå› æ­¤æ²¡æœ‰æ„šè ¢çš„å¾ªç¯ï¼‰ã€‚ æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æœ¬æœºå‡½æ•°è½»æ¾å®ç°æ­¤ç›®çš„ï¼š </p><br><pre> <code class="javascript hljs">globalEnv.def(<span class="hljs-string"><span class="hljs-string">"sleep"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">k, milliseconds</span></span></span><span class="hljs-function">)</span></span>{ setTimeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ Execute(k, [ <span class="hljs-literal"><span class="hljs-literal">false</span></span> ]); <span class="hljs-comment"><span class="hljs-comment">//   ,  'false' }, milliseconds); });</span></span></code> </pre> <br><p> æœ‰ç‚¹ä¸ä¾¿ä¹‹å¤„æ˜¯ï¼Œæˆ‘ä»¬å¿…é¡»ä½¿ç”¨<code>Execute</code> ï¼Œå› ä¸º<code>setTimeout</code>å°†å¯¼è‡´å›è°ƒï¼Œç„¶åå¼•å‘<code>Continuation</code> ï¼Œå¹¶ä¸”æ²¡æœ‰äººå¯ä»¥æ•è·å®ƒã€‚ ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š </p><br><pre> <code class="python hljs">let loop (n = <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> n &lt; <span class="hljs-number"><span class="hljs-number">10</span></span> { println(n); sleep(<span class="hljs-number"><span class="hljs-number">250</span></span>); loop(n + <span class="hljs-number"><span class="hljs-number">1</span></span>); } }; println(<span class="hljs-string"><span class="hljs-string">"And we're done"</span></span>);</code> </pre> <br><p> ç»“è®ºï¼š </p><br><pre> <code class="plaintext hljs">0 1 2 3 4 5 6 7 8 9 And we're done ***Result: false</code> </pre> <br><p> è¯·æ³¨æ„ï¼Œæ¯è¡Œä¹‹é—´ä¼šæœ‰ä¸€ç‚¹å»¶è¿Ÿã€‚ æ‚¨å¯ä»¥å°è¯•åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åŸå§‹æ–‡ç« ä¸­</a>è¿è¡Œæ­¤ä»£ç ã€‚ </p><br><p> è¿™å·²ç»æ˜¯æ‚¨åœ¨æ™®é€šJavaScriptä¸­æ— æ³•åšåˆ°çš„äº‹æƒ…ï¼Œé™¤äº†ä½¿ç”¨æ‰‹åŠ¨ä¼ è¾“è¿ç»­æ€§ä¹‹å¤–ï¼ˆè€Œä¸”ï¼Œæ‚¨ä¸èƒ½<code>for</code>ä½¿ç”¨<code>for</code>å¾ªç¯ï¼‰ï¼š </p><br><pre> <code class="javascript hljs">(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loop</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">n</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(n); setTimeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ loop(n + <span class="hljs-number"><span class="hljs-number">1</span></span>); }, <span class="hljs-number"><span class="hljs-number">250</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { println(<span class="hljs-string"><span class="hljs-string">"And we're done"</span></span>); <span class="hljs-comment"><span class="hljs-comment">//    } })(0);</span></span></code> </pre> <br><hr><br><p> æƒ³è±¡ä¸€ä¸‹å¦‚ä½•ä»¥Î»è¯­è¨€ä½¿ç”¨NodeJS APIï¼š </p><br><pre> <code class="javascript hljs">globalEnv.def(<span class="hljs-string"><span class="hljs-string">"readFile"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">k, filename</span></span></span><span class="hljs-function">)</span></span>{ fs.readFile(filename, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, data</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-comment"><span class="hljs-comment">// error handling is a bit more complex, ignoring for now Execute(k, [ data ]); // hope it's clear why we need the Execute }); }); globalEnv.def("writeFile", function(k, filename, data){ fs.writeFile(filename, data, function(err){ Execute(k, [ false ]); }); });</span></span></code> </pre> <br><p> ç”¨æ³•ï¼š </p><br><pre> <code class="python hljs">copyFile = Î»(source, dest) { writeFile(dest, readFile(source)); }; copyFile(<span class="hljs-string"><span class="hljs-string">"foo.txt"</span></span>, <span class="hljs-string"><span class="hljs-string">"bar.txt"</span></span>);</code> </pre> <br><p> æ‰€æœ‰è¿™ä¸€åˆ‡éƒ½æ˜¯å¼‚æ­¥çš„ã€‚ æ²¡æœ‰æ›´å¤šçš„å›è°ƒåœ°ç‹±ã€‚ </p><br><hr><br><p> è¿™æ˜¯ä¸€ä¸ªæ›´æœ‰è¶£çš„ç¤ºä¾‹ã€‚ æˆ‘ç¼–å†™äº†ä»¥ä¸‹æœ¬æœºå‡½æ•°ï¼š </p><br><pre> <code class="javascript hljs">globalEnv.def(<span class="hljs-string"><span class="hljs-string">"twice"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">k, a, b</span></span></span><span class="hljs-function">)</span></span>{ k(a); k(b); });</code> </pre> <br><p> è¯¥ç¨‹åºé‡‡ç”¨ä¸¤ä¸ªå‚æ•°<code>a</code>å’Œ<code>b</code>å¹¶è°ƒç”¨è¿ç»­ä¸¤æ¬¡ï¼Œæ¯ä¸ªå‚æ•°ä¸€æ¬¡ã€‚ è®©æˆ‘ä»¬å°è¯•è°ƒç”¨å®ƒï¼š </p><br><pre> <code class="python hljs">println(<span class="hljs-number"><span class="hljs-number">2</span></span> + twice(<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>)); println(<span class="hljs-string"><span class="hljs-string">"Done"</span></span>);</code> </pre> <br><p> ç»“è®ºï¼š </p><br><pre> <code class="plaintext hljs">5 Done ***Result: false 6 Done ***Result: false</code> </pre> <br><p> å¦‚æœæ‚¨ä»¥å‰ä»æœªä½¿ç”¨è¿‡å»¶ç»­ï¼Œä½†å°è¯•è‡ªå·±ç†è§£æ­¤ä»£ç ï¼Œåˆ™å¾—å‡ºçš„ç»“è®ºå¾ˆå¥‡æ€ªã€‚ ä¸€ä¸ªå°æç¤ºï¼šç¨‹åºå¯åŠ¨ä¸€æ¬¡ï¼Œä½†è¿”å›ç»“æœä¸¤æ¬¡ã€‚ </p><br><h2 id="obobschenie-callcc"> é€šç”¨åŒ–ï¼š <code>CallCC</code> </h2><br><p> ç¼–å†™æœ¬æœºå‡½æ•°æ—¶ï¼Œæˆ‘ä»¬ç»å¸¸ç©ç«ã€‚  Î»è¯­è¨€ä¸­æ²¡æœ‰åŠæ³•ä¸­æ–­å½“å‰å»¶ç»­çš„æ‰§è¡Œã€‚  <code>CallCC</code>å°†å¸®åŠ©è§£å†³æ­¤é—®é¢˜ã€‚ è¯¥åç§°æ˜¯Schemeçš„åŠŸèƒ½çš„ç¼©å†™<code>call-with-current-continuation</code>è°ƒç”¨ï¼ˆåœ¨Schemeä¸­é€šå¸¸ç§°ä¸ºcall / ccï¼‰ã€‚ </p><br><pre> <code class="javascript hljs">globalEnv.def(<span class="hljs-string"><span class="hljs-string">"CallCC"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">k, f</span></span></span><span class="hljs-function">)</span></span>{ f(k, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CC</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">discarded, ret</span></span></span><span class="hljs-function">)</span></span>{ k(ret); }); });</code> </pre> <br><p> å®ƒå°†å½“å‰å»¶ç»­åŒ–ä¸ºå¯ä»¥ç›´æ¥ä»Î»è¯­è¨€è°ƒç”¨çš„å‡½æ•°ã€‚ æ­¤å‡½æ•°å°†å¿½ç•¥å…¶åŸå§‹<code>discarded</code>å»¶ç»­ï¼Œè€Œæ˜¯è°ƒç”¨ä¼ é€’ç»™<code>CallCC</code>å‡½æ•°çš„å»¶ç»­ã€‚ </p><br><p> ä½¿ç”¨æ­¤å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ï¼ˆå·²ç»ç›´æ¥ä½¿ç”¨Î»è¯­è¨€ï¼Œè€Œä¸æ˜¯é€šè¿‡æœ¬æœºå‡½æ•°ï¼ï¼‰æˆ‘ä»¬ç”šè‡³ä»æœªè€ƒè™‘è¿‡çš„å¤§é‡æ‰§è¡Œæµæ§åˆ¶æ“ä½œç¬¦-ä»å¼‚å¸¸å¼€å§‹åˆ°ä»¥<code>return</code>ç»“æŸã€‚ è®©æˆ‘ä»¬ä»æœ€åå¼€å§‹ã€‚ </p><br><h3 id="realizaciya-return"> å®æ–½<code>return</code> </h3><br><pre> <code class="python hljs">foo = Î»(<span class="hljs-keyword"><span class="hljs-keyword">return</span></span>){ println(<span class="hljs-string"><span class="hljs-string">"foo"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(<span class="hljs-string"><span class="hljs-string">"DONE"</span></span>); println(<span class="hljs-string"><span class="hljs-string">"bar"</span></span>); }; CallCC(foo);</code> </pre> <br><p> ç»“è®ºï¼š </p><br><pre> <code class="plaintext hljs">foo ***Result: DONE</code> </pre> <br><p>  <code>foo</code>å‡½æ•°æ¥æ”¶çš„å‚æ•°ä¸ä»JavaScript <code>return</code>çš„å‚æ•°ç›¸åŒï¼ˆä½†è¢«ç§°ä¸ºå¸¸è§„å‡½æ•°ï¼‰ã€‚ å®ƒè·³è¿‡å½“å‰çš„å»¶ç»­ï¼ˆå°†è¾“å‡ºâ€œ barâ€ï¼‰å¹¶é€€å‡ºå‡½æ•°ï¼Œè¿”å›ç»™å®šå€¼ï¼ˆâ€œ DONEâ€ï¼‰ã€‚ å½“ç„¶ï¼Œè¿™ä»…åœ¨æ‚¨ä½¿ç”¨<code>CallCC</code>è°ƒç”¨å‡½æ•°ä»¥å°†å»¶ç»­ä½œä¸º<code>return</code>ä¼ é€’æ—¶<code>CallCC</code> ã€‚ æˆ‘ä»¬å¯ä»¥ä¸ºæ­¤åˆ›å»ºä¸€ä¸ªåŒ…è£…å™¨ï¼š </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> = Î»(f) Î»() CallCC(f); foo = <span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(Î»(<span class="hljs-keyword"><span class="hljs-keyword">return</span></span>){ println(<span class="hljs-string"><span class="hljs-string">"foo"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(<span class="hljs-string"><span class="hljs-string">"DONE"</span></span>); println(<span class="hljs-string"><span class="hljs-string">"bar"</span></span>); }); foo();</code> </pre> <br><p> ç»“è®ºï¼š </p><br><pre> <code class="plaintext hljs">foo ***Result: DONE</code> </pre> <br><p> è¿™ç§æ–¹æ³•çš„ä¼˜ç‚¹æ˜¯ï¼Œå½“æˆ‘ä»¬è°ƒç”¨<code>foo</code>æ—¶ï¼Œæˆ‘ä»¬ä¸å†éœ€è¦ä½¿ç”¨<code>CallCC</code> ã€‚ å½“ç„¶ï¼Œå¦‚æœæˆ‘ä»¬ä¸éœ€è¦æ¥å—<code>return</code>ä½œä¸ºå‚æ•°æˆ–ä½¿ç”¨<code>with-return</code>å‡½æ•°ï¼Œé‚£ä¼šå¾ˆå¥½ï¼Œä½†æ˜¯åœ¨è¯¥è¯­è¨€ä¸­ï¼Œæ— æ³•ç›´æ¥ä»ä¸­æ·»åŠ è¯­æ³•ç³–ï¼Œä¸ºæ­¤ï¼Œæˆ‘ä»¬è‡³å°‘éœ€è¦ä¿®æ”¹è§£æå™¨ï¼ˆå¯¹äºLispè€Œè¨€ä¸º+1ï¼‰ã€‚ </p><br><h3 id="perehody"> è½¬åœº </h3><br><p> ä¾‹å¦‚ï¼Œæˆ‘ä»¬éœ€è¦ç¼–å†™ä¸€ä¸ªç¨‹åºæ¥æŸ¥æ‰¾æ‰€æœ‰æœ€å¤§ä¸º100çš„æ­£æ•´æ•°å¯¹ï¼Œå¦‚æœå®ƒä»¬çš„ä¹˜æ³•ç»“æœä¸º84ã€‚è¿™ä¸æ˜¯ä¸€ä»¶å®¹æ˜“çš„äº‹ï¼Œæ‚¨å¯ä»¥ç«‹å³æƒ³è±¡ä¸¤ä¸ªåµŒå¥—å¾ªç¯æ¥è§£å†³å®ƒï¼Œä½†æ˜¯è¿™é‡Œæˆ‘ä»¬é‡‡ç”¨äº†å¦ä¸€ç§æ–¹æ³•ã€‚ æˆ‘ä»¬å°†åˆ›å»ºä¸¤ä¸ªå‡½æ•°ï¼š <code>guess</code>å’Œ<code>fail</code> ã€‚ ç¬¬ä¸€ä¸ªä¼šé€‰æ‹©å·ç ï¼Œç¬¬äºŒä¸ªä¼šå‘Šè¯‰å¥¹â€œå°è¯•å¦ä¸€ä¸ªå·ç â€ã€‚ æˆ‘ä»¬å°†åƒè¿™æ ·ä½¿ç”¨å®ƒä»¬ï¼š </p><br><pre> <code class="python hljs">a = guess(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-comment"><span class="hljs-comment">#  -  &gt;= 1 b = guess(a); #  -  &gt;= a if a * b == 84 { #    : print(a); print(" x "); println(b); }; fail(); #    `guess`    </span></span></code> </pre> <br><p>  : </p><br><pre> <code class="python hljs">fail = Î»() false; guess = Î»(current) { CallCC(Î»(k){ let (prevFail = fail) { fail = Î»(){ current = current + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> current &gt; <span class="hljs-number"><span class="hljs-number">100</span></span> { fail = prevFail; fail(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { k(current); }; }; k(current); }; }); }; a = guess(<span class="hljs-number"><span class="hljs-number">1</span></span>); b = guess(a); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> a * b == <span class="hljs-number"><span class="hljs-number">84</span></span> { print(a); print(<span class="hljs-string"><span class="hljs-string">" x "</span></span>); println(b); }; fail();</code> </pre> <br><p>     ,  ,      <code>a</code> ,    <code>84</code> ,   <code>b</code> ,  <code>84 / a</code> .           <code>guess</code> : <code>start</code>  <code>end</code> â€”      .   ,  . </p><br><h3 id="try-i-catch-iz-common-lisp"> <code>try</code>  <code>catch</code>  Common Lisp </h3><br><p>     â€” <code>catch</code>  <code>throw</code> .     : </p><br><pre> <code class="python hljs">f1 = Î»() { throw(<span class="hljs-string"><span class="hljs-string">"foo"</span></span>, <span class="hljs-string"><span class="hljs-string">"EXIT"</span></span>); print(<span class="hljs-string"><span class="hljs-string">"not reached"</span></span>); }; println(catch(<span class="hljs-string"><span class="hljs-string">"foo"</span></span>, Î»() { f1(); print(<span class="hljs-string"><span class="hljs-string">"not reached"</span></span>); })); <span class="hljs-comment"><span class="hljs-comment">#  EXIT</span></span></code> </pre> <br><ul><li>  <code>catch(TAG, function)</code>  ,    ,  <code>TAG</code> ',   <code>function</code> . </li><li>  <code>throw(TAG, value)</code>  ,     ,  <code>TAG</code> '  ,     <code>value</code> . </li></ul><br><p>  : </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">##  , 'throw'   . ##       `error`, ##     JavaScript.    . throw = Î»(){ println("ERROR: No more catch handlers!"); halt(); }; catch = Î»(tag, func){ CallCC(Î»(k){ let (rethrow = throw, ret) { ##   ,     . throw = Î»(t, val) { throw = rethrow; #   ,   . if t == tag then k(val) else throw(t, val); }; ##      . ret = func(); ##       (  'throw') ##    .   . throw = rethrow; # XXX ##  . ret; }; }); };</span></span></code> </pre> <br><p> ä¸€ä¸ªä¾‹å­ï¼š </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># ... f1 = Î»() { throw("foo", "EXIT"); print("not reached"); }; println(catch("foo", Î»() { f1(); print("not reached"); }));</span></span></code> </pre> <br><h2 id="temnaya-storona-sily">    </h2><br><p>    <code>catch</code> ,     ,    ,    .   ,    , ,  <code>CallCC</code>     .    ,     .    "   " â€”      â€”  .    ,  ,     ,  <code>catch</code> / <code>throw</code>    ,  . </p><br><p>    .   ,    <code>catch</code> . ,   <code>throw</code>   , ,  <code>catch</code>   ,     . ä¾‹å¦‚ï¼š </p><br><pre> <code class="python hljs">exit = false; <span class="hljs-comment"><span class="hljs-comment">#  . x = 0; # :   ,   'exit()'  CallCC( Î»(k) exit = k ); ## 'exit()'   ... if x == 0 then catch("foo", Î»(){ println("in catch"); x = 1; #  exit(); }); println("After catch"); throw("foo", "FOO");</span></span></code> </pre> <br><p> ç»“è®ºï¼š </p><br><pre> <code class="plaintext hljs">After catch After catch ERROR: No more catch handlers!</code> </pre> <br><p>    'After catch' ,   'ERROR: No more catch handlers!'. -  ,   'After catch'   ,   . ,  ''  ,  <code>catch</code> . ,    'XXX'   <code>catch</code>   ,         <code>throw</code> ,   <code>catch</code>   . </p><br><p> (       ,     .) </p><br><p>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">  CallCC</a> (, <em>   ,   CallCC</em> ).  ,    â€”  <code>CallCC</code>           . </p><br><h1 id="yield"> Yield </h1><br><p> ,    ,   <code>yield</code> : </p><br><pre> <code class="python hljs">foo = <span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">yield</span></span>(Î»(<span class="hljs-keyword"><span class="hljs-keyword">yield</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span>(<span class="hljs-number"><span class="hljs-number">3</span></span>); <span class="hljs-string"><span class="hljs-string">"DONE"</span></span>; }); println(foo()); <span class="hljs-comment"><span class="hljs-comment"># 1 println(foo()); # 2 println(foo()); # 3 println(foo()); # DONE</span></span></code> </pre> <br><p>    <code>yield</code> ,       .  ,  <code>return</code> .      ,       ,    <code>yield</code> ,       . </p><br><p>  : </p><br><pre> <code class="python hljs">fib = <span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">yield</span></span>(Î»(<span class="hljs-keyword"><span class="hljs-keyword">yield</span></span>){ let loop (a = <span class="hljs-number"><span class="hljs-number">1</span></span>, b = <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span>(b); loop(b, a + b); }; }); <span class="hljs-comment"><span class="hljs-comment">##   50   let loop (i = 0) { if i &lt; 50 { println(fib()); loop(i + 1); }; };</span></span></code> </pre> <br><p>  <code>fib</code>   .    .  <code>yield</code>      .     ,    ,         50  ,      50 . </p><br><p> ,      ,     , ,            . </p><br><h2 id="neudachnaya-popytka-realizacii">    </h2><br><p>          ,         . </p><br><p>   <code>yield</code> ,  ,       .   ,        ,      <code>return</code> . ,  ,    <code>yield</code> ,       <code>yield</code> ,         <em></em> .   ,   .      : </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> = Î»(func) { <span class="hljs-comment"><span class="hljs-comment">## with-yield     Î»() { CallCC(Î»(kret){ # kret     let (yield) { ##  yield yield = Î»(value) { # yield  ,    CallCC(Î»(kyld){ # kyld    yield... func = kyld; # ...     kret(value); #  . }); }; ## , ,  ,   yield. func(yield); }; }); }; };</span></span></code> </pre> <br><p>       <code>yield</code>  ,     . ,         ,     ,      "DONE". </p><br><p> ,     .   ,     - ,     ,    4   : </p><br><pre> <code class="python hljs">println(foo()); foo();</code> </pre> <br><p>    . </p><br><h3 id="problema-1-yield-nikogda-ne-izmenyaetsya">  â„–1: yield    </h3><br><p>  ,   ,  ,   ,     <code>yield</code> ( <code>kyld</code> ,    ,   )    : </p><br><pre> <code class="python hljs"> <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span>(<span class="hljs-number"><span class="hljs-number">3</span></span>); <span class="hljs-string"><span class="hljs-string">"DONE"</span></span>;</code> </pre> <br><p>    <code>yield</code>   ?     <code>yield</code> ,       ,    <code>yield</code>    . ,    .  ,     <code>yield</code>        <code>return</code> ,      : </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> = Î»(func) { let (<span class="hljs-keyword"><span class="hljs-keyword">return</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> = Î»(value) { CallCC(Î»(kyld){ func = kyld; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(value); <span class="hljs-comment"><span class="hljs-comment"># 'return'  ,     }); #        . }; # Î»(val) { # CallCC(Î»(kret){ # return = kret; # &lt;-  func(val || yield); }); }; }; };</span></span></code> </pre> <br><p> ,  ,       <code>yield</code>  ,   <code>yield</code>       (  ).      <code>yield</code> . </p><br><p>   ,    ,    <code>println(foo())</code>   : </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> = Î»(func) { let (<span class="hljs-keyword"><span class="hljs-keyword">return</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> = Î»(value) { CallCC(Î»(kyld){ func = kyld; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(value); }); }; Î»(val) { CallCC(Î»(kret){ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> = kret; func(val || <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span>); }); }; }; }; foo = <span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">yield</span></span>(Î»(<span class="hljs-keyword"><span class="hljs-keyword">yield</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span>(<span class="hljs-number"><span class="hljs-number">3</span></span>); <span class="hljs-string"><span class="hljs-string">"DONE"</span></span>; }); println(foo()); println(foo()); println(foo());</code> </pre> <br><p> ,    .        ,      <code>print(foo()); foo()</code> .   ,     <code>println(foo())</code> ?   ... </p><br><h3 id="problema-2-wtf">  â„–2: WTF? </h3><br><p>     .     :    ,          <code>foo()</code> .  ,     ? â€”    . </p><br><pre> <code class="python hljs">println(foo()); <span class="hljs-comment"><span class="hljs-comment">## yield 1 &lt;-----------------  ---------------------------+ println(foo()); ## yield 2 | println(foo()); ## yield 3 | println(foo()); ##   "DONE",   foo()  --&gt;--+</span></span></code> </pre> <br><p>       <code>with-yield</code> : </p><br><pre> <code class="python hljs"> func(val || <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span>); <span class="hljs-comment"><span class="hljs-comment">#...</span></span></code> </pre> <br><p>     <code>yield</code> ,   ,       <code>#...</code> .   ,   ,     ( <code>"DONE"</code> ),     ,   <code>"DONE"</code>   ,     . <code>foo()</code>     ,    <code>"DONE"</code>   .      : </p><br><pre> <code class="python hljs">println(foo()); println(<span class="hljs-string"><span class="hljs-string">"bar"</span></span>); println(foo()); println(foo()); foo();</code> </pre> <br><p>   : <code>1, bar, 2, 3, DONE, bar, DONE, bar, ...</code> . </p><br><p>      <code>func</code>  - ,    .   ,    <code>"no more continuations"</code> : </p><br><pre> <code class="python hljs"> val = func(val || <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span>); func = Î»() <span class="hljs-string"><span class="hljs-string">"NO MORE CONTINUATIONS"</span></span>; kret(val);</code> </pre> <br><p>     : </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> = Î»(func) { let (<span class="hljs-keyword"><span class="hljs-keyword">return</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> = Î»(value) { CallCC(Î»(kyld){ func = kyld; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(value); }); }; Î»(val) { CallCC(Î»(kret){ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> = kret; val = func(val || <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span>); func = Î»() <span class="hljs-string"><span class="hljs-string">"NO MORE CONTINUATIONS"</span></span>; kret(val); }); }; }; }; foo = <span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">yield</span></span>(Î»(<span class="hljs-keyword"><span class="hljs-keyword">yield</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span>(<span class="hljs-number"><span class="hljs-number">3</span></span>); <span class="hljs-string"><span class="hljs-string">"DONE"</span></span>; }); println(foo()); println(foo()); println(foo()); println(foo());</code> </pre> <br><p>      ,     : </p><br><pre> <code class="plaintext hljs">1 2 3 DONE NO MORE CONTINUATIONS NO MORE CONTINUATIONS NO MORE CONTINUATIONS ***Result: false</code> </pre> <br><p>    <code>1, 2, 3, DONE</code> ,      <code>"NO MORE CONTINUATIONS"</code>  .  ,       : </p><br><pre> <code class="python hljs">print(<span class="hljs-string"><span class="hljs-string">"A. "</span></span>); println(foo()); print(<span class="hljs-string"><span class="hljs-string">"B. "</span></span>); println(foo()); print(<span class="hljs-string"><span class="hljs-string">"C. "</span></span>); println(foo()); print(<span class="hljs-string"><span class="hljs-string">"D. "</span></span>); println(foo()); <span class="hljs-comment"><span class="hljs-comment">##   : A. 1 B. 2 C. 3 D. DONE B. NO MORE CONTINUATIONS C. NO MORE CONTINUATIONS D. NO MORE CONTINUATIONS ***Result: false</span></span></code> </pre> <br><p>  ,     :       , , ,      ,  <code>"B."</code>   . </p><br><p>       ,         <code>yield</code> ,     : </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> = Î»(func) { let (<span class="hljs-keyword"><span class="hljs-keyword">return</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> = Î»(value) { CallCC(Î»(kyld){ func = kyld; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(value); }); }; Î»(val) { CallCC(Î»(kret){ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> = kret; val = func(val || <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span>); func = Î»() <span class="hljs-string"><span class="hljs-string">"NO MORE CONTINUATIONS"</span></span>; kret(val); }); }; }; }; fib = <span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">yield</span></span>(Î»(<span class="hljs-keyword"><span class="hljs-keyword">yield</span></span>){ let loop (a = <span class="hljs-number"><span class="hljs-number">1</span></span>, b = <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span>(b); loop(b, a + b); }; }); <span class="hljs-comment"><span class="hljs-comment">##   50   let loop (i = 0) { if i &lt; 50 { println(fib()); loop(i + 1); }; };</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">ç»“è®º</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">1 2 3 5 8 13 21 34 55 89 144 233 377 610 987 1597 2584 4181 6765 10946 17711 28657 46368 75025 121393 196418 317811 514229 832040 1346269 2178309 3524578 5702887 9227465 14930352 24157817 39088169 63245986 102334155 165580141 267914296 433494437 701408733 1134903170 1836311903 2971215073 4807526976 7778742049 12586269025 20365011074 ***Result: false</code> </pre> </div></div><br><p> ,      (,       ),       " ". </p><br><h2 id="otdelennye-prodolzheniya-reset-i-shift">  : <code>reset</code>  <code>shift</code> </h2><br><p>    <code>yield</code>    : <code>reset</code>  <code>shift</code> .   " " â€” ,     .  <code>reset</code>  ,   <code>shift</code>     ,   <code>CallCC</code> . </p><br><p>  , <code>reset</code>  <code>shift</code>    â€” .     <code>reset</code> ,  <code>shift</code>      ,    <code>reset</code> . </p><br><p>  ,    <code>with-yield</code> : </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> = Î»(func) { let (<span class="hljs-keyword"><span class="hljs-keyword">yield</span></span>) { <span class="hljs-comment"><span class="hljs-comment">## 'yield'  'shift'     ##  'reset'.  ,   ,    ##   'func' â€” ,   `func()` ##    ,    . yield = Î»(val) { shift(Î»(k){ func = k; #    val; #    }); }; ##  `with-yield`      ##   'reset',    ,  ##   'yield' ( )    ##    Î»(val) { reset( Î»() func(val || yield) ); }; } };</span></span></code> </pre> <br><p>  ,      <code>reset</code> .  ,  ,       ,     <code>reset</code> .  ,    .     ,           . </p><br><p>     : </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> = Î»(func) { let (<span class="hljs-keyword"><span class="hljs-keyword">yield</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> = Î»(val) { shift(Î»(k){ func = k; val; }); }; Î»(val) { reset( Î»() func(val || <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span>) ); }; } }; foo = <span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">yield</span></span>(Î»(<span class="hljs-keyword"><span class="hljs-keyword">yield</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span>(<span class="hljs-number"><span class="hljs-number">3</span></span>); <span class="hljs-string"><span class="hljs-string">"DONE"</span></span>; }); println(foo()); <span class="hljs-comment"><span class="hljs-comment">#  1 println(foo()); #  2 println(foo()); #  3 println(foo()); #  DONE</span></span></code> </pre> <br><h2 id="realizaciya-reset-i-shift">  <code>reset</code>  <code>shift</code> </h2><br><p>       ,      .    .     .     ,     ,        ,   .    <a href="">  Scheme</a> ( â€” <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Oleg Kiselyov</a> ).   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="> </a>     . </p><br><h3 id="ispolzuya-nativnye-funkcii">    </h3><br><p>      ,      (    <code>CallCC</code> )         .   : </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pstack = []; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_goto</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">f</span></span></span><span class="hljs-function">) </span></span>{ f(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">KGOTO</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">r</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> h = pstack.pop(); h(r); }); } globalEnv.def(<span class="hljs-string"><span class="hljs-string">"reset"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">KRESET, th</span></span></span><span class="hljs-function">)</span></span>{ pstack.push(KRESET); _goto(th); }); globalEnv.def(<span class="hljs-string"><span class="hljs-string">"shift"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">KSHIFT, f</span></span></span><span class="hljs-function">)</span></span>{ _goto(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">KGOTO</span></span></span><span class="hljs-function">)</span></span>{ f(KGOTO, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SK</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">k1, v</span></span></span><span class="hljs-function">)</span></span>{ pstack.push(k1); KSHIFT(v); }); }); });</code> </pre> <br><p>   ,   <code>reset</code> ,   <code>shift</code>  <code>_goto</code> ,  â€”  .     .  <code>_goto</code>         ( <code>KGOTO</code> ).  ,       <code>f</code> (  <code>CallCC</code> )    -      <code>KGOTO</code> ,     .  ,  <code>f</code> ,   ,    <code>KGOTO</code> ,      ,     . </p><br><p>  <code>reset</code>      ( <code>KRESET</code> )     <code>_goto(th)</code> .      ,    , ,      <code>_goto</code> . ,     , <code>KGOTO</code>   <code>KRESET</code> . </p><br><p>   , <code>shift</code>     <code>KGOTO</code>     ,  <code>KGOTO</code>    <code>pstack</code> ,      <code>SK</code> ,     ,   <code>shift</code>   (   <code>shift</code> â€” <code>KSHIFT</code> ).  <code>SK</code> â€”   â€”              ( <code>k1</code> )   .   ,     <code>shift2</code> ,    ,    <code>pstack.push(k1);</code>  ï¼š </p><br><pre> <code class="python hljs">println(reset(Î»(){ <span class="hljs-number"><span class="hljs-number">1</span></span> + shift( Î»(k) k(k(<span class="hljs-number"><span class="hljs-number">2</span></span>)) ); })); println(reset(Î»(){ <span class="hljs-number"><span class="hljs-number">1</span></span> + shift2( Î»(k) k(k(<span class="hljs-number"><span class="hljs-number">2</span></span>)) ); }));</code> </pre> <br><p> ç»“è®ºï¼š </p><br><pre> <code class="plaintext hljs">4 3 ***Result: false</code> </pre> <br><p>  <code>shift</code>    ( <code>k</code> ),       <code>reset</code> .     â€”  1   <code>shift</code> : </p><br><pre> <code class="python hljs"><span class="hljs-number"><span class="hljs-number">1</span></span> + [?]</code> </pre> <br><p>    <code>k</code> ,   <code>?</code> .     â€” <code>k(k(2))</code> .   2   ,   <code>k(2)</code>  3. ,  <code>k(3)</code>  3     ,     4. </p><br><p> <code>shift2</code>  :  k(2)    . </p><br><h3 id="ispolzuya-callcc">  <code>CallCC</code> </h3><br><p>   ,       ,     <code>CallCC</code> ,    .     ,     JS, ,      ,       .    ,    <code>CallCC</code> ,    . </p><br><p>      â€”    <code>goto</code> ,       (    ): </p><br><pre> <code class="plaintext hljs">pstack = NIL; goto = false; reset = Î»(th) { CallCC(Î»(k){ pstack = cons(k, pstack); goto(th); }); }; shift = Î»(f) { CallCC(Î»(k){ goto(Î»(){ f(Î»(v){ CallCC(Î»(k1){ pstack = cons(k1, pstack); k(v); }); }); }); }); }; let (v = CallCC( Î»(k){ goto = k; k(false) } )) { if v then let (r = v(), h = car(pstack)) { pstack = cdr(pstack); h(r); } };</code> </pre> <br><p>          â€”        ! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN444024/">https://habr.com/ru/post/zh-CN444024/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN444014/index.html">å¾®è½¯å¼€è®¾å•†å­¦é™¢ä»¥å­¦ä¹ AIç­–ç•¥ï¼Œæ–‡åŒ–å’Œè´£ä»»æ„Ÿ</a></li>
<li><a href="../zh-CN444016/index.html">åˆ©ç”¨Microsoft Game Stackå–å¾—æ›´å¤šæˆå°±</a></li>
<li><a href="../zh-CN444018/index.html">ä¸€é¡¹PostgreSQLé…ç½®æ›´æ”¹å¦‚ä½•å°†æ…¢é€ŸæŸ¥è¯¢æ€§èƒ½æé«˜50å€</a></li>
<li><a href="../zh-CN444020/index.html">å¡ä¸è½¦åœ¨è‹è”ï¼šç¾å›½é£è¡Œå‘˜çš„çˆ±å¥½å¦‚ä½•æˆä¸ºè‹è”çš„å¤§è§„æ¨¡DIYçˆ±å¥½</a></li>
<li><a href="../zh-CN444022/index.html">æ¯”æˆˆä¸å†</a></li>
<li><a href="../zh-CN444026/index.html">MODX Digestï¼ƒ1.1ï¼ˆ2019å¹´2æœˆ25æ—¥è‡³3æœˆ11æ—¥ï¼‰</a></li>
<li><a href="../zh-CN444028/index.html">å¾®è½¯æ¸¸æˆå †æ ˆä»‹ç»</a></li>
<li><a href="../zh-CN444030/index.html">ä¸­å›½åœ¨çº¿é›¶å”®å•†Gearbestä¿ç•™äº†ä¸€ä¸ªæ‹¥æœ‰æ•°ç™¾ä¸‡ä¸ªäººå®¢æˆ·æ•°æ®çš„æ•°æ®åº“</a></li>
<li><a href="../zh-CN444032/index.html">ä¸ºä»€ä¹ˆ3Dæ‰“å°æœºä¸æ˜¯æ‰“å°æœº</a></li>
<li><a href="../zh-CN444034/index.html">ç»ç†çš„ä¸ƒå¤§è‡´å‘½ç½ªè¿‡</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>