<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏼‍💼 🥕 ✋🏾 Sichern von Windows-Servern in AWS 😒 👩🏿‍🤝‍👨🏻 👩‍👩‍👧</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Wir haben Windows Server in AWS und die Aufgabe besteht darin, die Sicherung zu konfigurieren. Sie können Snapshots verwenden, aber dann tritt ein Pro...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Sichern von Windows-Servern in AWS</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/462601/"> Wir haben Windows Server in AWS und die Aufgabe besteht darin, die Sicherung zu konfigurieren.  Sie können Snapshots verwenden, aber dann tritt ein Problem mit der Datenintegrität auf.  Ich möchte auch wöchentliche und monatliche Schnappschüsse aufbewahren, aber der Lebenszyklus in Schnappschüssen bietet dies nicht.  Der neue AWS Backup-Dienst weiß auch noch nicht, wie vollständige Snapshots erstellt werden sollen, oder ich habe nicht gefunden, wie.  Nun, ich möchte, dass all dies ohne meine Teilnahme so gut wie möglich funktioniert. <br><a name="habracut"></a><br>  Um die Aufgabe zu erfüllen, die wir brauchen <br><br><ol><li>  Windows Server 2008 R2 oder höher mit AWS </li><li>  SSM Agent Version 2.2.58.0 oder höher </li><li>  AWS Tools für Windows PowerShell 3.3.48.0 oder höher </li><li>  AWS System Manager </li><li>  Ich bin </li><li>  SNS </li><li>  Lambda </li></ol><br>  Zuerst brauchen wir eine Rolle für den Server.  Die Rolle sollte AWS SSM und die Erstellung von EBS-Snapshots ermöglichen. <br><br>  Gehen Sie zu IAM → Richtlinien → Richtlinie erstellen. <br>  Gehen Sie zur Registerkarte JSON und fügen Sie sie ein <br><br><pre><code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"Version"</span></span>: <span class="hljs-string"><span class="hljs-string">"2012-10-17"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"Statement"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"Effect"</span></span>: <span class="hljs-string"><span class="hljs-string">"Allow"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"Action"</span></span>: <span class="hljs-string"><span class="hljs-string">"ec2:CreateTags"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"Resource"</span></span>: <span class="hljs-string"><span class="hljs-string">"arn:aws:ec2:*::snapshot/*"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"Effect"</span></span>: <span class="hljs-string"><span class="hljs-string">"Allow"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"Action"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"ec2:DescribeInstances"</span></span>, <span class="hljs-string"><span class="hljs-string">"ec2:CreateSnapshot"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"Resource"</span></span>: <span class="hljs-string"><span class="hljs-string">"*"</span></span> } ] }</code> </pre> <br>  Wir drücken die Überprüfungsrichtlinie in dem Namen, in dem wir so etwas wie VssSnapshotPolicy schreiben.  Speichern <br><br>  Erstellen Sie jetzt eine Rolle. <br>  IAM → Rollen → Rolle erstellen <br><br>  Wählen Sie AWS Service → EC2 und gehen Sie zu Berechtigungen. <br><br>  Hier fügen wir AmazonSSMManagedInstanceCore für SMM und unsere Richtlinie hinzu, die wir zuvor mit VssSnapshotPolicy erstellt haben.  Wenn gewünscht, weisen Sie unserer Rolle ein Tag zu und geben Sie ihr einen Namen, z. B. VssSnapshotRole. <br><br>  Dann weisen wir diese Rolle den gewünschten Servern zu. <br><br>  Alles, was ssm jetzt kann, kann diese Server "verwalten". <br><br>  Jetzt müssen wir AWSVssComponents auf den Server stellen.  Wählen Sie dazu den Befehl Ausführen und klicken Sie auf Befehl ausführen. Suchen Sie nach AWS-ConfigureAWSPackage. <br><br>  Wählen Sie in den Befehlsparametern Install, Name - AwsVssComponents, die neueste Version. <br>  In Target wählen wir die Systeme aus, die gesichert werden sollen. <br><br>  Klicken Sie auf RUN. <br><br>  Nach Abschluss können wir ein Backup von der SSM-Konsole erstellen. <br><br>  Wählen Sie den Befehl Ausführen und suchen Sie nach AWSEC2-CreateVssSnapshot.  Wir installieren unsere Server in Target.  Wählen Sie Optionen wie Boot-Volume ausschließen, Nur kopieren und Keine Writer. <br><br>  Klicken Sie auf RUN.  Wir müssen Schnappschüsse erstellen. <br><br>  Erstellen Sie für Sicherungsbenachrichtigungen ein SNS-Thema.  Und abonnieren Sie es.  Ich verwende eine E-Mail-Benachrichtigung. <br><br>  Wir erstellen eine Richtlinie, die das Senden von Nachrichten ermöglicht <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"Version"</span></span>: <span class="hljs-string"><span class="hljs-string">"2012-10-17"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"Statement"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"Sid"</span></span>: <span class="hljs-string"><span class="hljs-string">"VisualEditor0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"Effect"</span></span>: <span class="hljs-string"><span class="hljs-string">"Allow"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"Action"</span></span>: <span class="hljs-string"><span class="hljs-string">"sns:Publish"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"Resource"</span></span>: <span class="hljs-string"><span class="hljs-string">"arn:aws:sns:ap-northeast-1:Account ID:Topic Name"</span></span> } ] }</code> </pre><br>  Und erstellen Sie eine Rolle mit dieser Richtlinie. <br><br>  Um den Prozess zu automatisieren, verwenden wir das SSM-Wartungsfenster. <br><br>  Klicken Sie auf Wartungsfenster erstellen.  Geben Sie den Namen ein und füllen Sie den Zeitplan nach Belieben aus. <br><br>  Wir gehen in das erstellte Wartungsfenster und fügen die Befehlsaufgabe Register RUN hinzu.  Geben Sie die Parameter ein.  In Tag schreibe ich den Typ der Sicherung (TAG Key = SnapshotType, Value =).  Ich habe drei mögliche Parameter: Tag, Woche, Monat und dementsprechend drei Wartungsfenster.  Aktivieren Sie SNS-Benachrichtigungen aktivieren und geben Sie unsere Rolle für Sns und Themen an. <br><br>  Alle Schnappschüsse werden jetzt nach einem Zeitplan erstellt. <br><br>  Und nach einer Weile werden wir zu viele Schnappschüsse haben - sie müssen gereinigt werden.  Zu diesem Zweck verwenden wir einen anderen AWS-Service - Lambda. <br><br>  Erstellen Sie zunächst eine Rolle, die Snapshots lesen und löschen kann. <br><br>  Zu diesem Zweck erstellen wir eine Richtlinie in IAM <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"Version"</span></span>: <span class="hljs-string"><span class="hljs-string">"2012-10-17"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"Statement"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"Sid"</span></span>: <span class="hljs-string"><span class="hljs-string">"VisualEditor0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"Effect"</span></span>: <span class="hljs-string"><span class="hljs-string">"Allow"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"Action"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"logs:DeleteSubscriptionFilter"</span></span>, <span class="hljs-string"><span class="hljs-string">"ec2:DeleteSnapshot"</span></span>, <span class="hljs-string"><span class="hljs-string">"ec2:DescribeSnapshots"</span></span>, <span class="hljs-string"><span class="hljs-string">"logs:DeleteLogStream"</span></span>, <span class="hljs-string"><span class="hljs-string">"logs:CreateExportTask"</span></span>, <span class="hljs-string"><span class="hljs-string">"logs:DeleteResourcePolicy"</span></span>, <span class="hljs-string"><span class="hljs-string">"logs:CreateLogStream"</span></span>, <span class="hljs-string"><span class="hljs-string">"logs:DeleteMetricFilter"</span></span>, <span class="hljs-string"><span class="hljs-string">"logs:TagLogGroup"</span></span>, <span class="hljs-string"><span class="hljs-string">"logs:CancelExportTask"</span></span>, <span class="hljs-string"><span class="hljs-string">"ec2:DescribeVolumes"</span></span>, <span class="hljs-string"><span class="hljs-string">"logs:DeleteRetentionPolicy"</span></span>, <span class="hljs-string"><span class="hljs-string">"logs:DeleteLogDelivery"</span></span>, <span class="hljs-string"><span class="hljs-string">"logs:AssociateKmsKey"</span></span>, <span class="hljs-string"><span class="hljs-string">"logs:PutDestination"</span></span>, <span class="hljs-string"><span class="hljs-string">"logs:DisassociateKmsKey"</span></span>, <span class="hljs-string"><span class="hljs-string">"logs:UntagLogGroup"</span></span>, <span class="hljs-string"><span class="hljs-string">"logs:DeleteLogGroup"</span></span>, <span class="hljs-string"><span class="hljs-string">"logs:PutDestinationPolicy"</span></span>, <span class="hljs-string"><span class="hljs-string">"ec2:DescribeSnapshotAttribute"</span></span>, <span class="hljs-string"><span class="hljs-string">"logs:DeleteDestination"</span></span>, <span class="hljs-string"><span class="hljs-string">"logs:PutLogEvents"</span></span>, <span class="hljs-string"><span class="hljs-string">"logs:CreateLogGroup"</span></span>, <span class="hljs-string"><span class="hljs-string">"logs:PutMetricFilter"</span></span>, <span class="hljs-string"><span class="hljs-string">"logs:CreateLogDelivery"</span></span>, <span class="hljs-string"><span class="hljs-string">"logs:PutResourcePolicy"</span></span>, <span class="hljs-string"><span class="hljs-string">"logs:UpdateLogDelivery"</span></span>, <span class="hljs-string"><span class="hljs-string">"logs:PutSubscriptionFilter"</span></span>, <span class="hljs-string"><span class="hljs-string">"logs:PutRetentionPolicy"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"Resource"</span></span>: <span class="hljs-string"><span class="hljs-string">"*"</span></span> } ] }</code> </pre><br>  Und wir hängen diese Politik an eine neue Rolle. <br><br>  Gehen Sie zu Lambda und erstellen Sie eine neue Python-Funktion. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sys <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> boto3 <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_volume_snapshots</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(client, volume_id, SnapshotType)</span></span></span><span class="hljs-function">:</span></span> args = { <span class="hljs-string"><span class="hljs-string">"Filters"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"Name"</span></span>: <span class="hljs-string"><span class="hljs-string">"volume-id"</span></span>, <span class="hljs-string"><span class="hljs-string">"Values"</span></span>: [volume_id] }, { <span class="hljs-string"><span class="hljs-string">"Name"</span></span>: <span class="hljs-string"><span class="hljs-string">"status"</span></span>, <span class="hljs-string"><span class="hljs-string">"Values"</span></span>: [<span class="hljs-string"><span class="hljs-string">"completed"</span></span>] }, { <span class="hljs-string"><span class="hljs-string">"Name"</span></span>: <span class="hljs-string"><span class="hljs-string">"tag-key"</span></span>, <span class="hljs-string"><span class="hljs-string">"Values"</span></span>: [<span class="hljs-string"><span class="hljs-string">"SnapshotType"</span></span>]}, { <span class="hljs-string"><span class="hljs-string">"Name"</span></span>: <span class="hljs-string"><span class="hljs-string">"tag-value"</span></span>, <span class="hljs-string"><span class="hljs-string">"Values"</span></span>: [SnapshotType]}, ], <span class="hljs-string"><span class="hljs-string">"OwnerIds"</span></span>: [<span class="hljs-string"><span class="hljs-string">"self"</span></span>] } snapshots = [] <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: resp = client.describe_snapshots(**args) snapshots += resp.get(<span class="hljs-string"><span class="hljs-string">"Snapshots"</span></span>, []) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">"NextToken"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> resp: args[<span class="hljs-string"><span class="hljs-string">"NextToken"</span></span>] = resp[<span class="hljs-string"><span class="hljs-string">"NextToken"</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> snapshots <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">delete_snapshot</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(client, snapshot_id)</span></span></span><span class="hljs-function">:</span></span> wait_period = <span class="hljs-number"><span class="hljs-number">5</span></span> retries = <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: client.delete_snapshot(SnapshotId=snapshot_id) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> Exception <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ex: <span class="hljs-comment"><span class="hljs-comment"># As the list of snapshot is eventually consistent old snapshots might appear in listed snapshots if getattr(ex, "response", {}).get("Error", {}).get("Code", "") == "'InvalidSnapshot.NotFound": return False # Throttling might occur when deleting snapshots too fast if "throttling" in ex.message.lower(): retries -= 1 if retries == 0: raise ex time.sleep(wait_period) wait_period = min(wait_period + 10 , 30) continue raise ex def lambda_handler(event, context): retentions = {"Day": 5, "Week": 3, "Month": 2} client = boto3.client("ec2") vols = client.describe_volumes() snapshots_deleted = [] for vol in vols['Volumes']: vol_id = vol['VolumeId'] for SnapshotType, retention_count in retentions.items(): snapshots_for_volume = sorted(get_volume_snapshots(client, vol_id, SnapshotType), key=lambda s: s["StartTime"], reverse=True) snapshots_to_delete = [] if retention_count &gt; 0: snapshots_to_delete = [b["SnapshotId"] for b in snapshots_for_volume[retention_count:]] for snapshot_id in snapshots_to_delete: if delete_snapshot(client, snapshot_id): snapshots_deleted.append(snapshot_id) return { "DeletedSnapshots": snapshots_deleted }</span></span></code> </pre><br>  Wir verwenden die oben erstellte Rolle.  Als Auslöser verwenden wir CloudWatch Event. <br>  Diese Funktion durchläuft alle Volumes, sucht nach allen Volumes von Snapshots, die mit dem SnapshotType-Tag abgeschlossen wurden, und entfernt alle Snapshots, die größer sind als die Aufbewahrung von Snapshots.  Ich habe die letzten 5 täglichen, 3 wöchentlichen und 2 monatlichen Schnappschüsse. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de462601/">https://habr.com/ru/post/de462601/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de462587/index.html">AirTest IDE und Bilderkennung - Automatisierung des Testens von Handyspielen basierend auf Bilderkennung</a></li>
<li><a href="../de462589/index.html">Erstellen Sie eine Pipeline für die Streaming-Datenverarbeitung. Teil 2</a></li>
<li><a href="../de462593/index.html">Auf der anderen Seite des Standes</a></li>
<li><a href="../de462595/index.html">Prüfung und Prüfung von Briefen: Worauf Sie beim Layout achten sollten</a></li>
<li><a href="../de462597/index.html">Typoskript und reagieren</a></li>
<li><a href="../de462605/index.html">Italienische Spur in der Kryptographie</a></li>
<li><a href="../de462607/index.html">Wie ich eine Bibliothek für den Yandex.Music-Dienst geschrieben habe</a></li>
<li><a href="../de462615/index.html">Warum ist es so schwierig zu entscheiden, welchen Film man sich ansieht (und neuronale Netze lösen dieses Problem nicht)?</a></li>
<li><a href="../de462619/index.html">Kinder, Mathe und R.</a></li>
<li><a href="../de462625/index.html">Dell G5 5590: eines der günstigsten Gaming-Laptops mit RTX 2060</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>