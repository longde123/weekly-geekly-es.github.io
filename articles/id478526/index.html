<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü•ó üçø üé´ Banyak OpenVPN di Windows Server dan Mikrotik dengan migrasi barang ini ke Linux üë®üèº‚Äç‚öñÔ∏è üë©‚Äçüë©‚Äçüëß üë©üèΩ‚Äçü§ù‚Äçüë©üèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bagus 

 Setiap perusahaan, cepat atau lambat, tiba-tiba, ia membutuhkan akses jarak jauh. 
 Praktis setiap spesialis IT dihadapkan dengan kebutuhan u...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Banyak OpenVPN di Windows Server dan Mikrotik dengan migrasi barang ini ke Linux</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/478526/"> Bagus <br><br>  Setiap perusahaan, cepat atau lambat, tiba-tiba, ia membutuhkan akses jarak jauh. <br>  Praktis setiap spesialis IT dihadapkan dengan kebutuhan untuk mengatur akses jarak jauh ke jaringan mereka di perusahaan. <br>  Saya, seperti banyak orang, kebutuhan ini ditutup dengan cap "kemarin."  Setelah menganalisis semua pro dan kontra, serta menyekop berton-ton informasi dan menggali sedikit dalam teori, saya memutuskan untuk melanjutkan dengan instalasi. <br><a name="habracut"></a><br>  Untuk alasan keamanan, saya memilih OpenVPN dalam implementasi berikut: mesin virtual diinstal pada server yang menjalankan Windows Server 2012, Windows Server 2012 juga diinstal di dalamnya, dan pada gilirannya, adalah server OpenVPN yang menerbitkan dan menandatangani sertifikat. <br><br>  Untuk kenyamanan, kami akan menyebutnya "server sertifikasi".  Selanjutnya, ia mengambil sertifikat server, mendorongnya ke Mikrotik, dan pada router Mikrotik mengangkat OpenVPN dengan akun, profil.  Saya juga menggunakan server sertifikasi untuk mengeluarkan sertifikat klien. <br><br>  Implementasinya, tentu saja, mengerikan, dan meskipun pada waktu itu pengalaman saya dalam hal-hal seperti itu, katakanlah, tidak cukup, dalam hal keamanan, itu bukan keputusan yang buruk. <br><br>  Bundel ini berfungsi untuk sementara waktu dan saya diberi pengantar baru: mentransfer server sertifikasi ke Linux, sambil mempertahankan koneksi dengan Mikrotik - klien tidak boleh menderita. <br><br>  Pengetahuan saya tentang Linux pada waktu itu berakhir pada Ubuntu 16.04LTS dengan antarmuka grafis yang digunakan sebagai terminal untuk terhubung melalui RDP ke server Windows.  Yaitu, sudo apt-get -f install -y, dan tidak lebih dari satu sentimeter. <br><br>  Setelah mempelajari pertanyaan OS mana dari keluarga Linux yang lebih stabil dan menjanjikan untuk organisasi saya, saya memilih CentOS 7 Minimal. <br><br>  Untuk memulainya, saya memutuskan untuk mempelajari sedikit teori, untuk memahami cara kerjanya dan bekerja secara umum.  Saya menonton tutorial video di saluran <a href="https://www.youtube.com/channel/UCKdRgZWgy42YxoFcTJ30LTA" rel="nofollow">www.youtube.com/channel/UCKdRgZWgy42YxoFcTJ30LTA</a> (Umumnya bukan iklan, mereka hanya membuat saya lebih dulu).  Gadis dengan suara yang menyenangkan memperkenalkan saya pada dasar-dasar bekerja di OS yang dipilih. <br><br>  Untuk memulai, saya meluncurkan Hyper-V di komputer saya, menginstal CentOS 7 Minimal di sana, selama instalasi saya membuat pengguna Admin dan benar-benar menutup ssh untuk root.  Mengucapkan selamat tinggal pada layar multi-warna yang indah, terjun ke dunia terminal hitam dan putih. <br><br>  Saya pikir tidak masuk akal untuk menggambarkan proses instalasi perangkat lunak, lebih baik untuk fokus pada masalah yang muncul selama proses dan untuk memecahkan yang saya harus menulis skrip kecil (itu di bawah kucing. Deskripsi masing-masing utilitas dapat ditemukan di Internet, tetapi pada saat itu ketika saya semua apakah itu, skrip ini belum ada di sana, semuanya dilakukan untuk pertama kalinya, dengan sentuhan dan secara acak). <br><br>  Dalam skrip, saya mencoba mengotomatiskan instalasi utilitas minimum yang diperlukan untuk server, menonaktifkan Selinux, menghubungkan repositori Epel, menginstal OpenVPN, dll. Di bawah ini adalah skrip itu sendiri, itu sederhana, tetapi dapat digunakan.  Saya tidak akan membongkarnya, tetapi jika seseorang membutuhkannya, tulis balasan. <br><br>  Setelah menggunakan skrip, server OpenVPN yang sudah dikonfigurasi akan muncul, mengedipkan mata hijau. <br><br>  UPD: Membuat beberapa penyesuaian pada skrip, menarik kesimpulan dari komentar.  Dia tidak mulai menghapus kesalahannya, tetapi hanya berkomentar sehingga utas komentar tidak akan hilang.  Garis yang ditambahkan didorong kembali untuk visibilitas. <br><br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash cd /etc/sysconfig/ sudo sed -i 's/SELINUX=enforcing/SELINUX=disabled/g' selinux sudo setenforce 0 cd /home/Admin sudo yum update -y sudo yum install epel-release -y sudo yum install mc -y sudo yum install nano -y sudo cp /usr/share/mc/syntax/sh.syntax /usr/share/mc/syntax/unknown.syntax sudo yum install chrony -y sudo systemctl start chronyd sudo systemctl enable chronyd sudo yum install net-tools -y sudo yum install iftop -y sudo yum install htop -y sudo yum install lsof -y sudo yum install dos2unix -y sudo yum install wget -y sudo yum install tcpdump -y sudo yum install openvpn -y wget https://github.com/OpenVPN/easy-rsa/releases/download/v3.0.3/EasyRSA-3.0.3.tgz sudo tar -xvzf EasyRSA-3.0.3.tgz #sudo chown -R Admin:Admin /var/log #sudo chmod 755 /var/log sudo mkdir /var/log/openvpn sudo mkdir /etc/openvpn/ccd sudo chown -R Admin:Admin /etc/openvpn/ccd sudo chown -R Admin:Admin /var/log/openvpn chmod 755 /etc/openvpn/ccd chmod 755 /var/log/openvpn echo &gt;/var/log/openvpn/openvpn-status.log echo &gt;/var/log/openvpn/openvpn.log #sudo chown -R Admin:Admin /etc/resolv.conf sudo chmod 777 /etc/resolv.conf echo nameserver 8.8.8.8 &gt;&gt;/etc/resolv.conf chmod 755 /etc/resolv.conf cd /etc/openvpn/ sudo /home/Admin/EasyRSA-3.0.3/easyrsa init-pki sudo chown -R Admin:Admin /etc/openvpn chmod 755 /etc/openvpn echo set_var EASYRSA_DN "org" &gt;/home/Admin/EasyRSA-3.0.3/test echo set_var EASYRSA_REQ_COUNTRY "RU" &gt;&gt;/home/Admin/EasyRSA-3.0.3/test echo set_var EASYRSA_KEY_SIZE 4096 &gt;&gt;/home/Admin/EasyRSA-3.0.3/test echo set_var EASYRSA_REQ_PROVINCE "LIP" &gt;&gt;/home/Admin/EasyRSA-3.0.3/test echo set_var EASYRSA_REQ_CITY "Lipetsk" &gt;&gt;/home/Admin/EasyRSA-3.0.3/test echo set_var EASYRSA_REQ_ORG "Cool-Admin" &gt;&gt;/home/Admin/EasyRSA-3.0.3/test echo set_var EASYRSA_REQ_EMAIL "xxx.ru" &gt;&gt;/home/Admin/EasyRSA-3.0.3/test echo set_var EASYRSA_REQ_OU "Our_ORG" &gt;&gt;/home/Admin/EasyRSA-3.0.3/test echo set_var EASYRSA_REQ_CN "changeme" &gt;&gt;/home/Admin/EasyRSA-3.0.3/test echo set_var EASYRSA_CERT_EXPIRE 3650 &gt;&gt;/home/Admin/EasyRSA-3.0.3/test echo set_var EASYRSA_DH_KEY_SIZE=2048 &gt;&gt;/home/Admin/EasyRSA-3.0.3/test sudo /home/Admin/EasyRSA-3.0.3/easyrsa build-ca nopass sudo /home/Admin/EasyRSA-3.0.3/easyrsa build-server-full Serv nopass sudo /home/Admin/EasyRSA-3.0.3/easyrsa build-client-full Client1 nopass sudo /home/Admin/EasyRSA-3.0.3/easyrsa --vars=vars gen-dh sudo /home/Admin/EasyRSA-3.0.3/easyrsa --vars=vars gen-crl mkdir keys sudo chown -R Admin:Admin /etc/openvpn/keys chmod 755 /etc/openvpn/keys sudo cp /etc/openvpn/pki/ca.crt /etc/openvpn/keys sudo cp /etc/openvpn/pki/dh.pem /etc/openvpn/keys sudo cp /etc/openvpn/pki/crl.pem /etc/openvpn/keys sudo cp /etc/openvpn/pki/issued/Serv.crt /etc/openvpn/keys sudo cp /etc/openvpn/pki/private/Serv.key /etc/openvpn/keys echo port 443 &gt;/etc/openvpn/server.conf echo proto udp &gt;&gt;/etc/openvpn/server.conf echo dev tun &gt;&gt;/etc/openvpn/server.conf echo ca /etc/openvpn/keys/ca.crt &gt;&gt;/etc/openvpn/server.conf echo cert /etc/openvpn/keys/Serv.crt &gt;&gt;/etc/openvpn/server.conf echo key /etc/openvpn/keys/Serv.key &gt;&gt;/etc/openvpn/server.conf echo dh /etc/openvpn/keys/dh.pem &gt;&gt;/etc/openvpn/server.conf echo crl-verify /etc/openvpn/keys/crl.pem &gt;&gt;/etc/openvpn/server.conf echo client-config-dir /etc/openvpn/ccd &gt;&gt;/etc/openvpn/server.conf echo topology subnet &gt;&gt;/etc/openvpn/server.conf echo server 172.21.0.0 255.255.255.0 &gt;&gt;/etc/openvpn/server.conf echo route 172.21.0.0 255.255.255.0 &gt;&gt;/etc/openvpn/server.conf echo push \"dhcp-option DNS 8.8.8.8\" &gt;&gt;/etc/openvpn/server.conf echo push \"dhcp-option DNS 8.8.4.4\" &gt;&gt;/etc/openvpn/server.conf echo keepalive 10 120 &gt;&gt;/etc/openvpn/server.conf echo persist-key &gt;&gt;/etc/openvpn/server.conf echo persist-tun &gt;&gt;/etc/openvpn/server.conf echo status /var/log/openvpn/openvpn-status.log &gt;&gt;/etc/openvpn/server.conf echo log-append /var/log/openvpn/openvpn.log &gt;&gt;/etc/openvpn/server.conf echo verb 2 &gt;&gt;/etc/openvpn/server.conf echo mute 20 &gt;&gt;/etc/openvpn/server.conf echo daemon &gt;&gt;/etc/openvpn/server.conf echo mode server &gt;&gt;/etc/openvpn/server.conf echo user nobody &gt;&gt;/etc/openvpn/server.conf echo group nobody &gt;&gt;/etc/openvpn/server.conf #sudo chown -R Admin:Admin /etc/sysctl.conf chmod 777 /etc/sysctl.conf echo net.ipv4.ip_forward=1 &gt;&gt;/etc/sysctl.conf chmod 755 /etc/sysctl.conf sudo sysctl -p /etc/sysctl.conf sudo systemctl enable openvpn@server sudo systemctl start openvpn@server sudo systemctl status openvpn@server</span></span></code> </pre> <br>  Menginstal OpenVPN tidak sepenuhnya berhasil. <br><br>  Tidak tahu tentang fitur-fitur kebijakan hak pada sistem Linux, saya menghabiskan banyak waktu mempelajari log dan memberikan semua file hak yang diperlukan. <br><br>  Ketika tombol OpenVPN berubah menjadi hijau, saya sangat senang, tetapi ternyata, ini hanya permulaan.  Demi kesederhanaan, saya berharap untuk mengganti sertifikat root dan file crl.pem, berharap semuanya bekerja.  Akibatnya, saya perlu mentransfer file berikut dari server ke Windows: <br><br>  Serv.crt - Sertifikat Server <br>  Serv.key - Server Key <br>  Ca.crt - Root Certificate <br>  Ca.key - Root Key <br>  Crl.pem - File Pencabutan Sertifikat <br>  Dh.pem - Kunci Diffie-Hellman <br>  Index.txt - File dengan informasi tentang sertifikat saat ini <br>  Serial - itu juga bertanggung jawab untuk relevansi sertifikat <br><br>  Itu juga memerlukan folder certs_by_serial, file vars, dan semua kunci dan sertifikat klien. <br>  Di Mikrotik, sertifikat tetap di tempatnya, jadi berhasil. <br><br>  Masalah muncul ketika saya mencoba untuk mencabut sertifikat, itu sama sekali tidak bekerja dari kata - file index.txt perlu dikonversi ke format unix, tetapi saya tidak segera melakukannya.  Menggunakan utilitas dos2unix. <br><br>  Sekarang sertifikat dicabut, tetapi terus bekerja tanpa masalah, karena Mikrotik tidak tahu bahwa itu dicabut dan dia perlu entah bagaimana menginformasikannya. <br><br>  Setelah membaca instruksi, serta berkonsultasi dengan Alexander ERI (terima kasih banyak!), Saya mengambil server http Apache sederhana di server sertifikasi dan menerbitkan file sertifikat yang dicabut di atasnya.  Akses tertutup sepenuhnya untuk itu, kecuali untuk file yang diterbitkan dari satu ip. <br><br>  Di terminal Mikrotik, di tab / System / Certificates / CRL, ditunjukkan jalur ke crl.pem yang diterbitkan.  Di sini harus diklarifikasi bahwa Mikrotik hanya menerima http dan alamat absolut untuk tab CRL, mis.  Seharusnya terlihat seperti ini: <a href="" rel="nofollow">127.0.0.1/crl/1.crl</a> <br>  Semuanya berfungsi, setidaknya untuk versi 6.4.2.x dari RouterOS, tetapi saya harus membuat konfigurasi klien dengan tangan saya, dan ini sangat disayangkan bagi saya dan menyebabkan banyak ketidaknyamanan.  Ketika dalam seminggu saya perlu membuat konfigurasi untuk sekitar 50 klien, saya memutuskan untuk mempercepat proses ini dan untuk ini saya menggunakan sepotong skrip orang lain yang ditemukan di Internet. <br><br>  Scriptnya bekerja seperti ini: setelah diluncurkan, tentukan "nama klien", jawab pertanyaan "setel kata sandi atau tidak", setelah itu kita ambil file konfigurasi "client.ovpn" yang sudah jadi, dengan sertifikat dan pengaturan yang diintegrasikan ke dalamnya.  Untuk menggunakannya, Anda harus memiliki / etc / openvpn.  Saya akan menandatangani garis komenty di mana jalan harus diganti dengan Anda sendiri.  Anda juga perlu membuat file dengan pengaturan klien sehingga skrip menggantikannya dalam proses membuat konfigurasi. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash function newClient () { echo "" echo "Tell me a name for the client." echo "Use one word only, no special characters." until [[ "$CLIENT" =~ ^[a-zA-Z0-9_]+$ ]]; do read -rp "Client name: " -e CLIENT done echo "" echo "Do you want to protect the configuration file with a password?" echo "(eg encrypt the private key with a password)" echo " 1) Add a passwordless client" echo " 2) Use a password for the client" until [[ "$PASS" =~ ^[1-2]$ ]]; do read -rp "Select an option [1-2]: " -e -i 1 PASS done #cd /etc/openvpn/easy-rsa/ || return case $PASS in 1) sudo /home/admin/EasyRSA-3.0.3/easyrsa build-client-full "$CLIENT" nopass ;; 2) echo "You will be asked for the client password below" ./easyrsa build-client-full "$CLIENT" ;; esac # Generates the custom client.ovpn cp /etc/openvpn/client-template.txt "$home/home/admin/IT/Temp/$CLIENT.ovpn" #       . #,      { echo "&lt;ca&gt;" cat "/etc/openvpn/pki/ca.crt" #    echo "&lt;/ca&gt;" echo "&lt;cert&gt;" awk '/BEGIN/,/END/' "/etc/openvpn/pki/issued/$CLIENT.crt" #   #  echo "&lt;/cert&gt;" echo "&lt;key&gt;" cat "/etc/openvpn/pki/private/$CLIENT.key" #     echo "&lt;/key&gt;" } &gt;&gt; "$home/home/admin/IT/Temp/$CLIENT.ovpn" #,     # echo "" echo "Client $CLIENT added, the configuration file is available at $home/admin/IT/OVPN/Temp/$CLIENT.ovpn." echo "Download the .ovpn file and import it in your OpenVPN client." exit 0; } newClient</span></span></code> </pre><br>  Setelah beberapa saat, larangan pengantar baru pada akses jarak jauh terpaksa membunuh server ini dan bundel yang berfungsi dengan Mikrotik.  Server OpenVPN baru dibuat untuk departemen TI, yang sekarang berfungsi sepenuhnya di CentOS.  Tetapi ini adalah kisah yang sangat berbeda. <br><br>  Saya mengucapkan terima kasih kepada Ivan dan Pavel atas bantuan mereka dalam mengedit artikel. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id478526/">https://habr.com/ru/post/id478526/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id478510/index.html">Kami mengundang Anda ke DINS QA EVENING 12/12/19: kami membuat Jenkins Pipeline dan belajar cara memparalelkan peluncuran tes dengan bantuan mereka</a></li>
<li><a href="../id478514/index.html">Menggunakan data terenkripsi untuk pembelajaran mesin tanpa mendekripsi</a></li>
<li><a href="../id478516/index.html">Jalan prosedural di Houdini dan Unity</a></li>
<li><a href="../id478518/index.html">Pengalaman menggunakan infrastruktur kantor di Zextras / Zimbra OSE</a></li>
<li><a href="../id478522/index.html">Akui saja, Watson, apakah Anda benar-benar bingung?</a></li>
<li><a href="../id478528/index.html">Kesayangan (kisah fantastis)</a></li>
<li><a href="../id478530/index.html">TechnoText-2019: siapa yang menang pada akhirnya dan untuk apa mereka</a></li>
<li><a href="../id478532/index.html">Bagaimana Apple Earnes: 5 Area Bisnis Paling Menguntungkan di Perusahaan</a></li>
<li><a href="../id478534/index.html">DevFest Siberia 2019: melihat tren dari pedalaman</a></li>
<li><a href="../id478536/index.html">WebRTC melalui Kurento: Pengalaman Pengujian dan Implementasi</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>