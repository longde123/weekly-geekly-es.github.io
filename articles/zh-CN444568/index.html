<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>😖 🔂 👨‍🔬 2018年发现的C ++项目的十大bug 🚴 👨🏿‍🚀 🤞🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="自2018年结束以来已经过去了三个月。 对于许多人来说，这只是飞逝，但是对于我们PVS-Studio开发人员而言，这是相当重要的一年。 我们正在竭尽全力，无所畏惧地竞相传播有关静态分析的信息，并在寻找使用C，C ++，C＃和Java语言编写的开源项目中的错误。 在本文中，我们为您收集了其中最有趣的前...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>2018年发现的C ++项目的十大bug</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/444568/"> 自2018年结束以来已经过去了三个月。 对于许多人来说，这只是飞逝，但是对于我们PVS-Studio开发人员而言，这是相当重要的一年。 我们正在竭尽全力，无所畏惧地竞相传播有关静态分析的信息，并在寻找使用C，C ++，C＃和Java语言编写的开源项目中的错误。 在本文中，我们为您收集了其中最有趣的前十名！ <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f7b/72a/054/f7b72a054c744397f8c8c1830253ae2a.png"></div><a name="habracut"></a><br> 为了找到最有趣的地方，我们使用了<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">PVS-Studio</a>静态代码分析器。 它可以检测用上面列出的语言编写的代码中的错误和潜在漏洞。 <br><br> 如果您对自己寻找错误感到很兴奋，欢迎随时下载并尝试使用我们的分析仪。 我们为学生和热情的开发人员提供了<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">免费的分析器版本，</a>为开源项目的开发人员提供了<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">免费的许可证</a> ，还为全世界和他的狗提供了<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">试用版</a> 。 谁知道，也许到明年您将能够创建自己的前十名？  :) <br><br>  <b>注意：</b>我邀请您进行检查，并在查看分析仪警告之前，尝试自己发现缺陷。 您将发现多少个错误？ <br><br><h2> 第十名 </h2><br> 来源： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">再次进入太空：独角兽如何拜访恒星</a> <br><br> 在检查名为Stellarium的虚拟天象仪时检测到此错误。 <br><br> 上面的代码片段虽然很小，但充满了一个非常棘手的错误： <br><br><pre><code class="cpp hljs">Plane::Plane(Vec3f &amp;v1, Vec3f &amp;v2, Vec3f &amp;v3) : distance(<span class="hljs-number"><span class="hljs-number">0.0f</span></span>), sDistance(<span class="hljs-number"><span class="hljs-number">0.0f</span></span>) { Plane(v1, v2, v3, SPolygon::CCW); }</code> </pre> <br> 找到了吗？ <br><br>  <b>PVS-Studio警告</b> ： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">V603</a>已创建对象，但未使用该对象。 如果要调用构造函数，则应使用“ this-&gt; Plane :: Plane（....）”。 平面cpp 29 <br><br> 代码作者打算使用嵌套在主对象中的另一个构造函数来初始化某些对象的字段。 嗯，与其相反，他只是设法创建了一个在离开其作用域时销毁的临时对象。 这样，几个对象的字段将保持未初始化。 <br><br> 作者应该使用在C ++ 11中引入的委托构造函数，而不是嵌套的构造函数调用。 例如，他本可以这样写： <br><br><pre> <code class="cpp hljs">Plane::Plane(Vec3f&amp; v1, Vec3f&amp; v2, Vec3f&amp; v3) : Plane(v1, v2, v3, SPolygon::CCW) { distance = <span class="hljs-number"><span class="hljs-number">0.0f</span></span>; sDistance = <span class="hljs-number"><span class="hljs-number">0.0f</span></span>; }</code> </pre> <br> 这样，所有必要的字段都将被正确初始化。 这不是很好吗？ <br><br><h2> 第九名 </h2><br> 来源： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Perl 5：如何在宏中隐藏错误</a> <br><br> 第九位是一个非常出色的宏，它的所有美都引人注目。 <br><br> 在收集撰写文章的错误时，我的同事Svyatoslav遇到了由分析器发出的与宏用法有关的警告。 这是： <br><br><pre> <code class="cpp hljs">PP(pp_match) { .... MgBYTEPOS_set(mg, TARG, truebase, RXp_OFFS(prog)[<span class="hljs-number"><span class="hljs-number">0</span></span>].end); .... }</code> </pre> <br> 为了找出问题所在，Svyatoslav进行了更深入的挖掘。 他打开了宏定义，发现其中包含多个嵌套宏，其中一些反过来又具有嵌套宏。 很难理解这一点，因此他必须使用预处理的文件。 可悲的是，它没有帮助。 这是Svyatoslav在上一行代码中找到的： <br><br><pre> <code class="cpp hljs">(((targ)-&gt;sv_flags &amp; <span class="hljs-number"><span class="hljs-number">0x00000400</span></span>) &amp;&amp; (!((targ)-&gt;sv_flags &amp; <span class="hljs-number"><span class="hljs-number">0x00200000</span></span>) || S_sv_only_taint_gmagic(targ)) ? (mg)-&gt;mg_len = ((prog-&gt;offs)[<span class="hljs-number"><span class="hljs-number">0</span></span>].end), (mg)-&gt;mg_flags |= <span class="hljs-number"><span class="hljs-number">0x40</span></span> : ((mg)-&gt;mg_len = (((targ)-&gt;sv_flags &amp; <span class="hljs-number"><span class="hljs-number">0x20000000</span></span>) &amp;&amp; !__builtin_expect(((((PL_curcop)-&gt;cop_hints + <span class="hljs-number"><span class="hljs-number">0</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0x00000008</span></span>) ? (<span class="hljs-keyword"><span class="hljs-keyword">_Bool</span></span>)<span class="hljs-number"><span class="hljs-number">1</span></span> :(<span class="hljs-keyword"><span class="hljs-keyword">_Bool</span></span>)<span class="hljs-number"><span class="hljs-number">0</span></span>),(<span class="hljs-number"><span class="hljs-number">0</span></span>))) ? (<span class="hljs-keyword"><span class="hljs-keyword">ssize_t</span></span>)Perl_utf8_length( (U8 *)(truebase), (U8 *)(truebase)+((prog-&gt;offs)[<span class="hljs-number"><span class="hljs-number">0</span></span>].end)) : (<span class="hljs-keyword"><span class="hljs-keyword">ssize_t</span></span>)((prog-&gt;offs)[<span class="hljs-number"><span class="hljs-number">0</span></span>].end), (mg)-&gt;mg_flags &amp;= ~<span class="hljs-number"><span class="hljs-number">0x40</span></span>));</code> </pre> <br>  <b>PVS-Studio警告</b> ： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">V502</a>也许“？：”操作员的工作方式与预期的不同。  '？：'运算符的优先级低于'&amp;&amp;'运算符。  pp_hot.c 3036 <br><br> 我认为，仅注意到这样的错误将具有挑战性。 我们一直在研究此代码很长一段时间，但是坦率地说，我们没有发现任何错误。 无论如何，这是一个可读性很差的有趣示例。 <br><br> 他们说宏是邪恶的。 当然，在某些情况下，宏是必不可少的，但是如果您可以将宏替换为函数，则一定要这样做。 <br><br> 嵌套宏尤其充满陷阱。 不仅因为很难理解它们，还因为它们会产生不可预测的结果。 如果程序员在这样的宏中犯了一个错误-在宏中找到它比在函数中发现要困难得多。 <br><br><h2> 第八名 </h2><br> 资料来源： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">铬：其他错误</a> <br><br> 下一个示例来自有关Chromium项目分析的系列文章。 该错误隐藏在WebRTC库中。 <br><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;SdpVideoFormat&gt; StereoDecoderFactory::GetSupportedFormats() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;SdpVideoFormat&gt; formats = ....; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span>&amp; format : formats) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cricket::CodecNamesEq(....)) { .... formats.push_back(stereo_format); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> formats; }</code> </pre> <br>  <b>PVS-Studio警告：</b>在基于范围的for循环中使用的“格式”容器的<b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">V789</a></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">CWE-672</a>迭代器在调用“ push_back”函数时变得无效。  stereocodecfactory.cc 89 <br><br> 错误是<i>格式</i>向量的大小在基于范围的for循环内变化。 基于范围的循环基于迭代器，这就是为什么在此类循环中更改容器大小可能导致这些迭代器无效的原因。 <br><br> 如果使用显式使用迭代器重写循环，则该错误仍然存​​在。 为了清楚起见，我可以引用以下代码： <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> format = begin(formats), __end = end(formats); format != __end; ++format) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cricket::CodecNamesEq(....)) { .... formats.push_back(stereo_format); } }</code> </pre> <br> 例如，当使用<i>push_back</i>方法时，可能会发生向量重新分配-这样，迭代器将寻址无效的内存位置。 <br><br> 为避免此类错误，请遵循以下规则：切勿在绑定了此容器条件的循环内更改容器大小。 它还涉及基于范围的循环和使用迭代器的循环。 欢迎您阅读有关StackOverflow的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">讨论</a> ，该<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">讨论</a>涵盖导致迭代器无效的操作主题。 <br><br><h2> 第七名 </h2><br> 来源： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Godot：关于静态分析仪的常规使用</a> <br><br> 来自游戏行业的第一个示例将是我们在Godot游戏引擎中找到的代码段。 可能需要一些工作才能注意到该错误，但是我敢肯定，我们精通的读者将对此进行应对。 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> AnimationNodeBlendSpace1D::add_blend_point( <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Ref&lt;AnimationRootNode&gt; &amp;p_node, <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> p_position, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> p_at_index) { ERR_FAIL_COND(blend_points_used &gt;= MAX_BLEND_POINTS); ERR_FAIL_COND(p_node.is_null()); ERR_FAIL_COND(p_at_index &lt; <span class="hljs-number"><span class="hljs-number">-1</span></span> || p_at_index &gt; blend_points_used); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (p_at_index == <span class="hljs-number"><span class="hljs-number">-1</span></span> || p_at_index == blend_points_used) { p_at_index = blend_points_used; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = blend_points_used - <span class="hljs-number"><span class="hljs-number">1</span></span>; i &gt; p_at_index; i++) { blend_points[i] = blend_points[i - <span class="hljs-number"><span class="hljs-number">1</span></span>]; } } .... }</code> </pre> <br>  <b>PVS-Studio警告： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">V621</a></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">CWE-835</a>考虑检查“ for”操作员。 循环有可能执行不正确或根本不执行。  animation_blend_space_1d.cpp 113 <br><br> 让我们仔细看看循环条件。 计数器变量由<i>blend_points_used-1</i>值初始化。 此外，从之前的两次检查（在<i>ERR_FAIL_COND</i>和<i>if中</i> ） <i>来看</i> ，很明显，到<i>blend_points_used</i>循环执行时， <i>blend_points_used</i>将始终大于<i>p_at_index</i> 。 因此，要么循环条件始终为真，要么根本不执行循环。 <br><br> 如果<i>blend_points_used-1 == p_at_index</i> ，则循环不会执行。 <br><br> 在所有其他情况下，检查<i>i&gt; p_at_index</i>始终为true，因为每次循环迭代时<i>i</i>计数器都会增加。 <br><br> 循环似乎是永恒的，但事实并非如此。 <br><br> 首先，将发生<i>i</i>变量的整数溢出（这是未定义的行为）。 这意味着，我们不应该依赖它。 <br><br> 如果<i>i</i>是<i>unsigned int</i> ，则在计数器达到最大可能值之后，运算符<i>i ++</i>会将其变为<i>0</i> 。 这种行为由标准定义，称为“无符号包装”。 但是，您应该意识到使用这种机制<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">也不是一个好主意</a> 。 <br><br> 这是第一点，但我们还有第二点！ 情况是，我们甚至都不会达到整数溢出。 数组索引将更早地超出范围。 这意味着将尝试访问为该阵列分配的块之外的内存。 这也是未定义的行为。 一个经典的例子:) <br><br> 我可以给您一些建议，以更容易避免类似的错误： <br><br><ol><li> 编写简单易懂的代码 </li><li> 彻底检查代码并为新编写的代码编写更多测试 </li><li> 使用静态分析仪；） </li></ol><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e24/4d8/f8b/e244d8f8b0062e5c822e3630b50b26bc.png"></div><br><br><h2> 第六名 </h2><br> 资料来源： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">亚马逊伐木场：痛苦的尖叫</a> <br><br> 这是游戏开发行业的另一个示例，即Amazon Lumberyard AAA引擎的源代码。 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TranslateVariableNameByOperandType</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// Igor: yet another Qualcomm's special case // GLSL compiler thinks that -2147483648 is // an integer overflow which is not if (*((int*)(&amp;psOperand-&gt;afImmediates[0])) == 2147483648) { bformata(glsl, "-2147483647-1"); } else { // Igor: this is expected to fix // paranoid compiler checks such as Qualcomm's if (*((unsigned int*)(&amp;psOperand-&gt;afImmediates[0])) &gt;= 2147483648) { bformata(glsl, "%d", *((int*)(&amp;psOperand-&gt;afImmediates[0]))); } else { bformata(glsl, "%d", *((int*)(&amp;psOperand-&gt;afImmediates[0]))); } } bcatcstr(glsl, ")"); .... }</span></span></code> </pre> <br>  <b>PVS-Studio警告</b> ： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">V523'then</a> '语句等效于'else'语句。  toglsloperand.c 700 <br><br>  Amazon Lumberyard被开发为跨平台引擎。 因此，开发人员尝试支持尽可能多的编译器。 从评论中可以看出，程序员Igor反对Qualcomm编译器。 <br><br> 我们不知道他是否能够执行任务并通过“偏执”编译器检查涉水，但是他留下了非常奇怪的代码。 奇怪的是， <i>if</i>语句的<i>then-</i>和<i>else-</i>分支都包含绝对相同的代码。 这种错误很可能是由于使用草率的复制粘贴方法导致的。 <br><br> 我什至不知道该怎么建议。 因此，我只希望Amazon Lumberyard开发人员在修复错误方面一切顺利，并为开发人员Igor带来好运！ <br><br><h2> 第五名 </h2><br> 资料来源： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">再次证明，PVS-Studio分析仪比人更专心</a> <br><br> 下一个示例发生了一个有趣的故事。 我的同事Andrey Karpov正在准备有关Qt框架的另一项检查的文章。 在写出一些明显的错误时，他偶然发现了分析仪警告，认为这是错误的。 这是该代码片段及其警告： <br><br><pre> <code class="cpp hljs">QWindowsCursor::CursorState QWindowsCursor::cursorState() { <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> { cursorShowing = <span class="hljs-number"><span class="hljs-number">0x1</span></span>, cursorSuppressed = <span class="hljs-number"><span class="hljs-number">0x2</span></span> }; CURSORINFO cursorInfo; cursorInfo.cbSize = <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(CURSORINFO); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (GetCursorInfo(&amp;cursorInfo)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cursorInfo.flags &amp; CursorShowing) <span class="hljs-comment"><span class="hljs-comment">// &lt;= V616 .... }</span></span></code> </pre> <br>  <b>PVS-Studio警告： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">V616</a></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">CWE-480</a>按位操作中使用名为“ CursorShowing”的常量，其值为0。  qwindowscursor.cpp 669 <br><br> 这意味着，PVS-Studio在该地方抱怨，这显然没有错误！  <i>CursorShowing</i>常量不可能为<i>0</i> ，因为它上面的几行由<i>1</i>初始化。 <br><br> 由于Andrey使用的分析仪版本不稳定，因此他对警告的正确性提出了质疑。 他仔细查看了这段代码，但仍然没有发现错误。 最终，他在bugtracker中给了它一个误报，以便其他同事可以纠正这种情况。 <br><br> 只有详细的分析表明，PVS-Studio再次比一个人更小心。 将<i>0x1</i>值分配给名为<i>cursorShowing</i>的命名常量，而<i>CursorShowing</i>参与按位“与”运算。 这是两个完全不同的常数，第一个以小写字母开头，第二个以大写字母开头。 <br><br> 代码成功编译，因为类<i>QWindowsCursor</i>确实包含具有此名称的常量。 这是它的定义： <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">QWindowsCursor</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> QPlatformCursor { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> CursorState { CursorShowing, CursorHidden, CursorSuppressed }; .... }</code> </pre> <br> 如果您没有为枚举常量明确分配值，则默认情况下将对其进行初始化。 由于<i>CursorShowing</i>是枚举中的第一个元素，因此将其分配为<i>0</i> 。 <br><br> 为避免此类错误，您不应给实体命名太相似的名称。 如果实体属于同一类型或可以彼此隐式转换，则应特别遵循此规则。 在这种情况下，几乎不可能注意到该错误，但是不正确的代码仍将被编译并存在于项目内部。 <br><br><h2> 第四名 </h2><br> 资料来源： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">处理输入数据时，请小心翼翼</a> <br><br> 我们越来越接近前三名决赛选手，而下一个是FreeSWITCH项目的错误。 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">char</span></span></span><span class="hljs-function"> *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">basic_gets</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *cnt)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> c = getchar(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fgets(command_buf, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(command_buf) - <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">stdin</span></span>) != command_buf) { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } command_buf[<span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>(command_buf)<span class="hljs-number"><span class="hljs-number">-1</span></span>] = <span class="hljs-string"><span class="hljs-string">'\0'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* remove endline */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } .... }</code> </pre> <br>  <b>PVS-Studio警告： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">V1010</a></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">CWE-20</a>索引：“ strlen（command_buf）”中使用了未经检查的污染数据。 <br><br> 分析器警告您在<i>strlen（command_buf）-1</i>表达式中使用了一些未经检查的数据。 确实：如果用C语言来讲<i>command_buf</i>是一个空字符串（仅包含字符'\ 0'），则<i>strlen（command_buf）</i>将返回<i>0</i> 。 在这种情况下，将访问<i>command_buf [-1]</i> ，这是未定义的行为。 不好 <br><br> 对该错误的实际热情不是<b>为什么</b>发生，而是<b>如何</b>发生。 此错误是您自己“触摸”的最出色的示例之一。 您可以运行FreeSwitch，执行一些操作，这些操作将导致上述代码片段的执行，并将空字符串传递给程序的输入。 <br><br> 结果，随着手的微妙运动，工作程序变成无效！ 您可以通过上述链接在源文章中找到有关如何重现此错误的详细信息。 同时，让我为您提供一个令人欣慰的结果： <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/jSYJirPIK8E" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br> 请记住，输出数据可以是任何数据，因此您应该始终检查它。 这样，分析仪将不会抱怨，程序将变得更加可靠。 <br><br> 现在是时候为我们的获胜者而战：我们现在已经进入残局了！ 顺便说一句，臭虫决赛选手已经等了很长时间，然后感到无聊，甚至开始变得笨拙。 看看他们在我们外出时的演出吧！ <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2c7/d5f/39e/2c7d5f39edfa5e07639ef95520889b09.png"></div><br><br><h2> 第三名 </h2><br> 资料来源： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">NCBI基因组工作台：受威胁的科学研究</a> <br><br> 来自NCBI Genome Workbench项目的代码段（这是用于研究和分析基因数据的一组工具）使前3名获奖者获奖。 即使您不必是转基因的超人也可以找到此bug，但很少有人知道在这里犯错误的可能性。 <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Crypt a given password using schema required for NTLMv1 authentication * @param passwd clear text domain password * @param challenge challenge data given by server * @param flags NTLM flags from server side * @param answer buffer where to store crypted password */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tds_answer_challenge</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ntlm_v == <span class="hljs-number"><span class="hljs-number">1</span></span>) { .... <span class="hljs-comment"><span class="hljs-comment">/* with security is best be pedantic */</span></span> <span class="hljs-built_in"><span class="hljs-built_in">memset</span></span>(hash, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(hash)); <span class="hljs-built_in"><span class="hljs-built_in">memset</span></span>(passwd_buf, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(passwd_buf)); ... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { .... } }</code> </pre> <br>  <b>PVS-Studio警告：</b> <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">V597</a>编译器可以删除“ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">内存集</a> ”函数调用，该函数调用用于刷新“哈希”缓冲区。  memset_s（）函数应用于擦除私有数据。  Challenge.c 365 </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">V597</a>编译器可以删除“ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">内存集</a> ”函数调用，该函数调用用于刷新“ passwd_buf”缓冲区。  memset_s（）函数应用于擦除私有数据。 第366章 </li></ul><br> 您找到错误了吗？ 如果是，则您是一个attaboy！..或转基因的超人。 <br><br> 事实是，现代的优化编译器能够做很多事情，以使构建的程序更快地运行。 包括编译器现在可以跟踪传递给<i>memset</i>的缓冲区的事实。 <br><br> 在这种情况下，他们可以删除对<i>memset</i>的“不必要的”调用，并拥有所有权利。 然后，存储重要数据的缓冲区可能会保留在内存中，使攻击者感到高兴。 <br><br> 在这种背景下，这种极客评论“安全最好是书呆子”听起来更有趣。 从针对该项目的少量警告来看，其开发人员会尽力做到精确并编写安全的代码。 但是，正如我们所看到的，人们可以轻易地忽略这种安全缺陷。 根据常见弱点枚举，此缺陷归类为<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">CWE-14</a> ：清除代码以清除缓冲区的编译器。 <br><br> 您应该使用<i>memset_s（）</i>函数，以便安全地进行内存释放。 该函数比<i>memset（）</i>更安全，并且不能被编译器忽略。 <br><br><h2> 第二名 </h2><br> 资料来源： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">PVS-Studio被证明比三个半程序员更具吸引力</a> <br><br> 我们的一位客户将银牌得主送给了我们。 他确信分析仪会发出一些误报。 <br><br> 叶夫根尼（Evgeniy）收到了这封电子邮件，仔细检查后将其发送给Svyatoslav。  Svyatoslav仔细查看了客户发送的那段代码，心想：“分析仪怎么可能犯了这样的错误？”。 于是他去找安德烈咨询。 他还检查了该位置并确定：实际上，分析仪产生了误报。 <br><br> 因此，需要修复。 仅在Svyatoslav开始制作综合示例以在我们的错误跟踪器中创建任务之后，他才发现了问题所在。 <br><br> 没有一个程序员可以找到这些错误，但是它们确实在代码中。 坦白地说，尽管分析仪清楚地为错误的地方发出警告，但本文的作者也没有找到它们！ <br><br> 您会发现这种狡猾的虫子吗？ 测试自己的警惕性和专心程度。 <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/002/b12/75b/002b1275be55e7c96131de9f44d02ef7.png"></div><br>  <b>PVS-Studio警告：</b> <ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">V560</a>条件表达式的一部分始终为false：（ch&gt; = 0x0FF21）。 解码w.cpp 525 </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">V560</a>条件表达式的一部分始终为true：（ch &lt;= 0x0FF3A）。 解码w.cpp 525 </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">V560</a>条件表达式的一部分始终为false：（ch&gt; = 0x0FF41）。 解码w.cpp 525 </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">V560</a>条件表达式的一部分始终为true：（ch &lt;= 0x0FF5A）。 解码w.cpp 525 </li></ul><br> 如果您做到了-恭喜您！ <br><br> 错误在于以下事实：逻辑否定运算符（！）不适用于整个条件，而仅适用于其第一个子表达式： <br><br><pre> <code class="cpp hljs">!((ch &gt;= <span class="hljs-number"><span class="hljs-number">0x0FF10</span></span>) &amp;&amp; (ch &lt;= <span class="hljs-number"><span class="hljs-number">0x0FF19</span></span>))</code> </pre> <br> 如果满足此条件，则<i>ch</i>变量值将位于[0x0FF10 ... 0x0FF19]范围内。 因此，四个进一步的比较已经毫无意义：它们将始终是对还是错。 <br><br> 为避免此类错误，值得遵循一些规则。 首先，将代码像表一样对齐是非常方便和有益的。 其次，您不应该在表达式上加上括号。 例如，此代码可以这样重写： <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> isLetterOrDigit = (ch &gt;= <span class="hljs-number"><span class="hljs-number">0x0FF10</span></span> &amp;&amp; ch &lt;= <span class="hljs-number"><span class="hljs-number">0x0FF19</span></span>) <span class="hljs-comment"><span class="hljs-comment">// 0..9 || (ch &gt;= 0x0FF21 &amp;&amp; ch &lt;= 0x0FF3A) // A..Z || (ch &gt;= 0x0FF41 &amp;&amp; ch &lt;= 0x0FF5A); // a..z if (!isLetterOrDigit)</span></span></code> </pre> <br> 这样，括号将更少，而另一方面-您更有可能注意到偶然的错误。 <br><br> 樱桃就在这里-让我们继续前进吧！ <br><br><h2> 第一名 </h2><br> 来源： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Shocked System：传奇系统Shock的源代码中有趣的错误</a> <br><br> 今天的决赛入围者是传奇的System Shock的错误！ 它是1994年发行的很久以前的游戏，它成为诸如Dead Space，BioShock和Deus Ex等标志性游戏的前身和灵感。 <br><br> 但是首先，我要承认一些事情。 我现在要向您展示的内容不包含任何错误。 实际上，它甚至都不是一段代码，但是我忍不住与您共享它！ <br><br> 问题是，在分析游戏的源代码时，我的同事Victoria发现了很多有趣的评论。 在不同的片段中，她发现了一些机智和讽刺的话，甚至是诗歌。 <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// I'll give you fish, I'll give you candy, // I'll give you, everything I have in my hand // that kid from the wrong side came over my house again, // decapitated all my dolls // and if you bore me, you lose your soul to me // - "Gepetto", Belly, _Star_ // And here, ladies and gentlemen, // is a celebration of C and C++ and their untamed passion... // ================== TerrainData terrain_info; // Now the actual stuff... // ======================= // this is all outrageously horrible, as we dont know what // we really need to deal with here // And if you thought the hack for papers was bad, // wait until you see the one for datas... - X // Returns whether or not in the humble opinion of the // sound system, the sample should be politely obliterated // out of existence // it's a wonderful world, with a lot of strange men // who are standing around, and they all wearing towels</span></span></code> </pre><br> 这就是最近90年代开发人员在游戏中留下的评论的样子……顺便说一下，System Shock的首席设计师Doug Church也在忙于编写代码。 谁知道，也许其中一些评论是他写的？ 希望，毛巾上的东西不是他的手工:) <br><br><h2> 结论 </h2><br> 最后，我要感谢<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">我的同事</a>寻找新的bug并在文章中进行介绍。 谢谢你们！ 没有你，这篇文章不会那么有趣。 <br><br> 另外，我想介绍一下我们的成就，因为我们整年都在忙于寻找错误。 我们还一直在开发和改进分析仪，从而对其进行了重大更改。 <br><br> 例如，我们增加了对几个新编译器的支持，并扩展了诊断规则的列表。 我们还实施了对<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">MISRA C和MISRA C ++</a>标准的初步支持。 最重要且耗时的新功能是对新语言的支持。 是的，我们现在可以分析<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Java</a>代码！ 而且，我们还有一个<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">新图标</a> ：) <br><br> 我还要感谢我们的读者。 感谢您阅读我们的文章并写信给我们！ 您反应灵敏，对我们如此重要！ <br><br> 我们2018年的十大C ++错误已经结束。 您最喜欢什么片段，为什么？ 您在2018年遇到过一些有趣的例子吗？ <br><br> 祝一切顺利，下次见！ </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN444568/">https://habr.com/ru/post/zh-CN444568/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN444558/index.html">CUBA 7的新功能</a></li>
<li><a href="../zh-CN444560/index.html">我们邀请您参加“云。 Fashion Trends” 2019年3月26日</a></li>
<li><a href="../zh-CN444562/index.html">GHIDRA的现代化。 朗姆Sega Mega Drive装载机</a></li>
<li><a href="../zh-CN444564/index.html">具有心理模型的数字产品开发</a></li>
<li><a href="../zh-CN444566/index.html">西科斯基与一名男子一起进行了无人直升机的演示</a></li>
<li><a href="../zh-CN444570/index.html">2018年C ++项目中的十大错误</a></li>
<li><a href="../zh-CN444572/index.html">LED闪烁</a></li>
<li><a href="../zh-CN444574/index.html">微型Macintosh Plus</a></li>
<li><a href="../zh-CN444576/index.html">类型系统如何改善您的JavaScript代码</a></li>
<li><a href="../zh-CN444578/index.html">演讲嘉宾2019顶级3D博览会：3dbio的Yousef Hesuani-器官和组织的3D打印</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>