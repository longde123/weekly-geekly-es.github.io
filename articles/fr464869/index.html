<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üóΩ üå≠ üë©‚Äçüíª L'histoire d'un monolithe. 2e partie üåÉ ‚ò™Ô∏è üôãüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans un article pr√©c√©dent , j'ai racont√© un bref historique du d√©veloppement des produits internes et externes de DublGIS. Aujourd'hui, nous plongeons...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>L'histoire d'un monolithe. 2e partie</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/2gis/blog/464869/"><img src="https://habrastorage.org/webt/ey/y4/pm/eyy4pmvrfn_bptplc1fl0vt9kpu.png"><br><br>  Dans un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article</a> pr√©c√©dent <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">,</a> j'ai racont√© un bref historique du d√©veloppement des produits internes et externes de DublGIS.  Aujourd'hui, nous plongeons dans les d√©tails du d√©veloppement d'un des produits, √† savoir l'exportation de donn√©es.  Je parlerai de l'architecture du projet et des solutions techniques individuelles qui nous ont permis de d√©velopper progressivement le projet et de l'adapter √† l'√©volution des exigences au fil du temps. <br><a name="habracut"></a><br><h4>  Un bref r√©sum√© du dernier article </h4><br>  Il existe plusieurs produits internes qui collectent de grandes quantit√©s de donn√©es cartographiques, un r√©pertoire d'organisations, de la publicit√©, des commentaires des utilisateurs, des critiques, des photos, diverses analyses.  Ces produits communiquent entre eux via le bus de donn√©es ou via Rest Api.  Et il existe un processus d'exportation distinct qui collecte toutes ces donn√©es dans un tas, les traite et les d√©compose au format souhait√©, emballe et forme un ¬´bundle¬ª pr√™t √† l'emploi pour la livraison √† ses produits finaux.  La livraison a lieu soit via le serveur de mise √† jour pour les versions PC et mobile, soit dans le backend en ligne pour, en fait, la version en ligne de 2GIS. <br><br><img src="https://habrastorage.org/webt/0o/v4/xl/0ov4xlhfak0bifcv8xk42nladwg.png"><br><br><h4>  Donn√©es source </h4><br>  Donc, √† l'entr√©e, nous avons: <br><br><ul><li>  plusieurs sources des m√™mes donn√©es; </li><li>  diff√©rentes m√©thodes de livraison (Firebird, bus, FTP, RestAPI); </li><li>  structure diff√©rente des m√™mes objets; </li><li>  des changements constants dans la structure des donn√©es; </li><li>  diff√©rents formats (donn√©es brutes dans la base de donn√©es, XML, JSON). </li></ul><br>  Du point de vue du consommateur: <br><br><ul><li>  encore une fois, diff√©rents formats (leurs formats de donn√©es pour diff√©rentes versions du produit, des formats distincts pour la vente); </li><li>  changements de format constants; </li><li>  des donn√©es agr√©g√©es (vous devez combiner diff√©rents objets en un seul, collecter des donn√©es sur l'entreprise dans toutes les succursales, les compl√©ter avec des liens vers des photos, des avis, des arr√™ts les plus proches, etc.); </li><li>  pr√© et post-traitement complexes (mise √† jour de certaines donn√©es sur la base d'autres, conversion de donn√©es, g√©n√©ration de donn√©es manquantes, par exemple, organisation de mini-logos publicitaires sur des b√¢timents, suppression ou correction de donn√©es erron√©es); </li><li>  exigences de coh√©rence et de validit√© des donn√©es; </li><li>  <b>TOUTES les</b> donn√©es sont n√©cessaires. </li></ul><br>  Ici, il convient de se concentrer sur le dernier paragraphe.  Comme vous le savez, la principale caract√©ristique de 2GIS est le travail hors ligne.  Autrement dit, la plupart des donn√©es que vous voyez dans nos versions PC et mobile se trouvent sur votre appareil.  Mais il s'agit d'un vaste √©ventail: des centaines de milliers d'objets g√©o (mers, for√™ts, rivi√®res, routes, b√¢timents, entr√©es, porches, signatures, plans d'√©tage, mod√®les 3D), des dizaines et des centaines de milliers d'entreprises et leurs succursales avec contacts, heures de travail, attributs suppl√©mentaires comme la facture moyenne et la disponibilit√© du Wi-Fi.  Et, bien s√ªr, des textes publicitaires et des photos. <br><br>  Et tout est en constante √©volution, ajout√©, supprim√©. <br><br>  Et pour ne pas se noyer dans ce flot incessant de changements, lors du d√©veloppement de l'architecture d'exportation, nous avons d√ª nous concentrer sur plusieurs domaines principaux: <br><br><ul><li>  sources de donn√©es; </li><li>  m√©thodes de livraison; </li><li>  algorithmes de traitement; </li><li>  formats de donn√©es des consommateurs. </li></ul><br><h4>  Nous r√©sumons √† partir de diff√©rentes sources et formats de donn√©es </h4><br>  Diff√©rentes sources introduisent les difficult√©s suivantes: <br><br><ul><li>  ils donnent les m√™mes donn√©es dans diff√©rents formats; </li><li>  ont un ensemble diff√©rent d'entit√©s ou d'attributs qui doivent √™tre r√©duits √† un seul objet de domaine. </li></ul><br>  Il s'agit d'un probl√®me assez standard et il est r√©solu en standard.  Nous avons juste besoin de cr√©er une interface pour recevoir des donn√©es, et une impl√©mentation sp√©cifique va d√©j√† l√† o√π elle est n√©cessaire et obtiendra les donn√©es sous la forme dont nous avons besoin. <br><br><img src="https://habrastorage.org/webt/wh/sg/tx/whsgtxlho1otzxvy2lc1kniydnq.png"><br><br>  Exemple d'interface: <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> interface ISource : IDisposable { <span class="hljs-function"><span class="hljs-function">ISourceReader </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetDeletedRows</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">ISourceReader </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetInsertedOrUpdatedRows</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; byte[] GetDataVersion(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> interface ISourceReader : IDisposable { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Read</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; object <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>[<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> columnName] { get; } }</code> </pre> <br>  Un exemple de mise en ≈ìuvre de l'obtention d'entreprises: <br><br><pre> <code class="cpp hljs">internal <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FirmSetSource</span></span></span><span class="hljs-class"> :</span></span> ISource { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ISourceReader </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetDeletedRows</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(_lastDataVersion == null) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null; var query = DataContext.ExecuteObject&lt;EsbFirmDeleted&gt;(_lastDataVersion); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DeletedIdsSourceReader&lt;<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>&gt;( query.Select(x =&gt; x.Id).GetEnumerator()); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ISourceReader </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetInsertedOrUpdatedRows</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EnumeratorSourceReader(typeof(FirmSet), GetNewOrChangedRows().GetEnumerator()); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> byte[] GetDataVersion() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> DataContext.ExecuteObject&lt;EsbFirm&gt;().Max(x =&gt; x.RowVersion); } }</code> </pre><br>  Cette abstraction nous permet en partie de r√©soudre le probl√®me avec des diff√©rences dans le mod√®le de domaine, mais pas compl√®tement.  Une limitation importante est la n√©cessit√© de recevoir des donn√©es de mani√®re incr√©mentielle, c'est-√†-dire de ne recevoir que leurs mises √† jour, et de ne pas aspirer le tout √† chaque fois.  Dans ce cas, il est plut√¥t g√™nant de suivre la relation entre les donn√©es afin de collecter certains agr√©gats.  Et il est relativement difficile de tout faire sans erreurs.  Par cons√©quent, nous avons d√©cid√© qu'√† ce stade, nous allons extraire les donn√©es des sources une √† une, et nous allons r√©soudre le probl√®me avec le mod√®le de domaine √† un niveau diff√©rent. <br><br><h4>  Mod√®le de domaine </h4><br>  Afin de ne pas d√©pendre des modifications de l'ensemble de donn√©es et de leur structure dans les sources de donn√©es, la base de donn√©es d'exportation a √©t√© r√©alis√©e avec une liste de tableaux relativement stable, qui est finalement tomb√©e sur notre domaine.  Si la source 1 manquait d'attributs pour l'entit√© A (objet de donn√©es dans l'image suivante), alors ils ont re√ßu une valeur par d√©faut ou √©taient facultatifs.  Et si l'entit√© B √©tait une sorte d'agr√©gat de donn√©es sources ou m√™me de sources diff√©rentes, alors chaque partie pourrait √™tre obtenue s√©par√©ment et ensuite assembl√©e dans son ensemble √† l'√©tape suivante. <br><br><img src="https://habrastorage.org/webt/xe/yl/8j/xeyl8jchpmefkzixpxnojxxenje.png"><br><br><h4>  Nous abstenons de la m√©thode de livraison des donn√©es </h4><br>  En fait, avoir votre propre base de donn√©es dans l'exportation et l'apparence de l'interface <i>ISourceReader</i> r√©solvent d√©j√† ce probl√®me.  Mais il y a un point non r√©solu: des mod√®les d'acquisition de donn√©es l√©g√®rement diff√©rents.  Dans un cas, nous tirons et obtenons un instantan√© au moment actuel, dans l'autre - deltas de changements sur le bus, dans le troisi√®me - √©galement le statut actuel au moment de la demande, mais avec des informations sur les objets supprim√©s au moment de la demande pr√©c√©dente. <br><br>  Pour uniformiser ce zoo, nous ajouterons une base de donn√©es suppl√©mentaire √† laquelle nous fusionnerons toutes les donn√©es de toutes les sources. <br><br>  Vous obtenez une telle image. <br><br><img src="https://habrastorage.org/webt/bn/vu/d7/bnvud7u46kgmhbmgzxr2rcsv-l4.png"><br><br>  En cons√©quence, nous lisons toutes les donn√©es de n'importe quel canal dans toutes les villes vers la base de donn√©es centrale.  La livraison est presque toujours incr√©mentielle, c'est-√†-dire que seuls des changements surviennent.  L'ancien DGPP, de son vivant, est rest√© une source alternative.  Il √©tait possible de pomper des donn√©es d'un SGBD vers un autre. <br><br>  En outre, l'exportation via ISource a extrait les donn√©es de la ville de DGPP ou EMDB dans sa base de donn√©es de synchronisation stable et les a converties en son mod√®le de domaine. <br><br>  Il ne reste plus alors qu'√† les traiter et √† les t√©l√©charger dans des formats grand public. <br><br><h4>  R√©sum√© des algorithmes de pr√©paration des donn√©es </h4><br>  Et ici, une difficult√© suppl√©mentaire se pose.  Premi√®rement, diff√©rents consommateurs veulent des donn√©es dans leurs formats.  De plus, ils veulent des ensembles de donn√©es diff√©rents.  Et dans l'appendice, les donn√©es hors ligne doivent √™tre aussi compactes et structur√©es que possible afin de pouvoir √™tre lues rapidement.  En cons√©quence, nous obtenons des formats binaires qui sont d√©velopp√©s par les √©quipes de produits finaux.  Et ce sont des gars qui travaillent sur une pile technologique compl√®tement diff√©rente.  Nous avons le familier et le bien-aim√© pour d√©velopper le backend .NET et parfois Java, ils ont principalement C ++ et python. <br><br>  En g√©n√©ral, un zoo de technologie. <br><br>  √Ä l'aube d'un d√©veloppement rapide, alors que nous n'avions que DGPP (voir l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article</a> pr√©c√©dent) et la version PC de 2GIS, le format des donn√©es finales √©tait un binaire, qui a √©t√© pr√©par√© par une biblioth√®que sp√©ciale √©crite en C ++ et envelopp√© dans un objet COM.  Il semblerait que non l'int√©gration de code h√©t√©rog√®ne.  Nous connectons la r√©f√©rence, l'interface .NET est g√©n√©r√©e - et la pilotons.  Et la premi√®re fois que nous l'avons fait. <br><br>  Mais, comme d'habitude, quelques probl√®mes sont apparus. <br><br><ol><li>  Nos donn√©es ont commenc√© √† cro√Ætre rapidement.  De nouveaux types de donn√©es sont apparus, de nouvelles grandes villes comme Moscou. </li><li>  Les syst√®mes d'exploitation X64 bits ont commenc√© √† se diffuser activement. </li><li>  Les probl√®mes dans COM devaient √™tre d√©bogu√©s d'une mani√®re ou d'une autre. </li></ol><br>  Passons en revue les points. <br><br>  La croissance des donn√©es dont nos produits ont absolument besoin a conduit au fait que leur traitement a commenc√© √† consommer une grande quantit√© de RAM.  Et apr√®s avoir connect√© la biblioth√®que COM √† notre processus .NET x86, nous avons automatiquement re√ßu le processus x86, c'est-√†-dire un maximum d'agents 3Gb avec un espace d'adressage accru.  Les √©quipes ne prenaient pas en charge la biblioth√®que pour les ressources x64, mais la biblioth√®que elle-m√™me avait la possibilit√© d'utiliser le disque au lieu de la m√©moire, ce qui a quelque peu att√©nu√© le probl√®me. <br><br>  Mais le d√©bogage √©tait toujours tr√®s difficile.  Il fallait commencer l'exportation, attendre qu'elle pr√©pare les donn√©es, commencer √† ajouter ces donn√©es √† la biblioth√®que.  Et apr√®s l'apparition de l'erreur, vous devez comprendre dans les journaux ce qui s'est mal pass√© et recommencer le processus.  Pas bon, tr√®s mauvais. <br><br>  La solution est comme d'habitude en surface.  Il suffit de prendre tout le code √©tranger dans un processus s√©par√© et d'√©tablir une communication via des fichiers interm√©diaires dans un format binaire ou texte simple. <br><br><img src="https://habrastorage.org/webt/it/iz/3z/itiz3zov4vs_st9jlsexawhwlsg.png"><br><br>  En cons√©quence, notre processus .NET d'origine est devenu compl√®tement n'importe quel processeur.  Aucune fuite de m√©moire ou erreur critique dans le code tiers ne l'a plus affect√©.  L'exportation a pr√©par√© les donn√©es, les a t√©l√©charg√©es dans un fichier interm√©diaire, les a transmises √† l'utilitaire et en a √©galement re√ßu le r√©sultat sous forme de fichier.  Les gars des √©quipes tierces ont √©crit leurs algorithmes dans leurs langages (C ++ ou Python) et pouvaient les d√©boguer sur des donn√©es r√©elles en cas d'erreurs sur leur machine sans avoir besoin de commencer √† exporter. <br><br>  Nous n'avions qu'√† conclure des accords sur l'interface utilitaire, qui √©taient fournis avec le runtime, avaient une liste convenue de param√®tres requis, et affichaient des messages d'information et des erreurs dans stdout dans le format requis. <br><br><img src="https://habrastorage.org/webt/lt/ja/15/ltja15n_x-u5dgdycaju5vuud1u.png"><br>  <i>Exemple de format de texte interm√©diaire</i> <br><br><h4>  R√©sum√© </h4><br>  Dans l'article, j'ai parl√© de certaines approches que nous avons utilis√©es √† diff√©rents niveaux de l'application pour isoler le processus de pr√©paration des donn√©es: <br><br><ul><li>  cach√© les d√©tails de l'acc√®s aux sources de donn√©es derri√®re les interfaces; </li><li>  extrait des canaux de transmission de donn√©es en utilisant un stockage interm√©diaire; </li><li>  cr√©ez votre domaine stable et convertissez-y les donn√©es d'origine; </li><li>  effectu√© des √©tapes individuelles de traitement des donn√©es dans des processus et utilis√© le code dans d'autres langues. </li></ul><br>  Merci d'√™tre arriv√© au bout.  Je r√©pondrai √† toutes les questions dans les commentaires, n'oubliez pas de poser. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr464869/">https://habr.com/ru/post/fr464869/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr464859/index.html">Contr√¥le de plusieurs moteurs pas √† pas Nema 17 en m√™me temps ou NemaStepper</a></li>
<li><a href="../fr464861/index.html">Scrum Mini Reference and Guide</a></li>
<li><a href="../fr464863/index.html">Natas Web. Passage de la plateforme CTF visant √† exploiter les vuln√©rabilit√©s du Web. Partie 4</a></li>
<li><a href="../fr464865/index.html">T√©l√©gramme comme entrep√¥t de donn√©es pour les projets informatiques</a></li>
<li><a href="../fr464867/index.html">"Gomme"</a></li>
<li><a href="../fr464871/index.html">15 livres d'apprentissage automatique pour d√©butants</a></li>
<li><a href="../fr464873/index.html">Pourquoi effectuer des op√©rations avec de la monnaie sur la bourse: 3 sc√©narios pratiques</a></li>
<li><a href="../fr464877/index.html">Nouvelles du monde d'OpenStreetMap n ¬∞ 473 (08/06/2019 - 12/08/2019)</a></li>
<li><a href="../fr464881/index.html">Personnalisation de la composition des tests JUnit5 avec application.properties</a></li>
<li><a href="../fr464883/index.html">Vers o√π se dirige le r√©seau</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>