<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üêü üë©üèª‚Äçüöí ‚ôçÔ∏è Un peu de dictionnaires internes en CPython (et PyPy) üè¥Û†ÅßÛ†Å¢Û†Å∑Û†Å¨Û†Å≥Û†Åø üíë üéß</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="La structure interne des dictionnaires en Python ne se limite pas uniquement au bucket et au hachage priv√©. Il s'agit d'un monde √©tonnant de cl√©s part...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Un peu de dictionnaires internes en CPython (et PyPy)</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/432996/">  La structure interne des dictionnaires en Python ne se limite pas uniquement au bucket et au hachage priv√©.  Il s'agit d'un monde √©tonnant de cl√©s partag√©es, de mise en cache de hachage, de DKIX_DUMMY et de comparaisons rapides, qui peuvent √™tre effectu√©es encore plus rapidement (au prix d'un bogue avec une probabilit√© approximative de 2 ^ -64). <br><br>  Si vous ne connaissez pas le nombre d'√©l√©ments dans le dictionnaire que vous venez de cr√©er, combien de m√©moire est d√©pens√©e pour chaque √©l√©ment, pourquoi maintenant (CPython 3.6 et versions ult√©rieures) le dictionnaire est impl√©ment√© dans deux tableaux et comment il se rapporte au maintien de l'ordre d'insertion, ou vous n'avez tout simplement pas regard√© la pr√©sentation de Raymond Hettinger "Modern Python moderne" Dictionnaires Une confluence d'une douzaine de grandes id√©es. "  Alors bienvenue. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/p33CVV29OG8" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Cependant, les personnes qui connaissent la conf√©rence peuvent √©galement trouver des d√©tails et des informations fra√Æches, et pour les nouveaux arrivants qui ne sont pas familiers avec le seau et le hachage ferm√©, l'article sera √©galement int√©ressant. <br><a name="habracut"></a><br>  Les dictionnaires en CPython sont partout, les classes, les variables globales, les param√®tres kwargs sont bas√©s sur eux, l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">interpr√©teur cr√©e des milliers de dictionnaires</a> , m√™me si vous-m√™me n'avez pas ajout√© de crochets √† votre script.  Mais pour r√©soudre de nombreux probl√®mes appliqu√©s, des dictionnaires sont √©galement utilis√©s, il n'est pas surprenant que leur impl√©mentation continue de s'am√©liorer et de plus en plus se d√©velopper en diff√©rentes astuces. <br><br><h2>  Impl√©mentation de base des dictionnaires (via Hashmap) </h2><br>  Si vous connaissez le travail de Hashmap standard et le hachage priv√©, vous pouvez passer au chapitre suivant. <br><br>  L'id√©e sous-jacente aux dictionnaires est simple: si nous avons un tableau dans lequel des objets de la m√™me taille sont stock√©s, alors nous avons facilement acc√®s √† l'objet souhait√©, connaissant l'index. <br><br><img src="https://habrastorage.org/webt/wq/m3/nk/wqm3nkortrkb_eyjwlorn4ahreq.png"><br><br>  Nous ajoutons simplement un index multipli√© par la taille de l'objet au d√©calage du tableau, et nous obtenons l'adresse de l'objet souhait√©. <br><br>  Mais que se passe-t-il si nous voulons organiser une recherche non pas par un index entier, mais par une variable d'un autre type, par exemple, pour trouver des utilisateurs √† leur adresse mail? <br><br>  Dans le cas d'un tableau simple, nous devrons parcourir les mails de tous les utilisateurs du tableau et les comparer avec la recherche, cette approche est appel√©e recherche lin√©aire et, √©videmment, elle est beaucoup plus lente que l'acc√®s √† l'objet par index. <br><br>  La recherche lin√©aire peut √™tre consid√©rablement acc√©l√©r√©e si nous limitons la taille de la zone dans laquelle vous souhaitez effectuer la recherche.  Ceci est g√©n√©ralement r√©alis√© en prenant le reste du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">hachage</a> .  Le champ recherch√© est la cl√©. <br><br><img src="https://habrastorage.org/webt/hn/1l/f4/hn1lf445vm6bnorbgvx7n5mbfos.png"><br><br>  Par cons√©quent, une recherche lin√©aire n'est pas effectu√©e sur l'ensemble du grand tableau, mais le long de sa partie. <br><br>  Mais que faire s'il y a d√©j√† un √©l√©ment?  Cela pourrait tr√®s bien se produire, car personne ne garantissait que les r√©sidus de la division du hachage seraient uniques (comme le hachage lui-m√™me).  Dans ce cas, l'objet sera plac√© √† l'index suivant, s'il est occup√©, il se d√©placera d'un autre index et ainsi de suite jusqu'√† ce qu'il en trouve un libre.  Lors de la r√©cup√©ration d'un √©l√©ment, toutes les cl√©s avec le m√™me hachage seront affich√©es. <br><br><img src="https://habrastorage.org/webt/8a/0d/uj/8a0dujuj4hduhrbihtpomacvg0i.png"><br><br>  Ce type de hachage est appel√© priv√©.  S'il y a peu de cellules libres dans le dictionnaire, alors une telle recherche menace de d√©g√©n√©rer en une recherche lin√©aire, donc nous perdrons tous les gains pour lesquels le dictionnaire a √©t√© cr√©√©, afin d'√©viter cela, l'interpr√®te conserve le tableau rempli en 1/2 - 2/3.  S'il n'y a pas suffisamment de cellules libres, un nouveau tableau est cr√©√© deux fois plus grand que le pr√©c√©dent et les √©l√©ments de l'ancien sont transf√©r√©s vers le nouveau √† la fois. <br><br>  Que faire si l'√©l√©ment a √©t√© supprim√©?  Dans ce cas, une cellule vide est form√©e dans le tableau et l'algorithme de recherche par cl√© ne peut pas distinguer, cette cellule est vide car un √©l√©ment avec un tel hachage n'√©tait pas dans le dictionnaire, ou parce qu'il a √©t√© supprim√©.  Pour √©viter la perte de donn√©es lors de la suppression, la cellule est marqu√©e d'un indicateur sp√©cial (DKIX_DUMMY).  Si cet indicateur est rencontr√© lors d'une recherche d'√©l√©ment, la recherche se poursuit, la cellule est consid√©r√©e comme occup√©e, si elle est ins√©r√©e, la cellule sera √©cras√©e. <br><br><h2>  Fonctionnalit√©s d'impl√©mentation en Python </h2><br>  Chaque √©l√©ment du dictionnaire doit contenir un lien vers l'objet cible et la cl√©.  La cl√© doit √™tre stock√©e pour le traitement de collision, l'objet - pour des raisons √©videntes.  √âtant donn√© que la cl√© et l'objet peuvent √™tre de n'importe quel type et taille, nous ne pouvons pas les stocker directement dans la structure, ils se trouvent dans la m√©moire dynamique et les liens vers ceux-ci sont stock√©s dans la structure de l'√©l√©ment de liste.  Autrement dit, la taille d'un √©l√©ment doit √™tre √©gale √† la taille minimale de deux pointeurs (16 octets sur les syst√®mes 64 bits).  Cependant, l'interpr√©teur stocke √©galement le hachage, ceci afin de ne pas le recalculer √† chaque augmentation de la taille du dictionnaire.  Au lieu de calculer le hachage de chaque cl√© d'une nouvelle mani√®re et de prendre le reste de la division par le nombre de compartiments, l'interpr√®te lit simplement la valeur d√©j√† enregistr√©e.  Mais que se passe-t-il si l'objet cl√© est modifi√©?  Dans ce cas, le hachage doit √™tre recalcul√© et la valeur stock√©e sera incorrecte?  Une telle situation est impossible, car les types mutables ne peuvent pas √™tre des cl√©s de dictionnaire. <br><br>  La structure de l'√©l√©ment dictionnaire est d√©finie comme suit: <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> Py_hash_t me_hash; <span class="hljs-comment"><span class="hljs-comment">//  PyObject *me_key; //    PyObject *me_value; //     } PyDictKeyEntry;</span></span></code> </pre> <br>  La taille minimale du dictionnaire est d√©clar√©e par la constante PyDict_MINSIZE, qui est de 8. Les d√©veloppeurs ont d√©cid√© qu'il s'agissait de la taille optimale afin d'√©viter un gaspillage de m√©moire inutile pour stocker des valeurs vides et du temps pour l'expansion dynamique de la matrice.  Ainsi, lors de la cr√©ation d'un dictionnaire (jusqu'√† la version 3.6), il fallait un minimum de 8 √©l√©ments dans le dictionnaire * 24 octets dans la structure = 192 octets (cela ne prend pas en compte le reste des champs: le co√ªt de la variable dictionnaire elle-m√™me, le compteur du nombre d'√©l√©ments, etc.) <br><br>  Les dictionnaires sont √©galement utilis√©s pour impl√©menter des champs de classe personnalis√©s.  Python vous permet de modifier dynamiquement le nombre d'attributs, cette dynamique ne n√©cessite pas de co√ªts suppl√©mentaires, car l'ajout / la suppression d'un attribut est essentiellement √©quivalent √† l'op√©ration correspondante sur le dictionnaire.  Cependant, une minorit√© de programmes utilisent cette fonctionnalit√©; la plupart sont limit√©s aux champs d√©clar√©s dans __init__.  Mais chaque objet doit stocker son propre dictionnaire, avec ses cl√©s et ses hachages, malgr√© le fait qu'ils co√Øncident avec d'autres objets.  Une am√©lioration logique ici est le stockage des cl√©s partag√©es en un seul endroit, ce qui est exactement ce qui a √©t√© mis en ≈ìuvre dans le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">PEP 412 - Key-Sharing Dictionary</a> .  La possibilit√© de modifier dynamiquement le dictionnaire n'a pas disparu: si l'ordre ou le nombre de cl√©s est modifi√©, le dictionnaire est converti des cl√©s de division en cl√© normale. <br><br>  Pour √©viter les collisions, le ¬´chargement¬ª maximum du dictionnaire est 2/3 de la taille actuelle du tableau. <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> USABLE_FRACTION(n) (((n) &lt;&lt; 1)/3)</span></span></code> </pre> <br>  Ainsi, la premi√®re extension se produira lorsque le 6√®me √©l√©ment sera ajout√©. <br><br>  La matrice s'av√®re √™tre assez d√©charg√©e, pendant le fonctionnement du programme, de la moiti√© au tiers des cellules restent vides, ce qui conduit √† une consommation de m√©moire accrue.  Afin de contourner cette limitation et, si possible, de ne stocker que les donn√©es n√©cessaires, un nouveau <s>niveau d'abstraction du</s> tableau a √©t√© ajout√©. <br><br>  Au lieu de stocker un tableau clairsem√©, par exemple: <br><br><pre> <code class="python hljs"> d = {<span class="hljs-string"><span class="hljs-string">'timmy'</span></span>: <span class="hljs-string"><span class="hljs-string">'red'</span></span>, <span class="hljs-string"><span class="hljs-string">'barry'</span></span>: <span class="hljs-string"><span class="hljs-string">'green'</span></span>, <span class="hljs-string"><span class="hljs-string">'guido'</span></span>: <span class="hljs-string"><span class="hljs-string">'blue'</span></span>} <span class="hljs-comment"><span class="hljs-comment"># -&gt; entries = [['--', '--', '--'], [-8522787127447073495, 'barry', 'green'], ['--', '--', '--'], ['--', '--', '--'], ['--', '--', '--'], [-9092791511155847987, 'timmy', 'red'], ['--', '--', '--'], [-6480567542315338377, 'guido', 'blue']]</span></span></code> </pre><br>  √Ä partir de la version 3.6, les dictionnaires sont organis√©s comme suit: <br><br><pre> <code class="python hljs"> indices = [<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>] entries = [[<span class="hljs-number"><span class="hljs-number">-9092791511155847987</span></span>, <span class="hljs-string"><span class="hljs-string">'timmy'</span></span>, <span class="hljs-string"><span class="hljs-string">'red'</span></span>], [<span class="hljs-number"><span class="hljs-number">-8522787127447073495</span></span>, <span class="hljs-string"><span class="hljs-string">'barry'</span></span>, <span class="hljs-string"><span class="hljs-string">'green'</span></span>], [<span class="hljs-number"><span class="hljs-number">-6480567542315338377</span></span>, <span class="hljs-string"><span class="hljs-string">'guido'</span></span>, <span class="hljs-string"><span class="hljs-string">'blue'</span></span>]]</code> </pre><br>  C'est-√†-dire  seuls les enregistrements r√©ellement n√©cessaires sont stock√©s, ils sont retir√©s de la table de hachage dans un tableau s√©par√© et seuls les index des enregistrements correspondants sont stock√©s dans la table de hachage.  Si initialement le tableau prenait 192 octets, il n'en est plus que de 80 (3 * 24 octets pour chaque enregistrement + 8 octets pour les index).  Compression atteinte √† 58%. [2] <br><br>  La taille d'un √©l√©ment dans les index change √©galement de mani√®re dynamique, initialement elle est √©gale √† un octet, c'est-√†-dire que l'ensemble du tableau peut √™tre plac√© dans un registre, lorsque l'index commence √† tenir sur 8 bits, puis les √©l√©ments s'√©tendent √† 16, puis √† 32 bits.  Il existe des constantes sp√©ciales DKIX_EMPTY et DKIX_DUMMY pour les √©l√©ments vides et supprim√©s, respectivement, l'extension de l'index √† 16 octets se produit lorsqu'il y a plus de 127 √©l√©ments dans le dictionnaire. <br><br>  De nouveaux objets sont ajout√©s aux entr√©es, c'est-√†-dire que lors de l'expansion du dictionnaire, il n'est pas n√©cessaire de les d√©placer, il vous suffit d'augmenter la taille des index et de le remplir avec des index. <br><br>  Lors de l'it√©ration sur un dictionnaire, le tableau d'indices n'est pas n√©cessaire, les √©l√©ments sont renvoy√©s s√©quentiellement √† partir des entr√©es, car  des √©l√©ments sont ajout√©s √† chaque fois √† la fin des entr√©es, le dictionnaire enregistre automatiquement l'ordre d'apparition des √©l√©ments.  Ainsi, en plus de r√©duire la m√©moire n√©cessaire pour stocker le dictionnaire, nous avons re√ßu une expansion dynamique plus rapide et une pr√©servation de l'ordre des cl√©s.  La r√©duction de la m√©moire est bonne en soi, mais en m√™me temps, elle peut augmenter les performances, car elle permet √† plus d'enregistrements d'entrer dans le cache du processeur. <br><br>  Les d√©veloppeurs de CPython ont tellement aim√© cette impl√©mentation que les dictionnaires sont d√©sormais requis pour maintenir l'ordre d'insertion par sp√©cification.  Si plus t√¥t l'ordre des dictionnaires √©tait d√©termin√©, c'est-√†-dire  il √©tait strictement d√©termin√© par le hachage et √©tait inchang√© du d√©but √† la fin, puis un peu d'al√©atoire y √©tait ajout√© pour que les cl√©s soient diff√©rentes √† chaque fois, maintenant les cl√©s du dictionnaire doivent maintenir l'ordre.  On ne sait pas dans quelle mesure cela √©tait n√©cessaire et que faire si une impl√©mentation encore plus efficace du dictionnaire mais ne pr√©servait pas l'ordre d'insertion. <br><br>  Cependant, il y avait des demandes pour impl√©menter un m√©canisme pour conserver la d√©claration d'attributs dans les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">classes</a> et dans les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">kwargs</a> , et cette impl√©mentation vous permet de fermer ces probl√®mes sans m√©canismes sp√©ciaux. <br><br>  Voici √† quoi cela ressemble dans le <a href="" rel="nofollow">code CPython</a> : <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dictkeysobject</span></span></span><span class="hljs-class"> {</span></span> Py_ssize_t dk_refcnt; <span class="hljs-comment"><span class="hljs-comment">/* Size of the hash table (dk_indices). It must be a power of 2. */</span></span> Py_ssize_t dk_size; <span class="hljs-comment"><span class="hljs-comment">/* Function to lookup in the hash table (dk_indices): - lookdict(): general-purpose, and may return DKIX_ERROR if (and only if) a comparison raises an exception. - lookdict_unicode(): specialized to Unicode string keys, comparison of which can never raise an exception; that function can never return DKIX_ERROR. - lookdict_unicode_nodummy(): similar to lookdict_unicode() but further specialized for Unicode string keys that cannot be the &lt;dummy&gt; value. - lookdict_split(): Version of lookdict() for split tables. */</span></span> dict_lookup_func dk_lookup; <span class="hljs-comment"><span class="hljs-comment">/* Number of usable entries in dk_entries. */</span></span> Py_ssize_t dk_usable; <span class="hljs-comment"><span class="hljs-comment">/* Number of used entries in dk_entries. */</span></span> Py_ssize_t dk_nentries; <span class="hljs-comment"><span class="hljs-comment">/* Actual hash table of dk_size entries. It holds indices in dk_entries, or DKIX_EMPTY(-1) or DKIX_DUMMY(-2). Indices must be: 0 &lt;= indice &lt; USABLE_FRACTION(dk_size). The size in bytes of an indice depends on dk_size: - 1 byte if dk_size &lt;= 0xff (char*) - 2 bytes if dk_size &lt;= 0xffff (int16_t*) - 4 bytes if dk_size &lt;= 0xffffffff (int32_t*) - 8 bytes otherwise (int64_t*) Dynamically sized, SIZEOF_VOID_P is minimum. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> dk_indices[]; <span class="hljs-comment"><span class="hljs-comment">/* char is required to avoid strict aliasing. */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* "PyDictKeyEntry dk_entries[dk_usable];" array follows: see the DK_ENTRIES() macro */</span></span> };</code> </pre><br>  Mais l'it√©ration est plus compliqu√©e que vous ne le pensez au d√©part, il existe des m√©canismes de v√©rification suppl√©mentaires que le dictionnaire n'a pas √©t√© modifi√© pendant l'it√©ration, l'un d'eux est une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">version</a> 64 bits <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">du dictionnaire</a> qui stocke chaque dictionnaire. <br><br>  Enfin, nous consid√©rons le m√©canisme de r√©solution des collisions.  Le fait est qu'en python, les valeurs de hachage sont facilement pr√©visibles: <br><br><pre> <code class="python hljs"> &gt;&gt;&gt;[hash(i) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">4</span></span>)] [<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>]</code> </pre><br>  Et puisque lors de la cr√©ation d'un dictionnaire √† partir de ces hachages, le reste de la division est pris, puis, en fait, ils d√©terminent dans quel compartiment l'enregistrement ira, uniquement les derniers bits de la cl√© (s'il est entier).  Vous pouvez imaginer une situation o√π nous avons beaucoup d'objets ¬´veulent¬ª entrer dans des seaux voisins, auquel cas vous devrez regarder beaucoup d'objets qui ne sont pas √† leur place lors de la recherche.  Pour r√©duire le nombre de collisions et augmenter le nombre de bits qui d√©terminent dans quel compartiment l'enregistrement ira, le m√©canisme suivant a √©t√© impl√©ment√©: <br><br><pre> <code class="cpp hljs"> <span class="hljs-comment"><span class="hljs-comment">//   i = i + 1 % n //   : #define PERTURB_SHIFT 5 perturb &gt;&gt;= PERTURB_SHIFT; j = (5*j) + 1 + perturb; //   j % n    </span></span></code> </pre><br>  perturb est une variable enti√®re initialis√©e par un hachage.  Il est √† noter que dans le cas d'un grand nombre de collisions, il est remis √† z√©ro et l'indice suivant est calcul√© par la formule: <br><br><pre> <code class="cpp hljs"> j = (<span class="hljs-number"><span class="hljs-number">5</span></span> * j + <span class="hljs-number"><span class="hljs-number">1</span></span>) % n</code> </pre><br>  Lors de l'extraction d'un √©l√©ment du dictionnaire, la m√™me recherche est effectu√©e: l'index de l'emplacement dans lequel l'√©l√©ment doit se trouver est calcul√©, si l'emplacement est vide, l'exception "valeur non trouv√©e" est lev√©e.  S'il y a une valeur dans cet emplacement, vous devez v√©rifier que sa cl√© correspond √† celle que vous recherchez, cela peut ne pas √™tre possible en cas de collision.  Cependant, la cl√© peut √™tre presque n'importe quel objet, y compris celui pour lequel l'op√©ration de comparaison prend un temps consid√©rable.  Pour √©viter une op√©ration de comparaison longue, plusieurs astuces sont utilis√©es en Python: <br><br><pre> <code class="python hljs"> <span class="hljs-comment"><span class="hljs-comment">#   (   ,  C) def eq(key, entity): if id(key) == id(entity): return True if hash(key) != hash(entity): return False return key == entity</span></span></code> </pre><br>  tout d'abord, les pointeurs sont compar√©s, si le pointeur cl√© de l'objet souhait√© est √©gal au pointeur de l'objet recherch√©, c'est-√†-dire qu'ils pointent vers la m√™me zone de m√©moire, puis la comparaison renvoie imm√©diatement true.  Mais ce n'est pas tout.  Comme vous le savez, les objets √©gaux doivent avoir des hachages √©gaux, ce qui signifie que les objets avec des hachages diff√©rents ne sont pas √©gaux.  Apr√®s avoir v√©rifi√© les pointeurs, les hachages sont v√©rifi√©s; s'ils ne sont pas √©gaux, false sera retourn√©.  Et seulement si les hachages sont √©gaux, une comparaison honn√™te sera appel√©e. <br><br>  Quelle est la probabilit√© d'un tel r√©sultat?  Environ 2 ^ -64, bien s√ªr, en raison de la pr√©visibilit√© facile de la valeur de hachage, vous pouvez facilement prendre un tel exemple, mais en r√©alit√©, cette v√©rification ne revient pas souvent √† combien?  Raymond Hettinger a assembl√© l'interpr√©teur en modifiant la derni√®re op√©ration de comparaison avec un simple retour vrai.  C'est-√†-dire  l'interpr√®te consid√®re les objets √©gaux si leurs hachages sont √©gaux.  Il a ensuite d√©fini des tests automatis√©s de nombreux projets populaires sur cet interpr√®te, qui se sont termin√©s avec succ√®s.  Il peut sembler √©trange de consid√©rer des objets avec des hachages √©gaux √©gaux, de ne pas v√©rifier en outre leur contenu et de se fier enti√®rement au hachage uniquement, mais vous le faites r√©guli√®rement lorsque vous utilisez les protocoles git ou torrent.  Ils consid√®rent les fichiers (blocs de fichiers) √©gaux si leurs hachages sont √©gaux, ce qui peut bien conduire √† des erreurs, mais leurs cr√©ateurs (et nous tous) esp√©rons qu'il convient de noter, il n'est pas d√©raisonnable, que la probabilit√© de collision est extr√™mement faible. <br><br>  Maintenant, vous devriez enfin comprendre la structure du dictionnaire, qui ressemble √† ceci: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> PyObject_HEAD <span class="hljs-comment"><span class="hljs-comment">/* Number of items in the dictionary */</span></span> Py_ssize_t ma_used; <span class="hljs-comment"><span class="hljs-comment">/* Dictionary version: globally unique, value change each time the dictionary is modified */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint64_t</span></span> ma_version_tag; PyDictKeysObject *ma_keys; <span class="hljs-comment"><span class="hljs-comment">/* If ma_values is NULL, the table is "combined": keys and values are stored in ma_keys. If ma_values is not NULL, the table is splitted: keys are stored in ma_keys and values are stored in ma_values */</span></span> PyObject **ma_values; } PyDictObject;</code> </pre><br><h2>  Changements futurs </h2><br>  Dans le chapitre pr√©c√©dent, nous avons examin√© ce qui a d√©j√† √©t√© impl√©ment√© et peut √™tre utilis√© par tout le monde dans leur travail, mais les am√©liorations ne sont bien s√ªr pas limit√©es √†: les plans de la version 3.8 incluent la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">prise en charge des dictionnaires invers√©s</a> .  En effet, rien n'emp√™che au lieu d'it√©rer depuis le d√©but d'un tableau d'√©l√©ments et d'augmenter les indices, en commen√ßant par la fin et les indices d√©croissants. <br><br><h2>  Mat√©riel suppl√©mentaire </h2><br>  Pour une immersion plus approfondie dans le sujet, il est recommand√© de vous familiariser avec les mat√©riaux suivants: <br><br><ol><li>  Enregistrement du rapport au d√©but de l'article </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">Proposition pour une nouvelle impl√©mentation de dictionnaires</a> </li><li>  <a href="" rel="nofollow">Dictionnaire du code source dans CPython</a> </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr432996/">https://habr.com/ru/post/fr432996/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr432986/index.html">Boucles C vs Go et math√©matiques simples</a></li>
<li><a href="../fr432988/index.html">Huiti√®me webmaster. En direct sur Habr√©</a></li>
<li><a href="../fr432990/index.html">Lampe en bois √† commande vocale Edison. Prix ‚Äã‚Äãd'√©mission 5 $</a></li>
<li><a href="../fr432992/index.html">Il a mis ses √©couteurs et est mort: nous parlons de la mort √©trange d'un √©colier √† Rimbau</a></li>
<li><a href="../fr432994/index.html">Vivaldi 2.2 - Conversion de quantit√© en qualit√©</a></li>
<li><a href="../fr432998/index.html">Histoire de No√´l</a></li>
<li><a href="../fr433000/index.html">Compilation de Kotlin: JetBrains VS ANTLR VS JavaCC</a></li>
<li><a href="../fr433002/index.html">Venez vous-m√™me ... ou les r√®gles de la communication en √©quipe</a></li>
<li><a href="../fr433004/index.html">Une strat√©gie de migration cloud robuste pour 2019: 7 conseils</a></li>
<li><a href="../fr433008/index.html">Les p√©riph√©riques USB constituent une menace ¬´soudaine¬ª</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>