<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèæ‚Äçüî¨ üîÄ üë®üèø‚Äçüç≥ √Ä la demande des d√©veloppeurs int√©gr√©s: d√©tection des erreurs dans Amazon FreeRTOS ü•ô üòä üçô</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Quiconque programme des microcontr√¥leurs conna√Æt probablement FreeRTOS, ou du moins a entendu parler de ce syst√®me d'exploitation. Les d√©veloppeurs d'...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>√Ä la demande des d√©veloppeurs int√©gr√©s: d√©tection des erreurs dans Amazon FreeRTOS</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/473966/">  Quiconque programme des microcontr√¥leurs conna√Æt probablement FreeRTOS, ou du moins a entendu parler de ce syst√®me d'exploitation.  Les d√©veloppeurs d'Amazon ont d√©cid√© d'am√©liorer les capacit√©s de ce syst√®me d'exploitation √† fonctionner avec les services AWS Internet of Things.  C'est ainsi qu'Amazon FreeRTOS est apparu.  Nous, d√©veloppeurs de l'analyseur de code statique PVS-Studio, avons √©t√© invit√©s par mail et dans les commentaires √† v√©rifier ces projets.  Eh bien, obtenez maintenant ce que vous avez demand√©.  Continuez √† lire pour d√©couvrir ce qui en est ressorti. <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/cee/9b7/a98/cee9b7a984f45dc365b4baea89adb019.png"></div><br><a name="habracut"></a><br><h2>  En bref sur les projets </h2><br>  Pour commencer, je vais vous parler un peu du pr√©curseur du projet en cours de test - FreeRTOS (le code source est disponible ici par <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">lien</a> ).  Comme le pr√©cise Wikipedia, FreeRTOS est un syst√®me d'exploitation multit√¢che en temps r√©el pour les syst√®mes embarqu√©s. <br><br>  Il est √©crit en bon vieux C, ce qui n'est pas surprenant - ce syst√®me d'exploitation devrait fonctionner dans des conditions typiques des microcontr√¥leurs: faible puissance de traitement, petite quantit√© de RAM, etc.  Le langage C vous permet de travailler avec des ressources √† un faible niveau et a des performances √©lev√©es, il est donc le mieux adapt√© pour d√©velopper un tel syst√®me d'exploitation. <br><br>  Revenons maintenant √† Amazon, qui est toujours en mouvement et qui d√©veloppe diverses directions prometteuses.  Par exemple, Amazon d√©veloppe un moteur Amazon Lumberyard AAA, que nous avons <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">√©galement v√©rifi√©</a> . <br><br>  L'une de ces directions est l'Internet des objets (IoT).  Pour se d√©velopper dans ce domaine, Amazon a d√©cid√© d'√©crire son propre syst√®me d'exploitation - et ils ont pris le noyau FreeRTOS comme base. <br><br>  Le syst√®me r√©sultant, Amazon FreeRTOS, est positionn√© pour ¬´fournir une connexion s√©curis√©e √† Amazon Web Services, comme AWS IoT Core ou AWS IoT Greengrass¬ª.  Le code source de ce projet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">est disponible</a> sur Github. <br><br>  Dans cet article, nous verrons s'il y a des erreurs dans FreeRTOS ainsi que la s√©curit√© du syst√®me d'exploitation Amazon en termes d'analyse de code statique. <br><br><h2>  Le d√©roulement du ch√®que </h2><br>  La v√©rification a √©t√© effectu√©e √† l'aide de l'outil de recherche d'erreur automatique - l'analyseur de code statique PVS-Studio.  Il est capable de d√©tecter les erreurs dans les programmes √©crits en C, C ++, C # et Java. <br><br>  Avant l'analyse, nous devons construire le projet.  De cette fa√ßon, je serai s√ªr d'avoir toutes les d√©pendances n√©cessaires et le projet est pr√™t √† √™tre v√©rifi√©.  On peut v√©rifier le projet de plusieurs fa√ßons - par exemple, en utilisant un syst√®me de surveillance de compilation.  Dans ce cas, j'ai effectu√© l'analyse en utilisant le plugin pour Visual Studio - il est bon que les r√©f√©rentiels des deux projets contiennent les ensembles de fichiers de projet qui facilitent la construction sous Windows. <br><br>  Je devais juste construire des projets pour m'assurer que tout √©tait pr√™t pour le contr√¥le.  Ensuite, j'ai ex√©cut√© l'analyse et - le tour est jou√©!  - J'ai un rapport d'analyseur pr√™t √† l'emploi devant moi. <br><br>  Les biblioth√®ques tierces incluses dans ces projets peuvent √©galement contenir des erreurs et, bien entendu, elles peuvent √©galement affecter le programme.  Cependant, je les ai exclus de l'analyse par souci de puret√© du r√©cit. <br><br>  Ainsi, les projets sont analys√©s, des rapports sont re√ßus, des erreurs int√©ressantes sont mises en √©vidence.  Il est temps d'obtenir leur avis! <br><br><h2>  Ce que FreeRTOS cache </h2><br>  Au d√©part, je m'attendais √† √©crire deux articles distincts: un pour chaque syst√®me d'exploitation.  Je me frottais d√©j√† les mains?  alors que je me pr√©parais √† √©crire un bon article sur FreeRTOS.  Anticipant la d√©couverte d'au moins quelques bogues juteux (comme <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">CWE-457</a> ), je regardais les avertissements clairsem√©s de l'analyseur et ... je n'ai rien trouv√©.  Je n'ai trouv√© aucune erreur int√©ressante. <br><br>  De nombreux avertissements √©mis par l'analyseur n'√©taient pas pertinents pour FreeRTOS.  Par exemple, ces avertissements √©taient des d√©fauts 64 bits tels que la <i>conversion</i> de <i>size_t</i> en <i>uint32_t</i> .  Cela est li√© au fait que FreeRTOS est cens√© fonctionner sur des appareils dont la taille du pointeur ne d√©passe pas 32 bits. <br><br>  J'ai soigneusement v√©rifi√© tous les avertissements <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">V1027</a> indiquant des pi√®ces moul√©es entre des pointeurs vers des structures non li√©es.  Si les structures coul√©es ont le m√™me alignement, une telle coul√©e est une erreur.  Et je n'ai trouv√© aucun casting dangereux! <br><br>  Tous les autres endroits suspects √©taient soit associ√©s au style de codage, soit dot√©s d'un commentaire expliquant pourquoi cela avait √©t√© fait de cette fa√ßon et pourquoi ce n'√©tait pas une erreur. <br><br>  Je voudrais donc faire appel aux d√©veloppeurs de FreeRTOS.  Les gars, vous √™tes g√©nial!  Nous avons √† peine vu des projets aussi propres et de haute qualit√© que le v√¥tre.  Et ce fut un plaisir de lire le code propre, soign√© et bien document√©.  Chapeau √† vous les gars. <br><br>  M√™me si je n'ai pas trouv√© de bogues int√©ressants ce jour-l√†, je savais que je ne m'arr√™terais pas l√†.  Je rentrais chez moi avec la ferme conviction que la version d'Amazon aurait 100% quelque chose d'int√©ressant, et que demain je prendrais certainement assez de bugs pour l'article.  Comme vous l'avez peut-√™tre devin√©, j'avais raison. <br><br><h2>  Ce qu'Amazon FreeRTOS cache </h2><br>  La version d'Amazon du syst√®me s'est av√©r√©e √™tre ... pour le dire l√©g√®rement, un peu pire.  L'h√©ritage de FreeRTOS est rest√© aussi propre alors que les nouvelles am√©liorations ont cach√© beaucoup de probl√®mes int√©ressants. <br><br>  Certains fragments ont cass√© la logique du programme, certains ont mal g√©r√© les pointeurs.  √Ä certains endroits, le code pouvait conduire √† un comportement ind√©fini, et il y avait des cas o√π le programmeur ignorait tout simplement le motif d'une erreur qu'il avait commise.  J'ai m√™me trouv√© plusieurs vuln√©rabilit√©s potentielles graves. <br><br>  On dirait que je me suis resserr√© avec l'introduction.  Commen√ßons √† comprendre les erreurs! <br><br><h3>  Rupture de la logique du programme </h3><br>  Commen√ßons par les endroits probl√©matiques qui indiquent √©videmment que le programme ne fonctionne pas de la mani√®re attendue par le programmeur.  La gestion des tableaux suspects viendra en premier: <br><br><pre><code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/** * @brief Pool of request and associated response buffers, * handles, and configurations. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> _requestPool_t _requestPool = { <span class="hljs-number"><span class="hljs-number">0</span></span> }; .... <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _scheduleAsyncRequest(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> reqIndex, <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> currentRange) { .... <span class="hljs-comment"><span class="hljs-comment">/* Set the user private data to use in the asynchronous callback context. */</span></span> _requestPool.pRequestDatas[reqIndex].pConnHandle = &amp;_connHandle; _requestPool.pRequestDatas[reqIndex].pConnConfig = &amp;_connConfig; _requestPool.pRequestDatas[reqIndex].reqNum = reqIndex; _requestPool.pRequestDatas[reqIndex].currRange = currentRange; _requestPool.pRequestDatas[reqIndex].currDownloaded = <span class="hljs-number"><span class="hljs-number">0</span></span>; _requestPool.pRequestDatas[reqIndex].numReqBytes = numReqBytes; .... _requestPool.pRequestDatas-&gt;scheduled = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; .... }</code> </pre> <br>  PVS-Studio a √©mis deux avertissements pour ce morceau de code: <br><br><ul><li>  V619 Le tableau '_requestPool.pRequestDatas' est utilis√© comme pointeur vers un seul objet.  iot_demo_https_s3_download_async.c 973 </li><li>  V574 Le pointeur '_requestPool.pRequestDatas' est utilis√© simultan√©ment comme tableau et comme pointeur vers un seul objet.  V√©rifiez les lignes: 931, 973. iot_demo_https_s3_download_async.c 973 </li></ul><br>  Au cas o√π, permettez-moi de vous rappeler: le nom du tableau est le pointeur sur son premier √©l√©ment.  Autrement dit, si <i>_requestPool.pRequestDatas</i> est un tableau de structures, <i>_requestPool.pRequestDatas [i] .scheduled</i> est une √©valuation du membre <i>planifi√©</i> de la structure du tableau <i>i.</i> <i>Et</i> si nous √©crivons <i>_requestPool.pRequestDatas-&gt; planifi√©</i> , il se r√©v√©lera que cela le membre √† savoir la premi√®re structure de tableau sera accessible. <br><br>  Dans l'extrait du code ci-dessus, c'est ce qui se passe.  Dans la derni√®re ligne, seule la valeur du membre de la premi√®re structure de tableau est modifi√©e.  En soi, un tel acc√®s est d√©j√† suspect, mais ici le cas est encore plus clair: le tableau <i>_requestPool.pRequestDatas</i> est √©valu√© par index dans tout le corps de la fonction.  Mais √† la fin l'op√©ration d'indexation a √©t√© oubli√©e. <br><br>  Si je comprends bien, la derni√®re ligne devrait ressembler √† ceci: <br><br><pre> <code class="cpp hljs">_requestPool.pRequestDatas[reqIndex].scheduled = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;</code> </pre> <br>  L'erreur suivante r√©side dans une petite fonction, donc je vais la donner compl√®tement: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* Return true if the string " pcString" is found * inside the token pxTok in JSON file pcJson. */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> BaseType_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prvGGDJsoneq</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * pcJson, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">jsmntok_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pxTok, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * pcString )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> ulStringSize = ( <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> ) pxTok-&gt;end - ( <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> ) pxTok-&gt;start; BaseType_t xStatus = pdFALSE; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( pxTok-&gt;type == JSMN_STRING ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( ( <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> ) <span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>( pcString ) == ulStringSize ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( ( <span class="hljs-keyword"><span class="hljs-keyword">int16_t</span></span> ) <span class="hljs-built_in"><span class="hljs-built_in">strncmp</span></span>( &amp;pcJson[ pxTok-&gt;start ], <span class="hljs-comment"><span class="hljs-comment">// &lt;= pcString, ulStringSize ) == 0 ) { xStatus = pdTRUE; } } } return xStatus; }</span></span></code> </pre> <br>  <b>Avertissement PVS-Studio:</b> V642 [CWE-197] L'enregistrement du r√©sultat de la fonction 'strncmp' dans la variable de type 'short' est inappropri√©.  Les bits significatifs pourraient √™tre perdus en brisant la logique du programme.  aws_greengrass_discovery.c 637 <br><br>  Jetons un coup d'≈ìil √† la d√©finition de la fonction strncmp: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">strncmp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *lhs, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *rhs, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> count )</span></span></span></span>;</code> </pre> <br>  Dans l'exemple, le r√©sultat du type <i>int</i> , d'une taille de 32 bits, est converti en une variable de type <i>int16_t</i> .  Avec cette conversion de "r√©tr√©cissement", les bits les plus anciens de la valeur retourn√©e seront perdus.  Par exemple, si la fonction <i>strncmp</i> renvoie <i>0x00010000</i> , l'unit√© sera perdue pendant la conversion et la condition sera ex√©cut√©e. <br><br>  C'est en fait √©trange de voir un tel casting dans l'√©tat.  Pourquoi est-il jamais n√©cessaire ici, si un <i>int</i> ordinaire peut √™tre compar√© √† z√©ro?  D'un autre c√¥t√©, si un programmeur voulait que cette fonction retourne parfois <i>true</i> m√™me si ce n'√©tait pas le cas, pourquoi ne pas supporter un comportement aussi d√©licat avec un commentaire?  Mais de cette fa√ßon, c'est une sorte de porte d√©rob√©e.  Quoi qu'il en soit, j'ai tendance √† penser que c'est une erreur.  Qu'en penses-tu? <br><br><h3>  Comportement et pointeurs ind√©finis </h3><br>  Voici un grand exemple.  Il recouvre une d√©r√©f√©rence potentielle de pointeur nul: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> _networkReceiveCallback(....) { IotHttpsReturnCode_t status = IOT_HTTPS_OK; _httpsResponse_t* pCurrentHttpsResponse = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; IotLink_t* pQItem = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; .... <span class="hljs-comment"><span class="hljs-comment">/* Get the response from the response queue. */</span></span> IotMutex_Lock(&amp;(pHttpsConnection-&gt;connectionMutex)); pQItem = IotDeQueue_PeekHead(&amp;(pHttpsConnection-&gt;respQ)); IotMutex_Unlock(&amp;(pHttpsConnection-&gt;connectionMutex)); <span class="hljs-comment"><span class="hljs-comment">/* If the receive callback is invoked * and there is no response expected, * then this a violation of the HTTP/1.1 protocol. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pQItem == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { IotLogError(....); fatalDisconnect = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; status = IOT_HTTPS_NETWORK_ERROR; <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> iotCleanup; } .... iotCleanup : <span class="hljs-comment"><span class="hljs-comment">/* Report errors back to the application. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (status != IOT_HTTPS_OK) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( pCurrentHttpsResponse-&gt;isAsync &amp;&amp; pCurrentHttpsResponse-&gt;pCallbacks-&gt;errorCallback) { pCurrentHttpsResponse-&gt;pCallbacks-&gt;errorCallback(....); } pCurrentHttpsResponse-&gt;syncStatus = status; } .... }</code> </pre> <br>  <b>Avertissement PVS-Studio:</b> V522 [CWE-690] Il peut y avoir un d√©r√©f√©rencement d'un pointeur nul potentiel 'pCurrentHttpsResponse'.  iot_https_client.c 1184 <br><br>  Le dernier bloc <i>if</i> contient des d√©r√©f√©rences probl√©matiques.  Voyons ce qui se passe ici. <br><br>  La fonction commence par les variables <i>pCurrentHttpsResponse</i> et <i>pQItem</i> initialis√©es par la valeur <i>NULL</i> et la variable d' <i>√©tat</i> est initialis√©e par la valeur <i>IOT_HTTPS_OK</i> , ce qui signifie que tout est correct. <br><br>  En outre, <i>pQItem</i> se voit attribuer la valeur, renvoy√©e par la fonction <i>IotDeQueue_PeekHead</i> , qui renvoie le pointeur au d√©but de la file d'attente √† double liaison. <br><br>  Que se passe-t-il si la file d'attente est vide?  Dans ce cas, la fonction <i>IotDeQueue_PeekHead</i> retournera <i>NULL:</i> <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> IotLink_t* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IotDeQueue_PeekHead</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> IotDeQueue_t* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pQueue)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> IotListDouble_PeekHead(pQueue); } .... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> IotLink_t* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IotListDouble_PeekHead</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> IotListDouble_t* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pList)</span></span></span><span class="hljs-function"> </span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment">/* @[declare_linear_containers_list_double_peekhead] */</span></span></span><span class="hljs-function"> </span></span>{ IotLink_t* pHead = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pList != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (IotListDouble_IsEmpty(pList) == <span class="hljs-literal"><span class="hljs-literal">false</span></span>) { pHead = pList-&gt;pNext; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pHead; }</code> </pre> <br>  De plus, la condition <i>pQItem == NULL</i> deviendra vraie et le flux de contr√¥le sera pass√© par <i>goto</i> √† la partie inf√©rieure de la fonction.  √Ä ce moment, le pointeur <i>pCurrentHttpsResponse</i> restera nul, tandis que le <i>statut</i> ne sera pas √©gal √† <i>IOT_HTTPS_OK</i> .  En fin de compte, nous arriverons au m√™me <i>si la</i> branche, et ... boum!  Eh bien, vous connaissez les cons√©quences d'une telle d√©r√©f√©rence. <br><br>  Ok  C'√©tait un exemple un peu d√©licat.  Maintenant, je vous sugg√®re de jeter un ≈ìil √† un d√©r√©f√©rencement potentiel tr√®s simple et compr√©hensible: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PKI_mbedTLSSignatureToPkcs11Signature</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * pxSignaturePKCS, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * pxMbedSignature )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> xReturn = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> * pxNextLength; <span class="hljs-comment"><span class="hljs-comment">/* The 4th byte contains the length of the R component */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> ucSigComponentLength = pxMbedSignature[ <span class="hljs-number"><span class="hljs-number">3</span></span> ]; <span class="hljs-comment"><span class="hljs-comment">// &lt;= if( ( pxSignaturePKCS == NULL ) || ( pxMbedSignature == NULL ) ) { xReturn = FAILURE; } .... }</span></span></code> </pre> <br>  <b>Avertissement PVS-Studio:</b> V595 [CWE-476] Le pointeur 'pxMbedSignature' a √©t√© utilis√© avant d'√™tre v√©rifi√© par rapport √† nullptr.  V√©rifiez les lignes: 52, 54. iot_pki_utils.c 52 <br><br>  Cette fonction re√ßoit des pointeurs vers <i>uint8_t</i> .  Les deux pointeurs sont v√©rifi√©s pour <i>NULL</i> , ce qui est une bonne pratique - de telles situations doivent √™tre r√©solues imm√©diatement. <br><br>  Mais voici le probl√®me: au moment o√π <i>pxMbedSignature</i> est v√©rifi√©, il sera d√©j√† d√©r√©f√©renc√© litt√©ralement une ligne au-dessus.  Ta-daa! <br><br>  Un autre exemple de code sp√©culatif: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">CK_RV </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">vAppendSHA256AlgorithmIdentifierSequence</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * x32ByteHashedMessage, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * x51ByteHashOidBuffer )</span></span></span><span class="hljs-function"> </span></span>{ CK_RV xResult = CKR_OK; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> xOidSequence[] = pkcs11STUFF_APPENDED_TO_RSA_SIG; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( ( x32ByteHashedMessage == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ) || ( x51ByteHashOidBuffer == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ) ) { xResult = CKR_ARGUMENTS_BAD; } <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>( x51ByteHashOidBuffer, xOidSequence, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>( xOidSequence ) ); <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>( &amp;x51ByteHashOidBuffer[ <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>( xOidSequence ) ], x32ByteHashedMessage, <span class="hljs-number"><span class="hljs-number">32</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> xResult; }</code> </pre> <br>  <b>Avertissements de PVS-Studio:</b> <br><br><ul><li>  V1004 [CWE-628] Le pointeur 'x51ByteHashOidBuffer' a √©t√© utilis√© de mani√®re non s√©curis√©e apr√®s avoir √©t√© v√©rifi√© par rapport √† nullptr.  V√©rifiez les lignes: 275, 280. iot_pkcs11.c 280 </li><li>  V1004 [CWE-628] Le pointeur 'x32ByteHashedMessage' a √©t√© utilis√© de mani√®re non s√©curis√©e apr√®s avoir √©t√© v√©rifi√© par rapport √† nullptr.  V√©rifiez les lignes: 275, 281. iot_pkcs11.c 281 </li></ul><br>  L'analyseur avertit que les param√®tres de fonction qui sont des pointeurs, ne sont pas utilis√©s en toute s√©curit√© apr√®s leur v√©rification de <i>NULL</i> .  En effet, les arguments sont v√©rifi√©s.  Mais dans le cas o√π l'un d'entre eux n'est pas <i>NULL</i> , aucune action n'est prise, sauf pour l'√©criture dans <i>xResult.</i>  Cette section du code dit en quelque sorte: "Ouais, donc les arguments se sont av√©r√©s mauvais.  Nous allons le noter maintenant, et vous - continuez, continuez. ¬ª <br><br>  R√©sultat: <i>NULL</i> sera transmis √† <i>memcpy.</i>  Que peut-il en r√©sulter?  O√π les valeurs seront-elles copi√©es et lesquelles?  En fait, deviner n'aidera pas, car la norme <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">stipule clairement</a> qu'un tel appel conduit √† un comportement ind√©fini (voir la section 1). <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/cf7/7d6/856/cf77d6856666f6a1529a1744832bd5bf.png" alt="Figure 3"></div><br><br>  Il existe d'autres exemples de gestion de pointeurs incorrects dans le rapport d'analyseur trouv√© dans Amazon FreeRTOS, mais je pense que les exemples donn√©s sont suffisants pour montrer les capacit√©s de PVS-Studio √† d√©tecter de telles erreurs.  Jetons un ≈ìil √† quelque chose de nouveau. <br><br><h3>  VRAI! = 1 </h3><br>  Il y avait plusieurs erreurs li√©es au mod√®le, qui, malheureusement, sont souvent n√©glig√©es. <br><br>  Le fait est que le type <i>bool</i> (de C ++) est diff√©rent du type <i>BOOL</i> (couramment utilis√© en C).  Le premier ne peut contenir qu'une valeur <i>vraie</i> ou <i>fausse</i> .  Le second est le typedef d'un type entier ( <i>int</i> , <i>long</i> et autres).  La valeur <i>0</i> est "fausse" pour elle, et toute autre valeur diff√©rente de z√©ro est "vraie". <br><br>  Puisqu'il n'y a pas de type bool√©en int√©gr√© en C, ces constantes sont d√©finies par commodit√©: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> FALSE 0 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> TRUE 1</span></span></code> </pre> <br>  Regardons l'exemple. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mbedtls_hardware_poll</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">* data, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* output, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> len, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* olen)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> lStatus = MBEDTLS_ERR_ENTROPY_SOURCE_FAILED; HCRYPTPROV hProv = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* Unferenced parameter. */</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)data; <span class="hljs-comment"><span class="hljs-comment">/* * This is port-specific for the Windows simulator, * so just use Crypto API. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (TRUE == CryptAcquireContextA( &amp;hProv, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, PROV_RSA_FULL, CRYPT_VERIFYCONTEXT)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (TRUE == CryptGenRandom(hProv, len, output)) { lStatus = <span class="hljs-number"><span class="hljs-number">0</span></span>; *olen = len; } CryptReleaseContext(hProv, <span class="hljs-number"><span class="hljs-number">0</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> lStatus; }</code> </pre> <br>  <b>Avertissements de PVS-Studio:</b> <br><br><ul><li>  V676 [CWE-253] Il est incorrect de comparer la variable de type BOOL avec TRUE.  aws_entropy_hardware_poll.c 48 </li><li>  V676 [CWE-253] Il est incorrect de comparer la variable de type BOOL avec TRUE.  L'expression correcte est: ¬´FAUX! = CryptGenRandom (hProv, len, output)¬ª.  aws_entropy_hardware_poll.c 51 </li></ul><br>  Avez-vous trouv√© une erreur?  Ne doutez pas, c'est ici :) Les fonctions <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><i>CryptAcquireContextA</i></a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><i>CryptGenRandom</i></a> sont des fonctions standard de l'en <i>-</i> t√™te <i>wincrypt.h</i> .  En cas de succ√®s, ils renvoient la valeur non nulle.  Permettez-moi de souligner qu'il est <i>non nul</i> .  Donc, th√©oriquement, cela pourrait √™tre n'importe quelle valeur diff√©rente de z√©ro: <i>1</i> , <i>314</i> , <i>42</i> , <i>420</i> . <br><br>  Apparemment, le programmeur qui √©crivait la fonction de l'exemple ne pensait pas √† cela, et √† la fin, les valeurs r√©sultantes sont compar√©es √† une. <br><br>  Quelle est la probabilit√© que la condition <i>VRAI == CryptGenRandom (....)</i> ne soit pas remplie?  C'est difficile √† dire.  Peut-√™tre, <i>CryptGenRandom</i> pourrait renvoyer 1 plus souvent que les autres valeurs, mais peut-√™tre qu'il n'en retournera que 1. Nous ne pouvons pas le savoir avec certitude: la mise en ≈ìuvre de cette fonction cryptographique est cach√©e aux yeux des programmeurs mortels :) <br><br>  Il est important de se rappeler que de telles comparaisons sont potentiellement dangereuses.  Au lieu de: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (TRUE == GetBOOL())</code> </pre> <br>  Utilisez une version plus s√ªre du code: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (FALSE != GetBOOL())</code> </pre> <br><h3>  Probl√®mes d'optimisation </h3><br>  Plusieurs avertissements de l'analyseur √©taient li√©s √† des structures √† fonctionnement lent.  Par exemple: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _IotHttpsDemo_GetS3ObjectFileSize(....) { .... pFileSizeStr = <span class="hljs-built_in"><span class="hljs-built_in">strstr</span></span>(contentRangeValStr, <span class="hljs-string"><span class="hljs-string">"/"</span></span>); .... }</code> </pre> <br>  <b>Avertissement PVS-Studio:</b> V817 Il est plus efficace de rechercher un caract√®re '/' plut√¥t qu'une cha√Æne.  iot_demo_https_common.c 205 <br><br>  C'est court et simple, non?  La fonction <i>strstr</i> est utilis√©e ici pour rechercher un seul caract√®re, pass√© dans le param√®tre sous forme de cha√Æne (c'est entre guillemets). <br><br>  Cet endroit peut potentiellement √™tre optimis√© en rempla√ßant <i>strstr</i> par <i>strchr</i> : <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _IotHttpsDemo_GetS3ObjectFileSize(....) { .... pFileSizeStr = <span class="hljs-built_in"><span class="hljs-built_in">strchr</span></span>(contentRangeValStr, <span class="hljs-string"><span class="hljs-string">'/'</span></span>); .... }</code> </pre> <br>  De cette fa√ßon, la recherche fonctionnera un peu plus rapidement.  Une petite mais jolie chose. <br><br>  Eh bien, ces optimisations sont bonnes, mais l'analyseur a √©galement trouv√© un autre endroit, qui pourrait √™tre optimis√© de mani√®re beaucoup plus notable: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">vRunOTAUpdateDemo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (; ; ) { .... xConnectInfo.cleanSession = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; xConnectInfo.clientIdentifierLength = (<span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span>)<span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>(clientcredentialIOT_THING_NAME); xConnectInfo.pClientIdentifier = clientcredentialIOT_THING_NAME; .... } }</code> </pre> <br>  <b>Avertissement PVS-Studio:</b> V814 Baisse des performances.  La fonction 'strlen' a √©t√© appel√©e plusieurs fois √† l'int√©rieur du corps d'une boucle.  aws_iot_ota_update_demo.c 235 <br><br>  Hmm ... A l'int√©rieur de la boucle, √† chaque it√©ration, un <i>strlen</i> est appel√© qui √©value la longueur de la m√™me ligne √† chaque fois.  Pas l'op√©ration la plus efficace :) <br><br>  Regardons √† l'int√©rieur de la d√©finition de <i>clientcredentialIOT_THING_NAME</i> : <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* * @brief Host name. * * @todo Set this to the unique name of your IoT Thing. */</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> clientcredentialIOT_THING_NAME </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">""</span></span></span></span></code> </pre> <br>  L'utilisateur est invit√© √† saisir le nom de son appareil ici.  Par d√©faut, il est vide, et dans ce cas, tout va bien.  Et si un utilisateur veut y entrer un nom long et beau?  Par exemple, j'aimerais appeler mon id√©e originale " <i>La machine √† caf√© passionn√©e et sophistiqu√©e BarBarista-N061E The Ultimate Edition</i> ".  Pouvez-vous imaginer ce que serait ma surprise si ma belle machine √† caf√© commen√ßait √† fonctionner un peu plus lentement apr√®s cela?  Nuisance! <br><br>  Pour corriger l'erreur, il vaut la peine de sortir <i>strlen</i> hors de la boucle du corps.  Apr√®s tout, le nom de l'appareil ne change pas pendant le fonctionnement du programme.  Oh, <i>constexpr</i> de C ++ conviendrait parfaitement ici ... <br><br>  Bon, eh bien, ne dorons pas le lis.  Comme mon coll√®gue Andrey Karpov l'a not√©, les compilateurs modernes savent ce qui est <i>strlen</i> et il les a personnellement regard√©s en utilisant une constante en code binaire s'ils constatent que la longueur de la ligne ne peut pas changer.  Il y a donc de fortes chances que dans le mode de g√©n√©ration de version, au lieu d'une √©valuation de la longueur de ligne r√©elle, la valeur pr√©-√©valu√©e soit utilis√©e.  Cependant, cela ne fonctionne pas toujours, donc l'√©criture d'un tel code n'est pas une bonne pratique. <br><br><h2>  Quelques mots sur MISRA </h2><br>  L'analyseur PVS-Studio dispose d'un large ensemble de r√®gles pour v√©rifier la conformit√© de votre code avec les normes MISRA C et MISRA C.  Quelles sont ces normes? <br><br>  MISRA est la norme de codage pour les syst√®mes embarqu√©s hautement responsables.  Il contient un ensemble de r√®gles et de directives strictes pour l'√©criture de code et la mise en place d'un processus de d√©veloppement.  Ces r√®gles sont nombreuses et visent non seulement √† √©liminer les erreurs graves, mais aussi √† diverses "odeurs de code".  Il vise √©galement √† √©crire le code le plus compr√©hensible et lisible. <br><br>  Ainsi, la norme MISRA suivante permet non seulement d'√©viter les erreurs et les vuln√©rabilit√©s, mais √©galement de r√©duire consid√©rablement la probabilit√© de leur apparition dans le code d√©j√† existant. <br><br>  MISRA est utilis√© dans les industries a√©rospatiale, m√©dicale, automobile et militaire, o√π la vie humaine d√©pend de la qualit√© des logiciels embarqu√©s. <br><br>  Apparemment, les d√©veloppeurs d'Amazon FreeRTOS connaissent cette norme et la suivent pour la plupart.  Une telle approche est absolument raisonnable: si vous √©crivez un syst√®me d'exploitation √©tendu pour les syst√®mes embarqu√©s, vous devez alors penser √† la s√©curit√©. <br><br>  Cependant, j'ai trouv√© pas mal de violations de la norme MISRA.  Je ne vais pas donner d'exemples de r√®gles comme "ne pas utiliser l'union" ou "la fonction ne devrait avoir qu'un seul retour √† la fin du corps" - malheureusement, elles ne sont pas spectaculaires, comme le sont la plupart des r√®gles MISRA.  Je pr√©f√®re vous donner des exemples de violations qui pourraient potentiellement entra√Æner de graves cons√©quences. <br><br>  Commen√ßons par les macros: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> FreeRTOS_ms_to_tick(ms) ( ( ms * configTICK_RATE_HZ + 500 ) / 1000 )</span></span></code> </pre> <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SOCKETS_htonl( ulIn ) ( ( uint32_t ) \ ( ( ( ulIn &amp; 0xFF ) </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;&lt; 24 ) | ( ( ulIn &amp; 0xFF00 ) &lt;&lt; 8 ) \ | ( ( ulIn &amp; 0xFF0000 ) &gt;&gt; 8 ) | ( ( ulIn &amp; 0xFF000000 ) &gt;&gt; 24 ) ) )</span></span></span></span></code> </pre> <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LEFT_ROTATE( x, c ) ( ( x </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;&lt; c ) | ( x &gt;&gt; ( 32 - c ) ) )</span></span></span></span></code> </pre> <br>  <b>Avertissements de PVS-Studio:</b> <br><br><ul><li>  V2546 [MISRA C 20.7] La ‚Äã‚Äãmacro et ses param√®tres doivent √™tre plac√©s entre parenth√®ses.  Pensez √† inspecter le param√®tre ¬´ms¬ª de la macro ¬´FreeRTOS_ms_to_tick¬ª.  FreeRTOS_IP.h 201 </li><li>  V2546 [MISRA C 20.7] La ‚Äã‚Äãmacro et ses param√®tres doivent √™tre plac√©s entre parenth√®ses.  Pensez √† inspecter le param√®tre 'ulIn' de la macro 'SOCKETS_htonl'.  iot_secure_sockets.h 512 </li><li>  V2546 [MISRA C 20.7] La ‚Äã‚Äãmacro et ses param√®tres doivent √™tre plac√©s entre parenth√®ses.  Pensez √† inspecter les param√®tres ¬´x¬ª, ¬´c¬ª de la macro ¬´LEFT_ROTATE¬ª.  iot_device_metrics.c 90 </li></ul><br>  Oui, c'est exactement ce que tu penses.  Les param√®tres de ces macros ne sont pas entre crochets.  Si quelqu'un √©crit accidentellement quelque chose comme <br><br><pre> <code class="cpp hljs">val = LEFT_ROTATE(A[i] | <span class="hljs-number"><span class="hljs-number">1</span></span>, B);</code> </pre> <br>  un tel "appel" d'une macro se d√©veloppera en: <br><br><pre> <code class="cpp hljs">val = ( ( A[i] | <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; B ) | ( A[i] | <span class="hljs-number"><span class="hljs-number">1</span></span> &gt;&gt; ( <span class="hljs-number"><span class="hljs-number">32</span></span> - B ) ) );</code> </pre> <br>  Rappelez-vous les priorit√©s des op√©rations?  Tout d'abord, un d√©calage au niveau du bit est effectu√©, et seulement apr√®s - un "ou" au niveau du bit.  Par cons√©quent, la logique du programme sera rompue.  Un exemple plus simple: que se passerait-il si l'expression " <i>x + y</i> " √©tait pass√©e dans la macro <i>FreeRTOS_ms_to_tick</i> ?  L'un des principaux objectifs de MISRA est de pr√©venir de telles situations. <br><br>  Certains pourraient dire: "Si vous avez des programmeurs qui ne connaissent pas cela, aucune norme ne peut vous aider!"  Je ne suis pas d'accord avec √ßa.  Les programmeurs sont aussi des gens, et peu importe l'exp√©rience d'une personne, ils peuvent aussi se fatiguer et faire une erreur √† la fin de la journ√©e.  C'est l'une des raisons pour lesquelles MISRA recommande fortement d'utiliser des outils d'analyse automatique pour tester la conformit√© d'un projet. <br><br>  Permettez-moi de m'adresser aux d√©veloppeurs d'Amazon FreeRTOS: PVS-Studio a trouv√© 12 autres macros dangereuses, vous devez donc faire attention avec elles :) <br><br>  Une autre violation int√©ressante de la MISRA: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/** * @brief Callback for an asynchronous request to notify * that the response is complete. * * @param[in] 0pPrivData - User private data configured * with the HTTPS Client library request configuration. * @param[in] respHandle - Identifier for the current response finished. * @param[in] rc - Return code from the HTTPS Client Library * signaling a possible error. * @param[in] status - The HTTP response status. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> _responseCompleteCallback(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>* pPrivData, IotHttpsResponseHandle_t respHandle, IotHttpsReturnCode_t rc, <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> status) { <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>* pUploadSuccess = (<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>*)pPrivData; <span class="hljs-comment"><span class="hljs-comment">/* When the remote server response with 200 OK, the file was successfully uploaded. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (status == IOT_HTTPS_STATUS_OK) { *pUploadSuccess = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { *pUploadSuccess = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/* Post to the semaphore that the upload is finished. */</span></span> IotSemaphore_Post(&amp;(_uploadFinishedSem)); }</code> </pre> <br>  Pouvez-vous trouver le bug vous-m√™me? <br><br>  <b>Avertissement PVS-Studio:</b> V2537 [MISRA C 2.7] Les fonctions ne doivent pas avoir de param√®tres inutilis√©s.  Pensez √† inspecter le param√®tre: ¬´rc¬ª.  iot_demo_https_s3_upload_async.c 234 <br><br>  Regardez de plus pr√®s: le param√®tre <i>rc</i> n'est utilis√© nulle part dans le corps de la fonction.  Alors que le commentaire de la fonction indique clairement que ce param√®tre est un code retour d'une autre fonction, et qu'il peut signaler une erreur.  Pourquoi ce param√®tre n'est-il g√©r√© d'aucune fa√ßon?  Quelque chose cloche clairement ici. <br><br>  Cependant, m√™me sans de tels commentaires, les param√®tres inutilis√©s indiquent souvent la logique bris√©e du programme.  Sinon, pourquoi en avez-vous besoin dans la signature de fonction? <br><br>  Ici, j'ai donn√© une petite fonction qui est bonne pour un exemple dans l'article.  En plus de cela, j'ai trouv√© 10 autres param√®tres inutilis√©s.  Beaucoup d'entre eux sont utilis√©s dans des fonctions plus importantes et il n'est pas facile de les d√©tecter. <br><br>  Curieusement, ils n'ont jamais √©t√© trouv√©s auparavant.  Apr√®s tout, les compilateurs d√©tectent facilement de tels cas. <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b80/6c7/bb9/b806c7bb94c335ce2712e9b46cffc560.png" alt="Figure 1"></div><br><br><h2>  Conclusion </h2><br>  Ce ne sont pas tous les probl√®mes trouv√©s par l'analyseur, mais l'article s'est d√©j√† r√©v√©l√© assez volumineux.  J'esp√®re que gr√¢ce √† cela, les d√©veloppeurs d'Amazon FreeRTOS seront en mesure de corriger certaines lacunes et pourraient m√™me vouloir <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">essayer PVS-Studio</a> par eux-m√™mes.  De cette fa√ßon, il sera plus pratique d'enqu√™ter de mani√®re approfondie sur les avertissements.  Et en fait - travailler avec une interface pratique est beaucoup plus facile que de regarder un rapport texte. <br><br>  Merci d'avoir lu nos articles!  Rendez-vous dans la prochaine publication: D <br><br>  PS Il se trouve que cet article a √©t√© publi√© le 31 octobre. Joyeux Halloween, les gars et les filles! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr473966/">https://habr.com/ru/post/fr473966/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr473952/index.html">Comme j'ai √©crit l'IA pour la strat√©gie au tour par tour</a></li>
<li><a href="../fr473956/index.html">Informations secr√®tes d'une compagnie de t√©l√©phone de trafiquants de drogue</a></li>
<li><a href="../fr473958/index.html">Le japonais de NICT a pr√©sent√© un cluster de fibres de travail avec une bande passante de 1 Pbit / s</a></li>
<li><a href="../fr473960/index.html">Strat√©gies de localisation de contenu</a></li>
<li><a href="../fr473962/index.html">Le mode sombre est maintenant partout. Est-ce si utile? (√† la fin de l'enqu√™te post√©rieure)</a></li>
<li><a href="../fr473972/index.html">Par ordre des d√©veloppeurs Embedded: recherche de bogues dans Amazon FreeRTOS</a></li>
<li><a href="../fr473974/index.html">Intercom'19 - une conf√©rence sur l'automatisation des communications de Voximplant aura lieu le 14 novembre</a></li>
<li><a href="../fr473976/index.html">AWS Elasticsearch: produit fondamentalement d√©fectueux</a></li>
<li><a href="../fr473978/index.html">Une telle douleur, une telle douleur, une caisse enregistreuse 2: 0</a></li>
<li><a href="../fr473980/index.html">La technologie et le monde r√©el: 4 start-ups qui changent l'avenir du design d'int√©rieur</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>