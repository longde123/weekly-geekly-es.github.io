<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëãüèø üíÄ üì¥ R√©plication logique entre les versions de PostgreSQL üë®üèº‚Äçüéì üëµüèª üç®</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Il existe diff√©rentes approches pour mettre √† jour PostgreSQL, mais certaines entra√Ænent des temps d'arr√™t. Si vous souhaitez √©viter les temps d'arr√™t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>R√©plication logique entre les versions de PostgreSQL</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/southbridge/blog/457512/"><p><img src="https://habrastorage.org/webt/yl/pr/hs/ylprhs3ilpoukerjhyvwdnj6kmu.png"></p><br><p>  Il existe diff√©rentes approches pour mettre √† jour PostgreSQL, mais certaines entra√Ænent des temps d'arr√™t.  Si vous souhaitez √©viter les temps d'arr√™t, utilisez la r√©plication pour la mise √† niveau - logique ou physique (streaming), selon le sc√©nario.  Dans cet article, nous examinerons la diff√©rence entre la r√©plication logique et physique dans PostgreSQL.  Ensuite, nous expliquerons en d√©tail comment mettre √† jour la version √† l'aide de la r√©plication logique tout en √©vitant les temps d'arr√™t des applications.  Le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">prochain article traitera</a> de la r√©plication physique. </p><br><p>  Dans les articles pr√©c√©dents, nous avons d√©j√† parl√© des m√©thodes de mise √† jour de PostgreSQL ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">mise √† niveau de PostgreSQL √† l'aide de pg_dumpall</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">mise √† niveau de PostgreSQL √† l'aide de pg_dump / pg_restore</a> ) dans le cadre de la s√©rie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">mise √† niveau ou migration d'anciennes versions de PostgreSQL</a> .  Mais ces deux m√©thodes n'excluent pas les temps d'arr√™t. </p><a name="habracut"></a><br><h2 id="tipy-logicheskoy-replikacii">  Types de r√©plication logique </h2><br><p>  Nous discutons ici de 2 types de r√©plication: </p><br><ul><li>  R√©plication entre PostgreSQL 10 et 11 √† l'aide de la r√©plication logique int√©gr√©e. </li><li>  R√©plication entre PostgreSQL 9.4 (ou ant√©rieur √† PG 11) et PostgreSQL 11 √† l'aide de l'extension <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pglogical</a> . </li></ul><br><p>  Pour minimiser les temps d'arr√™t, vous pouvez mettre √† niveau √† l'aide de la r√©plication.  Lorsque toutes les donn√©es pertinentes sont r√©pliqu√©es sur un autre dernier serveur PostgreSQL, vous transf√©rez simplement l'application vers le nouveau serveur avec un temps d'arr√™t minimal - bien que, bien s√ªr, tout d√©pend de la complexit√© de la pile d'applications. </p><br><p>  <strong>La r√©plication logique</strong> dans PostgreSQL permet aux utilisateurs de r√©pliquer de mani√®re s√©lective des tables et d'ouvrir un serveur de sauvegarde pour les op√©rations d'√©criture.  <strong>La r√©plication physique</strong> dans PostgreSQL se fait en blocs.  Dans ce cas, chaque base de donn√©es de l'assistant est r√©pliqu√©e sur le serveur de sauvegarde, inaccessible aux op√©rations d'√©criture.  Ensuite, nous appellerons le <strong>streaming de</strong> r√©plication physique. </p><br><p> Lorsque vous utilisez la r√©plication logique sur un serveur de secours, vous pouvez activer la r√©plication √† partir de plusieurs ma√Ætres.  Ceci est utile dans les situations o√π vous devez r√©pliquer des donn√©es de plusieurs bases de donn√©es PostgreSQL (OLTP) vers un seul serveur PostgreSQL pour les rapports et le stockage des donn√©es. </p><br><p>  Le principal avantage de la r√©plication logique par rapport au streaming est qu'avec la r√©plication logique, vous pouvez r√©pliquer les modifications de l'ancienne version de PostgreSQL vers la nouvelle.  La r√©plication de flux ne fonctionne que lorsque le ma√Ætre et le serveur de sauvegarde ont la m√™me version principale.  Id√©alement, des versions suppl√©mentaires devraient √©galement correspondre. </p><br><h3 id="replikaciya-mezhdu-versiyami-postgresql-10-i-11">  R√©plication entre PostgreSQL 10 et 11 </h3><br><p>  √Ä partir de PostgreSQL 10, la r√©plication logique est disponible par d√©faut.  Par cons√©quent, vous pouvez facilement r√©pliquer la base de donn√©es PostgreSQL 10 dans PostgreSQL 11. La r√©plication logique utilise le mod√®le de publication et d'abonnement.  Le n≈ìud qui soumet les modifications devient l'√©diteur.  Et le n≈ìud abonn√© √† ces modifications devient un abonn√©.  Il peut y avoir plusieurs abonnements par publication. </p><br><h3 id="publikaciya">  Publication </h3><br><p>  Une publication est un tableau de modifications cr√©√© par un groupe de tables.  Il s'agit d' <strong>un</strong> <strong>ensemble de</strong> <strong>modifications</strong> ou d' <strong>un</strong> <strong>ensemble de r√©plication</strong> .  Les publications ne peuvent contenir que des tableaux, mais pas d'autres objets.  DML dans ces tables peut √™tre r√©pliqu√©, mais DDL ne peut pas. </p><br><p>  Dans la publication, vous pouvez choisir le type de DML √† r√©pliquer: INS√âRER, SUPPRIMER, METTRE √Ä JOUR ou TOUT.  Par d√©faut, ALL est s√©lectionn√©.  La table doit avoir un identifiant de r√©plique afin de r√©pliquer les op√©rations UPDATE et DELETE sur l'abonn√©.  Les identificateurs de r√©pliques vous aident √† trouver les lignes mises √† jour ou supprim√©es. </p><br><p>  La cl√© primaire de la table est l'identifiant de r√©plique par d√©faut.  Ou vous pouvez faire de l'identifiant un index unique avec des valeurs NOT NULL.  Si vous n'avez pas de cl√© primaire ou d'index unique sans valeurs NULL, d√©finissez replica_identity sur FULL.  Dans ce cas, Postgres utilise la cha√Æne enti√®re comme cl√©.  Mais ce n'est pas tr√®s rationnel. </p><br><p>  Si une table sans cl√© primaire et identificateur de r√©plique est ajout√©e √† la publication par d√©faut apr√®s une op√©ration UPDATE ou DELETE, des erreurs peuvent se produire. </p><br><h3 id="podpiska">  Abonnement </h3><br><p>  Un abonn√© peut s'abonner √† une ou plusieurs publications.  Avant d'ajouter un abonnement, assurez-vous que les tables r√©pliqu√©es sont cr√©√©es sur le n≈ìud d'abonn√©.  Pour ce faire, videz uniquement les sch√©mas de l'√©diteur vers l'abonn√©. </p><br><h3 id="primer-logicheskoy-replikacii">  Exemple de r√©plication logique </h3><br><p>  <strong>L'exemple suivant d√©crit la r√©plication logique uniquement entre les versions 10 et 11 de PostgreSQL.</strong> </p><br><p>  Cr√©ez une publication sur le site de l'√©diteur.  Ajoutez tous ou seulement quelques tableaux √† la publication. </p><br><pre><code class="plaintext hljs">-- For adding ALL Tables in Database CREATE PUBLICATION percpub FOR ALL TABLES; -- For adding Selected Tables in Database CREATE PUBLICATION percpub FOR TABLE scott.employee scott.departments;</code> </pre> <br><p>  Sur le site abonn√©, cr√©ez un abonnement √† cette publication.  Effectuez un vidage DDL des tables sur l'abonn√© avant de cr√©er l'abonnement, comme mentionn√© ci-dessus. </p><br><pre> <code class="plaintext hljs">$ pg_dump -h publisher_server_ip -p 5432 -d percona -Fc -s -U postgres | pg_restore -d percona -h subscriber_node_ip -p 5432 -U postgres CREATE SUBSCRIPTION percsub CONNECTION 'host=publisher_server_ip dbname=percona user=postgres password=secret port=5432' PUBLICATION percpub;</code> </pre> <br><p>  Cette commande copie √©galement les donn√©es existantes dans les tables.  Si vous souhaitez d√©sactiver la copie des donn√©es existantes, utilisez la commande suivante et seules les modifications apport√©es √† l'√©diteur seront copi√©es. </p><br><pre> <code class="plaintext hljs">CREATE SUBSCRIPTION percsub CONNECTION 'host=publisher_server_ip dbname=percona user=postgres password=oracle port=5432' PUBLICATION percpub WITH (copy_data = false);</code> </pre> <br><p>  Suivez la r√©plication √† l'aide de la commande suivante dans le n≈ìud de l'√©diteur: </p><br><pre> <code class="plaintext hljs">$ psql \x select * from pg_stat_replication;</code> </pre> <br><h3 id="replikaciya-mezhdu-postgresql-94-i-postgresql-11">  R√©plication entre PostgreSQL 9.4 et PostgreSQL 11 </h3><br><p>  Que faire avec les versions ant√©rieures √† PostgreSQL 10?  Pour les versions 9.4 √† 11, il existe une extension sp√©ciale - <code>pglogical</code> .  En utilisant pglogical, vous pouvez r√©pliquer PostgreSQL 9.4 vers PostgreSQL 11 de deux mani√®res. </p><br><p>  Voici des instructions g√©n√©rales pour configurer la r√©plication entre PG 9.4 et PG 11 √† l'aide de l'extension <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pglogical</a> . </p><br><p>  <strong>√âtape 1.</strong> Consid√©rez pgserver_94 comme serveur source avec la base de donn√©es percona_94 sur PostgreSQL 9.4.  Cr√©ez l'extension suivante. <br>  code </p><br><pre> <code class="plaintext hljs">[pgserver_94:] $psql -d percona_94 -c "CREATE EXTENSION pglogical_origin" CREATE EXTENSION [pgserver_94:] $psql -d percona_94 -c "CREATE EXTENSION pglogical" CREATE EXTENSION</code> </pre> <br><p>  <strong>√âtape 2.</strong> Ajoutez maintenant tout ou partie des tables au sch√©ma ou √† plusieurs sch√©mas pour la r√©plication.  Dans l'exemple suivant, vous voyez une erreur car l'une des tables n'a pas de cl√© primaire. </p><br><pre> <code class="plaintext hljs">[pgserver_94:] $psql -d percona_94 psql (9.4.21) Type "help" for help. percona_94=# SELECT pglogical.create_node(node_name := 'provider1',dsn := 'host=192.168.0.24 port=5432 dbname=percona_94'); create_node ------------- 2976894835 (1 row) percona_94=# SELECT pglogical.replication_set_add_all_tables('default', ARRAY['public']); ERROR: table pgbench_history cannot be added to replication set default DETAIL: table does not have PRIMARY KEY and given replication set is configured to replicate UPDATEs and/or DELETEs HINT: Add a PRIMARY KEY to the table percona_94=# ALTER TABLE pgbench_history ADD PRIMARY KEY (tid,aid,delta); ALTER TABLE percona_94=# SELECT pglogical.replication_set_add_all_tables('default', ARRAY['public']); replication_set_add_all_tables -------------------------------- t (1 row)</code> </pre> <br><p>  <strong>√âtape 3.</strong> Sur le n≈ìud d'abonn√©, c'est-√†-dire dans la base de donn√©es PostgreSQL 11, ex√©cutez les commandes suivantes. </p><br><pre> <code class="plaintext hljs">[pgserver_11:] $psql -d percona_11 psql (11.2) Type "help" for help. percona_11=# SELECT pglogical.create_node(node_name := 'subscriber1',dsn := 'host=127.0.0.1 port=5432 dbname=percona_11 password=secret'); create_node ------------- 330520249 (1 row) percona_11=# SELECT pglogical.create_subscription(subscription_name := 'subscription1',provider_dsn := 'host=192.168.0.24 port=5432 dbname=percona_94 password=secret'); create_subscription --------------------- 1763399739 (1 row)</code> </pre> <br><p>  <strong>√âtape 4.</strong> V√©rifiez ensuite l'√©tat de la r√©plication en envoyant une demande √† plusieurs tables, que pglogical met toujours √† jour: </p><br><pre> <code class="plaintext hljs">percona_11=# select * from pglogical.local_sync_status; sync_kind | sync_subid | sync_nspname | sync_relname | sync_status | sync_statuslsn -----------+------------+--------------+------------------+-------------+---------------- f | 1763399739 | public | pgbench_accounts | r | 0/2EB7D48 f | 1763399739 | public | pgbench_history | r | 0/2EB7D48 f | 1763399739 | public | pgbench_tellers | r | 0/2EB7D48 f | 1763399739 | public | pgbench_branches | r | 0/2EB7D48 d | 1763399739 | | | r | 0/0 (5 rows) percona_11=# select * from pglogical.subscription; sub_id | sub_name | sub_origin | sub_target | sub_origin_if | sub_target_if | sub_enabled | sub_slot_name | sub_rep lication_sets | sub_forward_origins | sub_apply_delay ------------+---------------+------------+------------+---------------+---------------+-------------+----------------------------------------+---------------- -----------------------+---------------------+----------------- 1763399739 | subscription1 | 2976894835 | 330520249 | 2402836775 | 2049915666 | t | pgl_percona_11_provider1_subscription1 | {default,defaul t_insert_only,ddl_sql} | {all} | 00:00:00 (1 row)</code> </pre> <br><h3 id="vybor-pervichnogo-klyucha">  S√©lection de la cl√© primaire </h3><br><p>  Dans la deuxi√®me √©tape, vous avez vu comment toutes les tables du sch√©ma public ont √©t√© ajout√©es au jeu de r√©plication en cr√©ant une cl√© primaire pour une table qui n'en avait pas.  J'ai peut-√™tre choisi la mauvaise cl√© primaire pour cette table, mais c'est juste pour la d√©monstration.  Lorsque vous choisissez une cl√© primaire, assurez-vous qu'elle est correcte.  Il doit √™tre unique et utiliser des colonnes qui ne contiennent pas de valeurs NULL.  Si vous ne trouvez pas la cl√© primaire correcte, cela peut entra√Æner un temps d'arr√™t de l'application.  Voici un exemple d'erreur qui peut se produire: </p><br><pre> <code class="plaintext hljs">[pgserver_94:] $pgbench -c 10 -T 300 -n percona_94 Client 7 aborted in state 12: ERROR: duplicate key value violates unique constraint "pgbench_history_pkey" DETAIL: Key (tid, aid, delta)=(7, 63268, 2491) already exists.</code> </pre> <br><p>  Voici comment utiliser pglogical pour cr√©er une r√©plication entre l'ancienne et la nouvelle version de PostgreSQL.  Apr√®s avoir configur√© la r√©plication, basculez simplement les applications vers la derni√®re version afin que le temps d'arr√™t soit minimal. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr457512/">https://habr.com/ru/post/fr457512/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr457490/index.html">Aisioshechka de Zuckerberg - bri√®vement et dans le cas de la Balance</a></li>
<li><a href="../fr457500/index.html">Comment nous avons fait le pilote automatique pour une station-service</a></li>
<li><a href="../fr457502/index.html">Comment le mod√®le de notation RICE am√©liore la hi√©rarchisation des fonctionnalit√©s du produit</a></li>
<li><a href="../fr457504/index.html">Pourquoi √©crire votre grille de donn√©es React en 2019</a></li>
<li><a href="../fr457510/index.html">Utilisez mcrouter pour faire √©voluer horizontalement memcached</a></li>
<li><a href="../fr457514/index.html">Nevanger</a></li>
<li><a href="../fr457516/index.html">√âcrire un mod√®le de menace</a></li>
<li><a href="../fr457518/index.html">Plasma Cash Chain comme solution au trilemme d'√©volutivit√© de la blockchain</a></li>
<li><a href="../fr457522/index.html">Augmentez votre service de liste de diffusion ou utilisez des solutions toutes faites? Ce que j'ai appris pendant 5 ans chez UniSender</a></li>
<li><a href="../fr457524/index.html">Cam√©ras de profondeur - r√©volution silencieuse (quand les robots verront) Partie 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>