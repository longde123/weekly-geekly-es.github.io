<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ¥ ğŸŒªï¸ ğŸ§›ğŸ¿ æˆ‘ä»¬å¦‚ä½•è”ç³»æ™®ç½—ç±³ä¿®æ–¯ ğŸ‘©â€ğŸŒ¾ â˜£ï¸ ğŸ‘</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="æˆ‘ä¸å¾—ä¸ä»¥æŸç§æ–¹å¼å¤„ç†APIçš„æŒ‡æ ‡ï¼Œå°±åƒå¾€å¸¸ä¸€æ ·ï¼ˆæ²¡æœ‰æ—¶é—´ï¼Ÿï¼ï¼‰åœ¨ä»¥åæ·»åŠ -è¿™å¾ˆå›°éš¾å¹¶ä¸”å°šæœªå®ç°-è¿™æ„å‘³ç€æ˜¯æ—¶å€™å®ç°å®ƒäº†ã€‚ åœ¨ç½‘ä¸Šå¾˜å¾Šäº†ä¸€æ®µæ—¶é—´ä¹‹åï¼Œåœ¨æˆ‘çœ‹æ¥ï¼Œæœ€æµè¡Œçš„ç›‘è§†ç³»ç»Ÿæ˜¯æ™®ç½—ç±³ä¿®æ–¯ã€‚ 


 ä½¿ç”¨Prometheusï¼Œæˆ‘ä»¬å¯ä»¥ç›‘è§†å„ç§è®¡ç®—æœºèµ„æºï¼Œä¾‹å¦‚ï¼šå†…å­˜ï¼Œå¤„ç†å™¨ï¼Œç£ç›˜ï¼Œç½‘ç»œè´Ÿè½½ã€‚ å¯¹æˆ‘ä»¬è€Œ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>æˆ‘ä»¬å¦‚ä½•è”ç³»æ™®ç½—ç±³ä¿®æ–¯</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/475600/"><p>æˆ‘ä¸å¾—ä¸ä»¥æŸç§æ–¹å¼å¤„ç†APIçš„æŒ‡æ ‡ï¼Œå°±åƒå¾€å¸¸ä¸€æ ·ï¼ˆæ²¡æœ‰æ—¶é—´ï¼Ÿï¼ï¼‰åœ¨ä»¥åæ·»åŠ -è¿™å¾ˆå›°éš¾å¹¶ä¸”å°šæœªå®ç°-è¿™æ„å‘³ç€æ˜¯æ—¶å€™å®ç°å®ƒäº†ã€‚ åœ¨ç½‘ä¸Šå¾˜å¾Šäº†ä¸€æ®µæ—¶é—´ä¹‹åï¼Œåœ¨æˆ‘çœ‹æ¥ï¼Œæœ€æµè¡Œçš„ç›‘è§†ç³»ç»Ÿæ˜¯æ™®ç½—ç±³ä¿®æ–¯ã€‚ </p><br><p> ä½¿ç”¨Prometheusï¼Œæˆ‘ä»¬å¯ä»¥ç›‘è§†å„ç§è®¡ç®—æœºèµ„æºï¼Œä¾‹å¦‚ï¼šå†…å­˜ï¼Œå¤„ç†å™¨ï¼Œç£ç›˜ï¼Œç½‘ç»œè´Ÿè½½ã€‚ å¯¹æˆ‘ä»¬è€Œè¨€ï¼Œè®¡ç®—å¯¹APIæ–¹æ³•çš„è°ƒç”¨æ¬¡æ•°æˆ–è¡¡é‡å…¶æ‰§è¡Œæ—¶é—´å¯èƒ½ä¹Ÿå¾ˆé‡è¦ï¼Œå› ä¸ºç³»ç»Ÿä¸Šçš„è´Ÿè½½è¶Šå¤§ï¼Œå…¶åœæœºæ—¶é—´å°±è¶Šæ˜‚è´µã€‚ æ™®ç½—ç±³ä¿®æ–¯åœ¨è¿™é‡Œä¸ºæˆ‘ä»¬æä¾›å¸®åŠ©ã€‚ åœ¨æˆ‘çœ‹æ¥ï¼Œæœ¬æ–‡æä¾›äº†ç†è§£Prometheusçš„å·¥ä½œä»¥åŠå‘APIæ·»åŠ ä¸€ç»„åº¦é‡æ ‡å‡†çš„è¦ç‚¹ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬ä»¥æœ€å¹³åº¸çš„æ–¹å¼å¼€å§‹ï¼Œå¹¶è¿›è¡Œå°‘é‡æè¿°ã€‚ </p><a name="habracut"></a><br><p>  Prometheusæ˜¯ç”¨Goè¯­è¨€ç¼–å†™å¹¶ç”±SoundCloudå¼€å‘çš„å¼€æºç³»ç»Ÿå’Œæ—¶é—´åºåˆ—DBMSã€‚ å®ƒå…·æœ‰å®˜æ–¹æ–‡æ¡£å’Œå¯¹ä»¥ä¸‹è¯­è¨€çš„æ”¯æŒï¼šGoï¼ŒJavaæˆ–Scalaï¼ŒPythonï¼ŒRubyã€‚ éå®˜æ–¹æ”¯æŒå…¶ä»–è¯­è¨€ï¼Œä¾‹å¦‚ï¼šCï¼ƒï¼ŒC ++ï¼ŒCï¼ŒBashï¼Œç”¨äºNginxçš„Luaï¼Œç”¨äºTarantoolçš„Luaç­‰ã€‚æ•´ä¸ªåˆ—è¡¨ä½äºPrometheuså®˜æ–¹ç½‘ç«™ä¸Šã€‚ </p><br><p> æ‰€æœ‰PrometheusæœåŠ¡éƒ½å¯ä»¥åœ¨Docker Hubæˆ–Quay.ioä¸Šä»¥Dockeræ˜ åƒçš„å½¢å¼è·å¾—ã€‚ </p><br><p> Prometheusç”±<code>docker run -p 9090:9090 prom/prometheus</code>å¯åŠ¨ï¼Œè¯¥<code>docker run -p 9090:9090 prom/prometheus</code>ä»¥é»˜è®¤é…ç½®å¯åŠ¨å¹¶è®¾ç½®ç«¯å£<code>localhost:9090</code> ï¼Œä¹‹åï¼ŒPrometheus UIå°†åœ¨<code>localhost:9090</code>å¯ç”¨ã€‚ </p><br><p>  Prometheusæ˜¯ä¸€ä¸ªç›‘è§†ç³»ç»Ÿï¼Œå…¶ä¸­åŒ…æ‹¬ç”¨äºä½¿ç”¨HTTPåè®®é…ç½®å¯¹åº”ç”¨ç¨‹åºï¼ˆç«¯ç‚¹ï¼‰çš„ç›‘è§†çš„å„ç§å·¥å…·ã€‚ è¿æ¥åˆ°Prometheusæ—¶ï¼ŒHTTP APIä¸æ”¯æŒâ€œåŸºæœ¬èº«ä»½éªŒè¯â€ã€‚ å¦‚æœè¦ä½¿ç”¨åŸºæœ¬èº«ä»½éªŒè¯è¿æ¥åˆ°Prometheusï¼Œå»ºè®®å°†Prometheusä¸åå‘ä»£ç†æœåŠ¡å™¨ç»“åˆä½¿ç”¨ï¼Œå¹¶åœ¨ä»£ç†çº§åˆ«ä½¿ç”¨èº«ä»½éªŒè¯ã€‚ æ‚¨å¯ä»¥å¯¹Prometheusä½¿ç”¨ä»»ä½•åå‘ä»£ç†ã€‚ </p><br><p>  <strong><em>æ™®ç½—ç±³ä¿®æ–¯çš„ä¸»è¦ç»„æˆéƒ¨åˆ†ï¼š</em></strong> </p><br><ul><li> æ”¶é›†æŒ‡æ ‡å¹¶å°†å…¶ä¿å­˜åˆ°æ•°æ®åº“å¹¶è¿›è¡Œæ¸…ç†çš„æœåŠ¡å™¨ï¼› </li><li> ç”¨äºåœ¨APIä¸­æ”¶é›†æŒ‡æ ‡çš„è½¯ä»¶åŒ…ï¼› </li><li>  Pushgateway-ç”¨äºä»æ— æ³•ä½¿ç”¨Pullè¯·æ±‚çš„åº”ç”¨ç¨‹åºæ¥æ”¶æŒ‡æ ‡çš„ç»„ä»¶ï¼› </li><li> å¯¼å‡ºå™¨-å®‰è£…åœ¨ç›®æ ‡è®¡ç®—æœºä¸Šçš„ç”¨äºä»ç¬¬ä¸‰æ–¹åº”ç”¨ç¨‹åºå’ŒæœåŠ¡å¯¼å‡ºæŒ‡æ ‡çš„å·¥å…·ï¼› </li><li>  AlertManager-é€šçŸ¥ç®¡ç†å™¨ï¼ˆè­¦æŠ¥ï¼‰ï¼Œè­¦æŠ¥åœ¨é…ç½®æ–‡ä»¶ä¸­å®šä¹‰ï¼Œå¹¶ç”±ä¸€ç»„åº¦é‡æ ‡å‡†è§„åˆ™è®¾ç½®ã€‚ <br> å¦‚æœåœ¨æ“ä½œè¿‡ç¨‹ä¸­éµå®ˆè§„åˆ™ï¼Œåˆ™ä¼šè§¦å‘è­¦æŠ¥ï¼Œå¹¶é€šè¿‡ç”µå­é‚®ä»¶ï¼ŒSlackç­‰å°†è­¦æŠ¥å‘é€ç»™æŒ‡å®šçš„æ”¶ä»¶äººã€‚ </li></ul><br><p>  Prometheusä½¿ç”¨çš„å¯¹è±¡ç§°ä¸ºé€šè¿‡Pushgatewayæˆ–é€šè¿‡Exportersä»ç›®æ ‡æ¥æ”¶çš„åº¦é‡ã€‚ </p><br><p>  <strong><em>æ”¶é›†æŒ‡æ ‡æ—¶ï¼Œä½¿ç”¨äº†å‡ ç§ä¼ è¾“æŒ‡æ ‡çš„æ–¹æ³•ï¼š</em></strong> </p><br><ul><li>  Prometheusé€šè¿‡â€œæ‹‰â€è¯·æ±‚ä»ç›®æ ‡è¯·æ±‚åº¦é‡ï¼Œâ€œæ‹‰â€è¯·æ±‚çš„è®¾ç½®åœ¨æ¯ä¸ªä½œä¸šçš„scrape_configéƒ¨åˆ†çš„é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šã€‚ <br> å½“ç³»ç»Ÿæ”¶é›†æ•°æ®æ—¶ï¼Œæ‚¨å¯ä»¥æ§åˆ¶æ”¶é›†çš„é¢‘ç‡å¹¶åˆ›å»ºæ•°æ®æ”¶é›†çš„å‡ ç§é…ç½®ï¼Œä»¥ä¸ºä¸åŒçš„å¯¹è±¡é€‰æ‹©ä¸åŒçš„é¢‘ç‡ã€‚ </li><li> å¯¼å‡ºç¨‹åºå…è®¸æ‚¨ä»å„ç§å¯¹è±¡æ”¶é›†æŒ‡æ ‡ï¼Œä¾‹å¦‚ï¼šæ•°æ®åº“ï¼ˆMongoDBï¼ŒSQLç­‰ï¼‰ï¼Œæ¶ˆæ¯ä»£ç†ï¼ˆRabbitMQï¼ŒEMQï¼ŒNSQç­‰ï¼‰ï¼ŒHTTPè´Ÿè½½å¹³è¡¡å™¨ç­‰ï¼› </li><li>  Pushgatewayã€‚ å½“åº”ç”¨ç¨‹åºæ— æ³•æä¾›ç›´æ¥å‘Prometheusæä¾›æŒ‡æ ‡çš„åŠŸèƒ½æ—¶ï¼Œå¯ä»¥åœ¨å¿…è¦æ—¶ä½¿ç”¨å®ƒã€‚ æˆ–è€…ä½¿ç”¨æ— æ³•ä½¿ç”¨Prometheusæ‹‰å–è¯·æ±‚çš„æ‰¹å¤„ç†ä½œä¸šæ—¶ã€‚ </li></ul><br><p> å› æ­¤ï¼Œæ‰€æœ‰æ¥æ”¶åˆ°çš„æŒ‡æ ‡å°†ç”±Prometheuså­˜å‚¨åœ¨å¸¦æœ‰æ—¶é—´æˆ³çš„æ•°æ®åº“ä¸­ã€‚ </p><br><p>  <strong><strong>æ„å‹</strong></strong> </p><br><p> ä½¿ç”¨YAMLæ ¼å¼æä¾›çš„å‘½ä»¤è¡Œæ ‡å¿—å’Œé…ç½®æ–‡ä»¶é…ç½®Prometheusã€‚ å‘½ä»¤è¡Œæ ‡å¿—å…è®¸æ‚¨é…ç½®ä¸å¯å˜çš„å‚æ•°ï¼Œä¾‹å¦‚ï¼šè·¯å¾„ï¼Œå­˜å‚¨åœ¨ç£ç›˜å’Œå†…å­˜ä¸­çš„æ•°æ®é‡ç­‰ã€‚ è¯¥é…ç½®æ–‡ä»¶å…è®¸æ‚¨é…ç½®ä¸ä½œä¸šç›¸å…³çš„æ‰€æœ‰å†…å®¹ï¼Œå¹¶è®¾ç½®å·²åŠ è½½çš„è§„åˆ™Yamlæ–‡ä»¶ã€‚ æ‰€æœ‰å†…å®¹éƒ½å†™å…¥å…¨å±€é…ç½®æ–‡ä»¶ä¸­ï¼Œå®ƒä½¿æ‚¨å¯ä»¥ä¸ºæ¯ä¸ªäººè®¾ç½®å¸¸è§„è®¾ç½®ï¼Œå¹¶åˆ†åˆ«çªå‡ºæ˜¾ç¤ºä¸åŒé…ç½®éƒ¨åˆ†çš„è®¾ç½®ã€‚  Prometheusè½®è¯¢çš„è®¾ç½®åœ¨scrape_configséƒ¨åˆ†çš„é…ç½®æ–‡ä»¶ä¸­è¿›è¡Œé…ç½®ã€‚ </p><br><p>  Prometheuså¯ä»¥åœ¨æ“ä½œè¿‡ç¨‹ä¸­é‡æ–°åŠ è½½é…ç½®æ–‡ä»¶ï¼Œå¦‚æœæ–°é…ç½®æ— æ•ˆï¼Œåˆ™å°†ä¸ä¼šåº”ç”¨å®ƒã€‚ å¦‚æœè®¾ç½®äº†<code>--web.enable-lifecycle</code>æ ‡å¿—ï¼Œåˆ™é€šè¿‡å‘é€SIGHUP Prometheuså‘½ä»¤æˆ–å‘<code>/-/reload</code>å‘é€HTTP POSTè¯·æ±‚æ¥è§¦å‘é‡æ–°å¯åŠ¨é…ç½®æ–‡ä»¶ã€‚ å®ƒè¿˜å°†é‡æ–°åŠ è½½æ‰€æœ‰å·²é…ç½®çš„è§„åˆ™æ–‡ä»¶ã€‚ </p><br><p>  <strong><strong>ä½¿ç”¨ä»€ä¹ˆç±»å‹çš„æ•°æ®</strong></strong> </p><br><p>  Prometheuså­˜å‚¨è‡ªå®šä¹‰çš„å¤šç»´æ•°æ®æ¨¡å‹ï¼Œå¹¶å¯¹ç§°ä¸ºPromQLçš„å¤šç»´æ•°æ®ä½¿ç”¨æŸ¥è¯¢è¯­è¨€ã€‚  Prometheusä»¥æ—¶é—´åºåˆ—çš„å½¢å¼å­˜å‚¨æ•°æ®ï¼›å®ƒæ”¯æŒå‡ ç§å­˜å‚¨é€‰é¡¹ï¼š </p><br><ul><li> æœ¬åœ°ç£ç›˜å­˜å‚¨ï¼šæ¯2ä¸ªå°æ—¶ï¼Œå°†å‹ç¼©å·²ç¼“å­˜åœ¨å†…å­˜ä¸­çš„æ•°æ®å¹¶å°†å…¶å­˜å‚¨åœ¨ç£ç›˜ä¸Šã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œå·¥ä½œç›®å½•ä¸­ä½¿ç”¨./dataç›®å½•ä¿å­˜å‹ç¼©æ–‡ä»¶ï¼› </li><li> è¿œç¨‹å­˜å‚¨åº“ï¼šPrometheusæ”¯æŒé€šè¿‡åè®®ç¼“å†²åŒºé€‚é…å™¨ä¸ç¬¬ä¸‰æ–¹å­˜å‚¨åº“ï¼ˆä¾‹å¦‚ï¼šKafkaï¼ŒPostgreSQLï¼ŒAmazon S3ç­‰ï¼‰é›†æˆã€‚ </li></ul><br><p> å­˜å‚¨çš„æ—¶é—´åºåˆ—ç”±åº¦é‡å’Œå…ƒæ•°æ®ä»¥é”®å€¼å¯¹çš„å½¢å¼ç¡®å®šï¼Œå°½ç®¡åœ¨å¿…è¦æ—¶å¯ä»¥ä¸ä½¿ç”¨åº¦é‡â€‹â€‹çš„åç§°ï¼Œå¹¶ä¸”åº¦é‡æœ¬èº«ä»…ç”±å…ƒæ•°æ®ç»„æˆã€‚ æ—¶é—´åºåˆ—å¯ä»¥æ­£å¼å®šä¹‰ä¸º&lt;åº¦é‡åç§°&gt; {&lt;å…ƒæ•°æ®&gt;}ã€‚  <strong><em>å…³é”®</em></strong>æ˜¯&lt;metric name&gt; {&lt;metadata&gt;}-æˆ‘ä»¬æ­£åœ¨æµ‹é‡çš„<strong><em>å€¼</em></strong> ï¼Œè¯¥<strong><em>å€¼</em></strong>æ˜¯å¸¦æœ‰float64ç±»å‹çš„æ•°å­—çš„å®é™…å€¼ï¼ˆPrometheusä»…æ”¯æŒæ­¤ç±»å‹ï¼‰ã€‚ é”®è¯´æ˜åŒ…å«å…ƒæ•°æ®ï¼ˆæ ‡ç­¾ï¼‰ï¼Œä¹Ÿç”±é”®å€¼å¯¹æè¿°ï¼š&lt;æ ‡ç­¾åç§°&gt; =â€œ &lt;æ ‡ç­¾å€¼&gt;â€ï¼Œ&lt;æ ‡ç­¾åç§°&gt; =â€œ &lt;æ ‡ç­¾å€¼&gt;â€ï¼Œ... </p><br><p>  <strong>å­˜å‚¨æŒ‡æ ‡æ—¶ï¼Œä½¿ç”¨ä»¥ä¸‹æ•°æ®ç±»å‹ï¼š</strong> </p><br><ul><li>  <strong><em>è®¡æ•°å™¨</em></strong> -è®¡ç®—ä¸€æ®µæ—¶é—´å†…çš„é‡‘é¢ã€‚ è¿™ç§ç±»å‹çš„æŒ‡æ ‡åªèƒ½å¢åŠ ï¼ˆä¸èƒ½ä½¿ç”¨è´Ÿå€¼ï¼‰æˆ–é‡ç½®å€¼ã€‚ <br> ä¾‹å¦‚ï¼Œå®ƒå¯èƒ½é€‚ç”¨äºè®¡ç®—æ¯åˆ†é’Ÿçš„è¯·æ±‚æ•°æˆ–æ¯å¤©çš„é”™è¯¯æ•°ï¼Œå·²å‘é€/å·²æ¥æ”¶çš„ç½‘ç»œæ•°æ®åŒ…çš„æ•°é‡ç­‰ã€‚ </li><li>  <strong><em>é‡è¡¨</em></strong> -å­˜å‚¨éšæ—¶é—´æ¨ç§»å¯èƒ½å‡å°‘æˆ–å¢åŠ çš„å€¼ã€‚ <br> é‡è¡¨æœªæ˜¾ç¤ºä¸€æ®µæ—¶é—´å†…æŒ‡æ ‡çš„å‘å±•ã€‚ ä½¿ç”¨é‡è§„æ—¶ï¼Œéšç€æ—¶é—´çš„æµé€ï¼Œæ‚¨å¯èƒ½ä¼šä¸¢å¤±ä¸è§„åˆ™çš„æŒ‡æ ‡å˜åŒ–ã€‚ </li><li>  <strong><em>ç›´æ–¹å›¾</em></strong> -ä¿å­˜å¤šä¸ªæ—¶é—´åºåˆ—ï¼šæ‰€æœ‰è§‚æµ‹å€¼çš„æ€»å’Œï¼› è§‚å¯Ÿåˆ°çš„äº‹ä»¶æ•°ï¼› <br> ç´¯ç§¯è®¡æ•°å™¨ï¼ˆå­˜å‚¨æ¡¶ï¼‰-åœ¨æ ‡ç­¾ä¸­è¡¨ç¤ºä¸º<code>le="&lt;upper inclusive bound&gt;"</code> ã€‚ <br> åœ¨å…·æœ‰è‡ªå®šä¹‰ä¸Šé™ï¼ˆå­˜å‚¨æ¡¶ï¼‰çš„åŒºåŸŸä¸­æ”¶é›†å€¼ã€‚ </li><li>  <strong><em>æ‘˜è¦</em></strong> -ä¿å­˜å‡ ä¸ªæ—¶é—´åºåˆ—ï¼šæ‰€æœ‰è§‚æµ‹å€¼çš„æ€»å’Œï¼› è§‚å¯Ÿåˆ°çš„äº‹ä»¶æ•°ï¼› <br> è§‚å¯Ÿåˆ°çš„äº‹ä»¶çš„æµé‡Ï†åˆ†ä½æ•°ï¼ˆ0â‰¤Ï†â‰¤1ï¼‰-åœ¨æ ‡ç­¾ä¸­è¡¨ç¤ºä¸º<code>quantile="&lt;Ï†&gt;"</code> ã€‚ </li></ul><br><p>  <strong><strong>æ•°æ®å¦‚ä½•ä¿å­˜ï¼Ÿ</strong></strong> </p><br><p>  Prometheuså»ºè®®ä¸ºæ­£åœ¨è¿è¡Œçš„åº”ç”¨ç¨‹åºâ€œæä¾›â€ 2/3çš„RAMã€‚ <br> ä¸ºäº†å°†æ•°æ®å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼ŒPrometheusä½¿ç”¨äº†ç§°ä¸ºå—çš„æ–‡ä»¶ï¼›æ¯ä¸ªåº¦é‡éƒ½æœ‰å…¶è‡ªå·±çš„æ–‡ä»¶ã€‚ é™¤äº†æœ€åä¸€ä¸ªå†™å…¥æ•°æ®çš„å—æ–‡ä»¶ä¹‹å¤–ï¼Œæ‰€æœ‰å—æ–‡ä»¶éƒ½æ˜¯ä¸å¯å˜çš„ã€‚ æ–°æ•°æ®å°†ä¿å­˜åœ¨å—ä¸­ï¼Œå¹¶ä¸”æ¯éš”2å°æ—¶ï¼Œåå°æµä¼šå°†è¿™äº›æ•°æ®åˆå¹¶å¹¶å†™å…¥ç£ç›˜ã€‚ æ¯ä¸ªä¸¤å°æ—¶çš„æ—¶é—´æ®µç”±ä¸€ä¸ªç›®å½•ç»„æˆï¼Œè¯¥ç›®å½•åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªå—æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶åŒ…å«è¯¥æ—¶é—´æ®µçš„æ‰€æœ‰æ—¶é—´åºåˆ—æ ·æœ¬ï¼Œè¿˜åŒ…æ‹¬ä¸€ä¸ªå…ƒæ•°æ®æ–‡ä»¶å’Œä¸€ä¸ªç´¢å¼•æ–‡ä»¶ï¼ˆè¯¥ç´¢å¼•æ–‡ä»¶å¯¹å—æ–‡ä»¶ä¸­æ—¶é—´åºåˆ—çš„åº¦é‡æ ‡å‡†å’Œæ ‡ç­¾è¿›è¡Œç´¢å¼•ï¼‰ã€‚ å¦‚æœPrometheusåœ¨ä¸€ä¸ªå°æ—¶å†…æ²¡æœ‰å°†æ•°æ®å†™å…¥å—ï¼Œåˆ™å®ƒå°†è¢«ä¿å­˜åˆ°ç£ç›˜ï¼Œå¹¶ä¸”å°†åˆ›å»ºä¸€ä¸ªæ–°çš„å—æ¥å†™å…¥æ•°æ®ã€‚  Prometheusä¸­çš„æœ€å¤§æ•°æ®ä¿ç•™æœŸä¸ºã€œ21å¤©ã€‚ </p><br><p> å› ä¸º å†…å­˜å¤§å°æ˜¯å›ºå®šçš„ï¼Œå› æ­¤ç³»ç»Ÿçš„å†™å…¥å’Œè¯»å–æ€§èƒ½å°†å—åˆ°æ­¤å†…å­˜é‡çš„é™åˆ¶ã€‚  PTSDBå†…å­˜é‡ç”±æœ€å°æ—¶é—´æ®µï¼Œæ”¶é›†æ—¶é—´æ®µå’Œæ—¶é—´åº¦é‡æ ‡å‡†çš„æ•°é‡ç¡®å®šã€‚ </p><br><p>  Prometheusè¿˜å…·æœ‰WALæœºåˆ¶ä»¥é˜²æ­¢æ•°æ®ä¸¢å¤±ã€‚ </p><br><p>  <strong><em>é¢„å†™æ—¥å¿—ï¼ˆWALï¼‰</em></strong>ä»¥æ—¥å¿—æ–‡ä»¶çš„å½¢å¼åœ¨æ°¸ä¹…ä»‹è´¨ä¸Šåºåˆ—åŒ–å­˜å‚¨çš„æ“ä½œã€‚ å‘ç”Ÿæ•…éšœæ—¶ï¼Œå¯ä»¥ä½¿ç”¨WALæ–‡ä»¶é€šè¿‡ä»æ—¥å¿—è¿˜åŸå°†æ•°æ®åº“æ¢å¤åˆ°å…¶ä¸€è‡´çŠ¶æ€ã€‚ </p><br><p> æ—¥å¿—æ–‡ä»¶ä»¥128 MBçš„æ®µå­˜å‚¨åœ¨walç›®å½•ä¸­ã€‚ è¿™äº›æ–‡ä»¶åŒ…å«å°šæœªå‹ç¼©çš„åŸå§‹æ•°æ®ï¼Œå› æ­¤å®ƒä»¬æ¯”å¸¸è§„ç‰‡æ®µæ–‡ä»¶å¤§å¾—å¤šã€‚ </p><br><p>  Prometheuså°†è‡³å°‘å­˜å‚¨3ä¸ªæ—¥å¿—æ–‡ä»¶ï¼Œä½†æ˜¯æµé‡è¾ƒé«˜çš„æœåŠ¡å™¨å¯ä»¥çœ‹åˆ°ä¸‰ä¸ªä»¥ä¸Šçš„WALæ–‡ä»¶ï¼Œå› ä¸ºå®ƒéœ€è¦å­˜å‚¨è‡³å°‘ä¸¤ä¸ªå°æ—¶çš„åŸå§‹æ•°æ®ã€‚ </p><br><p> ä½¿ç”¨WALçš„ç»“æœæ˜¯å¤§å¤§å‡å°‘äº†å¯¹ç£ç›˜çš„å†™è¯·æ±‚æ•°é‡ï¼Œå› ä¸º ä»…æ—¥å¿—æ–‡ä»¶éœ€è¦å†™å…¥ç£ç›˜ï¼Œè€Œä¸æ˜¯æ“ä½œåå·²æ›´æ”¹çš„æ‰€æœ‰æ•°æ®ã€‚ æ—¥å¿—æ–‡ä»¶æ˜¯æŒ‰é¡ºåºå†™å…¥çš„ï¼Œå› æ­¤åŒæ­¥æ—¥å¿—çš„æˆæœ¬è¦æ¯”å°†ç‰‡æ®µä¸æ•°æ®å†™å…¥çš„æˆæœ¬ä½å¾—å¤šã€‚ </p><br><p>  Prometheusä¿å­˜äº†å®šæœŸæ–­ç‚¹ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œé€šè¿‡å‹ç¼©è¿‡å»çš„æ—¶é—´æ®µå¹¶å°†å…¶ä¿å­˜åˆ°ç£ç›˜ï¼Œæ¯2å°æ—¶æ·»åŠ ä¸€æ¬¡ã€‚ </p><br><p> æ‰€æœ‰æ–­ç‚¹éƒ½ä¸checkpoint.dddå­˜å‚¨åœ¨åŒä¸€ç›®å½•ä¸­ï¼Œå…¶ä¸­dddæ˜¯å•è°ƒé€’å¢çš„æ•°å­—ã€‚ å› æ­¤ï¼Œä»æ•…éšœä¸­æ¢å¤æ—¶ï¼Œå®ƒå¯ä»¥ä»æ–­ç‚¹ç›®å½•ä¸­æ¢å¤æ–­ç‚¹å¹¶æŒ‡ç¤ºé¡ºåºï¼ˆ.dddï¼‰ã€‚ <br> é€šè¿‡ç¼–å†™WALæ—¥å¿—ï¼Œæ‚¨å¯ä»¥è¿”å›åˆ°æ•°æ®æ—¥å¿—å¯ç”¨çš„ä»»ä½•æ£€æŸ¥ç‚¹ã€‚ </p><br><p>  <strong><strong>å®è·µä¸­å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ</strong></strong> </p><br><p> å½“æ·»åŠ åˆ°é¡¹ç›®ï¼ˆ.Net Frameworkï¼‰ä¸­æ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨Prometheus.Client.3.0.2åŒ…æ¥æ”¶é›†åº¦é‡ã€‚ ä¸ºäº†æ”¶é›†åº¦é‡ï¼Œå·²åœ¨é¡¹ç›®ä¸­æ·»åŠ äº†å¿…è¦çš„æ–¹æ³•å’Œç±»ä»¥å­˜å‚¨åº¦é‡ï¼Œç›´åˆ°Prometheusæ”¶åˆ°å®ƒä»¬ä¸ºæ­¢ã€‚ </p><br><p> æœ€åˆå®šä¹‰äº†IMetricsServiceæ¥å£ï¼Œè¯¥æ¥å£åŒ…å«ç”¨äºæµ‹é‡æ–¹æ³•å·¥ä½œæ—¶é—´çš„è®¡æ—¶å™¨æ–¹æ³•ï¼š </p><br><pre> <code class="plaintext hljs">public interface IMetricsService { Stopwatch StartTimer(); void StopTimer(Stopwatch timer, string controllerName, string actionName, string methodName = "POST"); }</code> </pre> <br><p> æˆ‘ä»¬æ·»åŠ äº†MetricsServiceç±»ï¼Œè¯¥ç±»å®ç°äº†IMetricsServiceæ¥å£å¹¶ä¸´æ—¶å­˜å‚¨æŒ‡æ ‡ã€‚ </p><br><pre> <code class="plaintext hljs">public class MetricsService : IMetricsService { private static Histogram _histogram; static MetricsService() { _histogram = CreateHistogram(); } public Stopwatch StartTimer() { try { var timer = new Stopwatch(); timer.Start(); return timer; } catch (Exception exception) { Logger.Error(exception); } return null; } public void StopTimer(Stopwatch timer, string controllerName, string actionName, string methodName = "POST") { try { if (timer == null) { throw new ArgumentException($"{nameof(timer)} can't be null."); } timer.Stop(); _histogram .WithLabels(controllerName, actionName, methodName) .Observe(timer.ElapsedMilliseconds, DateTimeOffset.UtcNow); } catch (Exception exception) { Logger.Error(exception); } } public static List&lt;string&gt; GetAllLabels() { var metricsList = new List&lt;string&gt;(); try { foreach (var keyValuePair in _histogram.Labelled) { var controllerName = keyValuePair.Key.Labels[0].Value; var actionName = keyValuePair.Key.Labels[1].Value; var methodName = keyValuePair.Key.Labels[2].Value; var requestDurationSum = keyValuePair.Value.Value.Sum; var requestCount = keyValuePair.Value.Value.Count; metricsList.Add($"http_request_duration_widget_sum{{controller={controllerName},action={actionName},method={methodName}}} {requestDurationSum}"); metricsList.Add($"http_request_duration_widget_count{{controller={controllerName},action={actionName},method={methodName}}} {requestCount}"); } _histogram = CreateHistogram(); } catch (Exception exception) { Logger.Error(exception); } return metricsList; } private static Histogram CreateHistogram() { var newMetrics = Metrics .WithCustomRegistry(new CollectorRegistry()) .CreateHistogram(name: "http_request_duration_web_api", help: "Histogram metrics of Web.Api", includeTimestamp: true, labelNames: new[] { "controller", "action", "method" }); var oldValue = _histogram; for (var i = 0; i &lt; 10; i++) { var oldValue = Interlocked.Exchange&lt;Histogram&gt;(ref oldValue, newMetrics); if (oldValue != null) { return oldValue; } } return null; } }</code> </pre> <br><p> ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æˆ‘ä»¬çš„ç±»å°†è®¡åˆ’æ”¶é›†çš„æŒ‡æ ‡å­˜å‚¨åœ¨Application_BeginRequestï¼ŒApplication_Errorï¼ŒApplication_EndRequestæ–¹æ³•ä¸­ã€‚ åœ¨Global.csç±»ä¸­ï¼Œæˆ‘ä»¬å‘ä¸Šè¿°æ–¹æ³•æ·»åŠ äº†ä¸€ç»„æŒ‡æ ‡ã€‚ </p><br><pre> <code class="plaintext hljs">private IMetricsService _metricsService; protected virtual void Application_BeginRequest(object sender, EventArgs e) { var context = new HttpContextWrapper(HttpContext.Current); var metricServiceTimer = _metricsService.StartTimer(); context.Items.Add("metricsService", _metricsService); context.Items.Add("metricServiceTimer", metricServiceTimer); } protected virtual void Application_EndRequest(object sender, EventArgs e) { WriteMetrics(new HttpContextWrapper(HttpContext.Current)); } protected void Application_Error(object sender, EventArgs e) { WriteMetrics(new HttpContextWrapper(HttpContext.Current)); } private void WriteMetrics(HttpContextBase context) { try { _metricsService = context.Items["metricsService"] as IMetricsService; if (_metricsService != null) { var timer = context.Items["metricServiceTimer"] as Stopwatch; string controllerName = null; string actionName = null; var rd = RouteTable.Routes.GetRouteData(context); if (rd != null) { controllerName = rd.GetRequiredString("controller"); actionName = rd.GetRequiredString("action"); } _metricsService.StopTimer(timer, controllerName, actionName, context.Request.HttpMethod); } } catch (Exception exception) { Logger.Error("Can't write metrics.", exception); } }</code> </pre><br><p> æ·»åŠ ä¸€ä¸ªæ–°çš„æ§åˆ¶å™¨ï¼Œå®ƒå°†ä½œä¸ºå°†æˆ‘ä»¬çš„APIæŒ‡æ ‡å‘é€ç»™Prometheusçš„å‚è€ƒç‚¹ï¼š </p><br><pre> <code class="plaintext hljs">public class MetricsController : Controller { [HttpGet] public string[] GetAllMetrics() { try { var metrics = MetricsService.GetAllLabels(); return metrics.ToArray(); } catch (Exception exception) { Logger.Error(exception); } return new string[] { }; } }</code> </pre> <br><p> æœ€åä¸€æ­¥æ˜¯å°†Prometheusé…ç½®é…ç½®ä¸ºåœ¨scrape_configséƒ¨åˆ†ä¸­æ”¶é›†æŒ‡æ ‡ï¼Œæ­¤åæˆ‘ä»¬å¯ä»¥åœ¨Prometheusæˆ–Grafana UIä¸­çœ‹åˆ°å·²æ”¶é›†çš„æŒ‡æ ‡ã€‚ </p><br><p>  <strong><strong>æˆ‘ä»¬å¯¹Prometheusæ„Ÿå…´è¶£çš„å…³é”®åŠŸèƒ½ï¼š</strong></strong> </p><br><p> å¤šç»´æ•°æ®æ¨¡å‹ï¼šæŒ‡æ ‡å’Œæ ‡ç­¾ã€‚ <br> çµæ´»çš„PromQLæŸ¥è¯¢è¯­è¨€ã€‚ åœ¨åŒä¸€ä¸ªæŸ¥è¯¢è¿ç®—ç¬¦ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¯¸å¦‚ä¹˜æ³•ï¼ŒåŠ æ³•ï¼Œä¸²è”ç­‰æ“ä½œï¼› å¯ä»¥ä½¿ç”¨å¤šä¸ªæŒ‡æ ‡æ‰§è¡Œã€‚ <br> ä½¿ç”¨pullæ–¹æ³•æ”¶é›†åŸºäºHTTPçš„æ•°æ®ã€‚ <br> ä¸é€šè¿‡Pushgatewayçš„æ¨é€æ–¹æ³•å…¼å®¹ã€‚ <br> å¯ä»¥é€šè¿‡å¯¼å‡ºå™¨ä»å…¶ä»–åº”ç”¨ç¨‹åºæ”¶é›†æŒ‡æ ‡ã€‚ <br> æä¾›é˜²æ­¢æ•°æ®ä¸¢å¤±çš„æœºåˆ¶ã€‚ <br> æ”¯æŒæ•°æ®çš„å„ç§å›¾å½¢è¡¨ç¤ºã€‚ </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN475600/">https://habr.com/ru/post/zh-CN475600/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN475588/index.html">ä¸‰ç§èŒƒå¼</a></li>
<li><a href="../zh-CN475590/index.html">ä½¿ç”¨è®°äº‹æœ¬++ç¼–è¯‘ç¨‹åº</a></li>
<li><a href="../zh-CN475594/index.html">æœ‰è¶£çš„JavaScriptï¼šå‡ ä¹çº¿æ€§çš„æ–¹ç¨‹å¼</a></li>
<li><a href="../zh-CN475596/index.html">å¯¹äºå°æ•°ç³»ç»Ÿè¯æ˜äº†å¤§ç´ æ•°å‡è®¾</a></li>
<li><a href="../zh-CN475598/index.html">é€šè¿‡ä¸€å †ViewModel + LiveDataï¼ŒRetrofit + Coroutinesåœ¨Androidåº”ç”¨ç¨‹åºä¸­ç»„ç»‡ç®€å•æ¶æ„</a></li>
<li><a href="../zh-CN475604/index.html">åœ¨Zabbix 4.4ä¸Šé…ç½®å®˜æ–¹PostgreSQLæ¨¡æ¿</a></li>
<li><a href="../zh-CN475608/index.html">Googleè·Ÿè¸ªä»£ç ç®¡ç†å™¨ï¼šä¸æ˜æ˜¾ä¸”æœ‰ç”¨çš„è§¦å‘å™¨è®¾ç½®</a></li>
<li><a href="../zh-CN475610/index.html">ä¿æŒè§†é‡çš„å®‰å…¨LEDå°ç¯</a></li>
<li><a href="../zh-CN475612/index.html">ç»™å®šä½•æ—¶ï¼Œä½•æ—¶æ–­è¨€å’Œå¯¹å®æ–½çš„ä¿¡å¿ƒ</a></li>
<li><a href="../zh-CN475614/index.html">æœ€å°çš„è‡ªåŠ¨åŒ–ã€‚ ç¬¬äºŒéƒ¨åˆ†ã€‚ ç½‘ç»œè®¾è®¡</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>