<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü•ß üóª üë®üèæ‚Äçüöí C√≥mo funciona la b√∫squeda Yandex.Market y qu√© suceder√° si uno de los servidores falla üôáüèΩ üèÖ üéì</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola, me llamo Eugene. Trabajo en la infraestructura de b√∫squeda Yandex.Market. Quiero contarle a la comunidad Habr sobre la cocina interna del Mercad...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C√≥mo funciona la b√∫squeda Yandex.Market y qu√© suceder√° si uno de los servidores falla</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/475848/">  Hola, me llamo Eugene.  Trabajo en la infraestructura de b√∫squeda Yandex.Market.  Quiero contarle a la comunidad Habr sobre la cocina interna del Mercado, pero hay algo que contar.  En primer lugar, c√≥mo funciona la b√∫squeda de mercado, los procesos y la arquitectura.  ¬øC√≥mo lidiamos con situaciones de emergencia: qu√© sucede si un servidor falla?  ¬øY si hay 100 de esos servidores? <br><br>  Tambi√©n aprender√° de inmediato c√≥mo implementamos nuevas funciones en un grupo de servidores.  Y c√≥mo probar servicios complejos directamente en producci√≥n, sin dar a los usuarios ning√∫n inconveniente.  En general, c√≥mo funciona la b√∫squeda del Mercado, para que todos est√©n bien. <br><br><img src="https://habrastorage.org/webt/-x/ye/eb/-xyeebvixa2pxxh3ad-peaoukyo.png"><br><a name="habracut"></a><br><h2>  Un poco sobre nosotros: ¬øqu√© problema resolvemos? </h2><br>  Cuando ingresa texto, busca productos por par√°metros o compara precios en diferentes tiendas, todas las solicitudes llegan al servicio de b√∫squeda.  La b√∫squeda es el servicio m√°s grande en el mercado. <br><br>  Procesamos todas las consultas de b√∫squeda: desde market.yandex.ru, beru.ru, el servicio Supercheck, Yandex.Advisor y aplicaciones m√≥viles.  Tambi√©n incluimos ofertas de bienes en los resultados de b√∫squeda en yandex.ru. <br><br><img width="500" src="https://habrastorage.org/webt/yt/_h/5d/yt_h5de7hmx0zmkv8gdk7glq-kc.png"><br><br>  Por servicio de b√∫squeda, me refiero no solo a la b√∫squeda directa, sino tambi√©n a una base de datos con todas las ofertas del mercado.  La escala es la siguiente: se procesan m√°s de mil millones de consultas de b√∫squeda por d√≠a.  Y todo deber√≠a funcionar r√°pidamente, sin interrupciones y siempre producir el resultado deseado. <br><br><h2>  Qu√© es qu√©: arquitectura de mercado </h2><br>  Describa brevemente la arquitectura actual del mercado.  Convencionalmente, se puede describir mediante el siguiente esquema: <br><img src="https://habrastorage.org/webt/ra/yq/jv/rayqjvvmbjvxhsc8lokpysg_rvw.jpeg"><br>  Digamos que una tienda asociada viene a nosotros.  Dice que quiero vender un juguete: este gato malvado con un chirrido.  Y un gato malvado sin un tweeter.  Y solo un gato.  Luego, la tienda necesita preparar ofertas en las que el mercado busca.  La tienda forma un xml especial con ofertas y comunica la ruta a este xml a trav√©s de una interfaz de socio.  Luego, el indexador descarga peri√≥dicamente este xml, busca errores y almacena toda la informaci√≥n en una gran base de datos. <br><br>  Hay muchos xml guardados.  Se crea un √≠ndice de b√∫squeda a partir de esta base de datos.  El √≠ndice se almacena en formato interno.  Despu√©s de crear el √≠ndice, el servicio de dise√±os lo carga en los motores de b√∫squeda. <br><br>  Como resultado, aparece un gato malvado con un chirrido en la base de datos y aparece un √≠ndice de gato en el servidor. <br><br>  Hablar√© sobre c√≥mo buscamos un gato en la parte sobre la arquitectura de b√∫squeda. <br><br><h2>  Arquitectura de b√∫squeda de mercado </h2><br>  Vivimos en el mundo de los microservicios: cada solicitud entrante a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">market.yandex.ru</a> genera muchas subconsultas y docenas de servicios participan en su procesamiento.  El diagrama muestra solo unos pocos: <br><br><img src="https://habrastorage.org/webt/92/n9/iu/92n9iutvet9ls6k7djh29brfdq0.jpeg"><br>  <i>Esquema de procesamiento de solicitud simplificado</i> <br><br>  Cada servicio tiene algo maravilloso: su propio equilibrador con un nombre √∫nico: <br><br><img src="https://habrastorage.org/webt/qb/_c/t4/qb_ct4mdpio2xprdlos2pi1oym8.jpeg"><br><br>  El equilibrador nos brinda una gran flexibilidad para administrar el servicio: por ejemplo, puede apagar los servidores, que a menudo se requieren para las actualizaciones.  El equilibrador ve que el servidor no est√° disponible y redirige autom√°ticamente las solicitudes a otros servidores o centros de datos.  Cuando agrega o elimina un servidor, la carga se redistribuye autom√°ticamente entre los servidores. <br><br>  El nombre √∫nico del equilibrador no depende del centro de datos.  Cuando el servicio A realiza una solicitud a B, de manera predeterminada, el equilibrador B redirige la solicitud al centro de datos actual.  Si el servicio no est√° disponible o est√° ausente en el centro de datos actual, la solicitud se redirige a otros centros de datos. <br><br>  Un solo FQDN para todos los centros de datos permite que el servicio A generalmente se desconecte de las ubicaciones.  Su solicitud de servicio B siempre ser√° procesada.  Una excepci√≥n es el caso cuando el servicio est√° en todos los centros de datos. <br><br>  Pero no todo es tan optimista con este equilibrador: tenemos un componente intermedio adicional.  El equilibrador puede ser inestable y este problema se resuelve con servidores redundantes.  Tambi√©n hay un retraso adicional entre los servicios A y B. Pero en la pr√°ctica, es inferior a 1 ms y para la mayor√≠a de los servicios esto no es cr√≠tico. <br><br><h3>  Combatir lo inesperado: servicios de b√∫squeda equilibrados y resistentes </h3><br>  Imagine que ocurri√≥ un colapso: necesita encontrar un gato con un chirrido, pero el servidor falla.  O 100 servidores.  ¬øC√≥mo salir?  ¬øRealmente dejaremos al usuario sin un gato? <br><br>  La situaci√≥n es terrible, pero estamos listos para ello.  Te lo dir√© en orden. <br><br>  La infraestructura de b√∫squeda se encuentra en varios centros de datos: <br><br><img src="https://habrastorage.org/webt/_i/wa/f9/_iwaf97__hrhmaspgxcl-euqqnq.jpeg"><br><br>  Al dise√±ar, ponemos la posibilidad de deshabilitar un centro de datos.  La vida est√° llena de sorpresas: por ejemplo, una excavadora puede cortar un cable subterr√°neo (s√≠, as√≠ fue).  Las capacidades en los centros de datos restantes deber√≠an ser suficientes para soportar la carga m√°xima. <br><br>  Considere un solo centro de datos.  En cada centro de datos, el mismo esquema de equilibradores: <br><br><img src="https://habrastorage.org/webt/x6/rp/hx/x6rphx-hrlcb1gciennukyjeudi.jpeg"><br>  Un equilibrador es al menos tres servidores f√≠sicos.  Tal redundancia est√° hecha para la confiabilidad.  Los equilibradores trabajan en HAProx. <br><br>  Elegimos HAProx debido a su alto rendimiento, requisitos de recursos peque√±os y amplia funcionalidad.  Dentro de cada servidor funciona nuestro software de b√∫squeda. <br><br>  La probabilidad de falla de un servidor es peque√±a.  Pero si tiene muchos servidores, aumentar√° la probabilidad de que al menos uno caiga. <br><br>  Esto es lo que sucede en realidad: los servidores se est√°n bloqueando.  Por lo tanto, debe monitorear constantemente el estado de todos los servidores.  Si el servidor deja de responder, se desconecta autom√°ticamente del tr√°fico.  Para esto, HAProxy tiene un control de salud incorporado.  Se dirige a todos los servidores con solicitud HTTP "/ ping" una vez por segundo. <br><br>  Otra caracter√≠stica de HAProxy: agent-check le permite cargar todos los servidores de manera uniforme.  Para hacer esto, HAProxy se conecta a todos los servidores, y devuelven su peso dependiendo de la carga actual de 1 a 100. El peso se calcula en funci√≥n del n√∫mero de solicitudes en la cola de procesamiento y la carga del procesador. <br><br>  Ahora sobre encontrar un gato.  Las consultas de la forma <b>/ b√∫squeda? Texto = angry + cat</b> llegan a <b>buscar</b> .  Para que la b√∫squeda sea r√°pida, todo el √≠ndice cat debe colocarse en la RAM.  Incluso leer desde un SSD no es lo suficientemente r√°pido. <br><br>  √ârase una vez, la base de la oferta era peque√±a, y hab√≠a suficiente RAM para un servidor.  A medida que la base de datos de la propuesta creci√≥, todo dej√≥ de caber en esta RAM y los datos se dividieron en dos partes: fragmento 1 y fragmento 2. <br><br><img src="https://habrastorage.org/webt/kz/od/j5/kzodj5ghrqccc_necth6gmylzgy.jpeg"><br>  Pero siempre sucede: cualquier soluci√≥n, incluso una buena, genera otros problemas. <br><br>  El equilibrador a√∫n fue a cualquier servidor.  Pero en la m√°quina donde lleg√≥ la solicitud, solo hab√≠a la mitad del √≠ndice.  El resto estaba en otros servidores.  Por lo tanto, el servidor tuvo que ir a alguna m√°quina vecina.  Despu√©s de recibir datos de ambos servidores, los resultados se combinaron y reorganizaron. <br><br>  Dado que el equilibrador distribuye las solicitudes de manera uniforme, todos los servidores se dedicaron a reorganizar, y no solo a proporcionar datos. <br><br>  El problema se produjo si el servidor vecino no estaba disponible.  La soluci√≥n fue especificar varios servidores con diferentes prioridades como el servidor "vecino".  Primero, la solicitud se envi√≥ a los servidores en el bastidor actual.  Si no se recibi√≥ respuesta, la solicitud se envi√≥ a todos los servidores en este centro de datos.  Y por √∫ltimo, pero no menos importante, la solicitud se envi√≥ a otros centros de datos. <br>  A medida que aument√≥ el n√∫mero de propuestas, los datos se dividieron en cuatro partes.  Pero este no era el l√≠mite. <br><br>  Ahora se usa una configuraci√≥n de ocho fragmentos.  Adem√°s, para ahorrar m√°s memoria, el √≠ndice se dividi√≥ en la parte de b√∫squeda (por la cual se realiza la b√∫squeda) y la parte de fragmento (que no est√° involucrada en la b√∫squeda). <br><br>  Un servidor contiene informaci√≥n sobre un solo fragmento.  Por lo tanto, para realizar una b√∫squeda en el √≠ndice completo, debe buscar en ocho servidores que contengan fragmentos diferentes. <br><br>  Los servidores se agrupan en grupos.  Cada grupo contiene ocho motores de b√∫squeda y un fragmento. <br><br><img src="https://habrastorage.org/webt/1b/om/dl/1bomdlbzui-uxhswoq1kfq9h7os.jpeg"><br>  La base de datos de valores clave con datos est√°ticos se est√° ejecutando en el servidor de fragmentos.  Son necesarios para emitir documentos, por ejemplo, una descripci√≥n de un gato con un chirrido.  Los datos se extraen especialmente en un servidor separado para no cargar la memoria de los motores de b√∫squeda. <br><br>  Dado que las ID de documentos son √∫nicas solo en el marco de un √≠ndice, podr√≠a surgir una situaci√≥n en la que no hay documentos en los fragmentos.  Bueno o eso en una ID habr√° otro contenido.  Por lo tanto, para que la b√∫squeda funcione y la b√∫squeda ocurra, ha surgido la necesidad de la consistencia de todo el cl√∫ster.  M√°s adelante hablar√© sobre c√≥mo monitoreamos la consistencia. <br><br>  La b√∫squeda en s√≠ est√° organizada de la siguiente manera: una consulta de b√∫squeda puede llegar a cualquiera de los ocho servidores.  Digamos que vino al servidor 1. Este servidor procesa todos los argumentos y entiende qu√© y c√≥mo buscar.  Dependiendo de la solicitud entrante, el servidor puede realizar solicitudes adicionales a servicios externos para obtener la informaci√≥n necesaria.  Una solicitud puede ser seguida por hasta diez solicitudes a servicios externos. <br><br>  Despu√©s de recopilar la informaci√≥n necesaria, comienza una b√∫squeda en la base de datos de ofertas.  Para hacer esto, se realizan subconsultas para los ocho servidores en el cl√∫ster. <br><br>  Despu√©s de recibir las respuestas, los resultados se combinan.  Al final, para generar el problema, es posible que necesite varias subconsultas m√°s para el servidor de fragmentos. <br><br>  Las consultas de b√∫squeda dentro del cl√∫ster son: <b>/ shard1? Text = angry + cat</b> .  Adem√°s, las subconsultas de la forma: <b>/ status</b> se realizan constantemente entre todos los servidores dentro del cl√∫ster una vez por segundo. <br><br>  La solicitud <b>/ status</b> detecta una situaci√≥n en la que el servidor no est√° disponible. <br><br>  Tambi√©n controla que en todos los servidores la versi√≥n del motor de b√∫squeda y la versi√≥n del √≠ndice sean las mismas, de lo contrario habr√° datos inconsistentes dentro del cl√∫ster. <br><br>  A pesar del hecho de que un servidor de fragmentos procesa las solicitudes de ocho motores de b√∫squeda, su procesador tiene una carga muy ligera.  Por lo tanto, ahora transferimos datos de fragmentos a un servicio separado. <br><br><img src="https://habrastorage.org/webt/3u/q5/ng/3uq5ngicgxwxg60diggqot7iiky.jpeg"><br><br>  Para transferir datos, introdujimos claves universales para documentos.  Ahora la situaci√≥n es imposible cuando una clave devuelve contenido de otro documento. <br><br>  Pero la transici√≥n a otra arquitectura a√∫n no est√° completa.  Ahora queremos deshacernos del servidor de fragmentos dedicado.  Y luego, generalmente, al√©jese de la estructura del cl√∫ster.  Esto nos permitir√° continuar escalando f√°cilmente.  Una ventaja adicional es un importante ahorro de hierro. <br><br>  Y ahora a las historias de miedo con un final feliz.  Considere varios casos de indisponibilidad del servidor. <br><br><h4>  Terrible sucedi√≥: un servidor no est√° disponible </h4><br>  Digamos que un servidor no est√° disponible.  Luego, los otros servidores en el cl√∫ster pueden continuar respondiendo, pero los resultados de la b√∫squeda estar√°n incompletos. <br><br>  A trav√©s de una verificaci√≥n de estado, los servidores vecinos entienden que uno no est√° disponible.  Por lo tanto, para mantener la integridad, todos los servidores en el cl√∫ster comienzan a responder a la solicitud <b>/ ping</b> al equilibrador de que tampoco est√°n disponibles.  Resulta que todos los servidores en el cl√∫ster murieron (que no es el caso).  Este es el principal inconveniente de nuestro esquema de cl√∫ster; por lo tanto, queremos alejarnos de √©l. <br><br><img src="https://habrastorage.org/webt/hr/ko/2o/hrko2ovb9b5q2hjb8xqgnubynec.jpeg"><br><br>  Solicitudes que terminaron con un error, el equilibrador vuelve a preguntar en otros servidores. <br>  Adem√°s, el equilibrador deja de enviar tr√°fico de usuarios a servidores muertos, pero contin√∫a verificando su estado. <br><br>  Cuando el servidor est√° disponible, comienza a responder a <b>/ ping</b> .  Tan pronto como las respuestas normales a los pings de los servidores muertos comienzan a llegar, los balanceadores comienzan a enviar tr√°fico de usuarios all√≠.  El grupo est√° restaurado, aplausos. <br><br><h4>  Peor a√∫n: muchos servidores no est√°n disponibles </h4><br>  Una parte importante de los servidores en el centro de datos se corta.  ¬øQu√© hacer, d√≥nde correr?  El equilibrador viene al rescate nuevamente.  Cada equilibrador mantiene constantemente en la memoria el n√∫mero actual de servidores en vivo.  Siempre considera la cantidad m√°xima de tr√°fico que puede manejar el centro de datos actual. <br><br>  Cuando caen muchos servidores en el centro de datos, el equilibrador comprende que este centro de datos no puede procesar todo el tr√°fico. <br><br>  Luego, el exceso de tr√°fico comienza distribuido aleatoriamente a otros centros de datos.  Todo funciona, todos est√°n felices. <br><br><img src="https://habrastorage.org/webt/cp/g-/if/cpg-ifevj3dzyvmedn1v-g5lzpg.jpeg"><br><h2>  C√≥mo lo hacemos: lanzamientos de lanzamiento </h2><br>  Ahora sobre c√≥mo publicamos los cambios realizados en el servicio.  Aqu√≠ tomamos el camino de los procesos de racionalizaci√≥n: el lanzamiento de una nueva versi√≥n est√° casi completamente automatizado. <br>  Cuando se acumula un cierto n√∫mero de cambios en el proyecto, se crea autom√°ticamente una nueva versi√≥n y se inicia su ensamblaje. <br><br><img src="https://habrastorage.org/webt/cy/to/0f/cyto0f3qhsuxs7bgd2momnccebe.jpeg"><br><br>  Luego, el servicio se implementa en pruebas, donde se verifica la estabilidad. <br><br>  Al mismo tiempo, se lanza la prueba autom√°tica de rendimiento.  √âl se dedica a un servicio especial.  No hablar√© de √©l ahora: su descripci√≥n es digna de un art√≠culo separado. <br><br>  Si la publicaci√≥n en la prueba es exitosa, la publicaci√≥n de la versi√≥n en preestablecida comienza autom√°ticamente.  Prestable es un cl√∫ster especial donde se dirige el tr√°fico normal de usuarios.  Si devuelve un error, el equilibrador se reinicia en producci√≥n. <br><br>  En predecible, los tiempos de respuesta se miden y comparan con el lanzamiento anterior en producci√≥n.  Si todo est√° bien, entonces la persona se conecta: verifica los gr√°ficos y los resultados de las pruebas de carga y luego comienza a implementarse en producci√≥n. <br><br><h2>  Todo lo mejor para el usuario: pruebas A / B </h2><br>  No siempre es obvio si los cambios en el servicio traer√°n beneficios reales.  Para medir la utilidad del cambio, a las personas se les ocurri√≥ una prueba A / B.  Hablar√© un poco sobre c√≥mo funciona esto en Yandex. B√∫squeda de mercado. <br><br>  Todo comienza con la adici√≥n de un nuevo par√°metro CGI que incluye una nueva funcionalidad.  Deje que nuestro par√°metro sea: <i>market_new_functionality = 1</i> .  Luego, en el c√≥digo, habilite esta funcionalidad con la bandera: <br><br><pre><code class="cpp hljs">If (cgi.experiments.market_new_functionality) { <span class="hljs-comment"><span class="hljs-comment">// enable new functionality }</span></span></code> </pre> <br>  Nueva funcionalidad se implementa en producci√≥n. <br><br>  Existe un servicio dedicado para automatizar las pruebas A / B, que se <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">describe</a> en detalle <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> .  Se crea un experimento en el servicio.  La cuota de tr√°fico se establece, por ejemplo, 15%.  El inter√©s no se establece para las solicitudes, sino para los usuarios.  Tambi√©n se indica el tiempo del experimento, por ejemplo, una semana. <br><br>  Se pueden comenzar varios experimentos al mismo tiempo.  En la configuraci√≥n, puede especificar si es posible la intersecci√≥n con otros experimentos. <br><br>  Como resultado, el servicio agrega autom√°ticamente el argumento <i>market_new_functionality = 1</i> al 15% de los usuarios.  Tambi√©n calcula autom√°ticamente las m√©tricas seleccionadas.  Despu√©s del experimento, los analistas miran los resultados y sacan conclusiones.  En base a los hallazgos, se toma la decisi√≥n de implementar la producci√≥n o el refinamiento. <br><br><h2>  Mano √°gil del mercado: pruebas de producci√≥n </h2><br>  A menudo sucede que es necesario verificar el funcionamiento de la nueva funcionalidad en la producci√≥n, pero no hay certeza de c√≥mo se comportar√° en condiciones de "combate" bajo cargas pesadas. <br><br>  Hay una soluci√≥n: los indicadores en los par√°metros CGI se pueden usar no solo para las pruebas A / B, sino tambi√©n para probar nuevas funcionalidades. <br><br>  Creamos una herramienta que le permite cambiar instant√°neamente la configuraci√≥n en miles de servidores sin exponer el servicio a riesgos.  Se llama "Stop Crane".  La idea original era la capacidad de desactivar r√°pidamente algunas funciones sin dise√±o.  Luego, la herramienta se expandi√≥ y se volvi√≥ m√°s compleja. <br><br>  El esquema del servicio se presenta a continuaci√≥n: <br><br><img src="https://habrastorage.org/webt/va/la/n8/valan8guj5dkld2j788pw7ytbwy.jpeg"><br><br>  La API establece valores de bandera.  El servicio de gesti√≥n almacena estos valores en una base de datos.  Todos los servidores van a la base de datos una vez cada diez segundos, bombean los valores de las banderas y aplican estos valores a cada solicitud. <br><br>  En Stop Crane, puede establecer dos tipos de valores: <br><br>  1) Expresiones condicionales.  Aplicar cuando se ejecuta uno de los valores.  Por ejemplo: <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"condition"</span></span>:<span class="hljs-string"><span class="hljs-string">"IS_DC1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"value"</span></span>:<span class="hljs-string"><span class="hljs-string">"3"</span></span>, }, { <span class="hljs-attr"><span class="hljs-attr">"condition"</span></span>: <span class="hljs-string"><span class="hljs-string">"CLUSTER==2 and IS_BERU"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">"4!"</span></span> }</code> </pre> <br>  El valor "3" se aplicar√° cuando la solicitud se procese en la ubicaci√≥n DC1.  Y el valor es "4" cuando la solicitud se procesa en el segundo cl√∫ster para el sitio beru.ru. <br><br>  2) Valores incondicionales.  Se usan por defecto si no se cumple ninguna de las condiciones.  Por ejemplo: <br><br>  <i>valor, valor!</i> <br><br>  Si el valor termina con un signo de exclamaci√≥n, se le da una prioridad m√°s alta. <br><br>  El analizador de los par√°metros CGI analiza la URL.  Luego aplica los valores del stop tap. <br><br>  Se aplican valores con las siguientes prioridades: <br><br><ol><li>  Mayor prioridad de detener el toque (signo de exclamaci√≥n). </li><li>  El valor de la consulta. </li><li>  El valor predeterminado es desde el grifo de parada. </li><li>  El valor predeterminado en el c√≥digo. </li></ol><br>  Hay muchos indicadores que se indican en valores condicionales; son suficientes para todos los escenarios que conocemos: <br><br><ul><li>  Centro de datos. </li><li>  Medio ambiente: producci√≥n, pruebas, sombra. </li><li>  Lugar: mercado, beru. </li><li>  N√∫mero de grupo </li></ul><br>  Con esta herramienta, puede habilitar una nueva funcionalidad en un grupo de servidores (por ejemplo, solo en un centro de datos) y verificar el funcionamiento de esta funcionalidad sin mucho riesgo para todo el servicio.  Incluso si cometi√≥ un error grave en alguna parte, todo comenz√≥ a caer y todo el centro de datos cay√≥, los equilibradores redirigir√°n las solicitudes a otro centro de datos.  Los usuarios finales no notar√°n nada. <br><br>  Si observa un problema, puede devolver inmediatamente el valor anterior de la bandera, y los cambios se revertir√°n. <br><br>  Este servicio tiene sus inconvenientes: a los desarrolladores les encanta y, a menudo, intentan introducir todos los cambios en Stop Crane.  Estamos tratando de combatir el mal uso. <br><br>  El enfoque Stop Crane funciona bien cuando ya tiene un c√≥digo estable, listo para implementarse en producci√≥n.  Al mismo tiempo, a√∫n tiene dudas y desea verificar el c√≥digo en condiciones de "combate". <br><br>  Sin embargo, la llave de paso no es adecuada para realizar pruebas durante el desarrollo.  Para los desarrolladores, hay un cl√∫ster separado llamado "cl√∫ster sombra". <br><br><h2>  Prueba encubierta: cluster de sombra </h2><br>  Las solicitudes de uno de los cl√∫steres se duplican en el cl√∫ster de sombra.  Pero el equilibrador ignora por completo las respuestas de este cl√∫ster.  El esquema de su trabajo se presenta a continuaci√≥n. <br><br><img src="https://habrastorage.org/webt/ie/xt/dp/iextdpgmvcam7ehqatcbwdjyjxe.jpeg"><br><br>  Obtenemos un grupo de prueba que est√° en condiciones reales de "combate".  El tr√°fico normal de usuarios vuela all√≠.  El hardware en ambos cl√∫steres es el mismo, por lo que puede comparar el rendimiento y los errores. <br><br>  Y dado que el equilibrador ignora por completo las respuestas, los usuarios finales no ver√°n las respuestas del cl√∫ster de sombra.  Por lo tanto, no da miedo cometer un error. <br><br><h2>  Conclusiones </h2><br>  Entonces, ¬øc√≥mo construimos una b√∫squeda de mercado? <br><br>  Para que todo funcione sin problemas, separamos la funcionalidad en servicios separados.  Por lo tanto, puede escalar solo los componentes que necesitamos y simplificar los componentes.  Es f√°cil dar un componente separado a otro equipo y compartir responsabilidades para trabajar en √©l.  Y un ahorro significativo en hierro con este enfoque es una ventaja obvia. <br><br>  El cl√∫ster de sombra tambi√©n nos ayuda: puede desarrollar servicios, probarlos en el proceso y al mismo tiempo no molestar al usuario. <br><br>  Bueno y verifica la producci√≥n, por supuesto.  ¬øNecesita cambiar la configuraci√≥n en mil servidores?  F√°cil, use una gr√∫a de parada.  Por lo tanto, puede implementar inmediatamente una soluci√≥n compleja lista para usar y volver a una versi√≥n estable si surgen problemas. <br><br>  Espero haber podido mostrar c√≥mo hacemos que el mercado sea r√°pido y estable con una base de ofertas cada vez mayor.  C√≥mo resolver problemas del servidor, atender una gran cantidad de solicitudes, mejorar la flexibilidad del servicio y hacerlo sin interrumpir los procesos de trabajo. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/475848/">https://habr.com/ru/post/475848/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../475834/index.html">Scrum no te ayudar√°. Entendemos por qu√©</a></li>
<li><a href="../475836/index.html">Entrevista con Arthur Khachuyan: ¬øc√≥mo calcular un multimillonario en las redes sociales?</a></li>
<li><a href="../475838/index.html">CAMBIO de personas. O ... cambiar a las personas. Sobre c√≥mo "despegar" el proyecto de transformaci√≥n</a></li>
<li><a href="../475840/index.html">Cliente API Badoo Jira: magia en Jira en PHP</a></li>
<li><a href="../475842/index.html">¬øReemplazar URL de acci√≥n y URI en tel√©fonos SIP o administrar a trav√©s de websockets?</a></li>
<li><a href="../475850/index.html">C√≥mo comenzar a desarrollar una carrera en TI, si a√∫n no tiene experiencia</a></li>
<li><a href="../475854/index.html">Grupos JDBC y manejo eficiente de archivos: Java mitap 3 de diciembre en San Petersburgo</a></li>
<li><a href="../475856/index.html">Google App Script, Mikrotik, Telegram y VPNBook comenzaron a tocar un cuarteto</a></li>
<li><a href="../475858/index.html">Entretenida criptoenerg√≠a: el calor de la miner√≠a para los humanos y el calor de los humanos para la miner√≠a</a></li>
<li><a href="../475860/index.html">Apache NiFi. 28 de noviembre en la sala de conferencias Deworkacy</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>