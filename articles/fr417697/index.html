<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚿 🛸 👷🏼 Éditeur d'images simple sur VueJS 🎅🏽 🔸 🤳🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Récemment, j'ai eu l'occasion d'écrire un service pour une boutique en ligne qui aiderait à passer une commande pour imprimer mes photos. 

 Le servic...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Éditeur d'images simple sur VueJS</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/417697/">  Récemment, j'ai eu l'occasion d'écrire un service pour une boutique en ligne qui aiderait à passer une commande pour imprimer mes photos. <br><br>  Le service a supposé un éditeur d'image «simple», dont je voudrais partager la création.  Et tout cela parce que parmi l'abondance de toutes sortes de plug-ins, je n'ai pas trouvé de fonctionnalité appropriée, en plus, les nuances des transformations CSS, sont soudain devenues une tâche très non triviale pour moi. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/884/ce8/2b3/884ce82b3d7a7c04c28705fd678fa6aa.jpg" alt="image"><br><a name="habracut"></a><br><h3>  Les tâches principales: </h3><br><ol><li>  Possibilité de télécharger des images depuis votre appareil, Google Drive et Instagram. </li><li>  Édition d'image: déplacement, rotation, réflexion horizontale et verticale, zoom, alignement automatique de l'image pour remplir la zone de recadrage. </li></ol><br>  Si le sujet s'avère intéressant, dans la prochaine publication, je décrirai en détail l'intégration avec Google Drive et Instagram dans la partie backend de l'application, où le populaire package NodeJS + Express a été utilisé. <br><br>  Pour l'organisation du frontend, j'ai choisi le merveilleux framework Vue.  Tout simplement parce que cela m'inspire après une réaction angulaire et agaçante.  Je pense que cela n'a aucun sens de décrire l'architecture, les routes et autres composants, passons directement à l'éditeur. <br><br>  À propos, la démo de l'éditeur peut être piquée <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . <br><br>  Nous aurons besoin de deux composants: <br><br>  <b>Modifier</b> - contiendra la logique et les commandes principales <br>  <b>Aperçu</b> - sera responsable de l'affichage de l'image <br><br><div class="spoiler">  <b class="spoiler_title">Modification du modèle de composant:</b> <div class="spoiler_text"><pre><code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Edit</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Preview</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">v-if</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"image"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ref</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"preview"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:matrix</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"matrix"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:image</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"image"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:transform</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"transform"</span></span></span><span class="hljs-tag"> @</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">resized</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"areaResized"</span></span></span><span class="hljs-tag"> @</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">loaded</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"imageLoaded"</span></span></span><span class="hljs-tag"> @</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">moved</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"imageMoved"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"range"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:min</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"minZoom"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:max</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"maxZoom"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">step</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"any"</span></span></span><span class="hljs-tag"> @</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">change</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"onZoomEnd"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">v-model.number</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"transform.zoom"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:disabled</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"!imageReady"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> @</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">click</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"rotateMinus"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:disabled</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"!imageReady"</span></span></span><span class="hljs-tag">&gt;</span></span>Rotate left<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> @</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">click</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"rotatePlus"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:disabled</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"!imageReady"</span></span></span><span class="hljs-tag">&gt;</span></span>Rotate right<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> @</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">click</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"flipY"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:disabled</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"!imageReady"</span></span></span><span class="hljs-tag">&gt;</span></span>Flip horizontal<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> @</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">click</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"flipX"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:disabled</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"!imageReady"</span></span></span><span class="hljs-tag">&gt;</span></span>Flip vertical<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Edit</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br></div></div><br>  Le composant Aperçu peut déclencher 3 événements: <br><br>  <i>chargé</i> - événement de chargement d'image <br>  <i>redimensionné</i> - événement de <i>redimensionnement de la</i> fenêtre <br>  <i>déplacé</i> - image événement en mouvement <br><br>  Paramètres: <br><br>  <i>image</i> - lien <i>image</i> <br>  <i>matrix</i> - matrice de transformation pour transformer la propriété CSS <br>  <i>transformer</i> - un objet qui décrit la transformation <br><br>  Afin de mieux contrôler la position de l'image, img a un positionnement absolu et la propriété <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">transform-origin</a> , le point de référence de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">transformation</a> , est définie sur la valeur initiale "0 0", qui correspond à l'origine dans le coin supérieur gauche de l'original (avant transformation!) Image. <br><br>  Le principal problème que j'ai rencontré est que vous devez vous assurer que le point d'origine de la transformation est toujours au centre de la zone d'édition, sinon, pendant les transformations, la partie sélectionnée de l'image se décale.  L'utilisation de cette <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">matrice de transformation</a> permet de résoudre ce problème. <br><br><h3>  Modification des composants </h3><br><div class="spoiler">  <b class="spoiler_title">Propriétés du composant Edit:</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> { <span class="hljs-attr"><span class="hljs-attr">components</span></span>: { Preview }, data () { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">image</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">imageReady</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">imageRect</span></span>: {}, <span class="hljs-comment"><span class="hljs-comment">//   areaRect: {}, //   minZoom: 1, //   maxZoom: 1, //   //   transform: { center: { x: 0, y: 0, }, zoom: 1, rotate: 0, flip: false, flop: false, x: 0, y: 0 } } }, computed: { matrix() { let scaleX = this.transform.flop ? -this.transform.zoom : this.transform.zoom; let scaleY = this.transform.flip ? -this.transform.zoom : this.transform.zoom; let tx = this.transform.x; let ty = this.transform.y; const cos = Math.cos(this.transform.rotate * Math.PI / 180); const sin = Math.sin(this.transform.rotate * Math.PI / 180); let a = Math.round(cos)*scaleX; let b = Math.round(sin)*scaleX; let c = -Math.round(sin)*scaleY; let d = Math.round(cos)*scaleY; return { a, b, c, d, tx, ty }; } }, ... }</span></span></code> </pre><br></div></div><br>  Les valeurs de imageRect et areaRect nous sont transmises par le composant Preview, appelant respectivement les méthodes imageLoaded et areaResized, les objets ont la structure: <br><br><pre> <code class="javascript hljs">{ <span class="hljs-attr"><span class="hljs-attr">size</span></span>: { <span class="hljs-attr"><span class="hljs-attr">width</span></span>: <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-attr"><span class="hljs-attr">height</span></span>: <span class="hljs-number"><span class="hljs-number">100</span></span> }, <span class="hljs-attr"><span class="hljs-attr">center</span></span>: { <span class="hljs-attr"><span class="hljs-attr">x</span></span>: <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-attr"><span class="hljs-attr">y</span></span>: <span class="hljs-number"><span class="hljs-number">50</span></span> } }</code> </pre><br>  Les valeurs centrales peuvent être calculées à chaque fois, mais il est plus facile de les noter une fois. <br><br>  La propriété de matrice calculée correspond aux mêmes coefficients de la matrice de transformation. <br><br>  La première tâche qui doit être résolue consiste à centrer l'image avec un rapport d'aspect arbitraire dans la zone de recadrage, tandis que l'image doit pouvoir s'adapter complètement, les zones non remplies (uniquement) au-dessus et en dessous, ou (uniquement) à gauche et à droite sont acceptables.  Avec toutes les transformations, cette condition doit être maintenue. <br><br>  Tout d'abord, nous limiterons les valeurs de zoom, pour cela nous vérifierons le rapport hauteur / largeur, en tenant compte de l'orientation de l'image. <br><br><div class="spoiler">  <b class="spoiler_title">Méthodes des composants:</b> <div class="spoiler_text"><pre> <code class="javascript hljs"> _setMinZoom(){ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> rotate = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.matrix.c !== <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> horizontal = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.imageRect.size.height &lt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.imageRect.size.width; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> areaSize = (horizontal &amp;&amp; !rotate || !horizontal &amp;&amp; rotate) ? <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.areaRect.size.width : <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.areaRect.size.height; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> imageSize = horizontal ? <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.imageRect.size.width : <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.imageRect.size.height; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.minZoom = areaSize/imageSize; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.transform.zoom &lt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.minZoom) <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.transform.zoom = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.minZoom; }, _setMaxZoom(){ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.maxZoom = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.areaRect.size.width/config.image.minResolution; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.transform.zoom &gt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.maxZoom) <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.transform.zoom = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.maxZoom; },</code> </pre><br></div></div><br>  Passons maintenant aux transformations.  Pour commencer, nous décrivons les reflets, car ils ne décalent pas la zone visible de l'image. <br><br><div class="spoiler">  <b class="spoiler_title">Méthodes des composants:</b> <div class="spoiler_text"><pre> <code class="javascript hljs">flipX(){ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.matrix.b == <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.matrix.c == <span class="hljs-number"><span class="hljs-number">0</span></span> ? <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.transform.flip = !<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.transform.flip : <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.transform.flop = !<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.transform.flop; }, flipY(){ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.matrix.b == <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.matrix.c == <span class="hljs-number"><span class="hljs-number">0</span></span> ? <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.transform.flop = !<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.transform.flop : <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.transform.flip = !<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.transform.flip; },</code> </pre><br></div></div><br>  Les transformations de zoom, de rotation et de déplacement nécessiteront déjà des ajustements de l'origine de la transformation. <br><br><div class="spoiler">  <b class="spoiler_title">Méthodes des composants:</b> <div class="spoiler_text"><pre> <code class="javascript hljs">onZoomEnd(){ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._translate(); }, rotatePlus(){ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.transform.rotate += <span class="hljs-number"><span class="hljs-number">90</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._setMinZoom(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._translate(); }, rotateMinus(){ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.transform.rotate -= <span class="hljs-number"><span class="hljs-number">90</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._setMinZoom(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._translate(); }, imageMoved(translate){ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._translate(); },</code> </pre><br></div></div><br>  C'est la méthode <b>_translate qui</b> est responsable de toutes les subtilités des transformations.  Deux référentiels doivent être introduits.  Le premier, appelons-le zéro, commence dans le coin supérieur gauche de l'image, lorsque nous multiplions les coordonnées par la matrice de transformation, nous passons à un autre système de coordonnées, appelons-le local.  Dans ce cas, nous pouvons inverser la transition du local au zéro en trouvant la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">matrice de</a> transformation <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">inverse</a> . <br><br>  Il s'avère que nous avons besoin de deux fonctions. <br><br>  La première consiste à passer de zéro au système local, le navigateur effectue les mêmes conversions lorsque nous spécifions la propriété de transformation css. <br><br><pre> <code class="css hljs"><span class="hljs-selector-tag"><span class="hljs-selector-tag">img</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">transform</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">matrix</span></span>(a, b, c, d, tx, ty); }</code> </pre><br>  La seconde - pour trouver les coordonnées originales de l'image, ayant déjà transformé les coordonnées. <br><br>  Il est plus pratique d'écrire ces fonctions en utilisant des méthodes d'une classe distincte. <br><br><div class="spoiler">  <b class="spoiler_title">Transformer la classe:</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Transform</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(center, matrix){ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.init(center, matrix); } init(center, matrix){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(center) <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.center = <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.assign({},center); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(matrix) <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.matrix = <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.assign({},matrix); } getOrigins(current){ <span class="hljs-comment"><span class="hljs-comment">//     let tr = {x: current.x - this.center.x, y: current.y - this.center.y}; //         const det = 1/(this.matrix.a*this.matrix.d - this.matrix.c*this.matrix.b); const x = ( this.matrix.d*(tr.x - this.matrix.tx) - this.matrix.c*(tr.y - this.matrix.ty) ) * det + this.center.x; const y = (-this.matrix.b*(tr.x - this.matrix.tx) + this.matrix.a*(tr.y - this.matrix.ty) ) * det + this.center.y; return {x, y}; } translate(current){ //     const origin = {x: current.x - this.center.x, y: current.y - this.center.y}; //        let x = this.matrix.a*origin.x + this.matrix.c*origin.y + this.matrix.tx + this.center.x; let y = this.matrix.b*origin.x + this.matrix.d*origin.y + this.matrix.ty + this.center.y; return {x, y}; } }</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">_Méthode de traduction avec commentaires détaillés:</b> <div class="spoiler_text"><pre> <code class="javascript hljs">_translate(checkAlign = <span class="hljs-literal"><span class="hljs-literal">true</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> tr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Transform(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.transform.center, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.matrix); <span class="hljs-comment"><span class="hljs-comment">// , ,  ,       const newCenter = tr.getOrigins(this.areaRect.center); this.transform.center = newCenter; //      this.transform.x = this.areaRect.center.x - newCenter.x; this.transform.y = this.areaRect.center.y - newCenter.y; //   tr.init(this.transform.center, this.matrix); //        ,      let x0y0 = tr.translate({x: 0, y: 0}); let x1y1 = tr.translate({x: this.imageRect.size.width, y: this.imageRect.size.height}); //  (  )       let result = { left: x1y1.x - x0y0.x &gt; 0 ? x0y0.x : x1y1.x, top: x1y1.y - x0y0.y &gt; 0 ? x0y0.y : x1y1.y, width: Math.abs(x1y1.x - x0y0.x), height: Math.abs(x1y1.y - x0y0.y) }; //       ,   "" let rightOffset = this.areaRect.size.width - (result.left + result.width); let bottomOffset = this.areaRect.size.height - (result.top + result.height); let alignedCenter; //   if(this.areaRect.size.width - result.width &gt; 1){ //align center X alignedCenter = tr.getOrigins({x: result.left + result.width/2, y: this.areaRect.center.y}); }else{ //align left if(result.left &gt; 0){ alignedCenter = tr.getOrigins({x: result.left + this.areaRect.center.x, y: this.areaRect.center.y}); //align right }else if(rightOffset &gt; 0){ alignedCenter = tr.getOrigins({x: this.areaRect.center.x - rightOffset, y: this.areaRect.center.y}); } } if(alignedCenter){ this.transform.center = alignedCenter; this.transform.x = this.areaRect.center.x - alignedCenter.x; this.transform.y = this.areaRect.center.y - alignedCenter.y; tr.init(this.transform.center, this.matrix); } //   if(this.areaRect.size.height - result.height &gt; 1){ //align center Y alignedCenter = tr.getOrigins({x: this.areaRect.center.x, y: result.top + result.height/2}); }else{ //align top if(result.top &gt; 0){ alignedCenter = tr.getOrigins({x: this.areaRect.center.x, y: result.top + this.areaRect.center.y}); //align bottom }else if(bottomOffset &gt; 0){ alignedCenter = tr.getOrigins({x: this.areaRect.center.x, y: this.areaRect.center.y - bottomOffset}); } } if(alignedCenter){ this.transform.center = alignedCenter; this.transform.x = this.areaRect.center.x - alignedCenter.x; this.transform.y = this.areaRect.center.y - alignedCenter.y; tr.init(this.transform.center, this.matrix); } },</span></span></code> </pre><br></div></div><br>  L'alignement crée l'effet de «coller» l'image sur les bords du recadrage, en évitant les champs vides. <br><br><h3>  Composant d'aperçu </h3><br>  La tâche principale de ce composant est d'afficher l'image, d'appliquer des transformations et de répondre au mouvement du bouton de la souris pris en sandwich sur l'image.  En calculant le décalage, nous mettons à jour les paramètres <b>transform.x</b> et <b>transform.y</b> , à la fin du mouvement, nous déclenchons l'événement <b>déplacé</b> , indiquant au composant Edit que nous devons recalculer la position du centre de transformation et ajuster transform.x et transform.y. <br><br><div class="spoiler">  <b class="spoiler_title">Aperçu du modèle de composant:</b> <div class="spoiler_text">  &lt;div ref = "area" class = "edit-zone" <br>  @ mousedown = "onMoveStart" <br>  @ touchstart = "onMoveStart" <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">mouseup</a> = "onMoveEnd" <br>  @ touchend = "onMoveEnd" <br>  @ mousemove = "onMove" <br>  @ touchmove = "onMove"&gt; <br>  &lt;img <br>  v-if = "image" <br>  ref = "image" <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">load</a> = "imageLoaded" <br>  : src = "image" <br>  : style = "{'transform': transformStyle, 'transform-origin': transformOrigin}"&gt; <br></div></div><br>  La fonctionnalité de l'éditeur est parfaitement séparée du projet principal et se trouve <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . <br><br>  J'espère que ce matériel vous sera utile.  Je vous remercie! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr417697/">https://habr.com/ru/post/fr417697/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr417683/index.html">Code obsolète - Code tiers</a></li>
<li><a href="../fr417685/index.html">Webinaires Skillbox Friday: continuer à apprendre gratuitement</a></li>
<li><a href="../fr417687/index.html">Asymétrie de vie</a></li>
<li><a href="../fr417689/index.html">Mobio s'entretient avec le PDG d'Appnext sur le marché du CPI et les tendances des applications mobiles</a></li>
<li><a href="../fr417691/index.html">Notre étagère est un programmeur C #. Et vous?</a></li>
<li><a href="../fr417699/index.html">Western Digital ferme une autre usine de disques durs en raison de la baisse de la demande</a></li>
<li><a href="../fr417701/index.html">Des scripts simples à l'application client-serveur à faire soi-même sur WCF: pourquoi j'aime travailler en CM</a></li>
<li><a href="../fr417703/index.html">Code réseau Age of Empires: 1 500 archers par modem à 28,8 kbps</a></li>
<li><a href="../fr417705/index.html">Comment un fabricant de cartes graphiques affecte la rentabilité de l'exploitation de GPU</a></li>
<li><a href="../fr417707/index.html">CSS-in-JS - mythes et réalité (composants de style comme exemple)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>