<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ¤¾ ğŸš† ğŸ’— å¯åŠ¨Spring StateMachine ğŸ‰ ğŸ‘©ğŸ¿â€âš•ï¸ ğŸšŒ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="å‚èµ›ä½œå“ 
 åœ¨é¡¹ç›®ä¸­ï¼Œæˆ‘é‡åˆ°äº†ä¸‰ä¸ªä¾‹å­ï¼Œä¸€ç§æˆ–å¦ä¸€ç§ä¸æœ‰é™è‡ªåŠ¨æœºç†è®ºç›¸å…³çš„ä¾‹å­ 



- ç¤ºä¾‹1. ä¸€ä¸ªæœ‰è¶£çš„ govnokod ä»£ç  ã€‚ éœ€è¦èŠ±è´¹å¤§é‡æ—¶é—´æ¥äº†è§£æ­£åœ¨å‘ç”Ÿçš„äº‹æƒ…ã€‚ ä»£ç ä¸­æ‰€ç¤ºç†è®ºçš„å®æ–½ä¾‹çš„ç‰¹å¾æ˜¯ç›¸å½“çŒ›çƒˆçš„è½¬å‚¨ï¼Œæœ‰æ—¶éå¸¸ç±»ä¼¼äºè¿‡ç¨‹ä»£ç ã€‚ æ­¤ç‰ˆæœ¬çš„ä»£ç æœ€å¥½ä¸è¦æ¥è§¦é¡¹ç›®ï¼Œè¿™ä¸€äº‹å®çŸ¥é“æ¯...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>å¯åŠ¨Spring StateMachine</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/462371/"><h3> å‚èµ›ä½œå“ </h3><br> åœ¨é¡¹ç›®ä¸­ï¼Œæˆ‘é‡åˆ°äº†ä¸‰ä¸ªä¾‹å­ï¼Œä¸€ç§æˆ–å¦ä¸€ç§ä¸<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æœ‰é™è‡ªåŠ¨æœºç†è®ºç›¸å…³çš„</a>ä¾‹å­ <br><br><ul><li> ç¤ºä¾‹1. <b>ä¸€ä¸ªæœ‰è¶£çš„</b> <s>govnokod</s> <b>ä»£ç </b> ã€‚ éœ€è¦èŠ±è´¹å¤§é‡æ—¶é—´æ¥äº†è§£æ­£åœ¨å‘ç”Ÿçš„äº‹æƒ…ã€‚ ä»£ç ä¸­æ‰€ç¤ºç†è®ºçš„å®æ–½ä¾‹çš„ç‰¹å¾æ˜¯ç›¸å½“çŒ›çƒˆçš„è½¬å‚¨ï¼Œæœ‰æ—¶éå¸¸ç±»ä¼¼äºè¿‡ç¨‹ä»£ç ã€‚ æ­¤ç‰ˆæœ¬çš„ä»£ç æœ€å¥½ä¸è¦æ¥è§¦é¡¹ç›®ï¼Œè¿™ä¸€äº‹å®çŸ¥é“æ¯ä¸ªæŠ€æœ¯äººå‘˜ï¼Œæ–¹æ³•ä¸“å®¶å’Œäº§å“ä¸“å®¶ã€‚ ä»–ä»¬ä½¿ç”¨æ­¤ä»£ç æ¥ä¿®å¤ç´§æ€¥æƒ…å†µï¼ˆå½“å®ƒå®Œå…¨æŸåæ—¶ï¼‰ï¼Œæ¯«æ— ç–‘é—®åœ°å®Œæˆä»»ä½•åŠŸèƒ½ã€‚ å› ä¸ºå®ƒä»¤äººææƒ§ã€‚ éš”ç¦»æ­¤ç±»å‹çš„ç¬¬äºŒä¸ªé†’ç›®çš„åŠŸèƒ½æ˜¯è¿™ç§åŠŸèƒ½å¼ºå¤§çš„å¼€å…³ï¼ˆå…¨å±ï¼‰ã€‚ <br> è¿™ä¸ªåˆ†æ•°ç”šè‡³æœ‰ä¸ªç©ç¬‘ï¼š <a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">æœ€ä½³å°ºå¯¸</b> <div class="spoiler_text"> åœ¨å…¶ä¸­ä¸€ä¸ªJPointä¸Šï¼Œä¸€ä½å‘è¨€äººï¼Œä¹Ÿè®¸æ˜¯Nikolai Alimenkovï¼Œè°ˆåˆ°äº†åˆ‡æ¢ä¸­æœ‰å¤šå°‘æƒ…å†µæ˜¯æ­£å¸¸çš„ï¼Œä»–è¯´æœ€é‡è¦çš„ç­”æ¡ˆæ˜¯â€œåˆ°ç›®å‰ä¸ºæ­¢é€‚åˆå±å¹•â€ã€‚ å› æ­¤ï¼Œå¦‚æœå¹²æ‰°å¹¶ä¸”æ‚¨çš„å¼€å…³å·²ç»ä¸æ­£å¸¸ï¼Œè¯·åœ¨IDEä¸­å‡å°å­—ä½“å¤§å° <br></div></div></li><li> ç¤ºä¾‹2. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><b>æ¨¡å¼çŠ¶æ€</b></a> ã€‚ ä¸»è¦æƒ³æ³•ï¼ˆå¯¹äºé‚£äº›ä¸å–œæ¬¢ä½¿ç”¨é“¾æ¥çš„äººï¼‰æ˜¯ï¼Œæˆ‘ä»¬å°†æŸä¸ªä¸šåŠ¡ä»»åŠ¡åˆ†è§£ä¸ºä¸€ç»„æœ€ç»ˆçŠ¶æ€ï¼Œå¹¶ç”¨ä»£ç å¯¹å…¶è¿›è¡Œæè¿°ã€‚ <br> æ¨¡å¼çŠ¶æ€çš„ä¸»è¦ç¼ºç‚¹æ˜¯çŠ¶æ€å½¼æ­¤äº†è§£ï¼Œå®ƒä»¬çŸ¥é“æœ‰å…„å¼Ÿå¹¶äº’ç›¸å‘¼å«ã€‚ è¿™æ ·çš„ä»£ç å¾ˆéš¾é€šç”¨ã€‚ ä¾‹å¦‚ï¼Œåœ¨å®ç°å…·æœ‰å¤šç§ä»˜æ¬¾æ–¹å¼çš„ä»˜æ¬¾ç³»ç»Ÿæ—¶ï¼Œæ‚¨å¯èƒ½ä¼šå†’å……Generic-sçš„é£é™©ï¼Œä»¥è‡´äºæ–¹æ³•çš„å£°æ˜å¯èƒ½ä¼šå˜æˆè¿™æ ·ï¼š <cut></cut><br><br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> &lt; T extends BaseContextPayment, Q extends BaseDomainPaymentRequest, S, B extends AbstractPaymentDetailBuilder&lt;T, Q, S, B&gt;, F extends AbstractPaymentBuilder&lt;T, Q, S, B&gt; &gt; <span class="hljs-function"><span class="hljs-function">PaymentContext&lt;T, S&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">build</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Q request, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Class&lt;F&gt; factoryClass)</span></span></span></span>{ <span class="hljs-comment"><span class="hljs-comment">//""  }</span></span></code> </pre> <br> æ€»ç»“çŠ¶æ€ï¼šå®ç°å¯èƒ½å¯¼è‡´ç›¸å½“å¤æ‚çš„ä»£ç ã€‚ </li><li> ç¤ºä¾‹3 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">StateMachineæ¨¡å¼</a>çš„ä¸»è¦æ€æƒ³æ˜¯çŠ¶æ€ä¹‹é—´å½¼æ­¤ä¸€æ— æ‰€çŸ¥ï¼Œè¿‡æ¸¡æ§åˆ¶æ˜¯ç”±ä¸Šä¸‹æ–‡æ‰§è¡Œçš„ï¼Œå®ƒæ›´å¥½ï¼Œè¿æ¥æ€§æ›´å¼º-ä»£ç æ›´ç®€å•ã€‚ <br></li></ul><br> åœ¨ç»å†äº†ç¬¬ä¸€ç§ç±»å‹çš„æ‰€æœ‰â€œåŠŸèƒ½â€å’Œç¬¬äºŒç§ç±»å‹çš„å¤æ‚æ€§ä¹‹åï¼Œæˆ‘ä»¬å†³å®šå°†Pattern StateMachineç”¨äºæ–°çš„ä¸šåŠ¡æ¡ˆä¾‹ã€‚ <br> ä¸ºäº†ä¸é‡æ–°å‘æ˜è½®å­ï¼Œå†³å®šä»¥Statemachine Springä¸ºåŸºç¡€ï¼ˆè¿™å°±æ˜¯Springï¼‰ã€‚ <br><br> çœ‹å®ŒåŸºåº§ä¹‹åï¼Œæˆ‘å»äº†YouTubeå’ŒHabrï¼ˆäº†è§£äººä»¬å¦‚ä½•ä½¿ç”¨å®ƒï¼Œå®ƒåœ¨äº§å“ä¸Šçš„æ„Ÿè§‰ï¼Œä»€ä¹ˆæ ·çš„è€™å­ç­‰ï¼‰ã€‚äº‹å®è¯æ˜ï¼Œå¾ˆå°‘æœ‰ä¿¡æ¯ï¼Œåœ¨YouTubeä¸Šæœ‰å‡ ä¸ªè§†é¢‘ï¼Œéƒ½éå¸¸è‚¤æµ…ã€‚ åœ¨æœ‰å…³æ­¤ä¸»é¢˜çš„HabrÃ©ä¸Šï¼Œæˆ‘å‘ç°åªæœ‰ä¸€ç¯‡æ–‡ç« ä»¥åŠè§†é¢‘å¾ˆè‚¤æµ…ã€‚ <br> åœ¨ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œä¸å¯èƒ½æè¿°Spring statemachineå·¥ä½œçš„æ‰€æœ‰ç»†å¾®ä¹‹å¤„ï¼Œæ— æ³•æ·±å…¥ç ”ç©¶æ‰€æœ‰æ¡ˆä¾‹ï¼Œä½†æ˜¯æˆ‘ä¼šå°½åŠ›è®²å‡ºæœ€é‡è¦å’Œæœ€éœ€è¦çš„å†…å®¹ï¼Œå…³äºrakeï¼Œç‰¹åˆ«æ˜¯å¯¹æˆ‘æ¥è¯´ï¼Œå½“æˆ‘ç†Ÿæ‚‰æ¡†æ¶æ—¶ï¼Œä¸‹é¢çš„ä¿¡æ¯æ˜¯å°†éå¸¸æœ‰å¸®åŠ©ã€‚ <br><br><h3> ä¸»ä½“ </h3><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªSpring Bootåº”ç”¨ç¨‹åºï¼Œ</a>æ·»åŠ ä¸€ä¸ªWeb Starterï¼ˆä½¿Webåº”ç”¨ç¨‹åºå°½å¿«è¿è¡Œï¼‰ï¼Œè¯¥åº”ç”¨ç¨‹åºå°†æ˜¯è´­ä¹°è¿‡ç¨‹çš„æŠ½è±¡ã€‚ è´­ä¹°çš„äº§å“å°†ç»å†æ–°çš„ï¼Œä¿ç•™çš„ï¼Œä¿ç•™çš„ä¸‹é™å’Œè´­ä¹°å®Œæˆçš„é˜¶æ®µã€‚ <br> ä¸€ç‚¹å³å…´åˆ›ä½œï¼Œåœ¨ä¸€ä¸ªçœŸå®çš„é¡¹ç›®ä¸­ä¼šæœ‰æ›´å¤šçš„çŠ¶æ€ï¼Œä½†æ˜¯ï¼Œå“¦ï¼Œæˆ‘ä»¬ä¹Ÿæœ‰ä¸€ä¸ªéå¸¸çœŸå®çš„é¡¹ç›®ã€‚ <br> åœ¨æ–°çƒ˜ç„™çš„Webåº”ç”¨ç¨‹åºçš„pom.xmlä¸­ï¼Œæ·»åŠ å¯¹è®¡ç®—æœºåŠå…¶æµ‹è¯•çš„ä¾èµ–é¡¹ï¼ˆå¦‚æœé€šè¿‡<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">start.spring.io</a>æ”¶é›†ï¼Œåˆ™Web Starteråº”è¯¥å·²ç»å­˜åœ¨ï¼‰ï¼š <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.springframework.statemachine<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>spring-statemachine-core<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>2.1.3.RELEASE<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.springframework.statemachine<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>spring-statemachine-test<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>2.1.3.RELEASE<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">scope</span></span></span><span class="hljs-tag">&gt;</span></span>test<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">scope</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">cut</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre><br> åˆ›å»ºç»“æ„ï¼š <br><img src="https://habrastorage.org/webt/u8/nw/oq/u8nwoqaezenqp1pouozil4qjwno.png"><br> æˆ‘è¿˜ä¸éœ€è¦è¯¦ç»†ä»‹ç»è¿™ç§ç»“æ„ï¼Œæˆ‘å°†æŒ‰é¡ºåºè¯´æ˜æ‰€æœ‰å†…å®¹ï¼Œå¹¶ä¸”åœ¨æ–‡ç« æœ«å°¾å°†æä¾›æŒ‡å‘è¯¥æºçš„é“¾æ¥ã€‚ <br><br> æ‰€ä»¥èµ°å§ <br> æˆ‘ä»¬æœ‰ä¸€ä¸ªå¸¦æœ‰å¿…è¦ä¾èµ–é¡¹çš„å¹²å‡€é¡¹ç›®ï¼Œé¦–å…ˆï¼Œæˆ‘ä»¬å°†åˆ›å»ºå¸¦æœ‰çŠ¶æ€å’Œäº‹ä»¶çš„æšä¸¾ï¼Œä»¥åŠä¸€â€‹â€‹ä¸ªç›¸å½“ç®€å•çš„æŠ½è±¡ï¼Œè¿™äº›ç»„ä»¶æœ¬èº«ä¸åŒ…å«ä»»ä½•é€»è¾‘ã€‚ <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> PurchaseEvent { RESERVE, BUY, RESERVE_DECLINE }</code> </pre> <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> PurchaseState { NEW, RESERVED, CANCEL_RESERVED, PURCHASE_COMPLETE }</code> </pre> <br> å°½ç®¡ä»å½¢å¼ä¸Šæ¥è¯´ï¼Œæ‚¨å¯ä»¥å‘è¿™äº›æšä¸¾æ·»åŠ å­—æ®µï¼Œå¹¶åœ¨å…¶ä¸­å¯¹æŸäº›å…·æœ‰æŸç§é€»è¾‘ç‰¹å¾çš„ä¸œè¥¿è¿›è¡Œç¡¬ç¼–ç ï¼Œè¿™æ˜¯å¾ˆåˆé€»è¾‘çš„ï¼ˆæˆ‘ä»¬å¾ˆæ–¹ä¾¿åœ°é€šè¿‡è§£å†³æƒ…å†µæ¥åšåˆ°è¿™ä¸€ç‚¹ï¼‰ã€‚ <br> æˆ‘ä»¬å°†é€šè¿‡java configé…ç½®æœºå™¨ï¼Œåˆ›å»ºé…ç½®æ–‡ä»¶ï¼Œå¹¶ä¸ºæ‰©å±•ç±»EnumStateMachineConfigurerAdapter &lt;PurchaseStateï¼ŒPurchaseEvent&gt;ã€‚ å› ä¸ºæˆ‘ä»¬çš„çŠ¶æ€å’Œäº‹ä»¶æ˜¯æšä¸¾ï¼Œæ‰€ä»¥æ¥å£æ˜¯åˆé€‚çš„ï¼Œä½†ä¸æ˜¯å¿…é¡»çš„ï¼Œä»»ä½•ç±»å‹çš„å¯¹è±¡éƒ½å¯ä»¥ç”¨ä½œæ³›å‹ï¼ˆç”±äºæˆ‘è®¤ä¸ºEnumStateMachineConfigurerAdapterç»°ç»°æœ‰ä½™ï¼Œå› æ­¤æˆ‘ä»¬ä¸ä¼šè€ƒè™‘æœ¬æ–‡ä¸­çš„å…¶ä»–ç¤ºä¾‹ï¼‰ã€‚ <br><br> ä¸‹ä¸€ä¸ªè¦ç‚¹æ˜¯ï¼Œä¸€å°æœºå™¨æ˜¯å¦å°†é©»ç•™åœ¨åº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡ä¸­ï¼šåœ¨@EnableStateMachineçš„å•ä¸ªå®ä¾‹ä¸­ï¼Œè¿˜æ˜¯æ¯æ¬¡åˆ›å»ºæ–°çš„@EnableStateMachineFactoryæ—¶ã€‚ å¦‚æœè¿™æ˜¯ä¸€ä¸ªæœ‰å¤§é‡ç”¨æˆ·çš„å¤šç”¨æˆ·Webåº”ç”¨ç¨‹åºï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªé€‰é¡¹å‡ ä¹ä¸é€‚åˆæ‚¨ï¼Œå› æ­¤æˆ‘ä»¬å°†ä½¿ç”¨ç¬¬äºŒä¸ªé€‰é¡¹ä½œä¸ºæ›´æµè¡Œçš„é€‰é¡¹ã€‚  StateMachineä¹Ÿå¯ä»¥é€šè¿‡æ„å»ºå™¨ä½œä¸ºå¸¸è§„beanåˆ›å»ºï¼ˆè¯·å‚é˜…æ–‡æ¡£ï¼‰ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹å¾ˆæ–¹ä¾¿ï¼ˆä¾‹å¦‚ï¼Œæ‚¨éœ€è¦å°†æœºå™¨æ˜¾å¼å£°æ˜ä¸ºbeanï¼‰ï¼Œå¦‚æœå®ƒæ˜¯å•ç‹¬çš„beanï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å‘Šè¯‰æˆ‘ä»¬æˆ‘ä»¬çš„èŒƒå›´ä¾‹å¦‚ä¼šè¯æˆ–è¯·æ±‚ã€‚ åœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­ï¼ŒåŒ…è£…å™¨ï¼ˆä¸šåŠ¡é€»è¾‘çš„ç‰¹å¾ï¼‰æ˜¯åœ¨çŠ¶æ€æœºbeanä¸Šå®ç°çš„ï¼ŒåŒ…è£…å™¨æ˜¯å•ä¾‹ï¼ŒåŸå‹æœºæœ¬èº« <br><div class="spoiler">  <b class="spoiler_title">è€™å­</b> <div class="spoiler_text"> å¦‚ä½•åœ¨Singltonä¸­å®ç°åŸå‹ï¼Ÿ <br> å®é™…ä¸Šï¼Œæ‚¨éœ€è¦åšçš„å°±æ˜¯æ¯æ¬¡è®¿é—®å¯¹è±¡æ—¶ä»applicationContextè·å–ä¸€ä¸ªæ–°beanã€‚ å°†applicationContextæ³¨å…¥ä¸šåŠ¡é€»è¾‘æ˜¯ä¸€ç§ç½ªè¿‡ï¼Œå› æ­¤ï¼ŒBeançŠ¶æ€æœºå¿…é¡»ä½¿ç”¨è‡³å°‘ä¸€ä¸ªæ–¹æ³•æˆ–æŠ½è±¡æ–¹æ³•ï¼ˆæ–¹æ³•æ³¨å…¥ï¼‰æ¥å®ç°æ¥å£ï¼Œåœ¨åˆ›å»ºJavaé…ç½®æ—¶ï¼Œæ‚¨å°†éœ€è¦å®ç°æ‰€æŒ‡ç¤ºçš„æŠ½è±¡æ–¹æ³•ï¼Œå¹¶ä¸”æˆ‘ä»¬å°†ä»applicationContextæ–°beanã€‚ é€šå¸¸çš„åšæ³•æ˜¯åœ¨configç±»ä¸­é“¾æ¥åˆ°applicationContextï¼Œé€šè¿‡æŠ½è±¡æ–¹æ³•ï¼Œæˆ‘ä»¬å°†è°ƒç”¨.getBeanï¼ˆï¼‰;ã€‚ <br></div></div><br>  EnumStateMachineConfigurerAdapterç±»æœ‰å‡ ç§æ–¹æ³•ï¼Œå®ƒä»¬è¦†ç›–äº†æˆ‘ä»¬é…ç½®æœºå™¨çš„æ–¹æ³•ã€‚ <br> é¦–å…ˆï¼Œæ³¨å†ŒçŠ¶æ€ï¼š <br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configure</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> StateMachineStateConfigurer&lt;PurchaseState, PurchaseEvent&gt; states)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ states .withStates() .initial(NEW) .end(PURCHASE_COMPLETE) .states(EnumSet.allOf(PurchaseState.class)); }</code> </pre> <br> åˆå§‹ï¼ˆNEWï¼‰æ˜¯æœºå™¨åœ¨åˆ›å»ºBeanä¹‹åå°†å¤„äºçš„çŠ¶æ€ï¼Œç»“æŸï¼ˆPURCHASE_COMPLETEï¼‰æ˜¯æœºå™¨å°†æ‰§è¡Œstatemachine.stopï¼ˆï¼‰çš„çŠ¶æ€ï¼Œå¯¹äºä¸ç¡®å®šçš„æœºå™¨ï¼ˆå…¶ä¸­å¤§å¤šæ•°ï¼‰æ˜¯æ— å…³ç´§è¦çš„ï¼Œä½†éœ€è¦æŒ‡å®šä¸€äº›å†…å®¹ã€‚  .statesï¼ˆEnumSet.allOfï¼ˆPurchaseState.classï¼‰æ‰€æœ‰çŠ¶æ€çš„åˆ—è¡¨ï¼Œæ‚¨å¯ä»¥æ‰¹é‡æ¨é€ã€‚ <br><br> é…ç½®å…¨å±€æœºå™¨è®¾ç½® <br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configure</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> StateMachineConfigurationConfigurer&lt;PurchaseState, PurchaseEvent&gt; config)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ config .withConfiguration() .autoStartup(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) .listener(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PurchaseStateMachineApplicationListener()); }</code> </pre> <br> åœ¨æ­¤ï¼ŒautoStartupç¡®å®šé»˜è®¤æƒ…å†µä¸‹æ˜¯å¦åœ¨åˆ›å»ºåè‡ªåŠ¨å¯åŠ¨è®¡ç®—æœºï¼Œæ¢å¥è¯è¯´-æ˜¯å¦å°†è‡ªåŠ¨åˆ‡æ¢åˆ°NEWçŠ¶æ€ï¼ˆé»˜è®¤ä¸ºfalseï¼‰ã€‚ ç«‹å³ï¼Œæˆ‘ä»¬ä¸ºæœºå™¨ä¸Šä¸‹æ–‡æ³¨å†Œä¸€ä¸ªä¾¦å¬å™¨ï¼ˆç¨åä»‹ç»ï¼‰ï¼Œåœ¨ç›¸åŒçš„é…ç½®ä¸­ï¼Œæ‚¨å¯ä»¥è®¾ç½®ä¸€ä¸ªå•ç‹¬çš„TaskExecutorï¼Œå½“å¯¹å®ƒä»¬çš„æŸäº›è½¬æ¢æ‰§è¡Œé•¿æ—¶é—´çš„Actionä¸”åº”ç”¨ç¨‹åºåº”è¯¥èµ°å¾—æ›´è¿œæ—¶ï¼Œè¿™å¾ˆæ–¹ä¾¿ã€‚ <br> å¥½å§ï¼Œè¿‡æ¸¡æœ¬èº«ï¼š <br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configure</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> StateMachineTransitionConfigurer&lt;PurchaseState, PurchaseEvent&gt; transitions)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ transitions .withExternal() .source(NEW) .target(RESERVED) .event(RESERVE) .action(reservedAction(), errorAction()) .and() .withExternal() .source(RESERVED) .target(CANCEL_RESERVED) .event(RESERVE_DECLINE) .action(cancelAction(), errorAction()) .and() .withExternal() .source(RESERVED) .target(PURCHASE_COMPLETE) .event(BUY) .guard(hideGuard()) .action(buyAction(), errorAction()); }</code> </pre> <br> åœ¨æ­¤å¤„è®¾ç½®äº†æ‰€æœ‰è½¬æ¢é€»è¾‘æˆ–è½¬æ¢é€»è¾‘ï¼ŒGuardå¯ä»¥æŒ‚åœ¨è½¬æ¢ä¸Šï¼Œä¸€ä¸ªå§‹ç»ˆè¿”å›å¸ƒå°”å€¼çš„ç»„ä»¶ï¼Œæ‚¨å°†è‡ªè¡Œå†³å®šä»ä¸€ä¸ªçŠ¶æ€åˆ°å¦ä¸€ç§çŠ¶æ€çš„è½¬æ¢ç©¶ç«Ÿè¦æ£€æŸ¥ä»€ä¹ˆï¼Œåœ¨Guardä¸­ä»»ä½•é€»è¾‘éƒ½å¯ä»¥å®Œç¾ï¼Œè¿™æ˜¯ä¸€ä¸ªå®Œå…¨æ™®é€šçš„ç»„ä»¶ä½†ä»–å¿…é¡»è¿”å›å¸ƒå°”å€¼ã€‚ ä¾‹å¦‚ï¼Œåœ¨æˆ‘ä»¬é¡¹ç›®çš„æ¡†æ¶å†…ï¼ŒHideGuardå¯ä»¥æ£€æŸ¥ç”¨æˆ·å¯ä»¥è®¾ç½®çš„æŸä¸ªè®¾ç½®ï¼ˆä¸æ˜¾ç¤ºæ­¤äº§å“ï¼‰ï¼Œå¹¶ä¸”æ ¹æ®å®ƒï¼Œä¸ä½¿è®¡ç®—æœºè¿›å…¥å—Guardä¿æŠ¤çš„çŠ¶æ€ã€‚ æˆ‘æ³¨æ„åˆ°ï¼ŒGuardï¼Œåªèƒ½å°†ä¸€ä¸ªæ·»åŠ åˆ°é…ç½®ä¸­çš„ä¸€ä¸ªè¿‡æ¸¡ä¸­ï¼Œè¿™æ ·çš„è®¾è®¡å°†è¡Œä¸é€šï¼š <br><pre> <code class="java hljs"> .withExternal() .source(RESERVED) .target(PURCHASE_COMPLETE) .event(BUY) .guard(hideGuard()) .guard(veryHideGuard())</code> </pre> <br> æ›´ç¡®åˆ‡åœ°è¯´ï¼Œå®ƒå°†èµ·ä½œç”¨ï¼Œä½†åªæœ‰ç¬¬ä¸€ä¸ªåå«ï¼ˆhideGuardï¼ˆï¼‰ï¼‰ <br> ä½†æ˜¯æ‚¨å¯ä»¥æ·»åŠ å‡ ä¸ªåŠ¨ä½œï¼ˆç°åœ¨æˆ‘ä»¬æ­£åœ¨è®¨è®ºåŠ¨ä½œï¼Œè¿™æ˜¯æˆ‘ä»¬åœ¨è¿‡æ¸¡é…ç½®ä¸­æŒ‡å®šçš„ï¼‰ï¼Œæˆ‘ä¸ªäººè¯•å›¾å°†ä¸‰ä¸ªåŠ¨ä½œæ·»åŠ åˆ°ä¸€ä¸ªè¿‡æ¸¡ä¸­ã€‚ <br><pre> <code class="java hljs"> .withExternal() .source(NEW) .target(RESERVED) .event(RESERVE) .action(reservedAction(), errorAction())</code> </pre> <br> ç¬¬äºŒä¸ªå‚æ•°æ˜¯ErrorActionï¼Œå¦‚æœReservedActionå¼•å‘å¼‚å¸¸ï¼ˆæŠ›å‡ºï¼‰ï¼Œåˆ™æ§ä»¶å°†è·å–å®ƒã€‚ <br><div class="spoiler">  <b class="spoiler_title">è€™å­</b> <div class="spoiler_text"> è¯·è®°ä½ï¼Œå¦‚æœåœ¨Actionä¸­ä»é€šè¿‡try / catchå¤„ç†é”™è¯¯ï¼Œåˆ™ä¸ä¼šè¿›å…¥ErrorActionï¼Œå¦‚æœéœ€è¦å¤„ç†å¹¶è¿›å…¥ErrorActionï¼Œåˆ™åº”ä»catchä¸­æŠ›å‡ºRuntimeExceptionï¼ˆï¼‰ï¼Œä¾‹å¦‚ï¼ˆæ‚¨è‡ªå·±è¯´è¿™æ˜¯éå¸¸å¿…è¦çš„ï¼‰ã€‚ <br></div></div><br> é™¤äº†åœ¨è¿‡æ¸¡ä¸­â€œæŒ‚èµ·â€åŠ¨ä½œå¤–ï¼Œæ‚¨è¿˜å¯ä»¥åœ¨çŠ¶æ€çŠ¶æ€çš„configureæ–¹æ³•ä¸­â€œæŒ‚èµ·â€åŠ¨ä½œï¼Œå¤§è‡´é‡‡ç”¨ä»¥ä¸‹å½¢å¼ï¼š <br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configure</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> StateMachineStateConfigurer&lt;PurchaseState, PurchaseEvent&gt; states)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ states .withStates() .initial(NEW) .end(PURCHASE_COMPLETE) .stateEntry() .stateExit() .state() .states(EnumSet.allOf(PurchaseState.class)); }</code> </pre> <br> è¿™å®Œå…¨å–å†³äºæ‚¨è¦å¦‚ä½•æ‰§è¡Œæ“ä½œã€‚ <br><div class="spoiler">  <b class="spoiler_title">è€™å­</b> <div class="spoiler_text"> è¯·æ³¨æ„ï¼Œå¦‚æœæ‚¨åœ¨é…ç½®çŠ¶æ€ï¼ˆï¼‰æ—¶æŒ‡å®šäº†æ“ä½œï¼Œä¾‹å¦‚ <br><pre> <code class="java hljs"> states .withStates() .initial(NEW) .end(PURCHASE_COMPLETE) .state(randomAction())</code> </pre> <br> å®ƒä¼šå¼‚æ­¥æ‰§è¡Œï¼Œä¾‹å¦‚ï¼Œå‡è®¾æ‚¨è¯´.stateEntryï¼ˆï¼‰ï¼Œåˆ™åº”åœ¨å…¥å£å¤„ç›´æ¥æ‰§è¡Œè¯¥æ“ä½œï¼Œä½†å¦‚æœè¯´.stateï¼ˆï¼‰ï¼Œåˆ™åº”åœ¨ç›®æ ‡çŠ¶æ€ä¸‹æ‰§è¡Œè¯¥æ“ä½œï¼Œä½†æ˜¯ä½•æ—¶æ‰§è¡Œåˆ™ä¸æ˜¯é‚£ä¹ˆé‡è¦ã€‚ <br> åœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬åœ¨è¿‡æ¸¡é…ç½®ä¸Šé…ç½®äº†æ‰€æœ‰æ“ä½œï¼Œå› ä¸ºæ‚¨å¯ä»¥ä¸€æ¬¡å°†å®ƒä»¬æŒ‚èµ·å‡ ä¸ªã€‚ <br></div></div><br> é…ç½®çš„æœ€ç»ˆç‰ˆæœ¬å°†å¦‚ä¸‹æ‰€ç¤ºï¼š <br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-meta"><span class="hljs-meta">@EnableStateMachineFactory</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StateMachineConfig</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EnumStateMachineConfigurerAdapter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PurchaseState</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PurchaseEvent</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configure</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> StateMachineConfigurationConfigurer&lt;PurchaseState, PurchaseEvent&gt; config)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ config .withConfiguration() .autoStartup(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) .listener(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PurchaseStateMachineApplicationListener()); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configure</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> StateMachineStateConfigurer&lt;PurchaseState, PurchaseEvent&gt; states)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ states .withStates() .initial(NEW) .end(PURCHASE_COMPLETE) .stateEntry() .stateExit() .state() .states(EnumSet.allOf(PurchaseState.class)); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configure</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> StateMachineTransitionConfigurer&lt;PurchaseState, PurchaseEvent&gt; transitions)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ transitions .withExternal() .source(NEW) .target(RESERVED) .event(RESERVE) .action(reservedAction(), errorAction()) .and() .withExternal() .source(RESERVED) .target(CANCEL_RESERVED) .event(RESERVE_DECLINE) .action(cancelAction(), errorAction()) .and() .withExternal() .source(RESERVED) .target(PURCHASE_COMPLETE) .event(BUY) .guard(hideGuard()) .action(buyAction(), errorAction()); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Action&lt;PurchaseState, PurchaseEvent&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reservedAction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReservedAction(); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Action&lt;PurchaseState, PurchaseEvent&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cancelAction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CancelAction(); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Action&lt;PurchaseState, PurchaseEvent&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">buyAction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BuyAction(); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Action&lt;PurchaseState, PurchaseEvent&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">errorAction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ErrorAction(); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Guard&lt;PurchaseState, PurchaseEvent&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hideGuard</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HideGuard(); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> StateMachinePersister&lt;PurchaseState, PurchaseEvent, String&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">persister</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DefaultStateMachinePersister&lt;&gt;(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PurchaseStateMachinePersister()); }</code> </pre> <br> æ³¨æ„æœºå™¨çš„æ–¹æ¡ˆï¼Œåœ¨æˆ‘ä»¬ç²¾ç¡®ç¼–ç çš„å†…å®¹ï¼ˆå“ªäº›äº‹ä»¶æœ‰æ•ˆçš„è¿‡æ¸¡ï¼Œå“ªä¸ªGuardä¿æŠ¤çŠ¶æ€ä»¥åŠåˆ‡æ¢çŠ¶æ€æ—¶å°†æ‰§è¡Œçš„æ“ä½œï¼Œå“ªä¸ªActionï¼‰ä¸Šéå¸¸æ¸…æ™°å¯è§ã€‚ <br><img src="https://habrastorage.org/webt/l8/2z/2v/l82z2v6pwdaudcrvdpqi99xw48s.png"><br> è®©æˆ‘ä»¬åšæ§åˆ¶å™¨ï¼š <br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RestController</span></span> <span class="hljs-meta"><span class="hljs-meta">@SuppressWarnings</span></span>(<span class="hljs-string"><span class="hljs-string">"unused"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PurchaseController</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> PurchaseService purchaseService; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PurchaseController</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(PurchaseService purchaseService)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.purchaseService = purchaseService; } <span class="hljs-meta"><span class="hljs-meta">@RequestMapping</span></span>(path = <span class="hljs-string"><span class="hljs-string">"/reserve"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reserve</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String userId, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String productId)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> purchaseService.reserved(userId, productId); } <span class="hljs-meta"><span class="hljs-meta">@RequestMapping</span></span>(path = <span class="hljs-string"><span class="hljs-string">"/cancel"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cancelReserve</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String userId)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> purchaseService.cancelReserve(userId); } <span class="hljs-meta"><span class="hljs-meta">@RequestMapping</span></span>(path = <span class="hljs-string"><span class="hljs-string">"/buy"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">buyReserve</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String userId)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> purchaseService.buy(userId); } }</code> </pre> <br><cut></cut><br> æœåŠ¡æ¥å£ <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PurchaseService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** *    ,          * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> userId id ,    ,      id  *    http- * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> productId id ,     * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> /  ,             *      . */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reserved</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String userId, String productId)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/** *   /    * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> userId id ,    ,      id  *    http- * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> /  ,             *      . */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cancelReserve</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String userId)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/** *     * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> userId id ,    ,      id  *    http- * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> /  ,             *      . */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">buy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String userId)</span></span></span></span>; }</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">è€™å­</b> <div class="spoiler_text"> æ‚¨çŸ¥é“åœ¨ä½¿ç”¨Springæ—¶é€šè¿‡æ¥å£åˆ›å»ºbeançš„é‡è¦æ€§å—ï¼Ÿ é¢å¯¹è¿™ä¸ªé—®é¢˜ï¼ˆæ˜¯çš„ï¼Œæ˜¯çš„ï¼Œæ˜¯çš„ï¼ŒZhenya Borisovåœ¨å¼€è†›æ‰‹ä¸­è®²è¯ï¼‰ï¼Œå½“ä»–ä»¬è¿›å…¥æ§åˆ¶å™¨åï¼Œä»–ä»¬è¯•å›¾å®ç°ä¸€ä¸ªä¸´æ—¶çš„éç©ºæ¥å£ã€‚  Springä¸ºç»„ä»¶åˆ›å»ºäº†ä¸€ä¸ªä»£ç†ï¼Œå¦‚æœç»„ä»¶æœªå®ç°ä»»ä½•æ¥å£ï¼Œå®ƒå°†é€šè¿‡CGLIBæ¥å®ç°ï¼Œä½†æ˜¯ä¸€æ—¦å®ç°æŸä¸ªæ¥å£ï¼ŒSpringå°±ä¼šå°è¯•é€šè¿‡åŠ¨æ€ä»£ç†åˆ›å»ºä»£ç†ï¼Œç»“æœæ‚¨å°†è·å¾—éš¾ä»¥ç†è§£çš„å¯¹è±¡ç±»å‹å’ŒNoSuchBeanDefinitionException ã€‚ <br></div></div><br> ä¸‹ä¸€ä¸ªé‡è¦çš„ç‚¹æ˜¯å¦‚ä½•æ¢å¤æœºå™¨çš„çŠ¶æ€ï¼Œå› ä¸ºå¯¹äºæ¯æ¬¡è°ƒç”¨ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„beanï¼Œè¯¥beanå¯¹æœºå™¨çš„å…ˆå‰çŠ¶æ€åŠå…¶ä¸Šä¸‹æ–‡ä¸€æ— æ‰€çŸ¥ã€‚ <br> ä¸ºæ­¤ï¼Œspring statemachineå…·æœ‰Persistensæœºåˆ¶ï¼š <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PurchaseStateMachinePersister</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StateMachinePersist</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PurchaseState</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PurchaseEvent</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">String</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> HashMap&lt;String, StateMachineContext&lt;PurchaseState, PurchaseEvent&gt;&gt; contexts = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap&lt;&gt;(); <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> StateMachineContext&lt;PurchaseState, PurchaseEvent&gt; context, String contextObj)</span></span></span><span class="hljs-function"> </span></span>{ contexts.put(contextObj, context); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> StateMachineContext&lt;PurchaseState, PurchaseEvent&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String contextObj)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> contexts.get(contextObj); } }</code> </pre> <br> å¯¹äºæˆ‘ä»¬çš„å¤©çœŸçš„å®ç°ï¼Œæˆ‘ä»¬ä½¿ç”¨é€šå¸¸çš„Mapä½œä¸ºçŠ¶æ€å­˜å‚¨ï¼Œåœ¨éå¤©çœŸçš„å®ç°ä¸­ï¼Œå®ƒå°†æ˜¯æŸç§æ•°æ®åº“ï¼Œè¯·æ³¨æ„ç¬¬ä¸‰ä¸ªé€šç”¨ç±»å‹Stringï¼Œè¿™æ˜¯ä¿å­˜è®¡ç®—æœºçŠ¶æ€çš„é”®ï¼Œå…¶ä¸­åŒ…å«æ‰€æœ‰çŠ¶æ€ï¼Œä¸Šä¸‹æ–‡ä¸­çš„å˜é‡ï¼Œidç­‰ç­‰ã€‚ åœ¨æˆ‘çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä½¿ç”¨ç”¨æˆ·IDä½œä¸ºä¿å­˜å¯†é’¥ï¼Œè¯¥IDç»å¯¹å¯ä»¥æ˜¯ä»»ä½•å¯†é’¥ï¼ˆç”¨æˆ·session_idï¼Œå”¯ä¸€ç™»å½•åç­‰ï¼‰ã€‚ <br><div class="spoiler">  <b class="spoiler_title">è€™å­</b> <div class="spoiler_text"> åœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­ï¼Œä»ç›’å­ä¸­ä¿å­˜å’Œæ¢å¤çŠ¶æ€çš„æœºåˆ¶ä¸é€‚åˆæˆ‘ä»¬ï¼Œå› ä¸ºæˆ‘ä»¬å°†æœºå™¨çš„çŠ¶æ€å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡å¯¹æœºå™¨ä¸€æ— æ‰€çŸ¥çš„å·¥ä½œè¿›è¡Œæ›´æ”¹ã€‚ <br> æˆ‘å¿…é¡»å›ºå®šä»æ•°æ®åº“æ¥æ”¶çš„çŠ¶æ€ï¼Œæ‰§è¡Œä¸€äº›InitActionï¼Œå½“è®¡ç®—æœºå¯åŠ¨æ—¶ï¼Œå®ƒä¼šä»æ•°æ®åº“æ¥æ”¶çŠ¶æ€ï¼Œå¹¶å¯¹å…¶è¿›è¡Œå¼ºåˆ¶è®¾ç½®ï¼Œç„¶åæ‰å¼•å‘äº‹ä»¶ï¼Œå³æ‰§è¡Œä¸Šè¿°æ“ä½œçš„ç¤ºä¾‹ä»£ç ï¼š <br><pre> <code class="java hljs">stateMachine .getStateMachineAccessor() .doWithAllRegions(access -&gt; { access.resetStateMachine(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DefaultStateMachineContext&lt;&gt;({ResetState}, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>)); }); stateMachine.start(); stateMachine.sendEvent({NewEventFromResetState});</code> </pre> <br></div></div><br> æˆ‘ä»¬å°†è€ƒè™‘æ¯ç§æ–¹æ³•ä¸­æœåŠ¡çš„å®ç°ï¼š <br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reserved</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String userId, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String productId)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> StateMachine&lt;PurchaseState, PurchaseEvent&gt; stateMachine = stateMachineFactory.getStateMachine(); stateMachine.getExtendedState().getVariables().put(<span class="hljs-string"><span class="hljs-string">"PRODUCT_ID"</span></span>, productId); stateMachine.sendEvent(RESERVE); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { persister.persist(stateMachine, userId); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Exception e) { e.printStackTrace(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; }</code> </pre> <br> æˆ‘ä»¬ä»å·¥å‚å–è½¦ï¼Œåœ¨æœºå™¨ä¸Šä¸‹æ–‡ä¸­æ”¾ç½®ä¸€ä¸ªå‚æ•°ï¼Œåœ¨æœ¬ä¾‹ä¸­æ˜¯productIdï¼Œä¸Šä¸‹æ–‡æ˜¯ä¸€ç§ç›’å­ï¼Œæ‚¨å¯ä»¥åœ¨éœ€è¦è®¿é—®çŠ¶æ€æœºbeanæˆ–å…¶ä¸Šä¸‹æ–‡çš„ä»»ä½•åœ°æ–¹æ”¾ç½®æ‰€éœ€çš„æ‰€æœ‰ä¸œè¥¿ï¼Œå› ä¸ºæœºå™¨ä¼šåœ¨ä¸Šä¸‹æ–‡å¼€å§‹æ—¶è‡ªåŠ¨å¯åŠ¨ï¼Œç„¶ååœ¨å¯åŠ¨ä¹‹åï¼Œæˆ‘ä»¬çš„æ±½è½¦å°†å¤„äºNEWçŠ¶æ€ï¼Œå°†äº‹ä»¶æŠ›å‡ºåœ¨é¢„è®¢å•†å“ä¸Šã€‚ <br><br> å…¶ä½™ä¸¤ç§æ–¹æ³•ç±»ä¼¼ï¼š <br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cancelReserve</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String userId)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> StateMachine&lt;PurchaseState, PurchaseEvent&gt; stateMachine = stateMachineFactory.getStateMachine(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { persister.restore(stateMachine, userId); stateMachine.sendEvent(RESERVE_DECLINE); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { e.printStackTrace(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">buy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String userId)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> StateMachine&lt;PurchaseState, PurchaseEvent&gt; stateMachine = stateMachineFactory.getStateMachine(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { persister.restore(stateMachine, userId); stateMachine.sendEvent(BUY); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { e.printStackTrace(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; }</code> </pre> <br> åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬é¦–å…ˆä¸ºç‰¹å®šç”¨æˆ·çš„userIdæ¢å¤è®¡ç®—æœºçš„çŠ¶æ€ï¼Œç„¶åå¼•å‘ä¸apiæ–¹æ³•ç›¸å¯¹åº”çš„äº‹ä»¶ã€‚ <br> è¯·æ³¨æ„ï¼ŒproductIdä¸å†å‡ºç°åœ¨æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å°†å…¶æ·»åŠ åˆ°è®¡ç®—æœºä¸Šä¸‹æ–‡ä¸­ï¼Œå¹¶ä¸”å°†ä»å¤‡ä»½ä¸­æ¢å¤è®¡ç®—æœºåå°†å…¶è·å–ã€‚ <br> åœ¨Actionå®ç°ä¸­ï¼Œæˆ‘ä»¬å°†ä»æœºå™¨ä¸Šä¸‹æ–‡ä¸­è·å–äº§å“IDï¼Œå¹¶åœ¨æ—¥å¿—ä¸­æ˜¾ç¤ºä¸è½¬æ¢ç›¸å¯¹åº”çš„æ¶ˆæ¯ï¼Œä¾‹å¦‚ï¼Œæˆ‘å°†ç»™å‡ºä»£ç ReservedActionï¼š <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ReservedAction</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Action</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PurchaseState</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PurchaseEvent</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(StateContext&lt;PurchaseState, PurchaseEvent&gt; context)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String productId = context.getExtendedState().get(<span class="hljs-string"><span class="hljs-string">"PRODUCT_ID"</span></span>, String.class); System.out.println(<span class="hljs-string"><span class="hljs-string">"   "</span></span> + productId + <span class="hljs-string"><span class="hljs-string">" ."</span></span>); } }</code> </pre> <br> æˆ‘ä»¬ä¸èƒ½ä¸æåŠä¾¦å¬å™¨ï¼Œè¯¥ä¾¦å¬å™¨å¼€ç®±å³ç”¨æä¾›äº†è®¸å¤šæ‚¨å¯ä»¥æŒ‚èµ·çš„è„šæœ¬ï¼Œè¯·äº²è‡ªçœ‹çœ‹ï¼š <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PurchaseStateMachineApplicationListener</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StateMachineListener</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PurchaseState</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PurchaseEvent</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stateChanged</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(State&lt;PurchaseState, PurchaseEvent&gt; from, State&lt;PurchaseState, PurchaseEvent&gt; to)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (from.getId() != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { System.out.println(<span class="hljs-string"><span class="hljs-string">"   "</span></span> + from.getId() + <span class="hljs-string"><span class="hljs-string">"   "</span></span> + to.getId()); } } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stateEntered</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(State&lt;PurchaseState, PurchaseEvent&gt; state)</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stateExited</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(State&lt;PurchaseState, PurchaseEvent&gt; state)</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">eventNotAccepted</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Message&lt;PurchaseEvent&gt; event)</span></span></span><span class="hljs-function"> </span></span>{ System.out.println(<span class="hljs-string"><span class="hljs-string">"   "</span></span> + event); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">transition</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Transition&lt;PurchaseState, PurchaseEvent&gt; transition)</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">transitionStarted</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Transition&lt;PurchaseState, PurchaseEvent&gt; transition)</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">transitionEnded</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Transition&lt;PurchaseState, PurchaseEvent&gt; transition)</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stateMachineStarted</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(StateMachine&lt;PurchaseState, PurchaseEvent&gt; stateMachine)</span></span></span><span class="hljs-function"> </span></span>{ System.out.println(<span class="hljs-string"><span class="hljs-string">"Machine started"</span></span>); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stateMachineStopped</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(StateMachine&lt;PurchaseState, PurchaseEvent&gt; stateMachine)</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stateMachineError</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(StateMachine&lt;PurchaseState, PurchaseEvent&gt; stateMachine, Exception exception)</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">extendedStateChanged</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object key, Object value)</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stateContext</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(StateContext&lt;PurchaseState, PurchaseEvent&gt; stateContext)</span></span></span><span class="hljs-function"> </span></span>{ } }</code> </pre> <br> å”¯ä¸€çš„é—®é¢˜æ˜¯ï¼Œè¿™æ˜¯ä¸€ä¸ªæ¥å£ï¼Œè¿™æ„å‘³ç€æ‚¨éœ€è¦å®ç°æ‰€æœ‰è¿™äº›æ–¹æ³•ï¼Œä½†æ˜¯ç”±äºæ‚¨ä¸å¤ªå¯èƒ½å…¨éƒ¨ä½¿ç”¨å®ƒä»¬ï¼Œå› æ­¤å…¶ä¸­ä¸€äº›å°†ç©ºæ— ä¸€ç‰©ï¼Œå…¶è¦†ç›–èŒƒå›´å°†è¡¨æ˜æµ‹è¯•æœªæ¶µç›–è¿™äº›æ–¹æ³•ã€‚ <br> åœ¨lisenerä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å°†ä»»ä½•æŒ‡æ ‡å®Œå…¨æŒ‚åœ¨æœºå™¨çš„å®Œå…¨ä¸åŒçš„äº‹ä»¶ä¸Šï¼ˆä¾‹å¦‚ï¼Œä»˜æ¬¾æ²¡æœ‰é€šè¿‡ï¼Œæœºå™¨ç»å¸¸è¿›å…¥æŸç§PAYMENT_FAILçŠ¶æ€ï¼Œæˆ‘ä»¬ç›‘å¬è¿‡æ¸¡ï¼Œå¹¶ä¸”å¦‚æœæœºå™¨è¿›å…¥é”™è¯¯çŠ¶æ€-æˆ‘ä»¬ç”¨å¥‡æ€ªçš„æ—¥å¿—å†™ï¼Œæˆ–é©»æ‰æˆ–æŠ¥è­¦ï¼Œç­‰ç­‰ã€‚ <br><div class="spoiler">  <b class="spoiler_title">è€™å­</b> <div class="spoiler_text">  lisener-eä¸­æœ‰ä¸€ä¸ªçŠ¶æ€stateMachineErroräº‹ä»¶ï¼Œä½†æœ‰ä¸€ç‚¹ç»†å¾®å·®åˆ«ï¼Œå½“æ‚¨é‡åˆ°å¼‚å¸¸å¹¶åœ¨catchä¸­å¤„ç†è¯¥å¼‚å¸¸æ—¶ï¼Œæœºå™¨ä¸è®¤ä¸ºå­˜åœ¨é”™è¯¯ï¼Œæ‚¨éœ€è¦åœ¨catchä¸­æ˜ç¡®åœ°è¯´å‡º <br>  stateMachine.setStateMachineErrorï¼ˆå¼‚å¸¸ï¼‰å¹¶ä¼ é€’é”™è¯¯ã€‚ <br></div></div><br> ä¸ºäº†æ£€æŸ¥æˆ‘ä»¬æ‰€åšçš„äº‹æƒ…ï¼Œæˆ‘ä»¬å°†æ‰§è¡Œä¸¤ç§æƒ…å†µï¼š <br><ul><li>  1.ä¿ç•™å¹¶éšåæ‹’ç»è´­ä¹°ã€‚ æˆ‘ä»¬å°†ä½¿ç”¨å‚æ•°userId = 007ï¼ŒproductId = 10001å‘åº”ç”¨ç¨‹åºå‘é€URIè¯·æ±‚â€œ / reserveâ€ï¼Œç„¶ååœ¨è¯·æ±‚åä½¿ç”¨å‚æ•°userId = 007è¿›è¡Œâ€œ / cancelâ€æ§åˆ¶å°è¾“å‡ºï¼š <br> <code>Machine started <br>    10001 . <br>    NEW   RESERVED <br> Machine started <br>   10001  <br>    RESERVED   CANCEL_RESERVED</code> </li> <li>  2.é¢„è®¢å¹¶æˆåŠŸè´­ä¹°ï¼š <br> <code>Machine started <br>    10001 . <br>    NEW   RESERVED <br> Machine started <br>    10001   <br>    RESERVED   PURCHASE_COMPLETE</code> </li> </ul><br><h3> ç»“è®º </h3><br> æ€»è€Œè¨€ä¹‹ï¼Œæˆ‘å°†ç»™å‡ºä¸€ä¸ªæµ‹è¯•æ¡†æ¶çš„ç¤ºä¾‹ï¼Œæˆ‘è®¤ä¸ºä»£ç ä¸­çš„æ‰€æœ‰å†…å®¹éƒ½å°†å˜å¾—æ¸…æ™°èµ·æ¥ï¼Œæ‚¨åªéœ€è¦å¯¹æµ‹è¯•æœºå™¨çš„ä¾èµ–æ€§ï¼Œå°±å¯ä»¥å£°æ˜æ€§åœ°æ£€æŸ¥é…ç½®ã€‚ <br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testWhenReservedCancel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ StateMachine&lt;PurchaseState, PurchaseEvent&gt; machine = factory.getStateMachine(); StateMachineTestPlan&lt;PurchaseState, PurchaseEvent&gt; plan = StateMachineTestPlanBuilder.&lt;PurchaseState, PurchaseEvent&gt;builder() .defaultAwaitTime(<span class="hljs-number"><span class="hljs-number">2</span></span>) .stateMachine(machine) .step() .expectStates(NEW) .expectStateChanged(<span class="hljs-number"><span class="hljs-number">0</span></span>) .and() .step() .sendEvent(RESERVE) .expectState(RESERVED) .expectStateChanged(<span class="hljs-number"><span class="hljs-number">1</span></span>) .and() .step() .sendEvent(RESERVE_DECLINE) .expectState(CANCEL_RESERVED) .expectStateChanged(<span class="hljs-number"><span class="hljs-number">1</span></span>) .and() .build(); plan.test(); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testWhenPurchaseComplete</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ StateMachine&lt;PurchaseState, PurchaseEvent&gt; machine = factory.getStateMachine(); StateMachineTestPlan&lt;PurchaseState, PurchaseEvent&gt; plan = StateMachineTestPlanBuilder.&lt;PurchaseState, PurchaseEvent&gt;builder() .defaultAwaitTime(<span class="hljs-number"><span class="hljs-number">2</span></span>) .stateMachine(machine) .step() .expectStates(NEW) .expectStateChanged(<span class="hljs-number"><span class="hljs-number">0</span></span>) .and() .step() .sendEvent(RESERVE) .expectState(RESERVED) .expectStateChanged(<span class="hljs-number"><span class="hljs-number">1</span></span>) .and() .step() .sendEvent(BUY) .expectState(PURCHASE_COMPLETE) .expectStateChanged(<span class="hljs-number"><span class="hljs-number">1</span></span>) .and() .build(); plan.test(); }</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">è€™å­</b> <div class="spoiler_text"> å¦‚æœæ‚¨çªç„¶æƒ³åœ¨ä¸ä½¿ç”¨å¸¸è§„å•å…ƒæµ‹è¯•å¼•å‘ä¸Šä¸‹æ–‡çš„æƒ…å†µä¸‹æµ‹è¯•è®¡ç®—æœºï¼Œåˆ™å¯ä»¥é€šè¿‡æ„å»ºå™¨åˆ›å»ºè®¡ç®—æœºï¼ˆä¸Šé¢å·²éƒ¨åˆ†è®¨è®ºï¼‰ï¼Œä½¿ç”¨configåˆ›å»ºç±»çš„å®ä¾‹å¹¶ä»é‚£é‡Œè·å–æ“ä½œå’Œä¿æŠ¤ï¼Œå®ƒå°†åœ¨æ²¡æœ‰ä¸Šä¸‹æ–‡çš„æƒ…å†µä¸‹å·¥ä½œï¼Œæ‚¨å¯ä»¥ç¼–å†™ä¸€äº›æµ‹è¯•è¯¥æ¡†æ¶æ˜¯æ¨¡æ‹Ÿçš„ï¼Œåœ¨ä¸åŒæƒ…å†µä¸‹æ£€æŸ¥å“ªäº›åŠ¨ä½œè¢«è°ƒç”¨ï¼Œå“ªäº›æœªè¢«è°ƒç”¨ï¼Œå¤šå°‘æ¬¡ç­‰ç­‰å°†æ˜¯ä¸€ä¸ªåŠ å·ã€‚ <br></div></div><br><h3> èšè‹¯ä¹™çƒ¯ </h3><br>     ,         ,    ,          ,   (Guard-   Action-   ) <br><br><h3>  </h3><br>    ,        choice,   ,     switch,     Guards,        ,    choice      Guard,    Events,  ,    ,        . <br><br><h3> å‚è€ƒæ–‡çŒ® </h3><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a> <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN462371/">https://habr.com/ru/post/zh-CN462371/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN462355/index.html">å¼‚æ­¥JavaScriptç¼–ç¨‹ï¼ˆå›è°ƒï¼ŒPromiseï¼ŒRxJsï¼‰</a></li>
<li><a href="../zh-CN462357/index.html">ç¬¬ä¸€ä¸ªåŸå‹ï¼šUnikernelsä½œä¸ºLinuxæ¼”è¿›çš„ä¸€ä¸ªé˜¶æ®µ</a></li>
<li><a href="../zh-CN462359/index.html">Dat-å®ƒæ˜¯ä»€ä¹ˆåè®®ï¼Œè°ä½¿ç”¨å®ƒ</a></li>
<li><a href="../zh-CN462365/index.html">æœºå™¨å­¦ä¹ çš„å±€é™æ€§</a></li>
<li><a href="../zh-CN462367/index.html">å…³äºåˆ›å§‹äººçš„é£é™©æŠ•èµ„çš„13ä¸ªäº‹å®</a></li>
<li><a href="../zh-CN462377/index.html">å¦‚ä½•åœ¨Enter The Gungeonä¸­ç”Ÿæˆåœ°ç‰¢</a></li>
<li><a href="../zh-CN462379/index.html">é…ç½®æ–‡ä»¶åŠ å¯†</a></li>
<li><a href="../zh-CN462381/index.html">ç¥ç»ç½‘ç»œå’Œæ·±åº¦å­¦ä¹ ï¼Œç¬¬5ç« ï¼šä¸ºä»€ä¹ˆæ·±åº¦ç¥ç»ç½‘ç»œå¦‚æ­¤éš¾è®­ç»ƒï¼Ÿ</a></li>
<li><a href="../zh-CN462383/index.html">ä»è¾¾å‰æ–¯å¦çš„ä»“åº“-åˆ°ç¨‹åºå‘˜ï¼šæˆ‘æ˜¯å¦‚ä½•ä»é›¶å¼€å§‹æˆä¸ºiOSå¼€å‘äººå‘˜çš„</a></li>
<li><a href="../zh-CN462385/index.html">ä¸€ç§æ–°æ–¹æ³•å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ‘†è„±æµ®ç‚¹è®¡ç®—</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>