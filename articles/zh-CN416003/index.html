<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>📋 👨‍❤️‍👨 🚅 HTML文件渲染：Skyeng撰写的《 ReactPHP for Beginners》一章 ✊ 👨🏾‍🍳 🧒🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Skyeng移动应用程序后端开发人员Sergey Zhuk继续写好书。 这次，他为俄语精通的读者发行了俄文教科书。 我请谢尔盖（Sergey）分享书中有用的自给自足章节，并为哈布拉（Habra）读者提供折扣代码。 下面是两者。 
 首先，让我们告诉您前面几章中我们停止过的内容。 

我们已经用PHP...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>HTML文件渲染：Skyeng撰写的《 ReactPHP for Beginners》一章</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/skyeng/blog/416003/"><p><img src="https://habrastorage.org/webt/6v/oi/xx/6voixx5vd9au0asabvgmnckfj90.png"></p><br><p>  Skyeng移动应用程序后端开发人员Sergey Zhuk继续写好书。 这次，他为俄语精通的读者发行了俄文教科书。 我请谢尔盖（Sergey）分享书中有用的自给自足章节，并为哈布拉（Habra）读者提供折扣代码。 下面是两者。 </p><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">首先，让我们告诉您前面几章中我们停止过的内容。</b> <div class="spoiler_text"><p>我们已经用PHP编写了简单的HTTP服务器。 我们有一个主要的<code>index.php</code>文件-启动服务器的脚本。 这是最高级别的代码：我们创建一个事件循环，配置HTTP服务器的行为并开始循环： </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">React</span></span>\<span class="hljs-title"><span class="hljs-title">Http</span></span>\<span class="hljs-title"><span class="hljs-title">Server</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Psr</span></span>\<span class="hljs-title"><span class="hljs-title">Http</span></span>\<span class="hljs-title"><span class="hljs-title">Message</span></span>\<span class="hljs-title"><span class="hljs-title">ServerRequestInterface</span></span>; $loop = React\EventLoop\Factory::create(); $router = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Router(); $router-&gt;load(<span class="hljs-string"><span class="hljs-string">'routes.php'</span></span>); $server = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Server( <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ServerRequestInterface $request)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($router)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $router($request); } ); $socket = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> React\Socket\Server(<span class="hljs-number"><span class="hljs-number">8080</span></span>, $loop); $server-&gt;listen($socket); $loop-&gt;run();</code> </pre> <br><p> 要路由请求，服务器使用路由器： </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// src/Router.php use Psr\Http\Message\ServerRequestInterface; use React\Http\Response; class Router { private $routes = []; public function __invoke(ServerRequestInterface $request) { $path = $request-&gt;getUri()-&gt;getPath(); echo "Request for: $path\n"; $handler = $this-&gt;routes[$path] ?? $this-&gt;notFound($path); return $handler($request); } public function load($filename) { $routes = require $filename; foreach ($routes as $path =&gt; $handler) { $this-&gt;add($path, $handler); } } public function add($path, callable $handler) { $this-&gt;routes[$path] = $handler; } private function notFound($path) { return function () use ($path) { return new Response( 404, ['Content-Type' =&gt; 'text/html; charset=UTF-8'], "No request handler found for $path" ); }; } }</span></span></code> </pre> <br><p> 来自<code>routes.php</code>文件的路由被加载到<code>routes.php</code> 。 现在，这里仅宣布了两条路线： </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">React</span></span>\<span class="hljs-title"><span class="hljs-title">Http</span></span>\<span class="hljs-title"><span class="hljs-title">Response</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Psr</span></span>\<span class="hljs-title"><span class="hljs-title">Http</span></span>\<span class="hljs-title"><span class="hljs-title">Message</span></span>\<span class="hljs-title"><span class="hljs-title">ServerRequestInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ <span class="hljs-string"><span class="hljs-string">'/'</span></span> =&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ServerRequestInterface $request)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Response( <span class="hljs-number"><span class="hljs-number">200</span></span>, [<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'text/plain'</span></span>], <span class="hljs-string"><span class="hljs-string">'Main page'</span></span> ); }, <span class="hljs-string"><span class="hljs-string">'/upload'</span></span> =&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ServerRequestInterface $request)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Response( <span class="hljs-number"><span class="hljs-number">200</span></span>, [<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'text/plain'</span></span>], <span class="hljs-string"><span class="hljs-string">'Upload page'</span></span> ); }, ];</code> </pre> <br><p> 到目前为止，一切都很简单，并且我们的异步应用程序可以放入几个文件中。 </p></div></div><br><p> 我们传递给更多“有用”的东西。 我们从前几章中学到的纯文本中的几个单词的答案看起来并不吸引人。 我们需要返回真实的内容，例如HTML页面。 </p><br><p> 那么，我们将HTML放在哪里？ 当然，您可以在路由文件中对网页的内容进行硬编码： </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// routes.php return [ '/' =&gt; function (ServerRequestInterface $request) { $html = &lt;&lt;&lt;HTML &lt;!DOCTYPE html&gt; &lt;html lang=”en”&gt; &lt;head&gt; &lt;meta charset=”UTF-8”&gt; &lt;title&gt;ReactPHP App&lt;/title&gt; &lt;/head&gt; &lt;body&gt; Hello, world &lt;/body&gt; &lt;/html&gt; HTML; return new Response( 200, ['Content-Type' =&gt; 'text/html'], $html ); }, '/upload' =&gt; function (ServerRequestInterface $request) { return new Response( 200, ['Content-Type' =&gt; 'text/plain'], 'Upload page' ); }, ];</span></span></code> </pre> <br><p> 但是不要那样做！ 您不能将业务逻辑（路由）与演示文稿（HTML页面）混合使用。 怎么了 假设您需要更改HTML代码中的某些内容，例如按钮的颜色。 哪个文件需要更改？ 与路由文件<code>router.php</code> ？ 听起来很怪吧？ 更改路由以更改按钮的颜色... </p><br><p> 因此，我们将不理会这些路由，对于HTML页面，我们将创建一个单独的目录。 在项目的根目录，添加一个名为pages的新目录。 然后在其中创建<code>index.html</code>文件。 这将是我们的主页。 其内容如下： </p><br><pre> <code class="php hljs">&lt;!DOCTYPE html&gt; &lt;html lang=<span class="hljs-string"><span class="hljs-string">"en"</span></span>&gt; &lt;head&gt; &lt;meta charset=<span class="hljs-string"><span class="hljs-string">"UTF-8"</span></span>&gt; &lt;title&gt;ReactPHP App&lt;/title&gt; &lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css"</span></span> &gt; &lt;/head&gt; &lt;body&gt; &lt;div <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">container</span></span></span><span class="hljs-class">"&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">div</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">row</span></span></span><span class="hljs-class">"&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">form</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">action</span></span></span><span class="hljs-class">="/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">upload</span></span></span><span class="hljs-class">" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">method</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">POST</span></span></span><span class="hljs-class">" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">justify</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">content</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">center</span></span></span><span class="hljs-class">"&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">div</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">form</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">group</span></span></span><span class="hljs-class">"&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">label</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">text</span></span></span><span class="hljs-class">"&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Text</span></span></span><span class="hljs-class">&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">label</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">textarea</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">text</span></span></span><span class="hljs-class">" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">text</span></span></span><span class="hljs-class">" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">form</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">control</span></span></span><span class="hljs-class">"&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">div</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">button</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">submit</span></span></span><span class="hljs-class">" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">btn</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">btn</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">primary</span></span></span><span class="hljs-class">"&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Submit</span></span></span><span class="hljs-class">&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">button</span></span></span><span class="hljs-class">&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">form</span></span></span><span class="hljs-class">&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">div</span></span></span><span class="hljs-class">&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">div</span></span></span><span class="hljs-class">&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">body</span></span></span><span class="hljs-class">&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">html</span></span></span><span class="hljs-class">&gt;</span></span></code> </pre> <br><p> 该页面非常简单，它仅包含一个元素-表单。 里面的表单有一个文本框和一个提交按钮。 我还添加了Bootstrap样式，以使我们的页面看起来更好。 </p><br><h4 id="chtenie-faylov-kak-ne-nado-delat"> 正在读取文件。 怎么做 </h4><br><p> 最直接的方法是读取请求处理程序中文件的内容，并将该内容作为响应正文返回。 像这样： </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// routes.php return [ '/' =&gt; function (ServerRequestInterface $request) { return new Response( 200, ['Content-Type' =&gt; 'text/html'], file_get_contents('pages/index.html') ); }, // ... ];</span></span></code> </pre> <br><p> 顺便说一句，它将起作用。 您可以自己尝试：重新启动服务器，然后在浏览器中重新加载页面<code>http://127.0.0.1:8080/</code> 。 </p><br><p><img src="https://habrastorage.org/webt/zq/dc/91/zqdc91cvy7a971jkniyw8hpxgzi.png"></p><br><p> 那怎么了 为什么不这样做呢？ 简而言之，因为如果文件系统开始变慢，将会出现问题。 </p><br><h4 id="blokiruyuschie-i-neblokiruyuschie-vyzovy"> 阻塞和非阻塞呼叫 </h4><br><p> 让我向您展示“阻塞”调用的含义，以及其中一个请求处理程序包含阻塞代码时可能发生的情况。 在返回响应对象之前，请添加一个对<code>sleep()</code>函数的调用： </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// routes.php return [ '/' =&gt; function (ServerRequestInterface $request) { sleep(10); return new Response( 200, ['Content-Type' =&gt; 'text/html'], file_get_contents('pages/index.html') ); }, '/upload' =&gt; function (ServerRequestInterface $request) { return new Response( 200, ['Content-Type' =&gt; 'text/plain'], 'Upload page' ); }, ];</span></span></code> </pre> <br><p> 这将使请求处理程序冻结10秒钟，然后它才能返回带有HTML页面内容的响应。 请注意，我们没有触摸<code>/upload</code>地址的处理程序。 通过调用<code>sleep(10)</code>函数，我模拟了某种阻塞操作的执行。 </p><br><p> 那我们有什么呢？ 当浏览器请求页面<code>/</code> ，处理程序将等待10秒钟，然后返回HTML页面。 当我们打开<code>/upload</code>地址时，其处理程序应立即返回带有字符串“ Upload page”的响应。 </p><br><p> 现在，让我们看看现实中会发生什么。 与往常一样，我们重新启动服务器。 现在，请在浏览器中打开另一个窗口。 在地址栏中，输入<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">http://127.0.0.1:8080/upload</a> ，但不要立即打开此页面。 只需将此地址暂时留在地址栏中。 然后转到第一个浏览器窗口，并在其中打开页面<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">http://127.0.0.1:8080/</a> 。 在加载此页面时（请记住，此过程将需要10秒钟），请快速转到第二个窗口并按“ Enter”以加载地址栏中剩余的地址（ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">http://127.0.0.1:8080/upload</a> ） 。 </p><br><p> 我们得到了什么？ 是的，地址/符合预期，需要10秒钟加载。 但是，令人惊讶的是，尽管我们没有向其添加任何<code>sleep()</code>调用，但第二页花费了相同的时间来加载。 知道为什么会这样吗？ </p><br><p>  ReactPHP在单个线程中运行。 似乎在异步应用程序中，任务是并行执行的，但实际上并非如此。 并行的错觉是由一系列事件构成的，这些事件不断地在各种任务之间切换并执行它们。 但是在某个时间点，总是只执行一项任务。 这意味着，如果这些任务之一花费的时间太长，它将阻止事件循环，这将无法注册新事件并为其调用处理程序。 最终导致整个应用程序“冻结”，它只会失去异步性。 </p><br><p> 可以，但是这与调用<code>file_get_contents('pages/index.h')</code>什么关系？ 这里的问题是我们正在直接访问文件系统。 与其他操作（例如，使用内存或计算）相比，使用文件系统可能会非常慢。 例如，如果结果证明文件太大或磁盘本身很慢，则读取文件可能会花费一些时间，因此会阻塞事件循环。 </p><br><p> 在标准同步模型中，请求-响应不是问题。 如果客户端请求的文件太重，它将等待下载此文件。 如此繁重的请求不会影响其他客户。 但就我们而言，我们正在处理一个异步的面向事件的模型。 我们启动了一个HTTP服务器，该服务器必须不断处理传入的请求。 如果一个请求花费太多时间才能完成，那么这将影响所有其他服务器客户端。 </p><br><p> 通常，请记住： </p><br><ul><li> 您永远不能阻止事件循环。 </li></ul><br><p> 那么，我们如何异步读取文件呢？ 这是第二条规则： </p><br><ul><li> 当无法避免阻塞操作时，应将其分叉到子进程中，并在主线程中继续异步执行。 </li></ul><br><p> 因此，在学习了如何做到这一点之后，让我们讨论正确的非阻塞解决方案。 </p><br><h4 id="docherniy-process"> 子进程 </h4><br><p> 与异步应用程序中文件系统的所有通信都必须在子进程中执行。 要在ReactPHP应用程序中管理子进程，我们需要安装另一个<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">“子进程”</a>组件。 该组件使您可以访问操作系统的功能，以在子进程中运行任何系统命令。 要安装此组件，请在项目的根目录中打开一个终端，然后运行以下命令： </p><br><p> <code>composer require react/child-process</code> </p> <br><h4 id="sovmestimost-s-windows">  <em>Windows兼容性</em> </h4><br><p>  <em>在Windows操作系统中，STDIN，STDOUT和STDERR线程处于阻塞状态，这意味着子进程组件将无法正常工作。</em>  <em>因此，该组件主要设计为仅在nix系统上工作。</em>  <em>如果您尝试在Windows系统上创建Process类的对象，则将引发异常。</em>  <em>但是该组件可以在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Linux的Windows子系统（WSL）下工作</a> 。</em>  <em>如果打算在Windows下使用此组件，则需要安装WSL。</em> </p><br><p> 现在，我们可以在子进程中执行任何shell命令。 打开<code>routes.php</code>文件，然后更改<code>/</code>路由的处理程序。 创建一个<code>React\ChildProcess\Process</code>类的对象，并作为命令，将<code>ls</code>传递给它以获取当前目录的内容： </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// routes.php use Psr\Http\Message\ServerRequestInterface; use React\ChildProcess\Process; use React\Http\Response; return [ '/' =&gt; function (ServerRequestInterface $request) { $childProcess = new Process('ls'); return new Response( 200, ['Content-Type' =&gt; 'text/html'], file_get_contents('pages/index.html') ); }, // ... ];</span></span></code> </pre> <br><p> 然后，我们需要通过调用<code>start()</code>方法来启动该过程。 问题在于<code>start()</code>方法需要一个事件循环对象。 但是在<code>routes.php</code>文件中，我们没有此对象。 我们如何将事件循环从<code>index.php</code>传递到直接路由到请求处理程序的路由？ 解决这个问题的方法是“依赖注入”。 </p><br><h4 id="inekciya-zavisimostey"> 依赖注入 </h4><br><p> 因此，我们的一条路线需要一个事件循环才能起作用。 在我们的应用程序中，只有一个组件知道路由的存在<code>Router</code>类。 事实证明，为路线提供事件循环是他的责任。 换句话说，路由器需要一个事件循环，或者它取决于事件循环。 我们如何在代码中明确表达这种依赖性？ 如何使即使不传递事件循环也无法创建路由器？ 当然，通过<code>Router</code>类的构造函数。 打开<code>Router.php</code>并将构造函数添加到<code>Router</code>类： </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Psr</span></span>\<span class="hljs-title"><span class="hljs-title">Http</span></span>\<span class="hljs-title"><span class="hljs-title">Message</span></span>\<span class="hljs-title"><span class="hljs-title">ServerRequestInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">React</span></span>\<span class="hljs-title"><span class="hljs-title">EventLoop</span></span>\<span class="hljs-title"><span class="hljs-title">LoopInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">React</span></span>\<span class="hljs-title"><span class="hljs-title">Http</span></span>\<span class="hljs-title"><span class="hljs-title">Response</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Router</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $routes = []; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> LoopInterface */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $loop; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(LoopInterface $loop)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;loop = $loop; } <span class="hljs-comment"><span class="hljs-comment">// ... }</span></span></code> </pre> <br><p> 在构造函数内部，将传递的事件循环保存在private <code>$loop</code>属性中。 当我们为类提供它需要在外部工作的对象时，这就是依赖注入。 </p><br><p> 现在有了这个新的构造函数，我们需要更新路由器的创建。 打开<code>index.php</code>文件，并更正我们创建<code>Router</code>类对象的行： </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// index.php $loop = React\EventLoop\Factory::create(); $router = new Router($loop); $router-&gt;load('routes.php');</span></span></code> </pre> <br><p> 做完了 返回<code>routes.php</code> 。 您可能已经猜到了，在这里我们可以将相同的想法与<strong>依赖项注入结合使用</strong> ，并将事件循环作为第二个参数添加到查询处理程序中。 更改第一个回调并添加第二个参数：实现<code>LoopInterface</code>的对象： </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// routes.php use Psr\Http\Message\ServerRequestInterface; use React\EventLoop\LoopInterface; use React\ChildProcess\Process; use React\Http\Response; return [ '/' =&gt; function (ServerRequestInterface $request, LoopInterface $loop) { $childProcess = new Process('ls'); $childProcess-&gt;start($loop); return new Response( 200, ['Content-Type' =&gt; 'text/html'], file_get_contents('pages/index.html') ); }, '/upload' =&gt; function (ServerRequestInterface $request) { return new Response( 200, ['Content-Type' =&gt; 'text/plain'], 'Upload page' ); }, ];</span></span></code> </pre> <br><p> 接下来，我们需要将事件循环传递给子进程的<code>start()</code>方法。 处理程序从哪里获取事件循环？ 它已经存储在路由器的private <code>$loop</code>属性中。 我们只需要在调用处理程序时传递它即可。 </p><br><p>  <code>__invoke()</code>打开<code>Router</code>类并更新<code>__invoke()</code>方法，将第二个参数添加到请求处理程序调用中： </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__invoke</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ServerRequestInterface $request)</span></span></span><span class="hljs-function"> </span></span>{ $path = $request-&gt;getUri()-&gt;getPath(); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"Request for: $path\n"</span></span>; $handler = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;routes[$path] ?? <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;notFound($path); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $handler($request, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;loop); }</code> </pre> <br><p> 仅此而已！ 这可能足够<strong>依赖注入</strong> 。 事件周期发生了一段相当大的旅程，对不对？ 从<code>index.php</code>文件到<code>Router</code>类，然后再从<code>Router</code>类到callbacks内部的<code>Router</code> <code>routes.php</code>文件。 </p><br><p> 因此，要确认子进程将执行其非阻塞魔术，让我们用更重的<code>ping 8.8.8.8</code>替换简单的<code>ls</code> 。 重新启动服务器，然后再次尝试在两个不同的窗口中打开两个页面。 首先， <code>http://127.0.0.1:8080/</code> <code>/upload</code> ，然后<code>/upload</code> 。 尽管<code>ping</code>命令在后台的第一个处理程序中执行，但两个页面都可以快速打开，没有任何延迟。 顺便说一下，这意味着我们可以派遣任何昂贵的操作（例如，处理大文件），而不会阻塞主应用程序。 </p><br><h4 id="svyazyvaem-docherniy-process-i-otvet-s-pomoschyu-potokov"> 使用线程绑定子进程和响应 </h4><br><p> 让我们回到我们的应用程序。 因此，我们创建了一个子进程，将其启动，但是我们的浏览器不会以任何方式显示分叉操作的结果。 让我们修复它。 </p><br><p> 我们如何与子进程进行沟通？ 在我们的例子中，我们有一个正在运行的<code>ls</code> ，该<code>ls</code>显示当前目录的内容。 我们如何获得该结论，然后将其发送给答案正文？ 简短的答案是：线程。 </p><br><p> 让我们谈谈流程。 您执行的任何Shell命令都具有三个数据流：STDIN，STDOUT和STDERR。 流式传输到标准输出和输入，以及流式传输错误。 例如，当我们执行<code>ls</code> ，该<code>ls</code>的结果直接发送到STDOUT（在终端屏幕上）。 因此，如果我们需要获取流程的输出，则需要访问输出流。 这就像炮击梨一样容易。 在创建响应对象时，用<code>$childProcess-&gt;stdout</code>替换<code>file_get_contents()</code>调用： </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Response( <span class="hljs-number"><span class="hljs-number">200</span></span>, [<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'text/plain'</span></span>], $childProcess-&gt;stdout );</code> </pre> <br><p> 所有子进程都具有与<code>stdio</code>流相关的三个属性： <code>stdout</code> ， <code>stdin</code>和<code>stderr</code> 。 在我们的例子中，我们想在网页上显示流程的输出。 我们传递一个流作为第三个参数，而不是<code>Response</code>类的构造函数中的字符串。  <code>Response</code>类足够聪明，可以意识到它已接收到流并进行了相应处理。 </p><br><p> 因此，像往常一样，我们重新启动服务器，然后看看我们做了什么。 让我们在浏览器中打开页面<code>http://127.0.0.1:8080/</code> ：您应该看到项目根文件夹的文件列表。 </p><br><p><img src="https://habrastorage.org/webt/mm/ui/za/mmuizadmcw-fzg1cekm0d1jpz3e.png"></p><br><p> 最后一步是用更有用的<code>ls</code>替换<code>ls</code> 。 我们通过使用<code>file_get_contents()</code>函数呈现<code>pages/index.html</code>文件来开始本章。 现在，我们可以绝对异步地读取该文件，而不必担心它将阻塞我们的应用程序。 用<code>cat pages/index.html</code>替换<code>ls</code> 。 </p><br><p> 如果您不熟悉<code>cat</code> ，那么它将用于连接和输出文件。 通常，此命令用于读取文件并将其内容输出到标准输出。  <code>cat pages/index.html</code>命令读取<code>cat pages/index.html</code>文件并将其内容打印到STDOUT。 并且我们已经将<code>stdout</code>发送为响应主体。 这是<code>routes.php</code>文件的最终版本： </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// routes.php use Psr\Http\Message\ServerRequestInterface; use React\EventLoop\LoopInterface; use React\ChildProcess\Process; use React\Http\Response; return [ '/' =&gt; function (ServerRequestInterface $request, LoopInterface $loop) { $childProcess = new Process('cat pages/index.html'); $childProcess-&gt;start($loop); return new Response( 200, ['Content-Type' =&gt; 'text/html'], $childProcess-&gt;stdout ); }, '/upload' =&gt; function (ServerRequestInterface $request) { return new Response( 200, ['Content-Type' =&gt; 'text/plain'], 'Upload page' ); }, ];</span></span></code> </pre> <br><p> 结果，只需要替换所有对<code>file_get_contents()</code>函数的调用就可以使用所有这些代码。 依赖注入，传递事件循环对象，添加子进程以及使用线程。 所有这些只是替换一个函数调用。 值得吗？ 答：是的，值得。 当某些东西可以阻止事件循环，而文件系统可以阻止时，请确保它最终将在最不适当的时刻被阻止。 </p><br><p> 每次我们需要访问文件系统时创建一个子进程可能看起来会产生额外的开销，这会影响应用程序的速度和性能。 不幸的是，在PHP中，没有其他方法可以异步处理文件系统。 所有异步PHP库都使用子进程（或抽象它们的扩展）。 </p><br><p>  Habra的读者可以<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">通过此链接</a>以折扣价购买整本书。 </p><br><p> 我们提醒您，我们一直在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">寻找优秀的开发人员</a> ！ 来吧，我们玩得开心！ </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN416003/">https://habr.com/ru/post/zh-CN416003/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN415993/index.html">远程处理，你无情的面粉</a></li>
<li><a href="../zh-CN415995/index.html">从内部开发CROC：人，鸭子和许多工作</a></li>
<li><a href="../zh-CN415997/index.html">Python机器学习软件</a></li>
<li><a href="../zh-CN415999/index.html">什么是Apple奖学金？为什么不仅是WWDC门票？</a></li>
<li><a href="../zh-CN416001/index.html">来自VK网站的消息-简单有效-PHP + CUrl</a></li>
<li><a href="../zh-CN416005/index.html">16个面向界面开发人员的React工具</a></li>
<li><a href="../zh-CN416007/index.html">简直太复杂了。 创建无线“智能家居”的开始。 基于Linux技术，Z-Wave和MajorDoMo软件</a></li>
<li><a href="../zh-CN416009/index.html">尝试兔子的粪便，它会非常有活力，并且会抓住-药理学提取物</a></li>
<li><a href="../zh-CN416011/index.html">BIF模式：干净的前端代码，方便处理服务器数据</a></li>
<li><a href="../zh-CN416013/index.html">如何开始投资并节省资金：道琼斯专家指出新手交易者的五个主要错误</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>