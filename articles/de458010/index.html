<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèä üôãüèº üå± Die Abenteuer der schwer fassbaren Malvari, Teil II: Geheime VBA-Skripte ‚õìÔ∏è üíÖ ‚è∏Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dieser Artikel ist Teil der Fileless Malware-Reihe. Alle anderen Teile der Serie: 



- Die Abenteuer der schwer fassbaren Malvari, Teil I. 
- Die Abe...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Die Abenteuer der schwer fassbaren Malvari, Teil II: Geheime VBA-Skripte</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/varonis/blog/458010/"><img src="https://habrastorage.org/webt/3t/ih/b0/3tihb0g1kt7wbjalc_s3xe0xgjo.png"><br><br>  Dieser Artikel ist Teil der Fileless Malware-Reihe.  Alle anderen Teile der Serie: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Die Abenteuer der schwer fassbaren Malvari, Teil I.</a> </li><li>  Die Abenteuer der schwer fassbaren Malvari, Teil II: Versteckte VBA-Skripte (wir sind hier) </li></ul><br>  Ich bin ein Fan der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Hybrid Analysis</a> Website (HA).  Dies ist eine Art Malware-Zoo, in dem Sie wilde "Raubtiere" aus sicherer Entfernung beobachten k√∂nnen, ohne angegriffen zu werden.  HA startet Malware in sicheren Umgebungen, zeichnet Systemaufrufe, generierte Dateien und Internetverkehr auf und zeigt alle diese Ergebnisse f√ºr jede von Ihnen analysierte Probe an.  Sie k√∂nnen also nicht Ihre Zeit und Energie verschwenden, indem Sie den verwirrenden Code selbst l√∂sen, sondern sofort alle Absichten der Hacker verstehen. <br><a name="habracut"></a><br>  Die HA-Beispiele, auf die ich aufmerksam geworden bin, verwenden entweder JavaScript-codierte oder VBA-Skripts (Visual Basic f√ºr Applikationen), die als Makros in Word- oder Excel-Dokumente eingebettet und an Phishing-E-Mails angeh√§ngt sind.  Beim √ñffnen starten diese Makros eine PowerShell-Sitzung auf dem Computer des Opfers.  Hacker senden normalerweise Base64-codierte Befehlsstr√∂me an PowerShell.  Dies alles geschieht, um die Erkennung des Angriffs mit Webfiltern und Antivirensoftware, die auf bestimmte Schl√ºsselw√∂rter reagieren, zu erschweren. <br>  Gl√ºcklicherweise dekodiert HA Base64 automatisch und zeigt sofort alles in lesbarer Form an.  Im Wesentlichen m√ºssen Sie sich nicht auf die Funktionsweise dieser Skripte konzentrieren, da Sie die vollst√§ndige Ausgabe der Befehle zum Ausf√ºhren von Prozessen im entsprechenden HA-Abschnitt sehen k√∂nnen.  Siehe ein Beispiel unten: <br><br><img src="https://habrastorage.org/webt/ew/jp/cw/ewjpcwuesyaeevrw55513pjcxy4.jpeg"><br><br>  Die Hybridanalyse f√§ngt Base64-codierte Befehle ab, die an PowerShell gesendet werden: <br><br><img src="https://habrastorage.org/webt/yy/j7/wx/yyj7wxyf8ejzrjtbnzgjfpdrucc.jpeg"><br><br>  ... und entschl√ºsselt sie dann f√ºr Sie.  # magisch <br><br>  In einem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">fr√ºheren Beitrag habe</a> ich meinen eigenen leicht verschleierten JavaScript-Container zum Starten einer PowerShell-Sitzung erstellt.  Dann l√§dt mein Skript, wie viele PowerShell-basierte Malware, das folgende PowerShell-Skript von einer Remote-Website herunter.  Dann habe ich als Beispiel eine harmlose PS heruntergeladen, die eine Nachricht auf dem Bildschirm druckt.  Aber die Zeiten √§ndern sich, und jetzt schlage ich vor, das Szenario zu komplizieren. <br><br><h2>  PowerShell Empire und Reverse Shell </h2><br>  Ein Ziel dieser √úbung ist es zu zeigen, wie (relativ) leicht ein Hacker klassische Perimeterabwehr- und Antivirenprogramme umgehen kann.  Wenn ein IT-Blogger ohne Programmierkenntnisse wie ich an einigen Abenden <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">eine</a> vollst√§ndig unentdeckte (FUD) <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Malware erstellen</a> kann, stellen Sie sich die M√∂glichkeiten eines jungen Hackers vor, der daran interessiert ist! <br><br>  Wenn Sie eine Person sind, die IT-Sicherheit bietet, Ihr Manager jedoch die m√∂glichen Folgen dieser Bedrohungen nicht kennt, zeigen Sie ihm einfach diesen Artikel. <br><br>  Hacker tr√§umen davon, direkten Zugriff auf einen Laptop oder den Server des Opfers zu erhalten.  Dies ist sehr einfach: Der Hacker muss lediglich einige vertrauliche Dateien auf dem Laptop des CEO abrufen. <br><br>  Irgendwie habe ich bereits √ºber die postoperative PowerShell Empire-Laufzeit geschrieben.  Erinnern wir uns, was es ist. <br><br>  Im Wesentlichen handelt es sich um ein PowerShell-basiertes Penetrationstest-Tool, das neben vielen anderen Funktionen das Ausf√ºhren einer Reverse-Shell vereinfacht.  Weitere Informationen finden Sie auf <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">der PSE-Homepage</a> . <br><br>  Lass uns ein kleines Experiment machen.  Ich habe eine sichere Malware-Testumgebung in der Amazon Web Services-Cloud eingerichtet.  Sie k√∂nnen meinem Beispiel folgen, um schnell und sicher ein funktionierendes Beispiel f√ºr diese Sicherheitsanf√§lligkeit zu zeigen (und nicht f√ºr das Starten von Viren innerhalb des Unternehmensbereichs ausgel√∂st zu werden). <br><br>  Wenn Sie die PowerShell Empire-Konsole starten, wird Folgendes angezeigt: <br><br><img src="https://habrastorage.org/webt/vx/-j/mf/vx-jmf1qyoc8cfo1nmcockocfea.jpeg"><br><br>  Zuerst starten Sie den Listener-Prozess auf Ihrem Hacker-Computer.  Geben Sie den Befehl "Listener" ein und geben Sie die IP-Adresse Ihres Systems mit "Host einstellen" an.  Starten Sie dann den Listener-Prozess mit dem Befehl execute (siehe unten).  Warten Sie also Ihrerseits auf eine Netzwerkverbindung von der Remote-Shell: <br><br><img src="https://habrastorage.org/webt/fm/1e/ux/fm1eux-ocyidttp4eqlt9q0qb74.jpeg"><br><br>  Auf der anderen Seite m√ºssen Sie den Agentencode durch Eingabe des Launcher-Befehls generieren (siehe unten).  Dadurch wird PowerShell-Code f√ºr den Remote-Agenten generiert.  Beachten Sie, dass es in Base64 codiert ist und die zweite Phase der Nutzlast darstellt.  Mit anderen Worten, mein JavaScript-Code zieht jetzt diesen Agenten, um PowerShell anstelle einer harmlosen Textausgabe auf dem Bildschirm auszuf√ºhren, und stellt eine Verbindung zu unserem Remote-PSE-Server her, um die Reverse Shell auszuf√ºhren. <br><br><img src="https://habrastorage.org/webt/xh/vs/ig/xhvsigu6puk1rvt0e3ttwh43uyg.jpeg"><br>  <em>Die Magie der umgekehrten Schale.</em>  <em>Dieser codierte PowerShell-Befehl stellt eine Verbindung zu meinem Listener her und startet die Remote-Shell.</em> <br><br>  Um Ihnen dieses Experiment zu zeigen, habe ich die Rolle eines unschuldigen Opfers √ºbernommen und Evil.doc ge√∂ffnet, wodurch unser JavaScript gestartet wurde.  Erinnerst du dich an den ersten Teil?  PowerShell wurde so konfiguriert, dass das Fenster nicht angezeigt wird, sodass das Opfer nichts Ungew√∂hnliches bemerkt.  Wenn Sie jedoch den Windows Task-Manager √∂ffnen, wird der PowerShell-Hintergrundprozess angezeigt, der f√ºr die meisten Benutzer immer noch keinen Alarm ausl√∂st.  Weil es normale PowerShell ist, nicht wahr? <br><br><img src="https://habrastorage.org/webt/wz/se/cr/wzsecrznut3tonqek3wteofemiw.jpeg"><br><br>  Wenn Sie jetzt Evil.doc ausf√ºhren, stellt ein versteckter Hintergrundprozess mit PowerShell Empire eine Verbindung zum Server her.  Nachdem ich den wei√üen Hut des Hacker-Pentesters aufgesetzt hatte, kehrte ich zur PowerShell Empire-Konsole zur√ºck und sehe jetzt eine Meldung, dass mein Remote-Agent aktiv ist. <br><br><img src="https://habrastorage.org/webt/fm/1e/ux/fm1eux-ocyidttp4eqlt9q0qb74.jpeg"><br><br>  Dann habe ich den Befehl "Interact" eingegeben, um die Shell in PSE zu √∂ffnen - und hier bin ich!  Kurz gesagt, ich habe mich in einen Taco-Server gehackt, den ich selbst einmal eingerichtet habe. <br><br><img src="https://habrastorage.org/webt/vh/to/0z/vhto0zmky-9wpmxxpf2tnlzze5s.jpeg"><br><br>  Was ich gerade demonstriert habe, erfordert nicht so viel Arbeit von Ihnen.  Sie k√∂nnen dies alles sicher f√ºr eine Mittagspause von ein bis zwei Stunden tun, um Ihr Wissen √ºber Informationssicherheit zu verbessern.  Es ist auch eine gute M√∂glichkeit zu verstehen, wie Hacker den Schutz externer Sicherheitsbereiche umgehen und verdeckt auf Ihren Systemen bereitstellen. <br><br>  IT-Manager, die glauben, einen unzerst√∂rbaren Schutz gegen Eindringen aufgebaut zu haben, werden ihn wahrscheinlich auch informativ finden - na ja, wenn Sie sie nat√ºrlich davon √ºberzeugen k√∂nnen, lange neben Ihnen zu sitzen. <br><br><h2>  Zur√ºck zur Realit√§t </h2><br>  Wie ich erwartet hatte, ist ein echter Hack, der f√ºr den durchschnittlichen Benutzer nicht sichtbar ist, nur eine Variation dessen, was ich gerade beschrieben habe.  Um Material f√ºr die n√§chste Ver√∂ffentlichung zu sammeln, suchte ich nach einem Beispiel f√ºr HA, das genauso funktioniert wie mein erfundenes Beispiel.  Und ich musste lange nicht danach suchen - die Seite bietet viele M√∂glichkeiten f√ºr eine solche Angriffstechnik. <br><br>  Die Malware, die ich auf HA gefunden habe, ist das \ VBA-Skript, das in das Word-Dokument integriert wurde.  Das hei√üt, ich muss nicht einmal die Dokumenterweiterung f√§lschen. Diese Malware ist wirklich das am h√§ufigsten aussehende Microsoft Word-Dokument.  Wenn Sie interessiert sind, habe ich dieses Beispiel mit dem Namen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">rfq.doc ausgew√§hlt</a> . <br><br>  Ich habe schnell herausgefunden, dass Sie h√§ufig nicht in der Lage sind, sch√§dliche VBA-Skripte direkt aus einem Dokument zu extrahieren.  Hacker komprimieren und verbergen sie und sind in den in Word integrierten Makrotools nicht sichtbar.  Sie ben√∂tigen ein spezielles Werkzeug, um es zu extrahieren.  Zum Gl√ºck bin ich auf Frank Baldwins <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">OfficeMalScanner gesto√üen</a> .  Danke, Frank. <br><br>  Mit diesem Tool konnte ich einen sehr verwirrenden VBA-Code herausholen.  Es sah ungef√§hr so ‚Äã‚Äãaus: <br><br><img src="https://habrastorage.org/webt/sd/nc/mo/sdncmon3h_nk5cr_hdgzld3jsns.jpeg"><br>  <em>Die Verschleierung wurde von Fachleuten durchgef√ºhrt.</em>  <em>Ich war beeindruckt!</em> <br><br>  Die Angreifer sind wirklich gut darin, den Code durcheinander zu bringen, nicht wie meine Bem√ºhungen, Evil.doc zu erstellen.  Nun, ok, im n√§chsten Teil werden wir unsere VBA-Debugger bekommen, etwas tiefer in diesen Code eintauchen und unsere Analyse mit den HA-Ergebnissen vergleichen. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de458010/">https://habr.com/ru/post/de458010/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de457996/index.html">Gest√§ndnis des Chefs: Wie man auf Reisen arbeitet, die H√§lfte der Abteilung in LA entl√§sst und warum man MeksetnoExp Tyoma Lebedev sponsert</a></li>
<li><a href="../de458000/index.html">Beurteilung der menschlichen Pose auf Bildern f√ºr iOS</a></li>
<li><a href="../de458002/index.html">Was wirklich mit der verschwundenen malaysischen Boeing passiert ist (Teil 1/3)</a></li>
<li><a href="../de458004/index.html">Sojus-TM-Raumfahrzeug-Verkehrskontrollsystem Teil 2</a></li>
<li><a href="../de458006/index.html">Dynamische Websites ohne Server auf Github-Seiten (f√ºr diejenigen, die es nicht wissen, verwenden Serverlose API-Server von Drittanbietern)</a></li>
<li><a href="../de458014/index.html">FEDOR Robot - Training mit der neuen ISS-Crew und den ersten Weltraumaufgaben</a></li>
<li><a href="../de458018/index.html">Komponist vs npm: Multi-Modul-Entwicklung</a></li>
<li><a href="../de458020/index.html">Juli IT Events Digest</a></li>
<li><a href="../de458022/index.html">Fingerabdruck durch Bannerwerbung? Nun ist das √ºblich</a></li>
<li><a href="../de458026/index.html">Vergleich der Serialisierungsformate</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>