<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ôèÔ∏è üé† üîé Les Aventures des Malvari Insaisissables, Partie II: Scripts VBA Secrets üî∏ üíä üêü</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Cet article fait partie de la s√©rie Fileless Malware. Toutes les autres parties de la s√©rie: 



- Les aventures des Malvari insaisissables, partie I ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Les Aventures des Malvari Insaisissables, Partie II: Scripts VBA Secrets</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/varonis/blog/458010/"><img src="https://habrastorage.org/webt/3t/ih/b0/3tihb0g1kt7wbjalc_s3xe0xgjo.png"><br><br>  Cet article fait partie de la s√©rie Fileless Malware.  Toutes les autres parties de la s√©rie: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Les aventures des Malvari insaisissables, partie I</a> </li><li>  Les Aventures des Malvari Insaisissables, Partie II: Scripts VBA Cach√©s (nous sommes ici) </li></ul><br>  Je suis fan du site d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">analyse hybride</a> (HA).  Il s'agit d'une sorte de zoo de logiciels malveillants o√π vous pouvez observer en toute s√©curit√© des "pr√©dateurs" sauvages √† une distance s√ªre sans √™tre attaqu√©.  HA lance des logiciels malveillants dans des environnements s√ªrs, enregistre les appels syst√®me, les fichiers g√©n√©r√©s et le trafic Internet et affiche tous ces r√©sultats pour chaque √©chantillon que vous analysez.  Ainsi, vous ne pouvez pas perdre votre temps et votre √©nergie √† r√©soudre vous-m√™me le code d√©routant, mais comprendre imm√©diatement toutes les intentions des pirates. <br><a name="habracut"></a><br>  Les exemples HA qui ont retenu mon attention utilisent des scripts encod√©s en JavaScript ou Visual Basic pour Applications (VBA) qui sont incorpor√©s en tant que macros dans des documents Word ou Excel et sont joints √† des e-mails de phishing.  Lorsqu'elles sont ouvertes, ces macros d√©marrent une session PowerShell sur l'ordinateur de la victime.  Les pirates envoient g√©n√©ralement des flux de commandes encod√©s en Base64 √† PowerShell.  Tout cela est fait pour rendre l'attaque difficile √† d√©tecter avec des filtres Web et des logiciels antivirus qui r√©pondent √† des mots cl√©s sp√©cifiques. <br>  Heureusement, HA d√©code automatiquement Base64 et affiche imm√©diatement tout sous une forme lisible.  Essentiellement, vous n'avez pas besoin de vous concentrer sur le fonctionnement de ces scripts, car vous pouvez voir la sortie compl√®te des commandes pour ex√©cuter les processus dans la section HA correspondante.  Voir un exemple ci-dessous: <br><br><img src="https://habrastorage.org/webt/ew/jp/cw/ewjpcwuesyaeevrw55513pjcxy4.jpeg"><br><br>  L'analyse hybride intercepte les commandes encod√©es en Base64 envoy√©es √† PowerShell: <br><br><img src="https://habrastorage.org/webt/yy/j7/wx/yyj7wxyf8ejzrjtbnzgjfpdrucc.jpeg"><br><br>  ... puis les d√©code pour vous.  # comme par magie <br><br>  Dans un article <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pr√©c√©dent,</a> j'ai cr√©√© mon propre conteneur JavaScript l√©g√®rement obscurci pour d√©marrer une session PowerShell.  Ensuite, mon script, comme de nombreux logiciels malveillants bas√©s sur PowerShell, t√©l√©charge le script PowerShell suivant √† partir d'un site Web distant.  Ensuite, √† titre d'exemple, j'ai t√©l√©charg√© un PS inoffensif imprimant un message √† l'√©cran.  Mais les temps changent, et maintenant je propose de compliquer le sc√©nario. <br><br><h2>  PowerShell Empire et Reverse Shell </h2><br>  L'un des objectifs de cet exercice est de montrer comment (relativement) facilement un pirate peut contourner les d√©fenses p√©rim√©triques classiques et les antivirus.  Si un blogueur informatique sans comp√©tences en programmation comme moi peut <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cr√©er un malware</a> totalement non d√©tect√© (FUD) en quelques soir√©es, imaginez les possibilit√©s d'un jeune pirate int√©ress√© par cela! <br><br>  Et si vous √™tes une personne assurant la s√©curit√© informatique, mais que votre responsable n'est pas au courant des cons√©quences possibles de ces menaces, montrez-lui simplement cet article. <br><br>  Les pirates informatiques r√™vent d'avoir un acc√®s direct √† un ordinateur portable ou au serveur de la victime.  C'est tr√®s simple √† faire: tout ce dont le pirate a besoin est d'obtenir des fichiers confidentiels sur l'ordinateur portable du PDG. <br><br>  D'une certaine mani√®re, j'ai d√©j√† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">√©crit</a> sur le runtime PowerShell Empire post-op√©rationnel.  Souvenons-nous de ce que c'est. <br><br>  En substance, il s'agit d'un outil de test de p√©n√©tration bas√© sur PowerShell qui, parmi de nombreuses autres fonctionnalit√©s, facilite l'ex√©cution d'un shell invers√©.  Vous pouvez en savoir plus √† ce sujet sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">la page d'accueil PSE</a> . <br><br>  Faisons une petite exp√©rience.  J'ai mis en place un environnement de test de malware s√©curis√© dans le cloud Amazon Web Services.  Vous pouvez suivre mon exemple pour montrer rapidement et en toute s√©curit√© un exemple de travail de cette vuln√©rabilit√© (et ne pas √™tre renvoy√© pour lancer des virus √† l'int√©rieur du p√©rim√®tre de l'entreprise). <br><br>  Si vous d√©marrez la console PowerShell Empire, vous verrez quelque chose comme ceci: <br><br><img src="https://habrastorage.org/webt/vx/-j/mf/vx-jmf1qyoc8cfo1nmcockocfea.jpeg"><br><br>  Tout d'abord, vous d√©marrez le processus d'√©coute sur votre ordinateur pirate.  Entrez la commande ¬´listener¬ª et sp√©cifiez l'adresse IP de votre syst√®me √† l'aide de ¬´set Host¬ª.  Ensuite, d√©marrez le processus d'√©coute avec la commande d'ex√©cution (ci-dessous).  Ainsi, pour votre part, commencez √† attendre une connexion r√©seau depuis le shell distant: <br><br><img src="https://habrastorage.org/webt/fm/1e/ux/fm1eux-ocyidttp4eqlt9q0qb74.jpeg"><br><br>  Pour l'autre c√¥t√©, vous devrez g√©n√©rer le code d'agent en entrant la commande du lanceur (voir ci-dessous).  Cela g√©n√©rera du code PowerShell pour l'agent distant.  Notez qu'il est cod√© en Base64 et repr√©sente la deuxi√®me phase de la charge utile.  En d'autres termes, mon code JavaScript va maintenant extraire cet agent pour ex√©cuter PowerShell au lieu d'une sortie de texte inoffensive √† l'√©cran et se connecter √† notre serveur PSE distant pour ex√©cuter le shell invers√©. <br><br><img src="https://habrastorage.org/webt/xh/vs/ig/xhvsigu6puk1rvt0e3ttwh43uyg.jpeg"><br>  <em>La magie de la coque invers√©e.</em>  <em>Cette commande PowerShell encod√©e se connecte √† mon √©couteur et d√©marre le shell distant.</em> <br><br>  Pour vous montrer cette exp√©rience, j'ai pris le r√¥le d'une victime innocente et ouvert Evil.doc, lan√ßant ainsi notre JavaScript.  Rappelez-vous la premi√®re partie?  PowerShell a √©t√© configur√© pour que sa fen√™tre ne s'ouvre pas, de sorte que la victime ne remarquera rien d'inhabituel.  Cependant, si vous ouvrez le Gestionnaire des t√¢ches de Windows, vous verrez le processus d'arri√®re-plan PowerShell, qui ne d√©clenchera toujours pas d'alarme pour la plupart.  Parce que c'est PowerShell normal, non? <br><br><img src="https://habrastorage.org/webt/wz/se/cr/wzsecrznut3tonqek3wteofemiw.jpeg"><br><br>  D√©sormais, lorsque vous ex√©cutez Evil.doc, un processus d'arri√®re-plan masqu√© se connecte au serveur avec PowerShell Empire.  Apr√®s avoir mis le chapeau blanc du hacker-pentester, je suis retourn√© √† la console PowerShell Empire et maintenant je vois un message indiquant que mon agent distant est actif. <br><br><img src="https://habrastorage.org/webt/fm/1e/ux/fm1eux-ocyidttp4eqlt9q0qb74.jpeg"><br><br>  J'ai ensuite entr√© la commande ¬´interact¬ª pour ouvrir le shell dans PSE - et me voici!  En bref, j'ai pirat√© un serveur Taco, que j'ai moi-m√™me install√© une fois. <br><br><img src="https://habrastorage.org/webt/vh/to/0z/vhto0zmky-9wpmxxpf2tnlzze5s.jpeg"><br><br>  Ce que je viens de d√©montrer ne n√©cessite pas autant de travail de votre part.  Vous pouvez faire tout cela en toute s√©curit√© pendant une pause d√©jeuner d'une √† deux heures pour am√©liorer vos connaissances en mati√®re de s√©curit√© de l'information.  C'est √©galement un excellent moyen de comprendre comment les pirates contournent la protection du p√©rim√®tre de s√©curit√© externe et se d√©ploient secr√®tement sur vos syst√®mes. <br><br>  Les responsables informatiques qui croient avoir construit une protection indestructible contre toute p√©n√©tration le trouveront probablement √©galement informatif - eh bien, si, bien s√ªr, vous pouvez les convaincre de rester assis √† c√¥t√© de vous pendant longtemps. <br><br><h2>  Retour √† la r√©alit√© </h2><br>  Comme je m'y attendais, un vrai hack qui n'est pas visible pour l'utilisateur moyen n'est qu'une variation de ce que je viens de d√©crire.  Pour collecter du mat√©riel pour la prochaine publication, j'ai commenc√© √† chercher un √©chantillon sur HA qui fonctionne de la m√™me mani√®re que mon exemple invent√©.  Et je n'ai pas eu √† le chercher depuis longtemps - le site a de nombreuses options pour une telle technique d'attaque. <br><br>  Le malware que j'ai fini par trouver sur HA est le script \ VBA qui a √©t√© int√©gr√© dans le document Word.  Autrement dit, je n'ai m√™me pas besoin de simuler l'extension doc, ce malware est vraiment le document Microsoft Word le plus courant.  Si vous √™tes int√©ress√©, j'ai choisi cet exemple, appel√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">rfq.doc</a> . <br><br>  J'ai rapidement d√©couvert que, souvent, vous ne pourrez pas extraire directement des scripts VBA malveillants d'un document.  Les pirates les compressent et les cachent, et ils ne sont pas visibles dans les outils de macro int√©gr√©s de Word.  Vous aurez besoin d'un outil sp√©cial pour l'extraire.  Heureusement, je suis tomb√© sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">OfficeMalScanner de</a> Frank Baldwin.  Merci, Frank. <br><br>  En utilisant cet outil, j'ai pu extraire un code VBA tr√®s d√©routant.  Cela ressemblait √† ceci: <br><br><img src="https://habrastorage.org/webt/sd/nc/mo/sdncmon3h_nk5cr_hdgzld3jsns.jpeg"><br>  <em>L'obfuscation a √©t√© effectu√©e par des professionnels.</em>  <em>J'ai √©t√© impressionn√©!</em> <br><br>  Les attaquants sont vraiment bons pour g√¢cher le code, pas comme mes efforts pour cr√©er Evil.doc.  Eh bien, ok, dans la prochaine partie, nous allons obtenir nos d√©bogueurs VBA, approfondir ce code et comparer notre analyse avec les r√©sultats HA. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr458010/">https://habr.com/ru/post/fr458010/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr457996/index.html">Confession du patron: comment travailler en voyage, licencier la moiti√© du d√©partement de LA et pourquoi parrainer MeksetnoExp Tyoma Lebedev</a></li>
<li><a href="../fr458000/index.html">√âvaluation de la pose humaine sur des images pour iOS</a></li>
<li><a href="../fr458002/index.html">Que s'est-il vraiment pass√© avec le Boeing malaisien disparu (partie 1/3)</a></li>
<li><a href="../fr458004/index.html">Syst√®me de contr√¥le du trafic des engins spatiaux Soyouz-TM, partie 2</a></li>
<li><a href="../fr458006/index.html">Sites dynamiques sans serveur sur les pages Github (pour ceux qui ne savent pas, sans serveur utilisent des serveurs API tiers)</a></li>
<li><a href="../fr458014/index.html">Robot FEDOR - formation avec le nouvel √©quipage de l'ISS et les premi√®res t√¢ches spatiales</a></li>
<li><a href="../fr458018/index.html">composer vs npm: d√©veloppement multi-modules</a></li>
<li><a href="../fr458020/index.html">R√©sum√© des √©v√©nements informatiques de juillet</a></li>
<li><a href="../fr458022/index.html">Empreintes digitales √† travers des banni√®res publicitaires? Maintenant, c'est courant</a></li>
<li><a href="../fr458026/index.html">Comparaison des formats de s√©rialisation</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>