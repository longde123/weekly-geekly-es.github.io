<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚úçüèª üßëüèª üåê Criando uma m√°quina de arcade emulador. Parte 3 üö• üßùüèø üéà</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Partes um e dois . 

 Emulador de processador 8080 
 Shell do emulador 
 Agora voc√™ deve ter todo o conhecimento necess√°rio para come√ßar a criar um em...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Criando uma m√°quina de arcade emulador. Parte 3</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/418699/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4ec/e50/f3a/4ece50f3a555bfb39878326ec26addd5.jpg" alt="imagem"></div><br>  Partes <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">um</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">dois</a> . <br><br><h1>  Emulador de processador 8080 </h1><br><h1>  Shell do emulador </h1><br>  Agora voc√™ deve ter todo o conhecimento necess√°rio para come√ßar a criar um emulador de processador 8080. <br><br>  <em>Vou tentar deixar meu c√≥digo o mais claro poss√≠vel, cada c√≥digo operacional √© implementado separadamente.</em>  <em>Quando voc√™ se sentir confort√°vel com isso, poder√° reescrev√™-lo para otimizar o desempenho ou reutilizar o c√≥digo.</em> <br><br>  Para come√ßar, vou criar uma estrutura de mem√≥ria que conter√° campos para tudo o que me pareceu necess√°rio ao escrever um desmontador.  Tamb√©m haver√° um local para um buffer de mem√≥ria, que ser√° a RAM. <br><a name="habracut"></a><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConditionCodes</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> z:<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> s:<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> p:<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> cy:<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> ac:<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> pad:<span class="hljs-number"><span class="hljs-number">3</span></span>; } ConditionCodes; <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">State8080</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> a; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> b; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> c; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> d; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> e; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> h; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> l; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> sp; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> pc; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *memory; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConditionCodes</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cc</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> int_enable; } State8080;</code> </pre> <br>  Agora crie um procedimento com uma chamada de erro que encerre o programa com um erro.  Ser√° algo parecido com isto: <br><br><pre> <code class="cpp hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UnimplementedInstruction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(State8080* state)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// pc    ,     printf ("Error: Unimplemented instruction\n"); exit(1); } int Emulate8080Op(State8080* state) { unsigned char *opcode = &amp;state-&gt;memory[state-&gt;pc]; switch(*opcode) { case 0x00: UnimplementedInstruction(state); break; case 0x01: UnimplementedInstruction(state); break; case 0x02: UnimplementedInstruction(state); break; case 0x03: UnimplementedInstruction(state); break; case 0x04: UnimplementedInstruction(state); break; /*....*/ case 0xfe: UnimplementedInstruction(state); break; case 0xff: UnimplementedInstruction(state); break; } state-&gt;pc+=1; //  }</span></span></code> </pre> <br>  Vamos implementar alguns c√≥digos de opera√ß√£o. <br><br><pre> <code class="cpp hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Emulate8080Op</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(State8080* state)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *opcode = &amp;state-&gt;memory[state-&gt;pc]; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(*opcode) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0x00</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-comment"><span class="hljs-comment">//NOP -  ! case 0x01: //LXI B, state-&gt;c = opcode[1]; state-&gt;b = opcode[2]; state-&gt;pc += 2; //   2  break; /*....*/ case 0x41: state-&gt;b = state-&gt;c; break; //MOV B,C case 0x42: state-&gt;b = state-&gt;d; break; //MOV B,D case 0x43: state-&gt;b = state-&gt;e; break; //MOV B,E } state-&gt;pc+=1; }</span></span></code> </pre> <br>  L√° vai voc√™.  Para cada opcode, alteramos o estado e a mem√≥ria, como faria um comando executado em um 8080 real. <br><br>  O 8080 possui cerca de 7 tipos, dependendo de como voc√™ os classifica: <br><br><ul><li>  Transfer√™ncia de dados </li><li>  Aritm√©tica </li><li>  Logical </li><li>  Ramos </li><li>  Stack </li><li>  Entrada-sa√≠da </li><li>  Especial </li></ul><br>  Vamos olhar para cada um deles individualmente. <br><br><h1>  Grupo aritm√©tico </h1><br>  As instru√ß√µes aritm√©ticas s√£o muitos dos 256 opcodes do processador 8080, que incluem v√°rios tipos de adi√ß√£o e subtra√ß√£o.  A maioria das instru√ß√µes aritm√©ticas trabalha com o registro A e salva o resultado em A. (O registro A tamb√©m √© chamado de acumulador). <br><br>  √â interessante notar que esses comandos afetam os c√≥digos de condi√ß√£o.  Os c√≥digos de estado (tamb√©m chamados de sinalizadores) s√£o configurados dependendo do resultado do comando executado.  Nem todos os comandos afetam sinalizadores e nem todas as equipes que afetam sinalizadores afetam todos os sinalizadores de uma s√≥ vez. <br><br><h3>  Flags 8080 </h3><br>  Em um processador 8080, os sinalizadores s√£o chamados Z, S, P, CY e AC. <br><br><ul><li>  Z (zero, zero) assume o valor 1 quando o resultado √© zero </li><li>  S (sinal) assume o valor 1 quando o bit 7 (o bit mais significativo, o bit mais significativo, MSB) do comando matem√°tico √© fornecido </li><li>  P (paridade, paridade) √© definido quando o resultado √© par e √© redefinido quando √© √≠mpar </li><li>  CY (carry) assume o valor 1 quando, como resultado do comando, √© realizada uma transfer√™ncia ou empr√©stimo para um bit de ordem superior </li><li>  AC (transporte auxiliar) √© usado principalmente para matem√°tica BCD (decimal com c√≥digo bin√°rio).  Para mais detalhes, consulte o manual, em Space Invaders, esse sinalizador n√£o √© usado. </li></ul><br>  Os c√≥digos de estado s√£o usados ‚Äã‚Äãem comandos de ramifica√ß√£o condicional, por exemplo, JZ executa ramifica√ß√£o apenas se o sinalizador Z estiver definido. <br><br>  A maioria das instru√ß√µes possui tr√™s formas: para registros, valores imediatos e mem√≥ria.  Vamos implementar algumas instru√ß√µes para entender seus formul√°rios e ver como √© trabalhar com c√≥digos de estado.  (Observe que eu n√£o implemento o sinalizador de transfer√™ncia auxiliar porque ele n√£o √© usado. Se eu o implementei, n√£o poderia test√°-lo.) <br><br><h4>  Formul√°rio de Registro </h4><br>  Aqui est√° um exemplo de implementa√ß√£o de duas instru√ß√µes com um formul√°rio de registro;  no primeiro, implantei o c√≥digo para facilitar o trabalho e, no segundo, √© apresentado um formul√°rio mais compacto que faz a mesma coisa. <br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0x80</span></span>: <span class="hljs-comment"><span class="hljs-comment">//ADD B { //      , //      uint16_t answer = (uint16_t) state-&gt;a + (uint16_t) state-&gt;b; //  :    , //    , //      if ((answer &amp; 0xff) == 0) state-&gt;cc.z = 1; else state-&gt;cc.z = 0; //  :   7 , //    , //      if (answer &amp; 0x80) state-&gt;cc.s = 1; else state-&gt;cc.s = 0; //   if (answer &gt; 0xff) state-&gt;cc.cy = 1; else state-&gt;cc.cy = 0; //    state-&gt;cc.p = Parity( answer &amp; 0xff); state-&gt;a = answer &amp; 0xff; } //  ADD     case 0x81: //ADD C { uint16_t answer = (uint16_t) state-&gt;a + (uint16_t) state-&gt;c; state-&gt;cc.z = ((answer &amp; 0xff) == 0); state-&gt;cc.s = ((answer &amp; 0x80) != 0); state-&gt;cc.cy = (answer &gt; 0xff); state-&gt;cc.p = Parity(answer&amp;0xff); state-&gt;a = answer &amp; 0xff; }</span></span></code> </pre> <br>  Eu emulo comandos matem√°ticos de 8 bits com um n√∫mero de 16 bits.  Isso facilita o rastreamento de casos em que os c√°lculos geram uma carga. <br><br><h4>  Formul√°rio para valores imediatos </h4><br>  O formul√°rio para valores imediatos √© quase o mesmo, exceto que o byte ap√≥s o comando √© a fonte do adicionado.  Como ‚Äúopcode‚Äù √© um ponteiro para o comando atual na mem√≥ria, opcode [1] ser√° imediatamente o pr√≥ximo byte. <br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0xC6</span></span>: <span class="hljs-comment"><span class="hljs-comment">//ADI  { uint16_t answer = (uint16_t) state-&gt;a + (uint16_t) opcode[1]; state-&gt;cc.z = ((answer &amp; 0xff) == 0); state-&gt;cc.s = ((answer &amp; 0x80) != 0); state-&gt;cc.cy = (answer &gt; 0xff); state-&gt;cc.p = Parity(answer&amp;0xff); state-&gt;a = answer &amp; 0xff; }</span></span></code> </pre> <br><h4>  Forma para mem√≥ria </h4><br>  No formul√°rio de mem√≥ria, um byte ser√° adicionado ao qual o endere√ßo armazenado em um par de registros HL indica. <br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0x86</span></span>: <span class="hljs-comment"><span class="hljs-comment">//ADD M { uint16_t offset = (state-&gt;h&lt;&lt;8) | (state-&gt;l); uint16_t answer = (uint16_t) state-&gt;a + state-&gt;memory[offset]; state-&gt;cc.z = ((answer &amp; 0xff) == 0); state-&gt;cc.s = ((answer &amp; 0x80) != 0); state-&gt;cc.cy = (answer &gt; 0xff); state-&gt;cc.p = Parity(answer&amp;0xff); state-&gt;a = answer &amp; 0xff; }</span></span></code> </pre> <br><h3>  Anota√ß√µes </h3><br>  As demais instru√ß√µes aritm√©ticas s√£o implementadas de maneira semelhante.  Adi√ß√µes: <br><br><ul><li>  Em diferentes vers√µes com transporte (ADC, ACI, SBB, SUI), de acordo com o manual de refer√™ncia, usamos bits de transporte nos c√°lculos. </li><li>  INX e DCX afetam pares de registradores; esses comandos n√£o afetam sinalizadores. </li><li>  DAD √© outro comando de um par de registros, afeta apenas a bandeira de transporte </li><li>  INR e DCR n√£o afetam o sinalizador de transporte </li></ul><br><h1>  Grupo de filiais </h1><br>  Depois de lidar com os c√≥digos de estado, o grupo de filiais ficar√° claro o suficiente para voc√™.  Existem dois tipos de ramifica√ß√£o - transi√ß√µes (JMP) e chamadas (CALL).  O JMP apenas define o PC para o valor do destino do salto.  CALL √© usado para rotinas, grava o endere√ßo de retorno na pilha e atribui ao PC o endere√ßo de destino.  RET retorna de CALL, recebendo o endere√ßo da pilha e gravando-o no PC. <br><br>  JMP e CALL apenas v√£o para endere√ßos absolutos que s√£o codificados em bytes ap√≥s o c√≥digo de opera√ß√£o. <br><br><h3>  Jmp </h3><br>  O comando JMP ramifica incondicionalmente no endere√ßo de destino.  Tamb√©m existem comandos de ramifica√ß√£o condicional para todos os c√≥digos de status (exceto para AC): <br><br><ul><li>  JNZ e JZ para zero </li><li>  JNC e JC para migra√ß√£o </li><li>  JPO e JPE para paridade </li><li>  JP (mais) e JM (menos) para o sinal </li></ul><br>  Aqui est√° uma implementa√ß√£o de alguns deles: <br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0xc2</span></span>: <span class="hljs-comment"><span class="hljs-comment">//JNZ  if (0 == state-&gt;cc.z) state-&gt;pc = (opcode[2] &lt;&lt; 8) | opcode[1]; else //    state-&gt;pc += 2; break; case 0xc3: //JMP  state-&gt;pc = (opcode[2] &lt;&lt; 8) | opcode[1]; break;</span></span></code> </pre> <br><h3>  CHAMADA e RET </h3><br>  CALL envia o endere√ßo da instru√ß√£o para a pilha ap√≥s a chamada e depois pula para o endere√ßo de destino.  O RET recebe o endere√ßo da pilha e o salva no PC.  Vers√µes condicionais do CALL e RET existem para todos os estados. <br><br><ul><li>  CZ, CNZ, RZ, RNZ para zero </li><li>  CNC, CC, RNC, RC para transfer√™ncia </li><li>  CPO, CPE, RPO, RPE para paridade </li><li>  CP, CM, RP, RM para sinal </li></ul><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0xcd</span></span>: <span class="hljs-comment"><span class="hljs-comment">//CALL  { uint16_t ret = state-&gt;pc+2; state-&gt;memory[state-&gt;sp-1] = (ret &gt;&gt; 8) &amp; 0xff; state-&gt;memory[state-&gt;sp-2] = (ret &amp; 0xff); state-&gt;sp = state-&gt;sp - 2; state-&gt;pc = (opcode[2] &lt;&lt; 8) | opcode[1]; } break; case 0xc9: //RET state-&gt;pc = state-&gt;memory[state-&gt;sp] | (state-&gt;memory[state-&gt;sp+1] &lt;&lt; 8); state-&gt;sp += 2; break;</span></span></code> </pre> <br><h3>  Anota√ß√µes </h3><br><ul><li>  O comando PCHL salta incondicionalmente para um endere√ßo em um par de registros HL. </li><li>  N√£o inclu√≠ o RST discutido anteriormente neste grupo.  Ele grava o endere√ßo de retorno na pilha e salta para o endere√ßo predefinido na parte inferior da mem√≥ria. </li></ul><br><h1>  Grupo l√≥gico </h1><br>  Este grupo executa opera√ß√µes l√≥gicas (consulte a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">primeira postagem do</a> tutorial).  Por sua natureza, eles s√£o semelhantes a um grupo aritm√©tico, pois a maioria das opera√ß√µes trabalha com o registro A (unidade) e a maioria das opera√ß√µes afeta sinalizadores.  Todas as opera√ß√µes s√£o executadas em valores de 8 bits; nesse grupo, n√£o h√° comandos que afetem pares de registradores. <br><br><h3>  Opera√ß√µes booleanas </h3><br>  AND, OR, NOT (CMP) e "exclusivo ou" (XOR) s√£o chamados de opera√ß√µes booleanas.  OU e AND eu expliquei anteriormente.  O comando NOT (para o processador 8080 √© chamado de CMA, ou acumulador de complemento) simplesmente altera os valores dos bits - todas as unidades se tornam zeros e zeros se tornam um. <br><br>  Eu percebo o XOR como um "reconhecedor de diferen√ßas".  Sua tabela de verdade √© assim: <br><br><table><tbody><tr><td>  x </td><td>  y </td><td>  Resultado </td></tr><tr><td>  0 0 </td><td>  0 0 </td><td>  0 0 </td></tr><tr><td>  0 0 </td><td>  1 </td><td>  1 </td></tr><tr><td>  1 </td><td>  0 0 </td><td>  1 </td></tr><tr><td>  1 </td><td>  1 </td><td>  0 0 </td></tr></tbody></table><br>  AND, OR e XOR t√™m um formul√°rio para registros, mem√≥ria e valores imediatos.  (O CMP possui apenas um comando que diferencia mai√∫sculas de min√∫sculas).  Aqui est√° uma implementa√ß√£o de um par de c√≥digos de opera√ß√£o: <br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0x2F</span></span>: <span class="hljs-comment"><span class="hljs-comment">//CMA (not) state-&gt;a = ~state-&gt;a //  ,  CMA     break; case 0xe6: //ANI  { uint8_t x = state-&gt;a &amp; opcode[1]; state-&gt;cc.z = (x == 0); state-&gt;cc.s = (0x80 == (x &amp; 0x80)); state-&gt;cc.p = parity(x, 8); state-&gt;cc.cy = 0; //  ,  ANI  CY state-&gt;a = x; state-&gt;pc++; //   } break;</span></span></code> </pre> <br><h3>  Comandos de mudan√ßa c√≠clica </h3><br>  Esses comandos alteram a ordem dos bits nos registradores.  Um deslocamento para a direita os move um pouco para a direita e um deslocamento para a esquerda - um pouco para a esquerda: <br><br> <code>  (0b00010000) = 0b00001000</code> <br> <br> <code>  (0b00000001) = 0b00000010</code> <br> <br>  Eles parecem n√£o ter valor, mas na realidade n√£o √© assim.  Eles podem ser usados ‚Äã‚Äãpara multiplicar e dividir por pot√™ncias de dois.  Tome o deslocamento √† esquerda como exemplo.  <code>0b00000001</code> √© decimal 1, e <code>0b00000001</code> -lo para a esquerda torna <code>0b00000010</code> , ou seja, 2. Se executarmos outro deslocamento para a esquerda, obtemos <code>0b00000100</code> , ou seja, 4. Outro deslocamento para a esquerda e multiplicamos por 8. Isso funcionar√° com qualquer por n√∫meros: 5 ( <code>0b00000101</code> ) quando deslocado para a esquerda, fornece 10 ( <code>0b00001010</code> ).  Outro deslocamento √† esquerda fornece 20 ( <code>0b00010100</code> ).  Uma mudan√ßa para a direita faz o mesmo, mas para a divis√£o. <br><br>  O 8080 n√£o possui um comando de multiplica√ß√£o, mas pode ser implementado usando esses comandos.  Se voc√™ entender como fazer isso, receber√° pontos de b√¥nus.  Uma vez que essa pergunta me foi feita em uma entrevista.  (Fiz, embora demorei alguns minutos.) <br><br>  Esses comandos giram o inversor ciclicamente e afetam apenas o sinalizador de transporte.  Aqui est√£o alguns comandos: <br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0x0f</span></span>: <span class="hljs-comment"><span class="hljs-comment">//RRC { uint8_t x = state-&gt;a; state-&gt;a = ((x &amp; 1) &lt;&lt; 7) | (x &gt;&gt; 1); state-&gt;cc.cy = (1 == (x&amp;1)); } break; case 0x1f: //RAR { uint8_t x = state-&gt;a; state-&gt;a = (state-&gt;cc.cy &lt;&lt; 7) | (x &gt;&gt; 1); state-&gt;cc.cy = (1 == (x&amp;1)); } break;</span></span></code> </pre> <br><h3>  Compara√ß√£o </h3><br>  A tarefa do CMP e CPI √© apenas definir sinalizadores (para ramifica√ß√£o).  Eles fazem isso subtraindo sinalizadores, mas n√£o armazenando o resultado. <br><br><ul><li>  Igualmente: se dois n√∫meros s√£o iguais, o sinalizador Z √© definido, pois a subtra√ß√£o um do outro d√° zero. </li><li>  Maior que: se A for maior que o valor que est√° sendo comparado, o sinalizador CY ser√° apagado (j√° que a subtra√ß√£o pode ser feita sem empr√©stimo). </li><li>  Menor: se A for menor que o valor comparado, o sinalizador CY √© definido (porque A deve concluir o empr√©stimo para concluir a subtra√ß√£o). </li></ul><br>  Existem vers√µes desses comandos para registros, mem√≥ria e valores imediatos.  A implementa√ß√£o √© uma subtra√ß√£o simples sem salvar o resultado: <br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0xfe</span></span>: <span class="hljs-comment"><span class="hljs-comment">//CPI  { uint8_t x = state-&gt;a - opcode[1]; state-&gt;cc.z = (x == 0); state-&gt;cc.s = (0x80 == (x &amp; 0x80)); //  ,    p -   state-&gt;cc.p = parity(x, 8); state-&gt;cc.cy = (state-&gt;a &lt; opcode[1]); state-&gt;pc++; } break;</span></span></code> </pre> <br><h3>  CMC e STC </h3><br>  Eles completam o grupo l√≥gico.  Eles s√£o usados ‚Äã‚Äãpara definir e limpar a bandeira de transporte. <br><br><h1>  Grupo de entrada-sa√≠da e comandos especiais </h1><br>  Esses comandos n√£o podem ser atribu√≠dos a nenhuma outra categoria.  Vou mencion√°-los por completo, mas parece-me que teremos que retornar a eles novamente quando come√ßarmos a emular o hardware dos Space Invaders. <br><br><ul><li>  EI e DI ativam ou desativam a capacidade do processador de lidar com interrup√ß√µes.  Adicionei o sinalizador interrupt_enabled √† estrutura de estado do processador e o configurei / redefinii usando esses comandos. </li><li>  Parece que RIM e SIM s√£o usados ‚Äã‚Äãprincipalmente para E / S serial.  Se voc√™ estiver interessado, pode ler o manual, mas esses comandos n√£o s√£o utilizados no Space Invaders.  Eu n√£o vou imit√°-los. </li><li>  HLT √© uma parada.  Acho que n√£o precisamos imit√°-lo, mas voc√™ pode chamar seu c√≥digo de sa√≠da (ou sair (0)) quando vir este comando. </li><li>  IN e OUT s√£o comandos que o equipamento do processador 8080 usa para se comunicar com equipamento externo.  Enquanto os estivermos implementando, eles n√£o far√£o nada al√©m de pular seus bytes de dados.  (Mais tarde retornaremos a eles). </li><li>  NOP √© "sem opera√ß√£o".  Uma aplica√ß√£o do NOP √© controlar o tempo do painel (s√£o necess√°rios quatro ciclos de CPU para executar). </li></ul><br>  Outra aplica√ß√£o do NOP √© a modifica√ß√£o do c√≥digo.  Digamos que precisamos alterar o c√≥digo ROM do jogo.  N√£o podemos excluir apenas opcodes desnecess√°rios, porque n√£o queremos alterar todos os comandos CALL e JMP (eles estar√£o incorretos se pelo menos uma parte do c√≥digo for movida).  Com o NOP, podemos nos livrar do c√≥digo.  <em>Adicionar c√≥digo √© muito mais dif√≠cil!</em>  <em>Voc√™ pode adicion√°-lo localizando espa√ßo em algum lugar da ROM e alterando o comando para JMP.</em> <br><br><h1>  Grupo de pilhas </h1><br>  J√° completamos a mec√¢nica da maioria das equipes no grupo de pilhas.  Se voc√™ fez o trabalho comigo, esses comandos ser√£o f√°ceis de implementar. <br><br><h3>  PUSH e POP </h3><br>  PUSH e POP funcionam apenas com pares de registradores.  PUSH grava um par de registradores na pilha, e o POP pega 2 bytes do topo da pilha e os grava em um par de registradores. <br><br>  Existem quatro opcodes para PUSH e POP, um para cada um dos pares: BC, DE, HL e PSW.  PSW √© um par especial de registros de sinalizadores de unidade e c√≥digos de status.  Aqui est√° a minha implementa√ß√£o de PUSH e POP para BC e PSW.  N√£o h√° coment√°rios - n√£o acho que exista algo particularmente complicado aqui. <br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0xc1</span></span>: <span class="hljs-comment"><span class="hljs-comment">//POP B { state-&gt;c = state-&gt;memory[state-&gt;sp]; state-&gt;b = state-&gt;memory[state-&gt;sp+1]; state-&gt;sp += 2; } break; case 0xc5: //PUSH B { state-&gt;memory[state-&gt;sp-1] = state-&gt;b; state-&gt;memory[state-&gt;sp-2] = state-&gt;c; state-&gt;sp = state-&gt;sp - 2; } break; case 0xf1: //POP PSW { state-&gt;a = state-&gt;memory[state-&gt;sp+1]; uint8_t psw = state-&gt;memory[state-&gt;sp]; state-&gt;cc.z = (0x01 == (psw &amp; 0x01)); state-&gt;cc.s = (0x02 == (psw &amp; 0x02)); state-&gt;cc.p = (0x04 == (psw &amp; 0x04)); state-&gt;cc.cy = (0x05 == (psw &amp; 0x08)); state-&gt;cc.ac = (0x10 == (psw &amp; 0x10)); state-&gt;sp += 2; } break; case 0xf5: //PUSH PSW { state-&gt;memory[state-&gt;sp-1] = state-&gt;a; uint8_t psw = (state-&gt;cc.z | state-&gt;cc.s &lt;&lt; 1 | state-&gt;cc.p &lt;&lt; 2 | state-&gt;cc.cy &lt;&lt; 3 | state-&gt;cc.ac &lt;&lt; 4 ); state-&gt;memory[state-&gt;sp-2] = psw; state-&gt;sp = state-&gt;sp - 2; } break;</span></span></code> </pre> <br><h3>  SPHL e XTHL </h3><br>  Existem mais duas equipes no grupo de pilhas - SPHL e XTHL. <br><br><ul><li>  <code>SPHL</code> move o HL para o SP (for√ßando o SP a obter um novo endere√ßo). </li><li>  <code>XTHL</code> troca o que est√° no topo da pilha pelo que est√° em um par de registros HL.  Por que voc√™ precisaria fazer isso?  Eu n√£o sei </li></ul><br><h1>  Um pouco mais sobre n√∫meros bin√°rios </h1><br>  Ao escrever um programa de computador, uma das decis√µes que voc√™ precisa tomar √© escolher o tipo de dados usado para os n√∫meros - se voc√™ deseja que eles sejam negativos e qual deve ser o tamanho m√°ximo deles.  Para o emulador de CPU, precisamos do tipo de dados para corresponder ao tipo de dados da CPU de destino. <br><br><h3>  Assinado e n√£o assinado </h3><br>  Quando come√ßamos a falar sobre n√∫meros hexadecimais, os consideramos sem sinal - ou seja, cada d√≠gito bin√°rio do n√∫mero hexadecimal tinha um valor positivo e cada um era considerado uma pot√™ncia de dois (unidades, dois, quatro, etc.). <br><br>  Lidamos com a quest√£o do armazenamento em computador de n√∫meros negativos.  Se voc√™ souber que os dados em quest√£o t√™m um sinal, ou seja, eles podem ser negativos, voc√™ poder√° reconhecer um n√∫mero negativo pelo bit mais significativo do n√∫mero (bit mais significativo, MSB).  Se o tamanho dos dados for de um byte, cada n√∫mero com um determinado valor de bit MSB ser√° negativo e cada um com um MSB zero ser√° positivo. <br><br>  O valor de um n√∫mero negativo √© armazenado como um c√≥digo adicional.  Se temos um n√∫mero assinado e o MSB √© igual a um, e queremos descobrir qual √© esse n√∫mero, podemos convert√™-lo da seguinte forma: execute ‚ÄúNOT‚Äù bin√°rio para n√∫meros hexadecimais e adicione um. <br><br>  Por exemplo, para um n√∫mero hexadecimal 0x80, o bit MSB √© definido, ou seja, √© negativo.  O "N√ÉO" bin√°rio do n√∫mero 0x80 √© 0x7f, ou decimal 127. 127 + 1 = 128. Ou seja, 0x80 em decimal √© -128.  Segundo exemplo: 0xC5.  N√£o (0xC5) = 0x3A = decimal 58 +1 = decimal 59. Ou seja, 0xC5 √© decimal -59. <br><br>  O que √© surpreendente em n√∫meros com c√≥digo adicional √© que podemos realizar c√°lculos com eles, assim como com n√∫meros n√£o assinados, e eles ainda <em>funcionar√£o</em> .  O computador n√£o precisa fazer nada de especial com sinais.  Vou mostrar alguns exemplos que provam isso. <br><br><pre>  Exemplo 1<font></font>
<font></font>
      bin√°rio hexadecimal decimal    
       -3 0xFD 1111 1101    
    + 10 0x0A +0000 1010    
    ----- -----------    
        7 0x07 1 0000 0111    
                        ^ Isso √© gravado no bit de transporte<font></font>
<font></font>
    Exemplo 2    <font></font>
<font></font>
      bin√°rio hexadecimal decimal    
      -59 0xC5 1100 0101    
    + 33 0x21 +0010 0001    
    ----- -----------    
      -26 0xE6 1110 0110 </pre><br><br>  No Exemplo 1, vemos que a adi√ß√£o de 10 e -3 resulta em 7. O resultado da adi√ß√£o foi transferido para que o sinalizador C. No Exemplo 2, o resultado da adi√ß√£o foi negativo, portanto decodificamos isso: Not (0xE6) = 0x19 = 25 + 1 = 26. <code>0xE6 = -26</code> Explos√£o do c√©rebro! <br><br>  Se voc√™ quiser, leia mais sobre o c√≥digo adicional na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Wikipedia</a> . <br><br><h3>  Tipos de dados </h3><br>  Em C, h√° um relacionamento entre os tipos de dados e o n√∫mero de bytes usados ‚Äã‚Äãpara esse tipo.  De fato, estamos interessados ‚Äã‚Äãapenas em n√∫meros inteiros.  Os tipos de dados C padr√£o / old school s√£o char, int e long, assim como seus amigos char n√£o assinado, int n√£o assinado e n√£o assinado por muito tempo.  O problema √© que, em plataformas diferentes e em compiladores diferentes, esses tipos podem ter tamanhos diferentes. <br><br>  Portanto, √© melhor selecionar um tipo de dados para nossa plataforma que declare explicitamente o tamanho dos dados.  Se sua plataforma possui stdint.h, voc√™ pode usar int8_t, uint8_t, etc. <br><br>  O tamanho de um n√∫mero inteiro determina o n√∫mero m√°ximo que pode ser armazenado nele.  No caso de n√∫meros inteiros n√£o assinados, voc√™ pode armazenar n√∫meros de 0 a 255 em 8 bits. Se voc√™ converter em hexadecimal, ser√° de 0x00 a 0xFF.  Como 0xFF possui ‚Äútodos os bits definidos‚Äù e corresponde ao decimal 255, √© completamente l√≥gico que o intervalo de um n√∫mero inteiro n√£o assinado de byte √∫nico seja de 0 a 255.  Intervalos nos dizem que todos os tamanhos de n√∫meros inteiros funcionar√£o exatamente da mesma maneira - os n√∫meros correspondem ao n√∫mero obtido quando todos os bits s√£o definidos. <br><br><table><tbody><tr><th>  Tipo </th><th>  Intervalo </th><th>  Hex </th></tr><tr><td>  8 bits n√£o assinado </td><td>  0-255 </td><td>  0x0-0xFF </td></tr><tr><td>  Assinado de 8 bits </td><td>  -128-127 </td><td>  0x80-0x7F </td></tr><tr><td>  16 bits n√£o assinado </td><td>  0-65535 </td><td>  0x0-0xFFFF </td></tr><tr><td>  Assinado de 16 bits </td><td>  -32768-32767 </td><td>  0x8000-0x7FFF </td></tr><tr><td>  32 bits n√£o assinado </td><td>  0-4294967295 </td><td>  0x0-0xFFFFFFFFFF </td></tr><tr><td>  Assinado de 32 bits </td><td>  -2147483648-2147483647 </td><td>  0x80000000-0x7FFFFFFF </td></tr></tbody></table><br>  Ainda mais interessante √© que -1 em cada tipo de dado assinado √© um n√∫mero que possui todos os bits definidos (0xFF para byte assinado, 0xFFFF para n√∫mero assinado de 16 bits e 0xFFFFFFFF para n√∫mero assinado de 32 bits).  Se os dados forem considerados sem sinal, ent√£o, para todos os bits fornecidos, o n√∫mero m√°ximo poss√≠vel para esse tipo de dado √© obtido. <br><br>  Para emular os registros do processador, selecionamos o tipo de dados correspondente ao tamanho desse registro.  Provavelmente vale a pena selecionar tipos n√£o assinados por padr√£o e convert√™-los quando voc√™ precisar consider√°-los assinados.  Por exemplo, usamos o tipo de dados uint8_t para representar um registro de 8 bits. <br><br><h3>  Dica: use um depurador para converter tipos de dados </h3><br>  Se o gdb estiver instalado na sua plataforma, √© muito conveniente us√°-lo para trabalhar com n√∫meros bin√°rios.  Abaixo, mostrarei um exemplo - na sess√£o mostrada abaixo, as linhas que come√ßam com # s√£o coment√°rios que adicionei posteriormente. <br><br> <code>#  /c,   gdb      <br> (gdb) print /c 0xFD <br> $1 = -3 '?' <br> <br> #  /x,   gdb    hex <br> #   "p"  "print" <br> (gdb) p /c 0xA <br> $2 = 10 '\n' <br> <br> #    2  " " <br> (gdb) p /c 0xC5 <br> $3 = -59 '?' <br> (gdb) p /c 0xC5+0x21 <br> $4 = -26 '?' <br> <br> #  print  ,  gdb    <br> (gdb) p 0x21 <br> $9 = 33 <br> <br> #     ,     gdb, <br> #  ,      <br> (gdb) p 0xc5 <br> $5 = 197 # <br> (gdb) p /c 0xc5 <br> $3 = -59 '?' # <br> (gdb) p 0xfd <br> $6 = 253 <br> <br> #        (   32- ) <br> (gdb) p /x -3 <br> $7 = 0xfffffffd <br> <br> #   1     <br> (gdb) print (char) 0xff <br> $1 = -1 '?' <br> #   1     <br> (gdb) print (unsigned char) 0xff <br> $2 = 255 '?'</code> <br> <br>  Quando trabalho com n√∫meros hexadecimais, sempre o fa√ßo em gdb - e isso acontece quase todos os dias.  Muito mais f√°cil do que abrir a calculadora de um programador com uma GUI.  Nas m√°quinas Linux (e Mac OS X), para iniciar uma sess√£o de gdb, basta abrir um terminal e inserir "gdb".  Se voc√™ usar o Xcode no OS X, depois de iniciar o programa, poder√° usar o console dentro do Xcode (aquele no qual a sa√≠da printf √© emitida).<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> No Windows, o depurador gdb est√° dispon√≠vel no Cygwin. </font></font><br><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Termina√ß√£o do emulador de CPU </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Depois de receber todas essas informa√ß√µes, voc√™ est√° pronto para uma longa jornada. </font><font style="vertical-align: inherit;">Voc√™ deve decidir como implementar o emulador - crie uma emula√ß√£o 8080 completa ou implemente apenas os comandos necess√°rios para concluir o jogo. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se voc√™ decidir fazer uma emula√ß√£o completa, precisar√° de mais algumas ferramentas. </font><font style="vertical-align: inherit;">Vou falar sobre eles na pr√≥xima se√ß√£o. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Outra maneira √© emular apenas as instru√ß√µes usadas pelo jogo. </font><font style="vertical-align: inherit;">Continuaremos preenchendo a enorme constru√ß√£o de switch que criamos na se√ß√£o Shell do Emulador. </font><font style="vertical-align: inherit;">Repetiremos o seguinte processo at√© termos um √∫nico comando n√£o realizado:</font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Inicie o emulador com ROM Space Invaders </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A chamada </font></font><code>UnimplementedInstruction()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sai se o comando n√£o estiver pronto</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Emule esta instru√ß√£o </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Goto 1 </font></font></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A primeira coisa que fiz ao come√ßar a escrever meu emulador foi adicionar c√≥digo do meu desmontador. </font><font style="vertical-align: inherit;">Ent√£o, eu pude emitir um comando que deve ser executado da seguinte maneira:</font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Emulate8080Op</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(State8080* state)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *opcode = &amp;state-&gt;memory[state-&gt;pc]; Disassemble8080Op(state-&gt;memory, state-&gt;pc); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (*opcode) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0x00</span></span>: <span class="hljs-comment"><span class="hljs-comment">//NOP /* ... */ } /*    */ printf("\tC=%d,P=%d,S=%d,Z=%d\n", state-&gt;cc.cy, state-&gt;cc.p, state-&gt;cc.s, state-&gt;cc.z); printf("\tA $%02x B $%02x C $%02x D $%02x E $%02x H $%02x L $%02x SP %04x\n", state-&gt;a, state-&gt;b, state-&gt;c, state-&gt;d, state-&gt;e, state-&gt;h, state-&gt;l, state-&gt;sp); }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tamb√©m adicionei c√≥digo no final para exibir todos os registros e sinalizadores de estado. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Boas not√≠cias: para nos aprofundarmos no programa para 50 mil equipes, precisamos apenas de um subconjunto dos c√≥digos de opera√ß√£o 8080. Vou at√© fornecer uma lista de c√≥digos de opera√ß√£o que precisam ser implementados:</font></font><br><br><table><tbody><tr><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Opcode </font></font></th><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> A equipe </font></font></th></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x00 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Nop </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x01 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> LXI B, D16 </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x05 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> DCR B </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x06 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MVI B, D8 </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x09 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pai b </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x0d </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> DCR C </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x0e </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MVI C, D8 </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x0f </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Rrc </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x11 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> LXI D, D16 </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x13 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Inx d </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x19 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pai d </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x1a </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> LDAX D </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x21 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> LXI H, D16 </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x23 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Inx h </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x26 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MVI H, D8 </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x29 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pai h </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x31 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> LXI SP, D16 </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x32 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> STA adr </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x36 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MVI M, D8 </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x3a </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Lda adr </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x3e </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MVI A, D8 </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x56 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MOV D, M </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x5e </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MOV E, M </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x66 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MOV H, M </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x6f </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MOV L, A </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x77 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MOV M, A </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x7a </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MOV A, D </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x7b </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MOV A, E </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x7c </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MOV A, H </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x7e </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MOV A, M </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0xa7 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ANA A </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0xaf </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> XRA A </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0xc1 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pop b </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0xc2 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Jnz adr </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0xc3 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Jmp adr </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0xc5 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> PUSH B </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0xc6 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ADI D8 </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0xc9 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ret </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0xcd </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Call adr </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0xd1 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pop d </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0xd3 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> OUT D8 </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0xd5 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> PUSH D </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0xe1 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pop h </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0xe5 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> PUSH H </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0xe6 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ANI D8 </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0xeb </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Xchg </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0xf1 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> POP PSW </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0xf5 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> PUSH PSW </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0xfb </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ei </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0xfe </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CPI D8 </font></font></td></tr></tbody></table><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Estas s√£o apenas 50 instru√ß√µes e 10 delas s√£o movimentos que s√£o implementados trivialmente. </font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Depura√ß√£o </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mas tenho m√°s not√≠cias. </font><font style="vertical-align: inherit;">Seu emulador quase certamente n√£o funcionar√° corretamente, e √© muito dif√≠cil encontrar erros nesse c√≥digo. </font><font style="vertical-align: inherit;">Se voc√™ souber qual comando est√° se comportando mal (por exemplo, uma transi√ß√£o ou uma chamada que v√° para c√≥digo sem sentido), tente corrigir o erro examinando seu c√≥digo. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Al√©m de examinar o c√≥digo, h√° outra maneira de corrigir o problema - comparando seu emulador com um que funcione exatamente. </font><font style="vertical-align: inherit;">Assumimos que outro emulador sempre funcione corretamente, e todas as diferen√ßas s√£o erros no seu emulador. </font><font style="vertical-align: inherit;">Por exemplo, voc√™ pode usar meu emulador. </font><font style="vertical-align: inherit;">Voc√™ pode execut√°-los manualmente em paralelo. </font><font style="vertical-align: inherit;">Voc√™ pode economizar tempo se integrar meu c√≥digo ao seu projeto para obter o seguinte processo:</font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Crie um estado para o seu emulador </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Crie um estado para o meu </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Para a pr√≥xima equipe </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Chamando seu emulador com seu estado </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Chamando a minha com minha fortuna </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Compare nossos dois estados </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Procurando erros em quaisquer diferen√ßas </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ir para 3 </font></font></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Outra maneira √© usar manualmente </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">este site</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Este √© um emulador de processador Javascript 8080 que inclui at√© Invasores de Espa√ßo ROM. </font><font style="vertical-align: inherit;">Aqui est√° o processo:</font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Reinicie a emula√ß√£o do Space Invaders clicando no bot√£o Space Invaders </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pressione o bot√£o "Executar 1" para executar o comando. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Executamos o seguinte comando em nosso emulador </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Compare o status do processador com o seu </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Se as condi√ß√µes coincidirem, v√° para 2 </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se as condi√ß√µes n√£o corresponderem, sua emula√ß√£o de instru√ß√£o est√° incorreta. </font><font style="vertical-align: inherit;">Corrija-o e inicie novamente a partir da etapa 1.</font></font></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eu usei esse m√©todo no come√ßo para depurar meu emulador 8080. N√£o vou mentir - o processo pode ser longo. Como resultado, muitos dos meus problemas acabaram sendo erros de digita√ß√£o e de copiar e colar, que ap√≥s a detec√ß√£o foram muito f√°ceis de corrigir. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se voc√™ executar passo a passo seu c√≥digo, a maioria das 30 mil instru√ß√µes ser√° executada em um ciclo de cerca de US $ 1a5f. Se voc√™ observar o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">javascript</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> no </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">emulador</font></a><font style="vertical-align: inherit;"> , poder√° ver que esse c√≥digo copia dados para a tela. Estou certo de que esse c√≥digo √© chamado com frequ√™ncia. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ap√≥s a primeira renderiza√ß√£o da tela, ap√≥s 50 mil comandos, o programa fica preso nesse loop infinito:</font></font><br><br><pre> <code class="hljs pgsql"> <span class="hljs-number"><span class="hljs-number">0</span></span>ada LDA <span class="hljs-meta"><span class="hljs-meta">$20</span></span>c0 <span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-keyword"><span class="hljs-keyword">add</span></span> ANA A <span class="hljs-number"><span class="hljs-number">0</span></span>ade JNZ <span class="hljs-meta"><span class="hljs-meta">$0</span></span>ada</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Espera at√© que o valor na mem√≥ria em $ 20c0 mude para zero. </font><font style="vertical-align: inherit;">Como o c√≥digo nesse loop n√£o altera exatamente $ 20c0, ele deve ser um sinal de outro lugar. </font><font style="vertical-align: inherit;">√â hora de falar sobre como emular o "ferro" de uma m√°quina de arcade. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Antes de avan√ßarmos para a pr√≥xima se√ß√£o, verifique se o emulador de CPU cai nesse loop infinito. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para refer√™ncia, veja </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">minhas fontes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Emula√ß√£o 8080 completa </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uma li√ß√£o que me custou muito: n√£o implemente equipes que voc√™ n√£o pode testar. </font><font style="vertical-align: inherit;">Essa √© uma boa regra geral para qualquer software em desenvolvimento. </font><font style="vertical-align: inherit;">Se voc√™ n√£o checar a equipe, ela ser√° quebrada. </font><font style="vertical-align: inherit;">E quanto mais voc√™ se afasta de sua implementa√ß√£o, mais dif√≠cil ser√° encontrar problemas. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Existe outra solu√ß√£o se voc√™ deseja criar um emulador 8080 completo e garantir que ele funcione. </font><font style="vertical-align: inherit;">Descobri um </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c√≥digo para o 8080</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> chamado cpudiag.asm, projetado para testar cada comando do processador 8080. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apresento esse processo depois do primeiro por v√°rios motivos:</font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eu queria que a descri√ß√£o desse processo fosse repetida para outro processador. </font><font style="vertical-align: inherit;">Eu n√£o acho que o an√°logo do cpudiag.asm exista para todos os processadores.</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como voc√™ pode ver, o processo √© bastante meticuloso. </font><font style="vertical-align: inherit;">Eu acho que um iniciante na depura√ß√£o de c√≥digo assembler ter√° grandes dificuldades se essas etapas n√£o estiverem listadas.</font></font></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Foi assim que usei esse teste com meu emulador. </font><font style="vertical-align: inherit;">Voc√™ pode us√°-lo ou criar uma maneira melhor de integr√°-lo.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Montagem de teste </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eu tentei algumas coisas, mas como resultado, decidi usar </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">esta p√°gina legal</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Colei o texto cpudiag.asm no painel esquerdo e a compila√ß√£o foi conclu√≠da sem problemas. </font><font style="vertical-align: inherit;">Levei um minuto para descobrir como baixar o resultado, mas clicando no bot√£o "Criar c√≥digo bonito" no canto inferior esquerdo, baixei um arquivo chamado test.bin, que √© o c√≥digo 8080 compilado. Pude verificar isso usando meu desmontador. </font></font><br><br> <a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Baixe cpudiag.asm</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> do espelho no meu site. </font></font><br><br> <a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Baixe cpudiag.bin</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (c√≥digo compilado 8080) do meu site.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Carregando um teste no meu emulador </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em vez de carregar invasores. * Arquivos, eu carrego esse bin√°rio. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pequenas dificuldades surgem aqui. Primeiramente, existe uma linha no c√≥digo do assembler de origem </font></font><code>ORG 00100H</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, ou seja, significa que o arquivo inteiro √© compilado com a suposi√ß√£o de que a primeira linha de c√≥digo est√° no hexadecimal 0x100. Eu nunca tinha escrito c√≥digo no assembler 8080 antes, ent√£o n√£o sabia o que essa linha faz. Levei apenas um minuto para descobrir que todos os endere√ßos das filiais estavam incorretos e era necess√°rio que a mem√≥ria iniciasse em 0x100. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Segundo, desde que meu emulador come√ßa do zero, primeiro devo fazer a transi√ß√£o para o c√≥digo real. Depois de inserir o valor hexadecimal na mem√≥ria no endere√ßo zero </font></font><code>JMP $0100</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, lidei com isso. (Ou voc√™ pode apenas inicializar o PC com um valor de 0x100.)</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em terceiro lugar, encontrei um bug no c√≥digo compilado. </font><font style="vertical-align: inherit;">Acho que o motivo √© o processamento incorreto da √∫ltima linha de c√≥digo </font></font><code>STACK EQU TEMPP+256</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, mas n√£o tenho certeza. </font><font style="vertical-align: inherit;">Seja como for, a pilha durante a compila√ß√£o foi localizada em US $ 6ad, e os primeiros PUSH come√ßaram a reescrever o c√≥digo. </font><font style="vertical-align: inherit;">Sugeri que a vari√°vel tamb√©m fosse deslocada em 0x100, como o restante do c√≥digo, ent√£o a corrigi inserindo "0x7" na linha de c√≥digo que inicializa o ponteiro da pilha. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por fim, como n√£o implementei o DAA ou a migra√ß√£o auxiliar no meu emulador, modifiquei o c√≥digo para ignorar essa verifica√ß√£o (apenas a ignoramos usando o JMP).</font></font><br><br><pre> <code class="cpp hljs"> ReadFileIntoMemoryAt(state, <span class="hljs-string"><span class="hljs-string">"/Users/kpmiller/Desktop/invaders/cpudiag.bin"</span></span>, <span class="hljs-number"><span class="hljs-number">0x100</span></span>); <span class="hljs-comment"><span class="hljs-comment">//  ,   JMP 0x100 state-&gt;memory[0]=0xc3; state-&gt;memory[1]=0; state-&gt;memory[2]=0x01; //Fix the stack pointer from 0x6ad to 0x7ad // this 0x06 byte 112 in the code, which is // byte 112 + 0x100 = 368 in memory state-&gt;memory[368] = 0x7; //  DAA state-&gt;memory[0x59c] = 0xc3; //JMP state-&gt;memory[0x59d] = 0xc2; state-&gt;memory[0x59e] = 0x05;</span></span></code> </pre> <br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> O teste est√° tentando concluir </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Obviamente, este teste depende da ajuda do CP / M OS. Descobri que o CP / M tem um c√≥digo de US $ 0005 que imprime mensagens no console e alterei minha emula√ß√£o de CHAMADA para lidar com esse comportamento. N√£o sei se tudo deu certo, mas funcionou para as duas mensagens que o programa est√° tentando imprimir. Minha emula√ß√£o CALL para executar este teste √© assim:</font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0xcd</span></span>: <span class="hljs-comment"><span class="hljs-comment">//CALL  #ifdef FOR_CPUDIAG if (5 == ((opcode[2] &lt;&lt; 8) | opcode[1])) { if (state-&gt;c == 9) { uint16_t offset = (state-&gt;d&lt;&lt;8) | (state-&gt;e); char *str = &amp;state-&gt;memory[offset+3]; // - while (*str != '$') printf("%c", *str++); printf("\n"); } else if (state-&gt;c == 2) { //    ,   ,    printf ("print char routine called\n"); } } else if (0 == ((opcode[2] &lt;&lt; 8) | opcode[1])) { exit(0); } else #endif { uint16_t ret = state-&gt;pc+2; state-&gt;memory[state-&gt;sp-1] = (ret &gt;&gt; 8) &amp; 0xff; state-&gt;memory[state-&gt;sp-2] = (ret &amp; 0xff); state-&gt;sp = state-&gt;sp - 2; state-&gt;pc = (opcode[2] &lt;&lt; 8) | opcode[1]; } break;</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Com este teste, encontrei v√°rios problemas no meu emulador. N√£o tenho certeza de quais deles estariam envolvidos no jogo, mas, se estivessem, seria muito dif√≠cil encontr√°-los. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fui em frente e implementei todos os opcodes (com exce√ß√£o do DAA e seus amigos). Demorei de 3 a 4 horas para resolver problemas nos meus desafios e implementar novos. Definitivamente, era mais r√°pido que o processo manual que descrevi acima - antes de encontrar esse teste, passei mais de 4 horas no processo manual. Se voc√™ conseguir descobrir essa explica√ß√£o, recomendo usar esse m√©todo em vez de comparar manualmente. No entanto, conhecer o processo manual tamb√©m √© uma grande habilidade e, se voc√™ quiser emular outro processador, retorne a ele.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se voc√™ n√£o pode executar esse processo ou parece muito complicado, definitivamente vale a pena escolher a abordagem descrita acima com dois emuladores diferentes executando dentro do seu programa. </font><font style="vertical-align: inherit;">Quando v√°rios milh√µes de comandos aparecerem no programa e as interrup√ß√µes forem adicionadas, ser√° imposs√≠vel comparar manualmente dois emuladores.</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt418699/">https://habr.com/ru/post/pt418699/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt418687/index.html">Revolu√ß√£o de 3,5 ": detalhes de um pequeno boom de disquetes com vapores</a></li>
<li><a href="../pt418689/index.html">Como criar bibliotecas de componentes no Figma, economizando um or√ßamento, usando o exemplo de um leil√£o online</a></li>
<li><a href="../pt418691/index.html">Rancheiro: Kubernetes em 5 minutos em bare metal</a></li>
<li><a href="../pt418693/index.html">Por que a felicidade √© t√£o dif√≠cil de detectar no c√©rebro</a></li>
<li><a href="../pt418695/index.html">Guerras antipirataria - O imp√©rio contra-ataca</a></li>
<li><a href="../pt418701/index.html">Estudamos analisadores sint√°ticos para o idioma russo</a></li>
<li><a href="../pt418705/index.html">Futex Basics</a></li>
<li><a href="../pt418707/index.html">KDispatcher - Eventbus leve e conveniente para o uso di√°rio</a></li>
<li><a href="../pt418709/index.html">Precisa se for√ßar: drivers e barreiras de interface</a></li>
<li><a href="../pt418711/index.html">Registros gerenciados por token 1.0</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>