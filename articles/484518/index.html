<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üñïüèª üë®‚Äç‚öñÔ∏è üëê Obtenemos el video de la c√°mara a trav√©s de DVRIP usando PHP üë¶üèæ ‚öΩÔ∏è üë©üèΩ‚Äçü§ù‚Äçüë®üèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En un art√≠culo anterior, promet√≠ mostrar un gui√≥n que saca el video de la c√°mara y, aunque ha pasado un cierto tiempo desde entonces, las promesas deb...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Obtenemos el video de la c√°mara a trav√©s de DVRIP usando PHP</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/484518/"> En un <a href="https://habr.com/ru/post/482864/">art√≠culo anterior,</a> promet√≠ mostrar un gui√≥n que saca el video de la c√°mara y, aunque ha pasado un cierto tiempo desde entonces, las promesas deben cumplirse.  Entonces lo estoy haciendo. <br><br>  Dio la casualidad de que con la asincron√≠a en el mundo de los servidores web todo est√° asociado, pero no PHP. <br><br>  Bueno, porque, ya sabes, este modelo moribundo, la memoria pierde, y de hecho no hay nada fuera de la caja en PHP excepto <a href="https://www.php.net/manual/ru/function.stream-select.php">stream_select ()</a> y <a href="https://www.php.net/manual/ru/function.stream-select.php">stream_set_blocking ()</a> . <br><br>  En alg√∫n lugar all√≠, en PECL, hay alg√∫n tipo de <a href="https://pecl.php.net/package/uv">libuv</a> , que, en principio, es solo un contenedor para las funciones originales de la biblioteca original, por lo que usarlo tal como es le brinda algunos desaf√≠os.  De todos modos, ¬øqui√©n en su sano juicio har√° esto? <br><br>  Pero si dejamos de vivir en el mundo de PHP4 y volvemos un poco a las realidades modernas, veremos que las cosas han cambiado un poco en los √∫ltimos a√±os.  Tenemos herramientas tan interesantes como <b>ReactPHP</b> y <b>AmPHP</b> , cuyos componentes cubren bien la funcionalidad de Node.js, y la presencia de generadores nos permite escribir c√≥digo as√≠ncrono en un estilo conveniente, como <i>async / wait</i> , evitando todas estas devoluciones de llamadas sin fin en devoluciones de llamada y cadenas de kil√≥metros <i>. ) .then (). then ()</i> . <br><br>  Entonces, por eso ahora, me parece, pr√°cticamente no hay tareas del mundo de Node.js que PHP no pueda resolver.  Pero si todav√≠a hay algunas, entonces todo depende solo de la presencia de algunas bibliotecas separadas, y no de la falta de oportunidades como tal. <br><blockquote>  Puede sorprender a la gente saber que la biblioteca est√°ndar de PHP ya tiene todo lo que necesitamos para escribir aplicaciones controladas por eventos y sin bloqueo.  Solo alcanzamos los l√≠mites de la funcionalidad nativa de PHP en esta √°rea cuando le pedimos que sondee miles de descriptores de archivos para la actividad de E / S al mismo tiempo.  Sin embargo, incluso en este caso, el error no est√° en PHP sino en la llamada select () del sistema subyacente, que es lineal en su degradaci√≥n del rendimiento a medida que aumenta la carga. <br><br>  <i><a href="https://amphp.org/amp/event-loop/">amphp.org/amp/event-loop</a></i> </blockquote><a name="habracut"></a><br>  Por supuesto, la cuesti√≥n de usar todo esto en la producci√≥n a√∫n no est√° completamente cerrada, pero si no sabe cosas err√≥neas que cualquier otro entorno de tiempo de ejecuci√≥n asincr√≥nico no le perdonar√°, entonces todo estar√° bien. <br><br><h3>  DVRIP </h3><br>  Consideraremos el protocolo, supuestamente inventado por los chinos, que se utiliza para comunicar software con c√°maras de vigilancia. <br><br>  Todo funciona sobre TCP, llamado DVRIP (a veces Sof√≠a), y cuando lo necesit√©, encontr√© solo dos bibliotecas m√°s o menos sanas, una de las cuales describ√≠a que generalmente solo se conectaba a la c√°mara e intercambiaba un par de mensajes, pero ten√≠a Descripci√≥n del encabezado del paquete que me ayud√≥ mucho. <br><br>  El segundo fue encontrado un poco m√°s tarde, en el momento de la exacerbaci√≥n de mi s√≠ndrome no inventado aqu√≠, y funcion√≥ de manera un poco diferente de lo que me gustar√≠a. <br><br>  En general, armado con un sniffer y una descripci√≥n del encabezado del paquete, bosquej√© brevemente un cierto script que est√° girando en alg√∫n lugar de mi servidor en alg√∫n lugar, y se presentar√° en una cierta prueba de concepto en este art√≠culo. <br><br>  El protocolo en s√≠ no es complejo y el paquete se ve as√≠: <br><br><ul><li>  encabezado de 20 bytes, que en PHP se puede designar como <br><br><pre><code class="php hljs">unpack(<span class="hljs-string"><span class="hljs-string">'Chead/Cversion/x2/IsessionId/Isequence/x2/SmsgId/Ilen'</span></span>, $buffer)</code> </pre> </li><li>  el encabezado va seguido de un mensaje largo y puede contener json, complementado por dos bytes \ x0a \ x00, o datos binarios. </li></ul><br>  Solo transmitiremos json, pero recibiremos ambos. <br><br>  La respuesta (si es un paquete con json) generalmente contiene un campo <b>Ret que</b> indica el √©xito de nuestra solicitud.  Las respuestas que contengan un c√≥digo <b>Ret</b> que no sea igual a <b>100</b> o <b>515</b> se considerar√°n deliberadamente err√≥neas. <br><br>  Armados con este conocimiento b√°sico, conectemos a la c√°mara y comprendamos. <br>  Necesitamos dos bibliotecas: <a href="https://github.com/amphp/socket">amphp / socket</a> , que <a href="https://github.com/amphp/socket">extraer√°</a> casi todo lo que necesitamos, y <a href="https://packagist.org/packages/evenement/evenement">evenement / evenement</a> , que est√°n disponibles en packagist y no requieren ninguna extensi√≥n. <br><br>  Trabajar con TCP en Amp se parece a esto: <br><br><pre> <code class="php hljs">Loop::run(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $socket = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> connect(<span class="hljs-string"><span class="hljs-string">"tcp://{$addr}:{$port}"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write(<span class="hljs-string"><span class="hljs-string">'Hello'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ($chunk = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;read()) { <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> $chunk; } $socket-&gt;close(); });</code> </pre> <br>  DVRIP generalmente se ejecuta en el puerto 34567, por lo que en nuestro caso ser√° algo como esto: <br><br><pre> <code class="php hljs">$socket = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> connect(<span class="hljs-string"><span class="hljs-string">'tcp://192.168.0.200:34567'</span></span>);</code> </pre> <br>  Luego, iniciamos sesi√≥n enviando a la c√°mara nuestro hash de nombre de usuario y contrase√±a, que se calcula de la siguiente manera: <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sofiaHash</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(string $password)</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function"> </span></span>{ $md5 = md5($password, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> implode(<span class="hljs-string"><span class="hljs-string">''</span></span>, array_map(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($i)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($md5)</span></span></span><span class="hljs-function"> </span></span>{ $c = (ord($md5[<span class="hljs-number"><span class="hljs-number">2</span></span> * $i]) + ord($md5[<span class="hljs-number"><span class="hljs-number">2</span></span> * $i + <span class="hljs-number"><span class="hljs-number">1</span></span>])) % <span class="hljs-number"><span class="hljs-number">62</span></span>; $c += $c &gt; <span class="hljs-number"><span class="hljs-number">9</span></span> ? ($c &gt; <span class="hljs-number"><span class="hljs-number">35</span></span> ? <span class="hljs-number"><span class="hljs-number">61</span></span> : <span class="hljs-number"><span class="hljs-number">55</span></span>) : <span class="hljs-number"><span class="hljs-number">48</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> chr($c); }, range(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">7</span></span>))); }</code> </pre> <br>  En caso de autorizaci√≥n exitosa, solicitamos un video y, si la c√°mara nos lo puede dar, entonces comenzamos a transmitirlo. <br><br>  Cada tipo de paquete tiene su propio msgId, por lo que podemos entender qu√© solicitud recibimos la respuesta.  En general, no es un trabajo polvoriento. <br><br>  Para mayor comodidad, describamos primero la clase de nuestro paquete: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Packet</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> SUCCESS_CODES = [<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">515</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> MESSAGE_CODES = [ <span class="hljs-string"><span class="hljs-string">'packet.request.login'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.request.keepAlive'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1006</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.request.claim'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1413</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.response.login'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1001</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.response.keepAlive'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1007</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.response.claim'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1414</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.videoControl'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1410</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.binary'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1412</span></span>, ]; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> int $head = <span class="hljs-number"><span class="hljs-number">255</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> int $version = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> int $sessionId; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> int $sequence; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> int $msgId; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> ?string $rawData; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> ?<span class="hljs-keyword"><span class="hljs-keyword">array</span></span> $data; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(int $msgId, ?array $data = null, int $sequence = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">, int $sessionId = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;msgId = $msgId; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;data = $data; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sequence = $sequence; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sessionId = $sessionId; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__toString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;data !== <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;rawData = json_encode(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;data, JSON_THROW_ON_ERROR) . <span class="hljs-string"><span class="hljs-string">"\x0a\x00"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pack(<span class="hljs-string"><span class="hljs-string">'CCx2IIx2SI'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;head, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;version, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sessionId, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sequence, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;msgId, strlen(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;rawData)) . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;rawData; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : ?</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">array</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;data; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRawData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : ?</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;rawData; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getSession</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sessionId; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getSequence</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sequence; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMessageType</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function"> </span></span>{ $types = array_flip(<span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::MESSAGE_CODES); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($types[<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;msgId])) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">'Unknown message type: '</span></span> . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;msgId); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $types[<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;msgId]; } }</code> </pre> <br>  e intente enviar una solicitud de autorizaci√≥n <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write((string) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.request.login'</span></span>], [ <span class="hljs-string"><span class="hljs-string">'EncryptType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'MD5'</span></span>, <span class="hljs-string"><span class="hljs-string">'LoginType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'DVRIP-Web'</span></span>, <span class="hljs-string"><span class="hljs-string">'PassWord'</span></span> =&gt; sofiaHash(<span class="hljs-string"><span class="hljs-string">'admin'</span></span>), <span class="hljs-string"><span class="hljs-string">'UserName'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'admin'</span></span>, ]));</code> </pre> <br>  Si genial  Nos conectamos y enviamos un mensaje, pero ni siquiera sabemos si la c√°mara era correcta y reaccion√≥ al menos de alguna manera.  Necesitamos leer de alguna manera la respuesta (hag√°moslo de forma asincr√≥nica), seleccionar paquetes espec√≠ficos y decodificarlos. <br><br>  Para separar de alguna manera la l√≥gica de procesamiento de los paquetes que vienen en respuesta, decid√≠ usar la biblioteca <b>evenement</b> y esboc√© una clase basada en ella que arrojar√° paquetes ya decodificados <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Reader</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EventEmitter</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> InputStream $socket; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(InputStream $socket)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;socket = $socket; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">start</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : \</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Generator</span></span></span><span class="hljs-function"> </span></span>{ $buffer = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;socket-&gt;isClosed() &amp;&amp; $result = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> Packet::read(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;socket, $buffer)) { [$packet, $chunk] = $result; $buffer = $chunk; $chunk = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;emit(<span class="hljs-string"><span class="hljs-string">'packet'</span></span>, [$packet]); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;emit($packet-&gt;getMessageType(), [$packet]); } $buffer = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } }</code> </pre> <br>  y tambi√©n agregamos un par de m√©todos est√°ticos a nuestra clase Packet, que, de hecho, extraer√° y decodificar√° paquetes del flujo de datos <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(InputStream $socket, string $buffer = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">''</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Promise</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> call(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket, $buffer)</span></span></span><span class="hljs-function"> </span></span>{ $header = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($header === <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; strlen($buffer) &gt; <span class="hljs-number"><span class="hljs-number">20</span></span>) { $header = unpack(<span class="hljs-string"><span class="hljs-string">'Chead/Cversion/x2/IsessionId/Isequence/x2/SmsgId/Ilen'</span></span>, substr($buffer, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>)); $buffer = substr($buffer, <span class="hljs-number"><span class="hljs-number">20</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($header !== <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; strlen($buffer) &gt;= (int) $header[<span class="hljs-string"><span class="hljs-string">'len'</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::fromRaw($header, (int) $header[<span class="hljs-string"><span class="hljs-string">'len'</span></span>] &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> ? substr($buffer, <span class="hljs-number"><span class="hljs-number">0</span></span>, (int) $header[<span class="hljs-string"><span class="hljs-string">'len'</span></span>]) : <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>), substr($buffer, (int) $header[<span class="hljs-string"><span class="hljs-string">'len'</span></span>]) ]; } $buffer .= <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;read(); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!$socket-&gt;isClosed()); }); } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fromRaw</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $header, ?string $rawData)</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">self</span></span></span><span class="hljs-function"> </span></span>{ $packet = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>($header[<span class="hljs-string"><span class="hljs-string">'msgId'</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, $header[<span class="hljs-string"><span class="hljs-string">'sequence'</span></span>], $header[<span class="hljs-string"><span class="hljs-string">'sessionId'</span></span>]); $packet-&gt;rawData = $rawData; $packet-&gt;data = (int) $packet-&gt;msgId === <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.binary'</span></span>] || $rawData === <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> ? <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> : json_decode(substr($rawData, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">-2</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, <span class="hljs-number"><span class="hljs-number">512</span></span>, JSON_THROW_ON_ERROR); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $packet; }</code> </pre><br>  Ahora, mediante el uso de <b>Evenement</b> , podemos describir nuestra l√≥gica en la forma <br><br><pre> <code class="php hljs">$reader-&gt;on($packetType, $handler);</code> </pre> <br>  Y as√≠ obtuve esta cadena, donde agregu√© otro procesamiento Keep Alive y SIGINT / SIGTERM: <br><br><pre> <code class="php hljs">$reader = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Reader($socket = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> connect(<span class="hljs-string"><span class="hljs-string">'tcp://10.0.5.100:49152'</span></span>)); $reader-&gt;on(<span class="hljs-string"><span class="hljs-string">'packet.response.login'</span></span>, asyncCoroutine(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Packet $packet)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($packet-&gt;getData()[<span class="hljs-string"><span class="hljs-string">'Ret'</span></span>]) || !in_array($packet-&gt;getData()[<span class="hljs-string"><span class="hljs-string">'Ret'</span></span>], Packet::SUCCESS_CODES)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">'Wrong login data'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write((string) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.request.claim'</span></span>], [ <span class="hljs-string"><span class="hljs-string">'Name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span>, <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Action'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Claim'</span></span>, <span class="hljs-string"><span class="hljs-string">'Parameter'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Channel'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'CombinMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'NONE'</span></span>, <span class="hljs-string"><span class="hljs-string">'StreamType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Main'</span></span>, <span class="hljs-string"><span class="hljs-string">'TransMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'TCP'</span></span>]], ], <span class="hljs-number"><span class="hljs-number">1</span></span>, $packet-&gt;getSession())); })); $reader-&gt;once(<span class="hljs-string"><span class="hljs-string">'packet.response.login'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Packet $packet)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket)</span></span></span><span class="hljs-function"> </span></span>{ Loop::unreference(Loop::repeat($packet-&gt;getData()[<span class="hljs-string"><span class="hljs-string">'AliveInterval'</span></span>] * <span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($watcherId)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket, $packet)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($socket-&gt;getResource() === <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Loop::cancel($watcherId); } <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write((string) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.request.keepAlive'</span></span>], [ <span class="hljs-string"><span class="hljs-string">'Name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'KeepAlive'</span></span>, <span class="hljs-string"><span class="hljs-string">'SessionID'</span></span> =&gt; $packet-&gt;getData()[<span class="hljs-string"><span class="hljs-string">'SessionID'</span></span>] ], <span class="hljs-number"><span class="hljs-number">0</span></span>, $packet-&gt;getSession())); })); }); $reader-&gt;on(<span class="hljs-string"><span class="hljs-string">'packet.response.claim'</span></span>, asyncCoroutine(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Packet $packet)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write((string) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.videoControl'</span></span>], [ <span class="hljs-string"><span class="hljs-string">'Name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span>, <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Action'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Start'</span></span>, <span class="hljs-string"><span class="hljs-string">'Parameter'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Channel'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'CombinMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'NONE'</span></span>, <span class="hljs-string"><span class="hljs-string">'StreamType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Main'</span></span>, <span class="hljs-string"><span class="hljs-string">'TransMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'TCP'</span></span>]], ], $packet-&gt;getSequence() + <span class="hljs-number"><span class="hljs-number">1</span></span>, $packet-&gt;getSession())); })); $emitter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Emitter(); $reader-&gt;on(<span class="hljs-string"><span class="hljs-string">'packet.binary'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($packet)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($emitter)</span></span></span><span class="hljs-function"> </span></span>{ $emitter-&gt;emit($packet-&gt;getRawData()); }); $reader-&gt;once(<span class="hljs-string"><span class="hljs-string">'packet.binary'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Packet $packet)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket)</span></span></span><span class="hljs-function"> </span></span>{ $signalHandler = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket, $packet)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write((string) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.videoControl'</span></span>], [ <span class="hljs-string"><span class="hljs-string">'Name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span>, <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Action'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Stop'</span></span>, <span class="hljs-string"><span class="hljs-string">'Parameter'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Channel'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'CombinMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'NONE'</span></span>, <span class="hljs-string"><span class="hljs-string">'StreamType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Main'</span></span>, <span class="hljs-string"><span class="hljs-string">'TransMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'TCP'</span></span>]], ], <span class="hljs-number"><span class="hljs-number">0</span></span>, $packet-&gt;getSession())); $socket-&gt;close(); }; Loop::unreference(Loop::onSignal(defined(<span class="hljs-string"><span class="hljs-string">'SIGINT'</span></span>) ? SIGINT : <span class="hljs-number"><span class="hljs-number">2</span></span>, $signalHandler, <span class="hljs-string"><span class="hljs-string">'SIGINT'</span></span>)); Loop::unreference(Loop::onSignal(defined(<span class="hljs-string"><span class="hljs-string">'SIGTERM'</span></span>) ? SIGTERM : <span class="hljs-number"><span class="hljs-number">15</span></span>, $signalHandler, <span class="hljs-string"><span class="hljs-string">'SIGTERM'</span></span>)); }); asyncCall([$reader, <span class="hljs-string"><span class="hljs-string">'start'</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write((string) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.request.login'</span></span>], [ <span class="hljs-string"><span class="hljs-string">'EncryptType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'MD5'</span></span>, <span class="hljs-string"><span class="hljs-string">'LoginType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'DVRIP-Web'</span></span>, <span class="hljs-string"><span class="hljs-string">'PassWord'</span></span> =&gt; sofiaHash(<span class="hljs-string"><span class="hljs-string">'123qwea'</span></span>), <span class="hljs-string"><span class="hljs-string">'UserName'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'admin'</span></span>, ])); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> pipe(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IteratorStream($emitter-&gt;iterate()), getStdout());</code> </pre> <br>  No hace falta decir que en lugar de stdout, podemos redirigir la transmisi√≥n de video donde queramos. <br><br><div class="spoiler">  <b class="spoiler_title">Gui√≥n final</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> ini_set(<span class="hljs-string"><span class="hljs-string">'display_errors'</span></span>, <span class="hljs-string"><span class="hljs-string">'stderr'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">Emitter</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">Loop</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">Promise</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">ByteStream</span></span>\<span class="hljs-title"><span class="hljs-title">InputStream</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">ByteStream</span></span>\<span class="hljs-title"><span class="hljs-title">IteratorStream</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Evenement</span></span>\<span class="hljs-title"><span class="hljs-title">EventEmitter</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">function</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">call</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">function</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">asyncCall</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">function</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">asyncCoroutine</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">function</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">ByteStream</span></span>\<span class="hljs-title"><span class="hljs-title">getStderr</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">function</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">ByteStream</span></span>\<span class="hljs-title"><span class="hljs-title">getStdout</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">function</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">ByteStream</span></span>\<span class="hljs-title"><span class="hljs-title">pipe</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">function</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">Socket</span></span>\<span class="hljs-title"><span class="hljs-title">connect</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'vendor/autoload.php'</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sofiaHash</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(string $password)</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function"> </span></span>{ $md5 = md5($password, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> implode(<span class="hljs-string"><span class="hljs-string">''</span></span>, array_map(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($i)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($md5)</span></span></span><span class="hljs-function"> </span></span>{ $c = (ord($md5[<span class="hljs-number"><span class="hljs-number">2</span></span> * $i]) + ord($md5[<span class="hljs-number"><span class="hljs-number">2</span></span> * $i + <span class="hljs-number"><span class="hljs-number">1</span></span>])) % <span class="hljs-number"><span class="hljs-number">62</span></span>; $c += $c &gt; <span class="hljs-number"><span class="hljs-number">9</span></span> ? ($c &gt; <span class="hljs-number"><span class="hljs-number">35</span></span> ? <span class="hljs-number"><span class="hljs-number">61</span></span> : <span class="hljs-number"><span class="hljs-number">55</span></span>) : <span class="hljs-number"><span class="hljs-number">48</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> chr($c); }, range(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">7</span></span>))); } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Reader</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EventEmitter</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> InputStream $socket; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(InputStream $socket)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;socket = $socket; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">start</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : \</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Generator</span></span></span><span class="hljs-function"> </span></span>{ $buffer = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;socket-&gt;isClosed() &amp;&amp; $result = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> Packet::read(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;socket, $buffer)) { [$packet, $chunk] = $result; $buffer = $chunk; $chunk = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;emit(<span class="hljs-string"><span class="hljs-string">'packet'</span></span>, [$packet]); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;emit($packet-&gt;getMessageType(), [$packet]); } $buffer = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Packet</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> SUCCESS_CODES = [<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">515</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> MESSAGE_CODES = [ <span class="hljs-string"><span class="hljs-string">'packet.request.login'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.request.keepAlive'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1006</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.request.claim'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1413</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.response.login'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1001</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.response.keepAlive'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1007</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.response.claim'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1414</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.videoControl'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1410</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.binary'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1412</span></span>, ]; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(InputStream $socket, string $buffer = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">''</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Promise</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> call(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket, $buffer)</span></span></span><span class="hljs-function"> </span></span>{ $header = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($header === <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; strlen($buffer) &gt; <span class="hljs-number"><span class="hljs-number">20</span></span>) { $header = unpack(<span class="hljs-string"><span class="hljs-string">'Chead/Cversion/x2/IsessionId/Isequence/x2/SmsgId/Ilen'</span></span>, substr($buffer, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>)); $buffer = substr($buffer, <span class="hljs-number"><span class="hljs-number">20</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($header !== <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; strlen($buffer) &gt;= (int) $header[<span class="hljs-string"><span class="hljs-string">'len'</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::fromRaw($header, (int) $header[<span class="hljs-string"><span class="hljs-string">'len'</span></span>] &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> ? substr($buffer, <span class="hljs-number"><span class="hljs-number">0</span></span>, (int) $header[<span class="hljs-string"><span class="hljs-string">'len'</span></span>]) : <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>), substr($buffer, (int) $header[<span class="hljs-string"><span class="hljs-string">'len'</span></span>]) ]; } $buffer .= <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;read(); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!$socket-&gt;isClosed()); }); } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fromRaw</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $header, ?string $rawData)</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">self</span></span></span><span class="hljs-function"> </span></span>{ $packet = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>($header[<span class="hljs-string"><span class="hljs-string">'msgId'</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, $header[<span class="hljs-string"><span class="hljs-string">'sequence'</span></span>], $header[<span class="hljs-string"><span class="hljs-string">'sessionId'</span></span>]); $packet-&gt;rawData = $rawData; $packet-&gt;data = (int) $packet-&gt;msgId === <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.binary'</span></span>] || $rawData === <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> ? <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> : json_decode(substr($rawData, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">-2</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, <span class="hljs-number"><span class="hljs-number">512</span></span>, JSON_THROW_ON_ERROR); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $packet; } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> int $head = <span class="hljs-number"><span class="hljs-number">255</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> int $version = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> int $sessionId; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> int $sequence; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> int $msgId; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> ?string $rawData; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> ?<span class="hljs-keyword"><span class="hljs-keyword">array</span></span> $data; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(int $msgId, ?array $data = null, int $sequence = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">, int $sessionId = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;msgId = $msgId; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;data = $data; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sequence = $sequence; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sessionId = $sessionId; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__toString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;data !== <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;rawData = json_encode(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;data, JSON_THROW_ON_ERROR) . <span class="hljs-string"><span class="hljs-string">"\x0a\x00"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pack(<span class="hljs-string"><span class="hljs-string">'CCx2IIx2SI'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;head, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;version, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sessionId, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sequence, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;msgId, strlen(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;rawData)) . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;rawData; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : ?</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">array</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;data; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRawData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : ?</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;rawData; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getSession</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sessionId; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getSequence</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sequence; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMessageType</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function"> </span></span>{ $types = array_flip(<span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::MESSAGE_CODES); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($types[<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;msgId])) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">'Unknown message type: '</span></span> . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;msgId); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $types[<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;msgId]; } } Loop::run(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : \</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Generator</span></span></span><span class="hljs-function"> </span></span>{ $reader = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Reader($socket = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> connect(<span class="hljs-string"><span class="hljs-string">'tcp://10.0.5.100:49152'</span></span>)); $reader-&gt;on(<span class="hljs-string"><span class="hljs-string">'packet.response.login'</span></span>, asyncCoroutine(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Packet $packet)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($packet-&gt;getData()[<span class="hljs-string"><span class="hljs-string">'Ret'</span></span>]) || !in_array($packet-&gt;getData()[<span class="hljs-string"><span class="hljs-string">'Ret'</span></span>], Packet::SUCCESS_CODES)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">'Wrong login data'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write((string) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.request.claim'</span></span>], [ <span class="hljs-string"><span class="hljs-string">'Name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span>, <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Action'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Claim'</span></span>, <span class="hljs-string"><span class="hljs-string">'Parameter'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Channel'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'CombinMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'NONE'</span></span>, <span class="hljs-string"><span class="hljs-string">'StreamType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Main'</span></span>, <span class="hljs-string"><span class="hljs-string">'TransMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'TCP'</span></span>]], ], <span class="hljs-number"><span class="hljs-number">1</span></span>, $packet-&gt;getSession())); })); $reader-&gt;once(<span class="hljs-string"><span class="hljs-string">'packet.response.login'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Packet $packet)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket)</span></span></span><span class="hljs-function"> </span></span>{ Loop::unreference(Loop::repeat($packet-&gt;getData()[<span class="hljs-string"><span class="hljs-string">'AliveInterval'</span></span>] * <span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($watcherId)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket, $packet)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($socket-&gt;getResource() === <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Loop::cancel($watcherId); } <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write((string) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.request.keepAlive'</span></span>], [ <span class="hljs-string"><span class="hljs-string">'Name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'KeepAlive'</span></span>, <span class="hljs-string"><span class="hljs-string">'SessionID'</span></span> =&gt; $packet-&gt;getData()[<span class="hljs-string"><span class="hljs-string">'SessionID'</span></span>] ], <span class="hljs-number"><span class="hljs-number">0</span></span>, $packet-&gt;getSession())); })); }); $reader-&gt;on(<span class="hljs-string"><span class="hljs-string">'packet.response.claim'</span></span>, asyncCoroutine(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Packet $packet)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write((string) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.videoControl'</span></span>], [ <span class="hljs-string"><span class="hljs-string">'Name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span>, <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Action'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Start'</span></span>, <span class="hljs-string"><span class="hljs-string">'Parameter'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Channel'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'CombinMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'NONE'</span></span>, <span class="hljs-string"><span class="hljs-string">'StreamType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Main'</span></span>, <span class="hljs-string"><span class="hljs-string">'TransMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'TCP'</span></span>]], ], $packet-&gt;getSequence() + <span class="hljs-number"><span class="hljs-number">1</span></span>, $packet-&gt;getSession())); })); $emitter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Emitter(); $reader-&gt;on(<span class="hljs-string"><span class="hljs-string">'packet.binary'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($packet)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($emitter)</span></span></span><span class="hljs-function"> </span></span>{ $emitter-&gt;emit($packet-&gt;getRawData()); }); $reader-&gt;once(<span class="hljs-string"><span class="hljs-string">'packet.binary'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Packet $packet)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket)</span></span></span><span class="hljs-function"> </span></span>{ $signalHandler = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket, $packet)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write((string) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.videoControl'</span></span>], [ <span class="hljs-string"><span class="hljs-string">'Name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span>, <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Action'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Stop'</span></span>, <span class="hljs-string"><span class="hljs-string">'Parameter'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Channel'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'CombinMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'NONE'</span></span>, <span class="hljs-string"><span class="hljs-string">'StreamType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Main'</span></span>, <span class="hljs-string"><span class="hljs-string">'TransMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'TCP'</span></span>]], ], <span class="hljs-number"><span class="hljs-number">0</span></span>, $packet-&gt;getSession())); $socket-&gt;close(); }; Loop::unreference(Loop::onSignal(defined(<span class="hljs-string"><span class="hljs-string">'SIGINT'</span></span>) ? SIGINT : <span class="hljs-number"><span class="hljs-number">2</span></span>, $signalHandler, <span class="hljs-string"><span class="hljs-string">'SIGINT'</span></span>)); Loop::unreference(Loop::onSignal(defined(<span class="hljs-string"><span class="hljs-string">'SIGTERM'</span></span>) ? SIGTERM : <span class="hljs-number"><span class="hljs-number">15</span></span>, $signalHandler, <span class="hljs-string"><span class="hljs-string">'SIGTERM'</span></span>)); }); asyncCall([$reader, <span class="hljs-string"><span class="hljs-string">'start'</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write((string) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.request.login'</span></span>], [ <span class="hljs-string"><span class="hljs-string">'EncryptType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'MD5'</span></span>, <span class="hljs-string"><span class="hljs-string">'LoginType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'DVRIP-Web'</span></span>, <span class="hljs-string"><span class="hljs-string">'PassWord'</span></span> =&gt; sofiaHash(<span class="hljs-string"><span class="hljs-string">'123qwea'</span></span>), <span class="hljs-string"><span class="hljs-string">'UserName'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'admin'</span></span>, ])); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> pipe(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IteratorStream($emitter-&gt;iterate()), getStdout()); });</code> </pre> </div></div><br>  Ahora podemos intentar grabar un video de esta manera <br><br><pre> <code class="bash hljs">$ php recorder.php &gt; output.h264</code> </pre> <br>  Agregamos un controlador SIGINT, as√≠ que cuando te canses, solo presiona Ctrl + C y el script detendr√° la transferencia de video y cerrar√° la conexi√≥n normalmente. <br><br>  Y podemos, por ejemplo, redirigir la transmisi√≥n a ffmpeg y transcodificar sobre la marcha. <br><br><pre> <code class="bash hljs">$ php recorder.php | ffmpeg -nostdin -y -hide_banner -loglevel verbose -f h264 -i pipe:0 -pix_fmt yuv420p -c copy -movflags +frag_keyframe+empty_moov+default_base_moof -reset_timestamps 1 -f mpegts output.mpegts</code> </pre> <br>  Y puedes hacer cadenas fren√©ticas de la forma <br><br><pre> <code class="bash hljs">$ php recorder.php | ffmpeg ... | curl -d @- ...</code> </pre> <br>  iniciando todo esto con alg√∫n tipo de script que se reiniciar√° cada hora, por lo que obtenemos piezas suaves que duran 1 hora, sobre la marcha, donde sea que necesitemos. <br><br><h3>  Por qu√© </h3><br>  Me inclino a creer que este art√≠culo plantear√° la pregunta "¬øPor qu√©?"  Existen soluciones preparadas para el registro desde c√°maras, las c√°maras en general pueden hacer muchas cosas por s√≠ mismas, ya que objetaron correctamente en los comentarios al art√≠culo anterior, y en general podr√≠a hacerse mucho m√°s f√°cil. <br><br>  Es solo que ten√≠a tiempo libre que ten√≠a que hacer en alg√∫n lugar, un deseo de hacer mi propio camino y un deseo infatigable de experimentar. <br><br>  Y funciona <br><br>  Por supuesto, el gui√≥n presentado en el art√≠culo requiere algunas modificaciones, y no debe usarlo de esta forma. Repito, esta es una prueba de concepto.  Y en general, le advierto encarecidamente que use productos caseros hasta la rodilla para garantizar la seguridad de su hogar. <br>  En mi caso, la confiabilidad no es tan cr√≠tica, por lo que esta opci√≥n funcionar√°.  Un observador de guiones est√° girando sobre este gui√≥n, que transfiere la transmisi√≥n a ffmpeg, graba piezas por hora y las carga en el VK, reiniciando el gui√≥n en caso de desconexi√≥n o cualquier circunstancia imprevista. <br><br>  En general, todo esto podr√≠a haberse evitado simplemente sacando el video a trav√©s de RTSP a trav√©s de TCP, como suger√≠ al final del art√≠culo anterior, pero a ffmpeg le gustaba est√∫pidamente detenerse en un momento aleatorio y comenzar a responder solo a SIGKILL. <br><br>  Comenc√© a sospechar que todo esto se deb√≠a a que la corona gui√≥ el reloj de guiones principal y recibi√≥ una prioridad m√°s baja, pero aumentar la prioridad solo redujo la frecuencia del problema. <br><br>  En el caso del script anterior, todo funciona mucho m√°s estable y a√∫n no ha presentado ninguna queja. </div></div><p>Source: <a href="https://habr.com/ru/post/484518/">https://habr.com/ru/post/484518/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../484502/index.html">Facebook obliga a los moderadores a documentar sus horas de trabajo al segundo, incluso yendo al ba√±o</a></li>
<li><a href="../484504/index.html">Hacer un ionizador de aire por menos de $ 10</a></li>
<li><a href="../484506/index.html">Soy fot√≥grafo y me convertir√© en una herramienta de trabajo.</a></li>
<li><a href="../484512/index.html">Las 25 principales ICO m√°s grandes: ¬øqu√© les pasa ahora?</a></li>
<li><a href="../484514/index.html">Enrutamiento universal para aplicaciones de reacci√≥n</a></li>
<li><a href="../484520/index.html">C√≥mo se ve el archivo zip y qu√© podemos hacer con √©l. Parte 3 - Aplicaci√≥n pr√°ctica</a></li>
<li><a href="../484522/index.html">Conferencia DEFCON 27. Hackea la polic√≠a. Parte 2</a></li>
<li><a href="../484526/index.html">Preparaci√≥n de un proyecto SDL2 para ejecutar en Android</a></li>
<li><a href="../484528/index.html">C√≥mo transfir√≠ mi proyecto de hobby a k8s</a></li>
<li><a href="../484530/index.html">M√°quina CNC para procesamiento por plasma / modificaci√≥n de materiales polim√©ricos</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>