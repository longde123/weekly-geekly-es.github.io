<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíî üìè üéß Ir √çndices de mapa de bits: B√∫squeda salvaje ‚õ≤Ô∏è üë©‚Äçüë©‚Äçüë¶ üïé</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduccion 
 Hice este informe en ingl√©s en la conferencia GopherCon Rusia 2019 en Mosc√∫ y en ruso en la reuni√≥n en Nizhny Novgorod. Se trata de un ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Ir √çndices de mapa de bits: B√∫squeda salvaje</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/badoo/blog/451938/"><img src="https://habrastorage.org/webt/hg/g_/eq/hgg_eq6037im5xzqx0ibzmdyoku.jpeg"><br><br><h2>  Introduccion </h2><br>  Hice este informe en ingl√©s en la conferencia GopherCon Rusia 2019 en Mosc√∫ y en ruso en la reuni√≥n en Nizhny Novgorod.  Se trata de un √≠ndice de mapa de bits, menos com√∫n que el √°rbol B, pero no menos interesante.  Comparto la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">grabaci√≥n del</a> discurso en la conferencia en ingl√©s y la transcripci√≥n del texto en ruso. <br><br>  Examinaremos c√≥mo funciona el √≠ndice de mapa de bits, cu√°ndo es mejor, cu√°ndo es peor que otros √≠ndices y en qu√© casos es mucho m√°s r√°pido que ellos;  Veremos qu√© DBMS populares ya tienen √≠ndices de mapa de bits.  intenta escribir el tuyo en Go.  Y para el postre, utilizaremos bibliotecas listas para crear nuestra propia base de datos especializada s√∫per r√°pida. <br><br>  Realmente espero que mi trabajo sea √∫til e interesante para usted.  Vamos! <br><a name="habracut"></a><br><h2>  Introduccion </h2><br><iframe width="560" height="315" src="https://www.youtube.com/embed/WvlUH6MjUuI" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">http://bit.ly/bitmapindexes</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://github.com/mkevac/gopherconrussia2019</a> <br><br>  Hola a todos!  Son las seis de la tarde, todos estamos s√∫per cansados.  Buen momento para hablar sobre la aburrida teor√≠a de los √≠ndices de bases de datos, ¬øverdad?  No se preocupe, tendr√© un par de l√≠neas de c√≥digo fuente aqu√≠ y all√°.  :-) <br><br>  Sin bromas, entonces el informe est√° lleno de informaci√≥n y no tenemos mucho tiempo.  Entonces comencemos. <br><img src="https://habrastorage.org/webt/ui/p9/0n/uip90nv7gann0i9cq_xqctdilh0.png"><br>  Hoy hablar√© sobre lo siguiente: <br><br><ul><li>  ¬øQu√© son los √≠ndices? <br></li><li>  ¬øQu√© es un √≠ndice de mapa de bits? <br></li><li>  d√≥nde se usa y d√≥nde NO se usa y por qu√©; <br></li><li>  implementaci√≥n simple en Go y un poco de lucha con el compilador; <br></li><li>  implementaci√≥n un poco menos simple, pero mucho m√°s productiva en Go-assembler; <br></li><li>  "Problemas" de los √≠ndices de mapa de bits; <br></li><li>  implementaciones existentes. <br></li></ul><br><br><h2>  Entonces, ¬øqu√© son los √≠ndices? </h2><br><img src="https://habrastorage.org/webt/ig/uh/ii/iguhiixwichncqrv6gdszecwgzg.png"><br><br>  Un √≠ndice es una estructura de datos separada que mantenemos y actualizamos adem√°s de los datos principales.  Se utiliza para acelerar la b√∫squeda.  Sin √≠ndices, una b√∫squeda requerir√≠a un pase completo a trav√©s de los datos (un proceso llamado exploraci√≥n completa), y este proceso tiene una complejidad algor√≠tmica lineal.  Pero las bases de datos generalmente contienen una gran cantidad de datos y la complejidad lineal es demasiado lenta.  Idealmente, obtendr√≠amos un logar√≠tmico o constante. <br><br>  Este es un tema enorme y complejo, abrumado por sutilezas y compromisos, pero despu√©s de mirar d√©cadas de desarrollo e investigaci√≥n de varias bases de datos, estoy listo para argumentar que solo hay unos pocos enfoques ampliamente utilizados para crear √≠ndices de bases de datos. <br><br><img src="https://habrastorage.org/webt/aa/yv/wn/aayvwnmn7tbaucc39k3x7ejolsa.png"><br><br>  El primer enfoque es reducir jer√°rquicamente el √°rea de b√∫squeda, dividiendo el √°rea de b√∫squeda en partes m√°s peque√±as. <br><br>  Usualmente hacemos esto usando todo tipo de √°rboles.  Un ejemplo es una caja grande con materiales en su armario, en la que hay cajas m√°s peque√±as con materiales divididos por varios temas.  Si necesita materiales, probablemente los buscar√° en una caja con las palabras "Materiales", y no en la que dice "Cookies", ¬øverdad? <br><br><img src="https://habrastorage.org/webt/zk/oq/_3/zkoq_3s8yr3izbnqvgd9nxmtvyi.png"><br><br>  El segundo enfoque es seleccionar inmediatamente el elemento o grupo de elementos deseado.  Hacemos esto en mapas hash o en √≠ndices inversos.  El uso de mapas hash es muy similar al ejemplo anterior, solo que en lugar de una caja con cajas en su armario, hay muchas cajas peque√±as con elementos finales. <br><br><img src="https://habrastorage.org/webt/kv/zh/0q/kvzh0qp0teoe7h1_ixbeum9jdne.png"><br><br>  El tercer enfoque es deshacerse de la necesidad de una b√∫squeda.  Hacemos esto usando filtros Bloom o filtros de cuco.  Los primeros proporcionan una respuesta al instante, eliminando la necesidad de buscar. <br><br><img src="https://habrastorage.org/webt/ic/b2/4f/icb24fzrjaf4ntui8cymh3orj3c.png"><br><br>  El √∫ltimo enfoque es utilizar plenamente todas las capacidades que nos brinda el hierro moderno.  Esto es exactamente lo que hacemos en los √≠ndices de mapa de bits.  S√≠, cuando los usamos, a veces necesitamos revisar todo el √≠ndice, pero lo hacemos de manera s√∫per eficiente. <br><br>  Como dije, el tema de los √≠ndices de bases de datos es vasto y est√° lleno de compromisos.  Esto significa que a veces podemos usar varios enfoques al mismo tiempo: si necesitamos acelerar la b√∫squeda a√∫n m√°s o si es necesario cubrir todos los tipos posibles de b√∫squeda. <br><br>  Hoy hablar√© sobre el enfoque menos conocido de estos: sobre los √≠ndices de mapas de bits. <br><br><h2>  ¬øQui√©n soy yo para hablar de esto? </h2><br><img src="https://habrastorage.org/webt/dh/i9/-r/dhi9-rzto3wlple4rympbmrdhx4.png"><br><br>  Trabajo como l√≠der de equipo en Badoo (quiz√°s conozca mejor nuestro otro producto, Bumble).  Ya tenemos m√°s de 400 millones de usuarios en todo el mundo y muchas funciones que se dedican a seleccionar el mejor par para ellos.  Hacemos esto usando servicios personalizados que tambi√©n usan √≠ndices de mapas de bits. <br><br><h2>  Entonces, ¬øqu√© es un √≠ndice de mapa de bits? </h2><br><img src="https://habrastorage.org/webt/iz/ty/tu/iztytuxzo4kzx7vyc7vwrwwslze.png"><br>  Los √≠ndices de mapa de bits, como su nombre nos dice, usan mapas de bits o conjuntos de bits para implementar un √≠ndice de b√∫squeda.  Desde una vista de p√°jaro, este √≠ndice consta de uno o m√°s de estos mapas de bits que representan cualquier entidad (como personas) y sus propiedades o par√°metros (edad, color de ojos, etc.), y de un algoritmo que utiliza operaciones de bits (AND, O, NO) para responder a una consulta de b√∫squeda. <br><img src="https://habrastorage.org/webt/24/20/ey/2420eyiyck6eqjz7t6xf9zs-gvq.jpeg"><br>  Se nos dice que los √≠ndices de mapas de bits son los m√°s adecuados y muy productivos para los casos en los que hay una b√∫squeda que combina consultas en muchas columnas que tienen poca cardinalidad (imagine "color de ojos" o "estado civil" frente a algo como "distancia del centro de la ciudad" )  Pero luego mostrar√© que funcionan perfectamente en el caso de columnas con alta cardinalidad. <br><br>  Considere el ejemplo m√°s simple de un √≠ndice de mapa de bits. <br><img src="https://habrastorage.org/webt/yc/rf/1d/ycrf1dwjkvooel8tctktagyxi0a.jpeg"><br>  Imagine que tenemos una lista de restaurantes de Mosc√∫ con propiedades binarias como estas: <br><br><ul><li>  cerca del metro (cerca del metro); <br></li><li>  hay un estacionamiento privado (tiene estacionamiento privado); <br></li><li>  hay una veranda (tiene terraza); <br></li><li>  Puede reservar una mesa (acepta reservas); <br></li><li>  adecuado para vegetarianos (vegana amigable); <br></li><li>  caro (caro) <br></li></ul><br><img src="https://habrastorage.org/webt/sg/oq/db/sgoqdbv90ujmnpkajxcc-8eg0eg.jpeg"><br>  D√©mosle a cada restaurante un n√∫mero de serie que comience en 0 y asigne memoria para 6 mapas de bits (uno para cada caracter√≠stica).  Luego completamos estos mapas de bits, dependiendo de si el restaurante tiene esta propiedad o no.  Si el restaurante 4 tiene una veranda, entonces el bit No. 4 en el mapa de bits ‚Äúhay una veranda‚Äù se establecer√° en 1 (si no hay veranda, entonces en 0). <br><img src="https://habrastorage.org/webt/jl/ap/ge/jlapgeh1fk9cvapi-9gyxtlgnty.jpeg"><br>  Ahora tenemos el √≠ndice de mapa de bits m√°s simple posible, y podemos usarlo para responder consultas como: <br><br><ul><li>  "Mu√©strame restaurantes aptos para vegetarianos"; <br></li><li>  "Mu√©strame restaurantes econ√≥micos con una terraza donde puedas reservar una mesa". <br></li></ul><br><br><img src="https://habrastorage.org/webt/2p/wq/t7/2pwqt76nijteahvflvizdufiumy.jpeg"><br><img src="https://habrastorage.org/webt/_d/fg/wq/_dfgwq--uyewk4k_fryjd533tug.jpeg"><br>  Como?  A ver  La primera solicitud es muy simple.  Todo lo que necesitamos hacer es tomar el mapa de bits "adecuado para vegetarianos" y convertirlo en una lista de restaurantes cuyos bits est√°n en exhibici√≥n. <br><img src="https://habrastorage.org/webt/oe/0-/hd/oe0-hd5hqr6b6unvqtdoadn3jtu.jpeg"><br><img src="https://habrastorage.org/webt/en/3r/co/en3rcomfemoy-arkj9qx3fqmveu.jpeg"><br>  La segunda consulta es un poco m√°s complicada.  Necesitamos usar la operaci√≥n NOT bit en el mapa de bits "caro" para obtener una lista de restaurantes econ√≥micos, luego configurarlo con el mapa de bits "puede reservar una mesa" y establecer el resultado con el mapa de bits "hay una veranda".  El mapa de bits resultante contendr√° una lista de establecimientos que cumplen con todos nuestros criterios.  En este ejemplo, este es solo el restaurante Yunost. <br><img src="https://habrastorage.org/webt/wm/jr/f5/wmjrf5nhch2k9zriz_sfuxzqfec.jpeg"><br><img src="https://habrastorage.org/webt/si/sf/c2/sisfc2h6lro8nu4yctf96absj_u.jpeg"><br>  Hay mucha teor√≠a, pero no se preocupe, veremos el c√≥digo muy pronto. <br><br><h2>  ¬øD√≥nde se usan los √≠ndices de mapa de bits? </h2><br><img src="https://habrastorage.org/webt/zu/sd/up/zusdupegzydvhacdl-wzmwytrbq.jpeg"><br>  Si "googlea" los √≠ndices de mapa de bits, el 90% de las respuestas estar√°n relacionadas de alguna manera con Oracle DB.  Pero el resto del DBMS tambi√©n es compatible con algo tan genial, ¬øverdad?  En realidad no <br><br>  Repasemos la lista de los principales sospechosos. <br><img src="https://habrastorage.org/webt/-k/xy/zn/-kxyznvnwct15_2jzp3rulwotic.jpeg"><br>  MySQL a√∫n no admite √≠ndices de mapa de bits, pero hay una propuesta con una propuesta para agregar esta opci√≥n ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://dev.mysql.com/worklog/task/?id=1524</a> ). <br><br>  PostgreSQL no admite √≠ndices de mapa de bits, pero utiliza mapas de bits simples y operaciones de bits para combinar los resultados de b√∫squeda en varios otros √≠ndices. <br><br>  Tarantool tiene √≠ndices de bitset, admite una simple b√∫squeda en ellos. <br><br>  Redis tiene campos de bits simples <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">(https://redis.io/commands/bitfield</a> ) sin la capacidad de buscar a trav√©s de ellos. <br><br>  MongoDB a√∫n no admite √≠ndices de mapa de bits, pero tambi√©n hay una Propuesta con una propuesta para agregar esta opci√≥n <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://jira.mongodb.org/browse/SERVER-1723</a> <br><br>  Elasticsearch utiliza mapas de bits en su interior <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">(https://www.elastic.co/blog/frame-of-reference-and-roaring-bitmaps</a> ). <br><br><br><img src="https://habrastorage.org/webt/kv/rd/zo/kvrdzoime8mqrf1vtl_iqwgjaea.jpeg"><br><br><ul><li>  Pero apareci√≥ un nuevo vecino en nuestra casa: Pilosa.  Esta es una nueva base de datos no relacional escrita en Go.  Contiene solo √≠ndices de mapa de bits y basa todo en ellos.  Hablaremos de ella un poco m√°s tarde. <br></li></ul><br><br><h2>  Ir a la implementaci√≥n </h2><br>  Pero, ¬øpor qu√© los √≠ndices de mapas de bits se usan tan raramente?  Antes de responder esta pregunta, me gustar√≠a demostrarle la implementaci√≥n de un √≠ndice de mapa de bits muy simple en Go. <br><img src="https://habrastorage.org/webt/db/ua/jt/dbuajtkgolu346p22gzcufwsll4.jpeg"><br>  Los mapas de bits son esencialmente solo piezas de datos.  En Go, usemos rebanadas de bytes para esto. <br><br>  Tenemos un mapa de bits por caracter√≠stica de restaurante, y cada bit en el mapa de bits indica si un restaurante en particular tiene esta propiedad o no. <br><img src="https://habrastorage.org/webt/j2/az/1i/j2az1inrzzj0rcdg9dajst7afhc.jpeg"><br>  Necesitaremos dos funciones auxiliares.  Uno se usar√° para llenar nuestros mapas de bits con datos aleatorios.  Aleatorio, pero con cierta probabilidad de que el restaurante tenga todas las propiedades.  Por ejemplo, creo que hay muy pocos restaurantes en Mosc√∫ donde no se puede reservar una mesa, y me parece que aproximadamente el 20% de los establecimientos son aptos para vegetarianos. <br><br>  La segunda funci√≥n convertir√° el mapa de bits en una lista de restaurantes. <br><img src="https://habrastorage.org/webt/aj/d7/vg/ajd7vgvjt7_2ssgiw7hh2jue9vu.jpeg"><br><img src="https://habrastorage.org/webt/gl/nv/wv/glnvwvokatnkyd08nxslinseoyc.jpeg"><br>  Para responder a la solicitud "Mu√©strame restaurantes econ√≥micos que tengan una veranda y d√≥nde puedes reservar una mesa", necesitamos operaciones de dos bits: NOT y AND. <br><br>  Podemos simplificar un poco nuestro c√≥digo utilizando la operaci√≥n m√°s compleja Y NO. <br><br>  Tenemos funciones para cada una de estas operaciones.  Ambos pasan por los cortes, toman los elementos correspondientes de cada uno, los combinan con una operaci√≥n de bits y colocan el resultado en el corte resultante. <br><img src="https://habrastorage.org/webt/_f/-m/wa/_f-mwakzpgavqkr_a6m3lzzo_gy.jpeg"><br>  Y ahora podemos usar nuestros mapas de bits y funciones para responder a una consulta de b√∫squeda. <br><img src="https://habrastorage.org/webt/rp/tn/uq/rptnuqmitwu5f-ag2w4tquglhca.jpeg"><br>  El rendimiento no es tan alto, incluso a pesar del hecho de que las funciones son muy simples y decentemente ahorramos en el hecho de que no devolvimos un nuevo segmento resultante cada vez que se llam√≥ a la funci√≥n. <br><br>  Habiendo perfilado un poco con pprof, not√© que el compilador Go se perdi√≥ una optimizaci√≥n muy simple pero muy importante: la funci√≥n en l√≠nea. <br><img src="https://habrastorage.org/webt/4s/6j/vs/4s6jvsys1nnmrpxnzpyfed8myq8.jpeg"><br>  El hecho es que el compilador Go tiene mucho miedo a los bucles que atraviesan sectores, y se niega categ√≥ricamente a las funciones en l√≠nea que contienen bucles. <br><img src="https://habrastorage.org/webt/ok/e_/th/oke_thx54xevzrxjqc6fmqx8w5y.jpeg"><br>  Pero no tengo miedo, y puedo enga√±ar al compilador usando goto en lugar de un bucle, como en los viejos tiempos. <br><br><img src="https://habrastorage.org/webt/bx/xo/ea/bxxoeatd8s3mby2jyemkac3jyfg.jpeg"><br><img src="https://habrastorage.org/webt/5k/fm/2l/5kfm2let9qh2ynkerqdkkd1thao.jpeg"><br><br>  Y, como puede ver, ¬°ahora el compilador integra felizmente nuestra funci√≥n!  Como resultado, logramos ahorrar aproximadamente 2 microsegundos.  No esta mal! <br><br><img src="https://habrastorage.org/webt/or/tx/lw/ortxlwhbagw4oafvij-sngkxbsm.jpeg"><br><br>  El segundo cuello de botella es f√°cil de ver si observa cuidadosamente la salida del ensamblador.  El compilador ha agregado la comprobaci√≥n de la divisi√≥n justo dentro de nuestro bucle m√°s popular.  El hecho es que Go es un lenguaje seguro, el compilador teme que mis tres argumentos (tres porciones) tengan diferentes tama√±os.  Despu√©s de todo, habr√° una posibilidad te√≥rica de la aparici√≥n del llamado desbordamiento del b√∫fer. <br><br>  Aseguremos al compilador mostr√°ndole que todas las rebanadas son del mismo tama√±o.  Podemos hacer esto agregando una simple verificaci√≥n al comienzo de nuestra funci√≥n. <br><img src="https://habrastorage.org/webt/rq/v7/en/rqv7enj1mgqnsrgwnlkwscks0ri.jpeg"><br>  Al ver esto, el compilador felizmente omite la prueba, y terminamos ahorrando otros 500 nanosegundos. <br><br><h2>  Grandes lotes </h2><br>  De acuerdo, logramos exprimir un poco el rendimiento de nuestra implementaci√≥n simple, pero este resultado, de hecho, es mucho peor de lo posible con el hardware actual. <br><br>  Todo lo que hacemos es operaciones de bits b√°sicas, y nuestros procesadores las realizan de manera muy eficiente.  Pero, desafortunadamente, "alimentamos" a nuestro procesador con trabajos muy peque√±os.  Nuestras funciones realizan operaciones byte a byte.  Podemos ajustar f√°cilmente nuestro c√≥digo para que funcione con fragmentos de 8 bytes utilizando segmentos UInt64. <br><br><img src="https://habrastorage.org/webt/-w/vl/rd/-wvlrdx24mrcvy_vovvjeouaxjs.jpeg"><br><br>  Como puede ver, este peque√±o cambio ha acelerado nuestro programa ocho veces debido a un aumento en el lote de ocho veces.  Se puede decir que la ganancia es lineal. <br><br><img src="https://habrastorage.org/webt/tf/ej/nk/tfejnkdoftg8gs7vfpgrmbxfejq.jpeg"><br><h2>  Implementaci√≥n de ensamblador </h2><br><img src="https://habrastorage.org/webt/ii/3d/du/ii3ddup__yc_-dhzsuivs6fcpeu.jpeg"><br>  Pero este no es el final.  Nuestros procesadores pueden trabajar con piezas de 16, 32 e incluso 64 bytes.  Estas operaciones "anchas" se denominan datos m√∫ltiples de una sola instrucci√≥n (SIMD; una instrucci√≥n, muchos datos), y el proceso de transformaci√≥n del c√≥digo para que utilice tales operaciones se denomina vectorizaci√≥n. <br><br>  Desafortunadamente, el compilador Go est√° lejos de ser un excelente estudiante en vectorizaci√≥n.  Actualmente, la √∫nica forma de vectorizar c√≥digo en Go es tomar y poner estas operaciones manualmente usando el ensamblador Go. <br><br><img src="https://habrastorage.org/webt/qv/dr/ap/qvdrapgfhvfhrei2ies1w2vtcds.jpeg"><br><br>  Assembler Go es una bestia extra√±a.  Probablemente sepa que el ensamblador es algo que est√° fuertemente relacionado con la arquitectura de la computadora para la que est√° escribiendo, pero este no es el caso con Go.  El ensamblador Go es m√°s como un IRL (lenguaje de representaci√≥n intermedio) o un lenguaje intermedio: es pr√°cticamente independiente de la plataforma.  Rob Pike hizo una excelente <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">presentaci√≥n</a> sobre este tema hace unos a√±os en la GopherCon en Denver. <br><br>  Adem√°s, Go usa el formato inusual del Plan 9, que difiere de los formatos generalmente reconocidos de AT&amp;T e Intel. <br><img src="https://habrastorage.org/webt/kp/8r/px/kp8rpxg_xmp3faph2ysefnjavxk.jpeg"><br>  Es seguro decir que escribir el ensamblador Go manualmente no es la actividad m√°s divertida. <br><br>  Pero, afortunadamente, ya hay dos herramientas de alto nivel que nos ayudan a escribir el ensamblador Go: PeachPy y avo.  Ambas utilidades generan ensambladores Go a partir de c√≥digo de nivel superior escrito en Python y Go, respectivamente. <br><img src="https://habrastorage.org/webt/mf/qz/zb/mfqzzbyuqtrdk06iiiw4ufe5eou.jpeg"><br>  Estas utilidades simplifican cosas como la asignaci√≥n de registros, los ciclos de escritura y, en general, simplifican el proceso de ingresar al mundo de la programaci√≥n de ensambladores en Go. <br><br>  Usaremos avo, por lo que nuestros programas ser√°n programas Go casi normales. <br><img src="https://habrastorage.org/webt/qd/ij/l2/qdijl2s77ub_c1om5budqbudjx4.jpeg"><br>  As√≠ es como se ve el ejemplo m√°s simple de un programa avo.  Tenemos una funci√≥n main () que define la funci√≥n Add () dentro de s√≠ misma, cuyo significado es agregar dos n√∫meros.  Hay funciones auxiliares para obtener par√°metros por nombre y obtener uno de los registros de procesador gratuitos y adecuados.  Cada operaci√≥n del procesador tiene una funci√≥n correspondiente en avo, como se ve en ADDQ.  Finalmente, vemos una funci√≥n auxiliar para almacenar el valor resultante. <br><img src="https://habrastorage.org/webt/8q/ze/6_/8qze6_requgfy9fimtn5tiirtn8.jpeg"><br>  Al llamar a ir a generar, ejecutaremos el programa en avo y al final se generar√°n dos archivos: <br><br><ul><li>  add.s con el c√≥digo resultante del ensamblador Go; <br></li><li>  stub.go con encabezados de funci√≥n para conectar dos mundos: Ir y ensamblador. <br></li></ul><br><img src="https://habrastorage.org/webt/mz/bk/pi/mzbkpixqbe5kygtl9vphoeak39w.jpeg"><br>  Ahora que hemos visto qu√© y c√≥mo lo hace avo, echemos un vistazo a nuestras funciones.  Implement√© versiones escalares y vectoriales (SIMD) de funciones. <br><br>  Primero, mira las versiones escalares. <br><img src="https://habrastorage.org/webt/9v/1a/gj/9v1agjswpb-wnfoyqbb1x0rb6vo.jpeg"><br>  Como en el ejemplo anterior, le pedimos que nos proporcione un registro gratuito y correcto de uso general, no necesitamos calcular las compensaciones y los tama√±os de los argumentos.  Todo lo que Avo hace por nosotros. <br><img src="https://habrastorage.org/webt/rt/yj/ju/rtyjjuzuc4ycx2au4tqohzaxsby.jpeg"><br>  Anteriormente utilizamos etiquetas y goto (o saltos) para mejorar el rendimiento y enga√±ar al compilador Go, pero ahora lo hacemos desde el principio.  El hecho es que los bucles son un concepto de nivel superior.  En ensamblador, solo tenemos etiquetas y saltos. <br><img src="https://habrastorage.org/webt/c4/gk/ww/c4gkwwdt0to9yorwoya2jurfrj8.jpeg"><br>  El c√≥digo restante ya deber√≠a ser familiar y comprensible.  Emulamos el ciclo con etiquetas y saltos, tomamos una peque√±a parte de los datos de nuestros dos segmentos, los combinamos con una operaci√≥n de bits (Y NO en este caso), y luego colocamos el resultado en el segmento resultante.  Eso es todo. <br><img src="https://habrastorage.org/webt/vw/gj/fg/vwgjfg2tkeaxec2n7qkvgneqpve.jpeg"><br>  As√≠ es como se ve el c√≥digo final del ensamblador.  No necesit√°bamos calcular los desplazamientos y los tama√±os (resaltados en verde) o realizar un seguimiento de los registros utilizados (resaltados en rojo). <br><img src="https://habrastorage.org/webt/of/sc/4v/ofsc4vbjkv2imcihypew4_japuo.jpeg"><br>  Si comparamos el rendimiento de la implementaci√≥n en ensamblador con el rendimiento de la mejor implementaci√≥n en Go, veremos que es lo mismo.  Y se espera.  Despu√©s de todo, no hicimos nada especial, solo reproducimos lo que har√≠a el compilador Go. <br><br>  Desafortunadamente, no podemos forzar al compilador a que incorpore nuestras funciones escritas en ensamblador.  El compilador Go no tiene esta caracter√≠stica hoy en d√≠a, aunque la solicitud de agregarla ha existido desde hace bastante tiempo. <br><br>  Es por eso que es imposible obtener beneficios de peque√±as funciones en ensamblador.  Necesitamos escribir funciones grandes, o usar el nuevo paquete matem√°tico / bits, o pasar por alto el lado del ensamblador. <br><br>  Veamos ahora las versiones vectoriales de nuestras funciones. <br><img src="https://habrastorage.org/webt/ac/qe/bs/acqebsweofbwzmvcwt-vro9yx4m.jpeg"><br>  Para este ejemplo, decid√≠ usar AVX2, por lo que utilizaremos operaciones que funcionen con fragmentos de 32 bytes.  La estructura del c√≥digo es muy similar a la opci√≥n escalar: cargando par√°metros, proporci√≥nenos un registro general gratuito, etc. <br><img src="https://habrastorage.org/webt/ef/5g/wa/ef5gwafb0stn7wunw8ryjcjyt_k.jpeg"><br>  Una de las innovaciones es que las operaciones vectoriales m√°s amplias utilizan registros amplios especiales.  En el caso de fragmentos de 32 bytes, estos son registros con el prefijo Y. Es por eso que ve la funci√≥n YMM () en el c√≥digo.  Si tuviera que usar el AVX-512 con fragmentos de 64 bits, el prefijo ser√≠a Z. <br><br>  La segunda innovaci√≥n es que decid√≠ usar una optimizaci√≥n llamada desenrollado de bucle, es decir, hacer ocho operaciones de bucle manualmente antes de saltar al inicio del bucle.  Esta optimizaci√≥n reduce la cantidad de brunches (ramas) en el c√≥digo y est√° limitada por la cantidad de registros libres disponibles. <br><img src="https://habrastorage.org/webt/vj/1c/nd/vj1cndpc9uqyrzgfqrld4vfda5o.jpeg"><br>  Bueno, ¬øqu√© pasa con el rendimiento?  Ella es hermosa  Obtuvimos la aceleraci√≥n unas siete veces en comparaci√≥n con la mejor soluci√≥n en Go.  Impresionante, ¬øeh? <br><img src="https://habrastorage.org/webt/d_/9b/ag/d_9bag_w0set74ryc4j5oqm5slm.jpeg"><br>  Pero incluso esta implementaci√≥n podr√≠a acelerarse potencialmente utilizando AVX-512, captaci√≥n previa o JIT (compilador justo a tiempo) para el planificador de consultas.  Pero este es ciertamente un tema para un informe separado. <br><br><h2>  Problemas de √≠ndice de mapa de bits </h2><br>  Ahora que ya hemos analizado una implementaci√≥n simple del √≠ndice de mapa de bits Go y un lenguaje ensamblador mucho m√°s eficiente, finalmente hablemos de por qu√© los √≠ndices de mapa de bits se usan tan raramente. <br><img src="https://habrastorage.org/webt/qs/yf/as/qsyfasqoxbr_heaolyqpd9ms7hk.jpeg"><br>  En los antiguos art√≠culos cient√≠ficos, se mencionan tres problemas de los √≠ndices de mapas de bits, pero los art√≠culos cient√≠ficos m√°s nuevos y yo sostenemos que ya no son relevantes.  No profundizaremos en cada uno de estos problemas, pero los consideraremos superficialmente. <br><br><h2>  El problema de la gran cardinalidad. </h2><br>  Entonces, se nos dice que los √≠ndices de mapa de bits son adecuados solo para campos con baja cardinalidad, es decir, aquellos que tienen pocos valores (por ejemplo, g√©nero o color de ojos), y la raz√≥n es que la representaci√≥n habitual de tales campos (un bit por valor) en caso de una gran cardinalidad, ocupar√° demasiado espacio y, adem√°s, estos √≠ndices de mapa de bits se llenar√°n d√©bilmente (rara vez). <br><img src="https://habrastorage.org/webt/zf/na/lt/zfnaltbokwrnweeiwtighgvq5cm.jpeg"><br><img src="https://habrastorage.org/webt/sa/p4/mw/sap4mwjq8sslx6_zgdanmn8fcwu.jpeg"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A veces podemos usar otra representaci√≥n, por ejemplo, la representaci√≥n est√°ndar, que usamos para representar n√∫meros. </font><font style="vertical-align: inherit;">Pero fue la llegada de los algoritmos de compresi√≥n lo que lo cambi√≥ todo. </font><font style="vertical-align: inherit;">En las √∫ltimas d√©cadas, los cient√≠ficos e investigadores han creado una gran cantidad de algoritmos de compresi√≥n para mapas de bits. </font><font style="vertical-align: inherit;">Su principal ventaja es que no necesita expandir los mapas de bits para las operaciones de bits: podemos realizar operaciones de bits directamente en mapas de bits comprimidos. </font></font><br><img src="https://habrastorage.org/webt/mv/56/bt/mv56btwi703wsb0nya7ofor5lew.jpeg"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recientemente, han comenzado a aparecer enfoques h√≠bridos, como mapas de bits rugientes. </font><font style="vertical-align: inherit;">Simult√°neamente utilizan tres representaciones diferentes para mapas de bits, en realidad mapas de bits, matrices y las llamadas ejecuciones de bits, y equilibran entre ellos para maximizar el rendimiento y minimizar el consumo de memoria.</font></font><br><br>    roaring     .          ,        Go. <br><img src="https://habrastorage.org/webt/af/xy/wy/afxywyhipsvsfla4tuot6ir0tei.jpeg"><br>   ,        ,   (binning). ,     ,   .  ‚Äî     ,  , ,       .       185,2   185,3 . <br><br> ,          1 . <br><br>      ,        50    250 ,   ,  ,            200 . <br><br> ,         . <br><br><h2>     </h2><br>   bitmap-   ,       . <br><br>          ,          .   ,             .  ,     ,    ‚Äî lock contention,      . <br><img src="https://habrastorage.org/webt/xg/ju/xl/xgjuxll8jn3btfxhniispsepbmw.jpeg"><br>             . <br><br>  ‚Äî    .    bitmap- ,       .               lock contention. <br><br>     ‚Äî    .       ,       ,   ‚Äî    .    -   (,   100   500 )      . ,       ,          . <br><br>      :       . <br><br><h2>    </h2><br><br>   bitmap-   , ,   ,        ,   ¬´ ¬ª. <br><br>  ,  ,    AND, OR  . .      - ¬´       200  300   ¬ª. <br><img src="https://habrastorage.org/webt/fq/qy/en/fqqyeneeggnmx0iccptaz8eygmm.jpeg"><br>                   OR. <br><img src="https://habrastorage.org/webt/jr/du/ey/jrdueypemf_a69m1wikbjpialze.jpeg"><br>        . ,    50 .       50 . <br><br>       ,      .      range-encoded bitmaps. <br><img src="https://habrastorage.org/webt/vq/hx/a5/vqhxa5jyy4w9_e5lurbjhntabie.jpeg"><br>           -  (, 200),      ,  . 200  .     300: 300  .  Y as√≠ sucesivamente. <br><br>   ,        ,      .     ,      300 ,      ,      199 .  Listo <br><img src="https://habrastorage.org/webt/wh/bc/hs/whbchsdcr0qrupa6jhu9fcpufke.jpeg"><br>  ,       bitmap-.   ,   ,      . , S2  Google.            ,   .           ¬´ ¬ª (   ). <br><br><h2>  Soluciones confeccionadas </h2><br>               .   -    - ,   ,    . <br><br>      ,   ,   bitmap-  .   ,   SIMD, . <br><br>  ,    ,   . <br><img src="https://habrastorage.org/webt/em/cg/km/emcgkmutgbpdj_arrdnfoub6lt0.jpeg"><br><h2> Roaring  </h2><br> -,    roaring bitmaps-,     .        ,     ,    bitmap-. <br><img src="https://habrastorage.org/webt/k3/mv/yh/k3mvyhvcdb8sh7g-aejhgqeob6c.jpeg"><br>  ,       Go-   SIMD,  , Go-  ,    C, . <br><br><h2> Pilosa </h2><br>  ,    , ‚Äî  Pilosa,  ,  ,  bitmap-  .    ,       . <br><img src="https://habrastorage.org/webt/uw/gs/56/uwgs563qvexzg27dd5x15zbzlto.jpeg"><br> Pilosa  roaring         ,      ,     : , range-encoded bitmaps,    . . <br><br>       Pilosa       . <br><img src="https://habrastorage.org/webt/8d/jm/kn/8djmknf2jltazwrepy_ia4j7k_4.jpeg"><br>     ,    .      Pilosa,     ,         , ,   . <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Despu√©s de eso, usamos NO en el campo "costoso", luego intersectamos el resultado (o AND) con el campo "terraza" y el campo "reservas". </font><font style="vertical-align: inherit;">Y finalmente, obtenemos el resultado final. </font></font><br><img src="https://habrastorage.org/webt/bg/bu/oi/bgbuoi1v8n8vus4einuldy4u8zu.jpeg"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Realmente espero que en el futuro previsible en DBMS como MySQL y PostgreSQL este nuevo tipo de √≠ndices tambi√©n aparezca: √≠ndices de mapa de bits.</font></font><br><img src="https://habrastorage.org/webt/ez/h4/g1/ezh4g1de2gpbozwi8-yubjvhpp4.jpeg"><br><h2>  Conclusi√≥n </h2><br><img src="https://habrastorage.org/webt/tp/0f/3v/tp0f3vktlhcltdxbu7fatn7qqhq.jpeg"><br>  Si a√∫n no te has quedado dormido, gracias.  Tuve que tocar muchos temas de pasada debido a la cantidad limitada de tiempo, pero espero que el informe haya sido √∫til y, quiz√°s, incluso motivador. <br><br>  Es bueno saber acerca de los √≠ndices de mapas de bits, incluso si no los necesita en este momento.  Deja que sean otra herramienta en tu caj√≥n. <br><br>  Hemos cubierto varios trucos de rendimiento para Go y las cosas con las que el compilador Go no funciona muy bien.  Pero es absolutamente √∫til que todo programador de Go lo sepa. <br><br>  Eso es todo lo que quer√≠a decir.  Gracias </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/451938/">https://habr.com/ru/post/451938/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../451928/index.html">C√≥mo configurar an√°lisis web en p√°ginas AMP</a></li>
<li><a href="../451930/index.html">Automatizaci√≥n de iluminaci√≥n de escaleras</a></li>
<li><a href="../451932/index.html">PHDays 9: Bienvenido a la Secci√≥n de Desarrollo Seguro</a></li>
<li><a href="../451934/index.html">Alexander Lamden: "Cualquier pieza de hierro tiene un car√°cter"</a></li>
<li><a href="../451936/index.html">Buscando vulnerabilidades en el navegador UC</a></li>
<li><a href="../451942/index.html">C√≥mo el zumbido en √Åfrica salva miles de vidas</a></li>
<li><a href="../451944/index.html">2019: A√±o de DEX (intercambios descentralizados)</a></li>
<li><a href="../451948/index.html">La historia de los tres cartuchos.</a></li>
<li><a href="../451950/index.html">Plantas de energ√≠a virtuales. ¬øEs posible gestionar las fuentes de energ√≠a "verde"?</a></li>
<li><a href="../451954/index.html">M√°s telegramas secretos</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>