<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëë üï∑Ô∏è ü§∑üèæ C√≥mo funciona el marco tiOPF para delphi / lazarus. Plantilla de visitante üßõüèø „äôÔ∏è ‚òùüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Del traductor 
 Hay dos razones por las cuales me compromet√≠ a traducir varios materiales en el marco desarrollado hace veinte a√±os para el entorno de...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C√≥mo funciona el marco tiOPF para delphi / lazarus. Plantilla de visitante</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/441266/"><h3>  Del traductor </h3><br>  Hay dos razones por las cuales me compromet√≠ a traducir varios materiales en el marco desarrollado hace veinte a√±os para el entorno de programaci√≥n no muy popular: <br><br>  1. Hace varios a√±os, despu√©s de haber aprendido muchas de las delicias de trabajar con Entity Framework como ORM para la plataforma .Net, busqu√© en vano an√°logos para el entorno de Lazarus y, en general, freepascal. <br>  Sorprendentemente, le faltan buenos ORM.  Todo lo que se descubri√≥ fue un proyecto de c√≥digo abierto llamado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">tiOPF</a> , desarrollado a fines de los 90 para Delphi, que luego se transfiri√≥ a Freepascal.  Sin embargo, este marco es fundamentalmente diferente del aspecto habitual de los ORM grandes y gruesos. <br><br>  No hay formas visuales de dise√±ar objetos (en Entidad - modelo primero) y mapear objetos a campos en tablas de bases de datos relacionales (en Entidad - base de datos primero) en tiOPF.  El desarrollador mismo posiciona este hecho como una de las deficiencias del proyecto, sin embargo, como m√©rito, ofrece una orientaci√≥n completa espec√≠ficamente sobre el modelo de negocio de objetos, solo vale un c√≥digo duro ... <br><a name="habracut"></a><br>  Fue al nivel del hardcoding propuesto que tuve problemas.  En ese momento, no estaba muy versado en esos paradigmas y m√©todos que el desarrollador del marco utiliz√≥ en su totalidad y mencion√© en la documentaci√≥n varias veces por p√°rrafo (patrones de dise√±o del visitante, enlazador, observador, varios niveles de abstracci√≥n para la independencia del DBMS, etc. .).  Mi gran proyecto que trabajaba con la base de datos en ese momento estaba completamente enfocado en los componentes visuales de Lazarus y la forma de trabajar con las bases de datos ofrecidas por el entorno visual, como resultado, toneladas del mismo c√≥digo: tres tablas en la misma base de datos con casi la misma estructura y datos homog√©neos, tres formularios id√©nticos para ver, tres formularios id√©nticos para editar, tres formularios id√©nticos para informes y todo lo dem√°s desde la parte superior del encabezado "C√≥mo no dise√±ar software". <br><br>  Despu√©s de leer suficiente literatura sobre los principios del dise√±o correcto de bases de datos y sistemas de informaci√≥n, incluido el estudio de plantillas, as√≠ como conocer el Entity Framework, decid√≠ hacer una refactorizaci√≥n completa tanto de la base de datos como de mi aplicaci√≥n.  Y si hice frente por completo a la primera tarea, entonces, para la implementaci√≥n de la segunda, hab√≠a dos caminos que iban en diferentes direcciones: ir completamente a estudiar .net, C # y Entity Framework, o encontrar un ORM adecuado para el conocido sistema Lazarus.  Tambi√©n hubo un tercer, primer sendero de bicicleta discreto: escribir ORM para que se ajuste a sus necesidades, pero este no es el punto ahora. <br><br>  El c√≥digo fuente del marco no se comenta mucho, pero los desarrolladores sin embargo prepararon (aparentemente en el per√≠odo inicial de desarrollo) una cierta cantidad de documentaci√≥n.  Todo esto, por supuesto, es de habla inglesa, y la experiencia muestra que, a pesar de la abundancia de c√≥digos, diagramas y frases de programaci√≥n de plantillas, muchos programadores de habla rusa todav√≠a est√°n mal orientados en la documentaci√≥n en ingl√©s.  No siempre y no todos tienen el deseo de entrenar la capacidad de entender el texto t√©cnico en ingl√©s sin la necesidad de que la mente lo traduzca al ruso. <br><br>  Adem√°s, la revisi√≥n reiterada del texto para la traducci√≥n le permite ver lo que me perd√≠ cuando conoc√≠ la documentaci√≥n, no lo entend√≠ completa o incorrectamente.  Es decir, esta es una oportunidad para aprender mejor el marco de estudio. <br><br>  2. En la documentaci√≥n, el autor omite intencionalmente o no algunas piezas de c√≥digo, probablemente obvio en su opini√≥n.  Debido a la limitaci√≥n de su redacci√≥n, la documentaci√≥n utiliza mecanismos y objetos obsoletos como ejemplos, eliminados o que ya no se utilizan en nuevas versiones del marco (¬øpero no dije que contin√∫a desarroll√°ndose?).  Adem√°s, cuando repet√≠ los ejemplos desarrollados por m√≠ mismo, encontr√© algunos errores que deber√≠an corregirse.  Por lo tanto, en algunos lugares me permit√≠ no solo traducir el texto, sino tambi√©n complementarlo o revisarlo para que siga siendo relevante, y los ejemplos estaban funcionando. <br><br>  Quiero comenzar la traducci√≥n de materiales de un art√≠culo de Peter Henrikson sobre la primera "ballena" en la que se basa todo el marco: la plantilla de visitante.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Texto original publicado aqu√≠</a> . <br><br><h2>  Plantilla visitante y tiOPF </h2><br>  El prop√≥sito de este art√≠culo es presentar la plantilla Visitor, cuyo uso es uno de los conceptos principales del marco de trabajo tiOPF (TechInsite Object Persistence Framework).  Consideraremos el problema en detalle, despu√©s de analizar soluciones alternativas antes de usar el Visitante.  En el proceso de desarrollar nuestro propio concepto de visitante, nos enfrentaremos a otro desaf√≠o: la necesidad de recorrer todos los objetos de la colecci√≥n.  Este tema tambi√©n ser√° estudiado. <br><br>  La tarea principal es encontrar una forma generalizada de realizar un conjunto de m√©todos relacionados en algunos objetos de la colecci√≥n.  Los m√©todos realizados pueden variar seg√∫n el estado interno de los objetos.  No podemos ejecutar m√©todos en absoluto, pero podemos ejecutar varios m√©todos en los mismos objetos. <br><br><h3>  El nivel necesario de entrenamiento. </h3><br>  El lector debe estar familiarizado con el objeto pascal y dominar los principios b√°sicos de la programaci√≥n orientada a objetos. <br><br><h3>  Ejemplo de tarea empresarial en este art√≠culo </h3><br>  Como ejemplo, desarrollaremos una libreta de direcciones que le permite crear registros de personas y su informaci√≥n de contacto.  Con el aumento de las posibles formas de comunicaci√≥n entre las personas, la aplicaci√≥n deber√≠a permitirle agregar de manera flexible dichos m√©todos sin un procesamiento de c√≥digo significativo (recuerdo que una vez que termin√© de procesar el c√≥digo para agregar un n√∫mero de tel√©fono, inmediatamente necesit√© procesarlo nuevamente para agregar correo electr√≥nico).  Necesitamos proporcionar dos categor√≠as de direcciones: reales, como domicilio, postal, laboral y electr√≥nica: tel√©fono fijo, fax, m√≥vil, correo electr√≥nico, sitio web. <br><br>  En el nivel de presentaci√≥n, nuestra aplicaci√≥n deber√≠a verse como Explorer / Outlook, es decir, se supone que debe usar componentes est√°ndar como TreeView y ListView.  La aplicaci√≥n deber√≠a funcionar r√°pidamente y no dar la impresi√≥n de un software voluminoso cliente-servidor. <br><br>  Una aplicaci√≥n podr√≠a verse as√≠: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/18a/fa8/773/18afa8773d4df14f7c08b3e4ae5ec204.png"><br><br>  En el men√∫ contextual del √°rbol, puede elegir agregar / eliminar el contacto de una persona o empresa, y hacer clic con el bot√≥n derecho en la lista de datos de contacto para abrir su di√°logo de edici√≥n, eliminar o agregar datos. <br><br>  Los datos se pueden guardar de varias formas, y en el futuro consideraremos c√≥mo usar esta plantilla para implementar esta funci√≥n. <br><br><h3>  Antes de empezar </h3><br>  Comenzaremos con una simple colecci√≥n de objetos: una lista de personas que a su vez tienen dos propiedades: nombre (Nombre) y direcci√≥n (EmailAdrs).  Para empezar, la lista se rellenar√° con datos en el constructor y posteriormente se cargar√° desde un archivo o base de datos.  Por supuesto, este es un ejemplo muy simplificado, pero es suficiente para implementar completamente la plantilla de visitante. <br><br>  Cree una nueva aplicaci√≥n y agregue dos clases de la secci√≥n de interfaz del m√≥dulo principal: TPersonList (heredado de TObjectList y requiere un complemento en el m√≥dulo contnrs) y TPerson (heredado de TObject): <br><br><pre><code class="delphi hljs"><span class="hljs-title"><span class="hljs-title">TPersonList</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(TObjectList)  <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constructor</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Create</span></span></span><span class="hljs-function">;</span></span>  <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;  <span class="hljs-title"><span class="hljs-title">TPerson</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(TObject)  <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>    FEMailAdrs: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>;    FName: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>;  <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>    <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> FName <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> FName;    <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> EMailAdrs: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> FEMailAdrs <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> FEMailAdrs;  <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br>  En el constructor TPersonList, creamos tres objetos TPerson y los agregamos a la lista: <br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constructor</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TPersonList</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Create</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lData: TPerson; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">inherited</span></span>; lData := TPerson.Create; lData.<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span> := <span class="hljs-string"><span class="hljs-string">'Malcolm Groves'</span></span>; lData.EMailAdrs := <span class="hljs-string"><span class="hljs-string">'malcolm@dontspamme.com'</span></span>;  <span class="hljs-comment"><span class="hljs-comment">// (ADUG Vice President) Add(lData); lData := TPerson.Create; lData.Name := 'Don MacRae';  // (ADUG President) lData.EMailAdrs := 'don@dontspamme.com'; Add(lData); lData := TPerson.Create; lData.Name := 'Peter Hinrichsen';  // (Yours truly) lData.EMailAdrs := 'peter_hinrichsen@dontspamme.com'; Add(lData); end;</span></span></code> </pre> <br>  Primero, revisaremos la lista y realizaremos dos operaciones en cada elemento de la lista.  Las operaciones son similares, pero no iguales: una simple llamada ShowMessage para mostrar el contenido de las propiedades Name y EmailAdrs de los objetos TPerson.  Agregue dos botones al formulario y as√≠gneles un nombre similar a este: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/201/819/5ce/2018195cee6acbb2348e3ceb78abeaea.png"><br><br>  En el alcance preferido de su formulario, tambi√©n debe agregar una propiedad (o solo un campo) FPersonList de tipo TPersonList (si el tipo se declara debajo del formulario, cambie el orden o haga una declaraci√≥n de tipo preliminar) y llame al constructor en el controlador de eventos onCreate: <br><br><pre> <code class="delphi hljs">FPersonList := TPersonList.Create;</code> </pre> <br>  Para liberar memoria correctamente en el controlador de eventos onClose del formulario, este objeto debe destruirse: <br><br><pre> <code class="delphi hljs">FPersonList.Free.</code> </pre> <br><h3>  Paso 1. Iteraci√≥n del c√≥digo duro </h3><br>  Para mostrar nombres de objetos TPerson, agregue el siguiente c√≥digo al controlador de eventos onClick del primer bot√≥n: <br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TForm1</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Button1Click</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Sender: TObject)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i: integer; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> FPersonList.Count - <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>   ShowMessage(TPerson(FPersonList.Items[i]).<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br>  Para el segundo bot√≥n, el c√≥digo del controlador ser√° el siguiente: <br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TForm1</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Button2Click</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Sender: TObject)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i: integer; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> FPersonList.Count - <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>   ShowMessage(TPerson(FPersonList.Items[i]).EMailAdrs); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br>  Aqu√≠ est√°n los bancos evidentes de este c√≥digo: <br><br><ul><li>  dos m√©todos que hacen casi lo mismo.  Toda la diferencia est√° solo en el nombre de la propiedad del objeto que muestran; <br></li><li>  la iteraci√≥n ser√° tediosa, especialmente cuando se ve obligado a escribir un bucle similar en cien lugares en el c√≥digo; <br></li><li>  Un duro reparto para TPerson est√° plagado de situaciones excepcionales.  ¬øQu√© sucede si hay una instancia de TAnimal en la lista sin una propiedad de direcci√≥n?  No hay ning√∫n mecanismo para detener el error y defenderse contra √©l en este c√≥digo. <br></li></ul><br>  Vamos a descubrir c√≥mo mejorar el c√≥digo mediante la introducci√≥n de una abstracci√≥n: pasamos el c√≥digo iterador a la clase principal. <br><br><h3>  Paso 2. Resumen del iterador </h3><br>  Entonces, queremos mover la l√≥gica del iterador a la clase base.  El iterador de la lista en s√≠ es muy simple: <br><br><pre> <code class="delphi hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> FList.Count - <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-comment"><span class="hljs-comment">// -    ‚Ä¶</span></span></code> </pre> <br>  Parece que estamos planeando usar una plantilla <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Iterator</a> .  Del libro sobre el libro <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">de patrones de dise√±o Gang-of-Four</a> , se sabe que el iterador puede ser externo e interno.  Cuando se utiliza un iterador externo, el cliente controla expl√≠citamente el recorrido llamando al m√©todo Next (por ejemplo, la enumeraci√≥n de los elementos TCollection se controla mediante los m√©todos First, Next, Last).  Aqu√≠ usaremos el iterador interno, ya que es m√°s f√°cil implementar el recorrido del √°rbol con su ayuda, que es nuestro objetivo.  Agregaremos el m√©todo Iterate a nuestra clase de lista y le pasaremos un m√©todo de devoluci√≥n de llamada, que debe realizarse en cada elemento de la lista.  La devoluci√≥n de llamada en el objeto pascal se declara como un tipo de procedimiento, tendremos, por ejemplo, TDoSomethingToAPerson. <br><br>  Entonces, declaramos un tipo de procedimiento TDoSomethingToAPerson, que toma un par√°metro del tipo TPerson.  El tipo de procedimiento le permite utilizar el m√©todo como par√°metro de otro m√©todo, es decir, implementar la devoluci√≥n de llamada.  De esta forma, crearemos dos m√©todos, uno de los cuales mostrar√° la propiedad Name del objeto y el otro, la propiedad EmailAdrs, y ellos mismos se pasar√°n como un par√°metro al iterador general.  Finalmente, la secci√≥n de declaraci√≥n de tipo deber√≠a verse as√≠: <br><br><pre> <code class="delphi hljs"><span class="hljs-comment"><span class="hljs-comment">{ TPerson }</span></span> <span class="hljs-title"><span class="hljs-title">TPerson</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(TObject) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>   FEMailAdrs: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>;   FName: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> FName <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> FName;   <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> EMailAdrs: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> FEMailAdrs <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> FEMailAdrs; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; TDoSomethingToAPerson = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pData: TPerson)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">of</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">object</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-comment"><span class="hljs-comment">{ TPersonList }</span></span> <span class="hljs-title"><span class="hljs-title">TPersonList</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(TObjectList) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constructor</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Create</span></span></span><span class="hljs-function">;</span></span>   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function">   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DoSomething</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pMethod: TDoSomethingToAPerson)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;   DoSomething: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TPersonList</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DoSomething</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pMethod: TDoSomethingToAPerson)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i: integer; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> Count - <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>   pMethod(TPerson(Items[i])); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br>  Ahora, para realizar las acciones necesarias en los elementos de la lista, debemos hacer dos cosas.  Primero, defina las operaciones necesarias utilizando m√©todos que tengan la firma especificada por TDoSomethingToAPerson y, en segundo lugar, escriba las llamadas DoSomething con los punteros a estos m√©todos pasados ‚Äã‚Äãcomo par√°metro.  En la secci√≥n de descripci√≥n del formulario, agregue dos declaraciones: <br><br><pre> <code class="delphi hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span>   FPersonList: TPersonList;   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DoShowName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pData: TPerson)</span></span></span><span class="hljs-function">;</span></span>   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DoShowEmail</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pData: TPerson)</span></span></span><span class="hljs-function">;</span></span></code> </pre> <br>  En la implementaci√≥n de estos m√©todos, indicamos: <br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TForm1</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DoShowName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pData: TPerson)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> ShowMessage(pData.<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TForm1</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DoShowEmail</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pData: TPerson)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> ShowMessage(pData.EMailAdrs); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br>  El c√≥digo para los manejadores de botones se cambia de la siguiente manera: <br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TForm1</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Button1Click</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Sender: TObject)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> FPersonList.DoSomething(@DoShowName); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TForm1</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Button2Click</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Sender: TObject)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> FPersonList.DoSomething(@DoShowEmail); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br>  Ya mejor.  Ahora tenemos tres niveles de abstracciones en nuestro c√≥digo.  Un iterador general es un m√©todo de una clase que implementa una colecci√≥n de objetos.  La l√≥gica empresarial (hasta ahora solo un mensaje sin fin a trav√©s de ShowMessage) se coloca por separado.  En el nivel de presentaci√≥n (interfaz gr√°fica), la l√≥gica empresarial se llama en una l√≠nea. <br><br>  Es f√°cil imaginar c√≥mo una llamada a ShowMessage puede ser reemplazada por un c√≥digo que guarda nuestros datos de TPerson en una base de datos relacional utilizando la consulta SQL del objeto TQuery.  Por ejemplo, as√≠: <br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TForm1</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SavePerson</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pData: TPerson)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lQuery: TQuery; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> lQuery := TQuery.Create(<span class="hljs-keyword"><span class="hljs-keyword">nil</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>   lQuery.SQL.Text := <span class="hljs-string"><span class="hljs-string">'insert into people values (:Name, :EMailAdrs)'</span></span>;   lQuery.ParamByName(<span class="hljs-string"><span class="hljs-string">'Name'</span></span>).AsString := pData.<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>;   lQuery.ParamByName(<span class="hljs-string"><span class="hljs-string">'EMailAdrs'</span></span>).AsString := pData.EMailAdrs;   lQuery.Datababase := gAppDatabase;   lQuery.ExecSQL; <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span>   lQuery.Free; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br>  Por cierto, esto introduce un nuevo problema de mantener una conexi√≥n a la base de datos.  En nuestra solicitud, la conexi√≥n a la base de datos se realiza a trav√©s de alg√∫n objeto global gAppDatabase.  ¬øPero d√≥nde se ubicar√° y c√≥mo trabajar?  Adem√°s, estamos atormentados en cada paso del iterador para crear objetos TQuery, configurar la conexi√≥n, ejecutar la consulta y no olvidar liberar la memoria.  Ser√≠a mejor incluir este c√≥digo en una clase que encapsule la l√≥gica de crear y ejecutar consultas SQL, as√≠ como configurar y mantener una conexi√≥n a la base de datos. <br><br><h3>  Paso 3. Pasar un objeto en lugar de pasar un puntero a una devoluci√≥n de llamada </h3><br>  Pasar el objeto al m√©todo iterador de la clase base resolver√° el problema del mantenimiento del estado.  Crearemos una clase de visitante TPersonVisitor abstracta con un √∫nico m√©todo Execute y pasaremos el objeto a este m√©todo como par√°metro.  La interfaz de visitante abstracta se presenta a continuaci√≥n: <br><br><pre> <code class="delphi hljs">  <span class="hljs-title"><span class="hljs-title">TPersonVisitor</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(TObject) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pPerson: TPerson)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br>  A continuaci√≥n, agregue el m√©todo Iterate a nuestra clase TPersonList: <br><br><pre> <code class="delphi hljs"><span class="hljs-title"><span class="hljs-title">TPersonList</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(TObjectList) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constructor</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Create</span></span></span><span class="hljs-function">;</span></span>   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Iterate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pVisitor: TPersonVisitor)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br>  La implementaci√≥n de este m√©todo ser√° la siguiente: <br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TPersonList</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Iterate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pVisitor: TPersonVisitor)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i: integer; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> Count - <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>   pVisitor.Execute(TPerson(Items[i])); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br>  Un objeto del visitante implementado de la clase TPersonVisitor se pasa al m√©todo Iterate y, al recorrer en iteraci√≥n los elementos de la lista para cada uno de ellos, se llama al visitante especificado (su m√©todo de ejecuci√≥n) con la instancia de TPerson como par√°metro. <br><br>  Creemos dos implementaciones del visitante: TShowNameVisitor y TShowEmailVistor, que realizar√°n el trabajo requerido.  Aqu√≠ se explica c√≥mo reponer la secci√≥n de interfaces del m√≥dulo: <br><br><pre> <code class="delphi hljs"><span class="hljs-comment"><span class="hljs-comment">{ TShowNameVisitor }</span></span> <span class="hljs-title"><span class="hljs-title">TShowNameVisitor</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(TPersonVisitor) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pPerson: TPerson)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-comment"><span class="hljs-comment">{ TShowEmailVisitor }</span></span> <span class="hljs-title"><span class="hljs-title">TShowEmailVisitor</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(TPersonVisitor) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pPerson: TPerson)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br>  Por simplicidad, la implementaci√≥n de los m√©todos de ejecuci√≥n en ellos seguir√° siendo una sola l√≠nea: ShowMessage (pPerson.Name) y ShowMessage (pPerson.EMailAdrs). <br><br>  Y cambie el c√≥digo para los controladores de clic de bot√≥n: <br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TForm1</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Button1Click</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Sender: TObject)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lVis: TPersonVisitor; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> lVis := TShowNameVisitor.Create; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>   FPersonList.Iterate(lVis); <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span>   lVis.Free; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TForm1</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Button2Click</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Sender: TObject)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lVis: TPersonVisitor; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> lVis := TShowEmailVisitor.Create; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>   FPersonList.Iterate(lVis); <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span>   lVis.Free; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br>  Ahora, habiendo resuelto un problema, creamos otro para nosotros mismos.  La l√≥gica del iterador se encapsula en una clase separada;  Las operaciones realizadas durante la iteraci√≥n est√°n envueltas en objetos, lo que nos permite guardar informaci√≥n sobre el estado, pero el tama√±o del c√≥digo ha crecido de una l√≠nea (FPersonList.DoSomething (@DoShowName); a nueve l√≠neas para cada controlador de bot√≥n. Ahora nos ayudar√°: este es el Administrador de visitantes, que se encargar√° de crear y liberar sus copias. Potencialmente, podemos proporcionar varias operaciones con objetos para realizar durante la iteraci√≥n, para esto, el Administrador de visitantes almacenar√° su lista y la revisar√° en cada paso, usted  . Olnyaya solamente operaciones seleccionadas siguiente demostrar√° claramente los beneficios de este enfoque, vamos a utilizar los visitantes para guardar los datos en una base de datos relacional como un simple datos de operaci√≥n de ahorro se pueden llevar a cabo por tres operadores diferentes SQL: crear, borrar y la actualizaci√≥n. <br><br><h3>  Paso 4. Encapsulaci√≥n adicional del visitante </h3><br>  Antes de continuar, debemos encapsular la l√≥gica del trabajo del Visitante, separ√°ndola de la l√≥gica de negocios de la aplicaci√≥n para que no vuelva a ella.  Nos llevar√° tres pasos hacer esto: crear las clases base TVisited y TVisitor, luego las clases base para el objeto comercial y la colecci√≥n de objetos comerciales, luego ajustar ligeramente nuestras clases espec√≠ficas TPerson y TPersonList (o TPeople) para que se conviertan en herederos de la base creada clases  En t√©rminos generales, la estructura de clases corresponder√° a dicho diagrama: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8bb/f5e/b62/8bbf5eb6201de628050d085c061fe800.png"><br><br>  El objeto TVisitor implementa dos m√©todos: la funci√≥n AcceptVisitor y el procedimiento Execute, en el que se pasa el objeto de tipo TVisited.  El objeto TVisited a su vez implementa el m√©todo Iterate con un par√°metro de tipo TVisitor.  Es decir, TVisited.Iterate debe llamar al m√©todo Execute en el objeto TVisitor transferido, enviando un enlace a su propia instancia como par√°metro, y si la instancia es una colecci√≥n, se llama al m√©todo Execute para cada elemento de la colecci√≥n.  La funci√≥n AcceptVisitor es necesaria ya que estamos desarrollando un sistema generalizado.  Ser√° posible pasar al Visitante, que opera solo con tipos TPerson, una instancia de la clase TDog, por ejemplo, y debe haber un mecanismo para evitar excepciones y errores de acceso debido a la falta de coincidencia de tipos.  La clase TVisited es descendiente de la clase TPersistent, ya que un poco m√°s tarde tendremos que implementar funciones relacionadas con el uso de RTTI. <br><br>  La parte de la interfaz del m√≥dulo ahora ser√° as√≠: <br><br><pre> <code class="delphi hljs">TVisited = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>; <span class="hljs-comment"><span class="hljs-comment">{ TVisitor }</span></span> <span class="hljs-title"><span class="hljs-title">TVisitor</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(TObject) <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span>   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AcceptVisitor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pVisited: TVisited)</span></span></span><span class="hljs-function">:</span></span> boolean; <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pVisited: TVisited)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-comment"><span class="hljs-comment">{ TVisited }</span></span> <span class="hljs-title"><span class="hljs-title">TVisited</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(TPersistent) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Iterate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pVisitor: TVisitor)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br>  Los herederos implementar√°n los m√©todos de la clase abstracta TVisitor, y la implementaci√≥n general del m√©todo Iterate para TVisited se detalla a continuaci√≥n: <br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TVisited</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Iterate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pVisitor: TVisitor)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> pVisitor.Execute(self); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br>  Al mismo tiempo, el m√©todo se declara virtual por la posibilidad de su anulaci√≥n en los herederos. <br><br><h3>  Paso 5. Crear un objeto comercial y una colecci√≥n compartidos </h3><br>  Nuestro marco necesita dos clases base m√°s: para definir un objeto comercial y una colecci√≥n de dichos objetos.  Ll√°malos TtiObject y TtiObjectList.  La interfaz del primero de ellos: <br><br><pre> <code class="delphi hljs"><span class="hljs-title"><span class="hljs-title">TtiObject</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(TVisited) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constructor</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Create</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br>  M√°s adelante en el proceso de desarrollo, complicaremos esta clase, pero para la tarea actual, solo un constructor virtual con la posibilidad de anularlo en los herederos es suficiente. <br><br>  Planeamos generar la clase TtiObjectList de TVisited para usar el comportamiento en m√©todos que ya han sido implementados por el ancestro (tambi√©n hay otras razones para esta herencia que ser√°n discutidas en su lugar).  Adem√°s, nada proh√≠be el uso de <abbr title="El autor no ha implementado la parte con interfaces en el manual, porque El art√≠culo fue escrito en los a√±os 90 y el mod para su uso en freepascal a√∫n no ha llegado.">interfaces</abbr> (interfaces) en lugar de clases abstractas. <br><br>  La parte de la interfaz de la clase TtiObjectList ser√° la siguiente: <br><br><pre> <code class="delphi hljs"><span class="hljs-title"><span class="hljs-title">TtiObjectList</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(TtiObject) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>   FList: TObjectList; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constructor</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Create</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span>;   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">destructor</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Destroy</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span>;   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Clear</span></span></span><span class="hljs-function">;</span></span>   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Iterate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pVisitor: TVisitor)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span>;   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Add</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pData: TObject)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br>  Como puede ver, el contenedor en s√≠ con los elementos del objeto se encuentra en la secci√≥n protegida y no estar√° disponible para los clientes de esta clase.  La parte m√°s importante de la clase es la implementaci√≥n del m√©todo Iterate anulado.  Si en la clase base el m√©todo simplemente se llama pVisitor.Execute (self), entonces la implementaci√≥n est√° relacionada con enumerar la lista: <br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TtiObjectList</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Iterate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pVisitor: TVisitor)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i: integer; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">inherited</span></span> Iterate(pVisitor); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> FList.Count - <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>   (FList.Items[i] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> TVisited).Iterate(pVisitor); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br>  La implementaci√≥n de otros m√©todos de clase toma una l√≠nea de c√≥digo sin tener en cuenta las expresiones heredadas colocadas autom√°ticamente: <br><br><pre> <code class="delphi hljs">Create: FList := TObjectList.Create; Destroy: FList.Free; Clear: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> Assigned(FList) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> FList.Clear; Add: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> Assigned(FList) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> FList.Add(pData);</code> </pre> <br>  Esta es una parte importante de todo el sistema.  Tenemos dos clases b√°sicas de l√≥gica de negocios: TtiObject y TtiObjectList.  Ambos tienen un m√©todo Iterate al que se pasa una instancia de la clase TVisited.  El iterador mismo llama al m√©todo Execute de la clase TVisitor y pasa una referencia al objeto mismo.  Esta llamada est√° predefinida en el comportamiento de la clase en el nivel superior de herencia.  Para una clase de contenedor, cada objeto almacenado en la lista tambi√©n tiene su m√©todo Iterate, llamado con un par√°metro de tipo TVisitor, es decir, se garantiza que cada visitante espec√≠fico omitir√° todos los objetos almacenados en la lista, as√≠ como la lista misma como un objeto contenedor. <br><br><h3>  Paso 6. Crear un administrador de visitantes </h3><br>  Entonces, volviendo al problema que nosotros mismos dibujamos en el tercer paso.  Dado que no queremos crear y destruir copias de Visitantes cada vez, el desarrollo del Administrador ser√° la soluci√≥n.  Debe realizar dos tareas principales: administrar la lista de Visitantes (que est√°n registrados como tales en la secci√≥n de inicializaci√≥n de m√≥dulos individuales) y ejecutarlos cuando reciben el comando apropiado del cliente. <br>  Para implementar el administrador, complementaremos nuestro m√≥dulo con tres clases adicionales: TVisClassRef, TVisMapping y TtiVisitorManager. <br><br><pre> <code class="delphi hljs">TVisClassRef = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> TVisitor;</code> </pre> <br>  TVisClassRef es un tipo de referencia e indica el nombre de una clase en particular, un descendiente de TVisitor.  El significado de usar un tipo de referencia es el siguiente: cuando se llama al m√©todo Execute base con una firma <br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pData: TVisited; </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pVisClass: TVisClassRef)</span></span></span><span class="hljs-function">,</span></span></code> </pre> <br>  internamente, este m√©todo puede usar una expresi√≥n como lVisitor: = pVisClass.Create para crear una instancia de un visitante espec√≠fico, sin conocer primero su tipo.  Es decir, cualquier clase: se puede crear din√°micamente un descendiente de TVisitor dentro del mismo m√©todo Execute al pasar el nombre de su clase como par√°metro. <br><br>  La segunda clase, TVisMapping, es una estructura de datos simple con dos propiedades: una referencia al tipo TVisClassRef y una propiedad de cadena Comando.  Se necesita una clase para comparar las operaciones realizadas por su nombre (un comando, por ejemplo, "guardar") y la clase Visitor, que ejecutan estos comandos.  Agregue su c√≥digo al proyecto: <br><br><pre> <code class="delphi hljs"><span class="hljs-title"><span class="hljs-title">TVisMapping</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(TObject) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>   FCommand: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>;   FVisitorClass: TVisClassRef; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> VisitorClass: TVisClassRef <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> FVisitorClass <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> FVisitorClass;   <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> Command: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> FCommand <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> FCommand; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br>  Y la √∫ltima clase es TtiVisitorManager.  Cuando registramos al Visitante usando el Administrador, se crea una instancia de la clase TVisMapping, que se ingresa en la lista del Administrador. <br>  Por lo tanto, en el Administrador, se crea una lista de Visitantes con una coincidencia de comandos de cadena, una vez recibidos, se ejecutar√°n.  La interfaz de clase se agrega al m√≥dulo: <br><br><pre> <code class="delphi hljs"><span class="hljs-title"><span class="hljs-title">TtiVisitorManager</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(TObject) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>   FList: TObjectList; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constructor</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Create</span></span></span><span class="hljs-function">;</span></span>   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">destructor</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Destroy</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span>;   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RegisterVisitor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pCommand: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">; pVisitorClass: TVisClassRef)</span></span></span><span class="hljs-function">;</span></span>   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pCommand: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">; pData: TVisited)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br>  Sus m√©todos clave son RegisterVisitor y Execute.  El primero generalmente se llama en la secci√≥n de inicializaci√≥n del m√≥dulo, que describe la clase Visitor, y se parece a esto: <br><br><pre> <code class="delphi hljs"><span class="hljs-keyword"><span class="hljs-keyword">initialization</span></span>  gTIOPFManager.VisitorManager.RegisterVisitor(<span class="hljs-string"><span class="hljs-string">'show'</span></span>, TShowNameVisitor);  gTIOPFManager.VisitorManager.RegisterVisitor(<span class="hljs-string"><span class="hljs-string">'show'</span></span>, TShowEMailAdrsVisitor);</code> </pre> <br>  El c√≥digo del m√©todo en s√≠ ser√° el siguiente: <br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TtiVisitorManager</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RegisterVisitor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pCommand: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">; pVisitorClass: TVisClassRef)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lData: TVisMapping; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> lData := TVisMapping.Create; lData.Command := pCommand; lData.VisitorClass := pVisitorClass; FList.Add(lData); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br>  No es dif√≠cil notar que este c√≥digo es muy similar a la implementaci√≥n de Pascal de la plantilla <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Factory</a> . <br><br>  Otro m√©todo de ejecuci√≥n importante acepta dos par√°metros: el comando por el cual se identificar√° al visitante o su grupo a identificar, as√≠ como el objeto de datos cuyo m√©todo Iterate se llamar√° con un enlace a la instancia del visitante deseado.  El c√≥digo completo para el m√©todo Execute se proporciona a continuaci√≥n: <br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TtiVisitorManager</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pCommand: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">; pData: TVisited)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i: integer; lVisitor: TVisitor; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> FList.Count - <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> SameText(pCommand, TVisMapping(FList.Items[i]).Command) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span>     lVisitor := TVisMapping(FList.Items[i]).VisitorClass.Create;     <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>       pData.Iterate(lVisitor);     <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span>       lVisitor.Free;     <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;   <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br>  Por lo tanto, para ejecutar dos Visitantes previamente registrados con un equipo, solo necesitamos una l√≠nea de c√≥digo: <br><br><pre> <code class="delphi hljs">gTIOPFManager.VisitorManager.Execute(<span class="hljs-string"><span class="hljs-string">'show'</span></span>, FPeople);</code> </pre> <br>  A continuaci√≥n, complementaremos nuestro proyecto para que pueda llamar a comandos similares: <br><br><pre> <code class="delphi hljs"><span class="hljs-comment"><span class="hljs-comment">//      gTIOPFManager.VisitorManager.Execute('read', FPeople); //      gTIOPFManager.VisitorManager.Execute('save', FPeople).</span></span></code> </pre> <br><h3>  Paso 7. Ajuste de las clases de l√≥gica de negocios </h3><br>  Agregar el antepasado de las clases TtiObject y TtiObjectList para nuestros objetos comerciales TPerson y TPeople nos permitir√° encapsular la l√≥gica del iterador en la clase base y no tocarla m√°s, adem√°s, es posible transferir objetos con datos al Administrador de Visitantes. <br><br>  La nueva declaraci√≥n de clase de contenedor se ver√° as√≠: <br><br><pre> <code class="delphi hljs"><span class="hljs-title"><span class="hljs-title">TPeople</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(TtiObjectList);</code> </pre> <br>  De hecho, la clase TPeople ni siquiera tiene que implementar nada.  Te√≥ricamente, podr√≠amos prescindir de una declaraci√≥n TPeople y almacenar objetos en una instancia de la clase TtiObjectList, pero dado que planeamos escribir Visitantes procesando solo instancias TPeople, necesitamos esta clase.  En la funci√≥n AcceptVisitor, se realizar√°n las siguientes verificaciones: <br><br><pre> <code class="delphi hljs">Result := pVisited <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> TPeople.</code> </pre> <br>  Para la clase TPerson, agregamos el ancestro TtiObject y movemos las dos propiedades existentes al √°mbito publicado, ya que en el futuro tendremos que trabajar a trav√©s de RTTI con estas propiedades.  Es mucho m√°s tarde lo que reducir√° significativamente el c√≥digo involucrado en el mapeo de objetos y registros en una base de datos relacional: <br><br><pre> <code class="delphi hljs"><span class="hljs-title"><span class="hljs-title">TPerson</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(TtiObject) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>   FEMailAdrs: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>;   FName: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">published</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> FName <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> FName;   <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> EMailAdrs: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> FEMailAdrs <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> FEMailAdrs; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br><h3>  Paso 8. Crear una vista de prototipo </h3><br>  <b><i>Observaci√≥n</i></b>  En el art√≠culo original, la GUI se basaba en componentes que el autor de tiOPF hizo para la conveniencia de trabajar con su marco delphi.  Estos eran an√°logos de componentes DB Aware, que eran controles est√°ndar como etiquetas, campos de entrada, casillas de verificaci√≥n, listas, etc., pero estaban asociados con ciertas propiedades de los objetos tiObject de la misma manera que los componentes de visualizaci√≥n de datos estaban asociados con campos en tablas de bases de datos.  Con el tiempo, el autor del marco marc√≥ los paquetes con estos componentes visuales como obsoletos e indeseables de usar.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A cambio, sugiere crear un enlace entre los componentes visuales y las propiedades de la clase utilizando el patr√≥n de dise√±o Mediator. </font><font style="vertical-align: inherit;">Esta plantilla es la segunda m√°s importante en toda la arquitectura del marco. </font><font style="vertical-align: inherit;">La descripci√≥n del autor del intermediario est√° cubierta por un art√≠culo separado, comparable en volumen a este manual, por lo tanto, ofrezco mi versi√≥n simplificada aqu√≠ como GUI. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cambie el nombre del bot√≥n 1 en el formulario del proyecto a "mostrar comando", y el bot√≥n 2 lo deja sin un controlador por ahora, o inmediatamente ll√°melo "guardar comando". </font><font style="vertical-align: inherit;">Lanza un componente memo en el formulario y coloca todos los elementos a tu gusto. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Agregue una clase Visitor que implementar√° el comando show: </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Interface -</font></font><br><br><pre> <code class="delphi hljs"><span class="hljs-title"><span class="hljs-title">TShowVisitor</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(TVisitor) <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span>   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AcceptVisitor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pVisited: TVisited)</span></span></span><span class="hljs-function">:</span></span> boolean; <span class="hljs-keyword"><span class="hljs-keyword">override</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pVisited: TVisited)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Y la implementaci√≥n es - </font></font><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TShowVisitor</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AcceptVisitor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pVisited: TVisited)</span></span></span><span class="hljs-function">:</span></span> boolean; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> Result := (pVisited <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> TPerson); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TShowVisitor</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pVisited: TVisited)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> AcceptVisitor(pVisited) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>; Form1.Memo1.Lines.Add(TPerson(pVisited).<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span> + <span class="hljs-string"><span class="hljs-string">': '</span></span> + TPerson(pVisited).EMailAdrs); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AcceptVisitor verifica que el objeto que se transfiere es una instancia de TPerson, porque el visitante solo debe ejecutar el comando con dichos objetos. Si el tipo coincide, el comando se ejecuta y se agrega una l√≠nea con propiedades de objeto al campo de texto. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Las acciones de apoyo para la salud del c√≥digo ser√°n las siguientes. Agregue dos propiedades a la descripci√≥n del formulario en la secci√≥n privada: FPeople de tipo TPeople y VM de tipo TtiVisitorManager. En el controlador de eventos de creaci√≥n de formularios, necesitamos iniciar estas propiedades, as√≠ como registrar al visitante con el comando "show":</font></font><br><br><pre> <code class="delphi hljs">FPeople := TPeople.Create; FillPeople; VM := TtiVisitorManager.Create; VM.RegisterVisitor(<span class="hljs-string"><span class="hljs-string">'show'</span></span>,TShowVisitor);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FilPeople tambi√©n es un procedimiento auxiliar que llena una lista con tres objetos; su c√≥digo se toma del constructor de la lista anterior. </font><font style="vertical-align: inherit;">No olvides destruir todos los objetos creados. </font><font style="vertical-align: inherit;">En este caso, escribimos FPeople.Free y VM.Free en el controlador de cierre de formulario. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Y ahora, ¬°bams! </font><font style="vertical-align: inherit;">- controlador del primer bot√≥n:</font></font><br><br><pre> <code class="delphi hljs">Memo1.Clear; VM.Execute(<span class="hljs-string"><span class="hljs-string">'show'</span></span>,FPeople);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De acuerdo, mucho m√°s divertido. </font><font style="vertical-align: inherit;">Y no jures por el hash de todas las clases en un m√≥dulo. </font><font style="vertical-align: inherit;">Al final del manual, rastrillaremos estos escombros.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Paso 9. La clase base del visitante que trabaja con archivos de texto </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En esta etapa, crearemos la clase base del Visitante que sabe c√≥mo trabajar con archivos de texto. Hay tres formas de trabajar con archivos en el pascal de objeto: procedimientos antiguos desde el momento del primer pascal (como AssignFile y ReadLn), trabajar a trav√©s de secuencias (TStringStream o TFileStream) y usar el objeto TStringList.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si el primer m√©todo est√° muy desactualizado, entonces el segundo y el tercero son una buena alternativa basada en OOP. </font><font style="vertical-align: inherit;">Al mismo tiempo, trabajar con transmisiones adem√°s brinda beneficios tales como la capacidad de comprimir y cifrar datos, pero la lectura y escritura l√≠nea por l√≠nea en una transmisi√≥n es una especie de redundancia en nuestro ejemplo. </font><font style="vertical-align: inherit;">Para simplificar, elegiremos una TStringList, que tiene dos m√©todos simples: LoadFromFile y SaveToFile. </font><font style="vertical-align: inherit;">Pero recuerde que con archivos grandes, estos m√©todos se ralentizar√°n significativamente, por lo que la transmisi√≥n ser√° la mejor opci√≥n para ellos. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Interfaz de clase base de TVisFile:</font></font><br><br><pre> <code class="delphi hljs"><span class="hljs-title"><span class="hljs-title">TVisFile</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(TVisitor) <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span>   FList: TStringList;   FFileName: TFileName; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constructor</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Create</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span>;   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">destructor</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Destroy</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Y la implementaci√≥n del constructor y destructor: </font></font><br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constructor</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TVisFile</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Create</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">inherited</span></span> Create; FList := TStringList.Create; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> FileExists(FFileName) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span>   FList.LoadFromFile(FFileName); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">destructor</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TVisFile</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Destroy</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> FList.SaveToFile(FFileName); FList.Free; <span class="hljs-keyword"><span class="hljs-keyword">inherited</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El valor de la propiedad FFileName se asignar√° a los constructores de los descendientes de esta clase base (simplemente no use el hardcoding, que arreglaremos aqu√≠, ¬°como el estilo de programaci√≥n principal despu√©s!). </font><font style="vertical-align: inherit;">El diagrama de las clases Visitor que trabajan con archivos es el siguiente: </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/717/969/104/717969104d4b13d73ba1844fe0c2ddf9.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De acuerdo con el diagrama a continuaci√≥n, creamos dos descendientes de la clase base TVisFile: TVisTXTFile y TVisCSVFile. </font><font style="vertical-align: inherit;">Uno trabajar√° con archivos * .csv en los que los campos de datos est√°n separados por un s√≠mbolo (coma), el segundo, con archivos de texto en los que los campos de datos individuales tendr√°n una longitud fija por l√≠nea. </font><font style="vertical-align: inherit;">Para estas clases, solo redefinimos los constructores de la siguiente manera:</font></font><br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constructor</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TVisCSVFile</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Create</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> FFileName := <span class="hljs-string"><span class="hljs-string">'contacts.csv'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">inherited</span></span> Create; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constructor</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TVisTXTFile</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Create</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> FFileName := <span class="hljs-string"><span class="hljs-string">'contacts.txt'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">inherited</span></span> Create; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>.</code> </pre> <br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Paso 10. Agregue el controlador de visitante de archivos de texto </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aqu√≠ agregaremos dos Visitantes espec√≠ficos, uno leer√° un archivo de texto, el segundo lo escribir√°. </font><font style="vertical-align: inherit;">El visitante de lectura debe anular los m√©todos de clase base AcceptVisitor y Execute. </font><font style="vertical-align: inherit;">AcceptVisitor verifica que el objeto de la clase TPeople se pase al visitante:</font></font><br><br><pre> <code class="delphi hljs">Result := pVisited <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> TPeople;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> La implementaci√≥n de ejecuci√≥n es la siguiente: </font></font><br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TVisTXtRead</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pVisited: TVisited)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i: integer; lData: TPerson; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> AcceptVisitor(pVisited) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">Exit</span></span>; <span class="hljs-comment"><span class="hljs-comment">//==&gt; TPeople(pVisited).Clear; for i := 0 to FList.Count - 1 do begin   lData := TPerson.Create;   lData.Name := Trim(Copy(FList.Strings[i], 1, 20));   lData.EMailAdrs := Trim(Copy(FList.Strings[i], 21, 80));   TPeople(pVisited).Add(lData); end; end;</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El visitante primero borra la lista del objeto TPeople que le pas√≥ por el par√°metro, luego lee las l√≠neas de su objeto TStringList, en el que se cargan los contenidos del archivo, crea un objeto TPerson en cada l√≠nea y lo agrega a la lista de contenedores TPeople. </font><font style="vertical-align: inherit;">Para simplificar, las propiedades de nombre y correo electr√≥nico en el archivo de texto est√°n separadas por espacios.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El visitante de registro implementa la operaci√≥n inversa. Su constructor (anulado) borra la TStringList interna (es decir, realiza la operaci√≥n FList.Clear; es obligatoria despu√©s de heredada), AcceptVisitor comprueba que se pasa el objeto de la clase TPerson, lo cual no es un error, sino una diferencia importante con respecto al mismo m√©todo de lectura de Visitor. Parece m√°s f√°cil implementar la grabaci√≥n de la misma manera: escanee todos los objetos del contenedor, agr√©guelos a una StringList y luego gu√°rdelos en un archivo. Todo esto fue as√≠, si realmente estuvi√©ramos hablando de la escritura final de datos en un archivo, sin embargo, planeamos asignar datos a una base de datos relacional, esto deber√≠a recordarse. Y en este caso, debemos ejecutar el c√≥digo SQL solo para aquellos objetos que han sido cambiados (creados, eliminados o editados). Es por eso que antes de que el Visitante realice una operaci√≥n en el objeto,debe verificar la correspondencia de su tipo:</font></font><br><br><pre> <code class="delphi hljs">Result := pVisited <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> Tperson;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> El m√©todo execute simplemente agrega a la StringList interna una cadena formateada con la regla especificada: primero, el contenido de la propiedad del nombre del objeto pasado, rellenado con espacios de hasta 20 caracteres, luego el contenido de la propiedad emaiadrs: </font></font><br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TVisTXTSave</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pVisited: TVisited)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> AcceptVisitor(pVisited) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>; FList.Add(PadRight(TPerson(pVisited).<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>,<span class="hljs-number"><span class="hljs-number">20</span></span>)+PadRight(TPerson(pVisited).EMailAdrs,<span class="hljs-number"><span class="hljs-number">60</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Paso 11. Agregue el controlador de visitante de archivos CSV </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Los visitantes de lectura y escritura son similares en casi todos sus colegas de las clases TXT, excepto por la forma de formatear la l√≠nea final de un archivo: en el est√°ndar CSV, los valores de propiedad est√°n separados por comas. </font><font style="vertical-align: inherit;">Para leer l√≠neas y analizarlas en propiedades, utilizamos la funci√≥n ExtractDelimited del m√≥dulo strutils, y la escritura se realiza simplemente concatenando las l√≠neas:</font></font><br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TVisCSVRead</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pVisited: TVisited)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i: integer; lData: TPerson; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> AcceptVisitor(pVisited) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>; TPeople(pVisited).Clear; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> FList.Count - <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span>   lData := TPerson.Create;   lData.<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span> := ExtractDelimited(<span class="hljs-number"><span class="hljs-number">1</span></span>, FList.Strings[i], [<span class="hljs-string"><span class="hljs-string">','</span></span>]);   lData.EMailAdrs := ExtractDelimited(<span class="hljs-number"><span class="hljs-number">2</span></span>, FList.Strings[i], [<span class="hljs-string"><span class="hljs-string">','</span></span>]);   TPeople(pVisited).Add(lData); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TVisCSVSave</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pVisited: TVisited)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> AcceptVisitor(pVisited) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>; FList.Add(TPerson(pVisited).<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span> + <span class="hljs-string"><span class="hljs-string">','</span></span> + TPerson(pVisited).EMailAdrs); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Todo lo que nos queda es registrar nuevos Visitantes en el Administrador y verificar el funcionamiento de la aplicaci√≥n. </font><font style="vertical-align: inherit;">En el controlador de creaci√≥n de formularios, agregue el siguiente c√≥digo:</font></font><br><br><pre> <code class="delphi hljs">VM.RegisterVisitor(<span class="hljs-string"><span class="hljs-string">'readTXT'</span></span>, TVisTXTRead); VM.RegisterVisitor(<span class="hljs-string"><span class="hljs-string">'saveTXT'</span></span>,TVisTXTSave); VM.RegisterVisitor(<span class="hljs-string"><span class="hljs-string">'readCSV'</span></span>,TVisCSVRead); VM.RegisterVisitor(<span class="hljs-string"><span class="hljs-string">'saveCSV'</span></span>,TVisCSVSave);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Acople los botones necesarios en el formulario y as√≠gneles los controladores apropiados: </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/112/0c2/7c3/1120c27c31300af40162387ac222d33c.png"><br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TForm1</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReadCSVbtnClick</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Sender: TObject)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> VM.Execute(<span class="hljs-string"><span class="hljs-string">'readCSV'</span></span>, FPeople); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TForm1</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReadTXTbtnClick</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Sender: TObject)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> VM.Execute(<span class="hljs-string"><span class="hljs-string">'readTXT'</span></span>, FPeople); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TForm1</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SaveCSVbtnClick</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Sender: TObject)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> VM.Execute(<span class="hljs-string"><span class="hljs-string">'saveCSV'</span></span>, FPeople); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TForm1</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SaveTXTbtnClick</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Sender: TObject)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> VM.Execute(<span class="hljs-string"><span class="hljs-string">'saveTXT'</span></span>, FPeople); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Los formatos de archivo adicionales para guardar datos se implementan simplemente agregando los Visitantes apropiados y registr√°ndolos en el Administrador. </font><font style="vertical-align: inherit;">Y preste atenci√≥n a lo siguiente: intencionalmente nombramos los comandos de manera diferente, es decir, saveTXT y saveCSV. </font><font style="vertical-align: inherit;">Si ambos visitantes coinciden con un comando de guardar, ambos comenzar√°n con el mismo comando, compru√©belo usted mismo.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Paso 12. Limpieza final del c√≥digo </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para la mayor belleza y pureza del c√≥digo, as√≠ como para preparar un proyecto para el desarrollo posterior de la interacci√≥n con el DBMS, distribuiremos nuestras clases en diferentes m√≥dulos de acuerdo con la l√≥gica y su prop√≥sito. </font><font style="vertical-align: inherit;">Al final, deber√≠amos tener la siguiente estructura de m√≥dulos en la carpeta del proyecto, lo que nos permite prescindir de una relaci√≥n circular entre ellos (al ensamblarlo, organizar los m√≥dulos necesarios en las secciones de usos):</font></font><br><br><table><tbody><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Modulo </font></font><br></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Funci√≥n </font></font><br></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Clases </font></font><br></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tivisitor.pas </font></font><br></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Clases base de la plantilla de visitante y administrador </font></font><br></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TVisitor </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TVisited </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TVisMapping </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TtiVisitorManager</font></font><br></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tiobject.pas </font></font><br></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Clases b√°sicas de l√≥gica de negocios </font></font><br></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TtiObject </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TtiObjectList</font></font><br></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> people_BOM.pas </font></font><br></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Clases espec√≠ficas de l√≥gica de negocios </font></font><br></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TPerson </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TPeople</font></font><br></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> people_SRV.pas </font></font><br></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Clases concretas responsables de la interacci√≥n. </font></font><br></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TVisFile </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TVisTXTFile </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TVisCSVFile </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TVisCSVGuardar </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TVisCSVRead </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TVisTXTSave </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TVisTXTRead</font></font><br></td></tr></tbody></table><br><h3>  Conclusi√≥n </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En este art√≠culo, examinamos el problema de iterar sobre una colecci√≥n o lista de objetos que pueden tener diferentes tipos. </font><font style="vertical-align: inherit;">Utilizamos la plantilla Visitor propuesta por GoF para implementar de manera √≥ptima dos formas diferentes de mapear datos de objetos a archivos de diferentes formatos. </font><font style="vertical-align: inherit;">Al mismo tiempo, un equipo puede realizar diferentes m√©todos debido a la creaci√≥n del Administrador de Visitantes. </font><font style="vertical-align: inherit;">Finalmente, los ejemplos simples e ilustrativos discutidos en el art√≠culo nos ayudar√°n a desarrollar un sistema similar para mapear objetos a una base de datos relacional. </font></font><br><br> <i><b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Archivo con c√≥digo fuente de ejemplos - aqu√≠</font></font></a></b></i> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/441266/">https://habr.com/ru/post/441266/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../441254/index.html">Seminario "Por qu√© nos pusimos en contacto con Kubernetes y lo que obtenemos de √©l", 28 de febrero, Mosc√∫</a></li>
<li><a href="../441258/index.html">Seguimiento din√°mico con todas las funciones en Linux utilizando eBPF y bpftrace</a></li>
<li><a href="../441260/index.html">C√≥mo ayudaron los gr√°ficos de redes neuronales</a></li>
<li><a href="../441262/index.html">Las tareas simples y largas eliminan a los candidatos mejor que los cortos y complejos</a></li>
<li><a href="../441264/index.html">Gu√≠a del usuario de Kibana. Visualizaci√≥n. Parte 2</a></li>
<li><a href="../441268/index.html">Ceedling + Eclipse o pruebas unitarias para microcontroladores</a></li>
<li><a href="../441270/index.html">Primer vistazo a la FoundationDB de Apple</a></li>
<li><a href="../441274/index.html">C√≥mo convertirse en un probador: los conocimientos y habilidades necesarios</a></li>
<li><a href="../441278/index.html">C√≥mo crear una hermosa paleta de colores</a></li>
<li><a href="../441280/index.html">Configuraci√≥n de GAL en Zimbra Collaboration Suite</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>