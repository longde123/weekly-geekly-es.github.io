<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçñ ü§üüèΩ üèçÔ∏è Exp√©rience GSoC: Comment deux (trois) √©tudiants ont vraiment am√©lior√© le code CRIU ‚úíÔ∏è üö¥üèΩ ‚õπüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Chaque ann√©e, Google organise l'√©v√©nement Google Summer of Code, o√π les principaux projets OpenSource trouvent de nouveaux d√©veloppeurs talentueux par...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Exp√©rience GSoC: Comment deux (trois) √©tudiants ont vraiment am√©lior√© le code CRIU</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/virtuozzo/blog/473362/">  Chaque ann√©e, Google organise l'√©v√©nement Google Summer of Code, o√π les principaux projets OpenSource trouvent de nouveaux d√©veloppeurs talentueux parmi les √©tudiants.  En 2019, notre projet CRIU a r√©ussi non seulement √† passer le tour de qualification, mais aussi √† attirer plusieurs jeunes d√©veloppeurs √† la fois.  Pourquoi tout cela et comment les travaux sur CRUI se sont d√©roul√©s dans le cadre du GSoC - lire sous le chat. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/109/de4/c31/109de4c31759545abe5fd1cd510484db.png" alt="image"><br><br><a name="habracut"></a><br><br>  Chez Virtuozzo, nous avons un petit projet d√©j√† tr√®s populaire appel√© CRIU.  Il s'agit d'un utilitaire syst√®me assez complexe et d'un ensemble de correctifs du noyau (la plupart d'entre eux, d'ailleurs, ont d√©j√† √©t√© accept√©s dans l'arborescence principale du noyau), avec lesquels vous pouvez faire des choses comme, par exemple, la migration en direct des conteneurs ou mettre √† jour le noyau sans red√©marrer les applications. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5f4/ea0/8ed/5f4ea08edfc77cbbb9aad905a193f0d3.png" alt="image"><br><br>  Nous avons commenc√© ce projet en 2011.  Et malgr√© le fait que l'utilitaire a initialement pos√© beaucoup de questions et que certains consid√©raient sa mise en ≈ìuvre impossible, CRIU s'est progressivement transform√© en un outil mature.  √Ä ce jour, plus d'une centaine et demi de contributeurs de plusieurs dizaines d'entreprises, dont des g√©ants tels que Google et IBM, ont r√©ussi √† y participer.  Malgr√© cela, la recherche de nouveaux membres se poursuit et cette ann√©e, nous avons finalement atteint Google Summer of Code (GSoC). <br><br>  GSoC est un √©v√©nement annuel parrain√© par Google visant √† attirer les √©tudiants vers divers projets open source.  D'une part, des √©quipes de projets ouverts cherchent √† participer √† l'√©v√©nement, et d'autre part, des √©tudiants qui souhaitent contribuer au d√©veloppement de la communaut√© et prouver leur professionnalisme sur des projets r√©els. <br><br>  Pour entrer dans l'√©quipe GSoC, il est n√©cessaire de soumettre une candidature sp√©cifiant la description du projet, plusieurs sujets sur lesquels les √©tudiants peuvent travailler et une liste de soi-disant ¬´mentors¬ª - des participants actifs au projet qui aideront l'√©tudiant dans son travail difficile.  Les √©tudiants doivent s√©lectionner un ou plusieurs projets et envoyer leur curriculum vitae aux mentors. <br><br>  Au milieu de l'ann√©e scolaire, Google examine les candidatures des √©quipes et s√©lectionne les projets qui y participeront, et plus pr√®s des vacances d'√©t√©, les √©quipes choisissent les √©tudiants avec lesquels elles sont pr√™tes √† travailler, apr√®s quoi Google proc√®de au filtrage final et r√©partit les √©tudiants selon les √©quipes.  En √©t√©, le travail commence, qui dure trois mois.  Tous les 30 jours, les √©tudiants soumettent des rapports interm√©diaires et leurs mentors √©valuent les r√©sultats et font des recommandations pour la poursuite (ou la fin) du travail. <br><br><h3>  Optimisation de la m√©moire et impl√©mentation des journaux binaires <br></h3><br>  J'avoue qu'en 2019, ce n'√©tait pas notre premi√®re tentative d'entrer dans le GSoC.  Jusqu'√† pr√©sent, nous n'avons pas pu passer par l'√©tape de s√©lection des projets de Google.  Mais nous n'avons pas abandonn√© (en g√©n√©ral, ce n'est pas difficile de soumettre une candidature), et finalement, tout a fonctionn√© - Google a reconnu le d√©veloppement de notre projet comme important et a publi√© CRUI au GSoC. <br><br>  Nous avions beaucoup de sujets pour les √©tudiants, un plus beau et plus complexe.  Une agr√©able surprise a √©t√© le fait que pour chacun d'eux dans la communaut√©, il y avait des artistes.  Il y avait des gens qui connaissaient les probl√®mes exprim√©s et √©taient pr√™ts √† travailler comme mentor.  Au stade de la candidature des √©tudiants, nous avons re√ßu tout un ¬´concours¬ª - 2 √©tudiants ont postul√© pour chacun des sujets et presque tous avaient de merveilleuses donn√©es d'entr√©e.  La s√©lection finale nous a permis d'obtenir deux √©tudiants qui ont abord√© des sujets d'optimisation du code de pr√©servation de la m√©moire du processus en cours, ainsi que la mise en ≈ìuvre de journaux binaires. <br><br>  √âtant donn√© que CRIU est un syst√®me de migration d'application en direct, il a un tel mode de fonctionnement lorsque la m√©moire que le processus utilise est lue et √©crite dans des fichiers image en parall√®le avec l'ex√©cution du processus lui-m√™me.  Nous appelons cela ¬´l'op√©ration du c≈ìur vivant¬ª du processus, car il continue de fonctionner sans s'arr√™ter.  Avant le cycle GSoC, toute la m√©moire √©tait tir√©e dans des tuyaux √† l'aide de l'appel syst√®me vmsplice, qui a fait du bruit √† un moment donn√©, puis le processus a continu√© √† s'ex√©cuter, et CRIU a lentement vid√© cette m√©moire dans des fichiers (ou dans un canal r√©seau s'il s'agissait d'une migration en direct).  En principe, c'est une approche qui fonctionne, mais le probl√®me √©tait que la m√©moire situ√©e dans les tuyaux est effectivement verrouill√©e (mlock) et que le noyau ne peut pas la d√©charger sur le disque (swap-out) si n√©cessaire. <br><br>  D'un point de vue architectural, nous voulions remplacer les tuyaux pour copier la m√©moire en petites portions en appelant process_vm_readv.  Cette innovation est apparue dans le noyau Linux il n'y a pas si longtemps (au fait, cet appel a un fr√®re jumeau appel√© process_vm_writev).  Mais en m√™me temps, cela vous permet de faciliter et d'acc√©l√©rer consid√©rablement, par exemple, le travail de l'utilitaire strace et des d√©bogueurs, qui peuvent √™tre piqu√©s dans la m√©moire des processus pour r√©soudre d'autres t√¢ches. <br><br>  Le travail sur l'optimisation a √©t√© compliqu√© par le fait que le code pour travailler avec la m√©moire de processus est l'un des principaux de l'utilitaire et doit donc √™tre absolument fiable.  Toute erreur dans l'enregistrement des pages peut conduire le processus √† recevoir un √©tat incoh√©rent de ses objets internes (dont CRIU, bien s√ªr, ne "sait" rien) et apr√®s la r√©cup√©ration, il tombera sans aucun diagnostic clair. <br><br>  La deuxi√®me difficult√© de ce d√©veloppement √©tait que le travail avec la m√©moire est impliqu√© dans presque toutes les fonctionnalit√©s du CRIU.  Ce sont les proc√©dures habituelles de restauration des points de contr√¥le, ce sont ses diff√©rentes versions optimis√©es, par exemple le pr√©-vidage ou la lazy-restore.  Une fois au cours de la semaine de rapport suivante, nous avions m√™me pr√©vu de ¬´renvoyer¬ª l'√©tudiant du projet, mais, heureusement, nous ne l'avons pas fait et nous avons maintenant l'optimisation tant attendue dans notre branche devel. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b31/4a8/e69/b314a8e6945d365f2dbc1b4e73412ad8.png" alt="image"><br><br>  La deuxi√®me t√¢che dans le cadre de GSoC 2019 a √©t√© le d√©veloppement et la mise en ≈ìuvre des journaux dits binaires.  Voici la chose: lorsque CRIU fonctionne, l'utilitaire √©crit des messages sur son travail dans un fichier (ou sur l'√©cran, mais encore mieux dans un fichier).  L'importance de ces messages est √©norme!  Si la proc√©dure de sauvegarde ou de restauration pour une raison quelconque ne se termine pas avec succ√®s, la seule fa√ßon de comprendre la raison est d'analyser chaque √©tape de mani√®re aussi d√©taill√©e que possible, et pour cela, vous avez besoin d'informations sur l'utilitaire.  Id√©alement, les proc√©dures n√©cessitent les journaux et fichiers image les plus d√©taill√©s, le cas √©ch√©ant.  En pratique, ces exigences sont difficiles √† satisfaire. <br><br>  Pour obtenir les journaux les plus d√©taill√©s, CRIU fournit un mode appropri√©, et la grande majorit√© des utilisateurs (et peut-√™tre m√™me tous) l'activent toujours.  Mais la quantit√© d'informations g√©n√©r√©es par criu dans le processus est si √©norme que la journalisation elle-m√™me commence √† affecter sensiblement la vitesse du syst√®me.  Une petite recherche a montr√© que nous passons 90% de notre temps √† nous connecter aux op√©rations de formatage de sortie - c'est-√†-dire aux ¬´m√™mes¬ª% d,% 08s,% .2f et autres modificateurs de la famille de fonctions printf.  La d√©sactivation des journaux r√©duit le temps d'enregistrement et de restauration des processus de 10 √† 30%, selon la taille des processus eux-m√™mes. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/035/8cc/429/0358cc42935b88b0792a1c693e84f7c6.png" alt="image"><br><br>  Afin de d√©sactiver l'utilisation d'une telle quantit√© de ressources syst√®me pour la journalisation, mais pour laisser les journaux aussi informatifs que possible, nous avons d√©cid√© de nous d√©barrasser du formatage et d'enregistrer les donn√©es binaires dans les fichiers journaux.  Apr√®s tout, vous pouvez les formater plus tard, si n√©cessaire.  Le deuxi√®me √©tudiant a fait face √† cette t√¢che, dont les correctifs ont √©galement d√©j√† √©t√© accept√©s dans la branche de d√©veloppement. <br><br><h3>  Et pas seulement au GSoC <br></h3><br>  Soit dit en passant, un autre fait int√©ressant de participer au GSoC est qu'un troisi√®me √©tudiant est venu vers nous qui a exprim√© le d√©sir de r√©soudre le probl√®me de l'anonymisation.  Apr√®s tout, il est souvent impossible d'obtenir des fichiers image car ils contiennent des informations secr√®tes que l'utilisateur ne veut √† juste titre partager avec personne - le contenu de la m√©moire, les fichiers avec lesquels le processus travaille, le contenu des files d'attente dans les connexions r√©seau, etc.  Afin de r√©soudre ce probl√®me, nous avons soumis une fonctionnalit√© appel√©e ¬´anonymisation des images¬ª dans l'application, mais Google ne l'a pas accept√©e. <br><br>  N√©anmoins, le sujet n'a pas perdu de sa pertinence, et l'√©tudiant qui a voulu s'y engager dans le cadre du GSoC a finalement d√©cid√© de travailler sur la question de mani√®re ind√©pendante, en dehors de l'√©v√©nement Google. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/521/6c2/3cd/5216c23cdb38140d3997e8d928e03b86.png" alt="image"><br><br><h3>  Conclusion <br></h3><br>  Ce fut, bien s√ªr, une exp√©rience positive en participant au GSoC.  Notre outil CRIU, que nous aimons et appr√©cions beaucoup, a re√ßu quelques impulsions de d√©veloppement plus puissantes, il est devenu encore plus mature et pratique.  Alors √† qui cela peut √™tre utile, utilisez-le avec plaisir! <br><br>  D'un autre c√¥t√©, nous √©tions convaincus que la question de la participation √† de tels √©v√©nements est une question de pers√©v√©rance et de confiance dans notre projet.  Si vous avez besoin de d√©veloppeurs, ne vous fatiguez pas de soumettre des applications et de formuler de nouveaux sujets int√©ressants.  Vous pouvez trouver des contributeurs compl√®tement inattendus d'un autre pays ou m√™me d'une autre entreprise. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr473362/">https://habr.com/ru/post/fr473362/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr473348/index.html">L'id√©e d'inertie (SGDm), l'id√©e de mise √† l'√©chelle (Adagrad) et de r√©gularisation dans l'apprentissage automatique en utilisant le probl√®me de la classification comme exemple</a></li>
<li><a href="../fr473350/index.html">Cr√©ation d'une API REST avec Node.js et une base de donn√©es Oracle. 3e partie</a></li>
<li><a href="../fr473352/index.html">Collections simultan√©es en 10 minutes</a></li>
<li><a href="../fr473354/index.html">√Ä propos des bizarreries de la habrostatistique</a></li>
<li><a href="../fr473358/index.html">Installer et configurer Nexus Sonatype en utilisant l'infrastructure comme approche de code</a></li>
<li><a href="../fr473364/index.html">Il y a un gobie qui se balance: une liste de contr√¥le pour le commerce √©lectronique pendant la saison des ventes</a></li>
<li><a href="../fr473366/index.html">Qu'y a-t-il dans ma smart tv? Ou qu'est-ce qui peut √™tre entass√© dans le t√©l√©viseur?</a></li>
<li><a href="../fr473368/index.html">MIRO est une plate-forme de robot int√©rieure ouverte. Partie 3 - Composant logiciel: ESP8266</a></li>
<li><a href="../fr473372/index.html">Cr√©ation d'un service de suivi d'appels simple, partie 1</a></li>
<li><a href="../fr473374/index.html">Comment nous avons int√©gr√© YouTube Live avec Zoom</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>