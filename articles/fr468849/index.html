<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ¤™ ğŸš¯ ğŸ‘˜ RÃ©tro-ingÃ©nierie de processeur inconnu dans un seul programme ğŸ––ğŸ¼ ğŸ†’ ğŸ§‘ğŸ¾â€ğŸ¤â€ğŸ§‘ğŸ¼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="TL; DR: nous avons procÃ©dÃ© Ã  une ingÃ©nierie inverse d'un programme Ã©crit pour une architecture de CPU complÃ¨tement inconnue sans aucune documentation ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>RÃ©tro-ingÃ©nierie de processeur inconnu dans un seul programme</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/468849/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/mf/1z/aq/mf1zaqnw0lte41iurmzthf-qjbk.png"></div><br>  TL; DR: nous avons procÃ©dÃ© Ã  une ingÃ©nierie inverse d'un programme Ã©crit pour une architecture de CPU complÃ¨tement inconnue sans aucune documentation sur le CPU (sans Ã©mulateur, sans ISA, sans tout) en seulement dix heures.  Ã€ partir de l'article, vous apprendrez comment nous l'avons fait ... <br><br>  Le week-end dernier, l'Ã©quipe CMU PPP et moi avons participÃ© Ã  l'Ã©quipe Dragon Sector Teaser CTF 2019 pour se dÃ©tendre et s'Ã©loigner de la dure Ã©chÃ©ance du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">CHI 2020</a> .  Dragon Sector est une Ã©quipe polonaise respectÃ©e avec une histoire de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">FFC</a> intÃ©ressants, donc je me demandais ce qu'ils avaient en stock. <br><br>  AprÃ¨s avoir rÃ©solu Â«ummmfpuÂ», une tÃ¢che qui comprenait la rÃ©tro-ingÃ©nierie du bytecode pour le coprocesseur Ã  virgule flottante Micromega uM-FPU, j'ai dÃ©cidÃ© de participer Ã  un concours pour rÃ©soudre le problÃ¨me CPU Adventure, qui Ã  l'Ã©poque n'Ã©tait rÃ©solu par aucune des Ã©quipes (en consÃ©quence nous Ã©tions les seuls Ã  avoir accompli la tÃ¢che). <br><br>  Voici une description de la tÃ¢che CPU Adventure: <br><br><blockquote> Mon grand-pÃ¨re dans les annÃ©es 60 Ã©tait engagÃ© dans le dÃ©veloppement d'ordinateurs.  Remettant les choses en ordre dans son grenier, j'ai trouvÃ© une Ã©trange voiture.  Ã€ cÃ´tÃ© de la machine se trouvait une pile de cartes perforÃ©es marquÃ©es Â«Dragon Adventure GameÂ».  AprÃ¨s un certain temps, j'ai rÃ©ussi Ã  le connecter Ã  un Ã©quipement moderne, mais le jeu est trop compliquÃ© et je ne peux pas arriver au bout sans tricher.  Pouvez-vous m'aider?  Je joins une transcription des cartes perforÃ©es utilisÃ©es dans la machine.  On prÃ©tend que la machine possÃ¨de 4 registres Ã  usage gÃ©nÃ©ral, 1 kibioctet de mÃ©moire de donnÃ©es et 32 â€‹â€‹kibioctet de mÃ©moire de commande.  Pour jouer au jeu, connectez-vous au serveur comme suit: <code>socat tcp4-connect:cpuadventure.hackable.software:1234 fd:0,rawer</code> Astuce: le processeur de la machine est unique, n'essayez pas de rechercher des informations sur Google. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">game.bin</a> </blockquote><a name="habracut"></a><br>  Une fois connectÃ© au serveur, nous avons reÃ§u les informations suivantes: <br><br><blockquote> <code>THERE IS A TAVERN HERE. INSIDE THE TAVERN, YOU SEE VALIS. <br> <br> SELECT AN OPTION: <br> <br> - GO (N)ORTH <br> - GO (E)AST <br> - (T)ALK TO VALIS <br> - (D)RINK <br> - SHOW (I)NVENTORY <br> <br> YOUR CHOICE:</code> </blockquote> <br>  Super.  Ceci est un jeu d'aventure Ã  l'ancienne.  AprÃ¨s avoir jouÃ© un peu, nous avons rÃ©alisÃ© que vous pouvez combattre des ennemis et obtenir un drapeau de ce personnage Valis si nous lui plaisons: <br><br><blockquote> <code>YOUR CHOICE: T <br> <br> YOU ENTER THE TAVERN AND APPROACH VALIS. <br> <br> - HEY, I WAS WONDERING IF YOU COULD HELP ME FIND THE FLAG? <br> - THE FLAG? MAYBE, BUT FIRST, I NEED A REDBULL. <br> - I... I DON'T HAVE A REDBULL. <br> - WELL THEN, MAKE YOURSELF USEFUL AND FIND ONE. <br> <br> THERE IS A TAVERN HERE. INSIDE THE TAVERN, YOU SEE VALIS. <br> <br> SELECT AN OPTION: <br> <br> - GO (N)ORTH <br> - GO (E)AST <br> - (T)ALK TO VALIS <br> - (D)RINK <br> - SHOW (I)NVENTORY <br> <br> YOUR CHOICE:</code> </blockquote> <br><h3>  Premiers pas </h3><br>  Je n'ai pas jouÃ© au jeu pendant trÃ¨s longtemps, rÃ©alisant qu'il est probablement plus important de <code>game.bin</code> Ã  une rÃ©tro-ingÃ©nierie du fichier <code>game.bin</code> .  Je l'ai ouvert dans un Ã©diteur hexadÃ©cimal, en espÃ©rant voir des valeurs binaires.  Imaginez ma surprise quand j'ai vu ceci: <br><br><pre>  110011111101000000111100110010001110000011001101000000000000110010011101010000001101001111100001111111001100111000000011 ... </pre><br><br>  Il <em>s'agit littÃ©ralement d'un</em> fichier binaire - un fichier texte qui ne contient rien d'autre que les caractÃ¨res ASCII 1 et 0. Nous savons que c'est trÃ¨s probablement le code machine du processeur, mais en plus d'avoir 4 registres, 1 Ko de mÃ©moire de donnÃ©es et 32 kibioctets de mÃ©moire d'instructions, on <em>ne</em> sait <em>rien</em> Ã  ce sujet.  Par consÃ©quent, notre premiÃ¨re tÃ¢che sÃ©rieuse sera de dÃ©terminer la taille unitaire de ce fichier binaire (par exemple, a-t-il une dimension 8 bits? Ou, peut-Ãªtre, a-t-il une dimension 12 bits ou 18 bits, comme dans certaines <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">architectures anciennes</a> ?) <br><br>  Pour connaÃ®tre la taille d'un fichier inconnu, j'ai utilisÃ© une vieille astuce - j'ai redimensionnÃ© la zone de texte jusqu'Ã  ce que la longueur du saut de ligne corresponde Ã  l'alignement.  Cette mÃ©thode est idÃ©ale pour des Ã©lÃ©ments comme le texte chiffrÃ© XOR multiple, les formats de fichiers inconnus (non compressÃ©s) et le code provenant d'un processeur inconnu: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7b0/264/13d/7b026413d2a0beb1ad79904ab78ffb15.gif"></div><br>  <i>Modifier la taille de la zone de texte</i> <br><br>  Ã€ partir de cette vÃ©rification rapide, j'ai dÃ©couvert que la taille unitaire de ce fichier devait Ãªtre un diviseur de 20 (la largeur de la fenÃªtre alignÃ©e).  Pour connaÃ®tre la taille exacte, j'ai rapidement Ã©crit un script Ã  la recherche de longues lignes rÃ©pÃ©titives (en supposant que tout code ait des sÃ©quences stÃ©rÃ©otypÃ©es rÃ©pÃ©titives).  La ligne de rÃ©pÃ©tition la plus longue Ã©tait le bloc de 425 bits suivant, trouvÃ© Ã  43625 et 44510: <br><br><pre>  10000011111110000001010100011111110100000101100010111000001001000101000100001000100001010001011000101000000001111111111100010000011110010100100001010100111100000110000010100000101000101000011110001111001101111001010100001010000111110100001010000110010011011110011111000000111011101000000001100000110000111101011010111011000100100010100000111000100011100011000000000101010101100010111000001010000001101010010000000011000001100 </pre><br>  Comme la distance entre les rÃ©pÃ©titions est de 885, nous sommes arrivÃ©s Ã  la conclusion que la dimension devrait Ãªtre de 5 bits, c'est-Ã -dire  un processeur inconnu doit avoir 5 octets.  ProgrÃ¨s! <br><br>  Nous avons recherchÃ© des encodages de cartes perforÃ©es 5 bits et nous nous sommes rapidement installÃ©s sur l'ancien encodage <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">avec le code Baudot</a> .  Et en fait - lorsque nous avons utilisÃ© le dÃ©codeur en ligne pour dÃ©coder certains fragments, nous avons obtenu du texte lisible! <br><br><blockquote>  â‡©DRAGONâ‡©HEREâ‡§; â‡©SHEâ‡©APPEARSâ‡©TOâ‡©BEâ‡©GUARDINGâ‡© SOMEâ‡©KINDâ‡©OFâ‡©Aâ‡© BOTTLEâ‡§; &amp;. &amp;. â‡©â€THEREâ‡©ISâ‡©Aâ‡©B <br><br>  <i>Code LSB Baudot ITA amÃ©liorÃ© de 425 bits</i> </blockquote><br>  Ensuite, nous avons essayÃ© de dÃ©coder l'intÃ©gralitÃ© du fichier en utilisant le code Bodo, mais dans les 20 000 premiers bits environ, nous avons obtenu des ordures, aprÃ¨s quoi il y avait un texte parfaitement lisible.  Cela nous a montrÃ© clairement que la premiÃ¨re partie du fichier appartient Ã  la section Â«codeÂ», suivie de la section Â«donnÃ©esÂ», qui contient des lignes constantes.  Nous avons supposÃ© que la machine utilise probablement le code Bodo pour les E / S, et stocke donc Ã©galement des lignes constantes dans le codage Bodo en mÃ©moire.  Pour rendre le segment de code plus lisible, j'ai dÃ©cidÃ© de le coder en utilisant le codage base-32, similaire au codage hexadÃ©cimal, mais en l'Ã©tendant avec l'alphabet 0-9a-v.  Voici Ã  quoi ressemble le fichier game.bin avec la premiÃ¨re partie encodÃ©e en base-32 et la seconde partie dÃ©codÃ©e par Bodo (le fichier complet est affichÃ© ici: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">game.b32</a> ): <br><br><blockquote> <code>pv83pi70pk00p7a0qfgvpjg3f0kf13f28p5f3pv10pk40pn60f0sf1sf24p5f3r9c11qad0f0sf1df26p5f39c21qad0f05f1ff26p5f39c41qad0f08f1df26p5f39c81qad0f0hf1ef26p5f3r1c00qaq15c20qcl0f01f1of27p5f3p3g3psf35c10qal0f02f1nf27p5f3p3g3psf3rf0hf1nf27p5f3f05f16f27p5f3rf84f95101311fl0f510f84907qa40b518447qa40b514f84f95k9m0k9m0k9m0907qa40b511447qa40b512ruougf10f20g0i9g0i910931b320u2u1u0ro9f0o9f0ojh0o9f0o9f0o9f0olj0o9f0o9f0o9f0o9f0o9f0o9f0o9f0o9k1onp0o9f0o9f0o9f0o9f0onf0ot82odi0o9f0o9f0o9f0o9f0o9f0o9f0o9f0olg0o9f0f0gf1df24p5f3r9c11qa835548755 <br> [...] <br> 93e9n59ka8fo87r85g8ui8ml8ed87b9h89u291u82333333333456789abcdb01234567892)%c3BOTTLE OF SOPLICA PIGWOWAENEMY HEALTH: <br> <br> YOU ATTACK <br> <br> YOU APPROACH REDFORD. <br> <br> <br> <br> YOU ENTER THE TAVERN AND APPROACH VALIS. <br> [...]</code> </blockquote> <br>  Par souci de simplicitÃ©, j'appellerai les unitÃ©s Ã  cinq bits Â«octetsÂ» ci-dessous.  Entre eux dans l'Ã©quipe, nous avons trouvÃ© d'autres noms pour eux - je les ai appelÃ©s croquettes et Zak - hacks. <br><br><h3>  IngÃ©nierie inverse du processeur inconnue </h3><br>  Nous passons maintenant Ã  la partie difficile - l'ingÃ©nierie inverse de 4000 octets de code qui s'exÃ©cute sur une architecture de processeur unique complÃ¨tement inconnue.  D'aprÃ¨s le code, il est assez Ã©vident qu'il devrait s'agir d'un ensemble d'instructions de <em>longueur variable</em> , car il est impossible d'y trouver un motif de rÃ©pÃ©tition stable notable.  J'ai passÃ© quelques heures lÃ -dessus, plus tard, mon membre de l'Ã©quipe Zachary Wade (@ zwad3) a commencÃ© Ã  m'aider.  Tout d'abord, j'ai commencÃ© Ã  chercher des morceaux de code en double, suggÃ©rant qu'ils utiliseraient souvent un petit nombre d'instructions.  J'ai commencÃ© Ã  diviser le code en sÃ©quences rÃ©pÃ©titives plus courtes qui Ã©taient plus pratiques pour l'analyse.  Je voudrais dire que c'Ã©tait un processus rigoureux, mais en fait, l'algorithme vague suivant a Ã©tÃ© principalement utilisÃ©: <br><br><ul><li>  Nous regardons Ã  travers le code et cherchons si quelque chose se rÃ©pÃ¨te trÃ¨s souvent </li><li>  Effectuez la procÃ©dure de recherche et remplacement pour insÃ©rer une nouvelle ligne Ã  cÃ´tÃ© de cette rÃ©pÃ©tition </li><li>  Explorez les similitudes / diffÃ©rences entre les lignes de sÃ©paration rÃ©sultantes. </li><li>  RÃ©pÃ©tez ce processus pendant environ une heure ... </li></ul><br>  Par exemple, l'un des motifs que j'ai dÃ©couverts Ã©tait Â«0f0.fÂ», oÃ¹ Â«.Â»  indique un caractÃ¨re inconnu.  J'ai cassÃ© la chaÃ®ne sur ce modÃ¨le et j'ai obtenu ce qui suit: <br><br><blockquote> <code>pv83pi70pk00p7a0qfgvpjg3f0kf13f28p5f3pv10pk40pn60f0sf <br> 1sf24p5f3r9c11qad0f0sf <br> 1df26p5f39c21qad0f05f <br> 1ff26p5f39c41qad0f08f <br> 1df26p5f39c81qad0f0hf <br> 1ef26p5f3r1c00qaq15c20qcl0f01f <br> 1of27p5f3p3g3psf35c10qal0f02f</code> </blockquote> <br>  TrÃ¨s utile!  Des deuxiÃ¨me et troisiÃ¨me lignes, nous voyons qu'il y a "... p5f3r9c ..." et "... p5f39c ...", et cela nous indique que "r" est un opcode Ã  un octet, c'est-Ã -dire, "... 5f3" est la fin d'un opcode, et " 9c .. Â»est le dÃ©but d'un autre.  Dans les deux derniÃ¨res lignes, nous voyons "p5f3r1c ..." et cela signifie que "1c .." est un autre opcode, et "p3 ..." est Ã©galement un autre opcode. <br><br>  J'ai continuÃ© Ã  diviser les instructions encore et encore d'une maniÃ¨re similaire, en utilisant les similitudes et les diffÃ©rences de blocs similaires pour trouver des instructions probables.  En fin de compte, j'ai obtenu quelque chose comme Ã§a: <br><br><blockquote> <code>pv83 <br> pi70 <br> pk00 <br> p7a0 <br> qfgv <br> pjg3 <br> f0k <br> f13 <br> f28 <br> p5f3 <br> pv10 <br> pk40 <br> pn60 <br> f0s <br> f1s <br> f24 <br> p5f3 <br> r <br> 9c11 <br> qad0 <br> f0s <br> f1d <br> f26 <br> p5f3 <br> 9c21 <br> qad0 <br> f05 <br> f1f</code> </blockquote> <br>  J'ai supposÃ© que Â«pÂ» et Â«qÂ» Ã©taient des instructions avec trois octets d'opÃ©randes, Â«f0Â», Â«f1Â» et Â«f2Â» Ã©taient des instructions avec un opÃ©rande et Â«9cÂ» Ã©tait une instruction avec deux opÃ©randes.  Cependant, je ne savais pas ce que chacune de ces instructions est. <br><br>  Je me suis donc tournÃ© vers le rÃ©pertoire de toutes les instructions Â«pÂ» que j'ai mises en Ã©vidence, et j'ai constatÃ© qu'en ce moment, les instructions les plus frÃ©quentes avec Â«pÂ» Ã©taient Â«p5f3Â».  De plus, en regardant les endroits oÃ¹ elle se produit, j'ai constatÃ© qu'elle est toujours prÃ©cÃ©dÃ©e des instructions Â«f0Â», Â«f1Â» et Â«f2Â».  En regardant tous les opÃ©randes "f0", "f1" et "f2", j'ai remarquÃ© que les opÃ©randes f2 sont toujours dans la plage 4-8.  En se rappelant que le CPU a 32 ko de mÃ©moire de programme pour l'adressage qui nÃ©cessite 15 bits, j'ai supposÃ© que Â«f0Â», Â«f1Â» et Â«f2Â» chargeaient une adresse avec f2 comme octet de poids fort.  Lorsque j'ai connectÃ© certaines de ces adresses entre elles, j'ai constatÃ© qu'elles pointaient toutes exactement vers le dÃ©but des lignes constantes dans la section des donnÃ©es.  J'ai trouvÃ© la fonction d' <code>print</code> !  Il s'ensuit immÃ©diatement que Â«p5f3Â» est en fait une sorte d'instruction pour imprimer une ligne ou un appel;  si vous prenez en compte l'opÃ©rande de trois octets, il s'agit trÃ¨s probablement d'un Â«appelÂ».  Encore une fois, en regardant les instructions Â«pÂ», j'ai rÃ©alisÃ© que les trois octets de l'opÃ©rande indiquent l'adresse en <em>ordre direct (petit-boutien)</em> , c'est-Ã -dire que le dernier octet de l'opÃ©rande est l'octet le plus Ã©levÃ© de l'adresse. <br><br>  Ce fut une Ã©norme percÃ©e!  Nous avons identifiÃ© notre premiÃ¨re instruction.  Ayant vu que Â«f0Â» et Â«f1Â» sont utilisÃ©s Ã  d'autres endroits, j'ai supposÃ© qu'ils chargeaient non pas les adresses, mais l'un des quatre registres (par exemple, f0 charge le registre 0) avec des constantes de 5 bits avec adressage direct.  C'est logique pour p5f3 - il charge trois arguments de registre pour la fonction 3f5 ("print_string"). <br><br>  J'ai commencÃ© Ã  Ã©crire un dÃ©sassembleur qui reconnaÃ®t l'idiome Â«printÂ» (f0x, f1x, f2x, p5f3), en plaÃ§ant la substitution de la ligne imprimÃ©e dans le code dÃ©sassemblÃ©.  En raison du grand nombre de lignes dans le programme, le code dÃ©sassemblÃ© est rapidement devenu trÃ¨s lisible, et il est devenu plus facile de trouver l'emplacement des blocs fonctionnels (le code dÃ©sassemblÃ© complet est <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> ): <br><br><blockquote> <code>0: call 38v <br> 4: call 7i <br> 8: call k <br> c: call a7 <br> g: q vgf <br> <br> k: call 3gj <br> o: print 83k # 'SELECT AN OPTION\x0e:\r\n\r\n\x0f\x00' <br> 15: call 1v <br> 19: call 4k <br> 1d: call 6n <br> 1h: print 4ss # '\r\nYOUR CHOICE\x0e: \x0f\x00' <br> 1u: ret <br> <br> 1v: unk 9 <br> 20: unk c <br> 21: unk 1 <br> 22: unk 1 <br> 23: q 0da <br> 27: print 6ds # '\x0e- \x0fGO \x0e(\x0fS\x0e)\x0fOUTH\r\n\x00' <br> 2k: unk 9 <br> 2l: unk c <br> 2m: unk 2 <br> 2n: unk 1 <br> 2o: q 0da <br> 2s: print 6f5 # '\x0e- \x0fGO \x0e(\x0fN\x0e)\x0fORTH\r\n\x00' <br> 39: unk 9 <br> 3a: unk c <br> 3b: unk 4 <br> 3c: unk 1 <br> 3d: q 0da <br> 3h: print 6d8 # '\x0e- \x0fGO \x0e(\x0fE\x0e)\x0fAST\r\n\x00' <br> 3u: unk 9 <br> 3v: unk c <br> 40: unk 8 <br> 41: unk 1 <br> 42: q 0da <br> 46: print 6eh # '\x0e- \x0fGO \x0e(\x0fW\x0e)\x0fEST\r\n\x00' <br> 4j: ret</code> </blockquote> <br>  Ã€ partir de ce petit extrait de code, j'ai rÃ©ussi Ã  comprendre plusieurs aspects: l'instruction Â«q0Â» devrait indiquer une ramification conditionnelle (car elle est utilisÃ©e pour ignorer l'impression de directions inutiles dans la fonction 1v), et les instructions Â«9c11Â», Â«9c21Â», Â«9c41Â», Â« 9c81 "devrait indiquer une sorte d'instruction ET - ils vÃ©rifient les bits dÃ©finis pour voir si ces directions sont autorisÃ©es (cela est clairement indiquÃ© par l'utilisation de" 1 "," 2 "," 4 "et" 8 "dans ces instructions). <br><br>  Au cours des deux heures suivantes, Zachary Wade (@ zwad3) et moi avons triÃ© les diffÃ©rentes instructions, en faisant et en affinant nos hypothÃ¨ses sur ce qu'elles faisaient.  Avoir de nombreuses dÃ©clarations imprimables lisibles a rendu notre travail beaucoup plus facile.  Nous avons dÃ©cidÃ© que chacun de nous rÃ©digerait individuellement son propre dÃ©monteur afin que nous puissions examiner les instructions Ã  notre propre rythme et partager nos rÃ©sultats. <br><br><h3>  IngÃ©nierie inverse du code </h3><br>  AprÃ¨s quelques heures, j'ai commencÃ© Ã  faire de grands progrÃ¨s dans le dÃ©montage.  AprÃ¨s avoir examinÃ© le code qui fonctionnait avec l'inventaire de l'utilisateur (plus prÃ©cisÃ©ment, la fonction Â«boissonÂ» et chaque gestionnaire qui lui est associÃ©), nous avons trouvÃ© des instructions pour sauvegarder et charger Ã  partir de la mÃ©moire (n'oubliez pas que le CPU a 1 kibio de mÃ©moire de donnÃ©es).  Ensuite, nous avons dÃ©couvert que certaines instructions arithmÃ©tiques / logiques (ALU) prennent des opÃ©randes de mÃ©moire (par exemple, "9c41" signifie "exÃ©cuter AND avec une valeur Ã  l'adresse de donnÃ©es 1 avec une valeur 4").  Ã€ partir de cela, nous avons pu recrÃ©er les variables dans la mÃ©moire de donnÃ©es, par exemple, dans [0] l'identifiant NPC est stockÃ© Ã  l'emplacement actuel, et dans [6,7] la santÃ© actuelle du joueur est stockÃ©e (les 5 bits infÃ©rieurs dans [6], les 5 plus anciens dans [7] ]).  Ã€ ce stade, je suis passÃ© des instructions de rÃ©tro-ingÃ©nierie Ã  l'annotation de mon code dÃ©sassemblÃ© et Ã  la rÃ©tro-ingÃ©nierie du programme lui-mÃªme.  Voici ma drÃ´le de notation pour les valeurs 5 bits: <br><br><blockquote> <code>_start: <br> call init <br> <br> L4: <br> call check_moves <br> call print_menu <br> call handle_command <br> br 4 <br> <br> print_menu: <br> call print_itemname <br> print 83k # 'SELECT AN OPTION\x0e:\r\n\r\n\x0f\x00' <br> call print_moves <br> call print_npcmenu <br> call print_itemmenu <br> print 4ss # '\r\nYOUR CHOICE\x0e: \x0f\x00' <br> ret <br> <br> print_moves: <br> and 0y1, [1] <br> brz 2k <br> print 6ds # '\x0e- \x0fGO \x0e(\x0fS\x0e)\x0fOUTH\r\n\x00' <br> 2k: and 0y2, [1] <br> brz 39 <br> print 6f5 # '\x0e- \x0fGO \x0e(\x0fN\x0e)\x0fORTH\r\n\x00' <br> 39: and 0y4, [1] <br> brz 3u <br> print 6d8 # '\x0e- \x0fGO \x0e(\x0fE\x0e)\x0fAST\r\n\x00' <br> 3u: and 0y8, [1] <br> brz 4j <br> print 6eh # '\x0e- \x0fGO \x0e(\x0fW\x0e)\x0fEST\r\n\x00' <br> 4j: ret <br> <br> print_npcmenu: <br> add 0y0, [0] <br> brz 6m <br> sub 0y2, [0] <br> br&lt;c&gt; 5p <br> print 7o1 # '\x0e- (\x0fT\x0e)\x0fALK TO \x00' <br> call print_npcname <br> call print_crlf <br> 5p: sub 0y1, [0] <br> brz 6m <br> print 7n2 # '\x0e- (\x0fF\x0e)\x0fIGHT \x00' <br> call print_npcname <br> call print_crlf <br> 6m: ret <br> <br> print_itemmenu: <br> print 7nh # '\x0e- (\x0fD\x0e)\x0fRINK\r\n\x00' <br> print 765 # '\x0e- \x0fSHOW \x0e(\x0fI\x0e)\x0fNVENTORY\r\n\x00' <br> ret</code> </blockquote> <br>  Nous avons encore de nombreux opcodes inconnus, par exemple, bien que nous ayons dÃ©couvert que "qa" est une ramification conditionnelle sur zÃ©ro (branch-on-zero, brz), nous n'avons pas pu comprendre ce qu'est "qc" (indiquÃ© ci-dessus comme br &lt;c&gt;).  Mais cela a suffi pour commencer Ã  comprendre la logique du programme. <br><br>  En fait, le jeu permet au joueur de se dÃ©placer sur une carte 8 Ã— 8 sur laquelle des PNJ (dragons, taureaux rouges et humains) sont placÃ©s au hasard.  Vous pouvez vous battre avec n'importe quel PNJ (mÃªme Valis, malgrÃ© l'absence d'un Ã©lÃ©ment de menu correspondant).  Pendant la bataille, vous pouvez attaquer l'ennemi, provoquant une quantitÃ© alÃ©atoire de dÃ©gÃ¢ts ou de manque, aprÃ¨s quoi l'ennemi attaque le joueur, provoquant Ã©galement une quantitÃ© alÃ©atoire de dÃ©gÃ¢ts ou de manque.  Vous pouvez Ã©galement choisir un verrou de bouclier, grÃ¢ce auquel l'ennemi manque ou frappe le bouclier sans causer de dÃ©gÃ¢ts.  Enfin, vous pouvez tricher en augmentant votre santÃ© Ã  1000, mais dans ce cas, la variable cachÃ©e ("trichÃ©", adresse 10) est dÃ©finie sur 1. Si le joueur tue avec succÃ¨s l'ennemi, un objet tombe de lui, gÃ©nÃ©ralement une bouteille d'alcool (Ã©videmment, ce jeu n'est pas pour les enfants). <br><br>  Le NPC Valis principal, dont le joueur doit recevoir le drapeau, a une machine d'Ã©tat dans laquelle il demande au joueur plusieurs articles - un tas de boissons de taureau rouge (Ã©videmment obtenues en battant des ennemis de taureau rouge), diverses boissons mÃ©langÃ©es (par exemple, gin et tonic - pour les obtenir, vous devez vaincre le dragon bleu et le dragon gris, puis mÃ©langer les objets qui en sont sortis), et la bande de puissance, qui peut Ãªtre obtenue si vous battez une autre personne PNJ dans le jeu (Redford) ou si vous l'aidez.  Si vous remplissez toute cette longue sÃ©rie de demandes, il vous donnera le drapeau, mais <em>seulement</em> si la variable Â«trichÃ©Â» n'est pas Ã©gal Ã  1. Autrement dit, notre tÃ¢che est de gagner le jeu sans tricher.  Comme nous commenÃ§ons avec seulement 100 HP, comme tous les ennemis, avec le passage habituel, il sera impossible de vaincre tous les ennemis (pour obtenir tout ce dont vous avez besoin pour vaincre environ 20 adversaires).  Il est nÃ©cessaire de modifier le RNG d'une maniÃ¨re ou d'une autre, afin que l'ennemi manque toujours. <br><br>  Les nombres alÃ©atoires sont gÃ©nÃ©rÃ©s par une fonction similaire Ã  une sorte de PRNG (adresse 37a), mais elle utilise des instructions uniques qui ne sont utilisÃ©es nulle part ailleurs, nous ne pouvons donc pas les inverser.  Cependant, nous avons remarquÃ© qu'il charge son vecteur d'Ã©tat Ã  partir de trois adresses en mÃ©moire ([11], [12] et [13]), c'est-Ã -dire que son Ã©tat complet ne prend que 15 bits.  Cela signifie que le RNG doit avoir une courte pÃ©riode - pas plus de 2 ^ 15 = 32768 de longueur. <br><br>  Alors que nous (en vain) essayions d'inverser la mise en Å“uvre du RNG, Jay Bosamia (@ jay_f0xtr0t) et Matthew Savage (@thebluepichu) ont implÃ©mentÃ© un exploit.  En envoyant simplement la commande Â«bouclierÂ» 100 000 fois de suite, nous avons pu obtenir une sÃ©quence de Â«coupsÂ» et de Â«manquesÂ» ennemis correspondant au bit Ã©mis par le RNG.  Nous nous sommes assurÃ©s que cette sÃ©quence se rÃ©pÃ¨te avec une pÃ©riode de 32767. GrÃ¢ce Ã  cela, nous avons pu assembler notre exploit principal - lorsque nous combattions avec le premier ennemi que nous avons rencontrÃ©, nous avons fermÃ© nos boucliers 40 fois pour recrÃ©er la sÃ©quence de coups sÃ»rs et manquÃ©s, recherchÃ© cette sÃ©quence dans une grande sÃ©quence pÃ©riodique, puis dÃ©couvert quand protÃ©ger et quand attaquer pour que l'ennemi manque toujours.  Ensuite, nous avons fait le tour de la carte en mode assassinhobo, tuant tout le monde et rÃ©cupÃ©rant leur butin.  Ã€ la fin, nous sommes retournÃ©s Ã  Valis et avons poliment demandÃ© notre drapeau, que nous avons reÃ§u: <br><br><blockquote> <code>DrgnS{m4kin9-v4lis-happy-w1th-n4t1ve-b4ud0t-cpu}</code> </blockquote> <br>  Fuh!  En effet, une vraie aventure.  Je n'arrive toujours pas Ã  croire que nous sommes passÃ©s d'une chaÃ®ne binaire et d'un manque total de documentation du processeur Ã  deux dÃ©sassembleurs presque complets et un code propre dÃ©sassemblÃ© en moins de 10 heures!  Tout le code est disponible sur GitHub: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">mon dÃ©sassembleur</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">le dÃ©sassembleur de Zachary</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">mon code brut dÃ©sassemblÃ©</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">mon code dÃ©sassemblÃ© annotÃ©</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Matt's Exploit client</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr468849/">https://habr.com/ru/post/fr468849/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr468837/index.html">Comment mener un entretien technique: un plan d'action pour les dÃ©butants</a></li>
<li><a href="../fr468841/index.html">Livraison continue pour votre bibliothÃ¨que Kotlin Multiplatform</a></li>
<li><a href="../fr468843/index.html">Avez-vous peur de mettre en place un systÃ¨me CRM? Votre entreprise est peut-Ãªtre malade</a></li>
<li><a href="../fr468845/index.html">Un court cours de physiologie de la ville, ou parties du corps</a></li>
<li><a href="../fr468847/index.html">MarchÃ©s publics dans d'autres pays: pourquoi les lois ont besoin de cadres</a></li>
<li><a href="../fr468851/index.html">ImplÃ©mentation d'animation dans React Native</a></li>
<li><a href="../fr468853/index.html">L'histoire d'une application rÃ©ussie de SPR dans un projet Legacy</a></li>
<li><a href="../fr468859/index.html">Â«Routeur de pompageÂ»: rÃ©glage de l'Ã©quipement TP-Link pour les fournisseurs Internet</a></li>
<li><a href="../fr468861/index.html">Positive Technologies donne vie Ã  la Â«ville piratableÂ» dans The Cyberbattle Standoff Ã  HITB + CyberWeek</a></li>
<li><a href="../fr468863/index.html">Internals Go: boucler les variables de boucle en fermeture</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>