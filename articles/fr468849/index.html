<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§ô üöØ üëò R√©tro-ing√©nierie de processeur inconnu dans un seul programme üññüèº üÜí üßëüèæ‚Äçü§ù‚Äçüßëüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="TL; DR: nous avons proc√©d√© √† une ing√©nierie inverse d'un programme √©crit pour une architecture de CPU compl√®tement inconnue sans aucune documentation ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>R√©tro-ing√©nierie de processeur inconnu dans un seul programme</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/468849/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/mf/1z/aq/mf1zaqnw0lte41iurmzthf-qjbk.png"></div><br>  TL; DR: nous avons proc√©d√© √† une ing√©nierie inverse d'un programme √©crit pour une architecture de CPU compl√®tement inconnue sans aucune documentation sur le CPU (sans √©mulateur, sans ISA, sans tout) en seulement dix heures.  √Ä partir de l'article, vous apprendrez comment nous l'avons fait ... <br><br>  Le week-end dernier, l'√©quipe CMU PPP et moi avons particip√© √† l'√©quipe Dragon Sector Teaser CTF 2019 pour se d√©tendre et s'√©loigner de la dure √©ch√©ance du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">CHI 2020</a> .  Dragon Sector est une √©quipe polonaise respect√©e avec une histoire de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">FFC</a> int√©ressants, donc je me demandais ce qu'ils avaient en stock. <br><br>  Apr√®s avoir r√©solu ¬´ummmfpu¬ª, une t√¢che qui comprenait la r√©tro-ing√©nierie du bytecode pour le coprocesseur √† virgule flottante Micromega uM-FPU, j'ai d√©cid√© de participer √† un concours pour r√©soudre le probl√®me CPU Adventure, qui √† l'√©poque n'√©tait r√©solu par aucune des √©quipes (en cons√©quence nous √©tions les seuls √† avoir accompli la t√¢che). <br><br>  Voici une description de la t√¢che CPU Adventure: <br><br><blockquote> Mon grand-p√®re dans les ann√©es 60 √©tait engag√© dans le d√©veloppement d'ordinateurs.  Remettant les choses en ordre dans son grenier, j'ai trouv√© une √©trange voiture.  √Ä c√¥t√© de la machine se trouvait une pile de cartes perfor√©es marqu√©es ¬´Dragon Adventure Game¬ª.  Apr√®s un certain temps, j'ai r√©ussi √† le connecter √† un √©quipement moderne, mais le jeu est trop compliqu√© et je ne peux pas arriver au bout sans tricher.  Pouvez-vous m'aider?  Je joins une transcription des cartes perfor√©es utilis√©es dans la machine.  On pr√©tend que la machine poss√®de 4 registres √† usage g√©n√©ral, 1 kibioctet de m√©moire de donn√©es et 32 ‚Äã‚Äãkibioctet de m√©moire de commande.  Pour jouer au jeu, connectez-vous au serveur comme suit: <code>socat tcp4-connect:cpuadventure.hackable.software:1234 fd:0,rawer</code> Astuce: le processeur de la machine est unique, n'essayez pas de rechercher des informations sur Google. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">game.bin</a> </blockquote><a name="habracut"></a><br>  Une fois connect√© au serveur, nous avons re√ßu les informations suivantes: <br><br><blockquote> <code>THERE IS A TAVERN HERE. INSIDE THE TAVERN, YOU SEE VALIS. <br> <br> SELECT AN OPTION: <br> <br> - GO (N)ORTH <br> - GO (E)AST <br> - (T)ALK TO VALIS <br> - (D)RINK <br> - SHOW (I)NVENTORY <br> <br> YOUR CHOICE:</code> </blockquote> <br>  Super.  Ceci est un jeu d'aventure √† l'ancienne.  Apr√®s avoir jou√© un peu, nous avons r√©alis√© que vous pouvez combattre des ennemis et obtenir un drapeau de ce personnage Valis si nous lui plaisons: <br><br><blockquote> <code>YOUR CHOICE: T <br> <br> YOU ENTER THE TAVERN AND APPROACH VALIS. <br> <br> - HEY, I WAS WONDERING IF YOU COULD HELP ME FIND THE FLAG? <br> - THE FLAG? MAYBE, BUT FIRST, I NEED A REDBULL. <br> - I... I DON'T HAVE A REDBULL. <br> - WELL THEN, MAKE YOURSELF USEFUL AND FIND ONE. <br> <br> THERE IS A TAVERN HERE. INSIDE THE TAVERN, YOU SEE VALIS. <br> <br> SELECT AN OPTION: <br> <br> - GO (N)ORTH <br> - GO (E)AST <br> - (T)ALK TO VALIS <br> - (D)RINK <br> - SHOW (I)NVENTORY <br> <br> YOUR CHOICE:</code> </blockquote> <br><h3>  Premiers pas </h3><br>  Je n'ai pas jou√© au jeu pendant tr√®s longtemps, r√©alisant qu'il est probablement plus important de <code>game.bin</code> √† une r√©tro-ing√©nierie du fichier <code>game.bin</code> .  Je l'ai ouvert dans un √©diteur hexad√©cimal, en esp√©rant voir des valeurs binaires.  Imaginez ma surprise quand j'ai vu ceci: <br><br><pre>  110011111101000000111100110010001110000011001101000000000000110010011101010000001101001111100001111111001100111000000011 ... </pre><br><br>  Il <em>s'agit litt√©ralement d'un</em> fichier binaire - un fichier texte qui ne contient rien d'autre que les caract√®res ASCII 1 et 0. Nous savons que c'est tr√®s probablement le code machine du processeur, mais en plus d'avoir 4 registres, 1 Ko de m√©moire de donn√©es et 32 kibioctets de m√©moire d'instructions, on <em>ne</em> sait <em>rien</em> √† ce sujet.  Par cons√©quent, notre premi√®re t√¢che s√©rieuse sera de d√©terminer la taille unitaire de ce fichier binaire (par exemple, a-t-il une dimension 8 bits? Ou, peut-√™tre, a-t-il une dimension 12 bits ou 18 bits, comme dans certaines <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">architectures anciennes</a> ?) <br><br>  Pour conna√Ætre la taille d'un fichier inconnu, j'ai utilis√© une vieille astuce - j'ai redimensionn√© la zone de texte jusqu'√† ce que la longueur du saut de ligne corresponde √† l'alignement.  Cette m√©thode est id√©ale pour des √©l√©ments comme le texte chiffr√© XOR multiple, les formats de fichiers inconnus (non compress√©s) et le code provenant d'un processeur inconnu: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7b0/264/13d/7b026413d2a0beb1ad79904ab78ffb15.gif"></div><br>  <i>Modifier la taille de la zone de texte</i> <br><br>  √Ä partir de cette v√©rification rapide, j'ai d√©couvert que la taille unitaire de ce fichier devait √™tre un diviseur de 20 (la largeur de la fen√™tre align√©e).  Pour conna√Ætre la taille exacte, j'ai rapidement √©crit un script √† la recherche de longues lignes r√©p√©titives (en supposant que tout code ait des s√©quences st√©r√©otyp√©es r√©p√©titives).  La ligne de r√©p√©tition la plus longue √©tait le bloc de 425 bits suivant, trouv√© √† 43625 et 44510: <br><br><pre>  10000011111110000001010100011111110100000101100010111000001001000101000100001000100001010001011000101000000001111111111100010000011110010100100001010100111100000110000010100000101000101000011110001111001101111001010100001010000111110100001010000110010011011110011111000000111011101000000001100000110000111101011010111011000100100010100000111000100011100011000000000101010101100010111000001010000001101010010000000011000001100 </pre><br>  Comme la distance entre les r√©p√©titions est de 885, nous sommes arriv√©s √† la conclusion que la dimension devrait √™tre de 5 bits, c'est-√†-dire  un processeur inconnu doit avoir 5 octets.  Progr√®s! <br><br>  Nous avons recherch√© des encodages de cartes perfor√©es 5 bits et nous nous sommes rapidement install√©s sur l'ancien encodage <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">avec le code Baudot</a> .  Et en fait - lorsque nous avons utilis√© le d√©codeur en ligne pour d√©coder certains fragments, nous avons obtenu du texte lisible! <br><br><blockquote>  ‚á©DRAGON‚á©HERE‚áß; ‚á©SHE‚á©APPEARS‚á©TO‚á©BE‚á©GUARDING‚á© SOME‚á©KIND‚á©OF‚á©A‚á© BOTTLE‚áß; &amp;. &amp;. ‚á©‚êÄTHERE‚á©IS‚á©A‚á©B <br><br>  <i>Code LSB Baudot ITA am√©lior√© de 425 bits</i> </blockquote><br>  Ensuite, nous avons essay√© de d√©coder l'int√©gralit√© du fichier en utilisant le code Bodo, mais dans les 20 000 premiers bits environ, nous avons obtenu des ordures, apr√®s quoi il y avait un texte parfaitement lisible.  Cela nous a montr√© clairement que la premi√®re partie du fichier appartient √† la section ¬´code¬ª, suivie de la section ¬´donn√©es¬ª, qui contient des lignes constantes.  Nous avons suppos√© que la machine utilise probablement le code Bodo pour les E / S, et stocke donc √©galement des lignes constantes dans le codage Bodo en m√©moire.  Pour rendre le segment de code plus lisible, j'ai d√©cid√© de le coder en utilisant le codage base-32, similaire au codage hexad√©cimal, mais en l'√©tendant avec l'alphabet 0-9a-v.  Voici √† quoi ressemble le fichier game.bin avec la premi√®re partie encod√©e en base-32 et la seconde partie d√©cod√©e par Bodo (le fichier complet est affich√© ici: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">game.b32</a> ): <br><br><blockquote> <code>pv83pi70pk00p7a0qfgvpjg3f0kf13f28p5f3pv10pk40pn60f0sf1sf24p5f3r9c11qad0f0sf1df26p5f39c21qad0f05f1ff26p5f39c41qad0f08f1df26p5f39c81qad0f0hf1ef26p5f3r1c00qaq15c20qcl0f01f1of27p5f3p3g3psf35c10qal0f02f1nf27p5f3p3g3psf3rf0hf1nf27p5f3f05f16f27p5f3rf84f95101311fl0f510f84907qa40b518447qa40b514f84f95k9m0k9m0k9m0907qa40b511447qa40b512ruougf10f20g0i9g0i910931b320u2u1u0ro9f0o9f0ojh0o9f0o9f0o9f0olj0o9f0o9f0o9f0o9f0o9f0o9f0o9f0o9k1onp0o9f0o9f0o9f0o9f0onf0ot82odi0o9f0o9f0o9f0o9f0o9f0o9f0o9f0olg0o9f0f0gf1df24p5f3r9c11qa835548755 <br> [...] <br> 93e9n59ka8fo87r85g8ui8ml8ed87b9h89u291u82333333333456789abcdb01234567892)%c3BOTTLE OF SOPLICA PIGWOWAENEMY HEALTH: <br> <br> YOU ATTACK <br> <br> YOU APPROACH REDFORD. <br> <br> <br> <br> YOU ENTER THE TAVERN AND APPROACH VALIS. <br> [...]</code> </blockquote> <br>  Par souci de simplicit√©, j'appellerai les unit√©s √† cinq bits ¬´octets¬ª ci-dessous.  Entre eux dans l'√©quipe, nous avons trouv√© d'autres noms pour eux - je les ai appel√©s croquettes et Zak - hacks. <br><br><h3>  Ing√©nierie inverse du processeur inconnue </h3><br>  Nous passons maintenant √† la partie difficile - l'ing√©nierie inverse de 4000 octets de code qui s'ex√©cute sur une architecture de processeur unique compl√®tement inconnue.  D'apr√®s le code, il est assez √©vident qu'il devrait s'agir d'un ensemble d'instructions de <em>longueur variable</em> , car il est impossible d'y trouver un motif de r√©p√©tition stable notable.  J'ai pass√© quelques heures l√†-dessus, plus tard, mon membre de l'√©quipe Zachary Wade (@ zwad3) a commenc√© √† m'aider.  Tout d'abord, j'ai commenc√© √† chercher des morceaux de code en double, sugg√©rant qu'ils utiliseraient souvent un petit nombre d'instructions.  J'ai commenc√© √† diviser le code en s√©quences r√©p√©titives plus courtes qui √©taient plus pratiques pour l'analyse.  Je voudrais dire que c'√©tait un processus rigoureux, mais en fait, l'algorithme vague suivant a √©t√© principalement utilis√©: <br><br><ul><li>  Nous regardons √† travers le code et cherchons si quelque chose se r√©p√®te tr√®s souvent </li><li>  Effectuez la proc√©dure de recherche et remplacement pour ins√©rer une nouvelle ligne √† c√¥t√© de cette r√©p√©tition </li><li>  Explorez les similitudes / diff√©rences entre les lignes de s√©paration r√©sultantes. </li><li>  R√©p√©tez ce processus pendant environ une heure ... </li></ul><br>  Par exemple, l'un des motifs que j'ai d√©couverts √©tait ¬´0f0.f¬ª, o√π ¬´.¬ª  indique un caract√®re inconnu.  J'ai cass√© la cha√Æne sur ce mod√®le et j'ai obtenu ce qui suit: <br><br><blockquote> <code>pv83pi70pk00p7a0qfgvpjg3f0kf13f28p5f3pv10pk40pn60f0sf <br> 1sf24p5f3r9c11qad0f0sf <br> 1df26p5f39c21qad0f05f <br> 1ff26p5f39c41qad0f08f <br> 1df26p5f39c81qad0f0hf <br> 1ef26p5f3r1c00qaq15c20qcl0f01f <br> 1of27p5f3p3g3psf35c10qal0f02f</code> </blockquote> <br>  Tr√®s utile!  Des deuxi√®me et troisi√®me lignes, nous voyons qu'il y a "... p5f3r9c ..." et "... p5f39c ...", et cela nous indique que "r" est un opcode √† un octet, c'est-√†-dire, "... 5f3" est la fin d'un opcode, et " 9c .. ¬ªest le d√©but d'un autre.  Dans les deux derni√®res lignes, nous voyons "p5f3r1c ..." et cela signifie que "1c .." est un autre opcode, et "p3 ..." est √©galement un autre opcode. <br><br>  J'ai continu√© √† diviser les instructions encore et encore d'une mani√®re similaire, en utilisant les similitudes et les diff√©rences de blocs similaires pour trouver des instructions probables.  En fin de compte, j'ai obtenu quelque chose comme √ßa: <br><br><blockquote> <code>pv83 <br> pi70 <br> pk00 <br> p7a0 <br> qfgv <br> pjg3 <br> f0k <br> f13 <br> f28 <br> p5f3 <br> pv10 <br> pk40 <br> pn60 <br> f0s <br> f1s <br> f24 <br> p5f3 <br> r <br> 9c11 <br> qad0 <br> f0s <br> f1d <br> f26 <br> p5f3 <br> 9c21 <br> qad0 <br> f05 <br> f1f</code> </blockquote> <br>  J'ai suppos√© que ¬´p¬ª et ¬´q¬ª √©taient des instructions avec trois octets d'op√©randes, ¬´f0¬ª, ¬´f1¬ª et ¬´f2¬ª √©taient des instructions avec un op√©rande et ¬´9c¬ª √©tait une instruction avec deux op√©randes.  Cependant, je ne savais pas ce que chacune de ces instructions est. <br><br>  Je me suis donc tourn√© vers le r√©pertoire de toutes les instructions ¬´p¬ª que j'ai mises en √©vidence, et j'ai constat√© qu'en ce moment, les instructions les plus fr√©quentes avec ¬´p¬ª √©taient ¬´p5f3¬ª.  De plus, en regardant les endroits o√π elle se produit, j'ai constat√© qu'elle est toujours pr√©c√©d√©e des instructions ¬´f0¬ª, ¬´f1¬ª et ¬´f2¬ª.  En regardant tous les op√©randes "f0", "f1" et "f2", j'ai remarqu√© que les op√©randes f2 sont toujours dans la plage 4-8.  En se rappelant que le CPU a 32 ko de m√©moire de programme pour l'adressage qui n√©cessite 15 bits, j'ai suppos√© que ¬´f0¬ª, ¬´f1¬ª et ¬´f2¬ª chargeaient une adresse avec f2 comme octet de poids fort.  Lorsque j'ai connect√© certaines de ces adresses entre elles, j'ai constat√© qu'elles pointaient toutes exactement vers le d√©but des lignes constantes dans la section des donn√©es.  J'ai trouv√© la fonction d' <code>print</code> !  Il s'ensuit imm√©diatement que ¬´p5f3¬ª est en fait une sorte d'instruction pour imprimer une ligne ou un appel;  si vous prenez en compte l'op√©rande de trois octets, il s'agit tr√®s probablement d'un ¬´appel¬ª.  Encore une fois, en regardant les instructions ¬´p¬ª, j'ai r√©alis√© que les trois octets de l'op√©rande indiquent l'adresse en <em>ordre direct (petit-boutien)</em> , c'est-√†-dire que le dernier octet de l'op√©rande est l'octet le plus √©lev√© de l'adresse. <br><br>  Ce fut une √©norme perc√©e!  Nous avons identifi√© notre premi√®re instruction.  Ayant vu que ¬´f0¬ª et ¬´f1¬ª sont utilis√©s √† d'autres endroits, j'ai suppos√© qu'ils chargeaient non pas les adresses, mais l'un des quatre registres (par exemple, f0 charge le registre 0) avec des constantes de 5 bits avec adressage direct.  C'est logique pour p5f3 - il charge trois arguments de registre pour la fonction 3f5 ("print_string"). <br><br>  J'ai commenc√© √† √©crire un d√©sassembleur qui reconna√Æt l'idiome ¬´print¬ª (f0x, f1x, f2x, p5f3), en pla√ßant la substitution de la ligne imprim√©e dans le code d√©sassembl√©.  En raison du grand nombre de lignes dans le programme, le code d√©sassembl√© est rapidement devenu tr√®s lisible, et il est devenu plus facile de trouver l'emplacement des blocs fonctionnels (le code d√©sassembl√© complet est <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> ): <br><br><blockquote> <code>0: call 38v <br> 4: call 7i <br> 8: call k <br> c: call a7 <br> g: q vgf <br> <br> k: call 3gj <br> o: print 83k # 'SELECT AN OPTION\x0e:\r\n\r\n\x0f\x00' <br> 15: call 1v <br> 19: call 4k <br> 1d: call 6n <br> 1h: print 4ss # '\r\nYOUR CHOICE\x0e: \x0f\x00' <br> 1u: ret <br> <br> 1v: unk 9 <br> 20: unk c <br> 21: unk 1 <br> 22: unk 1 <br> 23: q 0da <br> 27: print 6ds # '\x0e- \x0fGO \x0e(\x0fS\x0e)\x0fOUTH\r\n\x00' <br> 2k: unk 9 <br> 2l: unk c <br> 2m: unk 2 <br> 2n: unk 1 <br> 2o: q 0da <br> 2s: print 6f5 # '\x0e- \x0fGO \x0e(\x0fN\x0e)\x0fORTH\r\n\x00' <br> 39: unk 9 <br> 3a: unk c <br> 3b: unk 4 <br> 3c: unk 1 <br> 3d: q 0da <br> 3h: print 6d8 # '\x0e- \x0fGO \x0e(\x0fE\x0e)\x0fAST\r\n\x00' <br> 3u: unk 9 <br> 3v: unk c <br> 40: unk 8 <br> 41: unk 1 <br> 42: q 0da <br> 46: print 6eh # '\x0e- \x0fGO \x0e(\x0fW\x0e)\x0fEST\r\n\x00' <br> 4j: ret</code> </blockquote> <br>  √Ä partir de ce petit extrait de code, j'ai r√©ussi √† comprendre plusieurs aspects: l'instruction ¬´q0¬ª devrait indiquer une ramification conditionnelle (car elle est utilis√©e pour ignorer l'impression de directions inutiles dans la fonction 1v), et les instructions ¬´9c11¬ª, ¬´9c21¬ª, ¬´9c41¬ª, ¬´ 9c81 "devrait indiquer une sorte d'instruction ET - ils v√©rifient les bits d√©finis pour voir si ces directions sont autoris√©es (cela est clairement indiqu√© par l'utilisation de" 1 "," 2 "," 4 "et" 8 "dans ces instructions). <br><br>  Au cours des deux heures suivantes, Zachary Wade (@ zwad3) et moi avons tri√© les diff√©rentes instructions, en faisant et en affinant nos hypoth√®ses sur ce qu'elles faisaient.  Avoir de nombreuses d√©clarations imprimables lisibles a rendu notre travail beaucoup plus facile.  Nous avons d√©cid√© que chacun de nous r√©digerait individuellement son propre d√©monteur afin que nous puissions examiner les instructions √† notre propre rythme et partager nos r√©sultats. <br><br><h3>  Ing√©nierie inverse du code </h3><br>  Apr√®s quelques heures, j'ai commenc√© √† faire de grands progr√®s dans le d√©montage.  Apr√®s avoir examin√© le code qui fonctionnait avec l'inventaire de l'utilisateur (plus pr√©cis√©ment, la fonction ¬´boisson¬ª et chaque gestionnaire qui lui est associ√©), nous avons trouv√© des instructions pour sauvegarder et charger √† partir de la m√©moire (n'oubliez pas que le CPU a 1 kibio de m√©moire de donn√©es).  Ensuite, nous avons d√©couvert que certaines instructions arithm√©tiques / logiques (ALU) prennent des op√©randes de m√©moire (par exemple, "9c41" signifie "ex√©cuter AND avec une valeur √† l'adresse de donn√©es 1 avec une valeur 4").  √Ä partir de cela, nous avons pu recr√©er les variables dans la m√©moire de donn√©es, par exemple, dans [0] l'identifiant NPC est stock√© √† l'emplacement actuel, et dans [6,7] la sant√© actuelle du joueur est stock√©e (les 5 bits inf√©rieurs dans [6], les 5 plus anciens dans [7] ]).  √Ä ce stade, je suis pass√© des instructions de r√©tro-ing√©nierie √† l'annotation de mon code d√©sassembl√© et √† la r√©tro-ing√©nierie du programme lui-m√™me.  Voici ma dr√¥le de notation pour les valeurs 5 bits: <br><br><blockquote> <code>_start: <br> call init <br> <br> L4: <br> call check_moves <br> call print_menu <br> call handle_command <br> br 4 <br> <br> print_menu: <br> call print_itemname <br> print 83k # 'SELECT AN OPTION\x0e:\r\n\r\n\x0f\x00' <br> call print_moves <br> call print_npcmenu <br> call print_itemmenu <br> print 4ss # '\r\nYOUR CHOICE\x0e: \x0f\x00' <br> ret <br> <br> print_moves: <br> and 0y1, [1] <br> brz 2k <br> print 6ds # '\x0e- \x0fGO \x0e(\x0fS\x0e)\x0fOUTH\r\n\x00' <br> 2k: and 0y2, [1] <br> brz 39 <br> print 6f5 # '\x0e- \x0fGO \x0e(\x0fN\x0e)\x0fORTH\r\n\x00' <br> 39: and 0y4, [1] <br> brz 3u <br> print 6d8 # '\x0e- \x0fGO \x0e(\x0fE\x0e)\x0fAST\r\n\x00' <br> 3u: and 0y8, [1] <br> brz 4j <br> print 6eh # '\x0e- \x0fGO \x0e(\x0fW\x0e)\x0fEST\r\n\x00' <br> 4j: ret <br> <br> print_npcmenu: <br> add 0y0, [0] <br> brz 6m <br> sub 0y2, [0] <br> br&lt;c&gt; 5p <br> print 7o1 # '\x0e- (\x0fT\x0e)\x0fALK TO \x00' <br> call print_npcname <br> call print_crlf <br> 5p: sub 0y1, [0] <br> brz 6m <br> print 7n2 # '\x0e- (\x0fF\x0e)\x0fIGHT \x00' <br> call print_npcname <br> call print_crlf <br> 6m: ret <br> <br> print_itemmenu: <br> print 7nh # '\x0e- (\x0fD\x0e)\x0fRINK\r\n\x00' <br> print 765 # '\x0e- \x0fSHOW \x0e(\x0fI\x0e)\x0fNVENTORY\r\n\x00' <br> ret</code> </blockquote> <br>  Nous avons encore de nombreux opcodes inconnus, par exemple, bien que nous ayons d√©couvert que "qa" est une ramification conditionnelle sur z√©ro (branch-on-zero, brz), nous n'avons pas pu comprendre ce qu'est "qc" (indiqu√© ci-dessus comme br &lt;c&gt;).  Mais cela a suffi pour commencer √† comprendre la logique du programme. <br><br>  En fait, le jeu permet au joueur de se d√©placer sur une carte 8 √ó 8 sur laquelle des PNJ (dragons, taureaux rouges et humains) sont plac√©s au hasard.  Vous pouvez vous battre avec n'importe quel PNJ (m√™me Valis, malgr√© l'absence d'un √©l√©ment de menu correspondant).  Pendant la bataille, vous pouvez attaquer l'ennemi, provoquant une quantit√© al√©atoire de d√©g√¢ts ou de manque, apr√®s quoi l'ennemi attaque le joueur, provoquant √©galement une quantit√© al√©atoire de d√©g√¢ts ou de manque.  Vous pouvez √©galement choisir un verrou de bouclier, gr√¢ce auquel l'ennemi manque ou frappe le bouclier sans causer de d√©g√¢ts.  Enfin, vous pouvez tricher en augmentant votre sant√© √† 1000, mais dans ce cas, la variable cach√©e ("trich√©", adresse 10) est d√©finie sur 1. Si le joueur tue avec succ√®s l'ennemi, un objet tombe de lui, g√©n√©ralement une bouteille d'alcool (√©videmment, ce jeu n'est pas pour les enfants). <br><br>  Le NPC Valis principal, dont le joueur doit recevoir le drapeau, a une machine d'√©tat dans laquelle il demande au joueur plusieurs articles - un tas de boissons de taureau rouge (√©videmment obtenues en battant des ennemis de taureau rouge), diverses boissons m√©lang√©es (par exemple, gin et tonic - pour les obtenir, vous devez vaincre le dragon bleu et le dragon gris, puis m√©langer les objets qui en sont sortis), et la bande de puissance, qui peut √™tre obtenue si vous battez une autre personne PNJ dans le jeu (Redford) ou si vous l'aidez.  Si vous remplissez toute cette longue s√©rie de demandes, il vous donnera le drapeau, mais <em>seulement</em> si la variable ¬´trich√©¬ª n'est pas √©gal √† 1. Autrement dit, notre t√¢che est de gagner le jeu sans tricher.  Comme nous commen√ßons avec seulement 100 HP, comme tous les ennemis, avec le passage habituel, il sera impossible de vaincre tous les ennemis (pour obtenir tout ce dont vous avez besoin pour vaincre environ 20 adversaires).  Il est n√©cessaire de modifier le RNG d'une mani√®re ou d'une autre, afin que l'ennemi manque toujours. <br><br>  Les nombres al√©atoires sont g√©n√©r√©s par une fonction similaire √† une sorte de PRNG (adresse 37a), mais elle utilise des instructions uniques qui ne sont utilis√©es nulle part ailleurs, nous ne pouvons donc pas les inverser.  Cependant, nous avons remarqu√© qu'il charge son vecteur d'√©tat √† partir de trois adresses en m√©moire ([11], [12] et [13]), c'est-√†-dire que son √©tat complet ne prend que 15 bits.  Cela signifie que le RNG doit avoir une courte p√©riode - pas plus de 2 ^ 15 = 32768 de longueur. <br><br>  Alors que nous (en vain) essayions d'inverser la mise en ≈ìuvre du RNG, Jay Bosamia (@ jay_f0xtr0t) et Matthew Savage (@thebluepichu) ont impl√©ment√© un exploit.  En envoyant simplement la commande ¬´bouclier¬ª 100 000 fois de suite, nous avons pu obtenir une s√©quence de ¬´coups¬ª et de ¬´manques¬ª ennemis correspondant au bit √©mis par le RNG.  Nous nous sommes assur√©s que cette s√©quence se r√©p√®te avec une p√©riode de 32767. Gr√¢ce √† cela, nous avons pu assembler notre exploit principal - lorsque nous combattions avec le premier ennemi que nous avons rencontr√©, nous avons ferm√© nos boucliers 40 fois pour recr√©er la s√©quence de coups s√ªrs et manqu√©s, recherch√© cette s√©quence dans une grande s√©quence p√©riodique, puis d√©couvert quand prot√©ger et quand attaquer pour que l'ennemi manque toujours.  Ensuite, nous avons fait le tour de la carte en mode assassinhobo, tuant tout le monde et r√©cup√©rant leur butin.  √Ä la fin, nous sommes retourn√©s √† Valis et avons poliment demand√© notre drapeau, que nous avons re√ßu: <br><br><blockquote> <code>DrgnS{m4kin9-v4lis-happy-w1th-n4t1ve-b4ud0t-cpu}</code> </blockquote> <br>  Fuh!  En effet, une vraie aventure.  Je n'arrive toujours pas √† croire que nous sommes pass√©s d'une cha√Æne binaire et d'un manque total de documentation du processeur √† deux d√©sassembleurs presque complets et un code propre d√©sassembl√© en moins de 10 heures!  Tout le code est disponible sur GitHub: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">mon d√©sassembleur</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">le d√©sassembleur de Zachary</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">mon code brut d√©sassembl√©</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">mon code d√©sassembl√© annot√©</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Matt's Exploit client</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr468849/">https://habr.com/ru/post/fr468849/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr468837/index.html">Comment mener un entretien technique: un plan d'action pour les d√©butants</a></li>
<li><a href="../fr468841/index.html">Livraison continue pour votre biblioth√®que Kotlin Multiplatform</a></li>
<li><a href="../fr468843/index.html">Avez-vous peur de mettre en place un syst√®me CRM? Votre entreprise est peut-√™tre malade</a></li>
<li><a href="../fr468845/index.html">Un court cours de physiologie de la ville, ou parties du corps</a></li>
<li><a href="../fr468847/index.html">March√©s publics dans d'autres pays: pourquoi les lois ont besoin de cadres</a></li>
<li><a href="../fr468851/index.html">Impl√©mentation d'animation dans React Native</a></li>
<li><a href="../fr468853/index.html">L'histoire d'une application r√©ussie de SPR dans un projet Legacy</a></li>
<li><a href="../fr468859/index.html">¬´Routeur de pompage¬ª: r√©glage de l'√©quipement TP-Link pour les fournisseurs Internet</a></li>
<li><a href="../fr468861/index.html">Positive Technologies donne vie √† la ¬´ville piratable¬ª dans The Cyberbattle Standoff √† HITB + CyberWeek</a></li>
<li><a href="../fr468863/index.html">Internals Go: boucler les variables de boucle en fermeture</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>