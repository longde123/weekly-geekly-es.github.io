<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>   Migraci贸n perfecta (casi) entre las principales versiones de PostgreSQL utilizando replicaci贸n l贸gica   锔</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En True Engineering, en un proyecto, ha surgido la necesidad de cambiar la versi贸n de PostgreSQL de 9.6 a 11.1. 

 Por qu茅 La base de datos del proyec...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Migraci贸n perfecta (casi) entre las principales versiones de PostgreSQL utilizando replicaci贸n l贸gica</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/true_engineering/blog/437318/">  En True Engineering, en un proyecto, ha surgido la necesidad de cambiar la versi贸n de PostgreSQL de 9.6 a 11.1. <br><br>  Por qu茅  La base de datos del proyecto ya tiene un tama帽o de 1,5 Tb y est谩 creciendo.  El rendimiento es uno de los principales requisitos del sistema.  Y la estructura de datos en s铆 misma est谩 evolucionando: se agregan nuevas columnas, se cambian las existentes.  La nueva versi贸n de Postgres ha aprendido c贸mo trabajar de manera eficiente con la adici贸n de nuevas columnas con un valor predeterminado, por lo que no hay necesidad de cercar muletas personalizadas a nivel de aplicaci贸n.  Incluso en la nueva versi贸n, se agregaron varias formas nuevas de particionar tablas, lo que tambi茅n es extremadamente 煤til en condiciones de una gran cantidad de datos. <br><br>  Entonces, se decide, estamos migrando.  Por supuesto, puede generar una nueva versi贸n del servidor PostgreSQL en paralelo con el anterior, detener la aplicaci贸n, usar dump / restore (o pg_upgrade) para mover la base de datos y reiniciar la aplicaci贸n.  Esta soluci贸n no nos conven铆a debido al gran tama帽o de la base, adem谩s, la aplicaci贸n funciona en modo de combate, y solo quedan unos minutos para el tiempo de inactividad. <br><br>  Por lo tanto, decidimos probar la migraci贸n usando la replicaci贸n l贸gica en PostgreSQL usando un complemento de terceros llamado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">pglogical</a> . <br><br>  En el proceso de "prueba", nos encontramos con documentaci贸n muy fragmentaria sobre este proceso (y en ruso no lo es en absoluto), as铆 como algunas trampas y matices obvios.  En este art铆culo, queremos presentar nuestra experiencia en forma de tutorial. <br><br><img src="https://habrastorage.org/webt/cp/i7/oi/cpi7oixtsenmioqdrcyyotgagyk.png"><br><br>  <b>TL; DR</b> <br><br><ul><li>  Todo result贸 (no sin muletas, un art铆culo sobre ellos). </li><li>  Puede migrar dentro de la versi贸n PostgreSQL de 9.4 a 11.x, de cualquier versi贸n a cualquiera, hacia abajo o hacia arriba. </li><li>  El tiempo de inactividad es igual al tiempo que le toma a su aplicaci贸n volver a conectarse al nuevo servidor de base de datos (en nuestro caso, fue un reinicio de toda la aplicaci贸n, pero en la naturaleza, obviamente, "posibles opciones"). </li></ul><a name="habracut"></a><br><h3>  驴Por qu茅 no nos quedaba la soluci贸n de "frente"? </h3><br>  Como ya dijimos, la salida m谩s f谩cil es elevar la nueva versi贸n del servidor PostgreSQL en paralelo con la anterior, detener la aplicaci贸n, usar dump / restore (o pg_upgrade) para mover la base de datos e iniciar la aplicaci贸n nuevamente.  Para bases de datos de peque帽o volumen, en principio, esta es una opci贸n bastante adecuada (o, en el caso general, el volumen no es importante cuando tiene la opci贸n de tiempo de inactividad de la aplicaci贸n durante el per铆odo de "transfusi贸n" de la base de datos del servidor antiguo al nuevo, sin importar cu谩nto tiempo sea este tiempo).  Pero en nuestro caso, la base de datos ocupa aproximadamente 1,5 Tb en el disco, y moverla no es cuesti贸n de minutos, sino de varias horas.  La aplicaci贸n, a su vez, funciona en modo de combate, y realmente quer铆a evitar el tiempo de inactividad durante m谩s de un par de minutos. <br><br>  Tambi茅n contra esta opci贸n estaba el hecho de que usamos la replicaci贸n Maestro-Esclavo y no podemos apagar el servidor Esclavo del flujo de trabajo de manera segura.  Por lo tanto, para cambiar la aplicaci贸n de la versi贸n anterior de PostgreSQL a la nueva despu茅s de la migraci贸n del servidor maestro, ser铆a necesario preparar un nuevo servidor esclavo antes de iniciar la aplicaci贸n.  Y esto es unas pocas horas m谩s de tiempo de inactividad hasta que se crea el Esclavo (aunque mucho menos que la migraci贸n del Maestro). <br><br>  Por lo tanto, decidimos probar la migraci贸n usando la replicaci贸n l贸gica en PostgreSQL usando un complemento de terceros llamado pglogical. <br><br><h3>  Informaci贸n general </h3><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">pglogical</a> es un sistema de replicaci贸n l贸gica que utiliza decodificaci贸n l贸gica nativa en PostgreSQL e implementado como una extensi贸n de PostgreSQL.  Le permite configurar la replicaci贸n selectiva utilizando el modelo de suscripci贸n / publicaci贸n.  No requiere la creaci贸n de disparadores en la base de datos o el uso de utilidades externas para la replicaci贸n. <br><br>  La extensi贸n funciona en cualquier versi贸n de PostgreSQL, comenzando desde 9.4 (ya que la Decodificaci贸n l贸gica apareci贸 por primera vez en 9.4), y le permite migrar entre cualquier versi贸n compatible de PostgreSQL en cualquier direcci贸n. <br><br>  Configurar manualmente la replicaci贸n usando pglogical manualmente no es muy trivial, aunque en principio es bastante posible.  Afortunadamente, hay un programa de utilidad de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">terceros</a> para automatizar el proceso de configuraci贸n, que utilizaremos. <br><br><h3>  Memo de espacio en disco </h3><br>  Como planeamos actualizar la nueva versi贸n de PostgreSQL en los mismos servidores en paralelo con la anterior, los requisitos de disco para la base de datos en los servidores Maestro y Esclavo se duplican.  Parece que esto es obvio, pero ... Solo cuide suficiente espacio libre antes de comenzar la replicaci贸n para no lamentar los a帽os gastados sin rumbo. <br><br>  En nuestro caso, se requirieron modificaciones en la base de datos, m谩s el formato de almacenamiento durante la migraci贸n entre 9.6 y 11 "swells" no a favor de la 煤ltima versi贸n, por lo que el espacio en disco no tuvo que incrementarse en 2, sino en aproximadamente 2.2 veces.  Alabado sea LVM, esto se puede hacer en el proceso de migraci贸n sobre la marcha. <br><br>  En general, cu铆dalo. <br><br><h3>  Instalar PostgreSQL 11 en Master </h3><br><blockquote>  Nota: Utilizamos Oracle Linux, y todo lo siguiente se agudizar谩 para esta distribuci贸n.  Es posible que otras distribuciones de Linux requieran una peque帽a revisi贸n con un archivo, pero es poco probable que sea significativo. </blockquote><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   yum install https://download.postgresql.org/pub/repos/yum/11/redhat/rhel-7-x86_64/pgdg-oraclelinux11-11-2.noarch.rpm #   postgresql11 yum install postgresql11 postgresql11-devel postgresql11-server postgresql11-contrib #   /usr/pgsql-11/bin/postgresql-11-setup initdb</span></span></code> </pre> <br>  El antiguo datadir se encuentra en <b>/var/lib/pgsql/9.6/data</b> , el nuevo, respectivamente, est谩 en <b>/ var / lib / pgsql / 11 / data</b> <br><br>  Copie la configuraci贸n de acceso ( <b>pg_hba.conf</b> ) y la configuraci贸n del servidor ( <b>postgresql.conf</b> ) de 9.6 a 11. <br><br>  Para ejecutar dos servidores PostgreSQL en la misma m谩quina, en la configuraci贸n de configuraci贸n <b>postgresql.conf</b> 11, cambie el puerto a 15432 (puerto = 15432). <br><br>  Aqu铆 debe pensar detenidamente qu茅 m谩s debe hacer en la nueva versi贸n de PostgreSQL espec铆ficamente en su caso, para que comience con su <b>postgresql.conf</b> (y su aplicaci贸n eventualmente podr铆a funcionar con 茅l).  En nuestro caso, fue necesario instalar las extensiones PostgreSQL que usamos en la nueva versi贸n.  Esto est谩 m谩s all谩 del alcance del art铆culo, solo haga que el nuevo PostgreSQL se inicie, funcione y se adapte completamente a usted :) <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  ,  ,  shared libraries, whatever... # .... #  systemctl enable postgresql-11 systemctl start postgresql-11</span></span></code> </pre> <br>  Buscamos en <b>/ var / lib / pgsql / 11 / data / pg_log /</b> .  驴Est谩 todo bien?  Continuamos! <br><br><h3>  Instalar y configurar pgrepup </h3><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  python yum install python yum install python2-pip #  pgrepup pip install pgrepup #   pgrepup config</span></span></code> </pre> <br><img src="https://habrastorage.org/webt/zg/xz/9o/zgxz9oct5l-qglkxyeyrqejh4we.png"><br><br>  Matices: <br><br><ol><li>  Como <b>propietario de la aplicaci贸n,</b> especificamos el usuario bajo el cual se ejecutan los servidores PostgreSQL. </li><li>  Para <b>Base de datos,</b> especifique <b>template1</b> . </li><li>  <b>Nombre de usuario</b> y <b>contrase帽a</b> : datos para acceso de superusuario.  En nuestro caso, el m茅todo de <b>confianza</b> se especific贸 en <b>pg_hba.conf</b> para las conexiones locales del usuario de <b>postgres</b> , por lo que puede especificar una contrase帽a arbitraria. </li></ol><br><h3>  Configurar replicaci贸n </h3><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   pgrepup check</span></span></code> </pre><br>  Obtenemos la salida de una lista de muchos par谩metros que deben configurarse seg煤n sea necesario. <br><br>  Resultados de verificaci贸n de ejemplo: <br><br><img src="https://habrastorage.org/webt/h3/wu/zm/h3wuzmcevo7idf-xlyrz3ae8av8.png"><br><br><img src="https://habrastorage.org/webt/58/zh/bb/58zhbbubdbfvzzgat051bviywqy.png"><br><br>  Todos los errores durante la verificaci贸n deber谩n ser eliminados.  En la configuraci贸n de ambos servidores se debe establecer <b>wal_level = LOGICAL</b> (para que funcione la decodificaci贸n l贸gica), la configuraci贸n necesaria para el motor de replicaci贸n (n煤mero de slots y <b>wal_senders</b> ).  Las sugerencias de la utilidad pgrepup son bastante informativas; las preguntas no deber铆an surgir en la mayor铆a de los puntos. <br><br>  Realizamos todas las configuraciones necesarias que pgrepup solicita. <br><br>  En ambos archivos <b>pg_hba.conf</b> agregamos permisos para el usuario que realizar谩 la replicaci贸n, todo en el indicador pgrepup: <br><br><pre> <code class="bash hljs">host replication pgrepup_replication 127.0.0.1/32 md5 host all pgrepup_replication 127.0.0.1/32 md5</code> </pre> <br><h3>  Agregar claves primarias </h3><br>  Para que la replicaci贸n funcione, se debe definir una clave primaria en todas las tablas. <br><br>  En nuestro caso, PK no estaba en todas partes, por lo tanto, en el momento de la replicaci贸n, debe agregarlo y, al final de la replicaci贸n, si es necesario, eliminarlo. <br><br>  Una lista de tablas sin PK, entre otras cosas, produce la <code>pgrepup check</code> .  Para todas las tablas de esta lista, debe agregar una clave principal de la manera que m谩s le convenga.  En nuestro caso, fue algo como: <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> %s <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> temporary_pk <span class="hljs-type"><span class="hljs-type">BIGSERIAL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PRIMARY KEY</span></span></code> </pre> <br>  La utilidad pgrepup tiene un comando incorporado para llevar a cabo esta operaci贸n ( <code>pgrepup fix</code> ), y cuando se usa, incluso se da a entender que, tras una replicaci贸n exitosa, estas columnas temporales se eliminar谩n autom谩ticamente.  Pero, desafortunadamente, esta funcionalidad era tan ilusoria y encantadora con errores en grandes bases que decidimos no usarla, sino hacer esta operaci贸n manualmente ya que nos sentimos c贸modos. <br><br><h3>  Instalar extensi贸n pglogical </h3><br>  Las instrucciones para instalar la extensi贸n se pueden encontrar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu铆</a> .  La extensi贸n debe estar instalada en ambos servidores. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#       curl https://access.2ndquadrant.com/api/repository/dl/default/release/9.6/rpm | bash curl https://access.2ndquadrant.com/api/repository/dl/default/release/11/rpm | bash #   yum install postgresql96-pglogical postgresql11-pglogical</span></span></code> </pre> <br>  Agregue la carga de la biblioteca en <b>postgresql.conf de</b> ambos servidores: <br><br><pre> <code class="bash hljs">shared_preload_libraries = <span class="hljs-string"><span class="hljs-string">'pglogical'</span></span></code> </pre> <br><h3>  Instalar la extensi贸n pgl_ddl_deploy </h3><br>  Esta es una extensi贸n auxiliar que utiliza pgrepup para la replicaci贸n l贸gica DDL. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#      git clone https://github.com/enova/pgl_ddl_deploy.git #       PATH=/usr/pgsql-9.6/bin/:$PATH USE_PGXS=1 make USE_PGXS=1 make install make clean #       PATH=/usr/pgsql-11/bin/:$PATH make CLANG=true make install</span></span></code> </pre> <br>  Agregue la carga de la biblioteca en <b>postgresql.conf de</b> ambos servidores: <br><br><pre> <code class="bash hljs">shared_preload_libraries = <span class="hljs-string"><span class="hljs-string">'pglogical,pgl_ddl_deploy'</span></span></code> </pre> <br><h3>  Comprobaci贸n de cambios </h3><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   postgresql systemctl restart postgresql-11</span></span></code> </pre> <br>  Ahora, utilizando la <code>pgrepup check</code> , debe asegurarse de que todo est茅 bien con el servidor de destino y que todos los comentarios sobre el servidor de destino se hayan eliminado por completo. <br><br>  Si todo est谩 bien, puede reiniciar el servidor anterior.  Aqu铆 debe pensar c贸mo reaccionar谩 su aplicaci贸n ante el reinicio del servidor de base de datos, tal vez deber铆a detenerlo primero. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  systemctl restart postgresql-9.6 #  pgrepup check</span></span></code> </pre> <br>  Ahora en la salida del comando, todos los elementos deben estar marcados como OK. <br><br>  Parece que puedes comenzar la migraci贸n, pero ... <br><br><h3>  Corregir errores de pgrepup </h3><br>  Hay varios errores en la versi贸n actual de pgrepup que hacen imposible la migraci贸n.  Se enviaron solicitudes de extracci贸n, pero desafortunadamente, se ignoran, por lo que deber谩 realizar correcciones manualmente. <br><br>  Vamos a la carpeta de instalaci贸n de pgrepup (nuestro caso es <b>/usr/lib/python2.7/site-packages/pgrepup/commands/</b> ). <br><br>  Hazlo una vez.  En cada archivo <b>* .py</b> , agregue los <code>**kwargs</code> faltantes en la descripci贸n de la funci贸n.  Una imagen es mejor que mil palabras: <br><br><img src="https://habrastorage.org/webt/l3/zc/uo/l3zcuo2exe8lq_0u3gwv_nq8jty.png"><br><br>  Comprom茅tete <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu铆</a> . <br><br>  Hacer dos.  En <b>setup.py</b> hacemos una b煤squeda de "sh -c", dos entradas, todos los comandos de shell de varias l铆neas deben hacerse de una sola l铆nea. <br><br>  Comprom茅tete <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu铆</a> . <br><br><h3>  Comience la migraci贸n </h3><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  pgrepup setup</span></span></code> </pre> <br>  Con este comando, pgrepup prepara ambos servidores para iniciar la replicaci贸n, crea un usuario, configura pglogical y transfiere el esquema de la base de datos. <br><br><img src="https://habrastorage.org/webt/ww/km/jd/wwkmjdmmpmwyvgbdqyktohnhmmy.png"><br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   pgrepup start</span></span></code> </pre> <br>  l dijo: "隆Vamos!"  y agit贸 su mano: <br><br><img src="https://habrastorage.org/webt/3k/xc/_r/3kxc_rgde-t7q6yuhtvwkol5acs.png"><br><br>  La replicaci贸n se est谩 ejecutando.  La situaci贸n actual se puede ver usando el <code>pgrepup status</code> : <br><br><img src="https://habrastorage.org/webt/ig/gs/wb/iggswbqldii-c6cd5a1y7qyqawu.png"><br><br>  Aqu铆 vemos que dos bases de datos ya se han movido y la replicaci贸n est谩 en progreso, y una todav铆a est谩 en proceso de moverse.  Ahora solo queda tomar caf茅 y esperar hasta que se bombee todo el volumen de la base de datos original. <br><br>  En el camino, puede mirar m谩s profundamente en la fachada de pgrepup y ver qu茅 sucede debajo del cap贸.  Para las mentes inquisitivas, aqu铆 hay una lista de consultas como punto de partida: <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_replication_origin_status <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> remote_lsn <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> *,pg_xlog_location_diff(s.sent_location,s.replay_location) byte_lag <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_stat_replication s; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> query <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_stat_activity <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> application_name=<span class="hljs-string"><span class="hljs-string">'subscription_copy'</span></span></code> </pre> <br>  Teniendo mucho caf茅 (en el servidor de prueba al escribir este art铆culo, la migraci贸n de ~ 700Gb de datos dur贸 alrededor de un d铆a), finalmente vemos la siguiente imagen: <br><br><img src="https://habrastorage.org/webt/ep/2e/q2/ep2eq2c_mtywxboftk4ocb0e_1c.png"><br><br>  Y eso significa que es hora de preparar un nuevo Esclavo. <br><br><h3>  Instalar PostgreSQL 11 en Slave </h3><br>  Aqu铆 todo es simple y de acuerdo con el libro de texto, sin matices. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   yum install https://download.postgresql.org/pub/repos/yum/11/redhat/rhel-7-x86_64/pgdg-oraclelinux11-11-2.noarch.rpm #  postgresql 11 yum install postgresql11 postgresql11-devel postgresql11-server postgresql11-contrib #      su - postgres pg_basebackup -h db-master.hostname -p 15432 -D /var/lib/pgsql/11/data/ -R -P -U replication -X stream -c fast</span></span></code> </pre> <br>  Copie la configuraci贸n de acceso ( <b>pg_hba.conf</b> ) y la configuraci贸n del servidor ( <b>postgresql.conf</b> ) de 9.6 a 11. En la configuraci贸n de la versi贸n <b>postgresql.conf</b> 11, cambie el puerto a 15432 (puerto = 15432) <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  systemctl enable postgresql-11 systemctl start postgresql-11</span></span></code> </pre> <br><pre> <code class="pgsql hljs">#     Master <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> *,pg_wal_lsn_diff(s.sent_lsn,s.replay_lsn) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> byte_lag <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_stat_replication s; #     Slave <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> now()-pg_last_xact_replay_timestamp();</code> </pre><br><h3>  Subtotales </h3><br>  Despu茅s de todos estos procedimientos, obtenemos este complicado esquema de replicaci贸n: <br><br><img src="https://habrastorage.org/webt/70/ns/ej/70nsejcslxlccih_yktvesptqjg.png"><br><br>  Aqu铆, como verificaci贸n final (y, al final, es simplemente hermosa), puede hacer alguna ACTUALIZACIN en la base de datos maestra 9.6 y ver c贸mo se replica en los otros tres servidores. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7c0/c42/89e/7c0c4289e8a00b100f58ce751bd9209e.png" alt="imagen"><br><br><h3>  Cambiar la aplicaci贸n a la nueva versi贸n de PostgreSQL </h3><br>  Hasta ahora, nuestra aplicaci贸n no ha sospechado nada sobre la nueva versi贸n de PostgreSQL, es hora de solucionarlo.  Las opciones aqu铆 dependen fundamentalmente de solo dos cosas: <br>  驴Superar谩 los nuevos servicios en los mismos puertos en los que trabajaban los antiguos, <br>  y si su aplicaci贸n requiere un reinicio al reiniciar el servidor de bases de datos. <br><br>  Por diversi贸n, responderemos ambas preguntas "s铆" y procederemos. <br><br>  Paramos la aplicaci贸n. <br><br><pre> <code class="pgsql hljs"># ,   , : <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_stat_activity;</code> </pre> <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#    #       sequences. pgrepup stop</span></span></code> </pre> <br><img src="https://habrastorage.org/webt/cz/hc/2t/czhc2t8k6pjk-6ivvilidj5k9xq.png"><br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#      pgrepup uninstall</span></span></code> </pre><br><img src="https://habrastorage.org/webt/2w/ud/dq/2wuddqovqbninwwz9rx9fia8psa.png"><br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  master: #    systemctl disable postgresql-9.6 #   ,  ,  . systemctl stop postgresql-9.6 systemctl stop postgresql-11 #  slave: #    systemctl disable postgresql-9.6 #   ,  ,  . systemctl stop postgresql-9.6 systemctl stop postgresql-11</span></span></code> </pre> <br>  Devolvemos el puerto est谩ndar en la configuraci贸n <b>postgresql.conf</b> de la nueva versi贸n a Master and Slave. <br><br>  En el nuevo Slave, tambi茅n cambiamos el puerto al est谩ndar en <b>recovery.conf</b> . <br><br>  En el camino, hay una sugerencia de pecado para cambiar a煤n m谩s el puerto en la versi贸n antigua inactiva: <br>  Exponemos el puerto no est谩ndar en <b>postgresql.conf de la</b> versi贸n anterior a Master y Slave. <br>  En el viejo Slave, tambi茅n cambiamos el puerto a uno no est谩ndar en <b>recovery.conf</b> . <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   master systemctl enable postgresql-11 systemctl start postgresql-11 #   slave: systemctl enable postgresql-11 systemctl start postgresql-11</span></span></code> </pre> <br>  Revisa los registros. <br><br>  Verifique el estado de replicaci贸n en el maestro. <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> *,pg_wal_lsn_diff(s.sent_lsn,s.replay_lsn) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> byte_lag <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_stat_replication s;</code> </pre> <br>  Lanzamos la aplicaci贸n.  Estamos felices por media hora. <br><br>  <b>Y finalmente, literatura 煤til sobre el tema:</b> <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">pglogical</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Instrucciones de instalaci贸n para pglogical</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">documentos l贸gicos</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Actualizaci贸n de PostgreSQL de 9.4 a 10.3 con pglogical</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">pgrepup - actualiza PostgreSQL usando replicaci贸n l贸gica</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">pgrepup - PostgreSQL REPlicate y UPgrade</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Actualizaci贸n de PostgreSQL de 9.6 a 10 con un tiempo de inactividad m铆nimo utilizando pglogical</a> </li></ul><br>  Buena suerte </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/437318/">https://habr.com/ru/post/437318/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../437308/index.html">Ciclo de lecciones de SDL 2.0: Lecci贸n 4 - Manejo de eventos</a></li>
<li><a href="../437310/index.html">CSS Gradient Borders</a></li>
<li><a href="../437312/index.html">Implementaci贸n de una recarga en caliente de c贸digo C ++ en Linux y macOS: profundizando</a></li>
<li><a href="../437314/index.html">Enigma italiano: m谩quinas criptogr谩ficas OMI</a></li>
<li><a href="../437316/index.html">El Internet Development Institute ha nombrado sitios que pueden estar desconectados de RuNet desde el 1 de febrero</a></li>
<li><a href="../437320/index.html">ndice de desarrollo de la esfera medi谩tica 2018: estancamiento de la televisi贸n, mayor confianza en los medios informales</a></li>
<li><a href="../437322/index.html">El estado participa en BigDate</a></li>
<li><a href="../437324/index.html">Beso sangriento: propiedades de vasorelajaci贸n de la saliva de los murci茅lagos vampiros</a></li>
<li><a href="../437326/index.html">Sobre el tema de la multiplicaci贸n, extracci贸n de ra铆z cuadrada, sustituci贸n de importaciones y la empresa Milander</a></li>
<li><a href="../437330/index.html">devleads - habla sobre el agotamiento</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>