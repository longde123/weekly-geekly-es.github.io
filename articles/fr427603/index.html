<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üóûÔ∏è ‚ôçÔ∏è ‚õΩÔ∏è Comment enfin commencer √† √©crire des tests et ne pas le regretter üëç üì≥ üåµ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Venant √† un nouveau projet, je rencontre r√©guli√®rement l'une des situations suivantes: 



1. Il n'y a aucun test du tout. 
2. Il y a peu de tests, il...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment enfin commencer √† √©crire des tests et ne pas le regretter</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/custis/blog/427603/"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/webt/vr/v7/q_/vrv7q_kwfiqd5f7qx7jxwukv62g.jpeg"></a> <br><br>  Venant √† un nouveau projet, je rencontre r√©guli√®rement l'une des situations suivantes: <br><br><ol><li>  Il n'y a aucun test du tout. </li><li>  Il y a peu de tests, ils sont rarement √©crits et ne s'ex√©cutent pas de fa√ßon continue. </li><li>  Des tests sont pr√©sents et inclus dans CI (int√©gration continue), mais font plus de mal que de bien. </li></ol><br>  Malheureusement, c'est ce dernier sc√©nario qui conduit souvent √† de s√©rieuses tentatives pour commencer √† mettre en ≈ìuvre des tests en l'absence de comp√©tences appropri√©es. <br><br>  Que peut-on faire pour changer la situation actuelle?  L'id√©e d'utiliser des tests n'est pas nouvelle.  Dans le m√™me temps, la plupart des tutoriels ressemblent √† la c√©l√®bre image sur la fa√ßon de dessiner un hibou: connectez JUnit, √©crivez le premier test, utilisez la premi√®re maquette - et c'est parti!  De tels articles ne r√©pondent pas aux questions sur les tests qui doivent √™tre √©crits, √† quoi cela vaut la peine de pr√™ter attention et comment vivre avec tout cela.  De l√† est n√©e l'id√©e de cet article.  J'ai essay√© de r√©sumer bri√®vement mon exp√©rience dans la mise en ≈ìuvre de tests dans diff√©rents projets afin de faciliter ce chemin pour tout le monde. <br><a name="habracut"></a><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ra/7v/m-/ra7vm-kgn__gsmaeg6xg7aud4ey.jpeg"></div><br>  Il y a plus qu'assez d'articles introductifs sur ce sujet, donc nous ne nous r√©p√©terons pas et n'essaierons pas d'aller de l'autre c√¥t√©.  Dans la premi√®re partie, nous d√©mystifierons le mythe selon lequel les tests entra√Ænent exclusivement des co√ªts suppl√©mentaires.  Il sera montr√© comment la cr√©ation de tests de qualit√© peut √† son tour acc√©l√©rer le processus de d√©veloppement.  Ensuite, sur l'exemple d'un petit projet, les principes et r√®gles de base √† suivre pour r√©aliser cet avantage seront examin√©s.  Enfin, dans la derni√®re section, des recommandations sp√©cifiques de mise en ≈ìuvre seront donn√©es: comment √©viter les probl√®mes typiques lorsque les tests commencent, au contraire, ralentir consid√©rablement le d√©veloppement. <br><br>  Puisque ma sp√©cialisation principale est le backend Java, la pile technologique suivante sera utilis√©e dans les exemples: Java, JUnit, H2, Mockito, Spring, Hibernate.  Dans le m√™me temps, une partie importante de l'article est consacr√©e aux probl√®mes g√©n√©raux de test et les conseils qui s'y trouvent s'appliquent √† un √©ventail beaucoup plus large de t√¢ches. <br><br>  Attention cependant!  Les tests sont tr√®s addictifs: une fois que vous avez appris √† les utiliser, vous ne pouvez plus vous en passer. <br><br><div class="spoiler">  <b class="spoiler_title">Table des mati√®res</b> <div class="spoiler_text">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Tests vs vitesse de d√©veloppement</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Ex√©cuter du code en tout lieu</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Relancer les tests</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">D√©bogage</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Efficacit√©</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">De la th√©orie √† la pratique</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">D√©fi</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Mod√®le de domaine</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Structure du projet</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Tests d'int√©gration</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Tests unitaires</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Recommandations de mise en ≈ìuvre</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Conclusion</a> </div></div><br><a name="TestsVsSpeed"></a><h2>  Tests vs vitesse de d√©veloppement </h2><br>  Les principales questions qui se posent lors de l'examen de la mise en ≈ìuvre des tests: combien de temps faut-il pour √©crire des tests et quels avantages cela aura-t-il?  Les tests, comme toute autre technologie, n√©cessiteront de s√©rieux efforts de d√©veloppement et de mise en ≈ìuvre, de sorte qu'au d√©but, aucun avantage significatif ne devrait √™tre attendu.  Quant aux co√ªts de temps, ils d√©pendent fortement de l'√©quipe particuli√®re.  Cependant, moins de 20-30% des co√ªts suppl√©mentaires de codage ne doivent pas √™tre calcul√©s exactement.  Moins n'est tout simplement pas suffisant pour obtenir au moins un r√©sultat.  L'attente de retours instantan√©s est souvent la principale raison de limiter cette activit√© avant m√™me que les tests ne deviennent utiles. <br><br>  Mais de quelle efficacit√© parle-t-on?  Laissons tomber les paroles sur les difficult√©s de mise en ≈ìuvre et voyons quelles opportunit√©s sp√©cifiques pour gagner du temps s'ouvre. <br><br><a name="CodeRun"></a><h3>  Ex√©cuter du code en tout lieu </h3><br>  S'il n'y a pas de tests dans le projet, la seule fa√ßon de commencer est de soulever toute l'application.  C'est bien si cela prend environ 15 √† 20 secondes, mais les cas de grands projets dans lesquels un lancement complet peut prendre plusieurs minutes sont loin d'√™tre rares.  Qu'est-ce que cela signifie pour les d√©veloppeurs?  Une partie importante de leur temps de travail sera consacr√©e √† ces courtes sessions d'attente, au cours desquelles il est impossible de continuer √† travailler sur la t√¢che en cours, mais en m√™me temps, il y a trop peu de temps pour passer √† autre chose.  Beaucoup ont rencontr√© au moins une fois de tels projets o√π le code √©crit en une heure n√©cessite plusieurs heures de d√©bogage en raison de longs red√©marrages entre les corrections.  Dans les tests, vous pouvez vous limiter √† ex√©cuter de petites parties de l'application, ce qui r√©duira consid√©rablement le temps d'attente et augmentera la productivit√© du travail sur le code. <br><br>  De plus, la possibilit√© d'ex√©cuter du code n'importe o√π conduit √† un d√©bogage plus approfondi.  Souvent, la v√©rification m√™me des principaux cas d'utilisation positifs via l'interface de l'application n√©cessite beaucoup d'efforts et de temps.  La pr√©sence de tests permet d'effectuer une v√©rification d√©taill√©e d'une fonctionnalit√© sp√©cifique beaucoup plus facilement et plus rapidement. <br><br>  Un autre avantage est la possibilit√© de r√©guler la taille de l'unit√© test√©e.  Selon la complexit√© de la logique test√©e, vous pouvez vous limiter √† une m√©thode, une classe, un groupe de classes qui impl√©mentent certaines fonctionnalit√©s, un service, etc., jusqu'√† l'automatisation du test de l'application enti√®re.  Cette flexibilit√© vous permet de d√©charger des tests de haut niveau de nombreuses pi√®ces car ils seront test√©s √† des niveaux inf√©rieurs. <br><br><a name="RepeatedRun"></a><h3>  Relancer les tests </h3><br>  Cet avantage est souvent cit√© comme l'essence de l'automatisation des tests, mais regardons-le sous un angle moins familier.  Quelles nouvelles opportunit√©s ouvre-t-il aux d√©veloppeurs? <br><br>  Premi√®rement, chaque nouveau d√©veloppeur venu au projet pourra facilement ex√©cuter des tests existants pour comprendre la logique de l'application √† l'aide d'exemples.  Malheureusement, son importance est largement sous-estim√©e.  Dans les conditions modernes, les m√™mes personnes travaillent rarement sur un projet pendant plus de 1 √† 2 ans.  Et comme les √©quipes sont compos√©es de plusieurs personnes, l'apparition d'un nouveau participant tous les 2-3 mois est une situation typique pour des projets relativement importants.  Des projets particuli√®rement difficiles subissent des changements de g√©n√©rations enti√®res de d√©veloppeurs!  La possibilit√© de lancer facilement n'importe quelle partie de l'application et de regarder le comportement du syst√®me √† certains moments simplifie l'immersion de nouveaux programmeurs dans le projet.  De plus, une √©tude plus d√©taill√©e de la logique du code r√©duit le nombre d'erreurs commises en sortie et le temps de les d√©boguer √† l'avenir. <br><br>  Deuxi√®mement, la possibilit√© de v√©rifier facilement que l'application fonctionne correctement ouvre la voie √† une refactorisation continue.  Ce terme, malheureusement, est beaucoup moins populaire que CI.  Cela signifie que la refactorisation peut et doit √™tre effectu√©e chaque fois que le code est affin√©.  C'est pr√©cis√©ment le respect r√©gulier de la r√®gle notoire du scoutisme ¬´laissez le parking plus propre qu'avant votre arriv√©e¬ª qui vous permet d'√©viter la d√©gradation de la base du code et garantit au projet une vie longue et heureuse. <br><br><a name="Debugging"></a><h3>  D√©bogage </h3><br>  Le d√©bogage a d√©j√† √©t√© mentionn√© dans les paragraphes pr√©c√©dents, mais ce point est si important qu'il m√©rite un examen plus approfondi.  Malheureusement, il n'existe aucun moyen fiable de mesurer la relation entre le temps pass√© √† √©crire du code et √† le d√©boguer, car ces processus sont pratiquement ins√©parables les uns des autres.  N√©anmoins, la pr√©sence de tests de qualit√© dans le projet r√©duit consid√©rablement le temps de d√©bogage, jusqu'√† l'absence presque compl√®te de la n√©cessit√© d'ex√©cuter un d√©bogueur. <br><br><a name="Efficiency"></a><h3>  Efficacit√© </h3><br>  Tout ce qui pr√©c√®de peut consid√©rablement gagner du temps sur le d√©bogage initial du code.  Avec la bonne approche, seule celle-ci remboursera tous les co√ªts de d√©veloppement suppl√©mentaires.  Les bonus de test restants - l'am√©lioration de la qualit√© de la base de code (un code mal con√ßu est difficile √† tester), la r√©duction du nombre de d√©fauts, la possibilit√© de v√©rifier l'exactitude du code √† tout moment, etc. - deviendront presque gratuits. <br><br><a name="FromTheoryToPractice"></a><h2>  De la th√©orie √† la pratique </h2><br>  En termes, tout semble bon, mais passons aux choses s√©rieuses.  Comme mentionn√© pr√©c√©demment, il existe plus que suffisamment de documents sur la fa√ßon de proc√©der √† la configuration initiale de l'environnement de test.  Par cons√©quent, nous proc√©dons imm√©diatement au projet termin√©.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Sources ici.</a> <br><br><a name="Task"></a><h3>  D√©fi </h3><br>  En tant que t√¢che de mod√®le, consid√©rez un petit fragment du backend d'une boutique en ligne.  Nous allons √©crire une API typique pour travailler avec des produits: cr√©er, recevoir, √©diter.  Ainsi que quelques m√©thodes pour travailler avec les clients: changer un ¬´produit pr√©f√©r√©¬ª et calculer des points bonus pour une commande. <br><br><a name="DomainModel"></a><h3>  Mod√®le de domaine </h3><br>  Afin de ne pas surcharger l'exemple, nous nous limitons √† un ensemble minimal de champs et de classes. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/wc/pn/pz/wcpnpz94fmrb-av0-wkkuu4l2wi.jpeg"></div><br><br>  Le client a un nom d'utilisateur, un lien vers un produit pr√©f√©r√© et un drapeau indiquant s'il est un client premium. <br><br>  Produit (Produit) - nom, prix, remise et indicateur indiquant s'il est actuellement annonc√©. <br><br><a name="ProjectStructure"></a><h3>  Structure du projet </h3><br>  La structure du code de projet principal est la suivante. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ks/qa/m3/ksqam31c3vwkzdfwkmi8r7o3ggk.jpeg"></div><br><br>  Les classes sont en couches: <br><br><ul><li>  Mod√®le - mod√®le de domaine du projet; </li><li>  Jpa - r√©f√©rentiels pour travailler avec des bases de donn√©es bas√©es sur Spring Data; </li><li>  Service - logique m√©tier de l'application; </li><li>  Contr√¥leur - contr√¥leurs qui impl√©mentent l'API. </li></ul><br>  Structure de test unitaire. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/i3/_1/mi/i3_1micxy4kvvlb6dlgihfmmng0.jpeg"></div><br><br>  Les classes de test sont dans les m√™mes packages que le code d'origine.  De plus, un package avec des constructeurs pour la pr√©paration des donn√©es de test a √©t√© cr√©√©, mais plus sur ce qui suit. <br><br>  Il est pratique de s√©parer les tests unitaires et les tests d'int√©gration.  Ils ont souvent des d√©pendances diff√©rentes, et pour un d√©veloppement confortable, il devrait √™tre possible d'ex√©cuter l'un ou l'autre.  Cela peut √™tre r√©alis√© de diff√©rentes mani√®res: conventions de d√©nomination, modules, packages, sourceSets.  Le choix d'une m√©thode sp√©cifique est exclusivement une question de go√ªt.  Dans ce projet, les tests d'int√©gration se trouvent dans un sourceSet distinct - integrationTest. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/qq/1w/z7/qq1wz7n9tq77_zromu01ofx9cns.jpeg"></div><br><br>  Comme les tests unitaires, les classes avec des tests d'int√©gration sont dans les m√™mes packages que le code d'origine.  De plus, il existe des classes de base qui aident √† √©liminer la duplication de configuration et, si n√©cessaire, contiennent des m√©thodes universelles utiles. <br><br><a name="IntegrationTests"></a><h3>  Tests d'int√©gration </h3><br>  Il existe diff√©rentes approches pour d√©terminer les tests qui valent la peine de commencer.  Si la logique test√©e n'est pas tr√®s compliqu√©e, vous pouvez imm√©diatement passer √† celles d'int√©gration (elles sont parfois appel√©es celles d'acceptation).  Contrairement aux tests unitaires, ils s'assurent que l'application dans son ensemble fonctionne correctement. <br><br>  <b>L'architecture</b> <br><br>  Vous devez d'abord d√©cider √† quel niveau sp√©cifique les contr√¥les d'int√©gration seront effectu√©s.  Spring Boot offre une libert√© de choix totale: vous pouvez augmenter une partie du contexte, le contexte entier, et m√™me un serveur √† part enti√®re, accessible √† partir des tests.  √Ä mesure que la taille de l'application augmente, ce probl√®me devient de plus en plus complexe.  Souvent, vous devez √©crire diff√©rents tests √† diff√©rents niveaux. <br><br>  Un bon point de d√©part serait des tests de contr√¥leur sans d√©marrer le serveur.  Dans des applications relativement petites, il est tout √† fait acceptable de relever tout le contexte, car par d√©faut, il est r√©utilis√© entre les tests et initialis√© une seule fois.  Consid√©rez les m√©thodes de base de la classe <code>ProductController</code> : <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@PostMapping</span></span>(<span class="hljs-string"><span class="hljs-string">"new"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Product </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createProduct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@RequestBody Product product)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> productService.createProduct(product); } <span class="hljs-meta"><span class="hljs-meta">@GetMapping</span></span>(<span class="hljs-string"><span class="hljs-string">"{productId}"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Product </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getProduct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@PathVariable(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"productId"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> productId) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> productService.getProduct(productId); } <span class="hljs-meta"><span class="hljs-meta">@PostMapping</span></span>(<span class="hljs-string"><span class="hljs-string">"{productId}/edit"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updateProduct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@PathVariable(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"productId"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> productId, @RequestBody Product product) </span></span>{ productService.updateProduct(productId, product); }</code> </pre> <br>  La question de la gestion des erreurs est laiss√©e de c√¥t√©.  Supposons qu'il soit impl√©ment√© en externe sur la base d'une analyse des exceptions lev√©es.  Le code des m√©thodes est tr√®s simple, leur impl√©mentation dans le <code>ProductService</code> pas beaucoup plus compliqu√©e: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Transactional</span></span>(readOnly = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Product </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getProduct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Long productId)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> productRepository.findById(productId) .orElseThrow(() -&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DataNotFoundException(<span class="hljs-string"><span class="hljs-string">"Product"</span></span>, productId)); } <span class="hljs-meta"><span class="hljs-meta">@Transactional</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Product </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createProduct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Product product)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> productRepository.save(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Product(product)); } <span class="hljs-meta"><span class="hljs-meta">@Transactional</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Product </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updateProduct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Long productId, Product product)</span></span></span><span class="hljs-function"> </span></span>{ Product dbProduct = productRepository.findById(productId) .orElseThrow(() -&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DataNotFoundException(<span class="hljs-string"><span class="hljs-string">"Product"</span></span>, productId)); dbProduct.setPrice(product.getPrice()); dbProduct.setDiscount(product.getDiscount()); dbProduct.setName(product.getName()); dbProduct.setIsAdvertised(product.isAdvertised()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> productRepository.save(dbProduct); }</code> </pre> <br>  Le r√©f√©rentiel <code>ProductRepository</code> ne contient pas du tout ses propres m√©thodes: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProductRepository</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JpaRepository</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Product</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Long</span></span></span><span class="hljs-class">&gt; </span></span>{ }</code> </pre> <br>  Tout indique que ces classes n'ont pas besoin de tests unitaires simplement parce que toute la cha√Æne peut √™tre v√©rifi√©e facilement et efficacement par plusieurs tests d'int√©gration.  La duplication des m√™mes tests dans diff√©rents tests complique le d√©bogage.  En cas d'erreur dans le code, d√©sormais plus un test ne tombera, mais 10-15 √† la fois.  Cela n√©cessitera √† son tour une analyse plus approfondie.  S'il n'y a pas de duplication, le seul test tomb√© est susceptible d'indiquer imm√©diatement une erreur. <br><br>  <b>La configuration</b> <br><br>  Pour plus de commodit√©, nous mettons en √©vidence la classe de base <code>BaseControllerIT</code> , qui contient la configuration Spring et quelques champs: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(SpringRunner.class) <span class="hljs-meta"><span class="hljs-meta">@SpringBootTest</span></span>(webEnvironment = SpringBootTest.WebEnvironment.NONE) <span class="hljs-meta"><span class="hljs-meta">@Transactional</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseControllerIT</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> ProductRepository productRepository; <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> CustomerRepository customerRepository; }</code> </pre> <br>  Les r√©f√©rentiels sont d√©plac√©s vers la classe de base afin de ne pas encombrer les classes de test.  Leur r√¥le est exclusivement auxiliaire: pr√©parer les donn√©es et v√©rifier l'√©tat de la base de donn√©es apr√®s le travail du contr√¥leur.  Lorsque vous augmentez la taille de l'application, cela peut ne plus √™tre pratique, mais pour commencer, cela convient parfaitement. <br><br>  La configuration principale de Spring est d√©finie par les lignes suivantes: <br><br>  <code>@SpringBootTest</code> - utilis√© pour d√©finir le contexte de l'application.  <code>WebEnvironment.NONE</code> signifie qu'aucun contexte Web n'a besoin d'√™tre soulev√©. <br><br>  <code>@Transactional</code> - <code>@Transactional</code> tous les tests de classe dans une transaction avec restauration automatique pour enregistrer l'√©tat de la base de donn√©es. <br><br>  <b>Structure de test</b> <br><br>  Passons √† un ensemble minimaliste de tests pour la classe <code>ProductControllerIT</code> - <code>ProductControllerIT</code> . <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createProduct_productSaved</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Product product = product(<span class="hljs-string"><span class="hljs-string">"productName"</span></span>).price(<span class="hljs-string"><span class="hljs-string">"1.01"</span></span>).discount(<span class="hljs-string"><span class="hljs-string">"0.1"</span></span>).advertised(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>).build(); Product createdProduct = productController.createProduct(product); Product dbProduct = productRepository.getOne(createdProduct.getId()); assertEquals(<span class="hljs-string"><span class="hljs-string">"productName"</span></span>, dbProduct.getName()); assertEquals(number(<span class="hljs-string"><span class="hljs-string">"1.01"</span></span>), dbProduct.getPrice()); assertEquals(number(<span class="hljs-string"><span class="hljs-string">"0.1"</span></span>), dbProduct.getDiscount()); assertEquals(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, dbProduct.isAdvertised()); }</code> </pre> <br>  Le code de test doit √™tre extr√™mement simple et compr√©hensible en un coup d'≈ìil.  Si ce n'est pas le cas, la plupart des avantages des tests d√©crits dans la premi√®re section de l'article sont perdus.  Il est recommand√© de diviser le corps du test en trois parties qui peuvent √™tre visuellement s√©par√©es les unes des autres: pr√©parer les donn√©es, appeler la m√©thode de test, valider les r√©sultats.  Dans le m√™me temps, il est tr√®s souhaitable que le code de test s'adapte √† l'√©cran dans son ensemble. <br><br>  Personnellement, cela me semble plus √©vident lorsque les valeurs de test de la section de pr√©paration des donn√©es sont utilis√©es plus tard dans les v√©rifications.  Alternativement, vous pouvez comparer explicitement des objets, par exemple comme ceci: <br><br><pre> <code class="java hljs">assertEquals(product, dbProduct);</code> </pre> <br>  Dans un autre test de mise √† jour des informations produit ( <code>updateProduct</code> ), il est clair que la cr√©ation de donn√©es est devenue un peu plus compliqu√©e et pour maintenir l'int√©grit√© visuelle des trois parties du test, elles sont s√©par√©es par deux sauts de ligne cons√©cutifs: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updateProduct_productUpdated</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Product product = product(<span class="hljs-string"><span class="hljs-string">"productName"</span></span>).build(); productRepository.save(product); Product updatedProduct = product(<span class="hljs-string"><span class="hljs-string">"updatedName"</span></span>).price(<span class="hljs-string"><span class="hljs-string">"1.1"</span></span>).discount(<span class="hljs-string"><span class="hljs-string">"0.5"</span></span>).advertised(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>).build(); updatedProduct.setId(product.getId()); productController.updateProduct(product.getId(), updatedProduct); Product dbProduct = productRepository.getOne(product.getId()); assertEquals(<span class="hljs-string"><span class="hljs-string">"updatedName"</span></span>, dbProduct.getName()); assertEquals(number(<span class="hljs-string"><span class="hljs-string">"1.1"</span></span>), dbProduct.getPrice()); assertEquals(number(<span class="hljs-string"><span class="hljs-string">"0.5"</span></span>), dbProduct.getDiscount()); assertEquals(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, dbProduct.isAdvertised()); }</code> </pre> <br>  Chacune des trois parties de la p√¢te peut √™tre simplifi√©e.  Pour la pr√©paration des donn√©es, les g√©n√©rateurs de tests sont excellents, qui contiennent la logique de cr√©ation d'objets qui est pratique √† utiliser √† partir de tests.  Des appels de m√©thode trop complexes peuvent √™tre effectu√©s en m√©thodes auxiliaires √† l'int√©rieur des classes de test, masquant certains des param√®tres qui ne sont pas pertinents pour cette classe.  Pour simplifier les v√©rifications complexes, vous pouvez √©galement √©crire des fonctions auxiliaires ou impl√©menter vos propres correspondants.  L'essentiel de toutes ces simplifications est de ne pas perdre la visibilit√© du test: tout doit √™tre clair en un coup d'≈ìil sur la m√©thode principale, sans avoir besoin d'approfondir. <br><br>  <b>Constructeurs de tests</b> <br><br>  Les constructeurs de tests m√©ritent une attention particuli√®re.  L'encapsulation de la logique de cr√©ation d'objets simplifie la maintenance des tests.  En particulier, le remplissage des champs du mod√®le qui ne sont pas pertinents pour ce test peut √™tre masqu√© dans le g√©n√©rateur.  Pour ce faire, vous n'avez pas √† le cr√©er directement, mais utilisez une m√©thode statique qui remplira les champs manquants avec des valeurs par d√©faut.  Par exemple, si de nouveaux champs obligatoires apparaissent dans le mod√®le, ils peuvent √™tre facilement ajout√©s √† cette m√©thode.  Dans <code>ProductBuilder</code> cela ressemble √† ceci: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> ProductBuilder </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">product</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProductBuilder() .name(name) .advertised(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) .price(<span class="hljs-string"><span class="hljs-string">"0.00"</span></span>); }</code> </pre> <br>  <b>Nom du test</b> <br><br>  Il est imp√©ratif de comprendre ce qui est sp√©cifiquement test√© dans ce test.  Pour plus de clart√©, il est pr√©f√©rable de donner une r√©ponse √† cette question dans son titre.  En utilisant les exemples de tests pour la m√©thode <code>getProduct</code> consid√©rez la convention de d√©nomination utilis√©e: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getProduct_oneProductInDb_productReturned</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Product product = product(<span class="hljs-string"><span class="hljs-string">"productName"</span></span>).build(); productRepository.save(product); Product result = productController.getProduct(product.getId()); assertEquals(<span class="hljs-string"><span class="hljs-string">"productName"</span></span>, result.getName()); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getProduct_twoProductsInDb_correctProductReturned</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Product product1 = product(<span class="hljs-string"><span class="hljs-string">"product1"</span></span>).build(); Product product2 = product(<span class="hljs-string"><span class="hljs-string">"product2"</span></span>).build(); productRepository.save(product1); productRepository.save(product2); Product result = productController.getProduct(product1.getId()); assertEquals(<span class="hljs-string"><span class="hljs-string">"product1"</span></span>, result.getName()); }</code> </pre> <br>  Dans le cas g√©n√©ral, l'en-t√™te de la m√©thode de test se compose de trois parties, s√©par√©es par un soulignement: le nom de la m√©thode test√©e, le script et le r√©sultat attendu.  Cependant, personne n'a annul√© le bon sens, et il peut √™tre justifi√© d'omettre certaines parties du nom si elles ne sont pas n√©cessaires dans ce contexte (par exemple, un script dans un seul test pour cr√©er un produit).  Le but de cette d√©nomination est de s'assurer que l'essence de chaque test est compr√©hensible sans apprendre le code.  Cela rend la fen√™tre des r√©sultats des tests aussi claire que possible, et c'est avec elle que le travail avec les tests commence g√©n√©ralement. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/gu/0k/p9/gu0kp9p5hdbswo4i8d6ti2sy1qi.jpeg"></div><br><br>  <b>Conclusions</b> <br><br>  C‚Äôest tout.  Pour la premi√®re fois, un ensemble minimal de quatre tests suffit pour tester les m√©thodes de la classe <code>ProductController</code> .  En cas de d√©tection de bugs, vous pouvez toujours ajouter les tests manquants.  Dans le m√™me temps, le nombre minimum de tests r√©duit consid√©rablement le temps et les efforts n√©cessaires pour les prendre en charge.  Ceci, √† son tour, est essentiel dans le processus de mise en ≈ìuvre des tests, car les premiers tests sont g√©n√©ralement obtenus de mauvaise qualit√© et cr√©ent de nombreux probl√®mes inattendus.  Dans le m√™me temps, une telle suite de tests est largement suffisante pour recevoir les bonus d√©crits dans la premi√®re partie de l'article. <br><br>  Il convient de noter que ces tests ne v√©rifient pas la couche Web de l'application, mais souvent cela n'est pas n√©cessaire.  Si n√©cessaire, vous pouvez √©crire des tests distincts pour la couche Web avec un stub au lieu de la base ( <code>@WebMvcTest</code> , <code>MockMvc</code> , <code>@MockBean</code> ) ou utiliser un serveur √† part enti√®re.  Ce dernier peut compliquer le d√©bogage et compliquer le travail avec les transactions, car le test ne peut pas contr√¥ler la transaction du serveur.  Un exemple d'un tel test d'int√©gration peut √™tre trouv√© dans la classe <code>CustomerControllerServerIT</code> . <br><br><a name="UnitTests"></a><h3>  Tests unitaires </h3><br>  Les tests unitaires pr√©sentent plusieurs avantages par rapport aux tests d'int√©gration: <br><br><ul><li>  Le d√©marrage prend des millisecondes; </li><li>  Petite taille de l'unit√© test√©e; </li><li>  Il est facile de mettre en ≈ìuvre la v√©rification d'un grand nombre d'options, car lorsque la m√©thode est appel√©e directement, la pr√©paration des donn√©es est grandement simplifi√©e. </li></ul><br>  Malgr√© cela, les tests unitaires de par leur nature ne peuvent garantir l'op√©rabilit√© de l'application dans son ensemble et ne vous permettent pas d'√©viter d'√©crire des tests d'int√©gration.  Si la logique de l'unit√© test√©e est simple, la duplication des tests d'int√©gration avec les tests unitaires n'apportera aucun avantage, mais ajoutera seulement plus de code √† prendre en charge. <br><br>  La seule classe de cet exemple qui m√©rite des tests unitaires est le <code>BonusPointCalculator</code> .  Sa caract√©ristique distinctive est un grand nombre de branches de la logique m√©tier.  Par exemple, on suppose que l'acheteur re√ßoit des bonus de 10% du co√ªt du produit, multipli√©s par pas plus de 2 multiplicateurs de la liste suivante: <br><br><ul><li>  Le produit co√ªte plus de 10 000 (√ó 4); </li><li>  Le produit participe √† une campagne publicitaire (√ó 3); </li><li>  Le produit est le produit ¬´pr√©f√©r√©¬ª du client (√ó 5); </li><li>  Le client a un statut premium (√ó 2); </li><li>  Si le client a un statut premium et ach√®te un produit ¬´pr√©f√©r√©¬ª, au lieu des deux multiplicateurs indiqu√©s, un (√ó 8) est utilis√©. </li></ul><br>  Dans la vraie vie, bien s√ªr, il vaudrait la peine de concevoir un m√©canisme universel flexible pour calculer ces bonus, mais pour simplifier l'exemple, nous nous limitons √† une impl√©mentation fixe.  Le code de calcul du multiplicateur ressemble √† ceci: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> List&lt;BigDecimal&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">calculateMultipliers</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Customer customer, Product product)</span></span></span><span class="hljs-function"> </span></span>{ List&lt;BigDecimal&gt; multipliers = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (customer.getFavProduct() != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; customer.getFavProduct().equals(product)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (customer.isPremium()) { multipliers.add(PREMIUM_FAVORITE_MULTIPLIER); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { multipliers.add(FAVORITE_MULTIPLIER); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (customer.isPremium()) { multipliers.add(PREMIUM_MULTIPLIER); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (product.isAdvertised()) { multipliers.add(ADVERTISED_MULTIPLIER); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (product.getPrice().compareTo(EXPENSIVE_THRESHOLD) &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { multipliers.add(EXPENSIVE_MULTIPLIER); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> multipliers; }</code> </pre> <br>  Un grand nombre d'options conduit au fait que deux ou trois tests d'int√©gration ne sont pas limit√©s ici.  Un ensemble minimaliste de tests unitaires est parfait pour d√©boguer une telle fonctionnalit√©. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/bk/jw/ai/bkjwai9dy1mrxxarxncx6jgfehq.jpeg"></div><br><br>  La suite de tests correspondante se trouve dans la classe <code>BonusPointCalculatorTest</code> .  En voici quelques uns: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">calculate_oneProduct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Product product = product(<span class="hljs-string"><span class="hljs-string">"product"</span></span>).price(<span class="hljs-string"><span class="hljs-string">"1.00"</span></span>).build(); Customer customer = customer(<span class="hljs-string"><span class="hljs-string">"customer"</span></span>).build(); Map&lt;Product, Long&gt; quantities = mapOf(product, <span class="hljs-number"><span class="hljs-number">1L</span></span>); BigDecimal bonus = bonusPointCalculator.calculate(customer, list(product), quantities::get); BigDecimal expectedBonus = bonusPoints(<span class="hljs-string"><span class="hljs-string">"0.10"</span></span>).build(); assertEquals(expectedBonus, bonus); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">calculate_favProduct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Product product = product(<span class="hljs-string"><span class="hljs-string">"product"</span></span>).price(<span class="hljs-string"><span class="hljs-string">"1.00"</span></span>).build(); Customer customer = customer(<span class="hljs-string"><span class="hljs-string">"customer"</span></span>).favProduct(product).build(); Map&lt;Product, Long&gt; quantities = mapOf(product, <span class="hljs-number"><span class="hljs-number">1L</span></span>); BigDecimal bonus = bonusPointCalculator.calculate(customer, list(product), quantities::get); BigDecimal expectedBonus = bonusPoints(<span class="hljs-string"><span class="hljs-string">"0.10"</span></span>).addMultiplier(FAVORITE_MULTIPLIER).build(); assertEquals(expectedBonus, bonus); }</code> </pre> <br>  Il convient de noter que dans les tests, nous nous r√©f√©rons sp√©cifiquement √† l'API publique de la classe - la m√©thode de <code>calculate</code> .  Tester un contrat de classe plut√¥t que son impl√©mentation √©vite les pannes de tests dues √† des changements non fonctionnels et √† une refactorisation. <br><br>  Enfin, lorsque nous avons v√©rifi√© la logique interne avec des tests unitaires, nous n'avons plus besoin de mettre tous ces d√©tails en int√©gration.  Dans ce cas, un test plus ou moins repr√©sentatif suffit, par exemple ceci: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">calculateBonusPoints_twoProductTypes_correctValueCalculated</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Product product1 = product(<span class="hljs-string"><span class="hljs-string">"product1"</span></span>).price(<span class="hljs-string"><span class="hljs-string">"1.01"</span></span>).build(); Product product2 = product(<span class="hljs-string"><span class="hljs-string">"product2"</span></span>).price(<span class="hljs-string"><span class="hljs-string">"10.00"</span></span>).build(); productRepository.save(product1); productRepository.save(product2); Customer customer = customer(<span class="hljs-string"><span class="hljs-string">"customer"</span></span>).build(); customerRepository.save(customer); Map&lt;Long, Long&gt; quantities = mapOf(product1.getId(), <span class="hljs-number"><span class="hljs-number">1L</span></span>, product2.getId(), <span class="hljs-number"><span class="hljs-number">2L</span></span>); BigDecimal bonus = customerController.calculateBonusPoints( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CalculateBonusPointsRequest(<span class="hljs-string"><span class="hljs-string">"customer"</span></span>, quantities) ); BigDecimal bonusPointsProduct1 = bonusPoints(<span class="hljs-string"><span class="hljs-string">"0.10"</span></span>).build(); BigDecimal bonusPointsProduct2 = bonusPoints(<span class="hljs-string"><span class="hljs-string">"1.00"</span></span>).quantity(<span class="hljs-number"><span class="hljs-number">2</span></span>).build(); BigDecimal expectedBonus = bonusPointsProduct1.add(bonusPointsProduct2); assertEquals(expectedBonus, bonus); }</code> </pre> <br>  Comme dans le cas des tests d'int√©gration, l'ensemble de tests unitaires utilis√© est tr√®s petit et ne garantit pas l'exactitude compl√®te de l'application.  N√©anmoins, sa pr√©sence augmente consid√©rablement la confiance dans le code, facilite le d√©bogage et donne aux autres bonus list√©s dans la premi√®re partie de l'article. <br><br><a name="ImplementationConsiderations"></a><h2>  Recommandations de mise en ≈ìuvre </h2><br>  J'esp√®re que les sections pr√©c√©dentes ont √©t√© suffisantes pour convaincre au moins un d√©veloppeur d'essayer de commencer √† utiliser des tests dans son projet.  Ce chapitre √©num√©rera bri√®vement les principales recommandations qui aideront √† √©viter de graves probl√®mes et √† r√©duire les co√ªts initiaux de mise en ≈ìuvre. <br><br>  <b>Essayez de commencer √† impl√©menter les tests sur la nouvelle application.</b>  La r√©daction des premiers tests dans un grand projet h√©rit√© sera beaucoup plus difficile et n√©cessitera plus de comp√©tences que dans un projet fra√Æchement cr√©√©.  Par cons√©quent, si possible, il est pr√©f√©rable de commencer avec une petite nouvelle application.  Si de nouvelles applications √† part enti√®re ne sont pas attendues, vous pouvez essayer de d√©velopper un utilitaire utile √† usage interne.  L'essentiel est que la t√¢che soit plus ou moins r√©aliste - les exemples invent√©s ne donneront pas une exp√©rience √† part enti√®re. <br><br>  <b>Configurez des tests r√©guliers.</b>  Si les tests ne sont pas ex√©cut√©s r√©guli√®rement, ils cessent non seulement d'ex√©cuter leur fonction principale - v√©rifier l'exactitude du code - mais aussi deviennent rapidement obsol√®tes.  Par cons√©quent, il est extr√™mement important de configurer au moins le pipeline CI minimum avec un lancement automatique des tests chaque fois que le code est mis √† jour dans le r√©f√©rentiel. <br><br>  <b>Ne poursuivez pas le couvercle.</b>  Comme dans le cas de toute autre technologie, au d√©but, les tests ne seront pas obtenus de la meilleure qualit√©.  La litt√©rature pertinente (liens √† la fin de l'article) ou un mentor comp√©tent peut vous aider ici, mais cela n'annule pas le besoin de c√¥nes √† farce.  Les tests √† cet √©gard sont similaires au reste du code: pour comprendre comment ils affecteront le projet, vous ne pouvez qu'apr√®s avoir v√©cu avec eux pendant un certain temps.  Par cons√©quent, pour minimiser les dommages, la premi√®re fois est pr√©f√©rable de ne pas chasser le nombre et les beaux chiffres comme une couverture √† cent pour cent.  Au lieu de cela, vous devez vous limiter aux principaux sc√©narios positifs pour votre propre fonctionnalit√© d'application. <br><br>  <b>Ne vous laissez pas emporter par les tests unitaires.</b>  En poursuivant le th√®me ¬´quantit√© vs qualit√©¬ª, il convient de noter que des tests unitaires honn√™tes ne doivent pas √™tre effectu√©s pour la premi√®re fois, car cela peut facilement conduire √† une sp√©cification excessive de l'application.  √Ä son tour, cela deviendra un facteur inhibiteur s√©rieux dans les am√©liorations ult√©rieures de refactorisation et d'application.  Les tests unitaires ne doivent √™tre utilis√©s que s'il existe une logique complexe dans une classe ou un groupe de classes particulier, ce qui n'est pas pratique √† v√©rifier au niveau de l'int√©gration. <br><br>  <b>Ne vous laissez pas emporter par les classes de stub et les m√©thodes d'application.</b>  Les talons (talon, maquette) sont un autre outil qui n√©cessite une approche √©quilibr√©e et le maintien d'un √©quilibre.  D'une part, l'isolement complet de l'unit√© vous permet de vous concentrer sur la logique test√©e et de ne pas penser au reste du syst√®me.  En revanche, cela n√©cessitera un temps de d√©veloppement suppl√©mentaire et, comme pour les tests unitaires, peut conduire √† une sp√©cification excessive du comportement. <br><br>  <b>D√©tachez les tests d'int√©gration des syst√®mes externes.</b>  Une erreur tr√®s courante dans les tests d'int√©gration est l'utilisation d'une base de donn√©es r√©elle, de files d'attente de messages et d'autres syst√®mes externes √† l'application.  Bien s√ªr, la possibilit√© d'ex√©cuter un test dans un environnement r√©el est utile pour le d√©bogage et le d√©veloppement.  De tels tests en petites quantit√©s peuvent avoir un sens, en particulier pour une ex√©cution interactive.  Cependant, leur utilisation g√©n√©ralis√©e entra√Æne un certain nombre de probl√®mes: <br><br><ol><li>  Pour ex√©cuter les tests, vous devrez configurer l'environnement externe.  Par exemple, installez une base de donn√©es sur chaque machine sur laquelle l'application sera assembl√©e.  Cela rendra difficile pour les nouveaux d√©veloppeurs d'entrer dans le projet et de configurer CI. </li><li>  L'√©tat des syst√®mes externes peut varier sur diff√©rentes machines avant d'ex√©cuter les tests.  Par exemple, la base de donn√©es peut d√©j√† contenir les tables dont l'application a besoin avec des donn√©es qui ne sont pas attendues dans le test.  Cela entra√Ænera des √©checs impr√©visibles dans les tests et leur √©limination n√©cessitera un temps consid√©rable. </li><li>  Si des travaux parall√®les sont en cours sur plusieurs projets, l'influence non √©vidente de certains projets sur d'autres est possible.  Par exemple, des param√®tres de base de donn√©es sp√©cifiques d√©finis pour l'un des projets peuvent aider la fonctionnalit√© d'un autre projet √† fonctionner correctement, qui, cependant, se brisera lors du lancement sur une base de donn√©es propre sur une autre machine. </li><li>  Les tests sont effectu√©s pendant une longue p√©riode: un cycle complet peut atteindre des dizaines de minutes.  Cela conduit au fait que les d√©veloppeurs arr√™tent d'ex√©cuter des tests localement et ne regardent leurs r√©sultats qu'apr√®s avoir envoy√© les modifications au r√©f√©rentiel distant.  Ce comportement annule la plupart des avantages des tests, qui ont √©t√© discut√©s dans la premi√®re partie de l'article. </li></ol><br>  <b>Effacez le contexte entre les tests d'int√©gration.</b>  Souvent, pour acc√©l√©rer le travail des tests d'int√©gration, vous devez r√©utiliser le m√™me contexte entre eux.  M√™me la documentation officielle de Spring fait une telle recommandation.  En m√™me temps, l'influence des tests les uns sur les autres doit √™tre √©vit√©e.  Puisqu'elles sont lanc√©es dans un ordre arbitraire, la pr√©sence de telles connexions peut conduire √† des erreurs irr√©prochables al√©atoires.  Pour √©viter que cela ne se produise, les tests ne doivent laisser aucun changement de contexte.  Par exemple, lors de l'utilisation d'une base de donn√©es, pour l'isolement, il suffit g√©n√©ralement d'annuler toutes les transactions valid√©es dans le test.  Si les modifications du contexte ne peuvent pas √™tre √©vit√©es, vous pouvez configurer sa recr√©ation √† l'aide de l'annotation <code>@DirtiesContext</code> . <br><br> <b>  ,      .</b>         ,       - .    ,            .  ,   , ‚Äî      ,           . <br><br> <b>      .</b>      ,    ,       . ,    ,       . <br><br> <b>   TDD (Test-Driven Development).</b> TDD    ,      ,     .  ,        ,     .   ,         ,        . <br><br><h2>   ,  ? </h2><br>              ,  : <br><br><ol><li>       (  )?             . </li><li>           ,      ( ,  CI)?    . </li><li>     ?                     . </li><li>     ?    .   ,      ,      . </li></ol><br>        ,      .     , , -   .   ‚Äî           . <br><br><a name="Conclusion"></a><h2>  Conclusion </h2><br>       ,     .    -    ,    .  ,  -      .        ‚Äî         ,      ,    -.      ,                 . <br><br> ,    ,        ,            ! <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">   GitHub</a> <br><br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Growing Object-Oriented Software, Guided by Tests</a> , Steve Freeman, Nat Pryce <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">The Art of Unit Testing</a> , Roy Osherove <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Test-driven Development: By Example</a> , Kent Beck <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Refactoring: Improving the Design of Existing Code</a> , Martin Fowler <br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr427603/">https://habr.com/ru/post/fr427603/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr427589/index.html">Nous √©crivons un chat en ligne sur Websockets en utilisant Swoole</a></li>
<li><a href="../fr427591/index.html">L'architecture comme fardeau</a></li>
<li><a href="../fr427593/index.html">Quick Command Magic dans Vivaldi 2.1</a></li>
<li><a href="../fr427595/index.html">Essayez Micronaut ou Darling, j'ai r√©duit le cadre</a></li>
<li><a href="../fr427601/index.html">Cas 5 + 1 o√π la sp√©cification de l'API REST joue un r√¥le √©norme</a></li>
<li><a href="../fr427605/index.html">Comment la plateforme de crowdsourcing Yandex aide √† former des drones et √† √©valuer la qualit√© de service</a></li>
<li><a href="../fr427607/index.html">Datacenter en Suisse: travailler comme sur des roulettes</a></li>
<li><a href="../fr427609/index.html">R√©solution de l'√©quation avec division enti√®re sans force brute</a></li>
<li><a href="../fr427611/index.html">L'histoire de la fa√ßon dont j'ai mis √† jour Yandex MapKit sur iOS ou des cartes, de l'argent, 2 mappits</a></li>
<li><a href="../fr427613/index.html">10 blogs utiles pour les programmeurs en anglais</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>