<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>   Gateway para UDP entre Wi-Fi y LoRa  帮 </title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hacemos la puerta de enlace entre Wi-Fi y LoRa para UDP 





 Tuve un sue帽o infantil: dar a cada dispositivo dom茅stico "sin Wi-Fi" un ticket de red, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Gateway para UDP entre Wi-Fi y LoRa</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/482080/"><h1 id="delaem-shlyuz-mezhdu-wi-fi-i-lora-dlya-udp">  Hacemos la puerta de enlace entre Wi-Fi y LoRa para UDP </h1><br><p><img src="https://habrastorage.org/webt/7r/6w/qs/7r6wqsteous5ebxb2pjrlplmqbm.png"></p><br><p>  Tuve un sue帽o infantil: dar a cada dispositivo dom茅stico "sin Wi-Fi" un ticket de red, es decir, una direcci贸n IP y un puerto.  Despu茅s de un tiempo, me di cuenta de que no deb铆a posponerlo.  Debemos tomar y hacer. </p><br><h2 id="tehnicheskoe-zadanie">  T茅rminos de referencia </h2><br><p>  Convi茅rtalo en una puerta de enlace M5Stack con el m贸dulo LoRa instalado (Figura 1).  La puerta de enlace se conectar谩 a una red Wi-Fi para obtener una direcci贸n IP local a trav茅s de DHCP.  La puerta de enlace transmitir谩 su nombre en LoRa-ether con una cierta frecuencia (an谩logo de SSID para Wi-Fi) y el rango de puertos aceptables para que otros dispositivos sepan que existe una red a la que puede conectarse y en qu茅 rango puede seleccionar un puerto libre.  Dado que este ser谩 un prototipo, la autenticaci贸n no es esta vez.  Los nuevos dispositivos cliente encontrar谩n una red LoRa disponible y le transmitir谩n el puerto seleccionado.  Despu茅s de que la puerta de enlace ha recibido un puerto de un nuevo cliente, comprueba si est谩 libre, si es as铆, registra un nuevo cliente y comienza a escuchar este puerto en su propio servidor UDP as铆ncrono.  Despu茅s del registro, el cliente recibir谩 el consentimiento o la negativa a utilizar el puerto declarado.  El procedimiento operativo se muestra en la tabla 1. </p><br><p><img src="https://habrastorage.org/webt/cz/am/ab/czamabsepozwcixjn0rdwe7hmw8.png"><br>  Figura 1 </p><br><p>  Tabla 1 </p><br><div class="scrollable-table"><table><thead><tr><th>  lado </th><th>  direcci贸n y datos </th><th>  lado </th><th>  la sesi贸n </th></tr></thead><tbody><tr><td>  [cliente] </td><td>  &lt;- se帽al de baliza - </td><td>  [puerta de enlace] </td><td>  0xA1 </td></tr><tr><td>  [cliente] </td><td>  - puerto seleccionado -&gt; </td><td>  [puerta de enlace] </td><td>  0xB1 </td></tr><tr><td>  [cliente] </td><td>  &lt;- consentimiento o rechazo - </td><td>  [puerta de enlace] </td><td>  0xA2 </td></tr><tr><td>  [cliente] </td><td>  - Paquete UPD -&gt; </td><td>  [puerta de enlace] </td><td>  0xB2 </td></tr><tr><td>  [cliente] </td><td>  &lt;- Paquete UPD - </td><td>  [puerta de enlace] </td><td>  0xA3 </td></tr><tr><td>  [red] </td><td>  &lt;- Paquete UPD - </td><td>  [puerta de enlace] </td><td>  0xC1 </td></tr></tbody></table></div><br><p>  Ante m铆 sobre la mesa hay todo tipo de M贸dulos para el M5Stack y est谩n aburridos.  Tomemos LoR <del>  y divi茅rtete con ella </del>  .  隆El concepto del m贸dulo en s铆 es hermoso!  Que puedo decir  Pero, los m贸dulos de mi primera revisi贸n, en los que una antena incorporada terrible, hecha en una placa de circuito impreso flexible y pegada a la pared lateral de la caja.  Una vez realic茅 pruebas de campo de dichos m贸dulos (puede verlo en el canal en ruso en YouTube): </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/2mWAu6X_v-U" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  Naturalmente, tuve que eliminar estos rudimentos y soldar las antenas helicoidales est谩ndar que vienen con el Ra-01.  Despu茅s de tal personalizaci贸n, el rango de comunicaci贸n mejor贸 notablemente, pero apareci贸 un punto lateral: la antena tiene un di谩metro mayor que la distancia permitida entre los m贸dulos.  Tuve que abandonar el m贸dulo Final durante la duraci贸n del proyecto. </p><a name="habracut"></a><br><h2 id="pervye-trudnosti-ot-sihronnoy-tugosti">  Primeras dificultades <del>  de estanqueidad sincr贸nica </del></h2><br><p>  Parecer铆a que tomar la biblioteca <strong>WiFiUdp.h</strong> , donde todo es para la c贸moda existencia de un servidor UDP, no.  La biblioteca est谩 dise帽ada para levantar un servidor s铆ncrono que, desafortunadamente, no puede servir m煤ltiples conexiones al mismo tiempo.  Dicha biblioteca no es adecuada para la tarea actual.  Tuve que beber muchas tazas de t茅 y buscar una biblioteca que nos permitiera crear un servidor UDP asincr贸nico capaz de soportar muchas conexiones al mismo tiempo.  Se encontr贸 una biblioteca de este tipo: <strong>AsyncUDP.h</strong> .  驴Cu谩l es la diferencia entre un servidor s铆ncrono y uno as铆ncrono?  Echemos un vistazo a seis episodios en la Figura 2, en los que las opciones de operaci贸n de socket se muestran trivialmente. </p><br><p><img src="https://habrastorage.org/webt/fa/ay/fv/faayfvfxtqvi8nu5s_ks4ssbava.jpeg"></p><br><p>  Figura 2 </p><br><p>  Protagonista: </p><br><p>  <strong>Un hombre</strong> en el papel de un <strong>z贸calo</strong> ; </p><br><p>  <strong>Paloma</strong> en el papel de <strong>Compuesto</strong> ; </p><br><p>  <strong>Pismo</strong> como <strong>datos</strong> . </p><br><h3 id="epizod-a-sinhronnyy-soket-bez-taymauta">  Episodio A. Enchufe sincr贸nico sin tiempo de espera </h3><br><p>  Una persona se parar谩 hasta que la paloma le traiga una carta. </p><br><h3 id="epizod-b-sinhronnyy-soket-s-taymautom">  Episodio B. Enchufe sincr贸nico con tiempo de espera </h3><br><p>  Un hombre espera el tiempo acordado con la Paloma, y si no llega a tiempo, el Hombre se ir谩. </p><br><h3 id="epizod-c-sinhronnyy-soket-s-mnogopotochnostyu">  Episodio C. Z贸calo sincr贸nico de subprocesos m煤ltiples </h3><br><p>  Un hombre descansa y observa mientras las palomas entregan cartas por su cuenta. </p><br><h3 id="epizod-d-asinhronnyy-soket-kogda-nechego-eschyo-poluchat">  Episodio D. Z贸calo as铆ncrono (cuando no hay nada m谩s que recibir) </h3><br><p>  Un hombre hace sus cosas favoritas, pero no se olvida de las palomas. </p><br><h3 id="epizod-e-asinhronnyy-soket-kogda-est-chto-poluchit">  Episodio E. Z贸calo as铆ncrono (cuando hay algo que recibir) </h3><br><p>  El hombre se distrajo brevemente de sus asuntos para recibir una carta de la paloma. </p><br><h3 id="epizod-f-asinhronnyy-soket-s-mnogopotochnostyu">  Episodio F. Z贸calo multiproceso as铆ncrono </h3><br><p>  Un hombre se ocupa de sus asuntos y observa a las palomas entregar cartas por su cuenta. </p><br><p>  Si fue cuidadoso, probablemente deber铆a haber notado que los collares de las palomas en cada episodio tienen un cierto color.  Y esto no es accidental.  En los episodios A y B, solo un socket funciona en el servidor y eso es todo.  El episodio C ya tiene dos enchufes.  Los episodios D, E y F ya tienen tres tomas.  "驴Por qu茅 hay dos, pero aqu铆 hay tres?"  - usted pregunta  Esto es condicionalmente 2 y 3, de hecho, en lugar de 2 puede ser 20, y en lugar de tres 200. La tarea es mostrar que los enchufes as铆ncronos no queman tanto hierro como los s铆ncronos. </p><br><h2 id="kuda-skolko-chego-vmeschaetsya">  驴D贸nde encaja qu茅? </h2><br><p>  Veamos la tabla 1, que muestra la estructura del paquete UDP y pensemos qu茅 puede hacer al respecto. </p><br><p>  Tabla 1. Estructura de paquetes UDP </p><br><div class="scrollable-table"><table><thead><tr><th>  Pedacitos </th><th>  0 - 15 </th><th>  16 - 31 </th></tr></thead><tbody><tr><td>  0-31 </td><td>  Puerto de origen </td><td>  Puerto de destino </td></tr><tr><td>  32-63 </td><td>  Longitud del datagrama </td><td>  Suma de comprobaci贸n </td></tr><tr><td>  64 -... </td><td>  Datos </td><td></td></tr></tbody></table></div><br><p>  Agregue otro campo de <strong>Sesi贸n</strong> (1 Byte) al comienzo de esta tabla.  Esto es suficiente para este proyecto.  Seg煤n la sesi贸n, el dispositivo sabr谩 qu茅 hacer con el paquete a continuaci贸n.  Ahora encontraremos c贸digos para las sesiones y los escribiremos en la tabla 2. </p><br><p>  Tabla 2. Descripci贸n de la sesi贸n </p><br><div class="scrollable-table"><table><thead><tr><th>  C贸digo </th><th>  Titulo </th><th>  Explicaci贸n </th></tr></thead><tbody><tr><td>  0xA1 </td><td>  Faro </td><td>  La puerta de enlace transmite el nombre de la red LoRa y el rango de puertos permitidos con cierta frecuencia.  Esto es necesario para que los nuevos clientes vean la red disponible y los clientes actuales, cuando no hay transmisiones, puedan determinar el nivel de se帽al. </td></tr><tr><td>  0xB1 </td><td>  Solicitud </td><td>  Cuando el cliente encuentra la red, env铆a el puerto preferido. </td></tr><tr><td>  0xA2 </td><td>  Consentimiento o Negaci贸n </td><td>  Si el puerto solicitado por el cliente es gratuito, el servidor responde con el consentimiento y, de lo contrario, con un rechazo. </td></tr><tr><td>  0xB2 </td><td>  Enlace ascendente </td><td>  Cuando el cliente env铆a el paquete UDP a la puerta de enlace. </td></tr><tr><td>  0xA3 </td><td>  Enlace descendente </td><td>  Cuando la puerta de enlace env铆a el paquete UDP al cliente. </td></tr><tr><td>  0xC1 </td><td>  Enlace ascendente continuo </td><td>  Cuando la puerta de enlace env铆a un paquete UDP a la red local. </td></tr></tbody></table></div><br><p>  Bueno  Ahora analicemos la composici贸n de las sesiones en la tabla 3. </p><br><p>  Tabla 3. Sesiones </p><br><div class="scrollable-table"><table><thead><tr><th>  Nombre de sesi贸n </th><th>  Composici贸n </th></tr></thead><tbody><tr><td>  Faro </td><td>  C贸digo de sesi贸n (1 Byte) + Nombre de red LoRa (4 Bytes) + Puerto de inicio (2 Bytes) + Puerto de finalizaci贸n (2 Bytes) </td></tr><tr><td>  Solicitud </td><td>  C贸digo de transferencia (1 byte) + Nombre de red LoRa (4 Bytes) + Puerto preferido (2 Bytes) </td></tr><tr><td>  Consentimiento o Negaci贸n </td><td>  C贸digo de transmisi贸n (1 Byte) + Nombre de red LoRa (4 Bytes) + Puerto preferido (2 Bytes) + Resultado (1 Byte) </td></tr><tr><td>  Enlace ascendente </td><td>  C贸digo de transmisi贸n (1 Byte) + Nombre de red LoRa (4 Bytes) + Direcci贸n IP remota (4 Bytes) + Puerto remoto (2 Bytes) + Direcci贸n IP local (4 Bytes) + Puerto local (2 Bytes) + Tama帽o de datos (2 bytes) + datos </td></tr><tr><td>  Enlace descendente </td><td>  C贸digo de transmisi贸n (1 Byte) + Nombre de red LoRa (4 Bytes) + Direcci贸n IP remota (4 Bytes) + Puerto remoto (2 Bytes) + Direcci贸n IP local (4 Bytes) + Puerto local (2 Bytes) + Tama帽o de datos (2 bytes) + datos </td></tr><tr><td>  Enlace ascendente continuo </td><td>  Direcci贸n IP remota (4 bytes) + Puerto remoto (2 bytes) + Tama帽o de datos (2 bytes) + Datos </td></tr></tbody></table></div><br><p>  Escribi贸 dos clientes para Arduino y para M5Stack.  Puedes ver c贸mo funciona en el <a href="https://youtu.be/g4aHpgWcJnY" rel="nofollow">video</a> .  No hay problemas dentro del apartamento, todav铆a no he hecho pruebas de campo. </p><br><p>  El c贸digo fuente est谩 disponible en GitHub en </p><br><p>  Obtenga m谩s informaci贸n sobre la Unidad base M5Stack y compre <a href="http://ru.m5stack.com/%3Fsearch%3D%25D0%25BA%25D0%25BB%25D0%25B0%25D1%2581%25D1%2581%25D0%25B8%25D1%2587%25D0%25B5%25D1%2581%25D0%25BA%25D0%25B8%25D0%25B9" rel="nofollow">aqu铆.</a> </p><br><p>  Puede seleccionar m贸dulos inal谩mbricos LoRa para la Unidad base <a href="http://ru.m5stack.com/%3Fsearch%3Dlora" rel="nofollow">aqu铆</a> </p><br><p>  <strong>Me alegrar谩 si este proyecto es 煤til para usted.</strong>  <strong>Muchas gracias por tu tiempo!</strong> </p><br><p>  Referencias y (o) fuentes: </p><br><ul><li>  <a href="https://qna.habr.com/q/388343" rel="nofollow">Preguntas y respuestas de Habr "驴Qu茅 es un z贸calo as铆ncrono?"</a> </li><li>  <a href="https://ru.wikipedia.org/wiki/UDP" rel="nofollow">Wikipedia "UDP"</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/482080/">https://habr.com/ru/post/482080/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../482066/index.html">Reemplazar historia de usuario con historia de trabajo</a></li>
<li><a href="../482068/index.html">驴Necesito crear una matriz RAID a partir de SSD y qu茅 controladores se necesitan para esto?</a></li>
<li><a href="../482070/index.html">Cinco h谩bitos que ayudan a mantener el rendimiento cerebral</a></li>
<li><a href="../482076/index.html">Clientes, conf铆en en asoshnikov</a></li>
<li><a href="../482078/index.html">Riesgos de proyectos de TI y equipos de TI.</a></li>
<li><a href="../482084/index.html">Que leer en vacaciones</a></li>
<li><a href="../482086/index.html">An谩lisis de bootkit</a></li>
<li><a href="../482088/index.html">Hugge para desarrolladores, o c贸mo fui a KotlinConf</a></li>
<li><a href="../482092/index.html">驴Qu茅 necesita el ciego? Revisi贸n del experto sordociego Sergei Fleitin</a></li>
<li><a href="../482094/index.html">Arquitecto de software: por qu茅 es necesario y cu谩l es su maldici贸n</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>