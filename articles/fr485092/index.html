<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🕴🏽 📯 🔶 Validation des données dans les applications iOS 🙌🏼 🥗 🖊️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Je pense que chacun de nous a été confronté à la tâche de valider les données dans les applications. Par exemple, lors de l'enregistrement d'un utilis...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Validation des données dans les applications iOS</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/485092/"><p>  Je pense que chacun de nous a été confronté à la tâche de valider les données dans les applications.  Par exemple, lors de l'enregistrement d'un utilisateur, vous devez vous assurer que le courrier électronique a le format correct et que le mot de passe répond aux exigences de sécurité, etc.  Vous pouvez donner beaucoup d'exemples, mais tout se résume à une seule tâche - la validation des données avant de soumettre le formulaire. </p><br><p> En travaillant sur le prochain projet, j'ai pensé à créer une solution universelle, plutôt que d'écrire des méthodes de validation pour chaque écran avec un formulaire séparément.  Swift 5.1 a introduit l'annotation <code>@propertyWrapper</code> , et j'ai pensé qu'il serait pratique d'avoir une syntaxe comme celle-ci: </p><br><pre> <code class="swift hljs">@<span class="hljs-type"><span class="hljs-type">Validated</span></span>([validator1, validator2, ...]) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> email: <span class="hljs-type"><span class="hljs-type">String?</span></span> = <span class="hljs-literal"><span class="hljs-literal">nil</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> errors = $email.errors <span class="hljs-comment"><span class="hljs-comment">//  </span></span></code> </pre> <a name="habracut"></a><br><h3 id="validatory">  Validateurs </h3><br><p>  La première étape consistait à déterminer l'apparence et le fonctionnement des validateurs.  Dans le cadre de mon projet, je devais vérifier la validité des données et afficher les messages d'erreur appropriés.  Il n'était pas nécessaire de gérer des erreurs plus complexes, la mise en œuvre du validateur était donc la suivante: </p><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ValidationError</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LocalizedError</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> message: <span class="hljs-type"><span class="hljs-type">String</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> errorDescription: <span class="hljs-type"><span class="hljs-type">String?</span></span> { message } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Validator</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">associatedtype</span></span> <span class="hljs-type"><span class="hljs-type">ValueType</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> errorMessage: <span class="hljs-type"><span class="hljs-type">String</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isValid</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(value: ValueType?)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Bool</span></span> } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Validator</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">validate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(value: ValueType?)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">throws</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> !isValid(value: value) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-type"><span class="hljs-type">ValidationError</span></span>(message: errorMessage) } } }</code> </pre> <br><p>  Ici, tout est simple.  Le validateur contient un message d'erreur qui déclenche une ValidationError si la validation échoue.  Cela simplifie la gestion des erreurs, car tous les validateurs renvoient le même type d'erreur, mais avec des messages différents.  Un exemple est le code d'un validateur qui vérifie une chaîne par rapport à une expression régulière: </p><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RegexValidator</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Validator</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> errorMessage: <span class="hljs-type"><span class="hljs-type">String</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> regex: <span class="hljs-type"><span class="hljs-type">String</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>(regex: <span class="hljs-type"><span class="hljs-type">String</span></span>, errorMessage: <span class="hljs-type"><span class="hljs-type">String</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.regex = regex <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.errorMessage = errorMessage } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isValid</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(value: String?)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Bool</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">guard</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> v = value <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> predicate = <span class="hljs-type"><span class="hljs-type">NSPredicate</span></span>(format: <span class="hljs-string"><span class="hljs-string">"SELF MATCHES %@"</span></span>, regex) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> predicate.evaluate(with: v) } }</code> </pre> <br><p>  Cette implémentation contient un problème connu de nombreux.  Étant donné que le protocole <code>Validator</code> contient un type <code>associatedtype</code> , nous ne pouvons pas créer une variable de type </p><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> validators:[<span class="hljs-type"><span class="hljs-type">Validator</span></span>] <span class="hljs-comment"><span class="hljs-comment">//Protocol 'Validator' can only be used as a generic constraint because it has Self or associated type requirements</span></span></code> </pre> <br><p>  Pour résoudre ce problème, nous utilisons une approche standard, à savoir la création de la structure AnyValidator. <br></p><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ValidatorBox</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt;: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Validator</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> errorMessage: <span class="hljs-type"><span class="hljs-type">String</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">fatalError</span></span>() } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isValid</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(value: T?)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Bool</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">fatalError</span></span>() } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ValidatorBoxHelper</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">V</span></span></span><span class="hljs-class">:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Validator</span></span></span><span class="hljs-class">&gt;: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ValidatorBox</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">where</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">V</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ValueType</span></span></span><span class="hljs-class"> == </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> validator: <span class="hljs-type"><span class="hljs-type">V</span></span> <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>(validator: <span class="hljs-type"><span class="hljs-type">V</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.validator = validator } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> errorMessage: <span class="hljs-type"><span class="hljs-type">String</span></span> { validator.errorMessage } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isValid</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(value: T?)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Bool</span></span> { validator.isValid(value: value) } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AnyValidator</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt;: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Validator</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> validator: <span class="hljs-type"><span class="hljs-type">ValidatorBox</span></span>&lt;<span class="hljs-type"><span class="hljs-type">T</span></span>&gt; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>&lt;<span class="hljs-type"><span class="hljs-type">V</span></span>: <span class="hljs-type"><span class="hljs-type">Validator</span></span>&gt;(validator: <span class="hljs-type"><span class="hljs-type">V</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-type"><span class="hljs-type">V</span></span>.<span class="hljs-type"><span class="hljs-type">ValueType</span></span> == <span class="hljs-type"><span class="hljs-type">T</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.validator = <span class="hljs-type"><span class="hljs-type">ValidatorBoxHelper</span></span>(validator: validator) } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> errorMessage: <span class="hljs-type"><span class="hljs-type">String</span></span> { validator.errorMessage } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isValid</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(value: T?)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Bool</span></span> { validator.isValid(value: value) } }</code> </pre> <br><p>  Je pense qu'il n'y a rien à commenter.  Il s'agit d'une approche standard pour résoudre le problème décrit ci-dessus.  Il serait également utile d'ajouter une extension pour le protocole Validator, vous permettant de créer un objet AnyValidator. <br></p><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Validator</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> validator: <span class="hljs-type"><span class="hljs-type">AnyValidator</span></span>&lt;<span class="hljs-type"><span class="hljs-type">ValueType</span></span>&gt; { <span class="hljs-type"><span class="hljs-type">AnyValidator</span></span>(validator: <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) } }</code> </pre> <br><h3 id="property-wrapper">  Habillage de propriété </h3><br><p>  Une fois les valideurs triés, vous pouvez passer directement à l'implémentation du wrapper <code>@Validated</code> . </p><br><pre> <code class="swift hljs">@propertyWrapper <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Validated</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Value</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> validators: [<span class="hljs-type"><span class="hljs-type">AnyValidator</span></span>&lt;<span class="hljs-type"><span class="hljs-type">Value</span></span>&gt;] <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> wrappedValue: <span class="hljs-type"><span class="hljs-type">Value?</span></span> <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>(wrappedValue value: <span class="hljs-type"><span class="hljs-type">Value?</span></span>, <span class="hljs-number"><span class="hljs-number">_</span></span> validators: [<span class="hljs-type"><span class="hljs-type">AnyValidator</span></span>&lt;<span class="hljs-type"><span class="hljs-type">Value</span></span>&gt;]) { wrappedValue = value <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.validators = validators } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> projectedValue: <span class="hljs-type"><span class="hljs-type">Validated</span></span>&lt;<span class="hljs-type"><span class="hljs-type">Value</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> errors: [<span class="hljs-type"><span class="hljs-type">ValidationError</span></span>] { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> errors: [<span class="hljs-type"><span class="hljs-type">ValidationError</span></span>] = [] validators.forEach { <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> $<span class="hljs-number"><span class="hljs-number">0</span></span>.validate(value: wrappedValue) } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> { errors.append(error <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>! <span class="hljs-type"><span class="hljs-type">ValidationError</span></span>) } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> errors } }</code> </pre> <br><p>  Le but de cet article n'est pas d'analyser le fonctionnement <code>propertyWrapper</code> wrappers <code>propertyWrapper</code> et la syntaxe qu'ils utilisent.  Si vous n'avez pas encore pu les rencontrer, je vous conseille de lire mon autre article, <a href="https://www.toptal.com/swift/wrappers-swift-properties" rel="nofollow">How to Approach Wrappers for Swift Properties</a> (anglais). </p><br><p>  Cette implémentation nous permet de déclarer les propriétés qui nécessitent une validation comme suit: </p><br><pre> <code class="swift hljs">@<span class="hljs-type"><span class="hljs-type">Validated</span></span>([ <span class="hljs-type"><span class="hljs-type">NotEmptyValidator</span></span>(errorMessage: <span class="hljs-string"><span class="hljs-string">"Email can't be empty"</span></span>).validator, <span class="hljs-type"><span class="hljs-type">RegexValidator</span></span>(regex:<span class="hljs-string"><span class="hljs-string">"[A-Z0-9a-z._%+-]+@[A-Za-z0-9.-]+\\.[A-za-z]{2,64} "</span></span>, errorMessage:<span class="hljs-string"><span class="hljs-string">"Email has wrong format"</span></span>).validator ]) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> email: <span class="hljs-type"><span class="hljs-type">String?</span></span> = <span class="hljs-literal"><span class="hljs-literal">nil</span></span></code> </pre> <br><p>  Et obtenez un tableau d'erreurs de validation à tout moment comme suit </p><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> errors = $email.errors</code> </pre> <br><p><img src="https://habrastorage.org/webt/7k/ea/i3/7keai3dd8pugymrl-0mysnhwwto.gif" alt="image"><br>  Il est possible que certaines combinaisons de validateurs (par exemple, la validation par e-mail) apparaissent dans l'application sur plusieurs écrans.  Afin d'éviter de copier le code, dans de tels cas, il est possible de créer un wrapper distinct hérité de <code>Validated</code> . </p><br><pre> <code class="swift hljs">@propertyWrapper <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Email</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Validated</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">String</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> wrappedValue: <span class="hljs-type"><span class="hljs-type">String?</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.wrappedValue } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.wrappedValue = newValue } } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> projectedValue: <span class="hljs-type"><span class="hljs-type">Validated</span></span>&lt;<span class="hljs-type"><span class="hljs-type">String</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.projectedValue } <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>(wrappedValue value: <span class="hljs-type"><span class="hljs-type">String?</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> notEmptyValidator = <span class="hljs-type"><span class="hljs-type">NotEmptyValidator</span></span>(errorMessage: <span class="hljs-string"><span class="hljs-string">"Email can't be empty"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> regexValidator = <span class="hljs-type"><span class="hljs-type">RegexValidator</span></span>(regex:<span class="hljs-string"><span class="hljs-string">"[A-Z0-9a-z._%+-]+@[A-Za-z0-9.-]+\\.[A-za-z]{2,64} "</span></span>, errorMessage:<span class="hljs-string"><span class="hljs-string">"Email has wrong format"</span></span>).validator <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">init</span></span>(wrappedValue: value, [notEmptyValidator, regexValidator]) } } @<span class="hljs-type"><span class="hljs-type">Email</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> email: <span class="hljs-type"><span class="hljs-type">String?</span></span> = <span class="hljs-literal"><span class="hljs-literal">nil</span></span></code> </pre> <br><p>  Malheureusement, pour le moment, l'annotation <code>@propertyWrapper</code> nécessite de <code>wrappedValue</code> et <code>projectedValue</code> , sinon nous obtiendrons une erreur de compilation.  Il ressemble à un bogue d'implémentation, il est donc possible que dans les futures versions de Swift cela soit corrigé. </p><br><h3 id="dobavlyaem-reactive">  Ajouter réactif </h3><br><p>  Avec iOS13, le cadre de programmation réactive Combine natif est apparu.  Et j'ai pensé qu'il pourrait être utile d'avoir la syntaxe suivante: </p><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> cancellable = $email .publisher .<span class="hljs-built_in"><span class="hljs-built_in">map</span></span> { $<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">map</span></span> { $<span class="hljs-number"><span class="hljs-number">0</span></span>.localizedDescription }.joined(separator: <span class="hljs-string"><span class="hljs-string">", "</span></span>) } .receive(on: <span class="hljs-type"><span class="hljs-type">RunLoop</span></span>.main) .assign(to: \.text, on: emailErrorLabel)</code> </pre> <br><p>  Cela permettra de mettre à jour les informations sur les erreurs de validation en temps réel (après chaque caractère entré).  La mise en œuvre initiale de cette idée était la suivante: </p><br><pre> <code class="swift hljs">@propertyWrapper <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Validated</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Value</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _subject: <span class="hljs-type"><span class="hljs-type">Any!</span></span> <span class="hljs-meta"><span class="hljs-meta">@available</span></span>(iOS <span class="hljs-number"><span class="hljs-number">13.0</span></span>, *) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> subject: <span class="hljs-type"><span class="hljs-type">PassthroughSubject</span></span>&lt;[<span class="hljs-type"><span class="hljs-type">ValidationError</span></span>], <span class="hljs-type"><span class="hljs-type">Never</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _subject <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>! <span class="hljs-type"><span class="hljs-type">PassthroughSubject</span></span>&lt;[<span class="hljs-type"><span class="hljs-type">ValidationError</span></span>], <span class="hljs-type"><span class="hljs-type">Never</span></span>&gt; } <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> wrappedValue: <span class="hljs-type"><span class="hljs-type">Value?</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">didSet</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> #available(iOS <span class="hljs-number"><span class="hljs-number">13.0</span></span>, *) { subject.send(errors) } } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>(wrappedValue value: <span class="hljs-type"><span class="hljs-type">Value?</span></span>, <span class="hljs-number"><span class="hljs-number">_</span></span> validators: [<span class="hljs-type"><span class="hljs-type">AnyValidator</span></span>&lt;<span class="hljs-type"><span class="hljs-type">Value</span></span>&gt;]) { wrappedValue = value <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.validators = validators <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> #available(iOS <span class="hljs-number"><span class="hljs-number">13.0</span></span>, *) { _subject = <span class="hljs-type"><span class="hljs-type">PassthroughSubject</span></span>&lt;[<span class="hljs-type"><span class="hljs-type">ValidationError</span></span>], <span class="hljs-type"><span class="hljs-type">Never</span></span>&gt;() } } <span class="hljs-meta"><span class="hljs-meta">@available</span></span>(iOS <span class="hljs-number"><span class="hljs-number">13.0</span></span>, *) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> publisher: <span class="hljs-type"><span class="hljs-type">AnyPublisher</span></span>&lt;[<span class="hljs-type"><span class="hljs-type">ValidationError</span></span>], <span class="hljs-type"><span class="hljs-type">Never</span></span>&gt; { subject.eraseToAnyPublisher() } <span class="hljs-comment"><span class="hljs-comment">// The rest of the code }</span></span></code> </pre> <br><p>  Étant donné que la propriété stockée ne peut pas être marquée avec l'annotation <code>@available</code> , j'ai dû utiliser une <code>_subject</code> contournement avec les propriétés <code>_subject</code> et <code>subject</code> .  Sinon, tout devrait être très clair.  Un <code>PassthroughObject</code> est créé qui envoie des messages chaque fois que le <code>wrappedValue</code> change. </p><br><p>  Par conséquent, les messages d'erreur de validation changent lorsque l'utilisateur remplit le formulaire. <br><img src="https://habrastorage.org/webt/yq/3c/5n/yq3c5nyfojkoza-wzjbqib2zicw.gif" alt="image"><br>  Lors du test de cette solution, un bogue a été révélé.  La validation a lieu chaque fois qu'une propriété change, quelle que soit la présence des abonnés à cet événement.  D'une part, cela n'affecte pas le résultat, mais d'autre part, dans le cas où nous n'avons pas besoin de validation en temps réel, des actions inutiles seront effectuées.  Il validera et enverra correctement les messages uniquement s'il y a au moins un abonné.  En conséquence, le code a été refait avec cette exigence. </p><br><pre> <code class="swift hljs">@propertyWrapper <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Validated</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Value</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _subject: <span class="hljs-type"><span class="hljs-type">Any!</span></span> <span class="hljs-meta"><span class="hljs-meta">@available</span></span>(iOS <span class="hljs-number"><span class="hljs-number">13.0</span></span>, *) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> subject: <span class="hljs-type"><span class="hljs-type">Publishers</span></span>.<span class="hljs-type"><span class="hljs-type">HandleEvents</span></span>&lt;<span class="hljs-type"><span class="hljs-type">PassthroughSubject</span></span>&lt;[<span class="hljs-type"><span class="hljs-type">ValidationError</span></span>], <span class="hljs-type"><span class="hljs-type">Never</span></span>&gt;&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _subject <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>! <span class="hljs-type"><span class="hljs-type">Publishers</span></span>.<span class="hljs-type"><span class="hljs-type">HandleEvents</span></span>&lt;<span class="hljs-type"><span class="hljs-type">PassthroughSubject</span></span>&lt;[<span class="hljs-type"><span class="hljs-type">ValidationError</span></span>], <span class="hljs-type"><span class="hljs-type">Never</span></span>&gt;&gt; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> subscribed: <span class="hljs-type"><span class="hljs-type">Bool</span></span> = <span class="hljs-literal"><span class="hljs-literal">false</span></span> <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> wrappedValue: <span class="hljs-type"><span class="hljs-type">Value?</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">didSet</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> #available(iOS <span class="hljs-number"><span class="hljs-number">13.0</span></span>, *) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> subscribed { subject.upstream.send(errors) } } } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>(wrappedValue value: <span class="hljs-type"><span class="hljs-type">Value?</span></span>, <span class="hljs-number"><span class="hljs-number">_</span></span> validators: [<span class="hljs-type"><span class="hljs-type">AnyValidator</span></span>&lt;<span class="hljs-type"><span class="hljs-type">Value</span></span>&gt;]) { wrappedValue = value <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.validators = validators <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> #available(iOS <span class="hljs-number"><span class="hljs-number">13.0</span></span>, *) { _subject = <span class="hljs-type"><span class="hljs-type">PassthroughSubject</span></span>&lt;[<span class="hljs-type"><span class="hljs-type">ValidationError</span></span>], <span class="hljs-type"><span class="hljs-type">Never</span></span>&gt;() .handleEvents(receiveSubscription: {[<span class="hljs-keyword"><span class="hljs-keyword">weak</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>] <span class="hljs-number"><span class="hljs-number">_</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>?.subscribed = <span class="hljs-literal"><span class="hljs-literal">true</span></span> }) } } <span class="hljs-comment"><span class="hljs-comment">// The rest of the code }</span></span></code> </pre> <br><p>  En conséquence, j'ai obtenu une solution relativement universelle pour la validation des données dans l'application.  Il peut ne pas résoudre certains problèmes, par exemple, une gestion des erreurs plus compliquée que la simple sortie de message, mais il convient à une validation simple de l'entrée utilisateur.  Vous pouvez consulter la solution complète sur <a href="https://github.com/alexander-gaidukov/property-validator" rel="nofollow">GitHub</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr485092/">https://habr.com/ru/post/fr485092/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr485078/index.html">Difficile, vulnérable, sous-configuré: cyber-menaces 2020</a></li>
<li><a href="../fr485080/index.html">NgRx Ducks | Façades dynamiques</a></li>
<li><a href="../fr485084/index.html">Plancton de bureau - Evolution</a></li>
<li><a href="../fr485088/index.html">Râteau rétrospectif. Comment une solution autodidacte s'est avérée plus cool que payée</a></li>
<li><a href="../fr485090/index.html">Le secret de l'efficacité est un code de qualité, pas un gestionnaire efficace</a></li>
<li><a href="../fr485094/index.html">Microservices avec Spring Boot. Partie 3. Création d'un microservice de conversion de devises</a></li>
<li><a href="../fr485098/index.html">La conception peut-elle affecter la vitesse de livraison?</a></li>
<li><a href="../fr485100/index.html">Où aller: les prochains événements gratuits pour les développeurs à Moscou (30 janvier - 15 février)</a></li>
<li><a href="../fr485102/index.html">Topleaked: un outil pour détecter les fuites de mémoire</a></li>
<li><a href="../fr485104/index.html">Créer une clé RFID universelle pour les interphones</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>