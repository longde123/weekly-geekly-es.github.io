<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚å®Ô∏è ‚ùé ü§±üèΩ Gestion des relais Internet √† partir de RouterOS Mikrotik via l'API üèØ üç∂ ‚ùÑÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Un outil pratique pour g√©rer les PDU dans les routeurs MikroTik 
 MikroTik est connu comme un fabricant d'√©quipements r√©seau √† haute fiabilit√© √† bas p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Gestion des relais Internet √† partir de RouterOS Mikrotik via l'API</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/410107/"><img src="https://habrastorage.org/webt/ip/ds/cs/ipdscs4kq9sanmqsyphzumdxvck.png" alt="MikroTik RODOS-8/9/10" align="left"><br><br><h2>  Un outil pratique pour g√©rer les PDU dans les routeurs MikroTik </h2><br>  <b>MikroTik est</b> connu comme un fabricant d'√©quipements r√©seau √† haute fiabilit√© √† bas prix et riche en fonctionnalit√©s.  La base logicielle des produits MikroTik est <b>RouterOS</b> , un syst√®me d'exploitation r√©seau bas√© sur Linux.  Il fonctionne sur <b>RouterBOARD</b> , une large gamme de solutions mat√©rielles qui incluent √† la fois des √©quipements d'op√©rateur purs et des plates-formes pour un usage domestique.  RouterOS fournit √† l'administrateur / utilisateur de grandes options pour configurer et g√©rer le routeur, vous permettant non seulement de fonctionner avec les fonctionnalit√©s int√©gr√©es du syst√®me, mais √©galement de cr√©er vos propres options pour presque toutes les solutions gr√¢ce √† la programmation de scripts. <br><br>  Dans cet article, je vais expliquer comment vous pouvez utiliser les fonctionnalit√©s avanc√©es des routeurs MikroTik pour √©mettre des commandes de gestion de l'alimentation √† l'aide de <b>PDU (relais Internet)</b> directement √† partir du routeur via des fonctions de script. <a name="habracut"></a>  En tant que PDU, j'ai utilis√© le relais Ethernet RODOS-8/9/10 de la soci√©t√© OLIMP (les appareils sont absolument identiques en termes de contr√¥le), qui est rest√© apr√®s plusieurs projets et √©tait ¬´√† port√©e de main¬ª. <br><br><h2>  Fonctionnalit√©s RouterOS pour la gestion des PDU </h2><br>  Les fonctionnalit√©s avanc√©es de RouterOS peuvent permettre: <br><br><ul><li>  Allumez / √©teignez √† distance l'alimentation des appareils connect√©s √† la PDU </li><li>  Contr√¥lez √† distance la PDU lors de la survenance de divers √©v√©nements sur le r√©seau (par exemple, s'il n'y a pas de r√©ponse d'un appareil au ping, lorsqu'un client VPN sp√©cifique, un client de r√©seau wifi, etc., est connect√© au routeur), en fonction de l'heure (pr√©vu) </li><li>  Avertir l'administrateur ou les utilisateurs du changement d'√©tat du relais sur la PDU par e-mail ou num√©ro de t√©l√©phone (via SMS) </li></ul><br>  Ainsi, il est possible d'organiser, par exemple, le contr√¥le de l'√©quipement du serveur, allumer / √©teindre / red√©marrer l'√©quipement r√©seau ¬´suspendu¬ª, allumer le refroidissement ou le chauffage, l'√©clairage, g√©rer toutes les charges acceptables pour la puissance nominale dans le cadre de la maison intelligente, et bien plus encore qui peuvent permettre Votre imagination. <br><br>  La possibilit√© de contr√¥ler un relais Internet √† partir de RouterOS est fournie par la commande <b>fetch</b> router, dont la syntaxe est d√©crite en d√©tail sur le lien √† la fin de l'article. <br><br><h2>  Gestion des PDU via la commande de routeur ¬´fetch¬ª </h2><br>  Les PDU RODOS-8/9/10 prennent en charge le format URL suivant: <br><br><div class="spoiler">  <b class="spoiler_title">http: // [connexion]: [Mot de passe] @ [adresse IP] [/ protect] / rb [X-1] [action] .cgi</b> <div class="spoiler_text"><ul><li>  Login et mot de passe - donn√©es pertinentes pour acc√©der √† l'appareil en ¬´mode prot√©g√©¬ª (prot√©ger) </li><li>  Adresse IP - Adresse IP de l'appareil sur le r√©seau </li><li>  / protect - la cl√© d'acc√®s en "mode prot√©g√©".  Si l'acc√®s ¬´ouvert¬ª est install√© sur l'appareil, / protect n'est pas sp√©cifi√©, l'identifiant et le mot de passe ne sont pas non plus sp√©cifi√©s </li><li>  [action] - l'action prise sur le relais: n-allumer, f-√©teindre, s-√©mettre une impulsion d'une dur√©e de 1 sec </li><li>  X est le num√©ro du relais auquel on acc√®de; les valeurs possibles d√©pendent du mod√®le de l'appareil: <br><ol><li>  RODOS-8 - non indiqu√©, car  l'appareil a un seul relais </li><li>  RODOS-9 - X = 1 ou X = 2 </li><li>  RODOS-10 - X = [1-4] </li></ol></li></ul><br>  Tous les param√®tres sp√©cifi√©s sont pass√©s sans crochets []. </div></div><br>  Ainsi, pour r√©soudre notre probl√®me dans RouterOS, pour activer le premier relais de notre PDU, l'entr√©e suivante suffit: <br><br><pre><code class="hljs pgsql">/tool <span class="hljs-keyword"><span class="hljs-keyword">fetch</span></span> url="http://[:]@192.168.1.20/protect/rb0n"</code> </pre> <br>  Si nous voulons une r√©ponse de l'appareil, nous devons utiliser: <br><br><pre> <code class="hljs powershell">/tool fetch url=<span class="hljs-string"><span class="hljs-string">"http://[:]@192.168.1.20/protect/rb0n"</span></span> mode=http dst<span class="hljs-literal"><span class="hljs-literal">-path</span></span>=<span class="hljs-string"><span class="hljs-string">"Rodosanswer.txt"</span></span>; :local Rodosanswer [/<span class="hljs-type"><span class="hljs-type">file</span></span> <span class="hljs-type"><span class="hljs-type">get</span></span> <span class="hljs-type"><span class="hljs-type">Rodosanswer.txt</span></span> <span class="hljs-type"><span class="hljs-type">contents</span></span>];</code> </pre> <br>  La r√©ponse PDU dans notre cas est renvoy√©e √† l'aide du m√©canisme <b>json</b> √† la variable <b>Rodosanswer</b> sous la forme suivante: <br><br><ul><li>  ¬´Succ√®s!  ¬ª- en cas de r√©ussite </li><li>  ¬´Fault¬ª - si la commande n'est pas ex√©cut√©e (en r√®gle g√©n√©rale, lors de l'acc√®s sans indiquer le login et le mot de passe de la PDU dans la ligne URL, si la PDU est en mode ¬´prot√©g√©¬ª) </li></ul><br><h2>  Nous cr√©ons la fonction de gestion Rodos PDU dans le r√©f√©rentiel du routeur Mikrotik </h2><br>  Commen√ßons donc.  Cr√©ons une fonction de contr√¥le de relais en utilisant l'exemple de contr√¥le RODOS-10 dans le r√©f√©rentiel de scripts du routeur MikroTik sous le nom "Func_RODOS10rele": <br><br><div class="spoiler">  <b class="spoiler_title">Code "Func_RODOS10rele"</b> <div class="spoiler_text"><pre> <code class="hljs mel">################ FuncRODOS10rele ###################### #     PDU RODOS<span class="hljs-number"><span class="hljs-number">-10</span></span> # by Sergej Serkov <span class="hljs-number"><span class="hljs-number">23.12</span></span><span class="hljs-number"><span class="hljs-number">.2017</span></span> ####################################################### #  ,   :<span class="hljs-keyword"><span class="hljs-keyword">global</span></span> FuncRODOS10rele <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ :local Sport <span class="hljs-string"><span class="hljs-string">""</span></span>; :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([:len $Rport]=<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={:set Sport <span class="hljs-string"><span class="hljs-string">"80"</span></span>;} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>={:set Sport $Rport;} :<span class="hljs-keyword"><span class="hljs-keyword">global</span></span> FuncPing; :local PingAnswer [$FuncPing PingAdr=$Radr]; :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($PingAnswer=<span class="hljs-string"><span class="hljs-string">"OK"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ :local Rprotect; :local Wprotect; :local Rmode <span class="hljs-string"><span class="hljs-string">"0"</span></span>; :local Nrele <span class="hljs-number"><span class="hljs-number">0</span></span>; :local Act; :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (([:len $Rlogin]=<span class="hljs-number"><span class="hljs-number">0</span></span>) and ([:len $Rpass]=<span class="hljs-number"><span class="hljs-number">0</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={:set Rprotect <span class="hljs-string"><span class="hljs-string">""</span></span>; set Wprotect <span class="hljs-string"><span class="hljs-string">""</span></span>;} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>={:set Rprotect (<span class="hljs-string"><span class="hljs-string">"$Rlogin"</span></span>.<span class="hljs-string"><span class="hljs-string">":"</span></span>.<span class="hljs-string"><span class="hljs-string">"$Rpass"</span></span>.<span class="hljs-string"><span class="hljs-string">"@"</span></span>); set Wprotect <span class="hljs-string"><span class="hljs-string">"/protect"</span></span>;} :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($Rstatus=<span class="hljs-string"><span class="hljs-string">"on"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={:set Rmode <span class="hljs-string"><span class="hljs-string">"1"</span></span>; :set Act <span class="hljs-string"><span class="hljs-string">"n"</span></span>} :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($Rstatus=<span class="hljs-string"><span class="hljs-string">"off"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={:set Rmode <span class="hljs-string"><span class="hljs-string">"1"</span></span>; :set Act <span class="hljs-string"><span class="hljs-string">"f"</span></span>} :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($Rstatus=<span class="hljs-string"><span class="hljs-string">"inv"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={:set Rmode <span class="hljs-string"><span class="hljs-string">"1"</span></span>; :set Act <span class="hljs-string"><span class="hljs-string">"s"</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>={} :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($Rmode=<span class="hljs-string"><span class="hljs-string">"1"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ :set Nrele ([:tonum $Rrele] - <span class="hljs-number"><span class="hljs-number">1</span></span>); :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (($Nrele &gt; <span class="hljs-number"><span class="hljs-number">-1</span></span> and ($Nrele &lt; <span class="hljs-number"><span class="hljs-number">4</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ :local StrFetchRodos; :set StrFetchRodos (<span class="hljs-string"><span class="hljs-string">"http://"</span></span>.<span class="hljs-string"><span class="hljs-string">"$Rprotect"</span></span>.<span class="hljs-string"><span class="hljs-string">"$Radr"</span></span>.<span class="hljs-string"><span class="hljs-string">":"</span></span>.<span class="hljs-string"><span class="hljs-string">"$Sport"</span></span>.<span class="hljs-string"><span class="hljs-string">"$Wprotect"</span></span>.<span class="hljs-string"><span class="hljs-string">"/rb"</span></span>.<span class="hljs-string"><span class="hljs-string">"$Nrele"</span></span>.<span class="hljs-string"><span class="hljs-string">"$Act"</span></span>.<span class="hljs-string"><span class="hljs-string">".cgi"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { [/tool fetch url=$StrFetchRodos mode=http dst-path=<span class="hljs-string"><span class="hljs-string">"Rodosanswer.txt"</span></span>;]; } on-<span class="hljs-keyword"><span class="hljs-keyword">error</span></span>={: <span class="hljs-keyword"><span class="hljs-keyword">log</span></span> info <span class="hljs-string"><span class="hljs-string">""</span></span>; :<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">error</span></span> (<span class="hljs-string"><span class="hljs-string">"Call ERROR function &lt;RODOS10rele&gt; ERROR fetch command"</span></span>); :local Rodosanswer <span class="hljs-string"><span class="hljs-string">"ERROR: command ROS &lt;fetch&gt;"</span></span>; : <span class="hljs-keyword"><span class="hljs-keyword">log</span></span> info <span class="hljs-string"><span class="hljs-string">""</span></span>; :<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $Rodosanswer} :<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> info <span class="hljs-string"><span class="hljs-string">""</span></span>; :<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">warning</span></span> (<span class="hljs-string"><span class="hljs-string">"all "</span></span>.<span class="hljs-string"><span class="hljs-string">"$Wprotect "</span></span>.<span class="hljs-string"><span class="hljs-string">"function &lt;RODOS10rele&gt; set rele #"</span></span>.<span class="hljs-string"><span class="hljs-string">"$Rrele "</span></span>.<span class="hljs-string"><span class="hljs-string">"is ["</span></span>.<span class="hljs-string"><span class="hljs-string">"$Rstatus"</span></span>.<span class="hljs-string"><span class="hljs-string">"]"</span></span>); :<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> info <span class="hljs-string"><span class="hljs-string">""</span></span>; :delay <span class="hljs-number"><span class="hljs-number">2</span></span>s; :local Rodosanswer [/<span class="hljs-keyword"><span class="hljs-keyword">file</span></span> get Rodosanswer.txt contents]; /<span class="hljs-keyword"><span class="hljs-keyword">file</span></span> remove Rodosanswer.txt; :<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $Rodosanswer; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>={ :<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> info <span class="hljs-string"><span class="hljs-string">""</span></span>; :<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">error</span></span> (<span class="hljs-string"><span class="hljs-string">"all ERROR"</span></span>.<span class="hljs-string"><span class="hljs-string">"$Wprotect "</span></span>.<span class="hljs-string"><span class="hljs-string">"function &lt;RODOS10rele&gt; set rele#"</span></span>.<span class="hljs-string"><span class="hljs-string">"$Rrele"</span></span>.<span class="hljs-string"><span class="hljs-string">" but NUMBER RELE MISMATCH"</span></span>); :<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> info <span class="hljs-string"><span class="hljs-string">""</span></span>; :local Rodosanswer <span class="hljs-string"><span class="hljs-string">"ERROR: rele range mismath"</span></span>; :<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $Rodosanswer;} } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>={ :<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> info <span class="hljs-string"><span class="hljs-string">""</span></span>; :<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">error</span></span> (<span class="hljs-string"><span class="hljs-string">"all ERROR"</span></span>.<span class="hljs-string"><span class="hljs-string">"$Wprotect "</span></span>.<span class="hljs-string"><span class="hljs-string">"function &lt;RODOS10rele&gt; set rele#"</span></span>.<span class="hljs-string"><span class="hljs-string">"$Rrele"</span></span>.<span class="hljs-string"><span class="hljs-string">" but RELE REGIME SET MISMATCH"</span></span>); :<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> info <span class="hljs-string"><span class="hljs-string">""</span></span>; :local Rodosanswer <span class="hljs-string"><span class="hljs-string">"ERROR: rele regime set mismatch"</span></span>; :<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $Rodosanswer;} } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>={ :<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> info <span class="hljs-string"><span class="hljs-string">""</span></span>; :<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">error</span></span> (<span class="hljs-string"><span class="hljs-string">"all ERROR"</span></span>.<span class="hljs-string"><span class="hljs-string">"$Wprotect "</span></span>.<span class="hljs-string"><span class="hljs-string">"function &lt;RODOS10rele&gt; but DEVICE NOT RESPONDED"</span></span>); :<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> info <span class="hljs-string"><span class="hljs-string">""</span></span>; :local Rodosanswer <span class="hljs-string"><span class="hljs-string">"ERROR: device not responded"</span></span>; :<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $Rodosanswer;} }</code> </pre></div></div><br>  La fonction FuncRODOS10rele utilise √©galement dans son travail une autre petite fonction de v√©rification de l'adresse r√©seau pour le ping - <b>FuncPing</b> , qui devrait √™tre pr√©sente dans l'environnement des variables de r√©f√©rentiel du routeur pendant le fonctionnement de la fonction principale. <br><br><div class="spoiler">  <b class="spoiler_title">Code "Func_Ping"</b> <div class="spoiler_text"><pre> <code class="hljs mel">:<span class="hljs-keyword"><span class="hljs-keyword">global</span></span> FuncPing <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ :local PingCount <span class="hljs-number"><span class="hljs-number">3</span></span>; #  ; :local Result [/ping $PingAdr count=$PingCount]; :delay <span class="hljs-number"><span class="hljs-number">2</span></span>s; :local PingAnswer <span class="hljs-string"><span class="hljs-string">""</span></span>; :local MainIfInetOk false; :set MainIfInetOk ((<span class="hljs-number"><span class="hljs-number">3</span></span>*$Result) &gt;= (<span class="hljs-number"><span class="hljs-number">2</span></span> * $PingCount)) :put <span class="hljs-string"><span class="hljs-string">"MainIfInetOk=$MainIfInetOk"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$MainIfInetOk) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ :set PingAnswer <span class="hljs-string"><span class="hljs-string">"ERROR"</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($MainIfInetOk) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ :set PingAnswer <span class="hljs-string"><span class="hljs-string">"OK"</span></span> } :<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $PingAnswer;}</code> </pre></div></div><br><h2>  Application de la fonction de commande de relais </h2><br>  Les √©l√©ments suivants doivent √™tre transmis en tant que param√®tres √† la fonction FuncRODOS10rele: <br><br><ul><li>  Radr - adresse IP de l'appareil </li><li>  Rport - port http.  Si le port standard pour http (80) est configur√©, ce param√®tre peut √™tre omis </li><li>  Rrele - le num√©ro du relais sur lequel nous effectuons une action (pour RODOS-10 [1-4]), <br>  pour RODOS-9 [1-2], pour RODOS-8 n'est pas transmis) </li><li>  Rstatus - action en cours ("off" - d√©sactiver; "on" - activer; "inv" - donner une impulsion) </li><li>  Rlogin - connexion, Rpass - mot de passe d'acc√®s √† l'appareil <br>  (s'ils ne sont pas d√©finis, l'appel de commande est utilis√© sans "/ protect") <br></li></ul><br><div class="spoiler">  <b class="spoiler_title">Exemple 1: appeler une fonction avec acc√®s √† la PDU via le port http standard lorsque le "mode prot√©g√©" est d√©sactiv√© dans le module, en activant le relais n ¬∞ 2:</b> <div class="spoiler_text"><pre> <code class="hljs powershell">[<span class="hljs-variable"><span class="hljs-variable">$FuncRODOS10rele</span></span> <span class="hljs-type"><span class="hljs-type">Radr</span></span>=<span class="hljs-string"><span class="hljs-string">"192.168.1.20"</span></span> <span class="hljs-type"><span class="hljs-type">Rrele</span></span>=<span class="hljs-string"><span class="hljs-string">"2"</span></span> <span class="hljs-type"><span class="hljs-type">Rstatus</span></span>=<span class="hljs-string"><span class="hljs-string">"on"</span></span>]</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Exemple 2: appel d'une fonction avec acc√®s √† la PDU via le port http 8021 configur√© avec le ¬´mode prot√©g√©¬ª d√©fini, d√©sactivation du relais n ¬∞ 2</b> <div class="spoiler_text"><pre> <code class="hljs powershell">[<span class="hljs-variable"><span class="hljs-variable">$FuncRODOS10rele</span></span> <span class="hljs-type"><span class="hljs-type">Radr</span></span>=<span class="hljs-string"><span class="hljs-string">"192.168.1.20"</span></span> <span class="hljs-type"><span class="hljs-type">Rport</span></span>=<span class="hljs-string"><span class="hljs-string">"8021"</span></span> <span class="hljs-type"><span class="hljs-type">Rrele</span></span>=<span class="hljs-string"><span class="hljs-string">"2"</span></span> <span class="hljs-type"><span class="hljs-type">Rstatus</span></span>=<span class="hljs-string"><span class="hljs-string">"off"</span></span> <span class="hljs-type"><span class="hljs-type">Rlogin</span></span>=<span class="hljs-string"><span class="hljs-string">"login"</span></span> <span class="hljs-type"><span class="hljs-type">Rpass</span></span>=<span class="hljs-string"><span class="hljs-string">"password"</span></span>]</code> </pre> </div></div><br>  La r√©ponse de la fonction peut √™tre renvoy√©e √† la variable de cha√Æne <b>Rodosanswer</b> . <br><br><div class="spoiler">  <b class="spoiler_title">Rodosanswer peut contenir le texte suivant:</b> <div class="spoiler_text"><pre>  ‚Ä¢ "Succ√®s!" - en cas d'appel r√©ussi et d'ex√©cution d'une √©quipe

  ‚Ä¢ "Fault" - en cas de traitement erron√© et de non-ex√©cution d'une commande

  ‚Ä¢ "ERREUR: d√©calage de plage rele" - si un num√©ro de relais non valide est sp√©cifi√© 
	 dans le param√®tre de la fonction Rrele pour cette version de l'appareil

  ‚Ä¢ "ERREUR: d√©calage du jeu de r√©gimes" - en cas de non sp√©cification ou incorrect 
     le param√®tre sp√©cifi√© de la fonction Rstatus ("on", "off", "inv")

  ‚Ä¢ "ERREUR: l'appareil n'a pas r√©pondu" - s'il n'y a pas de r√©ponse de l'appareil 
     faire un ping

  ‚Ä¢ "ERREUR: commande ROS &lt;fetch&gt;" - en cas d'erreur directement
     lors de l'ex√©cution de la commande RouterOS fetch URL (g√©n√©ralement sinon
     le num√©ro de port sp√©cifi√© dans Rport, param√®tres Rlogine incorrectement sp√©cifi√©s
     et / ou Rpass)
</pre></div></div><br>  Vous pouvez appeler la fonction de contr√¥le de relais sur la PDU √† partir de n'importe lequel de vos autres scripts comme suit: <br><br><ol><li>  Vous devez d'abord ex√©cuter des scripts qui placent les fonctions n√©cessaires dans l'environnement des variables du r√©f√©rentiel du routeur.  Cela peut √™tre fait une fois, par exemple, lors du d√©marrage du routeur √† partir du planificateur RouterOS ( <b>/ planificateur syst√®me</b> ) <br><br><pre> <code class="hljs pgsql">#          /<span class="hljs-keyword"><span class="hljs-keyword">system</span></span> script run Func_RODOS10rele; #      ¬´FuncPing¬ª # (  FuncRODOS10rele) /<span class="hljs-keyword"><span class="hljs-keyword">system</span></span> script run Func_Ping;</code> </pre> </li><li>  Une fois les fonctions d√©finies, vous pouvez les utiliser (en particulier, appeler FuncRODOS10rele) <br><br>  A titre d'exemple, nous appelons notre fonction en appliquant une impulsion au relais n ¬∞ 4 de la PDU RODOS-10: <br><br><pre> <code class="hljs powershell">:global FuncRODOS10rele; :local Rodosanswer [<span class="hljs-variable"><span class="hljs-variable">$FuncRODOS10rele</span></span> <span class="hljs-type"><span class="hljs-type">Radr</span></span>=<span class="hljs-string"><span class="hljs-string">"192.168.1.20"</span></span> <span class="hljs-type"><span class="hljs-type">Rport</span></span>=<span class="hljs-string"><span class="hljs-string">"8021"</span></span> <span class="hljs-type"><span class="hljs-type">Rrele</span></span>=<span class="hljs-string"><span class="hljs-string">"4"</span></span> <span class="hljs-type"><span class="hljs-type">Rstatus</span></span>=<span class="hljs-string"><span class="hljs-string">"inv"</span></span> <span class="hljs-type"><span class="hljs-type">Rlogin</span></span>=<span class="hljs-string"><span class="hljs-string">"login"</span></span> <span class="hljs-type"><span class="hljs-type">Rpass</span></span>=<span class="hljs-string"><span class="hljs-string">"password"</span></span>]; :log info <span class="hljs-variable"><span class="hljs-variable">$Rodosanswer</span></span>;</code> </pre><br>  La r√©ponse sera renvoy√©e √† la variable <b>Rodosanswer</b> et, dans ce cas, affich√©e dans le journal du routeur. <br><br><h2>  Biblioth√®que de fonctions pr√™te √† l'emploi pour travailler avec les PDU </h2><br>  Pour faciliter l'utilisation, j'ai cr√©√© une biblioth√®que de fonctions pour les PDU Rodos des mod√®les 8, 9, 10 et 10 d'ex√©cution DIN (biblioth√®que version 1.0 dat√©e du 25 d√©cembre 2017).  Les scripts de biblioth√®que sont combin√©s dans le fichier Func_RODOS.rsc, qui peut √™tre import√© dans RouterOS par la commande de terminal d'utilitaire WINBOX suivante: <br><br><pre> <code class="hljs swift">/<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> file= Func_RODOS.rsc</code> </pre> <br>  Le processus d'importation peut prendre de 20 secondes √† 1 minute, selon le mod√®le du routeur Mikrotik (sa vitesse). <br>  Dans ce cas, tous les scripts qui √©taient auparavant disponibles dans le routeur ne sont pas affect√©s, les fonctions et les scripts de la biblioth√®que Func_RODOS sont ajout√©s aux scripts de r√©f√©rentiel existants. <br><br><div class="spoiler">  <b class="spoiler_title">La biblioth√®que Rodos.rsc version 1.0 contient les scripts suivants:</b> <div class="spoiler_text"><ul><li>  start_RODOS - l'ex√©cution de ce script d√©finit toutes les fonctions sur des variables d'environnement </li><li>  Func_Ping - la fonction de v√©rification de l'adresse pour "ping" </li><li>  Func_Mail - fonction pour envoyer un message arbitraire au courrier de l'administrateur </li><li>  Func_RODOS8rele - Fonction de contr√¥le du relais PDU RODOS-8 </li><li>  Func_RODOS8reset - fonction de r√©initialisation ("reset") du relais PDU RODOS-8 </li><li>  Func_RODOS9rele - ... de m√™me pour les mod√®les indiqu√©s ... </li><li>  Func_RODOS9reset </li><li>  Func_RODOS10rele </li><li>  Func_RODOS10reset </li><li>  call_example [...] - exemples d'appels de fonction de biblioth√®que </li><li>  Func_RODOS_lib - toutes les fonctions PDU (sauf Ping et Mail) dans un fichier de script </li></ul></div></div><br>  Apr√®s avoir import√© la biblioth√®que, vous pouvez supprimer les fonctions et scripts inutiles du r√©f√©rentiel, ne laissant que les fonctions de votre mod√®le PDU et de vos scripts avec les fonctions FuncMail et FuncPing. <br><br>  Dans la biblioth√®que, pour chacun des mod√®les de PDU pris en charge, il existe √©galement des fonctions de r√©initialisation ("reset") pratiques (marqu√©es dans les noms par "~ reset").  Les param√®tres des fonctions de r√©initialisation sont similaires aux param√®tres des fonctions d'installation du relais, √† l'exception du param√®tre ¬´Rstatus¬ª, qui n'est pas utilis√© pendant la ¬´r√©initialisation¬ª et du param√®tre facultatif facultatif Rtime, qui d√©finit le temps en secondes entre la coupure et la remise en marche du relais (si Rtime n'est pas transmis √† la fonction, est utilis√© par d√©faut 5 secondes). <br><br>  Les fonctions de red√©marrage fonctionnent comme suit: <br><ol><li>  Le relais sp√©cifi√© re√ßoit une commande d'arr√™t </li><li>  Ensuite, il attend Rtime secondes avec la commande d'inclusion suivante.  Dans ce cas, les fonctions de r√©initialisation se r√©f√®rent aux fonctions d'installation de relais correspondantes, qui doivent √™tre d√©termin√©es avant la premi√®re </li></ol><br>  Ainsi, si, avant l'appel √† la fonction de r√©initialisation, un certain relais √©tait activ√©, il sera d√©sactiv√© et apr√®s une heure sp√©cifi√©e sera r√©activ√© (et la charge qui lui est connect√©e sera "r√©initialis√©e").  Une op√©ration similaire est effectu√©e sur un relais d√©sactiv√©, et apr√®s l'activation de la fonction, le relais est activ√© (c'est-√†-dire que dans ce cas, la fonction se remplit en tant que fonction de commutation de relais).  Il est pratique d'utiliser les fonctions de r√©initialisation pour red√©marrer les √©quipements r√©seau ¬´bloqu√©s¬ª connect√©s aux PDU Rodos (points d'acc√®s, routeurs, commutateurs, divers serveurs, etc ...). <br><br>  Les codes sources de la biblioth√®que Rodos.rsc (fonctions et scripts, exemples d'acc√®s) sont ¬´comment√©s¬ª avec suffisamment de d√©tails, ce qui peut √™tre utile √† ceux qui veulent comprendre la biblioth√®que en d√©tail (ou peut-√™tre les modifier vous-m√™me ou √©crire votre propre version). <br><br>  Dans les exemples d'appels aux fonctions de red√©marrage, une fois la fonction √©labor√©e, il est possible d'envoyer des messages √† l'adresse e-mail de l'administrateur du routeur (vous pouvez sp√©cifier votre adresse e-mail dans les param√®tres de variable de script).  Dans ce cas, les scripts utilisent le service de messagerie RouterOS √† partir de <b>/ tool e-mail</b> , dont les param√®tres doivent √™tre correctement configur√©s √† l'avance par vous. <br><br><h2>  Plans futurs </h2><br>  √Ä l'avenir, la biblioth√®que de scripts pour les PDU Rodos sera √©tendue - il est pr√©vu de cr√©er des fonctions pour la station m√©t√©o Internet RODOS-16, qui a ¬´√† bord¬ª, en plus des relais, des lignes d'entr√©e / sortie et des capteurs de temp√©rature / humidit√© / pression atmosph√©rique.  Il est √©galement pr√©vu d'impl√©menter la journalisation des fonctions non seulement dans le journal et le courrier du routeur, mais √©galement dans le num√©ro de t√©l√©phone sp√©cifi√© par l'utilisateur (en envoyant des SMS via le modem du routeur). <br><br>  Peut-√™tre, dans le processus d'utilisation de la biblioth√®que par les utilisateurs (y compris les lecteurs de ce mat√©riel), certaines erreurs seront r√©v√©l√©es, qui, en r√®gle g√©n√©rale, sont in√©vitables lors de tout d√©veloppement.  Veuillez m'informer de toute erreur, commentaire et suggestion pour leur correction. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Lien vers la description de la commande Fetch pour les routeurs MikroTik</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Lien vers la documentation des PDU utilis√©es</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Lien vers la biblioth√®que de fonctions de script pour la PDU Rodos</a> <br><br>  Serkov Sergey Vladimirovich, 26 d√©cembre 2017 </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr410107/">https://habr.com/ru/post/fr410107/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr410093/index.html">Un quadricopt√®re canadien ob√©it aux grimaces de l'op√©rateur</a></li>
<li><a href="../fr410095/index.html">Un passionn√© d'informatique a assembl√© un processeur 8 bits √† partir des mat√©riaux disponibles</a></li>
<li><a href="../fr410099/index.html">Le MIT a expliqu√© comment se forment les habitudes</a></li>
<li><a href="../fr410103/index.html">L'ADN √† travers les yeux d'un programmeur</a></li>
<li><a href="../fr410105/index.html">Interface DALI et Arduino. V√©ritable surr√©alisme</a></li>
<li><a href="../fr410109/index.html">Le botnet Smominru aide les attaquants √† gagner plus de 3,6 millions de dollars</a></li>
<li><a href="../fr410111/index.html">Un candidat pour les membranes cellulaires trouv√© sur Titan</a></li>
<li><a href="../fr410113/index.html">Le plus petit lanceur a lanc√© avec succ√®s un satellite en orbite</a></li>
<li><a href="../fr410115/index.html">Sixi√®me DIY Mitap chez Mail.Ru Group (18/02/2018)</a></li>
<li><a href="../fr410117/index.html">Les chercheurs ont sugg√©r√© comment suivre un smartphone avec le GPS d√©sactiv√©.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>