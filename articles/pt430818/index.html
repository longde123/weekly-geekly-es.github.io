<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§¶üèª üßîüèª üßëüèø‚Äçü§ù‚Äçüßëüèº Acelera√ß√£o SQLAlchemy para astronautas arquitet√¥nicos üë©üèΩ‚Äçüî¨ üè® ‚≠êÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Habr, este √© um relat√≥rio do engenheiro de software Alexei Starkov na confer√™ncia Moscow Python Conf ++ 2018 em Moscou. V√≠deo no final da postagem.  O...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Acelera√ß√£o SQLAlchemy para astronautas arquitet√¥nicos</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/qrator/blog/430818/"><img src="https://habrastorage.org/webt/nk/mr/3o/nkmr3o45oaha-8h6n1elhxx3nai.png"><br><blockquote> Habr, este √© um relat√≥rio do engenheiro de software Alexei Starkov na confer√™ncia Moscow Python Conf ++ 2018 em Moscou.  V√≠deo no final da postagem. </blockquote>  Ol√° pessoal!  Meu nome √© Alexei Starkov - sou eu, nos meus melhores anos, trabalho em uma f√°brica. <br>  Agora eu trabalho no Qrator Labs.  Basicamente, durante toda a minha vida, estudei C e C ++ - adoro Alexandrescu, The Gang of Four, os princ√≠pios do SOLID - √© tudo.  O que me torna um astronauta arquitet√¥nico.  Eu tenho escrito Python nos √∫ltimos dois anos, porque eu gosto. <br><br>  Na verdade, quem s√£o os "cosmonautas da arquitetura"?  A primeira vez que conheci esse termo com Joel Spolsky, voc√™ provavelmente o leu.  Ele descreve os "astronautas" como pessoas que desejam construir uma arquitetura ideal que se baseia na abstra√ß√£o, na abstra√ß√£o, na abstra√ß√£o, que est√° se tornando cada vez mais geral.  No final, esses n√≠veis s√£o t√£o altos que descrevem todos os programas poss√≠veis, mas n√£o resolvem problemas pr√°ticos.  Neste momento, o "astronauta" (esta √© a √∫ltima vez que este termo √© cercado por aspas) fica sem ar e ele morre. <br><br>  Tamb√©m tenho tend√™ncias para a explora√ß√£o do espa√ßo arquitet√¥nico, mas neste relat√≥rio falarei um pouco sobre como isso me afetou e n√£o me permitiu construir um sistema com o desempenho necess√°rio.  O principal √© como eu superei isso. <br><br>  Resumo do meu relat√≥rio: foi / foi. <br><a name="habracut"></a><br><img src="https://habrastorage.org/webt/wj/_u/7c/wj_u7c0h2uaody3dj48xsbytsb4.png"><br><br>  Um aumento de milhares e milh√µes de vezes.  Quando eu fiz este slide, o √∫nico pensamento que eu tinha era "Como?" <br><br><img src="https://habrastorage.org/webt/of/cb/q_/ofcbq_bd033u4wh31hzexjkstfc.png"><br><br>  Onde eu poderia estragar tanto?  Se voc√™ n√£o quer estragar como eu - continue a ler. <br><br><img src="https://habrastorage.org/webt/md/ni/gt/mdnigtyu3igzmlqmcf89isptecc.png"><br><br>  Vou falar sobre o sistema de configura√ß√£o.  O sistema de configura√ß√£o √© uma ferramenta interna do Qrator Labs que armazena configura√ß√µes para a Rede Definida por Software (SDN) - nossa rede de filtragem.  Ele est√° comprometido em sincronizar a configura√ß√£o entre componentes e monitorar seu status. <br><br><img src="https://habrastorage.org/webt/xz/kg/zr/xzkgzr2wrphmvslxnx3v2qezxta.png"><br><br>  Em que consiste, em suma,?  Temos um banco de dados que armazena um instant√¢neo de nossa configura√ß√£o para toda a rede e temos um servidor que processa os comandos que chegam a ele e de alguma forma altera a configura√ß√£o. <br><br>  Nossos administradores e clientes t√©cnicos chegam a esse servidor e por meio do console, pelas APIs de terminal, APIs REST, JSON RPC e outras coisas que emitem comandos para o servidor, como resultado do qual ele altera nossa configura√ß√£o. <br><br>  As equipes podem ser muito simples ou mais complicadas.  Ent√£o, temos um certo conjunto de receptores que comp√µem nosso SDN e o servidor envia a configura√ß√£o a esses receptores.  Isso parece bem simples.  Basicamente, vou falar sobre essa parte. <br><br><img src="https://habrastorage.org/webt/yp/uq/c7/ypuqc7pzaeqvmbzsrksb9gefq-w.png"><br><br>  Como √© ela quem est√° relacionada ao banco de dados e √† alquimia. <br><br><img src="https://habrastorage.org/webt/qg/sz/np/qgsznprvrp4smdpbuoxopevxxt4.png"><br><br>  Qual √© a peculiaridade deste sistema?  √â bem pequeno - med√≠ocre.  Centenas de milhares, at√© milh√µes, de entidades s√£o armazenadas neste banco de dados.  A peculiaridade √© que o gr√°fico das rela√ß√µes entre entidades √© bastante complexo.  Existem v√°rias hierarquias de heran√ßa entre entidades, existem inclus√µes, existem simplesmente depend√™ncias entre elas.  Todas essas restri√ß√µes s√£o determinadas pela l√≥gica de neg√≥cios e devemos cumpri-las. <br><br>  A propor√ß√£o de solicita√ß√µes de grava√ß√£o para solicita√ß√µes de leitura √© de aproximadamente 15: 1.  Aqui est√° claro: existem muitos comandos para alterar a configura√ß√£o e, uma vez em um determinado per√≠odo de tempo, enviamos a configura√ß√£o para os pontos finais. <br><br>  O MySQL √© usado internamente - tamb√©m est√° dispon√≠vel em outros produtos da nossa empresa, temos uma experi√™ncia bastante s√©ria nesse banco de dados, existem pessoas que podem trabalhar com ele: criar um esquema de dados, criar consultas e tudo mais.  Portanto, tomamos o MySQL como um banco de dados relacional universal. <br><br><img src="https://habrastorage.org/webt/x0/xs/ae/x0xsae3wqaqw4dfth-y8q7i3tqk.png"><br><br>  Qual foi o problema depois que projetamos esse sistema?  A execu√ß√£o de um comando levou de um a trinta segundos, dependendo da complexidade da equipe.  Consequentemente, o atraso na execu√ß√£o chegou a cinco minutos.  Uma equipe chegou - 30 segundos, o segundo e assim por diante, uma pilha de acumulados - um atraso de 5 minutos. <br><br>  O atraso na aplica√ß√£o da configura√ß√£o √© de at√© dez minutos.  Foi decidido que isso n√£o era suficiente para n√≥s e que a otimiza√ß√£o era necess√°ria. <br><br><img src="https://habrastorage.org/webt/ah/6t/fj/ah6tfjmleq-fzvoecldzw5qxxu0.png"><br><br>  Primeiro, antes de realizar qualquer otimiza√ß√£o, √© necess√°rio realizar uma investiga√ß√£o e descobrir qual √© realmente o problema. <br><br><img src="https://habrastorage.org/webt/nu/wf/g6/nuwfg6v2hg2jangw6agmu9i6bw0.png"><br><br>  Como se viu, n√£o t√≠nhamos o componente mais importante para a investiga√ß√£o - n√£o t√≠nhamos telemetria.  Portanto, se voc√™ estiver projetando algum tipo de sistema, primeiro, no est√°gio de design, coloque telemetria nele.  Mesmo que o sistema seja inicialmente pequeno, um pouco mais e mais - no final, todo mundo chega a uma situa√ß√£o em que voc√™ precisa assistir a trilhas, mas n√£o h√° telemetria. <br><br><img src="https://habrastorage.org/webt/eh/ws/3t/ehws3tezqmrdlvfcljs1pxbttgm.png"><br><br>  O que pode ser feito a seguir se voc√™ n√£o tiver telemetria?  Voc√™ pode analisar os logs.  Aqui, scripts bastante simples passam por nossos logs e os transformam em uma tabela, ilustrando os tempos de execu√ß√£o de comando mais r√°pidos, lentos e m√©dios.  A partir daqui, j√° podemos ver em quais lugares temos piadas: quais equipes demoram mais para serem executadas e quais s√£o mais r√°pidas. <br><br><img src="https://habrastorage.org/webt/m6/0a/gc/m60agccykga4hl82ktrjfjglzqq.png"><br><br>  A √∫nica coisa a observar √© que, ao analisar os logs, consideramos apenas o tempo de execu√ß√£o desses comandos no servidor.  Este √© o primeiro est√°gio - o marcado como t2.  t1 - √© assim que o cliente ver√° o tempo de execu√ß√£o de nossa equipe: entrando na fila, aguardando, execu√ß√£o no servidor.  Como esse tempo ser√° mais longo, otimizamos o tempo t2 e, em seguida, usamos o tempo t1 para determinar se atingimos a meta. <br><br>  t1 √© a m√©trica da qualidade do nosso desempenho. <br><br><img src="https://habrastorage.org/webt/dx/dd/05/dxdd05sisxq1ciu6nu-na0zons8.png"><br><br>  Dessa forma, √© assim que criamos o perfil de todas as equipes - ou seja, pegamos o log do servidor, conduzimos por nossos scripts, analisamos e identificamos os componentes que funcionavam mais lentamente.  O servidor √© constru√≠do de forma bastante modular, um componente separado √© respons√°vel por cada comando e podemos criar um perfil individual dos componentes - e fazer benchmarks para eles.  Ent√£o, aqui tivemos uma classe - para cada componente problem√°tico que escrevemos, no qual em code_under_test () realizamos alguma atividade representando o uso de combate do componente.  E havia dois m√©todos: profile () e bench ().  A primeira chama cProfile, mostrando quantas vezes o que foi chamado, onde est√£o os gargalos. <br><br>  bench () foi executado v√°rias vezes e considerou m√©tricas diferentes para n√≥s - foi assim que avaliamos o desempenho. <br><br>  Mas acabou que este n√£o √© o problema! <br><br><img src="https://habrastorage.org/webt/wz/r8/-p/wzr8-pc9epal61cjoraog7bkvxc.png"><br><br>  O principal problema foi o n√∫mero de consultas ao banco de dados.  Havia muitos pedidos e, para entender por que havia tantos, vejamos como tudo foi organizado. <br><br><img src="https://habrastorage.org/webt/bg/r0/rz/bgr0rzhohcouyykpc3raznbi4rq.png"><br><br>  √Ä nossa frente est√° um peda√ßo de um circuito simples que representa nossos receptores, apresentado na forma da classe Receptor.  Eles est√£o unidos em algum grupo receptor - grupo.  E, consequentemente, existem alguns planos de configura√ß√£o - fatias da configura√ß√£o, que s√£o um subconjunto das configura√ß√µes que s√£o respons√°veis ‚Äã‚Äãpor uma "fun√ß√£o" desse receptor.  Por exemplo, para roteamento - plano de roteamento.  As plan√≠cies com receptores podem ser conectadas em qualquer ordem - ou seja, esse √© um relacionamento de muitos para muitos. <br><br>  Este √© um peda√ßo do grande esbo√ßo que estou apresentando aqui para que os exemplos possam ser melhor compreendidos. <br><br>  O que todo cosmonauta de arquitetura quer fazer quando v√™ a API de outra pessoa?  Ele quer ocult√°-lo, abstrair e escrever sua interface para poder remover esta API, ou melhor, ocult√°-la. <br><br><img src="https://habrastorage.org/webt/nq/zq/7-/nqzq7-zlnbxkkmy7mywbp8lqvq4.png"><br><br>  Assim, existe uma API "suja" da alquimia, na qual existem, de fato, mapeadores e nossa classe "pura" - Receiver, na qual algumas configura√ß√µes s√£o armazenadas e existem m√©todos: load (), save (), delete ().  E todas as outras classes associadas a ele.  N√≥s obtemos um gr√°fico de objetos Python, de alguma forma conectados entre si - cada um deles possui um m√©todo load (), save (), delete (), que se refere ao mapeador de alquimia, que, por sua vez, chama a API. <br><br><img src="https://habrastorage.org/webt/cs/bo/lr/csbolr6uozuvbxhimmqik_llgak.png"><br><br>  A implementa√ß√£o aqui √© muito simples.  Temos um m√©todo de carregamento que faz uma consulta ao banco de dados e, para cada objeto recebido, cria seu pr√≥prio objeto Python.  Existe um m√©todo de salvamento que faz a opera√ß√£o oposta - parece que existe um objeto no banco de dados usando a chave prim√°ria, caso contr√°rio - ele cria, adiciona e, em seguida, salvamos o estado desse objeto.  excluir na chave prim√°ria recebe e exclui o objeto do banco de dados. <br><br><img src="https://habrastorage.org/webt/fl/hq/lp/flhqlp2vg6srgo7wswpbowrlq6e.png"><br><br>  O principal problema √© imediatamente vis√≠vel - este √© o mapeamento.  Primeiro, fazemos isso uma vez do objeto Python para o mapeador, depois o mapeador para a base.  O mapeamento adicional √© uma ou duas chamadas, o que pode n√£o ser t√£o assustador ainda.  O principal problema foi a sincroniza√ß√£o manual.  Temos dois objetos de nossa interface "limpa" e um deles altera o atributo - como vemos que o atributo mudou no outro?  De jeito nenhum.  √â necess√°rio mesclar as altera√ß√µes no banco de dados e obter o atributo em outro objeto.  Obviamente, se sabemos que os objetos est√£o presentes no mesmo contexto, podemos rastrear isso.  Mas se tivermos duas sess√µes em lugares diferentes - apenas atrav√©s da base ou bloquear a base na mem√≥ria, o que n√£o fizemos. <br><br>  Esse carregamento / salvamento / exclus√£o √© outro mapeador que duplica completamente o interior da alquimia, que √© bem escrito e testado.  Essa ferramenta tem muitos anos, existe muita ajuda na Internet e a duplica√ß√£o tamb√©m n√£o √© muito boa. <br><br>  Veja o √≠cone no canto superior direito?  Marcarei os slides nos quais algo √© feito para "pureza", para aumentar o n√≠vel de abstra√ß√£o, para a astron√°utica arquitet√¥nica.  Ou seja, slides sem esse √≠cone s√£o pragm√°ticos e chatos, desinteressantes e n√£o podem ser lidos. <br><br>  O que fazer se muitas consultas forem lentas.  Quantos?  Na verdade muito.  Imagine uma cadeia de heran√ßa: um objeto, ele tem um pai, que um tem outro pai.  Sincronizamos o objeto filho - para fazer isso, primeiro voc√™ precisa sincronizar os pais.  Para sincronizar um pai, voc√™ precisa sincronizar seu pai.  Bem, todo mundo estava sincronizado.  De fato, dependendo de como constru√≠mos o gr√°fico, podemos caminhar e sincronizar todos esses objetos centenas de vezes - da√≠ um grande n√∫mero de solicita√ß√µes. <br><br><img src="https://habrastorage.org/webt/zo/n7/uh/zon7uhhtngwjd5rnaztxexuatsu.png"><br><br>  O que fizemos?  Pegamos toda a nossa l√≥gica de neg√≥cios e a colocamos no mapeador.  Todos os outros objetos aqui tamb√©m se fundiram com os mapeadores, e toda a nossa API, toda a camada de abstra√ß√£o de dados, ficou suja. <br><br><img src="https://habrastorage.org/webt/qn/4a/fz/qn4afzy7q6yrh0t-yw4r4m6c9se.png"><br><br>  √â assim que fica em Python - nosso mapeador possui algum tipo de l√≥gica de neg√≥cios, h√° uma descri√ß√£o declarativa dessa placa ali.  Colunas s√£o listadas, relacionamentos.  Aqui n√≥s temos essa classe. <br><br><img src="https://habrastorage.org/webt/ez/ud/sg/ezudsgqk1b9domctg8sdvzh4uj8.png"><br><br>  Obviamente, do ponto de vista de qualquer astronauta, uma API suja √© uma desvantagem.  L√≥gica comercial em uma descri√ß√£o declarativa da base.  Os esquemas s√£o misturados √† l√≥gica de neg√≥cios.  Ufa.  Feio. <br><br>  A descri√ß√£o do circuito est√° confusa.  Na verdade, isso √© um problema - se a l√≥gica de neg√≥cios n√£o tiver duas linhas, mas um volume maior, nessa classe, precisamos rolar ou procurar por um per√≠odo muito longo para obter descri√ß√µes espec√≠ficas.  Antes disso, tudo era bonito: em um lugar a descri√ß√£o da base, declarativa, descri√ß√£o dos esquemas, em outro lugar, a l√≥gica de neg√≥cios.  E ent√£o o circuito est√° confuso. <br><br>  Mas, por outro lado, obtemos imediatamente os mecanismos da alquimia: unidade de trabalho, que permite rastrear quais objetos est√£o sujos e quais rel√©s precisam ser atualizados;  obtemos um relacionamento que nos permite eliminar perguntas adicionais no banco de dados, sem garantir que as cole√ß√µes relevantes sejam preenchidas;  e o mapa de identidade que mais nos ajudou.  O mapa de identidade garante que dois objetos Python ser√£o o mesmo objeto Python se eles tiverem a mesma chave prim√°ria. <br><br>  Consequentemente, reduzimos imediatamente a complexidade para linear. <br><br><img src="https://habrastorage.org/webt/j4/ek/x8/j4ekx8dvwphpdavetrxejd1uvxg.png"><br><br>  Estes s√£o resultados intermedi√°rios.  O desempenho aumentou imediatamente 10 vezes, o n√∫mero de consultas ao banco de dados caiu cerca de 40-80 vezes e o RPS aumentou para 1-5.  Bem bom.  Mas a API est√° suja.  O que fazer <br><br><img src="https://habrastorage.org/webt/kj/po/hs/kjpohswqs8svlzroeizbub0tpmk.png"><br><br>  Mixins.  Adotamos a l√≥gica de neg√≥cios, novamente a removemos do nosso mapeador, mas, para que n√£o haja mais mapeamento, herdaremos nosso mapeador dentro da alquimia da nossa combina√ß√£o.  Por que n√£o o contr√°rio?  Isso n√£o funcionar√° na alquimia, ela jurar√° e dir√°: "Voc√™ tem duas classes diferentes referentes a um tablet, n√£o h√° poliformismo - v√° daqui".  E assim - √© poss√≠vel. <br><br>  Portanto, temos uma descri√ß√£o declarativa no mapeador, que √© herdada do mixin e recebe toda a l√≥gica de neg√≥cios.  Muito confort√°vel  E o resto das aulas s√£o exatamente iguais.  Parece - legal, tudo est√° limpo.  Mas h√° uma ressalva - as conex√µes e os rel√©s permanecem dentro da alquimia e, quando, digamos, nos unimos atrav√©s de uma tabela secund√°ria de placas intermedi√°rias, o mapeador dessa placa estar√° presente no c√≥digo do cliente, o que n√£o √© muito bonito. <br><br>  A alquimia n√£o teria sido uma estrutura t√£o boa e famosa se n√£o tivesse me dado a oportunidade de lutar contra isso. <br><br><img src="https://habrastorage.org/webt/g6/dz/gg/g6dzggup-pvokdl7h4mguhedazc.png"><br><br>  Como √© o mixin.  Ele tem l√≥gica de neg√≥cios, mapeadores separadamente, uma descri√ß√£o declarativa do prato.  As conex√µes permanecem dentro da alquimia, mas a l√≥gica de neg√≥cios √© separada. <br><br>  Como √© o esquema geral? <br><br><img src="https://habrastorage.org/webt/xl/1c/eh/xl1cehyjtaoqytk_gz5h-wbc5we.png"><br><br>  Temos um arquivo com um esquema no qual todas as nossas classes declarativas s√£o coletadas - vamos cham√°-lo de schema.py.  E temos entidades na l√≥gica de neg√≥cios, separadamente.  E essas entidades s√£o herdadas dentro do arquivo do esquema - escrevemos uma classe separada para cada entidade e a herdamos no esquema.  Assim, a l√≥gica de neg√≥cios est√° em uma pilha, o esquema em outra e elas podem ser alteradas independentemente. <br><br><img src="https://habrastorage.org/webt/rj/cl/ql/rjclqll79e8wcjwkjfxova8hhpe.png"><br><br>  Como exemplo de aprimoramento, consideraremos um esquema simples de dois r√≥tulos: receptores (tabela Receiver) e fatias da configura√ß√£o (tabela ReceiverPlanes).  Fatias de configura√ß√£o muitos para um s√£o associadas ao r√≥tulo do receptor.  N√£o h√° nada particularmente complicado. <br><br>  Para ocultar relacionamentos dentro da interface "suja" da alquimia, usamos relacionamentos e cole√ß√µes. <br><br><img src="https://habrastorage.org/webt/mz/ih/qg/mzihqg-lfqb8vhflbkxjpf8igp8.png"><br><br>  Eles nos permitem ocultar nossos mapeadores do c√≥digo do cliente. <br><br><img src="https://habrastorage.org/webt/y8/qc/v1/y8qcv1qj8_jq3y_pn-2xw-t6bji.png"><br><br>  Em particular, duas cole√ß√µes muito √∫teis s√£o association_proxy e attribute_mapped_collection.  N√≥s os usamos juntos.  Como a rela√ß√£o cl√°ssica funciona na alquimia: temos uma rela√ß√£o - essa √© uma certa cole√ß√£o, lista, mapeadores.  Mapeadores s√£o objetos de relacionamento de ponta remota.  Attribute_mapped_collection permite substituir esta lista por um ditado, as chaves nas quais ser√£o alguns dos atributos dos mapeadores e os valores s√£o os pr√≥prios mapeadores. <br><br>  Este √© o primeiro passo. <br><br><img src="https://habrastorage.org/webt/ho/tj/tt/hotjtty0hmg99f_kquecwyo4ms4.png"><br><br>  O segundo passo, fazemos associa√ß√£o_proxy sobre esse relacionamento.  Ele nos permite n√£o passar o mapeador para a cole√ß√£o, mas passar algum valor que posteriormente ser√° usado para inicializar nosso mapeador, ReceiverPlanes. <br><br>  Aqui temos lambda, na qual passamos a chave e o valor.  A chave se transforma no nome da fatia de configura√ß√£o e o valor no valor da fatia de configura√ß√£o.  Como resultado, no c√≥digo do cliente, tudo se parece com isso. <br><br><img src="https://habrastorage.org/webt/ko/00/s7/ko00s71bgaxu6i-h_baocnnqz-w.png"><br><br>  Apenas colocamos algum tipo de ditado em algum tipo de dicion√°rio.  Tudo funciona: sem mapeadores, sem alquimia, sem bancos de dados. <br><br>  √â verdade que existem armadilhas. <br><br><img src="https://habrastorage.org/webt/ux/ji/uy/uxjiuybsymdbtrvqlazqhckdv8c.png"><br><br>  Se atribuirmos valores diferentes, ou mesmo um, √† mesma chave duas vezes - lambda √© chamado para cada item definido, um objeto √© criado - um mapeador.  E, dependendo de como o esquema est√° estruturado, isso pode levar a v√°rias consequ√™ncias, de ‚Äúapenas viola√ß√µes das constantes‚Äù a conseq√º√™ncias imprevis√≠veis.  Por exemplo, voc√™ meio que excluiu um objeto da cole√ß√£o, mas ele ainda permaneceu l√°: voc√™ excluiu apenas um.  Quando comecei, matei muito tempo com essas coisas. <br><br>  E um pouco de sincroniza√ß√£o impl√≠cita.  Association_proxy e attribute_mapped_collection podem demorar um pouco: quando criamos um objeto mapeador, ele √© adicionado ao banco de dados, mas ainda n√£o est√° presente no atributo collection.  Aparecer√° apenas quando o atributo expirar nesta sess√£o.  Quando expirar, uma nova sincroniza√ß√£o com o banco de dados ocorrer√° e chegar√° l√°. <br><br>  Para superar isso, usamos nossas pr√≥prias cole√ß√µes auto-escritas.  Isso nem √© alquimia - voc√™ pode simplesmente criar sua pr√≥pria cole√ß√£o para superar tudo isso. <br><br><img src="https://habrastorage.org/webt/bk/l6/ya/bkl6yaerwagttjp6qprlfbsdpaw.png"><br><br>  H√° mais c√≥digo e a parte mais importante √© destacada.  Temos uma certa cole√ß√£o que herda de mapeamento mut√°vel - este √© um ditado, nas chaves das quais voc√™ pode alterar os valores.  E existe um m√©todo _get_plane_obj - para obter o objeto de fatia de configura√ß√£o. <br><br>  Aqui fazemos coisas simples - tentamos obt√™-lo pelo nome, por alguma chave prim√°ria e, se n√£o for, criamos e retornamos esse objeto. <br><br>  Em seguida, redefinimos apenas dois m√©todos: __setitem__ e __getitem__ <br>  No __setitem__, colocamos esses objetos em nossa cole√ß√£o, em um relacionamento.  A √∫nica coisa √© que atribu√≠mos valor no final.  Assim, implementamos o mesmo mecanismo que o association_proxy - transmite o valor, dite para ele e ele √© atribu√≠do ao atributo correspondente. <br><br>  __getitem__ faz a manipula√ß√£o inversa.  Ele recebe por chave algum objeto do rel√© e retorna seu atributo.  H√° tamb√©m uma pequena armadilha aqui - se voc√™ armazenar em cache a cole√ß√£o dentro do nosso mapeamento, √© poss√≠vel sair um pouco da sincroniza√ß√£o.  Como quando o atributo da cole√ß√£o expira na alquimia, a cole√ß√£o √© substitu√≠da por outra, ap√≥s a expira√ß√£o.  Portanto, podemos manter a refer√™ncia √† cole√ß√£o antiga e n√£o saber que a antiga expirou e que uma nova j√° apareceu.  Portanto, na √∫ltima parte, vamos diretamente para a inst√¢ncia da alquimia, novamente obtemos a cole√ß√£o atrav√©s de __getattr__ e fazemos __getitem__ com ela.  Ou seja, n√£o podemos armazenar em cache a cole√ß√£o Planes aqui. <br><br><img src="https://habrastorage.org/webt/_0/l6/tt/_0l6tt3pcdjmsxlwy2hivf1b4ty.png"><br><br>  Como essa cole√ß√£o afeta nossos mixins?  Como sempre - configure um atributo de cole√ß√£o.  O √∫nico lugar interessante √© que, quando carregamos uma inst√¢ncia do banco de dados, o m√©todo __init__ n√£o √© chamado.  Todos os atributos s√£o substitu√≠dos ex post. <br><br>  A alquimia fornece um decorador de reconstrutor padr√£o, que permite marcar algum m√©todo como sendo chamado ap√≥s o carregamento de um objeto do banco de dados.  E apenas no momento da inicializa√ß√£o, precisamos inicializar nossa cole√ß√£o.  O eu √© apenas essa inst√¢ncia.  O uso √© exatamente o mesmo que no exemplo anterior. <br><br><img src="https://habrastorage.org/webt/qe/yr/h4/qeyrh4fd3cmfpm8-exbfd1rwpkw.png"><br><br>  Mas em nosso esquema, os ouvidos do banco de dados ainda est√£o vis√≠veis - essa √© a configura√ß√£o.  Que tipo de configura√ß√£o?  √â varchar ou √© blob?  De fato, o cliente n√£o est√° interessado.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ele deve trabalhar com entidades abstratas de seu n√≠vel. </font><font style="vertical-align: inherit;">Para isso, a alquimia fornece decora√ß√£o tipo. </font></font><br><br><img src="https://habrastorage.org/webt/ds/lc/ic/dslcicbf3yrljfchfwbxhcucleq.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um exemplo simples. </font><font style="vertical-align: inherit;">Nosso banco de dados armazena o endere√ßo IP como um varchar. </font><font style="vertical-align: inherit;">Utilizamos a classe TypeDecorator, que faz parte da alquimia, que permite, primeiro, indicar qual tipo de banco de dados subjacente ser√° usado para esse tipo e, em segundo lugar, definir dois par√¢metros: process_bind_param convertendo o valor para o tipo de banco de dados e process_result_value quando valorizamos do tipo de banco de dados, converta para um objeto Python.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O atributo do endere√ßo assume o tipo python IPAddress. E podemos chamar m√©todos desse tipo e atribuir objetos desse tipo a ele, e tudo funciona para n√≥s. E est√° armazenado no banco de dados ... n√£o sei o que est√° armazenado, varchar (45), mas podemos substituir essa linha e o blob ser√° armazenado. Ou, se algum tipo nativo suportar endere√ßos IP, voc√™ poder√° us√°-lo. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O c√≥digo do cliente n√£o depende disso, n√£o precisa ser reescrito. </font></font><br><br><img src="https://habrastorage.org/webt/xb/m5/uu/xbm5uu_ryeji94kthsv0rp2ogdw.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Outra coisa interessante √© que temos uma vers√£o. Queremos que assim que mudarmos nosso objeto, a vers√£o aumente imediatamente. Temos algum contador de vers√£o, alteramos o objeto - ele mudou, a vers√£o aumentou. Fazemos isso automaticamente para n√£o esquecer.</font></font><br><br><img src="https://habrastorage.org/webt/zy/g5/ro/zyg5rofkv1ibi-yb-kuv3kikbww.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para isso, usamos eventos. Eventos s√£o eventos que ocorrem em diferentes est√°gios da vida de um mapeador e podem ser acionados quando os atributos mudam, quando uma entidade muda de um estado para outro, por exemplo, "criado", "salvo no banco de dados", "carregado a partir do banco de dados", "exclu√≠do"; e tamb√©m - em eventos no n√≠vel da sess√£o, antes que o c√≥digo sql seja emitido no banco de dados, antes da confirma√ß√£o, ap√≥s a confirma√ß√£o e tamb√©m ap√≥s a revers√£o. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A alquimia nos permite atribuir manipuladores para todos esses eventos, mas a ordem na qual os manipuladores s√£o executados para o mesmo evento n√£o √© garantida. Ou seja, √© espec√≠fico, mas n√£o se sabe qual. Portanto, se a ordem de execu√ß√£o for importante para voc√™, ser√° necess√°rio executar um mecanismo de registro. </font></font><br><br><img src="https://habrastorage.org/webt/wb/h2/w1/wbh2w1k4s4y6jqemt4oatlknwug.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aqui est√° um exemplo. Tr√™s eventos s√£o usados ‚Äã‚Äãaqui:</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on_before_flush - antes que o c√≥digo sql seja emitido para o banco de dados, examinamos todos os objetos que a alquimia marcou como sujos nesta sess√£o e verificamos se esse objeto foi modificado ou n√£o. Por que isso √© necess√°rio se a alquimia j√° marcou tudo? A alquimia marca um objeto como sujo assim que algum atributo √© alterado. Se atribuirmos o mesmo valor a esse atributo que ele possu√≠a, ele ser√° marcado como sujo. Existe um m√©todo de sess√£o is_modified para isso - ele √© usado internamente, n√£o o desenhei. Al√©m disso, do ponto de vista de nossa sem√¢ntica, do ponto de vista de nossa l√≥gica de neg√≥cios, mesmo que o atributo tenha sido alterado, o objeto ainda pode permanecer inalterado. Por exemplo, h√° uma certa lista na qual dois elementos s√£o trocados - do ponto de vista da alquimia, o atributo foi alterado, mas isso n√£o importa para a l√≥gica de neg√≥cios se, por exemplo,algum tipo.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">E, no final, chamamos outro m√©todo espec√≠fico para cada objeto para entender se o objeto √© ou n√£o modificado. E n√≥s os adicionamos a uma determinada vari√°vel associada √† sess√£o que criamos - esta √© a nossa vari√°vel dirty_instances, na qual adicionamos esse objeto. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O seguinte evento ocorre antes do commit - before_commit. H√° tamb√©m uma pequena armadilha: se n√£o tivermos um √∫nico flush para toda a transa√ß√£o, o flush ser√° chamado antes do commit - no meu caso, o manipulador foi chamado antes do commit antes do flush. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como voc√™ pode ver, o que fizemos no par√°grafo anterior pode n√£o nos ajudar e o session.dirty_instances estar√° vazio. Portanto, dentro do manipulador, fazemos novamente o flush para que todos os manipuladores sejam chamados antes do flush e simplesmente incrementamos a vers√£o em um.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">after_commit, after_soft_rollback - ap√≥s o commit, apenas o limpamos para que n√£o haja excessos na pr√≥xima vez. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Assim, voc√™ v√™ - este m√©todo install_handler instala manipuladores para tr√™s eventos ao mesmo tempo. Como classe, passamos a sess√£o aqui, pois esse √© um evento do seu n√≠vel. </font></font><br><br><img src="https://habrastorage.org/webt/oi/w8/pk/oiw8pkhgdpx7shz7rqrovfmg6lk.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bem aqui. Lembrarei o que alcan√ßamos - velocidade de 30 a 40 segundos para equipes complexas e grandes. De maneira alguma, algumas foram conclu√≠das em um segundo, outras em 200 milissegundos, como voc√™ pode ver no RPS. As consultas ao banco de dados come√ßaram a ser contadas em centenas. </font></font><br><br><img src="https://habrastorage.org/webt/7p/wk/qo/7pwkqo4-g_hksl5m_cqoo3xph5y.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O resultado √© um sistema bastante equilibrado. Havia, no entanto, uma ressalva. Alguns pedidos v√™m de n√≥s em lotes, emiss√µes. Ou seja, cerca de 30 pedidos chegam e cada um deles √© assim! (o orador mostra o polegar)</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se os processarmos um segundo de cada vez, a √∫ltima solicita√ß√£o na fila funcionar√° por 30 segundos. O primeiro, o segundo dois e assim por diante. </font></font><br><br><img src="https://habrastorage.org/webt/ut/br/gl/utbrglrwurgv0uux2yk8eme4owg.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Portanto, ainda precisamos acelerar. O que vamos fazer? </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De fato, a alquimia tem duas partes. A primeira √© uma abstra√ß√£o em um banco de dados sql chamado SQLAlchemy Core. O segundo √© ORM, o mapeamento real entre o banco de dados relacional e a representa√ß√£o do objeto. Consequentemente, o n√∫cleo da alquimia √© de um a um coincide com o sql - se voc√™ conhece o √∫ltimo, n√£o ter√° problemas com o n√∫cleo. Se voc√™ n√£o conhece o sql - aprenda o sql. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Al√©m disso, o n√∫cleo representa a menor sobrecarga. Praticamente n√£o h√° bombeamento - as consultas s√£o geradas usando o gerador de consultas e, em seguida, executadas. A sobrecarga sobre o dbapi √© m√≠nima.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Podemos criar solicita√ß√µes de qualquer complexidade, de qualquer tipo, podemos otimiz√°-las para a tarefa. Ou seja, se, no caso geral, o ORM n√£o se importa com a forma como o esquema do banco de dados √© constru√≠do - h√° alguma descri√ß√£o das tabelas, ele gera algumas consultas, sem saber que, neste caso, por exemplo, ser√° ideal selecionar daqui, em outro - a partir da√≠, como aplicar o filtro, e l√° - outro, ent√£o aqui podemos fazer solicita√ß√µes para a tarefa. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A desvantagem √© que chegamos novamente √† sincroniza√ß√£o manual. Todos os eventos, rel√©s - tudo isso no n√∫cleo n√£o funciona. Fizemos uma sele√ß√£o, objetos vieram at√© n√≥s, fizemos algo com eles, em seguida, atualizamos, inserimos ... voc√™ precisa incrementar a vers√£o com as m√£os, verifique voc√™ mesmo as constantes. O Core n√£o permite que tudo isso seja feito de maneira conveniente, em alto n√≠vel. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bem, n√£o vivemos o primeiro dia.</font></font><br><br><img src="https://habrastorage.org/webt/qx/kk/bx/qxkkbxwleeqwvdukaghimiat7sw.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um caso de uso simples. Cada mapeador cont√©m internamente um objeto __table__, que √© usado no n√∫cleo. A seguir, veja - n√≥s selecionamos o habitual, listamos as colunas, juntamos duas placas, indicamos a esquerda e a direita, indicamos por que condi√ß√£o a unimos, bem, para o gosto adicionamos uma ordem de compra. Al√©m disso, alimentamos essa solicita√ß√£o gerada na sess√£o e ela retorna iter√°vel para n√≥s, na qual os objetos semelhantes ao toque s√£o indexados pelo nome da coluna e pelo n√∫mero. O n√∫mero corresponde √† ordem em que est√£o listados na sele√ß√£o. </font></font><br><br><img src="https://habrastorage.org/webt/r2/uq/f4/r2uqf4wn-wa-cvigivokusan6um.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tornou-se muito melhor. No pior dos casos, o desempenho caiu para 2-4 segundos, a solicita√ß√£o mais complexa e mais longa continha 14 comandos e o RPS 10-15. √â s√≥lido. </font></font><br><br><img src="https://habrastorage.org/webt/m9/8d/mw/m98dmwpmo0trjpw3vta7dylmryw.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O que eu gostaria de dizer em conclus√£o.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√£o produza entidades onde elas n√£o s√£o necess√°rias - n√£o estrague a sua onde estiver pronta. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Use SQLA ORM - esta √© uma ferramenta muito conveniente que permite rastrear eventos em alto n√≠vel, responder a v√°rios eventos associados ao banco de dados, esconder todos os ouvidos da alquimia. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se tudo mais falhar, o desempenho n√£o √© suficiente - use o SQLA Core. </font><font style="vertical-align: inherit;">Isso ainda √© melhor do que usar SQL puro, porque fornece uma abstra√ß√£o relacional no banco de dados. </font><font style="vertical-align: inherit;">Escapa automaticamente par√¢metros, vincula corretamente, n√£o importa qual banco de dados est√° nele - ele pode ser alterado e o Core suporta diferentes dialetos.</font></font> √â muito conveniente <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √â tudo o que eu queria lhe contar hoje. </font></font><br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/flA2lEl2a0M" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt430818/">https://habr.com/ru/post/pt430818/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt430804/index.html">As baterias Tesla / Panasonic s√£o as baterias de ve√≠culos el√©tricos mais acess√≠veis do mercado</a></li>
<li><a href="../pt430806/index.html">Come√ßamos a aprender ingl√™s - escrevi um aplicativo: EWM - experi√™ncia na cria√ß√£o de um projeto de treinamento</a></li>
<li><a href="../pt430808/index.html">Teoria do Orador: 16 materiais sobre como funcionam os oradores e os oradores</a></li>
<li><a href="../pt430810/index.html">Teste de carga com gafanhoto. Parte 2</a></li>
<li><a href="../pt430812/index.html">O que developer.android.com est√° falando sobre o RecyclerView</a></li>
<li><a href="../pt430820/index.html">Black Friday 2018 - VDS em Moscou e Amsterd√£</a></li>
<li><a href="../pt430822/index.html">Seguran√ßa da informa√ß√£o na Internet das coisas: quem √© a coisa e quem √© o mestre?</a></li>
<li><a href="../pt430824/index.html">Procurar objeto danificado pelo n√∫mero de p√°gina danificado no MS SQL Server 2005</a></li>
<li><a href="../pt430826/index.html">Como desenvolver um gerente de desenvolvimento</a></li>
<li><a href="../pt430828/index.html">Experi√™ncia no uso de monitores LCD baseados em produtos MELT</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>