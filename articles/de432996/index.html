<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëÉüèæ ‚û°Ô∏è üë®‚Äç‚öïÔ∏è Ein paar W√∂rterb√ºcher Interna in CPython (und PyPy) üôà ‚èØÔ∏è üÜñ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Die interne Struktur von W√∂rterb√ºchern in Python beschr√§nkt sich nicht nur auf Bucket und privates Hashing. Dies ist eine erstaunliche Welt von gemein...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Ein paar W√∂rterb√ºcher Interna in CPython (und PyPy)</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/432996/">  Die interne Struktur von W√∂rterb√ºchern in Python beschr√§nkt sich nicht nur auf Bucket und privates Hashing.  Dies ist eine erstaunliche Welt von gemeinsam genutzten Schl√ºsseln, Hash-Caching, DKIX_DUMMY und schnellen Vergleichen, die noch schneller durchgef√ºhrt werden k√∂nnen (auf Kosten eines Fehlers mit einer ungef√§hren Wahrscheinlichkeit von 2 ^ -64). <br><br>  Wenn Sie die Anzahl der Elemente in dem gerade erstellten W√∂rterbuch nicht kennen, wie viel Speicher f√ºr jedes Element aufgewendet wird, warum das W√∂rterbuch jetzt (ab CPython 3.6) in zwei Arrays implementiert ist und wie es sich auf die Beibehaltung der Einf√ºgereihenfolge bezieht, oder Sie haben die Pr√§sentation von Raymond Hettinger ‚ÄûModern Python W√∂rterb√ºcher Ein Zusammenfluss von einem Dutzend gro√üartiger Ideen. "  Dann willkommen. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/p33CVV29OG8" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Personen, die mit der Vorlesung vertraut sind, finden jedoch auch einige Details und neue Informationen. F√ºr Neulinge, die mit Bucket und Closed Hashing nicht vertraut sind, ist der Artikel ebenfalls interessant. <br><a name="habracut"></a><br>  W√∂rterb√ºcher in CPython sind √ºberall, Klassen, globale Variablen, kwargs-Parameter basieren darauf. Der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Interpreter erstellt Tausende von W√∂rterb√ºchern</a> , auch wenn Sie selbst Ihrem Skript keine geschweiften Klammern hinzugef√ºgt haben.  Um viele angewandte Probleme zu l√∂sen, werden auch W√∂rterb√ºcher verwendet. Es ist nicht verwunderlich, dass sich ihre Implementierung weiter verbessert und immer mehr zu verschiedenen Tricks wird. <br><br><h2>  Grundlegende Implementierung von W√∂rterb√ºchern (via Hashmap) </h2><br>  Wenn Sie mit der Funktionsweise von Standard-Hashmap und privatem Hashing vertraut sind, k√∂nnen Sie mit dem n√§chsten Kapitel fortfahren. <br><br>  Die Idee, die den W√∂rterb√ºchern zugrunde liegt, ist einfach: Wenn wir ein Array haben, in dem Objekte derselben Gr√∂√üe gespeichert sind, erhalten wir leicht Zugriff auf das gew√ºnschte Objekt, wenn wir den Index kennen. <br><br><img src="https://habrastorage.org/webt/wq/m3/nk/wqm3nkortrkb_eyjwlorn4ahreq.png"><br><br>  Wir f√ºgen einfach einen Index multipliziert mit der Gr√∂√üe des Objekts zum Versatz des Arrays hinzu und erhalten die Adresse des gew√ºnschten Objekts. <br><br>  Was aber, wenn wir eine Suche nicht nach einem Ganzzahlindex, sondern nach einer Variablen eines anderen Typs organisieren m√∂chten, um beispielsweise Benutzer an ihrer E-Mail-Adresse zu finden? <br><br>  Bei einem einfachen Array m√ºssen wir die E-Mails aller Benutzer im Array durchsuchen und mit der Suche vergleichen. Dieser Ansatz wird als lineare Suche bezeichnet und ist offensichtlich viel langsamer als der Zugriff auf das Objekt √ºber den Index. <br><br>  Die lineare Suche kann erheblich beschleunigt werden, wenn wir die Gr√∂√üe des Bereichs begrenzen, in dem Sie suchen m√∂chten.  Dies wird normalerweise erreicht, indem der Rest des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">Hashs genommen wird</a> .  Das gesuchte Feld ist der Schl√ºssel. <br><br><img src="https://habrastorage.org/webt/hn/1l/f4/hn1lf445vm6bnorbgvx7n5mbfos.png"><br><br>  Infolgedessen wird eine lineare Suche nicht √ºber das gesamte gro√üe Array, sondern entlang seines Teils durchgef√ºhrt. <br><br>  Aber was ist, wenn dort bereits ein Element vorhanden ist?  Dies k√∂nnte sehr gut passieren, da niemand garantiert hat, dass die R√ºckst√§nde aus dem Teilen des Hashs eindeutig sind (wie der Hash selbst).  In diesem Fall wird das Objekt am n√§chsten Index platziert. Wenn es besch√§ftigt ist, wird es um einen anderen Index verschoben und so weiter, bis es einen freien findet.  Beim Abrufen eines Elements werden alle Schl√ºssel mit demselben Hash angezeigt. <br><br><img src="https://habrastorage.org/webt/8a/0d/uj/8a0dujuj4hduhrbihtpomacvg0i.png"><br><br>  Diese Art von Hashing wird als privat bezeichnet.  Wenn das W√∂rterbuch nur wenige freie Zellen enth√§lt, droht eine solche Suche zu einer linearen zu degenerieren, sodass wir alle Gewinne verlieren, f√ºr die das W√∂rterbuch erstellt wurde. Um dies zu vermeiden, h√§lt der Interpreter das Array 1/2 - 2/3 gef√ºllt.  Wenn nicht gen√ºgend freie Zellen vorhanden sind, wird ein neues Array erstellt, das doppelt so gro√ü ist wie das vorherige, und Elemente aus dem alten werden jeweils auf das neue √ºbertragen. <br><br>  Was tun, wenn der Artikel gel√∂scht wurde?  In diesem Fall wird eine leere Zelle im Array gebildet und der Suchalgorithmus kann nicht nach Schl√ºssel unterscheiden. Diese Zelle ist leer, weil ein Element mit einem solchen Hash nicht im W√∂rterbuch enthalten war oder weil es gel√∂scht wurde.  Um Datenverlust beim L√∂schen zu vermeiden, ist die Zelle mit einem speziellen Flag (DKIX_DUMMY) gekennzeichnet.  Wenn dieses Flag w√§hrend einer Elementsuche auftritt, wird die Suche fortgesetzt, die Zelle wird als besch√§ftigt betrachtet. Wenn sie eingef√ºgt wird, wird die Zelle √ºberschrieben. <br><br><h2>  Implementierungsfunktionen in Python </h2><br>  Jedes Element des W√∂rterbuchs muss einen Link zum Zielobjekt und zum Schl√ºssel enthalten.  Der Schl√ºssel muss f√ºr die Kollisionsverarbeitung gespeichert werden, das Objekt - aus offensichtlichen Gr√ºnden.  Da sowohl der Schl√ºssel als auch das Objekt einen beliebigen Typ und eine beliebige Gr√∂√üe haben k√∂nnen, k√∂nnen wir sie nicht direkt in der Struktur speichern, sie liegen im dynamischen Speicher und Verkn√ºpfungen zu ihnen werden in der Struktur des Listenelements gespeichert.  Das hei√üt, die Gr√∂√üe eines Elements muss der Mindestgr√∂√üe von zwei Zeigern entsprechen (16 Byte auf 64-Bit-Systemen).  Der Interpreter speichert jedoch auch den Hash. Dies geschieht, um ihn nicht bei jeder Vergr√∂√üerung des W√∂rterbuchs neu zu berechnen.  Anstatt den Hash aus jedem Schl√ºssel auf eine neue Weise zu berechnen und den Rest der Division durch die Anzahl der Buckets zu nehmen, liest der Interpreter einfach den bereits gespeicherten Wert.  Was aber, wenn das Schl√ºsselobjekt ge√§ndert wird?  In diesem Fall muss der Hash neu berechnet werden und der gespeicherte Wert ist falsch?  Eine solche Situation ist unm√∂glich, da ver√§nderbare Typen keine W√∂rterbuchschl√ºssel sein k√∂nnen. <br><br>  Die Struktur des W√∂rterbuchelements ist wie folgt definiert: <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> Py_hash_t me_hash; <span class="hljs-comment"><span class="hljs-comment">//  PyObject *me_key; //    PyObject *me_value; //     } PyDictKeyEntry;</span></span></code> </pre> <br>  Die Mindestgr√∂√üe des W√∂rterbuchs wird durch die PyDict_MINSIZE-Konstante deklariert, die 8 betr√§gt. Die Entwickler haben entschieden, dass dies die optimale Gr√∂√üe ist, um unn√∂tige Speicherverschwendung zum Speichern leerer Werte und Zeit f√ºr die dynamische Erweiterung des Arrays zu vermeiden.  Daher haben Sie beim Erstellen eines W√∂rterbuchs (bis Version 3.6) mindestens 8 Elemente im W√∂rterbuch ben√∂tigt * 24 Byte in der Struktur = 192 Byte (dies ber√ºcksichtigt nicht die verbleibenden Felder: die Kosten der W√∂rterbuchvariablen selbst, den Z√§hler f√ºr die Anzahl der Elemente usw.) <br><br>  W√∂rterb√ºcher werden auch zum Implementieren von benutzerdefinierten Klassenfeldern verwendet.  Mit Python k√∂nnen Sie die Anzahl der Attribute dynamisch √§ndern. Diese Dynamik erfordert keine zus√§tzlichen Kosten, da das Hinzuf√ºgen / Entfernen eines Attributs im Wesentlichen der entsprechenden Operation im W√∂rterbuch entspricht.  Eine Minderheit der Programme verwendet diese Funktionalit√§t, die meisten sind jedoch auf Felder beschr√§nkt, die in __init__ deklariert sind.  Jedes Objekt muss jedoch sein eigenes W√∂rterbuch mit seinen Schl√ºsseln und Hashes speichern, obwohl sie mit anderen Objekten √ºbereinstimmen.  Eine logische Verbesserung ist hier die Speicherung gemeinsam genutzter Schl√ºssel an nur einem Ort, genau das, was im <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">PEP 412 - Key-Sharing Dictionary</a> implementiert wurde.  Die M√∂glichkeit, das W√∂rterbuch dynamisch zu √§ndern, ist nicht verschwunden: Wenn die Reihenfolge oder die Anzahl der Schl√ºssel ge√§ndert wird, wird das W√∂rterbuch von den Teilungsschl√ºsseln in die regul√§ren Schl√ºssel konvertiert. <br><br>  Um Kollisionen zu vermeiden, betr√§gt das maximale ‚ÄûLaden‚Äú des W√∂rterbuchs 2/3 der aktuellen Gr√∂√üe des Arrays. <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> USABLE_FRACTION(n) (((n) &lt;&lt; 1)/3)</span></span></code> </pre> <br>  Somit tritt die erste Erweiterung auf, wenn das 6. Element hinzugef√ºgt wird. <br><br>  Es stellt sich heraus, dass das Array w√§hrend des Programmbetriebs ziemlich entladen ist, wobei die H√§lfte bis ein Drittel der Zellen leer bleiben, was zu einem erh√∂hten Speicherverbrauch f√ºhrt.  Um diese Einschr√§nkung zu umgehen und wenn m√∂glich nur die erforderlichen Daten zu speichern, wurde eine neue <s>Ebene der</s> Array- <s>Abstraktion</s> hinzugef√ºgt. <br><br>  Anstatt ein sp√§rliches Array zu speichern, zum Beispiel: <br><br><pre> <code class="python hljs"> d = {<span class="hljs-string"><span class="hljs-string">'timmy'</span></span>: <span class="hljs-string"><span class="hljs-string">'red'</span></span>, <span class="hljs-string"><span class="hljs-string">'barry'</span></span>: <span class="hljs-string"><span class="hljs-string">'green'</span></span>, <span class="hljs-string"><span class="hljs-string">'guido'</span></span>: <span class="hljs-string"><span class="hljs-string">'blue'</span></span>} <span class="hljs-comment"><span class="hljs-comment"># -&gt; entries = [['--', '--', '--'], [-8522787127447073495, 'barry', 'green'], ['--', '--', '--'], ['--', '--', '--'], ['--', '--', '--'], [-9092791511155847987, 'timmy', 'red'], ['--', '--', '--'], [-6480567542315338377, 'guido', 'blue']]</span></span></code> </pre><br>  Ab Version 3.6 sind die W√∂rterb√ºcher wie folgt organisiert: <br><br><pre> <code class="python hljs"> indices = [<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>] entries = [[<span class="hljs-number"><span class="hljs-number">-9092791511155847987</span></span>, <span class="hljs-string"><span class="hljs-string">'timmy'</span></span>, <span class="hljs-string"><span class="hljs-string">'red'</span></span>], [<span class="hljs-number"><span class="hljs-number">-8522787127447073495</span></span>, <span class="hljs-string"><span class="hljs-string">'barry'</span></span>, <span class="hljs-string"><span class="hljs-string">'green'</span></span>], [<span class="hljs-number"><span class="hljs-number">-6480567542315338377</span></span>, <span class="hljs-string"><span class="hljs-string">'guido'</span></span>, <span class="hljs-string"><span class="hljs-string">'blue'</span></span>]]</code> </pre><br>  Das hei√üt,  Es werden nur die Datens√§tze gespeichert, die wirklich erforderlich sind. Sie werden in einem separaten Array aus der Hash-Tabelle entfernt, und nur die Indizes der entsprechenden Datens√§tze werden in der Hash-Tabelle gespeichert.  Wenn das Array anfangs 192 Bytes ben√∂tigt hat, sind es jetzt nur noch 80 (3 * 24 Bytes f√ºr jeden Datensatz + 8 Bytes f√ºr Indizes).  Kompression bei 58% erreicht. [2] <br><br>  Die Gr√∂√üe eines Elements in Indizes √§ndert sich ebenfalls dynamisch. Anfangs entspricht sie einem Byte, dh das gesamte Array kann in einem Register abgelegt werden. Wenn der Index beginnt, in 8 Bit zu passen, erweitern sich die Elemente auf 16 und dann auf 32 Bit.  Es gibt spezielle Konstanten DKIX_EMPTY und DKIX_DUMMY f√ºr leere bzw. gel√∂schte Elemente. Eine Indexerweiterung auf 16 Byte erfolgt, wenn das W√∂rterbuch mehr als 127 Elemente enth√§lt. <br><br>  Neue Objekte werden zu Eintr√§gen hinzugef√ºgt, dh wenn das W√∂rterbuch erweitert wird, m√ºssen sie nicht verschoben werden. Sie m√ºssen lediglich die Gr√∂√üe der Indizes erh√∂hen und sie mit Indizes √ºberf√ºllen. <br><br>  Beim Durchlaufen eines W√∂rterbuchs wird das Indexarray nicht ben√∂tigt, die Elemente werden nacheinander aus Eintr√§gen zur√ºckgegeben, weil  Elemente werden jedes Mal am Ende von Eintr√§gen hinzugef√ºgt. Das W√∂rterbuch speichert automatisch die Reihenfolge des Auftretens von Elementen.  Somit haben wir nicht nur den f√ºr die Speicherung des W√∂rterbuchs erforderlichen Speicher reduziert, sondern auch eine schnellere dynamische Erweiterung und Beibehaltung der Reihenfolge der Schl√ºssel erhalten.  Das Reduzieren des Arbeitsspeichers ist an sich gut, kann aber gleichzeitig die Leistung steigern, da mehr Datens√§tze in den Prozessor-Cache gelangen. <br><br>  CPython-Entwickler mochten diese Implementierung so sehr, dass W√∂rterb√ºcher jetzt erforderlich sind, um die Einf√ºgereihenfolge nach Spezifikation beizubehalten.  Wenn fr√ºher die Reihenfolge der W√∂rterb√ºcher bestimmt wurde, d.h.  Es wurde streng durch einen Hash definiert und war von Anfang bis Anfang unver√§ndert. Dann wurde ein wenig Zuf√§lligkeit hinzugef√ºgt, damit die Schl√ºssel jedes Mal anders werden. Jetzt m√ºssen die W√∂rterbuchschl√ºssel die Reihenfolge beibehalten.  Wie viel dies notwendig war und was zu tun ist, wenn eine noch effektivere Implementierung des W√∂rterbuchs erscheint, aber die Einf√ºgereihenfolge nicht beibeh√§lt, ist unklar. <br><br>  Es gab jedoch Anforderungen, einen Mechanismus zum Beibehalten der Deklaration von Attributen in <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">Klassen</a> und in <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">kwargs zu</a> implementieren, und diese Implementierung erm√∂glicht es Ihnen, diese Probleme ohne spezielle Mechanismen zu schlie√üen. <br><br>  So sieht es im <a href="" rel="nofollow">CPython-Code aus</a> : <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dictkeysobject</span></span></span><span class="hljs-class"> {</span></span> Py_ssize_t dk_refcnt; <span class="hljs-comment"><span class="hljs-comment">/* Size of the hash table (dk_indices). It must be a power of 2. */</span></span> Py_ssize_t dk_size; <span class="hljs-comment"><span class="hljs-comment">/* Function to lookup in the hash table (dk_indices): - lookdict(): general-purpose, and may return DKIX_ERROR if (and only if) a comparison raises an exception. - lookdict_unicode(): specialized to Unicode string keys, comparison of which can never raise an exception; that function can never return DKIX_ERROR. - lookdict_unicode_nodummy(): similar to lookdict_unicode() but further specialized for Unicode string keys that cannot be the &lt;dummy&gt; value. - lookdict_split(): Version of lookdict() for split tables. */</span></span> dict_lookup_func dk_lookup; <span class="hljs-comment"><span class="hljs-comment">/* Number of usable entries in dk_entries. */</span></span> Py_ssize_t dk_usable; <span class="hljs-comment"><span class="hljs-comment">/* Number of used entries in dk_entries. */</span></span> Py_ssize_t dk_nentries; <span class="hljs-comment"><span class="hljs-comment">/* Actual hash table of dk_size entries. It holds indices in dk_entries, or DKIX_EMPTY(-1) or DKIX_DUMMY(-2). Indices must be: 0 &lt;= indice &lt; USABLE_FRACTION(dk_size). The size in bytes of an indice depends on dk_size: - 1 byte if dk_size &lt;= 0xff (char*) - 2 bytes if dk_size &lt;= 0xffff (int16_t*) - 4 bytes if dk_size &lt;= 0xffffffff (int32_t*) - 8 bytes otherwise (int64_t*) Dynamically sized, SIZEOF_VOID_P is minimum. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> dk_indices[]; <span class="hljs-comment"><span class="hljs-comment">/* char is required to avoid strict aliasing. */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* "PyDictKeyEntry dk_entries[dk_usable];" array follows: see the DK_ENTRIES() macro */</span></span> };</code> </pre><br>  Die Iteration ist jedoch komplizierter als Sie zun√§chst vielleicht denken. Es gibt zus√§tzliche √úberpr√ºfungsmechanismen, bei denen das W√∂rterbuch w√§hrend der Iteration nicht ge√§ndert wurde. Eine davon ist eine 64-Bit- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">Version des W√∂rterbuchs</a> , in der jedes W√∂rterbuch gespeichert ist. <br><br>  Schlie√ülich betrachten wir den Mechanismus zur L√∂sung von Kollisionen.  Die Sache ist, dass in Python Hash-Werte leicht vorhersehbar sind: <br><br><pre> <code class="python hljs"> &gt;&gt;&gt;[hash(i) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">4</span></span>)] [<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>]</code> </pre><br>  Und da beim Erstellen eines W√∂rterbuchs aus diesen Hashes der Rest der Division verwendet wird, bestimmen sie tats√§chlich, in welchen Bucket der Datensatz verschoben wird, nur die letzten paar Bits des Schl√ºssels (wenn es sich um eine Ganzzahl handelt).  Sie k√∂nnen sich eine Situation vorstellen, in der viele Objekte in benachbarte Eimer gelangen m√∂chten. In diesem Fall m√ºssen Sie viele Objekte betrachten, die bei der Suche nicht am richtigen Ort sind.  Um die Anzahl der Kollisionen zu verringern und die Anzahl der Bits zu erh√∂hen, die bestimmen, in welchen Bucket der Datensatz gehen soll, wurde der folgende Mechanismus implementiert: <br><br><pre> <code class="cpp hljs"> <span class="hljs-comment"><span class="hljs-comment">//   i = i + 1 % n //   : #define PERTURB_SHIFT 5 perturb &gt;&gt;= PERTURB_SHIFT; j = (5*j) + 1 + perturb; //   j % n    </span></span></code> </pre><br>  St√∂rung ist eine ganzzahlige Variable, die durch einen Hash initialisiert wird.  Es ist zu beachten, dass bei einer gro√üen Anzahl von Kollisionen dieser auf Null zur√ºckgesetzt wird und der folgende Index nach der Formel berechnet wird: <br><br><pre> <code class="cpp hljs"> j = (<span class="hljs-number"><span class="hljs-number">5</span></span> * j + <span class="hljs-number"><span class="hljs-number">1</span></span>) % n</code> </pre><br>  Beim Extrahieren eines Elements aus dem W√∂rterbuch wird dieselbe Suche durchgef√ºhrt: Der Index des Steckplatzes, in dem sich das Element befinden soll, wird berechnet. Wenn der Steckplatz leer ist, wird die Ausnahme "Wert nicht gefunden" ausgel√∂st.  Wenn sich in diesem Steckplatz ein Wert befindet, m√ºssen Sie √ºberpr√ºfen, ob der Schl√ºssel mit dem gesuchten √ºbereinstimmt. Dies ist m√∂glicherweise nicht m√∂glich, wenn eine Kollision auftritt.  Der Schl√ºssel kann jedoch fast jedes Objekt sein, einschlie√ülich eines Objekts, f√ºr das der Vergleichsvorgang viel Zeit in Anspruch nimmt.  Um einen langen Vergleichsvorgang zu vermeiden, werden in Python verschiedene Tricks verwendet: <br><br><pre> <code class="python hljs"> <span class="hljs-comment"><span class="hljs-comment">#   (   ,  C) def eq(key, entity): if id(key) == id(entity): return True if hash(key) != hash(entity): return False return key == entity</span></span></code> </pre><br>  Zun√§chst werden Zeiger verglichen. Wenn der Schl√ºsselzeiger des gew√ºnschten Objekts gleich dem Zeiger des gesuchten Objekts ist, dh auf denselben Speicherbereich zeigt, gibt der Vergleich sofort true zur√ºck.  Das ist aber noch nicht alles.  Wie Sie wissen, m√ºssen gleiche Objekte gleiche Hashes haben, was bedeutet, dass Objekte mit unterschiedlichen Hashes nicht gleich sind.  Nach dem √úberpr√ºfen der Zeiger werden Hashes √ºberpr√ºft. Wenn sie nicht gleich sind, wird false zur√ºckgegeben.  Und nur wenn die Hashes gleich sind, wird ein ehrlicher Vergleich aufgerufen. <br><br>  Wie hoch ist die Wahrscheinlichkeit eines solchen Ergebnisses?  Bei 2 ^ -64 k√∂nnen Sie nat√ºrlich aufgrund der einfachen Vorhersagbarkeit des Hash-Werts ein solches Beispiel leicht aufgreifen, aber in Wirklichkeit kommt diese √úberpr√ºfung nicht oft auf wie viel?  Raymond Hettinger stellte den Interpreter zusammen, indem er die letzte Vergleichsoperation mit einer einfachen R√ºckgabe true √§nderte.  Das hei√üt,  Der Interpreter betrachtet Objekte als gleich, wenn ihre Hashes gleich sind.  Dann setzte er automatisierte Tests vieler popul√§rer Projekte auf diesem Dolmetscher durch, die erfolgreich endeten.  Es mag seltsam erscheinen, Objekte mit gleichen Hashes als gleich zu betrachten, ihren Inhalt nicht zus√§tzlich zu √ºberpr√ºfen und sich ausschlie√ülich auf den Hash zu verlassen, aber Sie tun dies regelm√§√üig, wenn Sie die Git- oder Torrent-Protokolle verwenden.  Sie betrachten Dateien (Dateibl√∂cke) als gleich, wenn ihre Hashes gleich sind, was durchaus zu Fehlern f√ºhren kann. Ihre Ersteller (und wir alle) hoffen jedoch, dass es erw√§hnenswert ist, dass die Wahrscheinlichkeit einer Kollision √§u√üerst gering ist. <br><br>  Jetzt sollten Sie endlich die Struktur des W√∂rterbuchs verstehen, die so aussieht: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> PyObject_HEAD <span class="hljs-comment"><span class="hljs-comment">/* Number of items in the dictionary */</span></span> Py_ssize_t ma_used; <span class="hljs-comment"><span class="hljs-comment">/* Dictionary version: globally unique, value change each time the dictionary is modified */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint64_t</span></span> ma_version_tag; PyDictKeysObject *ma_keys; <span class="hljs-comment"><span class="hljs-comment">/* If ma_values is NULL, the table is "combined": keys and values are stored in ma_keys. If ma_values is not NULL, the table is splitted: keys are stored in ma_keys and values are stored in ma_values */</span></span> PyObject **ma_values; } PyDictObject;</code> </pre><br><h2>  Zuk√ºnftige √Ñnderungen </h2><br>  Im vorherigen Kapitel haben wir uns √ºberlegt, was bereits implementiert wurde und von jedem in seiner Arbeit verwendet werden kann. Die Verbesserungen beschr√§nken sich jedoch nat√ºrlich nicht auf: Pl√§ne f√ºr Version 3.8 enthalten <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">Unterst√ºtzung f√ºr umgekehrte W√∂rterb√ºcher</a> .  In der Tat verhindert nichts, anstatt vom Anfang eines Arrays von Elementen zu iterieren und Indizes zu erh√∂hen, beginnend mit dem Ende und abnehmenden Indizes. <br><br><h2>  Zus√§tzliche Materialien </h2><br>  F√ºr ein tieferes Eintauchen in das Thema wird empfohlen, sich mit den folgenden Materialien vertraut zu machen: <br><br><ol><li>  Aufzeichnung des Berichts am Anfang des Artikels </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">Vorschlag f√ºr eine neue W√∂rterbuchimplementierung</a> </li><li>  <a href="" rel="nofollow">W√∂rterbuch-Quellcode in CPython</a> </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de432996/">https://habr.com/ru/post/de432996/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de432986/index.html">C vs Go-Schleifen und einfache Mathematik</a></li>
<li><a href="../de432988/index.html">Achter Webmaster. Lebe auf Habr√©</a></li>
<li><a href="../de432990/index.html">Edison Sprachaktivierte Holzlampe. Ausgabepreis 5 USD</a></li>
<li><a href="../de432992/index.html">Er setzte seine Kopfh√∂rer auf und starb: Wir haben es mit dem seltsamen Tod eines Sch√ºlers in Rimbau zu tun</a></li>
<li><a href="../de432994/index.html">Vivaldi 2.2 - Quantit√§t in Qualit√§t umwandeln</a></li>
<li><a href="../de432998/index.html">Weihnachtsgeschichte</a></li>
<li><a href="../de433000/index.html">Kotlin kompilieren: JetBrains VS ANTLR VS JavaCC</a></li>
<li><a href="../de433002/index.html">Komm selbst ... oder die Kommunikationsregeln in einem Team</a></li>
<li><a href="../de433004/index.html">Eine robuste Cloud-Migrationsstrategie f√ºr 2019: 7 Tipps</a></li>
<li><a href="../de433008/index.html">USB-Ger√§te sind eine "pl√∂tzliche" Bedrohung</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>