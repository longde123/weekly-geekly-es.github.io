<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèΩ‚Äçüè´ üéé üë©üèæ‚Äçüíº Marionette + Hiera. Dr√ºcken Sie das Maximum üïê ü§£ üë®‚Äçüë©‚Äçüë¶</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In diesem Artikel m√∂chte ich dar√ºber sprechen, wie wir Puppet und Hiera verwenden , um Eisen- und virtuelle Server zu konfigurieren. Grunds√§tzlich geh...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Marionette + Hiera. Dr√ºcken Sie das Maximum</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/semrush/blog/412587/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/vq/z-/bj/vqz-bjm4yx2wvhzcf-frffyuh04.png"></div><br><p>  In diesem Artikel m√∂chte ich dar√ºber sprechen, wie wir <strong>Puppet</strong> und <strong>Hiera verwenden</strong> , um Eisen- und virtuelle Server zu konfigurieren.  Grunds√§tzlich geht es um die Architektur und die von uns erfundene Hierarchie, die die Konfiguration von Servern erleichtert und systematisiert. </p><br><p>  Ich wurde aufgefordert, diesen Artikel zu schreiben, weil ich im Internet keine besonders guten, wirklich funktionierenden Beispiele daf√ºr gefunden habe, wie man mit Hiera arbeiten kann und wof√ºr es ist.  Grunds√§tzlich handelt es sich hierbei um Tutorials mit Beispielen, um in das Thema einzutreten.  Aber die wirkliche praktische Anwendung von Hiera ist dort nicht geschrieben.  Vielleicht habe ich nicht gut ausgesehen, aber hier ist ein echtes Beispiel, das Ihnen wahrscheinlich helfen wird, alle Punkte √ºber i zu setzen, wie ich es einmal getan habe. </p><br><h3 id="dlya-kogo-byla-by-polezna-dannaya-statya">  F√ºr wen w√§re dieser Artikel n√ºtzlich </h3><br><p>  Wenn: </p><br><ul><li>  Sie wissen, was Puppet und Hiera sind, aber Sie verwenden sie nicht wirklich zusammen, da nicht klar ist, wie und warum </li><li>  Sie haben viele Teams in Ihrem Unternehmen und m√ºssen die Serverkonfiguration auf Befehlsebene irgendwie differenzieren </li><li>  Sie verwenden ein Pappet und die Knotendateien sind unglaublich gro√ü geworden </li><li>  Lesen Sie gerne die Serverkonfiguration im g√∂ttlichen Yaml-Format :) </li><li>  Sie interessieren sich grunds√§tzlich f√ºr das Thema Konfigurationsmanagement und Systemadministration. </li></ul><br><p>  Dieser Artikel ist f√ºr Sie. </p><a name="habracut"></a><br><h3 id="prezhde-chem-nachat">  Bevor Sie anfangen </h3><br><p>  Ich werde Sie sofort warnen, der Artikel hat sich als lang herausgestellt, aber ich hoffe, er ist n√ºtzlich.  Au√üerdem wird davon ausgegangen, dass Sie Hiera bereits mit Puppe verbunden haben und zumindest irgendwie mit Puppe vertraut sind.  Wenn hiera nicht verbunden ist, ist es nicht schwierig zu tun. </p><br><ul><li>  Lesen Sie hier mehr dar√ºber, was Puppet ist: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Puppet f√ºr Anf√§nger</a> . </li><li>  So funktioniert Hiera - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Einf√ºhrung in Hiera</a> . </li></ul><br><h3 id="vvodnye-dannye">  Daten eingeben </h3><br><ul><li>  Wir haben ungef√§hr 30 Entwicklungsteams bei SEMrush, von denen jedes seine eigenen Server hat </li><li>  Jedes Team arbeitet mit seinen eigenen Technologien (PL, DBMS usw.) </li><li>  Teams k√∂nnen und sollten (idealerweise) eine gemeinsame Konfiguration f√ºr bestimmte Projekte verwenden (Wiederverwendung von Code) </li><li>  Die Teams selbst verwalten die Bereitstellung von Anwendungen auf ihren Servern (dies erfolgt nicht √ºber das Pappet). </li></ul><br><h3 id="nemnogo-istorii">  Ein bisschen Geschichte </h3><br><p>  Anfangs hatten wir alles im Pappet der Version 3, dann entschieden wir uns, das 4. Pappet zu implementieren, und wir begannen, alle neuen Server darin zu platzieren und die alten langsam auf das 4. zu portieren. </p><br><p>  Im dritten Teil verwendeten wir das klassische System von Knotendateien und -modulen.  Die Module wurden in einer speziellen Gruppe von Projekten in Gitlab erstellt, auf einen Pappet-Server (mit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">r10k</a> ) <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">geklont</a> , dann kamen die Pappet-Agenten zum Assistenten und erhielten ein Verzeichnis, um es auf den Server anzuwenden. </p><br><p>  Dann versuchten sie, dies nicht zu tun und keine lokalen Module zu verwenden, sondern stellten Links zu den erforderlichen Modulen und ihren Repositorys in das Puppetfile.  Warum?  Weil diese Module von der Community und den Entwicklern st√§ndig unterst√ºtzt und verbessert werden (im Idealfall), und unsere lokalen Module nicht.  Sp√§ter f√ºhrten sie hiera ein und wechselten vollst√§ndig dazu, und Knotendateien (wie node.pp) sind in Vergessenheit geraten. </p><br><p> Im vierten Teil haben wir versucht, lokale Module vollst√§ndig aufzugeben und nur Remote-Module zu verwenden.  Leider sollte hier wieder eine Reservierung eingef√ºgt werden, da es ‚Äûnicht ganz geklappt hat‚Äú, manchmal muss man noch etwas selbst neigen und fertigstellen.  Nat√ºrlich gibt es nur Hiera und keine Knotendateien. </p><br><p>  <strong>Wenn Sie 30 Teams mit einem Technologiezoo haben, wird das Problem, wie diese Menagerie mit&gt; 1000 Servern gehalten werden kann, besonders akut.</strong>  <strong>Weiter werde ich erz√§hlen, wie uns hiera dabei hilft.</strong> </p><br><h3 id="ierarhiya">  Hierarchie </h3><br><p>  Hiera (von der es seinen Namen hat) richtet eine Hierarchie ein.  Bei uns sieht es so aus: </p><br><pre><code class="hljs axapta">--- :hierarchy: - <span class="hljs-string"><span class="hljs-string">"nodes/%{::fqdn}"</span></span> - <span class="hljs-string"><span class="hljs-string">"teams/%{::team}_team/nodes/%{::fqdn}"</span></span> - <span class="hljs-string"><span class="hljs-string">"teams/%{::team}_team/projects/%{::project}/tiers/%{::tier}"</span></span> - <span class="hljs-string"><span class="hljs-string">"teams/%{::team}_team/projects/%{::project}/%{::role}"</span></span> - <span class="hljs-string"><span class="hljs-string">"teams/%{::team}_team/projects/%{::project}"</span></span> - <span class="hljs-string"><span class="hljs-string">"teams/%{::team}_team/roles/%{::role}"</span></span> - <span class="hljs-string"><span class="hljs-string">"teams/%{::team}_team/%{::team}"</span></span> - <span class="hljs-string"><span class="hljs-string">"projects/%{::project}/tiers/%{::tier}/%{::role}"</span></span> - <span class="hljs-string"><span class="hljs-string">"projects/%{::project}/tiers/%{::tier}"</span></span> - <span class="hljs-string"><span class="hljs-string">"projects/%{::project}/%{::role}"</span></span> - <span class="hljs-string"><span class="hljs-string">"projects/%{::project}"</span></span> - <span class="hljs-string"><span class="hljs-string">"tiers/%{::tier}"</span></span> - <span class="hljs-string"><span class="hljs-string">"virtual/%{::virtual}"</span></span> - <span class="hljs-string"><span class="hljs-string">"os/%{::operatingsystem}/%{::operatingsystemmajrelease}"</span></span> - <span class="hljs-string"><span class="hljs-string">"os/%{::operatingsystem}"</span></span> - users - <span class="hljs-keyword"><span class="hljs-keyword">common</span></span></code> </pre> <br><p>  Lassen Sie uns zun√§chst obskure Variablen (Fakten) behandeln. </p><br><p>  Jeder Server in SEMrush sollte idealerweise 4 exponierte, spezielle Fakten haben, die seine Zugeh√∂rigkeit beschreiben: </p><br><ul><li>  <strong><code>team</code></strong> Tatsache - zu welchem ‚Äã‚ÄãTeam geh√∂rt es? </li><li>  Faktenprojekt - auf welches Projekt bezieht es sich? </li><li>  Rollentatsache - welche Rolle spielt dieses Projekt? </li><li>  <strong><code>tier</code></strong> Fact - Welche Art von Inszenierung hat es (Prod, Test, Dev)? </li></ul><br><p>  Wie funktioniert es  Der Pappet-Agent kommt zum Pappet-Master und sucht anhand dieser Fakten nach Dateien f√ºr sich selbst, wobei er die Ordner gem√§√ü unserer Hierarchie durchsucht.  Es muss nicht angegeben werden, dass die Konfigurationsdateien zu den Servern geh√∂ren.  Stattdessen wissen die Server selbst, welche Dateien ihnen geh√∂ren, und betrachten nur ihren Pfad und ihre Fakten. </p><br><p>  W√§hrend des Server-Setups kommunizieren Administratoren mit Entwicklern und geben diese Parameter an (h√§ufig wenden sich sachkundige Personen h√§ufig selbst an Administratoren), um in Zukunft eine Hierarchie in Hiera zu erstellen, auf deren Grundlage dann die Serverkonfiguration beschrieben wird.  Ein solches System hilft, Code wiederzuverwenden und hinsichtlich der Serverkonfiguration flexibler zu sein. </p><br><p>  Zum Beispiel haben wir ein <em>spezielles</em> Projekt.  In diesem Projekt gibt es m√∂glicherweise einen Frontend-Server mit Nginx, einen Backend-Server mit Python, einen Datenbankcluster mit MySQL und einen Redis-Server f√ºr das Caching.  Alle diese Server sollten in einem Projekt namens " <strong>Special" platziert</strong> werden und dann den Servern <strong>Rollen</strong> zuweisen. </p><br><p>  In der Projektdatei beschreiben wir die Parameter, die dem gesamten Projekt gemeinsam sind.  Das erste, was mir in den Sinn kommt, ist die Erstellung auf allen Servern des Benutzers f√ºr die Bereitstellung mit der Ausgabe der erforderlichen Rechte f√ºr ihn und der Einf√ºhrung seiner SSH-Schl√ºssel. </p><br><p>  In der Rolle f√ºr jeden Server wird der Dienst normalerweise beschrieben und angepasst - f√ºr das, was dieser Server beabsichtigt (Nginx, Python, MySQL usw.). In diesem Fall ben√∂tigen wir definitiv eine Stufe, wenn wir auch eine Kopie der Produktionsumgebung auf der Entwicklungsplattform bereitstellen m√ºssen. aber √§ndern Sie etwas darin (Passw√∂rter zum Beispiel).  In diesem Fall unterscheiden sich der Dev-Server und der Prod-Server nur darin, dass die Ebene auf die gew√ºnschte ‚ÄûPosition‚Äú (Prod oder Dev) eingestellt ist.  Und dann reicht ein bisschen Magie und Hiera. </p><br><p>  Wenn wir zwei identische Server in derselben Rolle bereitstellen m√ºssen, sich jedoch etwas darin unterscheiden sollte, z. B. einige Zeilen in der Konfiguration, wird ein anderer Teil der Hierarchie Abhilfe schaffen.  Wir platzieren die Dateien mit dem Namen des Formats <strong><code>{fqdn }.yaml</code></strong> an der richtigen Stelle (z. B. <strong><code>nodes/myserver.domain.net</code></strong> ), legen die erforderlichen Werte f√ºr Variablen auf der Ebene eines bestimmten Servers fest, und das Pappet wendet f√ºr beide Server f√ºr die Rolle dieselbe Konfiguration an und ist f√ºr jeden Server eindeutig von Servern. </p><br><p>  Beispiel: Zwei Backends mit PHP-Code haben dieselbe Rolle und sind v√∂llig identisch.  Es ist klar, dass wir nicht beide Server sichern wollen - es macht keinen Sinn.  Wir k√∂nnen eine Rolle erstellen, in der dieselbe Konfiguration f√ºr beide Server beschrieben wird, und dann eine weitere Datei <strong><code>nodes/backend1.semrush.net</code></strong> erstellen, in der die Konfiguration f√ºr die Sicherung <strong><code>nodes/backend1.semrush.net</code></strong> werden soll. </p><br><p>  Die Batch-Datei <strong><code>teams/team-name.yaml</code></strong> gibt die Konfiguration f√ºr alle Server an, die zum Team geh√∂ren.  In den meisten F√§llen werden die Benutzer beschrieben, die mit diesen Servern interagieren k√∂nnen, sowie ihre Zugriffsrechte. </p><br><p>  Basierend auf diesen Variablen haben wir diese <strong>Hierarchie aufgebaut</strong> .  Je h√∂her die gefundene Datei in der Hierarchie ist, desto h√∂her ist die Priorit√§t der darin angegebenen Konfiguration. </p><br><p>  Daraus folgt, dass Variablen basierend auf dieser Hierarchie <strong>√ºberschrieben</strong> werden k√∂nnen.  Das hei√üt, die Variable in der Rollendatei " <strong><code>projects/%{::project}/%{::role}</code></strong> " hat Vorrang vor der Variablen in der Projektdatei " <strong><code>projects/%{::project}</code></strong> ".  Variablen k√∂nnen auch auf allen Hierarchieebenen zusammengef√ºhrt werden, wenn Sie ein Modul und / oder Profil / eine Rolle so geschrieben haben, dass Sie dies tun k√∂nnen.  Durch Angabe des gemeinsamen Teils der MySQL-Konfiguration f√ºr alle Projektserver k√∂nnen Sie derselben Variablen auf anderen Hierarchieebenen spezielle Teile hinzuf√ºgen, die f√ºr diese Rolle Gewicht haben (in der Konfiguration f√ºr den Slave wird ein zus√§tzlicher Abschnitt angezeigt). </p><br><p>  Es stellt sich heraus, dass die Datei des spezifischen Knotens entlang des Pfads ‚Äû <strong><code>hieradata/nodes/%{::fqdn}</code></strong> ‚Äú die h√∂chste Priorit√§t hat.  Als n√§chstes kommt die Knotendatei, aber bereits auf Befehlsebene.  Unten ist der Block, der andere, allgemeinere Fakten beschreibt: </p><br><pre> <code class="hljs axapta"> - <span class="hljs-string"><span class="hljs-string">"virtual/%{::virtual}"</span></span> - <span class="hljs-string"><span class="hljs-string">"os/%{::operatingsystem}/%{::operatingsystemmajrelease}"</span></span> - <span class="hljs-string"><span class="hljs-string">"os/%{::operatingsystem}"</span></span> - users - <span class="hljs-keyword"><span class="hljs-keyword">common</span></span></code> </pre> <br><p>  Dementsprechend haben wir in der Datei <strong><code>common.yaml</code></strong> eine Konfiguration, die definitiv f√ºr <strong>alle</strong> Server gelten sollte. In der Datei <strong><code>users.yaml</code></strong> alle Benutzer in <strong><code>os/%{::operatingsystem}</code></strong> beschrieben (aber <strong><code>users.yaml</code></strong> werden nicht alle auf Servern erstellt). Allgemeine Konfiguration, typisch f√ºr Server mit einem bestimmten Betriebssystem (fact <code>::operatingsystem</code> ) und so weiter. </p><br><p>  Ich denke, wenn man diese Hierarchie betrachtet, wird alles klar.  Im Folgenden werde ich ein Beispiel f√ºr die Verwendung einer solchen Hierarchie betrachten.  Aber zuerst m√ºssen Sie √ºber Profile sprechen. </p><br><h3 id="profili">  Profile </h3><br><p>  Ein wichtiger Punkt bei der Konfiguration von Servern mithilfe von Modulen ist die Verwendung von Profilen.  Sie befinden sich auf der Pfadwebsite <strong><code>site/profiles</code></strong> und sind die Einstiegspunkte zu den Modulen.  Dank ihnen k√∂nnen Sie die h√§ngenden Module auf dem Server genauer konfigurieren und die erforderlichen Ressourcen erstellen. </p><br><p>  Betrachten Sie ein einfaches Beispiel.  Es gibt ein <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Modul</a> , das Redis installiert und konfiguriert.  Und wir m√∂chten auch den sysctl-Parameter <code>vm.overcommit_memory</code> beim Anschlie√üen dieses Moduls auf 1 setzen, weil <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> .  Dann schreiben wir ein kleines Profil, das diese Funktionalit√§t bietet: </p><br><pre> <code class="hljs lua"># standalone redis server class profiles::db::redis ( Hash $<span class="hljs-built_in"><span class="hljs-built_in">config</span></span> = {}, String $output_buffer_limit_slave = <span class="hljs-string"><span class="hljs-string">'256mb 64mb 60'</span></span>, ) { # https://redis.<span class="hljs-built_in"><span class="hljs-built_in">io</span></span>/topics/faq#background-saving-fails-with-a-fork-<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>-under-linux-even-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>-i-have-a-lot-of-free-ram sysctl { <span class="hljs-string"><span class="hljs-string">'vm.overcommit_memory'</span></span>: ensure =&gt; present, value =&gt; <span class="hljs-string"><span class="hljs-string">'1'</span></span>, } class { <span class="hljs-string"><span class="hljs-string">'::redis'</span></span>: * =&gt; $<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>, } }</code> </pre> <br><p>  Wie oben erw√§hnt, sind Profile ein Werkzeug, mit dem Sie das Verhalten des Moduls √§ndern / verbessern sowie die Anzahl der Konfigurationen in Hiera reduzieren k√∂nnen.  Wenn Sie Remote-Module verwenden, kann h√§ufig das Problem auftreten, dass ‚Äûgenehmigte‚Äú Module h√§ufig nicht √ºber die von Ihnen ben√∂tigte Funktionalit√§t verf√ºgen oder Fehler aufweisen.  Im Prinzip k√∂nnen Sie dieses Modul dann klonen und Funktionen korrigieren / hinzuf√ºgen.  Die richtige Entscheidung w√§re jedoch, wenn m√∂glich, ein gutes Profil zu erstellen, das das Modul so ‚Äûvorbereiten‚Äú kann, wie Sie es ben√∂tigen.  Im Folgenden finden Sie einige Beispiele f√ºr Profile, mit denen Sie besser verstehen k√∂nnen, warum sie ben√∂tigt werden. </p><br><h3 id="sokrytie-sekretov-v-hiera">  Geheimnisse in Hiera verstecken </h3><br><p>  Einer der wichtigen Vorteile von hiera gegen√ºber dem nackten Pappet ist seine F√§higkeit, vertrauliche Daten in Konfigurationsdateien in verschl√ºsselter Form im Repository zu speichern.  Ihre Passw√∂rter sind sicher. </p><br><p>  Kurz gesagt, Sie verwenden den √∂ffentlichen Schl√ºssel, um die ben√∂tigten Informationen zu verschl√ºsseln und mit einer solchen Zeile in die Hiera-Datei einzuf√ºgen.  Der private Teil des Schl√ºssels wird auf dem Pappet-Master gespeichert, sodass Sie diese Daten entschl√ºsseln k√∂nnen.  Weitere Details finden Sie auf der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Projektseite</a> . </p><br><p>  Auf dem Client (funktionierender Computer) wird das Tool einfach mithilfe von <strong><code>gem install hiera-eyaml</code></strong> .  Mit einem Befehl der Form <strong><code>eyaml encrypt --pkcs7-public-key=/path/to/public_key.pkcs7.pem -s 'hello'</code></strong> Sie Daten verschl√ºsseln und in eine Datei mit der Erweiterung eyaml oder einfach yaml einf√ºgen, je nachdem, wie Sie konfigurieren, und dann wird das Pappet es herausfinden.  Sie erhalten so etwas wie: </p><br><pre> <code class="hljs ruby">roles::postrgresql::<span class="hljs-symbol"><span class="hljs-symbol">password:</span></span> <span class="hljs-string"><span class="hljs-string">'ENC[PKCS7,MIIBeQYJKoZIhvcNAQcDoIIBajCCAWYCAQAxggEhMIIBHQIBADAFMAACAQEwDQYJKoZIhvcNAQEBBQAEggEAbIz1ihQlThMWa9T+Lq194Y6QdElMD1XTev5y+VPSHtkPTu6Al6TJaSrXF+7phJIjue+NF4ZVtJCLkHxUR6nJJqks0fcGS1vF2+6mmM9cy69sIU1A3HqpOHZLuqHAc7jUqljYxpwWSIGOK6I2FygdAp5FfOTewqfcVVmXj97EJdcv3DKrbAlSrIMO2iZRYwQvyv+qnptnZ7pilR2veOCPW2UMm6zagDLutX9Ft5vERbdaiCiEfTOpVa9Qx0GqveNRVJLV/5lfcL5ajdNBJXkvKqDbx8d3ZBtEVAAqeKlw0LqzScgmCbWQx2kUzukX5LSxbTpT0Th984Vp1sl7iPk7UTA8BgkqhkiG9w0BBwEwHQYJYIZIAWUDBAEqBBCp5GcwidcEMA+0wjAMblkKgBCR/f9KGXUgLh3/Ok60OIT5]'</span></span></code> </pre> <br><p>  Oder eine mehrzeilige Zeichenfolge: </p><br><pre> <code class="hljs powershell">roles::postgresql::password: &gt; ENC[<span class="hljs-type"><span class="hljs-type">PKCS7</span></span>,<span class="hljs-type"><span class="hljs-type">MIIBeQYJKoZIhvcNAQcDoIIBajCCAWYCAQAxggEhMIIBHQIBADAFMAACAQEw</span></span> <span class="hljs-type"><span class="hljs-type">DQYJKoZIhvcNAQEBBQAEggEAbIz1ihQlThMWa9T</span></span>+<span class="hljs-type"><span class="hljs-type">Lq194Y6QdElMD1XTev5y</span></span> +<span class="hljs-type"><span class="hljs-type">VPSHtkPTu6Al6TJaSrXF</span></span>+<span class="hljs-number"><span class="hljs-number">7</span></span><span class="hljs-type"><span class="hljs-type">phJIjue</span></span>+<span class="hljs-type"><span class="hljs-type">NF4ZVtJCLkHxUR6nJJqks0fcGS1vF</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>+<span class="hljs-number"><span class="hljs-number">6</span></span><span class="hljs-type"><span class="hljs-type">mmM9cy69sIU1A3HqpOHZLuqHAc7jUqljYxpwWSIGOK6I2FygdAp5FfOTe</span></span> <span class="hljs-type"><span class="hljs-type">wqfcVVmXj97EJdcv3DKrbAlSrIMO2iZRYwQvyv</span></span>+<span class="hljs-type"><span class="hljs-type">qnptnZ7pilR2veOCPW2UM</span></span> <span class="hljs-type"><span class="hljs-type">m6zagDLutX9Ft5vERbdaiCiEfTOpVa9Qx0GqveNRVJLV</span></span>/<span class="hljs-number"><span class="hljs-number">5</span></span><span class="hljs-type"><span class="hljs-type">lfcL5ajdNBJXkv</span></span> <span class="hljs-type"><span class="hljs-type">KqDbx8d3ZBtEVAAqeKlw0LqzScgmCbWQx2kUzukX5LSxbTpT0Th984Vp1sl7</span></span> <span class="hljs-type"><span class="hljs-type">iPk7UTA8BgkqhkiG9w0BBwEwHQYJYIZIAWUDBAEqBBCp5GcwidcEMA</span></span>+<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-type"><span class="hljs-type">wjAM</span></span> <span class="hljs-type"><span class="hljs-type">blkKgBCR</span></span>/<span class="hljs-type"><span class="hljs-type">f9KGXUgLh3</span></span>/<span class="hljs-type"><span class="hljs-type">Ok60OIT5</span></span>]</code> </pre> <br><p>  Es scheint, dass wir mit der Vorbereitung fertig sind, jetzt k√∂nnen wir ein Beispiel betrachten. </p><br><h3 id="primer-na-palcah">  Finger Beispiel </h3><br><p>  <strong>Spoiler</strong> : Es <em>wird viel mehr Konfigurationen geben, sodass diejenigen, die sich f√ºr diesen Artikel von rein theoretischem Interesse interessieren, diesen Abschnitt √ºberspringen und bis zum Ende gehen k√∂nnen.</em> </p><br><p>  Schauen wir uns nun ein Beispiel an, wie ein Server mithilfe von Hiera in Puppet4 konfiguriert wird.  Ich werde den Code nicht f√ºr alle Profile ver√∂ffentlichen, da sich der Beitrag sonst als ziemlich gro√ü herausstellen wird.  Ich werde mich auf die Hierarchie und Konfiguration von Hiera konzentrieren. </p><br><p>  <strong>Die Aufgabe ist folgende:</strong> Wir m√ºssen Folgendes bereitstellen: </p><br><ul><li>  Zwei identische Datenbankserver, auf denen postgresql bereitgestellt wird </li><li>  Zwei weitere Server - Frontend mit Nginx </li><li>  F√ºnfter und sechster Server - Python-Backends im Docker </li><li>  In der Entwicklungsumgebung ist bis auf einige Serverkonfigurationen alles gleich </li></ul><br><p>  Wir werden unsere Hierarchie der Reihe nach erstellen und mit der Projektdatei beginnen. </p><br><h4 id="proekt">  Projekt </h4><br><p>  Erstellen Sie die Projektdatei <strong><code>projects/kicker.yaml</code></strong> .  Wir f√ºgen ein, was allen Servern gemeinsam ist: Wir ben√∂tigen einige Repositorys und Ordner f√ºr die Bereitstellung sowie den Bereitstellungsbenutzer selbst. </p><br><pre> <code class="hljs ruby">--- <span class="hljs-symbol"><span class="hljs-symbol">classes:</span></span> - apt::debian::semrush <span class="hljs-symbol"><span class="hljs-symbol">files:</span></span> <span class="hljs-string"><span class="hljs-string">"/srv/data"</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">ensure:</span></span> <span class="hljs-string"><span class="hljs-string">'directory'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">owner:</span></span> <span class="hljs-string"><span class="hljs-string">'deploy'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">group:</span></span> <span class="hljs-string"><span class="hljs-string">'www-data'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">mode:</span></span> <span class="hljs-string"><span class="hljs-string">'0755'</span></span> <span class="hljs-string"><span class="hljs-string">'/srv/data/shared_temp'</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">ensure:</span></span> <span class="hljs-string"><span class="hljs-string">'directory'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">owner:</span></span> <span class="hljs-string"><span class="hljs-string">'deploy'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">group:</span></span> <span class="hljs-string"><span class="hljs-string">'www-data'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">mode:</span></span> <span class="hljs-string"><span class="hljs-string">'0775'</span></span> user_management::<span class="hljs-symbol"><span class="hljs-symbol">present:</span></span> - deploy</code> </pre> <br><h4 id="rol-db">  Db Rolle </h4><br><p>  Erstellen Sie eine <strong><code>projects/kicker/db.yaml</code></strong> Datenbankserver <strong><code>projects/kicker/db.yaml</code></strong> .  Bisher m√ºssen wir die Server nicht in Umgebungen unterteilen: </p><br><pre> <code class="hljs ruby">--- <span class="hljs-symbol"><span class="hljs-symbol">classes:</span></span> - profiles::db::postgresql profiles::db::postgresql::<span class="hljs-symbol"><span class="hljs-symbol">globals:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">manage_package_repo:</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-symbol"><span class="hljs-symbol">version:</span></span> <span class="hljs-string"><span class="hljs-string">'10'</span></span> profiles::db::postgresql::<span class="hljs-symbol"><span class="hljs-symbol">db_configs:</span></span> <span class="hljs-string"><span class="hljs-string">'listen_addresses'</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">value:</span></span> <span class="hljs-string"><span class="hljs-string">'*'</span></span> profiles::db::postgresql::<span class="hljs-symbol"><span class="hljs-symbol">databases:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">kicker:</span></span> {} profiles::db::postgresql::<span class="hljs-symbol"><span class="hljs-symbol">hba_rules:</span></span> <span class="hljs-string"><span class="hljs-string">'local connect to kicker'</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">type:</span></span> <span class="hljs-string"><span class="hljs-string">'local'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">database:</span></span> <span class="hljs-string"><span class="hljs-string">'kicker'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">user:</span></span> <span class="hljs-string"><span class="hljs-string">'kicker'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">auth_method:</span></span> <span class="hljs-string"><span class="hljs-string">'md5'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">order:</span></span> <span class="hljs-string"><span class="hljs-string">'001'</span></span> <span class="hljs-string"><span class="hljs-string">'allow connect from 192.168.1.100'</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">type:</span></span> <span class="hljs-string"><span class="hljs-string">'host'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">database:</span></span> <span class="hljs-string"><span class="hljs-string">'kicker'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">user:</span></span> <span class="hljs-string"><span class="hljs-string">'kicker'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">auth_method:</span></span> <span class="hljs-string"><span class="hljs-string">'md5'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">address:</span></span> <span class="hljs-string"><span class="hljs-string">'192.168.1.100/32'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">order:</span></span> <span class="hljs-string"><span class="hljs-string">'002'</span></span></code> </pre> <br><p>  Hier verbinden wir ein Profil, das f√ºr den allgemeinen Gebrauch von allen geschrieben wurde, die Postgres auf ihrem Server installieren m√∂chten.  Das Profil ist konfigurierbar und erm√∂glicht es Ihnen, das Modul flexibel zu konfigurieren, bevor Sie es anwenden. </p><br><p>  F√ºr die Neugierigsten unter dem Katzencode f√ºr dieses Profil: </p><br><div class="spoiler">  <b class="spoiler_title">Profil :: db :: postgresql</b> <div class="spoiler_text"><pre> <code class="hljs mel">class profiles::db::postgresql ( Hash $globals = {}, Hash $params = {}, Hash $recovery = {}, Hash[String, Hash[String, Variant[String, Boolean, Integer]]] $roles = {}, Hash[String, Hash[String, Variant[String, Boolean]]] $db_configs = {}, Hash[String, Hash[String, Variant[String, Boolean]]] $databases = {}, Hash[String, String] $db_grants = {}, Hash[String, Hash[String, String]] $extensions = {}, Hash[String, String] $table_grants = {}, Hash[String, Hash[String, String]] $hba_rules = {}, Hash[String, String] $indent_rules = {}, Optional[String] $role = undef, # <span class="hljs-string"><span class="hljs-string">'master'</span></span>, <span class="hljs-string"><span class="hljs-string">'slave'</span></span> Optional[String] $master_host = undef, Optional[String] $replication_password = undef, Integer $master_port = <span class="hljs-number"><span class="hljs-number">5432</span></span>, String $replication_user = <span class="hljs-string"><span class="hljs-string">'repl'</span></span>, String $trigger_file = <span class="hljs-string"><span class="hljs-string">'/tmp/pg_trigger.file'</span></span>, ){ <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> $role { <span class="hljs-string"><span class="hljs-string">'slave'</span></span>: { $_params = { manage_recovery_conf =&gt; true, } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> $globals[<span class="hljs-string"><span class="hljs-string">'datadir'</span></span>] { <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> { <span class="hljs-string"><span class="hljs-string">"${globals['datadir']}/recovery.done"</span></span>: ensure =&gt; absent, } } $_recovery = { <span class="hljs-string"><span class="hljs-string">'recovery config'</span></span> =&gt; { standby_mode =&gt; <span class="hljs-string"><span class="hljs-string">'on'</span></span>, primary_conninfo =&gt; <span class="hljs-string"><span class="hljs-string">"host=${master_host} port=${master_port} user=${replication_user} password=${replication_password}"</span></span>, trigger_file =&gt; $trigger_file, } } $_conf = { <span class="hljs-string"><span class="hljs-string">'hot_standby'</span></span> =&gt; { value =&gt; <span class="hljs-string"><span class="hljs-string">'on'</span></span>, }, } <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> { $trigger_file: ensure =&gt; absent, } } <span class="hljs-string"><span class="hljs-string">'master'</span></span>: { $_conf = { <span class="hljs-string"><span class="hljs-string">'wal_level'</span></span> =&gt; { value =&gt; <span class="hljs-string"><span class="hljs-string">'replica'</span></span>, }, <span class="hljs-string"><span class="hljs-string">'max_wal_senders'</span></span> =&gt; { value =&gt; <span class="hljs-number"><span class="hljs-number">5</span></span>, }, <span class="hljs-string"><span class="hljs-string">'wal_keep_segments'</span></span> =&gt; { value =&gt; <span class="hljs-number"><span class="hljs-number">32</span></span>, }, } <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> { $trigger_file: ensure =&gt; present, } } <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: { $_params = {} $_recovery = {} $_conf = {} } } class { <span class="hljs-string"><span class="hljs-string">'::postgresql::globals'</span></span>: * =&gt; $globals, } class { <span class="hljs-string"><span class="hljs-string">'::postgresql::server'</span></span>: * =&gt; deep_merge($_params, $params), } create_resources(<span class="hljs-string"><span class="hljs-string">'::postgresql::server::config_entry'</span></span>, deep_merge($_conf, $db_configs)) create_resources(<span class="hljs-string"><span class="hljs-string">'::postgresql::server::role'</span></span>, $roles) create_resources(<span class="hljs-string"><span class="hljs-string">'::postgresql::server::database'</span></span>, $databases) create_resources(<span class="hljs-string"><span class="hljs-string">'::postgresql::server::database_grant'</span></span>, $db_grants) create_resources(<span class="hljs-string"><span class="hljs-string">'::postgresql::server::extension'</span></span>, $extensions) create_resources(<span class="hljs-string"><span class="hljs-string">'::postgresql::server::table_grant'</span></span>, $table_grants) create_resources(<span class="hljs-string"><span class="hljs-string">'::postgresql::server::pg_hba_rule'</span></span>, $hba_rules) create_resources(<span class="hljs-string"><span class="hljs-string">'::postgresql::server::pg_indent_rule'</span></span>, $indent_rules) create_resources(<span class="hljs-string"><span class="hljs-string">'::postgresql::server::recovery'</span></span>, deep_merge($_recovery, $recovery)) }</code> </pre> </div></div><br><p>  Daher installieren wir <code>Postgresql 10</code> einen Schlag, konfigurieren die Konfiguration ( <code>listen</code> ), erstellen die <code>kicker</code> Datenbank und schreiben zwei Regeln f√ºr den Zugriff auf diese Datenbank in <code>pg_hba.conf</code> .  Cool! </p><br><h4 id="rol-frontend">  Frontend-Rolle </h4><br><p>  Wir nehmen das <code>frontend</code> .  Erstellen Sie die Datei <strong><code>projects/kicker/frontend.yaml</code></strong> mit den folgenden Inhalten: </p><br><pre> <code class="hljs ruby">--- <span class="hljs-symbol"><span class="hljs-symbol">classes:</span></span> - profiles::webserver::nginx profiles::webserver::nginx::<span class="hljs-symbol"><span class="hljs-symbol">servers:</span></span> <span class="hljs-string"><span class="hljs-string">'kicker.semrush.com'</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">use_default_location:</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span> <span class="hljs-symbol"><span class="hljs-symbol">listen_port:</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-symbol"><span class="hljs-symbol">server_name:</span></span> - <span class="hljs-string"><span class="hljs-string">'kicker.semrush.com'</span></span> profiles::webserver::nginx::<span class="hljs-symbol"><span class="hljs-symbol">locations:</span></span> <span class="hljs-string"><span class="hljs-string">'kicker-root'</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">location:</span></span> <span class="hljs-string"><span class="hljs-string">'/'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">server:</span></span> <span class="hljs-string"><span class="hljs-string">'kicker.semrush.com'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">proxy:</span></span> <span class="hljs-string"><span class="hljs-string">'http://kicker-backend.semrush.com:8080'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">proxy_set_header:</span></span> - <span class="hljs-string"><span class="hljs-string">'X-Real-IP $remote_addr'</span></span> - <span class="hljs-string"><span class="hljs-string">'X-Forwarded-for $remote_addr'</span></span> - <span class="hljs-string"><span class="hljs-string">'Host kicker.semrush.com'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">location_cfg_append:</span></span> <span class="hljs-string"><span class="hljs-string">'proxy_next_upstream'</span></span>: <span class="hljs-string"><span class="hljs-string">'error timeout invalid_header http_500 http_502 http_503 http_504'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">proxy_connect_timeout:</span></span> <span class="hljs-string"><span class="hljs-string">'5'</span></span></code> </pre> <br><p>  Hier ist alles einfach.  Wir verbinden das <strong><code>profiles::webserver::nginx</code></strong> , das den Eintrag in das nginx-Modul vorbereitet, und definieren auch die Variablen, insbesondere den <code>server</code> und den <code>location</code> f√ºr diese Site. </p><br><p>  Ein aufmerksamer Leser wird feststellen, dass es angemessener w√§re, die Beschreibung der Site h√∂her in der Hierarchie zu platzieren, da wir weiterhin eine Entwicklungsumgebung haben und andere Variablen ( <code>server_name</code> , <code>proxy</code> ) dort verwendet werden, dies ist jedoch nicht zu wichtig.  Wenn wir die Rolle auf diese Weise beschreiben, k√∂nnen wir sehen, wie diese Variablen nur durch Hierarchie neu definiert werden. </p><br><h4 id="rol-docker">  Docker-Rolle </h4><br><p>  Die Rolle von <code>docker</code> <strong><code>projects/kicker/docker.yaml</code></strong> : </p><br><pre> <code class="hljs ruby">--- <span class="hljs-symbol"><span class="hljs-symbol">classes:</span></span> - profiles::docker profiles::docker::<span class="hljs-symbol"><span class="hljs-symbol">params:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">version:</span></span> <span class="hljs-string"><span class="hljs-string">'17.05.0~ce-0~debian-stretch'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">packages:</span></span> <span class="hljs-string"><span class="hljs-string">'python3-pip'</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">provider:</span></span> apt <span class="hljs-string"><span class="hljs-string">'Fabric3'</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">provider:</span></span> pip3 <span class="hljs-symbol"><span class="hljs-symbol">ensure:</span></span> <span class="hljs-number"><span class="hljs-number">1.12</span></span>.post1 user_management::<span class="hljs-symbol"><span class="hljs-symbol">users:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">deploy:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">groups:</span></span> - docker</code> </pre> <br><p>  Das <strong><code>profiles/docker.pp</code></strong> sehr einfach und elegant.  Ich werde seinen Code geben: </p><br><div class="spoiler">  <b class="spoiler_title">Profil :: Docker</b> <div class="spoiler_text"><pre> <code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">profiles</span></span></span><span class="hljs-class">:</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">:docker </span></span></span></span>( Hash $params = {}, <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> $install_kernel = <span class="hljs-literal"><span class="hljs-literal">false</span></span>, ){ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-string"><span class="hljs-string">'docker'</span></span>: * =&gt; $params, } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($install_kernel) { include profiles::docker::kernel } }</code> </pre> </div></div><br><p>  Alles ist fertig.  Dies reicht bereits aus, um das ben√∂tigte Produkt auf vielen Servern bereitzustellen und ihnen einfach ein bestimmtes Projekt und eine bestimmte Rolle zuzuweisen (z. B. die Datei im gew√ºnschten Format im Verzeichnis facts.d abzulegen, dessen Speicherort von der Installationsmethode von Puppet abh√§ngt). </p><br><p>  Jetzt haben wir folgende Dateistruktur: </p><br><pre> <code class="bash hljs">. ‚îú‚îÄ‚îÄ kicker ‚îÇ ‚îú‚îÄ‚îÄ db.yaml ‚îÇ ‚îú‚îÄ‚îÄ docker.yaml ‚îÇ ‚îî‚îÄ‚îÄ frontend.yaml ‚îî‚îÄ‚îÄ kicker.yaml 1 directory, 4 files</code> </pre> <br><p>  Jetzt besch√§ftigen wir uns mit Umgebungen und der Definition einer Konfiguration, die f√ºr eine Rolle an einem bestimmten Standort eindeutig ist. </p><br><h4 id="okruzheniya-i-override">  Umgebung und Override </h4><br><p>  Lassen Sie uns die allgemeine Konfiguration f√ºr alle Verk√§ufe erstellen.  Die Datei <strong><code>projects/kicker/tiers/prod.yaml</code></strong> enth√§lt einen Hinweis darauf, dass eine Klasse mit einer Firewall mit dieser Umgebung verbunden werden muss ( <strong><code>projects/kicker/tiers/prod.yaml</code></strong> prod) sowie eine bestimmte Klasse, die ein h√∂heres Ma√ü an Sicherheit bietet: </p><br><pre> <code class="hljs pgsql"><span class="hljs-comment"><span class="hljs-comment">--- classes: - semrush_firewall - strict_security_level</span></span></code> </pre> <br><p>  Wenn wir in einer Entwicklungsumgebung etwas Bestimmtes beschreiben m√ºssen, wird dieselbe Datei erstellt und die erforderliche Konfiguration eingegeben. </p><br><p>  Als N√§chstes m√ºssen Sie die Variablen f√ºr die Nginx-Konfiguration der <code>frontend</code> Rolle in der Entwicklungsumgebung noch neu definieren.  Dazu m√ºssen Sie die Datei <strong><code>projects/kicker/tiers/dev/frontend.yaml</code></strong> erstellen.  Achten Sie auf eine neue Hierarchieebene. </p><br><pre> <code class="hljs ruby">--- profiles::webserver::nginx::<span class="hljs-symbol"><span class="hljs-symbol">servers:</span></span> <span class="hljs-string"><span class="hljs-string">'kicker-dev.semrush.com'</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">use_default_location:</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span> <span class="hljs-symbol"><span class="hljs-symbol">listen_port:</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-symbol"><span class="hljs-symbol">server_name:</span></span> - <span class="hljs-string"><span class="hljs-string">'kicker-dev.semrush.com'</span></span> profiles::webserver::nginx::<span class="hljs-symbol"><span class="hljs-symbol">locations:</span></span> <span class="hljs-string"><span class="hljs-string">'kicker-root'</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">location:</span></span> <span class="hljs-string"><span class="hljs-string">'/'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">server:</span></span> <span class="hljs-string"><span class="hljs-string">'kicker-dev.semrush.com'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">proxy:</span></span> <span class="hljs-string"><span class="hljs-string">'http://kicker-backend-dev.semrush.com:8080'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">proxy_set_header:</span></span> - <span class="hljs-string"><span class="hljs-string">'X-Real-IP $remote_addr'</span></span> - <span class="hljs-string"><span class="hljs-string">'X-Forwarded-for $remote_addr'</span></span> - <span class="hljs-string"><span class="hljs-string">'Host kicker-dev.semrush.com'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">location_cfg_append:</span></span> <span class="hljs-string"><span class="hljs-string">'proxy_next_upstream'</span></span>: <span class="hljs-string"><span class="hljs-string">'error timeout invalid_header http_500 http_502 http_503 http_504'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">proxy_connect_timeout:</span></span> <span class="hljs-string"><span class="hljs-string">'5'</span></span></code> </pre> <br><p>  Sie m√ºssen keine Klasse mehr angeben, sie wird von fr√ºheren Hierarchieebenen geerbt.  Hier haben wir <code>proxy_pass</code> und <code>proxy_pass</code> ge√§ndert.  Ein Server mit den Fakten role = frontend und tier = dev findet zuerst die Datei <strong><code>projects/kicker/frontend.yaml</code></strong> f√ºr sich selbst. Anschlie√üend werden die Variablen aus dieser Datei von der Datei <strong><code>projects/kicker/tiers/dev/frontend.yaml</code></strong> mit h√∂herer Priorit√§t √ºberschrieben . </p><br><h4 id="sokrytie-parolya-dlya-postgresql">  Passwort f√ºr PostgreSQL versteckt </h4><br><p>  Und so haben wir den letzten Punkt auf der Tagesordnung - Passw√∂rter f√ºr PostgreSQL festlegen. </p><br><p>  Passw√∂rter sollten in Umgebungen variieren.  Wir werden eyaml verwenden, um Passw√∂rter sicher zu speichern.  Passw√∂rter erstellen: </p><br><pre> <code class="bash hljs">eyaml encrypt -s <span class="hljs-string"><span class="hljs-string">'verysecretpassword'</span></span> eyaml encrypt -s <span class="hljs-string"><span class="hljs-string">'testpassword'</span></span></code> </pre> <br><p>  Wir f√ºgen die resultierenden Zeilen in die Dateien <code>**projects/kicker/tiers/prod/db.yaml**</code> und <code>**projects/kicker/tiers/dev/db.yaml**</code> (oder Sie k√∂nnen die eyaml-Erweiterung verwenden, dies ist anpassbar).  Hier ist ein Beispiel: </p><br><pre> <code class="hljs ruby">--- profiles::db::postgresql::<span class="hljs-symbol"><span class="hljs-symbol">roles:</span></span> <span class="hljs-string"><span class="hljs-string">'kicker'</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">password_hash:</span></span> &gt; <span class="hljs-string"><span class="hljs-string">'ENC[PKCS7,MIIBeQYJKoZIhvcNAQcDoIIBajCCAWYCAQAxggEhMIIBHQIBADAFMAACAQEwDQYJKoZIhvcNAQEBBQAEggEAsdpb2P0axUJzyWr2duRKAjh0WooGYUmoQ5gw0nO9Ym5ftv6uZXv25DRMKh7vsbzrrOR5/lLesx/pAVmcs2qbhd/y0Vr1oc2ohHlZBBKtCSEYwem5VN+kTMhWPvlt93x/S9ERoBp8LrrsIvicSYZByNfpS2DXCFbogSXCfEPxTTmCOtlOnxdjidIc9Q1vfAXv7FRQanYIspr2UytScm56H/ueeAc/8RYK51/nXDMtdPOiAP5VARioUKyTDSk8FqNvdUZRqA3cl+hA+xD5PiBHn5T09pnH8HyE/39q09gE0pXRe5+mOnU/4qfqFPc/EvAgAq5mVawlCR6c/cCKln5wJTA8BgkqhkiG9w0BBwEwHQYJYIZIAWUDBAEqBBDNKijGHBLPCth0sfwAjfl/gBAaPsfvzZQ/Umgjy1n+im0s]'</span></span></code> </pre> <br><p>  Als n√§chstes wird das Passwort f√ºr die <code>kicker</code> Rolle kommen, entschl√ºsselt und auf den Datenbankserver in PostgreSQL angewendet. </p><br><p>  Das ist in der Tat alles.  Ja, das Beispiel erwies sich als massiv, aber ich hoffe, es funktioniert, ohne Fragen zu stellen, klar und n√ºtzlich.  Die resultierende Hierarchie in Hiera lautet wie folgt: </p><br><pre> <code class="bash hljs">. ‚îú‚îÄ‚îÄ db.yaml ‚îú‚îÄ‚îÄ docker.yaml ‚îú‚îÄ‚îÄ frontend.yaml ‚îî‚îÄ‚îÄ tiers ‚îú‚îÄ‚îÄ dev ‚îÇ ‚îú‚îÄ‚îÄ db.yaml ‚îÇ ‚îî‚îÄ‚îÄ frontend.yaml ‚îú‚îÄ‚îÄ prod ‚îÇ ‚îî‚îÄ‚îÄ db.yaml ‚îî‚îÄ‚îÄ prod.yaml 3 directories, 7 files</code> </pre> <br><p>  Sie k√∂nnen diese Dateien live verfolgen, indem Sie ein speziell erstelltes <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Repository</a> klonen </p><br><h3 id="zaklyuchenie">  Fazit </h3><br><p>  Puppe ist gut und einfach mit Hiera zu verwenden.  Ich w√ºrde es nicht als ideales Konfigurationswerkzeug in der modernen Welt bezeichnen, √ºberhaupt nicht, aber es verdient Aufmerksamkeit.  Er bew√§ltigt einige Aufgaben sehr gut, und seine ‚ÄûPhilosophie‚Äú, einen st√§ndig identischen Zustand von Ressourcen und Konfiguration beizubehalten, kann eine wichtige Rolle bei der Gew√§hrleistung der Sicherheit und Einheitlichkeit von Konfigurationen spielen. </p><br><p>  Die moderne Welt entwickelt sich allm√§hlich zu Synergien und entwickelt sich weiter.  Nur wenige Leute verwenden nur noch ein Konfigurationssystem, oft gibt es im Arsenal der Entwickler und Administratoren mehrere Systeme gleichzeitig.  Und das ist gut so, denn es gibt eine gro√üe Auswahl.  Die Hauptsache ist, dass alles logisch und verst√§ndlich sein sollte, wie und wo es konfiguriert werden kann. </p><br><p>  Daher ist es unser Ziel als Administratoren, nichts selbst zu konfigurieren.  All dies sollte idealerweise von den Teams selbst durchgef√ºhrt werden.  Und wir m√ºssen ihnen ein Werkzeug oder Produkt geben, mit dem wir dies sicher, einfach und vor allem mit einem genauen Ergebnis tun k√∂nnen.  Nun, und helfen Sie bei der L√∂sung architektonischer und schwerwiegenderer Probleme als "Sie m√ºssen PostgreSQL auf dem Server installieren und einen Benutzer erstellen."  Camon, 2018 ist auf dem Hof! <del>  Also werfen Sie Marionette und Ansible und bewegen Sie sich in die Zukunft ohne Server. </del></p><br><p>  Mit der Entwicklung von Cloud-, Containerisierungs- und Container-Orchestrierungssystemen treten Konfigurationsmanagementsysteme f√ºr Benutzer und Kunden langsam in den Hintergrund.  Sie k√∂nnen auch einen ausfallsicheren Cluster von Containern in der Cloud erstellen und Ihre Anwendungen in Containern mit Auto-Skelling, Backup, Replikation, Auto-Discovery usw. aufbewahren, ohne eine einzige Zeile f√ºr Ansible, Puppet, Chef usw. zu schreiben.  Sie m√ºssen sich um nichts k√ºmmern (na ja, fast).  Auf der anderen Seite gibt es aufgrund von Wolken weniger Eisenserver.  Sie m√ºssen sie nur nicht mehr konfigurieren. Diese Aktion liegt in der Verantwortung des Cloud-Anbieters.  Es ist jedoch unwahrscheinlich, dass sie dieselben Systeme wie gew√∂hnliche Sterbliche verwenden. </p><br><h4 id="credits">  Credits </h4><br><p>  Vielen Dank: </p><br><ul><li>  Dmitry Tupitsin, Dmitry Loginov, Stepan Fedorov und das gesamte Team von Systemadministratoren f√ºr ihre Hilfe bei der Vorbereitung dieses Artikels </li><li>  Vladimir Legkostupov f√ºr das Bild </li><li>  Yana Tabakova, die all dies organisiert und dabei hilft, alle Phasen vor der Ver√∂ffentlichung zu durchlaufen </li><li>  Nikita Zakharov f√ºr Unterst√ºtzung bei Lizenzfragen </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de412587/">https://habr.com/ru/post/de412587/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de412573/index.html">Was mit Geektimes los ist, kehre nach Habr zur√ºck</a></li>
<li><a href="../de412575/index.html">Popmusik wird von Jahr zu Jahr eint√∂niger, weil die gleichen Leute sie komponieren</a></li>
<li><a href="../de412579/index.html">Marvel: Infinity War oder Wie Sie in wenigen Minuten Daten f√ºr Ihr Projekt sammeln</a></li>
<li><a href="../de412581/index.html">Von der Steinzeit bis zum Zweiten Weltkrieg: Wie Roboter zur Erforschung historischer Artefakte eingesetzt werden</a></li>
<li><a href="../de412583/index.html">Wir zerlegen das Redmond G200S-Kesselprotokoll und verbinden es mit dem HomeAssistant</a></li>
<li><a href="../de412589/index.html">25 unterhaltsame Android-Bibliotheken. Fr√ºhling 2018</a></li>
<li><a href="../de412591/index.html">Jetpack bauen: Der 29. Mai ist Wendell Moores Gedenktag</a></li>
<li><a href="../de412593/index.html">Neue Produkte, Plattformen und All-as-a-Service: HPE-Webinare</a></li>
<li><a href="../de412595/index.html">Bericht des Club of Rome 2018, Kapitel 1.1.2: ‚ÄûFinanzierung‚Äú</a></li>
<li><a href="../de412597/index.html">Jeff Bezos wird eine Kolonie auf der Oberfl√§che des Mondes bauen</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>