<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏽‍🏫 🎎 👩🏾‍💼 Marionette + Hiera. Drücken Sie das Maximum 🕐 🤣 👨‍👩‍👦</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In diesem Artikel möchte ich darüber sprechen, wie wir Puppet und Hiera verwenden , um Eisen- und virtuelle Server zu konfigurieren. Grundsätzlich geh...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Marionette + Hiera. Drücken Sie das Maximum</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/semrush/blog/412587/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/vq/z-/bj/vqz-bjm4yx2wvhzcf-frffyuh04.png"></div><br><p>  In diesem Artikel möchte ich darüber sprechen, wie wir <strong>Puppet</strong> und <strong>Hiera verwenden</strong> , um Eisen- und virtuelle Server zu konfigurieren.  Grundsätzlich geht es um die Architektur und die von uns erfundene Hierarchie, die die Konfiguration von Servern erleichtert und systematisiert. </p><br><p>  Ich wurde aufgefordert, diesen Artikel zu schreiben, weil ich im Internet keine besonders guten, wirklich funktionierenden Beispiele dafür gefunden habe, wie man mit Hiera arbeiten kann und wofür es ist.  Grundsätzlich handelt es sich hierbei um Tutorials mit Beispielen, um in das Thema einzutreten.  Aber die wirkliche praktische Anwendung von Hiera ist dort nicht geschrieben.  Vielleicht habe ich nicht gut ausgesehen, aber hier ist ein echtes Beispiel, das Ihnen wahrscheinlich helfen wird, alle Punkte über i zu setzen, wie ich es einmal getan habe. </p><br><h3 id="dlya-kogo-byla-by-polezna-dannaya-statya">  Für wen wäre dieser Artikel nützlich </h3><br><p>  Wenn: </p><br><ul><li>  Sie wissen, was Puppet und Hiera sind, aber Sie verwenden sie nicht wirklich zusammen, da nicht klar ist, wie und warum </li><li>  Sie haben viele Teams in Ihrem Unternehmen und müssen die Serverkonfiguration auf Befehlsebene irgendwie differenzieren </li><li>  Sie verwenden ein Pappet und die Knotendateien sind unglaublich groß geworden </li><li>  Lesen Sie gerne die Serverkonfiguration im göttlichen Yaml-Format :) </li><li>  Sie interessieren sich grundsätzlich für das Thema Konfigurationsmanagement und Systemadministration. </li></ul><br><p>  Dieser Artikel ist für Sie. </p><a name="habracut"></a><br><h3 id="prezhde-chem-nachat">  Bevor Sie anfangen </h3><br><p>  Ich werde Sie sofort warnen, der Artikel hat sich als lang herausgestellt, aber ich hoffe, er ist nützlich.  Außerdem wird davon ausgegangen, dass Sie Hiera bereits mit Puppe verbunden haben und zumindest irgendwie mit Puppe vertraut sind.  Wenn hiera nicht verbunden ist, ist es nicht schwierig zu tun. </p><br><ul><li>  Lesen Sie hier mehr darüber, was Puppet ist: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Puppet für Anfänger</a> . </li><li>  So funktioniert Hiera - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Einführung in Hiera</a> . </li></ul><br><h3 id="vvodnye-dannye">  Daten eingeben </h3><br><ul><li>  Wir haben ungefähr 30 Entwicklungsteams bei SEMrush, von denen jedes seine eigenen Server hat </li><li>  Jedes Team arbeitet mit seinen eigenen Technologien (PL, DBMS usw.) </li><li>  Teams können und sollten (idealerweise) eine gemeinsame Konfiguration für bestimmte Projekte verwenden (Wiederverwendung von Code) </li><li>  Die Teams selbst verwalten die Bereitstellung von Anwendungen auf ihren Servern (dies erfolgt nicht über das Pappet). </li></ul><br><h3 id="nemnogo-istorii">  Ein bisschen Geschichte </h3><br><p>  Anfangs hatten wir alles im Pappet der Version 3, dann entschieden wir uns, das 4. Pappet zu implementieren, und wir begannen, alle neuen Server darin zu platzieren und die alten langsam auf das 4. zu portieren. </p><br><p>  Im dritten Teil verwendeten wir das klassische System von Knotendateien und -modulen.  Die Module wurden in einer speziellen Gruppe von Projekten in Gitlab erstellt, auf einen Pappet-Server (mit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">r10k</a> ) <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">geklont</a> , dann kamen die Pappet-Agenten zum Assistenten und erhielten ein Verzeichnis, um es auf den Server anzuwenden. </p><br><p>  Dann versuchten sie, dies nicht zu tun und keine lokalen Module zu verwenden, sondern stellten Links zu den erforderlichen Modulen und ihren Repositorys in das Puppetfile.  Warum?  Weil diese Module von der Community und den Entwicklern ständig unterstützt und verbessert werden (im Idealfall), und unsere lokalen Module nicht.  Später führten sie hiera ein und wechselten vollständig dazu, und Knotendateien (wie node.pp) sind in Vergessenheit geraten. </p><br><p> Im vierten Teil haben wir versucht, lokale Module vollständig aufzugeben und nur Remote-Module zu verwenden.  Leider sollte hier wieder eine Reservierung eingefügt werden, da es „nicht ganz geklappt hat“, manchmal muss man noch etwas selbst neigen und fertigstellen.  Natürlich gibt es nur Hiera und keine Knotendateien. </p><br><p>  <strong>Wenn Sie 30 Teams mit einem Technologiezoo haben, wird das Problem, wie diese Menagerie mit&gt; 1000 Servern gehalten werden kann, besonders akut.</strong>  <strong>Weiter werde ich erzählen, wie uns hiera dabei hilft.</strong> </p><br><h3 id="ierarhiya">  Hierarchie </h3><br><p>  Hiera (von der es seinen Namen hat) richtet eine Hierarchie ein.  Bei uns sieht es so aus: </p><br><pre><code class="hljs axapta">--- :hierarchy: - <span class="hljs-string"><span class="hljs-string">"nodes/%{::fqdn}"</span></span> - <span class="hljs-string"><span class="hljs-string">"teams/%{::team}_team/nodes/%{::fqdn}"</span></span> - <span class="hljs-string"><span class="hljs-string">"teams/%{::team}_team/projects/%{::project}/tiers/%{::tier}"</span></span> - <span class="hljs-string"><span class="hljs-string">"teams/%{::team}_team/projects/%{::project}/%{::role}"</span></span> - <span class="hljs-string"><span class="hljs-string">"teams/%{::team}_team/projects/%{::project}"</span></span> - <span class="hljs-string"><span class="hljs-string">"teams/%{::team}_team/roles/%{::role}"</span></span> - <span class="hljs-string"><span class="hljs-string">"teams/%{::team}_team/%{::team}"</span></span> - <span class="hljs-string"><span class="hljs-string">"projects/%{::project}/tiers/%{::tier}/%{::role}"</span></span> - <span class="hljs-string"><span class="hljs-string">"projects/%{::project}/tiers/%{::tier}"</span></span> - <span class="hljs-string"><span class="hljs-string">"projects/%{::project}/%{::role}"</span></span> - <span class="hljs-string"><span class="hljs-string">"projects/%{::project}"</span></span> - <span class="hljs-string"><span class="hljs-string">"tiers/%{::tier}"</span></span> - <span class="hljs-string"><span class="hljs-string">"virtual/%{::virtual}"</span></span> - <span class="hljs-string"><span class="hljs-string">"os/%{::operatingsystem}/%{::operatingsystemmajrelease}"</span></span> - <span class="hljs-string"><span class="hljs-string">"os/%{::operatingsystem}"</span></span> - users - <span class="hljs-keyword"><span class="hljs-keyword">common</span></span></code> </pre> <br><p>  Lassen Sie uns zunächst obskure Variablen (Fakten) behandeln. </p><br><p>  Jeder Server in SEMrush sollte idealerweise 4 exponierte, spezielle Fakten haben, die seine Zugehörigkeit beschreiben: </p><br><ul><li>  <strong><code>team</code></strong> Tatsache - zu welchem ​​Team gehört es? </li><li>  Faktenprojekt - auf welches Projekt bezieht es sich? </li><li>  Rollentatsache - welche Rolle spielt dieses Projekt? </li><li>  <strong><code>tier</code></strong> Fact - Welche Art von Inszenierung hat es (Prod, Test, Dev)? </li></ul><br><p>  Wie funktioniert es  Der Pappet-Agent kommt zum Pappet-Master und sucht anhand dieser Fakten nach Dateien für sich selbst, wobei er die Ordner gemäß unserer Hierarchie durchsucht.  Es muss nicht angegeben werden, dass die Konfigurationsdateien zu den Servern gehören.  Stattdessen wissen die Server selbst, welche Dateien ihnen gehören, und betrachten nur ihren Pfad und ihre Fakten. </p><br><p>  Während des Server-Setups kommunizieren Administratoren mit Entwicklern und geben diese Parameter an (häufig wenden sich sachkundige Personen häufig selbst an Administratoren), um in Zukunft eine Hierarchie in Hiera zu erstellen, auf deren Grundlage dann die Serverkonfiguration beschrieben wird.  Ein solches System hilft, Code wiederzuverwenden und hinsichtlich der Serverkonfiguration flexibler zu sein. </p><br><p>  Zum Beispiel haben wir ein <em>spezielles</em> Projekt.  In diesem Projekt gibt es möglicherweise einen Frontend-Server mit Nginx, einen Backend-Server mit Python, einen Datenbankcluster mit MySQL und einen Redis-Server für das Caching.  Alle diese Server sollten in einem Projekt namens " <strong>Special" platziert</strong> werden und dann den Servern <strong>Rollen</strong> zuweisen. </p><br><p>  In der Projektdatei beschreiben wir die Parameter, die dem gesamten Projekt gemeinsam sind.  Das erste, was mir in den Sinn kommt, ist die Erstellung auf allen Servern des Benutzers für die Bereitstellung mit der Ausgabe der erforderlichen Rechte für ihn und der Einführung seiner SSH-Schlüssel. </p><br><p>  In der Rolle für jeden Server wird der Dienst normalerweise beschrieben und angepasst - für das, was dieser Server beabsichtigt (Nginx, Python, MySQL usw.). In diesem Fall benötigen wir definitiv eine Stufe, wenn wir auch eine Kopie der Produktionsumgebung auf der Entwicklungsplattform bereitstellen müssen. aber ändern Sie etwas darin (Passwörter zum Beispiel).  In diesem Fall unterscheiden sich der Dev-Server und der Prod-Server nur darin, dass die Ebene auf die gewünschte „Position“ (Prod oder Dev) eingestellt ist.  Und dann reicht ein bisschen Magie und Hiera. </p><br><p>  Wenn wir zwei identische Server in derselben Rolle bereitstellen müssen, sich jedoch etwas darin unterscheiden sollte, z. B. einige Zeilen in der Konfiguration, wird ein anderer Teil der Hierarchie Abhilfe schaffen.  Wir platzieren die Dateien mit dem Namen des Formats <strong><code>{fqdn }.yaml</code></strong> an der richtigen Stelle (z. B. <strong><code>nodes/myserver.domain.net</code></strong> ), legen die erforderlichen Werte für Variablen auf der Ebene eines bestimmten Servers fest, und das Pappet wendet für beide Server für die Rolle dieselbe Konfiguration an und ist für jeden Server eindeutig von Servern. </p><br><p>  Beispiel: Zwei Backends mit PHP-Code haben dieselbe Rolle und sind völlig identisch.  Es ist klar, dass wir nicht beide Server sichern wollen - es macht keinen Sinn.  Wir können eine Rolle erstellen, in der dieselbe Konfiguration für beide Server beschrieben wird, und dann eine weitere Datei <strong><code>nodes/backend1.semrush.net</code></strong> erstellen, in der die Konfiguration für die Sicherung <strong><code>nodes/backend1.semrush.net</code></strong> werden soll. </p><br><p>  Die Batch-Datei <strong><code>teams/team-name.yaml</code></strong> gibt die Konfiguration für alle Server an, die zum Team gehören.  In den meisten Fällen werden die Benutzer beschrieben, die mit diesen Servern interagieren können, sowie ihre Zugriffsrechte. </p><br><p>  Basierend auf diesen Variablen haben wir diese <strong>Hierarchie aufgebaut</strong> .  Je höher die gefundene Datei in der Hierarchie ist, desto höher ist die Priorität der darin angegebenen Konfiguration. </p><br><p>  Daraus folgt, dass Variablen basierend auf dieser Hierarchie <strong>überschrieben</strong> werden können.  Das heißt, die Variable in der Rollendatei " <strong><code>projects/%{::project}/%{::role}</code></strong> " hat Vorrang vor der Variablen in der Projektdatei " <strong><code>projects/%{::project}</code></strong> ".  Variablen können auch auf allen Hierarchieebenen zusammengeführt werden, wenn Sie ein Modul und / oder Profil / eine Rolle so geschrieben haben, dass Sie dies tun können.  Durch Angabe des gemeinsamen Teils der MySQL-Konfiguration für alle Projektserver können Sie derselben Variablen auf anderen Hierarchieebenen spezielle Teile hinzufügen, die für diese Rolle Gewicht haben (in der Konfiguration für den Slave wird ein zusätzlicher Abschnitt angezeigt). </p><br><p>  Es stellt sich heraus, dass die Datei des spezifischen Knotens entlang des Pfads „ <strong><code>hieradata/nodes/%{::fqdn}</code></strong> “ die höchste Priorität hat.  Als nächstes kommt die Knotendatei, aber bereits auf Befehlsebene.  Unten ist der Block, der andere, allgemeinere Fakten beschreibt: </p><br><pre> <code class="hljs axapta"> - <span class="hljs-string"><span class="hljs-string">"virtual/%{::virtual}"</span></span> - <span class="hljs-string"><span class="hljs-string">"os/%{::operatingsystem}/%{::operatingsystemmajrelease}"</span></span> - <span class="hljs-string"><span class="hljs-string">"os/%{::operatingsystem}"</span></span> - users - <span class="hljs-keyword"><span class="hljs-keyword">common</span></span></code> </pre> <br><p>  Dementsprechend haben wir in der Datei <strong><code>common.yaml</code></strong> eine Konfiguration, die definitiv für <strong>alle</strong> Server gelten sollte. In der Datei <strong><code>users.yaml</code></strong> alle Benutzer in <strong><code>os/%{::operatingsystem}</code></strong> beschrieben (aber <strong><code>users.yaml</code></strong> werden nicht alle auf Servern erstellt). Allgemeine Konfiguration, typisch für Server mit einem bestimmten Betriebssystem (fact <code>::operatingsystem</code> ) und so weiter. </p><br><p>  Ich denke, wenn man diese Hierarchie betrachtet, wird alles klar.  Im Folgenden werde ich ein Beispiel für die Verwendung einer solchen Hierarchie betrachten.  Aber zuerst müssen Sie über Profile sprechen. </p><br><h3 id="profili">  Profile </h3><br><p>  Ein wichtiger Punkt bei der Konfiguration von Servern mithilfe von Modulen ist die Verwendung von Profilen.  Sie befinden sich auf der Pfadwebsite <strong><code>site/profiles</code></strong> und sind die Einstiegspunkte zu den Modulen.  Dank ihnen können Sie die hängenden Module auf dem Server genauer konfigurieren und die erforderlichen Ressourcen erstellen. </p><br><p>  Betrachten Sie ein einfaches Beispiel.  Es gibt ein <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Modul</a> , das Redis installiert und konfiguriert.  Und wir möchten auch den sysctl-Parameter <code>vm.overcommit_memory</code> beim Anschließen dieses Moduls auf 1 setzen, weil <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> .  Dann schreiben wir ein kleines Profil, das diese Funktionalität bietet: </p><br><pre> <code class="hljs lua"># standalone redis server class profiles::db::redis ( Hash $<span class="hljs-built_in"><span class="hljs-built_in">config</span></span> = {}, String $output_buffer_limit_slave = <span class="hljs-string"><span class="hljs-string">'256mb 64mb 60'</span></span>, ) { # https://redis.<span class="hljs-built_in"><span class="hljs-built_in">io</span></span>/topics/faq#background-saving-fails-with-a-fork-<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>-under-linux-even-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>-i-have-a-lot-of-free-ram sysctl { <span class="hljs-string"><span class="hljs-string">'vm.overcommit_memory'</span></span>: ensure =&gt; present, value =&gt; <span class="hljs-string"><span class="hljs-string">'1'</span></span>, } class { <span class="hljs-string"><span class="hljs-string">'::redis'</span></span>: * =&gt; $<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>, } }</code> </pre> <br><p>  Wie oben erwähnt, sind Profile ein Werkzeug, mit dem Sie das Verhalten des Moduls ändern / verbessern sowie die Anzahl der Konfigurationen in Hiera reduzieren können.  Wenn Sie Remote-Module verwenden, kann häufig das Problem auftreten, dass „genehmigte“ Module häufig nicht über die von Ihnen benötigte Funktionalität verfügen oder Fehler aufweisen.  Im Prinzip können Sie dieses Modul dann klonen und Funktionen korrigieren / hinzufügen.  Die richtige Entscheidung wäre jedoch, wenn möglich, ein gutes Profil zu erstellen, das das Modul so „vorbereiten“ kann, wie Sie es benötigen.  Im Folgenden finden Sie einige Beispiele für Profile, mit denen Sie besser verstehen können, warum sie benötigt werden. </p><br><h3 id="sokrytie-sekretov-v-hiera">  Geheimnisse in Hiera verstecken </h3><br><p>  Einer der wichtigen Vorteile von hiera gegenüber dem nackten Pappet ist seine Fähigkeit, vertrauliche Daten in Konfigurationsdateien in verschlüsselter Form im Repository zu speichern.  Ihre Passwörter sind sicher. </p><br><p>  Kurz gesagt, Sie verwenden den öffentlichen Schlüssel, um die benötigten Informationen zu verschlüsseln und mit einer solchen Zeile in die Hiera-Datei einzufügen.  Der private Teil des Schlüssels wird auf dem Pappet-Master gespeichert, sodass Sie diese Daten entschlüsseln können.  Weitere Details finden Sie auf der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Projektseite</a> . </p><br><p>  Auf dem Client (funktionierender Computer) wird das Tool einfach mithilfe von <strong><code>gem install hiera-eyaml</code></strong> .  Mit einem Befehl der Form <strong><code>eyaml encrypt --pkcs7-public-key=/path/to/public_key.pkcs7.pem -s 'hello'</code></strong> Sie Daten verschlüsseln und in eine Datei mit der Erweiterung eyaml oder einfach yaml einfügen, je nachdem, wie Sie konfigurieren, und dann wird das Pappet es herausfinden.  Sie erhalten so etwas wie: </p><br><pre> <code class="hljs ruby">roles::postrgresql::<span class="hljs-symbol"><span class="hljs-symbol">password:</span></span> <span class="hljs-string"><span class="hljs-string">'ENC[PKCS7,MIIBeQYJKoZIhvcNAQcDoIIBajCCAWYCAQAxggEhMIIBHQIBADAFMAACAQEwDQYJKoZIhvcNAQEBBQAEggEAbIz1ihQlThMWa9T+Lq194Y6QdElMD1XTev5y+VPSHtkPTu6Al6TJaSrXF+7phJIjue+NF4ZVtJCLkHxUR6nJJqks0fcGS1vF2+6mmM9cy69sIU1A3HqpOHZLuqHAc7jUqljYxpwWSIGOK6I2FygdAp5FfOTewqfcVVmXj97EJdcv3DKrbAlSrIMO2iZRYwQvyv+qnptnZ7pilR2veOCPW2UMm6zagDLutX9Ft5vERbdaiCiEfTOpVa9Qx0GqveNRVJLV/5lfcL5ajdNBJXkvKqDbx8d3ZBtEVAAqeKlw0LqzScgmCbWQx2kUzukX5LSxbTpT0Th984Vp1sl7iPk7UTA8BgkqhkiG9w0BBwEwHQYJYIZIAWUDBAEqBBCp5GcwidcEMA+0wjAMblkKgBCR/f9KGXUgLh3/Ok60OIT5]'</span></span></code> </pre> <br><p>  Oder eine mehrzeilige Zeichenfolge: </p><br><pre> <code class="hljs powershell">roles::postgresql::password: &gt; ENC[<span class="hljs-type"><span class="hljs-type">PKCS7</span></span>,<span class="hljs-type"><span class="hljs-type">MIIBeQYJKoZIhvcNAQcDoIIBajCCAWYCAQAxggEhMIIBHQIBADAFMAACAQEw</span></span> <span class="hljs-type"><span class="hljs-type">DQYJKoZIhvcNAQEBBQAEggEAbIz1ihQlThMWa9T</span></span>+<span class="hljs-type"><span class="hljs-type">Lq194Y6QdElMD1XTev5y</span></span> +<span class="hljs-type"><span class="hljs-type">VPSHtkPTu6Al6TJaSrXF</span></span>+<span class="hljs-number"><span class="hljs-number">7</span></span><span class="hljs-type"><span class="hljs-type">phJIjue</span></span>+<span class="hljs-type"><span class="hljs-type">NF4ZVtJCLkHxUR6nJJqks0fcGS1vF</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>+<span class="hljs-number"><span class="hljs-number">6</span></span><span class="hljs-type"><span class="hljs-type">mmM9cy69sIU1A3HqpOHZLuqHAc7jUqljYxpwWSIGOK6I2FygdAp5FfOTe</span></span> <span class="hljs-type"><span class="hljs-type">wqfcVVmXj97EJdcv3DKrbAlSrIMO2iZRYwQvyv</span></span>+<span class="hljs-type"><span class="hljs-type">qnptnZ7pilR2veOCPW2UM</span></span> <span class="hljs-type"><span class="hljs-type">m6zagDLutX9Ft5vERbdaiCiEfTOpVa9Qx0GqveNRVJLV</span></span>/<span class="hljs-number"><span class="hljs-number">5</span></span><span class="hljs-type"><span class="hljs-type">lfcL5ajdNBJXkv</span></span> <span class="hljs-type"><span class="hljs-type">KqDbx8d3ZBtEVAAqeKlw0LqzScgmCbWQx2kUzukX5LSxbTpT0Th984Vp1sl7</span></span> <span class="hljs-type"><span class="hljs-type">iPk7UTA8BgkqhkiG9w0BBwEwHQYJYIZIAWUDBAEqBBCp5GcwidcEMA</span></span>+<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-type"><span class="hljs-type">wjAM</span></span> <span class="hljs-type"><span class="hljs-type">blkKgBCR</span></span>/<span class="hljs-type"><span class="hljs-type">f9KGXUgLh3</span></span>/<span class="hljs-type"><span class="hljs-type">Ok60OIT5</span></span>]</code> </pre> <br><p>  Es scheint, dass wir mit der Vorbereitung fertig sind, jetzt können wir ein Beispiel betrachten. </p><br><h3 id="primer-na-palcah">  Finger Beispiel </h3><br><p>  <strong>Spoiler</strong> : Es <em>wird viel mehr Konfigurationen geben, sodass diejenigen, die sich für diesen Artikel von rein theoretischem Interesse interessieren, diesen Abschnitt überspringen und bis zum Ende gehen können.</em> </p><br><p>  Schauen wir uns nun ein Beispiel an, wie ein Server mithilfe von Hiera in Puppet4 konfiguriert wird.  Ich werde den Code nicht für alle Profile veröffentlichen, da sich der Beitrag sonst als ziemlich groß herausstellen wird.  Ich werde mich auf die Hierarchie und Konfiguration von Hiera konzentrieren. </p><br><p>  <strong>Die Aufgabe ist folgende:</strong> Wir müssen Folgendes bereitstellen: </p><br><ul><li>  Zwei identische Datenbankserver, auf denen postgresql bereitgestellt wird </li><li>  Zwei weitere Server - Frontend mit Nginx </li><li>  Fünfter und sechster Server - Python-Backends im Docker </li><li>  In der Entwicklungsumgebung ist bis auf einige Serverkonfigurationen alles gleich </li></ul><br><p>  Wir werden unsere Hierarchie der Reihe nach erstellen und mit der Projektdatei beginnen. </p><br><h4 id="proekt">  Projekt </h4><br><p>  Erstellen Sie die Projektdatei <strong><code>projects/kicker.yaml</code></strong> .  Wir fügen ein, was allen Servern gemeinsam ist: Wir benötigen einige Repositorys und Ordner für die Bereitstellung sowie den Bereitstellungsbenutzer selbst. </p><br><pre> <code class="hljs ruby">--- <span class="hljs-symbol"><span class="hljs-symbol">classes:</span></span> - apt::debian::semrush <span class="hljs-symbol"><span class="hljs-symbol">files:</span></span> <span class="hljs-string"><span class="hljs-string">"/srv/data"</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">ensure:</span></span> <span class="hljs-string"><span class="hljs-string">'directory'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">owner:</span></span> <span class="hljs-string"><span class="hljs-string">'deploy'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">group:</span></span> <span class="hljs-string"><span class="hljs-string">'www-data'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">mode:</span></span> <span class="hljs-string"><span class="hljs-string">'0755'</span></span> <span class="hljs-string"><span class="hljs-string">'/srv/data/shared_temp'</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">ensure:</span></span> <span class="hljs-string"><span class="hljs-string">'directory'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">owner:</span></span> <span class="hljs-string"><span class="hljs-string">'deploy'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">group:</span></span> <span class="hljs-string"><span class="hljs-string">'www-data'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">mode:</span></span> <span class="hljs-string"><span class="hljs-string">'0775'</span></span> user_management::<span class="hljs-symbol"><span class="hljs-symbol">present:</span></span> - deploy</code> </pre> <br><h4 id="rol-db">  Db Rolle </h4><br><p>  Erstellen Sie eine <strong><code>projects/kicker/db.yaml</code></strong> Datenbankserver <strong><code>projects/kicker/db.yaml</code></strong> .  Bisher müssen wir die Server nicht in Umgebungen unterteilen: </p><br><pre> <code class="hljs ruby">--- <span class="hljs-symbol"><span class="hljs-symbol">classes:</span></span> - profiles::db::postgresql profiles::db::postgresql::<span class="hljs-symbol"><span class="hljs-symbol">globals:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">manage_package_repo:</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-symbol"><span class="hljs-symbol">version:</span></span> <span class="hljs-string"><span class="hljs-string">'10'</span></span> profiles::db::postgresql::<span class="hljs-symbol"><span class="hljs-symbol">db_configs:</span></span> <span class="hljs-string"><span class="hljs-string">'listen_addresses'</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">value:</span></span> <span class="hljs-string"><span class="hljs-string">'*'</span></span> profiles::db::postgresql::<span class="hljs-symbol"><span class="hljs-symbol">databases:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">kicker:</span></span> {} profiles::db::postgresql::<span class="hljs-symbol"><span class="hljs-symbol">hba_rules:</span></span> <span class="hljs-string"><span class="hljs-string">'local connect to kicker'</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">type:</span></span> <span class="hljs-string"><span class="hljs-string">'local'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">database:</span></span> <span class="hljs-string"><span class="hljs-string">'kicker'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">user:</span></span> <span class="hljs-string"><span class="hljs-string">'kicker'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">auth_method:</span></span> <span class="hljs-string"><span class="hljs-string">'md5'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">order:</span></span> <span class="hljs-string"><span class="hljs-string">'001'</span></span> <span class="hljs-string"><span class="hljs-string">'allow connect from 192.168.1.100'</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">type:</span></span> <span class="hljs-string"><span class="hljs-string">'host'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">database:</span></span> <span class="hljs-string"><span class="hljs-string">'kicker'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">user:</span></span> <span class="hljs-string"><span class="hljs-string">'kicker'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">auth_method:</span></span> <span class="hljs-string"><span class="hljs-string">'md5'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">address:</span></span> <span class="hljs-string"><span class="hljs-string">'192.168.1.100/32'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">order:</span></span> <span class="hljs-string"><span class="hljs-string">'002'</span></span></code> </pre> <br><p>  Hier verbinden wir ein Profil, das für den allgemeinen Gebrauch von allen geschrieben wurde, die Postgres auf ihrem Server installieren möchten.  Das Profil ist konfigurierbar und ermöglicht es Ihnen, das Modul flexibel zu konfigurieren, bevor Sie es anwenden. </p><br><p>  Für die Neugierigsten unter dem Katzencode für dieses Profil: </p><br><div class="spoiler">  <b class="spoiler_title">Profil :: db :: postgresql</b> <div class="spoiler_text"><pre> <code class="hljs mel">class profiles::db::postgresql ( Hash $globals = {}, Hash $params = {}, Hash $recovery = {}, Hash[String, Hash[String, Variant[String, Boolean, Integer]]] $roles = {}, Hash[String, Hash[String, Variant[String, Boolean]]] $db_configs = {}, Hash[String, Hash[String, Variant[String, Boolean]]] $databases = {}, Hash[String, String] $db_grants = {}, Hash[String, Hash[String, String]] $extensions = {}, Hash[String, String] $table_grants = {}, Hash[String, Hash[String, String]] $hba_rules = {}, Hash[String, String] $indent_rules = {}, Optional[String] $role = undef, # <span class="hljs-string"><span class="hljs-string">'master'</span></span>, <span class="hljs-string"><span class="hljs-string">'slave'</span></span> Optional[String] $master_host = undef, Optional[String] $replication_password = undef, Integer $master_port = <span class="hljs-number"><span class="hljs-number">5432</span></span>, String $replication_user = <span class="hljs-string"><span class="hljs-string">'repl'</span></span>, String $trigger_file = <span class="hljs-string"><span class="hljs-string">'/tmp/pg_trigger.file'</span></span>, ){ <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> $role { <span class="hljs-string"><span class="hljs-string">'slave'</span></span>: { $_params = { manage_recovery_conf =&gt; true, } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> $globals[<span class="hljs-string"><span class="hljs-string">'datadir'</span></span>] { <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> { <span class="hljs-string"><span class="hljs-string">"${globals['datadir']}/recovery.done"</span></span>: ensure =&gt; absent, } } $_recovery = { <span class="hljs-string"><span class="hljs-string">'recovery config'</span></span> =&gt; { standby_mode =&gt; <span class="hljs-string"><span class="hljs-string">'on'</span></span>, primary_conninfo =&gt; <span class="hljs-string"><span class="hljs-string">"host=${master_host} port=${master_port} user=${replication_user} password=${replication_password}"</span></span>, trigger_file =&gt; $trigger_file, } } $_conf = { <span class="hljs-string"><span class="hljs-string">'hot_standby'</span></span> =&gt; { value =&gt; <span class="hljs-string"><span class="hljs-string">'on'</span></span>, }, } <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> { $trigger_file: ensure =&gt; absent, } } <span class="hljs-string"><span class="hljs-string">'master'</span></span>: { $_conf = { <span class="hljs-string"><span class="hljs-string">'wal_level'</span></span> =&gt; { value =&gt; <span class="hljs-string"><span class="hljs-string">'replica'</span></span>, }, <span class="hljs-string"><span class="hljs-string">'max_wal_senders'</span></span> =&gt; { value =&gt; <span class="hljs-number"><span class="hljs-number">5</span></span>, }, <span class="hljs-string"><span class="hljs-string">'wal_keep_segments'</span></span> =&gt; { value =&gt; <span class="hljs-number"><span class="hljs-number">32</span></span>, }, } <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> { $trigger_file: ensure =&gt; present, } } <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: { $_params = {} $_recovery = {} $_conf = {} } } class { <span class="hljs-string"><span class="hljs-string">'::postgresql::globals'</span></span>: * =&gt; $globals, } class { <span class="hljs-string"><span class="hljs-string">'::postgresql::server'</span></span>: * =&gt; deep_merge($_params, $params), } create_resources(<span class="hljs-string"><span class="hljs-string">'::postgresql::server::config_entry'</span></span>, deep_merge($_conf, $db_configs)) create_resources(<span class="hljs-string"><span class="hljs-string">'::postgresql::server::role'</span></span>, $roles) create_resources(<span class="hljs-string"><span class="hljs-string">'::postgresql::server::database'</span></span>, $databases) create_resources(<span class="hljs-string"><span class="hljs-string">'::postgresql::server::database_grant'</span></span>, $db_grants) create_resources(<span class="hljs-string"><span class="hljs-string">'::postgresql::server::extension'</span></span>, $extensions) create_resources(<span class="hljs-string"><span class="hljs-string">'::postgresql::server::table_grant'</span></span>, $table_grants) create_resources(<span class="hljs-string"><span class="hljs-string">'::postgresql::server::pg_hba_rule'</span></span>, $hba_rules) create_resources(<span class="hljs-string"><span class="hljs-string">'::postgresql::server::pg_indent_rule'</span></span>, $indent_rules) create_resources(<span class="hljs-string"><span class="hljs-string">'::postgresql::server::recovery'</span></span>, deep_merge($_recovery, $recovery)) }</code> </pre> </div></div><br><p>  Daher installieren wir <code>Postgresql 10</code> einen Schlag, konfigurieren die Konfiguration ( <code>listen</code> ), erstellen die <code>kicker</code> Datenbank und schreiben zwei Regeln für den Zugriff auf diese Datenbank in <code>pg_hba.conf</code> .  Cool! </p><br><h4 id="rol-frontend">  Frontend-Rolle </h4><br><p>  Wir nehmen das <code>frontend</code> .  Erstellen Sie die Datei <strong><code>projects/kicker/frontend.yaml</code></strong> mit den folgenden Inhalten: </p><br><pre> <code class="hljs ruby">--- <span class="hljs-symbol"><span class="hljs-symbol">classes:</span></span> - profiles::webserver::nginx profiles::webserver::nginx::<span class="hljs-symbol"><span class="hljs-symbol">servers:</span></span> <span class="hljs-string"><span class="hljs-string">'kicker.semrush.com'</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">use_default_location:</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span> <span class="hljs-symbol"><span class="hljs-symbol">listen_port:</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-symbol"><span class="hljs-symbol">server_name:</span></span> - <span class="hljs-string"><span class="hljs-string">'kicker.semrush.com'</span></span> profiles::webserver::nginx::<span class="hljs-symbol"><span class="hljs-symbol">locations:</span></span> <span class="hljs-string"><span class="hljs-string">'kicker-root'</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">location:</span></span> <span class="hljs-string"><span class="hljs-string">'/'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">server:</span></span> <span class="hljs-string"><span class="hljs-string">'kicker.semrush.com'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">proxy:</span></span> <span class="hljs-string"><span class="hljs-string">'http://kicker-backend.semrush.com:8080'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">proxy_set_header:</span></span> - <span class="hljs-string"><span class="hljs-string">'X-Real-IP $remote_addr'</span></span> - <span class="hljs-string"><span class="hljs-string">'X-Forwarded-for $remote_addr'</span></span> - <span class="hljs-string"><span class="hljs-string">'Host kicker.semrush.com'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">location_cfg_append:</span></span> <span class="hljs-string"><span class="hljs-string">'proxy_next_upstream'</span></span>: <span class="hljs-string"><span class="hljs-string">'error timeout invalid_header http_500 http_502 http_503 http_504'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">proxy_connect_timeout:</span></span> <span class="hljs-string"><span class="hljs-string">'5'</span></span></code> </pre> <br><p>  Hier ist alles einfach.  Wir verbinden das <strong><code>profiles::webserver::nginx</code></strong> , das den Eintrag in das nginx-Modul vorbereitet, und definieren auch die Variablen, insbesondere den <code>server</code> und den <code>location</code> für diese Site. </p><br><p>  Ein aufmerksamer Leser wird feststellen, dass es angemessener wäre, die Beschreibung der Site höher in der Hierarchie zu platzieren, da wir weiterhin eine Entwicklungsumgebung haben und andere Variablen ( <code>server_name</code> , <code>proxy</code> ) dort verwendet werden, dies ist jedoch nicht zu wichtig.  Wenn wir die Rolle auf diese Weise beschreiben, können wir sehen, wie diese Variablen nur durch Hierarchie neu definiert werden. </p><br><h4 id="rol-docker">  Docker-Rolle </h4><br><p>  Die Rolle von <code>docker</code> <strong><code>projects/kicker/docker.yaml</code></strong> : </p><br><pre> <code class="hljs ruby">--- <span class="hljs-symbol"><span class="hljs-symbol">classes:</span></span> - profiles::docker profiles::docker::<span class="hljs-symbol"><span class="hljs-symbol">params:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">version:</span></span> <span class="hljs-string"><span class="hljs-string">'17.05.0~ce-0~debian-stretch'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">packages:</span></span> <span class="hljs-string"><span class="hljs-string">'python3-pip'</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">provider:</span></span> apt <span class="hljs-string"><span class="hljs-string">'Fabric3'</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">provider:</span></span> pip3 <span class="hljs-symbol"><span class="hljs-symbol">ensure:</span></span> <span class="hljs-number"><span class="hljs-number">1.12</span></span>.post1 user_management::<span class="hljs-symbol"><span class="hljs-symbol">users:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">deploy:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">groups:</span></span> - docker</code> </pre> <br><p>  Das <strong><code>profiles/docker.pp</code></strong> sehr einfach und elegant.  Ich werde seinen Code geben: </p><br><div class="spoiler">  <b class="spoiler_title">Profil :: Docker</b> <div class="spoiler_text"><pre> <code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">profiles</span></span></span><span class="hljs-class">:</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">:docker </span></span></span></span>( Hash $params = {}, <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> $install_kernel = <span class="hljs-literal"><span class="hljs-literal">false</span></span>, ){ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-string"><span class="hljs-string">'docker'</span></span>: * =&gt; $params, } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($install_kernel) { include profiles::docker::kernel } }</code> </pre> </div></div><br><p>  Alles ist fertig.  Dies reicht bereits aus, um das benötigte Produkt auf vielen Servern bereitzustellen und ihnen einfach ein bestimmtes Projekt und eine bestimmte Rolle zuzuweisen (z. B. die Datei im gewünschten Format im Verzeichnis facts.d abzulegen, dessen Speicherort von der Installationsmethode von Puppet abhängt). </p><br><p>  Jetzt haben wir folgende Dateistruktur: </p><br><pre> <code class="bash hljs">. ├── kicker │ ├── db.yaml │ ├── docker.yaml │ └── frontend.yaml └── kicker.yaml 1 directory, 4 files</code> </pre> <br><p>  Jetzt beschäftigen wir uns mit Umgebungen und der Definition einer Konfiguration, die für eine Rolle an einem bestimmten Standort eindeutig ist. </p><br><h4 id="okruzheniya-i-override">  Umgebung und Override </h4><br><p>  Lassen Sie uns die allgemeine Konfiguration für alle Verkäufe erstellen.  Die Datei <strong><code>projects/kicker/tiers/prod.yaml</code></strong> enthält einen Hinweis darauf, dass eine Klasse mit einer Firewall mit dieser Umgebung verbunden werden muss ( <strong><code>projects/kicker/tiers/prod.yaml</code></strong> prod) sowie eine bestimmte Klasse, die ein höheres Maß an Sicherheit bietet: </p><br><pre> <code class="hljs pgsql"><span class="hljs-comment"><span class="hljs-comment">--- classes: - semrush_firewall - strict_security_level</span></span></code> </pre> <br><p>  Wenn wir in einer Entwicklungsumgebung etwas Bestimmtes beschreiben müssen, wird dieselbe Datei erstellt und die erforderliche Konfiguration eingegeben. </p><br><p>  Als Nächstes müssen Sie die Variablen für die Nginx-Konfiguration der <code>frontend</code> Rolle in der Entwicklungsumgebung noch neu definieren.  Dazu müssen Sie die Datei <strong><code>projects/kicker/tiers/dev/frontend.yaml</code></strong> erstellen.  Achten Sie auf eine neue Hierarchieebene. </p><br><pre> <code class="hljs ruby">--- profiles::webserver::nginx::<span class="hljs-symbol"><span class="hljs-symbol">servers:</span></span> <span class="hljs-string"><span class="hljs-string">'kicker-dev.semrush.com'</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">use_default_location:</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span> <span class="hljs-symbol"><span class="hljs-symbol">listen_port:</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-symbol"><span class="hljs-symbol">server_name:</span></span> - <span class="hljs-string"><span class="hljs-string">'kicker-dev.semrush.com'</span></span> profiles::webserver::nginx::<span class="hljs-symbol"><span class="hljs-symbol">locations:</span></span> <span class="hljs-string"><span class="hljs-string">'kicker-root'</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">location:</span></span> <span class="hljs-string"><span class="hljs-string">'/'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">server:</span></span> <span class="hljs-string"><span class="hljs-string">'kicker-dev.semrush.com'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">proxy:</span></span> <span class="hljs-string"><span class="hljs-string">'http://kicker-backend-dev.semrush.com:8080'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">proxy_set_header:</span></span> - <span class="hljs-string"><span class="hljs-string">'X-Real-IP $remote_addr'</span></span> - <span class="hljs-string"><span class="hljs-string">'X-Forwarded-for $remote_addr'</span></span> - <span class="hljs-string"><span class="hljs-string">'Host kicker-dev.semrush.com'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">location_cfg_append:</span></span> <span class="hljs-string"><span class="hljs-string">'proxy_next_upstream'</span></span>: <span class="hljs-string"><span class="hljs-string">'error timeout invalid_header http_500 http_502 http_503 http_504'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">proxy_connect_timeout:</span></span> <span class="hljs-string"><span class="hljs-string">'5'</span></span></code> </pre> <br><p>  Sie müssen keine Klasse mehr angeben, sie wird von früheren Hierarchieebenen geerbt.  Hier haben wir <code>proxy_pass</code> und <code>proxy_pass</code> geändert.  Ein Server mit den Fakten role = frontend und tier = dev findet zuerst die Datei <strong><code>projects/kicker/frontend.yaml</code></strong> für sich selbst. Anschließend werden die Variablen aus dieser Datei von der Datei <strong><code>projects/kicker/tiers/dev/frontend.yaml</code></strong> mit höherer Priorität überschrieben . </p><br><h4 id="sokrytie-parolya-dlya-postgresql">  Passwort für PostgreSQL versteckt </h4><br><p>  Und so haben wir den letzten Punkt auf der Tagesordnung - Passwörter für PostgreSQL festlegen. </p><br><p>  Passwörter sollten in Umgebungen variieren.  Wir werden eyaml verwenden, um Passwörter sicher zu speichern.  Passwörter erstellen: </p><br><pre> <code class="bash hljs">eyaml encrypt -s <span class="hljs-string"><span class="hljs-string">'verysecretpassword'</span></span> eyaml encrypt -s <span class="hljs-string"><span class="hljs-string">'testpassword'</span></span></code> </pre> <br><p>  Wir fügen die resultierenden Zeilen in die Dateien <code>**projects/kicker/tiers/prod/db.yaml**</code> und <code>**projects/kicker/tiers/dev/db.yaml**</code> (oder Sie können die eyaml-Erweiterung verwenden, dies ist anpassbar).  Hier ist ein Beispiel: </p><br><pre> <code class="hljs ruby">--- profiles::db::postgresql::<span class="hljs-symbol"><span class="hljs-symbol">roles:</span></span> <span class="hljs-string"><span class="hljs-string">'kicker'</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">password_hash:</span></span> &gt; <span class="hljs-string"><span class="hljs-string">'ENC[PKCS7,MIIBeQYJKoZIhvcNAQcDoIIBajCCAWYCAQAxggEhMIIBHQIBADAFMAACAQEwDQYJKoZIhvcNAQEBBQAEggEAsdpb2P0axUJzyWr2duRKAjh0WooGYUmoQ5gw0nO9Ym5ftv6uZXv25DRMKh7vsbzrrOR5/lLesx/pAVmcs2qbhd/y0Vr1oc2ohHlZBBKtCSEYwem5VN+kTMhWPvlt93x/S9ERoBp8LrrsIvicSYZByNfpS2DXCFbogSXCfEPxTTmCOtlOnxdjidIc9Q1vfAXv7FRQanYIspr2UytScm56H/ueeAc/8RYK51/nXDMtdPOiAP5VARioUKyTDSk8FqNvdUZRqA3cl+hA+xD5PiBHn5T09pnH8HyE/39q09gE0pXRe5+mOnU/4qfqFPc/EvAgAq5mVawlCR6c/cCKln5wJTA8BgkqhkiG9w0BBwEwHQYJYIZIAWUDBAEqBBDNKijGHBLPCth0sfwAjfl/gBAaPsfvzZQ/Umgjy1n+im0s]'</span></span></code> </pre> <br><p>  Als nächstes wird das Passwort für die <code>kicker</code> Rolle kommen, entschlüsselt und auf den Datenbankserver in PostgreSQL angewendet. </p><br><p>  Das ist in der Tat alles.  Ja, das Beispiel erwies sich als massiv, aber ich hoffe, es funktioniert, ohne Fragen zu stellen, klar und nützlich.  Die resultierende Hierarchie in Hiera lautet wie folgt: </p><br><pre> <code class="bash hljs">. ├── db.yaml ├── docker.yaml ├── frontend.yaml └── tiers ├── dev │ ├── db.yaml │ └── frontend.yaml ├── prod │ └── db.yaml └── prod.yaml 3 directories, 7 files</code> </pre> <br><p>  Sie können diese Dateien live verfolgen, indem Sie ein speziell erstelltes <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Repository</a> klonen </p><br><h3 id="zaklyuchenie">  Fazit </h3><br><p>  Puppe ist gut und einfach mit Hiera zu verwenden.  Ich würde es nicht als ideales Konfigurationswerkzeug in der modernen Welt bezeichnen, überhaupt nicht, aber es verdient Aufmerksamkeit.  Er bewältigt einige Aufgaben sehr gut, und seine „Philosophie“, einen ständig identischen Zustand von Ressourcen und Konfiguration beizubehalten, kann eine wichtige Rolle bei der Gewährleistung der Sicherheit und Einheitlichkeit von Konfigurationen spielen. </p><br><p>  Die moderne Welt entwickelt sich allmählich zu Synergien und entwickelt sich weiter.  Nur wenige Leute verwenden nur noch ein Konfigurationssystem, oft gibt es im Arsenal der Entwickler und Administratoren mehrere Systeme gleichzeitig.  Und das ist gut so, denn es gibt eine große Auswahl.  Die Hauptsache ist, dass alles logisch und verständlich sein sollte, wie und wo es konfiguriert werden kann. </p><br><p>  Daher ist es unser Ziel als Administratoren, nichts selbst zu konfigurieren.  All dies sollte idealerweise von den Teams selbst durchgeführt werden.  Und wir müssen ihnen ein Werkzeug oder Produkt geben, mit dem wir dies sicher, einfach und vor allem mit einem genauen Ergebnis tun können.  Nun, und helfen Sie bei der Lösung architektonischer und schwerwiegenderer Probleme als "Sie müssen PostgreSQL auf dem Server installieren und einen Benutzer erstellen."  Camon, 2018 ist auf dem Hof! <del>  Also werfen Sie Marionette und Ansible und bewegen Sie sich in die Zukunft ohne Server. </del></p><br><p>  Mit der Entwicklung von Cloud-, Containerisierungs- und Container-Orchestrierungssystemen treten Konfigurationsmanagementsysteme für Benutzer und Kunden langsam in den Hintergrund.  Sie können auch einen ausfallsicheren Cluster von Containern in der Cloud erstellen und Ihre Anwendungen in Containern mit Auto-Skelling, Backup, Replikation, Auto-Discovery usw. aufbewahren, ohne eine einzige Zeile für Ansible, Puppet, Chef usw. zu schreiben.  Sie müssen sich um nichts kümmern (na ja, fast).  Auf der anderen Seite gibt es aufgrund von Wolken weniger Eisenserver.  Sie müssen sie nur nicht mehr konfigurieren. Diese Aktion liegt in der Verantwortung des Cloud-Anbieters.  Es ist jedoch unwahrscheinlich, dass sie dieselben Systeme wie gewöhnliche Sterbliche verwenden. </p><br><h4 id="credits">  Credits </h4><br><p>  Vielen Dank: </p><br><ul><li>  Dmitry Tupitsin, Dmitry Loginov, Stepan Fedorov und das gesamte Team von Systemadministratoren für ihre Hilfe bei der Vorbereitung dieses Artikels </li><li>  Vladimir Legkostupov für das Bild </li><li>  Yana Tabakova, die all dies organisiert und dabei hilft, alle Phasen vor der Veröffentlichung zu durchlaufen </li><li>  Nikita Zakharov für Unterstützung bei Lizenzfragen </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de412587/">https://habr.com/ru/post/de412587/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de412573/index.html">Was mit Geektimes los ist, kehre nach Habr zurück</a></li>
<li><a href="../de412575/index.html">Popmusik wird von Jahr zu Jahr eintöniger, weil die gleichen Leute sie komponieren</a></li>
<li><a href="../de412579/index.html">Marvel: Infinity War oder Wie Sie in wenigen Minuten Daten für Ihr Projekt sammeln</a></li>
<li><a href="../de412581/index.html">Von der Steinzeit bis zum Zweiten Weltkrieg: Wie Roboter zur Erforschung historischer Artefakte eingesetzt werden</a></li>
<li><a href="../de412583/index.html">Wir zerlegen das Redmond G200S-Kesselprotokoll und verbinden es mit dem HomeAssistant</a></li>
<li><a href="../de412589/index.html">25 unterhaltsame Android-Bibliotheken. Frühling 2018</a></li>
<li><a href="../de412591/index.html">Jetpack bauen: Der 29. Mai ist Wendell Moores Gedenktag</a></li>
<li><a href="../de412593/index.html">Neue Produkte, Plattformen und All-as-a-Service: HPE-Webinare</a></li>
<li><a href="../de412595/index.html">Bericht des Club of Rome 2018, Kapitel 1.1.2: „Finanzierung“</a></li>
<li><a href="../de412597/index.html">Jeff Bezos wird eine Kolonie auf der Oberfläche des Mondes bauen</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>