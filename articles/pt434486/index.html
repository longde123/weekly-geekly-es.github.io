<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üîå üë®üèæ‚Äç‚öñÔ∏è ‚úãüèæ Cart√µes de fidelidade. API do Google Pay para passes no ASP.NET ‚û∞ üìµ üõÇ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Os aplicativos de armazenamento de cart√µes banc√°rios entraram rapidamente em nossas vidas gra√ßas √† Apple Wallet e ao Google Pay. As duas plataformas, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Cart√µes de fidelidade. API do Google Pay para passes no ASP.NET</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/434486/"><p>  Os aplicativos de armazenamento de cart√µes banc√°rios entraram rapidamente em nossas vidas gra√ßas √† Apple Wallet e ao Google Pay.  As duas plataformas, al√©m do setor banc√°rio, tamb√©m permitem trabalhar com outros tipos de cart√µes - cart√µes de fidelidade, cart√µes-presente, ingressos para eventos, cart√µes de embarque, etc. <br></p><br><p><img src="https://habrastorage.org/webt/ga/ng/rq/gangrq7tlqwob2cmgxa1dydoasu.png"><br></p><br><p>  Enquanto trabalhava para uma empresa que atende uma rede de varejo bastante grande, tive que integrar os cart√µes de fidelidade dessa rede no Apple Wallet e no Google Pay.  E se voc√™ tivesse que mexer na Apple Wallet apenas porque a camada de integra√ß√£o √© bastante multifuncional, com o Google Pay a maior parte do esfor√ßo e as c√©lulas nervosas foram gastas tentando descobrir a documenta√ß√£o, encontrar as ferramentas certas e desenvolver a primeira prova de conceito.  Embora, em geral, o resto do trabalho tenha sido muito mais r√°pido do que para a Apple Wallet, passei um dia descobrindo como iniciar o servi√ßo, por isso n√£o me importaria se algu√©m escrevesse um artigo semelhante antes de mim. <br><a name="habracut"></a><br></p><h2>  1. Material </h2><br>  Os cart√µes de fidelidade s√£o representados usando duas entidades - Classe de fidelidade e Objeto de fidelidade. <br><br><ul><li>  <i>A classe de fidelidade</i> √© um tipo de modelo para todos os cart√µes de fidelidade.  Ele cont√©m campos comuns a todos os mapas, como cor da fonte, links para recursos de √≠cones, planos de fundo, campos de texto, etc., uma descri√ß√£o completa pode ser encontrada aqui: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Loyaltyclass</a> <br></li><li>  <i>Objeto de lealdade</i> - uma inst√¢ncia do LoyaltyClass.  Ele tamb√©m cont√©m os dados de um cart√£o espec√≠fico de um determinado cliente - n√∫mero do cart√£o, nome, campos de texto adicionais.  Descri√ß√£o aqui: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Loyaltyobject</a> <br></li></ul><br>  Para receber um cart√£o, o usu√°rio deve seguir o link de formato <br>  <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">www.android.com/payapp/savetoandroidpay</a> <b>/ {JWT}</b></i> , em que JWT √© um token que cont√©m JSON com dados LoyaltyClass.  Por√©m, como o tamanho do URL tem limita√ß√µes, √© recomend√°vel que voc√™ crie primeiro uma Classe de lealdade se sua estrutura contiver muitos caracteres. <br><br><p>  Se voc√™ precisar atualizar o mapa devido a uma altera√ß√£o no modelo, nos estilos, na necessidade de adicionar ou alterar os campos de texto, fa√ßa isso usando a API.  S√≥ √© necess√°rio atender a uma solicita√ß√£o POST com a nova vers√£o do mapa. Os servi√ßos do Google sincronizam todos os aplicativos de usu√°rios que possuem esse mapa. <br></p><br><h2>  2. Ferramentas e documenta√ß√£o </h2><br><p>  O problema era que todos os exemplos na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documenta√ß√£o da API do Google Pay for Passes</a> eram exclusivamente para Java, PHP e Python, e a pr√≥pria documenta√ß√£o recomendava fortemente "usar bibliotecas de clientes para simplificar o processo" de trabalhar com a API. <br></p><br><p>  Seguindo esse conselho, fui feliz para a pepita, mas a biblioteca do Google Pay n√£o estava l√°.  Glory to Brin, a primeira linha do Google para ‚Äúgoogle pay for passes dotnet‚Äù retornou a p√°gina de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">bibliotecas de utilit√°rios da API</a> do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Google Pay for Passes</a> , que encontrou o que eu precisava, embora no formato de arquivo ZIP, no qual havia um projeto .net com uma classe gerada que √© um wrapper para a <a href="">biblioteca</a> do Google Pay API - API do <a href="">Google Pay para Passes Client</a> . <br></p><br><p>  A julgar pela presen√ßa do arquivo <i>Google.Apis.Walletobjects.v1.1.9.2.00.nuspec</i> no projeto, a implanta√ß√£o do pacote nuget ainda fazia parte dos planos da equipe do Google.  Depois de abrir esse arquivo em busca de documenta√ß√£o, n√£o encontrei nada concreto, e alguns links que estavam na se√ß√£o de descri√ß√£o foram enviados para p√°ginas inexistentes. <br><br></p><h2>  3. Obtendo o token de acesso </h2><br><p>  Para come√ßar a trabalhar diretamente com a API do Google Pay for Passes, voc√™ precisa obter um token de acesso, para isso: <br><br></p><ol><li>  Tenha uma conta do comerciante do Google, que voc√™ pode obter <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> <br></li><li>  Crie uma conta de servi√ßo, obtenha um arquivo com credenciais para ela - um documento json com detalhes da conta de servi√ßo, incluindo identificador, email, chave privada etc.  Como a documenta√ß√£o recomenda, voc√™ precisa armazenar este arquivo em um local seguro. <br></li><li>  Vincular conta de comerciante e conta de servi√ßo no Google Merchant Center <br></li></ol><br>  Usando esse arquivo, voc√™ pode fazer login usando a biblioteca <i>Google.Apis.Auth.OAuth2</i> : <br><br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">await</span></span></span><span class="hljs-function"> Task&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetOAuthToken</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> {         <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> serviceAccountFile = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty;         serviceAccountFile = ConfigurationManager.AppSettings[<span class="hljs-string"><span class="hljs-string">"GooglePayServiceAccountConfigPath"</span></span>];        <span class="hljs-comment"><span class="hljs-comment">/*              Credential, GoogleCredential              Service Account,   ,      scopes API,             */</span></span>         <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> credential = GoogleCredential.FromFile(serviceAccountFile)                            .CreateScoped(WalletobjectsService.Scope.WalletObjectIssuer);        <span class="hljs-comment"><span class="hljs-comment">/*        Access token        ,   GetAccessTokenForRequestAsync         ,               */</span></span>         <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> token = <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> credential.UnderlyingCredential.GetAccessTokenForRequestAsync();         <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> token; }</code> </pre> <br><h2>  4. Crie um mapa </h2><br><p>  Para criar um cart√£o de fidelidade, voc√™ deve primeiro criar uma classe de fidelidade.  A classe de lealdade pode ser criada usando a API e a interface da web do Google Merchant Center.  Deve-se prestar aten√ß√£o ao nome da turma, pois esse nome deve ser exclusivo na infraestrutura do Google Pay. <br><br>  Depois de criar a classe de lealdade, voc√™ pode criar o objeto de lealdade.  Para fazer isso, j√° precisaremos da biblioteca que adicionamos ao projeto anteriormente: crie um objeto de solicita√ß√£o, especifique o token OAuth, transfira o objeto LoyaltyObject criado e execute a solicita√ß√£o: <br><br></p><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GooglePayApiService</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-comment"><span class="hljs-comment">// ,    Merchant Account IssuerId = ConfigurationManager.AppSettings["GooglePayIssuerId"]; _wobService = new WalletobjectsService(); } private async Task&lt;LoyaltyObject&gt; ConvertLoyaltyObjectFromTemplate(GooglePayPassTemplate template) { string id = $"{IssuerId}.{template.SerialNumber}"; string loyaltyClassName = ConfigurationManager.AppSettings["GooglePayStoreCardClassName"];     var loyaltyClass = await GetLoyaltyClass(loyaltyClassName); var result =  new LoyaltyObject { Id = id, AccountName = template.AccountName,          Barcode = new Barcode          {          AlternateText = template.BarcodeText,               Value = template.SerialNumber,               Type = "pdf417"          },          Kind = "walletObject#loyaltyObject",          ClassId = loyaltyClass.Id,          ClassReference = loyaltyClass,          State = "active"     };     return result; } private async Task&lt;LoyaltyObject&gt; CreateLoyaltyObject(LoyaltyObject loyaltyObject) { var saveRequest = _wobService.Loyaltyobject.Insert(loyaltyObject); saveRequest.OauthToken = await GetOAuthToken(); var savedObject = await saveRequest.ExecuteAsync(); return savedObject; }</span></span></code> </pre><br>  <i>GooglePayPassTemplate</i> neste exemplo √© um DTO que armazena um modelo de mapa para um usu√°rio, gerado por um servi√ßo desenvolvido separado. <br><br><h2>  5. Atualiza√ß√£o do mapa </h2><br><p>  Aqui, o princ√≠pio √© o mesmo que ao criar: geramos uma solicita√ß√£o, transferimos o objeto LoyaltyObject atualizado, executamos: <br><br></p><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;LoyaltyObject&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateLoyaltyObject</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">LoyaltyObject loyaltyObject</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> updateRequest = _wobService.Loyaltyobject.Update(loyaltyObject, loyaltyObject.Id);           updateRequest.OauthToken = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> GetOAuthToken(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> savedObject = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> updateRequest.ExecuteAsync(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> savedObject; }</code> </pre> <br><p>  Depois de concluir a solicita√ß√£o, o cart√£o nos aplicativos dos usu√°rios que o instalam ser√° atualizado ap√≥s alguns segundos, se o dispositivo estiver na rede e tiver uma conex√£o com a Internet. </p><br><br><h2>  6. gera√ß√£o JWT </h2><br><p>  Para instalar o cart√£o, voc√™ deve redirecionar o usu√°rio para o link <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">www.android.com/payapp/savetoandroidpay</a> <b>/ {JWT}</b> .  Uma descri√ß√£o da estrutura do token pode ser encontrada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">neste link</a> . <br></p><br><p>  O token √© assinado pelo RSA-SHA256 com uma assinatura que pode ser gerada usando o mesmo arquivo com credenciais da Conta de Servi√ßo: <br><br></p><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">JwtHelper</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateJwtForLoyaltyObject</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">LoyaltyObject loyaltyObject</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">/*       credential   ,         */</span></span> ServiceAccountCredential credential; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> now = DateTime.UtcNow; DateTime unixEpoch = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTime(<span class="hljs-number"><span class="hljs-number">1970</span></span>, <span class="hljs-number"><span class="hljs-number">01</span></span>, <span class="hljs-number"><span class="hljs-number">01</span></span>); <span class="hljs-comment"><span class="hljs-comment">// 1970-01-01 00:00:00 UTC var secondsSinceEpoch = (int)Math.Round((now - unixEpoch).TotalSeconds); string serviceAccountFile = serviceAccountFile = ConfigurationManager.AppSettings["GooglePayServiceAccountConfigPath"]; using (var fs = new FileStream(serviceAccountFile, FileMode.Open, FileAccess.Read, FileShare.Read)) { credential = ServiceAccountCredential.FromServiceAccountData(fs); } /*    JwtPayload,     payload-a  JWT */ var jwtPayload = new JwtPayload { iat = secondsSinceEpoch, iss = credential.Id, payload = new JwtInternalPayload { loyaltyObjects = new[] { new LoyaltyObjectPayload { id = loyaltyObject.Id } } } }; string header = @"{""alg"":""RS256"",""typ"":""JWT""}"; string payload = JsonConverter.SerializeObject(jwtPayload); string base64Header = EscapedBase64(Convert.ToBase64String(Encoding.UTF8.GetBytes(header))); string base64Payload = EscapedBase64(Convert.ToBase64String(Encoding.UTF8.GetBytes(payload))); //        Signature string signature = EscapedBase64(credential.CreateSignature( Encoding.UTF8.GetBytes($"{base64Header}.{base64Payload}") )); var token = $"{base64Header}.{base64Payload}.{signature}"; return token; } private static string EscapedBase64(string base64) { return base64.Replace('+', '-') .Replace('/', '_') .Replace("=", ""); } }</span></span></code> </pre><br><h2>  Conclus√£o </h2><br><p>  Neste artigo, abordamos o b√°sico sobre como trabalhar com a API do Google Pay for Passes: configurar contas, conectar-se √† API, criar a classe de lealdade e o objeto de lealdade. <br><br>  Se o UFO favorecer, eu falarei separadamente sobre como trabalhar com a Apple Wallet (tudo √© mais dif√≠cil em termos de implementa√ß√£o), como fazer a Apple Wallet fazer amizade com o Google Pay em um servi√ßo da Web e n√£o sentir dor. <br></p><br><p></p><h3>  Links √∫teis </h3><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Registrar conta de comerciante</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Documenta√ß√£o da API do Google Pay para passes</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Bibliotecas cliente para trabalhar com a API do Google Pay for Passes</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt434486/">https://habr.com/ru/post/pt434486/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt434474/index.html">Gato verde sobre conte√∫do espacial</a></li>
<li><a href="../pt434476/index.html">Os ChatOps no GitLab estar√£o dispon√≠veis para todos</a></li>
<li><a href="../pt434478/index.html">O c√≥digo sem rosto matar√° a programa√ß√£o e n√£o faremos nada a respeito.</a></li>
<li><a href="../pt434480/index.html">Ano novo, gadgets, fogo</a></li>
<li><a href="../pt434482/index.html">Mais um ano do nosso blog: resultados de 2018</a></li>
<li><a href="../pt434490/index.html">Como vimos o viva-voz cortando jato de √°gua</a></li>
<li><a href="../pt434494/index.html">O que ler. Lista de fic√ß√£o em russo para 2017 e 2018</a></li>
<li><a href="../pt434496/index.html">Confirma√ß√£o em duas fases e o futuro dos sistemas distribu√≠dos</a></li>
<li><a href="../pt434498/index.html">MVP and Dagger 2 - Esqueleto de aplicativo Android - Parte 1</a></li>
<li><a href="../pt434500/index.html">Vigarista chamado Jeanne ou Watch Your Ears</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>