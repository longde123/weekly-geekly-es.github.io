<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üìÇ üå¥ üí™ PDA (Pocket Travel Computer): registrador GPS de circuitos üîå üôèüèø ü§≥üèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Mi proyecto de hobby es un registrador GPS . Los comentarios incluso sugirieron llamarlo "computadora de viaje", como El registro es solo una peque√±a ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>PDA (Pocket Travel Computer): registrador GPS de circuitos</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/454434/">  Mi proyecto de hobby es un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">registrador GPS</a> .  Los comentarios incluso sugirieron llamarlo "computadora de viaje", como  El registro es solo una peque√±a parte de todas las capacidades del dispositivo.  Mucho ya se ha implementado, pero la mayor√≠a a√∫n no se ha hecho. <br><br>  En art√≠culos anteriores, describ√≠ la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">transici√≥n de arduino a STM32</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">STMCube / HAL</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">habl√© un poco sobre el sistema de compilaci√≥n</a> , el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">gestor de arranque</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">constru√≠ un dispositivo USB compuesto</a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aument√≥ su velocidad</a> .  Todo esto se hizo en una placa de pruebas basada en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">la placa Blue Pill STM32F103CB</a> y un erizo de cables.  Es hora de que el dispositivo tome forma, tanto electr√≥nica (circuito) como f√≠sica (cuerpo). <br><br><img src="https://habrastorage.org/webt/0g/et/tj/0gettjt59u77r2mjpz73hyfn7sc.jpeg"><br><br>  Los problemas que tuve que resolver en esta etapa est√°n muy interconectados.  Al elegir los componentes para un proyecto, debe imaginarse aproximadamente en qu√© vivienda se pueden insertar.  Y viceversa, la caja debe estar hecha para los componentes que est√°n disponibles y las placas, que, nuevamente, deben hacerse con la vista puesta en la caja.  En general, una mara√±a de problemas interconectados.  Por supuesto, puede tomar una caja m√°s grande y empujar cualquier cosa all√≠, pero quer√≠a algo compacto y liviano. <br><br>  Antes de comenzar de inmediato, quiero se√±alar que esta no es la versi√≥n final del dispositivo.  Lo m√°s probable es que haya errores en el esquema, algo no funcionar√° seg√∫n lo previsto, en los comentarios indicar√°n soluciones m√°s correctas, se repensar√°n algunos enfoques.  Creo que la segunda o incluso la tercera versi√≥n del dispositivo no se puede evitar.  Por lo tanto, me complacer√° sus comentarios constructivos. <br><br>  Debajo del corte, tiene varias cuentas, pero ser√° ingenier√≠a. <br><a name="habracut"></a><br><h2>  Que y por que </h2><br>  El registrador GPS Holux M241 es mi fiel compa√±ero en todos los viajes.  √âl ha estado conmigo por muchos miles de kil√≥metros.  La pista que escribe el registrador se utiliza principalmente para geoetiquetar fotos, pero la ruta en s√≠ tambi√©n es de inter√©s.  Es divertido descubrir qu√© tan r√°pido fue a esquiar, qu√© ruta vol√≥ su avi√≥n, qu√© vista brill√≥ fuera de la ventana del autob√∫s.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Aqu√≠</a> hice una peque√±a revisi√≥n de este dispositivo. <br><br>  Desafortunadamente, las capacidades de este dispositivo han dejado de ser adecuadas para m√≠: estoy cansado de perder el tiempo con las bater√≠as que siempre se sientan en el momento m√°s inoportuno.  Tambi√©n hay una velocidad USB muy baja, una peque√±a cantidad de flash interno, un mecanismo inconveniente para fusionar pistas, hay poca informaci√≥n disponible en la pantalla, baja precisi√≥n, un od√≥metro muy primitivo, no hay informaci√≥n sobre sat√©lites y mucho m√°s. <br><br>  S√≠, uno podr√≠a buscar lo que ofrecen los rastreadores modernos, seguro que ya hay un dispositivo a la venta que cumple con mis requisitos.  Pero esto es un pasatiempo, quiero intentar hacer algo complejo, interesante, √∫til y necesario.  D√©jalo ser, aunque solo lo use. <br><br>  El objetivo del proyecto en su conjunto es hacer un dispositivo similar en algo, solo relleno con mi lista de deseos.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">En el primer art√≠culo</a> de la serie, detall√© mis requisitos para el dispositivo.  En resumen, me gustar√≠a hacer lo siguiente: <br><br><ul><li>  Recicle el sistema de energ√≠a, transfi√©ralo a una bater√≠a de litio </li><li>  poner una pantalla m√°s informativa </li><li>  GPS m√°s preciso </li><li>  ampliar flash con tarjeta SD </li><li>  agregar br√∫jula y aceler√≥metro </li><li>  Tambi√©n quiero redise√±ar el sistema de registro para escupir pistas en el formato que necesito. </li></ul><br>  Adem√°s de los requisitos t√©cnicos y la lista de deseos, tambi√©n hay otros no t√©cnicos (no funcionales).  Por lo tanto, me gustar√≠a comenzar a crear dispositivos complejos desde cero, para descubrir c√≥mo funcionan los diversos componentes electr√≥nicos, c√≥mo programarlos, c√≥mo criar una placa y dise√±ar un estuche. <br><br>  ¬øPor qu√© necesita un dispositivo separado si todos los tel√©fonos modernos tienen GPS, una pantalla grande y mucha memoria?  Bueno, antes que nada, no estoy seguro de que un tel√©fono con GPS activado en modo de grabaci√≥n de seguimiento pueda soportar todo el d√≠a.  Realmente no me gustar√≠a quedarme en un pa√≠s desconocido sin un tel√©fono.  Adem√°s, yo personalmente uso un dispositivo separado es simplemente m√°s c√≥modo. <br><br>  Quiz√°s con el tiempo, el concepto del dispositivo cambiar√°.  Entonces, por ejemplo, ahora es cada vez m√°s l√≥gico abandonar la pantalla y conectarse al tel√©fono a trav√©s de Bluetooth, y hacer todos los trucos l√≥gicos en el tel√©fono.  Esta idea es muy robusta y tentadora.  Pero en esta etapa, todav√≠a me gustar√≠a tener una pantalla, siempre tengo tiempo para abandonarla. <br><br>  Durante el primer a√±o y medio, desarroll√© el dispositivo en varios tipos de placas de depuraci√≥n (primero arduino nano, luego la p√≠ldora azul STM32F103, luego STM32F407VE).  Tuve que conectar perif√©ricos en el cableado y los m√≥dulos comprados.  Como resultado, se erigi√≥ un erizo hecho de cables sobre la mesa, que no funcion√≥ para probar la recepci√≥n de GPS en la calle, a veces ni siquiera se pod√≠an mover los cables sin romper la conexi√≥n en alguna parte.  Y luego feliz depuraci√≥n. <br><br>  Cada vez, sentado para escribir funcionalidades √∫tiles, me top√© con el hecho de que alguna otra parte del sistema dej√≥ de funcionar normalmente y tuvo que pasar horas depurando algo completamente ajeno.  Entonces, por ejemplo, el componente m√°s importante del sistema, el receptor GPS, al final result√≥ ser el menos desarrollado, porque  Tuve que ir a depurar USB, tarjetas SD, configurar bibliotecas, etc. <br><br>  Finalmente, me cans√© y decid√≠ crear mi tablero de depuraci√≥n; este ser√° el tema del art√≠culo de hoy.  Los objetivos que me propuse en esta parte del proyecto fueron los siguientes: <br><br><ul><li>  Haga una placa de depuraci√≥n que no tenga problemas con componentes sin contacto </li><li>  Decidir sobre las principales soluciones t√©cnicas y esquem√°ticas. </li><li>  Aproximadamente decida sobre los componentes que usar√© a continuaci√≥n </li><li>  Aproximadamente decida sobre el dise√±o y el cuerpo </li><li>  El circuito debe ser lo suficientemente general como para poder experimentar con diferentes componentes y sus modos. </li></ul><br>  Y aunque el objetivo final es un dispositivo de bater√≠a compacto, hoy no har√© cosas como <br><br><ul><li>  modos de potencia de ajuste fino </li><li>  ajuste de consumo </li><li>  modos de reposo </li></ul><br><br>  Me ocupar√© de la configuraci√≥n de consumo cuando la placa y el c√≥digo principal est√©n listos.  Por cierto, sobre el c√≥digo de hoy tampoco lo ser√°, pero definitivamente volver√© a esta pregunta ya que habr√° suficiente material interesante. <br><br><h2>  Componentes </h2><br>  Comencemos con los componentes y perif√©ricos.  En el camino, calcularemos la cantidad de patas del microcontrolador que se necesitar√°n para conectar este zool√≥gico, as√≠ como los par√°metros de potencia.  Porque  es un proyecto de pasatiempo que eleg√≠ componentes de lo que realmente puedo comprar en tiendas / ebay / ali, y tambi√©n de lo que se puede soldar en casa (bueno, tambi√©n de lo que ya estaba en mi stock personal).  Quiz√°s algunos microcircuitos espec√≠ficos podr√≠an resolver mejor el problema, pero el tema de la asequibilidad y el precio es importante para m√≠. <br><br><ul><li>  El componente principal de un registrador GPS, por supuesto, ser√° un <b>receptor GPS</b> .  En mi caso, este es un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Beitian BN-880</a> bastante <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">enga√±ado</a> basado en el chip UBlox M8N.  La br√∫jula en el chip HMC5883L tambi√©n est√° integrada en el m√≥dulo. <br><br>  Conexi√≥n: 2 pines UART para GPS y 2 pines I2C para br√∫jula <br>  Fuente de alimentaci√≥n: desde 2.7V <br>  Consumo: 50 mA <br><br><ul><li>  Tambi√©n orden√≥ un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">m√≥dulo Beitial BN-220</a> .  No tiene una br√∫jula, pero la antena es m√°s compacta (20x20 mm frente a 30x30).  La verdad a√∫n no est√° clara c√≥mo esto afectar√° la calidad de la recepci√≥n.  Necesito probar.  Pero, a juzgar por la hoja de datos, este m√≥dulo puede funcionar desde 1.4V, lo que deber√≠a tener un efecto positivo en el tiempo de funcionamiento del dispositivo. </li><li>  Aqu√≠, de hecho, todo est√° de alguna manera embarrado.  Parece que el BN-880 se basa en el UBlox M8N, mientras que el BN-220 se basa en el U-blox M8030-KT.  Pero en algunas fuentes se desliza que parece ser lo mismo.  M√°s precisamente, el M8N es un m√≥dulo y el M8030-KT es un chipset en su interior.  Me preocupa el problema de energ√≠a en esta confusi√≥n: el M8N se anuncia desde 2.7V, mientras que el M8030-KT es desde 1.4V. </li><li>  Como alternativa, tambi√©n tengo el m√≥dulo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://www.aliexpress.com/item/1PC-SIM868-GSM-GPRS-Bluetooth-GNSS-SMS-GSM-Module-Instead-of-SIM808-SIM908/32821272639.html%3Fspm%3Da2g0s.9042311.0.0.27424c4dTkhPkq)%2520(%25D0%25BE%25D1%2582%25D0%25BB%25D0%25B0%25D0%25B4%25D0%25BE%25D1%2587%25D0%25BD%25D0%25B0%25D1%258F%2520%25D0%25BF%25D0%25BB%25D0%25B0%25D1%2582%25D0%25B0%2520">SIM868</a> por <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://www.aliexpress.com/item/1PC-SIM868-GSM-GPRS-Bluetooth-GNSS-SMS-GSM-Module-Instead-of-SIM808-SIM908/32821272639.html%3Fspm%3Da2g0s.9042311.0.0.27424c4dTkhPkq)%2520(%25D0%25BE%25D1%2582%25D0%25BB%25D0%25B0%25D0%25B4%25D0%25BE%25D1%2587%25D0%25BD%25D0%25B0%25D1%258F%2520%25D0%25BF%25D0%25BB%25D0%25B0%25D1%2582%25D0%25B0%2520">ah√≠</a> .  en el que adem√°s del GPS tambi√©n hay un m√≥dulo GSM / GPRS y Bluetooth.  Mientras asusta con su enga√±o y complejidad de conexi√≥n.  Tendr√°s que jugar primero con el tablero de depuraci√≥n. </li></ul></li><li>  La principal diferencia entre el dispositivo y "solo una caja negra" es la presencia de una <b>pantalla</b> .  En los primeros prototipos, conect√© la pantalla a trav√©s de I2C, pero la carga del bus era de aproximadamente el 25%.  Pero el punto no es ni siquiera en la proporci√≥n porcentual, sino en el hecho de que la transferencia del b√∫fer de pantalla tarda unos 25 ms, durante el cual es imposible comunicarse con otros dispositivos en el bus.  Esto puede ser un problema, por lo que debe colocar la pantalla en un bus I2C separado o considerar conectarse a trav√©s de SPI <br><br>  Conexi√≥n: 2 cables I2C o 3 cables SPI (pantalla de solo escritura, por lo tanto, la l√≠nea MISO no se usa, pero se usa una se√±al de datos / comando separada) <br>  Fuente de alimentaci√≥n: 3V <br>  Consumo: 25 mA <br></li><li>  Para controlar el dispositivo, usar√© <b>2 botones</b> que ocupan 2 patas del procesador, respectivamente. <br></li><li>  En el dispositivo original (Holux M241, del que originalmente copi√© la funcionalidad), era imposible ver la pista en un punto arbitrario en el tiempo.  Era necesario conectar el dispositivo a la computadora y fusionar los datos con un programa especial.  Me parece que la capacidad de ver una pista en un tel√©fono m√≥vil o tableta en cualquier momento ser√° muy popular.  Para esto, compr√© un m√≥dulo <b>Bluetooth</b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">HM-13</a> .  Este m√≥dulo se selecciona porque tiene SPP adem√°s de BLE. <br><br>  Conexi√≥n: 2 cables UART, 1 cable de estado (conectado / no conectado) <br>  Fuente de alimentaci√≥n: 2.5V - 3.9V <br>  Consumo: 50 mA (aunque la figura 13 mA est√° justo al lado de la hoja de datos. Quiz√°s este sea el valor m√°ximo y promedio) <br></li><li>  Como me dijeron, no tiene sentido mantener el receptor encendido si simplemente se sent√≥ a descansar o fue a cenar a un caf√©.  Por lo tanto, decid√≠ agregar el <b>aceler√≥metro</b> MMA8452 y usarlo para determinar si el dispositivo est√° en reposo o si nos estamos moviendo a alg√∫n lado. <br><br>  Conexi√≥n: 2 cables I2C, 1 cable para interrupci√≥n <br>  Fuente de alimentaci√≥n de 2V a 3.6V con algo de consumo microsc√≥pico <br></li><li>  La pista GPS se grabar√° en la <b>tarjeta SD</b> .  Ya he intentado usar la tarjeta en modo SPI y esto es, por decirlo suavemente, lento.  Especialmente en el registro.  Modo correcto para la tarjeta SD - SDIO <br><br>  Conexi√≥n: 6 cables. <br>  Fuente de alimentaci√≥n: desde 1.8V <br>  El consumo es desconocido, pero creo que no m√°s de 20 mA <br></li><li>  Para ahorrar energ√≠a, tiene sentido apagar la energ√≠a de aquellos dispositivos que no est√°n actualmente en uso.  As√≠ que cerca de cada consumidor pondr√© un <b>transistor</b> , que controlar√© una se√±al separada del microcontrolador <br><br>  Conexi√≥n: 5 se√±ales, un pie por consumidor (GPS, Bluetooth, aceler√≥metro, tarjeta SD, pantalla) <br><br>  UPD basado en comentarios.  Deshabilitar el aceler√≥metro no tiene sentido, ya tiene un consumo de centavo.  Es probable que algunos dispositivos siempre funcionen (por ejemplo, una tarjeta SD); en el futuro podr√© eliminar estos transistores.  Algunos dispositivos (como el GPS) pueden desconectarse por comando desde la interfaz.  Si de acuerdo con los resultados de la prueba, esta parte funcionar√° bien, tambi√©n rechazar√© un transistor externo.  Mientras tanto, estoy haciendo la tarifa total m√°xima posible, deje que estos transistores sean todos.  Adem√°s, todav√≠a no me he decidido por la periferia. </li><li>  <b>Un LED de dos colores</b> para la pantalla de estado (¬øqu√© tal sin un LED parpadeante?).  Ser√≠a posible poner un tricolor, pero hasta ahora no veo la necesidad. <br><br>  Conexi√≥n: 2 pines <br>  Consumo: 10 mA <br></li><li>  Adem√°s de Bluetooth, se implementar√° un mecanismo m√°s cl√°sico para fusionar pistas, a trav√©s de <b>USB</b> .  Para esto, se involucrar√°n 4 l√≠neas: un par diferencial para datos, 1 pin para detectar que el dispositivo est√° enchufado a USB y otro pin para conexi√≥n l√≥gica (por qu√© necesito estos 2 pines que describir√© a continuaci√≥n) <br></li><li>  El apetito viene con comer.  Desde que comenc√© a meter todo en el dispositivo de mis sue√±os, ¬øpor qu√© no agregar un <b>tweeter</b> ?  Bueno, o un <b>motor de vibraci√≥n</b> .  Todav√≠a no se me ocurri√≥ un caso de usuario. <br><br>  Conexi√≥n: 1 cable <br></li><li>  El dispositivo a√∫n necesitar√° ser encendido.  Mientras el chip PT1502 me est√° mirando como un cargador de bater√≠a de litio y <b>controlador de energ√≠a</b> .  Para comunicarse con el microcircuito, necesitar√° usar 2 cables: uno para la administraci√≥n de energ√≠a y el otro para una se√±al sobre una bater√≠a agotada.  En aras del inter√©s, ser√° posible medir el voltaje de la bater√≠a utilizando otra l√≠nea. <br></li><li>  Por supuesto, la carga de una bater√≠a de litio es incorrecta para medir en funci√≥n del voltaje.  Por lo tanto, agregu√© un <b>chip de medidor de potencia INA219</b> especial <br><br>  Voltaje de suministro: 3-5V, recomendar 3.3V <br>  Conexi√≥n: 2 hilos I2C <br><br>  Como se ver√° a continuaci√≥n, un voltaje de suministro de 3V crea algunas molestias en la conexi√≥n.  Preferir√≠a que el chip del contador se alimentara desde 2.7V o menos.  Pero despu√©s de pasar por varias opciones basadas en el precio / caso / disponibilidad, todav√≠a no encontr√© nada a 2.7V.  Estar√© agradecido por la ayuda. <br></li><li>  Solo queda proporcionar una interfaz de depuraci√≥n <b>SWD</b> (3 cables) y un <b>UART de depuraci√≥n</b> (2 cables m√°s) <br></li></ul><br>  Siempre me interes√≥ la pregunta de por qu√© se necesitan controladores con una gran cantidad de puertos, y cont√© f√°cilmente 39 patas necesarias para mi funcionalidad.  Y eso sin contar cuarzo, reinicio y energ√≠a.  Y hay ideas sobre qu√© hacer con una docena m√°s (por ejemplo, la pantalla podr√≠a conectarse a trav√©s de una interfaz paralela Intel 8080 o Motorola 6800). <br><br>  Por supuesto, puede atornillar los extractores de puerto I2C para reducir la cantidad de patas utilizadas.  Pero en primer lugar, se trata de componentes adicionales en la placa, en segundo lugar, la parte del software se vuelve mucho m√°s complicada y, en tercer lugar, los microcontroladores peque√±os a√∫n tienen poca memoria y, cuando hay suficiente memoria, tambi√©n hay suficientes puertos.  Por lo tanto, no veo ninguna raz√≥n para complicarlo todo: que haya 39 l√≠neas. <br><br><h2>  Nutrici√≥n </h2><br>  Con la fuente de alimentaci√≥n, no todo est√° tan claro.  Probablemente pueda alimentar todos los dispositivos desde 3.3V y calmarse.  Pero, sin embargo, vamos a hacer un dispositivo m√≥vil, lo que significa que debemos pensar en ahorrar energ√≠a.  Por lo tanto, debe intentar elegir un voltaje de suministro m√°s peque√±o.  A continuaci√≥n, calcular√© qu√© tipo de ahorro puede intentar lograr. <br><br>  Aqu√≠ est√°n los datos para todos los dispositivos en la placa; de esta forma, es m√°s conveniente elegir el dominio de potencia al que conectar este o aquel dispositivo. <br><br><div class="scrollable-table"><table><tbody><tr><td>  <b>Dispositivo</b> </td><td>  <b>Rango de potencia</b> </td><td>  <b>Dominio de poder</b> </td><td>  <b>comunicacion</b> </td></tr><tr><td>  CPU </td><td>  2 - 3.6V </td><td>  2V </td></tr><tr><td>  Aceler√≥metro </td><td>  2 - 3.6V </td><td>  2V </td><td>  I2C </td></tr><tr><td>  Tarjeta SD </td><td>  1.8V o 3.6V </td><td>  2V </td><td>  SDIO </td></tr><tr><td>  Display </td><td>  1.65 - 3.3V <br>  o 3 - 5V </td><td>  2V </td><td>  I2C o SPI </td></tr><tr><td>  GPS </td><td>  2.7 - 5.5V <br>  o desde 1.4V </td><td>  2.7V </td><td>  UART </td></tr><tr><td>  Bluetooth </td><td>  2.5 - 3.9V </td><td>  2.7V </td><td>  UART </td></tr><tr><td>  Medidor de potencia (INA219) </td><td>  3 - 5.5V </td><td>  3v </td><td>  I2C </td></tr><tr><td>  Zumbador </td><td>  3V - 5V </td><td>  Vbat </td></tr></tbody></table></div><br>  Desde la placa es f√°cil ver que algunos de los dispositivos pueden funcionar con voltajes suficientemente bajos (desde 1.8V).  Otros pueden trabajar c√≥modamente desde 2.7V.  Finalmente, los dispositivos restantes por debajo de 3V no pueden funcionar.  El chirrido, para bien, generalmente necesita 5V, pero para m√≠ ser√° alimentado por el voltaje m√°s alto, de la bater√≠a, no importa cu√°nto sea. <br><br>  Con el poder de la pantalla a√∫n no se entiende completamente.  En la descripci√≥n de los m√≥dulos de pantalla con ali, el rango es de 3 - 5V, mientras que en la hoja de datos del controlador de matriz SSD1309 el rango es de 1.65 - 3.3V.  Supongo que se necesitan 3V para balancear el convertidor de refuerzo en la placa del m√≥dulo de pantalla, mientras que 1.65V es suficiente para la l√≥gica.  Como se ver√° en las discusiones sobre el dise√±o, tiene sentido abandonar el m√≥dulo de pantalla y conectar la pantalla directamente, lo que alimentar√° la pantalla del dominio 2B. <br><br>  Tengo el mismo razonamiento sobre el GPS: diferentes fuentes indican diferentes voltajes de suministro.  Hasta ahora, no entiendo qu√© m√≥dulo usar√© al final, as√≠ que deje que el receptor se cuelgue en el dominio de 2.7V. <br><br>  Con una tarjeta SD no est√° nada claro.  La especificaci√≥n dice oscuramente que, en general, la tarjeta debe ser alimentada desde 3.3V, pero las tarjetas modernas son lo suficientemente inteligentes y pueden entender que est√°n atrapadas en un dispositivo de bajo voltaje y pueden cambiar a una alimentaci√≥n de 1.8V.  Pero el mecanismo para elegir los alimentos no est√° muy claro.  Alimentar√© la tarjeta de 2B y ver√© qu√© sucede.  No funcionar√°, funcionar√° desde 3V. <br><br>  Entonces, se vislumbran 4 buses de potencia: 2V, 2.7V, 3V y una bater√≠a.  Me gustar√≠a poner a todos los consumidores que est√°n comiendo y trabajando constantemente (y este es el controlador y el GPS) en el bus de voltaje m√°s bajo, pero por el momento a√∫n no he decidido el m√≥dulo GPS (y por lo tanto su fuente de alimentaci√≥n - 2 o 2.7V), lo que significa que ser√° necesario alg√∫n tipo de soluci√≥n universal.  Intentar√© separar la placa para que sea f√°cil aplicar uno u otro voltaje. <br><br>  ¬øDe d√≥nde sacas tantas tensiones diferentes?  Incluso en las primeras etapas del proyecto, mir√© el microcircuito PT1502 e incluso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">logr√© probarlo en otro proyecto</a> .  Adem√°s del cargador para la bater√≠a de litio, este microcircuito tiene hasta 3 fuentes de alimentaci√≥n: un pulso y 2 interruptores lineales.  Aqu√≠, sin embargo, el voltaje no est√° regulado en uno de ellos y es de 3V. Intentar√© alimentar el INA219 desde √©l.  Las 2 fuentes de energ√≠a restantes no son un problema, porque  All√≠ puedes elegir el voltaje. <br><br>  La estimaci√≥n del consumo no es muy exitosa.  El consumo m√°ximo se indica en las hojas de datos: esto es suficiente para calcular la potencia de los transistores clave, pero no lo suficiente como para estimar la capacidad de bater√≠a requerida.  Entonces, por ahora, seleccionar√© la bater√≠a seg√∫n el espacio disponible en el caso, y all√≠ ya medir√© el consumo real. <br><br>  Puede surgir la pregunta, pero ¬øc√≥mo hacer coincidir los dispositivos con diferentes voltajes operativos?  Vamos a hacerlo bien. <br><br><ul><li>  Todas las patas de comunicaci√≥n de los microcontroladores est√°n marcadas como tolerante a cinco voltios (excepto UART2 en las patas de PA2 / PA3), lo que significa que si aparece 3.3V desde el dispositivo de mayor voltaje, no ocurrir√° nada malo </li><li>  El aceler√≥metro, aunque alimentado por 2V, puede conectarse potencialmente en paralelo con dispositivos de alto voltaje en el bus.  Este problema se resuelve f√°cilmente: con el microcircuito MMA8452Q, puede alimentar por separado los cables de comunicaci√≥n desde otra fuente de alimentaci√≥n (a trav√©s del dispositivo de "alto voltaje" en el bus) </li><li>  Intentar√© alimentar la tarjeta SD con el mismo voltaje que el microcontrolador, lo que significa que no necesito coordinar nada. </li><li>  El GPS y Bluetooth deben consumir el voltaje "bajo" del microcontrolador sin ning√∫n problema.  Lo mismo ocurre con otros dispositivos de "alto voltaje" </li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Finalmente, algunas palabras sobre por qu√© estoy luchando por bajar el voltaje de suministro. </font><font style="vertical-align: inherit;">Un chip en un convertidor DC-DC pulsado, que puede intercambiar voltios por amperios (si no tiene en cuenta las p√©rdidas del convertidor, por supuesto). </font><font style="vertical-align: inherit;">Para ser m√°s precisos, cambie un voltaje m√°s alto con una corriente m√°s baja por un voltaje m√°s bajo y una corriente m√°s alta. </font><font style="vertical-align: inherit;">En este caso, estamos m√°s interesados ‚Äã‚Äãen el razonamiento inverso: si alimenta una carga de bajo voltaje a trav√©s de CC-CC, entonces el consumo de corriente de toda esta estructura junto con el convertidor ser√° menor que el consumo de corriente de la carga misma. </font><font style="vertical-align: inherit;">Bueno, dado que la capacidad de la bater√≠a se mide en mAh, la reducci√≥n del consumo de corriente aumentar√° la vida √∫til de la bater√≠a.</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cuenta?</font></font></b> <div class="spoiler_text">   ,        90%,        DC-DC        .  .      ,      DC-DC   . <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">  </a> .   900    4.1  3.5 (      ).  DC-DC    90% (   ).    100.            . <br><br> ,      900  100  9 .          ‚Äî 9.3     3.3, 11.4   2.7,   15    2. ,    ,    ,        . <br></div></div><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Microcontrolador </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Abord√© cuidadosamente la cuesti√≥n de elegir un microcontrolador: jugu√© con el configurador durante mucho tiempo, sopesando los pros y los contras de cada una de las opciones. Realmente me gustaron los microcontroladores STM32, por lo que no veo el punto de mirar en la direcci√≥n de otros controladores sin necesidad especial. Adem√°s, en la l√≠nea STM32 hay controladores para todos los gustos y para cualquier periferia. La experiencia adquirida en las etapas anteriores de mi proyecto nos permite reducir la elecci√≥n del controlador en funci√≥n de la lista de perif√©ricos, enlaces de software ya escritos, as√≠ como las caracter√≠sticas que me gustar√≠a implementar en el futuro.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por lo tanto, es bastante obvio que 20kb de memoria de mi STM32F103CB es definitivamente peque√±o: no hay suficientes buffers de tama√±o decente para comunicarse con una tarjeta SD y USB. </font><font style="vertical-align: inherit;">Ni siquiera he comenzado a implementar gran parte de la funcionalidad planificada, pero ya ha tomado m√°s de 19 kb. </font><font style="vertical-align: inherit;">Pero con el poder de procesamiento, como result√≥, esto no es particularmente necesario. </font><font style="vertical-align: inherit;">Si toda la comunicaci√≥n con los perif√©ricos se inserta en DMA, solo queda un par de porcentaje en la parte del procesador central. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Habiendo estimado la lista de lo que necesito del controlador, calcul√© lo siguiente:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &gt; = 128kb flash (actualmente se usan aproximadamente 50k) </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &gt; = 40 kb de memoria (ahora se toman 19k) </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &gt; = 40 pies GPIO (ver razonamiento arriba) </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &gt; = 40MHz (no necesitas mucho, lo principal es tener menos consumo) </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> DMA (realmente me gust√≥) </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &gt; = 2x I2C,&gt; = 3x UART,&gt; = 1 SPI </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> SDIO (la unidad flash a trav√©s de SPI es muy lenta) </font></font></li><li>  USB Full Speed,  High Speed </li><li>  (      ) </li><li>       LCD  (         FSMC) </li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Los microcontroladores STMicroelectornics son solo una moneda de diez centavos por docena, para todos los gustos, colores y carteras. Al principio intent√© elegir un controlador para proceder de la serie. Las reglas L0 y F0 son demasiado d√©biles y no tienen suficiente memoria, S7 y H7, por el contrario, tienen demasiadas funciones, no hay SDIO en L4 (UPD: SDIO es, simplemente no lo mencionaron en la p√°gina de t√≠tulo de la serie). Entre el resto de la serie, puede elegir algo seg√∫n mis necesidades, ya que no tengo requisitos particularmente espec√≠ficos. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La serie STM32WB impresiona con la presencia de Bluetooth, pero el estuche VFQFPN68 enfr√≠a un poco el deseo de usarlo en proyectos de hobby. Y no encontr√© tales controladores en el comercio minorista.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apunt√© al caso LQFP64: suficiente en el n√∫mero de patas, pero no muy grande al mismo tiempo y se puede soldar en casa. Es bueno que haya un configurador CubeMX donde puede seleccionar lo que necesita con los filtros. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Opt√© por el controlador STM32F103RB por tres razones. Primero, ya estudi√© bien la serie F103 con el tablero Blue Pill. En general, el controlador STM32F103CB me conven√≠a completamente, solo que la memoria no era suficiente. En segundo lugar, ya tengo un gestor de arranque y un c√≥digo de bajo nivel para este controlador, mientras que otros tendr√°n que rehacerse. Y en tercer lugar, hace aproximadamente un a√±o, ya estaba feliz de comprar 3 piezas STM32F103RB. Luego no hice un estudio detallado de los controladores disponibles, sino que simplemente tom√© un controlador m√°s grueso de la l√≠nea F103. No lo tires ahora :)</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como ya he se√±alado, no tengo requisitos perif√©ricos o de rendimiento particularmente espec√≠ficos. </font><font style="vertical-align: inherit;">Pero si me encuentro con algo, entonces tengo en cuenta que ya tengo controladores de la l√≠nea F4 (si se necesita algo m√°s poderoso), o L152RD, si necesitas decidir algo con el consumo (UPD: tambi√©n mir√© a L433RC). </font><font style="vertical-align: inherit;">Lo que agrada, con STM32, casi todos los controladores de pin a pin son compatibles, y F4 y L1 / L4 se pueden soldar casi sin alterar la placa. </font><font style="vertical-align: inherit;">Incluso puede recopilar y comparar el consumo con diferentes MK.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Algunas palabras sobre el cuerpo y el dise√±o. </font></font></h2><br>  Decidimos los detalles.  Es hora de dibujar un diagrama, luego trazar el tablero y luego tratar de encajarlo en la caja.  O no?  Para admitir, al principio solo fui por este camino, pero luego llegu√© a la conclusi√≥n de que todo debe hacerse en el orden inverso.  Bueno, o al menos al mismo tiempo. <br><br>  Me gustar√≠a obtener un dispositivo compacto.  Y para esto, debe comprender con precisi√≥n el tama√±o del espacio disponible, a su vez, comprender d√≥nde colocar la placa y su tama√±o, qu√© tama√±o de bater√≠a puede caber, d√≥nde colocar los botones, la pantalla, el conector USB y otros componentes externos, as√≠ como descubrir c√≥mo montar los componentes y usted puede si es conveniente tender cables entre ellos.  Simplemente no tiene sentido comenzar a levantar un tablero sin comprender todas estas cosas.  Resulta que primero debes ocuparte del cuerpo y el dise√±o, y luego pasar al circuito. <br><br>  Adem√°s, en el proceso de elaboraci√≥n del caso, tuve que revisar la selecci√≥n de componentes varias veces.  Inicialmente, pens√© en usar una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">pantalla econ√≥mica de 128x64 de 0,96 ‚Äù</a> (√°rea de trabajo de 21,7 x 11,2 mm), pero esta pantalla se ve√≠a completamente microsc√≥pica en el contexto de una caja mucho m√°s grande.  Luego se orden√≥ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">una pantalla de 1.3 "</a> (√°rea de trabajo 29.4 x 14.7 mm), pero no mejor√≥ mucho.  Luego obtuve <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">una pantalla de 1.54 ‚Äù</a> (35 x 17.5 mm), se ve m√°s o menos normal con ella.  Esta es actualmente la principal opci√≥n de trabajo. <br><br>  Seg√∫n las estimaciones, una pantalla de 1.8 "-2" se habr√≠a visto mejor, pero estas ya vienen en color y con una resoluci√≥n m√°s alta, y en consecuencia el b√∫fer de pantalla ser√° lo suficientemente grande para mi controlador (35kb en lugar de 1kb).  Bueno, empujar pantallas grandes en el estuche tambi√©n puede ser un problema, porque  los soportes de aterrizaje para dichos m√≥dulos son significativamente m√°s grandes que el √°rea activa de la pantalla. <br><br>  Mientras escrib√≠a este art√≠culo en ali, aparec√≠an <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">pantallas monocromas de 2.42 "</a> con la misma resoluci√≥n (128x64) y exactamente la misma encuadernaci√≥n que 1.54".  Ped√≠ uno para mi prueba: existe la posibilidad de pegarlo en mi estuche sin un aumento significativo en el dispositivo. <br><br>  Otro punto importante en la etapa de trabajo en el caso fue la comprensi√≥n de que el m√≥dulo de visualizaci√≥n adquirido ocupa demasiado espacio y reduce significativamente el espacio para la placa principal.  Por lo tanto, decid√≠ abandonar el m√≥dulo de pantalla terminado y, en su lugar, colocar la pantalla y su uni√≥n a mi placa.  El n√∫mero de partes en el circuito aument√≥ ligeramente, pero el dise√±o en su conjunto se simplific√≥ significativamente y se hizo m√°s compacto. <br><br>  Tengo pensamientos similares sobre el tema del m√≥dulo GPS.  No es tan grande, pero no importa c√≥mo lo ponga o interfiera, o la antena est√° cerrada por alguna bater√≠a.  Puede ser una buena idea colocar el relleno del m√≥dulo en su placa y colocar la antena en otro lugar. <br><br>  El trabajo en el caso tambi√©n permiti√≥ determinar el tama√±o y la capacidad de la bater√≠a.  En el volumen disponible, se acaba de encontrar una bater√≠a de 900 mAh, nos centraremos en ella.  Me gustar√≠a que mi dispositivo funcione con una bater√≠a de 15-20 horas, lo que significa que el consumo debe estar en el nivel de 45-60mA. <br><br>  Por el momento, no puedo terminar el trabajo en el casco.  En primer lugar, la cuesti√≥n de elecci√≥n para algunos componentes (pantalla, GPS) a√∫n est√° abierta.  En segundo lugar, no est√° claro si mi circuito comenzar√° en principio o si ser√° necesario cambiar algo radicalmente.  Y en tercer lugar, la placa resulta demasiado compacta: no estoy seguro de poder disolverla, soldarla y depurarla.  Por lo tanto, en este art√≠culo todav√≠a me enfocar√© en problemas de circuitos, me mover√© en pasos m√°s simples y m√°s comprensibles, y hablar√© sobre el caso la pr√≥xima vez.  Aqu√≠ tienes un par de representaciones y fotos para semillas. <br><br><img src="https://habrastorage.org/webt/4j/ff/l-/4jffl-arvuselp1d93s5muqazqy.png"><br><br><img src="https://habrastorage.org/webt/o2/a9/ve/o2a9vejujirpcxe634dzikwqc0e.png"><br><br><img src="https://habrastorage.org/webt/a9/hu/ka/a9huka9xfxi-g0wegdzhb8ezonm.jpeg"><br><br><img src="https://habrastorage.org/webt/az/nl/b2/aznlb21azpqtsfgoaim0occrvgc.jpeg"><br><br><h2>  Esquema </h2><br>  Ahora puedes hacer electr√≥nica.  Describir√© las soluciones de circuitos con suficiente detalle.  En primer lugar, para los mismos reci√©n llegados en electr√≥nica que yo, as√≠ como una sinopsis para m√≠.  Los ingenieros electr√≥nicos con experiencia pueden examinar los circuitos y retroceder a la siguiente secci√≥n. <br><br>  Comencemos con la nutrici√≥n. <br><br>  El dispositivo estar√° alimentado por una bater√≠a de litio, lo que significa que necesita un controlador de carga.  Adem√°s, algunos componentes tienen un l√≠mite de voltaje superior de aproximadamente 3.6V, mientras que una bater√≠a puede terminar f√°cilmente con m√°s de 4V.  Por lo tanto, necesita una fuente de energ√≠a reductora.  Como ya hemos descubierto, necesitaremos varias tensiones diferentes. <br><br>  Ya mencion√© que usar√© el chip PT1502.  Se ajusta bien, porque  implementa un controlador de carga, 3 fuentes de alimentaci√≥n, as√≠ como un circuito de dispositivo de conmutaci√≥n de bot√≥n.  El microcircuito contiene varios bloques funcionales, que he dividido en el diagrama para mayor claridad.  El circuito en s√≠ es un circuito de hoja de datos ligeramente revisado.  Aqu√≠ est√° el controlador de carga de la bater√≠a de litio. <br><br><img src="https://habrastorage.org/webt/7y/p7/sk/7yp7skuez7vcdpdzr33f6rhtfk4.png"><br><br>  La resistencia R3 establece la corriente de carga.  Por defecto, esto corresponde a 470mA.  Quiz√°s seg√∫n los resultados de la prueba, reducir√© el valor de esta resistencia a 510 ohmios, lo que dar√° una corriente de carga de aproximadamente 900 mA (1C). <br><br>  El controlador puede informar el modo de carga actual con el pie CHG_STAT.  Adem√°s, sabe c√≥mo dar se√±ales hasta 3: se est√° cargando, no se est√° cargando y ya se ha cargado, pero todav√≠a est√° conectado a la toma de corriente.  En la primera versi√≥n, el transistor interno presiona el pie contra el suelo y el controlador puede reconocerlo f√°cilmente.  En la segunda realizaci√≥n, el transistor est√° completamente cerrado y la pata entra en un estado de alta impedancia.  Usando un encendido, dicha se√±al tambi√©n es f√°cil de leer por el controlador. <br><br>  Pero con el tercer estado no es tan simple.  All√≠, el transistor est√° entornado y una corriente de 20 ŒºA fluye a trav√©s de √©l.  Para considerar tal condici√≥n, se me solicit√≥ elegir un elevador para que aproximadamente la mitad de la nutrici√≥n estuviera en mi pierna.  Entonces ser√° posible detectar f√°cilmente dicho estado utilizando el ADC.  Usando la ley de Ohm obtenemos R5 = 1V / 20mkA = 50k. <br><br>  Como dije, el chip PT1502 no es solo un cargador, sino tambi√©n un controlador complicado para toda la potencia.  El microcircuito monitorea los voltajes en el circuito y, utilizando la se√±al RESET, puede controlar el procesador principal (dicen que todav√≠a tiene que arrancar temprano, la potencia a√∫n no se ha estabilizado). <br><br><img src="https://habrastorage.org/webt/21/z3/f1/21z3f1tkkpvqsph462qukz0_anu.png"><br><br>  Adem√°s, el microcircuito puede iniciar el dispositivo con solo tocar un bot√≥n (BTN1) y, luego de recibir una se√±al del microcontrolador (PWR_HOLD), completar la operaci√≥n y apagar la alimentaci√≥n.  Bueno, para indicarle al procesador que la bater√≠a se est√° quedando sin se√±al BAT_LOW. <br><br>  Y esta es la principal fuente de energ√≠a. <br><br><img src="https://habrastorage.org/webt/nb/5x/tc/nb5xtc2txxl98wz1pfwgmzsr49u.png"><br><br>  El voltaje de salida se establece por el voltaje en el terminal BUCKFB y se establece en 2V con energ√≠a de la bater√≠a.  Pero con una potencia de dos voltios, se descubri√≥ un problema: el USB no funcionar√°.  Es decir  la bater√≠a se cargar√°, pero no podr√° transmitir datos: el microcontrolador simplemente no puede enviar se√±ales a un bus USB de suficiente amplitud.  Datashit recomienda un voltaje de al menos 2.7V, mejor que 3.3V. <br><br>  Para no bloquear otra fuente de energ√≠a y pensar c√≥mo cambiar entre ellas, decid√≠ ajustar la relaci√≥n del divisor R1 / R4 + R7.  Con esta inclusi√≥n, el impulso opera continuamente.  Tan pronto como el dispositivo se conecta a USB, el transistor se abre y desv√≠a R7.  La relaci√≥n de las resistencias de conducci√≥n cambia y obtenemos 3.16V en la salida (todav√≠a podemos jugar con las clasificaciones y mantenerlo hasta 3.3V). <br><br>  El PT1502 tambi√©n tiene 2 controles lineales. <br><br><img src="https://habrastorage.org/webt/1c/s0/tj/1cs0tjf8eerkuske4_dyqithygm.png"><br><br>  Se conectar√°n componentes de bajo consumo (INA219) o de corta duraci√≥n (bluetooth) a estos controladores, por lo que la eficiencia de estas fuentes no ser√° un problema.  El voltaje de suministro LDO2 se puede ajustar utilizando las se√±ales LDO2_SETx. <br><br>  Como todav√≠a tengo preguntas abiertas sobre el voltaje de alimentaci√≥n, decid√≠ separar los puentes para seleccionar el modo LDO2_SETx.  Adem√°s, para poder medir el consumo real en el bus correspondiente, tambi√©n puentear√© el puente JP1 / JP2 / JP3 al peine. <br><br>  Para finalizar el tema de las fuentes de alimentaci√≥n, debemos mencionar la potencia de la pantalla.  Escrib√≠ un poco m√°s alto que, en nombre de la compacidad, tuve que abandonar el m√≥dulo de pantalla comprado y levantar la pantalla con la correa en mi pizarra.  Esta pantalla requiere un convertidor de refuerzo especial de 7-16V.  Convenientemente, esta fuente se puede encender y apagar usando la se√±al EN.  El circuito en s√≠ se copia de la hoja de datos del amplificador, exactamente lo mismo se usa en los m√≥dulos de visualizaci√≥n con ali. <br><br><img src="https://habrastorage.org/webt/oi/bd/zm/oibdzmvkie49fxcjamxcvszh9gw.png"><br><br><div class="spoiler">  <b class="spoiler_title">PT1505</b> <div class="spoiler_text">  Navegando por Internet en busca de alternativas al chip PT1502, me encontr√© con su hermana mayor, el chip PT1505.  Este es casi el mismo controlador de potencia, pero con una actualizaci√≥n adicional.  Con tal controlador, ser√≠a posible reducir el n√∫mero de elementos en el tablero.  Desafortunadamente, no encontr√© chips PT1505 a la venta. <br><br>  Por cierto, te agradecer√© si conoces controladores de potencia similares de otros fabricantes. <br></div></div><br>  Ahora un poco sobre el poder del microcontrolador.  El microcircuito es grande y tiene 6 l√≠neas de alimentaci√≥n: 4 para la parte digital, 1 fuente de alimentaci√≥n anal√≥gica y una para el reloj.  De acuerdo con la hoja de datos en el STM32F103, en todas las l√≠neas de alimentaci√≥n (tal vez, excepto el reloj), debe haber un condensador de 100nF a lo largo del condensador, y uno m√°s com√∫n a 4.7uF. <br><br>  Pero en la hoja de datos del STM32F4 se dice que aunque los microcontroladores son pr√°cticamente compatibles en t√©rminos de salidas, todav√≠a tienen esquemas de energ√≠a algo diferentes.  Entonces, en los dos terminales debe haber condensadores de 2.2 mkF entre el terminal y la tierra (y no entre la tierra y la potencia, como en F1).  Por lo tanto, tuve que considerar ambas opciones y un microcontrolador espec√≠fico para soldar solo una parte de los condensadores. <br><br><img src="https://habrastorage.org/webt/vv/ai/a4/vvaia45dk-cjpdj9jrypfecczug.png"><br><br>  Continuando con el tema de la nutrici√≥n, debe descubrir c√≥mo medirlo.  Puede confiar en la se√±al BAT_LOW y pedirle al usuario que se acurruque r√°pidamente si la bater√≠a est√° baja.  Pero esto es exactamente lo que no me gust√≥ en el Holux M-241 original, porque  Esta se√±al apareci√≥ demasiado tarde y fue f√°cil pasarla por alto.  Necesito alg√∫n tipo de indicador m√°s informativo de la energ√≠a de la bater√≠a. <br><br><img src="https://habrastorage.org/webt/2r/6l/0g/2r6l0gd1bdyewq--m8zij_nugxs.png"><br><br>  Por si acaso, pongo el divisor m√°s com√∫n para medir el voltaje de la bater√≠a.  Pero en el caso de las bater√≠as de litio, esto es solo un indicador informativo y no se debe confiar en √©l.  Para lecturas m√°s honestas de la bater√≠a en Internet, sugieren utilizar un "colgante". <br><br><img src="https://habrastorage.org/webt/an/3u/nc/an3uncm2tjzd-pu3n6ns8vqnhz0.png"><br><br>  Este peque√±o microchip cuenta la cantidad de energ√≠a que ha pasado a trav√©s de √©l hacia o desde la bater√≠a.  Las mediciones se realizan en la derivaci√≥n R10.  Las lecturas del microcircuito se pueden leer a trav√©s de I2C.  El microcircuito puede medir el voltaje en la bater√≠a, la corriente que pasa a trav√©s de la resistencia y tambi√©n multiplicarse uno por el otro.  Desafortunadamente, ella no sabe c√≥mo acumular el valor de las horas que han pasado por Watt *, por lo tanto, tendr√° que hacer una encuesta constante. <br><br>  Pasemos a la parte digital.  El coraz√≥n de todo el sistema es el microcontrolador STM32F103RB. <br><br><img src="https://habrastorage.org/webt/hm/ws/ma/hmwsma-hii28gwjrskmvmfsytl4.png"><br><br>  El fleje en forma de dos cuarzos se tom√≥ de otros esquemas encontrados en Internet (verificados dos veces en la hoja de datos).  No necesito arrancar desde la RAM, sino porque la se√±al BOOT1 lleg√≥ al suelo.  BOOT0 se puede seleccionar con un puente para arrancar desde la memoria flash principal o el gestor de arranque UART incorporado (por ejemplo, para el firmware principal del dispositivo) <br><br>  El siguiente es el LED. <br><br><img src="https://habrastorage.org/webt/ja/bg/ah/jabgahdeoppmxzipfiqu5mpd9dq.png"><br><br>  Dado que el voltaje de alimentaci√≥n principal variar√° de 2 a 3.3V, los LED no deben conectarse a √©l; el brillo y el consumo de corriente variar√°n enormemente.  Por lo tanto, los LED I se conectar√°n al bus de 2.7V, las resistencias limitadoras de corriente se calculan en consecuencia.  Dado que el microcontrolador no podr√° entregar m√°s de 2V en su pie cuando funciona con una bater√≠a, el modo GPIO push-pull no se puede usar.  Solo drenaje abierto. <br><br>  No hay nada especial que decir sobre el bot√≥n de reinicio. <br><br><img src="https://habrastorage.org/webt/6x/eq/is/6xeqise0ghoatscub44uzcykfoq.png"><br><br>  Dado que un dispositivo de tres voltios (INA219) estar√° sentado en el bus I2C, tambi√©n debe hacer llaves de tres voltios <br><br><img src="https://habrastorage.org/webt/xj/yi/n7/xjyin76yz6g_sg7vo9t2s4eqrms.png"><br><br>  Un conector SWD tambi√©n es est√°ndar.  Se necesita un diodo para cambiar la alimentaci√≥n entre la bater√≠a y la alimentaci√≥n externa del programador. <br><br><img src="https://habrastorage.org/webt/vl/s7/pw/vls7pw9grlfznf3gfo1_yglclqw.png"><br><br>  Anticipando las exclamaciones de que no hacen esto y que tal conexi√≥n realmente no desconecta la bater√≠a.  S√≠, no se apaga, pero el diodo no es para esto.  Esto es necesario para poder alimentar el dispositivo desde el programador si la bater√≠a no est√° conectada.  Y si est√° conectado, entonces d√©jelo funcionar.  Bueno, si la bater√≠a est√° conectada, debe proteger el programador de 4.2V en la bater√≠a. <br><br>  Pero los botones deber√≠an detenerse con m√°s detalle. <br><br><img src="https://habrastorage.org/webt/gg/du/gi/ggdugivqqx7iqjimaqwkbsiehru.png"><br><br>  El hecho es que el primer bot√≥n no solo ser√° un bot√≥n, sino que tambi√©n funcionar√° como un interruptor de dispositivo: la se√±al BTN1 est√° conectada al chip del controlador de potencia PT1502.  Cuando el dispositivo est√° apagado, no se suministra energ√≠a al microcontrolador ni a otros consumidores.  Es por eso que el bot√≥n est√° conectado no a la alimentaci√≥n (VCC) sino a la bater√≠a (BAT).  Al presionar este bot√≥n, el PT1502 encender√° todas las fuentes de energ√≠a e iniciar√° el microcontrolador.  Despu√©s de eso, el bot√≥n puede funcionar como un bot√≥n normal.  Para no quemar el microcontrolador con un alto voltaje de la bater√≠a, constru√≠ un peque√±o divisor de voltaje que impulsa la se√±al BTN1 en los cuadros necesarios (sin embargo, es posible sin esto: el microcontrolador tiene entradas que son tolerantes a 5V) <br><br>  El segundo bot√≥n no es notable.  Dentro del procesador, se incluir√° un tir√≥n al suelo, y el bot√≥n alimentar√° una unidad a la l√≠nea ... <br><br>  Contin√∫a sin problemas hacia la periferia pesada.  USB <br><br><img src="https://habrastorage.org/webt/hj/vn/tg/hjvntgq_-3sjzwjv03t0dqd--gg.png"><br><br>  El conector USB sobresaldr√° del dispositivo y la electricidad est√°tica puede caminar hasta all√≠.  Resulta que hay microcircuitos especiales (como STF202-22) que protegen a los microcontroladores de las influencias externas. <br><br>  Pero algo m√°s es interesante aqu√≠.  Una resistencia de 1.5k est√° oculta dentro del chip STF202, que est√° conectado entre la pata VBUS y la l√≠nea D +.  Esta resistencia es necesaria de acuerdo con la especificaci√≥n USB: le dice al host que est√° atascado en algo.  En muchos circuitos, esta resistencia siempre est√° conectada entre la alimentaci√≥n y la l√≠nea D +.  Tan pronto como el host ve una resistencia de este tipo en la l√≠nea D +, inmediatamente comienza a comunicarse con el dispositivo.  Esto no siempre es apropiado, ya que  Es posible que algunos dispositivos no est√©n listos de inmediato para la comunicaci√≥n. <br><br>  Este es solo mi caso.  Hay un simple truco para esto (espiado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> ).  Puede encender y apagar esta resistencia usando un transistor: queremos comunicaci√≥n - prendemos la resistencia, solo queremos que nos alimente por USB - ap√°guela.  Cuando conecta su tel√©fono m√≥vil en USB, generalmente pregunta "¬øqu√© haremos?  ¬øFusi√≥n de datos o solo carga?  - en t√©rminos de electr√≥nica, se trata solo de conectar una resistencia pull-up. <br><br>  Pero, ¬øc√≥mo saber si un dispositivo est√° atascado en USB?  Para hacer esto, proporcion√© la se√±al USB_PLUGGED, que se elimina del divisor m√°s simple. <br><br><img src="https://habrastorage.org/webt/hx/lr/u5/hxlru5qf7wv13uxeseybbyhhpdi.png"><br><br>  Los 5V del USB tambi√©n podr√≠an alimentarse directamente al pie del microcontrolador; todav√≠a son tolerantes a los 5V.  Pero que ya sea a trav√©s del divisor. <br><br>  Aceler√≥metro ahora <br><br><img src="https://habrastorage.org/webt/-g/t1/5j/-gt15jf_cub3nubnrpsbr5hiusa.png"><br><br>  El esquema se toma de una hoja de datos.  El m√≥dulo est√° conectado a trav√©s de I2C, pero para indicarle al microcontrolador que hay novedades, tambi√©n se utiliza una l√≠nea de interrupci√≥n.  Adem√°s, dado que el INA219 de tres voltios todav√≠a est√° colgando en el mismo bus I2C, las patas de comunicaci√≥n del aceler√≥metro tambi√©n se alimentan del bus 3B para coordinar los niveles. <br><br>  Ya mencion√© que me gustar√≠a ahorrar energ√≠a y apagar los electrodom√©sticos no utilizados.  Entonces el transistor activa la potencia del aceler√≥metro. <br><br>  Por cierto, me gust√≥ mucho la llamada  Transistores digitales: un transistor completo con dos resistencias.  Esto ahorra un poco de espacio en el tablero.  Es una l√°stima que con una potencia de dos voltios, no pudiera recoger un transistor digital con al menos una corriente decente, 20-30 mA como m√°ximo.  As√≠ que los consumidores m√°s voraces tuvieron que estar conectados con MOSFET. <br><br>  Adelante GPS <br><br><img src="https://habrastorage.org/webt/vr/l-/hm/vrl-hm0a27os6lit3ont256xd1g.png"><br><br>  El GPS est√° ubicado en una placa separada y est√° conectado a trav√©s de un bucle invertido.  Como todav√≠a no me he decidido por el m√≥dulo GPS, proporcion√© 2 fuentes de alimentaci√≥n diferentes.  Adem√°s del transistor de potencia en el lado de la placa del procesador, no hay nada m√°s interesante. <br><br>  Solo dir√© algunas palabras sobre los UART.  Inicialmente, plane√© usar los 3: uno para cargar firmware y depurar, el segundo para GPS y el tercero para Bluetooth.  Pero result√≥ que UART3 est√° en los mismos pines que I2C No. 2, que originalmente plane√© usar para la pantalla.  Tuve que elegir.  Como resultado, llegu√© a la conclusi√≥n de que puedo cargar firmware y depurar a trav√©s del mismo UART que est√° reservado para GPS (por supuesto, el GPS tendr√° que estar desactivado).  Bueno, si necesita debutar el GPS en s√≠, es decir, USB CDC (en el que puede cargar registros) y SWD.  Un poco m√°s tarde, abandon√© la idea de usar I2C No. 2, por lo que UART3 se liber√≥, pero en nombre de ahorrar bater√≠a, decid√≠ centrarme en dos UART. <br><br>  Bluetooth <br><br><img src="https://habrastorage.org/webt/r2/m6/zt/r2m6ztztpabt1_2yprjrdava5nq.png"><br><br>  Bluetooth est√° conectado de acuerdo con el esquema de la hoja de datos.  Pin PIO1 puede funcionar en dos modos.  En el primero, se conecta un LED y el m√≥dulo parpadea con este LED.  Diferentes gui√±os significan un estado diferente.  En otro modo, este pin funciona como uno digital: uno cuando se establece la comunicaci√≥n y 0 si no.  Los modos se cambian mediante comandos AT durante la inicializaci√≥n del m√≥dulo. <br><br>  Tarjeta SD <br><br>  Aunque el esquema de conexi√≥n de la tarjeta SD es est√°ndar, por alguna raz√≥n fue muy dif√≠cil para m√≠.  Hay demasiadas opciones de conexi√≥n diferentes en Internet y no es tan f√°cil determinar cu√°l es la correcta. <br><br><img src="https://habrastorage.org/webt/9g/mi/xh/9gmixhnhcfhlo0s98wcmfz1dubk.png"><br><br>  En su mayor parte, ten√≠a preguntas en bujes.  De vez en cuando hay esquemas donde ponen resistencias en 1k.  Algunos circuitos ponen resistencias de 22 ohmios, aparentemente como protecci√≥n contra la est√°tica.  Sin embargo, la mayor√≠a de los circuitos no ofrecen resistencias de paso, y probablemente seguir√© el mismo camino.  Tampoco tendr√© estad√≠sticas desde  La unidad flash vivir√° dentro de la carcasa. <br><br>  Me parece que el transistor de potencia tampoco tendr√° demanda, creo que la tarjeta siempre funcionar√°, es un registrador.  Pero como se trata de un tablero de pruebas, que as√≠ sea.  Lo mismo sobre la bobina: aparentemente esta inclusi√≥n en el original se hizo paranoica, o la tarjeta se us√≥ en un entorno con poca potencia o interferencia.  Pienso soldar all√≠ una resistencia cero e intentar sin una bobina. <br><br>  Display <br><br>  Tuve la oportunidad de conectar uno de los m√≥dulos de pantalla con Ali a trav√©s de SPI y comparar con la conexi√≥n a trav√©s de I2C.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No hubo dificultades particulares y el c√≥digo solo necesitaba ser ligeramente desperdiciado. Al mismo tiempo, la velocidad de SPI es un orden de magnitud mayor que la de I2C. Despu√©s de agregar los datos de la hoja de datos sobre consumo (4 mA para SPI versus 10 mA para I2C), la necesidad de resistencias pull-up para I2C, decid√≠ conectar la pantalla a trav√©s de SPI. </font></font><br><br><img src="https://habrastorage.org/webt/zn/zx/yh/znzxyhs4tcmv4fyyhb-hfxzihns.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Desafortunadamente, la se√±al BS0 no se emite al bucle de visualizaci√≥n y, por lo tanto, no puede seleccionar el modo SPI de 3 hilos, solo puede SPI de 4 hilos. La diferencia en la l√≠nea D / C adicional (datos / comando), que en el caso del modo 3-Wire es transmitida por el noveno bit de los datos SPI. Sin embargo, tal vez el modo 4-Wire sea para mejor, porque SPI en STM32 solo puede transmitir 8 bits. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El resto del esquema corresponde a la hoja de datos. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Y finalmente, el chirrido. Nada especial: solo enci√©ndalo a trav√©s del transistor.</font></font><br><br><img src="https://habrastorage.org/webt/b9/nk/9u/b9nk9uzbod6oeswokssk4nhfvsq.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En caso de que haya un vibromotor en lugar de un tweeter, proporcion√© un diodo protector. </font><font style="vertical-align: inherit;">Sin embargo, escuch√© la opini√≥n de que un diodo protector tampoco da√±a el tweeter.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> En hierro </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arriba, describ√≠ mis pensamientos sobre el tema del cuerpo. De hecho, incluso intent√© criar una tabla para este caso. Desafortunadamente, el tablero era demasiado estrecho. Tuve que usar la instalaci√≥n a dos caras, cambiar de los componentes 1206 a 0805, pero de todos modos, los componentes en el tablero estaban muy apretados. Adem√°s, cada cambio en el esquema fue un dolor, porque Tuve que volver a reproducir casi la mitad del tablero. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As√≠ que jugu√© con ella durante varias semanas, pero la junta me derrot√≥ y abandon√© el proyecto durante casi un a√±o. Kick convertirse </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqu√≠ este art√≠culo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Pero realmente, esto es solo un prototipo, y el primero de varios. ¬øPor qu√© molestarse con una placa s√∫per compacta, donde no puede gatear con un soldador o un osciloscopio, si puede depurar todo en una placa grande?</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bueno, no tienes que hacer una placa tan grande como un iPhone, pero es muy posible entrar en las capas promocionales de 100x100mm 2 de JLCPCB. </font><font style="vertical-align: inherit;">Pr√°cticamente puedes limitarte. </font><font style="vertical-align: inherit;">Por lo tanto, en el tablero hay una gran pantalla de 2.42 ", puentes para medir el consumo en todas las l√≠neas de alimentaci√≥n, condensadores de potencia donde necesita y no necesita, y en general un mont√≥n de piezas que no se pueden instalar. </font><font style="vertical-align: inherit;">Todav√≠a queda un lugar.</font></font><br><br><img src="https://habrastorage.org/webt/nm/ig/vr/nmigvrrichuyvfy4vddfogpnquu.png"><br><br><img src="https://habrastorage.org/webt/sr/cy/ed/srcyeditmbixylghywsn15j-qas.png"><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Est√° en la vista de fotos</font></font></b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/d-/co/ru/d-coru_uwsrkpvz44tirfmisedg.png"><br><br><img src="https://habrastorage.org/webt/5w/pq/xk/5wpqxktdsgqt1auvgeh4wnhbaz4.png"><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No hay mucho que contar sobre el cableado. Separ√© la mayor√≠a de las l√≠neas de se√±al y campo a lo largo de la capa superior, mientras que la inferior estaba casi completamente enterrada bajo tierra. Desafortunadamente, el dise√±o todav√≠a result√≥ ser bastante denso y algunas l√≠neas de se√±al tuvieron que arrastrarse a lo largo de la capa inferior a trav√©s de la mitad del tablero. Debido a esto, la tierra est√° "desgarrada" en algunos lugares en varias islas poco conectadas. Espero que esto no sea un problema. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No hice la tierra debajo de la antena bluetooth, pero a√∫n as√≠ tuve que arrastrar una de las l√≠neas de se√±al a trav√©s de esta zona. Sin embargo, esta es la l√≠nea BT_ON, a lo largo de la cual las se√±ales a menudo no se ejecutan (se enciende o apaga all√≠), lo que significa que no deber√≠a afectar particularmente la se√±al.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se acercaba el verano y estaba planeando llevarme el alquiler de vacaciones. Para que las criadas en los hoteles no tengan miedo de una placa de depuraci√≥n desnuda con un abanico de cables, ser√≠a bueno ocultarla en el estuche. No pod√≠a negarme el placer y desarroll√© el caso y el tablero al mismo tiempo. As√≠ que hab√≠a tablas de montaje en la caja, montando el soporte de la pantalla. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El m√≥dulo GPS es un emparedado de varias placas y una antena de 12 mm de espesor. Decid√≠ no engancharlo en la parte superior del tablero, sino colocarlo en el mismo nivel. Esto redujo el grosor de la caja, pero mordi√≥ una esquina del tablero. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un par de fotos del tablero y el dispositivo final (en esta etapa del proyecto). </font></font><br><br><img src="https://habrastorage.org/webt/sr/yk/-g/sryk-gs6dpsw3cjk4mx7fhj4khw.jpeg"><br><br><img src="https://habrastorage.org/webt/i7/hm/im/i7hmimruqywcfpkw9q5qudxkyog.jpeg"><br><br><img src="https://habrastorage.org/webt/r_/wo/bj/r_wobjeewfmg8fohrp_nmehi1c4.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La bater√≠a se ajusta bien debajo de la pantalla, pero tuve que hacer una peque√±a caja para acercar la pantalla a la cubierta superior.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Algunas palabras en el tablero de montaje. Soldamos todo en aproximadamente 3 noches, y alrededor de una semana en las tardes me llev√≥ bastante tiempo depurar y verificar desde el lado del software. Para mi sorpresa, no hubo dificultades fundamentales con la configuraci√≥n del tablero y casi todo comenz√≥ como deber√≠a. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Result√≥ que soldar 0805 no era mucho m√°s dif√≠cil de soldar que 1206, es bastante comestible en casa con una lupa. Incluso puedes girar en 0603. Pero con la soldadura del microcontrolador y el conector de la pantalla (tienen un paso de 0,5 mm), tuve que jugar. En YouTube, de alguna manera se parece a la gente: lo pas√© con un soldador y eso es todo, pero todas mis conclusiones se quedaron instant√°neamente.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No sin problemas menores. En algunos lugares no se pod√≠a beber, en alg√∫n lugar hab√≠a un "moco". La huella del conector USB result√≥ estar equivocada: ten√≠a un paso de conclusiones que era menos de lo necesario (¬°as√≠ que conf√≠e despu√©s de esas huellas de Internet!). Tuve que doblar un poco las conclusiones para que se pusieran en marcha. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El conector de</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pantalla </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">FPC</font></a><font style="vertical-align: inherit;"> comprado en Ali result√≥ estar con los contactos a continuaci√≥n, mientras que lo necesitaba con los contactos en la parte superior (no hab√≠a sospechado tal diferencia antes). Tuve que "volar" el conector de la placa de visualizaci√≥n est√°ndar. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Despu√©s de meter la placa en la caja, result√≥ que no era posible desconectar la bater√≠a simplemente sacando el conector, pero no quer√≠a dejar la placa depurada energizada. Tuve que presionar un interruptor.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Al configurar la placa, result√≥ que no hab√≠a contacto con el suelo en ning√∫n lugar donde pudiera conectar la sonda al osciloscopio. Tuve que aferrarme al conector USB con un cocodrilo. Ser√° necesario proporcionar sitios de prueba en la pr√≥xima versi√≥n del tablero. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Los circuitos tambi√©n revelaron problemas. Por lo tanto, fue un hecho completamente inesperado que el chip PT1502 en el pin RESET genera un voltaje de 3V (estaba completamente seguro de que hab√≠a algo como un colector abierto). Como resultado, estos 3V se filtraron a la l√≠nea de alimentaci√≥n, a pesar de que planeaba tener solo 2V all√≠. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aqu√≠ hay un diagrama simplificado de lo que sucedi√≥. </font></font><br><img src="https://habrastorage.org/webt/ag/rw/tg/agrwtgjika-hvgzl_die2gokf4c.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gracias a la gran mente y los muchachos con easyelectronics.ru, esta uni√≥n se decidi√≥ agregando un diodo. Despu√©s de una peque√±a cirug√≠a, esta parte funcion√≥ como deber√≠a.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adem√°s, el m√≥dulo bluetooth (alimentado por 2.5V) me conect√© accidentalmente a la alimentaci√≥n principal (2V), en lugar del fijo de 3V. Ahora el bluetooth puede funcionar para m√≠ solo cuando el USB est√° conectado, cuando el voltaje de la alimentaci√≥n principal se eleva a 3.3V. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En principio, ser√≠a posible agitar el bistur√≠ y soldar el bluetooth a la potencia correcta, pero el UART2 al que est√° conectado el bluetooth no es tolerante a 5V (√©l mismo lo ley√≥ en la hoja de datos en la etapa de an√°lisis, √©l mismo lo not√≥ en el texto anterior, y finalmente se olvid√≥ cuando cable√≥ el tablero ) Por lo tanto, conectar el bluetooth a la alimentaci√≥n es mayor que la potencia del microcontrolador ... En la pr√≥xima versi√≥n de la placa, solo conecto el bluetooth a alg√∫n otro UART.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El convertidor DC-DC con voltaje variable tambi√©n funcion√≥ seg√∫n lo planeado: cuando funciona con una bater√≠a, emite 2V, y cuando conecta el USB se eleva a 3.16V (debe jugar con las clasificaciones y alcanzar 3.3V). Pero aqu√≠ sali√≥ una falla m√°s del circuito: tambi√©n debe ser capaz de aumentar el voltaje cuando es alimentado por el programador. Creo que esto se est√° tratando agregando otro diodo. Intentar√© jugar un poco m√°s tarde.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Finalmente, durante el trabajo en el tablero, todav√≠a no entend√≠a c√≥mo alimentar adecuadamente la tarjeta SD de bajo voltaje. Un peque√±o google no condujo a nada. Aparentemente, debe sumergirse en la lectura de especificaciones de p√°ginas reducidas (que, adem√°s, est√°n parcialmente cerradas). Mientras tanto, hice un cortocircuito en R7 y la placa ahora funciona con un 3.16V (3.3V) fijo. Lo dejar√© as√≠ durante los pr√≥ximos dos meses, mientras trabajar√© en la parte del software. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hablando de software. Sorprendentemente (aunque bastante esperado), pero en general todo comenz√≥ sin problemas. Como cambi√© entre microcontroladores de la misma serie (de F103CB a F103RC), no tuve que modificar la parte del software. Solo se corrigieron los n√∫meros de pin, pero se agreg√≥ la inclusi√≥n de transistores. Sin embargo, hubo 2 momentos no triviales con los que tuve que jugar.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El primero es la energ√≠a de la bater√≠a. </font><font style="vertical-align: inherit;">Depur√© la placa con alimentaci√≥n USB y todo funcion√≥ bien en general. </font><font style="vertical-align: inherit;">Pero la placa persistentemente no quer√≠a encender la bater√≠a.</font></font> Es decir<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Puede funcionar (si lo enciende cuando el USB est√° conectado y luego extrae el cable), pero no funciona para comenzar con uno fr√≠o. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Seg√∫n el dise√±o del chip PT1502, la placa deber√≠a comenzar as√≠. </font><font style="vertical-align: inherit;">El usuario presiona el bot√≥n BTN1 y despu√©s de un tercio de segundo el chip enciende todas las fuentes de energ√≠a. </font><font style="vertical-align: inherit;">Cuando todo est√° bien con la energ√≠a, el PT1502 "libera" la se√±al RESET, iniciando as√≠ el microcontrolador. </font><font style="vertical-align: inherit;">El procesador, a su vez, establece la se√±al PWR_HOLD en uno, indicando que se ha iniciado. </font><font style="vertical-align: inherit;">Despu√©s de eso, el PT1502 suministra regularmente electricidad al circuito hasta que el microcontrolador reduce la se√±al PWR_HOLD a cero.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pero esto es en teor√≠a. De hecho, tan pronto como el procesador configur√≥ la se√±al PWR_HOLD, la placa se apag√≥ al instante. Pas√© todo el circuito de alimentaci√≥n, mir√© las formas de onda de las se√±ales principales, baraj√© el c√≥digo en el gestor de arranque de un lado a otro, pero no pude entender el problema. Tambi√©n pequ√© por la ausencia de una resistencia desplegable en la l√≠nea PWR_HOLD, que olvid√© instalar, pero est√° recomendada por una hoja de datos (y lo m√°s probable es que todav√≠a sea necesaria). Pero agregarlo con un dosel no resolvi√≥ el problema. Y solo cuando prest√© un osciloscopio de cuatro canales, todo qued√≥ claro.</font></font><br><br><img src="https://habrastorage.org/webt/ix/ie/xf/ixiexf-lau1vggfbwu9ta4ys_hq.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cuando el usuario presiona el bot√≥n (l√≠nea naranja), el chip PT1502 enciende la alimentaci√≥n (l√≠nea p√∫rpura). Todo esto sucede mucho (300 ms) antes de los eventos en esta forma de onda. Y luego sucede algo interesante. PT1502 libera RESET (l√≠nea azul), el procesador se inicia y, por alguna raz√≥n, baja la l√≠nea del bot√≥n a cero. Aunque el microcontrolador todav√≠a est√° intentando elevar la l√≠nea POWER_HOLD (l√≠nea verde), es demasiado tarde, el PT1502 ya ha apagado todas las fuentes de alimentaci√≥n. Luego hay algunas convulsiones m√°s, pero el circuito a√∫n se apaga silenciosamente. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La pregunta es, ¬øde d√≥nde vino el cero en el bot√≥n? Todo el punto es un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">error discreto en el gestor de arranque</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , debido a que el tramo BTN1 se configur√≥ en el modo de salida (tal vez tambi√©n ocurrieron milagros en otros tramos en ese momento) y apareci√≥ una se√±al baja.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Con lo que m√°s tuvo que luchar es con la tarjeta SD. Simplemente no hab√≠a ning√∫n m√≥dulo SDIO en el antiguo microcontrolador, as√≠ que tuve que estudiar esta pieza desde cero. Pas√© casi todo el d√≠a tratando de obtener un mapa, copiando fragmentos de c√≥digo de ejemplos en Internet y lo que gener√≥ CubeMX. Aunque la tarjeta era perfectamente legible en una computadora, persistentemente no quer√≠a comenzar en mi circuito. Pequ√© por una soldadura deficiente, resistencias pull-up incorrectamente seleccionadas, circuitos torpes y hojas de datos interpretadas incorrectamente. Pero para mi sorpresa, otra tarjeta con el mismo c√≥digo y en el mismo tablero se inici√≥ sin problemas. Ser√° necesario estudiar este tema con m√°s detalle.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hubo otro problema con la tarjeta. Tocando diferentes l√≠neas con un osciloscopio, vi actividad solo en la l√≠nea D0, mientras que en D1-D3 hubo silencio: la tarjeta funcionaba en modo de un solo bit. En HAL, incluso se encontr√≥ la funci√≥n HAL_SD_ConfigWideBusOperation (), que puede habilitar el modo de transferencia de 4 bits. Desafortunadamente, cuando la tarjeta se cambi√≥ al modo de 4 bits, los perif√©ricos SDIO entraron en el RX FIFO Overrun profundo y dejaron de funcionar.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El problema result√≥ ser muy interesante. </font><font style="vertical-align: inherit;">Result√≥ que dentro de la funci√≥n HAL_SD_ReadBlocks () hay un cierto bucle que sondea las banderas SDIO. </font><font style="vertical-align: inherit;">A medida que llegan nuevos datos de la tarjeta, este c√≥digo transfiere los bytes del b√∫fer interno FIFO a la memoria del usuario. </font><font style="vertical-align: inherit;">Entonces, la tarjeta transmiti√≥ bytes tan r√°pido que el c√≥digo en HAL_SD_ReadBlocks () simplemente no tuvo tiempo para transferir los datos. </font><font style="vertical-align: inherit;">Tuve que bajar temporalmente la frecuencia del reloj de la tarjeta. </font><font style="vertical-align: inherit;">Bueno, en el futuro usar√© DMA y tal problema no deber√≠a surgir en principio.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Conclusi√≥n y pr√≥ximos pasos. </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Los que en este lugar esperaban ver el dispositivo terminado tendr√© que decepcionarlo: solo se completa el tablero de prueba, e incluso eso, solo la pieza de hierro. Ahora necesitas darle vida, programar, ajustar los modos y el consumo. Bueno, en realidad escriba un c√≥digo de registro; es por eso que se inici√≥ todo el proyecto. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sin embargo, para m√≠ personalmente esta etapa es un logro muy grande e importante. La electr√≥nica no es mi especialidad y estoy muy contento de que el dispositivo incluso se haya iniciado. Logr√© bombear lo suficiente para dise√±ar circuitos, combinar varios dispositivos, cablear la placa, elegir componentes y mucho m√°s.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hablar√© sobre el software en otra parte. </font><font style="vertical-align: inherit;">Adem√°s de los matices de la configuraci√≥n. </font><font style="vertical-align: inherit;">El hecho es que todo este relleno debe primero revivirse y probarse. </font><font style="vertical-align: inherit;">Por el momento, logramos iniciar todos los dispositivos en el tablero (bueno, excepto el tweeter), pero solo en la cantidad de "comenz√≥ y de alguna manera responde". </font><font style="vertical-align: inherit;">A√∫n no se ha escrito l√≥gica de procesamiento. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Planes para el futuro cercano:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conduzca la electr√≥nica en diferentes modos, verifique que el circuito a√∫n funcione. </font><font style="vertical-align: inherit;">Arreglar jambas en la segunda versi√≥n del tablero</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Mida el consumo de toda la periferia y encuentre formas de optimizar el consumo. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ensamble varias opciones de placa en diferentes microcontroladores (por ejemplo, L152 o L433) </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Lea atentamente la especificaci√≥n SD y descubra c√≥mo conectar correctamente la tarjeta en modo de se√±alizaci√≥n de bajo voltaje (1.8V) </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Prueba diferentes m√≥dulos de GPS y finalmente decide cu√°l ir√© a continuaci√≥n </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ordene un chip de br√∫jula separado (por ejemplo, HMC5883L o HSCDTD008A) e intente usarlos de alguna manera </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Realice la refactorizaci√≥n interna del c√≥digo, actualice todas las bibliotecas principales, comenzando con HAL </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Finalmente, comience a escribir caracter√≠sticas. </font><font style="vertical-align: inherit;">Implemente realmente para qu√© fue dise√±ado el dispositivo</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En esto, perm√≠tame despedirme. </font><font style="vertical-align: inherit;">Agradecer√≠a comentarios constructivos, ideas y consejos sobre dise√±o de circuitos y dise√±o de placas de circuitos. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fuentes: </font></font><br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥digo </font></font></a> <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">de c√≥digo gestor de arranque </font></font></a> <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Plata </font></font></a> <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Viviendas</font></font></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/454434/">https://habr.com/ru/post/454434/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../454436/index.html">Petty Petty Joy # 1: loguru</a></li>
<li><a href="../454440/index.html">Petty Little Fun # 2: Starlette</a></li>
<li><a href="../454442/index.html">C√≥mo elegir una red proxy para su negocio: 3 consejos pr√°cticos</a></li>
<li><a href="../454444/index.html">Perfilamos la carga de Habr o c√≥mo 189 solicitudes en la p√°gina representan influencia</a></li>
<li><a href="../454446/index.html">¬øQu√© hay de nuevo en C # 8?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>