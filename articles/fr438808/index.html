<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ùóÔ∏è ‚ùÑÔ∏è üÜó ModelMapper: aller-retour üßìüèº üë©üèæ‚ÄçüöÄ ü•ò</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pour des raisons bien connues, le backend ne peut pas renvoyer les donn√©es du r√©f√©rentiel telles quelles. Le plus c√©l√®bre - les d√©pendances essentiell...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ModelMapper: aller-retour</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/438808/"><img src="https://habrastorage.org/webt/pv/af/jp/pvafjpvwzjks_dgn_429dotjm5g.jpeg" alt="image"><br><br>  Pour des raisons bien connues, le backend ne peut pas renvoyer les donn√©es du r√©f√©rentiel telles quelles.  Le plus c√©l√®bre - les d√©pendances essentielles ne sont pas prises de la base sous la forme dans laquelle le front peut les comprendre.  Ici, vous pouvez ajouter des difficult√©s avec l'analyse enum (si les champs enum contiennent des param√®tres suppl√©mentaires) et de nombreuses autres difficult√©s r√©sultant de la conversion automatique de type (ou de l'impossibilit√© de les convertir automatiquement).  Cela implique la n√©cessit√© d'utiliser un objet de transfert de donn√©es - DTO, qui est compr√©hensible √† la fois pour l'arri√®re et l'avant. <a name="habracut"></a><br>  La conversion d'une entit√© en DTO peut se faire de diff√©rentes mani√®res.  Vous pouvez utiliser la biblioth√®que, vous pouvez (si le projet est petit) assembler quelque chose comme ceci: <br><br><pre><code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ItemMapperImpl</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ItemMapper</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> OrderRepository orderRepository; <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ItemMapperImpl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(OrderRepository orderRepository)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.orderRepository = orderRepository; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Item </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toEntity</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ItemDto dto)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Item( dto.getId(), obtainOrder(dto.getOrderId()), dto.getArticle(), dto.getName(), dto.getDisplayName(), dto.getWeight(), dto.getCost(), dto.getEstimatedCost(), dto.getQuantity(), dto.getBarcode(), dto.getType() ); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ItemDto </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toDto</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Item item)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ItemDto( item.getId(), obtainOrderId(item), item.getArticle(), item.getName(), item.getDisplayName(), item.getWeight(), item.getCost(), item.getEstimatedCost(), item.getQuantity(), item.getBarcode(), item.getType() ); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Long </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">obtainOrderId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Item item)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Objects.nonNull(item.getOrder()) ? item.getOrder().getId() : <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Order </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">obtainOrder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Long orderId)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Objects.nonNull(orderId) ? orderRepository.findById(orderId).orElse(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) : <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } }</code> </pre> <br>  Ces mappeurs auto-√©crits pr√©sentent des inconv√©nients √©vidents: <br><br><ol><li>  Ne pas mettre √† l'√©chelle. </li><li>  Lorsque vous ajoutez / supprimez m√™me le champ le plus insignifiant, vous devrez modifier le mappeur. </li></ol><br>  Par cons√©quent, la bonne solution consiste √† utiliser une biblioth√®que de mappage.  Je connais modelmapper et mapstruct.  Depuis que je travaille avec modelmapper, je vais en parler, mais si vous, mon lecteur, connaissez bien mapstruct et pouvez parler de toutes les subtilit√©s de son application, √©crivez un article √† ce sujet, et je serai le premier √† me l'√©crire (cette biblioth√®que est aussi tr√®s int√©ressant, mais il n'y a pas encore le temps d'y entrer). <br><br>  Alors modelmapper. <br><br>  Je veux dire tout de suite que si quelque chose n'est pas clair pour vous, vous pouvez t√©l√©charger le projet fini avec un test de travail, un lien √† la fin de l'article. <br><br>  La premi√®re √©tape consiste, bien s√ªr, √† ajouter une d√©pendance.  J'utilise gradle, mais il vous est facile d'ajouter une d√©pendance √† votre projet maven. <br><br><pre> <code class="java hljs">compile group: <span class="hljs-string"><span class="hljs-string">'org.modelmapper'</span></span>, name: <span class="hljs-string"><span class="hljs-string">'modelmapper'</span></span>, version: <span class="hljs-string"><span class="hljs-string">'2.3.2'</span></span></code> </pre> <br>  Cela suffit pour que le mappeur fonctionne.  Ensuite, nous devons cr√©er un bac. <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ModelMapper </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">modelMapper</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ ModelMapper mapper = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ModelMapper(); mapper.getConfiguration() .setMatchingStrategy(MatchingStrategies.STRICT) .setFieldMatchingEnabled(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) .setSkipNullEnabled(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) .setFieldAccessLevel(PRIVATE); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mapper; }</code> </pre> <br>  Habituellement, il suffit de renvoyer simplement un nouveau ModelMapper, mais il ne sera pas superflu de configurer le mappeur pour nos besoins.  J'ai d√©fini une strat√©gie de correspondance stricte, activ√© le mappage des champs, ignor√© les champs nuls et d√©fini un niveau d'acc√®s priv√© aux champs. <br><br>  Ensuite, cr√©ez la structure d'entit√© suivante.  Nous aurons une licorne, qui aura un certain nombre de dro√Ødes subordonn√©s, et chaque dro√Øde aura un certain nombre de cupcakes. <br><br><div class="spoiler">  <b class="spoiler_title">Entit√©s</b> <div class="spoiler_text"><blockquote>  Parent abstrait: </blockquote><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@MappedSuperclass</span></span> <span class="hljs-meta"><span class="hljs-meta">@Setter</span></span> <span class="hljs-meta"><span class="hljs-meta">@EqualsAndHashCode</span></span> <span class="hljs-meta"><span class="hljs-meta">@NoArgsConstructor</span></span> <span class="hljs-meta"><span class="hljs-meta">@AllArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractEntity</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Serializable</span></span></span><span class="hljs-class"> </span></span>{ Long id; LocalDateTime created; LocalDateTime updated; <span class="hljs-meta"><span class="hljs-meta">@Id</span></span> <span class="hljs-meta"><span class="hljs-meta">@GeneratedValue</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Long </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> id; } <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"created"</span></span>, updatable = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> LocalDateTime </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCreated</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> created; } <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"updated"</span></span>, insertable = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> LocalDateTime </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getUpdated</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> updated; } <span class="hljs-meta"><span class="hljs-meta">@PrePersist</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ setCreated(LocalDateTime.now()); } <span class="hljs-meta"><span class="hljs-meta">@PreUpdate</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toUpdate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ setUpdated(LocalDateTime.now()); } }</code> </pre> <br><blockquote>  Licorne: </blockquote><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Entity</span></span> <span class="hljs-meta"><span class="hljs-meta">@Table</span></span>(name = <span class="hljs-string"><span class="hljs-string">"unicorns"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@EqualsAndHashCode</span></span>(callSuper = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Setter</span></span> <span class="hljs-meta"><span class="hljs-meta">@AllArgsConstructor</span></span> <span class="hljs-meta"><span class="hljs-meta">@NoArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Unicorn</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractEntity</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String name; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;Droid&gt; droids; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Color color; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Unicorn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name, Color color)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.name = name; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.color = color; } <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"name"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> name; } <span class="hljs-meta"><span class="hljs-meta">@OneToMany</span></span>(fetch = FetchType.EAGER, cascade = CascadeType.ALL, mappedBy = <span class="hljs-string"><span class="hljs-string">"unicorn"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> List&lt;Droid&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDroids</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> droids; } <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"color"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Color </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getColor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> color; } }</code> </pre> <br><blockquote>  Droid: </blockquote><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Setter</span></span> <span class="hljs-meta"><span class="hljs-meta">@EqualsAndHashCode</span></span>(callSuper = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Entity</span></span> <span class="hljs-meta"><span class="hljs-meta">@Table</span></span>(name = <span class="hljs-string"><span class="hljs-string">"droids"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@AllArgsConstructor</span></span> <span class="hljs-meta"><span class="hljs-meta">@NoArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Droid</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractEntity</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String name; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Unicorn unicorn; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;Cupcake&gt; cupcakes; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Boolean alive; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Droid</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name, Unicorn unicorn, Boolean alive)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.name = name; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.unicorn = unicorn; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.alive = alive; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Droid</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name, Boolean alive)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.name = name; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.alive = alive; } <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"name"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> name; } <span class="hljs-meta"><span class="hljs-meta">@ManyToOne</span></span>(fetch = FetchType.EAGER) <span class="hljs-meta"><span class="hljs-meta">@JoinColumn</span></span>(name = <span class="hljs-string"><span class="hljs-string">"unicorn_id"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Unicorn </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getUnicorn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> unicorn; } <span class="hljs-meta"><span class="hljs-meta">@OneToMany</span></span>(fetch = FetchType.EAGER, cascade = CascadeType.ALL, mappedBy = <span class="hljs-string"><span class="hljs-string">"droid"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> List&lt;Cupcake&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCupcakes</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cupcakes; } <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"alive"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Boolean </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAlive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> alive; } }</code> </pre> <br><blockquote>  Cupcake: </blockquote><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Entity</span></span> <span class="hljs-meta"><span class="hljs-meta">@Table</span></span>(name = <span class="hljs-string"><span class="hljs-string">"cupcakes"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Setter</span></span> <span class="hljs-meta"><span class="hljs-meta">@EqualsAndHashCode</span></span>(callSuper = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) <span class="hljs-meta"><span class="hljs-meta">@AllArgsConstructor</span></span> <span class="hljs-meta"><span class="hljs-meta">@NoArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Cupcake</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractEntity</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Filling filling; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Droid droid; <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"filling"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Filling </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getFilling</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> filling; } <span class="hljs-meta"><span class="hljs-meta">@ManyToOne</span></span>(fetch = FetchType.EAGER) <span class="hljs-meta"><span class="hljs-meta">@JoinColumn</span></span>(name = <span class="hljs-string"><span class="hljs-string">"droid_id"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Droid </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDroid</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> droid; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Cupcake</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Filling filling)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.filling = filling; } }</code> </pre> <br></div></div><br>  Nous convertirons ces entit√©s en DTO.  Il existe au moins deux approches pour convertir les d√©pendances d'une entit√© en DTO.  L'une implique de ne sauvegarder que l'ID au lieu de l'entit√©, mais ensuite chaque entit√© de la d√©pendance, si n√©cessaire, nous tirerons en plus l'ID.  La deuxi√®me approche consiste √† garder le DTO d√©pendant.  Donc, dans la premi√®re approche, nous convertirions les dro√Ødes de liste en dro√Ødes de liste (nous stockons uniquement les ID dans la nouvelle liste), et dans la deuxi√®me approche, nous enregistrerons dans les dro√Ødes de liste. <br><br><div class="spoiler">  <b class="spoiler_title">DTO</b> <div class="spoiler_text"><blockquote>  Parent abstrait: </blockquote><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Data</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractDto</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Serializable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long id; <span class="hljs-meta"><span class="hljs-meta">@JsonFormat</span></span>(shape = JsonFormat.Shape.STRING, pattern = <span class="hljs-string"><span class="hljs-string">"yyyy-MM-dd HH:mm:ss.SSS"</span></span>) LocalDateTime created; <span class="hljs-meta"><span class="hljs-meta">@JsonFormat</span></span>(shape = JsonFormat.Shape.STRING, pattern = <span class="hljs-string"><span class="hljs-string">"yyyy-MM-dd HH:mm:ss.SSS"</span></span>) LocalDateTime updated; }</code> </pre> <br><blockquote>  UnicornDto: </blockquote><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@EqualsAndHashCode</span></span>(callSuper = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Data</span></span> <span class="hljs-meta"><span class="hljs-meta">@NoArgsConstructor</span></span> <span class="hljs-meta"><span class="hljs-meta">@AllArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UnicornDto</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractDto</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String name; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;DroidDto&gt; droids; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String color; }</code> </pre> <br><blockquote>  DroidDto: </blockquote><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@EqualsAndHashCode</span></span>(callSuper = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Data</span></span> <span class="hljs-meta"><span class="hljs-meta">@NoArgsConstructor</span></span> <span class="hljs-meta"><span class="hljs-meta">@AllArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DroidDto</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractDto</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String name; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;CupcakeDto&gt; cupcakes; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> UnicornDto unicorn; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Boolean alive; }</code> </pre> <br><blockquote>  CupcakeDto: </blockquote><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@EqualsAndHashCode</span></span>(callSuper = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Data</span></span> <span class="hljs-meta"><span class="hljs-meta">@NoArgsConstructor</span></span> <span class="hljs-meta"><span class="hljs-meta">@AllArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CupcakeDto</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractDto</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String filling; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> DroidDto droid; }</code> </pre> <br></div></div><br>  Pour affiner le mappeur selon nos besoins, nous devrons cr√©er notre propre classe wrapper et red√©finir la logique de mappage des collections.  Pour ce faire, nous cr√©ons une classe de composants UnicornMapper, y mappons automatiquement notre mappeur et red√©finissons les m√©thodes dont nous avons besoin. <br><br>  La version la plus simple de la classe wrapper ressemble √† ceci: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UnicornMapper</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ModelMapper mapper; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Unicorn </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toEntity</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(UnicornDto dto)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Objects.isNull(dto) ? <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> : mapper.map(dto, Unicorn.class); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> UnicornDto </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toDto</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Unicorn entity)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Objects.isNull(entity) ? <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> : mapper.map(entity, UnicornDto.class); } }</code> </pre> <br>  Maintenant, il nous suffit de c√¢bler automatiquement notre mappeur dans un service et de tirer en utilisant les m√©thodes toDto et toEntity.  Le mappeur transformera les entit√©s trouv√©es dans l'objet en DTO, DTO - en entit√©s. <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UnicornServiceImpl</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UnicornService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> UnicornRepository repository; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> UnicornMapper mapper; <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UnicornServiceImpl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(UnicornRepository repository, UnicornMapper mapper)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.repository = repository; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.mapper = mapper; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> UnicornDto </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">save</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(UnicornDto dto)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mapper.toDto(repository.save(mapper.toEntity(dto))); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> UnicornDto </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Long id)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mapper.toDto(repository.getOne(id)); } }</code> </pre> <br>  Mais si nous essayons de convertir quelque chose de cette mani√®re, puis d'appeler, par exemple, toString, nous obtiendrons une StackOverflowException, et voici pourquoi: UnicornDto contient la liste DroidDto, qui contient UnicornDto, qui contient DroidDto, et ainsi de suite jusqu'√† ce moment jusqu'√† √©puisement de la m√©moire de la pile.  Par cons√©quent, pour les d√©pendances inverses, j'utilise g√©n√©ralement non UnicornDto unicorn, mais Long unicornId.  De cette fa√ßon, nous restons en contact avec Unicorn, mais nous coupons la d√©pendance cyclique.  Corrigeons nos DTO afin qu'au lieu de DTO invers√©s, ils stockent les ID de leurs d√©pendances. <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@EqualsAndHashCode</span></span>(callSuper = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Data</span></span> <span class="hljs-meta"><span class="hljs-meta">@NoArgsConstructor</span></span> <span class="hljs-meta"><span class="hljs-meta">@AllArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DroidDto</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractDto</span></span></span><span class="hljs-class"> </span></span>{ ... <span class="hljs-comment"><span class="hljs-comment">//private UnicornDto unicorn; private Long unicornId; ... }</span></span></code> </pre> <br>  et ainsi de suite. <br><br>  Mais maintenant, si nous appelons DroidMapper, nous obtenons unicornId == null.  En effet, ModelMapper ne peut pas d√©terminer exactement ce qu'est Long.  Et √ßa ne le d√©range pas.  Et nous devrons affiner les mappeurs n√©cessaires pour leur apprendre √† mapper des entit√©s dans les ID. <br><br>  Nous rappelons qu'avec chaque bac apr√®s son initialisation, vous pouvez travailler manuellement. <br><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@PostConstruct</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setupMapper</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ mapper.createTypeMap(Droid.class, DroidDto.class) .addMappings(m -&gt; m.skip(DroidDto::setUnicornId)).setPostConverter(toDtoConverter()); mapper.createTypeMap(DroidDto.class, Droid.class) .addMappings(m -&gt; m.skip(Droid::setUnicorn)).setPostConverter(toEntityConverter()); }</code> </pre> <br>  Dans @PostConstruct, nous d√©finirons les r√®gles dans lesquelles nous indiquerons les champs que le mappeur ne doit pas toucher, car pour eux, nous d√©terminerons la logique par nous-m√™mes.  Dans notre cas, il s'agit √† la fois de la d√©finition de unicornId dans le DTO et de la d√©finition de Unicorn en substance (puisque le mappeur ne sait pas non plus quoi faire avec Long unicornId). <br><br>  TypeMap - c'est la r√®gle dans laquelle nous sp√©cifions toutes les nuances de la cartographie et d√©finissons √©galement le convertisseur.  Nous avons soulign√© que pour convertir de Droid en DroidDto, nous sautons setUnicornId, et en conversion inverse, nous passons setUnicorn.  Nous allons tous convertir dans le convertisseur toDtoConverter () pour UnicornDto et dans toEntityConverter () pour Unicorn.  Nous devons d√©crire ces convertisseurs dans notre composant. <br><br>  Le post-convertisseur le plus simple ressemble √† ceci: <br><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-function">Converter&lt;UnicornDto, Unicorn&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toEntityConverter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> MappingContext::getDestination; }</code> </pre> <br>  Nous devons √©tendre ses fonctionnalit√©s: <br><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Converter&lt;UnicornDto, Unicorn&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toEntityConverter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context -&gt; { UnicornDto source = context.getSource(); Unicorn destination = context.getDestination(); mapSpecificFields(source, destination); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context.getDestination(); }; }</code> </pre> <br>  On fait de m√™me avec le convertisseur inverse: <br><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Converter&lt;Unicorn, UnicornDto&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toDtoConverter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context -&gt; { Unicorn source = context.getSource(); UnicornDto destination = context.getDestination(); mapSpecificFields(source, destination); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context.getDestination(); }; }</code> </pre> <br>  En fait, nous ins√©rons simplement une m√©thode suppl√©mentaire dans chaque post-convertisseur, dans laquelle nous √©crivons notre propre logique pour les champs manquants. <br><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mapSpecificFields</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Droid source, DroidDto destination)</span></span></span><span class="hljs-function"> </span></span>{ destination.setUnicornId(Objects.isNull(source) || Objects.isNull(source.getId()) ? <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> : source.getUnicorn().getId()); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mapSpecificFields</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DroidDto source, Droid destination)</span></span></span><span class="hljs-function"> </span></span>{ destination.setUnicorn(unicornRepository.findById(source.getUnicornId()).orElse(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>)); }</code> </pre> <br>  Lors du mappage dans DTO, nous d√©finissons l'ID d'entit√©.  Lors du mappage dans DTO, nous obtenons l'entit√© du r√©f√©rentiel par ID. <br><br>  Et c'est tout. <br><br>  J'ai montr√© le minimum n√©cessaire pour commencer √† travailler avec modelmapper et je n'ai pas particuli√®rement refactoris√© le code.  Si vous, lecteur, avez quelque chose √† ajouter √† mon article, je serai heureux d'entendre des critiques constructives. <br><br>  Le projet peut √™tre consult√© ici: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Projet sur GitHub.</a> <br><br>  Les fans de code propre ont probablement d√©j√† vu l'opportunit√© de conduire de nombreux composants de code dans une abstraction.  Si vous √™tes l'un d'entre eux, je sugg√®re sous chat. <br><br><div class="spoiler">  <b class="spoiler_title">Augmenter le niveau d'abstraction</b> <div class="spoiler_text">  Pour commencer, nous d√©finissons une interface pour les m√©thodes de base de la classe wrapper. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Mapper</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">E</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractEntity</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">D</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractDto</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-function">E </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toEntity</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(D dto)</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">D </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toDto</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(E entity)</span></span></span></span>; }</code> </pre> <br>  Nous en h√©ritons une classe abstraite. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractMapper</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">E</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractEntity</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">D</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractDto</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Mapper</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">E</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">D</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> ModelMapper mapper; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Class&lt;E&gt; entityClass; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Class&lt;D&gt; dtoClass; AbstractMapper(Class&lt;E&gt; entityClass, Class&lt;D&gt; dtoClass) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.entityClass = entityClass; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dtoClass = dtoClass; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> E </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toEntity</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(D dto)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Objects.isNull(dto) ? <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> : mapper.map(dto, entityClass); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> D </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toDto</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(E entity)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Objects.isNull(entity) ? <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> : mapper.map(entity, dtoClass); } <span class="hljs-function"><span class="hljs-function">Converter&lt;E, D&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toDtoConverter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context -&gt; { E source = context.getSource(); D destination = context.getDestination(); mapSpecificFields(source, destination); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context.getDestination(); }; } <span class="hljs-function"><span class="hljs-function">Converter&lt;D, E&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toEntityConverter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context -&gt; { D source = context.getSource(); E destination = context.getDestination(); mapSpecificFields(source, destination); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context.getDestination(); }; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mapSpecificFields</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(E source, D destination)</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mapSpecificFields</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(D source, E destination)</span></span></span><span class="hljs-function"> </span></span>{ } }</code> </pre> <br>  Les post-convertisseurs et les m√©thodes de remplissage de champs sp√©cifiques peuvent y √™tre envoy√©s en toute s√©curit√©.  Cr√©ez √©galement deux objets de type Class et un constructeur pour les initialiser: <br><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Class&lt;E&gt; entityClass; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Class&lt;D&gt; dtoClass; AbstractMapper(Class&lt;E&gt; entityClass, Class&lt;D&gt; dtoClass) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.entityClass = entityClass; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dtoClass = dtoClass; }</code> </pre> <br>  Maintenant, la quantit√© de code dans DroidMapper est r√©duite √† ce qui suit: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DroidMapper</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractMapper</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Droid</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DroidDto</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ModelMapper mapper; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> UnicornRepository unicornRepository; <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DroidMapper</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ModelMapper mapper, UnicornRepository unicornRepository)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(Droid.class, DroidDto.class); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.mapper = mapper; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.unicornRepository = unicornRepository; } <span class="hljs-meta"><span class="hljs-meta">@PostConstruct</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setupMapper</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ mapper.createTypeMap(Droid.class, DroidDto.class) .addMappings(m -&gt; m.skip(DroidDto::setUnicornId)).setPostConverter(toDtoConverter()); mapper.createTypeMap(DroidDto.class, Droid.class) .addMappings(m -&gt; m.skip(Droid::setUnicorn)).setPostConverter(toEntityConverter()); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mapSpecificFields</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Droid source, DroidDto destination)</span></span></span><span class="hljs-function"> </span></span>{ destination.setUnicornId(getId(source)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Long </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Droid source)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Objects.isNull(source) || Objects.isNull(source.getId()) ? <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> : source.getUnicorn().getId(); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mapSpecificFields</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DroidDto source, Droid destination)</span></span></span><span class="hljs-function"> </span></span>{ destination.setUnicorn(unicornRepository.findById(source.getUnicornId()).orElse(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>)); } }</code> </pre> <br>  Un mappeur sans champs sp√©cifiques semble g√©n√©ralement simple: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UnicornMapper</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractMapper</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Unicorn</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UnicornDto</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UnicornMapper</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(Unicorn.class, UnicornDto.class); } }</code> </pre> <br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr438808/">https://habr.com/ru/post/fr438808/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr438798/index.html">Comment travailler avec des donn√©es de cyber-intelligence: nous apprenons √† collecter et √† identifier les indicateurs de compromis du syst√®me</a></li>
<li><a href="../fr438800/index.html">PHP Pear pirat√© et non disponible</a></li>
<li><a href="../fr438802/index.html">Programmes d'√©t√© 2019 pour enseigner aux adolescents des programmes √† l'√©tranger</a></li>
<li><a href="../fr438804/index.html">En attendant tout le monde au prochain Meetup CocoaHeads</a></li>
<li><a href="../fr438806/index.html">Probl√®mes de traduction litt√©raire</a></li>
<li><a href="../fr438810/index.html">HTTP / 3: de la racine √† la pointe</a></li>
<li><a href="../fr438812/index.html">Qualit√© du code frontal HH</a></li>
<li><a href="../fr438814/index.html">Un regard sobre sur Helm 2: "Voil√† ce que c'est ..."</a></li>
<li><a href="../fr438818/index.html">UDB. Qu'est-ce que c'est? Partie 5. Chemin de donn√©es. Petites choses utiles</a></li>
<li><a href="../fr438820/index.html">Gestion des connaissances: quels documents sont n√©cessaires et que corriger en eux</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>