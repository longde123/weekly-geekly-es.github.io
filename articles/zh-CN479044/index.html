<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏿‍🏫 💆 🌉 我在NOR Flash中实现环形缓冲区 👨‍🍳 🤟🏿 🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="背景知识 


 有我们自己设计的自动售货机。 在Raspberry Pi的内部，并且在单独的板上有一些捆扎带。 一个硬币接收器，一个纸币接收器，一个银行终端被连接起来。一个自写的程序管理着所有东西。 作品的全部历史记录都记录在USB闪存驱动器（MicroSD）上的杂志上，然后通过Internet（...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>我在NOR Flash中实现环形缓冲区</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/479044/"><h1 id="predystoriya"> 背景知识 </h1><br><p> 有我们自己设计的自动售货机。 在Raspberry Pi的内部，并且在单独的板上有一些捆扎带。 一个硬币接收器，一个纸币接收器，一个银行终端被连接起来。一个自写的程序管理着所有东西。 作品的全部历史记录都记录在USB闪存驱动器（MicroSD）上的杂志上，然后通过Internet（使用USB调制解调器）传输到服务器，然后将其添加到数据库中。 销售信息以1s加载，还有一个简单的Web界面，用于监控等。 </p><br><p> 也就是说，杂志对于会计（有收入，销售等），监控（各种故障和其他不可抗力情况）至关重要。 您可以说，这是我们拥有的有关该机器的所有信息。 </p><br><h1 id="problema"> 问题 </h1><br><p> 闪存驱动器显示为非常不可靠的设备。 他们以令人羡慕的规律性失败。 这既导致机器停机，又导致（如果由于某种原因无法在线传输日志）数据丢失。 </p><br><p>  <em>这不是使用闪存驱动器的第一次体验，在此之前，还有另一个项目将一百多个设备存储在USB闪存驱动器中，还存在可靠性问题，有时每月的故障次数为数十次。</em>  <em>我们尝试了不同的闪存驱动器，包括SLC内存上的品牌闪存驱动器，某些型号比其他型号更可靠，但是更换闪存驱动器并不能从根本上解决问题。</em> </p><a name="habracut"></a><br><p>  <strong>注意！</strong> 隆里德！ 如果您对“为什么”不感兴趣，而仅对“如何”感兴趣，则可以立即转到文章<a href="https://habr.com/ru/post/479044/">末尾</a> 。 </p><br><h1 id="reshenie"> 解决方案 </h1><br><p> 首先想到的是：放弃MicroSD，放入SSD，然后从中启动。 从理论上讲，这是可能的，但可能相对昂贵，而且不够可靠（添加了USB-SATA适配器；在预算有限的SSD上，故障统计也不理想）。 </p><br><p>  USB HDD看起来也不是特别有吸引力的解决方案。 </p><br><p> 因此，我们选择了以下选项：保留从MicroSD下载的内容，但以只读模式使用它们，并将操作日志（以及特定硬件特有的其他信息-序列号，传感器校准等）存储在其他位置。 </p><br><p> 覆盆子只读FS的主题已经被广泛研究，我不会在本文中详细介绍实现的细节<em>（但是，如果有兴趣的话，也许我会写一个关于该主题的迷你文章）</em> 。 我要指出的唯一一点是：从个人经验和已经实现可靠性方面获得的评论来看。 是的，不可能完全消除故障，但是有可能大大减少故障发生的频率。 是的，并且卡变得统一了，这极大地简化了维护人员的更换。 </p><br><h2 id="apparatnaya-chast"> 硬体 </h2><br><p> 毫无疑问，内存类型的选择-NOR Flash。 <br> 参数： </p><br><ul><li> 简单的连接（最常用的是SPI总线，已经有使用经验，因此不会出现“铁”问题）； </li><li> 荒谬的价格 </li><li> 标准操作协议（该实现已在Linux内核中，如果需要，您可以使用也存在的第三方，甚至编写自己的第三方，好处很简单）； </li><li> 可靠性和资源： <br> 根据典型的数据表：数据存储20年，每个块100,000个擦除周期； <br> 来自第三方的消息：BER极低，假设不需要纠错码<em>（在某些论文中考虑了NOR的ECC，但通常是MLC NOR的意思）</em> 。 </li></ul><br><p> 让我们估算数量和资源需求。 </p><br><p> 我想保证可以保存几天的数据。 这是必要的，以便在连接出现任何问题时不会丢失销售历史记录。 我们将专注于5天，在此期间<em>（即使考虑到周末和节假日），</em>我们也可以解决问题。 </p><br><p> 现在，我们每天要输入约100kb的杂志（3-4千条记录），但是这个数字正在逐渐增加-详细信息在增加，新事件也在增加。 另外，有时还会爆发（例如，某些传感器以误报的形式开始发送垃圾邮件）。 我们将每天计算100字节-兆字节的1万条记录。 </p><br><p> 总共出现5 MB的干净（可压缩）数据。 他们还<em>（粗略估计）</em> 1MB的服务数据。 </p><br><p> 也就是说，如果您不使用压缩功能，则需要一个8MB的芯片，如果您不使用压缩功能，则需要4MB的芯片。 这种类型的内存相当实数。 </p><br><p> 至于资源：如果我们计划每5天不超过一次重写整个内存，那么在使用10年后，我们将获得不到一千次的重写周期。 <br> 我记得，制造商承诺十万。 </p><br><div class="spoiler">  <b class="spoiler_title">关于NOR vs NAND的一些知识</b> <div class="spoiler_text"><p> 当然，今天，NAND存储器更受欢迎，但是对于这个项目，我不会使用它：与NOR不同，NAND必须使用纠错码，坏块表等，以及NAND芯片的支脚。通常更多。 </p><br><p>  NOR的缺点包括： </p><br><ul><li> 体积小（因此每兆字节价格高）； </li><li> 低交换率（很大程度上是由于使用了串行接口，通常是SPI或I2C）； </li><li> 慢擦除（取决于块的大小，从几分之一秒到几秒钟不等）。 </li></ul><br><p> 对我们来说，这似乎并不重要，所以继续。 </p></div></div><br><p> 如果细节令人感兴趣，则选择了<a href="https://www.adestotech.com/wp-content/uploads/doc3686.pdf" rel="nofollow">at25df321a</a>芯片<em>（但是，这无关紧要，市场上有许多与引脚和命令系统兼容的类似物;即使我们想将芯片从另一个制造商和/或另一个体积放进去，也可以在不更改代码的情况下工作）</em> 。 </p><br><p> 我使用Raspberry上Linux内核中内置的驱动程序，这要归功于设备树覆盖层的支持，一切都非常简单-您需要将编译后的覆盖层放入/ boot / overlays并稍微修改/boot/config.txt。 </p><br><div class="spoiler">  <b class="spoiler_title">例子dts文件</b> <div class="spoiler_text"><p> 老实说，我不确定所写的内容没有错误，但是可以。 </p><br><pre><code class="plaintext hljs">/* * Device tree overlay for at25 at spi0.1 */ /dts-v1/; /plugin/; / { compatible = "brcm,bcm2835", "brcm,bcm2836", "brcm,bcm2708", "brcm,bcm2709"; /* disable spi-dev for spi0.1 */ fragment@0 { target = &lt;&amp;spi0&gt;; __overlay__ { status = "okay"; spidev@1{ status = "disabled"; }; }; }; /* the spi config of the at25 */ fragment@1 { target = &lt;&amp;spi0&gt;; __overlay__ { #address-cells = &lt;1&gt;; #size-cells = &lt;0&gt;; flash: m25p80@1 { compatible = "atmel,at25df321a"; reg = &lt;1&gt;; spi-max-frequency = &lt;50000000&gt;; /* default to false: m25p,fast-read ; */ }; }; }; __overrides__ { spimaxfrequency = &lt;&amp;flash&gt;,"spi-max-frequency:0"; fastread = &lt;&amp;flash&gt;,"m25p,fast-read?"; }; };</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">而config.txt中的另一行</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">dtoverlay=at25:spimaxfrequency=50000000</code> </pre> </div></div><br><p> 我将省略将芯片连接到Raspberry Pi的描述。 一方面，我不是电子学专家，另一方面，即使对我来说，一切也微不足道：微电路只有8条支脚，其中我们需要接地，电源，SPI（CS，SI，SO，SCK）； 级别与Raspberry Pi的级别一致，不需要其他绑定-只需连接指定的6个触点即可。 </p><br><h2 id="postanovka-zadachi"> 问题陈述 </h2><br><p> 像往常一样，问题的提出经历了多次迭代，在我看来，下一次迭代的时机已到。 因此，让我们停下来，汇总已写的内容，并弄清阴影中剩余的细节。 </p><br><p> 因此，我们决定将日志存储在SPI NOR Flash中。 </p><br><div class="spoiler">  <b class="spoiler_title">对于不认识的人，NOR Flash是什么</b> <div class="spoiler_text"><p> 这是非易失性存储器，可以执行以下三个操作： </p><br><ol><li> 阅读： <br> 最常见的读取：我们传递地址并读取所需的字节数； </li><li> 记录： <br> 写入NOR闪存看起来很普通，但是它有一个特殊之处：您只能将1更改为0，反之亦然。 例如，如果我们在存储单元中有0x55，则在向其写入0x0f之后，已经在其中存储了0x05 <em>（请参见下表）</em> ； </li><li> 清除： <br> 当然，我们还需要能够执行相反的操作-将0更改为1，这就是存在擦除操作的原因。 与前两个不同，它不是以字节为单位，而是以块为单位运行（所选微电路中的最小擦除块为4kb）。 擦除会破坏整个块，这是将0更改为1的唯一方法。因此，使用闪存时，通常必须使数据结构与擦除块边界对齐。 <br> 在NOR Flash中记录： </li></ol><br><div class="scrollable-table"><table><thead><tr><th></th><th> 二进制数据 </th></tr></thead><tbody><tr><td>  <strong>是</strong> </td><td> <code>01010101</code> </td> </tr><tr><td>  <strong>记录下来</strong> </td><td> <code>00001111</code> </td> </tr><tr><td>  <strong>已成为</strong> </td><td> <code>00000101</code> </td> </tr></tbody></table></div></div></div><br><p> 日志本身代表一系列可变长度的记录。 典型的记录长度约为30个字节（尽管有时会记录几千个字节）。  <em>在这种情况下，我们就像处理一组字节一样使用它们，但是，如果您有兴趣，可以在记录内使用CBOR。</em> </p><br><p> 除了日志之外，我们还需要存储一些“调整”信息，无论是否已更新：某个设备ID，传感器校准，“设备被暂时禁用”标志等。 <br> 此信息是一组键值记录，也存储在CBOR中，我们没有太多此类信息（最大几千字节），因此不经常更新。 <br> 将来，我们将其称为上下文。 </p><br><p> 如果您想起本文开始的地方，那么即使在发生硬件故障/数据损坏的情况下，确保数据存储的可靠性以及在可能的情况下连续运行也非常重要。 </p><br><p> 可以考虑哪些问题来源？ </p><br><ul><li> 在写/擦除操作期间关闭电源。 这是来自“反对废品收货”的类别。 <br> 来自堆栈交换<a href="https://electronics.stackexchange.com/questions/225956/what-would-happen-in-case-of-power-outage-during-nor-flash-erase-or-programming" rel="nofollow">讨论的</a>信息：使用闪存工作时关闭电源时，擦除（设置为1），写入（设置为0）会导致未定义的行为：数据可以被写入，也可以部分写入（例如，我们传输了10字节/ 80位，并且仅记录了45个位），其中某些位也可能处于“中间”状态（读取会产生0或1）； </li><li> 闪存本身的错误。 <br>  BER虽然很低，但不能等于零。 </li><li> 巴士错误 <br> 通过SPI传输的数据没有受到任何保护，很可能会发生单位错误或同步错误-丢失或插入位（导致大量数据失真）； </li><li> 其他错误/失败 <br> 代码错误，Raspberry“故障”，外星人干预... </li></ul><br><p> 我制定了一些要求，我认为必须满足这些要求才能确保可靠性： </p><br><ul><li> 记录应立即写入闪存，不考虑挂起的记录；-如果发生错误，应尽快对其进行检测和处理；-如果可能，系统应从错误中恢复。 <br>  <em>（我想，每个人都遇到过这样的例子：“紧急情况”，紧急重启后，文件系统“崩溃”，操作系统无法启动）</em> </li></ul><br><h2 id="idei-podhody-razmyshleniya"> 想法，方法，思想 </h2><br><p> 当我开始考虑此任务时，我的脑海中浮现出许多想法，例如： </p><br><ul><li> 使用数据压缩 </li><li> 使用棘手的数据结构，例如，将记录标题与记录本身分开存储，这样，如果记录中发生错误，则可以读取其余记录而不会出现任何问题； </li><li> 当电源关闭时，使用位域控制记录的完整性； </li><li> 存储所有内容的校验和； </li><li> 使用某种纠错编码。 </li></ul><br><p> 其中一些想法被使用，有些决定被拒绝。 让我们去吧。 </p><br><h3 id="szhatie-dannyh"> 资料压缩 </h3><br><p> 我们在日记本中记录的事件是完全相同且可重复的（“投了5卢布硬币”，“单击了更改交付按钮”，...）。 因此，压缩应该非常有效。 </p><br><p> 压缩的开销微不足道（我们拥有的处理器非常强大，即使在第一个Pi上也有一个核心频率为700 MHz，在当前型号上有几个核心的频率超过了千兆赫），与存储的交换速度很低（每秒几兆字节），记录大小很小。 通常，如果压缩会影响性能，则仅是肯定的<em>（绝对不重要，仅说明一下）</em> 。 另外，我们没有真正的嵌入式系统，而是普通的Linux-因此实现不需要太多工作（只需链接库并使用其中的几个功能）。 </p><br><p> 从工作设备中提取了一部分日志（1.7 MB，7万条记录），并使用计算机上提供的gzip，lz4，lzop，bzip2，xz，zstd首先检查了压缩性。 </p><br><ul><li>  gzip，xz，zstd显示了相似的结果（40Kb）。 <br> 令我惊讶的是，时尚的xz在gzip或zstd级别显示了出来。 </li><li> 使用默认设置的lzip给出的结果稍差一些； </li><li>  lz4和lzop显示的效果不是很好（150Kb）； </li><li>  bzip2显示出令人惊讶的良好结果（18Kb）。 </li></ul><br><p> 因此，数据压缩得很好。 <br> 因此（如果我们没有发现致命的缺陷）应该进行压缩！ 只是因为更多数据可以容纳在同一闪存驱动器上。 </p><br><p> 让我们考虑一下这些缺陷。 </p><br><p> 第一个问题：我们已经同意，每条记录应立即刷新。 通常，存档器会从输入流中收集数据，直到决定是时候写入输出为止。 我们需要立即获取压缩的数据块并将其保存在非易失性存储器中。 </p><br><p> 我看到三种方式： </p><br><ol><li> 使用字典压缩而不是上面讨论的算法来压缩每个条目。 <br> 这是一个可行的选择，但我不喜欢它。 为了确保大致适当的压缩水平，应针对特定数据对字典进行“锐化”，任何更改都将导致压缩水平灾难性地下降。 是的，可以通过创建字典的新版本来解决问题，但这令人头疼-我们将需要存储字典的所有版本； 在每个条目中，我们将需要指出它是用哪个版本的字典压缩的... </li><li> 使用“经典”算法压缩每个条目，但与其他算法无关。 <br> 所考虑的压缩算法不适用于这种大小（数十个字节）的记录，压缩系数显然小于1（即，数据量增加而不是压缩）； </li><li> 每次录音后都要冲洗。 <br> 许多压缩库都支持FLUSH。 这是一个命令（或压缩过程的参数），存档器在接收到该命令时会生成压缩流，以便可以基于其恢复<strong>所有</strong>已接收的未压缩数据。 在文件系统或sql中进行<code>sync</code>此类模拟。 <br> 重要的是，后续的压缩操作将能够使用累积的词典，并且压缩率不会像以前的版本那样受苦。 </li></ol><br><p> 我认为很明显，我选择了第三个选项，让我们对其进行更详细的介绍。 </p><br><p>  zlib中有一篇<a href="https://www.bolet.org/~pornin/deflate-flush.html" rel="nofollow">很棒的</a>关于FLUSH的<a href="https://www.bolet.org/~pornin/deflate-flush.html" rel="nofollow">文章</a> 。 </p><br><p> 我根据该文章进行了动机测试，从一个真实的设备中获取了7万条日记条目，页面大小为60Kb <em>（我们将返回页面大小）</em> ： </p><br><div class="scrollable-table"><table><thead><tr><th></th><th> 源数据 </th><th>  Gzip -9压缩（无FLUSH） </th><th>  zlib与Z_PARTIAL_FLUSH </th><th>  zlib与Z_SYNC_FLUSH </th></tr></thead><tbody><tr><td>  <strong>体积，Kb</strong> </td><td>  1692 </td><td>  40 </td><td>  352 </td><td>  604 </td></tr></tbody></table></div><br><p> 乍一看，FLUSH引入的价格过高，但实际上我们的选择很差-要么根本不压缩，要么用FLUSH压缩（非常有效）。 不要忘记我们有7万条记录，Z_PARTIAL_FLUSH引入的冗余每个记录只有4-5个字节。 压缩比几乎达到5：1，这比出色的结果还要好。 </p><br><div class="spoiler">  <b class="spoiler_title">似乎是意外的，但实际上Z_SYNC_FLUSH是执行FLUSH的更有效方法</b> <div class="spoiler_text"><p> 在使用Z_SYNC_FLUSH的情况下，每个记录的最后4个字节将始终为0x00、0x00、0xff，0xff。 而且，如果我们知道它们，那么我们将无法存储它们，因此总大小仅为324Kb。 </p><br><p> 我所指的文章有一个解释： </p><br><blockquote> 附加了一个新的类型0的内容为空的块。 <br><br> 内容为空的类型0块包括： <br><ul><li> 三位块头； </li><li>  0至7位等于零，以实现字节对齐； </li><li> 四字节序列00 00 FF FF。 </li></ul><br></blockquote><p> 如您所见，在这4个字节之前的最后一块中，这是3到10个零位。 但是，实践表明，零位实际上至少为10。 </p><br><p> 事实证明，这样的短数据块通常（总是？）使用类型1的块（固定块）进行编码，该块必须以7个零位结尾，因此我们得到10-17个保证的零位（其余的零为零，概率约为50％）。 </p><br><p> 因此，在测试数据上，在100％的情况下，0x00、0x00、0xff，0xff之前有一个零字节，而在第三种情况下则有两个零字节<em>（也许事实是我使用了二进制CBOR，而当使用文本CBOR时JSON更可能会遇到类型2的块-动态块，分别在0x00、0x00、0xff，0xff之前没有附加零字节的情况下发生块</em> 。 </p><br><p> 可用测试数据上的总计可以容纳少于250Kb的压缩数据。 </p><br><p> 您可以通过变位来节省更多：现在，我们忽略了块末尾出现的几个零位，块开头的几个位也保持不变... <br> 但是后来我做出了一个坚决的决定，那就是停止，否则，以这样的速度，您就可以实现存档器的开发。 </p></div></div><br><p> 总的来说，我从测试数据中得到每条记录3-4个字节，压缩率大于6：1。 老实说，我没有指望得到这样的结果，我认为所有优于2：1的结果都已经证明使用压缩是合理的。 </p><br><p> 一切都很好，但是zlib（放气）仍然 <del> 古老的 </del> 当之无愧的老式压缩算法。 今天，将未压缩的数据流中的最后32Kb用作字典这一纯粹的事实看起来很奇怪（也就是说，如果某个数据块与输入流40Kb中的数据块非常相似，它将开始再次存档，但不会被存档）请参阅过去的条目）。 在 <del> 时髦的 </del> 现代档案大小词典通常以兆字节而不是千字节为单位。 </p><br><p> 因此，我们继续进行有关归档器的小型研究。 </p><br><p> 接下来测试了bzip2（回想一下，没有FLUSH，它显示了惊人的压缩率，几乎为100：1）。  FL，使用FLUSH时，其显示效果非常差，压缩数据的大小大于未压缩数据的大小。 </p><br><div class="spoiler">  <b class="spoiler_title">我对失败原因的假设</b> <div class="spoiler_text"><p>  Libbz2仅提供了一个刷新选项，似乎可以清除字典（类似于zlib中的Z_FULL_FLUSH），没有理由谈论某种有效的压缩。 </p></div></div><br><p>  zstd是最后一个要测试的。 根据参数的不同，它可以在gzip级别进行压缩，但速度要快得多，或者gzip会更好。 </p><br><p>  las，使用FLUSH证明他“不是很好”：压缩数据的大小约为700Kb。 </p><br><p> 我在github上的项目页面上<a href="https://github.com/facebook/zstd/issues/900" rel="nofollow">问了一个问题</a> ，我收到了一个答案，它值得指望每个压缩数据块最多包含10个字节的服务数据，这接近结果，捕获deflate不起作用。 </p><br><p> 我决定在与存档程序进行的实验中停止此操作（我想提醒您，即使在没有FLUSH的测试阶段，xz，lzip，lzo，lz4也不显示自己的位置，但我没有考虑更多的外来压缩算法）。 </p><br><p> 我们回到存档的问题。 </p><br><p> 第二个问题（正如他们说的那样，但不是价值问题）-压缩数据是单个流，其中不断向前几部分发送数据。 因此，当压缩数据的一部分损坏时，我们不仅会丢失与之关联的未压缩数据块，还会丢失所有后续数据块。 </p><br><p> 有一种解决此问题的方法： </p><br><ol><li> 防止出现问题-向压缩数据添加冗余，这将允许识别和纠正错误； 我们稍后再讨论； </li><li> 出现问题时将后果降到最低 <br> 前面我们已经说过，可以独立地压缩每个数据块，并且问题将自行消失（一个块的数据损坏将导致仅该块的数据丢失）。 但是，在极端情况下，数据压缩效率很低。 相反的极端情况：将我们所有4MB的微电路用作单个存档，这将为我们提供出色的压缩效果，但在数据损坏的情况下带来灾难性后果。 <br>  <em>是的，在可靠性方面需要折衷。</em>  <em>但是我们必须记住，我们正在为非易失性存储器开发一种数据存储格式，它具有极低的BER和声明的20年的数据存储期。</em> </li></ol><br><p> 在实验过程中，我发现在压缩级别上或多或少明显的损失始于大小小于10Kb的压缩数据块。 <br> 前面提到过，所使用的内存具有页面组织，我看不出为什么您不应该使用“一页-压缩数据的一个块”的对应关系。 </p><br><p> 也就是说，最小合理页面大小为16Kb（有一定的服务信息余量）。 但是，如此小的页面大小对最大记录大小施加了很大的限制。 </p><br><p> 尽管我仍然不希望以压缩形式记录更多单位的千字节，但我还是决定使用32KB页（每个芯片总共128页）。 </p><br><p>  <strong>总结：</strong> </p><br><ul><li> 我们存储使用zlib（deflate）压缩的数据； </li><li> 对于每个记录，设置Z_SYNC_FLUSH; </li><li> 对于每个压缩的记录，我们都会修剪最后的字节<em>（例如0x00、0x00、0xff，0xff）</em> ； 标头中指出我们削减了多少个字节； </li><li> 我们将数据存储在32Kb页面中； 页面内只有一个压缩数据流； 在每个页面上，我们再次开始压缩。 </li></ul><br><p> 并且，在完成压缩之前，我想提请注意一个事实，即我们仅获得几个字节的写数据，因此，不要虚增服务信息，每个字节都要计数，这一点非常重要。 </p><br><h3 id="hranenie-zagolovkov-dannyh"> 存储数据头 </h3><br><p> 由于我们有可变长度的记录，因此我们需要以某种方式确定记录的位置/边界。 </p><br><p> 我知道三种方法： </p><br><ol><li> 所有记录都存储在连续流中，首先是包含长度的记录头，然后是记录本身。 <br> 在该实施例中，报头和数据都可以具有可变的长度。 <br> 实际上，我们得到了一直使用的单链接列表。 </li><li> 标头和记录本身存储在单独的流中。 <br> 使用固定长度的标头，我们确保损坏一个标头不会影响其余标头。 <br> 例如，在许多文件系统中使用了类似的方法。 </li><li> 记录存储在连续的流中，记录的边界由某些标记（符号/字符序列，在数据块中被禁止）来确定。 如果在记录中找到标记，则我们将其替换为特定顺序（转义）。 <br> 例如，在PPP协议中使用了类似的方法。 </li></ol><br><p> 我会举例说明。 </p><br><p> 选项1： <br><img src="https://habrastorage.org/webt/b3/yu/q8/b3yuq8z6elbufkrice2g_vjtuhe.png" alt="选项1"><br> 一切都非常简单：知道记录的长度，我们可以计算下一个标头的地址。 因此，我们遍历标题，直到遇到填充有0xff的区域（自由区域）或页面的末尾。 </p><br><p> 选项2： <br><img src="https://habrastorage.org/webt/kf/qy/_7/kfqy_7qzi7pzmk-g5cqa4r6s75q.png" alt="选项2"><br> 由于记录长度的变化，我们无法提前说出每页需要多少条记录（因此还有标题）。 您可以将标头和数据本身散布到不同的页面中，但是我更喜欢另一种方法：我们将标头和数据放在同一页上，但是，标头（大小固定）来自页面的开头，数据（长度可变）来自结尾。 他们“见面”（没有足够的可用空间来存储新记录）后，我们认为此页面已满。 </p><br><p> 选项3： <br><img src="https://habrastorage.org/webt/-q/u1/qj/-qu1qjmqlcvfi570ovsdy_nzzny.png" alt="选项3"><br> 不需要在标题中存储有关数据位置的长度或其他信息，没有足够的标记指示记录的边界。 但是，在写入/读取时必须处理数据。 <br> 作为标记，我将使用0xff（擦除后会填满页面），因此，空闲区域绝对不会被视为数据。 </p><br><p> 比较表： </p><br><div class="scrollable-table"><table><thead><tr><th></th><th> 选项1 </th><th> 选项2 </th><th> 选项3 </th></tr></thead><tbody><tr><td>  <strong>容错能力</strong> </td><td>  -- </td><td>  + </td><td>  + </td></tr><tr><td>  <strong>紧凑性</strong> </td><td>  + </td><td>  -- </td><td>  + </td></tr><tr><td>  <strong>实施复杂度</strong> </td><td>  * </td><td>  ** </td><td>  ** </td></tr></tbody></table></div><br><p> 选项1有一个致命的缺陷：如果任何标头损坏，那么我们随后的整个链条都将被破坏。 其他选项使您即使受到严重破坏也可以恢复部分数据。 <br> 但是在这里应该回想一下，我们决定以压缩形式存储数据，因此我们在“破损”记录之后丢失了页面上的所有数据，因此即使表中有减号，我们也不会考虑。 </p><br><p> 紧凑性： </p><br><ul><li> 在第一个版本中，我们只需要在标头中存储长度，如果使用可变长度的整数，那么在大多数情况下，我们可以使用一个字节； </li><li> 在第二个选项中，我们需要存储起始地址和长度； 记录应为恒定大小，我估计每条记录4个字节（每个偏移量两个字节，每个长度两个字节）； </li><li>          ,    -    1-2%.       . </li></ul><br><p>        (   ).      ,     . </p><br><p> <em>, -  -    . ,        ,      —     ,  , ...</em> </p><br><p>     :          ,      ,      .. , , ,      —     ,   . </p><br><p> <strong>:</strong>       "   —   " -    . </p><br><h3 id="ispolzovanie-bitovyh-poley-dlya-kontrolya-uspeshnosti-operaciy-zapisi">         </h3><br><p>    ,    ,     : <br>         . <br> <em>   ,  erase    1,     1  0,   .</em>    "  "  1,  " " — 0. </p><br><p>          flash: </p><br><ol><li>   “  ”; </li><li>  ; </li><li>   “  ”; </li><li>  ; </li><li>   “ ”. </li></ol><br><p>  ,     “ ”,  4  . </p><br><p>          “1111” —     “1000” —   ;         ,        . </p><br><p>  ,           , , , ,      (   )   . </p><br><p> <strong>:</strong>      . </p><br><h3 id="kontrolnye-summy">   </h3><br><p>       (  )     ,     . ,       ,   . </p><br><p>      ,     ,           <em>( , ,   —       )</em> . </p><br><p>  ,    ,   ,   —  . </p><br><p>         — CRC.   ,     100%    ,   —               <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msup><mn>2</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo>&amp;#x2212;</mo><mi>n</mi></mrow></msup></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.659ex" height="2.298ex" viewBox="0 -883.9 1575.6 989.6" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700023,15700186,15700191,15700259,15700271&amp;usg=ALkJrhiWG1hdOGfmeHRrerU48xLwp8NTuQ#MJMAIN-32" x="0" y="0"></use><g transform="translate(500,393)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700023,15700186,15700191,15700259,15700271&amp;usg=ALkJrhiWG1hdOGfmeHRrerU48xLwp8NTuQ#MJMAIN-2212" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700023,15700186,15700191,15700259,15700271&amp;usg=ALkJrhiWG1hdOGfmeHRrerU48xLwp8NTuQ#MJMATHI-6E" x="778" y="0"></use></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mn><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></mn><mrow class="MJX-TeXAtom-ORD"><mo><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">--</font></font></mo><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ñ</font></font></mi></mrow></msup></math></span></span><script type="math/tex" id="MathJax-Element-1">2^{-n}</script>  。      ,      ,       :       ,      .  —      . </p><br><p>   : <a href="http://amsoftware.narod.ru/algo.html" rel="nofollow"> 1</a> , <a href="http://amsoftware.narod.ru/algo2.html" rel="nofollow"> 2</a> <em>(  narod.ru, )</em> . </p><br><p>       , CRC —     .    ,    . </p><br><p>        ,     . </p><br><p> : <br>         <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-2-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msup><mn>10</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo>&amp;#x2212;</mo><mn>3</mn></mrow></msup></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.658ex" height="2.419ex" viewBox="0 -935.7 2005.4 1041.5" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700023,15700186,15700191,15700259,15700271&amp;usg=ALkJrhiWG1hdOGfmeHRrerU48xLwp8NTuQ#MJMAIN-31"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700023,15700186,15700191,15700259,15700271&amp;usg=ALkJrhiWG1hdOGfmeHRrerU48xLwp8NTuQ#MJMAIN-30" x="500" y="0"></use><g transform="translate(1001,393)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700023,15700186,15700191,15700259,15700271&amp;usg=ALkJrhiWG1hdOGfmeHRrerU48xLwp8NTuQ#MJMAIN-2212" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700023,15700186,15700191,15700259,15700271&amp;usg=ALkJrhiWG1hdOGfmeHRrerU48xLwp8NTuQ#MJMAIN-33" x="778" y="0"></use></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mn><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10</font></font></mn><mrow class="MJX-TeXAtom-ORD"><mo><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">--</font></font></mo><mn><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3</font></font></mn></mrow></msup></math></span></span><script type="math/tex" id="MathJax-Element-2">10^{-3}</script>    ,       : </p><br><div class="scrollable-table"><table><thead><tr><th> ,  </th><th>  ,  </th><th>   </th><th>    </th><th>    </th></tr></thead><tbody><tr><td>  1个 </td><td>  0 </td><td>  1000 </td><td>  0 </td><td>  1000 </td></tr><tr><td>  1个 </td><td>  1个 </td><td>  4 </td><td>  999 </td><td>  1003 </td></tr><tr><td>  1个 </td><td>  2 </td><td> ≈0 </td><td>  1997年 </td><td>  1997年 </td></tr><tr><td>  1个 </td><td>  4 </td><td> ≈0 </td><td> 3990 </td><td> 3990 </td></tr><tr><td>  10 </td><td>  0 </td><td> 9955 </td><td>  0 </td><td> 9955 </td></tr><tr><td>  10 </td><td>  1个 </td><td>  39 </td><td>  990 </td><td>  1029 </td></tr><tr><td>  10 </td><td>  2 </td><td> ≈0 </td><td>  1979年 </td><td>  1979年 </td></tr><tr><td>  10 </td><td>  4 </td><td> ≈0 </td><td> 3954 </td><td> 3954 </td></tr><tr><td>  1000 </td><td>  0 </td><td> 632305 </td><td>  0 </td><td> 632305 </td></tr><tr><td>  1000 </td><td>  1个 </td><td> 2470 </td><td>  368 </td><td> 2838 </td></tr><tr><td>  1000 </td><td>  2 </td><td>  10 </td><td>  735 </td><td>  745 </td></tr><tr><td>  1000 </td><td>  4 </td><td> ≈0 </td><td> 1469 </td><td> 1469 </td></tr></tbody></table></div><br><p>  ,   —               —    . </p><br><p> ,      : ,       ,           .     ,  <a href="https://habr.com/ru/post/428746/">   </a> . </p><br><p> ,        ,      32    <em>(   64     -)</em> . </p><br><p>   ,    ,      , -   32-   (16  ,    0.01%;  24 ,  ,     ). </p><br><p>    :          ,    4  ?           ?  ,   <em> </em> ,      . </p><br><p>       ,     CRC-32C. <br>    6      22  (,     c), 4      655  (    ), 2           . </p><br><div class="spoiler"> <b class="spoiler_title">   </b> <div class="spoiler_text"><p> <a href="https://en.wikipedia.org/wiki/Cyclic_redundancy_check" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">维基百科</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">有关CRC的</font><a href="https://en.wikipedia.org/wiki/Cyclic_redundancy_check" rel="nofollow"><font style="vertical-align: inherit;">文章</font></a><font style="vertical-align: inherit;">。</font></font></p><br><p> <a href="https://users.ece.cmu.edu/~koopman/crc/c32/0x8f6e37a0_len.txt" rel="nofollow">  crc-32c</a>  <a href="http://users.ece.cmu.edu/~koopman/crc/notes.html" rel="nofollow"> </a> — ,    CRC  . </p><br><p>  <a href="http://users.ece.cmu.edu/~koopman/networks/dsn02/dsn02_koopman.pdf" rel="nofollow"> </a>  <a href="https://users.ece.cmu.edu/~koopman/crc/c32/0xfa567d89_len.txt" rel="nofollow">   </a> ,          ,      ,    ,         . </p></div></div><br><p> ,      ,  :       ? </p><br><p>  ""     : </p><br><ul><li>          —       (         /, ,     ..); </li><li>  deflate  zlib      <em> </em>   ""  ,  ,         ,      (        , zlib      ). </li></ul><br><p>  ""     : </p><br><ul><li> CRC ""     ,    - (          ,  ,  ,   "" ); </li><li>          , <a href="https://www.cvedetails.com/vulnerability-list/vendor_id-72/product_id-1820/GNU-Zlib.html" rel="nofollow">  </a> ,   . </li></ul><br><p>              . </p><br><p> <strong>:</strong>  CRC-32C,        ,      flash ( ). </p><br><h3 id="izbytochnost">  </h3><br><p>     , ,   , ,    (   )     . </p><br><p>        ,   . <br>       ,  - ,           RAID-6         . <br>         ,   ,           ,     . </p><br><p>   ,       .        ? </p><br><ol><li>   ( -      ,  Raspberry, ...) <br> ,             ; </li><li>   ( -   flash-   ,  ) <br>      ,         ; </li><li>       ; </li><li>   <br>            . </li></ol><br><p>       (    )       . ,   -  . </p><br><p> <strong>:</strong>      , ,      ,      (     ,      ). </p><br><h3 id="prochee">  </h3><br><p> ,          <em>(      )</em> ,      ,   . </p><br><ul><li>     "" <br>     -    ,    ..,    ,      . <br>     ,    ,    ; </li><li>     . <br>       — ! <br>         Magic Number (),        <em>( ,       )</em> ; </li><li>    (  )   ,         1 ; </li><li>               . </li></ul><br><p>   <a href="https://planetcalc.com/2481/" rel="nofollow">-</a>  .          . </p><br><h1 id="anchorformatanchoropisanie-formata-hraneniya-dannyh"><a name="format"></a>     </h1><br><h2 id="byte-order"> Byte order </h2><br><p> ,    ,   big-endian  (network byte order),   0x1234   0x12, 0x34. </p><br><h2 id="delenie-na-stranicy">    </h2><br><p>  -     . </p><br><p>     32,   ,  1/4      (   4  128 ). </p><br><p>        (          ). </p><br><p>       (   ),    0 (     0,  —  32,  —  64  ..) </p><br><p>       (ring buffer),          0,    1, ...,     ,          . </p><br><h2 id="vnutri-stranicy">   </h2><br><p><img src="https://habrastorage.org/webt/7r/sr/fa/7rsrfafqrc263dsu8zd5ptceqga.png" alt="页数"><br>     4-  ,     (CRC-32C),      ", ,  ". </p><br><p>   (  -)  : </p><br><ul><li>   Magic Number (  —   ) <br>        <code>0xed00 ⊕  </code> ; </li><li>   " " (   ). </li></ul><br><p>        (  deflate).          (  ),       .              (   ). </p><br><p>      Z_SYNC_FLUSH,        4  0x00, 0x00, 0xff, 0xff, , ,      . <br>   ( 4, 5  6 )      -. </p><br><p>      1, 2  3 , : </p><br><ul><li>   (T),   : 0 — , 1 — ; </li><li>    (S)  1  7 ,     "",       ; </li><li>   (L). </li></ul><br><p>   S: </p><br><div class="scrollable-table"><table><thead><tr><th> 小号 </th><th>  ,  </th><th>   ,  </th></tr></thead><tbody><tr><td> <code>0</code> </td> <td>  1个 </td><td> 5 ( <code>00 00 00 ff ff</code> ) </td></tr><tr><td> <code>10</code> </td> <td>  1个 </td><td> 6 ( <code>00 00 00 00 ff ff</code> ) </td></tr><tr><td> <code>110</code> </td> <td>  2 </td><td> 4 ( <code>00 00 ff ff</code> ) </td></tr><tr><td> <code>1110</code> </td> <td>  2 </td><td> 5 ( <code>00 00 00 ff ff</code> ) </td></tr><tr><td> <code>11110</code> </td> <td>  2 </td><td> 6 ( <code>00 00 00 00 ff ff</code> ) </td></tr><tr><td> <code>1111100</code> </td> <td>  3 </td><td> 4 ( <code>00 00 ff ff</code> ) </td></tr><tr><td> <code>1111101</code> </td> <td>  3 </td><td> 5 ( <code>00 00 00 ff ff</code> ) </td></tr><tr><td> <code>1111110</code> </td> <td>  3 </td><td> 6 ( <code>00 00 00 00 ff ff</code> ) </td></tr></tbody></table></div><br><p>  ,  ,   : <br><img src="https://habrastorage.org/webt/iu/fu/bp/iufubpdgxnpv9czd45tomt-0vtc.png" alt="标题输入"><br>     T,  —  S,  L (    ),  —  ,  —    ,     -. </p><br><p>  ,      ( 63+5    )     . </p><br><p>       CRC-32C,       (init)      . </p><br><p> <em>CRC   "",  (-    )  :</em> <math> </math><em><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-3-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>C</mi><mi>R</mi><mi>C</mi><mo stretchy=&quot;false&quot;>(</mo><mi>i</mi><mi>n</mi><mi>i</mi><mi>t</mi><mo>,</mo><mi>A</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>|</mo></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>|</mo></mrow><mi>B</mi><mo stretchy=&quot;false&quot;>)</mo><mo>=</mo><mi>C</mi><mi>R</mi><mi>C</mi><mo stretchy=&quot;false&quot;>(</mo><mi>C</mi><mi>R</mi><mi>C</mi><mo stretchy=&quot;false&quot;>(</mo><mi>i</mi><mi>n</mi><mi>i</mi><mi>t</mi><mo>,</mo><mi>A</mi><mo stretchy=&quot;false&quot;>)</mo><mo>,</mo><mi>B</mi><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="43.505ex" height="2.66ex" viewBox="0 -832 18731.1 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700023,15700186,15700191,15700259,15700271&amp;usg=ALkJrhiWG1hdOGfmeHRrerU48xLwp8NTuQ#MJMATHI-43" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700023,15700186,15700191,15700259,15700271&amp;usg=ALkJrhiWG1hdOGfmeHRrerU48xLwp8NTuQ#MJMATHI-52" x="760" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700023,15700186,15700191,15700259,15700271&amp;usg=ALkJrhiWG1hdOGfmeHRrerU48xLwp8NTuQ#MJMATHI-43" x="1520" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700023,15700186,15700191,15700259,15700271&amp;usg=ALkJrhiWG1hdOGfmeHRrerU48xLwp8NTuQ#MJMAIN-28" x="2280" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700023,15700186,15700191,15700259,15700271&amp;usg=ALkJrhiWG1hdOGfmeHRrerU48xLwp8NTuQ#MJMATHI-69" x="2670" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700023,15700186,15700191,15700259,15700271&amp;usg=ALkJrhiWG1hdOGfmeHRrerU48xLwp8NTuQ#MJMATHI-6E" x="3015" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700023,15700186,15700191,15700259,15700271&amp;usg=ALkJrhiWG1hdOGfmeHRrerU48xLwp8NTuQ#MJMATHI-69" x="3616" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700023,15700186,15700191,15700259,15700271&amp;usg=ALkJrhiWG1hdOGfmeHRrerU48xLwp8NTuQ#MJMATHI-74" x="3961" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700023,15700186,15700191,15700259,15700271&amp;usg=ALkJrhiWG1hdOGfmeHRrerU48xLwp8NTuQ#MJMAIN-2C" x="4323" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700023,15700186,15700191,15700259,15700271&amp;usg=ALkJrhiWG1hdOGfmeHRrerU48xLwp8NTuQ#MJMATHI-41" x="4768" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700023,15700186,15700191,15700259,15700271&amp;usg=ALkJrhiWG1hdOGfmeHRrerU48xLwp8NTuQ#MJMAIN-7C" x="5518" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700023,15700186,15700191,15700259,15700271&amp;usg=ALkJrhiWG1hdOGfmeHRrerU48xLwp8NTuQ#MJMAIN-7C" x="5797" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700023,15700186,15700191,15700259,15700271&amp;usg=ALkJrhiWG1hdOGfmeHRrerU48xLwp8NTuQ#MJMATHI-42" x="6075" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700023,15700186,15700191,15700259,15700271&amp;usg=ALkJrhiWG1hdOGfmeHRrerU48xLwp8NTuQ#MJMAIN-29" x="6835" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700023,15700186,15700191,15700259,15700271&amp;usg=ALkJrhiWG1hdOGfmeHRrerU48xLwp8NTuQ#MJMAIN-3D" x="7502" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700023,15700186,15700191,15700259,15700271&amp;usg=ALkJrhiWG1hdOGfmeHRrerU48xLwp8NTuQ#MJMATHI-43" x="8558" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700023,15700186,15700191,15700259,15700271&amp;usg=ALkJrhiWG1hdOGfmeHRrerU48xLwp8NTuQ#MJMATHI-52" x="9319" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700023,15700186,15700191,15700259,15700271&amp;usg=ALkJrhiWG1hdOGfmeHRrerU48xLwp8NTuQ#MJMATHI-43" x="10078" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700023,15700186,15700191,15700259,15700271&amp;usg=ALkJrhiWG1hdOGfmeHRrerU48xLwp8NTuQ#MJMAIN-28" x="10839" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700023,15700186,15700191,15700259,15700271&amp;usg=ALkJrhiWG1hdOGfmeHRrerU48xLwp8NTuQ#MJMATHI-43" x="11228" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700023,15700186,15700191,15700259,15700271&amp;usg=ALkJrhiWG1hdOGfmeHRrerU48xLwp8NTuQ#MJMATHI-52" x="11989" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700023,15700186,15700191,15700259,15700271&amp;usg=ALkJrhiWG1hdOGfmeHRrerU48xLwp8NTuQ#MJMATHI-43" x="12748" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700023,15700186,15700191,15700259,15700271&amp;usg=ALkJrhiWG1hdOGfmeHRrerU48xLwp8NTuQ#MJMAIN-28" x="13509" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700023,15700186,15700191,15700259,15700271&amp;usg=ALkJrhiWG1hdOGfmeHRrerU48xLwp8NTuQ#MJMATHI-69" x="13898" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700023,15700186,15700191,15700259,15700271&amp;usg=ALkJrhiWG1hdOGfmeHRrerU48xLwp8NTuQ#MJMATHI-6E" x="14244" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700023,15700186,15700191,15700259,15700271&amp;usg=ALkJrhiWG1hdOGfmeHRrerU48xLwp8NTuQ#MJMATHI-69" x="14844" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700023,15700186,15700191,15700259,15700271&amp;usg=ALkJrhiWG1hdOGfmeHRrerU48xLwp8NTuQ#MJMATHI-74" x="15190" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700023,15700186,15700191,15700259,15700271&amp;usg=ALkJrhiWG1hdOGfmeHRrerU48xLwp8NTuQ#MJMAIN-2C" x="15551" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700023,15700186,15700191,15700259,15700271&amp;usg=ALkJrhiWG1hdOGfmeHRrerU48xLwp8NTuQ#MJMATHI-41" x="15996" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700023,15700186,15700191,15700259,15700271&amp;usg=ALkJrhiWG1hdOGfmeHRrerU48xLwp8NTuQ#MJMAIN-29" x="16747" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700023,15700186,15700191,15700259,15700271&amp;usg=ALkJrhiWG1hdOGfmeHRrerU48xLwp8NTuQ#MJMAIN-2C" x="17136" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700023,15700186,15700191,15700259,15700271&amp;usg=ALkJrhiWG1hdOGfmeHRrerU48xLwp8NTuQ#MJMATHI-42" x="17582" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700023,15700186,15700191,15700259,15700271&amp;usg=ALkJrhiWG1hdOGfmeHRrerU48xLwp8NTuQ#MJMAIN-29" x="18341" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>C</mi><mi>R</mi><mi>C</mi><mo stretchy="false">(</mo><mi>i</mi><mi>n</mi><mi>i</mi><mi>t</mi><mo>,</mo><mi>A</mi><mrow class="MJX-TeXAtom-ORD"><mo stretchy="false">|</mo></mrow><mrow class="MJX-TeXAtom-ORD"><mo stretchy="false">|</mo></mrow><mi>B</mi><mo stretchy="false">)</mo><mo>=</mo><mi>C</mi><mi>R</mi><mi>C</mi><mo stretchy="false">(</mo><mi>C</mi><mi>R</mi><mi>C</mi><mo stretchy="false">(</mo><mi>i</mi><mi>n</mi><mi>i</mi><mi>t</mi><mo>,</mo><mi>A</mi><mo stretchy="false">)</mo><mo>,</mo><mi>B</mi><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-3">CRC(init, A || B) = CRC(CRC(init, A), B)</script></em>  <em>. <br>      CRC         .</em> </p><br><p>        . </p><br><p>    ,         0x00  0xff (       0xff,      ; 0x00    ). </p><br><h2 id="primernye-algoritmy">   </h2><br><h3 id="chtenie-iz-flesh-pamyati">   - </h3><br><p>       . <br>      —       -  . </p><br><p> <em>(  , Linux     NOR Flash, )</em> </p><br><h3 id="zapis-v-flesh-pamyat">   - </h3><br><p>  . <br>  . </p><br><p>        —       . </p><br><h3 id="podgotovka-novoy-mikroshemy-k-rabote">      </h3><br><p>     ( )      1. <br>         ( UUID    ). </p><br><p> , -   . </p><br><h3 id="zagruzka-avtomata">   </h3><br><p>     8    ( + CRC),    Magic Number   CRC . <br>  ""      ,    ,   . <br>   ,   CRC,   "".    —    .   —   ,    "" . <br>      , ,    "" . <br>   zlib (      ). </p><br><p> ,  ,  ,  . </p><br><h3 id="dobavlenie-zapisi-v-zhurnal">     </h3><br><p>     ,  Z_SYNC_FLUSH.,       . <br>    (     CRC) —    (. ). <br>    CRC.    —   . </p><br><h3 id="novaya-stranica">   </h3><br><p>       (              ).     —       ,     . <br>    erase.    0xff.  -   —    ,  .. <br>     ,     ,  —    (  ). </p><br><h1 id="primenimost-formata">   </h1><br><p>   ,       -    ( , JSON, MessagePack, CBOR, , protobuf)  NOR Flash. </p><br><p> ,  ""  SLC NOR Flash. </p><br><p>         BER,  NAND  MLC NOR <em>(      ?        )</em> . </p><br><p>  ,      ,   FTL: USB flash, SD, MicroSD, etc <em>(          512 ,          —   ""        )</em> . </p><br><p>             128 (16)  1 (128).         , , ,     <em>(      ,   NOR Flash    )</em> . </p><br><p>  -   ,         — ,   ,      github. </p><br><h1 id="zaklyuchenie"> 结论 </h1><br><p>  ,      <em>  </em> . </p><br><p>        ,  :     - , ,         . ,  () -         . </p><br><p>    ,   ? 当然可以   , ,      .   -        . </p><br><p>        ?  ,       ,   .    . </p><br><p>    ,       ,   " ". </p><br><p>        ,       <em>()</em>   , ,    ""  (, ,     ;      ).        <em>(    —   )</em> . </p><br><p>          ,      . </p><br><h1 id="literatura"> 文学作品 </h1><br><p>        ,       . </p><br><p>      ,     ,        ,      : </p><br><ol><li>  <a href="https://github.com/madler/infgen/" rel="nofollow">infgen</a>   zlib.        deflate/zlib/gzip.         deflate ( gzip) —  . </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN479044/">https://habr.com/ru/post/zh-CN479044/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN479034/index.html">如何使用openconnect和vpn-slice连接到Linux中的公司VPN</a></li>
<li><a href="../zh-CN479036/index.html">英特尔无法满足对处理器的需求。 惠普和戴尔因此而受苦</a></li>
<li><a href="../zh-CN479038/index.html">数字转换Leroy Merlin：设计用于处理客户呼叫的接口</a></li>
<li><a href="../zh-CN479040/index.html">视觉回归测试。 重新开机</a></li>
<li><a href="../zh-CN479042/index.html">Y方法是构建魔方的一种非常简单的方法</a></li>
<li><a href="../zh-CN479048/index.html">用于假人的Node.js流或如何使用流</a></li>
<li><a href="../zh-CN479050/index.html">IT领域的专利研究。 年轻战士的历程。 第二部分 专利研究的信息来源</a></li>
<li><a href="../zh-CN479052/index.html">[Supercomputing 2019]。 多云存储作为新金士顿DC1000M驱动器的应用程序</a></li>
<li><a href="../zh-CN479054/index.html">星期五手机投票</a></li>
<li><a href="../zh-CN479056/index.html">谈人生？ DREAM团队参加Alexa奖Socialbot挑战赛3</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>