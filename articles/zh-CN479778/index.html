<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘©ğŸ¼â€ğŸ¤â€ğŸ‘©ğŸ» ğŸˆ¯ï¸ ğŸ¤¾ğŸ» ï¼ƒæ³¨æ„ã€‚ æ³¨æ„ConcurrentHashMapä¸­çš„åŸå­æ“ä½œ ğŸ‘³ ğŸ’ªğŸ¾ ğŸ¹</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="è‡ªè¿œå¤ä»¥æ¥ï¼ŒJavaå°±æ‹¥æœ‰äº†å¾ˆæ£’çš„Mapæ¥å£åŠå…¶å®ç°ï¼Œç‰¹åˆ«æ˜¯HashMap ã€‚ ä»Java 5å¼€å§‹ï¼Œè¿˜æœ‰ConcurrentHashMap ã€‚ è€ƒè™‘è¿™ä¸¤ç§å®ç°æ–¹å¼ï¼Œå®ƒä»¬çš„æ¼”å˜ä»¥åŠè¿™ç§æ¼”å˜ä¼šå¯¼è‡´å¼€å‘äººå‘˜ä¸ä¸“å¿ƒçš„æƒ…å†µã€‚ 

 è­¦å‘Šï¼šæœ¬æ–‡ä½¿ç”¨æ¥è‡ªOpenJDK 8æºä»£ç çš„å¼•ç”¨ï¼Œè¯¥æºä»£ç åœ¨GNUé€šç”¨å…¬å…±è®¸å¯...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ï¼ƒæ³¨æ„ã€‚ æ³¨æ„ConcurrentHashMapä¸­çš„åŸå­æ“ä½œ</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/krista/blog/479778/"><img src="https://habrastorage.org/webt/n3/kl/xh/n3klxhqmcb1xqgomjbzvprnoyvo.jpeg"><br><br> è‡ªè¿œå¤ä»¥æ¥ï¼ŒJavaå°±æ‹¥æœ‰äº†å¾ˆæ£’çš„<a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html">Map</a>æ¥å£åŠå…¶å®ç°ï¼Œç‰¹åˆ«æ˜¯<a href="https://docs.oracle.com/javase/8/docs/api/java/util/HashMap.html">HashMap</a> ã€‚ ä»Java 5å¼€å§‹ï¼Œè¿˜æœ‰<a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentHashMap.html">ConcurrentHashMap</a> ã€‚ è€ƒè™‘è¿™ä¸¤ç§å®ç°æ–¹å¼ï¼Œå®ƒä»¬çš„æ¼”å˜ä»¥åŠè¿™ç§æ¼”å˜ä¼šå¯¼è‡´å¼€å‘äººå‘˜ä¸ä¸“å¿ƒçš„æƒ…å†µã€‚ <br><br> è­¦å‘Šï¼šæœ¬æ–‡ä½¿ç”¨æ¥è‡ªOpenJDK 8æºä»£ç çš„å¼•ç”¨ï¼Œè¯¥æºä»£ç åœ¨GNUé€šç”¨å…¬å…±è®¸å¯è¯ç‰ˆæœ¬2ä¸‹åˆ†å‘ã€‚ <br><a name="habracut"></a><br><h2>  Java 8ä¹‹å‰çš„æ—¶ä»£ </h2><br> é‚£äº›å‘ç°ç­‰å¾…æ—¶é—´å¾ˆé•¿çš„äººï¼Œé¦–å…ˆæ˜¯Java 7ï¼Œç„¶åæ˜¯Java 8ï¼ˆç°åœ¨ä¸åƒç°åœ¨ï¼Œæ¯å…­ä¸ªæœˆæœ‰ä¸€ä¸ªæ–°ç‰ˆæœ¬ï¼‰ï¼Œè®°ä½ä½¿ç”¨Mapè¿›è¡Œå“ªäº›æ“ä½œæœ€å—æ¬¢è¿ã€‚ è¿™æ˜¯ï¼š <br><br><ul><li>  <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html">V Map.putï¼ˆKé”®ï¼ŒVå€¼ï¼‰</a> </li><li>  <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html">V Map.getï¼ˆå¯¹è±¡é”®ï¼‰</a> </li></ul><br> å¦‚æœæ‚¨éœ€è¦åœ¨é›†åˆä¸­æ·»åŠ å€¼ï¼Œåˆ™ä½¿ç”¨ç¬¬ä¸€ç§æ–¹æ³•ï¼Œè¦è·å–ç°æœ‰å€¼ï¼Œè¯·ä½¿ç”¨ç¬¬äºŒç§æ–¹æ³•ã€‚ <br><br> ä½†æ˜¯ï¼Œå¦‚æœéœ€è¦å»¶è¿Ÿåˆå§‹åŒ–æ€ä¹ˆåŠï¼Ÿ ç„¶åå‡ºç°äº†è¿™æ ·çš„ä»£ç ï¼š <br><br><pre><code class="java hljs"><span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getOrPut</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String key)</span></span></span><span class="hljs-function"> </span></span>{ String result = map.get(key); <span class="hljs-comment"><span class="hljs-comment">//(1) if (result == null) { //(2) result = createValue(key); //(3) map.put(key, result); //(4) } return result; }</span></span></code> </pre> <br><ol><li> æˆ‘ä»¬é€šè¿‡é’¥åŒ™å¾—åˆ°ä»·å€¼ </li><li> æ£€æŸ¥æ˜¯å¦æ‰¾åˆ°æ‰€éœ€çš„å€¼ </li><li> å¦‚æœæ‰¾ä¸åˆ°å€¼ï¼Œåˆ™åˆ›å»ºå®ƒ </li><li> é€šè¿‡é”®ä¸ºæ”¶è—æ·»åŠ ä»·å€¼ </li></ol><br> åŸæ¥æœ‰ç‚¹éº»çƒ¦ï¼Œä¸æ˜¯å—ï¼Ÿ è€Œä¸”ï¼Œåœ¨ä½¿ç”¨ç®€å•çš„HashMapçš„æƒ…å†µä¸‹ï¼Œè¿™åªæ˜¯ä¸æ–¹ä¾¿é˜…è¯»çš„ä»£ç ï¼Œå› ä¸º ä»–æ²¡æœ‰ç©¿çº¿ã€‚ ä½†æ˜¯å¯¹äºConcurrentHashMapï¼Œä¼šå¼¹å‡ºä¸€ä¸ªé™„åŠ åŠŸèƒ½ï¼šå¦‚æœå¤šä¸ªçº¿ç¨‹åœ¨å…¶ä¸­ä¸€ä¸ªå°†å€¼å†™å…¥é›†åˆï¼ˆ3ï¼‰ä¹‹å‰è®¾æ³•æ£€æŸ¥æ¡ä»¶ï¼ˆ1ï¼‰ï¼Œåˆ™å¯ä»¥å¤šæ¬¡è°ƒç”¨createValueï¼ˆ2ï¼‰æ–¹æ³•ã€‚ è¿™ç§è¡Œä¸ºé€šå¸¸ä¼šå¯¼è‡´ä¸è‰¯åæœã€‚ <br><br> åœ¨Java 8ä¹‹å‰ï¼Œæ ¹æœ¬æ²¡æœ‰ä¼˜é›…çš„é€‰æ‹©ã€‚ å¦‚æœæ‚¨éœ€è¦èº²é¿å¤šä¸ªå€¼çš„åˆ›å»ºï¼Œåˆ™å¿…é¡»ä½¿ç”¨å…¶ä»–é”ã€‚ <br>  Java 8ä½¿äº‹æƒ…å˜å¾—æ›´å®¹æ˜“ã€‚ å¥½åƒ... <br><br><h2>  Java 8æ¥äº†... </h2><br>  Java 8å¸¦ç»™æˆ‘ä»¬çš„æœ€ä»¤äººæœŸå¾…çš„åŠŸèƒ½æ˜¯ä»€ä¹ˆï¼Ÿ æ˜¯çš„ï¼Œlambdaã€‚ ä¸ä»…æ˜¯ç¾æ´²é©¼ï¼Œè€Œä¸”è¿˜æ”¯æŒæ ‡å‡†åº“ä¸­æ‰€æœ‰å„ç§APIã€‚ åœ°å›¾æ•°æ®ç»“æ„æœªè¢«å¿½ç•¥ã€‚ ç‰¹åˆ«æ˜¯å‡ºç°äº†ä»¥ä¸‹æ–¹æ³•ï¼š <br><br><ul><li>  <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html">computeIfAbsent</a> </li><li>  <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html">computeIfPresent</a> </li><li>  <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html">æ¯æ¬¡</a> </li><li> ç­‰ </li></ul><br> ç”±äºè¿™äº›æ–¹æ³•ï¼Œå¯ä»¥é‡å†™å‰é¢ç»™å‡ºçš„ä»£ç è¦ç®€å•å¾—å¤šï¼š <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getOrPut</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String key)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> map.computeIfAbsent(key, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>::createValue); }</code> </pre><br> æ˜¾ç„¶ï¼Œæ²¡æœ‰äººä¼šæ”¾å¼ƒç®€åŒ–å…¶ä»£ç çš„æœºä¼šã€‚ æ­¤å¤–ï¼Œåœ¨ConcurrentHashMapçš„æƒ…å†µä¸‹ï¼Œ <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentHashMap.html">computeIfAbsent</a>æ–¹æ³•ä¹Ÿè‡ªåŠ¨æ‰§è¡Œã€‚ å³ ä»…å½“ç¼ºå°‘æ‰€éœ€å€¼æ—¶ï¼ŒcreateValueæ‰ä¼šè¢«ç²¾ç¡®è°ƒç”¨ä¸€æ¬¡ã€‚ <br><br>  IDEä¹Ÿæ²¡æœ‰é€šè¿‡ã€‚ å› æ­¤ï¼ŒIntelliJ IDEAæä¾›äº†è‡ªåŠ¨æ›¿æ¢æ—§ç‰ˆæœ¬å’Œæ–°ç‰ˆæœ¬çš„åŠŸèƒ½ï¼š <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ir/5r/nr/ir5rnrjz71vghcycvujmdcunyho.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ey/uu/ox/eyuuoxjeyqhfc8k3wxq46dlv26m.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/sz/6n/br/sz6nbrvaq_-sbj2ljwxktdnxw1y.png"></div><br> å¾ˆæ˜æ˜¾ï¼Œä»£ç ç®€åŒ–å’ŒIDEæç¤ºéƒ½é¼“åŠ±å¼€å‘äººå‘˜ä½¿ç”¨æ­¤æ–°APIã€‚ ç»“æœï¼ŒåŒä¸€computeIfAbsentå¼€å§‹å‡ºç°åœ¨ä»£ç ä¸­çš„å¾ˆå¤šåœ°æ–¹ã€‚ <br> å†è§... <br><br><h2> çªç„¶ä¹‹é—´ï¼ </h2><br> ç›´åˆ°ä¸‹ä¸€æ¬¡è´Ÿè½½æµ‹è¯•çš„æ—¶å€™åˆ°äº†ã€‚ ç„¶åå‡ºç°äº†ä¸€ä»¶å¯æ€•çš„äº‹æƒ…ï¼š <br><br><img src="https://habrastorage.org/webt/1i/o1/5q/1io15qqi3scznkqnzuemfbbe61g.png"><br><br> è¯¥åº”ç”¨ç¨‹åºé€‚ç”¨äºä»¥ä¸‹ç‰ˆæœ¬çš„Javaï¼š <br><br><pre> openjdkç‰ˆæœ¬â€œ 1.8.0_222â€
 OpenJDKè¿è¡Œæ—¶ç¯å¢ƒï¼ˆå†…éƒ¨ç‰ˆæœ¬1.8.0_222-8u222-b10-1ubuntu1ã€œ18.04.1-b10ï¼‰
 OpenJDK 64ä½æœåŠ¡å™¨VMï¼ˆå†…éƒ¨ç‰ˆæœ¬25.222-b10ï¼Œæ··åˆæ¨¡å¼ï¼‰
</pre><br><br> å¯¹äºé‚£äº›ä¸ç†Ÿæ‚‰è¯¸å¦‚<a href="https://www.yourkit.com/features/">YourKitä¹‹</a>ç±»çš„å‡ºè‰²å·¥å…·çš„ç”¨æˆ·ã€‚ <br><br> åœ¨å±å¹•å¿«ç…§ä¸­ï¼Œæ°´å¹³ç²—çº¿åŠæ—¶æ˜¾ç¤ºäº†åº”ç”¨ç¨‹åºçº¿ç¨‹çš„æ“ä½œã€‚ æ ¹æ®ç‰¹å®šæ—¶é—´æµçš„çŠ¶æ€ï¼Œå°†æ¡å¸¦æ¶‚æˆç›¸åº”çš„é¢œè‰²ï¼š <br><br><ul><li> é»„è‰²-æµç©ºé—²ï¼Œæ­£åœ¨ç­‰å¾…å·¥ä½œï¼› </li><li> ç»¿è‰²-çº¿ç¨‹æ­£åœ¨è¿è¡Œï¼Œæ­£åœ¨æ‰§è¡Œç¨‹åºä»£ç ï¼› </li><li> çº¢è‰²-è¯¥çº¿ç¨‹è¢«å¦ä¸€ä¸ªçº¿ç¨‹é˜»æ­¢ã€‚ </li></ul><br> ä¹Ÿå°±æ˜¯è¯´ï¼Œäº‹å®è¯æ˜ï¼Œå‡ ä¹æ‰€æœ‰çº¿ç¨‹ï¼ˆå®é™…ä¸Šï¼Œå±å¹•æˆªå›¾ä¸­æ˜¾ç¤ºçš„çº¿ç¨‹è¿œè¿œè¶…è¿‡æ‰€æœ‰çº¿ç¨‹ï¼‰å‡ ä¹å§‹ç»ˆå¤„äºé˜»å¡çŠ¶æ€ã€‚ è€Œä¸”ï¼Œæ‰€æœ‰é”éƒ½åœ¨ConcurrentHashMapçš„ç›¸åŒcomputeIfAbsentä¸­ï¼ å°½ç®¡å­˜åœ¨è¿™ç§äº‹å®ï¼Œä½†ç”±äºæ­¤ç‰¹å®šè´Ÿè½½æµ‹è¯•çš„å…·ä½“æƒ…å†µï¼Œè¯¥é›†åˆä¸­æœ€å¤šåªèƒ½å­˜å‚¨6-8ä¸ªå€¼ã€‚ å³ ç»™å®šä½ç½®ä¸­çš„å‡ ä¹æ‰€æœ‰æ“ä½œä»…æ˜¯å¯¹ç°æœ‰å€¼çš„è¯»å–ã€‚ <br><br> ä½†æ˜¯ç­‰ç­‰ï¼Œæ€ä¹ˆåŠï¼Ÿ å®é™…ä¸Šï¼Œå³ä½¿åœ¨æœ‰å…³é˜»å¡æ–¹æ³•çš„æ–‡æ¡£ä¸­ï¼Œä¹Ÿä»…åœ¨æ›´æ–°çš„é™„å½•ä¸­è¯´è¿‡ï¼š <br>  â€œå¦‚æœæŒ‡å®šçš„é”®å°šæœªä¸æŸä¸ªå€¼å…³è”ï¼Œè¯·å°è¯•ä½¿ç”¨ç»™å®šçš„æ˜ å°„å‡½æ•°è®¡ç®—å…¶å€¼ï¼Œå¹¶å°†å…¶è¾“å…¥åˆ°æ­¤æ˜ å°„ä¸­ï¼Œé™¤éä¸ºnullã€‚ æ•´ä¸ªæ–¹æ³•è°ƒç”¨æ˜¯åŸå­æ‰§è¡Œçš„ï¼Œå› æ­¤æ¯ä¸ªé”®æœ€å¤šå¯åº”ç”¨ä¸€æ¬¡è¯¥åŠŸèƒ½ã€‚ åœ¨è®¡ç®—è¿›è¡ŒæœŸé—´ï¼Œå¯èƒ½ä¼šé˜»æ­¢å…¶ä»–çº¿ç¨‹åœ¨æ­¤æ˜ å°„ä¸Šè¿›è¡Œçš„æŸäº›å°è¯•çš„æ›´æ–°æ“ä½œï¼Œå› æ­¤è®¡ç®—åº”ç®€çŸ­è€Œç®€å•ï¼Œå¹¶ä¸”ä¸å¾—å°è¯•æ›´æ–°æ­¤æ˜ å°„çš„ä»»ä½•å…¶ä»–æ˜ å°„ã€‚â€ <br><br> å®é™…ä¸Šï¼Œä¸€åˆ‡å¹¶éå¦‚æ­¤ã€‚ å¦‚æœæŸ¥çœ‹æ­¤æ–¹æ³•çš„æºä»£ç ï¼Œç»“æœå‘ç°å®ƒåŒ…å«ä¸¤ä¸ªéå¸¸åšçš„åŒæ­¥å—ï¼š <br><br><div class="spoiler">  <b class="spoiler_title">ConcurrentHashMap.computeIfAbsentçš„å®ç°</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> V </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">computeIfAbsent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(K key, Function&lt;? </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">super</span></span></span></span><span class="hljs-function"><span class="hljs-params"> K, ? extends V&gt; mappingFunction)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (key == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> || mappingFunction == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NullPointerException(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> h = spread(key.hashCode()); V val = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> binCount = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Node&lt;K,V&gt;[] tab = table;;) { Node&lt;K,V&gt; f; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> n, i, fh; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tab == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> || (n = tab.length) == <span class="hljs-number"><span class="hljs-number">0</span></span>) tab = initTable(); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((f = tabAt(tab, i = (n - <span class="hljs-number"><span class="hljs-number">1</span></span>) &amp; h)) == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { Node&lt;K,V&gt; r = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReservationNode&lt;K,V&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">synchronized</span></span> (r) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (casTabAt(tab, i, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, r)) { binCount = <span class="hljs-number"><span class="hljs-number">1</span></span>; Node&lt;K,V&gt; node = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((val = mappingFunction.apply(key)) != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) node = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Node&lt;K,V&gt;(h, key, val, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { setTabAt(tab, i, node); } } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (binCount != <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((fh = f.hash) == MOVED) tab = helpTransfer(tab, f); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> added = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">synchronized</span></span> (f) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tabAt(tab, i) == f) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fh &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { binCount = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Node&lt;K,V&gt; e = f;; ++binCount) { K ek; V ev; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e.hash == h &amp;&amp; ((ek = e.key) == key || (ek != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; key.equals(ek)))) { val = e.val; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } Node&lt;K,V&gt; pred = e; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((e = e.next) == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((val = mappingFunction.apply(key)) != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { added = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; pred.next = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Node&lt;K,V&gt;(h, key, val, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (f <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> TreeBin) { binCount = <span class="hljs-number"><span class="hljs-number">2</span></span>; TreeBin&lt;K,V&gt; t = (TreeBin&lt;K,V&gt;)f; TreeNode&lt;K,V&gt; r, p; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((r = t.root) != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; (p = r.findTreeNode(h, key, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>)) != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) val = p.val; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((val = mappingFunction.apply(key)) != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { added = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; t.putTreeVal(h, key, val); } } } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (binCount != <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (binCount &gt;= TREEIFY_THRESHOLD) treeifyBin(tab, i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!added) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> val; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (val != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) addCount(<span class="hljs-number"><span class="hljs-number">1L</span></span>, binCount); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> val; }</code> </pre><br></div></div><br> ä»ä»¥ä¸Šç¤ºä¾‹å¯ä»¥çœ‹å‡ºï¼Œç»“æœåªèƒ½åœ¨å…­ä¸ªç‚¹å½¢æˆï¼Œå¹¶ä¸”å‡ ä¹æ‰€æœ‰è¿™äº›ä½ç½®éƒ½åœ¨åŒæ­¥å—å†…éƒ¨ã€‚ å‡ºä¹æ„æ–™çš„ã€‚ æ­¤å¤–ï¼Œç®€å•çš„<a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentHashMap.html">è·å–</a>æ ¹æœ¬ä¸åŒ…å«åŒæ­¥ï¼š <br><br><div class="spoiler">  <b class="spoiler_title">ConcurrentHashMap.getçš„å®ç°</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> V </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object key)</span></span></span><span class="hljs-function"> </span></span>{ Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; e, p; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> n, eh; K ek; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> h = spread(key.hashCode()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((tab = table) != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; (n = tab.length) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; (e = tabAt(tab, (n - <span class="hljs-number"><span class="hljs-number">1</span></span>) &amp; h)) != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((eh = e.hash) == h) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((ek = e.key) == key || (ek != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; key.equals(ek))) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> e.val; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (eh &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (p = e.find(h, key)) != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> ? p.val : <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ((e = e.next) != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e.hash == h &amp;&amp; ((ek = e.key) == key || (ek != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; key.equals(ek)))) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> e.val; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; }</code> </pre><br></div></div><br> é‚£è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ å®é™…ä¸Šï¼Œåªæœ‰ä¸¤ç§é€‰æ‹©ï¼šè¦ä¹ˆè¿”å›åŸå§‹ä»£ç ï¼Œè¦ä¹ˆä½¿ç”¨å®ƒï¼Œä½†æ˜¯åœ¨ç»è¿‡ç¨å¾®ä¿®æ”¹çš„ç‰ˆæœ¬ä¸­ï¼š <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getOrPut</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String key)</span></span></span><span class="hljs-function"> </span></span>{ String result = map.get(key); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (result != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) ? result : map.computeIfAbsent(key, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>::createValue); }</code> </pre><br><h2> ç»“è®º </h2><br> æ€»çš„æ¥è¯´ï¼Œè¿™ç§çœ‹ä¼¼å¹³åº¸çš„é‡æ„é€ æˆçš„è‡´å‘½åæœéå¸¸ä»¤äººæ„å¤–ã€‚ ä»…é€šè¿‡å‹åŠ›æµ‹è¯•å³å¯æˆåŠŸæŒ½æ•‘è¿™ç§æƒ…å†µï¼Œå‹åŠ›æµ‹è¯•æˆåŠŸåœ°æ­ç¤ºäº†æ€§èƒ½ä¸‹é™ã€‚ <br><br> å¹¸è¿çš„æ˜¯ï¼Œè¾ƒæ–°çš„Javaç‰ˆæœ¬<a href="https://bugs.openjdk.java.net/browse/JDK-8161372">è§£å†³äº†</a>æ­¤é—®é¢˜ï¼š <a href="https://bugs.openjdk.java.net/browse/JDK-8161372">JDK-8161372</a> ã€‚ <br><br> å› æ­¤è¦å°å¿ƒï¼Œä¸è¦ç›¸ä¿¡è¯±äººçš„æŠ€å·§å¹¶ç¼–å†™æµ‹è¯•ã€‚ ç‰¹åˆ«å‹åŠ›å¤§ã€‚ <br><br>  Javaç»™å¤§å®¶ï¼ <br><br>  <b>UPD1ï¼š</b>æ­£å¦‚<b>Coldwind</b>æ­£ç¡®æŒ‡å‡ºçš„<a href="https://habr.com/ru/users/coldwind/" class="user_link">é‚£æ ·</a> ï¼Œè¯¥é—®é¢˜æ˜¯å·²çŸ¥çš„ï¼š <a href="https://bugs.openjdk.java.net/browse/JDK-8161372">JDK-8161372</a> ã€‚ è€Œä¸”ï¼Œå®ƒä¼¼ä¹åœ¨Java 9ä¸­æ˜¯å›ºå®šçš„ã€‚ä½†æ˜¯ï¼Œåœ¨ä»¥Java 8ï¼ŒJava 11ç”šè‡³Java 13å‘å¸ƒæœ¬æ–‡æ—¶ï¼Œæ­¤æ–¹æ³•ä¿æŒä¸å˜ã€‚ <br><br>  <b>UPD2ï¼š</b> <a href="https://habr.com/ru/users/vkovalchuk/" class="user_link">vkovalchuk</a>å¼•èµ·äº†æˆ‘çš„ç²—å¿ƒã€‚ ç¡®å®ï¼Œå¯¹äºJava 9å’Œæ›´é«˜ç‰ˆæœ¬ï¼Œé€šè¿‡æ·»åŠ å¦ä¸€ä¸ªæ¡ä»¶å¹¶è¿”å›ç»“æœè€Œä¸ä¼šé˜»å¡æ¥è§£å†³æ­¤é—®é¢˜ï¼š <br><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fh == h <span class="hljs-comment"><span class="hljs-comment">// check first node without acquiring lock &amp;&amp; ((fk = f.key) == key || (fk != null &amp;&amp; key.equals(fk))) &amp;&amp; (fv = f.val) != null) return fv;</span></span></code> </pre><br><br> æœ€åˆï¼Œæˆ‘é‡åˆ°äº†Javaä¸‹ä¸€ç‰ˆæœ¬çš„æƒ…å†µï¼š <br><br><pre> openjdkç‰ˆæœ¬â€œ 1.8.0_222â€
 OpenJDKè¿è¡Œæ—¶ç¯å¢ƒï¼ˆå†…éƒ¨ç‰ˆæœ¬1.8.0_222-8u222-b10-1ubuntu1ã€œ18.04.1-b10ï¼‰
 OpenJDK 64ä½æœåŠ¡å™¨VMï¼ˆå†…éƒ¨ç‰ˆæœ¬25.222-b10ï¼Œæ··åˆæ¨¡å¼ï¼‰
</pre><br><br> å½“æˆ‘æŸ¥çœ‹æ›´é«˜ç‰ˆæœ¬çš„èµ„æºæ—¶ï¼Œæˆ‘ç¡®å®é”™è¿‡äº†è¿™äº›å†…å®¹ï¼Œè¿™ä½¿æˆ‘è¯¯å…¥æ­§é€”ã€‚ <br><br> å› æ­¤ï¼Œä¸ºäº†å…¬æ­£èµ·è§ï¼Œæˆ‘æ›´æ­£äº†æœ¬æ–‡çš„æ­£æ–‡ã€‚ </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN479778/">https://habr.com/ru/post/zh-CN479778/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN479762/index.html">å¼€å‘äººå‘˜åœ¨ç¼–å†™HTMLå’ŒCSSæ—¶çŠ¯çš„6ä¸ªæœ€å¸¸è§é”™è¯¯</a></li>
<li><a href="../zh-CN479764/index.html">è«æ–¯ç§‘äº¤æ˜“æ‰€çš„ç§äººæŠ•èµ„è€…æ•°é‡è¶…è¿‡350ä¸‡äºº</a></li>
<li><a href="../zh-CN479768/index.html">å®‰è£…å’Œé…ç½®AlienVault SIEMï¼ˆOSSIMï¼‰</a></li>
<li><a href="../zh-CN479774/index.html">é€šè¿‡å‘¨å›´ç¯å¢ƒè¿›è¡Œå™äº‹æˆ–ä¸ºä»€ä¹ˆåœºæ™¯ä¸æ˜¯ä¸‡çµä¸¹</a></li>
<li><a href="../zh-CN479776/index.html">ä¸“ä¸šæ—…è¡Œï¼šç©ºå§å¦‚ä½•ç”Ÿæ´»</a></li>
<li><a href="../zh-CN479780/index.html">DevOps Moscow Meetup 17/12ï¼šåŠ å…¥å¹¿æ’­</a></li>
<li><a href="../zh-CN479790/index.html">ä¸‰ä¸ªå­µåŒ–å™¨ä¸ºç¬¬ä¸€æ‰¹å­¦ç”Ÿè¿›è¡Œäº†åŸå‹è®¾è®¡è¯¾ç¨‹</a></li>
<li><a href="../zh-CN479794/index.html">æˆ‘ä»¬ç»“åˆäº†â€œå„¿ç«¥â€å¾®æ§åˆ¶å™¨å’Œæ£‹ç›˜æ¸¸æˆ</a></li>
<li><a href="../zh-CN479796/index.html">é‡‘å£«é¡¿çš„è¨è¯ºæ–¯çº§å¨èƒ</a></li>
<li><a href="../zh-CN479800/index.html">æˆ‘æ­£åœ¨ç”¨Cï¼ƒç¼–å†™ï¼Œä»¥ä¾¿å‰ç«¯æ›´å®¹æ˜“</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>