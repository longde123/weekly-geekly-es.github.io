<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëÇüèΩ üñêüèæ üçò Unsichtbare Bereitstellung einer monolithischen Anwendung in der Produktion unter AWS. Pers√∂nliche Erfahrung üíí ü•ô üêØ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ich bin Lead DevOps Engineer bei Miro (ex-RealtimeBoard). Ich werde berichten, wie unser DevOps-Team das Problem der t√§glichen Server-Releases einer m...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Unsichtbare Bereitstellung einer monolithischen Anwendung in der Produktion unter AWS. Pers√∂nliche Erfahrung</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/miro/blog/436444/">  Ich bin Lead DevOps Engineer bei Miro (ex-RealtimeBoard).  Ich werde berichten, wie unser DevOps-Team das Problem der t√§glichen Server-Releases einer monolithischen Stateful-Anwendung gel√∂st und sie automatisch, f√ºr Benutzer unsichtbar und f√ºr ihre eigenen Entwickler praktisch gemacht hat. <br><br><h2>  Unsere Infrastruktur </h2><br>  Unser Entwicklungsteam besteht aus 60 Personen, die in Scrum-Teams aufgeteilt sind, darunter auch das DevOps-Team.  Die meisten Scrum-Befehle unterst√ºtzen die aktuelle Funktionalit√§t des Produkts und bieten neue Funktionen.  Die Aufgabe von DevOps besteht darin, eine Infrastruktur zu erstellen und zu warten, mit der die Anwendung schnell und zuverl√§ssig arbeitet und die es den Teams erm√∂glicht, Benutzern schnell neue Funktionen bereitzustellen. <br><img src="https://habrastorage.org/webt/sh/f-/qy/shf-qy6dzbfvuzonf4h5yf5iupk.png"><br><a name="habracut"></a><br><br>  Unsere Anwendung ist ein endloses Online-Board.  Es besteht aus drei Ebenen: einer Site, einem Client und einem Server in Java, einer monolithischen Stateful-Anwendung.  Die Anwendung unterh√§lt eine konstante Web-Socket-Verbindung mit Clients, und jeder Server speichert einen Cache mit offenen Karten. <br><br>  Die gesamte Infrastruktur - mehr als 70 Server - befindet sich in Amazon: mehr als 30 Server mit unserer Java-Anwendung, Webservern, Datenbankservern, Brokern und vielem mehr.  Mit dem Wachstum der Funktionalit√§t muss all dies regelm√§√üig aktualisiert werden, ohne die Arbeit der Benutzer zu st√∂ren. <br>  Das Aktualisieren der Site und des Clients ist einfach: Wir ersetzen die alte Version durch eine neue und beim n√§chsten Zugriff des Benutzers auf eine neue Site und einen neuen Client.  Wenn wir dies jedoch tun, wenn der Server freigegeben wird, kommt es zu Ausfallzeiten.  F√ºr uns ist dies nicht akzeptabel, da der Hauptwert unseres Produkts die gemeinsame Arbeit der Benutzer in Echtzeit ist. <br><br><h2>  Wie unser CI / CD-Prozess aussieht </h2><br>  Der CI / CD-Prozess bei uns ist Git Commit, Git Push, dann automatische Montage, automatisches Testen, Bereitstellen, Freigeben und √úberwachen. <br><br><img src="https://habrastorage.org/webt/ok/se/rv/okservy5e1ai7rboli8mvgvrvh4.png"><br><br>  F√ºr die kontinuierliche Integration verwenden wir Bamboo und Bitbucket.  F√ºr automatische Tests - Java und Python sowie Allure - zur Anzeige der Ergebnisse automatischer Tests.  F√ºr die kontinuierliche Lieferung - Packer, Ansible und Python.  Die gesamte √úberwachung erfolgt mit ELK Stack, Prometheus und Sentry. <br><br>  Entwickler schreiben Code und f√ºgen ihn dem Repository hinzu. Anschlie√üend werden die automatische Assemblierung und das automatische Testen gestartet.  Gleichzeitig versammelt sich das Team mit anderen Entwicklern und f√ºhrt eine Code√ºberpr√ºfung durch.  Wenn alle erforderlichen Prozesse, einschlie√ülich Autotests, abgeschlossen sind, h√§lt das Team den Build im Hauptzweig, und der Build des Hauptzweigs beginnt und wird zum automatischen Testen gesendet.  Der gesamte Prozess wird vom Team selbst getestet und ausgef√ºhrt. <br><br><h2>  AMI-Bild </h2><br>  Parallel zum Erstellen und Testen von Builds wird der Build des AMI-Images f√ºr Amazon gestartet.  Dazu verwenden wir Packer von HashiCorp, ein gro√üartiges OpenSource-Tool, mit dem Sie ein Image einer virtuellen Maschine erstellen k√∂nnen.  Alle Parameter werden mit einer Reihe von Konfigurationsschl√ºsseln an JSON √ºbergeben.  Der Hauptparameter sind Builder, die angeben, f√ºr welchen Anbieter wir das Image erstellen (in unserem Fall f√ºr Amazon). <br><br><pre><code class="plaintext hljs">"builders": [{ "type": "amazon-ebs", "access_key": "{{user `aws_access_key`}}", "secret_key": "{{user `aws_secret_key`}}", "region": "{{user `aws_region`}}", "vpc_id": "{{user `aws_vpc`}}", "subnet_id": "{{user `aws_subnet`}}", "tags": { "releaseVersion": "{{user `release_version`}}" }, "instance_type": "t2.micro", "ssh_username": "ubuntu", "ami_name": "packer-board-ami_{{isotime \"2006-01-02_15-04\"}}" }],</code> </pre> <br>  Es ist wichtig, dass wir nicht nur ein Image einer virtuellen Maschine erstellen, sondern es im Voraus mit Ansible konfigurieren: Installieren Sie die erforderlichen Pakete und nehmen Sie die Konfigurationseinstellungen vor, um eine Java-Anwendung auszuf√ºhren. <br><br><pre> <code class="plaintext hljs"> "provisioners": [{ "type": "ansible", "playbook_file": "./playbook.yml", "user": "ubuntu", "host_alias": "default", "extra_arguments": ["--extra_vars=vars"], "ansible_env_vars": ["ANSIBLE_HOST_KEY_CHECKING=False", "ANSIBLE_NOCOLOR=True"] }]</code> </pre><br><h2>  Ansible-Rollen </h2><br>  Fr√ºher haben wir das √ºbliche Ansible-Spielbuch verwendet, aber dies f√ºhrte zu viel sich wiederholendem Code, der schwer auf dem neuesten Stand zu halten war.  Wir haben etwas in einem Spielbuch ge√§ndert, vergessen, es in einem anderen zu tun, und sind infolgedessen auf Probleme gesto√üen.  Also haben wir angefangen, Ansible-Rollen zu verwenden.  Wir haben sie so vielseitig wie m√∂glich gestaltet, damit wir sie in verschiedenen Teilen des Projekts wiederverwenden und den Code nicht in gro√üen, sich wiederholenden Teilen √ºberladen k√∂nnen.  Beispielsweise verwenden wir die √úberwachungsrolle f√ºr alle Servertypen. <br><br><pre> <code class="plaintext hljs">- name: Install all board dependencies hosts: all user: ubuntu become: yes roles: - java - nginx - board-application - ssl-certificates - monitoring</code> </pre><br>  Von Seiten der Scrum-Teams sieht dieser Prozess so einfach wie m√∂glich aus: Das Team erh√§lt in Slack Benachrichtigungen, dass der Build und das AMI-Image zusammengestellt wurden. <br><br><h2>  Vorabversionen </h2><br>  Wir haben Vorabversionen eingef√ºhrt, um den Benutzern Produkt√§nderungen so schnell wie m√∂glich bereitzustellen.  Tats√§chlich handelt es sich hierbei um kanarische Versionen, mit denen Sie neue Funktionen bei einem kleinen Prozentsatz der Benutzer sicher testen k√∂nnen. <br><br>  Warum hei√üen Ver√∂ffentlichungen Kanarienvogel?  Zuvor nahmen Bergleute, als sie in die Mine hinabstiegen, einen Kanarienvogel mit.  Wenn sich Gas in der Mine befand, starb der Kanarienvogel und die Bergleute stiegen schnell an die Oberfl√§che.  So ist es auch bei uns: Wenn mit dem Server etwas schief geht, ist die Version noch nicht fertig und wir k√∂nnen schnell einen Rollback durchf√ºhren, und die meisten Benutzer werden nichts bemerken. <br><br>  <strong>Wie die kanarische Freilassung beginnt:</strong> <br><ol><li>  Das Entwicklungsteam von Bamboo klickt auf eine Schaltfl√§che -&gt; Es wird eine Python-Anwendung aufgerufen, die die Vorabversion startet. </li><li>  Es erstellt eine neue Instanz in Amazon aus einem vorbereiteten AMI-Image mit einer neuen Version der Anwendung. </li><li>  Instanz wird zu den erforderlichen Zielgruppen und Load Balancern hinzugef√ºgt. </li><li>  Mit Ansible wird f√ºr jede Instanz eine individuelle Konfiguration konfiguriert. </li><li>  Benutzer arbeiten mit der neuen Version der Java-Anwendung. </li></ol><br>  Auf der Seite der Scrum-Befehle sieht der Startvorgang vor der Ver√∂ffentlichung wieder so einfach wie m√∂glich aus: Das Team erh√§lt in Slack Benachrichtigungen, dass der Prozess gestartet wurde, und nach 7 Minuten ist der neue Server bereits in Betrieb.  Dar√ºber hinaus sendet die Anwendung das gesamte √Ñnderungsprotokoll der √Ñnderungen in der Version an Slack. <br><br>  Damit diese Barriere f√ºr die Schutz- und Zuverl√§ssigkeitspr√ºfung funktioniert, √ºberwachen die Scrum-Teams neue Fehler in Sentry.  Dies ist eine Open Source-Anwendung zur Fehlerverfolgung in Echtzeit.  Sentry l√§sst sich nahtlos in Java integrieren und verf√ºgt √ºber Konnektoren mit logback und log2j.  Wenn die Anwendung gestartet wird, √ºbertragen wir die Version, auf der sie ausgef√ºhrt wird, an Sentry. Wenn ein Fehler auftritt, sehen wir, in welcher Version der Anwendung sie aufgetreten ist.  Dies hilft Scrum-Teams, schnell auf Fehler zu reagieren und diese schnell zu beheben. <br><br>  Die Vorabversion sollte mindestens 4 Stunden lang funktionieren.  W√§hrend dieser Zeit √ºberwacht das Team seine Arbeit und entscheidet, ob die Version f√ºr alle Benutzer freigegeben wird. <br><br>  <strong>Mehrere Teams k√∂nnen gleichzeitig ihre Ver√∂ffentlichungen ver√∂ffentlichen</strong> .  Dazu vereinbaren sie untereinander, was in die Vorabversion gelangt und wer f√ºr die endg√ºltige Ver√∂ffentlichung verantwortlich ist.  Danach kombinieren die Teams entweder alle √Ñnderungen in einer Vorabversion oder starten mehrere Vorabversionen gleichzeitig.  Wenn alle Vorabversionen korrekt sind, werden sie am n√§chsten Tag als eine Ver√∂ffentlichung ver√∂ffentlicht. <br><br><h2>  Ver√∂ffentlichungen </h2><br>  Wir machen eine t√§gliche Ver√∂ffentlichung: <br><br><ol><li>  Wir f√ºhren neue Server ein. </li><li>  Wir √ºberwachen die Benutzeraktivit√§t auf neuen Servern mit Prometheus. </li><li>  Enger Zugriff f√ºr neue Benutzer auf alte Server. </li><li>  Wir √ºbertragen Benutzer von alten auf neue Server. </li><li>  Schalten Sie den alten Server aus. </li></ol><br>  Alles wird mit den Anwendungen Bamboo und Python erstellt.  Die Anwendung √ºberpr√ºft die Anzahl der ausgef√ºhrten Server und bereitet den Start derselben Anzahl neuer Server vor.  Wenn nicht gen√ºgend Server vorhanden sind, werden diese aus dem AMI-Image erstellt.  Auf ihnen wird eine neue Version bereitgestellt, eine Java-Anwendung gestartet und die Server in Betrieb genommen. <br><br>  Bei der √úberwachung √ºberpr√ºft die Python-Anwendung mithilfe der Prometheus-API die Anzahl der offenen Karten auf neuen Servern.  Wenn es versteht, dass alles richtig funktioniert, schlie√üt es den Zugriff auf die alten Server und √ºbertr√§gt Benutzer auf neue. <br><br><pre> <code class="plaintext hljs">import requests PROMETHEUS_URL = 'https://prometheus' def get_spaces_count(): boards = {} try: params = { 'query': 'rtb_spaces_count{instance=~"board.*"}' } response = requests.get(PROMETHEUS_URL, params=params) for metric in response.json()['data']['result']: boards[metric['metric']['instance']] = metric['value'][1] except requests.exceptions.RequestException as e: print('requests.exceptions.RequestException: {}'.format(e)) finally: return boards</code> </pre><br>  Der Prozess der Benutzer√ºbertragung zwischen Servern wird in Grafana angezeigt.  In der linken H√§lfte des Diagramms werden Server angezeigt, die auf der alten Version ausgef√ºhrt werden, in der rechten - auf der neuen.  Der Schnittpunkt von Diagrammen ist der Moment der Benutzer√ºbertragung. <br><br><img src="https://habrastorage.org/webt/zt/8l/df/zt8ldf8hmk39a7tzho9a_dt0gnq.png"><br><br>  Das Team √ºberwacht die Ver√∂ffentlichung von Slack.  Nach der Ver√∂ffentlichung wird das gesamte √Ñnderungsprotokoll in einem separaten Kanal in Slack ver√∂ffentlicht, und in Jira werden alle mit dieser Version verbundenen Aufgaben automatisch geschlossen. <br><br><h3>  Was ist Benutzermigration? </h3><br>  Wir speichern den Status des Whiteboards, auf dem Benutzer arbeiten, im Anwendungsspeicher und speichern st√§ndig alle √Ñnderungen an der Datenbank.  Um die Karte auf der Ebene der Clusterinteraktion zu √ºbertragen, laden wir sie in den Speicher des neuen Servers und senden dem Client einen Befehl zum erneuten Verbinden.  Zu diesem Zeitpunkt trennt sich der Client vom alten Server und stellt eine Verbindung zum neuen Server her.  Nach einigen Sekunden sehen Benutzer die Beschriftung - Verbindung wiederhergestellt.  Sie arbeiten jedoch weiter und bemerken keine Unannehmlichkeiten. <br><br><img src="https://habrastorage.org/webt/8m/ie/ae/8mieaew94xjibv9emwf0gkrq1l8.png"><br><br><h2>  Was wir gelernt haben, als wir die Bereitstellung unsichtbar gemacht haben </h2><br>  Was haben wir nach einem Dutzend Iterationen erreicht: <br><br><ul><li>  Das Scrum-Team √ºberpr√ºft seinen Code selbst. </li><li>  Das Scrum-Team entscheidet, wann die Vorabversion gestartet und einige √Ñnderungen an neue Benutzer √ºbertragen werden sollen. </li><li>  Das Scrum-Team entscheidet, ob die Ver√∂ffentlichung f√ºr alle Benutzer bereit ist. </li><li>  Benutzer arbeiten weiter und bemerken nichts. </li></ul><br>  Dies war nicht sofort m√∂glich, wir traten viele Male auf denselben Rechen und f√ºllten viele Zapfen.  Ich m√∂chte die Lektionen teilen, die wir erhalten haben. <br><br>  <strong>Zuerst der manuelle Prozess und erst dann seine Automatisierung.</strong>  Die ersten Schritte m√ºssen nicht tiefer in die Automatisierung gehen, da Sie automatisieren k√∂nnen, was am Ende nicht n√ºtzlich ist. <br><br>  <strong>Ansible ist gut, aber Ansible-Rollen sind besser.</strong>  Wir haben unsere Rollen so universell wie m√∂glich gestaltet: Wir haben sich wiederholenden Code entfernt, sodass sie nur die Funktionen enthalten, die sie enthalten sollten.  Auf diese Weise k√∂nnen Sie erheblich Zeit sparen, indem Sie Rollen wiederverwenden, √ºber die wir bereits mehr als 50 verf√ºgen. <br><br>  <strong>Verwenden Sie den Code in Python erneut und teilen Sie ihn in separate Bibliotheken und Module auf.</strong>  Auf diese Weise k√∂nnen Sie in komplexen Projekten navigieren und schnell neue Personen in diese eintauchen. <br><br><h2>  N√§chste Schritte </h2><br>  Der unsichtbare Bereitstellungsprozess ist noch nicht abgeschlossen.  Hier sind einige der folgenden Schritte: <br><br><ol><li>  Erm√∂glichen Sie Teams, nicht nur Vorabversionen, sondern alle Ver√∂ffentlichungen abzuschlie√üen. </li><li>  F√ºhren Sie bei Fehlern automatische Rollbacks durch.  Beispielsweise sollte eine Vorabversion automatisch zur√ºckgesetzt werden, wenn in Sentry kritische Fehler festgestellt werden. </li><li>  Automatisieren Sie die Freigabe vollst√§ndig, wenn keine Fehler vorliegen.  Wenn die Vorabversion keine Fehler enthielt, bedeutet dies, dass sie automatisch weiter eingef√ºhrt werden kann. </li><li>  F√ºgen Sie eine automatische Code-√úberpr√ºfung auf potenzielle Sicherheitsfehler hinzu. </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de436444/">https://habr.com/ru/post/de436444/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de436434/index.html">PVS-Studio f√ºr Java</a></li>
<li><a href="../de436436/index.html">Das CERN plant den Bau eines neuen Beschleunigers mit einer Tunnell√§nge von 100 km</a></li>
<li><a href="../de436438/index.html">Roscosmos nannte die m√∂glichen Gr√ºnde f√ºr den Verlust der Kommunikation mit dem Spektr-R-Orbitalobservatorium</a></li>
<li><a href="../de436440/index.html">Ich muss schnell gehen: Auf Geschwindigkeit in iOS bauen. Teil 2</a></li>
<li><a href="../de436442/index.html">Ein Kopf ist gut und zwei sind besser oder Paarprogrammierung in Aktion</a></li>
<li><a href="../de436448/index.html">Test 27 ‚ÄùIPS-Monitor Acer HA270bid: zur Selbstverbesserung</a></li>
<li><a href="../de436450/index.html">Fernbedienung und Kontrolle, Freiheit und Regierung. Gespr√§ch mit Staply</a></li>
<li><a href="../de436452/index.html">7 Bereiche der Linux-Entwicklung im Jahr 2019</a></li>
<li><a href="../de436454/index.html">Fragen und Antworten zu JavaScript</a></li>
<li><a href="../de436456/index.html">Erstellen Sie in Unity einen Farbverteilungseffekt</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>