<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèΩ‚Äç‚úàÔ∏è üì™ üÖæÔ∏è Comment nous avons commenc√© √† enregistrer les caisses enregistreuses pour nos clients ‚úçüèø ‚úçüèæ üìô</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Selon les amendements au 54-, depuis juillet de cette ann√©e, presque toutes les entreprises commerciales sont oblig√©es d'utiliser des caisses en ligne...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment nous avons commenc√© √† enregistrer les caisses enregistreuses pour nos clients</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tinkoff/blog/420033/">  Selon les amendements au 54-, depuis juillet de cette ann√©e, presque toutes les entreprises commerciales sont oblig√©es d'utiliser des caisses en ligne qui transmettent des donn√©es via Internet au service des imp√¥ts.  Pour acqu√©rir un tel appareil, vous devrez acheter une caisse et un disque fiscal, signer un accord et payer les services d'un op√©rateur de donn√©es fiscales, vous inscrire dans deux bureaux personnels du Federal Tax Service et OFD, entrer les d√©tails dans la caisse et recevoir un rapport d'enregistrement papier.  Eh bien, vous aurez √©galement besoin d'une signature num√©rique √©lectronique, sinon vous devrez vous pr√©senter au Federal Tax Service et faire personnellement la queue. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3a9/fb3/9b6/3a9fb39b680344c3f892804eb41b1a11.png"><br><br>  Nous avons d√©cid√© de sauver nos clients de toute cette horreur en cr√©ant un service qui enregistre tout automatiquement presque en un seul clic.  Nous en parlerons maintenant. <br><a name="habracut"></a><br><h2>  Pourquoi en avons-nous besoin </h2><br>  Vous avez d√©j√† r√©alis√© que l'enregistrement d'une billetterie est une qu√™te fastidieuse en plusieurs √©tapes, mais ce n'est pas le seul probl√®me.  √Ä chaque √©tape, le zoo attend les interfaces, dont les formulaires devront √™tre remplis manuellement avec les donn√©es d'enregistrement pour chaque billetterie, ainsi qu'un ensemble complet de bugs pertinents (salutations distinctes aux exigences fiscales pour l'utilisation des navigateurs IE, Yandex.Browser ou Sputnik).  Des centaines d'occasions de faire une erreur, de ruiner la proc√©dure et de recommencer.  Et si vous d√©finissez 5 √† 10 caisses enregistreuses, le risque d'erreur lors de la saisie des m√™mes d√©tails augmente parfois.  Sans parler de la perte de temps improductive et de la raison pour laquelle l'administration fiscale des particuliers refuse d'accepter le jeton, qui a √©t√© parfaitement ¬´aval√©¬ª hier. <br><br><img src="https://habrastorage.org/webt/cz/bk/qn/czbkqnhvog24qqgwodhckwfyhew.png"><br><br>  Et lorsque nous avons ressenti le plus gros de la trag√©die ci-dessus, nous avons d√©cid√© de reprendre le d√©veloppement. <br><br><h2>  √âtapes d'enregistrement </h2><br>  Plusieurs parties participent √† l'enregistrement simultan√© d'une caisse enregistreuse.  Il s'agit du service fiscal (FTS), OFD - l'op√©rateur de donn√©es fiscales par lequel les caisses enregistreuses interagissent avec l'administration fiscale, un centre de certification qui √©met des signatures √©lectroniques et, en r√®gle g√©n√©rale, un petit homme d'affaires d√©concert√© perdu dans les bouleversements bureaucratiques.  Nous avons voulu intervenir dans leur relation, au point de prendre sur nous toutes les difficult√©s. <br><br>  Conditionnellement, la proc√©dure est divis√©e en deux √©tapes: <br><br>  Inscription √† la caisse - les donn√©es d'un appareil particulier sont envoy√©es au Service f√©d√©ral des imp√¥ts et le num√©ro d'enregistrement vient en r√©ponse. <br><br>  Fiscalisation - activation de la caisse √† l'aide du num√©ro d'immatriculation du v√©hicule attribu√© par le Federal Tax Service. <br><br>  Tout d'abord, nous sommes all√©s chez nos partenaires pour travailler avec eux sur la premi√®re √©tape. <br><br><h2>  API pour le Federal Tax Service </h2><br>  Nous n'avons pas √©t√© les premiers √† penser √† l'automatisation de l'enregistrement.  Beaucoup ont dit qu'ils faisaient quelque chose dans ce domaine, que le d√©veloppement √©tait en cours, mais personne n'avait d'interface externe pr√™te √† l'emploi.  L'un des op√©rateurs de donn√©es fiscales a √©t√© fourni par l'API - presque pr√™t √† interagir avec la taxe. <br><br>  √Ä cette √©poque, seulement environ 80 demandes de test ont √©t√© envoy√©es en utilisant le protocole.  Nous pensions que bient√¥t l'interface fonctionnerait √† pleine capacit√©, et avons commenc√© la mise en ≈ìuvre et les tests sur les ¬´stubs¬ª. <br><br>  En allant √† la prod, nous avons r√©alis√© que nos tests et l'application r√©elle sont diff√©rents, comme le jour et la nuit.  Les ¬´talons¬ª que nous avons re√ßus de l'OFD ne comprenaient que des simulations de succ√®s et reproduisaient un script r√©ussi.  En fait, atteindre ce ¬´succ√®s¬ª n'a pas √©t√© facile. <br><br>  Parmi les r√©sultats, citons: les demandes des partenaires qui n'ont pas √©t√© trait√©es pendant plusieurs jours, le manque de commentaires du Service f√©d√©ral des imp√¥ts et de l'OFD, les erreurs de signature et notre ¬´erreur inconnue¬ª pr√©f√©r√©e.  Le protocole FTS s'est av√©r√© peu document√© et, souvent, a r√©pondu par des √©checs non sp√©cifi√©s, pour lesquels on ne sait pas exactement ce qui les a caus√©s.  Une sp√©cification claire n'existe toujours pas.  Ainsi, la premi√®re fois que nous avons test√© le protocole, et avec l'OFD, nous avons pris des d√©cisions sur la fa√ßon de r√©pondre √† certaines r√©ponses du Service f√©d√©ral des imp√¥ts dans des cas sp√©cifiques. <br><br><h2>  API Cashier </h2><br>  Bien qu'une partie de l'√©quipe ait √©tudi√© le comportement des syst√®mes du Service f√©d√©ral des imp√¥ts dans la pratique, le travail ne s'est pas arr√™t√©.  En parall√®le, nous avons organis√© des n√©gociations avec les fabricants de caisses enregistreuses, les avons invit√©s √† √©changer des donn√©es de notre part vers leur plateforme, de la plateforme √† la caisse enregistreuse et dans l'ordre inverse pour la mise en place d'une fiscalisation automatique des caisses enregistreuses. <br><br>  Nous avons s√©lectionn√© une paire de solutions monoblocs universelles.  Les caisses Evotor avec √©crans tactiles et DreamCas sont destin√©es aux clients habitu√©s aux bons vieux boutons et qui consid√®rent les fonctionnalit√©s suppl√©mentaires comme redondantes.  Les mod√®les sont diff√©rents: avec et sans scanner. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ro/r7/dc/ror7dcretvhsilz3yiw12judrxi.png"></div><br>  Si l'OFD avait sa propre API pr√™te, alors pour les entrepreneurs de la caisse enregistreuse, elle devait √™tre d√©velopp√©e √† partir de z√©ro.  Sinon, il est impossible de faire en sorte que toutes les donn√©es d'inscription arrivent automatiquement √† la caisse enregistreuse, sans saisie manuelle. <br><br>  Les coll√®gues ont r√©ussi √† mettre en place une interaction via leur plate-forme et ont rapidement √©t√© pr√™ts: une API pour ouvrir le compte personnel d'un client et un protocole propri√©taire pour g√©rer une caisse enregistreuse. <br><br><img src="https://habrastorage.org/webt/wy/5h/hr/wy5hhrv-agl7qmya0x9pnpbppde.png"><br><br>  Nos fournisseurs ont √©t√© les premiers √† mettre en place la soumission automatique des informations d'enregistrement √† la billetterie.  Et bient√¥t, l'API facilitera la d√©sinscription et la r√©inscription des caisses enregistreuses. <br><br>  Maintenant, lorsque nous n√©gocions avec d'autres vendeurs au comptant, c'est pr√©cis√©ment le support de cette interface qui devient l'une des exigences cl√©s. <br><br><h2>  Anatomie de l'enregistrement automatique </h2><br>  Apr√®s avoir appris √† travailler avec le Federal Tax Service et mis en ≈ìuvre des API avec des fournisseurs pour transf√©rer les donn√©es d'enregistrement au caissier, il √©tait temps de connecter tout cela dans un seul syst√®me et d'√©tablir une proc√©dure d'enregistrement. <br><br>  Il s'agit de choisir la bonne architecture, qui nous permettrait de contr√¥ler l'enregistrement asynchrone des caisses enregistreuses dans l'OFD, √† la fois avec le Federal Tax Service et le vendeur.  Puisqu'ils r√©pondent aux demandes avec retard, le processus prend du temps et a un grand nombre d'int√©grations avec des syst√®mes externes.  Pour cette raison, nous avons d√ª √©crire deux applications en Java. <br><br>  Job service communique directement avec CRF et les syst√®mes des fabricants de caisses enregistreuses.  Par exemple, nous envoyons les donn√©es client √† l'OFD et nous attendons de recevoir un num√©ro d'enregistrement en r√©ponse. <br><br>  Le service des t√¢ches interroge le statut des t√¢ches √† des intervalles sp√©cifiques.  Il demande encore et demande jusqu'√† ce que le r√©sultat revienne.  Le num√©ro d'enregistrement est enregistr√©, Job transf√®re l'application √† l'√©tape suivante et la fiscalisation commence. <br><br>  Si au d√©but nous surveillions attentivement le passage des applications et √©tudiions manuellement chaque erreur que le syst√®me a donn√©e, maintenant le processus est automatis√©. <br><br>  Nous d√©terminons imm√©diatement la cause de l'erreur.  Et en cas de probl√®mes massifs, des syst√®mes de surveillance ont √©t√© mis en place qui enregistrent les anomalies qui indiquent des d√©faillances majeures au Federal Tax Service ou OFD.  Le client, cependant, d√©couvre les probl√®mes dans le seul cas: si, en r√©ponse √† une demande, nous recevons un refus sp√©cifique, un refus motiv√© de s'inscrire. <br><br>  La deuxi√®me application, CashReg, est un syst√®me de traitement o√π un mod√®le de statut est maintenu, pr√©sent√© sous une forme relationnelle. <br><br>  Il a √©t√© d√©velopp√© sur la base des API fournies par les fournisseurs et le CRF, et comprenait toutes les transitions possibles pour chaque classe participant au processus d'inscription.  Le mod√®le d'√©tat √©vite les erreurs internes et √©limine les √©carts par rapport √† l'algorithme de traitement d'application standard. <br><br>  Ainsi, si la demande a √©t√© dans le m√™me statut pendant trop longtemps, par exemple, elle ne re√ßoit pas le num√©ro d'enregistrement pendant plusieurs heures, ou le CRF r√©pond avec une √©tape ou un statut incorrect de la demande, CashReg signalera une erreur. <br><br>  Bien s√ªr, un administrateur √©tait n√©cessaire pour g√©rer la proc√©dure.  Un groupe d'aide √† la d√©cision commerciale travaille avec lui, servant et accompagnant les caisses enregistreuses lors de l'inscription.  D√©sormais, seuls deux employ√©s y participent, mais leur interface de travail n'est pas compliqu√©e, et le processus de pr√©paration de la caisse, gr√¢ce au rejet de la saisie manuelle des donn√©es, est simple.  Ainsi, nous pouvons rapidement et facilement faire √©voluer le d√©partement. <br><br>  Les trois composants du syst√®me d'enregistrement n'impliquent pas de charges √©lev√©es, car ils sont d√©ploy√©s dans des environnements virtuels. <br><br><h2>  Comment se d√©roule le traitement des demandes </h2><br>  Tout cela √©tait n√©cessaire pour que le client, laissant une demande dans son compte personnel, mette quelques jours plus tard la caisse activ√©e en √©tat de marche derri√®re le comptoir. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f14/777/abe/f14777abe2e59529a31a321dcfbe01ca.png"></div><br>  Du point de vue de la cuisine domestique, la magie de l'enregistrement automatique semble un peu plus compliqu√©e.  Laissant la demande dans votre compte personnel, le client nous donne le consentement l√©gal pour √©mettre une signature √©lectronique et passer par toute la proc√©dure en son nom. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/36e/5ef/ccb/36e5efccba0427be9fef8324a50323c3.png"></div><br>  Les informations sur l'entreprise, les donn√©es d'enregistrement pour un magasin particulier et le signataire (par exemple, pour le directeur g√©n√©ral) sont extraites des bases bancaires.  Ils sont mis √† jour dans SPARK, passent par la notation et entrent dans le syst√®me ma√Ætre au box-office. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ae4/749/b78/ae4749b7824fe74ebc8ddefb2d952955.png"></div><br>  Ensuite, une application est form√©e dans CASHREG.  Il s'affiche comme une nouvelle t√¢che dans le panneau d'administration d'un employ√© du groupe de support des solutions de trading.  Il voit de quelle caisse et de quel budget le client a besoin.  L'employ√© trouve l'appareil n√©cessaire dans l'entrep√¥t, s√©lectionne le lecteur fiscal, code √† barres leurs num√©ros de s√©rie et confirme l'application.  Des appareils sp√©cifiques y sont donc attach√©s, qui seront livr√©s au client.  A ce stade, l'OFD re√ßoit une demande: ¬´Formuler une demande d'enregistrement de telle ou telle caisse, pour telle ou telle entreprise¬ª. <br><br>  Le dossier envoy√© par l'OFD en r√©ponse est authentifi√© par signature √©lectronique et, √† l'aide de l'API OFD, est envoy√© aux autorit√©s fiscales.  L√†, la caisse se voit attribuer un num√©ro d'enregistrement. <br><br>  Maintenant, le paquet complet de documents √† la caisse parvient au fabricant de la caisse enregistreuse (oui, ils sont √©galement impliqu√©s ici).  Dans le m√™me temps, une t√¢che appara√Æt dans le panneau d'administration - pour taxiser le m√™me caissier.  Cela signifie que l'employ√© inclut simplement le caissier.  Le syst√®me du fournisseur ¬´voit¬ª que l'appareil est en contact et charge automatiquement toutes les donn√©es d'enregistrement n√©cessaires dans sa m√©moire.  Les erreurs de saisie manuelle sont exclues, les m√™mes d√©tails vont au Service f√©d√©ral des imp√¥ts et au caissier. <br><br>  Le caissier imprime un rapport d'enregistrement - quelque chose pour lequel tout a commenc√©.  Les donn√©es fiscales du rapport: imprimer la date, la signature, le signe fiscal, servent de confirmation que la caisse est pr√™te pour le travail.  Ces informations sont √† nouveau transmises √† l'OFD. <br><br>  Imm√©diatement apr√®s que l'OFD ait g√©n√©r√© un rapport d'enregistrement, nous le signons pour le client et le box-office part avec le coursier. <br><br><img src="https://habrastorage.org/webt/dc/cs/et/dccsetgp8qnjvcijl84ra3n6vu0.png"><br><br>  L'OFD n'a pas encore pr√©par√© de carte d'enregistrement, mais vous ne pouvez pas attendre.  Il sera disponible sous forme √©lectronique dans le compte personnel du client dans deux √† trois jours. <br><br><h2>  Conclusion </h2><br>  Pour mettre en ≈ìuvre ce projet, une vingtaine d'employ√©s de toute la banque et de nombreux autres sp√©cialistes de nos partenaires, DFD et vendeurs de billets ont √©t√© distraits de leurs t√¢ches habituelles, mais leurs efforts n'ont pas √©t√© vains. <br><br>  Le d√©lai moyen pour obtenir un num√©ro d'enregistrement, √† l'exception des cas les plus n√©gatifs, est de trois heures.  En g√©n√©ral, toute la proc√©dure dure de 5 √† 6 heures.  90% des inscriptions r√©ussissent.  √Ä l'heure actuelle, environ 1 000 demandes ont d√©j√† √©t√© trait√©es. <br><br>  En g√©n√©ral, comme vous le comprenez, dans notre entreprise, nous aimons de tels cas, ce qui peut grandement simplifier la vie d'un grand nombre de personnes.  En r√©solvant de tels probl√®mes, vous sentez que vous faites quelque chose de vraiment utile. <br><br>  PS Si vous √™tes int√©ress√©, vous pouvez lire comment nous avons nous-m√™mes <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">nettoy√© notre distributeur automatique de billets</a> .  De plus, avec des protocoles d'√©change de donn√©es. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr420033/">https://habr.com/ru/post/fr420033/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr420021/index.html">Pourquoi avez-vous besoin de Splunk? Internet des objets et donn√©es industrielles</a></li>
<li><a href="../fr420023/index.html">Enregistrement des √©tats dans les applications Android</a></li>
<li><a href="../fr420025/index.html">Ferme intelligente. √Ä quoi ressemblera-t-elle?</a></li>
<li><a href="../fr420029/index.html">Comment nous, chez 1C: Enterprise, r√©solvons des syst√®mes d'√©quations alg√©briques</a></li>
<li><a href="../fr420031/index.html">Dessin avec des cibles de rendu dans Unreal Engine</a></li>
<li><a href="../fr420035/index.html">Interface graphique de Golang: GTK + 3</a></li>
<li><a href="../fr420037/index.html">Stream avec plusieurs cam√©ras √† partir de mat√©riaux improvis√©s</a></li>
<li><a href="../fr420039/index.html">Pens√©e fonctionnelle. 2e partie</a></li>
<li><a href="../fr420041/index.html">TypeScript War ou Enum Conquest</a></li>
<li><a href="../fr420045/index.html">Bunker pour la date: comment j'ai √©t√© autoris√© √† me promener dans le centre de donn√©es RUVDS sur le territoire de l'usine spatiale</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>