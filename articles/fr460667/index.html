<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üõ°Ô∏è ü§∑ ü§ü Automatisation des tests de services payants sur iOS üë©üèΩ‚Äçü§ù‚Äçüë©üèª üõê üôçüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pour ceux qui sont int√©ress√©s par le sujet de l'automatisation sur iOS, j'ai deux nouvelles - bonnes et mauvaises. Bon: dans l'application iOS pour le...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Automatisation des tests de services payants sur iOS</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/badoo/blog/460667/">  Pour ceux qui sont int√©ress√©s par le sujet de l'automatisation sur iOS, j'ai deux nouvelles - bonnes et mauvaises.  Bon: dans l'application iOS pour les services payants, un seul point d'int√©gration est utilis√© - les achats <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">int√©gr√©s</a> (achats <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">int√©gr√©s dans l'application</a> ).  Mauvais: Apple ne fournit aucun outil pour automatiser les tests d'achat. <br><br>  Dans cet article, je sugg√®re que vous et moi recherchions une m√©thode d'automatisation universelle au-del√† du bien et du mal d'Apple.  L'article sera utile √† toute personne qui int√®gre des services tiers qui sont une bo√Æte noire dans leurs applications: publicit√©, streaming, gestion de l'emplacement, etc. Habituellement, de telles int√©grations sont tr√®s difficiles √† tester, car il n'y a aucun moyen de configurer de mani√®re flexible un service tiers pour tester l'application. <br><br><img src="https://habrastorage.org/webt/fg/if/j3/fgifj3qfcwf_98iuebxjx-fxrka.jpeg"><br><a name="habracut"></a><br>  <i>Je m'appelle Victor Koronevich, je suis ing√©nieur principal en automatisation des tests chez Badoo.</i>  <i>Engag√© dans l'automatisation mobile depuis plus de dix ans.</i>  <i>Avec mon coll√®gue Vladimir Solodov, nous avons fait ce <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">rapport</a> lors de la conf√©rence de Heisenbug.</i>  <i>Il m'a √©galement aid√© √† pr√©parer ce texte.</i> <br><br>  Dans l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article</a> pr√©c√©dent <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">,</a> nous avons d√©crit les m√©thodes utilis√©es par Badoo pour tester l'int√©gration avec les fournisseurs de paiement, dont nous avons plus de 70. Dans cet article, nous parlerons davantage de la fa√ßon dont nous avons r√©ussi √† r√©aliser une automatisation stable et peu co√ªteuse des tests de services payants dans une application iOS. <br><br>  Commen√ßons par une description g√©n√©rale de nos recherches: <br><br><ol><li>  D√©finition du probl√®me <br></li><li>  √ânonc√© du probl√®me <br></li><li>  Solution n ¬∞ 1.  Apple Sandbox <br></li><li>  D√©cision num√©ro 2.  Fonction Mock, m√©thode et utilisation d'un faux objet <br></li><li>  √âvaluation de la d√©cision: principaux risques <br></li><li>  R√©sultat <br></li><li>  Conclusion <br></li></ol><br><h2>  D√©finition du probl√®me </h2><br>  L'automatisation doit √™tre effectu√©e en cas de besoin naturel.  Quand ce moment est-il venu avec nous? <br><br>  Il y a beaucoup de fonctionnalit√©s gratuites dans l'application Badoo, mais celles payantes offrent √† l'utilisateur plus d'options.  Ils les obtiennent de deux mani√®res: pour des pr√™ts - la monnaie interne de Badoo - ou en achetant un abonnement premium.  Pour un certain nombre de cr√©dits, vous pouvez augmenter votre profil dans les r√©sultats de recherche en premier lieu, faire un cadeau √† un autre utilisateur, etc.  L'abonnement premium est valable pour une certaine p√©riode de temps et vous offre plusieurs options √† la fois: activer le mode d'invisibilit√©, voir les personnes qui ont sympathis√© avec vous, annuler le r√©sultat de votre vote et d'autres. <br><br>  Ces fonctionnalit√©s sont apparues progressivement dans Badoo.  Et il y a quelques ann√©es, nous avons test√© les services payants dans les applications iOS uniquement manuellement.  Mais √† mesure que les fonctionnalit√©s et les nouveaux √©crans apparaissent, les tests manuels ont pris de plus en plus de temps.  Les exigences pour les changements dans l'application provenaient de diff√©rents c√¥t√©s: des d√©veloppeurs c√¥t√© client, des d√©veloppeurs c√¥t√© serveur et m√™me du fournisseur Apple lui-m√™me.  Pour un testeur, une it√©ration de test a commenc√© √† prendre environ huit heures.  Il est devenu impossible d'obtenir un feedback rapide pour un d√©veloppeur sur sa branche en 30 minutes, ce qui pourrait finalement affecter n√©gativement la comp√©titivit√© du produit. <br><br>  Nous voulions obtenir les r√©sultats des tests le plus rapidement possible.  Et ils ont rencontr√© un probl√®me: comment organiser les tests de r√©gression des services payants dans nos applications iOS √† moindre co√ªt afin d'obtenir des r√©sultats rapides et stables? <br><br><h2>  √ânonc√© du probl√®me </h2><br>  Ainsi, en tenant compte des sp√©cificit√©s de notre processus de livraison du produit final et de la taille de l'√©quipe, nous souhaitons: <br><br><ul><li>  Testez tous les achats dans l'application client (paiements et abonnements uniques); <br></li></ul><br><ul><li>  r√©p√©ter les tests 10 √† 20 fois par jour; <br></li><li>  Obtenez les r√©sultats des tests ~ 150 scripts de test en moins d'une demi-heure; <br></li><li>  se d√©barrasser du bruit; <br></li><li>  √™tre en mesure d'ex√©cuter des tests sur une branche sp√©cifique du code d√©veloppeur, quels que soient les r√©sultats des autres ex√©cutions. <br></li></ul><br>  Maintenant que nous avons formul√© la t√¢che, il est temps de commencer le voyage dans le monde merveilleux des ing√©nieurs et de leurs solutions. <br><br><h2>  Solution n ¬∞ 1.  Apple Sandbox </h2><br>  Tout d'abord, nous avons commenc√© √† rechercher des informations sur l'organisation du test automatique des services payants dans la documentation Apple.  Et ils n‚Äôont rien trouv√©.  Le support d'automatisation semble tr√®s maigre.  Si quelque chose appara√Æt, la configuration de l'automatisation avec les outils propos√©s est difficile (rappelons au moins <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">UIAutomation</a> , ainsi que le moment o√π le premier utilitaire <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">xcrun simctl</a> pour iOS Simulator est apparu) et vous devez rechercher des solutions d'ing√©nierie, y compris dans le segment open-source. <br><br>  Dans la documentation Apple pour tester les services payants, vous ne pouvez trouver que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Apple Sandbox</a> .  Il n'√©tait pas clair comment lier ce bac √† sable √† l'automatisation, mais nous avons d√©cid√© de rechercher s√©rieusement cette solution.  Le fait que le bac √† sable Android soit stable nous a donn√© confiance, et √† ce moment-l√†, nous avions d√©j√† r√©ussi les tests sur Android.  Peut-√™tre que le bac √† sable d'Apple sera tout aussi bon? <br><br>  Mais lorsque nous avons impl√©ment√© les autotests √† l'aide de ce bac √† sable, nous avons bu en entier.  Passons rapidement en revue les principaux probl√®mes. <br><br><h3>  1. Le pool d'utilisateurs de test </h3><br>  La principale limitation de l'automatisation √©tait les caract√©ristiques du contenu dans le pool d'utilisateurs de test, ce qui devrait garantir l'ind√©pendance du lancement des autotests. <br><br>  Pour ex√©cuter un seul achat automatique d'un abonnement, nous avons besoin de: <br><br><ol><li>  prendre un nouvel utilisateur pour autorisation dans le bac √† sable; <br></li><li>  changer sur le simulateur l'identifiant Apple li√© actuel; <br></li><li>  Connectez-vous √† Badoo avec Badoo <br></li><li>  acc√©der √† l'√©cran d'achat de l'abonnement et s√©lectionner un produit; <br></li><li>  Confirmez l'achat et connectez-vous via Apple ID; <br></li><li>  assurez-vous que l'achat a r√©ussi; <br></li><li>  envoyer l'utilisateur Badoo pour le nettoyage; <br></li><li>  effacer l'utilisateur du bac √† sable des abonnements. <br></li></ol><br>  Si vous essayez d'utiliser imm√©diatement le m√™me utilisateur lors du prochain test, il sera impossible d'acheter un deuxi√®me abonnement.  Vous devez attendre que le premier abonnement "tourne mal", ou vous d√©sinscrire dans les param√®tres.  Comme nous l'avons dit dans le premier <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article</a> , le bac √† sable a une p√©riode de validit√© d'abonnement sp√©cifique.  Si vous achetez un abonnement "pour un mois", vous devez attendre cinq minutes pour le fermer automatiquement.  Le processus de d√©sinscription lui-m√™me n'est pas non plus rapide. <br><br>  Par cons√©quent, pour une nouvelle ex√©cution du m√™me test, nous devrons soit attendre la fin de l'abonnement, soit prendre un autre utilisateur ¬´propre¬ª.  Si nous voulons ex√©cuter deux tests simultan√©ment ind√©pendamment l'un de l'autre, nous devons avoir au moins deux utilisateurs de bac √† sable dans le pool.  Ainsi, pour ex√©cuter 100 auto-tests en parall√®le dans 100 threads, nous avons besoin de 100 utilisateurs diff√©rents. <br><br>  Et maintenant, imaginons que nous effectuons un autotest sur deux agents, chacun pouvant les ex√©cuter sur 100 threads.  Dans ce cas, nous avons besoin d'au moins 200 utilisateurs! <br><br><h3>  2. Notifications ¬´incorrectes¬ª </h3><br>  Eh bien, que diable ne plaisante pas!  Nous avons organis√© un pool d'utilisateurs et commenc√© √† observer le d√©roulement des tests.  Ils sont tomb√©s le long de la route, mais la majorit√© - pour de nouvelles raisons qui nous sont inconnues.  Nous avons commenc√© √† comprendre et √† r√©aliser que lors de l'autorisation, de la confirmation d'un achat et du travail en tant qu'utilisateur dans le bac √† sable, l'App Store envoie des alertes: par exemple, demande un nouveau nom d'utilisateur et un nouveau mot de passe, confirme l'autorisation en cliquant sur le bouton ¬´OK¬ª, donne des informations sur une erreur interne avec le bouton ¬´OK¬ª .  Parfois, ils apparaissent, parfois non.  Et s'ils apparaissent, alors toujours dans un ordre diff√©rent. <br><br><img src="https://habrastorage.org/webt/sq/tu/1j/sqtu1ja-altpboz3pcudwnz8flm.gif"><br><br>  Comment est-il possible qu'une erreur suspecte soit simplement ignor√©e dans un autotest?  Et si une v√©ritable erreur survient, que dois-je faire?  Cette zone est automatiquement devenue une ¬´zone aveugle¬ª pour nous, et nous avons d√ª √©crire des gestionnaires sp√©ciaux pour toutes les alertes possibles qui pourraient arriver de l'App Store. <br><br>  Tout cela a ralenti les tests: <br><br><ul><li>  les alertes pourraient arriver √† diff√©rentes √©tapes du sc√©nario de test, d√©truisant l'id√©e principale du test - Sc√©nario de test pr√©visible;  nous avons d√ª ajouter un gestionnaire d'erreurs qui pr√©voyait l'apparition d'une s√©rie d'alertes ignor√©es connues; <br></li><li>  parfois de nouvelles variations d'alertes sont arriv√©es ou d'autres erreurs se sont produites, nous avons donc d√ª recommencer les tests tomb√©s;  cela a augment√© la dur√©e d'ex√©cution de tous les tests. <br></li></ul><br><h3>  3. Y a-t-il eu un test? </h3><br>  Ainsi, les utilisateurs du pool sont bloqu√©s, puis effac√©s pendant n minutes.  Nous ex√©cutons des tests dans 120 threads, et il y a d√©j√† pas mal d'utilisateurs dans le pool, mais ce n'est pas suffisant.  Nous avons cr√©√© notre syst√®me de gestion des utilisateurs, cr√©√© un gestionnaire d'alertes, puis l'informatique s'est produite.  Le bac √† sable est devenu indisponible pendant quelques jours pour tout utilisateur de test. <br><br>  Personne ne s'y attendait.  Et ce fut la derni√®re goutte dans le calice de notre patience, qui a finalement tu√© l'amour du bac √† sable Apple et nous a fait embarquer sur le chemin de l'autre c√¥t√© du bien et du mal.  Nous avons r√©alis√© que nous n'avions pas besoin d'une telle automatisation et que nous ne voulions plus souffrir de cette d√©cision dangereuse. <br><br><h2>  D√©cision num√©ro 2.  Fonction Mock, m√©thode et utilisation d'un faux objet </h2><br>  Nous avons donc bu des probl√®mes d'automatisation dans le bac √† sable d'Apple.  Mais ne pensez pas que dans le monde mobile, tout est compl√®tement mauvais.  Sur Android, le bac √† sable est beaucoup plus stable - vous pouvez y ex√©cuter des autotests. <br><br>  Essayons de trouver une autre solution pour iOS.  Mais comment regarder?  O√π chercher?  Regardons l'histoire des tests et du d√©veloppement logiciel: qu'est-il arriv√© au monde fou d'Apple?  Que disent les gens qui ont √©crit un tas de livres et qui ont acquis une autorit√© dans le monde de l'automatisation et du d√©veloppement de logiciels? <br><br>  Je me suis imm√©diatement souvenu du travail ¬´xUnit Test Patterns: Refactoring Test Code¬ª, √©crit par Gerard Mesaroche ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">revue par</a> Martin Fowler), - √† mon avis, l'un des meilleurs livres pour tout testeur qui conna√Æt au moins un langage de programmation de haut niveau et veut faire de l'automatisation .  Quelques chapitres de ce livre consacr√©s √† tester SUT ind√©pendamment des autres composants de l'application, qui sont notre ¬´bo√Æte noire¬ª, peuvent nous aider. <br><br><h3>  1. Introduction au moka et aux faux </h3><br>  Il convient de noter que dans le monde des tests automatiques, il n'y a pas de fronti√®re g√©n√©ralement accept√©e entre les concepts de test en double, test de talon, test d'espionnage, objet simul√©, faux objet, objet factice.  Vous devez toujours consid√©rer la terminologie de l'auteur.  Nous n'avons besoin que de deux concepts du grand monde des doubles de test: une fonction factice et un faux objet.  Qu'est ce que c'est  Et pourquoi en avons-nous besoin?  Nous donnons une br√®ve d√©finition de ces concepts afin de ne pas avoir de d√©saccords. <br><br>  Supposons que nous ayons une application et un composant int√©gr√©s, qui est pour nous une ¬´bo√Æte noire¬ª.  √Ä l'int√©rieur de l'application, nous pouvons appeler des fonctions en acc√©dant √† ce composant et obtenir les r√©sultats de ces fonctions.  En fonction du r√©sultat, notre application r√©agit de mani√®re sp√©cifique.  Parfois, le r√©sultat de l'ex√©cution de la fonction peut √™tre une entit√© enti√®re avec un tas de champs qui refl√®tent les donn√©es r√©elles de l'utilisateur. <br><br>  Substitution d'une fonction √† toute autre qui retourne le r√©sultat souhait√©, appelons la fonction simul√©e ou simplement simul√©e.  Ces fonctions peuvent avoir la m√™me signature, mais ce sont deux fonctions diff√©rentes. <br><br>  Et la substitution d'une entit√© obtenue √† la suite de la fonction pour une fausse entit√© (contenant les donn√©es n√©cessaires dans les champs, et parfois m√™me des donn√©es corrompues) sera appel√©e la mise en ≈ìuvre d'un faux objet.  Vous pouvez en savoir plus √† ce sujet dans le livre que j'ai mentionn√© ci-dessus, ou dans tout autre recueil pour les tests et le d√©veloppement de logiciels. <br><br>  Pour terminer, soulignons certaines fonctionnalit√©s de l'utilisation de fonctions simul√©es et de faux objets: <br><br><ol><li>  Pour obtenir les fonctions humides, vous devez acc√©der au code source et savoir comment l'application fonctionne avec le composant de l'int√©rieur au niveau du d√©veloppeur. <br></li><li>  Pour impl√©menter un faux objet, vous devez conna√Ætre la structure de l'objet r√©el. <br></li><li>  L'utilisation de la fonction de simulation permet une configuration flexible de l'application avec le composant. <br></li><li>  L'utilisation d'un faux objet vous permet de doter une entit√© de n'importe quelle propri√©t√©. <br></li></ol><br>  La m√©thode moki et faux objet est id√©ale pour isoler le fonctionnement d'un composant dans une application.  Voyons comment appliquer cette m√©thode pour r√©soudre notre probl√®me, o√π l'App Store sera le composant.  En raison des particularit√©s de l'utilisation de cette m√©thode, nous devons d'abord nous pencher sur l'√©tude de la nature du travail de notre application avec le composant, puis sur la mise en ≈ìuvre technique pour fabriquer des mokeys sp√©cifiques et de faux objets. <br><br><h2>  2. Comment se d√©roule un achat r√©el </h2><br>  Avant de commencer √† d√©crire l'interaction de toutes les parties du syst√®me, mettons en √©vidence les principaux acteurs: <br><br><ul><li>  utilisateur de l'application - tout acteur qui effectue des actions avec l'application, il peut s'agir d'une personne ou d'un script ex√©cutant les instructions n√©cessaires; <br></li><li>  application (dans notre cas, nous utilisons l'application Badoo iOS install√©e dans le simulateur iOS); <br></li><li>  serveur - un acteur qui traite les demandes de l'application et renvoie des r√©ponses ou des notifications asynchrones sans demande client (dans ce cas, nous entendons un serveur Badoo abstrait pour simplifier la structure); <br></li><li>  L'App Store est un acteur qui est une ¬´bo√Æte noire¬ª pour nous: nous ne savons pas comment il est organis√© √† l'int√©rieur, mais nous connaissons son interface publique pour le traitement des achats au sein de l'application ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">framework StoreKit</a> ), et sait √©galement comment v√©rifier les donn√©es sur un serveur Apple. <br></li></ul><br>  Voyons comment se d√©roule l'achat.  L'ensemble du processus peut √™tre vu dans le diagramme: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/kw/1l/tg/kw1ltgj7slrlftse7zykm-hrlec.png" width="600"></div><br>  <i><font color="gray">Figure 1. Sch√©ma de paiement sur l'App Store</font></i> <br><br>  Nous d√©crirons pas √† pas les principales actions des acteurs. <br><br>  1. Le point de d√©part est l'√©tat de tous les acteurs avant d'ouvrir l'√©cran avec une liste de produits. <br><br>  Qu'est-ce que cet √©cran et comment en sommes-nous arriv√©s l√†? <br><br>  Supposons qu'un utilisateur trouve une personne int√©ressante, ouvre son profil, r√©dige un message et souhaite envoyer un cadeau.  L'envoi d'un cadeau est un service payant.  L'utilisateur peut faire d√©filer le profil jusqu'√† la section d'envoi de cadeaux ou s√©lectionner imm√©diatement un cadeau dans le chat. <br><br>  Si l'utilisateur s√©lectionne un cadeau et n'a pas d'argent sur le compte, il verra une liste de diff√©rents packages de pr√™ts (Assistant de paiement) √† acheter.  Le point de d√©part de notre exemple est une liste de cadeaux.  Dans le sch√©ma, on peut consid√©rer un tel point n'importe quel √©cran avant d'afficher la liste des produits pour l'achat de pr√™ts ou d'abonnement. <br><br>  2. Ouverture d'une liste de produits. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/hn/9y/e-/hn9ye-ipwd_pblpxfgbawcpebok.jpeg" width="500"></div><br>  Nous sommes au point de d√©part, par exemple, sur la liste de cadeaux.  L'utilisateur s√©lectionne l'un des cadeaux dans l'application.  L'application fait une demande √† notre serveur pour obtenir une liste des packages de pr√™t ID produit possibles (100, 550, 2000, 5000).  Le serveur renvoie cette liste √† l'application. <br><br>  Ensuite, l'application envoie la liste des ID produit re√ßue pour v√©rification √† l'acteur de l'App Store (framework iOS du syst√®me StoreKit qui va au serveur Apple).  Il renvoie une liste de produits √©prouv√©s - et, par cons√©quent, l'application montre √† l'utilisateur la liste finale des packages de pr√™t avec des ic√¥nes et des prix. <br><br>  3. S√©lection des produits et g√©n√©ration de re√ßus. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ua/3j/jd/ua3jjdi5ifqqc0n6fiaqmg3elvq.jpeg" width="500"></div><br>  L'utilisateur s√©lectionne un produit payant.  L'App Store n√©cessite une preuve d'achat et une autorisation via l'identifiant Apple.  Une fois l'autorisation utilisateur r√©ussie, le contr√¥le est transf√©r√© √† l'application.  L'application attend la g√©n√©ration d'un re√ßu dans son propre package.  L'utilisateur √† ce moment voit le soleil, qui verrouille l'√©cran.  Ce re√ßu a √©t√© g√©n√©r√© peut √™tre compris √† l'aide de la m√©thode appStoreReceiptURL de la classe <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Bundle</a> .  Une fois le ch√®que g√©n√©r√© par l'App Store, l'application s√©lectionne le ch√®que dans son package et envoie une demande avec le ch√®que et les donn√©es utilisateur au serveur Badoo. <br><br>  4. V√©rification de la v√©rification sur le serveur Badoo. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/qw/4l/ag/qw4laggdbnz4zswxh-b6eopdk-y.jpeg" width="500"></div><br>  D√®s que le serveur Badoo re√ßoit le ch√®que et les donn√©es utilisateur, il les renvoie au c√¥t√© serveur Apple pour effectuer le premier cycle de v√©rification.  C'est l'une des recommandations d'Apple.  Ensuite, dans ce premier cycle de v√©rification, le serveur re√ßoit des informations sur l'√©tat actuel de l'abonnement. <br><br>  5. Envoi de notifications push (notification push) √† partir du serveur. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/yq/ne/ou/yqneoujlb2271__24hinousfjz8.jpeg" width="500"></div><br>  Le serveur Badoo traite √† nouveau les informations re√ßues apr√®s v√©rification par Apple et envoie √† l'application une r√©ponse accompagn√©e d'une notification push. <br><br>  6. Notification push dans l'application. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/mw/mx/vq/mwmxvqn6zutjpg45rmcq6tibudc.jpeg" width="500"></div><br>  S'il s'agissait d'un achat de pr√™ts, le solde de l'utilisateur dans l'application changera imm√©diatement et il verra le cadeau envoy√© dans le chat.  S'il s'agit d'un achat d'abonnement, l'utilisateur doit attendre la notification push finale que l'abonnement est activ√©. <br><br><h3>  3. D√©termination des d√©pendances et boucle de test </h3><br><br>  Pour une discussion plus approfondie, nous introduisons deux autres concepts - la d√©pendance externe et le circuit de test. <br><br><h4>  D√©pendance externe </h4><br>  Par d√©pendances externes, nous entendons toute interaction avec un composant, qui est pour nous une ¬´bo√Æte noire¬ª.  Dans ce cas, l'App Store agit comme un tel composant sous la forme d'un cadre syst√®me iOS (StoreKit), avec lequel notre application iOS fonctionne, et d'un serveur Apple, o√π vont les demandes de v√©rification. <br><br>  La gestion de ces d√©pendances en conditions r√©elles est impossible, l'application est oblig√©e de r√©pondre aux signaux de sortie de la bo√Æte noire (voir Fig. 2). <br><br>  Nous avons trois d√©pendances externes: <br><br><ol><li>  V√©rification des produits StoreKit. <br></li><li>  R√©ception et remplacement d'un re√ßu d'achat. <br></li><li>  V√©rification d'un ch√®que sur un serveur Badoo. <br></li></ol><br><img src="https://habrastorage.org/webt/ix/dd/mr/ixddmrcv7pwgene4fw12269cfeg.jpeg"><br>  <i><font color="gray">Figure 2. D√©pendances externes</font></i> <br><br><h4>  Circuit d'essai </h4><br>  Circuit de test - ce sont des sections du chemin que nous allons parcourir et v√©rifier pendant le processus de test. <br><br><img src="https://habrastorage.org/webt/26/m3/_u/26m3_uxzsdcrewtozcmgqihwbyu.jpeg"><br>  <i><font color="gray">Figure 3. Boucle de test</font></i> <br><br>         ,     ,                     . <br><br>    . <br><br><h3> 4.  :   </h3><br>          PPP-,      Payment Provider.       App Store (StoreKit)   ,      : <br><br><ol><li> prepare ‚Äî ,     ; <br></li><li> makePayment ‚Äî ,     . <br></li></ol><br>    iOS       ,        Mock Payment Provider.         StoreKit   .   ¬´ ¬ª?       prepare  makePayment,   ,   .      ,     . <br><br><h4>  ‚Ññ1.   StoreKit </h4><br>       prepare,     .    ,            .  ,   . <br><br><img src="https://habrastorage.org/webt/nr/nd/xj/nrndxjbquf5uuddom1zw4pcwkky.jpeg"><br> <i><font color="gray"> 4.    </font></i> <br><br>         Payment Provider.       .        Mock Payment Provider. <br><br><pre><script type="text/javascript">function gtElInit() {var lib = new google.translate.TranslateService();lib.translatePage('ru', 'fr', function () {});}</script><script type="text/javascript" src="https://translate.google.com/translate_a/element.js?cb=gtElInit&amp;client=wt"></script><code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MockPaymentProvider</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PaymentProvider</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> receipt: <span class="hljs-type"><span class="hljs-type">String?</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> storeKitTransactionID: <span class="hljs-type"><span class="hljs-type">String?</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepare</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(products: [BMProduct])</span></span></span></span> -&gt; [<span class="hljs-type"><span class="hljs-type">BMProduct</span></span>] { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> products } ... }</code> </pre> <br>  <i><font color="gray">Listing 1. Maquette du client</font></i> <br><br>  Chez le fournisseur de paiement simul√©, nous pouvons voir la mise en ≈ìuvre de la m√©thode de pr√©paration.  La magie de moka s'av√®re √™tre tr√®s simple: la m√©thode a saut√© la v√©rification des produits du c√¥t√© StoreKit, et elle renvoie simplement une liste entrante de produits.  L'impl√©mentation r√©elle de prepare ressemble √† ceci: <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepare</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(products: [BMProduct])</span></span></span></span> -&gt; [<span class="hljs-type"><span class="hljs-type">BMProduct</span></span>] { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> validatedProducts = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.productsSource.validate(products: products) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> validatedProducts }</code> </pre><br>  <i><font color="gray">Listing 2. Fournisseur de paiement en magasin r√©el</font></i> <br><br><h3>  D√©pendance n ¬∞ 2.  R√©ception et remplacement d'un re√ßu d'achat </h3><br>  La deuxi√®me d√©pendance est un peu plus compliqu√©e: nous devons d'abord supprimer l'autorisation afin de ne pas conserver le pool de comptes d'utilisateurs, puis obtenir le contr√¥le lui-m√™me.  Nous pouvons simplement supprimer le formulaire d'autorisation: <br><br><img src="https://habrastorage.org/webt/ir/zr/ak/irzrakxn_kx2ylzcdaudvux5pv4.jpeg"><br>  <i><font color="gray">Figure 5. Suppression d'un formulaire d'autorisation lors d'un paiement</font></i> <br><br>  Ce n'est pas si simple avec un ch√®que.  Les questions sont nombreuses: <br><br><ol><li>  Comment obtenir √† l'avance un re√ßu pour le bon produit? <br></li><li>  Si nous avons re√ßu le ch√®que, alors quand et comment le joindre √† la demande? <br></li></ol><br>  Ici, l'acteur "Utilisateur" a un nouveau r√¥le - QA.  Lorsque nous ex√©cutons le test, nous pouvons non seulement cliquer sur les boutons de l'interface, mais √©galement appeler les m√©thodes API du cadre de test (m√©thodes qui simulent les actions de l'utilisateur) et les services API REST (m√©thodes qui peuvent faire de la magie √† partir du service Badoo interne).  Chez Badoo, nous utilisons un outil API QA tr√®s puissant (vous pouvez trouver toutes ses capacit√©s sur le lien: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://vimeo.com/116931200</a> ).  C'est lui qui nous aide √† tester et v√©rifie le bon produit c√¥t√© serveur de Badoo.  Le serveur Badoo est le meilleur endroit pour g√©n√©rer des ch√®ques: il y a cryptage et d√©cryptage du ch√®que, donc le serveur sait tout sur cette structure de donn√©es. <br><br>  Apr√®s avoir re√ßu un faux ch√®que, nous pouvons le faire passer par une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">porte d√©rob√©e</a> c√¥t√© application.  Ensuite, l'application enverra un faux ch√®que avec les donn√©es utilisateur √† notre serveur. <br><br><img src="https://habrastorage.org/webt/uu/h5/03/uuh503gnoqehjqguhzjhydujvs8.jpeg"><br>  <i><font color="gray">Figure 6. Sch√©ma de r√©ception</font></i> <br><br>  Comment cela est-il devenu techniquement possible? <br><br>  1. Pour configurer un faux ch√®que dans l'application, nous avons pu utiliser une porte d√©rob√©e qui a enregistr√© le faux ch√®que dans le champ MockPaymentProvider de la r√©ception: <br><br><pre> <code class="swift hljs">#<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-type"><span class="hljs-type">BUILD_FOR_AUTOMATION</span></span> <span class="hljs-meta"><span class="hljs-meta">@objc</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BadooAppDelegate</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@objc</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setMockPurchaseReceipt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> receipt: String?)</span></span></span></span> { <span class="hljs-type"><span class="hljs-type">PaymentProvidersFactory</span></span>.useMockPaymentProviderForITunesPayments = <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-type"><span class="hljs-type">MockPaymentProvider</span></span>.receipt = receipt } ... } #endif</code> </pre> <br>  <i><font color="gray">Listing 3. Fausse porte d√©rob√©e</font></i> <br><br>  2. L'application a pu prendre notre ch√®que gr√¢ce √† MockPaymentProvider, dans lequel nous avons utilis√© la maquette makePayment et le ch√®que enregistr√© dans MockPaymentProvider.receipt: <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MockPaymentProvider</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PaymentProvider</span></span></span><span class="hljs-class"> </span></span>{ ... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">makePayment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> transaction: BPDPaymentTransactionContext)</span></span></span></span> { ... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> receiptData = <span class="hljs-type"><span class="hljs-type">MockPaymentProvider</span></span>.receipt?.data(using: .utf8) { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> request = <span class="hljs-type"><span class="hljs-type">BPDPurchaseReceiptRequest</span></span>(...) <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.networkService.send(request, completion: { [<span class="hljs-keyword"><span class="hljs-keyword">weak</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>] (<span class="hljs-number"><span class="hljs-number">_</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">guard</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> sSelf = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> receipt = request.responsePayload() { sSelf.delegate?.paymentProvider(sSelf, didReceiveReceipt: receipt) } }) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.delegate?.paymentProvider(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, didFailTransaction: transaction) } } }</code> </pre> <br>  <i><font color="gray">Listing 4. Appel d'un moka de traitement des achats avec un faux ch√®que</font></i> <br><br>  3. Obtenir un faux ch√®que <br><br>  Pour obtenir un faux contr√¥le, nous avons utilis√© la m√©thode sur le serveur (voir Listing 5).  Il prend un tableau par d√©faut avec des donn√©es pour g√©n√©rer des donn√©es de contr√¥le et y ajoute les donn√©es n√©cessaires pour un produit particulier. <br><br><pre> <code class="php hljs">$new_receipt_model = array_replace_recursive( <span class="hljs-comment"><span class="hljs-comment">//       $this-&gt;getDefaultModel(), //       //,      $this-&gt;enrichModelUsingSubscription($nr), //        $this-&gt;enrichModelUsingInput($input) ); //  $new_receipt = $this-&gt;signReceipt( json_encode($new_receipt_model, true), $new_receipt_model );</span></span></code> </pre><br>  <i><font color="gray">Listing 5. Partie serveur de la g√©n√©ration de ch√®ques</font></i> <br><br>  Pour r√©p√©ter la structure d'un ch√®que r√©el, le ch√®que personnalis√© envoy√© par l'application doit √™tre chiffr√© √† l'aide d'un certificat.  Nous utilisons notre certificat de travail au lieu du certificat Apple. <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">signReceipt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($receipt, $response)</span></span></span><span class="hljs-function">  </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//     base64 $receipt = 'Subject: ' . base64_encode(json_encode($response)) . PHP_EOL . PHP_EOL . $receipt; file_put_contents($receipt_file, $receipt); ... //    $sign_result = openssl_pkcs7_sign( $receipt_file, $signed_receipt_file, 'file://'.$path_cert, 'file://'.$path_key, [], PKCS7_BINARY); ... //  $signed_content_with_headers = file_get_contents($signed_receipt_file); list($headers, $signed_content) = explode(PHP_EOL . PHP_EOL, $signed_content_with_headers); //  return str_replace(["\r\n", "\r", "\n"], '', $signed_content); }</span></span></code> </pre><br>  <i><font color="gray">Listing 6. M√©thode de signature d'un ch√®que avec un certificat</font></i> <br><br>  4. En cons√©quence, dans le test, nous obtenons: <br><br><pre> <code class="ruby hljs">(<span class="hljs-regexp"><span class="hljs-regexp">/       "((\d+) |  (\d+) ?/</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|service_type|</span></span> <span class="hljs-comment"><span class="hljs-comment">#    service_details = parse_options(service_type) #  QA API (  Badoo) receipt = QaApi::Billing.order_get_app_store_receipt(service_details) #   Backdoors.set_fake_receipt(receipt) end</span></span></code> </pre><br>  <i><font color="gray">Listing 7. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">√âtape de</a> test de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Gherkin</a> pour le framework <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Cucumber</a></font></i> <br><br><h3>  D√©pendance n ¬∞ 3.  V√©rification d'un ch√®que sur un serveur Badoo </h3><br>  Pour supprimer la troisi√®me d√©pendance, vous devez vous d√©barrasser de la v√©rification de v√©rification sur le serveur.  Il est important de se rappeler que la v√©rification se fait en deux √©tapes.  √Ä la premi√®re √©tape, le ch√®que est authentifi√© sur la base des signatures et des certificats.  Le deuxi√®me - le ch√®que est envoy√© √† l'App Store.  En cas de validation r√©ussie √† ce stade, nous recevrons un ch√®que d√©crypt√© qui pourra √™tre trait√©. <br><br><img src="https://habrastorage.org/webt/pd/9g/p_/pd9gp_uz1kjnsb9rsk9weczdngw.jpeg"><br>  <i><font color="gray">Figure 7. Suppression de la v√©rification du serveur</font></i> <br><br>  Tout d'abord, le serveur effectue la v√©rification initiale de la v√©rification dans la m√©thode verifyReceiptByCert de la classe parente.  Cela v√©rifie la signature avec le certificat App Store.  Dans le cas d'un faux contr√¥le, cette v√©rification √©chouera car elle est sign√©e par notre certificat, et nous appellerons la m√©thode de v√©rification avec le certificat local verifyReceiptByLocalCert.  Dans cette m√©thode, nous essaierons de d√©chiffrer le ch√®que √† l'aide d'un certificat local, et en cas de succ√®s, nous placerons le r√©sultat du d√©chiffrement dans le champ interne local_receipt de la classe enfant (m√©thode addLocallyVerifiedReceipt). <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EngineTest</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Engine</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">verifyReceiptByCert</span></span></span><span class="hljs-class">($</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">receipt</span></span></span><span class="hljs-class">)  </span></span>{ $result = <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::verifyReceiptByCert($receipt); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($result === <span class="hljs-number"><span class="hljs-number">-1</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($result)) { $result = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;verifyReceiptByLocalCert($receipt); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $result; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">verifyReceiptByLocalCert</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($receipt)</span></span></span><span class="hljs-function"> </span></span>{ $receipt_file = tempnam(sys_get_temp_dir(), <span class="hljs-string"><span class="hljs-string">'rcp'</span></span>); file_put_contents($receipt_file, base64_decode($receipt)); $result = openssl_pkcs7_verify($receipt_file, PKCS7_BINARY, <span class="hljs-string"><span class="hljs-string">'/dev/null'</span></span>, [$DIR]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($result) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;addLocallyVerifiedReceipt($receipt, base64_decode($response)); } unlink($receipt_file); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $result; } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Engine</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">verifyReceiptByCert</span></span></span><span class="hljs-class">($</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">receipt</span></span></span><span class="hljs-class">) </span></span>{ $receipt_file = tempnam(sys_get_temp_dir(), <span class="hljs-string"><span class="hljs-string">'rcp'</span></span>); file_put_contents($receipt_file, base64_decode($receipt)); $result = openssl_pkcs7_verify($receipt_file, PKCS7_BINARY, <span class="hljs-string"><span class="hljs-string">'/dev/null'</span></span>, [$DIR]); unlink($receipt_file); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $result; }</code> </pre><br>  <i><font color="gray">Listing 8. V√©rification initiale</font></i> <br><br>  Lors de la v√©rification secondaire (verifyReceipt), nous obtenons la valeur du champ local_receipt de la classe enfant getLocallyVerifiedReceipt.  S'il n'est pas vide, nous utilisons sa valeur √† la suite d'une v√©rification. <br><br>  Si le champ est vide, alors nous appelons la v√©rification secondaire √† partir de la classe <i>parent</i> ( <i>parent</i> :: verifyReceipt).  L√†, nous faisons une demande √† l'App Store pour v√©rification de son c√¥t√©.  Le r√©sultat de la v√©rification dans les deux cas est un ch√®que d√©crypt√©. <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EngineTest</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Engine</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">verifyReceipt</span></span></span><span class="hljs-class">($</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">receipt_encoded</span></span></span><span class="hljs-class">, $</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">shared_secret</span></span></span><span class="hljs-class">, $</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">env</span></span></span><span class="hljs-class">) </span></span>{ $response = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getLocallyVerifiedReceipt($receipt_encoded); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($response)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> json_decode($response, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::verifyReceipt($receipt_encoded, $shared_secret, $env); } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Engine</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">verifyReceipt</span></span></span><span class="hljs-class">($</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">receipt_encoded</span></span></span><span class="hljs-class">, $</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">shared_secret</span></span></span><span class="hljs-class">, $</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">env</span></span></span><span class="hljs-class">) </span></span>{ $response = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_sendRequest($receipt_encoded, $shared_secret, $env); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $response; }</code> </pre> <br>  <i><font color="gray">Listing 9. V√©rification secondaire</font></i> <br><br><h3>  5. Test vid√©o: acheter des pr√™ts et des abonnements </h3><br><h4>  Num√©ro de test 1.  Achat d'abonnement </h4><br><div class="scrollable-table"><table><tbody><tr><td>  Quand <br></td><td>  Je me connecte √† l'application en tant que nouvel utilisateur avec une photo <br></td></tr><tr><td>  Et <br></td><td>  Je g√©n√®re un nouveau ch√®que de facturation d'abonnement d'un mois <br></td></tr><tr><td>  Et <br></td><td>  Je vais √† mon profil <br></td></tr><tr><td>  Alors <br></td><td>  Je m'assure que l'abonnement est d√©sactiv√© <br></td></tr><tr><td>  Quand <br></td><td>  J'ouvre la liste des produits <br></td></tr><tr><td>  Et <br></td><td>  J'ach√®te un abonnement d'un mois <br></td></tr><tr><td>  Alors <br></td><td>  Je v√©rifie la notification d'achat r√©ussie <br></td></tr><tr><td>  Et <br></td><td>  Je m'assure que l'abonnement est activ√© <br></td></tr></tbody></table></div><br>  Vid√©o de test: <br><br><img src="https://habrastorage.org/webt/xc/ut/ag/xcutagbl8qmu9wzgva0zop2xqg0.gif"><br><h4>  Num√©ro de test 2.  Acheter des pr√™ts et envoyer un cadeau </h4><br><div class="scrollable-table"><table><tbody><tr><td>  Quand <br></td><td>  Je me connecte √† l'application en tant que nouvel utilisateur avec une photo <br></td></tr><tr><td>  Et <br></td><td>  J'ajoute dix cr√©dits √† mon profil <br></td></tr><tr><td>  Et <br></td><td>  Je g√©n√®re une nouvelle v√©rification de cr√©dit pour 550 cr√©dits <br></td></tr><tr><td>  Et <br></td><td>  Je cr√©e un nouvel utilisateur Leela <br></td></tr><tr><td>  Et <br></td><td>  Leela a vot√© oui pour moi <br></td></tr><tr><td>  Et <br></td><td>  Je vais aux gens √† proximit√© et j'ouvre un profil Leela <br></td></tr><tr><td>  Et <br></td><td>  Je vote "Oui" pour Leela <br></td></tr><tr><td>  Alors <br></td><td>  Je v√©rifie la page du match <br></td></tr><tr><td>  Quand <br></td><td>  Je choisis d'envoyer un cadeau r√©gulier <br></td></tr><tr><td>  Alors <br></td><td>  Je v√©rifie l'√©cran de paiement avec une liste de colis <br></td></tr><tr><td>  Quand <br></td><td>  Je choisis d'acheter 550 cr√©dits <br></td></tr><tr><td>  Alors <br></td><td>  Je v√©rifie la notification d'achat r√©ussie <br></td></tr><tr><td>  Et <br></td><td>  Je m'assure que Leela a re√ßu un cadeau de chat <br></td></tr></tbody></table></div><br><br>  Vid√©o de test: <br><br><img src="https://habrastorage.org/webt/jb/dl/oj/jbdlojncgj656usnr5bsylaese4.gif"><br><br><h2>  √âvaluation de la d√©cision: principaux risques </h2><br>  La suppression des d√©pendances externes comporte certains risques. <br><br>  1. Configuration incorrecte. <br><br>  √âtant donn√© que la v√©rification n'est pas de notre c√¥t√©, nous pouvons mal configurer nos produits du c√¥t√© Apple.  Pour nous prot√©ger de l'erreur, nous avons √©crit un test unitaire c√¥t√© serveur distinct, qui v√©rifie que tous les produits que nous d√©marrons c√¥t√© Apple correspondent aux produits que nous avons dans notre configuration. <br><br>  2. Cas limites. <br><br>  Par exemple, lorsque le paiement est enti√®rement effectu√©, l'utilisateur re√ßoit une notification indiquant qu'il a effectu√©, mais notre application ne trouve pas le ch√®que qui doit √™tre falsifi√© √† la suite de ce paiement.  Le risque r√©side dans le fait que nous attachons nous-m√™mes le ch√®que √† l'aide d'une porte d√©rob√©e, et nous ne pouvons naturellement pas suivre un tel cas.  Afin de compenser en quelque sorte ce risque, nous effectuons des contr√¥les de bout en bout en utilisant le bac √† sable ou un v√©ritable paiement apr√®s la lib√©ration. <br><br>  3. Faux d√©loyaux ou fraude. <br><br>  Apr√®s avoir lu cet article, vous pourriez penser qu'√©tant donn√© que Badoo utilise de faux ch√®ques, vous pouvez nous attacher quelque chose de faux et utiliser le service gratuitement.  Pour que ce risque ne se mat√©rialise pas, nous signons tout avec notre propre certificat et limitons l'utilisation de moks et de faux contr√¥les √† des tests fonctionnels qui ne sont ex√©cut√©s que dans notre environnement de d√©veloppement. <br><br>  4. Modifiez le format du ch√®que. <br><br>  C'est le risque le plus s√©rieux.  Changer le format d'un ch√®que est possible quand Apple change quelque chose sans nous en avertir.  Nous avons eu un tel cas: lors du passage √† iOS 11, le format du ch√®que a compl√®tement chang√©.  Nous avons g√©n√©r√© un faux ch√®que sur notre serveur et l'avons utilis√© dans le test.  Tout √©tait parfait avec nous: tous les champs sont en place, tout est merveilleux, tout est en cours de traitement.  Mais lorsque nous sommes pass√©s au syst√®me r√©el, rien n'a fonctionn√©.  Les champs importants sur le ch√®que ont tout simplement cess√© d'exister. <br><br>  Comment compenser ce risque?  Premi√®rement, nous n'excluons pas la possibilit√© de tester de bout en bout le bac √† sable avant la sortie et le paiement r√©el - apr√®s la sortie.  Nous sommes maintenant dans la phase active d'un projet de v√©rification des notifications, lorsque nous essayons de classer tous les ch√®ques que nous recevons de la production selon que nous comprenons ce que c'est ou ne comprenons pas.  Si la r√©ponse est non, alors nous commen√ßons √† tout traiter manuellement, voir ce qui a chang√©, ce qui ne va pas, ce qui doit √™tre chang√© dans notre syst√®me. <br><div class="scrollable-table"><table><tbody><tr><td>  Risque <br></td><td>  Raison <br></td><td>  Comment compenser <br></td></tr><tr><td>  mauvaise configuration <br></td><td>  supprimer le ch√®que <br></td><td>  test unitaire sur le serveur <br></td></tr><tr><td>  cas de bord <br>  (ch√®que non remis) <br></td><td>  utiliser une porte d√©rob√©e <br></td><td>  Ch√®ques E2E (bac √† sable et paiement r√©el) <br></td></tr><tr><td>  fraude frauduleuse, fraude <br></td><td>  notification et g√©n√©ration de ch√®ques sur le serveur <br></td><td>  propre certificat <br></td></tr><tr><td>  changer le format du ch√®que <br></td><td>  notification et g√©n√©ration de ch√®ques sur le serveur <br></td><td>  v√©rification des notifications r√©elles et v√©rification de la prod (nouveau projet), <br>  Ch√®ques E2E (bac √† sable et paiement r√©el) <br></td></tr></tbody></table></div><br><h2>  R√©sultat </h2><br><br>  Consid√©rez les principaux avantages que nous avons pu obtenir gr√¢ce √† l'application de la m√©thode moki et du faux objet. <br><br><h4>  Automatisation peu co√ªteuse, rapide et stable des services payants sur iOS </h4><br>  En collaboration avec l'√©quipe de tests manuels iOS (merci sp√©cial √† Colin Chan), nous avons pu √©crire plus de 150 auto-tests pour les paiements.  Il s'agit d'une couverture assez importante pour un domaine de l'application. <br><br>  Gr√¢ce √† la parall√©lisation, nous pouvons obtenir le r√©sultat en seulement 15 √† 20 minutes sur n'importe quelle branche du d√©veloppeur client iOS ou du serveur de facturation.  Avant l'automatisation, le test manuel de cette zone par une seule personne prenait huit heures. <br><br>  Nous pouvons √©galement tester la grande majorit√© des cas de test en configurant le fournisseur de paiement simul√© via le moki de la mani√®re dont nous avons besoin.  Avec l'aide de mooks, nous avons appris comment d√©sactiver la v√©rification du produit et simuler les cas lorsque la v√©rification est partiellement effectu√©e.  Ainsi, nous avons ouvert des dossiers que nous ne pouvions pas tester en principe auparavant. <br><br><h4>  R√©gression fonctionnelle dans le d√©veloppement de nouvelles fonctionnalit√©s </h4><br>  L'automatisation a tr√®s bien fonctionn√© dans les cas o√π le d√©veloppeur en train de travailler sur une nouvelle fonctionnalit√© affectait l'ancienne fonctionnalit√©.  Nous avons eu un exemple lorsqu'un d√©veloppeur a fait une fonctionnalit√© complexe avec la mise en cache et a ex√©cut√© nos tests automatiques.  Certains d'entre eux se sont tromp√©s.  Il l'a vu et l'a r√©par√©.  Puis il a recommenc√© les autotests - et encore, quelque chose est tomb√©.  En cons√©quence, il a fait une s√©rie d'it√©rations jusqu'au moment o√π tout a commenc√© √† fonctionner normalement du c√¥t√© de l'application. <br><br><h4>  R√©gression fonctionnelle dans la refactorisation des paiements </h4><br>  L'automatisation la plus r√©ussie et la plus efficace possible se produit peut-√™tre dans le domaine du refactoring de code.  Dans ce cas, seule l'impl√©mentation interne change - il n'est pas n√©cessaire de modifier le code d'autotest.  L'interface utilisateur ne change en aucune fa√ßon et les autotests peuvent √™tre pilot√©s efficacement. <br><br><h4>  Test des fonctionnalit√©s exp√©rimentales d'Apple: p√©riode de gr√¢ce </h4><br>  Un syst√®me similaire est compl√®tement interchangeable lorsque vous testez de nouvelles int√©grations qui ne sont pas encore impl√©ment√©es dans le bac √† sable.  Il en √©tait de m√™me de la p√©riode de gr√¢ce.  Cette fonctionnalit√© n'est pas dans le bac √† sable.  Le d√©lai de gr√¢ce sur Apple n'est pas encore accessible √† tous.  Il s'agit d'un projet pilote que Badoo met en ≈ìuvre avec Apple.  Afin de v√©rifier avec un d√©lai de gr√¢ce, nous devions ajouter ici un tel morceau de code JSON: <br><br><pre> <code class="json hljs">pending_renewal_info:[ { expiration_intent: <span class="hljs-number"><span class="hljs-number">2</span></span> grace_period_expires_date: <span class="hljs-number"><span class="hljs-number">2019</span></span><span class="hljs-number"><span class="hljs-number">-04</span></span><span class="hljs-number"><span class="hljs-number">-25</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">50</span></span>:<span class="hljs-number"><span class="hljs-number">57</span></span> Etc/GMT auto_renew_product_id: badoo.productId original_transaction_id: <span class="hljs-number"><span class="hljs-number">560000361869085</span></span> is_in_billing_retry_period: <span class="hljs-number"><span class="hljs-number">1</span></span> grace_period_expires_date_pst: <span class="hljs-number"><span class="hljs-number">2019</span></span><span class="hljs-number"><span class="hljs-number">-04</span></span><span class="hljs-number"><span class="hljs-number">-25</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">50</span></span>:<span class="hljs-number"><span class="hljs-number">57</span></span> America/Los_Angeles product_id: badoo.productId grace_period_expires_date_ms: <span class="hljs-number"><span class="hljs-number">1556207457000</span></span> auto_renew_status: <span class="hljs-number"><span class="hljs-number">1</span></span> }]</code> </pre><br>  <i><font color="gray">Listing 10. D√©lai de gr√¢ce pour un abonnement</font></i> <br><br>  Nous l'avons fait tr√®s facilement en quelques secondes.  Dans notre syst√®me, nous avons pu tester notre r√©action √† une nouvelle fonctionnalit√©.  Maintenant, nous ex√©cutons cette fonctionnalit√© sur le prod. <br><br><h4>  Tests de qualit√© des produits dans les m√©thodes de composition </h4><br>  √Ä la suite de nos recherches, nous avons pu d√©crire une m√©thode qui √©limine le bruit des d√©pendances externes.  Cela a aid√© les d√©veloppeurs clients dans le processus de d√©veloppement de fonctionnalit√©s √† trouver des bogues au d√©but. <br><br>  Mais ne pensez pas que nous ayons pu tout tester avec cette m√©thode.  Pour tout tester, il est pr√©f√©rable d'utiliser une composition de m√©thodes: tester avec une vraie carte sur le prod, tester dans le bac √† sable, la m√©thode des mokes et des faux objets, les tests unitaires et d'int√©gration.  N'oubliez pas l'√©quilibre de la pyramide des tests et n'essayez pas de r√©soudre tous les probl√®mes avec une seule m√©thode.  Cela peut conduire √† une triste automatisation dans le bac √† sable, √† de tristes tests manuels avec une vraie carte de tous les cas, et √† de nombreuses autres erreurs graves √† l'endroit exact o√π leur apparence est la plus douloureuse. <br><br><h2>  Conclusion </h2><br>  √Ä la suite de nos recherches, nous avons obtenu une m√©thode peu co√ªteuse, rapide et stable de tester non seulement les services payants sur iOS, mais aussi tous les composants qui sont int√©gr√©s dans l'application comme une ¬´bo√Æte noire¬ª.  Maintenant, chez Badoo, nous mettons en ≈ìuvre cette m√©thode pour tester les fournisseurs payants Android (Global Charge, Boku, Centili) qui ont des bacs √† sable instables ou toute autre restriction.  Nous utilisons √©galement la m√©thode moki pour tester la publicit√©, le streaming et la g√©olocalisation. <br><br>  Il convient de dire que le processus d'introduction d'une nouvelle m√©thode n'a pas √©t√© rapide.  J'ai d√ª n√©gocier avec quatre √©quipes: iOS QA, iOS Dev, Billing QA, Billing Dev.  Tout le monde ne voulait pas passer √† une nouvelle m√©thode, craignant les risques.  Parfois, c'√©tait une suite dogmatique: pendant de nombreuses ann√©es, nous avons test√© dans le bac √† sable, et la principale force qui pouvait d√©truire le dogme √©tait le d√©sir des testeurs de facturation et de la plate-forme iOS de changer la situation et de se d√©barrasser des tourments.  Plus tard, les d√©veloppeurs ont r√©alis√© des avantages de cette m√©thode comme des diagnostics pr√©cis (nous n'avons pas pu trouver de bogues dans le bac √† sable, mais des bogues de notre client ou serveur), une flexibilit√© dans la configuration du composant (nous avons pu facilement tester des cas n√©gatifs au niveau de l'int√©gration) et, bien s√ªr, la r√©ponse √©tait 30 minutes sur une branche avec du code d√©velopp√©. <br><br>  Un grand merci √† tous ceux qui ont lu jusqu'√† la fin.  Un grand merci √† tous ceux qui ont aid√© et particip√© √† ce projet.  Un merci sp√©cial √† ces personnes: <br><br><ul><li>  Peter Kolpashchikov est un d√©veloppeur iOS qui a aid√© √† faire moki c√¥t√© client et a d√©velopp√© un concept PPP; <br></li><li>  Vladimir Solodov - Billing QA, qui a aid√© l'API QA √† g√©n√©rer de faux ch√®ques et √† partir du serveur de facturation; <br></li><li>  Maxim Filatov et Vasily Stepanov - Billing Dev Team, qui ont aid√© avec le code du serveur de facturation; <br></li><li>  iOS Dev Team - d√©veloppeurs qui ont pu refactoriser nos paiements dans un nouveau concept, rendant possible l'utilisation de mokas; <br></li><li>  iOS QA Team est une √©quipe de test impressionnante qui a √©crit un tas d'autotests; <br></li><li>  √âquipe QA de facturation - testeurs qui ont aid√© √† rechercher des probl√®mes. <br></li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr460667/">https://habr.com/ru/post/fr460667/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr460651/index.html">R√©union de la Society of Anonymous Testers: TMS, monitoring monitoring, search quality evaluation and native iOS tests</a></li>
<li><a href="../fr460655/index.html">Comment j'ai bris√© Telegram</a></li>
<li><a href="../fr460659/index.html">Utilisation de tuyaux pour pivoter</a></li>
<li><a href="../fr460661/index.html">Tout ce que vous devez savoir sur Node.js</a></li>
<li><a href="../fr460665/index.html">Projet de FAQ: Pourquoi les normes C ++ sont-elles publi√©es tous les trois ans?</a></li>
<li><a href="../fr460669/index.html">Comment assurer la s√©curit√© du d√©veloppement, gagner du temps et des nerfs</a></li>
<li><a href="../fr460671/index.html">Propri√©t√© et emprunt en D</a></li>
<li><a href="../fr460673/index.html">Exposez la magie de DiffUtil</a></li>
<li><a href="../fr460675/index.html">Extraction de donn√©es d'apprentissage automatique</a></li>
<li><a href="../fr460683/index.html">Projecteur d'√©v√©nements Laravel et concept de g√©n√©ration d'√©v√©nements</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>