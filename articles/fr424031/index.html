<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöï üèì üôçüèº Programmation r√©active avec JAX-RS üèà üî´ üè≥Ô∏è‚Äçüåà</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour √† tous! 

 L'ann√©e derni√®re, le cours Java Enterprise Developer a √©t√© lanc√© avec succ√®s et nous avons le dernier mat√©riel sur ce sujet que nou...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Programmation r√©active avec JAX-RS</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/424031/"> Bonjour √† tous! <br><br>  L'ann√©e derni√®re, le cours <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Java Enterprise Developer a</a> √©t√© lanc√© avec succ√®s et nous avons le dernier mat√©riel sur ce sujet que nous voulons partager avec vous, qui discute de l'utilisation de l'approche asynchrone et de la mise en sc√®ne pour d√©velopper des applications r√©actives r√©actives. <br><br>  Allons-y. <br><br>  La programmation r√©active sonne d'abord comme le nom d'un paradigme √©mergent, mais se r√©f√®re en fait √† une m√©thode de programmation dans laquelle une approche orient√©e √©v√©nement est utilis√©e pour travailler avec des flux de donn√©es asynchrones.  Bas√©s sur des donn√©es constamment √† jour, les syst√®mes r√©actifs y r√©pondent en effectuant une s√©rie d'√©v√©nements. <br>  La programmation r√©active suit le mod√®le de conception ¬´Observateur¬ª, qui peut √™tre d√©fini comme suit: si un √©tat change dans un objet, tous les autres objets sont notifi√©s et mis √† jour en cons√©quence.  Par cons√©quent, au lieu d'interroger les √©v√©nements pour les modifications, les √©v√©nements sont pouss√©s de mani√®re asynchrone afin que les observateurs puissent les traiter.  Dans cet exemple, les observateurs sont des fonctions qui sont ex√©cut√©es lorsque l'√©v√©nement est distribu√©.  Et le flux de donn√©es mentionn√© est le v√©ritable observable. <br><br>  Presque tous les langages et frameworks utilisent cette approche dans leur √©cosyst√®me, et les derni√®res versions de Java ne font pas exception.  Dans cet article, je vais expliquer comment la programmation r√©active peut √™tre appliqu√©e √† l'aide de la derni√®re version de JAX-RS dans les fonctionnalit√©s Java EE 8 et Java 8. <br><br><img src="https://habrastorage.org/webt/zp/g6/dr/zpg6dry4ynjfjnr6y6fkmkluoea.png"><a name="habracut"></a><br><br>  <b>Jet Manifesto</b> <br><br>  Le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Jet Manifesto</a> √©num√®re quatre aspects fondamentaux dont une application a besoin pour √™tre plus flexible, coupl√©e de mani√®re l√¢che et facile √† √©voluer, et donc capable d'√™tre r√©active.  Il stipule que l'application doit √™tre r√©active, flexible (et donc √©volutive), r√©siliente et ax√©e sur les messages. <br><br>  L'objectif sous-jacent est une application vraiment r√©active.  Supposons qu'il existe une application dans laquelle un gros thread est engag√© dans le traitement des demandes des utilisateurs, et apr√®s avoir termin√© le travail, ce thread renvoie les r√©ponses aux demandeurs d'origine.  Lorsqu'une application re√ßoit plus de demandes qu'elle n'en peut g√©rer, ce thread devient un goulot d'√©tranglement et l'application perd son ancienne r√©activit√©.  Pour maintenir la r√©activit√©, l'application doit √™tre √©volutive et r√©siliente.  Durable peut √™tre consid√©r√© comme une application dot√©e de fonctionnalit√©s d'auto-r√©cup√©ration.  D'apr√®s l'exp√©rience de la plupart des d√©veloppeurs, seule une architecture bas√©e sur les messages permet √† l'application d'√™tre √©volutive, r√©siliente et r√©active. <br><br>  La programmation r√©active a √©t√© introduite dans Java 8 et Java EE 8. Java a introduit des concepts tels que <code>CompletionStage</code> et son impl√©mentation de <code>CompletableFuture</code> , et Java a commenc√© √† utiliser ces fonctionnalit√©s dans des sp√©cifications telles que l'API Reactive Client dans JAX-RS. <br><br>  <b>API client r√©active JAX-RS 2.1</b> <br><br>  Voyons comment la programmation r√©active peut √™tre utilis√©e dans les applications Java EE 8. Pour comprendre le processus, vous avez besoin d'une connaissance de base de l'API Java EE. <br><br>  JAX-RS 2.1 a introduit une nouvelle fa√ßon de cr√©er un client REST avec prise en charge de la programmation r√©active.  L'impl√©mentation d'invocateur par d√©faut propos√©e dans JAX-RS est synchrone, ce qui signifie que le client cr√©√© enverra un appel de blocage au point de terminaison du serveur.  Un exemple d'impl√©mentation est pr√©sent√© dans le Listing 1. <br><br>  Listing 1 <br><br><pre> <code class="java hljs">Response response = ClientBuilder.newClient() .target(<span class="hljs-string"><span class="hljs-string">"http://localhost:8080/service-url"</span></span>) .request() .get();</code> </pre> <br>  √Ä partir de la version 2.0, JAX-RS prend en charge la cr√©ation d'un appelant asynchrone sur l'API client avec un simple appel √† la m√©thode <code>async()</code> , comme indiqu√© dans le listing 2. <br><br>  Listing 2 <br><br><pre> <code class="java hljs">Future&lt;Response&gt; response = ClientBuilder.newClient() .target(<span class="hljs-string"><span class="hljs-string">"http://localhost:8080/service-url"</span></span>) .request() .async() .get();</code> </pre> <br>  L'utilisation d'un invocateur asynchrone sur le client renvoie une instance <code>Future</code> de type <code>javax.ws.rs.core.Response</code> .  Cela peut conduire √† interroger la r√©ponse, avec un appel √† <code>future.get()</code> , ou √† enregistrer un rappel qui sera appel√© lorsqu'une r√©ponse HTTP sera disponible.  Les deux impl√©mentations conviennent √† la programmation asynchrone, mais les choses se compliquent g√©n√©ralement si vous souhaitez regrouper des rappels ou ajouter des cas conditionnels √† ces minima d'ex√©cution asynchrones. <br><br>  JAX-RS 2.1 fournit un moyen r√©actif de surmonter ces probl√®mes avec la nouvelle API client r√©active JAX-RS pour la construction d'un client.  C'est aussi simple que d'appeler la m√©thode <code>rx()</code> lors de la g√©n√©ration du client.  Dans le listing 3, la m√©thode <code>rx()</code> renvoie l'invocateur r√©actif qui existe pendant l'ex√©cution du client, et le client renvoie une r√©ponse de type <code>CompletionStage.rx()</code> , qui permet la transition de l'invocateur synchrone √† l'appelant asynchrone avec un simple appel. <br><br>  Listing 3 <br><br><pre> <code class="java hljs">CompletionStage&lt;Response&gt; response = ClientBuilder.newClient() .target(<span class="hljs-string"><span class="hljs-string">"http://localhost:8080/service-url"</span></span>) .request() .rx() .get();</code> </pre> <br>  <code>CompletionStage&lt;&gt;</code> est une nouvelle interface introduite dans Java 8. Elle repr√©sente un calcul, qui peut √™tre une √©tape dans le cadre d'un calcul plus large, comme son nom l'indique.  Il s'agit du seul repr√©sentant de r√©activit√© Java 8 √† avoir frapp√© le JAX-RS. <br>  Apr√®s avoir re√ßu l'instance de r√©ponse, je peux appeler <code>AcceptAsync()</code> , o√π je peux fournir un morceau de code qui s'ex√©cutera de mani√®re asynchrone lorsque la r√©ponse sera disponible, comme indiqu√© dans le Listing 4. <br><br>  Listing 4 <br><br><pre> <code class="java hljs">response.thenAcceptAsync(res -&gt; { Temperature t = res.readEntity(Temperature.class); <span class="hljs-comment"><span class="hljs-comment">//do stuff with t });</span></span></code> </pre> <br>  <b>Ajout de r√©activit√© √† un point de terminaison REST</b> <br><br>  L'approche r√©active ne se limite pas au c√¥t√© client dans JAX-RS;  il peut √©galement √™tre utilis√© c√¥t√© serveur.  Pour un exemple, je vais d'abord cr√©er un script simple o√π je peux demander une liste d'emplacements d'une destination.  Pour chaque position, je ferai un appel s√©par√© avec les donn√©es de localisation √† un autre point pour obtenir les valeurs de temp√©rature.  L'interaction des destinations sera comme indiqu√© dans la figure 1. <br><br><img src="https://habrastorage.org/webt/rd/zr/cr/rdzrcrvbeyyfkp_bc5szid_t9au.png"><br>  <i>Figure 1. Interaction entre les points de destination</i> <br><br>  Tout d'abord, je d√©finis simplement le mod√®le de domaine, puis les services pour chaque mod√®le.  Le listing 5 montre comment la classe <code>Forecast</code> est d√©finie, ce qui englobe les classes <code>Location</code> et <code>Temperature</code> . <br><br>  Listing 5 <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Temperature</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Double temperature; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String scale; <span class="hljs-comment"><span class="hljs-comment">// getters &amp; setters } public class Location { String name; public Location() {} public Location(String name) { this.name = name; } // getters &amp; setters } public class Forecast { private Location location; private Temperature temperature; public Forecast(Location location) { this.location = location; } public Forecast setTemperature( final Temperature temperature) { this.temperature = temperature; return this; } // getters }</span></span></code> </pre> <br>  Pour boucler la liste des pr√©visions, la classe <code>ServiceResponse</code> impl√©ment√©e dans le Listing 6. <br><br>  Listing 6 <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServiceResponse</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> processingTime; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;Forecast&gt; forecasts = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;&gt;(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setProcessingTime</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> processingTime)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.processingTime = processingTime; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ServiceResponse </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">forecasts</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(List&lt;Forecast&gt; forecasts)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.forecasts = forecasts; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } <span class="hljs-comment"><span class="hljs-comment">// getters }</span></span></code> </pre> <br>  <code>LocationResource</code> indiqu√©e dans le Listing 7 d√©finit trois exemples d'emplacements renvoy√©s avec le chemin <code>/location</code> . <br><br>  Listing 7 <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Path</span></span>(<span class="hljs-string"><span class="hljs-string">"/location"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LocationResource</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@GET</span></span> <span class="hljs-meta"><span class="hljs-meta">@Produces</span></span>(MediaType.APPLICATION_JSON) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Response </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getLocations</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ List&lt;Location&gt; locations = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;&gt;(); locations.add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Location(<span class="hljs-string"><span class="hljs-string">"London"</span></span>)); locations.add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Location(<span class="hljs-string"><span class="hljs-string">"Istanbul"</span></span>)); locations.add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Location(<span class="hljs-string"><span class="hljs-string">"Prague"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Response.ok(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GenericEntity&lt;List&lt;Location&gt;&gt;(locations){}).build(); } }</code> </pre> <br>  <code>TemperatureResource</code> indiqu√© dans le Listing 8 renvoie une valeur de temp√©rature g√©n√©r√©e al√©atoirement entre 30 et 50 pour un emplacement donn√©.  Un d√©lai de 500 ms a √©t√© ajout√© √† l'impl√©mentation pour simuler une lecture de capteur. <br><br>  Listing 8 <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Path</span></span>(<span class="hljs-string"><span class="hljs-string">"/temperature"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TemperatureResource</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@GET</span></span> <span class="hljs-meta"><span class="hljs-meta">@Path</span></span>(<span class="hljs-string"><span class="hljs-string">"/{city}"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Produces</span></span>(MediaType.APPLICATION_JSON) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Response </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAverageTemperature</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@PathParam(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"city"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> String cityName) </span></span>{ Temperature temperature = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Temperature(); temperature.setTemperature((<span class="hljs-keyword"><span class="hljs-keyword">double</span></span>) (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Random().nextInt(<span class="hljs-number"><span class="hljs-number">20</span></span>) + <span class="hljs-number"><span class="hljs-number">30</span></span>)); temperature.setScale(<span class="hljs-string"><span class="hljs-string">"Celsius"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Thread.sleep(<span class="hljs-number"><span class="hljs-number">500</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (InterruptedException ignored) { ignored.printStackTrace(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Response.ok(temperature).build(); } }</code> </pre> <br>  Tout d'abord, je vais montrer l'impl√©mentation du <code>ForecastResource</code> synchrone (voir Listing 9), qui retourne tous les emplacements.  Ensuite, pour chaque position, il appelle le service de temp√©rature pour obtenir les valeurs en degr√©s Celsius. <br><br>  Listing 9 <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Path</span></span>(<span class="hljs-string"><span class="hljs-string">"/forecast"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ForecastResource</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Uri</span></span>(<span class="hljs-string"><span class="hljs-string">"location"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WebTarget locationTarget; <span class="hljs-meta"><span class="hljs-meta">@Uri</span></span>(<span class="hljs-string"><span class="hljs-string">"temperature/{city}"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WebTarget temperatureTarget; <span class="hljs-meta"><span class="hljs-meta">@GET</span></span> <span class="hljs-meta"><span class="hljs-meta">@Produces</span></span>(MediaType.APPLICATION_JSON) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Response </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getLocationsWithTemperature</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> startTime = System.currentTimeMillis(); ServiceResponse response = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ServiceResponse(); List&lt;Location&gt; locations = locationTarget .request() .get(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GenericType&lt;List&lt;Location&gt;&gt;(){}); locations.forEach(location -&gt; { Temperature temperature = temperatureTarget .resolveTemplate(<span class="hljs-string"><span class="hljs-string">"city"</span></span>, location.getName()) .request() .get(Temperature.class); response.getForecasts().add( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Forecast(location).setTemperature(temperature)); }); <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> endTime = System.currentTimeMillis(); response.setProcessingTime(endTime - startTime); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Response.ok(response).build(); } }</code> </pre> <br>  Lorsque la destination de pr√©vision est demand√©e en tant que <code>/forecast</code> , vous obtiendrez une sortie similaire √† celle illustr√©e dans le listing 10. Notez que le temps de traitement de la demande a pris 1,533 ms, ce qui est logique, car une demande synchrone de valeurs de temp√©rature √† partir de trois emplacements diff√©rents s'√©l√®ve √† 1,5 ms <br><br>  Listing 10 <br><br><pre> <code class="java hljs">{ <span class="hljs-string"><span class="hljs-string">"forecasts"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"location"</span></span>: { <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"London"</span></span> }, <span class="hljs-string"><span class="hljs-string">"temperature"</span></span>: { <span class="hljs-string"><span class="hljs-string">"scale"</span></span>: <span class="hljs-string"><span class="hljs-string">"Celsius"</span></span>, <span class="hljs-string"><span class="hljs-string">"temperature"</span></span>: <span class="hljs-number"><span class="hljs-number">33</span></span> } }, { <span class="hljs-string"><span class="hljs-string">"location"</span></span>: { <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Istanbul"</span></span> }, <span class="hljs-string"><span class="hljs-string">"temperature"</span></span>: { <span class="hljs-string"><span class="hljs-string">"scale"</span></span>: <span class="hljs-string"><span class="hljs-string">"Celsius"</span></span>, <span class="hljs-string"><span class="hljs-string">"temperature"</span></span>: <span class="hljs-number"><span class="hljs-number">38</span></span> } }, { <span class="hljs-string"><span class="hljs-string">"location"</span></span>: { <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Prague"</span></span> }, <span class="hljs-string"><span class="hljs-string">"temperature"</span></span>: { <span class="hljs-string"><span class="hljs-string">"scale"</span></span>: <span class="hljs-string"><span class="hljs-string">"Celsius"</span></span>, <span class="hljs-string"><span class="hljs-string">"temperature"</span></span>: <span class="hljs-number"><span class="hljs-number">46</span></span> } } ], <span class="hljs-string"><span class="hljs-string">"processingTime"</span></span>: <span class="hljs-number"><span class="hljs-number">1533</span></span> }</code> </pre><br>  Jusqu'√† pr√©sent, tout se d√©roule comme pr√©vu.  Il est temps d'introduire une programmation r√©active c√¥t√© serveur, o√π les appels √† chaque emplacement peuvent √™tre effectu√©s en parall√®le apr√®s avoir re√ßu tous les emplacements.  Cela peut clairement am√©liorer le flux synchrone pr√©sent√© pr√©c√©demment.  Cela se fait dans le Listing 11, qui montre la d√©finition de la version du service de pr√©vision r√©actif. <br><br>  Listing 11 <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Path</span></span>(<span class="hljs-string"><span class="hljs-string">"/reactiveForecast"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ForecastReactiveResource</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Uri</span></span>(<span class="hljs-string"><span class="hljs-string">"location"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WebTarget locationTarget; <span class="hljs-meta"><span class="hljs-meta">@Uri</span></span>(<span class="hljs-string"><span class="hljs-string">"temperature/{city}"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WebTarget temperatureTarget; <span class="hljs-meta"><span class="hljs-meta">@GET</span></span> <span class="hljs-meta"><span class="hljs-meta">@Produces</span></span>(MediaType.APPLICATION_JSON) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getLocationsWithTemperature</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Suspended </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> AsyncResponse async)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> startTime = System.currentTimeMillis(); <span class="hljs-comment"><span class="hljs-comment">//   (stage)    CompletionStage&lt;List&lt;Location&gt;&gt; locationCS = locationTarget.request() .rx() .get(new GenericType&lt;List&lt;Location&gt;&gt;() {}); //      , //  ,   , //    CompletionStage final CompletionStage&lt;List&lt;Forecast&gt;&gt; forecastCS = locationCS.thenCompose(locations -&gt; { //      //   ompletionStage List&lt;CompletionStage&lt;Forecast&gt;&gt; forecastList = //      //     locations.stream().map(location -&gt; { //     //      //    final CompletionStage&lt;Temperature&gt; tempCS = temperatureTarget .resolveTemplate("city", location.getName()) .request() .rx() .get(Temperature.class); //   CompletableFuture,   //    //      return CompletableFuture.completedFuture( new Forecast(location)) .thenCombine(tempCS, Forecast::setTemperature); }).collect(Collectors.toList()); //    CompletableFuture, //     completable future //  return CompletableFuture.allOf( forecastList.toArray( new CompletableFuture[forecastList.size()])) .thenApply(v -&gt; forecastList.stream() .map(CompletionStage::toCompletableFuture) .map(CompletableFuture::join) .collect(Collectors.toList())); }); //   ServiceResponse, //       //    . //   future    // forecastCS,    //      CompletableFuture.completedFuture( new ServiceResponse()) .thenCombine(forecastCS, ServiceResponse::forecasts) .whenCompleteAsync((response, throwable) -&gt; { response.setProcessingTime( System.currentTimeMillis() - startTime); async.resume(response); }); } }</span></span></code> </pre> <br>  Une mise en ≈ìuvre r√©active peut sembler compliqu√©e √† premi√®re vue, mais apr√®s une √©tude plus approfondie, vous remarquerez qu'elle est assez simple.  Dans l'impl√©mentation de <code>ForecastReactiveResource</code> je cr√©e d'abord un appel client aux services de localisation √† l'aide de l'API JAX-RS Reactive Client.  Comme je l'ai mentionn√© ci-dessus, il s'agit d'un module compl√©mentaire pour Java EE 8, et il permet de cr√©er un appel r√©actif simplement en utilisant la m√©thode <code>rx()</code> . <br><br>  Maintenant, je cr√©e une nouvelle phase bas√©e sur l'emplacement pour dresser une liste de pr√©visions.  Ils seront stock√©s sous forme de liste de pr√©visions dans une grande √©tape d'ach√®vement appel√©e <code>forecastCS</code> .  En fin de compte, je vais cr√©er une r√©ponse aux appels de service en utilisant uniquement <code>forecastCS</code> . <br><br>  Et maintenant, collectons les pr√©visions sous la forme d'une liste d'√©tapes d'ach√®vement d√©finies dans la variable <code>forecastList</code> .  Pour cr√©er une √©tape d'ach√®vement pour chaque pr√©vision, je passe les donn√©es par emplacement, puis <code>tempCS</code> cr√©e la variable <code>tempCS</code> , √† nouveau √† l'aide de l'API JAX-RS Reactive Client, qui appelle le service de temp√©rature avec le nom de la ville.  Ici, j'utilise la m√©thode <code>resolveTemplate()</code> pour construire le client, et cela me permet de passer le nom de la ville au collecteur en tant que param√®tre. <br><br>  Comme derni√®re √©tape du streaming, j'appelle <code>CompletableFuture.completedFuture()</code> , en passant la nouvelle instance de <code>Forecast</code> tant que param√®tre.  Je combine cet avenir avec l'√©tape <code>tempCS</code> pour avoir une valeur de temp√©rature pour les emplacements surveill√©s. <br><br>  La m√©thode <code>CompletableFuture.allOf()</code> du Listing 11 convertit la liste des √©tapes d'ach√®vement en <code>forecastCS</code> .  L'ex√©cution de cette √©tape renvoie une grande instance future compl√©table lorsque tous les objets futurs compl√©tables fournis sont termin√©s. <br><br>  La r√©ponse de service est une instance de la classe <code>ServiceResponse</code> , donc je cr√©e un futur termin√©, puis je combine l'√©tape d'ach√®vement de la <code>forecastCS</code> CS avec une liste de pr√©visions et calcule le temps de r√©ponse du service. <br><br>  Bien entendu, la programmation r√©active force uniquement le c√¥t√© serveur √† s'ex√©cuter de mani√®re asynchrone;  le c√¥t√© client sera bloqu√© jusqu'√† ce que le serveur renvoie une r√©ponse au demandeur.  Pour surmonter ce probl√®me, les √©v√©nements envoy√©s par le serveur (SSE) peuvent √™tre utilis√©s pour envoyer partiellement une r√©ponse d√®s qu'elle est disponible afin que les valeurs de temp√©rature pour chaque emplacement soient transmises au client une par une.  La sortie de <code>ForecastReactiveResource</code> sera similaire √† celle pr√©sent√©e dans le listing 12. Comme indiqu√© dans la sortie, le temps de traitement est de 515 ms, ce qui est un temps d'ex√©cution id√©al pour obtenir des valeurs de temp√©rature √† partir d'un emplacement. <br><br>  Listing 12 <br><br><pre> <code class="java hljs">{ <span class="hljs-string"><span class="hljs-string">"forecasts"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"location"</span></span>: { <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"London"</span></span> }, <span class="hljs-string"><span class="hljs-string">"temperature"</span></span>: { <span class="hljs-string"><span class="hljs-string">"scale"</span></span>: <span class="hljs-string"><span class="hljs-string">"Celsius"</span></span>, <span class="hljs-string"><span class="hljs-string">"temperature"</span></span>: <span class="hljs-number"><span class="hljs-number">49</span></span> } }, { <span class="hljs-string"><span class="hljs-string">"location"</span></span>: { <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Istanbul"</span></span> }, <span class="hljs-string"><span class="hljs-string">"temperature"</span></span>: { <span class="hljs-string"><span class="hljs-string">"scale"</span></span>: <span class="hljs-string"><span class="hljs-string">"Celsius"</span></span>, <span class="hljs-string"><span class="hljs-string">"temperature"</span></span>: <span class="hljs-number"><span class="hljs-number">32</span></span> } }, { <span class="hljs-string"><span class="hljs-string">"location"</span></span>: { <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Prague"</span></span> }, <span class="hljs-string"><span class="hljs-string">"temperature"</span></span>: { <span class="hljs-string"><span class="hljs-string">"scale"</span></span>: <span class="hljs-string"><span class="hljs-string">"Celsius"</span></span>, <span class="hljs-string"><span class="hljs-string">"temperature"</span></span>: <span class="hljs-number"><span class="hljs-number">45</span></span> } } ], <span class="hljs-string"><span class="hljs-string">"processingTime"</span></span>: <span class="hljs-number"><span class="hljs-number">515</span></span> }</code> </pre> <br>  <b>Conclusion</b> <br><br>  Dans les exemples de cet article, j'ai d'abord montr√© une mani√®re synchrone d'obtenir des pr√©visions √† l'aide des services de localisation et de temp√©rature.  Ensuite, je suis pass√© √† une approche r√©active afin que le traitement asynchrone soit effectu√© entre les appels de service.  Lorsque vous utilisez l'API JAX-RS Reactive Client dans Java EE 8 avec les classes <code>CompletionStage</code> et <code>CompletableFuture</code> disponibles dans Java 8, la puissance du traitement asynchrone se d√©cha√Æne gr√¢ce √† la programmation r√©active. <br><br>  La programmation r√©active est plus que l'impl√©mentation d'un mod√®le asynchrone √† partir d'un mod√®le synchrone;  il simplifie √©galement l'utilisation de concepts tels que l'√©tape d'imbrication.  Plus il est utilis√©, plus il sera facile de g√©rer des scripts complexes en programmation parall√®le. <br><br>  LA FIN <br><br>  Merci de votre attention.  Comme toujours, nous attendons vos commentaires et questions. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr424031/">https://habr.com/ru/post/fr424031/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr424021/index.html">D√©fis des programmes d'auto-apprentissage et comment les surmonter</a></li>
<li><a href="../fr424023/index.html">Nous automatisons l'assemblage d'applications iOS √† l'aide de Fastlane</a></li>
<li><a href="../fr424025/index.html">Routage dans une grande application React</a></li>
<li><a href="../fr424027/index.html">Apprenez les tactiques, techniques et connaissances communes contradictoires (ATT @ CK). Tactiques d'entreprise. 2e partie</a></li>
<li><a href="../fr424029/index.html">Et encore une fois sur la paresse</a></li>
<li><a href="../fr424033/index.html">Que fait Kotlin: une entrevue avec Andrei Breslav</a></li>
<li><a href="../fr424035/index.html">2019 est l'ann√©e o√π Intel s'est arr√™t√©</a></li>
<li><a href="../fr424037/index.html">Une br√®ve visite de GraphQL</a></li>
<li><a href="../fr424039/index.html">Cryptographie apr√®s avoir d√©barqu√© des extraterrestres</a></li>
<li><a href="../fr424041/index.html">Une br√®ve introduction √† la biologie cellulaire</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>