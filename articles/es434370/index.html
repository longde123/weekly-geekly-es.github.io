<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üïØÔ∏è üîí üöÆ Otro conquistador de la sombra en Phaser, o el uso de bicicletas. üë©üèª‚Äçüåæ ü§ö üë©üèæ‚Äç‚úàÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hace dos a√±os, ya estaba experimentando con sustancias de sombra en Phaser 2D. En el √∫ltimo Ludum Dare, de repente decidimos hacer un horror, ¬°pero qu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Otro conquistador de la sombra en Phaser, o el uso de bicicletas.</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/434370/">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Hace dos a√±os,</a> ya estaba experimentando con <s>sustancias de</s> sombra en Phaser 2D.  En el √∫ltimo Ludum Dare, de repente decidimos hacer un horror, ¬°pero qu√© horror sin sombras y luces!  Me part√≠ los nudillos ... <br><br>  ... y nada a tiempo para LD.  En el juego, por supuesto, hay un poco de luz y sombra, pero esta es una apariencia miserable de lo que realmente deber√≠a haber sido. <br><br>  Despu√©s de regresar a casa despu√©s de enviar el juego a la competencia, decid√≠ "cerrar la gestalt" y terminar estas sombras desafortunadas.  Lo que sucedi√≥: puedes <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">sentirte en el juego</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">jugar en la demostraci√≥n</a> , mirar la imagen y leer el art√≠culo. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/m3/if/35/m3if351xwaowt3lxcayun-cuzak.png"></div><br><a name="habracut"></a>  Como siempre en tales casos, no tiene sentido tratar de escribir una soluci√≥n general, debe concentrarse en una situaci√≥n espec√≠fica.  El mundo del juego se puede representar en forma de segmentos, al menos aquellas entidades que proyectan sombras.  Las paredes son rect√°ngulos, las personas son rect√°ngulos, solo giran, el spoiler infernal es un c√≠rculo, pero en el modelo de corte se puede simplificar a una longitud de un di√°metro que siempre es perpendicular a un rayo de luz. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/dh/gq/id/dhgqidngehzo_pn9vgr9eirsgna.png"></div><br>  Hay varias fuentes de luz (20-30), y todas ellas son circulares (focos) y se encuentran condicionalmente m√°s bajas que los objetos iluminados (de modo que las sombras pueden ser infinitas). <br><br>  Vi en mi cabeza las siguientes formas de resolver el problema: <br><br><ol><li>  Para cada fuente de luz, construimos una textura del tama√±o de una pantalla (bueno, o 2-4 veces m√°s peque√±a).  En esta textura, simplemente dibujamos el trapecio BCC'D ', donde A es la fuente de luz, BC es el segmento, B'C' es la proyecci√≥n del segmento hacia el borde de la textura.  Despu√©s de eso, estas texturas se env√≠an al sombreador, donde se mezclan en una sola imagen. <br><br>  El autor del juego de plataformas Celeste hizo algo como esto, que est√° bien escrito en su art√≠culo en medium: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">medium.com/@NoelFB/remaking-celestes-lighting-3478d6f10bf</a> <br><br>  Problemas: 20-30 texturas del tama√±o de una pantalla que necesitan ser redibujadas casi cada cuadro y cargadas en la GPU.  Recuerdo que este fue un proceso muy, muy r√°pido. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/z2/ve/ya/z2veyaflrtcpobcfkkdecuqpkpa.png"></div><br></li><li>  El m√©todo descrito en una publicaci√≥n en un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">habr</a> - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">habr.com/post/272233</a> .  Para cada fuente de luz construimos un "mapa de profundidad", es decir  tal textura, donde x = el √°ngulo del "haz" de la fuente de luz, y = el n√∫mero de la fuente de luz, y el color == distancia de la fuente al obst√°culo m√°s cercano.  Si damos un paso de 0.7 grados (360/512) y 32 fuentes de luz, obtenemos una textura de 512x32, que no se ha actualizado durante tanto tiempo. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/aq/ew/_x/aqew_xze8rbkwvhj-68t3d4glz4.png"></div>  <sup>(ejemplo de textura para un paso de 45 grados)</sup> <br></li><li>  La forma secreta que describir√© al final </li></ol><br>  Al final, me decid√≠ por el m√©todo 2. Sin embargo, lo descrito en el art√≠culo no me conven√≠a hasta el final.  All√≠, la textura tambi√©n se construy√≥ en el sombreador usando un rakecast: el sombreador en el ciclo pas√≥ de la fuente de luz en la direcci√≥n del haz y busc√≥ un obst√°culo.  En mis experimentos anteriores, tambi√©n hice rakecast en el sombreador, y era muy costoso, aunque universal. <br><br>  ‚ÄúSolo tenemos segmentos en el modelo‚Äù, pens√©, ‚Äúy 10-20 segmentos caen en el radio de cualquier fuente de luz.  ¬øNo puedo calcular r√°pidamente un mapa de distancia basado en esto? <br><br>  Entonces decid√≠ hacerlo. <br><br>  Para empezar, simplemente mostr√© en la pantalla las paredes, el "personaje principal" condicional y las fuentes de luz.  Alrededor de las fuentes de luz, un c√≠rculo de pura luz clara cortada en la oscuridad.  Para obtener esto: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/yl/jh/y4/yljhy4kuzvmkdqscqjuzsbqfjms.png"></div>  <sup>( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">demo</a> )</sup> <br><br>  Inmediatamente comenc√© a hacer con el sombreador para no relajarme.  Era necesario pasar a cada fuente de luz sus coordenadas y radio de acci√≥n (m√°s all√° del cual la luz no alcanza), esto se hace simplemente a trav√©s de una matriz uniforme.  Y luego, en el sombreador (que es fragmentario, que se realiza para cada p√≠xel en la pantalla), quedaba por entender si el p√≠xel actual estaba en el c√≠rculo iluminado o no. <br><pre><code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SimpleLightShader</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Phaser</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Filter</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(game) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(game); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> lightsArray = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>(MAX_LIGHTS*<span class="hljs-number"><span class="hljs-number">4</span></span>); lightsArray.fill(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, lightsArray.length); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.uniforms.lightsCount = {<span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'1i'</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>}; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.uniforms.lights = {<span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'4fv'</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: lightsArray}; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fragmentSrc = <span class="hljs-string"><span class="hljs-string">` precision highp float; uniform int lightsCount; uniform vec4 lights[</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${MAX_LIGHTS}</span></span></span><span class="hljs-string">]; void main() { float lightness = 0.; for (int i = 0; i &lt; </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${MAX_LIGHTS}</span></span></span><span class="hljs-string">; i++) { if (i &gt;= lightsCount) break; vec4 light = lights[i]; lightness += step(length(light.xy - gl_FragCoord.xy), light.z); } lightness = clamp(0., 1., lightness); gl_FragColor = mix(vec4(0,0,0,0.5), vec4(0,0,0,0), lightness); } `</span></span>; } updateLights(lightSources) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.uniforms.lightsCount.value = lightSources.length; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> array = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.uniforms.lights.value; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> light <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> lightSources) { array[i++] = light.x; array[i++] = game.world.height - light.y; array[i++] = light.radius; i++; } } }</code> </pre> <br>  Ahora necesitamos comprender para cada fuente de luz qu√© segmentos proyectar√°n una sombra.  M√°s bien, qu√© partes de los segmentos: en la figura a continuaci√≥n no estamos interesados ‚Äã‚Äãen las partes "rojas" del segmento, porque  la luz a√∫n no les llega. <br><br>  <i>Nota: la definici√≥n de intersecci√≥n es un tipo de optimizaci√≥n preliminar.</i>  <i>Es necesario para reducir el tiempo de procesamiento adicional, eliminando grandes piezas de segmentos m√°s all√° del radio de la fuente de luz.</i>  <i>Esto tiene sentido cuando tenemos muchos segmentos cuya longitud es mucho mayor que el radio del "resplandor".</i>  <i>Si este no es el caso, y tenemos muchos segmentos cortos, puede ser correcto no perder el tiempo para determinar la intersecci√≥n y procesar los segmentos completos, porque</i>  <i>Ahorrar tiempo todav√≠a no funciona.</i> <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/cb/93/mb/cb93mbs6zzyyqwvfx633ppxbtzg.png"></div><br>  Para hacer esto, utilic√© la f√≥rmula bien conocida para encontrar la intersecci√≥n de una l√≠nea recta y un c√≠rculo, que todos recuerdan de memoria de un curso escolar de geometr√≠a ... en el mundo imaginario de alguien.  Simplemente no la recordaba, as√≠ que tuve que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">buscarlo</a> en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Google</a> . <br><br>  Codificamos, mira lo que pas√≥. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/_0/up/go/_0upgoezkyggo7sfkntejosckg0.png"></div>  <sup>( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">demo</a> )</sup> <br>  Parece ser la norma.  Ahora sabemos qu√© segmentos pueden proyectar una sombra y pueden realizar rakecast. <br><br>  Aqu√≠ tambi√©n tenemos opciones: <br><br><ol><li>  Simplemente vamos en c√≠rculo en c√≠rculo, lanzamos rayos y buscamos intersecciones.  La distancia a la intersecci√≥n m√°s cercana es el valor que necesitamos. </li><li>  Solo puedes ir a esas esquinas que se dividen en segmentos.  Despu√©s de todo, ya conocemos los puntos, no es dif√≠cil calcular los √°ngulos. </li><li>  Adem√°s, si vamos a lo largo de un segmento, entonces no necesitamos emitir rayos y calcular intersecciones; podemos movernos a lo largo del segmento con el paso deseado.  As√≠ es como funciona: </li></ol><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/9w/db/yp/9wdbyph5wjrn9dolovyhf_5y6-w.png"></div><br>  Aqui <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>A</mi><mi>B</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.507ex" height="2.057ex" viewBox="0 -780.1 1510 885.9" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhhdzL8_PQlGDNf_mCaN5ZaGGHC0Yg#MJMATHI-41" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhhdzL8_PQlGDNf_mCaN5ZaGGHC0Yg#MJMATHI-42" x="750" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>A</mi><mi>B</mi></math></span></span><script type="math/tex" id="MathJax-Element-1"> AB </script>  - segmento (pared), <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-2-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>C</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.766ex" height="2.057ex" viewBox="0 -780.1 760.5 885.9" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhhdzL8_PQlGDNf_mCaN5ZaGGHC0Yg#MJMATHI-43" x="0" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>C</mi></math></span></span><script type="math/tex" id="MathJax-Element-2"> C </script>  Es el centro de la fuente de luz, <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-3-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>C</mi><mi>d</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.982ex" height="2.057ex" viewBox="0 -780.1 1284 885.9" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhhdzL8_PQlGDNf_mCaN5ZaGGHC0Yg#MJMATHI-43" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhhdzL8_PQlGDNf_mCaN5ZaGGHC0Yg#MJMATHI-64" x="760" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>C</mi><mi>d</mi></math></span></span><script type="math/tex" id="MathJax-Element-3"> Cd </script>  - perpendicular al segmento. <br><br>  Dejar <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-4-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>x</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.33ex" height="1.455ex" viewBox="0 -520.7 572.5 626.5" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhhdzL8_PQlGDNf_mCaN5ZaGGHC0Yg#MJMATHI-78" x="0" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>x</mi></math></span></span><script type="math/tex" id="MathJax-Element-4"> x </script>  - el √°ngulo con respecto a lo normal, para lo cual necesita averiguar la distancia desde la fuente hasta el segmento, <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-5-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>X</mi><mn>1</mn></msub></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.979ex" height="2.298ex" viewBox="0 -780.1 1282.4 989.6" role="img" focusable="false" style="vertical-align: -0.487ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhhdzL8_PQlGDNf_mCaN5ZaGGHC0Yg#MJMATHI-58" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhhdzL8_PQlGDNf_mCaN5ZaGGHC0Yg#MJMAIN-31" x="1171" y="-213"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>X</mi><mn>1</mn></msub></math></span></span><script type="math/tex" id="MathJax-Element-5"> X_1 </script>  - punto en el segmento <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-6-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>A</mi><mi>B</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.507ex" height="2.057ex" viewBox="0 -780.1 1510 885.9" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhhdzL8_PQlGDNf_mCaN5ZaGGHC0Yg#MJMATHI-41" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhhdzL8_PQlGDNf_mCaN5ZaGGHC0Yg#MJMATHI-42" x="750" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>A</mi><mi>B</mi></math></span></span><script type="math/tex" id="MathJax-Element-6"> AB </script>  donde cae el rayo.  Tri√°ngulo <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-7-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>C</mi><mi>D</mi><msub><mi>X</mi><mn>1</mn></msub></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.669ex" height="2.298ex" viewBox="0 -780.1 2871.4 989.6" role="img" focusable="false" style="vertical-align: -0.487ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhhdzL8_PQlGDNf_mCaN5ZaGGHC0Yg#MJMATHI-43" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhhdzL8_PQlGDNf_mCaN5ZaGGHC0Yg#MJMATHI-44" x="760" y="0"></use><g transform="translate(1589,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhhdzL8_PQlGDNf_mCaN5ZaGGHC0Yg#MJMATHI-58" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhhdzL8_PQlGDNf_mCaN5ZaGGHC0Yg#MJMAIN-31" x="1171" y="-213"></use></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>C</mi><mi>D</mi><msub><mi>X</mi><mn>1</mn></msub></math></span></span><script type="math/tex" id="MathJax-Element-7"> CDX_1 </script>  - rectangular <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-8-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>C</mi><mi>d</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.982ex" height="2.057ex" viewBox="0 -780.1 1284 885.9" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhhdzL8_PQlGDNf_mCaN5ZaGGHC0Yg#MJMATHI-43" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhhdzL8_PQlGDNf_mCaN5ZaGGHC0Yg#MJMATHI-64" x="760" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>C</mi><mi>d</mi></math></span></span><script type="math/tex" id="MathJax-Element-8"> Cd </script>  - una pierna, y su longitud es conocida y constante para este segmento, <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-9-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>C</mi><msub><mi>X</mi><mn>1</mn></msub></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.745ex" height="2.298ex" viewBox="0 -780.1 2042.9 989.6" role="img" focusable="false" style="vertical-align: -0.487ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhhdzL8_PQlGDNf_mCaN5ZaGGHC0Yg#MJMATHI-43" x="0" y="0"></use><g transform="translate(760,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhhdzL8_PQlGDNf_mCaN5ZaGGHC0Yg#MJMATHI-58" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhhdzL8_PQlGDNf_mCaN5ZaGGHC0Yg#MJMAIN-31" x="1171" y="-213"></use></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>C</mi><msub><mi>X</mi><mn>1</mn></msub></math></span></span><script type="math/tex" id="MathJax-Element-9"> CX_1 </script>  - longitud deseada. <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-10-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>C</mi><msub><mi>X</mi><mn>1</mn></msub><mo>=</mo><mtext>&amp;#xA0;</mtext><mi>f</mi><mi>r</mi><mi>a</mi><mi>c</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>C</mi><mi>D</mi></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>c</mi><mi>o</mi><mi>s</mi><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo></mrow></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="23.042ex" height="2.66ex" viewBox="0 -832 9921 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhhdzL8_PQlGDNf_mCaN5ZaGGHC0Yg#MJMATHI-43" x="0" y="0"></use><g transform="translate(760,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhhdzL8_PQlGDNf_mCaN5ZaGGHC0Yg#MJMATHI-58" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhhdzL8_PQlGDNf_mCaN5ZaGGHC0Yg#MJMAIN-31" x="1171" y="-213"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhhdzL8_PQlGDNf_mCaN5ZaGGHC0Yg#MJMAIN-3D" x="2320" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhhdzL8_PQlGDNf_mCaN5ZaGGHC0Yg#MJMATHI-66" x="3626" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhhdzL8_PQlGDNf_mCaN5ZaGGHC0Yg#MJMATHI-72" x="4177" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhhdzL8_PQlGDNf_mCaN5ZaGGHC0Yg#MJMATHI-61" x="4628" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhhdzL8_PQlGDNf_mCaN5ZaGGHC0Yg#MJMATHI-63" x="5158" y="0"></use><g transform="translate(5591,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhhdzL8_PQlGDNf_mCaN5ZaGGHC0Yg#MJMATHI-43" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhhdzL8_PQlGDNf_mCaN5ZaGGHC0Yg#MJMATHI-44" x="760" y="0"></use></g><g transform="translate(7180,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhhdzL8_PQlGDNf_mCaN5ZaGGHC0Yg#MJMATHI-63" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhhdzL8_PQlGDNf_mCaN5ZaGGHC0Yg#MJMATHI-6F" x="433" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhhdzL8_PQlGDNf_mCaN5ZaGGHC0Yg#MJMATHI-73" x="919" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhhdzL8_PQlGDNf_mCaN5ZaGGHC0Yg#MJMAIN-28" x="1388" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhhdzL8_PQlGDNf_mCaN5ZaGGHC0Yg#MJMATHI-78" x="1778" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhhdzL8_PQlGDNf_mCaN5ZaGGHC0Yg#MJMAIN-29" x="2350" y="0"></use></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>C</mi><msub><mi>X</mi><mn>1</mn></msub><mo>=</mo><mtext>&nbsp;</mtext><mi>f</mi><mi>r</mi><mi>a</mi><mi>c</mi><mrow class="MJX-TeXAtom-ORD"><mi>C</mi><mi>D</mi></mrow><mrow class="MJX-TeXAtom-ORD"><mi>c</mi><mi>o</mi><mi>s</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow></math></span></span><script type="math/tex" id="MathJax-Element-10"> CX_1 = \ frac {CD} {cos (x)} </script>  .  Si conoce el paso de antemano (y nosotros lo sabemos), puede calcular previamente la tabla de cosenos inversos y buscar distancias muy r√°pidamente. <br><br>  Dar√© un ejemplo de c√≥digo para dicha tabla.  Casi todo el trabajo con esquinas se reemplaza por trabajo con √≠ndices, es decir  enteros de 0 a N, donde N = el n√∫mero de pasos en el c√≠rculo (es decir, √°ngulo de paso = <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-11-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mtext>&amp;#xA0;</mtext><mi>f</mi><mi>r</mi><mi>a</mi><mi>c</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>2</mn><mtext>&amp;#xA0;</mtext><mi>p</mi><mi>i</mi></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>N</mi></mrow></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="10.923ex" height="2.419ex" viewBox="0 -780.1 4703 1041.5" role="img" focusable="false" style="vertical-align: -0.607ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhhdzL8_PQlGDNf_mCaN5ZaGGHC0Yg#MJMATHI-66" x="250" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhhdzL8_PQlGDNf_mCaN5ZaGGHC0Yg#MJMATHI-72" x="800" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhhdzL8_PQlGDNf_mCaN5ZaGGHC0Yg#MJMATHI-61" x="1252" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhhdzL8_PQlGDNf_mCaN5ZaGGHC0Yg#MJMATHI-63" x="1781" y="0"></use><g transform="translate(2215,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhhdzL8_PQlGDNf_mCaN5ZaGGHC0Yg#MJMAIN-32" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhhdzL8_PQlGDNf_mCaN5ZaGGHC0Yg#MJMATHI-70" x="750" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhhdzL8_PQlGDNf_mCaN5ZaGGHC0Yg#MJMATHI-69" x="1254" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhhdzL8_PQlGDNf_mCaN5ZaGGHC0Yg#MJMATHI-4E" x="3814" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mtext>&nbsp;</mtext><mi>f</mi><mi>r</mi><mi>a</mi><mi>c</mi><mrow class="MJX-TeXAtom-ORD"><mn>2</mn><mtext>&nbsp;</mtext><mi>p</mi><mi>i</mi></mrow><mrow class="MJX-TeXAtom-ORD"><mi>N</mi></mrow></math></span></span><script type="math/tex" id="MathJax-Element-11"> \ frac {2 \ pi} {N} </script>  ) <br><br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HypTable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(steps = 512, stepAngle = 2*Math.PI/steps) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.perAngleStep = [<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; steps/<span class="hljs-number"><span class="hljs-number">4</span></span>; i++) { <span class="hljs-comment"><span class="hljs-comment">//   pi/2 let ang = i*stepAngle; this.perAngleStep[i] = 1/Math.cos(ang); } this.stepAngle = stepAngle; } /** * @param distancesMap -  ,    * @param angle1 -           * @param angle2 -           * @param normalFromLight - ,      */ fillDistancesForArc(distancesMap, angle1, angle2, normalFromLight) { const D = Math.hypot(normalFromLight.x, normalFromLight.y); const normalAngle = Phaser.Math.normalizeAngle(Math.atan2(normalFromLight.y, normalFromLight.x)); const normalAngleIndex = (normalAngle / this.stepAngle)|0; const index1 = (angle1 / this.stepAngle)|0; const index2 = (angle2 / this.stepAngle)|0; for (let angleIndex = index1; angleIndex &lt;= index2; angleIndex++) { let distanceForAngle = D * this.perAngleStep[normalize(angleIndex - normalAngleIndex)]; distancesMap.set(angleIndex, distanceForAngle); } } }</span></span></code> </pre><br>  Por supuesto, este m√©todo introduce un error para los casos en que el √°ngulo ACD inicial no es un m√∫ltiplo de un paso.  Pero para 512 pasos, visualmente no veo diferencia. <br><br>  Entonces, lo que ya sabemos hacer: <br><ol><li>  Encuentra segmentos dentro del rango de la fuente de luz que pueden proyectar una sombra <br></li><li>  Para el paso t, cree una tabla dist (√°ngulo), pasando por cada segmento y calculando las distancias. </li></ol><br><br>  As√≠ es como se ve esta tabla si la dibuja en rayos. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/kh/5m/17/kh5m17zbgdyq22dfeoys5borlbe.png"></div>  <sup>( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">demo</a> )</sup> <br><br>  Y as√≠ es como se ven las 10 fuentes de luz, si est√°n escritas en una textura. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/bg/ex/3-/bgex3-jcfuohb9_egfv_4ul-x2e.png"></div><br>  Aqu√≠, cada p√≠xel horizontal corresponde a un √°ngulo, y el color a la distancia en p√≠xeles. <br>  Est√° escrito en js como este usando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">imageData</a> <br><pre> <code class="javascript hljs"> fillBitmap(data, index) { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> total = index + <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.steps*<span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> d1, d2; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">//data[index] = Red //data[index+1] = Green //data[index+2] = Blue //data[index+3] = Alpha for (; index &lt; total; index+=4, i++) { //  512,    R     2. d1 = (this.distances[i]/2)|0; data[index] = d1; d1 = this.distances[i] - d1*2; d2 = (d1*128)|0; //   G -     2. data[index+1] = d2; //  B  A  255,     . data[index+2] = 255; data[index+3] = 255; } }</span></span></code> </pre><br><br>  Ahora pasamos la textura a nuestro sombreador, que ya tiene las coordenadas y los radios de las fuentes de luz.  Y procesarlo as√≠: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//      uniform sampler2D iChannel0; #define STRENGTH 0.3 #define MAX_DARK 0.7 #define M_PI 3.141592653589793 #define M_PI2 6.283185307179586 //       float decodeDist(vec4 color) { return color.r*255.*2. + color.g*2.; } float getShadow(int i, float angle, float distance) { //   x   ==  float u = angle/M_PI2; //   y   ==     float v = float(i)/${MAX_LIGHTS}.; float shadowAfterDistance = decodeDist(texture2D(iChannel0, vec2(u, v))); //  1   ,  0  . return step(shadowAfterDistance, distance); } void main() { float lightness = 0.; for (int i = 0; i &lt; ${MAX_LIGHTS}; i++) { if (i &gt;= lightsCount) break; vec4 light = lights[i]; //       vec2 light2point = gl_FragCoord.xy - light.xy; float radius = light.z; float distance = length(light2point); float inLight = step(distance, radius); //      ,       //  . //      , //    ,          //           //     ,    if (inLight == 0.) continue; float angle = mod(-atan(light2point.y, light2point.x), M_PI2); // 1     0   float thisLightness = (1. - getShadow(i, angle, distance)); //,   ‚Äú‚Äù  ,   ,  //    lightness += thisLightness*STRENGTH; } lightness = clamp(0., 1., lightness); gl_FragColor = mix(vec4(0,0,0,MAX_DARK), vec4(0,0,0,0), lightness); }</span></span></code> </pre> <br><br>  Resultado: <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/f9/0l/hj/f90lhj2yepescdli2qndmyx-xkq.png"></div>  <sup>( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">demo</a> )</sup> <br>  Ahora puedes traer un poco de belleza.  Deje que la luz se desvanezca con la distancia, y las sombras ser√°n borrosas. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/1s/op/sg/1sopsggdgrpurmn0qsui8rcfhne.png"></div><br>  Para desenfoque, miro las esquinas adyacentes, + - paso, as√≠: <br><br><pre> <code class="cpp hljs">thisLightness = (<span class="hljs-number"><span class="hljs-number">1.</span></span> - getShadow(i, angle, distance)) * <span class="hljs-number"><span class="hljs-number">0.4</span></span> + (<span class="hljs-number"><span class="hljs-number">1.</span></span> - getShadow(i, angle-SMOOTH_STEP, distance)) * <span class="hljs-number"><span class="hljs-number">0.2</span></span> + (<span class="hljs-number"><span class="hljs-number">1.</span></span> - getShadow(i, angle+SMOOTH_STEP, distance)) * <span class="hljs-number"><span class="hljs-number">0.2</span></span> + (<span class="hljs-number"><span class="hljs-number">1.</span></span> - getShadow(i, angle-SMOOTH_STEP*<span class="hljs-number"><span class="hljs-number">2.</span></span>, distance)) * <span class="hljs-number"><span class="hljs-number">0.1</span></span> + (<span class="hljs-number"><span class="hljs-number">1.</span></span> - getShadow(i, angle+SMOOTH_STEP*<span class="hljs-number"><span class="hljs-number">2.</span></span>, distance)) * <span class="hljs-number"><span class="hljs-number">0.1</span></span>;</code> </pre><br><br>  Si pones todo junto y mides el FPS, resulta as√≠: <br><br><ul><li>  En tarjetas de video integradas: todo est√° mal (&lt;30-40), incluso para ejemplos simples <br></li><li>  Todo lo dem√°s est√° bien, siempre que las fuentes de luz no sean muy fuertes.  Es decir, el n√∫mero de fuentes de luz por p√≠xel es importante, no el n√∫mero total. <br></li></ul><br><br>  Este resultado me convino bastante.  Todav√≠a pod√≠as jugar con el color de la iluminaci√≥n, pero yo no.  Despu√©s de girar un poco y agregar algunos mapas normales, cargu√© una versi√≥n actualizada de NOPE.  Ella se ve√≠a as√≠ ahora: <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/cq/nw/4o/cqnw4opdblgnm6ebys-lgbtvnt4.gif"></div><br><br>  Luego comenz√≥ a preparar un art√≠culo.  Mir√© ese gif y pens√©. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ct/de/zr/ctdezrcsaztxtgxx9jyioatirds.gif"></div><br>  "As√≠ que es casi un aspecto pseudo-3D, como en Wolfenstein", exclam√© (s√≠, tengo buena imaginaci√≥n).  Y, de hecho, si suponemos que todas las paredes tienen la misma altura, los mapas de distancia ser√°n suficientes para que podamos construir la escena.  ¬øPor qu√© no probarlo? <br><br>  La escena deber√≠a verse as√≠. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/lg/5v/-s/lg5v-sk8cmojfurrj_pnrg3xw0k.png"></div><br><br>  Entonces nuestra tarea: <br><br><ol><li>  En un punto de la pantalla, obtenga coordenadas mundiales para el caso cuando no haya paredes. <br><br>  Consideraremos esto: <br><ul><li>  Primero, normalizamos las coordenadas de un punto en la pantalla para que haya un punto (0,0) en el centro de la pantalla y en las esquinas (-1, -1) y (1,1), respectivamente <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/l9/ki/fu/l9kifubvfwn50ust9lhtsik2f_k.png"></div></li><li>  La coordenada x se convierte en el √°ngulo desde la direcci√≥n de visi√≥n, solo necesita multiplicarla por A / 2, donde A es el √°ngulo de visi√≥n <br></li><li>  La coordenada y determina la distancia desde el observador hasta el punto, en el caso general d ~ 1 / y.  Para un punto en el borde inferior de la pantalla, distancia = 1, para un punto en el centro de la pantalla, distancia = infinito. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/8e/ua/4b/8eua4bycfatkegaiwbyu_eohxky.png"></div></li><li>  Por lo tanto, si no tiene en cuenta las paredes, entonces para cada punto visible en el mundo habr√° 2 puntos en la pantalla, uno arriba del medio (en el "techo") y el otro debajo (en el "piso") <br></li></ul></li><li>  Ahora podemos mirar la tabla de distancias.  Si hay un muro m√°s cerca que nuestro punto, entonces debes dibujar un muro.  Si no, significa piso o techo <br></li></ol><br>  Obtenemos lo ordenado: <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/qp/gj/lu/qpgjluavcmsuba51v0iovqdccc0.png"></div>  <sup>( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">demo</a> )</sup> <br>  Agregue iluminaci√≥n: de la misma manera, repita las fuentes de luz y verifique las coordenadas mundiales.  Y, el toque final, agrega texturas.  Para hacer esto, en una textura con distancias, tambi√©n necesita escribir el desplazamiento u para la textura de la pared en este punto.  Aqu√≠ es donde el canal b fue √∫til. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/kn/ai/ay/knaiayi9epavp3cr8u6wcd4x2ss.png"></div>  <sup>( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">demo</a> )</sup> <br>  Perfecto <br><br>  Es broma. <br><br>  Imperfecto, por supuesto.  Pero, demonios, todav√≠a leo sobre c√≥mo hacer que mi Wolfenstein se transmita por rake hace unos 15 a√±os, y quer√≠a hacerlo todo, ¬°y esta es una gran oportunidad! <br><br><h4>  En lugar de una conclusi√≥n </h4><br>  Al comienzo del art√≠culo, mencion√© otro m√©todo secreto.  Aqu√≠ esta: <br><br><blockquote>  <b>Simplemente tome el motor que ya sabe c√≥mo.</b> </blockquote><br>  De hecho, si necesitas hacer un juego, esta ser√° la forma m√°s correcta y r√°pida.  ¬øPor qu√© necesitas cercar tus bicicletas y resolver problemas de larga data? <br><br>  Pero por qu√©. <br><br>  En el grado 10, me mud√© a otra escuela y tuve problemas en matem√°ticas.  No recuerdo el ejemplo exacto, pero era una ecuaci√≥n con grados, que en todos los aspectos necesitaba ser simplificada, pero simplemente no tuvo √©xito.  Desesperada, consult√© con mi hermana, y ella dijo: "as√≠ que agregue x <sup>2</sup> en ambos lados, y todo se descompondr√°".  Y esa fue la soluci√≥n: agregar lo que no estaba all√≠. <br><br>  Cuando, mucho m√°s tarde, ayud√© a mi amigo a construir mi casa, tuve que poner un bloque en el umbral, para llenar un nicho.  Y aqu√≠ estoy, clasificando el borde de las barras.  Uno parece encajar, pero no del todo.  Otros son mucho m√°s peque√±os.  Estoy pensando en c√≥mo recopilar la palabra felicidad aqu√≠, y un amigo dice: "as√≠ que bebieron los surcos en un lugar circular donde interfiere".  Y ahora el gran bar ya est√° parado. <br><br>  Estas historias est√°n unidas por tal efecto, que llamar√© el "efecto de inventario".  Cuando intenta tomar una decisi√≥n a partir de piezas existentes, sin ver material que se pueda procesar y refinar en estas partes.  Los n√∫meros son madera, dinero o c√≥digo. <br><br>  Muchas veces he observado el mismo efecto con colegas en la programaci√≥n.  Al no sentirse seguros del material, a veces ceden cuando es necesario hacer, por ejemplo, controles no est√°ndar.  O agregue pruebas unitarias a donde no estaban.  O intentan proporcionar todo, todo al dise√±ar una clase, y luego obtenemos un di√°logo como: <br>  - Esto no es necesario ahora <br>  - ¬øQu√© pasa si se hace necesario? <br>  - Entonces lo agregaremos.  Deje los puntos de expansi√≥n, eso es todo.  El c√≥digo no es granito, es plastilina. <br><br>  Y para aprender a ver y sentir el material con el que trabajamos, tambi√©n necesitamos bicicletas. <br><br>  Esto no es solo un entrenamiento para la mente o el entrenamiento.  Esta es una forma de alcanzar un nivel de trabajo cualitativamente diferente con el c√≥digo. <br><br>  Gracias a todos por leer. <br><br>  Enlaces, en caso de que haya olvidado hacer clic en alguna parte: <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Todas las demos juntas</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">C√≥digo de demostraci√≥n</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Realmente juego LD con sombras</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es434370/">https://habr.com/ru/post/es434370/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es434358/index.html">Sustituci√≥n de importaciones de sistemas operativos. ¬øC√≥mo veo el sistema operativo dom√©stico?</a></li>
<li><a href="../es434360/index.html">Charla explicada sobre programaci√≥n asincr√≥nica en Javascript</a></li>
<li><a href="../es434362/index.html">NO pronosticado para 2019</a></li>
<li><a href="../es434364/index.html">Hangfire Queue Support</a></li>
<li><a href="../es434368/index.html">Aprendizaje autom√°tico para encontrar errores en el c√≥digo: c√≥mo hice pr√°cticas en JetBrains Research</a></li>
<li><a href="../es434374/index.html">Comprobaci√≥n de RBAC en Kubernetes</a></li>
<li><a href="../es434380/index.html">Conceptos b√°sicos de inyecci√≥n de dependencia</a></li>
<li><a href="../es434382/index.html">Portar Alpine Linux a RISC-V</a></li>
<li><a href="../es434384/index.html">Sobre la responsabilidad de los artistas int√©rpretes o ejecutantes.</a></li>
<li><a href="../es434386/index.html">Douglas Engelbart: "Aumento del intelecto humano: un marco conceptual"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>