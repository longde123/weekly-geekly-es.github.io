<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🙏🏿 🥣 🤶🏿 ToFoIn v 1. Reservasi gateway dan beralih di antara saluran eksternal di FreeBSD 👨🏽‍🎨 🥂 🧓🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Anotasi 
 Dalam artikel sebelumnya, organisasi redundansi untuk gateway LAN dipertimbangkan. Sebagai solusi, sebuah skrip diusulkan agar pada saat itu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ToFoIn v 1. Reservasi gateway dan beralih di antara saluran eksternal di FreeBSD</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/421857/"><h3>  Anotasi </h3><br>  Dalam artikel sebelumnya, organisasi redundansi untuk gateway LAN dipertimbangkan.  Sebagai solusi, sebuah skrip diusulkan agar pada saat itu menyelesaikan masalah, tetapi memiliki sejumlah kelemahan.  Setelah beberapa waktu, ternyata menghilangkan kekurangan ini, sebagian menulis ulang kode dan mendapatkan sesuatu yang dapat diterima di output.  Sekarang kita dapat mengatakan bahwa skrip sudah cukup diuji untuk disebut stabil.  Untuk menyederhanakan pemahaman seluruh sistem, poin utama untuk menyiapkan layanan sekunder (dalam hal topik artikel) akan diduplikasi sebagian di bawah.  Alasannya sederhana - selama waktu ini aturan ipfw juga dikerjakan ulang, dns pergi untuk tinggal di AD pada Samba4 dengan bind-frontend dan catatan yang diperbarui dengan aman dari isc-dhcpd menggunakan kerberos, serta server dns sekunder seperti bind di gateway, mengkonfigurasi CARP ... Secara umum, ini menjadi jauh lebih menarik, tetapi lebih banyak tentang apa dan bagaimana kerjanya di bawah.  Segala sesuatu yang dapat diberikan dengan referensi ke sumbernya akan dirancang sedemikian rupa agar tidak menghasilkan esensi.  Apa yang diambil dari tempat lain, tetapi yang tidak lagi tersedia, akan diberikan di sini dengan komentar yang relevan. <br><a name="habracut"></a><br><h3>  Pendahuluan </h3><br>  Jadi, ada dua cara untuk meningkatkan kekebalan kebisingan dari saluran komunikasi dengan dunia luar di pihak konsumen: cadangan gateway dan reservasi titik koneksi.  Dengan kata lain, dalam kasus pertama, gateway kedua diatur, yang akan diaktifkan jika yang pertama gagal, dalam kasus kedua, saluran Internet cadangan akan diatur jika ada masalah dengan yang utama, dan semakin jauh mereka menyeberang, semakin baik, jelas.  Jika <abbr title="Protokol redundansi alamat umum">CARP</abbr> menyelesaikan tugas pertama untuk FreeBSD, maka yang kedua, setelah mengatur saluran eksternal kedua, dapat, sekali lagi, diselesaikan dengan beberapa cara.  Minimal, Anda dapat mengatur penyeimbangan lalu lintas atau beralih antar saluran.  Karena perbedaan besar dalam bandwidth saluran eksternal, opsi pertama tidak <abbr title="Toogle Failover dari Internet">cocok untuk</abbr> saya, jadi penyebab utama publikasi ini ditulis: <abbr title="Toogle Failover dari Internet">ToFoIn</abbr> - satu set skrip bash yang ditujukan untuk menyelesaikan masalah diagnostik dan beralih ke saluran eksternal yang berfungsi.  Setelah penyempurnaan, ini dapat diterapkan ke gateway dan m saluran.  Situasinya lemah, di mana n dan m lebih dari 2, tetapi skrip di bawah ini harus bekerja hingga nilai n dan m yang besar, karena  Logikanya, batasnya tidak ditentukan.  Secara umum, saya menduga bahwa menggunakan skrip ini dimungkinkan untuk menyelesaikan berbagai tugas yang cukup luas, tergantung pada status koneksi, terbatas, mungkin, hanya dengan imajinasi. <br><br><img src="https://habrastorage.org/webt/2e/yw/s8/2eyws8o9hbu3cxfpo0yja6dm_ea.png" width="500" align="left"><br>  Kira-kira topologi jaringan seperti itu mengasumsikan dalam bentuk paling sederhana penggunaan seperangkat skrip ToFoIn.  Tentu saja, skrip harus bekerja dalam kasus router tunggal, tetapi dalam kasus ini, Anda harus mengubah modul Daemon untuk menghapus ketergantungan dari urutan tindakan pada kondisi CARP, yang hanya akan absen dalam sistem.  Pemesanan lebih lanjut dari ini dan node lain hanya tergantung pada tingkat pentingnya layanan yang sesuai. <br><br><h3>  Tujuan dan sasaran </h3><br>  Tujuan proyek, seperti sebelumnya, adalah untuk membuat paket perangkat lunak universal dan mudah diskalakan yang berfokus pada pengidentifikasian masalah dalam koneksi eksternal dan internal dan secara otomatis beralih ke koneksi yang bisa diterapkan.  Secara umum, logikanya adalah sebagai berikut: <br><br><ul><li>  Ada "router" dengan masing-masing saluran eksternal.  Selain itu, semua n "router" berada dalam hirarki yang ketat dan terhubung satu sama lain menggunakan CARP pada semua antarmuka yang diperlukan. </li><li>  Agen bekerja secara independen pada setiap mesin, yang tugasnya didasarkan pada status CARP saat ini dari mesinnya: <br><ul><li>  Jika cadangan - mendeteksi dan mengkonfigurasi mesin pada router yang saat ini adalah master; </li><li>  Jika master - periksa status koneksi pada saat ini dan, jika perlu, beralih di antara saluran eksternal. </li></ul></li></ul><br><h3>  Solusi </h3><br>  Jaringan internal memiliki CARP, yang menyediakan gateway cadangan dan memungkinkan Anda untuk tidak mengubah pengaturan perangkat jaringan lain di jaringan internal saat berpindah saluran. <br><br>  Dhcpd beroperasi dalam mode primer - sekunder dan, secara umum, tidak masalah apa peran lain yang dimainkan mesin - koneksi antara dhcpd terjadi pada jaringan internal, yang selalu dilihat oleh router. <br><br>  Bind master dihapus dalam AD, yang disembunyikan di jaringan lokal, sementara server bind sekunder bekerja pada router gateway dengan pijakan yang sama. <br><br>  Aturan ipfw berbeda tergantung pada saluran mana yang dianggap sebagai saluran utama pada saat tertentu dan di-restart oleh modul Daemon ketika mengubah peran. <br><br>  Akhirnya tentang skrip itu sendiri.  Sekarang file-file tersebut berada di direktori yang sesuai, berfungsi dari penggunanya dan memiliki skrip awal di rc.d.  Tugas yang membutuhkan akses root diselesaikan oleh sudo.  Ada skrip instalasi yang memperhitungkan kemungkinan kehadiran versi yang diinstal, serta file pengaturan yang cukup rinci.  Modul-modulnya sama dengan perubahan kecil, beberapa hampir tidak berubah dalam fungsionalitas: <br><br>  <b>Daemon</b> - seperti namanya - adalah proses utama yang menjalankan tes dan beralih modul pada timer, dan juga memonitor CARP. <br>  <b>Penguji</b> - masih menguji komunikasi eksternal menggunakan perintah ping.  (jika sedang berjalan, mesin akan menganggap CARP dalam status Master) <br>  <b>Hakim</b> - berdasarkan pada hasil pengujian, menentukan saluran eksternal mana yang berfungsi dan apakah switching diperlukan, melakukan switching (jika sedang berjalan, mesin akan mempertimbangkan CARP dalam status Master). <br>  <b>Scout</b> adalah modul baru.  Itu dimulai ketika CARP dalam kondisi Backup.  Hal ini diperlukan untuk menentukan router yang tersisa saat ini yang utama. <br>  <b>Logger</b> - bertanggung jawab atas pencatatan peristiwa.  Hal ini diperlukan agar informasi tentang acara tidak digandakan dan majalah lebih mudah dibaca. <br>  <b>Watchdog</b> - berjalan sesuai jadwal dari crontab.  Ini menentukan "membeku" semua modul dan (bila memungkinkan) mencoba untuk memecahkan masalah yang muncul.  Yaitu  kuku semua orang, cukup cantumkan. <br><br>  Selain skrip itu sendiri, ada baiknya mempertimbangkan beberapa file yang lebih penting: <br><br>  <b>Tofoin.conf</b> - file pengaturan tunggal. <br>  <b>Tofoin.log</b> - file log peristiwa tunggal. <br>  <b>Result_</b> &lt;nomor saluran internal&gt; adalah file yang berfungsi, hasil pengujian ditambahkan di sini, dibuat di / tmp di sebelah .pid dan file yang berfungsi lainnya. <br><br>  Saya dengan senang hati dapat menjawab pertanyaan tentang pengoperasian modul, menjelaskan solusi dalam komentar. <br><br><h3>  Bagian teknis </h3><br><h4>  Peralatan </h4><br>  Dibandingkan dengan waktu sebelumnya, gateway pindah ke P4, menerima RAM 1536 Mb dan tiga HDD 40 Gb (mirror + spare).  Kartu jaringan masih PCI, PSU normal, secara alami di hadapan UPS. <br>  Peningkatan kapasitas dikaitkan dengan besi yang dikeluarkan dan pembaruan yang terlalu membosankan dari sumbernya, tetapi sebagian besar yang pertama.  OS FreeBSD 11.1, FS zfs. <br><br><h4>  Pengaturan Komponen Sistem </h4><br><div class="spoiler">  <b class="spoiler_title">Lebih detail</b> <div class="spoiler_text">  Kernel dikompilasi dengan parameter tambahan seperti itu (sesuatu juga dapat diatur dalam loader, tetapi lebih baik seperti ini): <br><br><pre><code class="bash hljs">options IPFIREWALL <span class="hljs-comment"><span class="hljs-comment"># ipfw firewall options IPFIREWALL_VERBOSE options IPFIREWALL_VERBOSE_LIMIT=50 options IPFIREWALL_NAT options LIBALIAS options DUMMYNET options HZ=1000 options ROUTETABLES=4 options KSTACK_PAGES=4 options KVA_PAGES=512 device carp</span></span></code> </pre> <br>  Pengaturan / boot / load.conf: <br><pre> <code class="bash hljs">geom_mirror_load=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> zfs_load=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> kern.geom.label.gptid.enable=<span class="hljs-string"><span class="hljs-string">"0"</span></span> vm.kmem_size=<span class="hljs-string"><span class="hljs-string">"1024M"</span></span> vm.kmem_size_max=<span class="hljs-string"><span class="hljs-string">"1024M"</span></span> vfs.zfs.arc_max=<span class="hljs-string"><span class="hljs-string">"512M"</span></span> vfs.zfs.vdev.cache.size=<span class="hljs-string"><span class="hljs-string">"30M"</span></span> vfs.zfs.prefetch_disable=1 kern.vty=vt</code> </pre> <br>  Pengaturan /etc/rc.conf pada mesin pertama (konfigurasi CARP menjadi perhatian utama): <br><pre> <code class="bash hljs">ifconfig_eth0=<span class="hljs-string"><span class="hljs-string">"up"</span></span> vlans_eth0=<span class="hljs-string"><span class="hljs-string">"vlan111 vlan222"</span></span> create_args_vlan111=<span class="hljs-string"><span class="hljs-string">"vlan 111"</span></span> create_args_vlan222=<span class="hljs-string"><span class="hljs-string">"vlan 222"</span></span> ifconfig_eth1=<span class="hljs-string"><span class="hljs-string">"up"</span></span> vlans_eth1=<span class="hljs-string"><span class="hljs-string">"vlan333 vlan444 vlan555"</span></span> create_args_vlan333=<span class="hljs-string"><span class="hljs-string">"vlan 333"</span></span> create_args_vlan444=<span class="hljs-string"><span class="hljs-string">"vlan 444"</span></span> create_args_vlan555=<span class="hljs-string"><span class="hljs-string">"vlan 555"</span></span> ifconfig_eth2=<span class="hljs-string"><span class="hljs-string">"up"</span></span> vlans_eth2=<span class="hljs-string"><span class="hljs-string">"vlan666 vlan777 vlan888"</span></span> create_args_vlan666=<span class="hljs-string"><span class="hljs-string">"vlan 666"</span></span> create_args_vlan777=<span class="hljs-string"><span class="hljs-string">"vlan 777"</span></span> create_args_vlan888=<span class="hljs-string"><span class="hljs-string">"vlan 888"</span></span> ifconfig_vlan666=<span class="hljs-string"><span class="hljs-string">"inet 192.168.0.1/24"</span></span> ifconfig_vlan666_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 100 pass MyPassword alias 192.168.0.5/32"</span></span> ifconfig_vlan777=<span class="hljs-string"><span class="hljs-string">"inet 192.168.1.1/24"</span></span> ifconfig_vlan777_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 100 pass MyPassword alias 192.168.1.5/32"</span></span> ifconfig_vlan888=<span class="hljs-string"><span class="hljs-string">"inet 192.168.2.1/24"</span></span> ifconfig_vlan888_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 100 pass MyPassword alias 192.168.2.5/32"</span></span> ifconfig_vlan111=<span class="hljs-string"><span class="hljs-string">"inet 192.168.3.1/30"</span></span> ifconfig_vlan111_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 100 pass MyPassword alias 1.1.1.2/24"</span></span> ifconfig_vlan222=<span class="hljs-string"><span class="hljs-string">"inet 192.168.4.1/30"</span></span> ifconfig_vlan333=<span class="hljs-string"><span class="hljs-string">"inet 192.168.5.1/30"</span></span> ifconfig_vlan333_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 100 pass MyPassword alias 2.2.2.2/30"</span></span> ifconfig_vlan444=<span class="hljs-string"><span class="hljs-string">"inet 192.168.6.1/30"</span></span> ifconfig_vlan444_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 100 pass MyPassword alias 3.3.3.2/30"</span></span> ifconfig_vlan555=<span class="hljs-string"><span class="hljs-string">"inet 192.168.7.1/30"</span></span> defaultrouter=<span class="hljs-string"><span class="hljs-string">"1.1.1.1"</span></span> setfib1_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> setfib1_defaultrouter=<span class="hljs-string"><span class="hljs-string">"3.3.3.1"</span></span> setfib2_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> setfib2_defaultrouter=<span class="hljs-string"><span class="hljs-string">"2.2.2.1"</span></span> zfs_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> named_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> dhcpd_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> firewall_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> firewall_logging=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> firewall_script=<span class="hljs-string"><span class="hljs-string">"/etc/firewall.sh"</span></span> gateway_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> tofoin_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span></code> </pre> <br>  <i>Legenda:</i> <i><br></i>  <i>eth0, eth1, eth2 - adapter fisik</i> <i><br></i>  <i>vlan666, vlan777, vlan888 - adapter LAN virtual,</i> <i><br></i>  <i>vlan222 dan vlan555 - adapter untuk komunikasi yang berlebihan antara kartu jaringan eksternal (mereka mungkin tidak lagi diperlukan, mereka secara aktif digunakan sebelumnya)</i> <i><br></i>  <i>vlan111 - saluran eksternal utama</i> <i><br></i>  <i>vlan444 - cadangan saluran eksternal</i> <i><br></i>  <i>vlan333 - teleponi</i> <br>  Pengaturan /etc/rc.conf pada mesin kedua (konfigurasi CARP menjadi perhatian utama, beberapa baris duplikat dihapus): <br><pre> <code class="bash hljs">ifconfig_vlan666=<span class="hljs-string"><span class="hljs-string">"inet 192.168.0.2/24"</span></span> ifconfig_vlan666_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 0 pass MyPassword alias 192.168.0.5/32"</span></span> ifconfig_vlan777=<span class="hljs-string"><span class="hljs-string">"inet 192.168.1.2/24"</span></span> ifconfig_vlan777_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 0 pass MyPassword alias 192.168.1.5/32"</span></span> ifconfig_vlan888=<span class="hljs-string"><span class="hljs-string">"inet 192.168.2.2/24"</span></span> ifconfig_vlan888_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 0 pass MyPassword alias 192.168.2.5/32"</span></span> ifconfig_vlan111=<span class="hljs-string"><span class="hljs-string">"inet 192.168.3.2/30"</span></span> ifconfig_vlan111_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 0 pass MyPassword alias 1.1.1.2/24"</span></span> ifconfig_vlan222=<span class="hljs-string"><span class="hljs-string">"inet 192.168.4.2/30"</span></span> ifconfig_vlan333=<span class="hljs-string"><span class="hljs-string">"inet 192.168.5.2/30"</span></span> ifconfig_vlan333_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 0 pass MyPassword alias 2.2.2.2/30"</span></span> ifconfig_vlan444=<span class="hljs-string"><span class="hljs-string">"inet 192.168.6.2/30"</span></span> ifconfig_vlan444_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 0 pass MyPassword alias 3.3.3.2/30"</span></span> ifconfig_vlan555=<span class="hljs-string"><span class="hljs-string">"inet 192.168.7.2/30"</span></span> defaultrouter=<span class="hljs-string"><span class="hljs-string">"1.1.1.1"</span></span> setfib1_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> setfib1_defaultrouter=<span class="hljs-string"><span class="hljs-string">"3.3.3.1"</span></span> setfib2_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> setfib2_defaultrouter=<span class="hljs-string"><span class="hljs-string">"2.2.2.1"</span></span></code> </pre> <br>  Beberapa aturan yang berguna saat mengkonfigurasi ipfw (nat) adalah: <br>  Untuk mengizinkan lalu lintas CARP: <br><pre> <code class="bash hljs">/sbin/ipfw -q add allow carp from any to any</code> </pre> <br>  "Nuklir" nat: <br><pre> <code class="bash hljs">/sbin/ipfw -q nat 1 config <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> ip vlan111 reset same_ports deny_in unreg_only /sbin/ipfw -q add nat 1 ip from any to any <span class="hljs-keyword"><span class="hljs-keyword">in</span></span></code> </pre> <br>  Menggunakan tabel perutean spesifik dengan adaptor spesifik: <br><pre> <code class="bash hljs">/sbin/ipfw -q add setfib 0 all from any to any via vlan666</code> </pre> <br>  Secara umum, saya bisa menulis artikel terpisah tentang pengaturan ipfw yang saya gunakan, tapi ini lain kali. <br></div></div><br><h4>  Perangkat lunak pihak ke-3 </h4><br><div class="spoiler">  <b class="spoiler_title">Lebih detail</b> <div class="spoiler_text">  Karena ada kebutuhan untuk bekerja secara bersamaan dengan dua atau lebih saluran eksternal, untuk ini lebih mudah untuk memiliki beberapa tabel routing, satu untuk setiap saluran.  Dan alangkah baiknya jika tabel ini dibuat saat startup sendiri.  Script setfib rc.d akan membantu.  Logika yang digunakan dalam ToFoIn mengasumsikan bahwa nama file (setfib1, setfib2, dll.) Cocok dengan jumlah tabel di mana skrip tunggal menambahkan rute default.  Tabel secara default memiliki nomor "0". <br>  Server DNS dengan Bind dalam peran utama berfungsi dalam mode sekunder, yang utama adalah samba4 + bind, tersembunyi di jaringan lokal.  Menyiapkan ikatan sekunder diungkapkan dengan indah dalam buku "DNS and BIND" Cricket Lee dan Paul Albitz.  Saya tidak ingat persyaratan khusus apa pun yang memperhitungkan penggunaan samba4 untuk server sekunder, dan saya tidak menyebutkannya dalam file pengaturan.  Kecuali, untuk saluran Internet yang berbeda, Anda mungkin perlu membuat 2 file berbeda, yang kemudian akan disalin oleh skrip ToFoIn ke tempat dari mana bind itu sendiri akan membacanya.  Hal ini disebabkan oleh fakta bahwa ketika menentukan alamat server DNS dari kedua penyedia dalam file yang sama, dengan mempertimbangkan bahwa mengikat bekerja dengan hanya satu tabel perutean, masalah muncul tentang resolusi alamat dari server tingkat tinggi yang tidak dapat diakses pada saat tertentu. <br>  Gagal isc-dhcpd.  Dhcpd tidak penting untuk ToFoIn, apalagi, ketidakhadirannya tidak akan mempengaruhi skrip sama sekali, namun, menurut saya, cukup logis untuk menempatkan server dhcp di gateway dan kemudian pertanyaan tentang failover masih muncul.  Dan di sini, dibandingkan dengan terakhir kali, itu menjadi lebih menarik ... Selain pengaturan yang diperlukan untuk failover, yang saya jelaskan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">terakhir kali</a> (awal bagian "preset" di dalam menu drop-down). <br>  Anda juga akan memerlukan skrip untuk memperbarui catatan dns dalam AD dengan menggunakan samba4 secara aman.  Server samba4 sendiri harus diinstal.  Pengaturan dan peluncuran tidak diperlukan, kami hanya tertarik pada alat manajemen yang disertakan dengan kit.  Mereka yang ingin dapat menemukan informasi lain di bagian "DHCP dengan pembaruan DNS dinamis" <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">di</a> . <br>  Ini terlihat menakutkan, tetapi berhasil. <br>  Tentang hal ini dengan konfigurasi perangkat lunak pihak ketiga selesai. <br></div></div><br><h4>  Sedikit tentang ToFoIn </h4><br>  Semua teks proyek bersama dengan skrip instalasi tersedia di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">gitlab</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Sebagai kesimpulan, contoh parameter file pengaturan ToFoIn dipertimbangkan:</b> <div class="spoiler_text">  Jumlah router yang digunakan dalam sistem: <br><pre> <code class="bash hljs">RNUMBER=2</code> </pre> <br>  Saat menggunakan subnet tambahan, Anda harus menetapkan rute default saat router menjadi yang utama.  Di sini Anda dapat menentukan jumlah file setfib yang sesuai yang akan dimulai kembali.  Dalam contoh ini, setfib2: <br><pre> <code class="bash hljs">ADDITLAN=2</code> </pre> <br>  Nama adaptor internal: <br><pre> <code class="bash hljs">INT_IF=vlan666</code> </pre> <br>  Semua antarmuka lain di mana router terhubung melalui CARP.  Diperlukan untuk mengontrol dan mempertahankan keadaan yang sama dari semua antarmuka: <br><pre> <code class="bash hljs">ALL_IF=<span class="hljs-string"><span class="hljs-string">"vlan111 vlan333 vlan444 vlan666 vlan777 vlan888"</span></span></code> </pre> <br>  vhid yang digunakan ketika mengkonfigurasi CARP: <br><pre> <code class="bash hljs">CARP_VHID=1</code> </pre> <br>  Alamat IP di jaringan internal router lain dalam urutan kepentingan, jika perlu, maka ASERV_IP_2, ASERV_IP_3, dll. Hanya digunakan. <br><pre> <code class="bash hljs">ASERV_IP_1=192.168.0.2</code> </pre> <br>  Jumlah saluran koneksi eksternal: <br><pre> <code class="bash hljs">CNUMBER=2</code> </pre> <br>  Pengaturan untuk saluran koneksi eksternal utama: <br>  Nama Adaptor: <br><pre> <code class="bash hljs">EXT_0_IF=vlan111</code> </pre> <br>  Nomor Tabel Perutean: <br><pre> <code class="bash hljs">RTABLE_0=0</code> </pre> <br>  Gateway Default: <br><pre> <code class="bash hljs">DEFAULT_GATEWAY=2.2.2.1</code> </pre> <br>  Pengaturan untuk saluran koneksi eksternal cadangan: <br>  Nama Adaptor: <br><pre> <code class="bash hljs">EXT_1_IF=vlan444</code> </pre> <br>  Nomor Tabel Perutean: <br><pre> <code class="bash hljs">RTABLE_1=1</code> </pre> <br>  Gateway default tidak diperlukan, karena untuk semua tabel routing, kecuali yang utama, skrip rc.d setfib &lt;table number&gt; digunakan, yang, seperti yang diasumsikan oleh logika, harus cocok dengan nomor tabel. <br>  Parameter modul tester: <br>  Jumlah alamat yang akan diperiksa: <br><pre> <code class="bash hljs">TNUMBER=2</code> </pre> <br>  Alamat mesin yang digunakan untuk mengirim permintaan ping.  Yang terbaik adalah menggunakan nama domain dalam kasus pertama, dan hanya setelah itu alamat ip: <br><pre> <code class="bash hljs">PTARGET_0=ya.ru PTARGET_1=8.8.8.8</code> </pre> <br>  Jumlah paket ping yang dikirim per target: <br><pre> <code class="bash hljs">PNUMBER=2</code> </pre> <br>  Pengaturan Modul Hakim <br>  Jumlah tes yang berhasil dari saluran utama sebelum kembali ke sana.  Waktu pengembalian ke saluran utama setelah dimulainya kembali operasinya kira-kira dihitung dengan rumus: (WNUMBER + 1) * JUDGEPERIOD detik. <br><pre> <code class="bash hljs">WNUMBER=3</code> </pre> <br>  Pengaturan Modul Logger <br>  2 parameter ini menunjukkan seberapa sering Logger akan merekam acara yang berulang.  Setelah merekam acara tersebut, waktu berikutnya LOGFREQ1 akan mencoba ulang jumlah yang dilaporkan, maka LOGFREQ2 adalah jumlah yang coba lagi.  Hanya peristiwa dalam satu baris yang diperhitungkan. <br><pre> <code class="bash hljs">LOGFREQ1=5 LOGFREQ2=20</code> </pre> <br>  Modul memulai penghitung waktu dalam hitungan detik <br>  Periode peluncuran modul Tester.  Masuk akal untuk mengandalkan waktu upaya gagal untuk menguji semua target. <br><pre> <code class="bash hljs">TESTERPERIOD=240</code> </pre> <br>  Periode peluncuran modul Hakim.  Jangan memasang kurang dari TESTERPERIOD. <br><pre> <code class="bash hljs">JUDGEPERIOD=300</code> </pre> <br>  Periode peluncuran modul Scout. <br><pre> <code class="bash hljs">SCOUTPERIOD=360</code> </pre> <br>  Masa tunggu sebelum memeriksa timer mulai dari modul Penguji dan Hakim.  Adalah logis untuk menetapkan kurang dari atau sama dengan nilai TESTERPERIOD. <br><pre> <code class="bash hljs">SENSITIVITY=60</code> </pre> <br>  Waktu setelah mana modul kerja dianggap digantung.  Digunakan oleh modul Watchdog. <br><pre> <code class="bash hljs">TESTERLIMIT=40 JUDGELIMIT=30 LOGGERLIMIT=20 SCOUTLIMIT=120 WATCHDOGLIMIT=150</code> </pre> <br>  Jalur ke file dan direktori <br>  Path ke skrip ipfw. <br><pre> <code class="bash hljs">FIRESCRIPT=/etc/firewall.sh</code> </pre> <br>  Pengaturan Ipfw.  Jika pengaturan ipfw tidak dipindahkan ke file terpisah, maka FIRESCRIPT = FIRESETDEF. <br><pre> <code class="bash hljs">FIRESETDEF=/etc/firewall/config</code> </pre> <br>  Path ke pengaturan ipfw untuk saluran eksternal utama: <br><pre> <code class="bash hljs">FIRESET_0=/etc/firewall/config_0</code> </pre> <br>  Jalur ke pengaturan ipfw untuk saluran eksternal cadangan, jika perlu, Anda dapat melanjutkan FIRESET_2 lebih lanjut, dll .: <br><pre> <code class="bash hljs">FIRESET_1=/etc/firewall/config_1</code> </pre> <br>  Jalur untuk mengikat pengaturan <br><pre> <code class="bash hljs">BINDSETDEF=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/namedb/named.conf</code> </pre> <br>  Bind pengaturan untuk saluran eksternal utama: <br><pre> <code class="bash hljs">BINDSET_0=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/namedb/named.conf.0</code> </pre> <br>  Bind pengaturan untuk saluran eksternal cadangan, jika perlu, Anda dapat melanjutkan BINDSET_2 lebih lanjut, dll.: <br><pre> <code class="bash hljs">BINDSET_1=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/namedb/named.conf.1</code> </pre> <br>  Paths ke semua executables ToFoIn: <br><pre> <code class="bash hljs">DAEMON=/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sbin/tofoin/daemon.sh TESTER=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sbin/tofoin/tester.sh JUDGE=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sbin/tofoin/judge.sh LOGGER=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sbin/tofoin/logger.sh SCOUT=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sbin/tofoin/scout.sh WATCHDOG=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sbin/tofoin/watchdog.sh</code> </pre> <br>  Log acara.  File ini TIDAK dibuat saat instalasi sekarang: <br><pre> <code class="bash hljs">LOGFILE=/var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/tofoin.log</code> </pre> <br>  File dan direktori sementara dibuat ketika modul yang sesuai dimulai, beberapa dihapus ketika dihentikan: <br><pre> <code class="bash hljs">DIR_TMP=/tmp/tofoin DIR_PID=/var/run/tofoin JUDGEMETER=/tmp/tofoin/judgemeter PREVSTATE=/tmp/tofoin/prevstate SCOUTGATE=/tmp/tofoin/scoutgate LOGTMP=/tmp/tofoin/logger.tmp LOGMETER=/tmp/tofoin/logmeter DAEMON_PID=/var/run/tofoin/daemon.pid TESTER_PID=/var/run/tofoin SCOUT_PID=/var/run/tofoin/scout.pid JUDGE_PID=/var/run/tofoin/judge.pid LOGGER_PID=/var/run/tofoin/logger.pid WATCHDOG_PID=/var/run/tofoin_watchdog.pid</code> </pre> <br></div></div><br><h3>  Ringkasan </h3><br>  Ternyata menjadi satu set script yang berfungsi penuh dan dapat diandalkan yang cocok dengan tugas beralih ke saluran kerja dalam kasus 2 router dengan 2 saluran komunikasi eksternal. <br><br><h3>  Paket </h3><br>  Rencana saya untuk proyek ini berhubungan, mungkin, dengan menulis ulang dari bash ke sh murni untuk menyingkirkan perangkat lunak yang tidak perlu di server.  Di sisi lain, sekarang semuanya bekerja dengan luar biasa dan saya benar-benar tidak ingin ikut campur dalam proses ini, selain itu, beralih ke sh dipenuhi dengan konstruksi bahasa yang lebih buruk yang diperlukan untuk mencapai hasil yang sama. <br>  Untuk selebihnya, mungkin, akan lebih baik mempertimbangkan penerapan modul uji terbaik. <br><br><h3>  Referensi: </h3><br>  ← <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Artikel sebelumnya</a> <br>  → <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Halaman proyek ToFoIn di gitlab</a> <br><div class="spoiler">  <b class="spoiler_title">Sisanya</b> <div class="spoiler_text">  DNS BIND 9: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Lee K., Albitz P. - DNS dan BIND (Edisi ke-5)</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">BIND server DNS</a> <br>  DHCP: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Failover dhcp</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">DHCP dengan pembaruan DNS dinamis</a> <br>  <a href="">samba-dnsupdate</a> <br>  SETFIB: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Beberapa rute default di FreeBSD tanpa BGP atau serupa</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">setfib dan beralih antar tabel routing</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">FreeBSD dua penyedia.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">setfib</a> <br>  IPFW + NAT: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Detil ipfw nat manual</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">FreeBSD 9 + ipfw + ipfw nat</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Detil ipfw nat manual</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Dummynet</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Kernel NAT</a> <br>  BASH: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Dasar-dasar BASH.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Bagian 2</a> <br>  <a href="">Panduan Script Bash Lanjutan</a> <br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id421857/">https://habr.com/ru/post/id421857/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id421845/index.html">Apa yang sebenarnya dilakukan analis data? Temuan dari 35 Wawancara</a></li>
<li><a href="../id421847/index.html">Lompat ke awan. Membangun solusi IoT anggaran di NodeMCU + Azure IoT Hub</a></li>
<li><a href="../id421849/index.html">Acara untuk SDM di bidang TI pada bulan September 2018: My Circle Digest</a></li>
<li><a href="../id421851/index.html">Masalah burung hantu dan bola dunia: menghubungkan dua majelis dengan ruang nama dan nama kelas yang identik</a></li>
<li><a href="../id421855/index.html">Proyektor rumah: “menurut versi” terbaik, fokus ultra-pendek, juara dalam kecerahan dan kecepatan</a></li>
<li><a href="../id421859/index.html">Catatan dari penyedia IoT. Perangkat dan kalah menang</a></li>
<li><a href="../id421863/index.html">Cara baru untuk membuat nanotube: sekarang dalam warna</a></li>
<li><a href="../id421867/index.html">Cara membuat kode dapat dibaca</a></li>
<li><a href="../id421869/index.html">Buat aplikasi Android untuk deteksi wajah real-time menggunakan Firebase ML Kit</a></li>
<li><a href="../id421871/index.html">Cara gagal secara menyedihkan dari migrasi Java ke Kotlin di aplikasi Android</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>