<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩‍🔬 🍄 🍇 归类选择有什么区别？ ⏯️ 🏁 👩‍👩‍👧‍👦</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="本文是为“ MS SQL Server开发人员”课程的学生准备的 
 我想分享一个先前项目的故事，它说明必须非常仔细地选择Collat​​ion。 关于仍然错误地选择此参数会发生什么，以及存在解决问题的选项。 


 首先，简要介绍什么是归类。 在SQL Server中，“排序规则”参数告诉服务器如...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>归类选择有什么区别？</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/461231/"><p> 本文是为<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">“ MS SQL Server开发人员”</a>课程的学生准备的 <br> 我想分享一个先前项目的故事，它说明必须非常仔细地选择Collat​​ion。 关于仍然错误地选择此参数会发生什么，以及存在解决问题的选项。 </p><br><p> 首先，简要介绍什么是归类。 在SQL Server中，“排序规则”参数告诉服务器如何对行进行排序和比较。 例如，“ Apple”和“ apple”行。 他们是否不同？ 这取决于指定的归类。 如果寄存器变得越来越不清楚，那么如何使用“圣诞树”和“圣诞树”示例？ 将它们视为相同还是不同？ 这也都在整理中。 </p><br><p> 这个故事发生在一个功能与DropBox或Google Drive非常相似的项目中。 它提供了在不同计算机上管理其同步文件夹和文件的能力，以及其他用户对该同步文件夹的访问权。 </p><br><p><img src="https://habrastorage.org/webt/zb/r_/ix/zbr_ixoq-dgwur4uwz_izd9myta.png" alt="图片"></p><a name="habracut"></a><br><p> 因此，故事始于以下事实：在Prod服务器上，日志中存在75-90％的错误（请参见下面的屏幕截图），并且不清楚它们来自何处，以及原因是什么。 错误是：“ ReadWrtLst未完成”。 接下来是用户的详细信息及其文件夹。 </p><br><p><img src="https://habrastorage.org/webt/i5/jz/lt/i5jzltkaco2jt9du8opn4ywi1du.png" alt="图片"></p><br><p> 代码很快找到了一个产生错误的地方，但是我们不明白它为什么会发生以及如何重现它。很明显，错误与用户以某种方式设法做到这一点有关在您的操作系统中创建另一个具有相同名称的文件夹。 </p><br><p> 我们已收集了有关为其发出此错误的用户的信息。 在这里，我们面临着第一个惊喜：在系统的数百万用户中，只有50个出现此错误，而这50个用户生成了90％的错误日志。 由于无法再现这种情况，我们决定与其中一位用户联系，并找出为什么其中一个文件夹未与之同步。 在我们看来，该文件夹与其他文件夹相同，唯一的不同是，该文件夹是使用象形文字以用户的语言来调用的。 用户是日语。 顺便说一下，在这50个用户中，日语是大多数。 </p><br><p> 感谢团队的一名开发人员，我们得以重现该错误。 该错误是由于所选的排序规则，操作系统认为文件夹名称不同，而SQL Server认为它们相同。 </p><br><p> 项目中使用的整理： <br>  SQL_Latin1_General_CP1_CI_AS </p><br><p> 关于如何阅读归类的一个小题外话。  （如果您熟悉它，请随时跳过它。） </p><br><p> 因此，归类包含以下几部分： </p><br><ul><li>  SQL-通过SQL Server（排序规则开头的SQL）或Windows（当时只是Latin1_ ...）的排序选项； </li><li>  Latin1_General-使用的语言环境或语言； </li><li>  CP1-代码页-代码页； </li><li>  CI-不区分大小写-不区分大小写； </li><li>  AS-重音敏感-考虑到轴突或变音符号，换句话说，“ a”不等于“ấ”。 </li></ul><br><p> 此排序规则曾经是安装SQL Server时的默认排序规则。 </p><br><p> 有哪些选择？ </p><br><ul><li>  _KS-考虑到平假名和片假名的日语字符，如果未选中该选项，则SQL Server将把平假名和片假名的象形文字解释为相同。 </li><li> _WS-考虑到字符的宽度，如果未选择该参数，则将“文本”和“ T ext”视为同一行。 </li><li>  _VSS-考虑到选择日文拼写选项的迹象，该现象从2017年版本开始出现。 </li><li>  _UTF8-允许您将数据存储在UTF8中。 </li></ul><br><p> 数据库中的所有文本字段均使用NVARCHAR类型。 <br> 事实证明，由于当前的归类忽略了日语字符的拼写差异和字符宽度的差异，因此SQL Server不能以与操作系统相同的方式比较字符串，这导致了问题，即 用户可以创建文件夹，不能将其添加到系统中进行同步。 比较文件名时，以后会发生同样的事情。 </p><br><p> 我们开始考虑如何解决此问题并更改排序规则。 </p><br><p> 可以在多个级别上设置排序规则： </p><br><ul><li>  SQL Server实例 </li><li> 资料库 </li><li> 桌子 </li><li> 领域 </li></ul><br><p> 同时，不建议在数据库内部使用不同的归类，因为每次比较具有不同归类的行时，都需要使用COLLATE进行转换，并向服务器指示应使用哪个比较顺序。 </p><br><p> 在很明显没有正确选择排序规则的情况下，有哪些选项可用？ </p><br><ol><li> 在数据库级别更改排序规则； </li><li> 在字段级别更改归类（在我们的例子中，更改整个表没有意义）； </li><li> 添加Varbinary字段，并使用文件夹名称在该字段中写入一个与该字段重复的副本，并将其用于比较； </li><li> 告诉用户目录名称中的字符支持受到限制。 </li></ol><br><p> 第一个选项-在数据库级别更改排序规则-是最困难的。 对于数据库，有必要重新创建数据库并在那里重新加载数据。 由于系统工作24/7，该选项立即被拒绝。 </p><br><p> 关于更改字段的第二个选项：最简单的实现方法是添加具有所需归类的字段，然后在其中传输数据。 但是，随后有必要更改与此字段配合使用的数据库中的代码，并且数据库中有很多代码。 </p><br><p> 我们最喜欢第三个选项，因为从理论上讲，它所做的更改最少，因为主字段将在当前的归类中继续存在，并且在转换时不会出现问题，而所有必需的功能都以日语字母或宽角色会工作。 缺点是有必要对软件部分进行更改，但是由于是服务器部分，因此可以做到这一点。 </p><br><p> 在这种情况下，第四个选项是最简单的，因为用户总数为几百万，只有50个用户有问题，但是，如果该应用程序在日本得到积极使用，则该解决方案将毫无用处。 </p><br><p> 将数据提供给管理层后，决定通知用户该软件不支持许多字符，并且当以同步文件和文件夹的名称使用该软件时，该软件可能无法正常工作。 这是一个临时解决方案，因为通过进一步分发，面临类似问题的用户数量将会增加，并且有必要使用前三个选项进行更改。 </p><br><p> 选择归类的最佳选择是基于您的应用程序需求。 如果您希望SQL Server以与OS相同的方式比较字符串，则默认情况下，归类绝对不正确。 不幸的是，在设计系统时，这样的细微差别很少在项目开始时就可见，但是，希望在阅读本文之后，您会回忆起所描述的情况，而不会自己踩踏。 </p><br><p> 有用的整理资源： <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://docs.microsoft.com/zh-cn/sql/relational-databases/collat​​ions/collat​​ion-and-unicode-support?view=sql-server-2017</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://www.red-gate.com/simple-talk/sql/sql-development/questions-sql-server-collat​​ions-shy-ask/</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://www.virtual-dba.com/sql-server-collat​​ion/</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN461231/">https://habr.com/ru/post/zh-CN461231/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN461219/index.html">Dell Latitude 7400 2合1：精美轻巧的公司可转换笔记本电脑，带有金属外壳</a></li>
<li><a href="../zh-CN461223/index.html">IaaS摘要：高性能，数据存储和数据中心新技术</a></li>
<li><a href="../zh-CN461225/index.html">如何从Barneo的漂流基地到达北极</a></li>
<li><a href="../zh-CN461227/index.html">Embarcadero RAD Studio 10.3.2出来了，还是死了...死了</a></li>
<li><a href="../zh-CN461229/index.html">赫尔辛基 如何在芬兰游戏行业找到工作，未经允许就开始工作且不违反俄罗斯法律</a></li>
<li><a href="../zh-CN461239/index.html">在例子中颤抖。 Flutter应用程序中的深层链接</a></li>
<li><a href="../zh-CN461241/index.html">地球物理学中的Wolfram Mathematica</a></li>
<li><a href="../zh-CN461243/index.html">不要去非洲走走：Black Continent上的互联网审查情况如何</a></li>
<li><a href="../zh-CN461247/index.html">50个有关阅读，收听和观看产品管理的最佳资料</a></li>
<li><a href="../zh-CN461249/index.html">为电影迷编写一个Android应用-第2部分（设计）</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>