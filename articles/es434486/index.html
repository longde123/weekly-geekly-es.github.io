<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üç´ üå©Ô∏è üíí Tarjetas de fidelidad. API de Google Pay para pases en ASP.NET üë©üèø‚Äçüç≥ üëµüèΩ üç∞</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Las aplicaciones de almacenamiento de tarjetas bancarias han entrado r√°pidamente en nuestras vidas gracias a Apple Wallet y Google Pay. Ambas platafor...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Tarjetas de fidelidad. API de Google Pay para pases en ASP.NET</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/434486/"><p>  Las aplicaciones de almacenamiento de tarjetas bancarias han entrado r√°pidamente en nuestras vidas gracias a Apple Wallet y Google Pay.  Ambas plataformas, adem√°s de la banca, tambi√©n le permiten trabajar con otros tipos de tarjetas: tarjetas de fidelidad, tarjetas de regalo, boletos para eventos, tarjetas de embarque, etc. <br></p><br><p><img src="https://habrastorage.org/webt/ga/ng/rq/gangrq7tlqwob2cmgxa1dydoasu.png"><br></p><br><p>  Mientras trabajaba para una empresa que presta servicios a una red minorista bastante grande, tuve que integrar las tarjetas de fidelizaci√≥n de esta red en Apple Wallet y Google Pay.  Y si tuvo que jugar con Apple Wallet solo porque la capa de integraci√≥n es bastante multifuncional, entonces con Google Pay la mayor parte del esfuerzo y las c√©lulas nerviosas se gastaron tratando de descubrir la documentaci√≥n, encontrar las herramientas adecuadas y desarrollar la primera prueba de concepto.  Aunque en general el resto del trabajo fue mucho m√°s r√°pido que para Apple Wallet, pas√© un d√≠a averiguando c√≥mo iniciar el servicio, por lo que no me importar√≠a si alguien escribi√≥ un art√≠culo similar antes que yo. <br><a name="habracut"></a><br></p><h2>  1. Material </h2><br>  Las tarjetas de fidelizaci√≥n se representan mediante dos entidades: Clase de fidelizaci√≥n y Objeto de fidelizaci√≥n. <br><br><ul><li>  <i>Loyalty Class</i> es un tipo de plantilla para todas las tarjetas de fidelizaci√≥n.  Contiene campos comunes a todos los mapas, como el color de fuente, enlaces a elementos de iconos, fondos, campos de texto, etc., una descripci√≥n completa se puede encontrar aqu√≠: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Loyaltyclass</a> <br></li><li>  <i>Objeto de lealtad</i> : una instancia de LoyaltyClass.  Tambi√©n contiene los datos de una tarjeta espec√≠fica de un cliente en particular: n√∫mero de tarjeta, nombre, campos de texto adicionales.  Descripci√≥n aqu√≠: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Loyaltyobject</a> <br></li></ul><br>  Para recibir una tarjeta, el usuario debe seguir el enlace de formato <br>  <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">www.android.com/payapp/savetoandroidpay</a> <b>/ {JWT}</b></i> , donde JWT es un token que contiene JSON con datos de LoyaltyClass.  Pero dado que la longitud de la URL tiene limitaciones, se recomienda que primero cree una Clase de lealtad si su estructura contiene muchos caracteres. <br><br><p>  Si necesita actualizar el mapa debido a un cambio en la plantilla, los estilos, la necesidad de agregar o cambiar campos de texto, puede hacerlo utilizando la API.  Solo es necesario completar una solicitud POST con la nueva versi√≥n del mapa, los servicios de Google sincronizan todas las aplicaciones de los usuarios que tienen este mapa. <br></p><br><h2>  2. Herramientas y documentaci√≥n. </h2><br><p>  El problema result√≥ ser que todos los ejemplos en la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">documentaci√≥n de Google Pay API for Passes</a> eran exclusivamente para Java, PHP y Python, y la documentaci√≥n en s√≠ misma recomienda encarecidamente "usar bibliotecas de clientes para simplificar el proceso" de trabajar con la API. <br></p><br><p>  Siguiendo este consejo, felizmente fui a Nuget, pero la biblioteca de Google Pay no estaba all√≠.  Glory to Brin, la primera l√≠nea en Google para "google pay for pas dotnet" devolvi√≥ la p√°gina de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">bibliotecas de utilidades API de Google Pay para Pases</a> , que encontr√≥ lo que necesitaba, aunque en el formato de archivo ZIP, en el que hab√≠a un proyecto .net con una clase generada que es un contenedor de la API de <a href="">Google Pay</a> - API de <a href="">Google Pay para la biblioteca de Passes Client</a> <br></p><br><p>  A juzgar por la presencia del archivo <i>Google.Apis.Walletobjects.v1.1.9.2.00.nuspec</i> en el proyecto, la implementaci√≥n del paquete nuget todav√≠a era parte de los planes del equipo de Google.  Despu√©s de abrir este archivo en busca de documentaci√≥n, no encontr√© nada concreto, y algunos enlaces que estaban en la secci√≥n de descripci√≥n se enviaron a p√°ginas inexistentes. <br><br></p><h2>  3. Obtener token de acceso </h2><br><p>  Para comenzar a trabajar directamente con la API de Google Pay para Pases, debe obtener un token de acceso, para esto necesita: <br><br></p><ol><li>  Tener una cuenta de comerciante de Google, que puede obtener <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> <br></li><li>  Cree una cuenta de servicio, obtenga un archivo con credenciales para ello: un documento json con detalles de la cuenta de servicio, que incluye identificador, correo electr√≥nico, clave privada, etc.  Como recomienda la documentaci√≥n, debe almacenar este archivo en un lugar seguro. <br></li><li>  Vincular cuenta de comerciante y cuenta de servicio en Google Merchant Center <br></li></ol><br>  Con este archivo, puede iniciar sesi√≥n con la biblioteca <i>Google.Apis.Auth.OAuth2</i> : <br><br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">await</span></span></span><span class="hljs-function"> Task&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetOAuthToken</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> {         <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> serviceAccountFile = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty;         serviceAccountFile = ConfigurationManager.AppSettings[<span class="hljs-string"><span class="hljs-string">"GooglePayServiceAccountConfigPath"</span></span>];        <span class="hljs-comment"><span class="hljs-comment">/*              Credential, GoogleCredential              Service Account,   ,      scopes API,             */</span></span>         <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> credential = GoogleCredential.FromFile(serviceAccountFile)                            .CreateScoped(WalletobjectsService.Scope.WalletObjectIssuer);        <span class="hljs-comment"><span class="hljs-comment">/*        Access token        ,   GetAccessTokenForRequestAsync         ,               */</span></span>         <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> token = <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> credential.UnderlyingCredential.GetAccessTokenForRequestAsync();         <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> token; }</code> </pre> <br><h2>  4. Crea un mapa </h2><br><p>  Para crear una tarjeta de fidelizaci√≥n, primero debe crear una Clase de fidelizaci√≥n.  La clase de lealtad se puede crear utilizando la API y la interfaz web de Google Merchant Center.  Se debe prestar atenci√≥n al nombre de la clase, ya que este nombre debe ser √∫nico en la infraestructura de Google Pay. <br><br>  Despu√©s de crear la Clase de lealtad, puede crear el Objeto de lealtad.  Para hacer esto, ya necesitar√° la biblioteca que agregamos al proyecto anteriormente: cree un objeto de solicitud, especifique el token OAuth, transfiera el objeto LoyaltyObject creado y ejecute la solicitud: <br><br></p><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GooglePayApiService</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-comment"><span class="hljs-comment">// ,    Merchant Account IssuerId = ConfigurationManager.AppSettings["GooglePayIssuerId"]; _wobService = new WalletobjectsService(); } private async Task&lt;LoyaltyObject&gt; ConvertLoyaltyObjectFromTemplate(GooglePayPassTemplate template) { string id = $"{IssuerId}.{template.SerialNumber}"; string loyaltyClassName = ConfigurationManager.AppSettings["GooglePayStoreCardClassName"];     var loyaltyClass = await GetLoyaltyClass(loyaltyClassName); var result =  new LoyaltyObject { Id = id, AccountName = template.AccountName,          Barcode = new Barcode          {          AlternateText = template.BarcodeText,               Value = template.SerialNumber,               Type = "pdf417"          },          Kind = "walletObject#loyaltyObject",          ClassId = loyaltyClass.Id,          ClassReference = loyaltyClass,          State = "active"     };     return result; } private async Task&lt;LoyaltyObject&gt; CreateLoyaltyObject(LoyaltyObject loyaltyObject) { var saveRequest = _wobService.Loyaltyobject.Insert(loyaltyObject); saveRequest.OauthToken = await GetOAuthToken(); var savedObject = await saveRequest.ExecuteAsync(); return savedObject; }</span></span></code> </pre><br>  <i>GooglePayPassTemplate</i> en este ejemplo es un DTO que almacena una plantilla de mapa para un usuario, que es generada por un servicio desarrollado por separado. <br><br><h2>  5. Actualizaci√≥n del mapa </h2><br><p>  Aqu√≠ el principio es el mismo que al crear: generamos una solicitud, transferimos el objeto LoyaltyObject actualizado, ejecutamos: <br><br></p><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;LoyaltyObject&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateLoyaltyObject</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">LoyaltyObject loyaltyObject</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> updateRequest = _wobService.Loyaltyobject.Update(loyaltyObject, loyaltyObject.Id);           updateRequest.OauthToken = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> GetOAuthToken(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> savedObject = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> updateRequest.ExecuteAsync(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> savedObject; }</code> </pre> <br><p>  Despu√©s de completar la solicitud, la tarjeta en las aplicaciones de los usuarios que la tienen instalada se actualizar√° despu√©s de unos segundos, si el dispositivo est√° en la red y tiene una conexi√≥n a Internet. </p><br><br><h2>  6. generaci√≥n JWT </h2><br><p>  Para instalar la tarjeta, debe redirigir al usuario al enlace <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">www.android.com/payapp/savetoandroidpay</a> <b>/ {JWT}</b> .  Puede encontrar una descripci√≥n de la estructura del token en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">este enlace</a> . <br></p><br><p>  El token est√° firmado por RSA-SHA256 con una firma que se puede generar utilizando el mismo archivo con credenciales de cuenta de servicio: <br><br></p><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">JwtHelper</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateJwtForLoyaltyObject</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">LoyaltyObject loyaltyObject</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">/*       credential   ,         */</span></span> ServiceAccountCredential credential; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> now = DateTime.UtcNow; DateTime unixEpoch = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTime(<span class="hljs-number"><span class="hljs-number">1970</span></span>, <span class="hljs-number"><span class="hljs-number">01</span></span>, <span class="hljs-number"><span class="hljs-number">01</span></span>); <span class="hljs-comment"><span class="hljs-comment">// 1970-01-01 00:00:00 UTC var secondsSinceEpoch = (int)Math.Round((now - unixEpoch).TotalSeconds); string serviceAccountFile = serviceAccountFile = ConfigurationManager.AppSettings["GooglePayServiceAccountConfigPath"]; using (var fs = new FileStream(serviceAccountFile, FileMode.Open, FileAccess.Read, FileShare.Read)) { credential = ServiceAccountCredential.FromServiceAccountData(fs); } /*    JwtPayload,     payload-a  JWT */ var jwtPayload = new JwtPayload { iat = secondsSinceEpoch, iss = credential.Id, payload = new JwtInternalPayload { loyaltyObjects = new[] { new LoyaltyObjectPayload { id = loyaltyObject.Id } } } }; string header = @"{""alg"":""RS256"",""typ"":""JWT""}"; string payload = JsonConverter.SerializeObject(jwtPayload); string base64Header = EscapedBase64(Convert.ToBase64String(Encoding.UTF8.GetBytes(header))); string base64Payload = EscapedBase64(Convert.ToBase64String(Encoding.UTF8.GetBytes(payload))); //        Signature string signature = EscapedBase64(credential.CreateSignature( Encoding.UTF8.GetBytes($"{base64Header}.{base64Payload}") )); var token = $"{base64Header}.{base64Payload}.{signature}"; return token; } private static string EscapedBase64(string base64) { return base64.Replace('+', '-') .Replace('/', '_') .Replace("=", ""); } }</span></span></code> </pre><br><h2>  Conclusi√≥n </h2><br><p>  En este art√≠culo, revisamos los conceptos b√°sicos para trabajar con la API de Google Pay para Pases: configurar cuentas, conectarse a la API, crear la Clase de lealtad y el Objeto de lealtad. <br><br>  Si el OVNI lo favorece, le contar√© por separado acerca de c√≥mo trabajar con Apple Wallet (todo es m√°s dif√≠cil en t√©rminos de implementaci√≥n), c√≥mo hacer amigos de Apple Wallet con Google Pay en un servicio web y no sentir dolor. <br></p><br><p></p><h3>  Enlaces utiles </h3><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Registrar cuenta de comerciante</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Documentaci√≥n de API de Google Pay para pases</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Bibliotecas de clientes para trabajar con API de Google Pay para pases</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es434486/">https://habr.com/ru/post/es434486/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es434474/index.html">Gato verde sobre contenido espacial</a></li>
<li><a href="../es434476/index.html">ChatOps en GitLab estar√° disponible para todos</a></li>
<li><a href="../es434478/index.html">El c√≥digo sin rostro matar√° la programaci√≥n, y no haremos nada al respecto.</a></li>
<li><a href="../es434480/index.html">A√±o nuevo, artilugios, fuego</a></li>
<li><a href="../es434482/index.html">Otro a√±o de nuestro blog: resultados de 2018</a></li>
<li><a href="../es434490/index.html">C√≥mo vimos el altavoz por corte por chorro de agua</a></li>
<li><a href="../es434494/index.html">Que leer Lista de ficci√≥n en ruso para 2017 y 2018</a></li>
<li><a href="../es434496/index.html">Compromiso en dos fases y el futuro de los sistemas distribuidos</a></li>
<li><a href="../es434498/index.html">MVP and Dagger 2 - Esqueleto de la aplicaci√≥n de Android - Parte 1</a></li>
<li><a href="../es434500/index.html">Estafador llamado Jeanne o Watch Your Ears</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>