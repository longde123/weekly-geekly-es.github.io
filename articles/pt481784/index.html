<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëá üßúüèø ‚ö°Ô∏è Como Kafka se tornou realidade üôé ‚è∞ üõÖ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√° Habr! 


 Trabalho na equipe de Tinkoff, que est√° desenvolvendo seu pr√≥prio centro de notifica√ß√µes. Na maioria das vezes, desenvolvo em Java usand...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como Kafka se tornou realidade</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tinkoff/blog/481784/"><p><img src="https://habrastorage.org/webt/d1/z0/m1/d1z0m1b3kvl5hobn4_4nnxuxc3o.png"></p><br><p>  Ol√° Habr! </p><br><p>  Trabalho na equipe de Tinkoff, que est√° desenvolvendo seu pr√≥prio centro de notifica√ß√µes.  Na maioria das vezes, desenvolvo em Java usando o Spring boot e resolvo v√°rios problemas t√©cnicos que surgem no projeto. </p><br><p>  A maioria dos nossos microsservi√ßos interage de forma ass√≠ncrona por meio de um intermedi√°rio de mensagens.  Anteriormente, usamos o IBM MQ como um broker, que deixou de lidar com a carga, mas, ao mesmo tempo, possu√≠a altas garantias de entrega. </p><br><p>  Como substitui√ß√£o, nos foi oferecido o Apache Kafka, que tem alta escalabilidade, mas, infelizmente, requer uma abordagem de configura√ß√£o quase individual para diferentes cen√°rios.  Al√©m disso, o mecanismo de entrega, pelo menos uma vez, que funciona em Kafka por padr√£o, n√£o permitiu manter pronto o n√≠vel de consist√™ncia necess√°rio.  Em seguida, compartilharei nossa experi√™ncia na configura√ß√£o do Kafka, em particular, explicarei como configurar e viver exatamente com a entrega √∫nica. </p><a name="habracut"></a><br><h2 id="garantirovannaya-dostavka-i-ne-tolko">  Entrega garantida e muito mais </h2><br><p>  Os par√¢metros que ser√£o discutidos posteriormente ajudar√£o a evitar v√°rios problemas com as configura√ß√µes de conex√£o padr√£o.  Mas primeiro, quero prestar aten√ß√£o a um par√¢metro que facilitar√° uma poss√≠vel depura√ß√£o. </p><br><p>  <strong>Client.id</strong> para produtor e consumidor ajudar√° com isso.  √Ä primeira vista, voc√™ pode usar o nome do aplicativo como um valor e, na maioria dos casos, isso funcionar√°.  Embora a situa√ß√£o em que v√°rios Consumidores sejam usados ‚Äã‚Äãno aplicativo e voc√™ lhes d√™ o mesmo client.id leve ao seguinte aviso: </p><br><pre><code class="java hljs">org.apache.kafka.common.utils.AppInfoParser ‚Äî Error registering AppInfo mbean javax.management.InstanceAlreadyExistsException: kafka.consumer:type=app-info,id=kafka.test-<span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br><p>  Se voc√™ deseja usar o JMX em um aplicativo com Kafka, isso pode ser um problema.  Nesse caso, √© melhor usar uma combina√ß√£o do nome do aplicativo e, por exemplo, o nome do t√≥pico, como o valor de client.id.  O resultado de nossa configura√ß√£o pode ser visto na sa√≠da do comando <strong>kafka-consumer-groups</strong> dos utilit√°rios do Confluent: </p><br><p><img src="https://habrastorage.org/webt/1e/qh/1z/1eqh1zw485osmsizmx6gu9_d8ne.png"></p><br><p>  Agora vamos analisar o cen√°rio de entrega garantida de mensagens.  O Kafka Producer possui um par√¢metro <strong>acks</strong> que permite que voc√™ configure depois de quantos reconhecem que o l√≠der do cluster precisa considerar a mensagem gravada com √™xito.  Este par√¢metro pode assumir os seguintes valores: </p><br><ul><li>  0 - o reconhecimento n√£o ser√° considerado. </li><li>  1 - par√¢metro padr√£o, √© necess√°rio reconhecimento a partir de apenas 1 r√©plica. </li><li>  ‚àí1 - √© necess√°rio reconhecimento de todas as r√©plicas sincronizadas ( <strong>configura√ß√£o do</strong> cluster <strong>min.insync.replicas</strong> ). </li></ul><br><p>  Pode ser visto pelos valores acima que acks iguais a -1 d√£o as garantias mais fortes de que a mensagem n√£o ser√° perdida. </p><br><p>  Como todos sabemos, sistemas distribu√≠dos n√£o s√£o confi√°veis.  Para proteger contra falhas tempor√°rias, o Kafka Producer fornece um par√¢metro de novas <strong>tentativas</strong> que permite definir o n√∫mero de tentativas de repeti√ß√£o durante <strong>delivery.timeout.ms</strong> .  Como o par√¢metro de novas tentativas √© padronizado como Integer.MAX_VALUE (2147483647), o n√∫mero de retransmiss√µes de uma mensagem pode ser ajustado alterando apenas delivery.timeout.ms. </p><br><h2 id="dvizhemsya-k-exactly-once-delivery">  Movendo-se exatamente para a entrega √∫nica </h2><br><p>  Essas configura√ß√µes permitem que nosso produtor envie mensagens com alta garantia.  Vamos agora falar sobre como garantir a grava√ß√£o de apenas uma c√≥pia de uma mensagem em um t√≥pico Kafka?  No caso mais simples, para fazer isso no Producer, configure o par√¢metro <strong>enable.idempotence</strong> como true.  Idempotency garante a grava√ß√£o de apenas uma mensagem em uma parti√ß√£o espec√≠fica de um t√≥pico.  Um pr√©-requisito para ativar a idempot√™ncia √© <strong>acks = all, tente novamente&gt; 0, max.in.flight.requests.per.connection ‚â§ 5</strong> .  Se esses par√¢metros n√£o forem definidos pelo desenvolvedor, os valores acima ser√£o definidos automaticamente. </p><br><p>  Quando a idempot√™ncia √© configurada, √© necess√°rio garantir que as mesmas mensagens caiam nas mesmas parti√ß√µes todas as vezes.  Isso pode ser feito configurando a chave e o par√¢metro partitioner.class no Producer.  Vamos come√ßar com a chave.  Para cada remessa, deve ser o mesmo.  Isso √© facilmente alcan√ßado usando qualquer identificador de neg√≥cios da mensagem original.  O par√¢metro partitioner.class possui um valor padr√£o de <a href="">DefaultPartitioner</a> .  Com essa estrat√©gia de particionamento, o comportamento padr√£o √© o seguinte: </p><br><ul><li>  Se a parti√ß√£o for especificada explicitamente ao enviar a mensagem, n√≥s a usaremos. </li><li>  Se a parti√ß√£o n√£o estiver especificada, mas a chave estiver especificada, selecione a parti√ß√£o por hash na chave. </li><li>  Se a parti√ß√£o e a chave n√£o forem especificadas, selecione as parti√ß√µes por vez (round-robin). </li></ul><br><p>  Al√©m disso, o uso da chave e do envio idempotente com o par√¢metro <strong>max.in.flight.requests.per.connection = 1</strong> fornece um processamento ordenado de mensagens no Consumer.  Separadamente, vale lembrar que, se o controle de acesso estiver configurado em seu cluster, voc√™ precisar√° dos direitos de grava√ß√£o idempotente no t√≥pico. </p><br><p>  Se voc√™ repentinamente n√£o possuir os recursos de envio idempotente por chave ou a l√≥gica no lado do Produtor exigir a preserva√ß√£o da consist√™ncia dos dados entre diferentes parti√ß√µes, as transa√ß√µes ser√£o √∫teis.  Al√©m disso, usando uma transa√ß√£o em cadeia, voc√™ pode sincronizar condicionalmente um registro no Kafka, por exemplo, com um registro no banco de dados.  Para habilitar o envio transacional para o Producer, √© necess√°rio que ele possua idempot√™ncia e, opcionalmente, defina <strong>transactional.id</strong> .  Se o controle de acesso estiver configurado no cluster Kafka, para grava√ß√£o transacional e tamb√©m idempotente, voc√™ precisar√° de permiss√µes de grava√ß√£o, que podem ser concedidas pela m√°scara usando o valor armazenado em transactional.id. </p><br><p>  Formalmente, voc√™ pode usar qualquer sequ√™ncia, por exemplo, o nome do aplicativo, como um identificador de transa√ß√£o.  Mas se voc√™ executar v√°rias inst√¢ncias de um aplicativo com o mesmo transactional.id, a primeira inst√¢ncia iniciada ser√° interrompida com um erro, pois o Kafka o considerar√° um processo zumbi. </p><br><pre> <code class="java hljs">org.apache.kafka.common.errors.ProducerFencedException: Producer attempted an operation with an old epoch. Either there is a newer producer with the same transactionalId, or the producer<span class="hljs-string"><span class="hljs-string">'s transaction has been expired by the broker.</span></span></code> </pre> <br><p>  Para resolver esse problema, adicionamos um sufixo ao nome do aplicativo na forma do nome do host, obtido das vari√°veis ‚Äã‚Äãde ambiente. </p><br><p>  O produtor est√° configurado, mas as transa√ß√µes no Kafka controlam apenas o escopo da mensagem.  Independentemente do status da transa√ß√£o, a mensagem cai imediatamente no t√≥pico, mas possui atributos adicionais do sistema. </p><br><p>  Para impedir que essas mensagens sejam lidas antecipadamente pelo Consumidor, ele precisa definir o par√¢metro <strong>isolamento.level</strong> como read_committed.  Esse consumidor poder√° ler mensagens n√£o transacionais como antes e transacionais somente ap√≥s uma confirma√ß√£o. <br>  Se voc√™ instalou todas as configura√ß√µes listadas acima, configurou exatamente uma vez a entrega.  Parab√©ns! </p><br><p>  Mas h√° mais uma nuance.  Transactional.id, que configuramos acima, √© na verdade um prefixo de transa√ß√£o.  No gerenciador de transa√ß√µes, um n√∫mero de s√©rie √© adicionado a ele.  O identificador recebido √© emitido em <strong>transactional.id.expiration.ms</strong> , configurado no cluster Kafka e com um valor padr√£o de "7 dias".  Se, durante esse per√≠odo, o aplicativo n√£o recebeu nenhuma mensagem, ao tentar o pr√≥ximo envio transacional, voc√™ receber√° uma <strong>InvalidPidMappingException</strong> .  Depois disso, o coordenador da transa√ß√£o emitir√° um novo n√∫mero de sequ√™ncia para a pr√≥xima transa√ß√£o.  No entanto, a mensagem pode ser perdida se o InvalidPidMappingException n√£o for processado corretamente. </p><br><h2 id="vmesto-itogov">  Em vez de totais </h2><br><p>  Como voc√™ pode ver, apenas enviar mensagens para Kafka n√£o √© suficiente.  Voc√™ precisa escolher uma combina√ß√£o de par√¢metros e estar preparado para fazer altera√ß√µes r√°pidas.  Neste artigo, tentei mostrar exatamente uma vez as configura√ß√µes de entrega em detalhes e descrevi v√°rios problemas de configura√ß√£o client.id e transactional.id que encontramos.  O resumo das configura√ß√µes do produtor e do consumidor est√° resumido abaixo. </p><br><p>  Produtor: </p><br><ol><li>  acks = all </li><li>  tentativas&gt; 0 </li><li>  enable.idempotence = true </li><li>  max.in.flight.requests.per.connection ‚â§ 5 (1 - para envio ordenado) </li><li>  transactional.id = $ {application-name} - $ {hostname} </li></ol><br><p>  Consumidor: </p><br><ol><li>  isolamento.level = read_committed </li></ol><br><p>  Para minimizar erros em aplicativos futuros, criamos nosso inv√≥lucro na configura√ß√£o de mola, onde os valores para alguns dos par√¢metros listados j√° est√£o definidos. </p><br><p>  E aqui est√£o alguns materiais para estudo independente: </p><br><ul><li>  <a href="https://cwiki.apache.org/confluence/display/KAFKA/KIP-98%2B-%2BExactly%2BOnce%2BDelivery%2Band%2BTransactional%2BMessaging">KIP-98 - Entrega Exatamente √önica e Mensagens Transacionais</a> </li><li>  <a href="https://kafka.apache.org/documentation/">Descri√ß√£o das configura√ß√µes</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt481784/">https://habr.com/ru/post/pt481784/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt481774/index.html">Dicas de seguran√ßa: Patch virtual</a></li>
<li><a href="../pt481776/index.html">Servi√ßos de jogos 5G e na nuvem - teste como funciona em Moscou</a></li>
<li><a href="../pt481778/index.html">An√°lise de malware do Skeleton Key</a></li>
<li><a href="../pt481780/index.html">O MyOffice possui mais de 200 novos recursos</a></li>
<li><a href="../pt481782/index.html">Sobre os problemas do tradutor Python e repensar o idioma</a></li>
<li><a href="../pt481786/index.html">Google enterra extens√£o IMAP do PHP</a></li>
<li><a href="../pt481788/index.html">An√°lise de solu√ß√£o de problemas reais da ind√∫stria (salvando leit√µes e outros)</a></li>
<li><a href="../pt481790/index.html">Como a trapa√ßa est√° mudando a comunidade speedrunner</a></li>
<li><a href="../pt481792/index.html">Como o PVS-Studio realizou a segunda metade das confer√™ncias de 2019</a></li>
<li><a href="../pt481794/index.html">Beckender - um psicoterapeuta: um depurador para a psique</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>