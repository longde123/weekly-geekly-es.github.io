<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚳 👃🏾 👦🏼 Blackjack dan perlindungan kebocoran balik 🛫 😣 🍇</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Salam Ada hal seperti itu - hydrolock \ neptune \ avkvastorozh - sistem pematian air jika terjadi kebocoran yang tidak terkendali. Prinsipnya sederhan...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Blackjack dan perlindungan kebocoran balik</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/399459/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Salam Ada hal seperti itu - hydrolock \ neptune \ avkvastorozh - sistem pematian air jika terjadi kebocoran yang tidak terkendali. Prinsipnya sederhana - sensor air + otomatisasi + sepasang keran listrik. Tetapi iblis, seperti biasa, ada dalam rincian: bagaimana keran diatur, bagaimana sensor kebocoran diatur, dan mengapa satu biaya 50 rubel dan yang lain biaya 500 rubel. Satu kilogram buletin tata letak akan melilit semua ini, kemasan akan mengeluarkan mata Anda, dll. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam cerita saya akan berjalan melalui batu bata sistem, yang membimbing saya dalam pilihan. Seluruh sistem dibangun di atas sensor pabrik dan pengontrol buatan sendiri berdasarkan Partikel (ex.Spark) Photon (seperti esp8266 yang memiliki IDE cloud pada pengkabelan di luar kotak), basis perangkat adalah pengontrol stm + modul wifi dari Broadcom. Semua ini terkait dengan server openhab di Orange Pi One.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/715/6ee/aa2/7156eeaa28b44479a5d5aff2e63ff89c.png" width="600"></div><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mengapa bukan sistem yang sudah selesai? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - Karena saya bisa melakukannya sendiri dan ini tinggi </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - Integrasi dengan sistem eksternal lemah dalam sistem yang sudah jadi. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - Sistem siap pakai tidak memiliki fungsi tambahan - memperhitungkan pembacaan meter, sensor suhu air, pemberitahuan pemadaman air dan fantasi erotis berjalan lainnya.</font></font><br>
 <br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mari kita mulai dengan crane</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Memilih bodoh di dahi dalam hal torsi. Untuk beberapa waktu ia tinggal di pinggiran kota, di mana kualitas air (mungkin di mana-mana di Zamkadye) menyisakan banyak yang diinginkan. Jadi bola valves 1/2 inci jika Anda tidak menyentuh tahun - sangat sulit untuk berputar. Dan pada gantungan handuk 1 inci yang dipanaskan, saya bahkan tidak mencoba untuk memindahkannya - hanya jika saya memperkuat bahu dengan kunci inggris, tetapi di sini Anda dapat merobek sesuatu. Masalahnya ada pada endapan kalsium-kayu, "ditumbuhi" dengan satu kata. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dengan demikian, pilihan jatuh pada seri profesional dari hydrolock - 21N * m torsi tidak terasa seperti obrolan iklan, crane sangat besar - mengevaluasi tempat pemasangannya sebelum membeli. </font></font><br>
<br>
<img src="https://habrastorage.org/files/758/e07/18c/758e0718cc9a46e09306bac214db8cf1.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Keran disegel, segel karet di sekeliling, pintu masuk di bawah kelenjar sekrup. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lepaskan penutup.</font></font><br>
<br>
<img src="https://habrastorage.org/files/f9d/aa4/a25/f9daa4a251e140c3bbe4b049a5af7f46.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di depan kita ada papan atas dan motor stepper. Semua ini didukung oleh 12 volt. Shorting kabel kontrol ke tanah menempatkan katup dalam posisi tertutup. Di papan tulis kita melihat pengontrol PIC 12f629 sederhana. Tinggal, controller di drive derek. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bagian belakang papan adalah yang paling menarik. </font></font><br>
<br>
<img src="https://habrastorage.org/files/c14/e08/f2e/c14e08f2e4224088a534e1811fa3729a.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L293 driver shagovik dan photocoupler (emitor + photodetector). Dia melihat gigi utama drive, yang dicat bagian - putih dan hitam, tertutup / terbuka. </font></font><br>
<br>
<img src="https://habrastorage.org/files/a14/cec/177/a14cec1771ef4d52bc15c83e9183124e.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Derek berputar sepanjang waktu dalam satu arah, logika pengontrolnya sederhana - kita memutar poros sampai kita beralih ke warna yang diinginkan. Rotasi crane dalam satu arah adalah keausan yang lebih sedikit, dan cara non-kontak untuk menentukan posisi lebih kecil kemungkinannya untuk memburuk / tidak berfungsinya resistor variabel atau sakelar batas.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk pemasangan, Anda dapat melepaskan crane dari drive - dipegang dengan 2 mur. Ada gasket isolasi panas antara drive dan derek. </font></font><br>
<br>
<img src="https://habrastorage.org/files/bf7/37c/1f7/bf737c1f7a144c72baba7a17fdc94615.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya memiliki perbaikan satu setengah tahun yang lalu. Derek itu dibeli tiga tahun lalu - untuk membongkar, melihat ke dalam, membeli lebih banyak dan memutarnya selama perbaikan. Ya, sekarang ... maksimum yang saya kelola di sirkus neraka ini adalah meletakkan pengumpul debu di dalam rakitan pasokan air dengan prospek untuk menggantinya dengan crane. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan hanya setelah satu setengah tahun - saya membeli crane kedua dan mengacaukannya.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Akibatnya, kami mengamati fenomena aneh dan langka (baca di suara Drozdov) - semua informasi dari situs web produsen dikonfirmasi. Selain itu, uraiannya aneh, seolah-olah para teknisi menulis, dan kemudian pemasaran disiram untuk orang-orang, tetapi masih sedikit orang yang mengerti semua chip. Tidak ada bagian yang cukup di situs - untuk integrator dengan detail teknis di dalamnya. Bahkan dengan mengorbankan peningkatan torsi, mereka tidak berbohong di awal - derek di poni awal dengan mesin 1,5A dan setelah 2-3 detik mulai naik dalam mode normal (0,7 A) saat ini. Dibutuhkan sekitar 25-30 detik untuk menutup.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pengalaman lain: dengan mengorbankan torsi - ini berlebihan untuk waktu Moskow, di sini airnya cukup oke, selama satu setengah tahun dalam filter 100 μm ada sepasang sampah dan tidak ada pertumbuhan berlebihan. </font><font style="vertical-align: inherit;">Anda harus membayar untuk torsi besar dengan harga, waktu pembukaan, dan tempat di lemari. </font><font style="vertical-align: inherit;">Saya pikir akan ada cukup drive konvensional dari Hydrolock Ultimate, Neptune atau Aquastorozh. </font><font style="vertical-align: inherit;">Saya tidak bisa menjamin untuk dua terakhir - saya tidak bisa keluar, sekitar 5 tahun yang lalu mereka memiliki sebagian roda gigi plastik, sekarang mereka tampaknya telah memperbaikinya. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ada juga hydrolock Pemenang dengan koneksi sensor langsung ke drive - ini adalah jika Anda tidak membutuhkan semua yang telah saya lakukan. </font><font style="vertical-align: inherit;">Di sana, daya otonom dari 4 baterai, dan pangkalan mirip dengan drive utama. </font><font style="vertical-align: inherit;">Secara umum, ini juga berpotensi menarik untuk pengontrol buatan sendiri - 5 volt, Anda tidak perlu menempatkan dua bus pada volt 5 dan 12 dan Anda dapat membuang isolasi optik.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sensor kebocoran</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya membeli sensor konter WSU yang sama - universal. </font><font style="vertical-align: inherit;">Mereka memiliki dua output "kolektor terbuka", satu menarik ke tanah hanya jika ada air, yang kedua - jika air masuk, itu menarik ke tanah sepanjang waktu sampai listrik terputus. </font><font style="vertical-align: inherit;">Saya hanya menggunakan output pertama, sisa logika ada di controller, tetapi sepertinya output ini dapat berguna untuk beberapa sistem pengiriman kondominium. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kabel dalam kit berada tiga meter di suatu tempat. </font><font style="vertical-align: inherit;">Warna kabelnya adalah Ad_i_Israel. </font><font style="vertical-align: inherit;">Lihatlah kutipannya:</font></font><br>
<br>
<blockquote><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kabel merah (coklat) (Vcc) diaktifkan dari +5 hingga +30 volt. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
kawat hitam (putih) (OUT2) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
kawat hijau (OUT1) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
kawat kuning (GND)</font></font></i></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Inilah yang dicegah membuat bumi putih / hitam? </font><font style="vertical-align: inherit;">Pada drive crane, omong-omong, kabel berwarna dengan logika bukan bir. </font><font style="vertical-align: inherit;">Sensor pertama ada di dapur, di bawah wastafel di sebelah mesin cuci piring. </font></font><br>
<br>
<img src="https://habrastorage.org/files/2ea/407/a25/2ea407a255b8420e9b1d6c26772e2709.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Yang kedua di kamar mandi di selokan drainase khusus. </font><font style="vertical-align: inherit;">Ketika dia melakukan screed, dia tidak membawanya ke dinding. </font><font style="vertical-align: inherit;">Hasilnya adalah semacam bah untuk menampung air dari kamar mandi dan toilet. </font></font><br>
<br>
<img src="https://habrastorage.org/files/51d/715/898/51d71589848d4a77a59f8caf0dbf2041.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dari pengalaman operasi - sudah ada satu alarm palsu dari sensor di mesin pencuci piring. </font><font style="vertical-align: inherit;">Dilihat oleh log untuk satu siklus pemungutan suara (500 ms) ada sirkuit, dimodifikasi kode - perubahan negara sekarang terjadi pada 10 nilai identik berturut-turut dari sensor </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kontak sensor berlapis emas. </font><font style="vertical-align: inherit;">Seorang teman memiliki sensor serupa selama beberapa tahun, tidak ada oksidasi yang terlihat.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sensor tekanan</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Praktis - showometer. </font><font style="vertical-align: inherit;">Akurasi + - 0,5 atm sangat cocok untuk saya. </font><font style="vertical-align: inherit;">Berdasarkan sensor, peringatan shutdown air datang. </font><font style="vertical-align: inherit;">Saya membeli Ali di </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sini</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sensor suhu</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan mengapa tidak menambahkan? </font><font style="vertical-align: inherit;">Dari berguna - itu akan dapat menginformasikan setiap tahun tentang penutupan air panas. </font><font style="vertical-align: inherit;">Ds18b20 dangkal bekas.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Penghitung</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Itelma yang paling umum, setiap 10 liter melakukan kontak. </font><font style="vertical-align: inherit;">Di sisi pengontrol, output ditarik ke + 3.3V, meteran menariknya ke tanah.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pengendali</font></font></h3><br>
<img src="https://habrastorage.org/files/318/4e6/d7a/3184e6d7ad9c4eab99d9962410c7918c.jpg"><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Di dalam</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/files/a83/72d/117/a8372d1170ca43f8b92925fa76a240f8.jpg"><br>
<img src="https://habrastorage.org/files/f7b/e62/ee8/f7be62ee80a54ff2a0ed60ad17467a8b.jpg"><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Berdasarkan Partikel Foton, lebih detail di </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sini</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Mereka memiliki versi dengan modul 2G atau 3G (Electron). Firmware pertama adalah slag lengkap, berkedip dengan dioda OK, tetapi segera setelah Anda mulai sosis yang kenyal, bermain dengan i2c dan interupsi dapat kehilangan wifi. Sekarang kamu bisa hidup. Pada prinsipnya, Anda dapat membuang sensor tekanan dari sirkuit dan menggerakkan segala sesuatu pada ESP8266 - lakukan saja. Pertama, foton harus ditautkan ke akun partikel (dilakukan melalui Aplikasi di ponsel atau melalui konsol Partikel CLI - Saya hanya menggunakan metode kedua) dan mendaftarkan jaringan wifi. Setelah mengikat, </font><font style="vertical-align: inherit;">di </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sini</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> di bagian perangkat muncul controller dan statusnya terhubung ke cloud.</font></font><br>
<br>
<img src="https://habrastorage.org/files/71d/c17/687/71dc17687ccb4a289d0a0dd2296fdfca.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya memiliki semua node yang terhubung ke cloud hanya untuk memperbarui firmware. </font><font style="vertical-align: inherit;">Bukan berarti saya akan menjadi paranoid - hanya bekerja dengan cloud makan bukan sumber daya controller kaya. </font><font style="vertical-align: inherit;">IDE mendukung bekerja dengan perpustakaan, secara harfiah selusin didukung oleh penghitung itu sendiri, sisanya oleh komunitas. </font><font style="vertical-align: inherit;">Dalam pengamatan saya, semua yang umum telah diangkut sejak lama, dan fitur lainnya adalah bahwa IDE segera tahu berapa banyak proyek yang menggunakan pustaka.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kode sumber firmware</font></font></b><div class="spoiler_text"><pre><code class="hljs cpp"><span class="hljs-comment"><span class="hljs-comment">// This #include statement was automatically added by the Particle IDE.</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Adafruit_SSD1306/Adafruit_SSD1306.h"</span></span></span></span><font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">// This #include statement was automatically added by the Particle IDE.</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"MQTT/MQTT.h"</span></span></span></span><font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">// This #include statement was automatically added by the Particle IDE.</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"OneWire/OneWire.h"</span></span></span></span><font></font>
<font></font>
SYSTEM_THREAD(ENABLED);<font></font>
SYSTEM_MODE(MANUAL);<font></font>
STARTUP(WiFi.selectAntenna(ANT_EXTERNAL));<font></font>
STARTUP(System.enableFeature(FEATURE_RETAINED_MEMORY));<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">counter_struct</span></span></span><span class="hljs-class"> {</span></span>
  <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> value;<font></font>
  byte state;<font></font>
  <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pin;<font></font>
};<font></font>
<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">valve_struct</span></span></span><span class="hljs-class"> {</span></span><font></font>
  byte state;<font></font>
  <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pin;<font></font>
};<font></font>
<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sensor_struct</span></span></span><span class="hljs-class"> {</span></span>
  <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> timeout;<font></font>
  byte state;<font></font>
  <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pin;<font></font>
};<font></font>
<font></font>
<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> currentMillis = <span class="hljs-number"><span class="hljs-number">0</span></span>;
<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> previous_conected = <span class="hljs-number"><span class="hljs-number">100000</span></span>; <span class="hljs-comment"><span class="hljs-comment">//  </span></span>
<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> previous_wifi_uptime = <span class="hljs-number"><span class="hljs-number">100000</span></span>; <span class="hljs-comment"><span class="hljs-comment">//  </span></span>
<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> previous_counter_read = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">//  </span></span>
<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> wifi_uptime;
<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> start_temp_timer = <span class="hljs-number"><span class="hljs-number">0</span></span>;
<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> read_temp_timer = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
byte display_timeout = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">//temp onewire </span></span><font></font>
OneWire ds0 = OneWire(D2);<font></font>
OneWire ds1 = OneWire(D3);<font></font>
byte addr0[<span class="hljs-number"><span class="hljs-number">8</span></span>];<font></font>
byte addr1[<span class="hljs-number"><span class="hljs-number">8</span></span>];
<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> presense0 = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;
<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> presense1 = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;<font></font>
byte data[<span class="hljs-number"><span class="hljs-number">12</span></span>];<font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> OLED_RESET A7</span></span>
<span class="hljs-function"><span class="hljs-function">Adafruit_SSD1306 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">display</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(OLED_RESET)</span></span></span></span>;<font></font>
<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">//valve control</span></span>
retained valve_struct valve[<span class="hljs-number"><span class="hljs-number">2</span></span>] = { {<span class="hljs-number"><span class="hljs-number">0</span></span>, D4}, {<span class="hljs-number"><span class="hljs-number">0</span></span>, D5} };<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">//counter control</span></span>
retained counter_struct counter[<span class="hljs-number"><span class="hljs-number">2</span></span>] = { {<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, A0}, {<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, A1} };
<span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pressure[<span class="hljs-number"><span class="hljs-number">2</span></span>] = {A2, A3};
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SENSOR_TIMEOUT 10</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> sensor_struct sensor[<span class="hljs-number"><span class="hljs-number">2</span></span>] = { {<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, D6}, {<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, D7} };<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">callback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* topic, byte* payload, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> length)</span></span></span></span>;<font></font>
<font></font>
byte server[] = { <span class="hljs-number"><span class="hljs-number">192</span></span>,<span class="hljs-number"><span class="hljs-number">168</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">101</span></span>};
<span class="hljs-function"><span class="hljs-function">MQTT </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">client</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(server, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1883</span></span></span></span><span class="hljs-function"><span class="hljs-params">, callback)</span></span></span></span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">publish_message</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* t, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* p, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> retain)</span></span></span><span class="hljs-function"> 
</span></span>{
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client.publish(t, (<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span>*)p, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(p), retain);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">publish_message</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* t, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> p, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> retain)</span></span></span><span class="hljs-function"> 
</span></span>{   
    <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buf_d[<span class="hljs-number"><span class="hljs-number">12</span></span>];
    <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> n = <span class="hljs-built_in"><span class="hljs-built_in">sprintf</span></span>(buf_d,<span class="hljs-string"><span class="hljs-string">"%d"</span></span>,p);
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client.publish(t, (<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span>*)buf_d, n, retain);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">publish_message</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* t, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> p, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> retain)</span></span></span><span class="hljs-function"> 
</span></span>{   
    <span class="hljs-comment"><span class="hljs-comment">//char buf_f[18];</span></span>
    <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">s</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(p, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">4</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>;
<span class="hljs-comment"><span class="hljs-comment">//    dtostrf(p, 9, 4, buf_f);</span></span>
    <span class="hljs-comment"><span class="hljs-comment">//int n = sprintf(buf_f,"%f",p);</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client.publish(t, (<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span>*)s.c_str(), s.length(), retain);<font></font>
}<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">// recieve message</span></span>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">callback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* topic, byte* payload, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> length)</span></span></span><span class="hljs-function"> </span></span>{
    <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> p[length + <span class="hljs-number"><span class="hljs-number">1</span></span>];
    <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>(p, payload, length);<font></font>
    p[length] = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>;
    <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">message</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(p)</span></span></span></span>;
    <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(topic)</span></span></span></span>;
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (t.equals(<span class="hljs-string"><span class="hljs-string">"home/water_count/spark/set"</span></span>))<font></font>
    {<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (message.equalsIgnoreCase(<span class="hljs-string"><span class="hljs-string">"1"</span></span>))<font></font>
        {<font></font>
            Particle.connect();<font></font>
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (waitFor(Particle.connected, <span class="hljs-number"><span class="hljs-number">10000</span></span>)) <font></font>
                {publish_message(<span class="hljs-string"><span class="hljs-string">"home/water_count/spark"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>);}
            <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>
                {Particle.disconnect(); publish_message(<span class="hljs-string"><span class="hljs-string">"home/water_count/spark"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>);}<font></font>
        }<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">else</span></span><font></font>
        {<font></font>
            Particle.disconnect();<font></font>
            publish_message(<span class="hljs-string"><span class="hljs-string">"home/water_count/spark"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>);<font></font>
        }<font></font>
    }<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (t.startsWith(<span class="hljs-string"><span class="hljs-string">"home/water_count/valve/"</span></span>))<font></font>
    {<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> m = message.toInt();
        <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x = t.substring(<span class="hljs-number"><span class="hljs-number">23</span></span>,<span class="hljs-number"><span class="hljs-number">24</span></span>).toInt();
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (m &gt; <span class="hljs-number"><span class="hljs-number">-1</span></span> &amp;&amp; m &lt; <span class="hljs-number"><span class="hljs-number">2</span></span> &amp;&amp; x &gt; <span class="hljs-number"><span class="hljs-number">-1</span></span> &amp;&amp; x &lt;<span class="hljs-number"><span class="hljs-number">2</span></span>) <font></font>
        {<font></font>
            set_valve(x, m);<font></font>
        }<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">else</span></span><font></font>
        {<font></font>
            publish_message(<span class="hljs-string"><span class="hljs-string">"home/water_count/valve/"</span></span> + t.substring(<span class="hljs-number"><span class="hljs-number">23</span></span>,<span class="hljs-number"><span class="hljs-number">24</span></span>),  valve[x].state , <span class="hljs-literal"><span class="hljs-literal">true</span></span>);<font></font>
        }<font></font>
    }<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (t.startsWith(<span class="hljs-string"><span class="hljs-string">"home/water_count/counter/"</span></span>))<font></font>
    {<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> m = message.toFloat();
        <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x = t.substring(<span class="hljs-number"><span class="hljs-number">25</span></span>,<span class="hljs-number"><span class="hljs-number">26</span></span>).toInt();
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (m &gt; <span class="hljs-number"><span class="hljs-number">-1</span></span> &amp;&amp; m &lt;= <span class="hljs-number"><span class="hljs-number">999999</span></span> &amp;&amp; x &gt; <span class="hljs-number"><span class="hljs-number">-1</span></span> &amp;&amp; x &lt;<span class="hljs-number"><span class="hljs-number">2</span></span>) <font></font>
        {<font></font>
            counter[x].value = m;<font></font>
        }<font></font>
        publish_message(<span class="hljs-string"><span class="hljs-string">"home/water_count/counter/"</span></span> + t.substring(<span class="hljs-number"><span class="hljs-number">25</span></span>,<span class="hljs-number"><span class="hljs-number">26</span></span>),  counter[x].value , <span class="hljs-literal"><span class="hljs-literal">true</span></span>);<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{
<span class="hljs-comment"><span class="hljs-comment">//Serial.begin(9600);</span></span><font></font>
    WiFi.on();<font></font>
    WiFi.connect();<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (waitFor(WiFi.ready, <span class="hljs-number"><span class="hljs-number">5000</span></span>)) {mqtt_connect();}
    <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">2</span></span>; i++) <font></font>
    {<font></font>
        pinMode(valve[i].pin, OUTPUT);<font></font>
        digitalWrite(valve[i].pin, valve[i].state);<font></font>
        pinMode(counter[i].pin, INPUT);<font></font>
        pinMode(sensor[i].pin, INPUT);<font></font>
        counter[i].state = digitalRead(counter[i].pin);<font></font>
        pinMode(pressure[i], AN_INPUT);<font></font>
    }<font></font>
    pinMode(A4, INPUT_PULLUP);<font></font>
<font></font>
    display.begin(SSD1306_SWITCHCAPVCC, <span class="hljs-number"><span class="hljs-number">0x3C</span></span>);  <span class="hljs-comment"><span class="hljs-comment">// initialize with the I2C addr 0x3C (for the 128x64)</span></span>
    display.clearDisplay();   <span class="hljs-comment"><span class="hljs-comment">// clears the screen and buffer</span></span><font></font>
<font></font>
    <span class="hljs-comment"><span class="hljs-comment">//Particle.connect();</span></span><font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> 
</span></span>{<font></font>
    currentMillis = millis();<font></font>
    <span class="hljs-comment"><span class="hljs-comment">//       MQTT </span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentMillis - previous_conected &gt;= <span class="hljs-number"><span class="hljs-number">30000</span></span> || previous_conected &gt; currentMillis)<font></font>
    {<font></font>
        previous_conected = currentMillis;<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!client.isConnected() &amp; wifi_uptime &gt; <span class="hljs-number"><span class="hljs-number">60</span></span>)<font></font>
        {<font></font>
            mqtt_connect();<font></font>
        }<font></font>
        publish_message(<span class="hljs-string"><span class="hljs-string">"home/water_count/rssi"</span></span>, WiFi.RSSI(), <span class="hljs-literal"><span class="hljs-literal">true</span></span>);<font></font>
    }<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentMillis - previous_wifi_uptime &gt;= <span class="hljs-number"><span class="hljs-number">1000</span></span> || previous_wifi_uptime &gt; currentMillis)<font></font>
    {<font></font>
        previous_wifi_uptime = currentMillis;<font></font>
        WiFi.ready() ? wifi_uptime++ : wifi_uptime = <span class="hljs-number"><span class="hljs-number">0</span></span>;
        <span class="hljs-comment"><span class="hljs-comment">//work with button and display</span></span>
        <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> fg = digitalRead(A4);
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (display_timeout &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>)<font></font>
        {<font></font>
            display_timeout -= <span class="hljs-number"><span class="hljs-number">1</span></span>;
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (display_timeout == <span class="hljs-number"><span class="hljs-number">0</span></span>) <font></font>
            { <font></font>
                display.clearDisplay();<font></font>
                display.display();<font></font>
            } <font></font>
        }<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fg == <span class="hljs-number"><span class="hljs-number">0</span></span>)<font></font>
        {<font></font>
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (display_timeout == <span class="hljs-number"><span class="hljs-number">0</span></span>)<font></font>
            {<font></font>
                display.clearDisplay();   <span class="hljs-comment"><span class="hljs-comment">// clears the screen and buffer</span></span>
                display.setTextSize(<span class="hljs-number"><span class="hljs-number">2</span></span>);<font></font>
                display.setTextColor(WHITE);<font></font>
                display.setCursor(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>);<font></font>
                display.print(<span class="hljs-string"><span class="hljs-string">"C="</span></span>);<font></font>
                display.println(counter[<span class="hljs-number"><span class="hljs-number">0</span></span>].value, <span class="hljs-number"><span class="hljs-number">4</span></span>);<font></font>
                display.setCursor(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">16</span></span>);<font></font>
                display.print(<span class="hljs-string"><span class="hljs-string">"H="</span></span>);<font></font>
                display.println(counter[<span class="hljs-number"><span class="hljs-number">1</span></span>].value, <span class="hljs-number"><span class="hljs-number">4</span></span>);<font></font>
                display.setCursor(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">32</span></span>);<font></font>
                display.print(<span class="hljs-string"><span class="hljs-string">"Valve="</span></span>);<font></font>
                display.print(valve[<span class="hljs-number"><span class="hljs-number">0</span></span>].state);<font></font>
                display.print(<span class="hljs-string"><span class="hljs-string">"|"</span></span>);<font></font>
                display.println(valve[<span class="hljs-number"><span class="hljs-number">1</span></span>].state);<font></font>
                display.setCursor(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">48</span></span>);<font></font>
                display.print(<span class="hljs-string"><span class="hljs-string">"Sensor="</span></span>);<font></font>
                display.print(sensor[<span class="hljs-number"><span class="hljs-number">0</span></span>].state);<font></font>
                display.print(<span class="hljs-string"><span class="hljs-string">"|"</span></span>);<font></font>
                display.println(sensor[<span class="hljs-number"><span class="hljs-number">1</span></span>].state);<font></font>
                display.display();<font></font>
            }<font></font>
            display_timeout = <span class="hljs-number"><span class="hljs-number">10</span></span>;<font></font>
        }<font></font>
    }<font></font>
    <span class="hljs-comment"><span class="hljs-comment">//counter check</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentMillis - previous_counter_read &gt;= <span class="hljs-number"><span class="hljs-number">500</span></span> || previous_counter_read &gt; currentMillis)<font></font>
    {<font></font>
        previous_counter_read = currentMillis;<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">2</span></span>; i++) <font></font>
        {<font></font>
            byte count_state = digitalRead(counter[i].pin);<font></font>
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count_state != counter[i].state)<font></font>
            {<font></font>
                counter[i].state = count_state;<font></font>
                <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count_state == <span class="hljs-number"><span class="hljs-number">0</span></span>)<font></font>
                {<font></font>
                    counter[i].value += <span class="hljs-number"><span class="hljs-number">0.01</span></span>;
                    <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buf18[<span class="hljs-number"><span class="hljs-number">30</span></span>];
                    <span class="hljs-built_in"><span class="hljs-built_in">sprintf</span></span>(buf18,<span class="hljs-string"><span class="hljs-string">"home/water_count/counter/%d"</span></span>, i);<font></font>
                    publish_message(buf18 , counter[i].value, <span class="hljs-literal"><span class="hljs-literal">true</span></span>);<font></font>
                }<font></font>
            }<font></font>
            <span class="hljs-comment"><span class="hljs-comment">//    </span></span><font></font>
            byte sensor_state = digitalRead(sensor[i].pin);<font></font>
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sensor_state != sensor[i].state) <span class="hljs-comment"><span class="hljs-comment">//</span></span><font></font>
            {<font></font>
                sensor[i].state = sensor_state;<font></font>
                sensor[i].timeout = SENSOR_TIMEOUT; <font></font>
            }<font></font>
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sensor[i].timeout &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <font></font>
            {<font></font>
                sensor[i].timeout -= <span class="hljs-number"><span class="hljs-number">1</span></span>;
                <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sensor[i].timeout == <span class="hljs-number"><span class="hljs-number">0</span></span>)<font></font>
                {<font></font>
                    <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buf18[<span class="hljs-number"><span class="hljs-number">30</span></span>];
                    <span class="hljs-built_in"><span class="hljs-built_in">sprintf</span></span>(buf18,<span class="hljs-string"><span class="hljs-string">"home/water_count/sensor/%d"</span></span>, i);<font></font>
                    publish_message(buf18 , sensor[i].state, <span class="hljs-literal"><span class="hljs-literal">true</span></span>);
                    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sensor[i].state  == <span class="hljs-number"><span class="hljs-number">0</span></span>)<font></font>
                    {<font></font>
                        set_valve(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-comment"><span class="hljs-comment">//close both valve</span></span>
                        set_valve(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-comment"><span class="hljs-comment">//close both valve</span></span><font></font>
                    }<font></font>
                }<font></font>
            }<font></font>
        }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment"><span class="hljs-comment">// temp onewire</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentMillis - start_temp_timer &gt;= <span class="hljs-number"><span class="hljs-number">299000</span></span> || start_temp_timer &gt; currentMillis)<font></font>
    { <span class="hljs-comment"><span class="hljs-comment">// </span></span><font></font>
        start_temp_timer = currentMillis;<font></font>
        presense0 = start_temp0();<font></font>
        presense1 = start_temp1();<font></font>
    }<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentMillis - read_temp_timer &gt;= <span class="hljs-number"><span class="hljs-number">300000</span></span> || read_temp_timer &gt; currentMillis)<font></font>
    {<span class="hljs-comment"><span class="hljs-comment">// </span></span><font></font>
        read_temp_timer = currentMillis;<font></font>
        start_temp_timer = currentMillis;<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (presense0) read_temp0();
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (presense1) read_temp1();
        <span class="hljs-comment"><span class="hljs-comment">//preasure calc and send</span></span>
        <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buf18[<span class="hljs-number"><span class="hljs-number">30</span></span>]; 
        <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">2</span></span>; i++)<font></font>
        {<font></font>
            <span class="hljs-built_in"><span class="hljs-built_in">sprintf</span></span>(buf18,<span class="hljs-string"><span class="hljs-string">"home/water_count/pressure/%d"</span></span>, i);
            <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> read_val = analogRead(pressure[i]);
            <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> value = (read_val - <span class="hljs-number"><span class="hljs-number">600.0</span></span>) / <span class="hljs-number"><span class="hljs-number">300.0</span></span> ;<font></font>
            publish_message(buf18 , value, <span class="hljs-literal"><span class="hljs-literal">false</span></span>);<font></font>
        }<font></font>
    }<font></font>
    <span class="hljs-comment"><span class="hljs-comment">//Particle.process();</span></span><font></font>
    client.loop();<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mqtt_connect</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">
</span></span>{
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (client.connect(<span class="hljs-string"><span class="hljs-string">"water_count"</span></span>))<font></font>
    { <span class="hljs-comment"><span class="hljs-comment">//  spark    </span></span>
        client.subscribe(<span class="hljs-string"><span class="hljs-string">"home/water_count/spark/set"</span></span>);<font></font>
        publish_message(<span class="hljs-string"><span class="hljs-string">"home/water_count/spark"</span></span>, Particle.connected() ? <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>);<font></font>
        client.subscribe(<span class="hljs-string"><span class="hljs-string">"home/water_count/valve/+/set"</span></span>);<font></font>
        client.subscribe(<span class="hljs-string"><span class="hljs-string">"home/water_count/counter/+/set"</span></span>);<font></font>
        <font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">start_temp0</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">
</span></span>{<font></font>
    <font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !ds0.search(addr0)) { ds0.reset_search(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>;}<font></font>
    ds0.reset_search();<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (OneWire::crc8(addr0, <span class="hljs-number"><span class="hljs-number">7</span></span>) != addr0[<span class="hljs-number"><span class="hljs-number">7</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>;}<font></font>
    <font></font>
    ds0.reset();<font></font>
    ds0.select(addr0);<font></font>
    ds0.write(<span class="hljs-number"><span class="hljs-number">0x44</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>);
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <font></font>
}<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">start_temp1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">
</span></span>{<font></font>
    <font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !ds1.search(addr1)) { ds1.reset_search(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>;}<font></font>
    ds1.reset_search();<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (OneWire::crc8(addr1, <span class="hljs-number"><span class="hljs-number">7</span></span>) != addr1[<span class="hljs-number"><span class="hljs-number">7</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>;}<font></font>
    <font></font>
    ds1.reset();<font></font>
    ds1.select(addr1);<font></font>
    ds1.write(<span class="hljs-number"><span class="hljs-number">0x44</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>);
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read_temp0</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">
</span></span>{
    <span class="hljs-comment"><span class="hljs-comment">//delay(1000);</span></span><font></font>
    ds0.reset();<font></font>
    ds0.select(addr0);<font></font>
    ds0.write(<span class="hljs-number"><span class="hljs-number">0xBE</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>);<font></font>
<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">9</span></span>; i++) <font></font>
    {<font></font>
        data[i] = ds0.read();<font></font>
    }<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">int16_t</span></span> raw = (data[<span class="hljs-number"><span class="hljs-number">1</span></span>] &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>) | data[<span class="hljs-number"><span class="hljs-number">0</span></span>];
    <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> celsius = (<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>)raw * <span class="hljs-number"><span class="hljs-number">0.0625</span></span>;
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (celsius &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || celsius &gt; <span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>;<font></font>
    publish_message(<span class="hljs-string"><span class="hljs-string">"home/water_count/temp/0"</span></span>, celsius, <span class="hljs-literal"><span class="hljs-literal">false</span></span>);
    <span class="hljs-comment"><span class="hljs-comment">//Serial.println(celsius);</span></span><font></font>
    ds0.reset_search();<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>;<font></font>
}<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read_temp1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">
</span></span>{
    <span class="hljs-comment"><span class="hljs-comment">//delay(1000);</span></span><font></font>
    ds1.reset();<font></font>
    ds1.select(addr1);<font></font>
    ds1.write(<span class="hljs-number"><span class="hljs-number">0xBE</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>);<font></font>
<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">9</span></span>; i++) <font></font>
    {<font></font>
        data[i] = ds1.read();<font></font>
    }<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">int16_t</span></span> raw = (data[<span class="hljs-number"><span class="hljs-number">1</span></span>] &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>) | data[<span class="hljs-number"><span class="hljs-number">0</span></span>];
    <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> celsius = (<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>)raw * <span class="hljs-number"><span class="hljs-number">0.0625</span></span>;
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (celsius &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || celsius &gt; <span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>;<font></font>
    publish_message(<span class="hljs-string"><span class="hljs-string">"home/water_count/temp/1"</span></span>, celsius, <span class="hljs-literal"><span class="hljs-literal">false</span></span>);
    <span class="hljs-comment"><span class="hljs-comment">//Serial.println(celsius);</span></span><font></font>
    ds1.reset_search();<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">set_valve</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> vlv, byte state)</span></span></span><span class="hljs-function">
</span></span>{<font></font>
    valve[vlv].state = state;<font></font>
    digitalWrite(valve[vlv].pin, state);<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buf26[<span class="hljs-number"><span class="hljs-number">26</span></span>];
    <span class="hljs-built_in"><span class="hljs-built_in">sprintf</span></span>(buf26,<span class="hljs-string"><span class="hljs-string">"home/water_count/valve/%d"</span></span>, vlv);<font></font>
    publish_message(buf26 , state , <span class="hljs-literal"><span class="hljs-literal">true</span></span>);<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Melalui MQTT kami terhubung ke broker. </font><font style="vertical-align: inherit;">Monitor sensor dan helm di cabang yang sesuai dari acara dan nilai mqtt. </font><font style="vertical-align: inherit;">Misalnya rumah / water_count / katup / 0 - drive air. </font><font style="vertical-align: inherit;">home / water_count / counter / 0 - pembacaan counter air dingin. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami berlangganan perintah untuk mengubah keadaan drive dan menetapkan nilai saat ini dari penghitung (air dingin dan panas):</font></font><br>
<br>
<pre><code class="hljs axapta"><span class="hljs-keyword"><span class="hljs-keyword">client</span></span>.subscribe(<span class="hljs-string"><span class="hljs-string">"home/water_count/valve/+/set"</span></span>);
<span class="hljs-keyword"><span class="hljs-keyword">client</span></span>.subscribe(<span class="hljs-string"><span class="hljs-string">"home/water_count/counter/+/set"</span></span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ada satu tombol pada perangkat - dengan menekan kita menghidupkan layar, menggambar bacaan counter saat ini, sensor dan ketukan. Layar OLED, cepat memudar jika dihidupkan sepanjang waktu.</font></font><br>
<br>
<pre><code class="hljs lisp">STARTUP(<span class="hljs-name"><span class="hljs-name">System</span></span>.enableFeature(<span class="hljs-name"><span class="hljs-name">FEATURE_RETAINED_MEMORY</span></span>))<span class="hljs-comment"><span class="hljs-comment">;</span></span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ini adalah fitur perangkat keras dan perangkat lunak yang menarik dari pengontrol stm, dalam Partikel referensi mereka menyebutnya BackupSRAM. Foton memiliki output vbat - ini bukan daya baterai atau pengisian daya. Selama ada tegangan pada kaki ini, isi SRAM 4k byte dipertahankan dengan pengontrol yang sepenuhnya tidak berenergi. Ini menghilangkan masalah keausan pada EEPROM. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam kode, variabel yang harus didorong ke dalam memori ini dinyatakan dengan indikasi: dipertahankan. Saya menerapkan perangkat keras dari supercapacitor di 1.5F. Menurut datasheet, memori akan mati di 1.6v, menurut percobaan bangku saya di proto-board itu akan datang dalam 2 minggu dengan tentang kapasitor saya. Logika menutup crane ketika sensor dipicu adalah "otonom" dan tidak tergantung pada koneksi ke openhab. Ada saklar 3 arah untuk kontrol drive langsung - otomatis, OFF (keran terbuka), Tutup (tutup).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Diagram sirkuit di bawah ini: </font></font><br>
<br>
<img src="https://habrastorage.org/files/1a8/f4c/63d/1a8f4c63dba34f4e9905b703fabad0fd.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Proyek Elang, bersama dengan lib kustom, dapat diunduh di </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sini</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Biaya dibuat LUT, di trek tidak menyusut.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pemandian air, sahabat terbaik LUT</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/files/351/e37/1c3/351e371c3caf487d9f14f839f89402be.jpg"><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unit catu daya. </font><font style="vertical-align: inherit;">Kami membutuhkan 12 dan 5 volt. </font><font style="vertical-align: inherit;">Donatur dicari di ebay untuk saluran: "adaptor daya hard drive 5v 12v", seperti </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ini</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Perumahan</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Itu dicetak dengan plastik PLA pada printer 3d (Tarantula Tevo). </font><font style="vertical-align: inherit;">Nozzle 0.4mm, lapisan 0.25mm. </font><font style="vertical-align: inherit;">Penutup pada saat yang sama dan alas untuk memasang papan pengontrol. </font><font style="vertical-align: inherit;">Basis dengan catu daya terpasang ke dinding. </font><font style="vertical-align: inherit;">Basis dengan tutupnya tidak diikat dengan sekrup, ada ketegangan tutup yang cukup (seperti tutup nenek di stoples selai) dan struktur dinding yang berlapis berfungsi. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Model 3D dalam </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">arsip</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/files/945/110/37d/94511037d3734ad1a573e84e5fc426ef.png"><br>
<br>
<img src="https://habrastorage.org/files/5aa/546/c0b/5aa546c0b6dd41d58fd6b33bde08df74.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beginilah tampilannya terpasang di pipa air.</font></font><br>
<br>
<img src="https://habrastorage.org/files/cfb/293/f66/cfb293f66c3f4bb9ad2f46e812418918.jpg"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Openhab</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dikerjakan di Orange Pi One di bawah Armbian.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konfigurasi Barang</font></font></b><div class="spoiler_text"><pre><code class="hljs julia">  -    ,  .
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_temp1	<span class="hljs-string"><span class="hljs-string">"T cool [%.1f °C]"</span></span>			(gWaterCount)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/temp1:state:default]"</span></span> }
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_temp2	<span class="hljs-string"><span class="hljs-string">"T hot [%.1f °C]"</span></span>			(gWaterCount)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/temp2:state:default]"</span></span> }
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_count0	<span class="hljs-string"><span class="hljs-string">"Count cool [%.2f ³]"</span></span>					(gWaterCount)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/counter/0:state:default]"</span></span> }
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_count1	<span class="hljs-string"><span class="hljs-string">"Count hot [%.2f ³]"</span></span>				(gWaterCount)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/counter/1:state:default]"</span></span> }
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_pressure0	<span class="hljs-string"><span class="hljs-string">"P cool [%.2f .]"</span></span>			(gWaterCount)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/pressure/0:state:default]"</span></span> }
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_pressure1	<span class="hljs-string"><span class="hljs-string">"P hot [%.2f .]"</span></span>				(gWaterCount)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/pressure/1:state:default]"</span></span> }
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_sensor0	<span class="hljs-string"><span class="hljs-string">"Sensor0 is [MAP(water_sensor.map):%s]"</span></span>		(gWaterCount)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/sensor/0:state:default]"</span></span> }
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_sensor1	<span class="hljs-string"><span class="hljs-string">"Sensor1 is [MAP(water_sensor.map):%s]"</span></span>		(gWaterCount)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/sensor/1:state:default]"</span></span> }
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_valve0	<span class="hljs-string"><span class="hljs-string">"Valve cool"</span></span>		(gWaterCount)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/valve/0:state:default], &gt;[mqtt_bro:home/water_count/valve/0/set:command:*:default]"</span></span> }
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_valve1	<span class="hljs-string"><span class="hljs-string">"Valve hot"</span></span>				(gWaterCount)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/valve/1:state:default], &gt;[mqtt_bro:home/water_count/valve/1/set:command:*:default]"</span></span> }
<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>	watercount_sendStr <span class="hljs-string"><span class="hljs-string">"LastVol:[%s]"</span></span>						(gWaterCount)
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_sendCool <span class="hljs-string"><span class="hljs-string">"Send cool [%.2f ³]"</span></span>		(gWaterCount)
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_sendHot <span class="hljs-string"><span class="hljs-string">"Send hot [%.2f ³]"</span></span>			(gWaterCount)
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_sendSwitch <span class="hljs-string"><span class="hljs-string">"Autosend"</span></span> 	(gWaterCount)
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_rssi	<span class="hljs-string"><span class="hljs-string">"WaterCount [%d dB]"</span></span>	(gSpark_RSSI)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/rssi:state:default]"</span></span> }
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_spark_state	<span class="hljs-string"><span class="hljs-string">"WaterCount Spark"</span></span>		(gSpark)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/spark:state:default], &gt;[mqtt_bro:home/water_count/spark/set:command:*:default]"</span></span> }</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Diperlukan aturan transformasi kecil untuk sensor kebocoran.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konfigurasi berubah</font></font></b><div class="spoiler_text"><b>transform\water_sensor.map </b><br>
1=dry<br>
0=wet<br>
undefined=undefined<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami membentuk halaman untuk manajemen:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konfigurasikan Peta Situs</font></font></b><div class="spoiler_text"><b>Sitemap</b><br>
Text label=«» icon=«water» <br>
 {<br>
 Frame <br>
 {<br>
 Text item=watercount_temp1<br>
 Text item=watercount_count0<br>
 Text item=watercount_pressure0<br>
 Switch item=watercount_valve0 mappings=[1=«Close», 0=«Open»]<br>
 }<br>
 Frame <br>
 {<br>
 Text item=watercount_temp2<br>
 Text item=watercount_count1<br>
 Text item=watercount_pressure1<br>
 Switch item=watercount_valve1 mappings=[1=«Close», 0=«Open»]<br>
 }<br>
 Frame <br>
 {<br>
 Text item=watercount_sensor0<br>
 Text item=watercount_sensor1 <br>
 }<br>
 Frame <br>
 {<br>
 Switch item=watercount_sendSwitch mappings=[0=«OFF», 1=«ON»]<br>
 Text item=watercount_sendStr<br>
 Text item=watercount_sendCool<br>
 Text item=watercount_sendHot<br>
 }<br>
 } <br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan aturan pemrosesan:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aturan Konfigurasi</font></font></b><div class="spoiler_text"><pre><code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> "Check watercount_sensor0"
	<span class="hljs-keyword"><span class="hljs-keyword">when</span></span>
		Item watercount_sensor0 received <span class="hljs-keyword"><span class="hljs-keyword">update</span></span>
	<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_sensor0.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) == <span class="hljs-number"><span class="hljs-number">1</span></span>)<font></font>
		{<font></font>
			<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_sensor0.historicState(now.minusSeconds(<span class="hljs-number"><span class="hljs-number">3</span></span>)).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) == <span class="hljs-number"><span class="hljs-number">1</span></span>)<font></font>
			{<font></font>
				sendTelegram("****_bot", "Sensor0 was wet less than 5 seconds")<font></font>
			}<font></font>
			<span class="hljs-keyword"><span class="hljs-keyword">else</span></span><font></font>
			{<font></font>
				sendTelegram("****_bot", "Sensor0 become dry")<font></font>
			}<font></font>
		}<font></font>
		<span class="hljs-keyword"><span class="hljs-keyword">else</span></span><font></font>
		{<font></font>
			<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_sensor0.historicState(now.minusSeconds(<span class="hljs-number"><span class="hljs-number">3</span></span>)).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) == <span class="hljs-number"><span class="hljs-number">0</span></span>)<font></font>
			{<font></font>
				sendTelegram("****_bot", "Sensor0 was dry less than 5 seconds");			<font></font>
			}<font></font>
			<span class="hljs-keyword"><span class="hljs-keyword">else</span></span><font></font>
			{<font></font>
				sendTelegram("****_bot", "Sensor0 become wet! Valves will be closed!")<font></font>
			}<font></font>
		}<font></font>
	<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> "Check watercount_sensor1"
	<span class="hljs-keyword"><span class="hljs-keyword">when</span></span>
		Item watercount_sensor1 received <span class="hljs-keyword"><span class="hljs-keyword">update</span></span>
	<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_sensor1.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) == <span class="hljs-number"><span class="hljs-number">1</span></span>)<font></font>
		{<font></font>
			<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_sensor1.historicState(now.minusSeconds(<span class="hljs-number"><span class="hljs-number">3</span></span>)).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) == <span class="hljs-number"><span class="hljs-number">1</span></span>)<font></font>
			{<font></font>
				sendTelegram("****_bot", "Sensor1 was wet less than 5 seconds")<font></font>
			}<font></font>
			<span class="hljs-keyword"><span class="hljs-keyword">else</span></span><font></font>
			{<font></font>
				sendTelegram("****_bot", "Sensor1 become dry")<font></font>
			}<font></font>
		}<font></font>
		<span class="hljs-keyword"><span class="hljs-keyword">else</span></span><font></font>
		{<font></font>
			<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_sensor1.historicState(now.minusSeconds(<span class="hljs-number"><span class="hljs-number">3</span></span>)).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) == <span class="hljs-number"><span class="hljs-number">0</span></span>)<font></font>
			{<font></font>
				sendTelegram("****_bot", "Sensor1 was dry less than 5 seconds");			<font></font>
			}<font></font>
			<span class="hljs-keyword"><span class="hljs-keyword">else</span></span><font></font>
			{<font></font>
				sendTelegram("****_bot", "Sensor1 become wet! Valves will be closed!")<font></font>
			}<font></font>
		}<font></font>
	<span class="hljs-keyword"><span class="hljs-keyword">end</span></span><font></font>
	<font></font>
<span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> "Check watercount_temp2"
	<span class="hljs-keyword"><span class="hljs-keyword">when</span></span>
		Item watercount_temp2 received <span class="hljs-keyword"><span class="hljs-keyword">update</span></span>
	<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_temp2.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) &lt; <span class="hljs-number"><span class="hljs-number">37</span></span> )<font></font>
		{<font></font>
			sendTelegram("****_bot", String::format("Hot water temp drop to %s", watercount_temp2.state.toString));<font></font>
		}<font></font>
	<span class="hljs-keyword"><span class="hljs-keyword">end</span></span><font></font>
<font></font>
<span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> "Check watercount_pressure0"
	<span class="hljs-keyword"><span class="hljs-keyword">when</span></span>
		Item watercount_pressure0 received <span class="hljs-keyword"><span class="hljs-keyword">update</span></span>
	<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_pressure0.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) &lt; <span class="hljs-number"><span class="hljs-number">1</span></span> &amp;&amp; (watercount_pressure0.historicState(now.minusSeconds(<span class="hljs-number"><span class="hljs-number">3</span></span>)).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) &gt;= <span class="hljs-number"><span class="hljs-number">1</span></span>)<font></font>
		{<font></font>
			sendTelegram("****_bot", String::format("Cool pressure drop to %s", watercount_pressure0.state.toString));<font></font>
		}<font></font>
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_pressure0.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) &gt; <span class="hljs-number"><span class="hljs-number">1</span></span> &amp;&amp; (watercount_pressure0.historicState(now.minusSeconds(<span class="hljs-number"><span class="hljs-number">3</span></span>)).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) &lt;= <span class="hljs-number"><span class="hljs-number">1</span></span>)<font></font>
		{<font></font>
			sendTelegram("****_bot", String::format("Cool pressure rise to %s", watercount_pressure0.state.toString));<font></font>
		}<font></font>
	<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> "Check watercount_pressure1"
	<span class="hljs-keyword"><span class="hljs-keyword">when</span></span>
		Item watercount_pressure1 received <span class="hljs-keyword"><span class="hljs-keyword">update</span></span>
	<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_pressure1.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) &lt; <span class="hljs-number"><span class="hljs-number">1</span></span> &amp;&amp; (watercount_pressure1.historicState(now.minusSeconds(<span class="hljs-number"><span class="hljs-number">3</span></span>)).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) &gt;= <span class="hljs-number"><span class="hljs-number">1</span></span>)<font></font>
		{<font></font>
			sendTelegram("****_bot", String::format("Hot pressure drop to %s", watercount_pressure1.state.toString));<font></font>
		}<font></font>
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_pressure1.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) &gt; <span class="hljs-number"><span class="hljs-number">1</span></span> &amp;&amp; (watercount_pressure1.historicState(now.minusSeconds(<span class="hljs-number"><span class="hljs-number">3</span></span>)).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) &lt;= <span class="hljs-number"><span class="hljs-number">1</span></span>)<font></font>
		{<font></font>
			sendTelegram("****_bot", String::format("Hot pressure rise to %s", watercount_pressure1.state.toString));<font></font>
		}<font></font>
	<span class="hljs-keyword"><span class="hljs-keyword">end</span></span><font></font>
<font></font>
<span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> "Generate send string counters" //every <span class="hljs-number"><span class="hljs-number">24</span></span> day <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> mounth  <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">00.01</span></span> minutes
	<span class="hljs-keyword"><span class="hljs-keyword">when</span></span>
		<span class="hljs-type"><span class="hljs-type">Time</span></span> cron "0 0 1 24 1/1 ?" 
	<span class="hljs-keyword"><span class="hljs-keyword">then</span></span><font></font>
		<font></font>
		var <span class="hljs-type"><span class="hljs-type">float</span></span> deltaCool = (watercount_count0.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType).floatValue() - (watercount_sendCool.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType).floatValue()<font></font>
		var <span class="hljs-type"><span class="hljs-type">float</span></span> deltaHot = (watercount_count1.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType).floatValue() - (watercount_sendHot.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType).floatValue()<font></font>
		<font></font>
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (deltaCool &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; deltaHot &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>)<font></font>
		{<font></font>
			watercount_sendStr.postUpdate(String::format(" %.2f / %.2f 3", deltaCool, deltaHot))<font></font>
			watercount_sendCool.state = watercount_count0.state<font></font>
			watercount_sendHot.state = watercount_count1.state<font></font>
			sendTelegram("****_bot", String::format(" 23,  5, . 23.  №2560097 (.) = %.2f 3. C №2538996 (.) = %.2f 3. %s", (watercount_sendCool.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType).floatValue(), (watercount_sendHot.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType).floatValue(), watercount_sendStr.state.toString()))<font></font>
		}<font></font>
		<span class="hljs-keyword"><span class="hljs-keyword">else</span></span><font></font>
		{<font></font>
			watercount_sendSwitch.postUpdate(<span class="hljs-number"><span class="hljs-number">0</span></span>)<font></font>
			sendTelegram("****_bot", "Current counters value less than sended last time. Turn off autosend.")<font></font>
		}<font></font>
<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> "Send string counters" 
	<span class="hljs-keyword"><span class="hljs-keyword">when</span></span>
		<span class="hljs-type"><span class="hljs-type">Time</span></span> cron "0 0 23 24 1/1 ?"
	<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (watercount_sendSwitch.state == <span class="hljs-number"><span class="hljs-number">1</span></span>)<font></font>
		{<font></font>
			sendMail("uk@uk.ru", " 23,  5, . 23", String::format(" 23,  5, . 23.  №2560097 (.) = %.2f 3. C №2538996 (.) = %.2f 3", (watercount_sendCool.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType).floatValue(), (watercount_sendHot.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType).floatValue()));<font></font>
			sendTelegram("****_bot", "Send email with watercount values");<font></font>
		}<font></font>
		<span class="hljs-keyword"><span class="hljs-keyword">else</span></span><font></font>
		{<font></font>
			sendTelegram("****_bot", "Can't send email with watercount values - autosend is OFF.");<font></font>
		}<font></font>
<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> "Rotate valves" 
	<span class="hljs-keyword"><span class="hljs-keyword">when</span></span>
		<span class="hljs-type"><span class="hljs-type">Time</span></span> cron "0 0 05 25 1/1 ?"
	<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (watercount_valve0.state == <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; watercount_valve1.state == <span class="hljs-number"><span class="hljs-number">0</span></span>)<font></font>
		{	<font></font>
			watercount_valve0.postUpdate(<span class="hljs-number"><span class="hljs-number">1</span></span>)<font></font>
			Thread::sleep(<span class="hljs-number"><span class="hljs-number">1000</span></span>)<font></font>
			watercount_valve1.postUpdate(<span class="hljs-number"><span class="hljs-number">1</span></span>)<font></font>
			Thread::sleep(<span class="hljs-number"><span class="hljs-number">1000</span></span>)<font></font>
			watercount_valve0.postUpdate(<span class="hljs-number"><span class="hljs-number">0</span></span>)<font></font>
			Thread::sleep(<span class="hljs-number"><span class="hljs-number">1000</span></span>)<font></font>
			watercount_valve1.postUpdate(<span class="hljs-number"><span class="hljs-number">0</span></span>)<font></font>
			sendTelegram("****_bot", "Valves was rotated.");<font></font>
		}<font></font>
		<span class="hljs-keyword"><span class="hljs-keyword">else</span></span><font></font>
		{<font></font>
			sendTelegram("****_bot", "Can't rotate valves, it's closed.");<font></font>
		}<font></font>
<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk mengirim pesan, saya tidak menggunakan fungsionalitas built-in dari aplikasi android openhab, juga tidak saya integrasikan dengan cloud mereka. </font><font style="vertical-align: inherit;">Saya suka bot Telegram. </font><font style="vertical-align: inherit;">Cara mengkonfigurasi dan menghubungkan bot dapat dilihat di </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wiki</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Untuk mengirim surat dari kotak surat gmail, jika Anda memiliki otentikasi dua faktor, Anda perlu mengaktifkan kata sandi satu kali untuk aplikasi surat dan mengatur kata sandi ini di konfigurasi openhab. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Berjalan sesuai aturan. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Periksa watercount_sensor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- pengontrol mengirimkan nilai sensor kebocoran baru hanya ketika nilainya diubah atau jika ada alarm palsu (kurang dari 10 siklus). Kami menganalisis makna datang dan historis, kami membentuk pesan informasi. Ada nuansa - upaya untuk mendapatkan prevoiusItem terus-menerus memberikan nilai saat ini, saya belum menemukan solusi - Saya mengambil nilai "-3 detik", jika seseorang mengatasinya, tuliskan dalam komentar atau di PM. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Periksa watercount_temp2</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - periksa apakah kurang dari 37, artinya air panas telah menjadi dingin, Anda harus menghidupkan pemanas pada saat kedatangan. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Periksa watercount_pressure</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - kami menganalisis nilai saat ini dan sebelumnya, kami merespons dengan pesan hingga turun di bawah 1 atm dan pertumbuhan di atasnya. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hasilkan penghitung string pengirim</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Dimulai dengan cron pada tanggal 24 setiap bulan pada pukul 1 pagi. Kami memeriksa bahwa nilainya sekarang lebih besar daripada yang dikirim terakhir kali. Jika kurang, matikan pengiriman otomatis dan buat lansiran. Jika OK - kami mengingat nilai-nilai penghitung untuk dikirim ke KUHP, kami mengirim badan pesan di masa depan ke telegram. Pada saat yang sama, kami menghemat dalam watercount_sendStr berapa banyak yang kami konsumsi selama sebulan terakhir. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Buat penghitung string pengirim</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - dimulai pada cron pada hari ke-24 pukul 23.00. Cek apakah pengiriman otomatis diaktifkan, jika aktif - helm mengirim konter ke surat perusahaan pelayaran. Ternyata saya memiliki hari ke-24 sepanjang hari, sesuatu untuk diperbaiki atau hanya mengurangi pengiriman otomatis, jika terjadi kesalahan pada telegram. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Perbarui dengan komentar</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Putar katup</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Aturan untuk menutup / membuka keran sebulan sekali agar tidak mendidih. </font><font style="vertical-align: inherit;">Tanggal 25 jam 5 pagi - agar tidak masuk ke mesin pencuci piring atau mesin cuci, tetapi bahkan jika itu sampai di sana - itu tidak kritis, tumpang tindih air akan sekitar 3-4 detik. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dan hanya di sini rumah pintar dimulai ...</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Menggabungkan sistem dalam satu titik (openhab) memungkinkan Anda untuk membangun logika yang tidak tersedia untuk satu set sistem otonom. </font><font style="vertical-align: inherit;">Misalnya: peristiwa peningkatan meter air telah tiba - sistem keamanan aktif, kunci pintu depan ditutup, konsumsi energi mesin pencuci piring dan mesin cuci kurang dari 5 watt, yang berarti kebocoran telah terdeteksi oleh sensor. </font><font style="vertical-align: inherit;">Kami membentuk perintah untuk menutup crane, mengirim pesan ke bot di Telegram. </font><font style="vertical-align: inherit;">Tapi ini seperti utas nanti.</font></font></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id399459/">https://habr.com/ru/post/id399459/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id399449/index.html">DNA hanya setengah dari ukuran kromosom. Yang lainnya adalah cangkang fungsionalitas yang tidak diketahui</a></li>
<li><a href="../id399451/index.html">Mengapa kita tidak memiliki ingatan bayi</a></li>
<li><a href="../id399453/index.html">Lima bentuk uang blockchain tersedia sekarang</a></li>
<li><a href="../id399455/index.html">Bukan hanya peralatan rumah tangga: Apa lagi yang ada di Audiomania untuk pecinta musik, pecinta dan musisi</a></li>
<li><a href="../id399457/index.html">Pertemuan FinTech Rusia # 2: Berdagang di Era Digital</a></li>
<li><a href="../id399461/index.html">Kecerdasan buatan akan membantu orang menyingkirkan fobia dan ketakutan</a></li>
<li><a href="../id399463/index.html">Multicopter belajar duduk di atap mobil yang bergerak</a></li>
<li><a href="../id399469/index.html">Jaringan saraf Pix2pix secara realistis mewarnai sketsa pensil dan foto hitam putih</a></li>
<li><a href="../id399471/index.html">Hunian luar angkasa, bagian 5: bagaimana kita akan hidup dengan Merkurius (atau kita tidak akan)</a></li>
<li><a href="../id399473/index.html">Chip Intel 4004 berusia 45 tahun. Sedikit sejarah TI</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>