<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘©â€ğŸ‘¦â€ğŸ‘¦ ğŸ˜ ğŸ¤½ğŸ¼ åœ¨stm32f4-discoveryä¸Šçš„PPPOSå®ç° ğŸ‘¼ ğŸ‘©ğŸ»â€âš–ï¸ ğŸ‘¨ğŸ½â€ğŸ«</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="æœ‰ä¸€æ¬¡ï¼Œåœ¨æˆ‘ä¹‹å‰æœ‰ä¸€é¡¹ä»»åŠ¡æ˜¯åœ¨STM32ä¸Šæä¾›ä»…å…·æœ‰COMç«¯å£çš„Internetè®¿é—®ã€‚ ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘éœ€è¦PPPï¼Œæˆ–è€…ç¡®åˆ‡åœ°è¯´æ˜¯PPPoSï¼ˆä¸²è¡Œç‚¹å¯¹ç‚¹åè®®-å®ç°PPPçš„æ–¹æ³•ä¹‹ä¸€ï¼Œå½“é€šè¿‡COMç«¯å£è¿æ¥æ—¶ä½¿ç”¨å®ƒï¼‰ã€‚ 

 åœ¨è§£å†³æ‘†åœ¨æˆ‘é¢å‰çš„ä»»åŠ¡çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘é‡åˆ°äº†ä¸€äº›å›°éš¾ï¼Œæˆ‘è®¤ä¸ºå…¶ä¸­ä¹‹ä¸€æ˜¯å¯¹äº’è”ç½‘ä¸Š...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>åœ¨stm32f4-discoveryä¸Šçš„PPPOSå®ç°</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/419037/"> æœ‰ä¸€æ¬¡ï¼Œåœ¨æˆ‘ä¹‹å‰æœ‰ä¸€é¡¹ä»»åŠ¡æ˜¯åœ¨STM32ä¸Šæä¾›ä»…å…·æœ‰COMç«¯å£çš„Internetè®¿é—®ã€‚ ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘éœ€è¦PPPï¼Œæˆ–è€…ç¡®åˆ‡åœ°è¯´æ˜¯PPPoSï¼ˆä¸²è¡Œç‚¹å¯¹ç‚¹åè®®-å®ç°PPPçš„æ–¹æ³•ä¹‹ä¸€ï¼Œå½“é€šè¿‡COMç«¯å£è¿æ¥æ—¶ä½¿ç”¨å®ƒï¼‰ã€‚ <br><br> åœ¨è§£å†³æ‘†åœ¨æˆ‘é¢å‰çš„ä»»åŠ¡çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘é‡åˆ°äº†ä¸€äº›å›°éš¾ï¼Œæˆ‘è®¤ä¸ºå…¶ä¸­ä¹‹ä¸€æ˜¯å¯¹äº’è”ç½‘ä¸Šä¸PPPoSæœ‰å…³çš„é—®é¢˜çš„æŠ¥é“ä¸è¶³ã€‚ åœ¨æˆ‘çš„é€‚åº¦çŸ¥è¯†å…è®¸çš„èŒƒå›´å†…ï¼Œæˆ‘å°†é€šè¿‡è¿™ç¯‡æ–‡ç« å°è¯•ç¼©å°æŒ‡å®šçš„å·®è·ã€‚ <br><br> æœ¬æ–‡ä»‹ç»å¦‚ä½•ä»å¤´å¼€å§‹ä¸ºSystem Workbench for STM32åˆ›å»ºé¡¹ç›®ã€‚ æ˜¾ç¤ºä½¿ç”¨UARTçš„ç¤ºä¾‹ã€‚ æœ‰ç”¨äºå®ç°PPPçš„ä»£ç ç¤ºä¾‹ã€‚ å½“ç„¶ï¼Œè¿˜æœ‰å‘é™„è¿‘çš„è®¡ç®—æœºå‘é€æ¶ˆæ¯çš„ç¤ºä¾‹ã€‚ <br><a name="habracut"></a><br><h3> å¼•è¨€ </h3><br>  PPPï¼ˆç‚¹å¯¹ç‚¹åè®®ï¼‰æ˜¯OSIç½‘ç»œæ¨¡å‹çš„ä¸¤ç‚¹æ•°æ®é“¾æ¥åè®®ã€‚ å®ƒé€šå¸¸ç”¨äºåœ¨ä¸¤ä¸ªç½‘ç»œèŠ‚ç‚¹ä¹‹é—´å»ºç«‹ç›´æ¥é€šä¿¡ï¼Œå¹¶ä¸”å¯ä»¥æä¾›è¿æ¥èº«ä»½éªŒè¯ï¼ŒåŠ å¯†å’Œæ•°æ®å‹ç¼©ã€‚ ç”¨äºå¤šç§ç±»å‹çš„ç‰©ç†ç½‘ç»œï¼šç©ºè°ƒåˆ¶è§£è°ƒå™¨ç”µç¼†ï¼Œç”µè¯çº¿ï¼Œèœ‚çªç”µè¯ç­‰ã€‚ <br><br>  PPPåè®®çš„å­ç§ç±»é€šå¸¸å¾ˆå¤šï¼Œä¾‹å¦‚ä»¥å¤ªç½‘ä¸Šçš„ç‚¹å¯¹ç‚¹åè®®ï¼ˆPPPoEï¼‰ï¼Œç”¨äºé€šè¿‡ä»¥å¤ªç½‘ï¼ˆæœ‰æ—¶æ˜¯é€šè¿‡DSLï¼‰è¿›è¡Œè¿æ¥ï¼›  ATMä¸Šçš„ç‚¹å¯¹ç‚¹åè®®ï¼ˆPPPoAï¼‰ï¼Œç”¨äºé€šè¿‡ATMé€‚é…å±‚5ï¼ˆAAL5ï¼‰è¿›è¡Œè¿æ¥ï¼Œè¿™æ˜¯DSLçš„ä¸»è¦PPPoEæ›¿ä»£æ–¹æ¡ˆã€‚ <br><br>  PPPæ˜¯ä¸€ç³»åˆ—åè®®ï¼šé“¾è·¯æ§åˆ¶åè®®ï¼ˆLCPï¼‰ï¼Œç½‘ç»œæ§åˆ¶åè®®ï¼ˆNCPï¼‰ï¼Œèº«ä»½éªŒè¯åè®®ï¼ˆPAPï¼ŒCHAPï¼‰ï¼Œå¤šé€šé“PPPï¼ˆMLPPPï¼‰ã€‚ <br><br>  <i>æ¥è‡ªç»´åŸºç™¾ç§‘</i> ã€‚ <br><br><h3> å‡†å¤‡å·¥ä½œ </h3><br> ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦ï¼š <br><br><h4> é“ï¼š </h4><br><ol><li> è°ƒè¯•æ¿stm32f4_discoveryï¼š <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/u1/0k/6-/u10k6-una1bkmaphl4wlazibaca.jpeg"></div></li><li>  USBè‡³miniUSBé€‚é…å™¨ï¼Œç”¨äºå°†å¼€å‘æ¿è¿æ¥è‡³è®¡ç®—æœºã€‚ </li><li> ä¸¤ä¸ªUSBtoUART FT232é€‚é…å™¨ï¼š <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/uh/uk/mo/uhukmolq4_t-pckn8h2rjofspnu.png"></div></li><li> ä¸¤æ¡USBå»¶é•¿çº¿ä¹Ÿå¾ˆæœ‰ç”¨ï¼Œä¸ä¸€å®šï¼Œä½†å¾ˆæ–¹ä¾¿ã€‚ </li></ol><br><h4> è½¯ï¼š </h4><br><ol><li> è™šæ‹ŸæœºVirtualBoxã€‚ æ‚¨å¯ä»¥<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åœ¨æ­¤å¤„</a>ä¸‹è½½ã€‚ æˆ‘ä»¬è¿˜ä¸‹è½½å¹¶å®‰è£…VirtualBox <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ‰©å±•åŒ…</a> ã€‚ </li><li> ä¸¤ä¸ªå®‰è£…ç›˜ï¼Œåˆ†åˆ«å¸¦æœ‰Windowså’ŒLinuxæ“ä½œç³»ç»Ÿã€‚ æˆ‘ä»¬åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è¿™é‡Œ</a>ä½¿ç”¨Windowsï¼Œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åœ¨è¿™é‡Œä½¿ç”¨</a> Linuxã€‚ <br><br> å®‰è£…æ“ä½œç³»ç»Ÿåï¼Œæ‚¨å°†éœ€è¦ä¸ºæ¥å®¾æ“ä½œç³»ç»Ÿå®‰è£…é™„åŠ ç»„ä»¶ã€‚ å¯¹äºæˆ‘ä»¬æ‹¥æœ‰è¶³å¤Ÿå¤š32xç³»ç»Ÿçš„ä»»åŠ¡ï¼Œæ‚¨ä¸èƒ½æ— è§†è™šæ‹ŸåŒ–ã€‚ </li><li> å¯¹äºWindowsï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå¯ä»¥æ¥å—è¯·æ±‚å¹¶é€šè¿‡TCP / IPå“åº”çš„ç¨‹åºï¼Œä»¥åŠä¸€ä¸ªç”¨äºä½¿ç”¨COMç«¯å£çš„ç»ˆç«¯ç¨‹åºã€‚  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åœ¨æ­¤å¤„</a>ä¸‹è½½PacketSenderï¼ˆå•å‡»â€œä¸ï¼Œè°¢è°¢ï¼Œè®©æˆ‘ä¸‹è½½ã€‚â€ï¼‰ï¼Œç»ˆç«¯åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ­¤å¤„</a> ã€‚ æ­¤å¤–ï¼Œæˆ‘ä»¬éœ€è¦STM32CubeMXè¿›è¡Œé¡¹ç›®çš„åˆå§‹è®¾ç½®ã€‚ ä»st.comä¸‹è½½ï¼ˆæ³¨å†Œåï¼Œé“¾æ¥å°†é€šè¿‡ç”µå­é‚®ä»¶æä¾›ï¼‰ã€‚ </li><li> æˆ‘ä»¬å°†STM32çš„System Workbenchæ”¾åœ¨ä¸»æ“ä½œç³»ç»Ÿä¸Šã€‚  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä»è¿™é‡Œ</a>ä¸‹è½½ï¼ˆéœ€è¦æ³¨å†Œï¼‰ã€‚ </li></ol><br><h3> é˜¶æ®µ1.åˆ›å»ºé¡¹ç›® </h3><br> é¦–å…ˆï¼Œæ‰“å¼€STM32CubeMXå¹¶åœ¨é‚£é‡Œä¸ºæˆ‘ä»¬çš„stm32f4-discoveryæ¿åˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®ã€‚ æ‰“å¼€RCCï¼Œä»¥å¤ªç½‘ï¼ˆETHï¼‰ï¼ŒSYSï¼ŒUSART2ï¼ŒUSART3ï¼Œç„¶åæ‰“å¼€FREERTOSå’ŒLWIPã€‚ <br><br><img src="https://habrastorage.org/webt/vr/jk/ve/vrjkveavft5ry-oasa7h2e07rwe.png"><br><img src="https://habrastorage.org/webt/9c/v2/rv/9cv2rv-_8yf5w67mr7bw7ynp1vk.png"><br><br> ä¸ºäº†è¿›è¡Œè¯Šæ–­ï¼Œæˆ‘ä»¬éœ€è¦æ¿ä¸Šæœ‰LEDã€‚ ä¸ºæ­¤ï¼Œå°†PD12-PD15çš„æ”¯è·¯é…ç½®ä¸ºGPIO_Outputã€‚ <br><br><img src="https://habrastorage.org/webt/-s/bb/lk/-sbblkybmbdz1wrftiow38tq4eg.png"><br><br> åœ¨â€œæ—¶é’Ÿé…ç½®â€é€‰é¡¹å¡ä¸Šï¼Œè®¾ç½®é¢‘ç‡ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ <br><br><img src="https://habrastorage.org/webt/sd/cc/qy/sdccqyreetba7g_m8yq_gypc-ge.png"><br><br> æ¥ä¸‹æ¥ï¼Œåœ¨â€œé…ç½®â€é€‰é¡¹å¡ä¸Šï¼Œé…ç½®USARTç«¯å£ã€‚ æˆ‘ä»¬å°†ä»¥DMAæ¨¡å¼ä¸ä»–ä»¬åˆä½œã€‚ æˆ‘ä»¬æœ‰ä¸¤ä¸ªUSARTç«¯å£ï¼Œä¸€ä¸ªç”¨äºé€šè¿‡PPPä¼ è¾“å’Œæ¥æ”¶æ•°æ®ï¼Œå¦ä¸€ä¸ªç”¨äºè®°å½•ã€‚ ä¸ºäº†ä½¿å®ƒä»¬å·¥ä½œï¼Œæˆ‘ä»¬éœ€è¦åœ¨ä¸¤ä¸ªç«¯å£çš„RXå’ŒTXä¸Šé…ç½®DMAã€‚ å¯¹äºæ‰€æœ‰DMAè°ƒæ•´åˆ†æ”¯ï¼Œå°†â€œä¸­â€è®¾ç½®ä¸ºä¼˜å…ˆçº§ã€‚ å¯¹äºUSART2æ”¯è„šRXï¼Œå°†æ¨¡å¼è®¾ç½®ä¸ºâ€œåœ†å½¢â€ã€‚ å…¶ä½™è®¾ç½®é»˜è®¤ä¸ºä¿ç•™ã€‚ <br><br><img src="https://habrastorage.org/webt/96/s8/9u/96s89uloxfrdtxd0scqvcyb-zng.png"><br><br> æ‚¨è¿˜éœ€è¦åœ¨â€œ NVICè®¾ç½®â€é€‰é¡¹å¡ä¸Šä¸ºä¸¤ä¸ªç«¯å£å¯ç”¨å…¨å±€ä¸­æ–­ã€‚ <br><br> è¿™æ ·å°±å®Œæˆäº†STM32CubeMXä¸­é¡¹ç›®çš„åˆå§‹è®¾ç½®ã€‚ æˆ‘ä»¬ä¿å­˜é¡¹ç›®æ–‡ä»¶ï¼Œå¹¶ä¸ºSTM32çš„System Workbenchè¿›è¡Œä»£ç ç”Ÿæˆã€‚ <br><br><img src="https://habrastorage.org/webt/ss/_d/8l/ss_d8lzdxneoj5mjasvmyhhhxiu.png"><br><br><h4> å®ä½œ </h4><br> ç°åœ¨ï¼Œè®©æˆ‘ä»¬éªŒè¯ä¸‹è½½çš„ä»£ç æ˜¯å¦å¯ä»¥ç¼–è¯‘å’Œè¿è¡Œã€‚ ä¸ºæ­¤ï¼Œåœ¨â€œ StartDefaultTaskâ€å‡½æ•°çš„main.cæ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬ç”¨LEDçš„æ‰“å¼€å’Œå…³é—­ä»£ç æ›¿æ¢äº†forï¼ˆ;;ï¼‰å¾ªç¯çš„ä¸»ä½“ã€‚ <br><br> åº”è¯¥æ˜¯è¿™æ ·çš„ï¼š <br><br><pre><code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* StartDefaultTask function */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">StartDefaultTask</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * argument)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/* init code for LWIP */</span></span> MX_LWIP_Init(); <span class="hljs-comment"><span class="hljs-comment">/* USER CODE BEGIN 5 */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* Infinite loop */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(;;) { HAL_GPIO_WritePin(GPIOD, GPIO_PIN_12|GPIO_PIN_13|GPIO_PIN_14|GPIO_PIN_15, GPIO_PIN_SET); osDelay(<span class="hljs-number"><span class="hljs-number">1000</span></span>); HAL_GPIO_WritePin(GPIOD, GPIO_PIN_12|GPIO_PIN_13|GPIO_PIN_14|GPIO_PIN_15, GPIO_PIN_RESET); osDelay(<span class="hljs-number"><span class="hljs-number">1000</span></span>); } <span class="hljs-comment"><span class="hljs-comment">/* USER CODE END 5 */</span></span> }</code> </pre> <br> æˆ‘ä»¬ç¼–è¯‘å›ºä»¶å¹¶æŸ¥çœ‹ã€‚ æ¿ä¸Šçš„æ‰€æœ‰å››ä¸ªLEDå‡åº”é—ªçƒã€‚ <br><br><h3> ç¬¬2é˜¶æ®µã€‚ä¸USARTåˆä½œ </h3><br> æˆ‘ä»¬çš„ä¸‹ä¸€ä¸ªä»»åŠ¡æ˜¯éªŒè¯USARTçš„æ­£ç¡®æ“ä½œã€‚ <br><br> æˆ‘ä»¬éœ€è¦åšçš„ç¬¬ä¸€ä»¶äº‹æ˜¯å°†FT232è¿æ¥åˆ°å‘ç°è®¾å¤‡ã€‚ ä¸ºæ­¤ï¼Œè¯·æŸ¥çœ‹USARTæ¥å£ç¦»å©šçš„é‚£æ¡è…¿ã€‚ æˆ‘åˆ†åˆ«ä¸ºUSART2_RXå’ŒUSART2_TXä½¿ç”¨PD6å’ŒPD5ã€‚ <br><br><img src="https://habrastorage.org/webt/qj/yh/yo/qjyhyoohdofxtqedphuhzq7qcac.png"><br><br> ä»¥åŠUSART3_RXå’ŒUSART3_TXçš„PD9å’ŒPD8ã€‚ <br><br><img src="https://habrastorage.org/webt/37/bf/om/37bfomzqqcapediljrf14flpuiu.png"><br><br> å¦å¤–ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªGNDè„šã€‚ <br><br> æˆ‘ä»¬åœ¨æ¿ä¸Šæ‰¾åˆ°äº†è¿™äº›å¼•è„šå¹¶å°†å®ƒä»¬è¿æ¥åˆ°FT232å¼•è„šï¼Œè€Œæ¿ä¸Šçš„GNDå¼•è„šå¯ä»¥æ˜¯ä»»æ„å¼•è„šï¼Œæ¿ä¸Šçš„RXå¼•è„šå¿…é¡»è¿æ¥åˆ°FT232çš„TXå¼•è„šï¼Œå¹¶ä¸”æ¿ä¸Šçš„TXå¼•è„šå¿…é¡»è¿æ¥åˆ°FT232çš„RXå¼•è„šã€‚ å…¶ä½™ç»“è®ºæœªä½¿ç”¨ã€‚ <br><br> ä»ç„¶å¯ä»¥å°†FT232è¿æ¥åˆ°è®¡ç®—æœºçš„USBç«¯å£ï¼Œä»¥åŠé€šè¿‡miniUSBè¿æ¥å™¨å°†å‘ç°æ¿æœ¬èº«è¿æ¥åˆ°è®¡ç®—æœºï¼ˆä¸è¦ä¸microUSBæ··æ·†ï¼‰ã€‚ <br><br> è¿æ¥FT232åï¼Œä¸»æ“ä½œç³»ç»Ÿå°†ä¸ºå…¶å®‰è£…é©±åŠ¨ç¨‹åºï¼Œç„¶åå°†è¿™äº›è®¾å¤‡è½¬å‘è‡³è™šæ‹Ÿæœºä¸Šçš„Windowsæ¥å®¾ã€‚ <br><br> ç°åœ¨ï¼Œæˆ‘ä»¬æ·»åŠ äº†USARTè¿è¡Œæ‰€éœ€çš„ç¨‹åºä»£ç ã€‚ ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†æ·»åŠ å››ä¸ªæ–‡ä»¶ï¼šusart.hï¼Œusart.cï¼Œlogger.hï¼Œlogger.cã€‚ <br><br> æ–‡ä»¶å†…å®¹ï¼š <br><br>  <b>usart.hæ–‡ä»¶</b> <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> _USART_ #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _USART_ #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"stm32f4xx_hal.h"</span></span></span><span class="hljs-meta"> void usart_Open(void); bool usart_Send(char* bArray, int size_bArray); uint16_t usart_Recv(char* bArray, uint16_t maxLength); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* _USART_ */</span></span></span></span></code> </pre><br>  <b>usart.cæ–‡ä»¶</b> <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"usart.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"logger.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"cmsis_os.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> Q_USART2_SIZE 200 xQueueHandle g_qUsart; osThreadId g_usart_rxTaskHandle; extern UART_HandleTypeDef huart2; void usart_rxTask(void); uint8_t bGet[Q_USART2_SIZE] = {0}; uint16_t g_tail = 0; void usart_Open(void) { g_qUsart = xQueueCreate( Q_USART2_SIZE, sizeof( unsigned char ) ); osThreadDef(usart_rxTask_NAME, usart_rxTask, osPriorityNormal, 0, Q_USART2_SIZE/4+128); g_usart_rxTaskHandle = osThreadCreate(osThread(usart_rxTask_NAME), NULL); HAL_UART_Receive_DMA(&amp;huart2, bGet, Q_USART2_SIZE); } void usart_rxTask(void) { for(;;) { uint16_t length = Q_USART2_SIZE - huart2.hdmarx-&gt;Instance-&gt;NDTR; while(length - g_tail) { uint8_t tmp = bGet[g_tail]; xQueueSendToBack( g_qUsart, &amp;tmp, 100 ); g_tail++; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (g_tail == Q_USART2_SIZE) g_tail = 0; } } } bool usart_Send(char* bArray, int size_bArray) { HAL_StatusTypeDef status; status = HAL_UART_Transmit_DMA(&amp;huart2, bArray, size_bArray); while (HAL_UART_GetState(&amp;huart2) != HAL_UART_STATE_READY) { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (HAL_UART_GetState(&amp;huart2) == HAL_UART_STATE_BUSY_RX) break; osDelay(1); } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (status == HAL_OK) return true; return false; } uint16_t usart_Recv(char* bArray, uint16_t maxLength) { uint8_t tmp = 0; uint16_t length = 0; while(uxQueueMessagesWaiting(g_qUsart)) { xQueueReceive( g_qUsart, &amp;tmp, 100 ); bArray[length] = tmp; length++; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (length &gt;= maxLength) break; } return length; }</span></span></code> </pre><br>  <b>logger.hæ–‡ä»¶</b> <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> _LOGGER_ #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _LOGGER_ void logger(const char *format, ...); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* _LOGGER_ */</span></span></span></span></code> </pre><br>  <b>logger.cæ–‡ä»¶</b> <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"logger.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"stm32f4xx_hal.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdarg.h&gt; extern UART_HandleTypeDef huart3; #define MAX_STRING_SIZE 1024 HAL_StatusTypeDef logger_Send(char* bArray, uint32_t size_bArray) { HAL_StatusTypeDef status; for(int i=0;i&lt;5;i++) { status = HAL_UART_Transmit_DMA(&amp;huart3, bArray, size_bArray); if (status == HAL_OK) break; osDelay(2); } while (HAL_UART_GetState(&amp;huart3) != HAL_UART_STATE_READY) { osDelay(1); } return status; } void logger(const char *format, ...) { char buffer[MAX_STRING_SIZE]; va_list args; va_start (args, format); vsprintf(buffer, format, args); va_end(args); buffer[MAX_STRING_SIZE-1]=0; logger_Send(buffer, strlen(buffer)); }</span></span></span></span></code> </pre><br> æˆ‘ä»¬éœ€è¦usartåœ¨usart2ä¸Šå‘é€å’Œæ¥æ”¶æ•°æ®ã€‚ è¿™å°†æ˜¯æˆ‘ä»¬ä¸PPPæœåŠ¡å™¨é€šä¿¡çš„ä¸»è¦ç•Œé¢ã€‚ <br><br> æˆ‘ä»¬éœ€è¦Loggeré€šè¿‡å‘ç»ˆç«¯å‘é€æ¶ˆæ¯æ¥å®ç°æ—¥å¿—è®°å½•ã€‚  void usart_Openï¼ˆvoidï¼‰å‡½æ•°å½¢æˆä¸€ä¸ªé˜Ÿåˆ—ï¼Œå¹¶å¼€å§‹ä¸ºè¯¥é˜Ÿåˆ—æä¾›æœåŠ¡ã€‚ ä½¿ç”¨USARTä¹‹å‰å¿…é¡»å®Œæˆæ­¤åŠŸèƒ½ã€‚ ç„¶åä¸€åˆ‡éƒ½å˜å¾—å¾ˆç®€å•ï¼Œbool usart_Sendå‡½æ•°ï¼ˆchar * bArrayï¼Œint size_bArrayï¼‰å°†æ•°æ®å‘é€åˆ°ç«¯å£ï¼Œå¹¶ä¸” <br>  uint16_t usart_Recvï¼ˆchar * bArrayï¼Œuint16_t maxLengthï¼‰ä»void usart_rxTaskï¼ˆvoidï¼‰å‡½æ•°å·²æ·»åŠ å®ƒä»¬çš„é˜Ÿåˆ—ä¸­è·å–å®ƒä»¬ã€‚ <br><br> å¯¹äºè®°å½•å™¨ï¼Œå®ƒä»ç„¶æ›´ç®€å•ï¼›ä¸éœ€è¦è·å–æ•°æ®ï¼Œå› æ­¤ï¼Œä¸éœ€è¦é˜Ÿåˆ—æˆ–é˜Ÿåˆ—ç»´æŠ¤ä»»åŠ¡ã€‚ <br><br> åœ¨<b>main.h</b>æ–‡ä»¶çš„å¼€å¤´ï¼Œ <b>æ‚¨</b>éœ€è¦æ·»åŠ ä¸€äº›æè¿°boolç±»å‹çš„å®šä¹‰ï¼Œè¿™åœ¨Cè¯­è¨€ä¸­ä¸å¯ç”¨ã€‚ <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* USER CODE BEGIN Includes */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>; <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> true 1 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> false 0 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* USER CODE END Includes */</span></span></span></span></code> </pre><br> ç°åœ¨è¯¥æ£€æŸ¥ç»“æœä»£ç çš„åŠŸèƒ½äº†ã€‚ ä¸ºæ­¤ï¼Œè¯·åœ¨<b>main.c</b>æ–‡ä»¶ä¸­ï¼Œæ›´æ”¹å·²çŸ¥ä»»åŠ¡â€œ StartDefaultTaskâ€çš„ä»£ç  <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* USER CODE BEGIN 4 */</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"usart.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"logger.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MAX_MESSAGE_LENGTH 100 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* USER CODE END 4 */</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* StartDefaultTask function */</span></span></span><span class="hljs-meta"> void StartDefaultTask(void const * argument) { </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* init code for LWIP */</span></span></span><span class="hljs-meta"> MX_LWIP_Init(); </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* USER CODE BEGIN 5 */</span></span></span><span class="hljs-meta"> usart_Open(); </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Infinite loop */</span></span></span><span class="hljs-meta"> uint8_t send[] = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Send message\r\n"</span></span></span><span class="hljs-meta">; uint8_t recv[MAX_MESSAGE_LENGTH] = {0}; uint16_t recvLength = 0; for(;;) { HAL_GPIO_WritePin(GPIOD, GPIO_PIN_12|GPIO_PIN_13|GPIO_PIN_14|GPIO_PIN_15, GPIO_PIN_SET); osDelay(1000); HAL_GPIO_WritePin(GPIOD, GPIO_PIN_12|GPIO_PIN_13|GPIO_PIN_14|GPIO_PIN_15, GPIO_PIN_RESET); osDelay(1000); </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (usart_Send(send, sizeof(send)-1)) logger(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"SEND - %s"</span></span></span><span class="hljs-meta">, send); recvLength = usart_Recv(recv, MAX_MESSAGE_LENGTH-1); </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (recvLength) { recv[recvLength] = 0; logger(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"RECV - %s\r\n"</span></span></span><span class="hljs-meta">, recv); } } </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* USER CODE END 5 */</span></span></span><span class="hljs-meta"> }</span></span></code> </pre><br> å¦å¤–ï¼Œæˆ‘ä»¬éœ€è¦ç»™ä»»åŠ¡å †æ ˆæ›´å¤šçš„å†…å­˜ã€‚ ä¸ºæ­¤ï¼Œåœ¨è°ƒç”¨osThreadDefï¼ˆï¼‰å‡½æ•°main.cæ–‡ä»¶æ—¶ï¼Œæ‚¨éœ€è¦é€šè¿‡128 * 10æ¥ä¿®å¤128 * 10ï¼š <br><br><pre> <code class="hljs lisp">osThreadDef(<span class="hljs-name"><span class="hljs-name">defaultTask</span></span>, StartDefaultTask, osPriorityNormal, <span class="hljs-number"><span class="hljs-number">0</span></span>, &lt;b&gt;128*10&lt;/b&gt;)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br> æˆ‘ä»¬ç¼–è¯‘å¹¶åˆ·æ–°ã€‚  LEDé—ªçƒçš„æ–¹å¼ä¸ä¸Šä¸€ä¸ªä»»åŠ¡ç›¸åŒã€‚ <br><br> è¦æŸ¥çœ‹æˆ‘ä»¬çš„å·¥ä½œç»“æœï¼Œæ‚¨éœ€è¦åœ¨æˆ‘ä»¬çš„è™šæ‹Ÿæœºä¸­è¿è¡ŒTerminalç¨‹åºã€‚ ç¨‹åºçš„ä¸€ä¸ªå®ä¾‹ç”¨äºè®°å½•ç«¯å£ï¼Œç¬¬äºŒä¸ªå®ä¾‹ç”¨äºä¸»ç¨‹åºã€‚ åœ¨è®¾å¤‡ç®¡ç†å™¨ä¸­æŸ¥çœ‹ä¸ºæ‚¨çš„FT232åˆ†é…äº†å“ªäº›ç«¯å£å·ã€‚ å¦‚æœåˆ†é…çš„æ•°å­—è¶…è¿‡10ï¼Œè¯·é‡æ–°åˆ†é…ã€‚ <br><br> å½“æ‚¨å¯åŠ¨è¯¥ç¨‹åºçš„ç¬¬äºŒä¸ªå®ä¾‹æ—¶ï¼Œå¯èƒ½ä¼šå‘ç”Ÿé”™è¯¯ï¼Œè¯·å…³é—­è¯¥é”™è¯¯çª—å£å¹¶ç»§ç»­ä½¿ç”¨è¯¥ç¨‹åºã€‚ <br><br> å¯¹äºè¿™ä¸¤ä¸ªç«¯å£ï¼Œæˆ‘ä»¬ä»¥115200æ³¢ç‰¹å»ºç«‹è¿æ¥ï¼Œæ•°æ®ä½-8ï¼Œå¥‡å¶æ ¡éªŒ-æ— ï¼Œåœæ­¢ä½-1ï¼Œæ¡æ‰‹-æ— ã€‚ <br><br> å¦‚æœæ‚¨æ­£ç¡®æ‰§è¡Œäº†æ‰€æœ‰æ“ä½œï¼Œåˆ™å°†åœ¨usart2çš„ç»ˆç«¯çª—å£ä¸­å‘é€â€œå‘é€æ¶ˆæ¯â€æ¶ˆæ¯ã€‚ åŒä¸€æ¡æ¶ˆæ¯å°†åœ¨è®°å½•å™¨çš„ç»ˆç«¯çª—å£ä¸­é‡å¤ï¼Œä»…å¸¦æœ‰å‰ç¼€â€œ SEND-â€ <br><br> å¦‚æœåœ¨usart2çš„ç»ˆç«¯çª—å£ä¸­ï¼Œåœ¨â€œå‘é€â€å­—æ®µä¸­é”®å…¥ä¸€äº›æ–‡æœ¬ï¼Œç„¶åå•å‡»è¯¥å­—æ®µå³ä¾§çš„ç›¸åº”æŒ‰é’®ï¼Œåˆ™åœ¨è®°å½•å™¨çª—å£ä¸­ï¼Œæ‚¨å°†çœ‹åˆ°å¸¦æœ‰å‰ç¼€â€œ RECV-â€çš„ç›¸åŒæ¶ˆæ¯ã€‚ <br><br> åœ¨ä¸‹å›¾ä¸­ï¼šå·¦è¾¹æ˜¯è®°å½•å™¨ï¼Œå³è¾¹æ˜¯usart2ã€‚ <br><br><img src="https://habrastorage.org/webt/k5/v6/hc/k5v6hcxebj6hfdgbitfwyzs1ffw.png"><br><br><h3> é˜¶æ®µ3ã€‚PPPå…¥é—¨ </h3><br> ä½œä¸ºæ­¤ä»»åŠ¡çš„ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†å»ºç«‹PPPè¿æ¥ã€‚ é¦–å…ˆï¼Œå¯ç”¨PPPä½¿ç”¨ï¼Œå°†ppp_opts.hæ–‡ä»¶ä¸­çš„PPP_SUPPORTå®šä¹‰çš„å€¼æ›´æ”¹ä¸º1ã€‚ç„¶åï¼Œåœ¨lwipopts.hæ–‡ä»¶ä¸­é‡æ–°å®šä¹‰å¿…è¦çš„å®šä¹‰ï¼Œ <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* USER CODE BEGIN 1 */</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MEMP_NUM_SYS_TIMEOUT 8 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CHECKSUM_GEN_IP 1 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CHECKSUM_GEN_TCP 1 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* USER CODE END 1 */</span></span></span></span></code> </pre><br> åŒæ—¶ï¼Œæ—§çš„å®šä¹‰éœ€è¦è¢«æ³¨é‡Šæ‰ã€‚ <br><br> ç°åœ¨ï¼Œæˆ‘ä»¬ä¿®æ”¹lwip.cæ–‡ä»¶ï¼Œå°†ä»¥ä¸‹ä»£ç æ’å…¥â€œ / * USER CODE BEGIN 0 * /â€å—ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* USER CODE BEGIN 0 */</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"usart.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"pppos.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"sio.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"dns.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ppp.h"</span></span></span><span class="hljs-meta"> static ppp_pcb *ppp; struct netif pppos_netif; void PppGetTask(void const * argument) { uint8_t recv[2048]; uint16_t length = 0; for(;;) { length=usart_Recv(recv, 2048); </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (length) { pppos_input(ppp, recv, length); logger(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"read - PppGetTask() len = %d\n"</span></span></span><span class="hljs-meta">, length); } osDelay(10); } } #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ip4_addr.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"dns.h"</span></span></span><span class="hljs-meta"> static void ppp_link_status_cb(ppp_pcb *pcb, int err_code, void *ctx) { struct netif *pppif = ppp_netif(pcb); LWIP_UNUSED_ARG(ctx); switch(err_code) { case PPPERR_NONE: </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* No error. */</span></span></span><span class="hljs-meta"> { logger(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ppp_link_status_cb: PPPERR_NONE\n\r"</span></span></span><span class="hljs-meta">); logger(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">" our_ip4addr = %s\n\r"</span></span></span><span class="hljs-meta">, ip4addr_ntoa(netif_ip4_addr(pppif))); logger(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">" his_ipaddr = %s\n\r"</span></span></span><span class="hljs-meta">, ip4addr_ntoa(netif_ip4_gw(pppif))); logger(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">" netmask = %s\n\r"</span></span></span><span class="hljs-meta">, ip4addr_ntoa(netif_ip4_netmask(pppif))); } break; case PPPERR_PARAM: </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Invalid parameter. */</span></span></span><span class="hljs-meta"> logger(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ppp_link_status_cb: PPPERR_PARAM\n"</span></span></span><span class="hljs-meta">); break; case PPPERR_OPEN: </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Unable to open PPP session. */</span></span></span><span class="hljs-meta"> logger(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ppp_link_status_cb: PPPERR_OPEN\n"</span></span></span><span class="hljs-meta">); break; case PPPERR_DEVICE: </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Invalid I/O device for PPP. */</span></span></span><span class="hljs-meta"> logger(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ppp_link_status_cb: PPPERR_DEVICE\n"</span></span></span><span class="hljs-meta">); break; case PPPERR_ALLOC: </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Unable to allocate resources. */</span></span></span><span class="hljs-meta"> logger(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ppp_link_status_cb: PPPERR_ALLOC\n"</span></span></span><span class="hljs-meta">); break; case PPPERR_USER: </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* User interrupt. */</span></span></span><span class="hljs-meta"> logger(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ppp_link_status_cb: PPPERR_USER\n"</span></span></span><span class="hljs-meta">); break; case PPPERR_CONNECT: </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Connection lost. */</span></span></span><span class="hljs-meta"> logger(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ppp_link_status_cb: PPPERR_CONNECT\n"</span></span></span><span class="hljs-meta">); break; case PPPERR_AUTHFAIL: </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Failed authentication challenge. */</span></span></span><span class="hljs-meta"> logger(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ppp_link_status_cb: PPPERR_AUTHFAIL\n"</span></span></span><span class="hljs-meta">); break; case PPPERR_PROTOCOL: </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Failed to meet protocol. */</span></span></span><span class="hljs-meta"> logger(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ppp_link_status_cb: PPPERR_PROTOCOL\n"</span></span></span><span class="hljs-meta">); break; case PPPERR_PEERDEAD: </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Connection timeout. */</span></span></span><span class="hljs-meta"> logger(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ppp_link_status_cb: PPPERR_PEERDEAD\n"</span></span></span><span class="hljs-meta">); break; case PPPERR_IDLETIMEOUT: </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Idle Timeout. */</span></span></span><span class="hljs-meta"> logger(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ppp_link_status_cb: PPPERR_IDLETIMEOUT\n"</span></span></span><span class="hljs-meta">); break; case PPPERR_CONNECTTIME: </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* PPPERR_CONNECTTIME. */</span></span></span><span class="hljs-meta"> logger(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ppp_link_status_cb: PPPERR_CONNECTTIME\n"</span></span></span><span class="hljs-meta">); break; case PPPERR_LOOPBACK: </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Connection timeout. */</span></span></span><span class="hljs-meta"> logger(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ppp_link_status_cb: PPPERR_LOOPBACK\n"</span></span></span><span class="hljs-meta">); break; default: logger(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ppp_link_status_cb: unknown errCode %d\n"</span></span></span><span class="hljs-meta">, err_code); break; } } </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// Callback used by ppp connection static u32_t ppp_output_cb(ppp_pcb *pcb, u8_t *data, u32_t len, void *ctx) { LWIP_UNUSED_ARG(pcb); LWIP_UNUSED_ARG(ctx); if (len &gt; 0) { if (!usart_Send(data, len)) return 0x05; } logger("write - ppp_output_cb() len = %d\n", len); return len; } void pppConnect(void) { ppp = pppos_create(&amp;pppos_netif, ppp_output_cb, ppp_link_status_cb, NULL); ppp_set_default(ppp); osThreadId PppGetTaskHandle; osThreadDef(PPP_GET_TASK_NAME, PppGetTask, osPriorityNormal, 0, 128*10); PppGetTaskHandle = osThreadCreate(osThread(PPP_GET_TASK_NAME), NULL); err_t err = ppp_connect(ppp,0); if (err == ERR_ALREADY) { logger("Connected successfully"); } for(int i=0;i&lt;40;i++) { osDelay(500); if (ppp-&gt;phase &gt;= PPP_PHASE_RUNNING) break; } } /* USER CODE END 0 */</span></span></span></span></code> </pre><br> ç„¶åï¼Œåœ¨å‡½æ•°MX_LWIP_Initï¼ˆï¼‰ä¸­çš„â€œ / * USER CODE BEGIN 3 * /â€å—ä¸­ï¼Œå°†è°ƒç”¨æ·»åŠ åˆ°pppConnectï¼ˆï¼‰å‡½æ•°ã€‚ <br><br> æ­¤å¤–ï¼Œæ‚¨éœ€è¦å¢åŠ å †å¤§å°ï¼Œä¸ºæ­¤ï¼Œåœ¨FreeRTOSConfig.hæ–‡ä»¶ä¸­ï¼Œéœ€è¦æ³¨é‡Šæ‰configTOTAL_HEAP_SIZEå®šä¹‰ï¼Œç„¶ååœ¨æ–‡ä»¶æœ«å°¾çš„/ * USER CODE BEGINå®šä¹‰* /å—ä¸­ç”¨æ–°å€¼å£°æ˜å®ƒã€‚ <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* USER CODE BEGIN Defines */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* Section where parameter definitions can be added (for instance, to override default ones in FreeRTOS.h) */</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> configTOTAL_HEAP_SIZE ((size_t)1024*30) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* USER CODE END Defines */</span></span></span></span></code> </pre><br> å¦å¤–ï¼Œåœ¨usart.cæ–‡ä»¶ä¸­ï¼Œå°†Q_USART2_SIZEå®šä¹‰çš„å€¼æ›´æ”¹ä¸º2048ã€‚ <br><br> è¿æ¥è®¾ç½®ä»MX_LWIP_Initï¼ˆï¼‰å‡½æ•°å¼€å§‹ï¼›å®ƒæ˜¯è‡ªåŠ¨åˆ›å»ºçš„ï¼›æˆ‘ä»¬åˆšåˆšåœ¨å…¶ä¸­æ·»åŠ äº†å¯¹pppConnectï¼ˆï¼‰å‡½æ•°çš„è°ƒç”¨ã€‚ åœ¨æ­¤åŠŸèƒ½ä¸­ï¼Œå¯åŠ¨æœåŠ¡PPPOSè¿æ¥çš„ä»»åŠ¡ã€‚ éœ€è¦å‘pppos_createï¼ˆï¼‰å‡½æ•°ä¼ é€’å‡½æ•°çš„åœ°å€ï¼Œè¿™äº›åœ°å€å°†ç”¨äºå‘é€æ¶ˆæ¯ä»¥åŠè¾“å‡ºæœ‰å…³æ›´æ”¹è¿æ¥çŠ¶æ€çš„ä¿¡æ¯ã€‚ å¯¹äºæˆ‘ä»¬æ¥è¯´ï¼Œè¿™äº›åˆ†åˆ«æ˜¯å‡½æ•°ppp_output_cbï¼ˆï¼‰å’Œppp_link_status_cbï¼ˆï¼‰ã€‚ å¦å¤–ï¼ŒpppConnectï¼ˆï¼‰å‡½æ•°å°†å¯åŠ¨ä¸ºæ¥æ”¶åˆ°çš„æ¶ˆæ¯æä¾›æœåŠ¡çš„ä»»åŠ¡ã€‚ æ“ä½œç»“æŸæ—¶ï¼ŒpppConnectï¼ˆï¼‰å‡½æ•°å°†ç­‰å¾…ä¸æœåŠ¡å™¨å»ºç«‹è¿æ¥ï¼Œç„¶åå®Œæˆå…¶æ“ä½œã€‚ <br><br> ä¸€æ—¦LWIPå†³å®šæœ‰å¿…è¦å‘ç½‘ç»œå‘é€æ¶ˆæ¯æ—¶ï¼Œå°†åœ¨æ›´é«˜å±‚æ¬¡ä¸Šè¿›è¡Œç½‘ç»œå·¥ä½œï¼Œppp_output_cbï¼ˆï¼‰å‡½æ•°å°†è¢«è‡ªåŠ¨è°ƒç”¨ã€‚ æ¥è‡ªç½‘ç»œçš„å“åº”å°†ç”±PppGetTaskï¼ˆï¼‰å‡½æ•°æ¥æ”¶ï¼Œä½œä¸ºå¤„ç†ä¼ å…¥æ¶ˆæ¯çš„ä»»åŠ¡çš„ä¸€éƒ¨åˆ†ï¼Œå¹¶ä¼ è¾“åˆ°LWIPçš„è‚ å­ä¸­ã€‚ å¦‚æœè¿æ¥çŠ¶æ€æ›´æ”¹ï¼Œåˆ™å°†è‡ªåŠ¨è°ƒç”¨ppp_link_status_cbï¼ˆï¼‰å‡½æ•°ã€‚ <br><br> æœ€åï¼Œæˆ‘ä»¬å°†ä¿®æ”¹StartDefaultTaskä»»åŠ¡ã€‚ ç°åœ¨çœ‹èµ·æ¥åº”è¯¥åƒè¿™æ ·ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">StartDefaultTask</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * argument)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/* init code for LWIP */</span></span> <span class="hljs-comment"><span class="hljs-comment">// MX_LWIP_Init(); /* USER CODE BEGIN 5 */ usart_Open(); MX_LWIP_Init(); /* Infinite loop */ for(;;) { HAL_GPIO_WritePin(GPIOD, GPIO_PIN_12|GPIO_PIN_13|GPIO_PIN_14|GPIO_PIN_15, GPIO_PIN_SET); osDelay(1000); HAL_GPIO_WritePin(GPIOD, GPIO_PIN_12|GPIO_PIN_13|GPIO_PIN_14|GPIO_PIN_15, GPIO_PIN_RESET); osDelay(1000); } /* USER CODE END 5 */ }</span></span></code> </pre><br> å®Œæˆåï¼Œæ‚¨å¯ä»¥ç¼–è¯‘å¹¶åˆ·æ–°ã€‚ <br><br> æ­¤æ—¶ï¼Œæ‚¨éœ€è¦å¯åŠ¨PPPæœåŠ¡å™¨ã€‚ ä¸ºæ­¤ï¼Œæ‚¨å¿…é¡»é¦–å…ˆä½¿ç”¨Linuxéƒ¨ç½²è™šæ‹Ÿæœºã€‚ æˆ‘ä½¿ç”¨Ubuntu 16.04 x32ã€‚ å®‰è£…æ“ä½œç³»ç»Ÿåï¼Œéœ€è¦é…ç½®ä½¿ç”¨COMç«¯å£ã€‚ <br><br> åœ¨è¿™ä¸€éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬ä¸éœ€è¦å¸¦æœ‰Windowsçš„è™šæ‹Ÿæœºï¼Œæˆ‘ä»¬å¯ä»¥å®‰å…¨åœ°å°†å…¶å…³é—­ã€‚ æˆ‘ä»¬åœ¨Linuxä¸­éƒ½è¿æ¥äº†FT232ã€‚ <br><br> åœ¨Linuxä¸­ï¼Œåœ¨å¼€å§‹ä½¿ç”¨COMç«¯å£ä¹‹å‰ï¼Œå¿…é¡»å…è®¸ç”¨æˆ·ä½¿ç”¨å®ƒã€‚ ä¸ºæ­¤ï¼Œè¯·æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">sudo</span></span> addgroup USERNAME dialout</code> </pre> <br> å…¶ä¸­USERNAMEæ˜¯å½“å‰ç”¨æˆ·çš„åç§°ã€‚ <br><br> è¦æŸ¥çœ‹COMç³»ç»Ÿä¸­çš„å¯ç”¨ç«¯å£ï¼Œæ‚¨éœ€è¦è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š <br><br><pre> <code class="hljs perl">dmesg | <span class="hljs-keyword"><span class="hljs-keyword">grep</span></span> tty</code> </pre> <br><img src="https://habrastorage.org/webt/zc/h4/mp/zch4mpfwyybln76dl1jnhpxjt0s.png"><br><br> æˆ‘ä»¬çœ‹åˆ°ç³»ç»Ÿä¸­æœ‰ä¸¤ä¸ªttyUSBç«¯å£ã€‚ æˆ‘ä»¬ä¸èƒ½ç«‹å³è¯´å‡ºå“ªä¸ªæ˜¯è®°å½•å™¨ï¼Œå“ªä¸ªæ˜¯usart2ã€‚ æ‚¨åªéœ€è¦ä¾æ¬¡æ£€æŸ¥å®ƒä»¬å³å¯ã€‚ <br><br> é¦–å…ˆï¼Œæ‰§è¡Œå‘½ä»¤ä»¥ä»ä¸€ä¸ªç«¯å£è¯»å–ï¼š <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">stty</span></span> -F /dev/ttyUSB0 <span class="hljs-number"><span class="hljs-number">115200</span></span> cat /dev/ttyUSB0</code> </pre> <br> ç„¶åä»å¦ä¸€ä¸ªï¼š <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">stty</span></span> -F /dev/ttyUSB1 <span class="hljs-number"><span class="hljs-number">115200</span></span> cat /dev/ttyUSB1</code> </pre> <br> æˆ‘ä»¬çœ‹åˆ°è¿™æ ·çš„å›¾ç‰‡çš„åœ°æ–¹å°±æ˜¯è®°å½•å™¨ã€‚ <br><br><img src="https://habrastorage.org/webt/u0/cu/zc/u0cuzcnbhzppwdhpibm2o6zelpk.png"><br><br> æ‚¨å¯ä»¥ç¦»å¼€æ­¤çª—å£ï¼Œå®ƒä¸ä¼šæ‰“æ‰°æˆ‘ä»¬ã€‚ <br><br> æ¥ä¸‹æ¥ï¼Œæ‚¨éœ€è¦å…è®¸ä»æˆ‘ä»¬çš„ä¸»æ¿å‘é€çš„æ•°æ®åŒ…ç¦»å¼€å…¶å­ç½‘çš„é™åˆ¶ã€‚ ä¸ºæ­¤ï¼Œè¯·é…ç½®iptablesã€‚ æˆ‘ä»¬æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š <br><br>  1.æ‰“å¼€ä¸€ä¸ªæ–°çš„æ§åˆ¶å°çª—å£ <br>  2.æ‚¨éœ€è¦æ‰¾å‡ºæ‚¨çš„IPå’Œç½‘ç»œæ¥å£åç§°ï¼ˆè¿è¡Œ<b>ifconfig</b>å‘½ä»¤ï¼‰ <br><br><img src="https://habrastorage.org/webt/jy/d4/9s/jyd49satpc3erdlzeddi44gwcy4.png"><br><br>  3.è¿è¡Œnaté…ç½®å‘½ä»¤ <br><br><pre> <code class="hljs powershell">sudo echo <span class="hljs-number"><span class="hljs-number">1</span></span> | sudo tee <span class="hljs-literal"><span class="hljs-literal">-a</span></span> /proc/sys/net/ipv4/ip_forward &gt; /dev/null sudo echo <span class="hljs-number"><span class="hljs-number">1</span></span> | sudo tee <span class="hljs-literal"><span class="hljs-literal">-a</span></span> /proc/sys/net/ipv4/ip_dynaddr &gt; /dev/null sudo iptables <span class="hljs-operator"><span class="hljs-operator">-F</span></span> FORWARD sudo iptables <span class="hljs-operator"><span class="hljs-operator">-F</span></span> <span class="hljs-literal"><span class="hljs-literal">-t</span></span> nat sudo iptables <span class="hljs-literal"><span class="hljs-literal">-t</span></span> nat <span class="hljs-literal"><span class="hljs-literal">-A</span></span> POSTROUTING <span class="hljs-literal"><span class="hljs-literal">-o</span></span> enp0s3 <span class="hljs-literal"><span class="hljs-literal">-j</span></span> SNAT -<span class="hljs-literal"><span class="hljs-literal">-to</span></span><span class="hljs-literal"><span class="hljs-literal">-source</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">10.196</span></span> sudo iptables <span class="hljs-literal"><span class="hljs-literal">-t</span></span> nat <span class="hljs-literal"><span class="hljs-literal">-L</span></span></code> </pre> <br> å…¶ä¸­ï¼Œenp0s3æ˜¯ç½‘ç»œæ¥å£çš„åç§° <br>  192.168.10.196-æ‚¨çš„IPåœ°å€ <br>  / proc / sys / net / ipv4--ç›¸åº”æ–‡ä»¶çš„è·¯å¾„ã€‚ <br><br> è¿™äº›å‘½ä»¤å¯ä»¥é‡å†™ä¸ºæ‰¹å¤„ç†æ–‡ä»¶ï¼Œå¹¶åœ¨æ¯æ¬¡å¯åŠ¨PPPæœåŠ¡å™¨ä¹‹å‰è¿è¡Œã€‚ æ‚¨å¯ä»¥å°†å…¶æ·»åŠ åˆ°è‡ªåŠ¨è¿è¡Œï¼Œä½†æˆ‘æ²¡æœ‰ã€‚ <br><br> ç°åœ¨æˆ‘ä»¬å·²ç»å‡†å¤‡å¥½å¯åŠ¨æœåŠ¡å™¨ï¼Œå®ƒä»…ä¿ç•™ç”¨äºåˆ›å»ºè®¾ç½®æ–‡ä»¶ã€‚ æˆ‘å°†å…¶ç§°ä¸ºâ€œ <b>pppd.conf</b> â€ï¼Œå»ºè®®ä½¿ç”¨ä»¥ä¸‹è®¾ç½®ï¼š <br><br><pre> <code class="hljs pgsql">nodetach noauth passive <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-keyword"><span class="hljs-keyword">debug</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lock</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.250</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>:<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.250</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> /dev/ttyUSB1 <span class="hljs-number"><span class="hljs-number">115200</span></span> lcp-echo-<span class="hljs-type"><span class="hljs-type">interval</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> lcp-echo-failure <span class="hljs-number"><span class="hljs-number">1</span></span> cdtrcts</code> </pre> <br> æˆ‘ä»¬å°†è®¾ç½®é‡å†™ä¸ºæ–‡ä»¶ï¼Œç„¶åå°±å¯ä»¥å¯åŠ¨æœåŠ¡å™¨äº†ã€‚ è¿™æ˜¯é€šè¿‡<b>sudo pppdæ–‡ä»¶./pppd.confå‘½ä»¤å®Œæˆçš„</b> <br><br> å¿…é¡»å…ˆå¯åŠ¨PPPDæœåŠ¡å™¨ï¼Œç„¶åå†å¼€å§‹å‘ç°ï¼Œå› æ­¤åœ¨å¯åŠ¨PPPDä¹‹åï¼Œæ‚¨éœ€è¦å•å‡»æ¿ä¸Šçš„â€œé‡ç½®â€æŒ‰é’®ã€‚ <br><br> å¦‚æœä¸€åˆ‡æ“ä½œæ­£ç¡®ï¼Œæ‚¨å°†çœ‹åˆ°ä»¥ä¸‹å›¾ç‰‡ï¼š <br><br><img src="https://habrastorage.org/webt/kv/-p/lj/kv-pljob3duk3bigzj3iazcsasa.png"><br><br> åœ¨å·¦ä¾§è¿è¡Œpppdï¼Œåœ¨å³ä¾§è¿è¡Œloggerã€‚ <br><br><h3> é˜¶æ®µ4ã€‚æˆ‘ä»¬å¯„å‡ºä¸€ä¸ªè¢‹å­ </h3><br> åœ¨è¿™ä¸ªé˜¶æ®µï¼Œæˆ‘ä»¬éœ€è¦ä¸¤ä¸ªè™šæ‹Ÿæœºã€‚  Linux for pppdå’ŒWindowsæ¥æ”¶è¯¥è½¯ä»¶åŒ…ã€‚ ä¸ºäº†ç®€åŒ–ä»»åŠ¡ï¼Œä¸¤å°è®¡ç®—æœºå¿…é¡»ä½äºåŒä¸€å­ç½‘ä¸­ï¼Œç†æƒ³çš„è§£å†³æ–¹æ¡ˆæ˜¯åœ¨VirtualBoxç½‘ç»œè®¾ç½®ä¸­ä¸ºä¸¤å°è®¡ç®—æœºæŒ‡å®šä¸€ä¸ªç½‘æ¡¥è¿æ¥ï¼Œå¹¶åœ¨Windowsä¸­ç¦ç”¨é˜²ç«å¢™ã€‚ <br><br> æˆ‘ä»¬å¯åŠ¨è™šæ‹Ÿæœºï¼Œå¹¶ä½¿ç”¨pppdé…ç½®å‘ç°æ¿çš„pppè¿æ¥ã€‚ åœ¨Windowsä¸Šï¼Œæˆ‘ä»¬æ‰¾åˆ°äº†è®¡ç®—æœºçš„IPåœ°å€ï¼ˆipconfigå‘½ä»¤ï¼‰ï¼Œæˆ‘å¾—åˆ°äº†192.168.10.97ã€‚ <br><br> å¯åŠ¨Packet Senderå¹¶æŒ‰ä»¥ä¸‹æ–¹å¼è¿›è¡Œé…ç½®ï¼š <br><br><img src="https://habrastorage.org/webt/k8/zt/uv/k8ztuv4eccjueyvlk8gigjbmkj0.png"><br><br> ç°åœ¨å†æ¬¡ä¿®æ”¹<b>main.c</b>æ–‡ä»¶ä¸­çš„StartDefaultTaskä»»åŠ¡ã€‚ <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* USER CODE BEGIN 4 */</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"logger.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"sockets.h"</span></span></span><span class="hljs-meta"> typedef uint32_t SOCKET; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* USER CODE END 4 */</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* StartDefaultTask function */</span></span></span><span class="hljs-meta"> void StartDefaultTask(void const * argument) { </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* init code for LWIP */</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// MX_LWIP_Init(); /* USER CODE BEGIN 5 */ usart_Open(); MX_LWIP_Init(); /* Infinite loop */ uint8_t sendStr[]="Test message TCP/IP."; uint8_t resvStr[100]={0}; int resvLength = 0; struct sockaddr_in sockAddr; sockAddr.sin_family = AF_INET; sockAddr.sin_port = htons( 6565 ); uint32_t addr = inet_addr("192.168.10.97"); sockAddr.sin_addr.s_addr = addr; SOCKET socket = NULL; int nError = 0; /* Infinite loop */ for(;;) { HAL_GPIO_WritePin(GPIOD, GPIO_PIN_12|GPIO_PIN_13|GPIO_PIN_14|GPIO_PIN_15, GPIO_PIN_SET); osDelay(1000); HAL_GPIO_WritePin(GPIOD, GPIO_PIN_12|GPIO_PIN_13|GPIO_PIN_14|GPIO_PIN_15, GPIO_PIN_RESET); osDelay(1000); socket = socket( AF_INET, SOCK_STREAM, 0 ); nError = connect( socket, (struct sockaddr*)&amp;sockAddr, sizeof(sockAddr) ); if ( nError == 0 ) { nError = send( socket, sendStr, sizeof(sendStr)-1, 0 ); if ( nError &lt; 0 ) logger("SEND ERROR %d\n", nError); else { logger("SEND - %s\n", sendStr); resvLength = 0; while(resvLength &lt; 1) resvLength = lwip_recv( socket, resvStr, sizeof(resvStr), MSG_WAITALL); resvStr[resvLength]=0; logger("GET - %s\n", resvStr); } lwip_close(socket); } else logger("CONNECT ERROR %d\n", nError); } /* USER CODE END 5 */ }</span></span></span></span></code> </pre><br> ä½œä¸ºaddrå˜é‡çš„å€¼ï¼Œæˆ‘ä»¬ä½¿ç”¨Windowsè®¡ç®—æœºçš„åœ°å€ï¼Œç«¯å£å·6565ã€‚ <br> å‘é€æ¶ˆæ¯â€œæµ‹è¯•æ¶ˆæ¯TCP / IPã€‚â€ï¼Œå“åº”â€œæ¶ˆæ¯å·²æ¥æ”¶ã€‚â€ <br><br> åœ¨è¿™é‡Œæ‚¨å¯ä»¥çœ‹åˆ°PPPåŠŸèƒ½æ²¡æœ‰ç›´æ¥ç”¨äºå‘é€å’Œæ¥æ”¶æ¶ˆæ¯ã€‚ æ‰€æœ‰å·¥ä½œéƒ½åœ¨æ›´é«˜å±‚æ¬¡ä¸Šè¿›è¡Œï¼Œæˆ‘ä»¬çš„åŠŸèƒ½ä¼šè‡ªåŠ¨è°ƒç”¨ã€‚ <br><br> æˆ‘ä»¬ç¼–è¯‘å¹¶åˆ·æ–°ã€‚ <br><br> åœ¨Linuxæœºå™¨ä¸Šå¯ä»¥çœ‹åˆ°è¿æ¥åˆ°pppdçš„ç»“æœï¼š <br><br><img src="https://habrastorage.org/webt/il/og/h6/ilogh6wuak7zym8unedcnddcjr4.png"><br><br> åœ¨Windowsæœºå™¨ä¸Šçš„Packet Senderç¨‹åºä¸­å¯ä»¥çœ‹åˆ°å·²æ¥æ”¶çš„è¯·æ±‚å’Œå·²å‘é€çš„å“åº”ï¼š <br><br><img src="https://habrastorage.org/webt/30/yh/4m/30yh4m_l52nvlkdixrv9zmivehc.png"><br><br> å¥½äº†ï¼Œå°±æ˜¯è¿™æ ·ï¼Œæˆ‘ä»¬ä»å‘ç°æ¿å‘é€çš„æ•°æ®åŒ…åˆ°è¾¾äº†COMç«¯å£ï¼Œåˆ°è¾¾äº†pppdæœåŠ¡å™¨ï¼Œè¢«å‘é€è‡³è®¡ç®—æœºçš„Windowsç«¯å£6565ï¼Œåœ¨æ­¤æˆåŠŸæ¥æ”¶ï¼Œä½œä¸ºå“åº”ï¼Œå¦ä¸€ä¸ªæ•°æ®åŒ…é€šè¿‡äº†æ–¹å‘ç›¸åï¼Œå¹¶å·²åœ¨è‘£äº‹ä¼šæˆåŠŸé‡‡ç”¨ã€‚ æ‚¨å¯èƒ½è¿˜å¯ä»¥å°†æ¶ˆæ¯å‘é€åˆ°Internetä¸Šçš„ä»»ä½•è®¡ç®—æœºã€‚ <br><br>  â†’å®Œæ•´çš„é¡¹ç›®ä»£ç å¯åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ­¤å¤„</a>ä¸‹è½½ </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN419037/">https://habr.com/ru/post/zh-CN419037/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN419025/index.html">@Pythonetcç¼–è¯‘ï¼Œ2018å¹´7æœˆ</a></li>
<li><a href="../zh-CN419027/index.html">é“¶è¡Œæ— ç°é‡‘æ”¯ä»˜çš„ä¿¡æ¯å®‰å…¨ã€‚ ç¬¬å…­éƒ¨åˆ†-é“¶è¡ŒçŠ¯ç½ªåˆ†æ</a></li>
<li><a href="../zh-CN419029/index.html">Fortniteå·²æˆä¸ºä¸€ç§ç¤¾ä¼šç°è±¡ã€‚ çˆ¶æ¯è¶Šæ¥è¶Šå¤šåœ°ä¸ºä»–ä»¬çš„å­©å­è˜è¯·æ•™ç»ƒå¹¶ä¸ä»–ä»¬ä¸€èµ·ç©</a></li>
<li><a href="../zh-CN419033/index.html">å…³äºåœ¨kubernetesé›†ç¾¤ä¸­è¿è¡Œvue.jsçš„ä¸»é¢˜çš„ç®€çŸ­è¯´æ˜</a></li>
<li><a href="../zh-CN419035/index.html">æœ¬ä¹¦â€œå¤´å…ˆæ•æ·ã€‚ çµæ´»çš„é¡¹ç›®ç®¡ç†â€</a></li>
<li><a href="../zh-CN419041/index.html">æˆ‘è¸©è¿‡çš„9å°Elasticsearchè€™</a></li>
<li><a href="../zh-CN419043/index.html">éš¾ä»¥æ‰æ‘¸çš„å¸§å®šæ—¶é—®é¢˜</a></li>
<li><a href="../zh-CN419047/index.html">Redditåœ¨2005-2007å¹´é—´ä½¿ç”¨å¯†ç å’Œç”µå­é‚®ä»¶å¯¹æ•°æ®åº“è¿›è¡Œäº†é»‘å®¢å…¥ä¾µï¼Œæ³„æ¼</a></li>
<li><a href="../zh-CN419049/index.html">GeekBrainsæ¨å‡ºâ€œåœ¨æ•°å­—ä¸­å¯»æ‰¾è‡ªå·±â€å…è´¹åœ¨çº¿æ•™è‚²é©¬æ‹‰æ¾</a></li>
<li><a href="../zh-CN419051/index.html">Flantå¦‚ä½•å¸®åŠ©åˆå­¦è€…</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>