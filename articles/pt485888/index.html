<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üòª üåõ üåΩ Falsifica√ß√£o de solicita√ß√£o do servidor, opera√ß√£o de SSRF cego ü•¢ üâë üîù</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Existe uma coisa chamada SSRF. Muito foi escrito sobre ela, mas ainda assim, vou lhe dizer brevemente. 
 Digamos que voc√™ v√° ao site, preencha o perfi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Falsifica√ß√£o de solicita√ß√£o do servidor, opera√ß√£o de SSRF cego</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/485888/">  Existe uma coisa chamada SSRF.  Muito foi escrito sobre ela, mas ainda assim, vou lhe dizer brevemente. <br>  Digamos que voc√™ v√° ao site, preencha o perfil e acesse o item "upload avatar".  E voc√™ tem a op√ß√£o - fazer upload de um arquivo ou especificar um link. <br><a name="habracut"></a><br>  Nesse caso, estamos interessados ‚Äã‚Äãno segundo ponto.  Se fornecermos um link para um recurso que cont√©m uma imagem, o aplicativo Web: <br><br><ol><li>  Transfere-o </li><li>  Verifique se a imagem √© a imagem </li><li>  Verifique os tamanhos, pois eles podem n√£o se encaixar </li><li>  Exiba para o usu√°rio (para cortar) </li></ol><br><br>  Ent√£o aqui.  Se o site n√£o verificar de onde est√° tentando baixar a imagem, isso √© uma vulnerabilidade (como regra).  Al√©m disso, os vetores de ataques a um recurso t√£o pequeno como o download de imagens s√£o t√£o extensos que n√£o h√° reuni√£o suficiente na barra para passar por todas as op√ß√µes. <br><br><img src="https://habrastorage.org/webt/-f/1o/ws/-f1owsnmnosberjwjdwv9sp76bq.jpeg"><br><br>  Uma vez me perguntaram: ‚ÄúO que posso fazer se posso colocar apenas um link http (s)?  N√£o d√° nada! " <br>  Eu te digo. <br><br>  A op√ß√£o mais f√°cil √© tentar identificar os servi√ßos internos.  Se estamos falando de uma imagem, voc√™ pode tentar olhar para os caminhos padr√£o como favicon.ico, logos ou o diret√≥rio de √≠cones, sugerindo que o Apache seja usado.  Ao enviar solicita√ß√µes, podemos iterar sobre endere√ßos locais populares, bem como subdom√≠nios do site que funcionam na infraestrutura interna.  S√£o todos os tipos de bambu, jira, gitlab e outras coisas amadas por todas as empresas. <br><br>  Para que √© necess√°rio?  Mas porque conhecimento √© poder.  Afinal, mesmo cegamente, voc√™ pode usar v√°rias vulnerabilidades e explora√ß√µes.  Conhecendo o fornecedor ou a vers√£o do servidor ou servi√ßo da Web usado, voc√™ reduz o alcance dos ataques que pode aplicar.  Talvez nem agora, mas no futuro, o conhecimento de informa√ß√µes t√©cnicas sobre a infraestrutura interna o ajudar√° a explorar outras vulnerabilidades. <br><br>  Bem, fomos proibidos de nos permitir inserir endere√ßos IP.  Suponha que tenhamos algum recurso importante dentro da infraestrutura e seu endere√ßo IP seja 192.168.1.1 <br><br>  Antes de tudo, iniciamos mentalmente um dom√≠nio ao qual atribuiremos esse IP.  Que seja my-test-site.com.  Na vida real, voc√™ deve criar subdom√≠nios cujo endere√ßo ser√° direcionado para o IP de que precisamos, mas mais sobre isso posteriormente. <br><br><h3>  For√ßa bruta da senha </h3><br><br>  Vamos sonhar que temos um roteador dentro.  O diret√≥rio / admin / est√° em Autentica√ß√£o b√°sica.  Alterando o link, podemos selecionar logins e senhas para o roteador.  Mas aqui √© bem simples, n√≥s apenas formamos um link do formul√°rio <br><br> <code>http://login:password@my-test-site.com/admin/</code> <br> <br>  Assim, o valor antes dos dois pontos ser√° o login, depois dele - a senha.  E atrav√©s do sinal @, haver√° um dom√≠nio para o qual esses dados ser√£o enviados.  Observe que ele n√£o funciona com todos os tipos de pessoas de contato nas quais voc√™ precisa preencher um formul√°rio.  Portanto, a autentica√ß√£o b√°sica √© necess√°ria - uma janela pop-up com uma resposta 401 do servidor. <br><br>  Se tiv√©ssemos sorte e o site retornasse pelo menos o c√≥digo de resposta (200, 401, 503), seria muito mais f√°cil.  Ent√£o podemos observar claramente o processo e ver nossa vit√≥ria: <br><br> <code>http://admin:password@my-test-site.com/admin/ - 401 <br> http://admin:admin@my-test-site.com/admin/ - 401 <br> http://admin:123456@my-test-site.com/admin/ - 200</code> <br> <br>  Ao enviar uma d√∫zia ou duas dessas solicita√ß√µes, voc√™ pode tentar encontrar a senha desse roteador.  E depois v√° para o script para salvar seu pr√≥prio DNS ou at√© /reboot.cgi <br><br>  E se n√£o houver resposta e √© sempre a mesma? <br><br>  Aqui os hor√°rios nos ajudar√£o. <br><br><h3>  Hor√°rios </h3><br><br>  Tudo leva tempo.  Como levo seu tempo para ler um artigo, os servi√ßos demoram para responder. <br>  A peculiaridade √© que podemos tentar acessar recursos internos e medir o tempo para responder √† pergunta - existe algum servi√ßo ou n√£o? <br>  Depois de enviar muitas solicita√ß√µes, voc√™ pode classificar cegamente servi√ßos internos, portas e at√© diret√≥rios e arquivos, contando com uma anomalia de respostas. <br><br> <code>1302 ms - http://test.company.com <br> 1307 ms - http://db.company.com <br> 5483 ms - http://jira.company.com <br> 1410 ms - http://docs.company.com <br> 1366 ms - http://kafka.company.com</code> <br> <br>  O subdom√≠nio jira respondeu por mais tempo, provavelmente por dentro, e a diferen√ßa √© percept√≠vel porque o servidor da Web tentou carregar a p√°gina e percebeu que n√£o era uma imagem.  E o que importa para n√≥s n√£o √© o fato de "Quem respondeu por mais tempo?", Mas "Quem respondeu n√£o como todos os outros?"  Como o tempo pode ser um atraso - por exemplo, se voc√™ encontrar um arquivo ou script grande que demora muito para ser executado.  Ou vice-versa, uma resposta r√°pida. <br><br> <code>1302 ms - http://test.company.com <br> 1307 ms - http://db.company.com <br> 423 ms - http://jira.company.com <br> 1410 ms - http://docs.company.com <br> 1366 ms - http://kafka.company.com</code> <br> <br>  Nesse caso, a resposta diz que √© 401 ou um redirecionamento que n√£o processa o analisador de imagens.  Ou talvez o site esteja acess√≠vel, mas depois de verificar os primeiros bytes ou tipo de conte√∫do, nosso aplicativo da Web o rejeitou antes de fazer o download completo da p√°gina.  Outros sites neste exemplo n√£o esperaram por uma conex√£o (ou o nome do host n√£o ficou s√≥brio) <br><br><h3>  Mecanismos de verifica√ß√£o de IP </h3><br><br>  Muitos sites confirmaram que o endere√ßo IP n√£o √© interno.  Mas a l√≥gica pode estar errada e, √†s vezes, voc√™ ainda pode conectar o aplicativo ao endere√ßo IP interno.  Por exemplo, um site faz check-in em dois blocos l√≥gicos.  Primeiro, ele verifica se o host que aponta para o IP externo me foi fornecido com precis√£o.  Se, ap√≥s passar com √™xito na primeira verifica√ß√£o, o site estabelecer uma conex√£o, sem armazenar em cache o endere√ßo IP do par√°grafo anterior, voc√™ poder√° fazer um truque engra√ßado. <br><br>  Na primeira solicita√ß√£o do dom√≠nio my-test-site.com, forne√ßa um IP externo, por exemplo 123.123.123.123 <br>  E assim que passar na valida√ß√£o, comece a enviar IP interno para o mesmo dom√≠nio. <br><br>  Nesse caso, <a href="https://github.com/neex" rel="nofollow">Emil Lerner</a> fez um √≥timo servi√ßo - 1u.ms! <br><br>  O dom√≠nio 1u.ms responde com os endere√ßos IP especificados. <br><br>  O formato do dom√≠nio deve ser o seguinte: <br><br> <code>make-%IP%-rebind-%IP-rr.1u.ms</code> <br> <br>  Por exemplo <br><br> <code>make-123.123.123.123-rebind-127.0.0.1-rr.1u.ms</code> <br> <br>  A primeira solicita√ß√£o ser√° respondida com o endere√ßo 123.123.123.123 e a segunda solicita√ß√£o j√° ser√° respondida em 127.0.0.1 (se forem uma ap√≥s a outra, dentro de 5 segundos). <br><br>  A prop√≥sito, o endere√ßo IP pode ser escrito sem pontos, caso voc√™ precise de um subdom√≠nio: <br><br> <code>make-123-123-123-123-rebind-127-0-0-1-rr.1u.ms</code> <br> <br>  A prop√≥sito, antes de fazer e depois de rr, voc√™ pode escrever palavras arbitr√°rias para impedir o uso de dados em cache: <br><br> <code>bo0om-make-123-123-123-123-rebind-127-0-0.1-rr-test.1u.ms</code> <br> <br>  E para ver o log - o an√°logo da cauda -f: <br> <code>curl http://1u.ms:8080/log</code> <br>  (ou o mesmo link no navegador) <br><br><h3>  Digitaliza√ß√£o de porta usando DNS </h3><br><br>  De fato, ao gerenciar registros DNS, voc√™ pode tentar verificar as portas.  Um pequeno truque nos ajudar√° com isso. <br><br>  Suponha que tenhamos um dom√≠nio my-test-site.com. <br><br>  Geralmente, ele cont√©m pelo menos um registro A para o recurso abrir. <br>  Digamos que o IP do nosso site seja 172.217.20.46 (retirado do google.com.br).  Mas podemos especificar v√°rias dessas entradas!  Imagine que n√≥s os criamos e nossos registros DNS s√£o assim: <br><br> <code>my-test-site.com 172.217.20.46 <br> my-test-site.com 192.168.1.1</code> <br> <br>  Nosso recurso ser√° aberto?  Sim vai.  E tudo porque o primeiro registro vai primeiro. <br><br>  Agora mude os registros DNS da seguinte maneira: <br><br> <code>my-test-site.com 192.168.1.1 <br> my-test-site.com 172.217.20.46</code> <br> <br>  Nosso recurso ser√° aberto?  Ser√° novamente :) <br><br>  E tudo porque o recurso primeiro tentar√° inicializar a partir do primeiro IP especificado e, se houver algum problema, ele passar√° para o segundo. <br><br> <code>curl "my-test-site.com" -v <br> * Trying 192.168.1.1... <br> * TCP_NODELAY set <br> * Immediate connect fail for 192.168.1.1: Host is down <br> * Trying 172.217.20.46... <br> * TCP_NODELAY set <br> * Connected to my-test-site.com (172.217.20.46) port 80 (#0) <br> &gt; GET / HTTP/1.1 <br> &gt; Host: my-test-site.com <br> &gt; User-Agent: curl/7.64.1 <br> &gt; Accept: */* <br> &gt; <br> &lt; HTTP/1.1 404 Not Found <br> &lt; Content-Type: text/html; charset=UTF-8 <br> &lt; Referrer-Policy: no-referrer <br> &lt; Content-Length: 1561 <br> &lt; Date: Tue, 21 Jan 2020 16:35:08 GMT</code> <br> <br>  Usando esse recurso, voc√™ pode descobrir quais portas est√£o abertas e quais n√£o.  De fato, muitas (mas n√£o todas) as bibliotecas tentar√£o chegar primeiro ao primeiro recurso, listado primeiro nos registros DNS e depois no segundo. <br>  Aqui indicamos o link para o nosso recurso no carregamento do avatar. <br><br>  Especificando nosso dom√≠nio, alterando a porta, tentamos usar o m√©todo de exce√ß√£o para determinar qual porta est√° dispon√≠vel. <br><br> <code>http://my-test-site.com:22 -    172.217.20.46:22 <br> http://my-test-site.com:80 -    172.217.20.46:80 <br> http://my-test-site.com:8080 -    <br> http://my-test-site.com:9200 -    172.217.20.46:9200 <br> http://my-test-site.com:3306 -   </code> <br> <br>  Como especificamos 192.168.1.1 como o primeiro registro, conclu√≠mos que esse endere√ßo respondeu √† biblioteca em 192.168.1.1 (portas 8080 e 3306), mesmo que estivesse incorreto, mas respondeu.  Portanto, essas portas est√£o abertas e existem servi√ßos nelas.  Nesse caso, ele n√£o mudar√° para o segundo endere√ßo. <br><br>  O servi√ßo 1u.ms aqui tamb√©m pode ajudar, neste caso, teremos a seguinte configura√ß√£o: <br><br> <code>make-%IP%-and-%IP%rr.1u.ms</code> <br> <br>  do tipo <br><br> <code>make-192.168.1.1-and-172.217.20.46rr.1u.ms</code> <br> <br>  Ele retornar√° duas entradas, todos os outros recursos, como no par√°grafo anterior. <br><br>  A prop√≥sito, essa abordagem pode ser usada para uma Rebinding DNS mais r√°pida, for√ßando o navegador a mudar de um servidor "travado" para um servidor em funcionamento.  Eu acho que ser√° mais r√°pido do que esperar um minuto para atualizar o cache do DNS.  No entanto, com o Chrome, por exemplo, esse truque n√£o funcionar√°, pois √© necess√°rio um IP aleat√≥rio. <br><br>  Outro problema √© que o servidor DNS com o qual o aplicativo da web determina os endere√ßos de dom√≠nio pode ter round robin interno - altere a ordem dos registros, distribuindo uniformemente a carga em todos os servidores.  Por exemplo, 8.8.8.8 recusou esse recurso, mas no 1.1.1.1 ele est√° presente. <br><br><h3>  Redirecionamentos </h3><br><br>  Tente redirecionamentos!  Bem, primeiro, os redirecionamentos podem reduzir o n√∫mero de solicita√ß√µes para um aplicativo Web, por exemplo, ao verificar portas usando DNS.  Se a resposta chegar, redirecione para outra porta ou dom√≠nio.  Caso contr√°rio, talvez ele tenha trope√ßado em um porto aberto. <br><br>  Mas a melhor coisa, √© claro, √© tentar alterar o protocolo usando o redirecionamento.  Na minha pr√°tica, houve casos em que um redirecionamento para o arquivo: /// etc / passwd funcionou e mostrou o conte√∫do do arquivo.  Na vers√£o com ssrf cego, voc√™ pode tentar alterar o protocolo para gopher (enquanto ele ainda existe) e j√° pode enviar cartas usando comandos para SMTP e outras magias. <br><br><h3>  Nega√ß√£o de servi√ßo </h3><br>  O carregador de inicializa√ß√£o ser√° interrompido se eu fornecer um arquivo de entrada com 10 GB de tamanho?  Ou uma imagem de 225.000 por 225.000 pixels, ocupando 141,4 GB de RAM.  Isso pode afetar o desempenho do site.  √â verdade que um servidor com falha n√£o nos trar√° nenhuma divers√£o, portanto, lembre-se disso. <br><br><h3>  E um monte de tudo </h3><br><br>  Provavelmente √© tudo o que posso citar agora.  Isso n√£o leva em considera√ß√£o as vulnerabilidades associadas ao download (onde ele √© carregado, como √© salvo, que √© verificado ao mesmo tempo) e partes de terceiros (lembre-se do <a href="https://imagetragick.com/" rel="nofollow">imagetragick</a> e <a href="https://github.com/neex/gifoeb" rel="nofollow">gifoeb</a> ).  Se voc√™ tiver outras id√©ias, deixe um coment√°rio. <br><br>  N√£o posso deixar de dar <a href="https://docs.google.com/document/d/1v1TkWZtrhzRLy0bYXBcdLUedXGb9njTNIJXa3u9akHM/edit" rel="nofollow">uma B√≠blia</a> ao <a href="https://docs.google.com/document/d/1v1TkWZtrhzRLy0bYXBcdLUedXGb9njTNIJXa3u9akHM/edit" rel="nofollow">SSRF</a> que descreva a maioria dos casos nesse ataque.  E tamb√©m uma p√°gina com SSRF no reposit√≥rio <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%2520Side%2520Request%2520Forgery" rel="nofollow">PayloadsAllTheThings</a> favorito de <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%2520Side%2520Request%2520Forgery" rel="nofollow">todos</a> , com o suporte ativo da comunidade. <br>  A prop√≥sito, muitos ataques s√£o aplic√°veis ‚Äã‚Äãao servidor (no servidor) e ao cliente (no navegador).  Atacante - ataque, seja criativo.  Defendendo - defenda-se, seja mais esperto do que atacar. <br><br>  <a href="https://bo0om.ru/blind-ssrf" rel="nofollow">https://bo0om.ru/blind-ssrf</a> <br>  <a href="https://zen.yandex.ru/media/id/5d2d9c1e31878200ad93e4c0/poddelka-servernyh-zaprosov-ekspluataciia-ataki-blind-ssrf-5e305b669b2c49359f7c72da" rel="nofollow">Zen</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt485888/">https://habr.com/ru/post/pt485888/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt485872/index.html">Regress√£o log√≠stica de mastiga√ß√£o</a></li>
<li><a href="../pt485874/index.html">O livro ‚ÄúLearning Python: programa√ß√£o de jogos, visualiza√ß√£o de dados, aplicativos da web. 3rd ed.</a></li>
<li><a href="../pt485876/index.html">Aceleramos o OpenVPN no roteador Openwrt. Vers√£o alternativa sem ferro de solda e extremismo r√≠gido</a></li>
<li><a href="../pt485884/index.html">Como configurar o Levitron chin√™s</a></li>
<li><a href="../pt485886/index.html">Como (e por que) analisar as chaves e os an√∫ncios dos concorrentes do Yandex.Direct e Google Ads gratuitamente</a></li>
<li><a href="../pt485892/index.html">O fim da era Trident</a></li>
<li><a href="../pt485896/index.html">Banco de dados massivamente paralelo Greenplum - um pequeno programa educacional</a></li>
<li><a href="../pt485898/index.html">Exporte o Google Forms + fa√ßa o download do Google Script via API REST (Python)</a></li>
<li><a href="../pt485904/index.html">Meetup sobre Load Testing em Raiffeisenbank</a></li>
<li><a href="../pt485908/index.html">Gra√ßas √† incr√≠vel falha em Ocarina of Time, foi poss√≠vel adicionar modelos da Star Fox 64</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>