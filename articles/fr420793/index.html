<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëÉüèæ üë®üèª‚Äçüç≥ üîî D√©bogage en tant que processus ‚§¥Ô∏è üßúüèø üçñ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On pense que le d√©veloppement prend environ 10% du temps, et le d√©bogage prend 90%. Peut-√™tre que cette d√©claration est exag√©r√©e, mais tout d√©veloppeu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>D√©bogage en tant que processus</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/jugru/blog/420793/"> On pense que le d√©veloppement prend environ 10% du temps, et le d√©bogage prend 90%.  Peut-√™tre que cette d√©claration est exag√©r√©e, mais tout d√©veloppeur conviendra que le d√©bogage est un processus extr√™mement gourmand en ressources, en particulier dans les grands syst√®mes multithreads. <br><br>  Ainsi, l'optimisation et la syst√©matisation du processus de d√©bogage peuvent apporter des avantages significatifs sous forme d'heures de travail √©conomis√©es, augmentant la vitesse de r√©solution des probl√®mes et, finalement, augmentant la fid√©lit√© de vos utilisateurs. <br><br><img src="https://habrastorage.org/webt/lm/eb/rk/lmebrkzzdxjbw-vsbub7ybrlxjq.png"><br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Sergey Shchegrikovich</a> (dotmailer) √† la conf√©rence <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">DotNext 2018 Piter a</a> sugg√©r√© de consid√©rer le d√©bogage comme un processus qui peut √™tre d√©crit et optimis√©.  Si vous n'avez toujours pas de plan clair pour trouver des bugs - sous la vid√©o et le texte de la transcription du rapport de Sergey. <br><br>  (Et √† la fin de l'article, nous avons ajout√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">l'</a> attrait de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">John Skeet</a> √† tous les affili√©s, assurez-vous de regarder) <br><a name="habracut"></a><br><iframe width="560" height="315" src="https://www.youtube.com/embed/Paxi4K5Om1Q" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  Mon objectif est de r√©pondre √† la question: comment corriger efficacement les bugs et quel devrait √™tre le focus.  Je pense que la r√©ponse √† cette question est un processus.  Le processus de d√©bogage, qui consiste en des r√®gles tr√®s simples, et vous les connaissez bien, mais vous l'utilisez probablement sans le savoir.  Par cons√©quent, ma t√¢che est de les syst√©matiser et de montrer comment devenir plus efficaces √† l'aide d'un exemple. <br><br>  Nous d√©velopperons un langage commun pour la communication pendant le d√©bogage, et nous verrons √©galement un chemin direct pour trouver les principaux probl√®mes.  Sur mes exemples, je montrerai ce qui s'est pass√© en raison d'une violation de ces r√®gles. <br><br><h2>  Utilitaires de d√©bogage </h2><br><img src="https://habrastorage.org/getpro/habr/post_images/292/518/f94/292518f94ecd468e034d8ec952398980.png"><br>  Bien s√ªr, tout d√©bogage n'est pas possible sans les utilitaires de d√©bogage.  Mes favoris sont: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Windbg</a> , qui, en plus du d√©bogueur lui-m√™me, poss√®de de riches fonctionnalit√©s pour √©tudier les vidages de m√©moire.  Un vidage de m√©moire est une tranche de l'√©tat d'un processus.  Vous y trouverez la valeur des champs d'objets, des piles d'appels, mais, malheureusement, le vidage de la m√©moire est statique. <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PerfView</a> est un profileur √©crit sur la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">technologie ETW</a> . <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Sysinternals</a> est un utilitaire √©crit par <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Mark Russinovich</a> , qui vous permet de creuser un peu plus loin dans l'appareil du syst√®me d'exploitation. <br></li></ul><br><h2>  Service en baisse </h2><br>  Commen√ßons par un exemple de ma vie dans lequel je montrerai comment la nature non syst√©matique du processus de d√©bogage conduit √† l'inefficacit√©. <br><br>  Cela est probablement arriv√© √† tout le monde, lorsque vous venez dans une nouvelle entreprise dans une nouvelle √©quipe pour un nouveau projet, puis d√®s le premier jour, vous voulez faire des avantages irr√©parables.  C'√©tait donc avec moi.  √Ä cette √©poque, nous avions un service qui recevait du HTML pour l'entr√©e et des images de sortie pour la sortie. <br><br>  Le service a √©t√© √©crit sous .Net 3.0 et c'√©tait il y a tr√®s longtemps.  Ce service avait une petite fonctionnalit√© - il s'est √©cras√©.  Tombait souvent, environ une fois toutes les deux √† trois heures.  Nous avons corrig√© ces propri√©t√©s de red√©marrage √©l√©gamment d√©finies dans les propri√©t√©s du service apr√®s la chute. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0cc/b02/1a2/0ccb021a20b6c50d1639cd3e2bef7c28.png"><br><br>  Le service n'√©tait pas essentiel pour nous et nous pouvions y survivre.  Mais j'ai rejoint le projet et la premi√®re chose que j'ai d√©cid√© de faire a √©t√© de le r√©parer. <br><br>  O√π vont les d√©veloppeurs .NET si quelque chose ne fonctionne pas?  Ils vont √† EventViewer.  Mais l√† je n'ai rien trouv√© d'autre que le record que le service est tomb√©.  Il n'y avait aucun message sur l'erreur native, ni une pile d'appels. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/be3/bdf/2fe/be3bdf2fe39777092ad0f2989e35d92e.png"><br><br>  Il existe un outil qui a fait ses preuves pour ce qu'il faut faire ensuite - nous enveloppons l'ensemble <code>main</code> dans <code>try-catch</code> . <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { ProcessRequest(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception ex) { LogError(ex); }</code> </pre><br>  L'id√©e est simple: <code>try-catch</code> fonctionnera, cela nous d√©rangera, nous le lirons et r√©parerons le service.  Nous compilons, d√©ployons en production, le service plante, il n'y a pas d'erreur.  Ajoutez une autre <code>catch</code> . <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { ProcessRequest(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception ex) { LogError(ex); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> { LogError(); }</code> </pre><br>  Nous r√©p√©tons le processus: le service plante, il n'y a pas d'erreur dans les logs.  La derni√®re chose qui peut aider est <code>finally</code> , ce qui est toujours appel√©. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { ProcessRequest(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception ex) { LogError(ex); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> { LogError(); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { LogEndOfExecution(); }</code> </pre><br>  Nous compilons, d√©ployons, le service plante, il n'y a pas d'erreur.  Trois jours s'√©coulent derri√®re ce processus, maintenant des pens√©es viennent d√©j√† que nous devons enfin commencer √† penser et √† faire autre chose.  Vous pouvez faire beaucoup de choses: essayez de reproduire l'erreur sur la machine locale, regardez les vidages de m√©moire, etc.  Cela semblait encore deux jours et je vais corriger ce bug ... <br><br>  Deux semaines se sont √©coul√©es. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1eb/f02/0c3/1ebf020c3dde595f5423fd8247c3137b.png"><br><br>  J'ai regard√© dans PerformanceMonitor, o√π j'ai vu un service qui se bloque, puis monte, puis retombe.  Cette condition est appel√©e <i>d√©sespoir</i> et ressemble √† ceci: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/98b/e07/904/98be07904a35b99130ba9ddf871af47f.png"><br><br>  Dans cette vari√©t√© d'√©tiquettes, essayez-vous de d√©couvrir o√π se situe r√©ellement le probl√®me?  Apr√®s plusieurs heures de m√©ditation, le probl√®me appara√Æt soudain: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/379/2ba/caa/3792bacaa7c418f5fcffa318729bf1a0.png"><br><br>  La ligne rouge est le nombre de descripteurs natifs dont le processus est propri√©taire.  Un handle natif est une r√©f√©rence √† une ressource de syst√®me d'exploitation: fichier, registre, cl√© de registre, mutex, etc.  Pour une √©trange combinaison de circonstances, la baisse de la croissance du nombre de poign√©es co√Øncide avec les moments o√π le service a chut√©.  Cela conduit √† l'id√©e qu'il y a quelque part une fuite de poign√©es. <br><br>  Nous prenons un vidage de m√©moire, l'ouvrons dans WinDbg.  Nous commen√ßons √† ex√©cuter des commandes.  Essayons de voir la file d'attente de finalisation des objets qui devraient √™tre lib√©r√©s par l'application. <br><br><pre> <code class="hljs erlang-repl"><span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">000</span></span>&gt; !FinalizeQueue</code> </pre><br>  √Ä la toute fin de la liste, j'ai trouv√© un navigateur Web. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d6f/aa5/eb3/d6faa5eb38c3b7a4429e55d7f8af655e.png"><br>  La solution est simple - prenez WebBrowser et appelez en <code>dispose</code> : <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Process</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> webBrowser = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WebBrowser()) { <span class="hljs-comment"><span class="hljs-comment">// Processing ... } }</span></span></code> </pre><br>  Les conclusions de cette histoire peuvent √™tre tir√©es comme suit: deux semaines, c'est trop long et trop long pour trouver une disposition non invit√©e;  que nous avons trouv√© une solution au probl√®me - la chance, puisqu'il n'y avait pas d'approche sp√©cifique, il n'y avait pas de nature syst√©matique. <br><br>  Apr√®s cela, j'avais une question: comment faire ses d√©buts efficacement et que faire? <br><br>  Pour ce faire, vous devez conna√Ætre seulement trois choses: <br><br><ol><li>  R√®gles de d√©bogage <br></li><li>  Algorithme de recherche d'erreurs. <br></li><li>  Techniques de d√©bogage proactives. <br></li></ol><br><h2>  R√®gles de d√©bogage </h2><br><ol><li>  R√©p√©tez l'erreur. <br></li><li>  Si vous n'avez pas corrig√© l'erreur, elle n'est pas corrig√©e. <br></li><li>  Comprenez le syst√®me. <br></li><li>  V√©rifiez la fiche. <br></li><li>  Divisez et conqu√©rez. <br></li><li>  Rafra√Æchissez-vous. <br></li><li>  Ceci est votre bug. <br></li><li>  Cinq pourquoi. <br></li></ol><br>  Ce sont des r√®gles assez claires qui se d√©crivent. <br><br>  R√©p√©tez l'erreur.  Une r√®gle tr√®s simple, car si vous ne pouvez pas vous tromper, il n'y a rien √† corriger.  Mais il existe diff√©rents cas, en particulier pour les bogues dans un environnement multi-thread.  Nous avons en quelque sorte eu une erreur qui n'apparaissait que sur les processeurs Itanium et uniquement sur les serveurs de production.  Par cons√©quent, la premi√®re t√¢che du processus de d√©bogage consiste √† trouver une configuration du banc de test sur laquelle l'erreur serait reproduite. <br><br>  Si vous n'avez pas corrig√© l'erreur, elle n'est pas corrig√©e.  Cela arrive parfois: un bug tracker contient un bug qui est apparu il y a six mois, personne ne l'a vu depuis longtemps, et on souhaite simplement le fermer.  Mais en ce moment, nous manquons la chance de savoir, la chance de comprendre comment notre syst√®me fonctionne et ce qui lui arrive vraiment.  Par cons√©quent, tout bug est une nouvelle opportunit√© d'apprendre quelque chose, d'en savoir plus sur votre syst√®me. <br><br>  Comprenez le syst√®me.  Brian Kernighan a dit un jour que si nous √©tions si intelligents pour √©crire ce syst√®me, alors nous devons √™tre doublement intelligents pour le lancer. <br><br>  Un petit exemple de la r√®gle.  Notre suivi dessine des graphiques: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4cf/bfa/85b/4cfbfa85be2cf375741646b55aa373e6.png"><br>  Il s'agit d'un graphique du nombre de demandes trait√©es par notre service.  Apr√®s l'avoir regard√©, nous avons eu l'id√©e qu'il serait possible d'augmenter la vitesse du service.  Dans ce cas, le planning augmente, il peut √™tre possible de r√©duire le nombre de serveurs. <br><br>  L'optimisation des performances Web se fait simplement: nous prenons PerfView, l'ex√©cutons sur la machine de production, il supprime la trace dans les 3-4 minutes, nous prenons cette trace sur la machine locale et commen√ßons √† l'√©tudier. <br><br>  L'une des statistiques que PerfView affiche est le garbage collector. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d3a/ed0/c3f/d3aed0c3f4d3c6de77840aa9ffc10004.png"><br><br>  En regardant ces statistiques, nous avons vu que le service passe 85% de son temps √† ramasser les ordures.  Vous pouvez voir dans PerfView exactement o√π ce temps est pass√©. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/bb5/cd2/e4a/bb5cd2e4a54d4f71d832482217233281.png"><br><br>  Dans notre cas, cela cr√©e des cha√Ænes.  La correction elle-m√™me se sugg√®re: nous rempla√ßons toutes les cha√Ænes par StringBuilders.  Localement, nous obtenons une augmentation de productivit√© de 20 √† 30%.  D√©ployer en production, voir les r√©sultats par rapport √† l'ancien planning: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/060/d63/21d/060d6321d41fa993d80d7b9d19d2d95c.png"><br><br>  La r√®gle ¬´Comprendre le syst√®me¬ª ne consiste pas seulement √† comprendre comment les interactions se d√©roulent dans votre syst√®me, comment les messages passent, mais √† essayer de mod√©liser votre syst√®me. <br><br>  Dans l'exemple, le graphique montre la bande passante.  Mais si vous regardez l'ensemble du syst√®me du point de vue de la th√©orie des files d'attente, il s'av√®re que le d√©bit de notre syst√®me d√©pend d'un seul param√®tre - la vitesse d'arriv√©e de nouveaux messages.  En fait, le syst√®me ne contenait tout simplement pas plus de 80 messages √† la fois, il n'y a donc aucun moyen d'optimiser ce calendrier. <br><br>  V√©rifiez la fiche.  Si vous ouvrez la documentation d'un appareil √©lectrom√©nager, elle y sera d√©finitivement inscrite: si l'appareil ne fonctionne pas, v√©rifiez que la fiche est ins√©r√©e dans la prise.  Apr√®s plusieurs heures dans le d√©bogueur, je me retrouve souvent √† penser que je devais juste recompiler ou simplement r√©cup√©rer la derni√®re version. <br><br>  La r√®gle ¬´v√©rifier la fiche¬ª concerne les faits et les donn√©es.  Le d√©bogage ne commence pas par l'ex√©cution de WinDbg ou PerfView sur les machines de production, il commence par la v√©rification des faits et des donn√©es.  Si le service ne r√©pond pas, il se peut qu'il ne fonctionne tout simplement pas. <br><br>  Divisez et conqu√©rez.  C'est la premi√®re et probablement la seule r√®gle qui inclut le d√©bogage en tant que processus.  Il s'agit d'hypoth√®ses, de leur promotion et de leur test. <br><br>  Un de nos services n'a pas voulu s'arr√™ter. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4f2/cff/169/4f2cff1697473f917e815384d773149a.png"><br><br>  Nous faisons une hypoth√®se: il y a peut-√™tre un cycle dans le projet qui traite quelque chose √† l'infini. <br><br>  Vous pouvez tester l'hypoth√®se de diff√©rentes mani√®res, une option consiste √† effectuer un vidage de la m√©moire.  Nous retirons les piles d'appels du vidage et de tous les threads en utilisant la commande <code>~*e!ClrStack</code> .  Nous commen√ßons √† regarder et √† voir trois flux. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1d3/a54/35b/1d3a5435b697646daaf802e2bd838c7e.png"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/2f3/185/6b2/2f31856b23147722d7b3e534689572f8.png"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/d0f/ac7/760/d0fac7760f4e8e201d0f028c4deae23e.png"><br><br>  Le premier thread est dans Main, le second est dans le gestionnaire <code>OnStop()</code> et le troisi√®me thread attendait certaines t√¢ches internes.  Ainsi, notre hypoth√®se n'est pas justifi√©e.  Il n'y a pas de boucle, tous les threads attendent quelque chose.  Impasse probablement. <br><br>  Notre service fonctionne comme suit.  Il y a deux t√¢ches - l'initialisation et le travail.  L'initialisation ouvre une connexion √† la base de donn√©es, le travailleur commence √† traiter les donn√©es.  La communication entre eux s'effectue via un indicateur commun, qui est impl√©ment√© √† l'aide de <code>TaskCompletionSource</code> . <br><br>  Nous faisons la deuxi√®me hypoth√®se: nous avons peut-√™tre une impasse d'une t√¢che pour la seconde.  Pour v√©rifier cela, vous pouvez voir chaque t√¢che s√©par√©ment via WinDbg. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c0f/536/1cf/c0f5361cf09ba6cd40d9a72e6d5dfb06.png"><br><br>  Il s'av√®re que l'une des t√¢ches est tomb√©e, et la seconde non.  Dans le projet, nous avons vu le code suivant: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">await</span></span> openAsync(); _initLock.SetResult(<span class="hljs-literal"><span class="hljs-literal">true</span></span>);</code> </pre><br>  Cela signifie que la t√¢che d'initialisation ouvre la connexion et d√©finit ensuite <code>TaskCompletionSource</code> sur true.  Mais que faire si une exception tombe ici?  Ensuite, nous n'avons pas le temps de d√©finir <code>SetResult</code> sur true, donc le correctif de ce bogue √©tait le suivant: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> openAsync(); _initLock.SetResult(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(Exception ex) { _initLock.SetException(ex); }</code> </pre><br>  Dans cet exemple, nous proposons deux hypoth√®ses: la boucle infinie et l'impasse.  La r√®gle "diviser pour mieux r√©gner" permet de localiser l'erreur.  Des approximations successives r√©solvent de tels probl√®mes. <br><br>  La chose la plus importante dans cette r√®gle est les hypoth√®ses, car au fil du temps, elles se transforment en mod√®les.  Et selon l'hypoth√®se, nous utilisons diff√©rentes actions. <br><br>  Rafra√Æchissez-vous.  Cette r√®gle est que vous avez juste besoin de vous lever de la table et de marcher, de boire de l'eau, du jus ou du caf√©, de faire n'importe quoi, mais le plus important est de vous distraire de votre probl√®me. <br><br>  Il existe une tr√®s bonne m√©thode appel√©e canard.  Selon la m√©thode, il faut parler du probl√®me du <i>canard</i> .  Vous pouvez utiliser un coll√®gue comme <i>canard</i> .  De plus, il n'a pas √† r√©pondre, il suffit d'√©couter et d'accepter.  Et souvent, apr√®s la premi√®re discussion du probl√®me, vous trouvez vous-m√™me une solution. <br><br>  Ceci est votre bug.  Je vais parler de cette r√®gle par un exemple. <br><br>  Il y avait un probl√®me dans une <code>AccessViolationException</code> .  En regardant dans la pile d'appels, j'ai vu que cela s'est produit lorsque nous avons g√©n√©r√© la requ√™te LinqToSql √† l'int√©rieur du client sql. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/fd2/849/7a6/fd28497a66853c5bcf17eaa9d978524a.png"><br><br>  De ce bug, il √©tait clair que quelque part l'int√©grit√© de la m√©moire est viol√©e.  Heureusement, √† cette √©poque, nous utilisions d√©j√† un syst√®me de gestion du changement.  En cons√©quence, apr√®s quelques heures, il est devenu clair ce qui s'est pass√©: nous avons install√© .Net 4.5.2 sur nos machines de production. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f24/bc8/438/f24bc84388e43df0ad4e7af27c0bbc24.png"><br><br>  En cons√©quence, nous envoyons le bogue √† Microsoft, ils l'examinent, nous communiquons avec eux, ils corrigent le bogue dans .Net 4.6.1. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/44a/c39/535/44ac39535a874ff0ea0f599a55f07252.png"><br><br>  Pour moi, cela s'est traduit par 11 mois de travail avec le support Microsoft, bien s√ªr, pas tous les jours, mais il a fallu 11 mois depuis le d√©but pour corriger.  De plus, nous leur avons envoy√© des dizaines de gigaoctets de vidages m√©moire, nous avons mis des centaines d'assemblys priv√©s pour rattraper cette erreur.  Et pendant tout ce temps, nous n'avons pas pu dire √† nos clients que Microsoft √©tait √† bl√¢mer, pas nous.  Par cons√©quent, le bug est toujours le v√¥tre. <br><br>  Cinq pourquoi.  Dans notre entreprise, nous utilisons Elastic.  L'√©lastique est bon pour l'agr√©gation de journaux. <br><br>  Vous venez travailler le matin et les mensonges √©lastiques. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1a1/c80/09b/1a1c8009b49f9c288b3c4b29daf194cc.png"><br><br>  La premi√®re question est pourquoi est √©lastique?  Presque imm√©diatement, il est devenu clair - les n≈ìuds principaux sont tomb√©s.  Ils coordonnent le travail de l'ensemble du cluster et lorsqu'ils tombent, l'ensemble du cluster cesse de r√©pondre.  Pourquoi ne se sont-ils pas lev√©s?  Peut-√™tre qu'il devrait y avoir un d√©marrage automatique?  Apr√®s avoir recherch√© la r√©ponse, nous avons constat√© que la version du plugin ne correspond pas.  Pourquoi les n≈ìuds principaux sont-ils tomb√©s?  Ils ont √©t√© tu√©s par OOM Killer.  C'est une telle chose sur les machines Linux, qui en cas de manque de m√©moire ferme les processus inutiles.  Pourquoi n'y a-t-il pas assez de m√©moire?  Parce que le processus de mise √† jour a commenc√©, ce qui d√©coule des journaux syst√®me.  Pourquoi cela a-t-il fonctionn√© avant, mais pas maintenant?  Et comme nous avions ajout√© de nouveaux n≈ìuds une semaine plus t√¥t, les n≈ìuds ma√Ætres avaient donc besoin de plus de m√©moire pour stocker les index et les configurations de cluster. <br><br>  Les questions "pourquoi?"  aider √† trouver la racine du probl√®me.  Dans l'exemple, nous pourrions d√©sactiver le bon chemin plusieurs fois, mais le correctif complet ressemble √† ceci: mettre √† jour le plug-in, lancer les services, augmenter la m√©moire et prendre une note pour l'avenir, que la prochaine fois, lors de l'ajout de nouveaux n≈ìuds au cluster, vous devez vous assurer que la m√©moire sur Master est suffisante Noeuds <br><br>  L'application de ces r√®gles vous permet de r√©v√©ler des probl√®mes r√©els, de vous concentrer sur la r√©solution de ces probl√®mes et aide √† communiquer.  Mais ce serait encore mieux si ces r√®gles formaient un syst√®me.  Et il existe un tel syst√®me, il s'appelle l'algorithme de d√©bogage. <br><br><h2>  Algorithme de d√©bogage </h2><br>  Pour la premi√®re fois, j'ai lu √† propos de l'algorithme de d√©bogage dans le livre John Robbins Debugging applications.  Il d√©crit le processus de d√©bogage comme suit: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f1e/2af/a07/f1e2afa078f2ab8587467660b25df052.png"><br><br>  Cet algorithme est utile pour sa boucle interne - travaillant avec une hypoth√®se. <br><br>  A chaque tour de cycle, nous pouvons nous v√©rifier: en savons-nous plus sur le syst√®me ou non?  Si nous √©mettons des hypoth√®ses, v√©rifiez, elles ne fonctionnent pas, nous n‚Äôapprenons rien de nouveau sur le fonctionnement du syst√®me, alors il est probablement temps de se rafra√Æchir.  Deux questions actuelles √† ce stade: quelles hypoth√®ses avez-vous test√©es et quelle hypoth√®se testez-vous maintenant. <br><br>  Cet algorithme s'accorde tr√®s bien avec les r√®gles de d√©bogage dont nous avons parl√© plus haut: r√©p√©tez l'erreur - c'est votre bogue, d√©crivez le probl√®me - comprenez le syst√®me, formulez une hypoth√®se - divisez et conqu√©rez, testez l'hypoth√®se - v√©rifiez la fiche, assurez-vous qu'elle est corrig√©e - cinq pourquoi. <br><br>  J'ai un bon exemple pour cet algorithme.  Une exception est tomb√©e sur l'un de nos services Web. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/206/a57/d71/206a57d711a7c783c9f22389120d1bf8.png"><br><br>  Notre premi√®re pens√©e n'est pas notre probl√®me.  Mais selon les r√®gles, c'est toujours notre probl√®me. <br><br>  Tout d'abord, r√©p√©tez l'erreur.  Pour chaque millier de demandes, il existe environ une <code>StructureMapException</code> , afin que nous puissions reproduire le probl√®me. <br><br>  Deuxi√®mement, nous essayons de d√©crire le probl√®me: si l'utilisateur fait une demande http pour notre service au moment o√π StructureMap essaie de cr√©er une nouvelle d√©pendance, alors une exception se produit. <br><br>  Troisi√®mement, nous √©mettons l'hypoth√®se que StructureMap est un wrapper et qu'il y a quelque chose √† l'int√©rieur qui l√®ve une exception interne.  Nous testons l'hypoth√®se √† l'aide de procdump.exe. <br><br><pre> <code class="hljs powershell">procdump.exe <span class="hljs-literal"><span class="hljs-literal">-ma</span></span> <span class="hljs-literal"><span class="hljs-literal">-e</span></span> <span class="hljs-operator"><span class="hljs-operator">-f</span></span> StructureMap w3wp.exe</code> </pre><br>  Il s'av√®re que l'int√©rieur est une <code>NullReferenceException</code> . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2da/773/500/2da773500ffd18d1c28b91f6ff5b45e3.png"><br><br>  En √©tudiant la pile d'appels de cette exception, nous comprenons qu'elle se produit √† l'int√©rieur du g√©n√©rateur d'objet dans le StructureMap lui-m√™me. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5fd/347/8fc/5fd3478fc54df6295244471a33560a3d.png"><br><br>  Mais <code>NullReferenceException</code> n'est pas le probl√®me lui-m√™me, mais la cons√©quence.  Vous devez comprendre o√π cela se produit et qui le g√©n√®re. <br><br>  Nous proposons l'hypoth√®se suivante: pour une raison quelconque, notre code retourne une d√©pendance nulle.  √âtant donn√© que dans .Net tous les objets en m√©moire sont localis√©s un par un, si nous regardons les objets sur le tas qui se trouvent avant la <code>NullReferenceException</code> , ils pointeront probablement vers le code qui a lev√© l'exception. <br><br>  Dans WinDbg, il existe une commande - Liste des objets proches <code>!lno</code> .  Cela montre que l'objet qui nous int√©resse est la fonction lambda, qui est utilis√©e dans le code suivant. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> CompoundInterceptor </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FindInterceptor</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Type type</span></span></span><span class="hljs-function">)</span></span> { CompoundInterceptop interceptor; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_analyzedInterceptors.TryGetValue(type, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> interceptor)) { <span class="hljs-keyword"><span class="hljs-keyword">lock</span></span> (_locker) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_analyzedInterceptors.TryGetValue(type, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> interceptor)) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> interceptorArray = _interceptors.FindAll(i =&gt; i.MatchesType(type)); interceptor = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CompoundInterceptor(interceptorArray); _analyzedInterceptors.Add(type, interceptor); } } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> interceptor; }</code> </pre><br>  Dans ce code, nous v√©rifions d'abord si la valeur dans le <code>Dictionary</code> <code>_analyzedInterceptors</code> dans <code>_analyzedInterceptors</code> , si nous ne la trouvons pas, puis ajoutons une nouvelle valeur √† l'int√©rieur du <code>lock</code> . <br><br>  En th√©orie, ce code ne peut jamais retourner null.  Mais le probl√®me ici est dans <code>_analyzedInterceptors</code> , qui utilise un <code>Dictionary</code> ordinaire dans un environnement multi-thread, pas un <code>ConcurrentDictionary</code> . <br><br>  La racine du probl√®me a √©t√© trouv√©e, nous avons mis √† jour la derni√®re version de StructureMap, d√©ploy√©e, v√©rifi√© que tout √©tait corrig√©.  La derni√®re √©tape de notre algorithme est ¬´apprendre et dire¬ª.  Dans notre cas, il s'agissait d'une recherche dans le code de tous les <code>Dictionary</code> utilis√©s dans le verrouillage et de v√©rifier que tous sont utilis√©s correctement. <br><br>  Ainsi, l'algorithme de d√©bogage est un algorithme intuitif qui fait gagner un temps consid√©rable.  Il se concentre sur l'hypoth√®se - et c'est la chose la plus importante dans le d√©bogage. <br><br><h2>  D√©bogage proactif </h2><br>  √Ä la base, le d√©bogage proactif r√©pond √† la question ¬´que se passe-t-il lorsqu'un bogue appara√Æt¬ª. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7aa/718/900/7aa71890010a8c32900fa5b01e0b690a.png"><br><br>  L'importance des techniques de d√©bogage proactives peut √™tre vue dans le diagramme du cycle de vie des bogues. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/be0/f6f/06c/be0f6f06cb0c810ca6b19cb861d998c4.png"><br><br>  Le probl√®me est que plus la dur√©e de vie du bogue est longue, plus nous consacrons de ressources (temps) √† celui-ci. <br><br>  Les r√®gles de d√©bogage et l'algorithme de d√©bogage nous concentrent sur le moment o√π le bogue est d√©tect√© et nous pouvons d√©terminer quoi faire ensuite.  En fait, nous voulons changer notre focus au moment o√π le bogue a √©t√© cr√©√©.  Je crois que nous devrions faire le produit minimum d√©boguable (MDP), c'est-√†-dire un produit qui poss√®de le minimum d'infrastructure n√©cessaire pour un d√©bogage efficace en production. <br><br>  MDP se compose de deux choses: la fonction fitness et la m√©thode USE. <br><br>  Caract√©ristiques de remise en forme.  Ils ont √©t√© popularis√©s par Neil Ford et co-auteurs dans le livre Building Evolutionary Architectures.  √Ä la base, les fonctions de fitness, selon les auteurs du livre, ressemblent √† ceci: il existe une architecture d'application que nous pouvons couper sous diff√©rents angles, obtenant des propri√©t√©s architecturales telles que la <i>maintenabilit√©</i> , les <i>performances</i> , etc., et pour chaque section, nous devons √©crire un test - fitness -fonction.  Ainsi, une fonction de fitness est un test d'architecture. <br><br>  Dans le cas de MDP, la fonction fitness est un test de d√©bogage.  Vous pouvez utiliser tout ce que vous voulez pour √©crire de tels tests: NUnit, MSTest, etc.  Mais, comme le d√©bogage fonctionne souvent avec des outils externes, je vais d√©montrer l'utilisation de Pester (framework de test d'unit√© powershell) comme exemple.  Son avantage ici est qu'il fonctionne bien avec la ligne de commande. <br><br>  Par exemple, au sein de l'entreprise, nous convenons d'utiliser des biblioth√®ques sp√©cifiques pour la journalisation;  lors de la journalisation, nous utiliserons des mod√®les sp√©cifiques;  les caract√®res pdb doivent toujours √™tre donn√©s au serveur de symboles.  Ce seront les conventions que nous testerons dans nos tests. <br><br><pre> <code class="hljs powershell">Describe <span class="hljs-string"><span class="hljs-string">'Debuggability'</span></span> { It <span class="hljs-string"><span class="hljs-string">'Contains line numbers in PDBs'</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">Get-ChildItem</span></span> <span class="hljs-literal"><span class="hljs-literal">-Path</span></span> . <span class="hljs-literal"><span class="hljs-literal">-Recurse</span></span> <span class="hljs-literal"><span class="hljs-literal">-Include</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">@</span></span>(<span class="hljs-string"><span class="hljs-string">"*.exe"</span></span>, <span class="hljs-string"><span class="hljs-string">"*. dll "</span></span>) ` | <span class="hljs-built_in"><span class="hljs-built_in">ForEach-Object</span></span> { &amp;symchk.exe /v <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$_</span></span></span><span class="hljs-string">"</span></span> /s <span class="hljs-string"><span class="hljs-string">"\\network\"</span></span> *&gt;&amp;<span class="hljs-number"><span class="hljs-number">1</span></span> } ` | <span class="hljs-built_in"><span class="hljs-built_in">Where-Object</span></span> { <span class="hljs-variable"><span class="hljs-variable">$_</span></span> <span class="hljs-operator"><span class="hljs-operator">-like</span></span> <span class="hljs-string"><span class="hljs-string">"*Line nubmers: TRUE*"</span></span> } ` | Should <span class="hljs-operator"><span class="hljs-operator">-Not</span></span> ‚ÄìBeNullOrEmpty } }</code> </pre><br>  Ce test v√©rifie que tous les caract√®res pdb ont √©t√© donn√©s au serveur de symboles et ont √©t√© donn√©s correctement, c'est-√†-dire ceux qui contiennent des num√©ros de ligne √† l'int√©rieur.  Pour ce faire, nous prenons la version compil√©e de la production, trouvons tous les fichiers exe et dll, passons tous ces fichiers binaires via l'utilitaire syschk.exe, qui est inclus dans le package des outils de d√©bogage pour Windows.  L'utilitaire syschk.exe v√©rifie le binaire avec le serveur de symboles et, s'il y trouve un fichier pdb, imprime un rapport √† ce sujet.  Dans le rapport, nous recherchons la ligne ¬´Num√©ros de ligne: VRAI¬ª.  Et en finale on v√©rifie que le r√©sultat n'est pas ¬´nul ou vide¬ª. <br><br>  Ces tests doivent √™tre int√©gr√©s dans un pipeline de d√©ploiement continu.  Une fois les tests d'int√©gration et les tests unitaires r√©ussis, les fonctions de mise en forme sont lanc√©es. <br><br>  Je vais montrer un autre exemple avec la v√©rification des biblioth√®ques n√©cessaires dans le code. <br><br><pre> <code class="hljs powershell">Describe <span class="hljs-string"><span class="hljs-string">'Debuggability'</span></span> { It <span class="hljs-string"><span class="hljs-string">'Contains package for logging'</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">Get-ChildItem</span></span> <span class="hljs-literal"><span class="hljs-literal">-Path</span></span> . <span class="hljs-literal"><span class="hljs-literal">-Recurse</span></span> <span class="hljs-literal"><span class="hljs-literal">-Name</span></span> <span class="hljs-string"><span class="hljs-string">"packages.config"</span></span> ` | <span class="hljs-built_in"><span class="hljs-built_in">ForEach-Object</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">Get-Content</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$_</span></span></span><span class="hljs-string">"</span></span> } ` | <span class="hljs-built_in"><span class="hljs-built_in">Where-Object</span></span> { <span class="hljs-variable"><span class="hljs-variable">$_</span></span> <span class="hljs-operator"><span class="hljs-operator">-like</span></span> <span class="hljs-string"><span class="hljs-string">"*nlog*"</span></span> } ` | Should <span class="hljs-operator"><span class="hljs-operator">-Not</span></span> ‚ÄìBeNullOrEmpty } }</code> </pre><br>  Dans le test, nous prenons tous les fichiers packages.config et essayons d'y trouver les biblioth√®ques nlog.  De m√™me, nous pouvons v√©rifier que le champ id de corr√©lation est utilis√© √† l'int√©rieur du champ nlog. <br><br>  UTILISEZ les m√©thodes.  La derni√®re chose que MDP comprend est les mesures que vous devez collecter. <br><br>  Je vais d√©montrer par l'exemple de la m√©thode USE, qui a √©t√© popularis√©e par Brendan Gregg.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'id√©e est simple: s'il y a un probl√®me dans le code, il suffit de prendre trois m√©triques: utilisation (saturation), saturation (erreurs), ce qui aidera √† comprendre o√π est le probl√®me. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Certaines entreprises, par exemple Circonus (elles font du soft monitoring), </font><font style="vertical-align: inherit;">construisent </font><font style="vertical-align: inherit;">leurs </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tableaux</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">bord</font></a><font style="vertical-align: inherit;"> sous forme de m√©triques d√©sign√©es. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/70a/f58/382/70af583826e562f796fb0473c520db15.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si vous regardez en d√©tail, par exemple, la m√©moire, alors l'utilisation est la quantit√© de m√©moire libre, la saturation est le nombre d'acc√®s au disque, les erreurs sont toutes les erreurs qui sont apparues. </font><font style="vertical-align: inherit;">Par cons√©quent, pour rendre les produits plus pratiques pour le d√©bogage, vous devez collecter les m√©triques USE pour toutes les fonctionnalit√©s et toutes les parties du sous-syst√®me. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si vous utilisez une fonctionnalit√© commerciale, vous pouvez tr√®s probablement y distinguer trois mesures:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Utilisation - temps de traitement de la demande. </font></font><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> La saturation est la longueur de la file d'attente. </font></font><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Erreurs - toutes situations exceptionnelles. </font></font><br></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√Ä titre d'exemple, regardons un graphique du nombre de demandes trait√©es par l'un de nos syst√®mes. </font><font style="vertical-align: inherit;">Comme vous pouvez le constater, le service n'a pas trait√© les demandes au cours des trois derni√®res heures. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/6cc/f89/7ab/6ccf897ab0758b344dfc940eb9be548b.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La premi√®re hypoth√®se que nous avons faite est que le service est tomb√© et que nous devons le red√©marrer. </font><font style="vertical-align: inherit;">Lors de la v√©rification, il s'av√®re que le service fonctionne, il utilise 4-5% du CPU. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/7e1/9a3/f4a/7e19a3f4a52547627e150401b0f1e7e7.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La deuxi√®me hypoth√®se est qu'une erreur rel√®ve du service que nous ne voyons pas. </font><font style="vertical-align: inherit;">Nous utiliserons l'utilitaire etrace.</font></font><br><br><pre> <code class="hljs powershell">etrace -<span class="hljs-literal"><span class="hljs-literal">-kernel</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Process</span></span> ^ -<span class="hljs-literal"><span class="hljs-literal">-where</span></span> ProcessName=Ex5<span class="hljs-literal"><span class="hljs-literal">-Service</span></span> ^ -<span class="hljs-literal"><span class="hljs-literal">-clr</span></span> Exception</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'utilitaire vous permet de vous abonner aux √©v√©nements ETW en temps r√©el et de les afficher √† l'√©cran. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/f1a/d13/52b/f1ad1352bc6e02e3a660f64ce90fdc87.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">On voit que √ßa tombe </font></font><code>OutOfMemoryException</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Mais, la deuxi√®me question, pourquoi n'est-elle pas dans les journaux? </font><font style="vertical-align: inherit;">La r√©ponse est rapide - nous l'interceptons, essayons de nettoyer la m√©moire, attendons un peu et recommen√ßons √† travailler.</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (ShouldContinue()) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Do(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (OutOfMemoryException) { Thread.Sleep(<span class="hljs-number"><span class="hljs-number">100</span></span>); GC.CollectionCount(<span class="hljs-number"><span class="hljs-number">2</span></span>); GC.WaitForPendingFinalizers(); } }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'hypoth√®se suivante est que quelqu'un mange toute la m√©moire. </font><font style="vertical-align: inherit;">Selon le vidage de la m√©moire, la plupart des objets sont dans le cache.</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Cache</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> ConcurrentDictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, String&gt; _items = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> DateTime _nextClearTime = DateTime.UtcNow; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetFromCache</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> key</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_nextClearTime &lt; DateTime.UtcNow) { _nextClearTime = DateTime.UtcNow.AddHours(<span class="hljs-number"><span class="hljs-number">1</span></span>); _items.Clear(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _items[key]; } }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le code montre que toutes les heures, le cache doit √™tre effac√©. </font><font style="vertical-align: inherit;">Mais la m√©moire n'√©tait pas suffisante, ils n'ont m√™me pas atteint le nettoyage. </font><font style="vertical-align: inherit;">Regardons un exemple de la m√©trique de cache USE. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/0c6/174/634/0c6174634447a3bd1af03adf10c14cbe.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Selon le calendrier, il est imm√©diatement visible - la m√©moire a augment√©, les erreurs ont imm√©diatement commenc√©. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Donc, conclusions sur ce qu'est le d√©bogage proactif.</font></font><br><br><ul><li>  ‚Äî    .  , ,    ‚Äî    .    ‚Äî    ,      -.     ,       . <br></li><li>     .             ;  Exception ,   ,     -   . <br></li><li> Minimum Debuggable Product ‚Äî  ,          . <br></li></ul><br><h2> ,    ? </h2><br><ol><li>   . <br></li><li>  . <br></li><li>  . <br></li></ol><br><hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cette fois, le sponsor de notre annonce est Jon Skeet. </font><font style="vertical-align: inherit;">M√™me si vous n'allez pas √† Moscou pour le nouveau </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DotNext</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , la vid√©o vaut le d√©tour (John a essay√© dur).</font></font><br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/p2SQbq-umy4" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr420793/">https://habr.com/ru/post/fr420793/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr420777/index.html">Connexion √† Android Studio sans code</a></li>
<li><a href="../fr420779/index.html">Soci√©t√© Boring Mask: tunnel vers le stade et ouverture du tunnel</a></li>
<li><a href="../fr420783/index.html">Gestion des d√©pendances, √©v√©nements et mod√®les d'observateurs et de m√©diateurs</a></li>
<li><a href="../fr420785/index.html">Travailler en tant que sp√©cialiste informatique en Extr√™me-Orient - Oblast de Sakhaline</a></li>
<li><a href="../fr420791/index.html">Robots domestiques: ce que vous pouvez acheter. Aper√ßu des robots domestiques commerciaux disponibles</a></li>
<li><a href="../fr420795/index.html">Id√©es fausses de l'analyste</a></li>
<li><a href="../fr420797/index.html">L'apprentissage ne peut pas √™tre remis √† plus tard</a></li>
<li><a href="../fr420799/index.html">MPS 2018.2: tests de g√©n√©rateur, plug-in GitHub, aspect VCS, notifications de migration, etc.</a></li>
<li><a href="../fr420803/index.html">Cours d'impression 3D. √âconomie de plastique lors de l'impression de mod√®les non fonctionnels √† partir de 3Dtool</a></li>
<li><a href="../fr420805/index.html">[Fran√ßais] Quand utiliser des flux parall√®les</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>