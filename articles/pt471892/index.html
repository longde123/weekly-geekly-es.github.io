<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèø‚Äçü§ù‚Äçüë©üèæ üëÇüèæ üë®‚Äçüè≠ 6 hist√≥rias pr√°ticas de nossos dias da semana do SRE üí∞ ü§û ‚ôãÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A infraestrutura da web moderna consiste em muitos componentes para diversos fins, com √≥bvia e n√£o muito interconectada. Isso se torna especialmente e...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>6 hist√≥rias pr√°ticas de nossos dias da semana do SRE</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/471892/"><img src="https://habrastorage.org/webt/7_/c-/_w/7_c-_wura080ohc4zdfyq6ummtw.png"><br><br>  A infraestrutura da web moderna consiste em muitos componentes para diversos fins, com √≥bvia e n√£o muito interconectada.  Isso se torna especialmente evidente quando aplicativos operacionais que usam pilhas de software diferentes, que com o advento dos microsservi√ßos, come√ßaram a ocorrer literalmente a cada passo.  Fatores externos (APIs de terceiros, servi√ßos etc.) s√£o adicionados √† "divers√£o" geral, o que complica uma imagem j√° dif√≠cil. <br><br>  Em geral, mesmo que essas aplica√ß√µes sejam unidas por id√©ias e solu√ß√µes arquitet√¥nicas comuns, para eliminar problemas incomuns, muitas vezes precisam percorrer as pr√≥ximas √°reas desconhecidas.  Se esses problemas ocorrem √© apenas uma quest√£o de tempo.  Estes s√£o os exemplos de nossas pr√°ticas mais recentes √†s quais este artigo √© dedicado.  Elenco: Golang, Sentry, RabbitMQ, nginx, PostgreSQL e outros. <a name="habracut"></a><br><br><h2>  Hist√≥ria n¬∫ 1.  Golang e HTTP / 2 </h2><br>  A execu√ß√£o de um benchmark que executa muitas solicita√ß√µes HTTP para um aplicativo Web levou a resultados inesperados.  Um aplicativo Go simples no processo de benchmark vai para outro aplicativo Go localizado atr√°s de ingress / openresty.  Quando o HTTP / 2 est√° ativado, obtemos erros com o c√≥digo 400 para algumas solicita√ß√µes. Para entender o motivo desse comportamento, removemos o aplicativo Go do outro lado da cadeia e fizemos um local simples no Ingress, que sempre retorna 200. O comportamento n√£o mudou! <cut></cut><br><br>  Decidiu-se ent√£o reproduzir o script fora do ambiente Kubernetes - em outro peda√ßo de ferro.  O resultado foi um Makefile, com a ajuda do qual s√£o lan√ßados dois cont√™ineres: em um - benchmarks que v√£o para o nginx, no outro - no Apache.  Ambos ouvem o HTTP / 2 com um certificado autoassinado.  O tempo final de opera√ß√£o, veja <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://github.com/flant/examples/tree/master/2019/09-">neste reposit√≥rio</a> . <br><br>  Execute os benchmarks com <code>concurrency=200</code> : <br><br>  1.1  Nginx: <br><br><pre> <code class="plaintext hljs">Completed 0 requests Completed 1000 requests Completed 2000 requests Completed 3000 requests Completed 4000 requests Completed 5000 requests Completed 6000 requests Completed 7000 requests Completed 8000 requests Completed 9000 requests ----- Bench results begin ----- Requests per second: 10336.09 Failed requests: 1623 ----- Bench results end -----</code> </pre> <br>  1.2  Apache: <br><br><pre> <code class="plaintext hljs">‚Ä¶ ----- Bench results begin ----- Requests per second: 11427.60 Failed requests: 0 ----- Bench results end -----</code> </pre> <br>  Assumimos que o ponto aqui √© uma implementa√ß√£o menos rigorosa do HTTP / 2 no Apache. <br><br>  Vamos tentar com <code>concurrency=1000</code> : <br><br>  2.1  Nginx: <br><br><pre> <code class="plaintext hljs">‚Ä¶ ----- Bench results begin ----- Requests per second: 11274.92 Failed requests: 4205 ----- Bench results end -----</code> </pre> <br>  2.2  Apache: <br><br><pre> <code class="plaintext hljs">‚Ä¶ ----- Bench results begin ----- Requests per second: 11211.48 Failed requests: 5 ----- Bench results end -----</code> </pre> <br>  Ao mesmo tempo, observamos que os resultados <i>nem sempre</i> s√£o <i>reproduzidos</i> : alguns dos lan√ßamentos passam sem problemas. <br><br>  Uma busca por problemas no github do projeto Golang levou aos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">n√∫meros</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">25009</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">32441</a> .  Atrav√©s deles, fomos para o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">PR 903</a> : desativando o HTTP / 2 no Go por padr√£o! <br><br>  Interpretar resultados de benchmark sem mergulhar profundamente na arquitetura dos servidores Web acima √© bastante dif√≠cil.  Em um caso espec√≠fico, foi suficiente desativar o HTTP / 2 para o servi√ßo especificado. <br><br><h2>  Hist√≥ria No. 2.  Symfony e sentinela antigos </h2><br>  Em um dos projetos, uma vers√£o muito antiga do framework PHP symfony (v2.3) ainda est√° funcionando.  Um cliente Raven antigo e uma classe auto-escrita em PHP s√£o anexados a ele "no kit", o que complica um pouco a depura√ß√£o. <br><br>  Depois de transferir um dos servi√ßos no Kubernetes para o Sentry, usado para rastrear erros na aplica√ß√£o deste projeto, os eventos pararam subitamente.  Para reproduzir esse comportamento, usamos exemplos do site Sentry, pegando duas op√ß√µes e copiando o DSN das configura√ß√µes do Sentry.  Visualmente, tudo funcionou: mensagens de erro (supostamente) foram enviadas uma ap√≥s a outra. <br><br>  Op√ß√£o de verifica√ß√£o de JavaScript: <br><br><pre> <code class="javascript hljs">&lt;!DOCTYPE html&gt; <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">html</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">body</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"https://browser.sentry-cdn.com/5.6.3/bundle.min.js"</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">integrity</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"sha384-/Cqa/8kaWn7emdqIBLk3AkFMAHBk0LObErtMhO+hr52CntkaurEnihPmqYj3uJho"</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">crossorigin</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"anonymous"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="undefined"><span class="xml"><span class="undefined"> </span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">JavaScript in Body</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"demo"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">A Paragraph.</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">button</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"button"</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">onclick</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"myFunction()"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">Try it</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">button</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="javascript"><span class="xml"><span class="javascript"> Sentry.init({ </span></span><span class="hljs-attr"><span class="xml"><span class="javascript"><span class="hljs-attr">dsn</span></span></span></span><span class="xml"><span class="javascript">: </span></span><span class="hljs-string"><span class="xml"><span class="javascript"><span class="hljs-string">'http://33dddd76e9f0c4ddcdb51@sentry.kube-dev.test//12'</span></span></span></span><span class="xml"><span class="javascript"> }); </span></span><span class="hljs-keyword"><span class="xml"><span class="javascript"><span class="hljs-keyword">try</span></span></span></span><span class="xml"><span class="javascript"> { </span></span><span class="hljs-keyword"><span class="xml"><span class="javascript"><span class="hljs-keyword">throw</span></span></span></span><span class="xml"><span class="javascript"> </span></span><span class="hljs-keyword"><span class="xml"><span class="javascript"><span class="hljs-keyword">new</span></span></span></span><span class="xml"><span class="javascript"> </span></span><span class="hljs-built_in"><span class="xml"><span class="javascript"><span class="hljs-built_in">Error</span></span></span></span><span class="xml"><span class="javascript">(</span></span><span class="hljs-string"><span class="xml"><span class="javascript"><span class="hljs-string">'Caught'</span></span></span></span><span class="xml"><span class="javascript">); } </span></span><span class="hljs-keyword"><span class="xml"><span class="javascript"><span class="hljs-keyword">catch</span></span></span></span><span class="xml"><span class="javascript"> (err) { Sentry.captureException(err); } </span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">body</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">html</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre><br>  Da mesma forma em Python: <br><br><pre> <code class="python hljs"> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sentry_sdk <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> init, capture_message init(<span class="hljs-string"><span class="hljs-string">"http://33dddd76e9f0c4ddcdb51@sentry.kube-dev.test//12"</span></span>) capture_message(<span class="hljs-string"><span class="hljs-string">"Hello World"</span></span>) <span class="hljs-comment"><span class="hljs-comment"># Will create an event. raise ValueError()</span></span></code> </pre> <br>  No entanto, eles n√£o entraram no Sentry.  Ao enviar uma mensagem, √© criada a ilus√£o de que a mensagem foi enviada, porque os clientes geram imediatamente um hash para o problema. <br><br>  Como resultado, o problema foi resolvido com muita simplicidade: o envio de eventos foi para HTTP, e o servi√ßo Sentry ouviu apenas HTTPS.  Foi fornecido um redirecionamento de HTTP para HTTPS, mas o cliente antigo (o c√≥digo no lado do symfony) n√£o conseguiu seguir os redirecionamentos, o que voc√™ n√£o espera por padr√£o atualmente. <br><br><h2>  Hist√≥ria n¬∫ 3.  RabbitMQ e proxy de terceiros </h2><br>  Em um projeto, a nuvem Evotor √© usada para conectar caixas registradoras.  De fato, funciona como um proxy: as solicita√ß√µes POST do Evotor v√£o diretamente para o RabbitMQ - atrav√©s do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">plug</a> - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">in STOMP</a> implementado nas conex√µes WebSocket. <br><br>  Um dos desenvolvedores fez solicita√ß√µes de teste usando o Postman e recebeu as respostas esperadas de <code>200 OK</code> , no entanto, solicita√ß√µes atrav√©s da nuvem levaram a um inesperado <code>405 Method Not Allowed</code> . <br><br><div class="spoiler">  <b class="spoiler_title">200 OK</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">source: kubernetes namespace: kube-nginx-ingress host: kube-node-2 pod_name: nginx-2bpt7 container_name: nginx stream: stdout app: nginx controller-revision-hash: 5bdbfd564 pod-template-generation: 25 time: 2019-09-10T09:42:50+00:00 request_id: 1271dba228f0943ab2df0196ff0d7f67 user: client address: 100.200.300.400 protocol: HTTP/1.1 scheme: http method: POST host: rmq-review.kube-dev.client.domain path: /api/queues/vhost/queue.gen.eeeeffff111:1.onlinecassa:55556666/get request_query: referrer: user_agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/65.0.3325.181 Safari/537.36 content_kind: cacheable namespace: review ingress: stomp-ws service: rabbitmq service_port: stats vhost: rmq-review.kube-dev.client.domain location: / nginx_upstream_addr: 10.127.1.1:15672 nginx_upstream_bytes_received: 2538 nginx_upstream_response_time: 0.008 nginx_upstream_status: 200 bytes_received: 757 bytes_sent: 1254 request_time: 0 status: 200 upstream_response_time: 0 upstream_retries: 0</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">405 M√©todo n√£o permitido</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">source: kubernetes namespace: kube-nginx-ingress host: kube-node-1 pod_name: nginx-4xx6h container_name: nginx stream: stdout app: nginx controller-revision-hash: 5bdbfd564 pod-template-generation: 25 time: 2019-09-10T09:46:26+00:00 request_id: b8dd789604864c95b4af499ed6805630 user: client address: 200.100.300.400 protocol: HTTP/1.1 scheme: http method: POST host: rmq-review.kube-dev.client.domain path: /api/queues/vhost/queue.gen.ef7fb93387ca9b544fc1ecd581cad4a9:1.onlinecassa:55556666/get request_query: referrer: user_agent: ru.evotor.proxy/37 content_kind: cache-headers-not-present namespace: review ingress: stomp-ws service: rabbitmq service_port: stats vhost: rmq-review.kube-dev.client.domain location: / nginx_upstream_addr: 10.127.1.1:15672 nginx_upstream_bytes_received: 134 nginx_upstream_response_time: 0.004 nginx_upstream_status: 405 bytes_received: 878 bytes_sent: 137 request_time: 0 status: 405 upstream_response_time: 0 upstream_retries: 0</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Pedido tcpdump da Evotor</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">200.100.300.400.21519 &gt; 100.200.400.300: Flags [P.], cksum 0x8e29 (correct), seq 1:879, ack 1, win 221, options [nop,nop,TS val 2313007107 ecr 79097074], length 878: HTTP, length: 878 POST /api/queues//vhost/queue.gen.ef7fb93387ca9b544fc1ecd581cad4a9:1.onlinecassa:55556666/get HTTP/1.1 device-model: ST-5 device-os: android Accept-Encoding: gzip content-type: application/json; charset=utf-8 connection: close accept: application/json x-original-forwarded-for: 10.11.12.13 originhost: rmq-review.kube-dev.client.domain x-original-uri: /api/v2/apps/e114-aaef-bbbb-beee-abadada44ae/requests x-scheme: https accept-encoding: gzip user-agent: ru.evotor.proxy/37 Authorization: Basic X-Evotor-Store-Uuid: 20180417-73DC-40C9-80B7-00E990B77D2D X-Evotor-Device-Uuid: 20190909-A47B-40EA-806A-F7BC33833270 X-Evotor-User-Id: 01-000000000147888 Content-Length: 58 Host: rmq-review.kube-dev.client.domain {"count":1,"encoding":"auto","ackmode":"ack_requeue_true"}[!http] 12:53:30.095385 IP (tos 0x0, ttl 64, id 5512, offset 0, flags [DF], proto TCP (6), length 52) 100.200.400.300:80 &gt; 200.100.300.400.21519: Flags [.], cksum 0xfa81 (incorrect -&gt; 0x3c87), seq 1, ack 879, win 60, options [nop,nop,TS val 79097122 ecr 2313007107], length 0 12:53:30.096876 IP (tos 0x0, ttl 64, id 5513, offset 0, flags [DF], proto TCP (6), length 189) 100.200.400.300:80 &gt; 200.100.300.400.21519: Flags [P.], cksum 0xfb0a (incorrect -&gt; 0x03b9), seq 1:138, ack 879, win 60, options [nop,nop,TS val 79097123 ecr 2313007107], length 137: HTTP, length: 137 HTTP/1.1 405 Method Not Allowed Date: Tue, 10 Sep 2019 10:53:30 GMT Content-Length: 0 Connection: close allow: HEAD, GET, OPTIONS</code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">Pedido tcpdump feito por curl</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">777.10.74.11.61211 &gt; 100.200.400.300:80: Flags [P.], cksum 0x32a8 (correct), seq 1:397, ack 1, win 2052, options [nop,nop,TS val 734012594 ecr 4012360530], length 396: HTTP, length: 396 POST /api/queues/%2Fvhost/queue.gen.ef7fb93387ca9b544fc1ecd581cad4a9:1.onlinecassa:55556666/get HTTP/1.1 Host: rmq-review.kube-dev.client.domain User-Agent: curl/7.54.0 Authorization: Basic = Content-Type: application/json Accept: application/json Content-Length: 58 {"count":1,"ackmode":"ack_requeue_true","encoding":"auto"}[!http] 12:40:11.001442 IP (tos 0x0, ttl 64, id 50844, offset 0, flags [DF], proto TCP (6), length 52) 100.200.400.300:80 &gt; 777.10.74.11.61211: Flags [.], cksum 0x2d01 (incorrect -&gt; 0xfa25), seq 1, ack 397, win 59, options [nop,nop,TS val 4012360590 ecr 734012594], length 0 12:40:11.017065 IP (tos 0x0, ttl 64, id 50845, offset 0, flags [DF], proto TCP (6), length 2621) 100.200.400.300:80 &gt; 777.10.74.11.61211: Flags [P.], cksum 0x370a (incorrect -&gt; 0x6872), seq 1:2570, ack 397, win 59, options [nop,nop,TS val 4012360605 ecr 734012594], length 2569: HTTP, length: 2569 HTTP/1.1 200 OK Date: Tue, 10 Sep 2019 10:40:11 GMT Content-Type: application/json Content-Length: 2348 Connection: keep-alive Vary: Accept-Encoding cache-control: no-cache vary: accept, accept-encoding, origin</code> </pre> </div></div><br>  O olho treinado de um engenheiro v√™ imediatamente a diferen√ßa: <br><br><ul><li>  curl: <code>POST /api/queues/%2Fclient‚Ä¶</code> </li><li>  Evotor: <code>POST /api/queues//client‚Ä¶</code> </li></ul><br>  O fato √© que, em um caso, um <code>//vhost</code> incompreens√≠vel (para RabbitMQ) <code>//vhost</code> e no outro - <code>%2Fvhost</code> , que √© o comportamento esperado quando: <br><br><pre> <code class="plaintext hljs"># rabbitmqctl list_vhosts Listing vhosts ... /vhost</code> </pre> <br>  Na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">edi√ß√£o</a> do projeto RabbitMQ sobre este t√≥pico, o desenvolvedor explica: <br><br><blockquote>  N√£o iremos substituir%-codifica√ß√£o.  √â uma maneira padr√£o de codifica√ß√£o de caminho de URL e existe h√° s√©culos.  Assumindo que a codifica√ß√£o% em ferramentas baseadas em HTTP desaparecer√°, at√© mesmo a estrutura mais popular assumindo que esses caminhos de URL s√£o "maliciosos" √© m√≠ope e ing√™nuo.  O nome do host virtual padr√£o pode ser <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">alterado para qualquer valor</a> (como um que n√£o use barras ou outros caracteres que exijam codifica√ß√£o%) e, pelo menos com a vers√£o Pivotal BOSH do RabbitMQ, o host virtual padr√£o √© exclu√≠do no momento da implanta√ß√£o de qualquer maneira . </blockquote><br>  O problema foi resolvido sem o envolvimento de nossos engenheiros (no lado do Evotor ap√≥s entrar em contato com eles). <br><br><h2>  Hist√≥ria n¬∫ 4.  Gene no PostgreSQL </h2><br>  O PostgreSQL possui um √≠ndice muito √∫til, que √© frequentemente esquecido.  Esta hist√≥ria come√ßou com reclama√ß√µes sobre os freios no aplicativo.  Em um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">artigo recente,</a> j√° demos um exemplo de um fluxo de trabalho aproximado ao analisar essas situa√ß√µes.  E aqui nosso APM - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Atatus</a> - mostrou a seguinte imagem: <br><br><img src="https://habrastorage.org/webt/t9/yy/gz/t9yygzwma4valcmjnpt-lbfxpdi.png"><br><br>  √Äs 10h, h√° um aumento no tempo que o aplicativo gasta trabalhando com o banco de dados.  Como esperado, o motivo est√° nas respostas lentas do DBMS.  Para n√≥s, analisar consultas, identificar √°reas problem√°ticas e √≠ndices "paralisados" √© uma rotina compreens√≠vel.  O <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">okmeter</a> que usamos ajuda <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">muito nele</a> : existem dois pain√©is padr√£o para monitorar o status dos servidores e a capacidade de criar <i>rapidamente os</i> nossos - com a sa√≠da de m√©tricas problem√°ticas: <br><br><img src="https://habrastorage.org/webt/5r/8h/2p/5r8h2pfgbo_rxewvzgf_3jyjcii.png"><br><br>  Os gr√°ficos de carregamento da CPU indicam que um dos bancos de dados √© 100% carregado.  Porque  Os novos pain√©is do PostgreSQL solicitar√£o: <br><br><img src="https://habrastorage.org/webt/i0/pq/de/i0pqdejoizrp518mnsnguoljkdg.png"><br><br>  A causa dos problemas √© imediatamente aparente - o principal consumidor da CPU: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> u.* <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span> u <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> u.id = ? &amp; u.field_1 = ? <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> u.field_2 <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> <span class="hljs-string"><span class="hljs-string">'%somestring%'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> u.id <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> ?</code> </pre> <br>  Considerando o plano de trabalho da consulta problem√°tica, descobrimos que a filtragem por campos indexados de uma tabela oferece uma sele√ß√£o muito grande: o banco de dados recebe mais de 70 mil linhas por <code>id</code> e <code>field_1</code> e, em seguida, procura uma substring entre elas.  Acontece que <code>LIKE</code> em uma substring interage com uma grande quantidade de dados de texto, o que leva a um s√©rio abrandamento na execu√ß√£o da consulta e a um aumento na carga da CPU. <br><br>  <i>Aqui, voc√™ pode notar com raz√£o que um problema de arquitetura n√£o est√° descartado (√© necess√°ria uma corre√ß√£o l√≥gica do aplicativo ou at√© mesmo um mecanismo de texto completo ...), mas n√£o h√° tempo para retrabalho, e ele deveria ter funcionado rapidamente 15 minutos atr√°s.</i>  <i>Ao mesmo tempo, a palavra de pesquisa √© realmente um identificador (e por que n√£o em um campo separado? ..), que produz unidades de linhas.</i>  <i>De fato, se pud√©ssemos compor um √≠ndice nesse campo de texto, todos os outros se tornariam desnecess√°rios.</i> <br><br>  A solu√ß√£o final atual √© adicionar um √≠ndice GIN para o <code>field_2</code> .  Esse √© o her√≥i do dia - esse mesmo "g√™nio".  Em resumo, o GIN √© um tipo de √≠ndice que tem um desempenho muito bom na pesquisa de texto completo, acelerando-o qualitativamente.  Voc√™ pode ler mais sobre isso, por exemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">neste material maravilhoso</a> . <br><br><img src="https://habrastorage.org/webt/sm/lw/qd/smlwqdjwdystzwexf0rfz-hk6qq.png"><br><br>  Como voc√™ pode ver, essa opera√ß√£o simples permitiu remover a carga extra e com ela - e economizar dinheiro para o cliente. <br><br><h2>  Hist√≥ria n¬∫ 5.  Armazenando em cache s3 no nginx </h2><br>  O armazenamento em nuvem compat√≠vel com S3 est√° h√° muito tempo na lista de tecnologias usadas por muitos projetos.  Se voc√™ precisar de armazenamento de imagem confi√°vel para o seu site ou para dados de rede neural, o Amazon S3 √© uma √≥tima op√ß√£o.  A confiabilidade do armazenamento e a alta disponibilidade de dados (e a falta da necessidade de "cercar o jardim") s√£o cativantes. <br><br>  No entanto, √†s vezes, para economizar dinheiro - porque geralmente o pagamento do S3 √© feito para solicita√ß√µes e tr√°fego - uma boa solu√ß√£o √© instalar um servidor proxy em cache na frente do armazenamento.  Esse m√©todo reduzir√° os custos quando se trata, por exemplo, de avatares de usu√°rios, dos quais existem muitos em cada p√°gina. <br><br>  Parece que √© mais f√°cil do que pegar o nginx e configurar proxies com cache, revalida√ß√£o, atualiza√ß√£o em segundo plano e outro blackjack?  No entanto, como em outros lugares, existem algumas nuances ... <br><br>  A configura√ß√£o aproximada desse proxy com armazenamento em cache era assim: <br><br><pre> <code class="plaintext hljs">proxy_cache_key $uri; proxy_cache_methods GET HEAD; proxy_cache_lock on; proxy_cache_revalidate on; proxy_cache_background_update on; proxy_cache_use_stale updating error timeout invalid_header http_500 http_502 http_503 http_504; proxy_cache_valid 200 1h; location ~ ^/(?&lt;bucket&gt;avatars|images)/(?&lt;filename&gt;.+)$ { set $upstream $bucket.s3.amazonaws.com; proxy_pass http://$upstream/$filename; proxy_set_header Host $upstream; proxy_cache aws; proxy_cache_valid 200 1h; proxy_cache_valid 404 60s; }</code> </pre> <br>  E, em geral, funcionou: as imagens foram exibidas, tudo estava bem com o cache ... no entanto, surgiram problemas com os clientes do AWS S3.  Em particular, o cliente do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aws-sdk-php</a> parou de funcionar.  A an√°lise dos logs nginx mostrou que o upstream retornou o c√≥digo 403 para solicita√ß√µes HEAD, e a resposta continha um erro espec√≠fico: <code>SignatureDoesNotMatch</code> .  Quando vimos que o nginx faz uma solicita√ß√£o GET para upstream, tudo se encaixou. <br><br>  O fato √© que o cliente S3 assina cada solicita√ß√£o e o servidor verifica essa assinatura.  No caso de proxy simples, tudo funciona bem: a solicita√ß√£o atinge o servidor inalterada.  No entanto, quando o cache est√° ativado, o nginx come√ßa a otimizar o trabalho com o back-end e substitui as solicita√ß√µes HEAD pelo GET.  A l√≥gica √© simples: √© melhor recuperar e salvar o objeto inteiro e, em seguida, todos os pedidos HEAD do cache tamb√©m.  No entanto, no nosso caso, a solicita√ß√£o n√£o pode ser modificada porque est√° assinada. <br><br>  Existem essencialmente duas solu√ß√µes: <br><br><ol><li>  N√£o conduza clientes S3 atrav√©s de proxies; </li><li>  se for "necess√°rio", desative a op√ß√£o <code>proxy_cache_convert_head</code> e adicione <code>$request_method</code> √† chave de cache.  Nesse caso, o nginx envia solicita√ß√µes HEAD "como est√£o" e armazena em cache as respostas separadamente. </li></ol><br><h2>  Hist√≥ria n¬∫ 6.  DDoS e conte√∫do do usu√°rio do Google </h2><br>  A noite de domingo n√£o pressagiou problemas at√© - de repente!  - A fila de invalida√ß√£o de cache nos servidores de borda n√£o aumentou, o que fornece tr√°fego para usu√°rios reais.  Esse √© um sintoma muito estranho: afinal, o cache √© implementado na mem√≥ria e n√£o est√° vinculado aos discos r√≠gidos.  A descarga do cache na arquitetura usada √© uma opera√ß√£o barata, portanto esse erro pode aparecer apenas no caso de uma carga realmente alta.  Isso foi confirmado pelo fato de que os mesmos servidores come√ßaram a notificar o aparecimento de 500 erros <i>(picos de linha vermelha no gr√°fico abaixo)</i> . <br><br><img src="https://habrastorage.org/webt/3-/cr/ec/3-crecmpt9kbmt7o_6gujxwiru0.png"><br><br>  Um aumento t√£o acentuado levou a supera√ß√µes de CPU: <br><br><img src="https://habrastorage.org/webt/2t/vn/cw/2tvncw9vkrti9ysqmil7bmcztk0.png"><br><br>  Uma an√°lise r√°pida mostrou que os pedidos n√£o chegaram aos dom√≠nios principais, mas a partir dos logs ficou claro que eles estavam no vhost padr√£o.  Ao longo do caminho, muitos usu√°rios americanos procuraram o recurso russo.  Tais circunst√¢ncias sempre levantam quest√µes imediatamente. <br><br>  Depois de coletar dados dos logs do nginx, revelamos que estamos lidando com uma certa botnet: <br><br><pre> <code class="plaintext hljs">35.222.30.127 US [15/Sep/2019:21:40:00 +0300] GET "http://example.ru/?ITPDH=XHJI" HTTP/1.1 301 178 "http://example.ru/ORQHYGJES" "Mozilla/5.0 (Windows; U; Windows NT 5.2; en-US; rv:1.9.1.3) Gecko/20090824 Firefox/3.5.3 (.NET CLR 3.5.30729)" "-" "upcache=-" "upaddr=-" "upstatus=-" "uplen=-" "uptime=-" spdy="" "loc=wide-closed.example.ru.undef" "rewrited=/?ITPDH=XHJI" "redirect=http://www.example.ru/?ITPDH=XHJI" ancient=1 cipher=- "LM=-;EXP=-;CC=-" 107.178.215.0 US [15/Sep/2019:21:40:00 +0300] GET "http://example.ru/?REVQSD=VQPYFLAJZ" HTTP/1.1 301 178 "http://www.usatoday.com/search/results?q=MLAJSBZAK" "Mozilla/5.0 (Windows; U; MSIE 7.0; Windows NT 6.0; en-US)" "-" "upcache=-" "upaddr=-" "upstatus=-" "uplen=-" "uptime=-" spdy="" "loc=wide-closed.example.ru.undef" "rewrited=/?REVQSD=VQPYFLAJZ" "redirect=http://www.example.ru/?REVQSD=VQPYFLAJZ" ancient=1 cipher=- "LM=-;EXP=-;CC=-" 107.178.215.0 US [15/Sep/2019:21:40:00 +0300] GET "http://example.ru/?MPYGEXB=OMJ" HTTP/1.1 301 178 "http://engadget.search.aol.com/search?q=MIWTYEDX" "Mozilla/5.0 (Windows; U; Windows NT 6.1; en; rv:1.9.1.3) Gecko/20090824 Firefox/3.5.3 (.NET CLR 3.5.30729)" "-" "upcache=-" "upaddr=-" "upstatus=-" "uplen=-" "uptime=-" spdy="" "loc=wide-closed.example.ru.undef" "rewrited=/?MPYGEXB=OMJ" "redirect=http://www.example.ru/?MPYGEXB=OMJ" ancient=1 cipher=- "LM=-;EXP=-;CC=-"</code> </pre> <br>  Um padr√£o compreens√≠vel √© rastreado nos logs: <br><br><ul><li>  verdadeiro agente do usu√°rio; </li><li>  uma solicita√ß√£o para o URL raiz com um argumento GET aleat√≥rio para evitar entrar no cache; </li><li>  referenciador indica que a solicita√ß√£o veio de um mecanismo de pesquisa. </li></ul><br>  Coletamos os endere√ßos e verificamos sua afilia√ß√£o - todos eles pertencem ao <code>googleusercontent.com</code> , com duas sub-redes (107.178.192.0/18 e 34.64.0.0/10).  Essas sub-redes cont√™m m√°quinas virtuais GCE e v√°rios servi√ßos, como tradu√ß√£o de p√°gina. <br><br>  Felizmente, o ataque n√£o durou tanto tempo (cerca de uma hora) e diminuiu gradualmente.  Parece que os algoritmos de prote√ß√£o dentro do Google funcionaram, ent√£o o problema foi resolvido "por si s√≥". <br><br>  Esse ataque n√£o foi destrutivo, mas levantou quest√µes √∫teis para o futuro: <br><br><ul><li>  Por que os anti-ddos n√£o funcionam?  Um servi√ßo externo √© usado, para o qual enviamos uma solicita√ß√£o correspondente.  No entanto, havia muitos endere√ßos ... </li><li>  Como se proteger disso no futuro?  No nosso caso, at√© op√ß√µes para fechar o acesso em uma base geogr√°fica s√£o poss√≠veis. </li></ul><br><h2>  PS </h2><br>  Leia tamb√©m em nosso blog: <br><br><ul><li>  ‚Äú <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Da vida com o Kubernetes: como os espanh√≥is n√£o se queixaram do servidor HTTP</a> ‚Äù; </li><li>  ‚Äú <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">6 erros divertidos do sistema na opera√ß√£o do Kubernetes [e sua solu√ß√£o]</a> ‚Äù; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">3 casos incomuns sobre o subsistema de rede Linux</a> ." </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt471892/">https://habr.com/ru/post/pt471892/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt471876/index.html">PDU e Tudo-Tudo-Tudo: Distribui√ß√£o de Energia em Rack</a></li>
<li><a href="../pt471878/index.html">Como escrever um contrato inteligente para o WebAssembly em uma rede Ontology? Parte 1: Ferrugem</a></li>
<li><a href="../pt471884/index.html">10 utilit√°rios ApexSQL gratuitos para gerenciar bancos de dados do Microsoft SQL Server</a></li>
<li><a href="../pt471886/index.html">VMmanager 6: apresentando a caixa e comparando com a gera√ß√£o anterior</a></li>
<li><a href="../pt471890/index.html">Infer√™ncia Variacional - o que √© e o que come?</a></li>
<li><a href="../pt471896/index.html">O Inside Playbook. Recursos de rede no novo Ansible Engine 2.9</a></li>
<li><a href="../pt471904/index.html">Planejador de recursos na HPE InfoSight</a></li>
<li><a href="../pt471906/index.html">Os perigos de otimiza√ß√µes impr√≥prias</a></li>
<li><a href="../pt471908/index.html">A inesperada beleza dos n√∫meros primos</a></li>
<li><a href="../pt471912/index.html">Aprendendo ingl√™s: 7 maneiras pr√°ticas de expandir seu vocabul√°rio</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>