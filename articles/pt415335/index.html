<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèΩ‚Äçüé® ‚õàÔ∏è üßìüèº Tutorial de plano de fundo do Android. Parte 5: Corotinas em Kotlin üë®üèΩ‚Äç‚öïÔ∏è üì¶ ‚è≠Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ilha Kotlin 

 Textos anteriores desta s√©rie: sobre AsyncTask , sobre Loaders , sobre Executors e EventBus , sobre RxJava . 

 Ent√£o chegou esta hora....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Tutorial de plano de fundo do Android. Parte 5: Corotinas em Kotlin</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/jugru/blog/415335/"><img src="https://habrastorage.org/webt/r3/h-/kd/r3h-kdmudutyx6g2zcisi4vly7c.png"><br>  <sup>Ilha Kotlin</sup> <br><br>  <i>Textos anteriores desta s√©rie: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">sobre AsyncTask</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">sobre Loaders</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">sobre Executors e EventBus</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">sobre RxJava</a> .</i> <br><br>  Ent√£o chegou esta hora.  Este √© o artigo para o qual toda a s√©rie foi escrita: uma explica√ß√£o de como a nova abordagem funciona "sob o cap√¥".  Se voc√™ ainda n√£o sabe como us√°-lo, aqui est√£o alguns links √∫teis para voc√™ come√ßar: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">P√°gina no site oficial</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Postagem do blog de receitas da Coroutine Android</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Relat√≥rio Roman Elizarov</a> </li></ul><br>  E, ao dominar as corotinas, voc√™ pode se perguntar o que permitiu √† Kotlin oferecer essa oportunidade e como ela funciona.  Observe que aqui vamos nos concentrar apenas no est√°gio de compila√ß√£o: voc√™ pode escrever um artigo separado sobre execu√ß√£o. <br><a name="habracut"></a><br>  A primeira coisa que precisamos entender √© que, no corpus, na verdade n√£o existem corotinas.  O compilador transforma a fun√ß√£o com o modificador de suspens√£o em uma fun√ß√£o com o par√¢metro <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Continuation</a> .  Essa interface possui dois m√©todos: <br><br><pre><code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">resume</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(value: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">T</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">resumeWithException</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(exception: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Throwable</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span></code> </pre> <br>  Tipo T √© o tipo de retorno da sua fun√ß√£o de suspens√£o original.  E aqui est√° o que realmente acontece: essa fun√ß√£o √© executada em um determinado segmento (paci√™ncia, tamb√©m chegamos a isso), e o resultado √© passado para a fun√ß√£o resume dessa continua√ß√£o, no contexto em que a fun√ß√£o de suspens√£o foi chamada.  Se a fun√ß√£o n√£o receber o resultado e gerar uma exce√ß√£o, o resumeWithException ser√° lan√ßado, gerando um erro no c√≥digo de chamada. <br><br>  Ok, mas de onde veio a continua√ß√£o?  Claro, do construtor Corutin!  Vejamos o c√≥digo que cria qualquer corotina, por exemplo, o lan√ßamento: <br><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">actual</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">launch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( context: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">CoroutineContext</span></span></span></span><span class="hljs-function"><span class="hljs-params"> = DefaultDispatcher, start: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">CoroutineStart</span></span></span></span><span class="hljs-function"><span class="hljs-params"> = CoroutineStart.DEFAULT, parent: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Job</span></span></span></span><span class="hljs-function"><span class="hljs-params">? = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">null</span></span></span></span><span class="hljs-function"><span class="hljs-params">, block: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">suspend</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">CoroutineScope</span></span></span></span><span class="hljs-function"><span class="hljs-params">.()</span></span></span></span> -&gt; <span class="hljs-built_in"><span class="hljs-built_in">Unit</span></span> ): Job { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> newContext = newCoroutineContext(context, parent) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> coroutine = <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (start.isLazy) LazyStandaloneCoroutine(newContext, block) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> StandaloneCoroutine(newContext, active = <span class="hljs-literal"><span class="hljs-literal">true</span></span>) coroutine.start(start, coroutine, block) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> coroutine }</code> </pre><br>  Aqui, o construtor cria uma corotina - uma inst√¢ncia da classe AbstractCoroutine, que, por sua vez, implementa a interface de Continua√ß√£o.  O m√©todo start pertence √† interface Job.  Mas encontrar a defini√ß√£o do m√©todo de in√≠cio √© muito dif√≠cil.  Mas podemos vir aqui do outro lado.  Um leitor atento j√° percebeu que o primeiro argumento para a fun√ß√£o de inicializa√ß√£o √© o CoroutineContext, e est√° definido como DefaultDispatcher por padr√£o.  Despachantes s√£o classes que controlam a execu√ß√£o de corotinas, portanto s√£o definitivamente importantes para entender o que est√° acontecendo.  Vejamos a declara√ß√£o DefaultDispatcher: <br><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">actual</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> DefaultDispatcher: CoroutineDispatcher = CommonPool</code> </pre><br>  Ent√£o, na verdade, esse √© o CommonPool, embora as docas java nos digam que isso pode mudar.  O que √© o CommonPool? <br><br>  Este √© um gerenciador de rotinas que usa o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ForkJoinPool</a> como uma implementa√ß√£o do ExecutorService.  Sim, √©: no final, todas as suas rotinas lambda s√£o apenas Runnable, que entraram no Executor com um conjunto de transforma√ß√µes complicadas.  Mas o diabo, como sempre, est√° nos detalhes. <br><br><img src="https://habrastorage.org/webt/jh/yg/wr/jhygwrz-zofdvbpe11tbvvatsqi.jpeg"><br>  <sup>Garfo?</sup>  <sup>Ou participar?</sup> <br><br>  A julgar pelos resultados da pesquisa no meu twitter, aqui preciso explicar brevemente o que √© FJP :) <br><br><div class="oembed"><twitter-widget class="twitter-tweet twitter-tweet-rendered" id="twitter-widget-0" style="position: static; visibility: visible; display: block; transform: rotate(0deg); width: 500px; margin: 10px auto; max-width: 100%; min-width: 220px;" data-tweet-id="991950848996597760"></twitter-widget><script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></div><br>  Primeiro, o ForkJoinPool √© um executor moderno criado para uso com fluxos paralelos do Java 8. A tarefa original era um paralelismo eficiente ao trabalhar com a API Stream, que basicamente significa dividir os fluxos para processar parte dos dados e combin√°-los quando todos os dados forem processados.  Para simplificar, imagine que voc√™ tenha o seguinte c√≥digo: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">IntStream</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.range</span></span>(1, 1_000_000) <span class="hljs-selector-class"><span class="hljs-selector-class">.parallel</span></span>() <span class="hljs-selector-class"><span class="hljs-selector-class">.sum</span></span>()</code> </pre><br>  A quantidade desse fluxo n√£o ser√° calculada em um fluxo. Em vez disso, o ForkJoinPool dividir√° recursivamente o intervalo em partes (primeiro em duas partes de 500.000, depois cada uma em 250.000 e assim por diante), calcule a soma de cada parte e combine os resultados em um √∫nico quantidade.  Aqui est√° uma visualiza√ß√£o desse processo: <br><br><img src="https://habrastorage.org/webt/15/yb/uk/15ybukvbskzmzddp9lytwarsbvy.jpeg"><br>  <sup>Os encadeamentos s√£o divididos para tarefas diferentes e mesclados novamente ap√≥s a conclus√£o</sup> <br><br>  A efic√°cia do FJP √© baseada no algoritmo de "roubo de trabalho": quando um encadeamento espec√≠fico fica sem tarefas, ele vai para as filas de outros encadeamentos de pool e rouba suas tarefas.  Para uma melhor compreens√£o, voc√™ pode ver o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">relat√≥rio de</a> Alexei Shipilev ou assistir a uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">apresenta√ß√£o</a> . <br><br>  Bem, n√≥s percebemos o que nossas corotinas est√£o fazendo!  Mas como eles acabam l√°? <br><br>  Isso acontece dentro do m√©todo de despacho CommonPool #: <br><br><pre> <code class="hljs css">_<span class="hljs-selector-tag"><span class="hljs-selector-tag">pool</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.execute</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">timeSource</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.trackTask</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">block</span></span>))</code> </pre><br>  O m√©todo de despacho √© chamado no m√©todo resume (Value: T) em DispatchedContinuation.  Parece familiar!  Lembramos que a continua√ß√£o √© uma interface implementada no AbstractCoroutine.  Mas como eles est√£o relacionados? <br><br>  O truque est√° dentro da classe CoroutineDispatcher.  Ele implementa a interface ContinuationInterceptor da seguinte maneira: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> actual <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> fun &lt;T&gt; interceptContinuation(continuation: Continuation&lt;T&gt;): Continuation&lt;T&gt; = DispatchedContinuation(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, continuation)</code> </pre><br>  Est√° vendo?  Voc√™ fornece um bloco simples para o construtor corutin.  Voc√™ n√£o precisa implementar nenhuma interface sobre a qual deseja saber nada.  A biblioteca da corotina cuida de tudo isso.  Ela √© <br>  intercepta a execu√ß√£o, substitui a continua√ß√£o por DispatchedContinuation e a envia ao executor, o que garante a execu√ß√£o mais eficiente do seu c√≥digo. <br><br>  Agora, a √∫nica coisa com a qual precisamos lidar √© como o despacho √© chamado a partir do m√©todo start.  Vamos preencher essa lacuna.  O m√©todo resume √© chamado de startCoroutine na fun√ß√£o de extens√£o do bloco: <br><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-type"><span class="hljs-function"><span class="hljs-type">&lt;R, T&gt;</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">suspend</span></span></span></span><span class="hljs-function"><span class="hljs-params"> R.()</span></span></span></span> -&gt; T).startCoroutine( receiver: R, completion: Continuation&lt;T&gt; ) { createCoroutineUnchecked(receiver, completion).resume(<span class="hljs-built_in"><span class="hljs-built_in">Unit</span></span>) }</code> </pre><br>  E startCoroutine, por sua vez, √© chamado pelo operador "()" na enumera√ß√£o CoroutineStart.  Seu construtor aceita como o segundo par√¢metro e o padr√£o √© CoroutineStart.DEFAULT.  Isso √© tudo! <br><br>  Essa √© a raz√£o pela qual admiro a abordagem corutin: n√£o √© apenas uma sintaxe espetacular, mas tamb√©m uma implementa√ß√£o brilhante. <br><br><blockquote>  E para aqueles que leram at√© o final, eles s√£o exclusivos: um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">v√≠deo do</a> meu relat√≥rio ‚ÄúN√£o √© necess√°rio um violinista: recusamos o RxJava em favor da corotina em Kotlin‚Äù da confer√™ncia <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Mobius</a> .  Enjoy :) <br></blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt415335/">https://habr.com/ru/post/pt415335/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt415323/index.html">Projetos de gradua√ß√£o de formandos do Technoproject, primavera de 2018</a></li>
<li><a href="../pt415327/index.html">O teorema de Pit√°goras foi usado pelos construtores de Stonehenge 2000 anos antes do nascimento do pr√≥prio Pit√°goras.</a></li>
<li><a href="../pt415329/index.html">Toda a verdade sobre o RTOS de Colin Walls. Artigo # 3 Tarefas e planejamento</a></li>
<li><a href="../pt415331/index.html">Impressoras de constru√ß√£o para gr√°ficas de 5 a 6 andares s√£o produzidas em Yaroslavl</a></li>
<li><a href="../pt415333/index.html">Arduino - micropoderoso transmissor AM</a></li>
<li><a href="../pt415337/index.html">Como os canais do empurrador j√° entregaram 10.000.000.000.000 de mensagens</a></li>
<li><a href="../pt415341/index.html">Cursos de administra√ß√£o do PostgreSQL</a></li>
<li><a href="../pt415343/index.html"># 2HACKATON para jovens profissionais em Perm</a></li>
<li><a href="../pt415345/index.html">Dicas para decidir se tornar um desenvolvedor iOS</a></li>
<li><a href="../pt415347/index.html">2. Baseado em Meyers ‚ÄúC ++ Efetivo e Moderno‚Äù - detalhes da infer√™ncia de tipo de modelo para matrizes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>