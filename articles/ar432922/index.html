<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>๐ช โ๏ธ ๐คพ๐ฟ ููู ุจุญุซูุง ููุฏุฉ ุฃุณุจูุนูู ุนู ุฎุทุฃ NFS ูู ููุงุฉ Linux โช ๐ โน๐ผ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ูุตู ููุตู ููุจุญุซ ุนู ุงูุฃุฎุทุงุก ูู ูููุฉ GitLab ุงูุชู ุฃุฏุช ุฅูู ุงูุชุตุญูุญ ููุธุงู Linux kernel 


 ูู 14 ุณุจุชูุจุฑ ุ ุฃุจูุบ ุฏุนู GitLab ุนู ูุดููุฉ ุฎุทูุฑุฉ ุญุฏุซุช ูุฃุญุฏ ุนููุงุฆูุง: ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ููู ุจุญุซูุง ููุฏุฉ ุฃุณุจูุนูู ุนู ุฎุทุฃ NFS ูู ููุงุฉ Linux</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/southbridge/blog/432922/" style=";text-align:right;direction:rtl"><h3 id="podrobnoe-opisanie-poiskov-baga-iz-zadachi-gitlab-kotorye-priveli-k-patchu-dlya-yadra-linux" style=";text-align:right;direction:rtl">  ูุตู ููุตู ููุจุญุซ ุนู ุงูุฃุฎุทุงุก ูู ูููุฉ GitLab ุงูุชู ุฃุฏุช ุฅูู ุงูุชุตุญูุญ ููุธุงู Linux kernel </h3><br><p style=";text-align:right;direction:rtl"> ูู 14 ุณุจุชูุจุฑ ุ ุฃุจูุบ ุฏุนู GitLab ุนู ูุดููุฉ ุฎุทูุฑุฉ ุญุฏุซุช ูุฃุญุฏ ุนููุงุฆูุง: ุฃููุงู ุ GitLab ูุนูู ุจุดูู ุฌูุฏ ุ ููู ุซู ูุญุตู ุงููุณุชุฎุฏููู ุนูู ุฎุทุฃ.  ููุฏ ุญุงูููุง ุงุณุชูุณุงุฎ ุจุนุถ ุงููุณุชูุฏุนุงุช ูู ุฎูุงู Git ุ ููุฌุฃุฉ ุธูุฑุช ุฑุณุงูุฉ ุบูุฑ ูููููุฉ ุญูู ููู ูุฏูู: <code>Stale file error</code> .  ุงุณุชูุฑ ุงูุฎุทุฃ ููุฏุฉ ุทูููุฉ ููู ูุนูู ุญุชู ุจุฏุฃ ูุณุคูู ุงููุธุงู ูุฏูููุง ูู ุงูุฏููู ููุณู. </p><br><p style=";text-align:right;direction:rtl">  ุงุถุทุฑุฑุช ูุฏุฑุงุณุฉ ุงูุขููุงุช ุงูุฏุงุฎููุฉ ูุฌูุช ููุธุงู ูููุงุช ุดุจูุฉ NFS.  ูุชูุฌุฉ ูุฐูู ุ ูุฌุฏูุง <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุฎูููุง ูู</a> ุนููู Linux v4.0 NFS ุ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ูุชุจ Trond Myklebust ุชุตุญูุญูุง ููููุงุฉ</a> ุ ูููุฐ 26 ุฃูุชูุจุฑ ุ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุชู ุชุถููู ูุฐุง ุงูุชุตุญูุญ ูู ููุงุฉ Linux ุงูุฑุฆูุณูุฉ</a> . </p><br><p style=";text-align:right;direction:rtl">  ูู ูุฐุง ุงูููุดูุฑ ุ ุณูู ุฃุฎุจุฑู ููู ุฏุฑุณูุง ุงููุดููุฉ ุ ููู ุฃู ุงุชุฌุงู ููุฑูุง ููู ููุง ูู ุงูุฃุฏูุงุช ุงูุชู ุงุณุชุฎุฏููุงูุง ูุชุชุจุน ุงูุฎุทุฃ.  ููุฏ ุงุณุชููููุง ุงูุนูู ุงููุจุงุญุซ ุงูููุชุงุฒ ุงูุฐู ูุงู ุจู ุฃูููุบ ุฏุงุดูุณูู ุงูููุถุญ ูู ุงูููุดูุฑ ุงูุชุงูู: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">"ููู</a> ุฃุชุนูุจ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุชุณุฑุจ ุงูุฐุงูุฑุฉ ูู ุฑูุจู ููุฏุฉ ุฃุณุจูุนูู"</a> . </p><br><img src="https://habrastorage.org/webt/es/0f/-7/es0f-7dbqlnheksnnmxtlwawlic.jpeg"><a name="habracut"></a><br><p style=";text-align:right;direction:rtl">  ุฅูู ุฃูุถูุง ูุซุงู ุฑุงุฆุน ุนูู ููููุฉ ุชุตุญูุญ ุฃุฎุทุงุก ุงููุตุงุฏุฑ ุงูููุชูุญุฉ ุจุงุนุชุจุงุฑูุง ุฑูุงุถุฉ ุฌูุงุนูุฉ ุชุถู ุงูุนุฏูุฏ ูู ุงูุฃุดุฎุงุต ูุงูุดุฑูุงุช ูุงูุจูุฏุงู.  ุดุนุงุฑ GitLab ุ " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ูููู ููุฌููุน ุงููุณุงููุฉ</a> " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุ</a> ูุง ููุทุจู ููุท ุนูู GitLab ููุณูุง ุ ูููู ุฃูุถูุง ููุดุงุฑูุน ุฃุฎุฑู ููุชูุญุฉ ุงููุตุฏุฑ ุ ูุซู ููุงุฉ Linux. </p><br><h3 id="vosproizvedenie-baga" style=";text-align:right;direction:rtl">  ุนูุฉ ุงูุงุณุชูุณุงุฎ </h3><br><p style=";text-align:right;direction:rtl">  ุงุญุชูุธูุง ุจู NFS ุนูู GitLab.com ูุณููุงุช ุนุฏูุฏุฉ ุ ูููู ุจุนุฏ ุฐูู ุชููููุง ุนู ุงุณุชุฎุฏุงูู ูููุตูู ุฅูู ุจูุงูุงุช ูุณุชูุฏุน ุงูุชุฎุฒูู ุนูู ุงูุฃุฌูุฒุฉ ุงูุชู ุชุญุชูู ุนูู ุชุทุจููุงุช.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ููุฏ ููููุง ุฌููุน ููุงููุงุช Git ุฅูู Gitaly</a> .  ูุญู ูุฏุนู NFS ููุนููุงุก ุงูุฐูู ูุฏูุฑูู ุนูููุงุช ุงูุชุซุจูุช ุงูุฎุงุตุฉ ุจูู ุนูู GitLab ููููู ูู ููุงุฌููุง ููุณ ุงููุดููุฉ ุงูุชู ูุงุฌููุง ุงูุนููู ุงููุฐููุฑ ุณุงุจููุง. </p><br><p style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุฃุนุทู ุงูุนููู ุจุนุถ ุงูุชูููุญุงุช ุงููููุฏุฉ</a> : </p><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุงููุต ุงููุงูู ููุฎุทุฃ: <code>fatal: Couldn't read ./packed-refs: Stale file handle</code> . </li><li style=";text-align:right;direction:rtl">  ุนูู ูุง ูุจุฏู ุ ูุดุฃุช ุงููุดููุฉ ุนูุฏูุง ุจุฏุฃ ุงูุนููู ูุฏูููุง ูู ุฌูุน ุงูุจูุงูุงุช ุงูููููุฉ ูู Git ุจุงุณุชุฎุฏุงู ุงูุฃูุฑ <code>git gc</code> . </li><li style=";text-align:right;direction:rtl">  ุงุฎุชูู ุงูุฎุทุฃ ุนูุฏูุง ุจุฏุฃ ูุณุคูู ุงููุธุงู ุงูุฃุฏุงุฉ ุงููุณุงุนุฏุฉ <code>ls</code> ูู ุงูุฏููู. </li><li style=";text-align:right;direction:rtl">  ุงุฎุชูู ุงูุฎุทุฃ ุนูุฏ <code>git gc</code> ุนูููุฉ <code>git gc</code> . </li></ol><br><p style=";text-align:right;direction:rtl">  ูู ุงููุงุถุญ ุฃู ุฃูู ููุทุชูู ูุฑุชุจุทุชุงู.  ุนูุฏ ุฅุฑุณุงู ุงูุชุบููุฑุงุช ุฅูู ูุฑุน Git ุ ููุดุฆ Git ุฑุงุจุทูุง ุถุนูููุง - ุงุณู ููู ุทููู ูุดูุฑ ุฅูู ุงุณู ุงููุฑุน ููุงูุชุฒุงู.  ุนูู ุณุจูู ุงููุซุงู ุ ุนูุฏ ุงูุฅุฑุณุงู ุฅูู <code>master</code> ุ ุณูุชู ุฅูุดุงุก ููู ูุณูู <code>refs/heads/master</code> ูู ุงููุณุชูุฏุน: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">$ cat refs/heads/master 2e33a554576d06d9e71bfd6814ee9ba3a7838963</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูููุฐ ุงูุฃูุฑ <code>git gc</code> ุงูุนุฏูุฏ ูู ุงูููุงู.  ุนูู ุณุจูู ุงููุซุงู ุ ุชุฌูุน ูุฐู ุงูุฑูุงุจุท ุงูุถุนููุฉ (ุงููุฑุงุฌุน) <code>packed-refs</code> ููู ูุงุญุฏ ูุณูู <code>packed-refs</code> .  ูุฐุง ูุณุฑุน ุงูุนูู ููููุงู ุ ูุฃู ูุฑุงุกุฉ ููู ูุจูุฑ ูุงุญุฏ ุฃุณูู ูู ุงูุนุฏูุฏ ูู ุงููููุงุช ุงูุตุบูุฑุฉ.  ุนูู ุณุจูู ุงููุซุงู ุ ุจุนุฏ ุชุดุบูู ุงูุฃูุฑ <code>git gc</code> ุ ูุฏ ูุจุฏู ููู <code>packed-refs</code> ูุงูุชุงูู: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs"># pack-refs with: peeled fully-peeled sorted 564c3424d6f9175cf5f2d522e10d20d781511bf1 refs/heads/10-8-stable edb037cbc85225261e8ede5455be4aad771ba3bb refs/heads/11-0-stable 94b9323033693af247128c8648023fe5b53e80f9 refs/heads/11-1-stable 2e33a554576d06d9e71bfd6814ee9ba3a7838963 refs/heads/master</code> </pre> <br><p style=";text-align:right;direction:rtl">  ููู ูุชู ุฅูุดุงุก ููู <code>packed-refs</code> ุ  ููุนุฑูุฉ ุฐูู ุ ูููุง ุจุชุดุบูู ุงูุฃูุฑ <code>strace git gc</code> ุญูุซ ูุงู ูุฏููุง ุฑุงุจุท ุถุนูู.  ูููุง ููู ุงูุฎุทูุท ุฐุงุช ุงูุตูุฉ: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">28705 open("/tmp/libgit2/.git/packed-refs.lock", O_RDWR|O_CREAT|O_EXCL|O_CLOEXEC, 0666) = 3 28705 open(".git/packed-refs", O_RDONLY) = 3 28705 open("/tmp/libgit2/.git/packed-refs.new", O_RDWR|O_CREAT|O_EXCL|O_CLOEXEC, 0666) = 4 28705 rename("/tmp/libgit2/.git/packed-refs.new", "/tmp/libgit2/.git/packed-refs") = 0 28705 unlink("/tmp/libgit2/.git/packed-refs.lock") = 0</code> </pre> <br><p style=";text-align:right;direction:rtl">  ููุงููุงุช ุงููุธุงู ุฃุธูุฑุช ุฃู ุงูุฃูุฑ <code>git gc</code> : </p><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุงูุชุชุญ <code>packed-refs.lock</code> .  ูุฐุง ูุฎุจุฑ ุงูุนูููุงุช ุงูุฃุฎุฑู ุฃู ููู <code>packed-refs</code> ูุคูู ููุง ูููู ุชุบููุฑู. </li><li style=";text-align:right;direction:rtl">  ุงูุชุชุญ <code>packed-refs.new</code> . </li><li style=";text-align:right;direction:rtl">  <code>packed-refs.new</code> ุงูุฑูุงุจุท ุงูุถุนููุฉ ูู <code>packed-refs.new</code> . </li><li style=";text-align:right;direction:rtl">  ุฅุนุงุฏุฉ ุชุณููุฉ <code>packed-refs.new</code> ุฅูู <code>packed-refs</code> . </li><li style=";text-align:right;direction:rtl">  ุฅุฒุงูุฉ <code>packed-refs.lock</code> . </li><li style=";text-align:right;direction:rtl">  ุฅุฒุงูุฉ ุงูุฑูุงุจุท ุงูุถุนููุฉ. </li></ol><br><p style=";text-align:right;direction:rtl">  ุงูููุทุฉ ุงูุฃุณุงุณูุฉ ููุง ูู ุงูููุทุฉ ุงูุฑุงุจุนุฉ ุ ููู ุฅุนุงุฏุฉ ุงูุชุณููุฉ ุ ุญูุซ ููุฏู Git ููู <code>packed-refs</code> .  ูุง ูููู <code>git gc</code> ุจุฌูุน ุงูุฑูุงุจุท ุงูุถุนููุฉ ูุญุณุจ ุ ุจู ูุคุฏู ุฃูุถูุง ูููุฉ ุฃูุซุฑ ูุซุงูุฉ ูู ุญูุซ ุงูููุงุฑุฏ - ููู ูุจุญุซ ูู ุงููุงุฆูุงุช ุบูุฑ ุงููุณุชุฎุฏูุฉ ููุฒูููุง.  ูู ุงููุณุชูุฏุนุงุช ุงููุจูุฑุฉ ุ ูุฏ ูุณุชูุฑ ูุฐุง ุฃูุซุฑ ูู ุณุงุนุฉ. </p><br><p style=";text-align:right;direction:rtl">  ูุณุฃููุง ุฃููุณูุง: ูู ุงููุณุชูุฏุนุงุช ุงููุจูุฑุฉ ูู <code>git gc</code> ุชุจูู ุงูููู ููุชูุญูุง ุฃุซูุงุก ุงูุชูุธููุ  ุฏุฑุณูุง ุณุฌูุงุช <code>strace</code> ุ ุฃุทูููุง ุงูุฃุฏุงุฉ ุงููุณุงุนุฏุฉ <code>lsof</code> ุ ูููุง ูุง ุชุนูููุงู ุญูู ุนูููุฉ <code>git gc</code> : </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/getpro/habr/post_images/493/51d/077/49351d077382c8b70317346789331c81.svg" alt="ุงูุตูุฑุฉ"></p><br><p style=";text-align:right;direction:rtl">  ููุง ุชุฑูู ุ ูุชู ุฅุบูุงู ููู <code>packed-refs</code> ูู ุงูููุงูุฉ ุ ุจุนุฏ ุงูุนูููุฉ ุงูุทูููุฉ ุงููุญุชููุฉ <code>Garbage collect objects</code> . </p><br><p style=";text-align:right;direction:rtl">  ูุฐุง ุ ูุดุฃ ุงูุณุคุงู ุงูุชุงูู: ููู ูุชุตุฑู NFS ุนูุฏูุง ูููู ููู <code>packed-refs</code> ููุชูุญูุง ุนูู ุนูุฏุฉ ูุงุญุฏุฉ ุ ูุงูุขุฎุฑ ูุนูุฏ ุชุณููุชู ูู ุฐูู ุงูููุชุ </p><br><p style=";text-align:right;direction:rtl">  "ูุฃุบุฑุงุถ ุนูููุฉ" ุ ุทูุจูุง ูู ุงูุนููู ุฅุฌุฑุงุก ุชุฌุฑุจุฉ ูุงุญุฏุฉ ุนูู ุฌูุงุฒูู ูุฎุชูููู (ุฃููุณ ูุจูุจ): <br>  1) ูู ูุญุฏุฉ ุงูุชุฎุฒูู ุงููุดุชุฑูุฉ NFS ุ ูู ุจุฅูุดุงุก ููููู: <code>test1.txt</code> ู <code>test2.txt</code> ุจูุญุชููุงุช ูุฎุชููุฉ ุ ุจุญูุซ ูููู ุงูุชูููุฒ ุจููููุง ุฃุณูู: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">alice $ echo "1 - Old file" &gt; /path/to/nfs/test1.txt alice $ echo "2 - New file" &gt; /path/to/nfs/test2.txt</code> </pre> <br><p style=";text-align:right;direction:rtl">  2) ุนูู ุฌูุงุฒ Alice ุ ูุฌุจ ุฃู ูููู ุงูููู <code>test1.txt</code> ููุชูุญูุง: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">alice $ irb irb(main):001:0&gt; File.open('/path/to/nfs/test1.txt')</code> </pre> <br><p style=";text-align:right;direction:rtl">  3) ุนูู ุฌูุงุฒ Alice ุ ุงุนุฑุถ ุจุงุณุชูุฑุงุฑ ูุญุชููุงุช <code>test1.txt</code> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">alice $ while true; do cat test1.txt; done</code> </pre> <br><p style=";text-align:right;direction:rtl">  4) ุซู ุ ุนูู ุฌูุงุฒ ุจูุจ ุ ูู ุจุชุดุบูู ุงูุฃูุฑ: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">bob $ mv -f test2.txt test1.txt</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุงูุฎุทูุฉ ุงูุฃุฎูุฑุฉ ุชุณุชูุณุฎ ูุง ููุนู <code>git gc</code> ูุน ููู <code>packed-refs</code> ุนูุฏ ุงููุชุงุจุฉ ููู ููู ููุฌูุฏ. <br>  ุนูู ุฌูุงุฒ ุงูุนููู ุ ูุงูุช ุงููุชูุฌุฉ ุชุจุฏู ูุซู ูุฐุง: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">1 - Old file 1 - Old file 1 - Old file cat: test1.txt: Stale file handle</code> </pre> <br><p style=";text-align:right;direction:rtl">  ููุงู!  ูุจุฏู ุฃููุง ูุฏ ุณูุทุฑูุง ุนูู ุงููุดููุฉ ุจุทุฑููุฉ ูุณูุทุฑ ุนูููุง.  ูููู ูู ููุณ ุงูุชุฌุฑุจุฉ ุนูู ุฎุงุฏู Linux NFS ุ ูู ุชุญุฏุซ ูุฐู ุงููุดููุฉ.  ูุงูุช ุงููุชูุฌุฉ ูุชููุนุฉ - ุจุนุฏ ุฅุนุงุฏุฉ ุชุณููุฉ ุงููุญุชูู ุงูุฌุฏูุฏ ุชู ูุจููู: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">1 - Old file 1 - Old file 1 - Old file 2 - New file &lt;--- RENAME HAPPENED 2 - New file 2 - New file</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูู ุฃูู ูุฃุชู ูุฐุง ุงูุงุฎุชูุงู ูู ุงูุณูููุ  ุงุชุถุญ ุฃู ุงูุนููู ูุณุชุฎุฏู ุชุฎุฒูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Isilon NFS</a> ุ ูุงูุฐู ูุฏุนู NFS v4.0 ููุท.  ุนูุฏูุง ูููุง ุจุชุบููุฑ ุฅุนุฏุงุฏุงุช ุงูุงุชุตุงู ุฅูู ุงูุฅุตุฏุงุฑ <code>vers=4.0</code> ุจุงุณุชุฎุฏุงู ุงููุนููุฉ <code>vers=4.0</code> ูู <code>/etc/fstab</code> ุ ุฃุธูุฑ ุงูุงุฎุชุจุงุฑ ูุชูุฌุฉ ูุฎุชููุฉ ูุฎุงุฏู Linux NFS: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">1 - Old file 1 - Old file 1 - Old file 1 - Old file &lt;--- RENAME HAPPENED 1 - Old file 1 - Old file</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุจุฏูุงู ูู <code>Stale file handle</code> ุงููุฏูู <code>Stale file handle</code> ูุนุฑุถ ุฎุงุฏู Linux NFS v4.0 <em>ูุญุชูู</em> ูุฏูููุง.  ุงุชุถุญ ุฃู ุงูุงุฎุชูุงู ูู ุงูุณููู ูููู ุชูุณูุฑู ุจูุงุณุทุฉ ููุงุตูุงุช NFS.  ูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">RFC 3010</a> : </p><br><blockquote style=";text-align:right;direction:rtl">  ูุฏ ูุตุจุญ ูุงุตู ุงูููู ูุฏูููุง ุฃู ููุชูู ุงูุตูุงุญูุฉ ุนูุฏ ุฅุนุงุฏุฉ ุชุณููุชู ุ ูููู ููุณ ุฏุงุฆููุง.  ูููุตุญ ูููุฐู ุงูุฎุงุฏู ุจุงุชุฎุงุฐ ุฎุทูุงุช ููุชุฃูุฏ ูู ุฃู ูุงุตูุงุช ุงูููู ูุง ุชูุชูู ุตูุงุญูุชูุง ููุง ุชูุชูู ุตูุงุญูุชูุง ุจูุฐู ุงูุทุฑููุฉ. </blockquote><p style=";text-align:right;direction:rtl">  ุจูุนูู ุขุฎุฑ ุ ูููู ูุฎูุงุฏู NFS ุงุฎุชูุงุฑ ููููุฉ ุงูุชุตุฑู ุนูุฏ ุฅุนุงุฏุฉ ุชุณููุฉ ุฃุญุฏ ุงููููุงุช ุ ููููู ุฎุงุฏู NFS ุจุฅุฑุฌุงุน <code>Stale file error</code> ุจุดูู ูุนููู ูู ูุซู ูุฐู ุงูุญุงูุงุช.  ุงูุชุฑุญูุง ุฃู ุณุจุจ ุงููุดููุฉ ูู ููุณู ุ ุนูู ุงูุฑุบู ูู ุฃู ุงููุชุงุฆุฌ ูุงูุช ูุฎุชููุฉ.  ููุฏ ุดููุง ูู ุฃูู ุชู ูุญุต ุฐุงูุฑุฉ ุงูุชุฎุฒูู ุงููุคูุช ุ ูุฃู ุงูุฃุฏุงุฉ ุงููุณุงุนุฏุฉ <code>ls</code> ูู ุงูุฏููู ุฃุฒุงูุช ุงูุฎุทุฃ.  ุงูุขู ูุฏููุง ุณููุงุฑูู ุงุฎุชุจุงุฑ ูุงุจู ููุชูุฑุงุฑ ุ ูุงูุชูููุง ุฅูู ุงูุฎุจุฑุงุก - ูุดุฑูู Linux NFS. </p><br><h2 id="lozhnyy-sled-delegirovanie-na-nfs-servere" style=";text-align:right;direction:rtl">  ุชุชุจุน ุฎุทุฃ: ุชูููุถ ุนูู ุฎุงุฏู NFS </h2><br><p style=";text-align:right;direction:rtl">  ุนูุฏูุง ุชูููุง ูู ุฅุนุงุฏุฉ ุฅูุชุงุฌ ุงูุฎุทุฃ ุฎุทูุฉ ุจุฎุทูุฉ ุ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ูุชุจุช ุฅูู ุฌูุงุช ุงุชุตุงู Linux NFS</a> ุญูู ูุง ุชุนูููุงู.  ููุฏ ุชูุงุตูุช ูุน Bruce Fields ุ ูุดุฑู ุฎุงุฏู Linux NFS ููุฏุฉ ุฃุณุจูุน ุ ูุงูุชุฑุญ ุฃู ูููู ุงูุฎุทุฃ ูู NFS ูุฃููู ุจุญุงุฌุฉ ูุฏุฑุงุณุฉ ุญุฑูุฉ ูุฑูุฑ ุงูุดุจูุฉ.  ูุงู ูุนุชูุฏ ุฃู ุงููุดููุฉ ุชุชูุซู ูู ุชูููุถ ุงูููุงู ุนูู ุฎุงุฏู NFS. </p><br><h3 id="chto-takoe-delegirovanie-na-nfs-servere" style=";text-align:right;direction:rtl">  ูุง ูู ุงูุชูููุถ ุนูู ุฎุงุฏู NFSุ </h3><br><p style=";text-align:right;direction:rtl">  ุจุงุฎุชุตุงุฑ ุ ูุญุชูู ุงูุฅุตุฏุงุฑ NFS v4 ุนูู ูุธููุฉ ุชูููุถ ูุชุณุฑูุน ุงููุตูู ุฅูู ุงููููุงุช.  ูููู ุฃู ูููุถ ุงูุฎุงุฏู ุญู ุงููุตูู ูููุฑุงุกุฉ ุฃู ุงููุชุงุจุฉ ุฅูู ุงูุนููู ุจุญูุซ ูุง ูุถุทุฑ ุงูุนููู ุฅูู ุณุคุงู ุงูุฎุงุฏู ุจุงุณุชูุฑุงุฑ ุฅุฐุง ูุงู ุงูููู ูุฏ ุชู ุชุบููุฑู ุจูุงุณุทุฉ ุนููู ุขุฎุฑ.  ุจุจุณุงุทุฉ ุ ุชูููุถ ุณุฌู ูุซู ุฅูุฑุงุถ ุดุฎุต ูุง ุฏูุชุฑ ููุงุญุธุงุชู ูุงูููู ุ "ุฃูุช ุชูุชุจ ููุง ุ ูุณุฃุญุตู ุนููู ุนูุฏูุง ุฃููู ุฌุงูุฒูุง".  ููุง ูุชุนูู ุนูู ุฃู ุดุฎุต ุฃู ูุทูุจ ุฏูุชุฑ ููุงุญุธุงุช ูู ูู ูุฑุฉ ุชุญุชุงุฌ ูููุง ุฅูู ูุชุงุจุฉ ุดูุก ูุง - ูุชูุชุน ุจุญุฑูุฉ ูุงููุฉ ูู ุงูุชุตุฑู ุญุชู ูุชู ุฅุฎุฑุงุฌ ุฏูุชุฑ ุงูููุงุญุธุงุช.  ูู NFS ุ ูุณูู ุทูุจ ุฅุฑุฌุงุน ุฏูุชุฑ ููุงุญุธุงุช ุจุฅูุบุงุก ุงูุชูููุถ. </p><br><p style=";text-align:right;direction:rtl">  ุฎุทุฃ ูู ุฅุจุทุงู ุชูููุถ NFS ูููู ุฃู ููุณุฑ ูุดููุฉ <code>Stale file handle</code> .  ุชุฐูุฑ ููู ุชู ูุชุญ <code>test1.txt</code> ูู <code>test1.txt</code> Alice ุ ุซู ูุงู <code>test2.txt</code> ุจุงุณุชุจุฏุงูู.  ุฑุจูุง ุชุนุฐุฑ ุนูู ุงูุฎุงุฏู ุฅุจุทุงู ุงูุชูููุถ ูู <code>test1.txt</code> ุ ูุฃุฏู ุฐูู ุฅูู ุญุงูุฉ ุบูุฑ ุตุงูุญุฉ.  ูุงุฎุชุจุงุฑ ูุฐู ุงููุธุฑูุฉ ุ ูููุง ุจุชุณุฌูู ุญุฑูุฉ ูุฑูุฑ NFC ุจุงุณุชุฎุฏุงู ุงูุฃุฏุงุฉ ุงููุณุงุนุฏุฉ <code>tcpdump</code> ูุชุตูุฑูุง ุจุงุณุชุฎุฏุงู Wireshark. </p><br><p style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Wireshark</a> ูู ุฃุฏุงุฉ ุฑุงุฆุนุฉ ููุชูุญุฉ ุงููุตุฏุฑ ูุชุญููู ุญุฑูุฉ ูุฑูุฑ ุงูุดุจูุฉ ุ ุฎุงุตุฉ ูุงุณุชูุดุงู NFS ุฃุซูุงุก ุงูุนูู.  ุณุฌููุง ุงูุชุชุจุน ุจุงุณุชุฎุฏุงู ุงูุฃูุฑ ุงูุชุงูู ุนูู ุฎุงุฏู NFS: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">tcpdump -s 0 -w /tmp/nfs.pcap port 2049</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูุณุฌู ูุฐุง ุงูุฃูุฑ ุฌููุน ุฒูุงุฑุงุช NFS ุงูุชู ุนุงุฏุฉ ูุง ุชูุฑ ุนุจุฑ ูููุฐ TCP 2049. ูุธุฑูุง ูุฃู ุชุฌุฑุจุชูุง ูุงูุช ูุงุฌุญุฉ ูุน NFS v4.1 ุ ูููู ููุณ ูุน NFS v4.0 ุ ูููููุง ููุงุฑูุฉ ุณููู NFS ูู ุญุงูุฉ ุงูุนูู ูุบูุฑ ุงูุนุงููุฉ.  ูุน Wireshark ุ ุดุงูุฏูุง ุงูุณููู ุงูุชุงูู: </p><br><h3 id="nfs-v40-ustarevshiy-fayl" style=";text-align:right;direction:rtl">  NFS v4.0 (ููู ููู) </h3><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/getpro/habr/post_images/6a1/0bb/e23/6a10bbe2304b155431010aa4ca577fa7.svg" alt="ุงูุตูุฑุฉ"></p><br><p style=";text-align:right;direction:rtl">  ููุถุญ ูุฐุง ุงููุฎุทุท ุฃูู ูู ุงูุฎุทูุฉ 1 ุ ููุชุญ Alice <code>test1.txt</code> ููุชููู ูุงุตู ููู NFS ูุน ูุนุฑู <code>stateid</code> 0x3000.  ุนูุฏูุง ูุญุงูู ุจูุจ ุฅุนุงุฏุฉ ุชุณููุฉ ุงูููู ุ ูุทูุจ ุฎุงุฏู NFS ุฅุนุงุฏุฉ ุงููุญุงููุฉ ุนู ุทุฑูู ุฅุฑุณุงู ุงูุฑุณุงูุฉ <code>NFS4ERR_DELAY</code> ุ ููุชุฐูุฑ ุงูููุฏ ูู Alice ุนุจุฑ ุงูุฑุณุงูุฉ <code>CB_RECALL</code> (ุงูุฎุทูุฉ 3).  ุฅุฑุฌุงุน Alice ุงูุชูููุถ (DELEGRETURN ูู ุงูุฎุทูุฉ 4) ุ ููุญุงูู Bob ุฅุฑุณุงู ุฑุณุงูุฉ ุฅุนุงุฏุฉ <code>RENAME</code> ูุฑุฉ ุฃุฎุฑู (ุงูุฎุทูุฉ 5).  ูุชู ุชูููุฐ <code>RENAME</code> ูู ููุชุง ุงูุญุงูุชูู ุ ููู Alice ุชูุงุตู ูุฑุงุกุฉ ุงูููู ุจููุณ ุงููุงุตู. </p><br><h3 id="nfs-v41-rabochiy-sluchay" style=";text-align:right;direction:rtl">  NFS v4.1 (ุญุงูุฉ ุงูุนูู) </h3><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/getpro/habr/post_images/f3d/1a3/d49/f3d1a3d49e803d73a4dd7f830e9b238a.svg" alt="ุงูุตูุฑุฉ"></p><br><p style=";text-align:right;direction:rtl">  ููุง ูููู ุงููุฑู ูุฑุฆููุง ูู ุงูุฎุทูุฉ 6. ูู NFS v4.0 (ูุน ููู ูุฏูู) ุ ุชุญุงูู Alice ุงุณุชุฎุฏุงู ููุณ <code>stateid</code> .  ูู ุงูุฅุตุฏุงุฑ NFS v4.1 (ุญุงูุฉ ุงูุนูู) ุ ุชููู Alice ุจุชูููุฐ ุนูููุงุช <code>LOOKUP</code> ู <code>OPEN</code> ุฅุถุงููุฉ ุ ูุจุงูุชุงูู ูุนุฑุถ ุงูุฎุงุฏู ุญุงูุฉ ูุฎุชููุฉ.  ูู ุงูุฅุตุฏุงุฑ 4.0 ุ ูุง ูุฑุณู ุฃู ุฑุณุงุฆู ุฅุถุงููุฉ.  ูุฐุง ูุง ููุณุฑ ููุงุฐุง ุชุฑู ุฃููุณ ูุญุชูู ูุฏูููุง - ุชุณุชุฎุฏู ูุงุตููุง ูุฏูููุง. </p><br><p style=";text-align:right;direction:rtl">  ููุงุฐุง ุชูุฑุฑ ุฃููุณ ูุฌุฃุฉ ุนูู <code>LOOKUP</code> ุฅุถุงููุฉุ  ูุจุฏู ุฃู ุงุณุชุฏุนุงุก ุงูููุฏ ูุงู ูุงุฌุญูุง ุ ููู ูุจุฏู ุฃู ููุงู ูุดููุฉ ูุง ุฒุงูุช ูุงุฆูุฉ.  ุนูู ุณุจูู ุงููุซุงู ุ ูุชู ุชุฎุทู ุฎุทูุฉ ุงูุฅุนุงูุฉ.  ููุชุญูู ูู ุฐูู ุ ุงุณุชุจุนุฏูุง ุชูููุถ NFS ุนูู ุฎุงุฏู NFS ููุณู ุจุงุณุชุฎุฏุงู ูุฐุง ุงูุฃูุฑ: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">echo 0 &gt; /proc/sys/fs/leases-enable</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูุฑุฑูุง ุงูุชุฌุฑุจุฉ ุ ููู ุงููุดููุฉ ูู ุชุฎุชู.  ููุฏ ุชุฃูุฏูุง ูู ุฃู ุงููุดููุฉ ูู ุชูู ูู ุฎุงุฏู NFS ุฃู ุงูุชูููุถ ุ ููุฑุฑูุง ุฃู ููุธุฑ ุฅูู ุนููู NFS ูู ุงูููุงุฉ. </p><br><h2 id="kopaem-glubzhe-linux-nfs-klient" style=";text-align:right;direction:rtl">  ุญูุฑ ุฃุนูู: ุนููู Linux NFS </h2><br><p style=";text-align:right;direction:rtl">  ูุงู ุงูุณุคุงู ุงูุฃูู ุงูุฐู ูุงู ุนูููุง ุงูุฅุฌุงุจุฉ ุนููู ุนูู ูุดุฑูู NFS: </p><br><h3 id="eta-problema-sohranyaetsya-v-posledney-versii-yadra" style=";text-align:right;direction:rtl">  ูู ุงุณุชูุฑุช ูุฐู ุงููุดููุฉ ูู ุฃุญุฏุซ ุฅุตุฏุงุฑ ูู kernelุ </h3><br><p style=";text-align:right;direction:rtl">  ุญุฏุซุช ุงููุดููุฉ ูู ููุงุฉ CentOS 7.2 ู Ubuntu 16.04 ูุน ุงูุฅุตุฏุงุฑุงุช 3.10.0-862.11.6 ู 4.4.0-130 ุ ุนูู ุงูุชูุงูู.  ููู ููุง ุงูููู ุชุฎูู ุนู ุฃุญุฏุซ ุฅุตุฏุงุฑ ุ ูุงูุฐู ูุงู ูู ุฐูู ุงูููุช 4.19-RC2. </p><br><p style=";text-align:right;direction:rtl">  ููุฏ ูููุง ุจูุดุฑ ุงูุฌูุงุฒ ุงูุธุงูุฑู ุงูุฌุฏูุฏ ูู Ubuntu 16.04 ุนูู Google Cloud Platform (GCP) ุ ูุงุณุชูุณุงุฎ ุฃุญุฏุซ ููุงุฉ Linux ุ ูุฅุนุฏุงุฏ ุจูุฆุฉ ุชุทููุฑ kernel.  ุฃูุดุฃูุง ููู <code>.config</code> ุจุงุณุชุฎุฏุงู <code>menuconfig</code> ููุง ููู: </p><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ูุชู ุชุตููู ุจุฑูุงูุฌ ุงูุชุดุบูู NFS ููุญุฏุฉ ููุทูุฉ ( <code>CONFIG_NFSD=m</code> ). </li><li style=";text-align:right;direction:rtl">  ุชู ุชุญุฏูุฏ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ูุนููุงุช kernel GCP</a> ุงูุตุญูุญุฉ ุจุดูู ุตุญูุญ. </li></ol><br><p style=";text-align:right;direction:rtl">  ุชุชุจุน ุนูู ุงููุฑุงุซุฉ ุงูุชุทูุฑ ูู ุงูููุช ุงูุญูููู ุจูุงุณุทุฉ Drosophila ุ ููุน ุงูุนูุตุฑ ุงูุฃูู ุ ูููููุง ุจุณุฑุนุฉ ุฅุฌุฑุงุก ุชุตุญูุญุงุช ุนูู ุนููู NFS ุฏูู ุฅุนุงุฏุฉ ุชุดุบูู ุงูููุงุฉ.  ุงูููุทุฉ ุงูุซุงููุฉ ุชุถูู ุฃู ุงูููุงุฉ ุณุชุจุฏุฃ ุจุนุฏ ุงูุชุซุจูุช.  ูุญุณู ุงูุญุธ ุ ููุง ุฑุงุถูู ุนู ูุนููุงุช kernel ุงูุงูุชุฑุงุถูุฉ. </p><br><p style=";text-align:right;direction:rtl">  ููุฏ ุชุฃูุฏูุง ูู ุฃู ูุดููุฉ ุงูููู ุงููุชูุงุฏู ูู ุชุฎุชู ูู ุฃุญุฏุซ ุฅุตุฏุงุฑ ูู kernel.  ุณุฃููุง ุฃููุณูุง: </p><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุฃูู ุจุงูุถุจุท ุชูุดุฃ ุงููุดููุฉุ </li><li style=";text-align:right;direction:rtl">  ููุงุฐุง ูุญุฏุซ ูุฐุง ูู NFS v4.0 ุ ูููู ููุณ ูู v4.1ุ </li></ol><br><p style=";text-align:right;direction:rtl">  ููุฅุฌุงุจุฉ ุนูู ูุฐู ุงูุฃุณุฆูุฉ ุ ุจุญุซูุง ูู ุดูุฑุฉ ูุตุฏุฑ NFS.  ูู ููู ูุฏููุง ูุตุญุญ ุฃุฎุทุงุก kernel ุ ูุฐูู ุฃุฑุณููุง ููุนูู ูู ุงูููุงููุงุช ุฅูู ุงูููุฏ ุงููุตุฏุฑู: </p><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  <code>pr_info()</code> (ูุงูุช <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><code>   printk</code></a> ). </li><li style=";text-align:right;direction:rtl">  <code>dump_stack()</code> : ููุธูุฑ ุชุชุจุน ุงูููุฏุณ ูุงุณุชุฏุนุงุก ุงููุธููุฉ ุงูุญุงููุฉ. </li></ol><br><p style=";text-align:right;direction:rtl">  ุนูู ุณุจูู ุงููุซุงู ุ ุฃูู ุดูุก ูุนููุงู ูู ุงูุงุชุตุงู <code>nfs4_file_open()</code> ูู <code>fs/nfs/nfs4file.c</code> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">static int nfs4_file_open(struct inode *inode, struct file *filp) { ... pr_info("nfs4_file_open start\n"); dump_stack();</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุจุงูุทุจุน ุ ูููููุง <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><code>  dprintk</code> ูุน ุชุตุญูุญ ุฃุฎุทุงุก Linux</a> ุฃู ุงุณุชุฎุฏุงู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><code>rpcdebug</code></a> ุ ููููุง ุฃุฑุฏูุง ุฅุถุงูุฉ ุฑุณุงูุชูุง ุงูุฎุงุตุฉ ููุชุญูู ูู ุงูุชุบููุฑุงุช. </p><br><p style=";text-align:right;direction:rtl">  ุจุนุฏ ูู ุชุบููุฑ ุ ูููุง ุจุฅุนุงุฏุฉ ุชุฑุฌูุฉ ุงููุญุฏุฉ ุงูููุทูุฉ ูุฅุนุงุฏุฉ ุชุซุจูุชูุง ูู ุงูููุงุฉ ุจุงุณุชุฎุฏุงู ุงูุฃูุงูุฑ: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">make modules sudo umount /mnt/nfs-test sudo rmmod nfsv4 sudo rmmod nfs sudo insmod fs/nfs/nfs.ko sudo mount -a</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุจุงุณุชุฎุฏุงู ูุญุฏุฉ NFS ุ ุชูููุง ูู ุชูุฑุงุฑ ุงูุชุฌุงุฑุจ ูุชููู ุงูุฑุณุงุฆู ูููู ููุฏ NFS.  ุนูู ุณุจูู ุงููุซุงู ุ ููููู ุฃู ุชุฑู ุนูู ุงูููุฑ ูุง ูุญุฏุซ ุนูุฏูุง <code>open()</code> ุงูุชุทุจูู <code>open()</code> ููุงููุงุช: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">Sep 24 20:20:38 test-kernel kernel: [ 1145.233460] Call Trace: Sep 24 20:20:38 test-kernel kernel: [ 1145.233462] dump_stack+0x8e/0xd5 Sep 24 20:20:38 test-kernel kernel: [ 1145.233480] nfs4_file_open+0x56/0x2a0 [nfsv4] Sep 24 20:20:38 test-kernel kernel: [ 1145.233488] ? nfs42_clone_file_range+0x1c0/0x1c0 [nfsv4] Sep 24 20:20:38 test-kernel kernel: [ 1145.233490] do_dentry_open+0x1f6/0x360 Sep 24 20:20:38 test-kernel kernel: [ 1145.233492] vfs_open+0x2f/0x40 Sep 24 20:20:38 test-kernel kernel: [ 1145.233493] path_openat+0x2e8/0x1690 Sep 24 20:20:38 test-kernel kernel: [ 1145.233496] ? mem_cgroup_try_charge+0x8b/0x190 Sep 24 20:20:38 test-kernel kernel: [ 1145.233497] do_filp_open+0x9b/0x110 Sep 24 20:20:38 test-kernel kernel: [ 1145.233499] ? __check_object_size+0xb8/0x1b0 Sep 24 20:20:38 test-kernel kernel: [ 1145.233501] ? __alloc_fd+0x46/0x170 Sep 24 20:20:38 test-kernel kernel: [ 1145.233503] do_sys_open+0x1ba/0x250 Sep 24 20:20:38 test-kernel kernel: [ 1145.233505] ? do_sys_open+0x1ba/0x250 Sep 24 20:20:38 test-kernel kernel: [ 1145.233507] __x64_sys_openat+0x20/0x30 Sep 24 20:20:38 test-kernel kernel: [ 1145.233508] do_syscall_64+0x65/0x130</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูุง ูู ูุฐู <code>vfs_open</code> ู <code>vfs_open</code> ุ  ูุฏู Linux ูุธุงู ูููุงุช ุงูุชุฑุงุถู ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">VFS</a> ) ุ ุทุจูุฉ ุชุฌุฑูุฏูุฉ ุชููุฑ ูุงุฌูุฉ ูุดุชุฑูุฉ ูุฌููุน ุฃูุธูุฉ ุงููููุงุช.  ูุซุงุฆู VFS ุชููู: </p><br><blockquote style=";text-align:right;direction:rtl">  ุชุทุจู VFS open (2) ุ stat (2) ุ chmod (2) ูููุงููุงุช ุงููุธุงู ุงูุฃุฎุฑู.  ูุณุชุฎุฏู ูุธุงู VFS ูุณูุทุฉ ุงุณู ุงููุณุงุฑ ุงูุชู ูุชู ุชูุฑูุฑูุง ุฅูููู ููุจุญุซ ูู ุฐุงูุฑุฉ ุงูุชุฎุฒูู ุงููุคูุช ุนู ุฅุฏุฎุงูุงุช ุงูุฏููู (ุฐุงูุฑุฉ ุงูุชุฎุฒูู ุงููุคูุช ูุทุจ ุงูุฃุณูุงู ุฃู ุฐุงูุฑุฉ ุงูุชุฎุฒูู ุงููุคูุช).  ูููุฑ ูุฐุง ูุญุฑู ุจุญุซ ุณุฑูุนูุง ุฌุฏูุง ูุญูู ุงุณู ุงููุณุงุฑ (ุฃู ุงุณู ุงูููู) ุฅูู ุทุจูุฉ ุฃุณูุงู ูุนููุฉ.  ุชูุฌุฏ Dentry ูู ุฐุงูุฑุฉ ุงููุตูู ุงูุนุดูุงุฆู ููุง ูุชู ุญูุธูุง ุนูู ุงููุฑุต - ููู ููุฌูุฏุฉ ููุท ูู ุฃุฌู ุงูุฃุฏุงุก. </blockquote><br><h3 id="i-nas-osenilo--a-chto-esli-problema-v-dentry-keshe" style=";text-align:right;direction:rtl">  ููุฌุฑ ุนูููุง - ูุงุฐุง ูู ูุงูุช ุงููุดููุฉ ูู ุฐุงูุฑุฉ ุงูุชุฎุฒูู ุงููุคูุช ุงูุฃุณูุงูุ </h3><br><p style=";text-align:right;direction:rtl">  ููุฏ ูุงุญุธูุง ุฃู ุฐุงูุฑุฉ ุงูุชุฎุฒูู ุงููุคูุช ูุทุจ ุงูุฃุณูุงู ูุชู ูุญุตูุง ุนุงุฏุฉ ูู <code>fs/nfs/dir.c</code>  ููุง ููุชููู ุจุดูู ุฎุงุต <code>nfs4_lookup_revalidate()</code> ุ <code>nfs4_lookup_revalidate()</code> ุ <code>nfs4_lookup_revalidate()</code> ุชุนูู ูู ููุช ูุจูุฑ: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">diff --git a/fs/nfs/dir.cb/fs/nfs/dir.c index 8bfaa658b2c1..ad479bfeb669 100644 --- a/fs/nfs/dir.c +++ b/fs/nfs/dir.c @@ -1159,6 +1159,7 @@ static int nfs_lookup_revalidate(struct dentry *dentry, unsigned int flags) trace_nfs_lookup_revalidate_enter(dir, dentry, flags); error = NFS_PROTO(dir)-&gt;lookup(dir, &amp;dentry-&gt;d_name, fhandle, fattr, label); trace_nfs_lookup_revalidate_exit(dir, dentry, flags, error); + goto out_bad; if (error == -ESTALE || error == -ENOENT) goto out_bad; if (error)</code> </pre> <br><p style=";text-align:right;direction:rtl">  ููู ูุฐู ุงูุชุฌุฑุจุฉ ุ ูู ุชุญุฏุซ ูุดููุฉ ููู ุนูุง ุนูููุง ุงูุฒูู!  ูุฃุฎูุฑุง ุ ูุงุฌููุง ุฏุฑุจ. </p><br><p style=";text-align:right;direction:rtl">  ููุนุฑูุฉ ุณุจุจ ุนุฏู ุญุฏูุซ ุงููุดููุฉ ูู <code>pr_info()</code> NFS v4.1 ุ ุฃุถููุง ุงูููุงููุงุช <code>pr_info()</code> ุฅูู ูู <code>if</code> ุญุธุฑ ูู ูุฐู ุงููุธููุฉ.  ูููุง ุจุชุฌุฑุจุฉ NFS v4.0 ู v4.1 ููุฌุฏูุง ุญุงูุฉ ุฎุงุตุฉ ูู ุงูุฅุตุฏุงุฑ v4.1: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">if (NFS_SB(dentry-&gt;d_sb)-&gt;caps &amp; NFS_CAP_ATOMIC_OPEN_V1) { goto no_open; }</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูุง ูู <code>NFS_CAP_ATOMIC_OPEN_V1</code> ุ  ูููู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุชุตุญูุญ kernel</a> ุฃู ูุฐู ุฅุญุฏู ููุฒุงุช NFS v4.1 ุ ูุฃูุฏุช ุงูููุฏ ูู <code>fs/nfs/nfs4proc.c</code> ุฃู ูุฐู ุงููุนููุฉ ูู ูู v4.1 ููู ููุณุช ูู v4.0: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">static const struct nfs4_minor_version_ops nfs_v4_1_minor_ops = { .minor_version = 1, .init_caps = NFS_CAP_READDIRPLUS | NFS_CAP_ATOMIC_OPEN | NFS_CAP_POSIX_LOCK | NFS_CAP_STATEID_NFSV41 | NFS_CAP_ATOMIC_OPEN_V1</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูุฐูู ุ ุชุชุตุฑู ุงูุฅุตุฏุงุฑุงุช ุจุดูู ูุฎุชูู - ูู ุงูุฅุตุฏุงุฑ v4.1 ุ ูุณุชุฏุนู <code>goto no_open</code> ุงููุฒูุฏ ูู ุนูููุงุช ุงูุชุญูู ูู ูุธููุฉ <code>nfs_lookup_revalidate()</code> ุ ููู v4.0 ุชุฑุฌุน ุงูุฏุงูุฉ <code>nfs4_lookup_revalidate()</code> .  ูููู ุญููุง ุงููุดููุฉุ </p><br><h2 id="reshenie" style=";text-align:right;direction:rtl">  ุงูุญู </h2><br><p style=";text-align:right;direction:rtl">  ุชุญุฏุซุช ุนู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุงููุชุงุฆุฌ ุงูุชู</a> ุชูุตููุง <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุฅูููุง ูู ุงููุงุฆูุฉ ุงูุจุฑูุฏูุฉ NFS</a> ูุงูุชุฑุญ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุงูุชุตุญูุญ ุงูุจุฏุงุฆู</a> .  ุจุนุฏ ุฃุณุจูุน ุ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุฃุฑุณู</a> Trond Myklebust <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุณูุณูุฉ ูู ุงูุชุตุญูุญุงุช ูุน ุฅุตูุงุญุงุช ุงูุฃุฎุทุงุก ุฅูู ุงููุงุฆูุฉ ุงูุจุฑูุฏูุฉ ููุฌุฏ ูุดููุฉ ุฃุฎุฑู ุฐุงุช ุตูุฉ ูู NFS v4.1</a> . </p><br><p style=";text-align:right;direction:rtl">  ุงุชุถุญ ุฃู ุงูุฅุตูุงุญ ู NFS v4.0 ุนูุฉ ูุงู ุฃุนูู ูู ูุงุนุฏุฉ ุงูุชุนูููุงุช ุงูุจุฑูุฌูุฉ ููุง ููุง ูุธู.  ูุตูู ุชุฑููุฏ ุฌูุฏุง ูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุงูุชุตุญูุญ</a> : </p><br><blockquote style=";text-align:right;direction:rtl">  ูู ุงูุถุฑูุฑู ุงูุชุฃูุฏ ูู ุงูุชุญูู ุจุดูู ุตุญูุญ ูู inode ู dentry ุนูุฏ ูุชุญ ููู ููุชูุญ ุจุงููุนู.  ูู ุงูููุช ุงูุญุงูู ุ ูุง ูููู ุจุงูุชุญูู ูู ุฅูุง NFSv4.0 ุ ูุฃู ุงูููู ุงูููุชูุญ ูุชู ุชุฎุฒููู ูุคูุชูุง.  ุฏุนููุง ุฅุตูุงุญ ูุฐุง ูุชุฎุฒูู ุงููููุงุช ุงูููุชูุญุฉ ููุท ูู ุญุงูุงุช ุฎุงุตุฉ - ูุงุณุชุนุงุฏุฉ ุงููููุงุช ุงูููุชูุญุฉ ูุฅุนุงุฏุฉ ุงูุชูููุถ. </blockquote><p style=";text-align:right;direction:rtl">  ููุฏ ุชุฃูุฏูุง ูู ุฃู ูุฐุง ุงูุฅุตูุงุญ ุญู ูุดููุฉ ุงูููู ุงููุชูุงุฏู ูุฃุฑุณู ุชูุงุฑูุฑ ุงูุฃุฎุทุงุก ุฅูู ูุฑู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Ubuntu</a> ู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">RedHat</a> . </p><br><p style=";text-align:right;direction:rtl">  ููุฏ ููููุง ุฌูุฏูุง ุฃู ุงูุชุบููุฑุงุช ูู ุชููู ูู ุฅุตุฏุงุฑ kernel ุงููุณุชูุฑ ุจุนุฏ ุ ูุฐูู ุฃุถููุง <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุญูุงู ูุคูุชูุง ููุฐู ุงููุดููุฉ ูู Gitaly</a> .  ููุฏ ุฌุฑุจูุง ูุชุญูููุง ูู ุฃู ุงุณุชุฏุนุงุก <code>stat()</code> ูู ููู <code>packed-refs</code> ูุชุณุจุจ ูู ููุงู kernel ุจุงูุชุญูู ูู ุงูููู ุงููุนุงุฏ ุชุณููุชู ูู ุฐุงูุฑุฉ ุงูุชุฎุฒูู ุงููุคูุช ูุทุจ ุงูุฃุณูุงู.  ููุจุณุงุทุฉ ุ ูููุง ุจุชุทุจูู ูุฐุง ูู Gitaly ูุฃู ูุธุงู ูููุงุช ุ ูููุณ ููุท NFS.  ูุชู ุงูุชุญูู ูู ุงูุตุญุฉ ูุฑุฉ ูุงุญุฏุฉ ููุท ูุจู ุฃู ููุชุญ Gitaly ุงููุณุชูุฏุน ุ ูุจุงููุณุจุฉ ูููููุงุช ุงูุฃุฎุฑู ุ ุชูุฌุฏ ุจุงููุนู ููุงููุงุช <code>stat()</code> . </p><br><h2 id="chemu-my-nauchilis" style=";text-align:right;direction:rtl">  ูุงุฐุง ุชุนูููุง </h2><br><p style=";text-align:right;direction:rtl">  ูููู ุฃู ูุฎูู ุงูุฎุทุฃ ูู ุฃู ุฑูู ูู ุฃุฑูุงู ูุฌููุนุฉ ุงูุจุฑุงูุฌ ุ ููู ุจุนุถ ุงูุฃุญูุงู ุชุญุชุงุฌ ุฅูู ุงูุจุญุซ ุนูู ุฎุงุฑุฌ ุงูุชุทุจูู.  ุฅุฐุง ูุงู ูุฏูู ุงุชุตุงูุงุช ูููุฏุฉ ูู ุนุงูู ุงููุตุงุฏุฑ ุงูููุชูุญุฉ ุ ูุฅู ูุฐุง ุณูุฌุนู ุนููู ุฃุณูู. </p><br><p style=";text-align:right;direction:rtl">  ุดูุฑูุง ุฌุฒููุงู ูู Trond Myuklebust ุนูู ุฅุตูุงุญ ุงููุดููุฉ ุ ูุฅูู Bruce Fields ููุฅุฌุงุจุฉ ุนูู ุฃุณุฆูุชูุง ูุงููุณุงุนุฏุฉ ูู ูุนุฑูุฉ NFS.  ูู ุฃุฌู ูุฐู ุงูุงุณุชุฌุงุจุฉ ูุงูููุงุกุฉ ุงูููููุฉ ุ ููุฏุฑ ูุฌุชูุน ูุทูุฑู ุงูุจุฑุงูุฌ ููุชูุญุฉ ุงููุตุฏุฑ. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar432922/">https://habr.com/ru/post/ar432922/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar432910/index.html">ูู ุงูุฎุทูุฑุฉ ุงุนุชุจุงุฑ ุงููุงูุน ุงูุงูุชุฑุงุถู ุจูุซุงุจุฉ ุขูุฉ ููุชุนุงุทู</a></li>
<li><a href="../ar432912/index.html">ููููุฉ ุงูุญุตูู ุนูู ุงูุชุฏุฑูุจ ูู ุฌูุฌู</a></li>
<li><a href="../ar432914/index.html">ุฑูุจูุช ุฏุฑุฏุดุฉ ุจุณูุท ููุบุงูุฉ ูู Telegram ููุฃุตุบุฑ</a></li>
<li><a href="../ar432918/index.html">ุขุณู ุ ููุฏ ูุณุฑุช ุงูุงูุชุนุงุด ุงูุฎุงุต ุจู</a></li>
<li><a href="../ar432920/index.html">ุงูุนุงูู ุงูุจุดุฑู ูู ุงูุดุฑูุฉ: ูู ูู ุฎุทูุฑุ</a></li>
<li><a href="../ar432924/index.html">Runุ Geckoุ run: ูู ุขููุฉ ุญุฑูุฉ ูุฌูู ููููุงู</a></li>
<li><a href="../ar432926/index.html">24 ูุตูุฉ ุญูู ููููุฉ ูุฌุงุญ ุจุฏุก ุงูุชุดุบูู ูู ูุนุฑุถ ุนุงููู ุถุฎู ุ ุจุงุณุชุฎุฏุงู Web Summit 2018 ููุซุงู</a></li>
<li><a href="../ar432928/index.html">ูุง ูุญุฏุซ ูู ุดุฑูุฉ ุฅูุชู ูููุงุฐุง ูู ุชููู ุฃูุงุฒูู AWS ุจุงููุงูู ุฅูู ุฑูุงุฆููุง ุนูู ุงูุฑุบู ูู ุงูุนูุงููู ุงูุฑุฆูุณูุฉ ุงูุตุงุฎุจุฉ</a></li>
<li><a href="../ar432930/index.html">ุงุณุชุบูุงู ุงูุฃุฑุจุนุงุก ุฏูุณูุจุฑ 2018: ูุงุฎุชุจุงุฑ ุจูุน ุฌุฏูุฏุฉ ูู ุงูููุช ุ ูุงุฏูุง ...</a></li>
<li><a href="../ar432932/index.html">ุงููุธุงู ุงูุจูุฆู ููุนุงูู ุงููุดุชุฑูุงุช ุงูุฑูููุฉ (ูุณุฑูุฉ ุฃูู)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>