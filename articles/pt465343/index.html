<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü•ë üö¥üèø üåä Como fabricamos o motor e o jogo por um ano e meio. Parte Dois A infraestrutura ü§õüèΩ üëàüèø ü§©</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Primeiro, alguns coment√°rios sobre os tra√ßos do artigo anterior. Realmente costum√°vamos trabalhar na Wargaming , onde desenvolvemos um mecanismo conhe...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como fabricamos o motor e o jogo por um ano e meio. Parte Dois A infraestrutura</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/465343/"> Primeiro, alguns coment√°rios sobre os tra√ßos do artigo anterior.  Realmente costum√°vamos trabalhar na <b>Wargaming</b> , onde desenvolvemos um mecanismo conhecido como <b>dava.framework</b> ou <b>dava.engine</b> .  Portanto, muitos colegas antigos, com quem ainda mantemos boas rela√ß√µes, participam ativamente da discuss√£o. <br><br>  V√°rias pessoas t√™m d√∫vidas: √© a mesma tecnologia ou outra?  Resposta: esta √© uma nova tecnologia escrita do zero. <br><br>  Como conseguimos em apenas um ano?  Nossa equipe tem uma vasta experi√™ncia.  Muitos desenvolvem motores e jogos h√° mais de 15 anos. <br><br>  Por que, a partir do zero, se voc√™ pudesse usar nosso mecanismo antigo, que tamb√©m est√° no c√≥digo aberto?  Ele tem cerca de 10 anos e a maior parte do c√≥digo est√° desatualizada.  At√© as melhores partes do motor, das quais nos orgulhamos, √†s vezes continham partes do c√≥digo e alguns rudimentos de 5, 7 e √†s vezes at√© 10 anos atr√°s.  Muitas solu√ß√µes arquitet√¥nicas foram projetadas para dispositivos da √©poca - come√ßando com um iPhone 3G.  Agora, focamos pelo menos no iPad Air 1 e similares em dispositivos Android avan√ßados.  Consequentemente, as abordagens mudaram um pouco. <br><a name="habracut"></a><br>  E a pergunta mais comum: por que possuir um motor?  No √∫ltimo artigo, houve v√°rios argumentos de diferentes graus de persuas√£o.  Quero me concentrar no principal: apenas nossa pr√≥pria tecnologia pode permitir que voc√™ aproveite ao m√°ximo o ferro, fa√ßa o n√∫mero m√°ximo de otimiza√ß√µes especificamente para sua jogabilidade, estilo visual.  Nos posicionamos, inclusive como empresa de tecnologia, n√£o apenas como desenvolvedor de jogos.  Acreditamos que, com nosso n√≠vel de engenheiros e nossa experi√™ncia, podemos competir seriamente no mercado de produtos m√≥veis de alta tecnologia. <br><br>  E agora ao ponto: que ferramentas e t√©cnicas nos ajudaram a realizar essa tarefa bastante ambiciosa em pouco tempo? <br><br><h4>  A infraestrutura </h4><br>  Escolhemos o Atlassian Bitbucket Server + Jenkins.  No Bitbucket est√° o reposit√≥rio principal (mestre), ao qual o Jenkins est√° conectado.  Cada desenvolvedor tem seu pr√≥prio garfo.  Para cada tarefa, uma nova bifurca√ß√£o √© criada na bifurca√ß√£o, que √© integrada de volta atrav√©s da solicita√ß√£o de extra√ß√£o.  Em geral, o esquema √© bastante padr√£o.  Cada solicita√ß√£o √© submetida a uma revis√£o obrigat√≥ria e a testes autom√°ticos.  E, se for bem-sucedido, ele se funde automaticamente no mestre. <br><br><h4>  Jenkins </h4><br>  Jenkins tem v√°rias defici√™ncias: ele √© um focinho da web antigo, n√£o muito r√°pido, guloso, parece um portal da Internet dos anos 90.  No entanto, sua flexibilidade, um grande n√∫mero de m√≥dulos e de forma gratuita a tornam uma boa escolha, mesmo em 2019.  Tendo brincado com os m√≥dulos e configura√ß√µes, voc√™ pode obter uma apar√™ncia diger√≠vel, uma descri√ß√£o declarativa dos pipelines (no reposit√≥rio).  A prop√≥sito, existem cerca de 40 pipelines agora: testes, editores, um jogo para todas as plataformas;  trabalhe com infraestrutura e metagame do servidor.  Colete todos os 20 buildagentov. <br><br>  No futuro, √© claro, quero experimentar solu√ß√µes modernas de hipster, por exemplo, GitLab ou TravisCI auto-hospedado.  N√£o consideramos completamente solu√ß√µes em nuvem (Nevercode, Bitrise, CircleCI, etc.) devido ao grande tamanho de nosso reposit√≥rio, ativos e, consequentemente, ao tempo de constru√ß√£o e tamanho dos artefatos. <br><br><h4>  Sistema de compila√ß√£o </h4><br>  O principal requisito para o sistema era o seguinte: gera√ß√£o de projetos para iOS, MacOS, Android, Windows, Linux em um script.  Conseguimos experimentar Premake, SCons, Bazel e CMake.  Por v√°rias raz√µes, paramos no CMake, testado pelo tempo. <br><br>  Nos √∫ltimos anos, o CMake tornou-se quase o padr√£o para bibliotecas C ++.  Quase tudo, desde o rapel ao SDL, pode ser conectado ao seu projeto CMake em apenas algumas linhas.  √â claro que h√° exce√ß√µes, como o OpenSSL ou V8, com as quais tive que suar um pouco.  No topo do Zmeik nu, desenvolvemos uma pequena estrutura (cerca de 3.000 linhas no total).  Principais recursos: <br>  Modularidade.  As partes individuais do motor s√£o projetadas como m√≥dulos.  Por exemplo, som, interface do usu√°rio, f√≠sica, rede etc.  Cada m√≥dulo pode ter seus pr√≥prios ativos (por exemplo, sombreadores) e pode ter depend√™ncias em outros m√≥dulos. <br><br>  O aplicativo final no mecanismo (jogo, editor, utilit√°rios) conecta apenas os m√≥dulos necess√°rios.  Um pouco distante √© o m√≥dulo principal, que √© uma depend√™ncia para a maioria dos outros m√≥dulos.  O n√∫cleo implementa o ponto de entrada, o ciclo principal do aplicativo, a intera√ß√£o com o sistema operacional e outras entidades b√°sicas. <br>  M√≥dulos de terceiros.  Nossa estrutura permite baixar um reposit√≥rio git ou arquivar em v√°rias linhas, descompactar, compilar, copiar bibliotecas e / ou fontes.  Hoje, temos 66 desses m√≥dulos de terceiros: an√°lises, formatos de arquivos de terceiros, middleware como f√≠sica, uma biblioteca de sons etc. <br><br><h4>  Processo de desenvolvimento </h4><br>  Com base na experi√™ncia anterior, decidimos adicionar o mecanismo e o jogo em um reposit√≥rio.  Isso permite que voc√™ fa√ßa altera√ß√µes na API do mecanismo sem problemas e adapte o jogo de forma s√≠ncrona.  O resultado foi o chamado monoreposit√≥rio, com suas vantagens e desvantagens.  Mas, como planejamos imediatamente manter um ritmo muito alto de desenvolvimento, a possibilidade de refatora√ß√£o s√≠ncrona do mecanismo e do jogo superou todas as outras desvantagens dessa solu√ß√£o. <br><br>  Em m√©dia, adicionamos mais de 20 solicita√ß√µes pull por dia.  Isso significa que o mestre pode potencialmente ser quebrado 20 vezes por dia.  Felizmente, em 1991, eles criaram a t√©cnica de integra√ß√£o cont√≠nua.  A que chegamos? <br><br><h4>  Integra√ß√£o cont√≠nua </h4><br>  Como mencionado acima, um brunch √© criado para cada tarefa na bifurca√ß√£o do desenvolvedor.  Em seguida, uma solicita√ß√£o pull √© criada desse brunch para o reposit√≥rio principal.  Essa solicita√ß√£o de recebimento passa por uma s√©rie de testes automatizados na Jenkins: <br><br><ol><li>  Testes de unidade para todas as plataformas (windows, linux, macos, ios, android).  O Googletest √© usado como base e o OpenCppCoverage, cujo relat√≥rio √© verificado por um script python adicional, √© usado para verificar a porcentagem de cobertura.  Se a porcentagem de cobertura para um arquivo espec√≠fico for menor que 75%, o teste ser√° considerado com falha.  Assim, cobrimos a maioria das classes de mecanismo de baixo n√≠vel com testes. </li><li>  Codeformatter  Para c√≥digo C ++, usamos o formato clang.  A formata√ß√£o do c√≥digo alterado ocorre primeiro automaticamente ao confirmar na m√°quina do desenvolvedor e, em seguida, √© verificada no teste.  Para javascript, usado como linguagem de script, √© usado o npm linter. </li><li>  Testes de ativos.  Um grupo bastante grande de testes: da valida√ß√£o de formatos de arquivo √† verifica√ß√£o de depend√™ncias (por exemplo, verifica√ß√£o da textura usada no n√≠vel do jogo). </li><li>  Testes unit√°rios e funcionais do editor.  Uma parte integrante do mecanismo √© o editor, onde os n√≠veis de jogo e outros ativos s√£o criados e editados.  Al√©m dos testes de unidade, o froglogic Squish for Qt √© usado para testar o editor - um utilit√°rio para teste autom√°tico da GUI.  Tudo isso nos permite fazer o teste manual do editor.  Al√©m disso, de acordo com as cr√≠ticas de artistas e designers de n√≠veis, o n√≠vel de qualidade e estabilidade √© superior ao da empresa anterior, quando tivemos uma equipe de cinco testadores.  Ao mesmo tempo, os lan√ßamentos ocorrem diariamente e, com testes manuais, os lan√ßamentos ocorrem a cada 2 semanas. </li><li>  Testes funcionais do jogo.  √â claro que eu quero usar testes funcionais autom√°ticos para o jogo.  Portanto, come√ßamos a desenvolver o seguinte sistema: </li></ol><br><ul><li>  O aplicativo de teste (especificamente - um script python) inicia um servidor de jogos e um cliente com certos par√¢metros </li><li>  servidor e cliente em execu√ß√£o abrem a porta de rede, </li><li>  O aplicativo de teste se conecta a eles e envia comandos: fa√ßa o download de um mapa, selecione um personagem e armas, v√° para um ponto, mire, atire, etc. </li><li>  a pr√≥pria sintaxe de teste √© python pytest.  Este sistema est√° atualmente em desenvolvimento ativo. </li></ul><br>  A maioria dos projetos para testes √© coletada com o sinalizador "tratar avisos como erros" ativado e na plataforma MacOS com o clang AddressSanitizer ativado adicionalmente, o que permite detectar ainda mais erros no est√°gio de prepara√ß√£o da solicita√ß√£o de recebimento. <br><br>  Al√©m dos testes, cada solicita√ß√£o de recebimento √© revisada por pelo menos dois outros desenvolvedores e, se necess√°rio, √© enviada para revis√£o.  Quando todos os testes estiverem conclu√≠dos e os revisores n√£o tiverem coment√°rios, o pedido de solicita√ß√£o √© congelado automaticamente. <br>  Como alguns testes podem levar um tempo consider√°vel (por exemplo, um teste completo do editor da GUI dura mais de uma hora), um script abreviado √© usado em solicita√ß√µes pull.  O conjunto completo de testes √© iniciado no assistente a cada 4 horas. <br><br>  At√© o momento, 6.600 pull-quests foram criadas e realizadas dessa maneira. <br><br><img src="https://habrastorage.org/webt/sh/io/7k/shio7kkx60nm-urpb2sx97z9w0s.jpeg"><br><br><h4>  Entrega cont√≠nua </h4><br>  Usamos o conceito de lan√ßamentos di√°rios autom√°ticos (ou melhor, di√°rios).  Como exatamente isso acontece: <br><br><ol><li>  a tag git √© criada, </li><li>  executa vers√µes completas de todos os testes, </li><li>  se for bem-sucedido, os artefatos s√£o coletados: </li></ol><br><ul><li>  editores para MacOS e Windows.  Assim, todas as manh√£s, todos t√™m uma nova vers√£o das ferramentas.  E, gra√ßas aos testes autom√°ticos, estamos confiantes em sua certa qualidade e estabilidade. </li><li>  cliente e servidor do jogo para todas as plataformas.  O cliente para iOS √© carregado para o TestFlight, para Android - para o Google Play, outras plataformas - para o JFrog Artifactory, servidores de jogos e outros servi√ßos - para a nuvem.  Ou seja, todas as manh√£s, temos uma nova vers√£o do jogo, pronta para testes e playtests. </li></ul><br>  Obviamente, nem todo lan√ßamento noturno termina com sucesso.  Alguns testes podem falhar ou ocorrer√° um erro cr√≠tico na inicializa√ß√£o do aplicativo.  Nesse caso, os problemas encontrados s√£o reparados pelo desenvolvedor de plant√£o durante o dia e o processo de libera√ß√£o √© reiniciado. <br>  Existem v√°rios em servi√ßo todos os dias: <br><br><ol><li>  Atendente de 1¬∫ n√≠vel.  Monitora a estabilidade dos testes no reposit√≥rio principal. </li><li>  Atendente de segundo n√≠vel no jogo.  Reparando bugs do jogo. </li><li>  Atendente de segundo n√≠vel em editores.  Corrige bugs editoriais, aconselha usu√°rios (artistas, designers de n√≠veis, designers de jogos). </li></ol><br>  Tamb√©m no dia de servi√ßo, voc√™ pode se envolver em d√≠vidas t√©cnicas: adicione os testes ausentes para a funcionalidade antiga, complemente a documenta√ß√£o ou fa√ßa refatora√ß√£o, o que n√£o leva tempo com o planejamento de libera√ß√£o usual. <br><br><img src="https://habrastorage.org/webt/bu/kf/w-/bukfw-ef19i1in1woa5ozjxgecm.jpeg"><br><br>  No pr√≥ximo artigo, examinaremos mais de perto a arquitetura de software do pr√≥prio mecanismo, bem como os principais m√≥dulos e subsistemas. <br><br>  Para continuar ... <br><br>  A primeira parte: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">habr.com/en/post/461623</a> <br><br><img src="https://habrastorage.org/webt/ic/l2/m8/icl2m8bbkuivjomsbt8ugzsibus.jpeg"></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt465343/">https://habr.com/ru/post/pt465343/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt465323/index.html">O que ser√° criptografia p√≥s-qu√¢ntica?</a></li>
<li><a href="../pt465325/index.html">Objetos especiais dif√≠ceis de pegar nos rob√¥s</a></li>
<li><a href="../pt465329/index.html">Modelo de aprendizado de m√°quina interpretado. Parte 2</a></li>
<li><a href="../pt465333/index.html">Como olhar nos olhos de Cassandra e n√£o perder dados, estabilidade e f√© no NoSQL</a></li>
<li><a href="../pt465341/index.html">Como criar uma nuvem privada para vigil√¢ncia por v√≠deo</a></li>
<li><a href="../pt465345/index.html">Evento de contrata√ß√£o m√≥vel da FunCorp</a></li>
<li><a href="../pt465349/index.html">Voc√™ precisa do Agile: 5 modelos para testar</a></li>
<li><a href="../pt465351/index.html">Problemas comuns para quem ganhou o Gostender</a></li>
<li><a href="../pt465353/index.html">Auditoria de Seguran√ßa ICS</a></li>
<li><a href="../pt465355/index.html">Quando 'a' n√£o √© igual a 'a'. Na sequ√™ncia de um hack</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>