<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§¥üèº ‚è∞ üëè Bagaimana memecahkan kamera yang mahal sehingga istrimu tidak membunuhmu üí¶ üõ´ üñ±Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Penafian: penelitian dimulai pada 2013, jadi jika Anda berpikir beberapa metode bodoh dan berbahaya - Anda benar, itu saja. Namun, saya belajar banyak...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Bagaimana memecahkan kamera yang mahal sehingga istrimu tidak membunuhmu</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/438168/"> <i>Penafian: penelitian dimulai pada 2013, jadi jika Anda berpikir beberapa metode bodoh dan berbahaya - Anda benar, itu saja.</i>  <i>Namun, saya belajar banyak dalam prosesnya.</i> <br><br>  <b>Entri</b> <br>  Semuanya dimulai beberapa bulan sebelum kelahiran anak pertama saya.  Istri saya dan saya selalu ingin membeli kamera Leica yang keren dan tiba-tiba menyadari bahwa jika kami tidak membelinya sekarang, maka kami tidak dapat melakukannya untuk waktu yang lama.  Karena itu, kami memesan kamera M240 dan ... booming, kami antri selama enam bulan.  Segera saya bosan menunggu, dan saya mulai mempelajari situs mereka.  Perhatian saya segera ditarik ke bagian file.  Nah, Anda bisa menebak mengapa ... Firmware! <br><br>  Saya melihat file yang tidak dienkripsi dan tidak terkompresi ( <code>m8-2_005.upd</code> ) yang dimulai dengan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">PWAD magic</a> .  Apakah kamu mengenali?  Ya, itu benar, ini adalah format Doom Patch WAD.  Cowok sepertinya menyukai yang klasik.  Formatnya <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">didokumentasikan dengan sangat baik</a> , sehingga tidak sulit untuk menguraikannya. <br><a name="habracut"></a><br><h1>  File firmware Leica </h1><br><h3>  Firmware Leica M8 </h3><br>  Ini sebenarnya sangat lucu, karena ketika saya kemudian mempelajari file firmware Leica T terkompresi, saya pertama kali memutuskan untuk menguji metode kompresi yang digunakan id Software di masa lalu. <br><br>  Wikipedia mengatakan mereka menggunakan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">format LHA</a> , yang pada dasarnya adalah LZW.  Tapi dekompresor LZW yang umum tidak cocok, jadi saya mulai mencari implementasi spesifik dari perangkat lunak id - dan voila, saya menemukan <a href="">Catacomb Armageddon</a> di <a href="">sumbernya</a> .  Saya harus mengakui, beruntung. <br><br>  Bagaimanapun, kembali ke M8.  Berikut adalah struktur firmware: <br><br><pre>  ATURAN: 0x0000008C (3036: 0x00000BDC) - Deskripsi XML
 LUTS: 0x00000C68 (183274: 0x0002CBEA)
  GAMMA: 0x0000007C (31760: 0x00007C10)
  KEUNTUNGAN: 0x00007C8C (50344: 0x0000C4A8)
  LEICA: 0x00014134 (7000: 0x00001B58)
  BLEMISH: 0x00015C8C (250: 0x000000FA)
  WREF: 0x00015D88 (82480: 0x00014230)
  OBJ: 0x00029FB8 (11268: 0x00002C04)
  VERSI: 0x0002CBBC (46: 0x0000002E)
 PXA: 0x0002D854 (858384: 0x000D1910)
 BF: 0x000FF164 (134522: 0x00020D7A) - Perangkat Analog Keluarga prosesor Blackfin
 GUI: 0x0011FEE0 (3574180: 0x003689A4)
  TRANS: 0x0000005C (59988: 0x0000EA54) - lokalisasi
  GAMBAR: 0x0000EAB0 (267433: 0x000414A9)
   21_1PRT: 0x000000CC (18411: 0x000047EB) - gambar JFIF
   21_2GRP: 0x000048B8 (23172: 0x00005A84) - gambar JFIF
   21_3PAN: 0x0000A33C (23034: 0x000059FA) - gambar JFIF
   24_1PRT: 0x0000FD38 (18489: 0x00004839) - gambar JFIF
   24_2GRP: 0x00014574 (23230: 0x00005ABE) - gambar JFIF
   24_3PAN: 0x0001A034 (22998: 0x000059D6) - gambar JFIF
   28_1PRT: 0x0001FA0C (22605: 0x0000584D) - gambar JFIF
   28_2GRP: 0x0002525C (23081: 0x00005A29) - gambar JFIF
   28_3PAN: 0x0002AC88 (23282: 0x00005AF2) - gambar JFIF
   35_1PRT: 0x0003077C (22496: 0x000057E0) - gambar JFIF
   35_2GRP: 0x00035F5C (23532: 0x00005BEC) - gambar JFIF
   35_3PAN: 0x0003BB48 (22881: 0x00005961) - gambar JFIF
  FONT1: 0x0004FF5C (1522988: 0x00173D2C)
  FONT2: 0x001C3C88 (1723676: 0x001A4D1C)
  VERSI: 0x003689A4 (0: 0x00000000)
 M16C: 0x00488884 (130406: 0x0001FD66) - Keluarga Renesas M16C (Rekor Motorola)
 FPGA: 0x004A85EC (131604: 0x00020214) - Xilinx Spartan 3
 FSL: 0x004C8800 (814: 0x0000032E) - bootloader tahap pertama </pre><br>  IDA di luar kotak tidak mendukung prosesor Blackfin, tetapi ada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">plugin pihak ketiga</a> . <br><br><h3>  Firmware Leica M9 </h3><br>  File firmware Leica M9 ( <code>m9-1_196.upd</code> ) terlihat terenkripsi: histogram menunjukkan distribusi sekitar 0,45%. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ac1/6fc/17d/ac16fc17df9bfb0c9c63bdefaecc83d9.png"><br><br>  Akhir cerita?  Mungkin tidak.  Faktanya adalah Leica menggunakan prosesor yang agak lemah di kamera, dan pada saat itu enkripsi XOR sering digunakan dalam elektronik konsumen, jadi saya memutuskan untuk menulis alat sederhana untuk operasi XOR untuk membandingkan firmware dengan saya dan menghitung beberapa statistik. <br><br>  Panjang kunci ditentukan dengan mencari pola pengulangan terpanjang.  Ini masuk akal, karena setiap firmware biasanya menyertakan blok besar data berulang, seperti pad 0x00 / 0xFF atau grafik dengan piksel LUT.  Kunci itu sendiri dihitung oleh frekuensi byte dalam panjang kunci, di mana byte yang paling umum pergi ke buffer kunci.  Hasil program dengan jelas menunjukkan enkripsi XOR.  Kemudian saya harus <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">memodifikasi alat</a> sedikit untuk mendapatkan kunci potensial dan mendekripsi kode.  Ini lagi ternyata file PWAD. <br><br>  Isi PWAD mengungkapkan struktur berikut: <br><br><pre>  ATURAN: 0x0000007C (2788: 0x00000AE4) - Deskripsi XML
 LUTS: 0x00000B60 (4060616: 0x003DF5C8)
  PROSES: 0x0000004C (3900572: 0x003B849C)
   BUAT: 0x0000004C (20: 0x00000014) - cap waktu
   LUTS: 0x00000060 (427744: 0x000686E0)
   GAINMAP: 0x00068740 (20008: 0x00004E28)
   LENS: 0x0006D568 (3452724: 0x0034AF34)
  CCD: 0x003B84E8 (148662: 0x000244B6)
   BUAT: 0x0000004C (20: 0x00000014) - cap waktu
   BLEMISH: 0x00000060 (1092: 0x00000444)
   WREF: 0x000004A4 (147452: 0x00023FFC)
   LIN: 0x000244A0 (22: 0x00000016)
  ICCPROF: 0x003DC9A0 (4304: 0x000010D0)
   ECI-RGB: 0x0000003C (540: 0x0000021C)
   sRGB: 0x00000258 (3144: 0x00000C48)
   A-RGB: 0x00000EA0 (560: 0x00000230)
  WBPARAM: 0x003DDA70 (7000: 0x00001B58)
 BF561: 0x003E0128 (289128: 0x00046968) - Perangkat Analog keluarga Prosesor Blackfin
  bf0: 0x0000004C (117846: 0x0001CC56) - prosesor utama
  bf1: 0x0001CCA4 (117826: 0x0001CC42) - firmware dari subprocessor
  bf0.map: 0x000398E8 (27072: 0x000069C0) - kartu firmware prosesor utama dengan karakter: D
  bf1.map: 0x000402A8 (26304: 0x000066C0) - kartu firmware sub-prosesor dengan karakter: D
 BODY: 0x00426A90 (143280: 0x00022FB0) - Keluarga Renesas M16C (Rekor Motorola)
 GUI: 0x00449A40 (3647624: 0x0037A888)
  TRANS: 0x0000005C (131656: 0x00020248) - lokalisasi
  GAMBAR: 0x000202A4 (267433: 0x000414A9)
   21_1PRT: 0x000000CC (18411: 0x000047EB) - gambar JFIF
   21_2GRP: 0x000048B8 (23172: 0x00005A84) - gambar JFIF
   21_3PAN: 0x0000A33C (23034: 0x000059FA) - gambar JFIF
   24_1PRT: 0x0000FD38 (18489: 0x00004839) - gambar JFIF
   24_2GRP: 0x00014574 (23230: 0x00005ABE) - gambar JFIF
   24_3PAN: 0x0001A034 (22998: 0x000059D6) - gambar JFIF
   28_1PRT: 0x0001FA0C (22605: 0x0000584D) - gambar JFIF
   28_2GRP: 0x0002525C (23081: 0x00005A29) - gambar JFIF
   28_3PAN: 0x0002AC88 (23282: 0x00005AF2) - gambar JFIF
   35_1PRT: 0x0003077C (22496: 0x000057E0) - gambar JFIF
   35_2GRP: 0x00035F5C (23532: 0x00005BEC) - gambar JFIF
   35_3PAN: 0x0003BB48 (22881: 0x00005961) - gambar JFIF
  FONT1: 0x00061750 (1522988: 0x00173D2C)
  USBLOGO: 0x001D547C (1775: 0x000006EF) - gambar JFIF
  FONT2: 0x001D5B6C (1723676: 0x001A4D1C)
 FPGA: 0x007C42C8 (150176: 0x00024AA0) - Xilinx Spartan 3A
 BF547: 0x007E8D68 (937576: 0x000E4E68) - Perangkat Analog Keluarga Prosesor Blackfin (FSL?) </pre><br><br><h3>  Firmware Leica M240 </h3><br>  Saya terbiasa memeriksa halaman unduhan dengan firmware Leica setiap pagi.  Segera muncul file baru: <b>FW_M240_1_1_0_2.FW</b> . <br><br>  Itu tidak terlihat dienkripsi, tetapi dikompresi ... <br><br><h4>  Kompresi </h4><br>  Histogram menunjukkan ledakan besar pada 0x9D. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6cb/025/ef7/6cb025ef734f60b1d4104b7301798cad.png"><br><br>  Mungkin ini semacam sihir kompresi.  Pencarian di Internet [kompresi 9D +] tidak menghasilkan apa-apa, kecuali bahwa 0x1F9D <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">digunakan sebagai tanda tangan untuk kompresi LZW</a> .  Jika ada, saya mengerti jenis kompresi LZ dan memutuskan untuk melihat byte setelah 0x9D.  Dan saya melihat empat opsi: <br><br><ol><li> <code>9D 70 C4</code> <br> </li><li> <code>9D 00</code> <br> </li><li> <code>9D XX YY</code> <br> </li><li> <code>9D XX 8Y YY</code> </li> </ol><br>  Apa lagi yang berhasil Anda perhatikan: <br><br><ul><li>  opsi pertama hanya muncul sekali pada alamat 0x30: mungkin digunakan sebagai indikator data terkompresi; <br></li><li>  XX tidak pernah melebihi 0x7F; <br></li><li>  byte terakhir YY dalam kasus ketiga dan keempat tidak pernah melebihi 0x7F </li></ul><br>  Dari apa yang saya ketahui tentang LZ, ini sangat mirip dengan LZ77 atau LZSS, di mana YY adalah langkah indent dan XX adalah jumlah byte yang akan disalin.  Dan opsi kedua adalah kasus khusus mengeluarkan 0x9D.  Saya menulis fungsi C sederhana yang mengimplementasikan logika ini.  Dia mengkonfirmasi bahwa kami bergerak ke arah yang benar, tetapi opsi keempat masih tidak sesuai dengan skema. <br><br>  Saya mencoba segala cara untuk menafsirkannya, tetapi tidak ada hasilnya.  Oleh karena itu, saya meminta saran pada teman-teman saya.  Seorang pria memperhatikan bahwa menurut pengamatan saya sendiri, byte keempat YY hanya muncul ketika bit tertinggi 0x8Y diatur: ini hanya jarak ekstra untuk langkah indent.  Saya malu, semuanya ternyata sangat jelas ... <br><br>  Akhirnya, decompressor mulai mengeluarkan aliran yang valid ... sampai macet di tengah file.  Ini terjadi karena panjang jendela geser yang tidak diketahui.  Debugging tambahan dan tes memperbaiki situasi. <br><br>  Jadi ada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">alat untuk parsing firmware M240</a> . <br><br><h4>  Struktur firmware </h4><br>  Untuk bekerja dengan format yang tidak dikenal, saya tidak menghasilkan sesuatu yang lebih baik daripada mengukur beberapa offset dan ukuran bagian kode - dan mencoba untuk menemukan nilai terdekat di header file.  Misalnya, blok ini: <br><br> <code>0x00: 1E 1C AF 2E 01 01 00 02 07 E1 EA 5E 00 5C 1A B1 <br> 0x10: 01 29 1A 7E AE 38 73 65 9C 3D 75 B4 34 2F 44 6E <br> 0x20: 13 17 8E 6B 00 00 00 01 00 00 00 30 E1 E3 50 D1</code> <br> <br>  akhirnya berubah menjadi: <br><br> <code>1E1CAF2E ‚Äî   "LEICA FILE" <br> 01010002 - 1.1.0.2 <br> 005C1AB1 ‚Äî    (big endian) <br> 01291A7E ‚Äî    (big endian) <br> AE3873659C3D75B4342F446E13178E6B ‚Äî  MD5 <br> 00000001 ‚Äî    <br> 00000030 ‚Äî    </code> <br> <br>  Ketika saya memahami struktur firmware, saya meningkatkan alat saya, dan pada akhirnya, ini menghasilkan ini: <br><br> <code>Running with options: <br> + firmware folder: M240_FIRMWARE <br> + verbose enabled <br> <br> Open firmware file: FW_M240_1_1_0_2.FW <br> File size: 6036193 | 0x005C1AE1 <br> <br> Parse container header: <br> version: 1.1.0.2 <br> packed size: 6036145 | 0x005C1AB1 <br> unpacked size: 19470974 | 0x01291A7E <br> body blocks: 1 | 0x00000001 <br> body offset: 48 | 0x00000030 <br> MD5: AE387365 9C3D75B4 342F446E 13178E6B <br> MD5 check: PASSED <br> <br> Uncompress container body: <br> 6036145 -&gt; 19470974 <br> Uncompression: DONE <br> <br> Split container: <br> Number of sections: 9 | 0x00000009 <br> Section table size: 612 | 0x00000264 <br> Section table offset: 36 | 0x00000024 <br> Section 1 <br> Section Name: "[A]IMG_LOKI-212" <br> Section offset: 0 | 0x00000000 <br> Section size: 7340032 | 0x00700000 <br> Section base: 1048576 | 0x00100000 <br> MD5: A8D55AA2 B0ACDB14 0673AD79 707674F3 <br> MD5 check: PASSED <br> Create file: M240_FIRMWARE/IMG_LOKI-212.bin <br> <br> ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ <br> <br> Section 9 <br> Section Name: "[A]IMG-LENSDATA-213" <br> Section offset: 19214844 | 0x012531FC <br> Section size: 255478 | 0x0003E5F6 <br> Section base: 16252928 | 0x00F80000 <br> MD5: 39C2BEC0 27ED23F6 2C1C8513 EEE697B9 <br> MD5 check: PASSED <br> Create file: M240_FIRMWARE/IMG-LENSDATA-213.bin <br> Splitting container: DONE <br> Extraction COMPLETE!</code> <br> <br>  Firmware M240 mencakup satu wadah dengan sembilan elemen: <br><br> <code>IMG_LOKI-212.bin -    <br> IMG_LOKI-213.bin -    <br> CTRL_SYS-11.bin -   - <br> IMG-FPGA-212.bin -     () <br> IMG-FPGA-213.bin -     () <br> IMG-DSP-212.bin -  DSP <br> IMG-DSP-213.bin -  DSP <br> IMG-LENSDATA-212.bin -    <br> IMG-LENSDATA-213.bin -   </code> <br> <br>  Seperti yang Anda lihat, dalam satu firmware ada dua set file.  Kemudian saya mengetahui bahwa 212 adalah versi dari mikrosirkuit pemrosesan gambar, dan dua versi Leica M240 mulai diproduksi.  Penelitian ini didasarkan pada versi 212. <br><br><h1>  Manajemen Sistem: CTRL_SYS-11.bin </h1><br>  Satu-satunya bagian yang umum adalah firmware untuk chip kontrol sistem.  Ini adalah biner yang sangat besar, dan kodenya dapat dengan mudah menebak apa yang dimaksudkan. <br><br> <code>$ strings CTRL_SYS-11.bin | rg SH <br> -&gt; Test SH7216 data flash driver <br> -&gt; Test SH7216 SCI driver <br> -&gt; Test SH7216 I2C driver <br> -&gt; Test SH7216 MTU2 driver <br> -&gt; Test SH7216 ADC functions <br> -&gt; Test SH7216 CMT driver</code> <br> <br>  Dengan demikian, kami memiliki prosesor Renesas SH7216 (SH-2A), yang bertanggung jawab untuk tahap awal pemuatan, tes I / O dan pembaruan firmware.  Di luar kotak, IDA mendukung jenis prosesor ini.  Tinggal mencari alamat pemuatan basis yang benar, yang diketahui dari deskripsi bagian firmware: ini <code>0x0</code> . <br><br> <code>Section Name: "[A]CTRL_SYS-11" <br> Section offset: 14680064 | 0x00E00000 <br> Section size: 917277 | 0x000DFF1D <br> Section base: 0 | 0x00000000</code> <br> <br>  Saya memasukkannya ke dalam IDA dan mengenali semua fungsi, tetapi saya tidak menggali khususnya, karena firmware dari prosesor utama jauh lebih menarik. <br><br>  Di sini juga dapat dicatat bahwa UART chip ini terbuka ke port layanan, tempat ia menampilkan log pengunduhan.  Kami akan kembali ke sini nanti. <br><br><h1>  Chip utama: IMG_LOKI-212.bin </h1><br>  Untuk memulai rekayasa balik firmware ini, Anda harus terlebih dahulu menjawab beberapa pertanyaan: <br><br><ol><li>  jenis prosesor apa <br></li><li>  apa alamat beban dasar <br></li><li>  berdasarkan OS apa, jika ada </li></ol><br>  Berkat alat kami, kami sudah tahu alamat beban dasar: ini <code>0x100000</code> . <br><br> <code>Section Name: "[A]IMG_LOKI-212" <br> Section offset: 0 | 0x00000000 <br> Section size: 7340032 | 0x00700000 <br> Section base: 1048576 | 0x00100000</code> <br> <br>  Firmware menyimpan jawaban yang tersisa dalam bentuk yang dapat dibaca.  Misalnya, baris ini: <br><br> <code>$ strings ./IMG_LOKI-212.bin | rg Softune <br> 6Softune REALOS/FR is Realtime OS for FR Family, based on micro-ITRON COPYRIGHT(C) FUJITSU LIMITED 1994-1999 <br> ...</code> <br> <br>  Maka, kami berhadapan dengan prosesor kustom <b>Fujitsu FR</b> (Leica menyebutnya <b>Maestro</b> ) dan <b>sistem</b> operasi <b>Softune REALOS</b> .  Sebenarnya, ini jauh lebih baik daripada Blackfin, karena IDA out of the box mendukung FR. <br><br><h2>  Modul prosesor FR </h2><br>  Kenyataannya tidak begitu cerah, karena setelah mengunduh file firmware, program IDA tidak menunjukkan instruksi, tautan eksternal, dll. <br><br>  Saya memutuskan untuk memperbaikinya, tetapi pada akhirnya saya harus <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">sepenuhnya menulis ulang beberapa bagian dari firmware</a> .  Inilah hasilnya: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9f3/728/c76/9f3728c769d29aa02e2f405c08d8bb9a.png"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/a08/2ea/81d/a082ea81d9056b07935398a19d4df294.png"><br><br>  Selain koreksi dalam <code>ana</code> , <code>ins</code> dan <code>out</code> , kode <code>emu</code> sama sekali baru dapat: <br><br><ul><li>  mengenali berbagai jenis kode dan tautan eksternal ke data; <br></li><li>  Kenali pernyataan sakelar <br></li><li>  melakukan stack tracing; <br></li><li>  Pisahkan argumen stack dan variabel lokal <br></li><li>  mengenali fungsi dengan benar. </li></ul><br>  Tetapi perubahan terbesar, seperti yang Anda perhatikan, adalah huruf kapital untuk instruksi :) <br><br>  Ingin melihat set instruksi lengkap?  Ini dia: <br><br><pre>  TAMBAH ATAU BTSTH LSR MOV BN LDRES EXTSH   
 ADD2 ORH MUL LSR2 JMP BP STRES EXTUH   
 ADDC ORB MULU ASR PANGGILAN BV COPOP SRCH0   
 TAMBAH EOR MULH ASR2 RET BNV COPLD SRCH1   
 ADDN2 EORH MULUH LDI INT BLT COPST SRCHC   
 SUB EORB DIV0S LDI INTE BGE COPSV LDM0    
 SUBC BANDL DIV0U LDI RETI BLE NOP LDM1    
 SUBN BANDH DIV1 LD BRA BGT ANDCCR STM0    
 CMP BORL DIV2 LDUH BNO BLS ORCCR STM1    
 CMP2 BORH DIV3 LDUB BEQ BHI STILM ENTER   
 DAN BEORL DIV4S ST BNE DMOV ADDSP TINGGALKAN   
 ANDH BEORH LSL STH BC DMOVH EXTSB XCHB    
 ANDB BTSTL LSL2 STB BNC DMOVB EXTUB </pre><br>  Sangat sederhana dan indah. <br><br>  Omong-omong, Anda mungkin telah memperhatikan bahwa beberapa instruksi tidak selaras: <br><br><pre>  BRA: D loc_xxx
     LDI: 8 # 0x64, R5 </pre><br>  Ini bukan kesalahan dalam modul prosesor, tetapi sebenarnya fitur keluarga Fujitsu FR.  Ini disebut <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">slot tunda</a> dan cukup khas untuk prosesor RISC. <br><br>  Dari <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">manual prosesor FR80</a> (catatan: tautan tidak lagi berfungsi): <br><br><blockquote>  Instruksi, yang terletak tepat setelah instruksi cabang (lokasinya disebut "slot tunda"), dieksekusi sebelum cabang, dan instruksi pada alamat target dieksekusi setelah cabang.  Karena instruksi dalam slot penundaan dijalankan sebelum operasi cabang, kecepatan eksekusi yang terlihat adalah 1 siklus. </blockquote><br>  Dengan demikian, ini, pada intinya, optimasi pipa, dan lebih baik untuk mengingatnya, karena digunakan di mana-mana dalam firmware Leica. <br><br><h2>  Softune REALOS </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Dari wiki</a> : <br><br><blockquote>  Softune adalah lingkungan pengembangan terintegrasi Fujitsu untuk keluarga prosesor Fujitsu FR, FR-V, dan F2MC.  Didukung oleh REALOS ŒºITRON kernel real-time.  Misalnya, ini digunakan pada kamera DSLR Nikon (lihat Nikon EXPEED) dan beberapa kamera Pentax dengan K. </blockquote><br>  Jadi ini adalah RTOS yang layak cukup populer dengan tugas, semaphore dan barang lainnya.  Saya bertanya-tanya apakah mungkin untuk mengenali beberapa fungsi perpustakaan standar dalam firmware Leica. <br><br>  Saya harus menyebut bagian pertama dari penelitian ini sebagai pemborosan waktu, dan inilah alasannya. <br><br>  Softune IDE ternyata sangat sulit ditemukan, tetapi pada akhirnya saya berhasil mendapatkan sesuatu.  Seperti yang diharapkan, IDE menyertakan perpustakaan.  Ada empat binari: <br><br><ul><li>  lib911.lib <br></li><li>  lib911e.lib <br></li><li>  lib911if.lib <br></li><li>  lib911p.lib </li></ul><br>  Saya tidak tahu mengapa, mungkin dengan inersia, ketika saya meretas semua yang berhubungan dengan Leica, saya mulai merekayasa balik format tersebut lagi.  Ya, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Format Modul Objek yang</a> didokumentasikan dengan sangat baik.  Dan ya, tentu saja, saya <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">menulis alat khusus untuk ini</a> : <br><br> <code>Fujitsu RISC Library Tool v1.0 <br> Usage: FRLibTool [-s start] [-i imagebase] [-o output] [-f index] [-dv] FIRMWARE.BIN LIBRARY.LIB <br> <br> This tool will help you to find Softune REALOS library functions in FR (Fujitsu RISC) firmware. <br> Use following arguments: <br> -f Specify firmware image file <br> -s Specify firmware image scan offset <br> -b Specify firmware imagebase <br> -o Specify output type (exclusively) <br> list - list of functions <br> idc - IDC script <br> py - IDA python script <br> pat - FLAIR pattern file <br> -i xxx Specify index of particular function <br> -d Dump library <br> -v Be verbose</code> <br> <br>  Dengan menggunakannya, Anda dapat membuat file <code>*.pat</code> dan menggunakannya sebagai input dalam <b>IDA FLAIR</b> untuk menghasilkan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">file tanda tangan</a> . <br><br> <code>$ FRLibTool -o pat lib911.lib <br> $ FRLibTool -o pat lib911e.lib <br> $ FRLibTool -o pat lib911if.lib <br> $ FRLibTool -o pat lib911p.lib <br> ... <br> $ sigmake -n "SOFTUNE C/C++ Library" lib911.pat lib911e.pat lib911if.pat lib911p.pat softune.sig</code> <br> <br>  Setelah menerapkan tanda tangan ini, saya akhirnya senang melihat korespondensi di <b>IMG_LOKI-212.idb</b> . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/189/618/145/189618145ab302edfff51fa222ed89b3.png"><br><br><h4>  Tata letak </h4><br>  Jumlah baris dalam firmware segera menarik perhatian.  Banyak fungsi diberi nama karena fungsinya.  Ini sangat berguna dalam proses rekayasa terbalik untuk memahami pola umum. <br><br>  Penting juga untuk dicatat bahwa beberapa bagian file firmware disalin ke alamat berbeda di handler reset.  Misalnya, pemuat bawaan saat runtime bergerak lebih tinggi dalam RAM. <br><br>  Saya harus secara manual membuat bagian tambahan, akibatnya, saya mendapat tata letak berikut: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/70f/d9d/ca3/70fd9dca36e610c7dea2e1c2fd29090c.png"><br><br><h4>  Gangguan </h4><br>  Tabel vektor interupsi dapat ditemukan dengan mengakses TBR (Table Base Register): <br><br> <code>LDI:32 #int_table, R0 <br> MOV R0, TBR</code> <br> <br>  Biasanya ini terjadi pada handler reset vektor di awal firmware. <br><br>  Alamat penangan dalam tabel disimpan dalam urutan terbalik sesuai dengan formula <code>TBR + (0x3FC - 4 √ó inum)</code> , sehingga vektor reset di akhir tabel diimbangi <code>0x3FC</code> . <br><br>  Saya menemukan sebagian besar gangguan dari manual FR dan menyarankan bahwa Leica Maestro memiliki tata letak yang mirip.  Kemudian dia mengambil masing-masing pawang dan mencoba menemukan seutas tali atau petunjuk lain yang mengungkapkan tujuan interupsi. <br><br>  Sebagai hasilnya, saya membuat daftar ini: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/bd7/eb8/c29/bd7eb8c291d5368d44576466400cb34b.png"><br><br>  Banyak interupsi yang cukup diharapkan, seperti AUDIO / SDIO / VIDEO / JPEG / RAW, tetapi mencoba mengidentifikasi yang paling misterius dari mereka?  Saya berbicara tentang interupsi <code>int_uart_in</code> .  Tampaknya kamera mendukung semacam mode konsol UART CLI. <br><br><h4>  Panggilan sistem </h4><br>  Seperti hampir semua OS, Softline REALOS menggunakan panggilan sistem.  Di assembler, mereka terlihat seperti ini: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/22f/a92/9e3/22fa929e311af81f43be57bf0bbbbc74.png"><br><br>  Alamat aktual penangan panggilan sistem dihitung sebagai berikut.  Mari kita mulai dengan mencari interrupt handler <code>INT #0x40</code> .  Seperti dijelaskan di atas, ini <br><br> <code>(0x3FC - 4 √ó inum) = (0x3FC - 4 √ó 0x40) = 0x2FC = int_realos_syscall</code> <br> <br>  Di handler, mudah untuk menemukan tautan ke bagian bawah tabel panggilan sistem dengan kata-kata 16-bit.  Catatan spesifik dalam tabel ini dihitung dengan rumus <code>syscall_table_bottom + (num * 2)</code> : <br><br> <code>[syscall_table_bottom + (-23 * 2)] = [syscall_table_bottom - 0x2E] = [0x1012EA] = 0xE68</code> <br> <br>  Ini tidak terlihat seperti alamat, karena alamat sebenarnya dari penangan panggilan sistem dihitung sebagai <code>syscall_table_bottom + offset</code> .  Seluruh proses ditunjukkan dalam diagram. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c5a/240/2bb/c5a2402bb00a171532dabf9ef9aa45ea.png"><br><br>  Semua panggilan sistem dan fungsinya ditunjukkan dalam <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">manual kernel Softline REALOS / FR</a> , jadi saya berhasil mengembalikan semua penangan yang diimplementasikan dalam tabel dan sedikit meningkatkan IDB. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c6a/b81/57a/c6ab8157a83a3e00613b4a000de45e54.png"><br><br>  Tentu saja, Anda dapat membuat kode lebih indah dengan mendefinisikan jenis-jenis panggilan sistem di IDA. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1e0/75c/099/1e075c099f1bdcb70388427705dd25c0.png"><br><br>  Saya menulis <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">skrip Python</a> untuk secara otomatis mencari panggilan sistem ini dan banyak lagi. <br><br><h4>  Tugasnya </h4><br>  Dalam panggilan sistem <code>sta_tsk</code> saya perhatikan bahwa bukan fungsi utama yang dilewatkan sebagai parameter, tetapi pid.  Ini berarti saatnya untuk mencari array besar deskriptor tugas.  Dan masuk akal untuk memulai dengan <code>sta_tsk</code> itu sendiri. <br><br><pre>  ROM: 102180 sys_sta_tsk:
 ROM: 102180 ST RP, @ -R15
 ROM: 102182 LDUB @ (R14, 0x4F), R3
 ROM: 102184 LDI: 32 # word_100B80, R14 </pre><br>  Pada awalnya kami melihat beberapa tautan.  Saya harus mengotak-atik sedikit dengan tipe data, tetapi pada akhirnya potongan-potongan itu menyatu: <br><br><pre>  ROM: 100B80 word_100B80: .word 0xF;  sejumlah tugas
 ROM: 100B82 .word 0x1C;  ukuran deskriptor tugas<font></font>
<font></font>
 ROM: 100B84 .panjang 0x82A09F5C;  deskriptor tugas 1
 ROM: 100B88. Panjang 0x1000D
 ROM: 100B8C. Panjang 0
 ROM: 100B90 .panjang 0x40000000
 ROM: 100B94 .long sub_1A7DB2;  tugas utama
 ROM: 100B98. Panjang 0x8286EEC0
 ROM: 100B9C. Panjang 0<font></font>
<font></font>
 ROM: 100BA0. Panjang 0x82A09F88;  deskriptor tugas 2
 ROM: 100BA4. Panjang 0x20010
 ROM: 100BA8. Panjang 0
 ROM: 100BAC .panjang 0x40000000
 ROM: 100BB0 .panjang sub_1A6BD2;  tugas utama
 ROM: 100BB4 .panjang 0x8287EEC0
 ROM: 100BB8. Panjang 0
 ... </pre><br>  dan sebagainya.  Hanya 15 tugas.  Itu masalah waktu untuk melihat ke dalam setiap fungsi utama, menentukan nama dan tujuan tugas (kecuali yang terakhir).  Berikut daftar lengkapnya: <br><br><ol><li>  <b>SubCPU</b> <br>  Tugas ini tampaknya bertanggung jawab untuk operasi penangkapan seperti pemaparan, penampakan di layar, dll. <br></li><li>  <b>Manajer kunci</b> <br>  Kemungkinan besar, tugas ini dikaitkan dengan tombol perangkat keras. <br></li><li>  <b>Guimanager</b> <br>  Tugas yang cukup besar, di mana mesin keadaan UI dan rendering antarmuka diimplementasikan. <br></li><li>  <b>Debugmanager</b> <br>  Ya, ada sesuatu yang harus di-debug.  Yum yum. <br></li><li>  <b>Pembuat film</b> <br>  Tugas ini adalah semua tentang operasi file. <br></li><li>  <b>Fammanager</b> <br>  Saya akan mengatakan bahwa tugas bertanggung jawab atas file dan memori, karena itu tergantung pada tugas manajer file dan manajer memori. <br></li><li>  <b>Memorymanager</b> <br>  Tidak ada kejutan: operasi memori, manajemen kolam, dll. <br></li><li>  <b>Imagemanager</b> <br>  Tugas ini mengelola proses encoding / decoding dan proses pemrosesan gambar lainnya. <br></li><li>  <b>Manajer Usb</b> <br>  Tantangan saat ini adalah pemrosesan komunikasi USB, yang mencakup MassStorage, PTP, dan protokol Leica sendiri. <br></li><li>  <b>IOManager</b> <br>  Tugas ini tampaknya mengelola perangkat penyimpanan seperti kartu SD dan CF (apa? Apa CF lainnya? Mungkin itu dari model 213). <br></li><li>  <b>Manajer sistem</b> <br>  Berbagai tugas seperti operasi sistem umum, manajemen daya, dll. <br></li><li>  <b>Pengaturan Manajer</b> <br>  Menangani status dan pengaturan kamera. <br></li><li>  <b>Monitormanager</b> <br>  Melacak perubahan kondisi kamera dan menginformasikan tugas lainnya. <br></li><li>  <b>Manajer periferal</b> <br>  Tugas ini mengontrol GPS, kecerahan, dan beberapa sensor lainnya. <br></li><li>  <b>Tidak dikenal</b> <br>  Sayangnya, saya tidak menemukan sesuatu yang signifikan baginya. </li></ol><br>  Sangat menarik untuk dicatat bahwa setelah array utama ada keterangan lain yang beredar. <br><br> <code>ROM:100D28 dword_100D28: .long 0x82A0A1F0 <br> ROM:100D2C .long 0x21 <br> ROM:100D30 .long 0 <br> ROM:100D34 .long 0x80000000 <br> ROM:100D38 .long tid16_task <br> ROM:100D3C .long 0x8285EEC0 <br> ROM:100D40 .long 0</code> <br> <br>  Dan fungsi dari tugas ini hanya bercabang sendiri. <br><br> <code>ROM:101494 sub_101494: <br> ROM:101494 BRA sub_101494 ; CODE XREF: sub_101494</code> <br> <br>  Deskriptor ini direferensikan di akhir fungsi <code>start</code> , yang bertanggung jawab untuk membuat tugas-tugas lain dan mengatur firmware.  Jadi ini kemungkinan besar adalah tugas tidak adanya sistem. <br><br><h4>  Modul dan Pesan </h4><br>  Selain tugas, Anda dapat menentukan beberapa objek logis, seperti IO dan modul periferal.  Modul disajikan sebagai sekelompok penangan pesan sebagai bagian dari salah satu tugas. <br><br>  Kelompok IO tampaknya meliputi: <br><br><ul><li>  Manajer IO </li><li>  Subprocessor </li><li>  Manajer USB </li><li>  USB PTP </li><li>  Protokol Leica USB </li><li>  Penyimpanan massal USB </li><li>  Pengelola Tombol </li><li>  Manajer debug </li><li>  Manajer lensa </li></ul><br>  Dan pada kelompok periferal: <br><br><ul><li>  Manajer Periferal </li><li>  Sensor cahaya </li><li>  LED </li><li>  Pembicara </li><li>  Sensor kemiringan </li><li>  Pengakuan penutupan tutup </li><li>  Modul GPS </li><li>  Modul 3DAxis </li></ul><br>  Sistem pengiriman pesan itu sendiri menggunakan struktur SOFTUNE standar: <br><br><pre> <code class="plaintext hljs">struct RealOS_MsgPayload { uint32_t msgID; // +0x0 uint32_t data[]; // +0x4 } struct RealOS_Message { uint32_t os_reserved1; // +0x0 uint32_t os_reserved2; // +0x4 uint32_t to; // +0x8 uint32_t from; // +0xC RealOS_MsgPayload* payload; // +0x10 }</code> </pre> <br>  Seperti yang diharapkan, IPC juga memiliki beberapa grup pesan.  Karena banyak pesan diproses dalam tugas dan modul, saya hanya dapat memulihkan beberapa dari grup ini: <br><br><pre>  0x1101xxxx - pesan sistem global:
              0x11010002 = SYS_UPDATE_BOOTLOADER atau
              0x11010005 = SYS_ERASE_SETTINGS
 0x1102xxxx - pesan yang terkait dengan pengambilan gambar:
              0x11020001 = CMD_CAP_CAPTURE atau
              0x11020008 = IMAGE_STATUS_CHANGED  
 0x1104xxxx - pesan tentang acara yang berkaitan dengan pemutaran:  <font></font>
             0x11040002 = PLY_DISABLE_PLAY_MODE <font></font>
             0x11040004 = PLY_IMAGE_READY  <font></font>
0x1108xxxx -     PTP  .:<font></font>
             0x11080002 = DBG_CHANGE_LEVEL <font></font>
             0x11080012 = DBG_WRITE_ROM_DUMP_SD  <font></font>
0x2201xxxx -  USB PTP<font></font>
             0x22010108 =    <font></font>
             0x22010118 =  DebugObject  <font></font>
0x2202xxxx -     SUBCPU:<font></font>
             0x22020002 = E_SUBCPU_REQUEST_M_EXPOSURE_REQUEST  <font></font>
             0x22020015 = E_IO_SUBCPU_COMMAND_CLEANING_SENSOR  <font></font>
0x2203xxxx -    :<font></font>
             0x22030001 =   <font></font>
0x2204xxxx -   IO:<font></font>
             0x2204000C = / Mass Storage <font></font>
             0x22040012 =    <font></font>
0x330000xx -     UI:<font></font>
             0x33000001 =  <font></font>
             0x33000007 =  <font></font>
0x440000xx -   ,     <font></font>
             0x44000013 = E_IMG_CMD_CHANGE_PINFO  <font></font>
0x55xxxxxx ‚Äî   FAM:  <font></font>
             0x558800xx = - FAM <font></font>
             0x558888xx =     FAM<font></font>
0x6602xxxx ‚Äî     LED, :<font></font>
             0x66020001 -  LED  X <font></font>
             0x66020002 =   LED  <font></font>
0x6604xxxx -  :<font></font>
             0x66040001 =  <font></font>
             0x66040007 =    <font></font>
0x6611xxxx -  ,   <font></font>
0x6622xxxx -   ,   <font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0x6660xxxx - beberapa pesan lain yang berkaitan dengan memori:</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
             0x66600006 = HISTOGRAM  </font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
             0x66600011 = RAWCOMP  </font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0x771100xx dan 0x77AA00xx - pesan yang terkait dengan beralih mode kamera </font></font></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Sayangnya, banyak posting lain masih belum diketahui. </font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> GUI </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dalam file firmware, kita juga akan melihat bagian-bagian berikut: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CTRL_SYS-11</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IMG-LOKI-212</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IMG-DSP-212</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IMG-FPGA-212</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IMG-LENSDATA-212</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yang mengejutkan saya adalah kurangnya sumber daya GUI. Tetapi mereka harus berada di suatu tempat dan, kemungkinan besar, dibangun ke </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IMG-LOKI-212</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Salah satu pendekatan saya yang biasa untuk membalikkan pengembangan firmware adalah mengembalikan semua referensi silang yang mungkin. Tidak hanya di kode, tetapi juga di bagian data. Lalu saya melihat-lihat, mencoba menemukan beberapa pola atau tautan ke bagian kode yang diketahui.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Firmware Leica tidak terkecuali. </font><font style="vertical-align: inherit;">Ada banyak urutan data serupa dengan alamat ke urutan data lain yang lebih jauh, dll. Ketika saya menaiki hierarki tautan, saya akhirnya melihat fungsi yang sudah dikenal. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Misalnya, saya menemukan struktur data tanpa tautan:</font></font><br><br><pre> <code class="plaintext hljs">g_data = { ... }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Struktur lain mengatasinya: </font></font><br><br><pre> <code class="plaintext hljs">g_data_struct1 = { ... , &amp;g_data }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Yang pada gilirannya disebut oleh struktur lain: </font></font><br><br><pre> <code class="plaintext hljs">g_data_struct2 = { &amp;g_data, ... }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Struktur data ini memiliki tautan dari kode, dan diteruskan sebagai parameter ke fungsi lain: </font></font><br><br><pre> <code class="plaintext hljs">func1() ‚ï∞ func2(..., &amp;g_data_struct2, ...)</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Namun, </font></font><code>func1()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">itu tidak dipanggil langsung dari fungsi lain, tetapi disimpan dalam beberapa array:</font></font><br><br><pre> <code class="plaintext hljs">g_func_list1[] = { ..., func1(), ... }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Melihat di atas, saya menemukan panggilan dalam kode </font></font><code>g_func_list1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="plaintext hljs">func3() { g_func_list1[x] }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Dan lagi, fungsi ini disimpan dalam array: </font></font><br><br><pre> <code class="plaintext hljs">g_func_list2[] = { ..., func3(), ... }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Beberapa kode lain mengakses array itu sendiri: </font></font><br><br><pre> <code class="plaintext hljs">func4() { g_func_list2[x] }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Untungnya, kali ini fungsinya dipanggil dari fungsi lain, dan seterusnya </font></font><code>gui_MADE_ApplicationRun</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br><br><pre> <code class="plaintext hljs">gui_Statemachine_DoStateChange() ‚ï∞ gui_MADE_ApplicationRun() ‚ï∞ func5() ‚ï∞ func4()</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Beberapa baris menunjukkan bahwa subsistem GUI disebut "MADE," dan transisi halaman ditangani menggunakan </font></font><code>MADE_GetSysTri</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">apa pun artinya. </font><font style="vertical-align: inherit;">Mesin negara GUI pada dasarnya diimplementasikan dalam suatu fungsi </font></font><code>gui_Statemachine_DoStateChange</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Setelah mengumpulkan informasi tentang GUI, gambaran umum muncul: </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/4d4/33e/3cf/4d433e3cf679dba11141d58d080daf5b.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Seperti yang Anda lihat, fungsi utama untuk sumber daya GUI adalah </font></font><code>gui_CopyImageDesc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(meskipun ini bukan nama asli). </font><font style="vertical-align: inherit;">Dia memiliki argumen berikut:</font></font><br><br><pre> <code class="plaintext hljs">gui_CopyImageDesc( uint32_t dstAddress; // R4 - destination address UIDescType type; // R5 - description type UITarget target; // R6 - rendering target uint32_t descAddress; // R7 - description address uint8_t always0; // (SP + 0x0) - always 0 uint8_t index1; // (SP + 0x4) - index 1 uint8_t index2; // (SP + 0x8) - index 2 uint16_t x_offset; // (SP + 0xC) - x offset uint16_t y_offset; // (SP + 0x10) - y offset uint16_t unknown2; // (SP + 0x14) - uint32_t language1; // (SP + 0x18) - language id 1 uint32_t language2; // (SP + 0x1C) - language id 2 uint32_t funcAddress; // (SP + 0x20) - function address )</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ada empat jenis deskripsi sumber daya: </font></font><br><br><pre> <code class="plaintext hljs">struct UIDescType0Header struct UIDescType1Header struct UIDescType2 struct UIDescType3 { { { { uint32_t address; uint32_t address; uint32_t reg; uint16_t x_offset; uint16_t entries; uint16_t entries; uint32_t address; uint16_t y_offset; uint16_t unknown; uint16_t unknown; uint16_t unknown1; uint32_t address; } } uint16_t unknown2; } uint16_t unknown3; struct UIDescType0Entry struct UIDescType1Entry uint16_t tableoff; { { } uint16_t x_offset; uint16_t x_offset; uint16_t y_offset; uint16_t y_offset; uint32_t address; uint32_t address; } uint16_t objects; uint16_t total_w; uint16_t total_h; uint16_t unknown; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tipe pertama memiliki header dengan referensi ke array catatan. Setiap catatan memiliki koordinat dan alamat untuk data piksel. Jenis saat ini tampaknya menggambarkan elemen yang bergantung pada keadaan, seperti ikon, yang mungkin berwarna abu-abu atau menghilang dari UI. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tipe kedua juga dimulai dengan tajuk dan digunakan untuk melokalkan, menjelaskan garis atau blok teks. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tipe ketiga menjelaskan peta karakter untuk berbagai bahasa. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jenis yang terakhir bertanggung jawab untuk semua sumber daya statis lainnya, seperti gambar, latar belakang, dll. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sekarang mari kita lihat data untuk gambar itu sendiri. </font><font style="vertical-align: inherit;">Enam byte pertama terlihat seperti header kecil, diikuti oleh semacam pola berulang, di mana setiap byte kedua adalah salah satu </font><font style="vertical-align: inherit;">, atau </font><font style="vertical-align: inherit;">. Adalah logis untuk mengasumsikan bahwa </font><font style="vertical-align: inherit;">dan</font></font><br><br> <code>+0x00: 00 08 00 14 00 01 A2 FF 0A 04 05 FF 0C 04 03 FF <br> +0x10: 0D 04 03 FF 0E 04 02 FF 0E 04 02 FF 04 04 06 FF <br> +0x20: 04 04 02 FF 04 04 06 FF 04 04 02 FF 04 04 06 FF <br> +0x30: 04 04 02 FF 04 04 06 FF 04 04 02 FF 04 04 06 FF <br> +0x40: 04 04 02 FF 04 04 06 FF 04 04 02 FF 04 04 06 FF <br> +0x50: 04 04 02 FF 04 04 06 FF 04 04 02 FF 0E 04 02 FF <br> +0x60: 0E 04 02 FF 0D 04 03 FF 0D 04 03 FF 0C 04 04 FF <br> +0x70: 04 04 0C FF 04 04 0C FF 04 04 0C FF 04 04 0C FF <br> +0x80: 04 04 0C FF 04 04 0C FF 04 04 0C FF 04 04 0C FF <br> +0x90: 04 04 0D FF 02 04 2D FF 00 06 00 14 00 01 79 FF</code> <br> <br><font style="vertical-align: inherit;"></font><code>0xFF</code><font style="vertical-align: inherit;"></font><code>0x04</code><font style="vertical-align: inherit;"></font><code>0x0008</code><font style="vertical-align: inherit;"></font><code>0x0014</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- lebar dan tinggi dalam tampilan dengan urutan byte langsung (big endian). Di akhir dump ini, kita melihat awal dari urutan lainnya </font></font><code>00 06 00 14 00 01</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Kemungkinan besar, ini adalah sumber daya berikutnya (seperti yang dikonfirmasi oleh tautan ke sana). Dengan demikian, ukuran data gambar aktual adalah 146 byte. Tetapi ukuran gambar harus 0x8 * 0x14 = 0xA0 = 160. Jelas bahwa data tersebut bukan piksel murni dan bahkan LUT 8-bit, karena lebih kecil 14 byte.</font></font> Lalu apa?<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mungkin semacam kompresi. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Melihat dump heksadesimal ini, sulit untuk percaya bahwa beberapa jenis skema kompleks digunakan. GUI Leica tidak terlalu berwarna, jadi menurut pengalaman saya, yang terbaik adalah menggunakan tabel LUT di sini. Dalam hal ini, sumber daya UI akan sepenuhnya mengulangi indeks LUT seperti </font></font><code>03 03 03</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">atau </font></font><code>1 1 1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Biasanya, kompresor mencoba menyingkirkan duplikasi data, menggantinya dengan tautan. Array indeks ini ideal untuk kompresi bahkan dengan metode sederhana seperti RLE </font></font><code>[data][number]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Perintah sederhana untuk menulis </font></font><code>data</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(nilai) </font></font><code>number</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kali. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dengan semua ini dalam pikiran, saya menyarankan agar kita kemungkinan besar melihat gambar sederhana dengan dua warna LUT ( </font></font><code>0xFF</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan </font></font><code>0x04</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), dan byte di depan warna adalah jumlah piksel untuk menggambar.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Dan kemudian Anda menulis instrumen lain," Anda berpikir. Tapi tidak, saya mengambil pena dan kertas dan mulai mengisi sel. Lucu kalau saya masih punya foto itu. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/743/b4a/1f3/743b4a1f3a65f485760e8a4f0584d2e6.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Di suatu tempat di sepanjang jalan, saya menyadari bahwa 160 piksel tidak cukup untuk gambar ini, jadi 0x8 dan 0x14 perlu dikalikan dua. Kata ketiga 0x0001 menunjukkan apakah gambar adalah karakter ASCII, jadi struktur ImageAsset akhir adalah sebagai berikut:</font></font><br><br><pre> <code class="plaintext hljs">struct ImageAsset { uint16_t width; // /2 (big endian) uint16_t height; // /2 (big endian) uint16_t ascii; // 1,   ASCII struct image_data { uint8_t number; //     uint8_t color; //     LUT } data[]; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tetapi satu bagian masih hilang: LUT. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Itu tidak begitu sulit ditemukan, karena banyak tautan dan struktur sudah dipulihkan secara manual, jadi saya perlahan menggulir bagian data, mencari array 256 elemen dari nilai 16-bit atau 32-bit, sampai saya menemukan ini: </font><font style="vertical-align: inherit;">Sekali lagi, terima kasih Dalam pekerjaan saya dengan Desain Blackmagic, saya langsung mengenali piksel YUV (misalnya, semua nilai dengan angka 8080). </font><font style="vertical-align: inherit;">Saya tidak bodoh lagi menggambar seluruh antarmuka pengguna secara manual di atas kertas, jadi ya, saya menulis alat lain - </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;">M240UITool</font></a><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Selain mengatur ulang semua sumber daya gambar dari file firmware ke BMP / PNG, alat ini dapat membuat skrip IDC di IDA untuk menentukan semua sumber daya UI.</font></font><br><br> <code>.long 0x7008080, 0x72D8080, 0x73C8080, 0x75A8080, 0x79B8080, 0x71DFF6B, 0x7BE8080, 0x7FF8080 <br> .long 0x77BBD27, 0x75B60E7, 0x7835F4A, 0x7D3089F, 0x7018080, 0x7028080, 0x7038080, 0x7048080 <br> .long 0x7058080, 0x7068080, 0x7078080, 0x7088080, 0x7098080, 0x70A8080, 0x70B8080, 0x70C8080 <br> .long 0x70D8080, 0x70E8080, 0x70F8080, 0x7108080, 0x7118080, 0x7128080, 0x7952B15, 0x7138080 <br> .long 0x7148080, 0x7158080, 0x7168080, 0x7178080, 0x7188080, 0x7198080, 0x71A8080, 0x71C8080 <br> .long 0x71D8080, 0x71E8080, 0x71F8080, 0x7338080, 0x7208080, 0x7218080, 0x7228080, 0x7238080 <br> .long 0x7248080, 0x7248080, 0x7268080, 0x7278080, 0x7288080, 0x7298080, 0x72A8080, 0x72B8080 <br> .long 0x72C8080, 0x75E8080, 0x7608080, 0x7628080, 0x7648080, 0x7678080, 0x7688080, 0x7698080 <br> .long 0x76B8080, 0x76E8080, 0x7708080, 0x7728080, 0x7758080, 0x7778080, 0x7798080, 0x77C8080 <br> .long 0x77E8080, 0x7818080, 0x7838080, 0x7868080, 0x7888080, 0x78B8080, 0x78D8080, 0x7908080 <br> .long 0x7928080, 0x7958080, 0x7978080, 0x7998080, 0x79C8080, 0x79D8080, 0x7668080, 0x79E8080 <br> .long 0x7A18080, 0x7A28080, 0x7A38080, 0x7A68080, 0x7A78080, 0x7A88080, 0x7AB8080, 0x7AC8080 <br> .long 0x7AD8080, 0x7B08080, 0x7B28080, 0x7B58080, 0x7B88080, 0x7B98080, 0x7BC8080, 0x7CC8080 <br> .long 0x7AB3BBB, 0x7E10094, 0x7E4556E, 0x4008080, 0x2922D17, 0x7B2AB00, 0x7C2A262, 0x71DFF6B <br> .long 0x768D4A2, 0x769D4EA, 0x7BD88AE, 0x705997B, 0x70BB377, 0x711CC73, 0x717E66F, 0x7238866 <br> .long 0x729A262, 0x72FBB5E, 0x735D55A, 0x7417751, 0x747914D, 0x74DAA48, 0x753C444, 0x75F663B <br> .long 0x76B9933, 0x7998080, 0x771B32F, 0x77D5526, 0x7836F22, 0x789881E, 0x78FA21A, 0x7159095 <br> .long 0x71AAA91, 0x720C38D, 0x726DD88, 0x7506F6A, 0x7568866, 0x75CA262, 0x762BB5E, 0x76E5E55 <br> .long 0x7747751, 0x77A914D, 0x780AA48, 0x78C4D3F, 0x792663B, 0x7988037, 0x79E9933, 0x7AA3C2A <br> .long 0x7B05526, 0x7B66F22, 0x7BC881E, 0x72488AE, 0x72AA1AA, 0x72FBBA6, 0x735D4A2, 0x7427799 <br> .long 0x7489095, 0x74DAA91, 0x753C38D, 0x77E556E, 0x7836F6A, 0x7898866, 0x78FA262, 0x79C4459 <br> .long 0x7A15E55, 0x7A77751, 0x7AD914D, 0x7BF4D3F, 0x7CC8080, 0x7C5663B, 0x7CB8037, 0x7337FC8 <br> .long 0x73999C4, 0x73FB2C0, 0x745CCBB, 0x7757799, 0x74C54FF, 0x77B9095, 0x780AA91, 0x7AB3C72 <br> .long 0x7B1556E, 0x7B66F6A, 0x7BC8866, 0x74277E1, 0x74890DD, 0x74EAAD9, 0x754C3D5, 0x76066CC <br> .long 0x7667FC8, 0x76C99C4, 0x772B2C0, 0x77E55B7, 0x7846EB3, 0x78A88AE, 0x790A1AA, 0x7526EFB <br> .long 0x75787F7, 0x75DA1F3, 0x763BAEE, 0x76F5DE6, 0x77577E1, 0x77B90DD, 0x781AAD9, 0x78D4CD0 <br> .long 0x79366CC, 0x79F99C4, 0x7E10094, 0x7CF44A1, 0x7DB7799, 0x7E71A90, 0x7ED338C, 0x7FF8080 <br> .long 0x7328080, 0x7DC8080, 0x7C88080, 0x7508080, 0x775CD2C, 0x76944EA, 0x7808080, 0x71A61FF <br> .long 0x7244D40, 0x7242C15, 0xFFF8080, 0xF338080, 0xF668080, 0xF998080, 0xFCC8080, 0xF008080 <br> .long 0xF4C54FF, 0xFAB3BBB, 0xFE10094, 0xFE4556E, 0xF952B15, 0xFDA7751, 0xFB2AB00, 0xFC2A262 <br> .long 0xF1DFF6B, 0xF68D4A2, 0xF69D4EA, 0xFBD88AE, 0xA922D17, 0xC6E4130, 0xE286963, 0x74C55FF <br> .long 0x768D536, 0x7FF8080, 0x7FF8080, 0x7FF8080, 0x2922D17, 0x46E4130, 0x6286963, 0x8080</code> <br> <br><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br><br> <code>Leica M (typ 240) UI Tool v1.0 <br> Usage: ./M240UITool [-a address] [-i imagebase] [-s script] [-d dump] [-f folder] [-l LUT] [-rbv] FIRMWARE.BIN <br> <br> This tool will help you to find UI resources in firmware. <br> Use following arguments: <br> -a Specify address of the gui_CopyImageDesc function (ex. 0x2F95E0) <br> -i Specify firmware imagebase <br> -s Specify IDC file name <br> -c Specify container file name <br> -d Specify dump image format <br> png - PNG format <br> bmp - BMP (ARGB) format <br> -f Specify folder for dumped images <br> -l Specify LUT for images (filename of address) <br> -b Specify number of bytes to display in verbose mode <br> -r Try to recover string characters <br> -v Be verbose</code> <br> <br><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kita sudah tahu bahwa dari fungsi yang dibuat oleh satu halaman UI, itu disebut beberapa kali </font></font><code>gui_CopyImageDesc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Saya pikir akan sangat bagus untuk membuat browser sumber daya UI dan mendefinisikan semua fitur rendering halaman. </font><font style="vertical-align: inherit;">Opsi </font></font><code>-c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ini </font><font style="vertical-align: inherit;">dimaksudkan untuk ini </font><font style="vertical-align: inherit;">- ini menciptakan wadah khusus untuk melihat sumber daya. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dan siapa yang mengatakan bahwa browser sumber daya UI mungkin tidak terlihat tidak biasa? </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/8b6/5f7/6c3/8b65f76c30a4d4a037719e805141573a.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Menjadi interaktif (tombol tembus pada tangkapan layar), alat ini memungkinkan Anda untuk tidak hanya menelusuri halaman-halaman menu EVF / LCD, tetapi juga melihat langkah-langkah rendering dalam satu halaman. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sayangnya, kode sumber untuk karya ini hilang di suatu tempat, tetapi file header masih dalam kode M240UITool, jadi secara teknis Anda dapat membuatnya dari awal.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Menu debug </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Baris apa yang kita cari terutama saat reverse engineering? Menurut saya, kata ini </font></font><code>debug</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan turunannya. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ada banyak baris menarik di firmware, tetapi ini khusus: </font><font style="vertical-align: inherit;">Tampaknya Anda dapat masuk ke mode debug menggunakan beberapa kombinasi tombol. Semua garis ini dipanggil dari satu fungsi raksasa </font><font style="vertical-align: inherit;">, yang mengimplementasikan mesin pemindaian tombol. Begini tampilannya di IDA:</font></font><br><br> <code>$ strings ./IMG_LOKI-212_1.1.0.2.bin | grep "Debug Mode" <br> GUI: State: %d! Scanning for Debug Mode successful <br> GUI: Scanning for Debug Mode: State: %d, Ignore long DEL <br> GUI: Scanning for Debug Mode: State: %d <br> GUI: Scanning for Debug Mode: State: %d, Ignore long DEL <br> GUI: Scanning for Debug Mode: State: %d <br> GUI: Scanning for Debug Mode: State: %d, Ignore long DEL <br> GUI: Scanning for Debug Mode: State: %d <br> GUI: Scanning for Debug Mode: State: %d, Ignore long DEL <br> GUI: Scanning for Debug Mode: State: %d <br> GUI: Scanning for Debug Mode: State: %d, Ignore long DEL <br> GUI: Scanning for Debug Mode: State: %d <br> ... <br> GUI: ScanningForDebugWithKeyAndJoyStick(): g_GUI_CheckForDebugWithKeyAndJoyStick = %d</code> <br> <br><font style="vertical-align: inherit;"></font><code>ScanningForDebugWithKeyAndJoyStick</code><font style="vertical-align: inherit;"></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/e9e/525/cd2/e9e525cd2bc493e7bb8cc4b3710b1334.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Saya tidak akan berbohong, butuh beberapa waktu untuk memahami bagaimana tombol perangkat keras diproses dalam firmware, dan kemudian mengembalikan jenis yang disebutkan untuk tombol dan joystick. Tetapi ketika saya mendapat kombinasinya, saya mengetahui dengan kecewa bahwa dia tidak melakukan apa-apa. Mungkin hanya bekerja dari halaman GUI tertentu. Beberapa malam lagi penelusuran manual mesin negara GUI - dan masalahnya selesai, dan kami juga berhasil menemukan halaman menu Reset. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Akhirnya, selamat datang di mode debug. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/526/74d/068/52674d068ae127cc7b90b5b1172de325.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Saya banyak berpikir apakah akan mengumumkan kombinasi ini, tetapi memutuskan untuk abstain. Saya menghargai kerja keras yang dilakukan Leica, merilis perangkat uniknya, dan saya tidak ingin bertanggung jawab atas kenyataan bahwa pusat layanan mereka akan mengisi bangkai kamera yang rusak sebagai hasil dari beberapa keingintahuan yang tidak masuk akal.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tapi tetap saja, saya akan memberikan beberapa jenis yang disebutkan untuk menyederhanakan rekayasa balik bagi mereka yang siap untuk pergi dengan cara ini. </font></font><br><br><pre> <code class="plaintext hljs">enum ControlActionType { kControlAction_Idle, // 0 kControlAction_Push, // 1 kControlAction_Release, // 2 kControlAction_LongPush // 3 }; enum ControlBtnType { kControlBtn_LV, // 0 kControlBtn_PLAY, // 1 kControlBtn_DEL, // 2 kControlBtn_ISO, // 3 kControlBtn_MENU, // 4 kControlBtn_SET // 5 }; enum ControlJoystickType { kControlJoy_INFO, // 0 kControlJoy_Up, // 1 kControlJoy_Down, // 2 kControlJoy_Left, // 3 kControlJoy_Right // 4 };</code> </pre> <br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ptp </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Berpikir tentang tugas USB, saya mendefinisikan tiga mode (yang juga dikonfirmasi dalam menu debug): </font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ptp </font></font><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MSC (Kelas Penyimpanan Massal) </font></font><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Leica custom </font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PTP paling menarik karena didokumentasikan dengan baik dan memungkinkan Anda untuk mengontrol kamera. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cukup mudah untuk menemukan penangan PTP dalam firmware, karena ada banyak panggilan dari kode ini. </font><font style="vertical-align: inherit;">Semua panggilan PTP dibagi menjadi tiga kelompok: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Legacy</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Leica Extended (LE)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Production</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pesan debug membantu membangun nama untuk hampir semua kode.</font></font><br><br><pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Warisan: Leica Extents: Produksi:                           </font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0x1001 - GetDeviceInfo 0x9001 - Tetapkan Pengaturan Kamera 0x9100 - Buka Sesi Produksi      </font></font><font></font>
0x1002 - OpenSession 0x9002 - Get Camera Settings 0x9101 - Close Production Session     <font></font>
0x1003 - CloseSession 0x9003 - Get Lens Parameter 0x9102 - UpdateFirmware               <font></font>
0x1004 - Get Storage ID 0x9004 - Release Stage 0x9103 - Open OSD Session             <font></font>
0x1005 - Get Storage Info 0x9005 - Open LE Session 0x9104 - Close OSD Session            <font></font>
0x1006 - GetNumObjects 0x9006 - Close LE Session 0x9105 - Get OSD Data                 <font></font>
0x1007 - GetObjectHandles 0x9007 - RequestObjectTransferReady 0x9106 - GetFirmwareStruct            <font></font>
0x1008 - GetObjectInfo 0x9008 - GetGeoTackingData 0x910B - GetDebugMenu                 <font></font>
0x1009 - GetObject 0x900A - Open Debug Session 0x910C - SetDebugMenu                 <font></font>
0x100A - Get Thumb 0x900B - Close Debug Session 0x910D - ODIN Message                 <font></font>
0x100B - Delete Object 0x900C - Get Debug Buffer 0x910E - GetDebugObjectHandles        <font></font>
0x100E - Initiate Capture 0x900D - Debug Command String 0x910F - GetDebugObject               <font></font>
0x1014 - GetDevicePropDesc 0x900E - Get Debug Route 0x9110 - DeleteDebugObject            <font></font>
0x1015 - GetDevicePropV 0x900F - SetIPTCData 0x9111 - GetDebugObjectInfo           <font></font>
0x101C - Initiate Open Capture 0x9010 - GetIPTCData 0x9112 - WriteDebugObject             <font></font>
                                   0x9020 - Get3DAxisData 0x9113 - CreateDebugObject            <font></font>
                                   0x9030 - OpenLiveViewSession 0x9114 - Calibrate 3Daxis             <font></font>
                                   0x9031 - CloseLiveViewSession 0x9115 - Magnetic calibration         <font></font>
                                   0x9033 - Unknown 0x9116 - Get Viewfinder Data </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implementasi antarmuka PTP itu sendiri tampaknya standar, tetapi beberapa perintah memiliki keterbatasan yang sengaja saya hilangkan di sini. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bagaimanapun, semua hal di atas cukup menarik. </font><font style="vertical-align: inherit;">Anda mungkin berpikir, "Mari kita colokkan kamera melalui USB dan mulai memeriksa dengan libptp."</font></font> Benar juga. <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sialan ... </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Leica M240 tidak memiliki port USB.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tangani port </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Leica menawarkan beberapa aksesoris untuk kamera ini, tetapi ada satu yang sangat menarik. </font><font style="vertical-align: inherit;">Kita berbicara tentang </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pegangan multi-fungsi Leica M (14495)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Ini menggantikan bagian logam bawah casing, menyediakan GPS built-in dan beberapa konektor seperti USB, terminal flash SCA, DIN / ISO-X dan soket daya. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/fab/250/1b6/fab2501b6e69cb6caf3f62528e413bdb.jpg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dan Anda berkata lagi: "Bagus, sekarang beli saja, pasangkan ke kamera, hubungkan kamera via USB dan mulailah menyelidik menggunakan libptp."</font></font> Benar juga. <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hanya sialan ... </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Harganya hampir 900 dolar. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ini hampir sembilan ratus alasan untuk membuat adaptor Anda sendiri. </font><font style="vertical-align: inherit;">Namun, untuk berjaga-jaga, saya mengatur pemberitahuan eBay untuk aksesori ini.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Konektor </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konektor pada kamera adalah sebagai berikut: </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/a29/4f0/388/a294f0388ad2c5ac3d355d0838e01586.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Saya mencoba menemukannya di Internet, tetapi serius, bagaimana Anda menggambarkannya di Google? </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dengan sedikit putus asa, saya mulai memikirkan beberapa hal gila, seperti menempelkan kertas timah atau jarum ke penghapus karet. Tapi begitu bekerja di Blackmagic Design, melihat papan sirkuit kamera, saya perhatikan bahwa salah satu konektor memiliki bentuk yang sangat akrab. Hari berikutnya saya membawa Leica M240 saya ke kantor - dan ya, tampilannya mirip, hanya jauh lebih lama dengan banyak pembalut. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tetap menanyakan nomor komponen manajer komponen kami, dan kemudian menemukannya di katalog </font></font><b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Samtec</font></font></a></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font><b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;">ERM8-013-05.0-L-DV-TR</font></a></b><font style="vertical-align: inherit;"> . </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/a60/dc3/d36/a60dc3d36d12216f74690577507fc6db.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kami juga bertanya kepada Samtec apakah mungkin untuk mendapatkan sampel, dan mereka setuju.</font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/dda/752/0d6/dda7520d6691fc48f3f1aaa026e49635.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sedikit kerja dengan besi solder, kardus, dan pita listrik - dan steker saya sudah siap (sampel tahun 2013). </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/ddd/243/fe5/ddd243fe596648709c3f9dccb76f15ea.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lima tahun kemudian, pada tahun 2018, saya memutuskan untuk secara pribadi meminta Samtec untuk mengirim sampel lain. </font><font style="vertical-align: inherit;">Saya ingin melakukan sesuatu yang lebih baik. </font></font><br><br> <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ERCD-013-05.00-TTR-TTR-1-D</font></font></a></b> <br><img src="https://habrastorage.org/getpro/habr/post_images/e1a/56a/995/e1a56a9958b1dda50aca34f0ecac8863.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Sekali lagi, banyak pekerjaan dengan besi solder, bersumpah, memotong kawat, bersumpah, lagi bekerja dengan besi solder untuk membuat opsi baru yang lebih menarik:</font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/1a5/b78/10d/1a5b7810d3a2ccea73bf4e2d75cad8cd.png"><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pinout </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ada 26 kontak di konektor: 13 di setiap sisi. Bahkan sebelum menyolder bagian saya, saya memeriksa konektor kamera dengan multimeter dan penganalisis logika. Ngomong-ngomong, Anda perlu meletakkan magnet pada sensor penutup bawah sehingga kamera menganggap bahwa penutup sudah terpasang. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bumi (kamera mati, tidak ada baterai)</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Saya selalu mulai dari tanah karena aman dan sangat mudah ditemukan. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/ead/140/15c/ead14015c97177d6717e198616c9114b.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dengan demikian, kami memiliki delapan garis tanah (abu-abu gelap). </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Potensi (kamera aktif)</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Saat kamera aktif, Anda dapat mengukur potensi di setiap pin dan mendapatkan gagasan tentang tingkat logika dan daya. </font></font><br><br> <a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">alexhude.github.io/assets/2019/2019-01-24-hacking-leica-m240/probe2_potential.png</font></font></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Performa pada pin 8-9 dan 11-13 terlalu tinggi untuk pin logika, jadi saya mendefinisikannya sebagai power (merah). </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resistansi (kamera mati, tidak ada baterai)</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ini berguna untuk mengukur resistansi. Dalam beberapa kasus, ini membantu mengidentifikasi input dan mengelompokkan beberapa baris. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/fa7/fde/1a6/fa7fde1a623a5f13d264a5127a3083d2.png"><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Output yang terhubung (kamera dimatikan, tidak ada baterai)</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Kemudian saya memutuskan untuk memeriksa semua bantalan eksternal pada bodi kamera untuk memeriksa apakah mereka terhubung ke port layanan. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/f75/61e/c06/f7561ec060796fa8e39a15d533e3de03.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kontak sinkronisasi flash langsung terhubung ke saluran 10. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Penganalisis logika (kamera dihidupkan)</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Data untuk setiap saluran direkam dalam urutan berikut: aktifkan, kamera harus dalam mode LV, ambil gambar, mulai merekam video.</font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/494/33c/27c/49433c27cf94be5cb9430e4ba518560c.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dua baris menunjukkan transmisi beberapa data: 01 dan 21. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">01</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - 115200, transmisi 8 bit, 1 stop bit, parity bit, LSB pertama. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/bf7/3a2/fdf/bf73a2fdfbbfeab571c354f2a6d50c9b.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Setiap 500 ms, ia mengirimkan penghitung </font></font><code>C3 3C 02 81 00 01 00 82, C3 3C 02 81 01 01 00 83, C3 3C 02 81 02 01 00 80</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">... </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">21</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - 115200, transmisi 8 bit, 1 stop bit, tidak ada bit parity check, LSB pertama. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/f00/423/2dd/f004232dd3f1b8c8f0e665fd63f3fa9b.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ini mengirimkan log bootloader ke SH7216 ("Leica Camera AG" pada gambar di atas). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mari kita tandai mereka biru tua. Sangat menyedihkan bahwa log Maestro tidak keluar bahkan dengan pengaturan debug maksimum di menu Debug. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/c44/541/bb9/c44541bb98c4388f151bdc3faffa1dfe.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pada kontak ini, resistansi sekitar 310kOhm.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Saya tidak tahu mengapa, tetapi saya menyarankan bahwa jalur data lain mungkin memiliki resistensi yang sama atau akan ditutup. Oleh karena itu, saya mendefinisikan garis ~ 300kOhm, ~ 200kOhm, dan ~ 100kOhm sebagai garis data (nuansa biru pada gambar). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Secara umum, gambar berikut ini diambil. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/e7e/31f/f2c/e7e31ff2cc7da6ae304652488ca9db4c.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">12 kandidat di jalur data. Tapi bagaimana cara memeriksanya? Setelah percakapan singkat dengan para ahli besi tentang perlindungan listrik dari sirkuit terpadu, saya mulai menyodok kontak melalui resistor 4kOhm, yang mengurangi arus ke tingkat yang tidak boleh terbakar oleh input.</font></font><br><br><h4>  UART </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Saya membuat asumsi lain bahwa garis RX harus dekat TX. </font><font style="vertical-align: inherit;">Baris 02, 03, dan 20 terlihat seperti kandidat yang baik karena keduanya memiliki tegangan 3,3 V seperti TX. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Awalnya, saya mencoba menjelajahi jalur ini menggunakan Bus Pirate. </font><font style="vertical-align: inherit;">Sayangnya, hasilnya agak kotor. </font><font style="vertical-align: inherit;">Kemudian saya mengambil kabel berbasis SiLabs sebagai lebih dapat diandalkan dan tidak bertentangan pada macOS. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pertama, saya menghubungkan kabel TX ke pin 20 dan mulai mengetik </font></font><code>help</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">setelah bootloader. </font><font style="vertical-align: inherit;">Seperti yang diharapkan, setelah jeda singkat, kamera mengulangi karakter. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/a16/445/c00/a16445c00b6a22a6b37b74c97fc97ca5.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kontak 02 dan 03 adalah kandidat berikutnya untuk UART. </font><font style="vertical-align: inherit;">Sayangnya, tidak ada tanda-tanda bahwa garis-garis ini disadap. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dalam diagram, UART yang terkenal ditunjukkan oleh warna hijau yang lebih gelap.</font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/733/f68/fa1/733f68fa1950518017ad2c09971ac1f8.png"><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> USB </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semuanya dimulai dengan memotong kabel USB menjadi dua dengan header di tengah dan resistor 4kOhm untuk penginderaan. </font><font style="vertical-align: inherit;">Sinyal integritas pasangan diferensial? </font><font style="vertical-align: inherit;">Tidak, maka saya tidak terlalu peduli.</font></font> :) <br><br><img src="https://habrastorage.org/getpro/habr/post_images/891/930/5d3/8919305d35cd2525d420313c2b0e7555.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kemudian saya memeriksa beberapa perangkat rumah USB di rumah untuk mendapatkan gambaran tentang bagaimana komunikasi pada port ini. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Canon </font></font></b> <br><img src="https://habrastorage.org/getpro/habr/post_images/c49/f85/cf8/c49f85cf89650352531c83c970eb609c.png"><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Camera Blackmagic Pocket </font></font></b> <br><img src="https://habrastorage.org/getpro/habr/post_images/8b7/7e5/bc8/8b77e5bc8c2fa3387083a8e8ec12c3db.png"><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Camcorder Canon </font></font></b> <br><img src="https://habrastorage.org/getpro/habr/post_images/17f/dd4/67a/17fdd467a6627a4129f38d6e476d4ffc.png"><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Camcorder JVC Camcorder </font></font></b> <br><img src="https://habrastorage.org/getpro/habr/post_images/757/80d/4c8/75780d4c8a85c55c04afe5de9209e09d.png"><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Keychain </font></font></b> <br><img src="https://habrastorage.org/getpro/habr/post_images/ad9/3a6/382/ad93a63828797eaea1f5d906367b792f.png"><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">KidiZoom Camera</font></font></b> <br><img src="https://habrastorage.org/getpro/habr/post_images/32e/d73/13a/32ed7313a12ef1cef1444a87c22f3c77.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Mereka semua sedikit berbeda, tetapi keadaan awal D-D + rendah. </font><font style="vertical-align: inherit;">Yah, kita akan tahu, dan sekarang kita akan memeriksa bahwa kita memiliki:</font></font><br><br><ul><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">22</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - tidak mungkin, karena D-D + adalah pasangan diferensial dan harus cukup dekat;</font></font><br></li><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">04/05</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - tidak mungkin karena mereka memiliki resistensi yang berbeda;</font></font><br></li><li> <b>14/15</b> ‚Äî ,      ; <br></li><li> <b>15/16</b> ‚Äî ,        . </li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jadi saya menghubungkan USB D-D + ke pin 15/16 dan menghubungkannya ke iMac ... </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/777/491/b7f/777491b7f4a3b4b0f8376931db78c6c8.jpg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pada layar USB PTP, tetapi kamera tidak muncul di host. Saya mencoba mengkonfigurasi berbagai opsi pada tata letak sirkuit elektronik, tetapi tidak ada yang berhasil. Beagle menunjukkan banyak paket yang rusak dan kesalahan lainnya. Pada akhirnya, saya menyerah dan kembali untuk merekayasa balik firmware. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ini adalah pinout terakhir, USB ditandai dengan warna hijau tua. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/2ad/07d/289/2ad07d289a684e6db69a02ae9e50c294.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Siapa yang menyangka bahwa beberapa tahun kemudian pemberitahuan eBay yang sama akan datang kepada saya dan saya akan dengan murah membeli aksesori yang diinginkan. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Akhirnya, saya bisa menguji asumsi saya tentang PTP. Tapi pada awalnya itu sangat penasaran bagaimana USB PHY terlihat di dalam gadget. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/afe/0b1/afc/afe0b1afc09953f7f9c6dbc451c47c56.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Di dalamnya ada hub </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SMSC 2512b</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tepat di jalan dari gagang jack ke konektor Mini USB. Chip bekerja dalam mode default karena tidak ada pin EEPROM atau SCL / SDA. Port hilir pertama diarahkan ke soket pada bodi kamera, tetapi yang kedua tidak terhubung ke apa pun. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Saya mungkin melewatkan sesuatu, tetapi bagi saya solusi seperti itu tidak masuk akal. Paspor teknis mengatakan bahwa chip tersebut memiliki "pin USB terintegrasi penuh, serta resistor untuk menaikkan dan menurunkan tegangan." Mungkin para insinyur Leica memutuskan untuk tidak mengimplementasikan USB PHY mereka sendiri, tetapi menggunakan yang ada di hub, yang telah teruji dengan baik dan berhasil di luar kotak. Sebenarnya, saya tidak bisa menyalahkan mereka, karena sebelum saya mencoba melakukan ini, dan itu ternyata menjadi tugas yang sulit. Mungkin ini adalah fitur untuk perlindungan terhadap penipuan, siapa tahu.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Bagaimanapun, jika Anda mengerti USB PHY dan siap membantu, jangan ragu untuk menulis kepada saya: seharusnya dapat bekerja melalui port USB tanpa aksesori bermerek ini :) </font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> PTP lagi </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Seperti yang saya katakan, saatnya bermain-main dengan ekstensi Leica PTP. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Untungnya, saya menemukan pustaka C ++ yang cukup keren daripada libptp - ini </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libEasyPTP</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Juga tidak butuh banyak waktu untuk menulis alat berdasarkan pustaka ini: Saya sudah tahu beberapa batasan dalam antarmuka Leica PTP. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dan meskipun M240PTPTool cukup bermasalah, ia cukup cocok untuk peran pembuktian konsep ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kode program</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hanya dua permintaan melalui PTP: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetDebugBuffer (0x900C)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DebugCommandString (0x900D)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">By the way, agar modul untuk mengisi log debug, Anda perlu mengatur Level Debug sebagai "Debug" atau "Debug RAW" di menu. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ada beberapa opsi di antarmuka M240PTPTool:</font></font><br><br><ul><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">keluar</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - tutup alat;</font></font><br></li><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">flush</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - gabungkan buffer debug dari kamera:</font></font></li></ul><br> <code>M240&gt; flush <br> I:[00:11:468]|01| DATE/TIME CORRECTED by 5921 sec <br> D:[00:12:079]|00| Send message from TID 0 to TID 1 over MBX 3 - length: 4 - MesgID: 0x22020103 <br> D:[00:12:179]|00| Send message from TID 0 to TID 1 over MBX 3 - length: 4 - MesgID: 0x22020103 <br> D:[00:12:282]|11| Message received from TID 0 for TID 1 over MBX 3 <br> D:[00:12:283]|11| Message received from TID 0 for TID 1 over MBX 3 <br> D:[00:12:301]|00| Send message from TID 0 to TID 1 over MBX 3 - length: 4 - MesgID: 0x22020103 <br> D:[00:12:402]|00| Send message from TID 0 to TID 1 over MBX 3 - length: 4 - MesgID: 0x22020103 <br> D:[00:12:502]|00| Send message from TID 0 to TID 1 over MBX 3 - length: 4 - MesgID: 0x22020103 <br> ...</code> <br> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Teks lain dikirim ke kamera sebagai perintah debugging. </font><font style="vertical-align: inherit;">Misalnya, ini </font></font><code>help</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">menampilkan semua perintah yang mungkin dengan argumen: Daftar </font><font style="vertical-align: inherit;">lengkapnya cukup besar, tetapi lihat, Anda dapat mengirim pesan langsung ke Softune untuk tugas apa pun! </font><font style="vertical-align: inherit;">Apa yang akan sangat menarik untuk dikirim ke sana ... </font><font style="vertical-align: inherit;">Baris populer lain yang sering dicari dalam firmware adalah </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Mari kita lihat apakah kita punya satu. </font><font style="vertical-align: inherit;">Tampaknya, Anda dapat membuang firmware ke kartu SD. </font><font style="vertical-align: inherit;">Menggunakan tautan ke baris "Membuang file ke kartu", mudah untuk menemukan kode yang bertanggung jawab untuk ini. </font><font style="vertical-align: inherit;">Itu terletak di blok Sistem Tugas raksasa (pid 11, seperti yang kita sudah tahu) dan dipanggil oleh pesan </font><font style="vertical-align: inherit;">tanpa argumen. </font><font style="vertical-align: inherit;">Dial </font><font style="vertical-align: inherit;">di </font><b><font style="vertical-align: inherit;">M240PTPTool</font></b><font style="vertical-align: inherit;"> , tekan Enter dan melihat layar.</font></font><br><br> <code>M240&gt; help <br> ********* debug command description ******** <br> <br> exposure request <br> Description: requests a release from Sub CPU <br> Parameter 1: Exposure Time TV <br> <br> still request <br> Description: simulates the -still request- command flow of Sub CPU <br> Parameter: no <br> <br> ... <br> <br> send Message;[Parameter1];[Parameter2];[Parameter2];...;... <br> Description: Sending Message to Task <br> Parameter 1: Receiver Task ID <br> Parameter 2: Command ID <br> Parameter 3: Command Data[0] (32 Bit) <br> Parameter 4: Command Data[1] (32 Bit) <br> Parameter 5: . <br> Parameter 6: . <br> use maximum 10 Parameter <br> <br> ...</code> <br> <br><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><code>dump</code><font style="vertical-align: inherit;"></font><br><br> <code>$ strings IMG_LOKI-212_1.1.0.2.bin | rg -i dump <br> GUI: HEX DUMP: Address: %x, Length: %d <br> HSK: DBG_WRITE_ROM_DUMP_SD: File was properly opened, but it seems to be empty. <br> ROM_DUMP <br> HSK: DBG_WRITE_ROM_DUMP_SD: Flushing Dump to ROM. Size %d <br> SD:\ROM_DUMP.bin <br> HSK: DBG_WRITE_ROM_DUMP_SD Command received! <br> ROM_DUMP.bin <br> HSK: DUMP failed, no cards inserted! <br> HSK: DUMP FlashROM to SD card. <br> HSK: DUMP FlashROM to CF card. <br> Dumping files to card</code> <br> <br><font style="vertical-align: inherit;"></font><code>0x11080006</code><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><code>send Message;11;0x11080006</code><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/4de/1cc/e2e/4de1cce2e0ee47a67645df790a7e581c.jpg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kemudian lepaskan kartu SD dan periksa apa yang ada di dalamnya. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/209/2a8/25e/2092a825e23cb93c4845b416ea11b0e4.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ini dia, dump lengkap, termasuk firmware. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ini membuka kemungkinan yang tak terbatas. </font><font style="vertical-align: inherit;">Misalnya, Anda dapat membuat perangkat kecil dengan MCU, dukungan untuk host USB dan tombol untuk meluncurkan urutan pesan yang kompleks ... </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dan kemudian kami memiliki anak kedua.</font></font> :) <br><br><h1>  Epilog </h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jika Anda tidak ingin merusak perangkat, biasanya ada cara untuk memeriksanya tanpa membuka kasing atau menyolder kabel ke papan sirkuit. </font><font style="vertical-align: inherit;">Di bawah ini tips saya jika Anda tertarik:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">temukan semua informasi publik tentang perangkat: spesifikasi teknis, data komponen, foto bagian dalam, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">video dari pabrik</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;)</font></font><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> jika Anda memiliki firmware, selidiki dan cari tip tentang output eksternal; </font></font><br></li><li>        ,     ; <br></li><li>  GND//    ,  ; <br></li><li>     ; <br></li><li>     ,   ; <br></li><li>   ,     (, ); <br></li><li>        ,    Google   (USB/UART/SPI/I2C/1Wire); <br></li><li>      ,      ; <br></li><li>  <s></s>  ,      ; <br></li><li>  ,    . </li></ul><br><img src="https://habrastorage.org/getpro/habr/post_images/18b/006/166/18b006166a4070202c1be3a9b946c3e9.png"><br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">github.com/alexhude</a> <br><br> <b>  !</b> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id438168/">https://habr.com/ru/post/id438168/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id438152/index.html">"Saya dapat memberi tahu Anda tentang rasa sakit yang dimiliki setiap pengembang iOS di pantat" - 10 pertanyaan kepada pengembang, episode 2</a></li>
<li><a href="../id438158/index.html">Pialang data AS menjual data lokasi tanpa persetujuan pengguna - pekerjaan mereka akan diatur</a></li>
<li><a href="../id438162/index.html">The tuple dari orang yang sehat</a></li>
<li><a href="../id438164/index.html">Genetika dan ayam: protein CSF1-Fc manusia dalam protein telur</a></li>
<li><a href="../id438166/index.html">Interaksi antara situs di browser dan program yang berjalan secara lokal</a></li>
<li><a href="../id438170/index.html">Hadiah dinamai menurut Ilya Segalovich. Kisah tentang Ilmu Komputer dan Peluncuran Publikasi</a></li>
<li><a href="../id438172/index.html">Apple tidak dapat memindahkan produksi perangkatnya ke AS</a></li>
<li><a href="../id438174/index.html">Kuning - Vakum - Cloud</a></li>
<li><a href="../id438176/index.html">Ikhtisar IPSec di Mikrotik</a></li>
<li><a href="../id438178/index.html">Membuat aplikasi ARCore pertama Anda</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>