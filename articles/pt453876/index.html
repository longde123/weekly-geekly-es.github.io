<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèæ‚Äçüéì üë©‚Äçüë©‚Äçüëß ü•ú Como no Yandex.Practicum, o front-end desync venceu: um n√∫mero acrob√°tico com Redux-Saga, postMessage e Jupyter ‚ú® üåí ü§Ø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Meu nome √© Artyom Nesmiyanov, sou desenvolvedor full-stack da Yandex.Practicum, lido principalmente com o frontend. Acreditamos que √© poss√≠vel e neces...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como no Yandex.Practicum, o front-end desync venceu: um n√∫mero acrob√°tico com Redux-Saga, postMessage e Jupyter</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/453876/">  Meu nome √© Artyom Nesmiyanov, sou desenvolvedor full-stack da Yandex.Practicum, lido principalmente com o frontend.  Acreditamos que √© poss√≠vel e necess√°rio estudar programa√ß√£o, an√°lise de dados e outras atividades digitais com prazer.  E comece a aprender e continue.  Qualquer desenvolvedor que n√£o tenha desistido de si mesmo est√° sempre "continuando".  N√≥s tamb√©m.  Portanto, percebemos as tarefas de trabalho como um formato de aprendizado.  E um dos mais recentes ajudou a mim e aos caras a entender melhor em que dire√ß√£o desenvolver nossa pilha de front-end. <br><br><img src="https://habrastorage.org/webt/u2/uh/nx/u2uhnxzsc0hv3v7clkqskbzwnc0.png"><br><br><h3>  De quem e de que √© feito o Workshop </h3><br>  Nossa equipe de desenvolvimento √© extremamente compacta.  Existem apenas duas pessoas no back-end, quatro no front-end, considerando-me uma pilha cheia.  De tempos em tempos, os caras do Yandex.Tutorial se juntam a n√≥s no refor√ßo.  Trabalhamos no Scrum com sprints de duas semanas. <br><a name="habracut"></a><br>  Nosso front-end √© baseado no React.js em conjunto com o Redux / Redux-Saga, usamos o Express para se comunicar com o back-end.  A parte de back-end da pilha est√° em Python (mais precisamente, Django), o banco de dados √© PostgreSQL e, para algumas tarefas, Redis.  Usando o Redux, armazenamos armazenamentos de informa√ß√µes, enviamos a√ß√µes que s√£o processadas pelo Redux e pelo Redux-Saga.  Todos os efeitos colaterais, como solicita√ß√µes de servidor, chamadas para Yandex.Metrica e redirecionamentos, s√£o processados ‚Äã‚Äãapenas no Redux-Saga.  E todas as modifica√ß√µes de dados ocorrem nos redutores Redux. <br><br><h3>  Como n√£o ignorar um log no seu iframe </h3><br>  Agora, em nossa plataforma, o treinamento est√° aberto em tr√™s profiss√µes: desenvolvedor front-end, desenvolvedor web, analista de dados.  E estamos vendo ferramentas ativamente para cada curso. <br><br>  No curso de seis meses " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Data Analyst</a> ", fizemos um simulador interativo, onde ensinamos aos usu√°rios <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">como usar o Jupyter Notebook</a> .  Este √© um shell legal para computa√ß√£o interativa, que √© amado com raz√£o pelos cientistas de dados.  Todas as opera√ß√µes no ambiente s√£o realizadas dentro do notebook, mas de maneira simples - um notebook (como chamarei mais adiante). <br><br>  As solicita√ß√µes de experi√™ncia e temos certeza: √© importante que as tarefas de treinamento sejam quase reais.  Incluindo em termos de ambiente de trabalho.  Portanto, era necess√°rio garantir que, dentro da li√ß√£o, todo o c√≥digo pudesse ser escrito, executado e verificado diretamente no caderno. <br><br>  Com a implementa√ß√£o b√°sica das dificuldades n√£o surgiram.  O caderno em si foi colocado em um iframe separado, a l√≥gica para chec√°-lo foi prescrita no back-end. <br><br><img src="https://habrastorage.org/webt/2z/_9/iy/2z_9iyuj7pmha0ielvj4evuyhic.png"><br>  <i>O bloco de anota√ß√µes do aluno (√† direita) √© apenas um iframe cuja URL leva a um bloco de anota√ß√µes espec√≠fico no JupyterHub.</i> <br><br>  Numa primeira aproxima√ß√£o, tudo funcionou sem problemas, sem problemas.  No entanto, durante os testes, surgiram absurdos.  Por exemplo, voc√™ tem a garantia de conduzir a vers√£o correta do c√≥digo em um notebook; no entanto, depois de clicar no bot√£o "Tarefa de teste", o servidor responde que a resposta est√° supostamente incorreta.  E por que - um mist√©rio. <br><br>  Bem, o que est√° acontecendo, percebemos no mesmo dia em que encontramos um bug: descobriu-se que a solu√ß√£o que n√£o estava voando era a atual, a solu√ß√£o que acabou de ser inserida no formul√°rio Notebook Jupyter, mas a anterior j√° estava apagada.  O notebook em si n√£o teve tempo de sobreviver e diminu√≠mos a velocidade do back-end para que ele verificasse a tarefa nele.  O que, √© claro, ele n√£o poderia fazer. <br><br>  Tivemos que nos livrar do rassinhron entre salvar o notebook e enviar uma solicita√ß√£o ao servidor para verific√°-lo.  O problema era que era necess√°rio fazer com que o iframe do notebook se comunicasse com a janela principal, ou seja, com o frontend no qual a li√ß√£o como um todo estava girando.  Obviamente, era imposs√≠vel encaminhar qualquer evento diretamente entre eles: eles vivem em dom√≠nios diferentes. <br><br>  Procurando uma solu√ß√£o, descobri que o Jupyter Notebook permite que seus plugins sejam conectados.  H√° um objeto J√∫piter - um notebook - com o qual voc√™ pode operar.  Trabalhar com ele envolve eventos, incluindo a preserva√ß√£o do notebook, bem como a chamada da a√ß√£o apropriada.  Tendo descoberto o interior do Jupyter (eu precisava: n√£o existe documenta√ß√£o normal para ele), os caras e eu fizemos - criamos nosso pr√≥prio plug-in para ele e, usando o mecanismo postMessage, conseguimos o trabalho coordenado dos elementos dos quais a li√ß√£o do Workshop foi montada. <br><br>  Elaboramos uma solu√ß√£o alternativa, levando em considera√ß√£o o fato de que nossa pilha inclui inicialmente o j√° mencionado Redux-Saga - para simplificar, o middleware sobre o Redux, o que torna poss√≠vel trabalhar de forma mais flex√≠vel com efeitos colaterais.  Por exemplo, salvar um notebook √© algo como esse efeito colateral.  Enviamos algo para o back-end, esperamos por algo, obtemos algo.  Todo esse movimento √© processado dentro do Redux-Saga: lan√ßa os eventos para o front-end, ditando a ele como exibir o que na interface do usu√°rio. <br><br>  Qual √© o resultado?  O PostMessage √© criado e enviado para o iframe com um notebook.  Quando um iframe v√™ que algo veio de fora, analisa a string recebida.  Percebendo que ele precisa manter o notebook, ele executa essa a√ß√£o e, por sua vez, envia uma resposta postMessage sobre a execu√ß√£o da solicita√ß√£o. <br><br>  Quando clicamos no bot√£o "Verificar tarefa", o evento correspondente √© enviado para a Redux Store: "Assim e assim, fomos verificados".  Redux-Saga v√™ a a√ß√£o chegar e postMessage em um iframe.  Agora ela est√° esperando o iframe dar uma resposta.  Enquanto isso, nosso aluno v√™ o indicador de download no bot√£o "Verificar a tarefa" e entende que o simulador n√£o trava, mas "pensa".  E somente quando o postMessage volta dizendo que o salvamento est√° completo, o Redux-Saga continua trabalhando e envia uma solicita√ß√£o ao back-end.  No servidor, a tarefa √© verificada - a solu√ß√£o certa ou n√£o, se erros s√£o cometidos, qual, etc., e essas informa√ß√µes s√£o armazenadas ordenadamente no Redux Store.  E a partir da√≠, o script de front-end o puxa para a interface da li√ß√£o. <br><br>  Aqui est√° o circuito resultante: <br><br><img src="https://habrastorage.org/webt/ks/gc/eu/ksgceup6hokoh9jtvqoajegbjfc.png"><br><br>  <i>(1) Pressionamos o bot√£o "Verificar tarefa" (Verificar) ‚Üí (2) Enviamos a a√ß√£o CHECK_NOTEBOOK_REQUEST ‚Üí (3) Enviamos a a√ß√£o da verifica√ß√£o ‚Üí (2) Enviamos a a√ß√£o SAVE_NOTEBOOK_REQUEST ‚Üí (3) Captamos a a√ß√£o e enviamos postMessage no iframe ‚Üí salvar evento (4) Receber mensagem ‚Üí (5) Notebook √© salvo ‚Üí (4) Receber evento da API do Jupyter em que o notebook foi salvo e enviar postMessage salvo no notebook ‚Üí (1) Receber evento ‚Üí (2) Enviar a√ß√£o SAVE_NOTEBOOK_SUCCESS ‚Üí (3) Capturamos a a√ß√£o e envie uma solicita√ß√£o para verificar o notebook ‚Üí (6) ‚Üí (7) Verifique se este notebook est√° no banco de dados ‚Üí (8) ‚Üí (7) Acesse o c√≥digo do notebook ‚Üí (5) Retorne o c√≥digo ‚Üí (7) Execute a verifica√ß√£o do c√≥digo ‚Üí (9) ) ‚Üí (7) Recebemos um corte</i>  <i>verifica√ß√£o tat ‚Üí (6) ‚Üí (3) enviamos a√ß√£o CHECK_NOTEBOOK_SUCCESS ‚Üí (2) para baixo para verificar a resposta do lado ‚Üí (1) Desenhe resultado</i> <br><br>  Vamos ver como tudo isso funciona no contexto do c√≥digo. <br><br>  Temos no front-end trainer_type_jupyter.jsx - o script da p√°gina em que nosso caderno √© desenhado. <br><br><pre><code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">className</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"trainer__right-column"</span></span></span><span class="hljs-tag">&gt;</span></span> {notebookLinkIsLoading ? ( <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">iframe</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">className</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"trainer__jupiter-frame"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ref</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">{this.onIframeRef}</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">{notebookLink}</span></span></span><span class="hljs-tag"> /&gt;</span></span> ) : ( <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Spin</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">size</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"l"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">mix</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"trainer__jupiter-spin"</span></span></span><span class="hljs-tag"> /&gt;</span></span> )} <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Depois de clicar no bot√£o "Verificar trabalho", o m√©todo handleCheckTasks √© chamado. <br><br><pre> <code class="xml hljs">handleCheckTasks = () =&gt; { const {checkNotebook, lesson} = this.props; checkNotebook({id: lesson.id, iframe: this.iframeRef}); };</code> </pre> <br>  De fato, handleCheckTasks serve para invocar a a√ß√£o Redux com os par√¢metros passados. <br><br><pre> <code class="xml hljs">export const checkNotebook = getAsyncActionsFactory(CHECK_NOTEBOOK).request;</code> </pre> <br>  Essa √© uma a√ß√£o comum projetada para Redux-Saga e m√©todos ass√≠ncronos.  Aqui, getAsyncActionsFactory gera tr√™s a√ß√µes: <br><br>  // utils / help-store / async.js <br><br><pre> <code class="xml hljs">export function getAsyncActionsFactory(type) { const ASYNC_CONSTANTS = getAsyncConstants(type); return { request: payload =&gt; ({type: ASYNC_CONSTANTS.REQUEST, payload}), error: (response, request) =&gt; ({type: ASYNC_CONSTANTS.ERROR, response, request}), success: (response, request) =&gt; ({type: ASYNC_CONSTANTS.SUCCESS, response, request}), } }</code> </pre> <br>  Assim, getAsyncConstants gera tr√™s constantes no formato * _REQUEST, * _SUCCESS e * _ERROR. <br><br>  Agora vamos ver como nossa Redux-Saga lidar√° com toda essa economia: <br><br>  // trainer.saga.js <br><br><pre> <code class="xml hljs">function* watchCheckNotebook() { const watcher = createAsyncActionSagaWatcher({ type: CHECK_NOTEBOOK, apiMethod: Api.checkNotebook, preprocessRequestGenerator: function* ({id, iframe}) { yield put(trainerActions.saveNotebook({iframe})); yield take(getAsyncConstants(SAVE_NOTEBOOK).SUCCESS); return {id}; }, successHandlerGenerator: function* ({response}) { const {completed_tests: completedTests} = response; for (let id of completedTests) { yield put(trainerActions.setTaskSolved(id)); } }, errorHandlerGenerator: function* ({response: error}) { yield put(appActions.setNetworkError(error)); } }); yield watcher(); }</code> </pre> <br>  A magia?  Nada de extraordin√°rio.  Como voc√™ pode ver, createAsyncActionSagaWatcher simplesmente cria um marcador de √°gua que pode pr√©-processar os dados que entram na a√ß√£o, fazer uma solicita√ß√£o em um URL espec√≠fico, despachar a a√ß√£o * _REQUEST e despachar * _SUCCESS e * _ERROR ap√≥s uma resposta bem-sucedida do servidor.  Al√©m disso, √© claro, para cada op√ß√£o, os manipuladores s√£o fornecidos dentro do rel√≥gio. <br><br>  Voc√™ provavelmente percebeu que no pr√©-processador de dados chamamos outro Redux-Saga, espere at√© que termine com SUCCESS e s√≥ ent√£o continue trabalhando.  E, √© claro, os iframes n√£o precisam ser enviados ao servidor, portanto, apenas fornecemos o ID. <br><br>  D√™ uma olhada na fun√ß√£o saveNotebook: <br><br><pre> <code class="xml hljs">function* saveNotebook({payload: {iframe}}) { iframe.contentWindow.postMessage(JSON.stringify({ type: 'save-notebook' }), '*'); yield; }</code> </pre> <br>  Atingimos o mecanismo mais importante na intera√ß√£o de iframes com o frontend - postMessage.  O fragmento de c√≥digo fornecido envia uma a√ß√£o com o tipo save-notebook, que √© processado dentro do iframe. <br><br>  Eu j√° mencionei que precis√°vamos escrever um plug-in para o Jupyter Notebook, que seria carregado dentro do notebook.  Esses plugins s√£o mais ou menos assim: <br><br><pre> <code class="xml hljs">define([ 'base/js/namespace', 'base/js/events' ], function( Jupyter, events ) {...});</code> </pre><br>  Para criar essas extens√µes, voc√™ deve lidar com a pr√≥pria API do Jupyter Notebook.  Infelizmente, n√£o h√° documenta√ß√£o clara sobre isso.  Mas os <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">c√≥digos-fonte</a> est√£o dispon√≠veis e eu os examinei.  √â bom que o c√≥digo seja leg√≠vel l√°. <br><br>  O plugin deve ser ensinado a se comunicar com a janela principal na frente da li√ß√£o: afinal, a dessincroniza√ß√£o entre eles √© a causa do erro na verifica√ß√£o da tarefa.  Antes de tudo, assinamos todas as mensagens que recebemos: <br><br><pre> <code class="xml hljs">window.addEventListener('message', actionListener);</code> </pre> <br>  Agora iremos fornecer o seu processamento: <br><br><pre> <code class="xml hljs">function actionListener({data: eventString}) { let event = ''; try { event = JSON.parse(eventString); } catch(e) { return; } switch (event.type) { case 'save-notebook': Jupyter.actions.call('jupyter-notebook:save-notebook'); Break; ... default: break; } }</code> </pre> <br>  Todos os eventos que n√£o se encaixam no nosso formato s√£o ignorados. <br><br>  Vemos que o evento save-notebook chega at√© n√≥s e chamamos a a√ß√£o para salvar o notebook.  Resta apenas enviar uma mensagem de que o notebook foi preservado: <br><br><pre> <code class="xml hljs">events.on('notebook_saved.Notebook', actionDispatcher); function actionDispatcher(event) { switch (event.type) { case 'select': const selectedCell = Jupyter.notebook.get_selected_cell(); dispatchEvent({ type: event.type, data: {taskId: getCellTaskId(selectedCell)} }); return; case 'notebook_saved': default: dispatchEvent({type: event.type}); } } function dispatchEvent(event) { return window.parent.postMessage( typeof event === 'string' ? event : JSON.stringify(event), '*' ); }</code> </pre><br>  Em outras palavras, basta enviar {type: 'notebook_saved'} para cima.  Isso significa que o notebook foi preservado. <br><br>  Vamos voltar ao nosso componente: <br><br>  //trainer_type_jupyter.jsx <br><br><pre> <code class="xml hljs">componentDidMount() { const {getNotebookLink, lesson} = this.props; getNotebookLink({id: lesson.id}); window.addEventListener('message', this.handleWindowMessage); }</code> </pre> <br>  Ao montar o componente, solicitamos ao servidor um link para o notebook e assinamos todas as a√ß√µes que podem ser executadas para n√≥s: <br><br><pre> <code class="xml hljs">handleWindowMessage = ({data: eventString}) =&gt; { const {activeTaskId, history, match: {params}, setNotebookSaved, tasks} = this.props; let event = null; try { event = JSON.parse(eventString); } catch(e) { return; } const {type, data} = event; switch (type) { case 'app_initialized': this.selectTaskCell({taskId: activeTaskId}) return; case 'notebook_saved': setNotebookSaved(); return; case 'select': { const taskId = data &amp;&amp; data.taskId; if (!taskId) { return } const task = tasks.find(({id}) =&gt; taskId === id); if (task &amp;&amp; task.status === TASK_STATUSES.DISABLED) { this.selectTaskCell({taskId: null}) return; } history.push(reversePath(urls.trainerTask, {...params, taskId})); return; } default: break; } };</code> </pre> <br>  √â aqui que o envio de a√ß√£o setNotebookSaved √© chamado, o que permitir√° ao Redux-Saga continuar trabalhando e salvando o notebook. <br><br><h3>  Falhas de escolha </h3><br>  Lidamos com o bug de preserva√ß√£o do notebook.  E imediatamente mudou para um novo problema.  Era necess√°rio aprender a bloquear tarefas (tarefas), √†s quais o aluno ainda n√£o havia alcan√ßado.  Em outras palavras, era necess√°rio sincronizar a navega√ß√£o entre nosso simulador interativo e o Jupyter Notebook: em uma li√ß√£o, t√≠nhamos um caderno com v√°rias tarefas no iframe, cujas transi√ß√µes precisavam ser coordenadas com as altera√ß√µes na interface da li√ß√£o como um todo.  Por exemplo, para que, ao clicar na segunda tarefa na interface da li√ß√£o no bloco de notas, ocorra a mudan√ßa para a c√©lula correspondente √† segunda tarefa.  E vice-versa: se no quadro do Jupyter Notebook voc√™ selecionar uma c√©lula vinculada √† terceira tarefa, o URL na barra de endere√ßos do navegador deve mudar imediatamente e, consequentemente, o texto que acompanha a teoria da terceira tarefa deve ser exibido na interface da li√ß√£o. <br><br>  Houve uma tarefa mais dif√≠cil.  O fato √© que nosso programa de treinamento foi desenvolvido para a passagem consistente de li√ß√µes e tarefas.  Enquanto isso, por padr√£o, no bloco de anota√ß√µes de J√∫piter, nada impede que o usu√°rio abra qualquer c√©lula.  E no nosso caso, cada c√©lula √© uma tarefa separada.  Acabou que voc√™ pode resolver a primeira e a terceira tarefas e pular a segunda.  O risco de aprova√ß√£o n√£o linear da li√ß√£o teve que ser eliminado. <br><br>  A solu√ß√£o foi baseada no mesmo postMessage.  Somente tivemos que nos aprofundar na API do Jupyter Notebook, mais especificamente, no que o pr√≥prio objeto Jupiter pode fazer.  E crie um mecanismo para verificar a qual tarefa a c√©lula est√° conectada.  Na sua forma mais geral, √© o seguinte.  Na estrutura do notebook, as c√©lulas v√£o seq√ºencialmente uma ap√≥s a outra.  Eles podem ter metadados.  O campo "Tags" √© fornecido nos metadados, e tags s√£o apenas identificadores de tarefas dentro da li√ß√£o.  Al√©m disso, usando c√©lulas de marca√ß√£o, voc√™ pode determinar se elas devem ser bloqueadas pelo aluno at√© o momento.  Como resultado, de acordo com o modelo atual do simulador, clicando na c√©lula, come√ßamos a enviar postMessage do iframe para o front-end, que, por sua vez, vai para o Redux Store e verifica, com base nas propriedades da tarefa, se ele est√° dispon√≠vel para n√≥s agora.  Se indispon√≠vel, mudamos para a c√©lula ativa anterior. <br><br>  Portanto, conclu√≠mos que √© imposs√≠vel selecionar uma c√©lula em um notebook que n√£o deva ser acess√≠vel pela linha do tempo do treinamento.  √â verdade que isso deu origem a um erro acr√≠tico, mas cr√≠tico: voc√™ tenta clicar em uma c√©lula com uma tarefa inacess√≠vel e ela pisca rapidamente: fica claro que foi ativada por um momento, mas foi imediatamente bloqueada.  Embora n√£o tenhamos eliminado essa aspereza, ela n√£o interfere nas li√ß√µes, mas, em segundo plano, continuamos a pensar em como lidar com isso (a prop√≥sito, h√° algum pensamento?). <br><br>  Um pouco sobre como modificamos nosso front-end para resolver o problema.  Vamos voltar a trainer_type_jupyter.jsx novamente - focaremos em app_initialized e selecionaremos. <br><br>  Com app_initialized, tudo √© elementar: o notebook foi carregado e queremos fazer alguma coisa.  Por exemplo, selecione a c√©lula atual, dependendo da tarefa selecionada.  O plug-in √© descrito para que voc√™ possa passar taskId e alternar para a primeira c√©lula correspondente a este taskId. <br><br>  Ou seja: <br><br>  // trainer_type_jupyter.jsx <br><br><pre> <code class="xml hljs">selectTaskCell = ({taskId}) =&gt; { const {selectCell} = this.props; if (!this.iframeRef) { return; } selectCell({iframe: this.iframeRef, taskId}); };</code> </pre> <br>  // trainer.actions.js <br><br><pre> <code class="xml hljs">export const selectCell = ({iframe, taskId}) =&gt; ({ type: SELECT_CELL, iframe, taskId });</code> </pre> <br>  // trainer.saga.js <br><br><pre> <code class="xml hljs">function* selectCell({iframe, taskId}) { iframe.contentWindow.postMessage(JSON.stringify({ type: 'select-cell', data: {taskId} }), '*'); yield; } function* watchSelectCell() { yield takeEvery(SELECT_CELL, selectCell); }</code> </pre> <br>  // custom.js (plugin do Jupyter) <br><br><pre> <code class="xml hljs">function getCellTaskId(cell) { const notebook = Jupyter.notebook; while (cell) { const tags = cell.metadata.tags; const taskId = tags &amp;&amp; tags[0]; if (taskId) { return taskId; } cell = notebook.get_prev_cell(cell); } return null; } function selectCell({taskId}) { const notebook = Jupyter.notebook; const selectedCell = notebook.get_selected_cell(); if (!taskId) { selectedCell.unselect(); return; } if (selectedCell &amp;&amp; selectedCell.selected &amp;&amp; getCellTaskId(selectedCell) === taskId) { return; } const index = notebook.get_cells() .findIndex(cell =&gt; getCellTaskId(cell) === taskId); if (index <span class="hljs-tag"><span class="hljs-tag">&lt; </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span><span class="hljs-tag">) { </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">return</span></span></span><span class="hljs-tag">; } </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">notebook.select</span></span></span><span class="hljs-tag">(</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">index</span></span></span><span class="hljs-tag">); </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">const</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">cell</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">notebook.get_cell(index);</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">cell.element</span></span></span><span class="hljs-tag">[</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span><span class="hljs-tag">]</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.scrollIntoView</span></span></span><span class="hljs-tag">({ </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">behavior:</span></span></span><span class="hljs-tag"> '</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">smooth</span></span></span><span class="hljs-tag">', </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">block:</span></span></span><span class="hljs-tag"> '</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">start</span></span></span><span class="hljs-tag">' }); } </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">function</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">actionListener</span></span></span><span class="hljs-tag">({</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data:</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">eventString</span></span></span><span class="hljs-tag">}) { </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">...</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">case</span></span></span><span class="hljs-tag"> '</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">select-cell</span></span></span><span class="hljs-tag">'</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">selectCell</span></span></span><span class="hljs-tag">(</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">event.data</span></span></span><span class="hljs-tag">); </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">break</span></span></span><span class="hljs-tag">;</span></span></code> </pre> <br>  Agora voc√™ pode trocar de c√©lula e aprender com o iframe que a c√©lula foi trocada. <br><br>  Ao alternar a c√©lula, alteramos a URL e ca√≠mos em outra tarefa.  Resta apenas fazer o oposto - ao escolher outra tarefa na interface, alterne a c√©lula.  F√°cil: <br><br><pre> <code class="xml hljs">componentDidUpdate({match: {params: {prevTaskId}}) { const {match: {params: {taskId}}} = this.props; if (taskId !== prevTaskId) { this.selectTaskCell({taskId});</code> </pre> <br><h3>  Caldeira separada para perfeccionistas </h3><br>  Seria legal nos gabarmos de como estamos bem.  A solu√ß√£o na linha inferior √© eficaz, embora pare√ßa um pouco confusa: se resumirmos, temos um m√©todo que processa qualquer mensagem vinda de fora (no nosso caso, de um iframe).  Mas no sistema que constru√≠mos, h√° coisas que eu e meus colegas n√£o gostamos muito. <br><br>  ‚Ä¢ N√£o h√° flexibilidade na intera√ß√£o dos elementos: sempre que desejamos adicionar novas funcionalidades, teremos que alterar o plug-in para suportar o antigo e o novo formato de comunica√ß√£o.  N√£o existe um √∫nico mecanismo isolado para trabalhar entre o iframe e nosso componente front-end, que renderiza o Jupyter Notebook na interface da li√ß√£o e trabalha com nossas tarefas.  Globalmente - h√° um desejo de tornar um sistema mais flex√≠vel para que no futuro seja f√°cil adicionar novas a√ß√µes, eventos e process√°-los.  E no caso n√£o apenas do notebook J√∫piter, mas tamb√©m de qualquer iframe nos simuladores.  Ent√£o, estamos procurando passar o c√≥digo do plug-in atrav√©s do postMessage e renderiz√°-lo (eval) dentro do plug-in. <br><br>  ‚Ä¢ Fragmentos de c√≥digo que resolvem problemas est√£o espalhados por todo o projeto.  A comunica√ß√£o com iframes √© realizada tanto no Redux-Saga quanto no componente, o que certamente n√£o √© o ideal. <br><br>  ‚Ä¢ O iframe em si com a renderiza√ß√£o do Jupyter Notebook est√° em outro servi√ßo.  A edi√ß√£o √© um pouco problem√°tica, especialmente em conformidade com o princ√≠pio de compatibilidade com vers√µes anteriores.  Por exemplo, se queremos mudar algum tipo de l√≥gica no front-end e no pr√≥prio notebook, temos que fazer um trabalho duplo. <br><br>  Muitos gostariam de implementar mais facilmente.  Tome pelo menos reagir.  Ele possui v√°rios m√©todos de ciclo de vida e cada um deles precisa ser processado.  Al√©m disso, estou confuso com a liga√ß√£o com o React.  Idealmente, eu gostaria de poder trabalhar com nossos iframes, independentemente da sua estrutura front-end.  Em geral, a interse√ß√£o das tecnologias que escolhemos imp√µe limita√ß√µes: o mesmo Redux-Saga espera que as a√ß√µes do Redux sejam nossas, e n√£o p√≥s-mensagem. <br><br>  Portanto, definitivamente n√£o vamos parar no que foi alcan√ßado.  Um dilema do livro did√°tico: voc√™ pode ir para o lado da beleza, mas sacrificar a otimiza√ß√£o do desempenho ou vice-versa.  Ainda n√£o encontramos a melhor solu√ß√£o. <br><br>  Talvez as id√©ias surjam com voc√™? </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt453876/">https://habr.com/ru/post/pt453876/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt453866/index.html">Solicita√ß√£o de API com ganchos de rea√ß√£o, HOC ou prop de renderiza√ß√£o</a></li>
<li><a href="../pt453868/index.html">Mini interruptor sens√≠vel ao toque com painel de vidro no nRF52832</a></li>
<li><a href="../pt453870/index.html">Escrevemos o proxy reverso socks5 no PowerShell.</a></li>
<li><a href="../pt453872/index.html">Restaurando fotos usando redes neurais</a></li>
<li><a href="../pt453874/index.html">Da roleta russa ao LOTO seguro: como proteger o pessoal do data center</a></li>
<li><a href="../pt453882/index.html">Um √≥timo guia sobre a profiss√£o de arquiteto de solu√ß√µes (+ lista de links √∫teis)</a></li>
<li><a href="../pt453884/index.html">Substitui√ß√£o da c√¢mera HYIP ou DSLR?</a></li>
<li><a href="../pt453886/index.html">Trabalhos do programa</a></li>
<li><a href="../pt453888/index.html">Aprendizado de m√°quina em alta velocidade: manuten√ß√£o preditiva de quatro meses</a></li>
<li><a href="../pt453890/index.html">Sonhos sovi√©ticos do futuro</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>