<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèæ‚Äçüíº üë®üèº‚Äçüè´ ü§æ Los conceptos b√°sicos de proxy transparente usando 3proxy e iptables / netfilter o c√≥mo "dejar que todo pase por un proxy" üëâ üÜï üë©üèΩ‚Äç‚úàÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En este art√≠culo, me gustar√≠a revelar las posibilidades de proxy transparente, que le permite redirigir todo o parte del tr√°fico a trav√©s de servidore...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Los conceptos b√°sicos de proxy transparente usando 3proxy e iptables / netfilter o c√≥mo "dejar que todo pase por un proxy"</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/460469/"> En este art√≠culo, me gustar√≠a revelar las posibilidades de proxy transparente, que le permite redirigir todo o parte del tr√°fico a trav√©s de servidores proxy externos de manera absolutamente imperceptible. <br><br>  Cuando comenc√© a resolver este problema, me enfrent√© al hecho de que su implementaci√≥n tiene un problema importante: el protocolo HTTPS.  En los viejos tiempos, no hab√≠a problemas especiales con el proxy HTTP transparente, pero al proxy HTTPS, los navegadores informan interferencia con el protocolo, y ah√≠ es donde termina la felicidad. <br><br>  En instrucciones comunes para el servidor proxy, Squid incluso ofrece generar su propio certificado e instalarlo para los clientes, lo cual es <s>completamente absurdo</s> al menos irracional y parece un ataque MITM.  S√© que Squid ya puede hacer algo como esto, pero este art√≠culo trata sobre una forma comprobada y de trabajo usando 3proxy del respetado 3APA3A. <br><br>  A continuaci√≥n, consideraremos en detalle el proceso de creaci√≥n de 3proxy desde el origen, su configuraci√≥n, proxy completo y selectivo utilizando NAT, distribuci√≥n de canales a varios servidores proxy externos, as√≠ como el uso de un enrutador y rutas est√°ticas.  Utilizamos Debian 9 x64 como sistema operativo.  ¬°Empecemos! <br><a name="habracut"></a><br><h3>  Instale 3proxy e inicie un servidor proxy normal </h3><br>  1. Instale ifconfig (desde el paquete net-tools) <br> <code>apt-get install net-tools</code> <br>  2. Instalar Midnigth Commander <br> <code>apt-get install mc</code> <br>  3. Ahora tenemos 2 interfaces: <br>  enp0s3 - externo, busca en Internet <br>  enp0s8 - interno, debe buscar en una red de √°rea local <br>  En otras distribuciones basadas en Debian, las interfaces generalmente se denominan eth0 y eth1. <br> <code>ifconfig -a</code> <br> <br><div class="spoiler">  <b class="spoiler_title">Interfaces</b> <div class="spoiler_text">  enp0s3: flags = 4163 &lt;UP, BROADCAST, RUNNING, MULTICAST&gt; mtu 1500 <br>  inet 192.168.23.11 netmask 255.255.255.0 broadcast 192.168.23.255 <br>  inet6 fe80 :: a00: 27ff: fec2: bae4 prefixlen 64 scopeid 0x20 ether 08: 00: 27: c2: ba: e4 txqueuelen 1000 (Ethernet) <br>  Paquetes RX 6412 bytes 8676619 (8.2 MiB) <br>  Errores RX 0 ca√≠dos 0 desbordamientos 0 fotograma 0 <br>  Paquetes TX 1726 bytes 289128 (282.3 KiB) <br>  Errores de TX 0 ca√≠dos 0 desbordamientos 0 transportista 0 colisiones 0 <br><br>  enp0s8: flags = 4098 &lt;TRANSMISI√ìN, MULTICAST&gt; mtu 1500 <br>  √©ter 08: 00: 27: 79: a7: e3 txqueuelen 1000 (Ethernet) <br>  Paquetes RX 0 bytes 0 (0.0 B) <br>  Errores RX 0 ca√≠dos 0 desbordamientos 0 fotograma 0 <br>  Paquetes TX 0 bytes 0 (0.0 B) <br>  Errores de TX 0 ca√≠dos 0 desbordamientos 0 transportista 0 colisiones 0 <br><br>  lo: flags = 73 &lt;ARRIBA, LOOPBACK, RUNNING&gt; mtu 65536 <br>  inet 127.0.0.1 m√°scara de red 255.0.0.0 <br>  inet6 :: 1 prefixlen 128 scopeid 0x10 loop txqueuelen 1 (Loopback local) <br>  Paquetes RX 0 bytes 0 (0.0 B) <br>  Errores RX 0 ca√≠dos 0 desbordamientos 0 fotograma 0 <br>  Paquetes TX 0 bytes 0 (0.0 B) <br>  Errores de TX 0 ca√≠dos 0 desbordamientos 0 transportista 0 colisiones 0 <br><br>  La interfaz enp0s8 no se usa actualmente, la habilitaremos cuando queramos usar la configuraci√≥n NAT Proxy o NAT.  Entonces es l√≥gico asignarle una ip est√°tica. <br><br>  4. Proceda a instalar 3proxy <br><br>  4.1 Instalaci√≥n de paquetes b√°sicos para compilar 3proxy desde la fuente <br><br> <code>root@debian9:~# apt-get install build-essential libevent-dev libssl-dev -y</code> <br> <br>  4.2.  Crea una carpeta para descargar el archivo con la fuente <br><br> <code>root@debian9:~# mkdir -p /opt/proxy</code> <br> <br>  4.3.  Vamos a esta carpeta <br><br> <code>root@debian9:~# cd /opt/proxy <br></code> <br><br>  4.4.  Ahora descargue el √∫ltimo paquete 3proxy.  Al momento de escribir, la √∫ltima versi√≥n estable era 0.8.12 (18/04/2018) Desc√°rguela del sitio web oficial de 3proxy <br><br> <code>root@debian9:/opt/proxy# wget https://github.com/z3APA3A/3proxy/archive/0.8.12.tar.gz <br></code> <br><br>  4.5.  Descomprima el archivo descargado <br><br> <code>root@debian9:/opt/proxy# tar zxvf 0.8.12.tar.gz</code> <br> <br>  4.6.  Vaya al directorio desempaquetado para compilar el programa. <br><br> <code>root@debian9:/opt/proxy# cd 3proxy-0.8.12</code> <br> <br>  4.7.  A continuaci√≥n, debe agregar una l√≠nea al archivo de encabezado para que nuestro servidor sea completamente an√≥nimo (realmente funciona, todo est√° verificado, los clientes ip est√°n ocultos) <br><br> <code>root@debian9:/opt/proxy/3proxy-0.8.12# nano +29 src/proxy.h</code> <br> <br>  Agregar una l√≠nea <br><br> <code>#define ANONYMOUS 1 <br></code> <br>  Presione Ctrl + xy Enter para guardar los cambios. <br><br>  4.8.  Vamos a construir el programa <br><br> <code>root@debian9:/opt/proxy/3proxy-0.8.12# make -f Makefile.Linux</code> <br> <br><div class="spoiler">  <b class="spoiler_title">Makelog</b> <div class="spoiler_text">  make [2]: Saliendo del directorio '/opt/proxy/3proxy-0.8.12/src/plugins/TransparentPlugin' <br>  make [1]: Saliendo del directorio '/opt/proxy/3proxy-0.8.12/src' <br></div></div><br>  Sin errores, contin√∫e. <br><br>  4.9.  Instala el programa en el sistema <br><br> <code>root@debian9:/opt/proxy/3proxy-0.8.12# make -f Makefile.Linux install</code> <br> <br>  4.10.  Vaya al directorio ra√≠z y verifique d√≥nde est√° instalado el programa. <br><br> <code>root@debian9:/opt/proxy/3proxy-0.8.12# cd ~/ <br> root@debian9:~# whereis 3proxy</code> <br>  3proxy: / usr / local / bin / 3proxy / usr / local / etc / 3proxy <br><br>  4.11.  Cree una carpeta para archivos de configuraci√≥n y registros en el directorio de inicio del usuario <br><br> <code>root@debian9:~# mkdir -p /home/joke/proxy/logs</code> <br> <br>  4.12.  Vaya al directorio donde deber√≠a estar la configuraci√≥n <br><br> <code>root@debian9:~# cd /home/joke/proxy/</code> <br> <br>  4.13.  Cree un archivo vac√≠o y copie la configuraci√≥n all√≠ <br><br> <code>root@debian9:/home/joke/proxy# cat &gt; 3proxy.conf</code> <br> <br><div class="spoiler">  <b class="spoiler_title">3proxy.conf</b> <div class="spoiler_text">  demonio <br>  pidfile /home/joke/proxy/3proxy.pid <br>  nserver 8.8.8.8 <br>  nscache 65536 <br>  probador de usuarios: CL: 1234 <br>  tiempos de espera 1 5 30 60180 1800 16 60 <br>  log /home/joke/proxy/logs/3proxy.log D <br>  logformat "- + _L% t.%.% N.% p% E% U% C:% c% R:% r% O% I% h% T" <br>  rotar 3 <br>  auth fuerte <br>  rubor <br>  permitir probador <br>  calcetines -p3128 <br>  proxy -p8080 <br></div></div><br>  Para guardar, presione Ctrl + Z <br><br>  4.14.  Cree un archivo pid para que no haya errores al inicio. <br><br> <code>root@debian9:/home/joke/proxy# cat &gt; 3proxy.pid</code> <br> <br>  Para guardar, presione Ctrl + Z <br><br>  4.15.  ¬°Lanza un servidor proxy! <br><br> <code>root@debian9:/home/joke/proxy# 3proxy /home/joke/proxy/3proxy.conf</code> <br> <br>  4.16.  Veamos si el servidor est√° escuchando en los puertos <br><br> <code>root@debian9:~/home/joke/proxy# netstat -nlp</code> <br> <br><div class="spoiler">  <b class="spoiler_title">registro de netstat</b> <div class="spoiler_text">  Conexiones activas a Internet (solo servidores) <br>  Proto Recv-Q Send-Q Direcci√≥n local Direcci√≥n extranjera Estado PID / Nombre del programa <br>  tcp 0 0 0.0.0.0:8080 0.0.0.0:* ESCUCHE 504 / 3proxy <br>  tcp 0 0 0.0.0.0:22 0.0.0.0:* ESCUCHAR 338 / sshd <br>  tcp 0 0 0.0.0.0lla128 0.0.0.0:* ESCUCHE 504 / 3proxy <br>  tcp6 0 0 ::: 22 ::: * ESCUCHAR 338 / sshd <br>  udp 0 0 0.0.0.0:68 0.0.0.0:* 352 / dhclient <br></div></div><br>  Como estaba escrito en la configuraci√≥n, el proxy web escucha el puerto 8080, y el proxy Socks5 escucha 3128. <br><br>  4.17.  Para iniciar el servicio proxy despu√©s de reiniciar, agr√©guelo a cron. <br><br> <code>root@debian9:/home/joke/proxy# crontab -e</code> <br> <br>  Agregar una l√≠nea <br><br> <code>@reboot /usr/local/bin/3proxy /home/joke/proxy/3proxy.conf</code> <br> <br>  Presione Entrar, ya que cron deber√≠a ver el car√°cter de fin de l√≠nea y guardar el archivo. <br><br>  Deber√≠a haber un mensaje sobre la instalaci√≥n de un nuevo crontab. <br><br>  crontab: instalaci√≥n de nuevo crontab <br><br>  4.18.  Reiniciaremos el sistema e intentaremos conectarnos a trav√©s del navegador al proxy.  Para la verificaci√≥n, utilizamos el navegador Firefox (para proxy web) y el complemento FoxyProxy para socks5 con autenticaci√≥n. <br><br> <code>root@debian9:/home/joke/proxy# reboot</code> <br> <br>  4.19.  Despu√©s de verificar el proxy despu√©s de reiniciar, puede ver los registros.  Esto completa la configuraci√≥n del proxy. <br><br><div class="spoiler">  <b class="spoiler_title">3 registro de proxy</b> <div class="spoiler_text">  1542573996.018 PROXY.8080 00000 probador 192.168.23.10:50915 217.12.15.54ced43 1193 6939 0 CONNECT_ads.yahoo.com:443_HTTP/1.1 <br>  1542574289.634 SOCK5.3128 00000 probador 192.168.23.10/101193 54.192.13.69:443 0 0 0 CONNECT_normandy.cdn.mozilla.net:443 <br></div></div><br><h3>  Configure y ejecute la configuraci√≥n NAT de proxy transparente </h3><br>  En esta configuraci√≥n, todos los dispositivos en la red interna funcionar√°n de manera transparente en Internet a trav√©s de un servidor proxy remoto.  Absolutamente todas las conexiones tcp ser√°n redirigidas a uno o varios servidores proxy (¬°realmente ampliando el ancho del canal, ejemplo de configuraci√≥n No. 2!).  DNS utilizar√° las capacidades de 3proxy (dnspr).  UDP no saldr√° porque todav√≠a no usamos el mecanismo de reenv√≠o (deshabilitado de forma predeterminada en el kernel de Linux). <br><br>  1. Es hora de habilitar la interfaz enp0s8 <br><br> <code>root@debian9:~# nano /etc/network/interfaces</code> <br> <br><div class="spoiler">  <b class="spoiler_title">archivo / etc / network / interfaces</b> <div class="spoiler_text">  # Este archivo describe las interfaces de red disponibles en su sistema <br>  # y c√≥mo activarlos.  Para obtener m√°s informaci√≥n, consulte las interfaces (5). <br><br>  fuente /etc/network/interfaces.d/* <br><br>  # La interfaz de red de bucle invertido <br>  auto lo <br>  iface lo inet loopback <br><br>  # La interfaz de red primaria <br>  allow-hotplug enp0s3 <br>  iface enp0s3 inet dhcp <br><br>  # La interfaz de red secundaria <br>  allow-hotplug enp0s8 <br>  iface enp0s8 inet est√°tico <br>  direcci√≥n 192.168.201.254 <br>  m√°scara de red 255.255.255.0 <br></div></div><br>  Aqu√≠ asignamos la direcci√≥n est√°tica 192.168.201.254 y la m√°scara 255.255.255.0 a la interfaz enp0s8 <br>  Guarde la configuraci√≥n Ctrl + X y reinicie <br><br> <code>root@debian9:~# reboot</code> <br> <br>  2. Comprobando las interfaces <br><br> <code>root@debian9:~# ifconfig</code> <br> <br><div class="spoiler">  <b class="spoiler_title">registro de ifconfig</b> <div class="spoiler_text">  enp0s3: flags = 4163 &lt;UP, BROADCAST, RUNNING, MULTICAST&gt; mtu 1500 <br>  inet 192.168.23.11 netmask 255.255.255.0 broadcast 192.168.23.255 <br>  inet6 fe80 :: a00: 27ff: fec2: bae4 prefixlen 64 scopeid 0x20 ether 08: 00: 27: c2: ba: e4 txqueuelen 1000 (Ethernet) <br>  Paquetes RX 61 bytes 7873 (7.6 KiB) <br>  Errores RX 0 ca√≠dos 0 desbordamientos 0 fotograma 0 <br>  Paquetes TX 65 bytes 10917 (10.6 KiB) <br>  Errores de TX 0 ca√≠dos 0 desbordamientos 0 transportista 0 colisiones 0 <br><br>  enp0s8: flags = 4163 &lt;UP, BROADCAST, RUNNING, MULTICAST&gt; mtu 1500 <br>  inet 192.168.201.254 netmask 255.255.255.0 broadcast 192.168.201.255 <br>  inet6 fe80 :: a00: 27ff: fe79: a7e3 prefixlen 64 scopeid 0x20 ether 08: 00: 27: 79: a7: e3 txqueuelen 1000 (Ethernet) <br>  Paquetes RX 0 bytes 0 (0.0 B) <br>  Errores RX 0 ca√≠dos 0 desbordamientos 0 fotograma 0 <br>  Paquetes TX 8 bytes 648 (648.0 B) <br>  Errores de TX 0 ca√≠dos 0 desbordamientos 0 transportista 0 colisiones 0 <br><br>  lo: flags = 73 &lt;ARRIBA, LOOPBACK, RUNNING&gt; mtu 65536 <br>  inet 127.0.0.1 m√°scara de red 255.0.0.0 <br>  inet6 :: 1 prefixlen 128 scopeid 0x10 loop txqueuelen 1 (Loopback local) <br>  Paquetes RX 0 bytes 0 (0.0 B) <br>  Errores RX 0 ca√≠dos 0 desbordamientos 0 fotograma 0 <br>  Paquetes TX 0 bytes 0 (0.0 B) <br>  Errores de TX 0 ca√≠dos 0 desbordamientos 0 transportista 0 colisiones 0 <br><br>  3. Todo result√≥, ahora necesita configurar 3proxy para proxy transparente. <br><br> <code>root@debian9:~# cd /home/joke/proxy/ <br> root@debian9:/home/joke/proxy# cat &gt; 3proxytransp.conf</code> <br> <br><div class="spoiler">  <b class="spoiler_title">Ejemplo de configuraci√≥n del servidor proxy transparente # 1</b> <div class="spoiler_text">  demonio <br>  pidfile /home/joke/proxy/3proxy.pid <br>  nserver 8.8.8.8 <br>  nscache 65536 <br>  tiempos de espera 1 5 30 60180 1800 16 60 <br>  log /home/joke/proxy/logs/3proxy.log D <br>  logformat "- + _L% t.%.% N.% p% E% U% C:% c% R:% r% O% I% h% T" <br>  rotar 3 <br>  rubor <br>  autenticaci√≥n iponly <br>  dnspr <br>  permitir * <br>  padre 1000 calcetines5 IP_EXTERNAL_PROXY 3128 probador 1234 <br>  plugin /opt/proxy/3proxy-0.8.12/src/TransparentPlugin.ld.so transparent_plugin <br>  tcppm -i0.0.0.0 888 127.0.0.1 11111 <br></div></div><br>  4. Ahora ejecute 3proxy con la nueva configuraci√≥n <br> <code>root@debian9:/home/joke/proxy# /usr/local/bin/3proxy /home/joke/proxy/3proxytransp.conf</code> <br> <br>  5. Agregue crontab nuevamente <br> <code>root@debian9:/home/joke/proxy# crontab -e <br> @reboot /usr/local/bin/3proxy /home/joke/proxy/3proxytransp.conf</code> <br> <br>  6. Veamos qu√© est√° escuchando nuestro proxy ahora <br> <code>root@debian9:~# netstat -nlp <br></code> <br><br><div class="spoiler">  <b class="spoiler_title">registro de netstat</b> <div class="spoiler_text">  Conexiones activas a Internet (solo servidores) <br>  Proto Recv-Q Send-Q Direcci√≥n local Direcci√≥n extranjera Estado PID / Nombre del programa <br>  tcp 0 0 0.0.0.0:22 0.0.0.0:* ESCUCHE 349 / sshd <br>  tcp 0 0 0.0.0.0:888 0.0.0.0:* ESCUCHE 354 / 3proxy <br>  tcp6 0 0 ::: 22 ::: * ESCUCHE 349 / sshd <br>  udp 0 0 0.0.0.0:53 0.0.0.0:* 354 / 3proxy <br>  udp 0 0 0.0.0.0:68 0.0.0.0:* 367 / dhclient <br></div></div><br>  7. Ahora el proxy est√° listo para aceptar cualquier conexi√≥n TCP en el puerto 888, DNS en el puerto 53, para que luego pueda ser redirigido a los calcetines remotos5: proxy de Google y DNS 8.8.8.8.  Nos queda por configurar las reglas netfilter (iptables) y DHCP para emitir direcciones. <br><br>  8. Instale el paquete iptables-persistent y dhcpd <br><br> <code>root@debian9:~# apt-get install iptables-persistent isc-dhcp-server</code> <br> <br>  9. Edite el archivo de inicio dhcpd <br> <code>root@debian9:~# nano /etc/dhcp/dhcpd.conf</code> <br> <br><div class="spoiler">  <b class="spoiler_title">dhcpd.conf</b> <div class="spoiler_text">  # dhcpd.conf <br>  # # <br>  # Archivo de configuraci√≥n de muestra para ISC dhcpd <br>  # # <br><br>  # definiciones de opciones comunes a todas las redes compatibles ... <br>  opci√≥n nombre-dominio "ejemplo.org"; <br>  opci√≥n de servidores de nombres de dominio ns1.example.org, ns2.example.org; <br><br>  tiempo de arrendamiento predeterminado 600; <br>  max-lease-time 7200; <br><br>  ddns-update-style none; <br><br>  # Si este servidor DHCP es el servidor DHCP oficial para el local <br>  # network, la directiva autorizada no debe ser comentada. <br><br>  autoritario; <br><br>  # Una configuraci√≥n ligeramente diferente para una subred interna. <br>  subred 192.168.201.0 m√°scara de red 255.255.255.0 { <br>  rango 192.168.201.10 192.168.201.250; <br>  opci√≥n de servidores de nombres de dominio 192.168.201.254; <br>  enrutadores opcionales 192.168.201.254; <br>  opci√≥n broadcast-address 192.168.201.255; <br>  tiempo de arrendamiento predeterminado 600; <br>  max-lease-time 7200; <br>  } <br></div></div><br>  11. Reinicie y verifique el servicio en el puerto 67 <br> <code>root@debian9:~# reboot <br> root@debian9:~# netstat -nlp</code> <br> <br><div class="spoiler">  <b class="spoiler_title">registro de netstat</b> <div class="spoiler_text">  Conexiones activas a Internet (solo servidores) <br>  Proto Recv-Q Send-Q Direcci√≥n local Direcci√≥n extranjera Estado PID / Nombre del programa <br>  tcp 0 0 0.0.0.0:22 0.0.0.0:* ESCUCHE 389 / sshd <br>  tcp 0 0 0.0.0.0:888 0.0.0.0:* ESCUCHE 310 / 3proxy <br>  tcp6 0 0 ::: 22 ::: * ESCUCHE 389 / sshd <br>  udp 0 0 0.0.0.0:20364 0.0.0.0:* 393 / dhcpd <br>  udp 0 0 0.0.0.0:53 0.0.0.0:* 310 / 3proxy <br>  udp 0 0 0.0.0.0:67 0.0.0.0:* 393 / dhcpd <br>  udp 0 0 0.0.0.0:68 0.0.0.0:* 405 / dhclient <br>  udp6 0 0 ::: 31728 ::: * 393 / dhcpd <br>  sin procesar 0 0 0.0.0.0:1 0.0.0.0:* 393 / dhcpd <br><br></div></div><br>  12. Queda por redirigir todas las solicitudes de TCP al puerto 888 y guardar la regla en iptables <br><br> <code>root@debian9:~# iptables -t nat -A PREROUTING -s 192.168.201.0/24 -p tcp -j REDIRECT --to-ports 888</code> <br> <br> <code>root@debian9:~# iptables-save &gt; /etc/iptables/rules.v4</code> <br> <br>  13. Para expandir el ancho de banda del canal, puede usar varios servidores proxy.  La cantidad total debe ser 1000. Se establecen nuevas conexiones con una probabilidad de 0.2, 0.2, 0.2, 0.2, 0.1, 0.1 a los servidores proxy especificados. <br><br>  Nota: si tenemos un proxy web, entonces en lugar de socks5 necesita escribir connect, si socks4, luego socks4 (socks4 ¬°NO APOYA LA AUTORIZACI√ìN DE INICIO DE SESI√ìN / CONTRASE√ëA!) <br><br><div class="spoiler">  <b class="spoiler_title">Ejemplo de configuraci√≥n del servidor proxy transparente # 2</b> <div class="spoiler_text">  demonio <br>  pidfile /home/joke/proxy/3proxy.pid <br>  nserver 8.8.8.8 <br>  nscache 65536 <br>  maxconn 500 <br>  tiempos de espera 1 5 30 60180 1800 16 60 <br>  log /home/joke/proxy/logs/3proxy.log D <br>  logformat "- + _L% t.%.% N.% p% E% U% C:% c% R:% r% O% I% h% T" <br>  rotar 3 <br>  rubor <br>  autenticaci√≥n iponly <br>  dnspr <br>  permitir * <br><br>  padre 200 calcetines5 IP_EXT_EXT_PROXY # 1 3128 probador 1234 <br>  padre 200 calcetines5 IP_EXT_EXT_PROXY # 2 3128 probador 1234 <br>  padre 200 calcetines5 IP_EXT_EXT_PROXY # 3 3128 probador 1234 <br>  padre 200 calcetines5 IP_EXT_EXT_PROXY # 4 3128 probador 1234 <br>  padre 100 calcetines5 IP_EXT_EXT_PROXY # 5 3128 probador 1234 <br>  padre 100 calcetines5 IP_EXT_EXT_PROXY # 6 3128 probador 1234 <br><br>  plugin /opt/proxy/3proxy-0.8.12/src/TransparentPlugin.ld.so transparent_plugin <br>  tcppm -i0.0.0.0 888 127.0.0.1 11111 <br></div></div><br><h3>  Configurar y ejecutar la configuraci√≥n de proxy transparente NAT + </h3><br>  En esta configuraci√≥n, utilizaremos el mecanismo NAT habitual con representaci√≥n selectiva o transparente total de direcciones o subredes individuales.  Los usuarios de la red interna trabajar√°n con ciertos servicios / subredes sin siquiera darse cuenta de que funcionan a trav√©s de un proxy.  Todas las conexiones https funcionan bien, no es necesario generar / reemplazar certificados. <br><br>  Primero, decidimos qu√© subredes / servicios queremos proxy.  Supongamos que los servidores proxy externos se encuentran donde se est√° ejecutando un servicio como pandora.com.  Ahora queda por determinar su subred / direcci√≥n. <br><br>  1. Ping <br><br> <code>root@debian9:~# ping pandora.com</code> <br>  PING pandora.com (208.85.40.20) 56 (84) bytes de datos. <br><br>  2. Escribimos en Google BGP 208.85.40.20 <br><br>  Vaya al sitio web <a href="">bgp.he.net/net/208.85.40.0/24#_netinfo</a> <br>  Puede ver que estoy buscando la subred es AS40428 Pandora Media, Inc <br><br>  <a href="">bgp.he.net/net/208.85.40.0/24#_netinfo</a> <br><br>  Abrir prefijos v4 <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">bgp.he.net/AS40428#_prefixes</a> <br><br>  ¬°Aqu√≠ est√°n las subredes deseadas! <br><br>  199.116.161.0/24 <br>  199.116.162.0/24 <br>  199.116.164.0/23 <br>  199.116.164.0/24 <br>  199.116.165.0/24 <br>  208.85.40.0/24 <br>  208.85.41.0/24 <br>  208.85.42.0/23 <br>  208.85.42.0/24 <br>  208.85.43.0/24 <br>  208.85.44.0/24 <br>  208.85.46.0/23 <br>  208.85.46.0/24 <br>  208.85.47.0/24 <br><br>  3. Para reducir el n√∫mero de subredes, se debe realizar la agregaci√≥n.  Vaya a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ip-calculator.ru/aggregate</a> y copie nuestra lista all√≠.  Como resultado, 6 subredes en lugar de 14. <br><br>  199.116.161.0/24 <br>  199.116.162.0/24 <br>  199.116.164.0/23 <br>  208.85.40.0/22 <br>  208.85.44.0/24 <br>  208.85.46.0/23 <br><br>  4. Borrar las reglas de iptables <br><br> <code>root@debian9:~# iptables -F <br> root@debian9:~# iptables -X <br> root@debian9:~# iptables -t nat -F <br> root@debian9:~# iptables -t nat -X</code> <br> <br>  Habilitar reenv√≠o y NAT <br><br> <code>root@debian9:~# echo 1 &gt; /proc/sys/net/ipv4/ip_forward <br> root@debian9:~# iptables -A FORWARD -i enp0s3 -o enp0s8 -j ACCEPT <br> root@debian9:~# iptables -A FORWARD -i enp0s8 -o enp0s3 -j ACCEPT <br> root@debian9:~# iptables -t nat -A POSTROUTING -o enp0s3 -s 192.168.201.0/24 -j MASQUERADE</code> <br> <br>  Para que el reenv√≠o est√© siempre activado despu√©s de reiniciar, cambie el archivo <br><br> <code>root@debian9:~# nano /etc/sysctl.conf</code> <br> <br>  Y descomentar la l√≠nea <br><br>  net.ipv4.ip_forward = 1 <br><br>  Ctrl + X para guardar el archivo <br><br>  5. Envolvemos las subredes de pandora.com en el proxy <br><br> <code>root@debian9:~# iptables -t nat -A PREROUTING -s 192.168.201.0/24 -d 199.116.161.0/24,199.116.162.0/24,199.116.164.0/23,208.85.40.0/22,208.85.44.0/24,208.85.46.0/23 -p tcp -j REDIRECT --to-ports 888</code> <br> <br>  6. Guardar las reglas <br><br> <code>root@debian9:~# iptables-save &gt; /etc/iptables/rules.v4</code> <br> <br><h3>  Configure y ejecute el Proxy transparente a trav√©s de la configuraci√≥n del enrutador </h3><br>  En esta configuraci√≥n, el servidor proxy transparente puede ser una PC separada o una m√°quina virtual detr√°s de un enrutador dom√©stico / corporativo.  Es suficiente registrar rutas est√°ticas en el enrutador o dispositivos y toda la subred usar√° proxies sin la necesidad de ninguna configuraci√≥n adicional. <br><br>  ¬°IMPORTANTE!  Es necesario que nuestra puerta de enlace reciba una IP est√°tica del enrutador, o que est√© configurada para la misma est√°tica. <br><br>  1. Configure una direcci√≥n de puerta de enlace est√°tica (adaptador enp0s3) <br><br> <code>root@debian9:~# nano /etc/network/interfaces</code> <br> <br><div class="spoiler">  <b class="spoiler_title">archivo / etc / network / interfaces</b> <div class="spoiler_text">  # Este archivo describe las interfaces de red disponibles en su sistema <br>  # y c√≥mo activarlos.  Para obtener m√°s informaci√≥n, consulte las interfaces (5). <br><br>  fuente /etc/network/interfaces.d/* <br><br>  # La interfaz de red de bucle invertido <br>  auto lo <br>  iface lo inet loopback <br><br>  # La interfaz de red primaria <br>  allow-hotplug enp0s3 <br>  iface enp0s3 inet est√°tico <br>  direcci√≥n 192.168.23.2 <br>  m√°scara de red 255.255.255.0 <br>  Gateway 192.168.23.254 <br><br>  # La interfaz de red secundaria <br>  allow-hotplug enp0s8 <br>  iface enp0s8 inet est√°tico <br>  direcci√≥n 192.168.201.254 <br>  m√°scara de red 255.255.255.0 <br></div></div><br>  2. Permitir que los dispositivos de la subred 192.168.23.0/24 utilicen el proxy <br><br> <code>root@debian9:~# iptables -t nat -A PREROUTING -s 192.168.23.0/24 -d 199.116.161.0/24,199.116.162.0/24,199.116.164.0/23,208.85.40.0/22,208.85.44.0/24,208.85.46.0/23 -p tcp -j REDIRECT --to-ports 888</code> <br> <br>  3. Guardar las reglas <br> <code>root@debian9:~# iptables-save &gt; /etc/iptables/rules.v4</code> <br> <br>  4. Registraremos las subredes en el enrutador <br><br><div class="spoiler">  <b class="spoiler_title">Lista de red del enrutador</b> <div class="spoiler_text">  199.116.161.0 255.255.255.0 192.168.23.2 <br>  199.116.162.0 255.255.255.0 192.168.23.2 <br>  199.116.164.0 255.255.254.0 192.168.23.2 <br>  208.85.40.0 255.255.252.0 192.168.23.2 <br>  208.85.44.0 255.255.255.0 192.168.23.2 <br>  208.85.46.0 255.255.254.0 192.168.23.2 <br></div></div><br><h3>  Materiales / recursos utilizados </h3><br>  1. El sitio web oficial del <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">programa</a> 3proxy <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">3proxy.ru</a> <br><br>  2. Instrucciones de instalaci√≥n para 3proxy de la fuente <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">www.ekzorchik.ru/2015/02/how-to-take-your-socks-proxy</a> <br><br>  3. Rama de desarrollador 3proxy en github <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">github.com/z3APA3A/3proxy/issues/274</a> <br><br></div></div></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/460469/">https://habr.com/ru/post/460469/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../460459/index.html">Archivo de configuraci√≥n htaccess</a></li>
<li><a href="../460461/index.html">Simulaci√≥n de ataques dirigidos como una evaluaci√≥n de seguridad. Instrucciones cibern√©ticas de Teaming rojo</a></li>
<li><a href="../460463/index.html">¬øQu√© pas√≥ con GALILEO? - Versi√≥n del programador GNSS</a></li>
<li><a href="../460465/index.html">Sombras digitales: ayuda de manera competente a reducir los riesgos digitales</a></li>
<li><a href="../460467/index.html">Estamos buscando una aver√≠a en el autom√≥vil por el sonido: llamamos a una peque√±a m√°quina que aprende a encontrar anomal√≠as en el motor</a></li>
<li><a href="../460471/index.html">Errores del panel de administraci√≥n o experiencia de desarrollo de Laravel Orchid</a></li>
<li><a href="../460473/index.html">El ruido blanco dibuja un cuadrado negro</a></li>
<li><a href="../460475/index.html">Control remoto m√≥vil salvavidas</a></li>
<li><a href="../460479/index.html">Y el oso de peluche parece estar muy cargado</a></li>
<li><a href="../460481/index.html">Computadoras de rendimiento sin ventilador MIC-7000</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>