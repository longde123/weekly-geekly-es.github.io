<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘¨ğŸ¾ ğŸ’“ ğŸ™…ğŸ¿ Spring Cacheï¼šä»1åˆ†é’Ÿçš„è¿æ¥ç¼“å­˜åˆ°çµæ´»çš„ç¼“å­˜ç®¡ç†å™¨é…ç½® â¤µï¸ ğŸ”¥ ğŸ”“</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="æˆ‘ä»¥å‰å¾ˆæ€•ç¼“å­˜ã€‚ æˆ‘çœŸçš„ä¸æƒ³çˆ¬ä¸Šå»çœ‹çœ‹å®ƒæ˜¯ä»€ä¹ˆï¼Œæˆ‘ç«‹å³æƒ³åƒå‡ºä¸€äº›å‘åŠ¨æœºèˆ±Lutoä¼ä¸šçš„ä¸œè¥¿ï¼Œåªæœ‰å¥¥æ—åŒ¹å…‹å¥¥æ—åŒ¹å…‹çš„è·èƒœè€…æ‰èƒ½å¼„æ¸…æ¥šã€‚ äº‹å®è¯æ˜å¹¶éå¦‚æ­¤ã€‚ äº‹å®è¯æ˜ï¼Œç¼“å­˜åœ¨ä»»ä½•é¡¹ç›®ä¸­éƒ½éå¸¸ç®€å•ï¼Œæ˜“äºç†è§£å¹¶ä¸”éå¸¸å®¹æ˜“å®ç°ã€‚ 



 åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†å°½æˆ‘æ‰€èƒ½è§£é‡Šæœ‰å…³ç¼“å­˜çš„ç®€å•çŸ¥è¯†ã€‚ æ‚¨å°†å­¦ä¹ å¦‚ä½•åœ¨1åˆ†é’Ÿå†…...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Spring Cacheï¼šä»1åˆ†é’Ÿçš„è¿æ¥ç¼“å­˜åˆ°çµæ´»çš„ç¼“å­˜ç®¡ç†å™¨é…ç½®</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/465667/">æˆ‘ä»¥å‰å¾ˆæ€•ç¼“å­˜ã€‚ æˆ‘çœŸçš„ä¸æƒ³çˆ¬ä¸Šå»çœ‹çœ‹å®ƒæ˜¯ä»€ä¹ˆï¼Œæˆ‘ç«‹å³æƒ³åƒå‡ºä¸€äº›å‘åŠ¨æœºèˆ±Lutoä¼ä¸šçš„ä¸œè¥¿ï¼Œåªæœ‰å¥¥æ—åŒ¹å…‹å¥¥æ—åŒ¹å…‹çš„è·èƒœè€…æ‰èƒ½å¼„æ¸…æ¥šã€‚ äº‹å®è¯æ˜å¹¶éå¦‚æ­¤ã€‚ äº‹å®è¯æ˜ï¼Œç¼“å­˜åœ¨ä»»ä½•é¡¹ç›®ä¸­éƒ½éå¸¸ç®€å•ï¼Œæ˜“äºç†è§£å¹¶ä¸”éå¸¸å®¹æ˜“å®ç°ã€‚ <br><br><img src="https://habrastorage.org/webt/1f/my/g2/1fmyg2ofjbgqmyf3lorqqkan85u.jpeg"><br><br> åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†å°½æˆ‘æ‰€èƒ½è§£é‡Šæœ‰å…³ç¼“å­˜çš„ç®€å•çŸ¥è¯†ã€‚ æ‚¨å°†å­¦ä¹ å¦‚ä½•åœ¨1åˆ†é’Ÿå†…å®ç°ç¼“å­˜ï¼Œå¦‚ä½•é€šè¿‡é”®ç¼“å­˜ï¼Œè®¾ç½®ç¼“å­˜ç”Ÿå­˜æœŸä»¥åŠè®¸å¤šå…¶ä»–æ–¹é¢çš„çŸ¥è¯†ï¼Œå¦‚æœæ‚¨è¢«æŒ‡ç¤ºè¦åœ¨å·¥ä½œé¡¹ç›®ä¸­ç¼“å­˜æŸäº›å†…å®¹ï¼Œå¹¶ä¸”ä¸æƒ³å¼„æ··è„¸ <br><a name="habracut"></a><br> ä¸ºä»€ä¹ˆæˆ‘è¯´â€œå—ä¿¡ä»»â€ï¼Ÿ é€šå¸¸ï¼Œç”±äºç¼“å­˜æ˜¯æœ‰æ„ä¹‰çš„ï¼Œå› æ­¤å¯ä»¥åº”ç”¨åˆ°å¤§å‹ï¼Œé«˜è´Ÿè½½çš„é¡¹ç›®ä¸­ï¼Œæ¯åˆ†é’Ÿæœ‰æˆåƒä¸Šä¸‡çš„è¯·æ±‚ã€‚ åœ¨æ­¤ç±»é¡¹ç›®ä¸­ï¼Œä¸ºäº†ä¸ä½¿æ•°æ®åº“è¿‡è½½ï¼Œå®ƒä»¬é€šå¸¸ä¼šç¼“å­˜å­˜å‚¨åº“è°ƒç”¨ã€‚ å°¤å…¶æ˜¯å¦‚æœå·²çŸ¥ä»¥æŸä¸ªé¢‘ç‡æ›´æ–°æŸä¸ªä¸»ç³»ç»Ÿçš„æ•°æ®ã€‚ æˆ‘ä»¬è‡ªå·±ä¸ç¼–å†™æ­¤ç±»é¡¹ç›®ï¼Œæˆ‘ä»¬è‡´åŠ›äºå®ƒä»¬ã€‚ å¦‚æœé¡¹ç›®å¾ˆå°å¹¶ä¸”ä¸ä¼šå¨èƒåˆ°è¿‡è½½ï¼Œé‚£ä¹ˆå½“ç„¶æœ€å¥½ä¸è¦ç¼“å­˜ä»»ä½•ä¸œè¥¿-å§‹ç»ˆæ–°é²œçš„æ•°æ®æ€»æ˜¯æ¯”å®šæœŸæ›´æ–°çš„æ•°æ®æ›´å¥½ã€‚ <br><br> é€šå¸¸ï¼Œåœ¨åŸ¹è®­å²—ä½ä¸Šï¼Œæ¼”è®²è€…é¦–å…ˆä¼šåœ¨å¼•æ“ç›–ä¸‹çˆ¬è¡Œï¼Œå¼€å§‹æ·±å…¥ç ”ç©¶æŠ€æœ¯èƒ†é‡ï¼Œè¿™ä½¿è¯»è€…å€æ„Ÿå›°æ‰°ï¼Œåªæœ‰åˆ°é‚£æ—¶ï¼Œå½“ä»–ç¿»é˜…äº†æ–‡ç« çš„å¤§éƒ¨åˆ†å†…å®¹å¹¶ä¸”ä¸äº†è§£ä»»ä½•å†…å®¹æ—¶ï¼Œå®ƒä¾¿ä¼šå‘Šè¯‰è¯»è€…å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚ ä¸€åˆ‡éƒ½ä¼šä¸æˆ‘ä»¬ä¸åŒã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬ä½¿å®ƒå·¥ä½œï¼Œå¹¶ä¸”æœ€å¥½ä»¥æœ€å°‘çš„åŠªåŠ›ï¼Œç„¶åï¼Œå¦‚æœæ‚¨æœ‰å…´è¶£ï¼Œå°±å¯ä»¥åœ¨ç¼“å­˜å±‚ä¸‹é¢æŸ¥çœ‹ï¼Œåœ¨åƒåœ¾ç®±å†…éƒ¨æŸ¥çœ‹å¹¶å¾®è°ƒç¼“å­˜ã€‚ ä½†æ˜¯ï¼Œå³ä½¿æ‚¨ä¸è¿™æ ·åšï¼ˆå¹¶ä¸”ä»ç¬¬6ç‚¹å¼€å§‹ï¼‰ï¼Œæ‚¨çš„ç¼“å­˜ä¹Ÿå¯ä»¥é‚£æ ·å·¥ä½œã€‚ <br><br> æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªé¡¹ç›®ï¼Œåœ¨å…¶ä¸­æˆ‘ä»¬å°†åˆ†ææˆ‘æ‰¿è¯ºçš„æ‰€æœ‰ç¼“å­˜æ–¹é¢ã€‚ æœ€åï¼Œåƒå¾€å¸¸ä¸€æ ·ï¼Œå°†æœ‰ä¸€ä¸ªæŒ‡å‘é¡¹ç›®æœ¬èº«çš„é“¾æ¥ã€‚ <br><br><h2>  0.åˆ›å»ºä¸€ä¸ªé¡¹ç›® </h2><br> æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªéå¸¸ç®€å•çš„é¡¹ç›®ï¼Œåœ¨å…¶ä¸­æˆ‘ä»¬å¯ä»¥ä»æ•°æ®åº“ä¸­è·å–å®ä½“ã€‚ æˆ‘å‘é¡¹ç›®æ·»åŠ äº†Lombokï¼ŒSpring Cacheï¼ŒSpring Data JPAå’ŒH2ã€‚ è™½ç„¶ï¼Œåªæœ‰Spring Cacheå¯ä»¥çœæ‰ã€‚ <br><br><pre><code class="java hljs">plugins { id <span class="hljs-string"><span class="hljs-string">'org.springframework.boot'</span></span> version <span class="hljs-string"><span class="hljs-string">'2.1.7.RELEASE'</span></span> id <span class="hljs-string"><span class="hljs-string">'io.spring.dependency-management'</span></span> version <span class="hljs-string"><span class="hljs-string">'1.0.8.RELEASE'</span></span> id <span class="hljs-string"><span class="hljs-string">'java'</span></span> } group = <span class="hljs-string"><span class="hljs-string">'ru.xpendence'</span></span> version = <span class="hljs-string"><span class="hljs-string">'0.0.1-SNAPSHOT'</span></span> sourceCompatibility = <span class="hljs-string"><span class="hljs-string">'1.8'</span></span> configurations { compileOnly { extendsFrom annotationProcessor } } repositories { mavenCentral() } dependencies { implementation <span class="hljs-string"><span class="hljs-string">'org.springframework.boot:spring-boot-starter-cache'</span></span> implementation <span class="hljs-string"><span class="hljs-string">'org.springframework.boot:spring-boot-starter-data-jpa'</span></span> compileOnly <span class="hljs-string"><span class="hljs-string">'org.projectlombok:lombok'</span></span> runtimeOnly <span class="hljs-string"><span class="hljs-string">'com.h2database:h2'</span></span> annotationProcessor <span class="hljs-string"><span class="hljs-string">'org.projectlombok:lombok'</span></span> testImplementation <span class="hljs-string"><span class="hljs-string">'org.springframework.boot:spring-boot-starter-test'</span></span> }</code> </pre> <br> æˆ‘ä»¬åªæœ‰ä¸€ä¸ªå®ä½“ï¼Œæˆ‘ä»¬ç§°å…¶ä¸ºUserã€‚ <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Entity</span></span> <span class="hljs-meta"><span class="hljs-meta">@Table</span></span>(name = <span class="hljs-string"><span class="hljs-string">"users"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Data</span></span> <span class="hljs-meta"><span class="hljs-meta">@NoArgsConstructor</span></span> <span class="hljs-meta"><span class="hljs-meta">@ToString</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Serializable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Id</span></span> <span class="hljs-meta"><span class="hljs-meta">@GeneratedValue</span></span>(strategy = GenerationType.IDENTITY) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long id; <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"name"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String name; <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"email"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String email; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">User</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name, String email)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.name = name; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.email = email; } }</code> </pre> <br> æ·»åŠ å­˜å‚¨åº“å’ŒæœåŠ¡ï¼š <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserRepository</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JpaRepository</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Long</span></span></span><span class="hljs-class">&gt; </span></span>{ } <span class="hljs-meta"><span class="hljs-meta">@Slf</span></span>4j <span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserServiceImpl</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> UserRepository repository; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UserServiceImpl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(UserRepository repository)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.repository = repository; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> User </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(User user)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> repository.save(user); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> User </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Long id)</span></span></span><span class="hljs-function"> </span></span>{ log.info(<span class="hljs-string"><span class="hljs-string">"getting user by id: {}"</span></span>, id); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> repository.findById(id) .orElseThrow(() -&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EntityNotFoundException(<span class="hljs-string"><span class="hljs-string">"User not found by id "</span></span> + id)); } }</code> </pre> <br> å½“æˆ‘ä»¬è¾“å…¥getï¼ˆï¼‰æœåŠ¡æ–¹æ³•æ—¶ï¼Œæˆ‘ä»¬å°†å…¶è®°å½•åœ¨æ—¥å¿—ä¸­ã€‚ <br><br> è¿æ¥åˆ°Spring Cacheé¡¹ç›®ã€‚ <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@SpringBootApplication</span></span> <span class="hljs-meta"><span class="hljs-meta">@EnableCaching</span></span> <span class="hljs-comment"><span class="hljs-comment">// Spring Cache public class CacheApplication { public static void main(String[] args) { SpringApplication.run(CacheApplication.class, args); } }</span></span></code> </pre> <br> é¡¹ç›®å‡†å¤‡å°±ç»ªã€‚ <br><br><h2>  1.ç¼“å­˜è¿”å›ç»“æœ </h2><br>  Spring Cacheåšä»€ä¹ˆï¼Ÿ  Spring Cacheåªæ˜¯ç¼“å­˜ç‰¹å®šè¾“å…¥å‚æ•°çš„è¿”å›ç»“æœã€‚ è®©æˆ‘ä»¬æ¥çœ‹çœ‹ã€‚ æˆ‘ä»¬å°†@Cacheableæ‰¹æ³¨æ”¾åœ¨getï¼ˆï¼‰æœåŠ¡æ–¹æ³•ä¸Šï¼Œä»¥ç¼“å­˜è¿”å›çš„æ•°æ®ã€‚ æˆ‘ä»¬å°†æ­¤æ³¨é‡Šå‘½åä¸ºâ€œç”¨æˆ·â€ï¼ˆæˆ‘ä»¬å°†è¿›ä¸€æ­¥åˆ†æä¸ºä»€ä¹ˆå•ç‹¬è¿›è¡Œæ­¤æ“ä½œï¼‰ã€‚ <br><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-meta"><span class="hljs-meta">@Cacheable</span></span>(<span class="hljs-string"><span class="hljs-string">"users"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> User </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Long id)</span></span></span><span class="hljs-function"> </span></span>{ log.info(<span class="hljs-string"><span class="hljs-string">"getting user by id: {}"</span></span>, id); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> repository.findById(id) .orElseThrow(() -&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EntityNotFoundException(<span class="hljs-string"><span class="hljs-string">"User not found by id "</span></span> + id)); }</code> </pre> <br> ä¸ºäº†æ£€æŸ¥å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œæˆ‘ä»¬å°†ç¼–å†™ä¸€ä¸ªç®€å•çš„æµ‹è¯•ã€‚ <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(SpringRunner.class) <span class="hljs-meta"><span class="hljs-meta">@SpringBootTest</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractTest</span></span></span><span class="hljs-class"> </span></span>{ }</code> </pre> <br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Slf</span></span>4j <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserServiceTest</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> UserService service; <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ User user1 = service.create(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User(<span class="hljs-string"><span class="hljs-string">"Vasya"</span></span>, <span class="hljs-string"><span class="hljs-string">"vasya@mail.ru"</span></span>)); User user2 = service.create(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User(<span class="hljs-string"><span class="hljs-string">"Kolya"</span></span>, <span class="hljs-string"><span class="hljs-string">"kolya@mail.ru"</span></span>)); getAndPrint(user1.getId()); getAndPrint(user2.getId()); getAndPrint(user1.getId()); getAndPrint(user2.getId()); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAndPrint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Long id)</span></span></span><span class="hljs-function"> </span></span>{ log.info(<span class="hljs-string"><span class="hljs-string">"user found: {}"</span></span>, service.get(id)); } }</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">é¢˜å¤–è¯ï¼Œä¸ºä»€ä¹ˆæˆ‘é€šå¸¸ç¼–å†™AbstractTestå¹¶ä»ä¸­ç»§æ‰¿æ‰€æœ‰æµ‹è¯•ã€‚</b> <div class="spoiler_text"> å¦‚æœè¯¥ç±»å…·æœ‰è‡ªå·±çš„@SpringBootTestæ‰¹æ³¨ï¼Œåˆ™æ¯æ¬¡éƒ½ä¼šä¸ºè¯¥ç±»é‡æ–°å¼•å‘ä¸Šä¸‹æ–‡ã€‚ ç”±äºä¸Šä¸‹æ–‡å¯èƒ½ä¼šæŒç»­5ç§’é’Ÿæˆ–40ç§’é’Ÿï¼Œå› æ­¤æ— è®ºå¦‚ä½•è¿™éƒ½ä¼šæå¤§åœ°é˜»ç¢æµ‹è¯•è¿‡ç¨‹ã€‚ åŒæ—¶ï¼Œä¸Šä¸‹æ–‡é€šå¸¸æ²¡æœ‰åŒºåˆ«ï¼Œå¹¶ä¸”åœ¨åŒä¸€ç±»ä¸­è¿è¡Œæ¯ç»„æµ‹è¯•æ—¶ï¼Œæ— éœ€é‡æ–°å¯åŠ¨ä¸Šä¸‹æ–‡ã€‚ å¦‚æœåƒæˆ‘ä»¬è¿™æ ·ï¼Œåœ¨æŠ½è±¡ç±»ä¸Šä»…æ”¾ç½®ä¸€ä¸ªæ³¨é‡Šï¼Œä¾‹å¦‚ï¼Œè¿™å°†ä½¿æˆ‘ä»¬ä»…å¼•å‘ä¸€æ¬¡ä¸Šä¸‹æ–‡ã€‚ <br><br> å› æ­¤ï¼Œå¦‚æœå¯èƒ½çš„è¯ï¼Œæˆ‘å®æ„¿å‡å°‘åœ¨æµ‹è¯•/ç»„è£…è¿‡ç¨‹ä¸­æå‡ºçš„ä¸Šä¸‹æ–‡æ•°é‡ã€‚ <br></div></div><br> æˆ‘ä»¬çš„æµ‹è¯•åšä»€ä¹ˆï¼Ÿ ä»–åˆ›å»ºäº†ä¸¤ä¸ªç”¨æˆ·ï¼Œç„¶åä¸¤æ¬¡å°†å…¶ä»æ•°æ®åº“ä¸­æ‹‰å‡ºã€‚ å›æƒ³ä¸€ä¸‹ï¼Œæˆ‘ä»¬æ”¾ç½®äº†@Cacheableæ‰¹æ³¨ï¼Œè¯¥æ‰¹æ³¨å°†ç¼“å­˜è¿”å›çš„å€¼ã€‚ ä»getï¼ˆï¼‰æ–¹æ³•æ¥æ”¶åˆ°å¯¹è±¡åï¼Œæˆ‘ä»¬å°†å¯¹è±¡è¾“å‡ºåˆ°æ—¥å¿—ä¸­ã€‚ åŒæ ·ï¼Œæˆ‘ä»¬å°†æœ‰å…³åº”ç”¨ç¨‹åºæ¯æ¬¡è®¿é—®çš„ä¿¡æ¯è®°å½•åˆ°getï¼ˆï¼‰æ–¹æ³•ã€‚ <br><br> è¿è¡Œæµ‹è¯•ã€‚ è¿™å°±æ˜¯æˆ‘ä»¬åœ¨æ§åˆ¶å°ä¸­å¾—åˆ°çš„ã€‚ <br><br><pre> <code class="java hljs">getting user by id: <span class="hljs-number"><span class="hljs-number">1</span></span> user found: User(id=<span class="hljs-number"><span class="hljs-number">1</span></span>, name=Vasya, email=vasya<span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru) getting user by id: <span class="hljs-number"><span class="hljs-number">2</span></span> user found: User(id=<span class="hljs-number"><span class="hljs-number">2</span></span>, name=Kolya, email=kolya<span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru) user found: User(id=<span class="hljs-number"><span class="hljs-number">1</span></span>, name=Vasya, email=vasya<span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru) user found: User(id=<span class="hljs-number"><span class="hljs-number">2</span></span>, name=Kolya, email=kolya<span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru)</code> </pre> <br> å¦‚æˆ‘ä»¬æ‰€è§ï¼Œå‰ä¸¤æ¬¡æˆ‘ä»¬ç¡®å®ä½¿ç”¨äº†getï¼ˆï¼‰æ–¹æ³•ï¼Œå¹¶å®é™…ä¸Šä»æ•°æ®åº“ä¸­è·å–äº†ç”¨æˆ·ã€‚ åœ¨æ‰€æœ‰å…¶ä»–æƒ…å†µä¸‹ï¼Œéƒ½æ²¡æœ‰å¯¹æ–¹æ³•çš„çœŸæ­£è°ƒç”¨ï¼Œåº”ç”¨ç¨‹åºé€šè¿‡é”®è·å–äº†ç¼“å­˜çš„æ•°æ®ï¼ˆåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¿™æ˜¯idï¼‰ã€‚ <br><br><h2>  2.ç¼“å­˜å¯†é’¥å£°æ˜ </h2><br> åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œç¼“å­˜çš„æ–¹æ³•ä¼šåŒ…å«å¤šä¸ªå‚æ•°ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯èƒ½æœ‰å¿…è¦ç¡®å®šè¿›è¡Œç¼“å­˜çš„å‚æ•°ã€‚ æˆ‘ä»¬åœ¨æ–¹æ³•ä¸­æ·»åŠ äº†ä¸€ä¸ªç¤ºä¾‹ï¼Œè¯¥ç¤ºä¾‹ä¼šå°†ç”±å‚æ•°ç»„è£…çš„å®ä½“ä¿å­˜åˆ°æ•°æ®åº“ä¸­ï¼Œä½†æ˜¯å¦‚æœå·²ç»å­˜åœ¨å…·æœ‰ç›¸åŒåç§°çš„å®ä½“ï¼Œåˆ™ä¸ä¼šä¿å­˜å®ƒã€‚ ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†nameå‚æ•°å®šä¹‰ä¸ºç¼“å­˜é”®ã€‚ å®ƒçœ‹èµ·æ¥åƒè¿™æ ·ï¼š <br><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-meta"><span class="hljs-meta">@Cacheable</span></span>(value = <span class="hljs-string"><span class="hljs-string">"users"</span></span>, key = <span class="hljs-string"><span class="hljs-string">"#name"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> User </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name, String email)</span></span></span><span class="hljs-function"> </span></span>{ log.info(<span class="hljs-string"><span class="hljs-string">"creating user with parameters: {}, {}"</span></span>, name, email); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> repository.save(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User(name, email)); }</code> </pre> <br> è®©æˆ‘ä»¬ç¼–å†™ç›¸åº”çš„æµ‹è¯•ï¼š <br><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ createAndPrint(<span class="hljs-string"><span class="hljs-string">"Ivan"</span></span>, <span class="hljs-string"><span class="hljs-string">"ivan@mail.ru"</span></span>); createAndPrint(<span class="hljs-string"><span class="hljs-string">"Ivan"</span></span>, <span class="hljs-string"><span class="hljs-string">"ivan1122@mail.ru"</span></span>); createAndPrint(<span class="hljs-string"><span class="hljs-string">"Sergey"</span></span>, <span class="hljs-string"><span class="hljs-string">"ivan@mail.ru"</span></span>); log.info(<span class="hljs-string"><span class="hljs-string">"all entries are below:"</span></span>); service.getAll().forEach(u -&gt; log.info(<span class="hljs-string"><span class="hljs-string">"{}"</span></span>, u.toString())); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createAndPrint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name, String email)</span></span></span><span class="hljs-function"> </span></span>{ log.info(<span class="hljs-string"><span class="hljs-string">"created user: {}"</span></span>, service.create(name, email)); }</code> </pre> <br> æˆ‘ä»¬å°†å°è¯•åˆ›å»ºä¸‰ä¸ªç”¨æˆ·ï¼Œå…¶ä¸­ä¸¤ä¸ªçš„åç§°å°†ç›¸åŒ <br><br><pre> <code class="java hljs"> createAndPrint(<span class="hljs-string"><span class="hljs-string">"Ivan"</span></span>, <span class="hljs-string"><span class="hljs-string">"ivan@mail.ru"</span></span>); createAndPrint(<span class="hljs-string"><span class="hljs-string">"Ivan"</span></span>, <span class="hljs-string"><span class="hljs-string">"ivan1122@mail.ru"</span></span>);</code> </pre> <br> å¹¶ä¸”å…¶ä¸­ä¸¤ä¸ªç”µå­é‚®ä»¶å°†åŒ¹é… <br><br><pre> <code class="java hljs"> createAndPrint(<span class="hljs-string"><span class="hljs-string">"Ivan"</span></span>, <span class="hljs-string"><span class="hljs-string">"ivan@mail.ru"</span></span>); createAndPrint(<span class="hljs-string"><span class="hljs-string">"Sergey"</span></span>, <span class="hljs-string"><span class="hljs-string">"ivan@mail.ru"</span></span>);</code> </pre> <br> åœ¨åˆ›å»ºæ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬è®°å½•è¯¥æ–¹æ³•è¢«è°ƒç”¨çš„æ‰€æœ‰äº‹å®ï¼Œå¹¶ä¸”è¿˜å°†è®°å½•è¯¥æ–¹æ³•è¿”å›ç»™æˆ‘ä»¬çš„æ‰€æœ‰å®ä½“ã€‚ ç»“æœå°†æ˜¯è¿™æ ·çš„ï¼š <br><br><pre> <code class="java hljs">creating user with parameters: Ivan, ivan<span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru created user: User(id=<span class="hljs-number"><span class="hljs-number">1</span></span>, name=Ivan, email=ivan<span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru) created user: User(id=<span class="hljs-number"><span class="hljs-number">1</span></span>, name=Ivan, email=ivan<span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru) creating user with parameters: Sergey, ivan<span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru created user: User(id=<span class="hljs-number"><span class="hljs-number">2</span></span>, name=Sergey, email=ivan<span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru) all entries are below: User(id=<span class="hljs-number"><span class="hljs-number">1</span></span>, name=Ivan, email=ivan<span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru) User(id=<span class="hljs-number"><span class="hljs-number">2</span></span>, name=Sergey, email=ivan<span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru)</code> </pre> <br> æˆ‘ä»¬çœ‹åˆ°ï¼Œå®é™…ä¸Šï¼Œè¯¥åº”ç”¨ç¨‹åºè°ƒç”¨äº†3æ¬¡è¯¥æ–¹æ³•ï¼Œå¹¶ä¸”ä»…ä¸¤æ¬¡è°ƒç”¨äº†è¯¥æ–¹æ³•ã€‚ ä¸€æ—¦é”®ä¸æ–¹æ³•åŒ¹é…ï¼Œå®ƒå°±ç®€å•åœ°è¿”å›ä¸€ä¸ªç¼“å­˜çš„å€¼ã€‚ <br><br><h2>  3.å¼ºåˆ¶ç¼“å­˜ã€‚  @CachePut </h2><br> åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æƒ³ç¼“å­˜æŸä¸ªå®ä½“çš„è¿”å›å€¼ï¼Œä½†æ˜¯åŒæ—¶ï¼Œæˆ‘ä»¬éœ€è¦æ›´æ–°ç¼“å­˜ã€‚ å¯¹äºæ­¤ç±»éœ€æ±‚ï¼Œå­˜åœ¨@CachePutæ‰¹æ³¨ã€‚ å®ƒå°†åº”ç”¨ç¨‹åºä¼ é€’åˆ°æ–¹æ³•ä¸­ï¼ŒåŒæ—¶ä¸ºè¿”å›å€¼æ›´æ–°ç¼“å­˜ï¼Œå³ä½¿å®ƒå·²è¢«ç¼“å­˜ã€‚ <br><br> æ·»åŠ ä¸€äº›å¯ä»¥ä¿å­˜ç”¨æˆ·çš„æ–¹æ³•ã€‚ æˆ‘ä»¬å°†ä½¿ç”¨æ™®é€šçš„@Cacheableæ‰¹æ³¨æ ‡è®°å…¶ä¸­ä¸€ä¸ªï¼Œä½¿ç”¨ç¬¬äºŒä¸ª@CachePutæ ‡è®°ã€‚ <br><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-meta"><span class="hljs-meta">@Cacheable</span></span>(value = <span class="hljs-string"><span class="hljs-string">"users"</span></span>, key = <span class="hljs-string"><span class="hljs-string">"#user.name"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> User </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createOrReturnCached</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(User user)</span></span></span><span class="hljs-function"> </span></span>{ log.info(<span class="hljs-string"><span class="hljs-string">"creating user: {}"</span></span>, user); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> repository.save(user); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-meta"><span class="hljs-meta">@CachePut</span></span>(value = <span class="hljs-string"><span class="hljs-string">"users"</span></span>, key = <span class="hljs-string"><span class="hljs-string">"#user.name"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> User </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createAndRefreshCache</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(User user)</span></span></span><span class="hljs-function"> </span></span>{ log.info(<span class="hljs-string"><span class="hljs-string">"creating user: {}"</span></span>, user); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> repository.save(user); }</code> </pre> <br> ç¬¬ä¸€ç§æ–¹æ³•å°†ç®€å•åœ°è¿”å›ç¼“å­˜çš„å€¼ï¼Œç¬¬äºŒç§æ–¹æ³•å°†å¼ºåˆ¶æ›´æ–°ç¼“å­˜ã€‚ ç¼“å­˜å°†ä½¿ç”¨é”®ï¼ƒuser.nameæ‰§è¡Œã€‚ æˆ‘ä»¬å°†ç¼–å†™ç›¸åº”çš„æµ‹è¯•ã€‚ <br><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createAndRefresh</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ User user1 = service.createOrReturnCached(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User(<span class="hljs-string"><span class="hljs-string">"Vasya"</span></span>, <span class="hljs-string"><span class="hljs-string">"vasya@mail.ru"</span></span>)); log.info(<span class="hljs-string"><span class="hljs-string">"created user1: {}"</span></span>, user1); User user2 = service.createOrReturnCached(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User(<span class="hljs-string"><span class="hljs-string">"Vasya"</span></span>, <span class="hljs-string"><span class="hljs-string">"misha@mail.ru"</span></span>)); log.info(<span class="hljs-string"><span class="hljs-string">"created user2: {}"</span></span>, user2); User user3 = service.createAndRefreshCache(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User(<span class="hljs-string"><span class="hljs-string">"Vasya"</span></span>, <span class="hljs-string"><span class="hljs-string">"kolya@mail.ru"</span></span>)); log.info(<span class="hljs-string"><span class="hljs-string">"created user3: {}"</span></span>, user3); User user4 = service.createOrReturnCached(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User(<span class="hljs-string"><span class="hljs-string">"Vasya"</span></span>, <span class="hljs-string"><span class="hljs-string">"petya@mail.ru"</span></span>)); log.info(<span class="hljs-string"><span class="hljs-string">"created user4: {}"</span></span>, user4); }</code> </pre> <br> æ ¹æ®å·²ç»æè¿°çš„é€»è¾‘ï¼Œç¬¬ä¸€æ¬¡é€šè¿‡createOrReturnCachedï¼ˆï¼‰æ–¹æ³•ä¿å­˜åç§°ä¸ºâ€œ Vasyaâ€çš„ç”¨æˆ·æ—¶ï¼Œæˆ‘ä»¬å°†æ”¶åˆ°ä¸€ä¸ªç¼“å­˜çš„å®ä½“ï¼Œå¹¶ä¸”åº”ç”¨ç¨‹åºå°†ä¸ä¼šè‡ªè¡Œè¾“å…¥è¯¥æ–¹æ³•ã€‚ å¦‚æœè°ƒç”¨createAndRefreshCacheï¼ˆï¼‰æ–¹æ³•ï¼Œåˆ™åä¸ºâ€œ Vasyaâ€çš„é”®çš„ç¼“å­˜å®ä½“å°†åœ¨ç¼“å­˜ä¸­è¢«è¦†ç›–ã€‚ è®©æˆ‘ä»¬è¿è¡Œæµ‹è¯•ï¼Œçœ‹çœ‹æ§åˆ¶å°ä¸­å°†æ˜¾ç¤ºä»€ä¹ˆã€‚ <br><br><pre> <code class="java hljs">creating user: User(id=<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, name=Vasya, email=vasya<span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru) created user1: User(id=<span class="hljs-number"><span class="hljs-number">1</span></span>, name=Vasya, email=vasya<span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru) created user2: User(id=<span class="hljs-number"><span class="hljs-number">1</span></span>, name=Vasya, email=vasya<span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru) creating user: User(id=<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, name=Vasya, email=kolya<span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru) created user3: User(id=<span class="hljs-number"><span class="hljs-number">2</span></span>, name=Vasya, email=kolya<span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru) created user4: User(id=<span class="hljs-number"><span class="hljs-number">2</span></span>, name=Vasya, email=kolya<span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru)</code> </pre> <br> æˆ‘ä»¬çœ‹åˆ°user1å·²æˆåŠŸå†™å…¥æ•°æ®åº“å’Œç¼“å­˜ã€‚ å½“æˆ‘ä»¬å°è¯•å†æ¬¡è®°å½•å…·æœ‰ç›¸åŒåç§°çš„ç”¨æˆ·æ—¶ï¼Œæˆ‘ä»¬å¾—åˆ°äº†ç¬¬ä¸€ä¸ªè°ƒç”¨çš„ç¼“å­˜ç»“æœï¼ˆuser2ï¼Œå…¶IDä¸user1ç›¸åŒï¼Œè¿™å‘Šè¯‰æˆ‘ä»¬è¯¥ç”¨æˆ·æœªè¢«å†™å…¥ï¼Œè¿™åªæ˜¯ä¸€ä¸ªç¼“å­˜ï¼‰ã€‚ æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é€šè¿‡ç¬¬äºŒç§æ–¹æ³•å†™å…¥ç¬¬ä¸‰ä¸ªç”¨æˆ·ï¼Œå³ä½¿ä½¿ç”¨ç¼“å­˜çš„ç»“æœï¼Œè¯¥ç”¨æˆ·ä»ç„¶ä¼šè°ƒç”¨è¯¥æ–¹æ³•å¹¶å°†æ–°ç»“æœå†™å…¥ç¼“å­˜ã€‚ è¿™æ˜¯user3ã€‚ å¦‚æˆ‘ä»¬æ‰€è§ï¼Œä»–å·²ç»æœ‰äº†ä¸€ä¸ªæ–°çš„IDã€‚ ä¹‹åï¼Œæˆ‘ä»¬è°ƒç”¨ç¬¬ä¸€ä¸ªæ–¹æ³•ï¼Œè¯¥æ–¹æ³•é‡‡ç”¨user3æ·»åŠ çš„æ–°ç¼“å­˜ã€‚ <br><br><h2>  4.ä»ç¼“å­˜ä¸­åˆ é™¤ã€‚  @CacheEvict </h2><br> æœ‰æ—¶æœ‰å¿…è¦ç¡¬æ›´æ–°ç¼“å­˜ä¸­çš„æŸäº›æ•°æ®ã€‚ ä¾‹å¦‚ï¼Œä¸€ä¸ªå®ä½“å·²ç»ä»æ•°æ®åº“ä¸­åˆ é™¤ï¼Œä½†æ˜¯ä»ç„¶å¯ä»¥ä»ç¼“å­˜ä¸­è®¿é—®å®ƒã€‚ ä¸ºäº†ä¿æŒæ•°æ®çš„ä¸€è‡´æ€§ï¼Œæˆ‘ä»¬è‡³å°‘ä¸éœ€è¦åœ¨ç¼“å­˜ä¸­å­˜å‚¨å·²åˆ é™¤çš„æ•°æ®ã€‚ <br><br> å‘è¯¥æœåŠ¡æ·»åŠ æ›´å¤šæ–¹æ³•ã€‚ <br><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">delete</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Long id)</span></span></span><span class="hljs-function"> </span></span>{ log.info(<span class="hljs-string"><span class="hljs-string">"deleting user by id: {}"</span></span>, id); repository.deleteById(id); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-meta"><span class="hljs-meta">@CacheEvict</span></span>(<span class="hljs-string"><span class="hljs-string">"users"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deleteAndEvict</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Long id)</span></span></span><span class="hljs-function"> </span></span>{ log.info(<span class="hljs-string"><span class="hljs-string">"deleting user by id: {}"</span></span>, id); repository.deleteById(id); }</code> </pre> <br> ç¬¬ä¸€ä¸ªåªä¼šåˆ é™¤ç”¨æˆ·ï¼Œç¬¬äºŒä¸ªä¹Ÿä¼šåˆ é™¤ç”¨æˆ·ï¼Œä½†æ˜¯æˆ‘ä»¬å°†ä½¿ç”¨@CacheEvictæ‰¹æ³¨å¯¹å…¶è¿›è¡Œæ ‡è®°ã€‚ æ·»åŠ ä¸€ä¸ªå°†åˆ›å»ºä¸¤ä¸ªç”¨æˆ·çš„æµ‹è¯•ï¼Œæ­¤åå°†é€šè¿‡ä¸€ç§ç®€å•çš„æ–¹æ³•åˆ é™¤ä¸€ä¸ªç”¨æˆ·ï¼Œç„¶åé€šè¿‡ä¸€ä¸ªå¸¦æ³¨é‡Šçš„æ–¹æ³•åˆ é™¤ä¸€ä¸ªç”¨æˆ·ã€‚ ä¹‹åï¼Œæˆ‘ä»¬å°†é€šè¿‡getï¼ˆï¼‰æ–¹æ³•å¸å¼•è¿™äº›ç”¨æˆ·ã€‚ <br><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">delete</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ User user1 = service.create(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User(<span class="hljs-string"><span class="hljs-string">"Vasya"</span></span>, <span class="hljs-string"><span class="hljs-string">"vasya@mail.ru"</span></span>)); log.info(<span class="hljs-string"><span class="hljs-string">"{}"</span></span>, service.get(user1.getId())); User user2 = service.create(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User(<span class="hljs-string"><span class="hljs-string">"Vasya"</span></span>, <span class="hljs-string"><span class="hljs-string">"vasya@mail.ru"</span></span>)); log.info(<span class="hljs-string"><span class="hljs-string">"{}"</span></span>, service.get(user2.getId())); service.delete(user1.getId()); service.deleteAndEvict(user2.getId()); log.info(<span class="hljs-string"><span class="hljs-string">"{}"</span></span>, service.get(user1.getId())); log.info(<span class="hljs-string"><span class="hljs-string">"{}"</span></span>, service.get(user2.getId())); }</code> </pre> <br> ç¬¦åˆé€»è¾‘çš„æ˜¯ï¼Œç”±äºå·²ç»ç¼“å­˜äº†æˆ‘ä»¬çš„ç”¨æˆ·ï¼Œå› æ­¤åˆ é™¤å°†ä¸ä¼šé˜»æ­¢æˆ‘ä»¬è·å–å®ƒï¼Œå› ä¸ºå®ƒå·²è¢«ç¼“å­˜ã€‚ è®©æˆ‘ä»¬çœ‹çœ‹æ—¥å¿—ã€‚ <br><br><pre> <code class="java hljs">getting user by id: <span class="hljs-number"><span class="hljs-number">1</span></span> User(id=<span class="hljs-number"><span class="hljs-number">1</span></span>, name=Vasya, email=vasya<span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru) getting user by id: <span class="hljs-number"><span class="hljs-number">2</span></span> User(id=<span class="hljs-number"><span class="hljs-number">2</span></span>, name=Vasya, email=vasya<span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru) deleting user by id: <span class="hljs-number"><span class="hljs-number">1</span></span> deleting user by id: <span class="hljs-number"><span class="hljs-number">2</span></span> User(id=<span class="hljs-number"><span class="hljs-number">1</span></span>, name=Vasya, email=vasya<span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru) getting user by id: <span class="hljs-number"><span class="hljs-number">2</span></span> javax.persistence.EntityNotFoundException: User not found by id <span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre> <br> æˆ‘ä»¬çœ‹åˆ°åº”ç”¨ç¨‹åºä¸¤æ¬¡éƒ½å®‰å…¨åœ°ä½¿ç”¨äº†getï¼ˆï¼‰æ–¹æ³•ï¼Œå¹¶ä¸”Springç¼“å­˜äº†è¿™äº›å®ä½“ã€‚ æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é€šè¿‡ä¸åŒçš„æ–¹æ³•åˆ é™¤å®ƒä»¬ã€‚ æˆ‘ä»¬ä»¥é€šå¸¸çš„æ–¹å¼åˆ é™¤äº†ç¬¬ä¸€ä¸ªï¼Œå¹¶ä¸”ä¿ç•™äº†ç¼“å­˜çš„å€¼ï¼Œå› æ­¤å½“æˆ‘ä»¬å°è¯•ä½¿ç”¨æˆ·çš„IDä¸º1æ—¶ï¼Œæˆ‘ä»¬æˆåŠŸäº†ã€‚ å½“æˆ‘ä»¬å°è¯•è·å–ç”¨æˆ·2æ—¶ï¼Œè¯¥æ–¹æ³•è¿”å›EntityNotFoundException-ç¼“å­˜ä¸­æ²¡æœ‰æ­¤ç±»ç”¨æˆ·ã€‚ <br><br><h2>  5.åˆ†ç»„è®¾ç½®ã€‚  @ç¼“å­˜ </h2><br> æœ‰æ—¶ï¼Œä¸€ä¸ªæ–¹æ³•éœ€è¦å‡ ä¸ªç¼“å­˜è®¾ç½®ã€‚  @Cachingæ³¨é‡Šç”¨äºè¿™äº›ç›®çš„ã€‚ å®ƒå¯èƒ½çœ‹èµ·æ¥åƒè¿™æ ·ï¼š <br><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Caching</span></span>( cacheable = { <span class="hljs-meta"><span class="hljs-meta">@Cacheable</span></span>(<span class="hljs-string"><span class="hljs-string">"users"</span></span>), <span class="hljs-meta"><span class="hljs-meta">@Cacheable</span></span>(<span class="hljs-string"><span class="hljs-string">"contacts"</span></span>) }, put = { <span class="hljs-meta"><span class="hljs-meta">@CachePut</span></span>(<span class="hljs-string"><span class="hljs-string">"tables"</span></span>), <span class="hljs-meta"><span class="hljs-meta">@CachePut</span></span>(<span class="hljs-string"><span class="hljs-string">"chairs"</span></span>), <span class="hljs-meta"><span class="hljs-meta">@CachePut</span></span>(value = <span class="hljs-string"><span class="hljs-string">"meals"</span></span>, key = <span class="hljs-string"><span class="hljs-string">"#user.email"</span></span>) }, evict = { <span class="hljs-meta"><span class="hljs-meta">@CacheEvict</span></span>(value = <span class="hljs-string"><span class="hljs-string">"services"</span></span>, key = <span class="hljs-string"><span class="hljs-string">"#user.name"</span></span>) } ) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cacheExample</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(User user)</span></span></span><span class="hljs-function"> </span></span>{ }</code> </pre> <br> è¿™æ˜¯å¯¹æ³¨é‡Šè¿›è¡Œåˆ†ç»„çš„å”¯ä¸€æ–¹æ³•ã€‚ å¦‚æœæ‚¨å°è¯•å †ç§¯ç±»ä¼¼ <br><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@CacheEvict</span></span>(<span class="hljs-string"><span class="hljs-string">"users"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@CacheEvict</span></span>(<span class="hljs-string"><span class="hljs-string">"meals"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@CacheEvict</span></span>(<span class="hljs-string"><span class="hljs-string">"contacts"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@CacheEvict</span></span>(<span class="hljs-string"><span class="hljs-string">"tables"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cacheExample</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(User user)</span></span></span><span class="hljs-function"> </span></span>{ }</code> </pre> <br> ç„¶åIDEAä¼šå‘Šè¯‰æ‚¨äº‹å®å¹¶éå¦‚æ­¤ã€‚ <br><br><h2>  6.çµæ´»çš„é…ç½®ã€‚ ç¼“å­˜ç®¡ç†å™¨ </h2><br> æœ€ç»ˆï¼Œæˆ‘ä»¬æ‰¾å‡ºäº†ç¼“å­˜ï¼Œå¯¹æˆ‘ä»¬è€Œè¨€ï¼Œå®ƒä¸å†æ˜¯ä»¤äººéš¾ä»¥ç†è§£å’Œææƒ§çš„ä¸œè¥¿ã€‚ ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹å¹•åæƒ…å†µï¼Œçœ‹çœ‹æˆ‘ä»¬å¦‚ä½•å¤§è‡´é…ç½®ç¼“å­˜ã€‚ <br><br> å¯¹äºæ­¤ç±»ä»»åŠ¡ï¼Œæœ‰ä¸€ä¸ªCacheManagerã€‚ æ— è®ºSpring Cacheåœ¨å“ªé‡Œï¼Œå®ƒéƒ½å­˜åœ¨ã€‚ å½“æˆ‘ä»¬æ·»åŠ @EnableCacheæ‰¹æ³¨æ—¶ï¼ŒSpringå°†è‡ªåŠ¨åˆ›å»ºè¿™æ ·çš„ç¼“å­˜ç®¡ç†å™¨ã€‚ å¦‚æœæˆ‘ä»¬è‡ªåŠ¨åŒ…è£…ApplicationContextå¹¶åœ¨æ–­ç‚¹å¤„å°†å…¶æ‰“å¼€ï¼Œåˆ™å¯ä»¥éªŒè¯è¿™ä¸€ç‚¹ã€‚ é™¤å…¶ä»–binå¤–ï¼Œè¿˜å°†æœ‰ä¸€ä¸ªcacheManager beanã€‚ <br><br><img src="https://habrastorage.org/webt/nc/bn/vp/ncbnvpwm57vw-2i9t7xpaiwr29s.png"><br><br> åœ¨å·²ç»åˆ›å»ºäº†ä¸¤ä¸ªç”¨æˆ·å¹¶å°†å…¶æ”¾å…¥ç¼“å­˜çš„é˜¶æ®µï¼Œæˆ‘åœæ­¢äº†è¯¥åº”ç”¨ç¨‹åºã€‚ å¦‚æœæˆ‘ä»¬é€šè¿‡Evaluate Expressionè°ƒç”¨æ‰€éœ€çš„beanï¼Œæˆ‘ä»¬å°†çœ‹åˆ°ç¡®å®å­˜åœ¨è¿™æ ·çš„beanï¼Œå®ƒå…·æœ‰ä¸€ä¸ªå¸¦æœ‰â€œ usersâ€é”®çš„ConcurentMapCacheå’Œå€¼ConcurrentHashMapï¼Œè¯¥å€¼å·²ç»åŒ…å«äº†ç¼“å­˜çš„ç”¨æˆ·ã€‚ <br><br><img src="https://habrastorage.org/webt/7-/xt/s9/7-xts9jrjipidhtsls1nv4gr2o0.png"><br><br> åè¿‡æ¥ï¼Œæˆ‘ä»¬å¯ä»¥ä¸Habrå’Œç¨‹åºå‘˜ä¸€èµ·åˆ›å»ºæˆ‘ä»¬çš„ç¼“å­˜ç®¡ç†å™¨ï¼Œç„¶åæ ¹æ®è‡ªå·±çš„å–œå¥½å¯¹å…¶è¿›è¡Œå¾®è°ƒã€‚ <br><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span>(<span class="hljs-string"><span class="hljs-string">"habrCacheManager"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> CacheManager </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cacheManager</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; }</code> </pre> <br> å‰©ä¸‹çš„åªæ˜¯é€‰æ‹©æˆ‘ä»¬å°†ä½¿ç”¨çš„ç¼“å­˜ç®¡ç†å™¨ï¼Œå› ä¸ºå…¶ä¸­æœ‰å¾ˆå¤šã€‚ æˆ‘ä¸ä¼šåˆ—å‡ºæ‰€æœ‰çš„ç¼“å­˜ç®¡ç†å™¨ï¼Œåªè¦çŸ¥é“æœ‰è¿™æ ·çš„å†…å®¹å°±è¶³å¤Ÿäº†ï¼š <br><br><ul><li>  <i><b>SimpleCacheManager</b></i>æ˜¯æœ€ç®€å•çš„ç¼“å­˜ç®¡ç†å™¨ï¼Œä¾¿äºå­¦ä¹ å’Œæµ‹è¯•ã€‚ </li><li>  <i><b>ConcurrentMapCacheManager-</b></i>æ‡’æƒ°åœ°åˆå§‹åŒ–æ¯ä¸ªè¯·æ±‚çš„è¿”å›å®ä¾‹ã€‚ è¿˜å»ºè®®æ‚¨æµ‹è¯•å’Œå­¦ä¹ å¦‚ä½•ä½¿ç”¨ç¼“å­˜ä»¥åŠä¸€äº›è¯¸å¦‚æˆ‘ä»¬è¿™æ ·çš„ç®€å•æ“ä½œã€‚ ä¸ºäº†è®¤çœŸå¤„ç†ç¼“å­˜ï¼Œå»ºè®®ä½¿ç”¨ä»¥ä¸‹å®ç°ã€‚ </li><li>  <i><b>JCacheCacheManager</b></i> ï¼Œ <i><b>EhCacheCacheManager</b></i> ï¼Œ <i><b>CaffeineCacheManager</b></i>æ˜¯è®¤çœŸçš„â€œåˆä½œä¼™ä¼´â€ç¼“å­˜ç®¡ç†å™¨ï¼Œå¯ä»¥çµæ´»åœ°è‡ªå®šä¹‰å¹¶æ‰§è¡Œå„ç§åŠ¨ä½œçš„ä»»åŠ¡ã€‚ </li></ul><br> ä½œä¸ºæˆ‘çš„è°¦è™šæ–‡ç« çš„ä¸€éƒ¨åˆ†ï¼Œæˆ‘å°†ä¸ä»‹ç»æœ€åä¸‰ä¸ªçš„ç¼“å­˜ç®¡ç†å™¨ã€‚ ç›¸åï¼Œæˆ‘ä»¬å°†ä»¥ConcurrentMapCacheManagerä¸ºä¾‹ï¼Œä»‹ç»è®¾ç½®ç¼“å­˜ç®¡ç†å™¨çš„å‡ ä¸ªæ–¹é¢ã€‚ <br><br> å› æ­¤ï¼Œè®©æˆ‘ä»¬é‡æ–°åˆ›å»ºæˆ‘ä»¬çš„ç¼“å­˜ç®¡ç†å™¨ã€‚ <br><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span>(<span class="hljs-string"><span class="hljs-string">"habrCacheManager"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> CacheManager </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cacheManager</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConcurrentMapCacheManager(); }</code> </pre> <br> æˆ‘ä»¬çš„ç¼“å­˜ç®¡ç†å™¨å·²å‡†å¤‡å°±ç»ªã€‚ <br><br><h2>  7.ç¼“å­˜è®¾ç½®ã€‚ ä½¿ç”¨å¯¿å‘½ï¼Œæœ€å¤§å°ºå¯¸ç­‰ã€‚ </h2><br> ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªç›¸å½“æµè¡Œçš„Google Guavaåº“ã€‚ æˆ‘æ‹¿äº†æœ€åä¸€ä¸ªã€‚ <br><br><pre> <code class="java hljs">compile group: <span class="hljs-string"><span class="hljs-string">'com.google.guava'</span></span>, name: <span class="hljs-string"><span class="hljs-string">'guava'</span></span>, version: <span class="hljs-string"><span class="hljs-string">'28.1-jre'</span></span></code> </pre> <br> åˆ›å»ºç¼“å­˜ç®¡ç†å™¨æ—¶ï¼Œæˆ‘ä»¬å°†è¦†ç›–createConcurrentMapCacheæ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å°†ä»Guavaè°ƒç”¨CacheBuilderã€‚ åœ¨æ­¤è¿‡ç¨‹ä¸­ï¼Œå°†è¦æ±‚æˆ‘ä»¬é€šè¿‡åˆå§‹åŒ–ä»¥ä¸‹æ–¹æ³•æ¥é…ç½®ç¼“å­˜ç®¡ç†å™¨ï¼š <br><br><ul><li>  maximumSize-ç¼“å­˜å¯ä»¥åŒ…å«çš„å€¼çš„æœ€å¤§å¤§å°ã€‚ ä½¿ç”¨æ­¤å‚æ•°ï¼Œæ‚¨å¯ä»¥å°è¯•åœ¨æ•°æ®åº“è´Ÿè½½å’ŒJVM RAMä¹‹é—´æ‰¾åˆ°æŠ˜è¡·æ–¹æ¡ˆã€‚ </li><li>  refreshAfterWrite-å°†å€¼å†™å…¥é«˜é€Ÿç¼“å­˜ä¹‹åçš„æ—¶é—´ï¼Œä¹‹åå®ƒå°†è‡ªåŠ¨æ›´æ–°ã€‚ </li><li>  expireAfterAccess-å€¼çš„æœ€åä¸€æ¬¡è°ƒç”¨åçš„ç”Ÿå­˜æœŸã€‚ </li><li>  expireAfterWrite-å†™å…¥ç¼“å­˜åå€¼çš„ç”Ÿå­˜æœŸã€‚ è¿™æ˜¯æˆ‘ä»¬å°†å®šä¹‰çš„å‚æ•°ã€‚ </li></ul><br> å’Œå…¶ä»–ã€‚ <br><br> æˆ‘ä»¬åœ¨ç»ç†ä¸­å®šä¹‰è®°å½•çš„ç”Ÿå­˜æœŸã€‚ ä¸ºäº†ä¸é•¿æ—¶é—´ç­‰å¾…ï¼Œè¯·è®¾ç½®1ç§’ã€‚ <br><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span>(<span class="hljs-string"><span class="hljs-string">"habrCacheManager"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> CacheManager </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cacheManager</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConcurrentMapCacheManager() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> Cache </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createConcurrentMapCache</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConcurrentMapCache( name, CacheBuilder.newBuilder() .expireAfterWrite(<span class="hljs-number"><span class="hljs-number">1</span></span>, TimeUnit.SECONDS) .build().asMap(), <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); } }; }</code> </pre> <br> æˆ‘ä»¬ç¼–å†™ä¸è¿™ç§æƒ…å†µç›¸å¯¹åº”çš„æµ‹è¯•ã€‚ <br><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkSettings</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> InterruptedException </span></span>{ User user1 = service.createOrReturnCached(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User(<span class="hljs-string"><span class="hljs-string">"Vasya"</span></span>, <span class="hljs-string"><span class="hljs-string">"vasya@mail.ru"</span></span>)); log.info(<span class="hljs-string"><span class="hljs-string">"{}"</span></span>, service.get(user1.getId())); User user2 = service.createOrReturnCached(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User(<span class="hljs-string"><span class="hljs-string">"Vasya"</span></span>, <span class="hljs-string"><span class="hljs-string">"vasya@mail.ru"</span></span>)); log.info(<span class="hljs-string"><span class="hljs-string">"{}"</span></span>, service.get(user2.getId())); Thread.sleep(<span class="hljs-number"><span class="hljs-number">1000L</span></span>); User user3 = service.createOrReturnCached(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User(<span class="hljs-string"><span class="hljs-string">"Vasya"</span></span>, <span class="hljs-string"><span class="hljs-string">"vasya@mail.ru"</span></span>)); log.info(<span class="hljs-string"><span class="hljs-string">"{}"</span></span>, service.get(user3.getId())); }</code> </pre> <br> æˆ‘ä»¬å°†å‡ ä¸ªå€¼ä¿å­˜åˆ°æ•°æ®åº“ä¸­ï¼Œå¦‚æœæ•°æ®è¢«ç¼“å­˜ï¼Œåˆ™ä¸ä¿å­˜ä»»ä½•å†…å®¹ã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬ä¿å­˜ä¸¤ä¸ªå€¼ï¼Œç„¶åç­‰å¾…1ç§’é’Ÿï¼Œç›´åˆ°ç¼“å­˜å¤±æ•ˆï¼Œç„¶åå†ä¿å­˜å¦ä¸€ä¸ªå€¼ã€‚ <br><br><pre> <code class="java hljs">creating user: User(id=<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, name=Vasya, email=vasya<span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru) getting user by id: <span class="hljs-number"><span class="hljs-number">1</span></span> User(id=<span class="hljs-number"><span class="hljs-number">1</span></span>, name=Vasya, email=vasya<span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru) User(id=<span class="hljs-number"><span class="hljs-number">1</span></span>, name=Vasya, email=vasya<span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru) creating user: User(id=<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, name=Vasya, email=vasya<span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru) getting user by id: <span class="hljs-number"><span class="hljs-number">2</span></span> User(id=<span class="hljs-number"><span class="hljs-number">2</span></span>, name=Vasya, email=vasya<span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru)</code> </pre> <br> æ—¥å¿—æ˜¾ç¤ºï¼Œé¦–å…ˆæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªç”¨æˆ·ï¼Œç„¶åå°è¯•äº†å¦ä¸€ä¸ªç”¨æˆ·ï¼Œä½†æ˜¯ç”±äºæ•°æ®å·²ç¼“å­˜ï¼Œå› æ­¤æˆ‘ä»¬ä»ç¼“å­˜ä¸­è·å–æ•°æ®ï¼ˆåœ¨ä¸¤ç§æƒ…å†µä¸‹ï¼Œå½“ä¿å­˜æ—¶å’Œä»æ•°æ®åº“è·å–æ—¶ï¼‰ã€‚ ç„¶åï¼Œé«˜é€Ÿç¼“å­˜å˜åäº†ï¼Œå› ä¸ºä¸€æ¡è®°å½•å‘Šè¯‰æˆ‘ä»¬æœ‰å…³ç”¨æˆ·çš„å®é™…ä¿å­˜å’Œå®é™…æ¥æ”¶çš„ä¿¡æ¯ã€‚ <br><br><h2>  8.æ€»ç»“ </h2><br> è¿Ÿæ—©ï¼Œå¼€å‘äººå‘˜éƒ½éœ€è¦åœ¨é¡¹ç›®ä¸­å®ç°ç¼“å­˜ã€‚ æˆ‘å¸Œæœ›æœ¬æ–‡èƒ½å¸®åŠ©æ‚¨ç†è§£ä¸»é¢˜å¹¶å¤§èƒ†åœ°ç ”ç©¶ç¼“å­˜é—®é¢˜ã€‚ <br><br> è¯¥é¡¹ç›®çš„Githubåœ¨è¿™é‡Œï¼š <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https</a> : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">//github.com/promoscow/cache</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN465667/">https://habr.com/ru/post/zh-CN465667/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN465655/index.html">OpenStreetMapç¬¬474å·ä¸–ç•Œæ–°é—»ï¼ˆ08/13/2019-08/08/2019ï¼‰</a></li>
<li><a href="../zh-CN465657/index.html">å¸•é‡‘æ£®å®šå¾‹ï¼šå¯ä»¥å‡»è´¥å®ƒ</a></li>
<li><a href="../zh-CN465659/index.html">å¯¹æ–‡ç« â€œè«æ–¯ç§‘äººå¾æœè¥¿ä¼¯åˆ©äºšâ€ï¼Œæˆ–äºŒåå¹´åçš„å›åº”</a></li>
<li><a href="../zh-CN465661/index.html">ä½ ä¹Ÿæœ‰è¿™æ ·çš„æœ‹å‹å—ï¼Ÿ ä¹Ÿè®¸æ˜¯ä½ ï¼Ÿ</a></li>
<li><a href="../zh-CN465663/index.html">Superjob APIå¸¸è§é—®é¢˜è§£ç­”ï¼ˆæ±‚èŒå‘å¸ƒï¼‰</a></li>
<li><a href="../zh-CN465669/index.html">è®¡ç®—åº”ç”¨ç¨‹åºä¸­çš„ä¸‹è½½é€Ÿåº¦</a></li>
<li><a href="../zh-CN465673/index.html">Hedi Lamarrï¼šå¥½è±åçš„å‘æ˜å®¶</a></li>
<li><a href="../zh-CN465675/index.html">NASAå¦‚ä½•å…³å¿ƒå®‡èˆªå‘˜çš„å®‰å…¨å’Œæƒ…æŠ¥</a></li>
<li><a href="../zh-CN465677/index.html">å¿˜æ‰éšèº«å¬å§ï¼ä¸€åˆ‡éƒ½ä¸è€³æœºæœ‰å…³</a></li>
<li><a href="../zh-CN465679/index.html">æ‰‹è¡¨é™¤äº†æ˜¾ç¤ºæ—¶é—´å¤–è¿˜å¯ä»¥åšä»€ä¹ˆï¼Œä»¥åŠå¦‚ä½•é€‰æ‹©æ‚¨çš„ç¬¬ä¸€åªæ‰‹è¡¨</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>