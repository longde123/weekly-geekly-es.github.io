<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤛🏻 💂🏼 🏡 Preparándose para investigar incidentes 🚜 💪🏻 🥧</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="¿Es posible defenderse completamente contra los ciberataques? Probablemente, puede hacerlo si se rodea de todos los medios de protección existentes y ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Preparándose para investigar incidentes</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/solarsecurity/blog/434176/">  ¿Es posible defenderse completamente contra los ciberataques?  Probablemente, puede hacerlo si se rodea de todos los medios de protección existentes y contrata a un gran equipo de expertos para administrar los procesos.  Sin embargo, está claro que en realidad esto es imposible: el presupuesto para la seguridad de la información no es infinito y, sin embargo, se producirán incidentes.  Y dado que sucederán, ¡entonces debes prepararte para ellos! <br><br>  En este artículo, compartiremos escenarios típicos para investigar incidentes de malware, nos dirá qué buscar en los registros y daremos recomendaciones técnicas sobre cómo configurar las herramientas de protección de información para aumentar las posibilidades de éxito de una investigación. <br><br><img src="https://habrastorage.org/webt/hn/iv/ok/hnivokrrsyt91yvpfegy98-ywnm.jpeg"><br><a name="habracut"></a><br>  El proceso clásico para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">responder a un incidente</a> relacionado con malware involucra etapas como detección, contención, recuperación, etc., sin embargo, todas sus capacidades, de hecho, se determinan en la etapa de preparación.  Por ejemplo, la tasa de detección de infecciones depende directamente de qué tan bien esté configurada la auditoría en la empresa. <br><br><img src="https://habrastorage.org/webt/8e/hx/ex/8ehxexj-t_ixnm4e87y9joqxskq.png"><br>  <i>Ciclo de respuesta a incidentes SANS clásico</i> <i><br></i> <br>  En términos generales, las acciones de los analistas durante la investigación son las siguientes: <br><br><ol><li>  Generación de versiones que explican las causas del incidente (por ejemplo, "el malware se instaló en el host porque el usuario lo lanzó desde un correo electrónico de phishing" o "el incidente es una falsa alarma porque el usuario visitó un sitio legítimo ubicado en el mismo alojamiento que el servidor de administración malware "). </li><li>  Priorización de versiones por grado de probabilidad.  La probabilidad se calcula (pero más bien se finge) en base a estadísticas de incidentes pasados, la criticidad del incidente o sistema, y ​​también en base a la experiencia personal. </li><li>  Estudio de cada versión, búsqueda de hechos que lo prueben o refuten. </li></ol><br>  Por supuesto, no tiene sentido probar todas las hipótesis posibles, al menos porque el tiempo es limitado.  Por lo tanto, aquí veremos las versiones más probables y los escenarios típicos para investigar incidentes de malware. <br><br><h4>  Escenario 1 </h4><blockquote>  Sospecha que un sistema no crítico ha sido comprometido por malware.  Debido a la naturaleza acrítica del sistema, se ha asignado un poco de tiempo para la verificación. </blockquote> Lo primero que hacen la mayoría de los ingenieros de respuesta es ejecutar una verificación antivirus.  Sin embargo, como sabemos, un antivirus no es tan difícil de manejar.  Por lo tanto, vale la pena generar y desarrollar la siguiente versión altamente probable: el malware es un archivo o servicio ejecutable separado. <br><br>  Como parte del desarrollo de esta versión, hay tres pasos simples a seguir: <br><br><ol><li>  Filtre el registro de seguridad por evento 4688, de modo que obtengamos una lista de todos los procesos que comenzaron. </li><li>  Filtre el registro del sistema por evento 7045, de modo que obtengamos una lista de las instalaciones de todos los servicios. </li><li>  Identifique nuevos procesos y servicios que no estaban previamente en el sistema.  Copie estos módulos y analícelos en busca de código malicioso (escanee con varios antivirus, verifique la validez de la firma digital, descompile el código, etc.). </li></ol><br><img src="https://habrastorage.org/webt/wn/u4/rj/wnu4rj_nt8ywqt0ibh4ih-5amfa.png"><br>  <i>Enumere todos los procesos y servicios en ejecución en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Event Log Explorer</a></i> <i><br></i> <br>  En teoría, este es un proceso bastante trivial.  Sin embargo, en la práctica hay una serie de dificultades para las que hay que estar preparado. <br><br>  En primer lugar, la configuración de auditoría estándar de Windows no registra los hechos del inicio del proceso (evento 4688), por lo que debe habilitarse por adelantado en la política de grupo de dominio.  Si sucedió que esta auditoría no se incluyó de antemano, puede intentar obtener una lista de archivos ejecutables de otros artefactos de Windows, por ejemplo, del registro de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Amcache</a> .  Puede <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">extraer</a> datos de este archivo de registro utilizando la utilidad <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">AmcaheParser</a> . <br><br><img src="https://habrastorage.org/webt/qs/gz/xt/qsgzxtirmjybxie6cvjzz3_w2g4.png"><br>  <i>Un ejemplo de extracción de los hechos de los procesos de inicio de Amcache.hve</i> <i><br></i> <br>  Sin embargo, este método no es muy confiable, ya que no proporciona información precisa sobre cuándo exactamente y cuántas veces se inició el proceso. <br><br>  En segundo lugar, la evidencia del lanzamiento de procesos como <i>cmd.exe, powershell.exe, wscript.exe</i> y otros intérpretes será de poca utilidad sin información sobre la línea de comandos con la que se iniciaron los procesos, porque  contiene la ruta a un archivo de script potencialmente malicioso. <br><br><img src="https://habrastorage.org/webt/rh/-m/cw/rh-mcwpnaxnlrquvuexzk8pcp4w.png"><br>  <i>Ejecutar el intérprete de guiones sin información sobre qué guión se lanzó</i> <i><br></i> <br>  Otra característica de Windows es que la auditoría de la línea de comandos del proceso iniciado se realiza configurando por separado la política de grupo de dominio: <i>Configuración de la computadora -&gt; Políticas -&gt; Plantillas administrativas -&gt; Sistema -&gt; Auditoría Creación de procesos -&gt; Incluir línea de comandos en eventos de creación de procesos</i> .  Al mismo tiempo, el popular Windows 7/2008 no registra la línea de comandos sin la actualización <i>KB3004375 instalada</i> , así que póngala con anticipación. <br><br>  Si sucedió que no configuró nada por adelantado u olvidó la actualización, puede intentar averiguar la ubicación del script en los archivos de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Prefetch</a> (una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">utilidad para ayudar</a> ).  Contienen información sobre todos los archivos (principalmente DLL) cargados en el proceso en los primeros 10 segundos de vida.  Y el guión contenido en los argumentos de la línea de comandos del intérprete seguramente estará presente allí. <br><br><img src="https://habrastorage.org/webt/kw/ld/jv/kwldjvh_gxvl87jucac-4k7kezg.png"><br>  <i>Ejemplo de encontrar un argumento de línea de comando "perdido" en Prefetch</i> <i><br></i> <br>  Pero este método no es del todo confiable: la próxima vez que inicie el proceso, se sobrescribirá el caché Prefetch. <br><br>  <b>Preparación para la investigación:</b> <b><br></b> <br><ul><li>  Incluya una auditoría avanzada de la <a href="">creación</a> y finalización de procesos. </li><li>  Habilite el registro de argumentos de la línea de comandos del proceso. </li><li>  Instale la actualización KB3004375 en Windows 7 / Server 2008. </li></ul><br><br><h4>  Escenario 2 </h4><blockquote>  Se registró un acceso al servidor de administración de malware en el enrutador perimetral.  La dirección IP del servidor malicioso se obtuvo de una suscripción de inteligencia de amenazas de seguridad media. </blockquote>  En <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">uno de nuestros artículos anteriores,</a> dijimos que los analistas de TI pecan al agregar a las listas de indicadores de direcciones IP de compromiso de servidores que alojan centros de control de malware y sitios web legítimos al mismo tiempo.  Si acaba de comenzar a formular procesos de respuesta, en las primeras etapas es mejor abandonar el uso de dichos indicadores, porque cada intento de un usuario de ingresar a un sitio web legítimo se verá como un incidente completo. <br><br>  Una de las opciones para responder a tales alarmas puede reducirse a verificar qué proceso realizó la conexión: si se trata de un navegador de Internet, en ausencia de otros hechos que indiquen compromiso, el incidente puede considerarse una falsa alarma. <br><br>  Hay muchas formas de averiguar qué proceso inició la conexión: puede ejecutar <i>netstat</i> y ver los sockets actuales o recopilar un volcado de memoria y luego configurar la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">volatilidad</a> en él, que también puede mostrar conexiones ya completadas.  Pero todo esto es largo, no escalable y lo más importante, no es confiable.  Es mucho más confiable obtener toda la información necesaria del registro de seguridad de Windows. <br><br><img src="https://habrastorage.org/webt/lj/vd/hk/ljvdhkraffowzrs1trqurriawo0.png"><br>  <i>Correlación del evento de "acceso a direcciones IP maliciosas" en el sistema HPE Arcsight SIEM y el proceso correspondiente en el registro de seguridad de Windows</i> <i><br></i> <br>  <b>Preparación de investigación</b> <b><br></b> <br>  Para resolver este escenario en una máquina de usuario, debe habilitar el registro de todas las conexiones de red al registro de seguridad.  Esto se puede hacer en función de los eventos de <a href="">auditoría</a> de <a href="">la plataforma de filtrado</a> y la <a href="">auditoría de descarte de paquetes</a> . <br><br>  Al mismo tiempo, la revista puede comenzar a atascarse rápidamente, así que aumente su tamaño a 2-3 GB.  En nuestra experiencia, en un host de usuario normal, esta cantidad es suficiente durante aproximadamente 3 días para registrar todos los sockets, y este período es suficiente para una investigación exitosa. <br><br>  En servidores altamente cargados, como controladores de dominio, servidores web, etc., no debe hacer esto, el registro se desbordará mucho más rápido. <br><br><h4>  Escenario 3 </h4><blockquote>  Su sistema de detección de anomalías NG / ML / Anti-APT informa que 30 hosts están explorando para obtener las mismas cuentas. <br><br><img src="https://habrastorage.org/webt/mf/wm/ew/mfwmewn7w-zrx33cf1t5jp-w4vm.png"></blockquote>  Cuando ingresan a una nueva red, los atacantes generalmente intentan averiguar qué servicios están presentes en ella y qué cuentas se usan; esto ayuda mucho en el proceso de un mayor movimiento a lo largo de la infraestructura.  En particular, esta información se puede obtener de Active Directory usando el comando <i>net user / domain</i> . <br><br>  Si la inteligencia potencial se lleva a cabo desde un host, puede investigarse, incluido el uso de los registros de los procesos en ejecución.  Sin embargo, si hay muchos hosts y los ataques son del mismo tipo (ocurrieron al mismo tiempo o se solicitó el mismo conjunto de entidades de AD), entonces tiene sentido, en primer lugar, excluir un falso positivo típico.  Para hacer esto, cree y verifique las siguientes versiones: <br><br><ol><li>  La inteligencia se fija en 30 hosts para los mismos objetos AD porque el usuario legítimo de la <i>red</i> , el administrador, lanzó el comando <i>net</i> . </li><li>  La inteligencia se repara en 30 hosts para los mismos objetos AD, porque creó el mismo software legítimo. </li></ol><br>  El análisis estadístico de los registros ayudará a encontrar estos puntos nodales (un usuario o proceso común).  Demostramos este método en un artículo anterior aplicado a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">los registros del servidor DNS</a> .  Sin embargo, tales métodos de investigación efectivos no pueden usarse si el almacenamiento de datos no se organizó de antemano. <br><br>  <b>Preparación de investigación</b> <b><br></b> <br>  Es necesario organizar el almacenamiento a largo plazo de al menos los siguientes datos de los registros de servicios de red comunes: <br><br><ul><li>  Controladores de dominio: entradas, salidas de cuentas y emisión de tickets Kerberos (categoría <a href="">Inicio de sesión de cuenta</a> en la configuración avanzada de auditoría). </li><li>  Proxies: direcciones, puertos de origen y de servidor externo, así como la URL completa. </li><li>  Servidores DNS: consultas DNS exitosas y no exitosas y su fuente dentro de la red. </li><li>  Enrutadores perimetrales: construidos y desmontables para todas las conexiones TCP / UDP, así como conexiones que intentan romper las reglas de acceso lógico: por ejemplo, intenta enviar una consulta DNS directamente al exterior, sin pasar por el servidor DNS corporativo. </li></ul><br><h4>  Escenario 4 </h4><blockquote>  Su dominio se ha visto comprometido y le preocupa que un atacante pueda establecerse en la infraestructura utilizando la técnica DCShadow. </blockquote><img align="right" src="https://habrastorage.org/webt/v-/uc/lo/v-uclovamv5zqf2hbyc44towvbs.png">  Supongamos que sucede algo terrible: encuentra que la cuenta del administrador del dominio se ha visto comprometida. <br><br>  Responder a un incidente de este tipo incluye una capa de trabajo muy grande, que incluye un análisis de todas las acciones cometidas en virtud de esta cuenta.  Parte de esta investigación se puede hacer utilizando solo los registros del controlador de dominio.  Por ejemplo, puede estudiar los eventos asociados con la emisión de tickets de Kerberos para comprender de dónde fueron con esta cuenta.  O puede analizar los eventos asociados con el cambio de objetos AD críticos para verificar si la composición de los grupos altamente privilegiados (los mismos administradores de dominio) ha cambiado.  Naturalmente, todo esto requiere una auditoría preconfigurada. <br><br>  Sin embargo, existe el problema de que un atacante con derechos de administrador de dominio puede modificar objetos AD utilizando la técnica DCShadow, que se basa en el mecanismo de replicación entre controladores de dominio. <br><br>  Su esencia es que el propio atacante parece ser un controlador de dominio, realiza cambios en AD y luego replica (sincroniza) estos cambios con controladores legítimos, evitando así la auditoría de los cambios de objetos configurados en ellos.  El resultado de tal ataque puede ser agregar un usuario a un grupo de administradores de dominio o enlaces más complicados al cambiar el atributo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Historial de SID</a> o al modificar el objeto ACL <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">AdminSDHolder</a> . <br><br>  Para verificar la versión sobre la presencia de cambios no confirmados en AD, debe estudiar los registros de replicación del controlador: si las direcciones IP distintas de los controladores de dominio estuvieron involucradas en la replicación, puede decir con gran confianza que el ataque fue exitoso. <br><br><img src="https://habrastorage.org/webt/mj/b0/td/mjb0tddd6rne92qbmeop1av4dzi.png"><br>  <i>Eliminar un controlador de dominio desconocido de la replicación de AD</i> <br><br>  <b>Preparación para la investigación:</b> <br><br><ul><li>  Para investigar acciones cometidas por una cuenta comprometida, debe incluir de antemano: <br><ul><li>  Auditoría de entradas y salidas de cuentas y emisión de tickets de Kerberos (categoría de <a href="">inicio de sesión de cuenta</a> en configuraciones de auditoría avanzadas). </li><li>  Auditoría de cambios en cuentas y grupos (categoría <a href="">Gestión de cuentas</a> ). </li></ul></li><li>  Para investigar versiones relacionadas con posibles ataques DCShadow: <br><ul><li>  Habilite la auditoría detallada <a href="">de la replicación del servicio de directorio</a> . </li><li>  Organice el almacenamiento a largo plazo de eventos 4928/4929, en los que el origen del evento no sea un controlador de dominio legítimo (atributo DCShadow). </li></ul></li></ul><br><h4>  Conclusión </h4><br>  En este artículo, hablamos sobre algunos escenarios típicos para investigar incidentes de seguridad de la información y medidas para su preparación preventiva.  Si está interesado en este tema y está listo para ir más allá, le recomiendo que preste atención a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">este documento</a> , que describe en qué eventos de Windows puede encontrar rastros del uso de técnicas de piratería populares. <br><br>  Me gustaría terminar con una cita de un estudio reciente de una empresa de seguridad cibernética: <blockquote>  “En su mayor parte, los directores rusos de seguridad de la información tienden a dar respuestas pesimistas [a las preguntas de investigación].  Por lo tanto, la mitad (48%) cree que el presupuesto no cambiará de ninguna manera, y el 15% piensa que se reducirán los fondos ". </blockquote>  Para mí personalmente, esto es una señal de que el presupuesto restante en el nuevo año se gasta mejor no en comprar SZI de última generación como detectores de Machine Learning, otros IDS de próxima generación, etc., sino en afinar aquellos SZI que ya existen.  Y el mejor SZI está configurado correctamente en los registros de Windows.  En mi humilde opinión. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es434176/">https://habr.com/ru/post/es434176/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es434166/index.html">Lenovo YogaBook C930: un dispositivo que reemplaza cuatro dispositivos a la vez</a></li>
<li><a href="../es434168/index.html">Entrevista con el Jefe del Centro de Competencia .NET en DotNext 2018</a></li>
<li><a href="../es434170/index.html">Cómo se creó el sonido en Pathfinder: Kingmaker</a></li>
<li><a href="../es434172/index.html">Buscando al asesino en Prolog</a></li>
<li><a href="../es434174/index.html">Genética del cultivar románico: un modelo matemático fractal de expresión génica</a></li>
<li><a href="../es434178/index.html">Cómo un proveedor de servicios hizo su Service Desk</a></li>
<li><a href="../es434180/index.html">Revisión droidcon SF</a></li>
<li><a href="../es434182/index.html">La impresión por chorro de tinta como una de las áreas de dinámica de fluidos aplicados</a></li>
<li><a href="../es434184/index.html">Cómo hacer amigos Alice y HomeBridge</a></li>
<li><a href="../es434186/index.html">Meta-selección: qué publicaciones extranjeras se aconseja dar en vacaciones</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>