<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>⏫ 📻 👨🏾‍⚖️ So verbinden Sie GitLab und Pantheon und optimieren Drupal- und WordPress-Workflows 👨🏽‍🤝‍👨🏼 🔋 ⛸️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Unser Gast, Entwickler der Pantheon-Entwicklertools, spricht darüber, wie WordPress-Bereitstellungen mithilfe von GitLab CI / CD automatisiert werden ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>So verbinden Sie GitLab und Pantheon und optimieren Drupal- und WordPress-Workflows</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/southbridge/blog/447966/"><p><img src="https://habrastorage.org/webt/ja/h2/ef/jah2efouevm2la2v9vkt3vuojm8.png"></p><br><p>  Unser Gast, Entwickler der Pantheon-Entwicklertools, spricht darüber, wie WordPress-Bereitstellungen mithilfe von GitLab CI / CD automatisiert werden können. </p><br><p>  Bei <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Pantheon beschäftige</a> ich mich mit Entwicklerbeziehungen, daher suche ich immer nach neuen Wegen, um WordPress- und Drupal-Entwicklern bei der Lösung von Automatisierungsproblemen in ihren Workflows zu helfen.  Dazu experimentiere ich gerne mit neuen Werkzeugen und kombiniere sie für eine effektive Arbeit miteinander. </p><br><p>  <strong>Ich sehe oft Entwickler, die mit einem einzigen Entwicklungsserver gequält werden.</strong> </p><br><p> So lala Spaß - warten Sie, bis Sie an der Reihe sind, einen Server zu verwenden, oder senden Sie Clients eine URL mit dem Hinweis: "Schauen Sie hier, aber nicht hier." </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Multidev-Umgebungen</a> - eines der coolen Tools von Pantheon - lösen dieses Problem, da Sie mit ihnen auf Anfrage Umgebungen für Git-Zweige erstellen können.  Jede Multidev-Umgebung verfügt über eine eigene URL und Datenbank, sodass die Entwickler leise arbeiten, die Qualität überprüfen und die Genehmigung erhalten, ohne sich gegenseitig auf die Fersen zu treten. </p><br><p>  Pantheon verfügt jedoch über keine Tools für die Versionskontrolle oder die kontinuierliche Integration und Bereitstellung (CI / CD).  Dies ist jedoch eine flexible Plattform, in die Sie alle Tools integrieren können. </p><br><p>  <strong>Mir ist auch aufgefallen, dass für die Entwicklung des Teams ein Tool und für die Montage und Bereitstellung andere verwendet werden.</strong> </p><br><p>  Zum Beispiel haben sie verschiedene Tools für die Versionskontrolle und CI / CD.  Sie müssen herumspielen und zwischen den Tools wechseln, um den Code zu bearbeiten und Probleme zu diagnostizieren. </p><a name="habracut"></a><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">GitLab</a> verfügt über ein umfassendes Set an Entwicklungstools: für Versionskontrolle, Tickets, Zusammenführungsanforderungen, die beste CI / CD-Pipeline der Klasse, ein Containerregister und all diese Dinge.  Ich bin nicht auf Anwendungen gestoßen, in denen der Entwicklungsworkflow so viel zu verwalten wäre. </p><br><p>  Ich liebe die Automatisierung, daher habe ich gelernt, wie man Pantheon mit GitLab verbindet, damit Commits für den Hauptzweig von GitLab in der Hauptentwicklungsumgebung von Pantheon bereitgestellt werden.  Durch das Zusammenführen von Anforderungen in GitLab können Code in Multidev-Umgebungen in Pantheon erstellt und bereitgestellt werden. </p><br><p>  In diesem Handbuch zeige ich Ihnen, wie Sie eine Verbindung zwischen GitLab und Pantheon herstellen und Ihren WordPress- und Drupal-Workflow optimieren. </p><br><p>  Sie können natürlich <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">das GitLab-Repository spiegeln</a> , aber wir werden alles mit Stiften tun, um in <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">GitLab CI</a> zu graben und dieses Tool nicht nur für die zukünftige Bereitstellung zu verwenden. </p><br><h3 id="vvedenie">  Einführung </h3><br><p>  Für diesen Beitrag müssen Sie verstehen, dass Pantheon jede Site in drei Elemente unterteilt: Code, Datenbank und Dateien. </p><br><p>  Der Code enthält CMS-Dateien wie den Kernel, Plugins und WordPress-Themes.  Diese Dateien werden im von Pantheon gehosteten <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Git-Repository</a> verwaltet, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">dh</a> wir können mit Git Code von GitLab nach Pantheon bereitstellen. <br>  Dateien im Pantheon werden als Mediendateien bezeichnet, dh Bilder für die Site.  Normalerweise werden sie von Benutzern heruntergeladen und von Git ignoriert. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Erstellen Sie ein kostenloses Konto</a> , erfahren Sie mehr über <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">den Workflow</a> von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Pantheon</a> oder <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">melden Sie sich</a> bei pantheon.io <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">für eine Demo</a> an. </p><br><h3 id="predpolozheniya">  Annahmen </h3><br><p> Mein Projekt auf Pantheon und GitLab heißt <code>pantheon-gitlab-blog-demo</code> .  Der Name des Projekts muss eindeutig sein.  Hier werden wir mit der WordPress-Site arbeiten.  Sie können Drupal nehmen, aber Sie müssen etwas ändern. </p><br><p>  Ich werde die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Git-Befehlszeile verwenden</a> , und Sie können in der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">GUI arbeiten,</a> wenn Sie möchten. </p><br><h3 id="sozdaem-proekt">  Erstellen Sie ein Projekt </h3><br><p>  Erstellen Sie zunächst <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ein GitLab-Projekt</a> (wir werden darauf zurückkommen). </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Erstellen Sie</a> jetzt <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">eine WordPress-Site im Pantheon</a> .  Installieren Sie dann WordPress für die Dashboard-Site. </p><br><blockquote>  Wenn Ihre Hände jucken, ändern Sie etwas, entfernen Sie beispielsweise Plugins und fügen Sie sie hinzu. Seien Sie geduldig.  Die Site ist noch nicht mit GitLab verbunden, und wir möchten, dass alle Codeänderungen über GitLab erfolgen. </blockquote><p>  Wenn wir WordPress installieren, kehren wir zum Pantheon-Website-Dashboard zurück und ändern den Entwicklungsmodus in Git. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/up/zf/50/upzf50ocuma107rer9uxiybvjnc.png"></a> </p><br><h3 id="nachalnyy-kommit-na-gitlab">  GitLab Initial Commit </h3><br><p>  Jetzt müssen Sie den anfänglichen WordPress-Code von der Pantheon-Website auf GitLab übertragen.  Dazu klonen wir den Code lokal aus dem Git-Repository der Pantheon-Site und senden ihn dann an das GitLab-Repository. </p><br><p>  Um es einfacher und sicherer zu machen, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">fügen wir Pantheon einen SSH-Schlüssel hinzu</a> und geben das Kennwort nicht jedes Mal ein, wenn wir das Pantheon Git-Repository klonen.  Gleichzeitig werden <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">wir GitLab einen SSH-Schlüssel hinzufügen</a> . </p><br><p>  Zu diesem Zweck klonen wir die Pantheon-Site lokal, indem wir den Befehl aus dem Feld Mit Git klonen im Site-Dashboard kopieren. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/em/qz/ga/emqzgamloafdlzbj3xp0ssrt2o0.png"></a> <br>  <em>Wenn Sie Hilfe benötigen, lesen Sie die Dokumentation <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">zu Git Getting Started für Pantheon</a> .</em> </p><br><p>  Ändern Sie nun den <code>git remote origin</code> , dass er auf GitLab anstelle von Pantheon verweist.  Dies kann <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><code> git remote</code></a> . </p><br><p>  Gehen wir zum GitLab-Projekt und kopieren Sie die Repository-URL aus der Dropdown-Liste Klonen auf der Projektdetailseite.  Wir wählen die Option Mit SSH klonen, da wir den SSH-Schlüssel bereits konfiguriert haben. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/6m/4o/ea/6m4oeailmhmcggywg27uptq7aio.png"></a> </p><br><p>  Standardmäßig ist <code>git remote</code> für die lokale Kopie des Code-Repositorys <code>origin</code> .  Dies kann mit <code>git remote set-url origin [URL  GitLab]</code> geändert werden, wobei anstelle von Klammern die tatsächliche URL eingegeben wird. </p><br><p>  Führen Sie <code>git push origin master --force</code> , um Ihren WordPress-Code von Pantheon an GitLab zu senden. </p><br><blockquote>  Die Option –force wird nur einmal benötigt.  Dann wird es in <code>git push</code> Befehlen auf GitLab nicht sein. </blockquote><br><h3 id="nastraivaem-uchetnye-dannye-i-peremennye">  Konfigurieren Sie Anmeldeinformationen und Variablen </h3><br><p>  Erinnern Sie sich, wie wir lokal einen SSH-Schlüssel hinzugefügt haben, um sich bei Pantheon und GitLab anzumelden?  Mit dem SSH-Token können GitLab und Pantheon autorisiert werden. </p><br><p>  GitLab hat einige großartige Dokumentationen.  Sehen wir uns den <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Abschnitt über SSH-Schlüssel bei Verwendung des Docker-Executors im Dokument zur Verwendung von SSH-Schlüsseln mit GitLab CI / CD an</a> . </p><br><p>  Jetzt führen wir die ersten beiden Schritte aus: <em>Erstellen Sie lokal mit ssh-keygen ein neues Paar SSH-Schlüssel und fügen Sie dem Projekt den privaten Schlüssel als Variable hinzu</em> . </p><br><p>  Dann setzen wir <code>SSH_PRIVATE_KEY</code> als <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">GitLab CI / CD-Umgebungsvariable</a> in den Projekteinstellungen. <br>  Erstellen <code>.gitlab-ci.yml</code> im dritten und vierten Schritt eine <code>.gitlab-ci.yml</code> mit den folgenden Inhalten: </p><br><pre> <code class="plaintext hljs">before_script: # See https://docs.gitlab.com/ee/ci/ssh_keys/README.html - eval $(ssh-agent -s) - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - &gt; /dev/null - mkdir -p $HOME/.ssh &amp;&amp; echo "StrictHostKeyChecking no" &gt;&gt; "$HOME/.ssh/config" - git config --global user.email "$GITLAB_USER_EMAIL" - git config --global user.name "Gitlab CI"</code> </pre> <br><p>  Bis wir die <code>.gitlab-ci.yml</code> , muss noch etwas hinzugefügt werden. </p><br><p>  Jetzt führen wir den fünften Schritt aus und <em>fügen den öffentlichen Schlüssel, den wir im ersten Schritt erstellt haben, zu den Diensten hinzu, auf die Sie in der Build-Umgebung zugreifen müssen</em> . </p><br><p>  In unserem Fall möchten wir von GitLab aus Zugriff auf Pantheon erhalten.  Befolgen Sie die Anweisungen im Pantheon-Dokument, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">um</a> Pantheon <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">einen SSH-Schlüssel hinzuzufügen,</a> und führen Sie diesen Schritt aus. </p><br><blockquote>  Denken Sie daran: SSH in GitLab geschlossen, im Pantheon geöffnet. </blockquote><p>  Richten Sie einige weitere Umgebungsvariablen ein.  Die erste heißt PANTHEON_SITE.  Seine Bedeutung ist der Name der Pantheon-Site auf Ihrem Computer. </p><br><p>  Der Name auf dem Computer wird am Ende des Befehls Mit Git klonen angezeigt.  Sie haben die Site bereits lokal geklont, daher ist dies der Name des lokalen Repository-Verzeichnisses. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/rf/3p/gb/rf3pgbmo_2u0xsri8d1hq5f-xxw.png"></a> </p><br><p>  <code>PANTHEON_GIT_URL</code> Nächstes die Umgebungsvariable <code>PANTHEON_GIT_URL</code> .  Dies ist die Git-Repository-URL für die Pantheon-Site, die wir bereits verwendet haben. </p><br><blockquote>  Wir geben nur die URL des SSH-Repositorys ohne <code>git clone</code> und den Site-Namen auf dem Computer am Ende ein. </blockquote><p>  Fuh.  Dies ist erledigt, jetzt können wir unsere <code>.gitlab-ci.yml</code> . </p><br><h3 id="sozdaem-zadachu-deploya">  Erstellen Sie eine Bereitstellungsaufgabe </h3><br><p>  Was wir anfänglich mit GitLab CI machen werden, ist sehr ähnlich zu dem, was wir zuvor mit Git-Repositorys gemacht haben.  Fügen Sie diesmal jedoch das Pantheon-Repository als zweite Remote-Git-Quelle hinzu und senden Sie den Code von GitLab an Pantheon. </p><br><p>  Konfigurieren Sie dazu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">die</a> <code>deploy</code> und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">die Task "</a> <code>deploy:dev</code> , da die Bereitstellung in der Entwicklungsumgebung von Pantheon erfolgt.  Infolgedessen <code>.gitlab-ci.yml</code> aus: </p><br><pre> <code class="plaintext hljs">stages: - deploy before_script: # See https://docs.gitlab.com/ee/ci/ssh_keys/README.html - eval $(ssh-agent -s) - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - &gt; /dev/null - mkdir -p $HOME/.ssh &amp;&amp; echo "StrictHostKeyChecking no" &gt;&gt; "$HOME/.ssh/config" - git config --global user.email "$GITLAB_USER_EMAIL" - git config --global user.name "Gitlab CI" deploy:dev: stage: deploy environment: name: dev url: https://dev-$PANTHEON_SITE.pantheonsite.io/ script: - git remote add pantheon $PANTHEON_GIT_URL - git push pantheon master --force only: - master</code> </pre> <br><p>  Die Variablen <code>SSH_PRIVATE_KEY, PANTHEON_SITE</code> und <code>PANTHEON_GIT_URL</code> sollten vertraut aussehen - wir haben diese Umgebungsvariablen früher eingerichtet.  Mit diesen Variablen können wir die Werte in der <code>.gitlab-ci.yml</code> viele Male verwenden, und wir müssen sie nur an einer Stelle aktualisieren. </p><br><p>  <code>.gitlab-ci.yml</code> hinzu, <code>.gitlab-ci.yml</code> an GitLab. </p><br><h3 id="proveryaem-deploy">  Aktivieren Sie Bereitstellen </h3><br><p>  Wenn wir alles richtig gemacht haben, wird die Task <code>deploy:dev</code> in GitLab CI / CD erfolgreich sein und das <code>.gitlab-ci.yml</code> an Pantheon senden.  Mal sehen. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ex/pu/to/exputo8aihdn0sxv1aavrpa-rg4.png"></a> </p><br><p> <a href=""><img src="https://habrastorage.org/webt/2w/4_/zs/2w4_zszf0r6dxu8jvgo-ogfzzqi.png"></a> </p><br><p> <a href=""><img src="https://habrastorage.org/webt/6z/tk/ir/6ztkirsm-22bbcegra12_lyx3zg.png"></a> </p><br><h3 id="otpravlyaem-vetki-merzh-rekvestov-v-pantheon">  Wir senden Filialen von Zusammenführungsanfragen an Pantheon </h3><br><p>  Hier verwenden wir meine Lieblings-Pantheon-Funktion - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Multidev</a> , mit der Sie auf Anfrage zusätzliche Pantheon-Umgebungen für Git-Zweige erstellen können. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Der Zugriff auf Multidev ist begrenzt</a> , daher ist dieser Abschnitt <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">optional</a> .  Wenn Sie jedoch Zugriff haben, können Sie die Produktivität erheblich steigern, indem Sie die automatische Erstellung von Multidev-Umgebungen auf Pantheon aus GitLab-Zusammenführungsanforderungen einrichten. </p><br><p>  <code>git checkout -b multidev-support</code> lokal einen neuen Git-Zweig mit <code>git checkout -b multidev-support</code> .  Jetzt wird sich wieder etwas in <code>.gitlab-ci.yml</code> . </p><br><p>  Ich möchte die Nummer der Zusammenführungsanforderung im Namen der Pantheon-Umgebung angeben.  Zum Beispiel ist die erste Zusammenführungsanforderung <code>mr-1</code> , die zweite ist <code>mr-2</code> usw. </p><br><p>  Die Zusammenführungsanforderung ändert sich, daher müssen wir die Namen der Pantheon-Zweige dynamisch identifizieren.  In GitLab ist dies einfach - Sie müssen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">vordefinierte Umgebungsvariablen verwenden</a> . </p><br><p>  Wir können <code>$CI_MERGE_REQUEST_IID</code> , um die Nummer der Zusammenführungsanforderung anzugeben.  Wenden wir all dies zusammen mit den zuvor angegebenen globalen Umgebungsvariablen an und fügen am Ende der <code>.gitlab-ci.yml</code> eine neue Task "deploy: multidev" <code>.gitlab-ci.yml</code> . </p><br><pre> <code class="plaintext hljs">deploy:multidev: stage: deploy environment: name: multidev/mr-$CI_MERGE_REQUEST_IID url: https://mr-$CI_MERGE_REQUEST_IID-$PANTHEON_SITE.pantheonsite.io/ script: # Checkout the merge request source branch - git checkout $CI_COMMIT_REF_NAME # Add the Pantheon git repository as an additional remote - git remote add pantheon $PANTHEON_GIT_URL # Push the merge request source branch to Pantheon - git push pantheon $CI_COMMIT_REF_NAME:mr-$CI_MERGE_REQUEST_IID --force only: - merge_requests</code> </pre> <br><p>  Es wird unserer Aufgabe <code>deploy:dev</code> ähnlich sein, nur der Zweig wird an Pantheon gesendet und nicht an <code>master</code> . </p><br><p>  Wir haben die aktualisierte <code>.gitlab-ci.yml</code> hinzugefügt und festgeschrieben und senden jetzt einen neuen Zweig an GitLab mit <code>git push -u origin multidev-support</code> . </p><br><p>  Erstellen Sie nun eine neue <em>Zusammenführungsanforderung</em> aus dem <code>multidev-support</code> Zweig, indem <em>Sie auf Zusammenführungsanforderung erstellen</em> klicken. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/bi/bv/gt/bibvgthkwykacqew-cswygjdmig.png"></a> </p><br><p>  Nachdem wir die Zusammenführungsanforderung erstellt haben, sehen wir uns an, wie die CI / CD- <code>deploy:multidev</code> . </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ck/ev/lq/ckevlqnrfbfanoj0dlmjt26wxpw.png"></a> </p><br><p>  Siehe - ein neuer Zweig wurde zum Pantheon geschickt.  Wenn wir jedoch zum Multidev-Bereich im Dashboard der Pantheon-Site gehen, wird die neue Umgebung dort nicht angezeigt. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/yy/yy/bz/yyyybzmedtphnsj-6humcyu2hmu.png"></a> </p><br><p>  Schauen Sie sich den Abschnitt Git Branches an. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/hp/_o/bl/hp_obl6r7pv4ihuot7i6gx4rqwm.png"></a> </p><br><p>  Infolgedessen erreichte unser <code>mr-1</code> Zweig das Pantheon.  Erstellen Sie eine Umgebung aus dem Zweig <code>mr-1</code> . </p><br><p> <a href=""><img src="https://habrastorage.org/webt/2v/xg/ez/2vxgez9ugraihe2bdyn-5cxevjm.png"></a> </p><br><p>  Wir haben eine Multidev-Umgebung erstellt und kehren nun zu GitLab zurück und sehen uns den Abschnitt <em>Operationen&gt; Umgebungen an</em> .  Wir werden Einträge für <code>dev</code> und <code>mr-1</code> . </p><br><p>  Dies liegt daran, dass wir den CI / CD-Aufgaben einen <code>environment</code> Namen <code>name</code> und <code>url</code> hinzugefügt haben.  Wenn wir auf das Symbol zum Öffnen der Umgebung klicken, rufen wir die URL der Pantheon-Multidev-Umgebung auf. </p><br><h3 id="avtomatiziruem-sozdanie-multidev">  Automatisieren Sie die Erstellung von Multidev </h3><br><p>  Im Prinzip können Sie hier anhalten und daran denken, für jede Zusammenführungsanforderung eine Multidev-Umgebung zu erstellen. Dieser Prozess kann jedoch automatisiert werden. </p><br><p>  Pantheon verfügt über ein <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Terminus-</a> Befehlszeilentool, mit dem Sie automatisch mit der Plattform arbeiten können.  In Terminus können Sie Multidev-Umgebungen über die Befehlszeile erstellen - ideal für <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">GitLab CI</a> . </p><br><p>  Wir benötigen eine neue Zusammenführungsanforderung, um sie zu testen.  Erstellen Sie einen neuen Zweig mit <code>git checkout -b auto-multidev-creation</code> . </p><br><p>  Um Terminus in GitLab CI / CD-Tasks verwenden zu können, benötigen Sie ein Maschinentoken für die Authentifizierung in Terminus und ein Container-Image mit Terminus. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Erstellen Sie ein Pantheon-Maschinentoken</a> , speichern Sie es an einem sicheren Ort und fügen Sie es als globale Umgebungsvariable in GitLab mit dem Namen <code>PANTHEON_MACHINE_TOKEN</code> . </p><br><blockquote>  Wenn Sie vergessen haben, wie GitLab-Umgebungsvariablen hinzugefügt werden, kehren Sie zu der Stelle zurück, an der wir <code>PANTHEON_SITE</code> definiert haben. </blockquote><br><h3 id="sozdaem-dockerfile-s-terminus">  Erstellen Sie eine Docker-Datei mit Terminus </h3><br><p>  Wenn Sie Docker nicht verwenden oder Docker- <code>Dockerfile</code> nicht mögen, nehmen Sie mein <code>registry.gitlab.com/ataylorme/pantheon-gitlab-blog-demo:latest</code> Bild und überspringen Sie diesen Abschnitt. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">GitLab verfügt über eine Container-Registrierung,</a> in der Sie eine Docker-Datei für unser Projekt erstellen und hosten können.  Erstellen wir eine Docker-Datei mit Terminus, um mit Pantheon zu arbeiten. </p><br><p>  Terminus ist ein Befehlszeilenprogramm in PHP. Beginnen wir also mit dem PHP-Image.  Ich installiere Terminus über Composer, daher nehme ich das <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">offizielle Docker Composer-Image</a> als Grundlage.  Erstellen Sie eine <code>Dockerfile</code> im lokalen Repository-Verzeichnis mit den folgenden Inhalten: </p><br><pre> <code class="plaintext hljs"># Use the official Composer image as a parent image FROM composer:1.8 # Update/upgrade apk RUN apk update RUN apk upgrade # Make the Terminus directory RUN mkdir -p /usr/local/share/terminus # Install Terminus 2.x with Composer RUN /usr/bin/env COMPOSER_BIN_DIR=/usr/local/bin composer -n --working-dir=/usr/local/share/terminus require pantheon-systems/terminus:"^2"</code> </pre> <br><p>  Befolgen Sie die Anweisungen zum Zusammenstellen und Senden von Bildern aus dem Abschnitt <em>Erstellen und Push-Bilder</em> in der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Dokumentation</a> zur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Containerregistrierung</a> , um das Bild aus der <code>Dockerfile</code> zu sammeln und an GitLab zu senden. </p><br><p>  Öffnen Sie den <em>Registrierungsabschnitt</em> im GitLab-Projekt.  Wenn alles nach Plan lief, wird es unser Image geben.  <code>.gitlab-ci.yml</code> Sie den Link zum Image-Tag - wir benötigen ihn für die <code>.gitlab-ci.yml</code> . </p><br><p> <a href=""><img src="https://habrastorage.org/webt/_x/ta/yn/_xtayn5xz10hq5kuv7abvqvskgq.png"></a> </p><br><p>  Der <code>deploy:multidev</code> beginnt zu wachsen. Verschieben Sie ihn daher in eine separate Datei.  Erstellen Sie eine neue <code>private/multidev-deploy.sh:</code> </p><br><pre> <code class="plaintext hljs">#!/bin/bash # Store the mr- environment name export PANTHEON_ENV=mr-$CI_MERGE_REQUEST_IID # Authenticate with Terminus terminus auth:login --machine-token=$PANTHEON_MACHINE_TOKEN # Checkout the merge request source branch git checkout $CI_COMMIT_REF_NAME # Add the Pantheon Git repository as an additional remote git remote add pantheon $PANTHEON_GIT_URL # Push the merge request source branch to Pantheon git push pantheon $CI_COMMIT_REF_NAME:$PANTHEON_ENV --force # Create a function for determining if a multidev exists TERMINUS_DOES_MULTIDEV_EXIST() { # Stash a list of Pantheon multidev environments PANTHEON_MULTIDEV_LIST="$(terminus multidev:list ${PANTHEON_SITE} --format=list --field=id)" while read -r multiDev; do if [[ "${multiDev}" == "$1" ]] then return 0; fi done &lt;&lt;&lt; "$PANTHEON_MULTIDEV_LIST" return 1; } # If the mutltidev doesn't exist if ! TERMINUS_DOES_MULTIDEV_EXIST $PANTHEON_ENV then # Create it with Terminus echo "No multidev for $PANTHEON_ENV found, creating one..." terminus multidev:create $PANTHEON_SITE.dev $PANTHEON_ENV else echo "The multidev $PANTHEON_ENV already exists, skipping creating it..." fi</code> </pre> <br><p>  Das Skript befindet sich in einem privaten Verzeichnis und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">bietet keinen Webzugriff auf Pantheon</a> .  Wir haben ein Skript für unsere Multidev-Logik.  Lassen Sie uns nun den <code>deploy:multidev</code> Datei <code>.gitlab-ci.yml</code> aktualisieren, <code>deploy:multidev</code> <code>.gitlab-ci.yml</code> zu erhalten: </p><br><pre> <code class="plaintext hljs">deploy:multidev: stage: deploy environment: name: multidev/mr-$CI_MERGE_REQUEST_IID url: https://mr-$CI_MERGE_REQUEST_IID-$PANTHEON_SITE.pantheonsite.io/ script: # Run the multidev deploy script - "/bin/bash ./private/multidev-deploy.sh" only: - merge_requests</code> </pre> <br><p>  Wir müssen sicherstellen, dass unsere Aufgaben in dem erstellten benutzerdefinierten Image <code>.gitlab-ci.yml</code> . <code>.gitlab-ci.yml</code> fügen wir das Definitionsbild mit der Registrierungs-URL in <code>.gitlab-ci.yml</code> .  Als Ergebnis haben wir die folgende <code>.gitlab-ci.yml</code> : </p><br><pre> <code class="plaintext hljs">image: registry.gitlab.com/ataylorme/pantheon-gitlab-blog-demo:latest stages: - deploy before_script: # See https://docs.gitlab.com/ee/ci/ssh_keys/README.html - eval $(ssh-agent -s) - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - &gt; /dev/null - mkdir -p $HOME/.ssh &amp;&amp; echo "StrictHostKeyChecking no" &gt;&gt; "$HOME/.ssh/config" - git config --global user.email "$GITLAB_USER_EMAIL" - git config --global user.name "Gitlab CI" deploy:dev: stage: deploy environment: name: dev url: https://dev-$PANTHEON_SITE.pantheonsite.io/ script: - git remote add pantheon $PANTHEON_GIT_URL - git push pantheon master --force only: - master deploy:multidev: stage: deploy environment: name: multidev/mr-$CI_MERGE_REQUEST_IID url: https://mr-$CI_MERGE_REQUEST_IID-$PANTHEON_SITE.pantheonsite.io/ script: # Run the multidev deploy script - "/bin/bash ./private/multidev-deploy.sh" only: - merge_requests</code> </pre> <br><p>  Fügen Sie <code>private/multidev-deploy.sh</code> und <code>.gitlab-ci.yml</code> <code>private/multidev-deploy.sh</code> und <code>.gitlab-ci.yml</code> .  Kehren Sie nun zu GitLab zurück und warten Sie, bis die CI / CD-Aufgabe abgeschlossen ist.  Seien Sie geduldig: Multidev kann einige Minuten dauern. </p><br><p>  Dann schauen wir uns die Multidev-Liste im Pantheon an.  Oh Wunder!  Die Multidev <code>mr-2</code> Mr <code>mr-2</code> Umgebung ist bereits vorhanden. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/gx/jf/ab/gxjfabnawlvvtncrg268q7nwkiw.png"></a> </p><br><h3 id="zaklyuchenie">  Fazit </h3><br><p>  Mein Team hat viel mehr Spaß gemacht, als wir angefangen haben, Zusammenführungsanforderungen zu öffnen und Umgebungen automatisch zu erstellen. </p><br><p>  Mit den leistungsstarken GitLab- und Pantheon-Tools können Sie GitLab automatisch mit Pantheon verbinden. </p><br><p>  Sobald wir GitLab CI / CD verwenden, wird unser Workflow wachsen.  Hier sind einige Ideen für den Einstieg: </p><br><ul><li>  Fügen Sie einen Build-Schritt hinzu. </li><li>  Fügen Sie automatisierte Tests hinzu. </li><li>  Fügen Sie eine Aufgabe hinzu, um die Einhaltung der Codestandards sicherzustellen. </li><li>  Fügen Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">dynamische Tests zur Anwendungssicherheit hinzu</a> . </li></ul><br><p>  Schreiben Sie, was Sie von GitLab, Pantheon und Automatisierung halten. </p><br><p>  PS Wussten Sie, dass Terminus, das Pantheon-Befehlszeilentool, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">durch Plugins erweitert werden kann</a> ? </p><br><p>  Wir bei Pantheon haben hart an Version 2 unseres <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Plugins für</a> GitLab-fähige <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Terminus-Build-Tools gearbeitet</a> .  Wenn Sie nicht an den Einstellungen für jedes Projekt basteln möchten, probieren Sie dieses Plugin aus und helfen Sie uns, Beta v2 zu testen.  Für den Befehl Terminus <code>build:project:create</code> benötigen Sie nur das Pantheon-Token und das GitLab-Token.  Sie wird ein Beispielprojekt mit Composer und automatisierten Tests bereitstellen, ein neues Projekt in GitLab, der neuen Pantheon-Site, erstellen und diese mithilfe von Umgebungsvariablen und SSH-Schlüsseln verbinden. </p><br><h3 id="ob-avtore">  Über den Autor </h3><br><p>  Andrew Taylor erstellt Entwicklertools im <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Pantheon</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de447966/">https://habr.com/ru/post/de447966/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de447956/index.html">Quantenkommunikation an der ITMO University - ein Projekt unzerbrechlicher Datenübertragungssysteme</a></li>
<li><a href="../de447958/index.html">CJM für falsches Auslösen von DrWeb Antivirus</a></li>
<li><a href="../de447960/index.html">Veeam Linux Backup unter Elbrus OS. Importsubstitution ['?' | '.' | '!']</a></li>
<li><a href="../de447962/index.html">Hacker können Tesla Model S mithilfe des Autopilotsystems fernsteuern</a></li>
<li><a href="../de447964/index.html">Mikrocomputertests für IoT</a></li>
<li><a href="../de447968/index.html">Schreiben in Rust + CUDA C.</a></li>
<li><a href="../de447970/index.html">Super einfache Javascript-Protokollierung - zwei Dekorateure und fertig</a></li>
<li><a href="../de447976/index.html">Entwicklung und Montage einer Fotolampe</a></li>
<li><a href="../de447980/index.html">Warum ist es unerlässlich, eine Marken-Taxi-App für Ihr Unternehmen zu investieren und zu entwickeln?</a></li>
<li><a href="../de447982/index.html">Digest: 10 Materialien zu Bildschirmen und Projektoren für das Heimkino</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>