<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚵🏽 ☝🏿 🙌🏽 混沌工程，第3部分：方法和工具 😴 ⏹️ 💷</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="我们成为我们所看到的。 首先，我们对工具进行成型，然后对我们进行成型。 

 麦克卢汉元帅 

 我要衷心感谢并感谢我的好朋友里卡多·苏埃拉斯 （ Ricardo Sueiras）的评论，贡献以及不让我留下这篇未完成的文章。 里卡多，你只是一个传奇！ 


 重要的是要记住，当您释放猴子并随意输入失...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>混沌工程，第3部分：方法和工具</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/southbridge/blog/480802/"><p><img src="https://habrastorage.org/webt/bj/bo/hr/bjbohri48f3n_qtsbswegzbyw5y.jpeg"></p><br><blockquote> 我们成为我们所看到的。 首先，我们对工具进行成型，然后对我们进行成型。 <br><br> 麦克卢汉元帅 </blockquote><p>  <em>我要衷心感谢并感谢我的好朋友<a href="https://medium.com/%40094459">里卡多·苏埃拉斯</a> （ <a href="https://medium.com/%40094459">Ricardo Sueiras）</a>的评论，贡献以及不让我留下这篇未完成的文章。</em>  <em>里卡多，你只是一个传奇！</em> </p><br><p> 重要的是要记住，当您释放猴子并随意输入失败时，混乱的工程并不是要发生的。 混沌工程是一种定义明确， <a href="https://en.wikipedia.org/wiki/Scientific_method">形式化的</a>实验<a href="https://en.wikipedia.org/wiki/Scientific_method">技术</a> 。 </p><a name="habracut"></a><br><blockquote>  “混沌工程涉及仔细观察，对观察对象持严重怀疑态度，因为认知假设扭曲了结果的解释。该技术涉及通过基于相似观察的归纳来提出假设；基于实验和基于测量的对相似假设得出的结论进行检验；调整或根据实验结果拒绝假设” <br><br>  —维基百科 </blockquote><p> 混沌工程学首先要了解您正在处理的系统的稳定状态，随后的假设表述，最后是要进行验证的实验，以帮助提高系统的安全性。 </p><br><p><img src="https://habrastorage.org/webt/gq/yq/jc/gqyqjcysfguozpispkjletc21ik.png"><br>  <em>混沌工程阶段</em> </p><br><p> 在<a href="https://medium.com/%40adhorn/chaos-engineering-ab0cc9fbd12a">系列文章</a>的<a href="https://medium.com/%40adhorn/chaos-engineering-ab0cc9fbd12a">第一部分中，</a>我介绍了混沌工程，并讨论了上述方法的每个步骤。 </p><br><p> 在<a href="https://medium.com/%40adhorn/chaos-engineering-part-2-b9c78a9f3dde">第二部分中</a> ，我研究了在设计混沌工程实验时需要投资的领域，以及如何选择正确的假设。 </p><br><p> 在第三部分中，我将重点介绍实验本身，并介绍涵盖广泛故障的一系列工具和方法。 </p><br><p> 该清单不是详尽无遗的，但从头开始并给予深思，它就足够了。 </p><br><h2 id="vvedenie-otkaza---chto-eto-i-dlya-chego-nuzhno"> 引入故障-它有什么作用？ </h2><br><p> 故障用于验证系统响应在正常负载条件下是否符合规格。 通过改变设备上的电信号<a href="https://ieeexplore.ieee.org/document/780999/">，在“铁”</a>级（触点级） <a href="https://ieeexplore.ieee.org/document/780999/">引入故障</a>时，首次使用了该技术。 </p><br><p> 在编程中，引入故障有助于提高软件系统的稳定性，并允许您纠正对系统潜在故障的抵抗力方面的缺陷。 这称为故障排除。 它还有助于评估故障造成的损害-即 甚至在生产环境中发生故障之前的损坏半径。 这称为故障预测。 </p><br><p> 引入故障有几个主要好处，有助于： </p><br><ul><li> 了解并实践对事故和事件的响应。 </li><li> 了解实际失败的后果。 </li><li> 了解容错机制的有效性和局限性。 </li><li> 消除设计错误并检测常见的故障点。 </li><li> 了解并提高系统的可观察性。 </li><li> 了解失败的失败半径并缩小范围。 </li><li> 了解系统组件之间的错误分布。 </li></ul><br><h3 id="kategorii-vvedeniya-otkazov"> 失败类别 </h3><br><p> 引入故障有5种类型：（1）资源级别；  （2）网络与依存关系；  （3）应用，流程和服务；  （4）基础设施；  （5）人身**。 </p><br><p> 接下来，我将研究每种类别，并举例说明每种类别的故障。 我还将考虑引入故障和多合一编排工具的示例。 </p><br><blockquote>  **重要！ 在这篇文章中，我不会在人的层面上介绍失败的内容，但是我将在下面进行介绍。 </blockquote><br><h2 id="1---vvedenie-otkaza-na-urovne-resursa-aka-nehvatka-resursov">  1-在资源级别引入失败，也就是缺乏资源。 </h2><br><p> 是的，云技术告诉我们资源几乎是无限的，但是我赶紧让您失望：它们不是无限的。 实例，容器，函数等  -无论抽象如何，资源最终都会耗尽。 超出资源的最大允许消耗称为消耗。 </p><br><p><img src="https://habrastorage.org/webt/ri/54/nn/ri54nnmprlvjvug3f395w6ohofk.png"></p><br><p> 资源的缺乏模仿了<a href="https://en.wikipedia.org/wiki/Denial-of-service_attack">拒绝服务</a>攻击，但无法渗透到预期的服务器。 故障的引入可能很普遍，因为可能不难使用。 </p><br><h3 id="istoschaya-resursy-cpu-pamyati-i-vvodavyvoda"> 耗尽CPU，内存和I / O资源 </h3><br><p> 我最喜欢的工具之一是<a href="https://www.mankier.com/1/stress-ng">Stress-ng，它</a>是<a href="https://directory.fsf.org/wiki/Stress">由Amos Waterland编写</a>的原始<a href="https://directory.fsf.org/wiki/Stress">压力测试工具</a> <a href="https://www.mankier.com/1/stress-ng">的</a>对应物。 </p><br><p> 使用Stress-ng，可以通过加载计算机的各个物理子系统以及使用压力测试控制系统核心的接口来输入故障。 提供以下压力测试：CPU，CPU缓存，设备，I / O，中断，文件系统，内存，网络，OS，管道，调度程序和VM。  <a href="https://www.mankier.com/1/stress-ng">手册页</a>包括所有可用压力测试的完整说明，其中只有220个！ </p><br><p> 以下是一些有关如何使用Stress-ng的实际示例： </p><br><p> CPU <code>matrixprod</code>上的负载可以正确地混合使用内存，缓存和浮点运算。 这也许。 充分预热CPU的最佳方法。 </p><br><pre> <code class="plaintext hljs">❯ stress-ng —-cpu 0 --cpu-method matrixprod -t 60s</code> </pre> <br><p>  <code>iomix-bytes</code>负载为每个<code>iomix</code>处理程序<code>iomix</code>写入N个字节； 默认值为1 GB，非常适合执行I / O压力测试。 在此示例中，我将在文件系统上设置80％的可用空间。 </p><br><pre> <code class="plaintext hljs">❯ stress-ng --iomix 1 --iomix-bytes 80% -t 60s</code> </pre> <br><p>  <code>vm-bytes</code>非常适合进行内存压力测试。 在此示例中，Stress-ng对虚拟内存运行9个压力测试，每小时总共消耗90％的可用内存。 因此，每个发束测试会消耗10％的可用内存。 </p><br><pre> <code class="plaintext hljs">❯ stress-ng --vm 9 --vm-bytes 90% -t 60s</code> </pre> <br><h3 id="nehvatka-diskovogo-prostranstva-na-zhestkih-diskah"> 硬盘驱动器上的磁盘空间不足 </h3><br><p>  <code>dd</code>是编译用于转换和复制文件的命令行实用程序。 但是， <code>dd</code>可以从特殊设备（例如<code>/dev/zero</code>和<code>/dev/random</code>文件中读取和/或写入，以执行诸如备份硬盘的引导扇区并获取固定数量的随机数据之类的任务。 因此，它可用于在服务器上引入故障并模拟磁盘溢出。 您的日志文件是否使服务器溢出并删除了应用程序？ 因此， <code>dd</code>会有所帮助-而且会很痛！ </p><br><p>  <strong>小心使用<code>dd</code> 。</strong>  <strong>输入错误的命令-硬盘上的数据将被擦除，破坏或覆盖！</strong> </p><br><pre> <code class="plaintext hljs">❯ dd if=/dev/urandom of=/burn bs=1M count=65536 iflag=fullblock &amp;</code> </pre> <br><h3 id="podtormazhivanie-api-prilozheniy"> 应用程序API速度降低 </h3><br><p>  API的性能，弹性和可伸缩性很重要。  API对于构建应用程序和发展业务至关重要。 </p><br><p> 负载测试是在您的应用程序投入生产之前对其进行测试的好方法。 这也是一种很酷的压力加载方法，因为它通常会显示出例外和限制，在其他情况下，这些例外和限制在遇到实际流量之前仍然不可见。 </p><br><p>  <a href="https://github.com/wg/wrk"><code>wrk</code></a>是一个HTTP基准测试工具，对系统造成很大的压力。 我特别喜欢测试API可访问性检查，尤其是在<a href="https://medium.com/%40adhorn/patterns-for-resilient-architecture-part-3-16e8601c488e">性能检查方面</a> ，因为它们在开发人员代码级别上揭示了许多有关设计决策的内容：如何配置缓存？ 限速如何实施？ 系统是否优先考虑有关负载均衡器的运行状况检查？ </p><br><p> 从这里开始： </p><br><pre> <code class="plaintext hljs">❯ wrk -t12 -c400 -d20s http://127.0.0.1/api/health</code> </pre> <br><p> 此命令启动12个线程，并保持400个HTTP连接打开20秒钟。 </p><br><h2 id="2---vvedenie-otkazov-na-urovne-seti-i-zavisimostey">  2-引入网络级故障和依赖关系 </h2><br><p>  <a href="http://wiki.c2.com/%3FPeterDeutsch">彼得·德意志（Peter Deutsch）的</a>书<a href="http://eightfallaciesofdistributedcomputing/">《分布式计算的八个谬论》</a>是开发人员在设计分布式系统时所做的一系列假设。 然后答案以无法访问的形式出现，您必须重做所有事情。 这些错误的假设是： </p><br><ul><li> 网络是可靠的。 </li><li> 延迟为0。 </li><li> 带宽是无限的。 </li><li> 网络是安全的。 </li><li> 拓扑不会更改。 </li><li> 只有一名管理员。 </li><li> 转移费用0。 </li><li> 网络是同质的。 </li></ul><br><p> 如果要测试分布式系统是否可以处理网络故障，此列表是选择故障转移的一个很好的起点。 <br> 引入网络延迟，丢失和中断 </p><br><h3 id="vvedenie-zaderzhki-poteri-ili-obryva-seti"> 引入网络延迟，丢失或中断 </h3><br><p>  <code>tc</code> （ <a href="http://tldp.org/HOWTO/Traffic-Control-HOWTO/intro.html">流量控制</a> ）是用于配置Linux内核批处理调度程序的Linux命令行工具。 它定义了数据包如何在网络接口中排队以进行发送和接收。 操作包括排队，策略定义，分类，计划，调整和丢失。 </p><br><p>  <code>tc</code>可用于模拟UDP或TCP应用程序的延迟和数据包丢失，或限制特定服务带宽的使用-模拟Internet流量的状况。 </p><br><p>  <strong>-引入100 ms的延迟</strong> </p><br><pre> <code class="plaintext hljs">#Start ❯ tc qdisc add dev etho root netem delay 100ms #Stop ❯ tc qdisc del dev etho root netem delay 100ms</code> </pre> <br><p>  <strong>-引入100 ms的延迟和50 ms的增量</strong> </p><br><pre> <code class="plaintext hljs">#Start ❯ tc qdisc add dev eth0 root netem delay 100ms 50ms #Stop ❯ tc qdisc del dev eth0 root netem delay 100ms 50ms</code> </pre> <br><p>  <strong>-损坏5％的网络数据包</strong> </p><br><pre> <code class="plaintext hljs">#Start ❯ tc qdisc add dev eth0 root netem corrupt 5% #Stop ❯ tc qdisc del dev eth0 root netem corrupt 5%</code> </pre> <br><p>  <strong>-7％的封包丢失率和25％的相关性</strong> </p><br><pre> <code class="plaintext hljs">#Start ❯ tc qdisc add dev eth0 root netem loss 7% 25% #Stop ❯ tc qdisc del dev eth0 root netem loss 7% 25%</code> </pre> <br><blockquote>  <strong>重要！</strong>  7％足以使TCP应用程序不丢失。 </blockquote><br><h3 id="igraya-s-etchosts---staticheskoy-tablicey-poiska-dlya-imen-uzlov"> 玩“ / etc / hosts”-主机名的静态查找表 </h3><br><p>  <code>/etc/hosts</code>是一个简单的文本文件，该文件将IP地址与主机名关联起来，一次仅一行。 每个节点需要一行包含以下信息： </p><br><pre> <code class="plaintext hljs">IP_address canonical_hostname [aliases...]</code> </pre> <br><p><img src="https://habrastorage.org/webt/mx/po/lo/mxpoloqghh2ou_bphgifo69ydba.png"></p><br><p> 主机文件是访问计算机网络上的网络节点并将人们理解的主机名转换为IP地址的几种系统之一。 是的，您猜对了：由于它，欺骗计算机很方便。 以下是一些示例： </p><br><p>  <strong>-阻止对EC2实例的DynamoDB API的访问</strong> </p><br><pre> <code class="plaintext hljs">#Start # make copy of /etc/hosts to /etc/host.back ❯ cp /etc/hosts /etc/hosts.back ❯ echo "127.0.0.1 dynamodb.us-east-1.amazonaws.com" &gt;&gt; /etc/hosts ❯ echo "127.0.0.1 dynamodb.us-east-2.amazonaws.com" &gt;&gt; /etc/hosts ❯ echo "127.0.0.1 dynamodb.us-west-1.amazonaws.com" &gt;&gt; /etc/hosts ❯ echo "127.0.0.1 dynamodb.us-west-2.amazonaws.com" &gt;&gt; /etc/hosts ❯ echo "127.0.0.1 dynamodb.eu-west-1.amazonaws.com" &gt;&gt; /etc/hosts ❯ echo "127.0.0.1 dynamodb.eu-north-1.amazonaws.com" &gt;&gt; /etc/hosts #Stop # copy back the old version /etc/hosts ❯ cp /etc/hosts.back /etc/hosts</code> </pre> <br><p>  <strong>-阻止从EC2实例访问EC2 API</strong> </p><br><pre> <code class="plaintext hljs">#Start # make copy of /etc/hosts to /etc/host.back ❯ cp /etc/hosts /etc/hosts.back ❯ echo "127.0.0.1 ec2.us-east-1.amazonaws.com" &gt;&gt; /etc/hosts ❯ echo "127.0.0.1 ec2.us-east-2.amazonaws.com" &gt;&gt; /etc/hosts ❯ echo "127.0.0.1 ec2.us-west-1.amazonaws.com" &gt;&gt; /etc/hosts ❯ echo "127.0.0.1 ec2.us-west-2.amazonaws.com" &gt;&gt; /etc/hosts ❯ echo "127.0.0.1 ec2.eu-west-1.amazonaws.com" &gt;&gt; /etc/hosts ❯ echo "127.0.0.1 ec2.eu-north-1.amazonaws.com" &gt;&gt; /etc/hosts #Stop # copy back the old version /etc/hosts ❯ cp /etc/hosts.back /etc/hosts</code> </pre> <br><p> 实时观看：首先，EC2 API可用，并且<code>ec2 describe-instances</code>成功返回。 </p><br><p><img src="https://habrastorage.org/webt/f9/oy/bc/f9oybcnf8l9s8ov4m7bzulyx6as.png"></p><br><p> 将<code>127.0.01 ec2.eu-west-1.amazonaws.com</code>添加到<code>/etc/hosts</code> ，EC2 API调用就会<code>127.0.01 ec2.eu-west-1.amazonaws.com</code> 。 </p><br><p><img src="https://habrastorage.org/webt/lj/6v/_y/lj6v_y8w7yfhnk9h8izd2gtj2aw.png"></p><br><p> 当然，这适用于所有AWS API。 </p><br><h2 id="rasskazal-by-ya-vam-anekdot-pro-dns"> 我会讲一个关于DNS的玩笑... </h2><br><p><img src="https://habrastorage.org/webt/dq/mo/ps/dqmopsts1wl0pfntxgvwoqgcwby.gif"></p><br><h3 id="no-boyus-do-vas-doydet-tolko-na-vtorye-sutki-v-smysle-cherez-24-chasa">  ...但是，恐怕它只会在第二天到达您。 我的意思是24小时后。 </h3><br><p>  2016年10月21日，由于<a href="https://en.wikipedia.org/wiki/2016_Dyn_cyberattack">DDoS Dyn攻击，</a>欧洲和北美的大量平台和服务不可用。 根据<a href="https://www.thousandeyes.com/resources/2018-global-dns-performance-benchmark-report">ThousandEyes关于2018年全球DNS性能的报告</a> ，60％的企业和SaaS提供商仍依赖单一来源的DNS提供商，因此容易受到DNS故障的影响。 而且由于没有DNS，就不会有Internet，因此，模拟DNS故障以评估您对下一个DNS故障的适应性将非常有用。 </p><br><p>  <strong>Blackholing</strong>是一种传统上可以减少<a href="https://en.wikipedia.org/wiki/Denial-of-service_attack">DDoS攻击</a>损害的方法。 不良的网络流量被路由到黑洞，并被丢弃到无效位置。 用于网络上的<code>/dev/null</code>版本：-)您可以使用它来模拟网络流量的丢失或同一<a href="https://en.wikipedia.org/wiki/Domain_Name_System">DNS</a>的协议，例如。 </p><br><p> 对于此任务，您需要<a href="https://linux.die.net/man/8/iptables"><code>iptables</code></a>工具，该工具用于在Linux内核中配置，维护和验证IP数据包。 </p><br><p> 要通过黑洞获取DNS流量，请尝试以下操作： </p><br><pre> <code class="plaintext hljs">#Start ❯ iptables -A INPUT -p tcp -m tcp --dport 53 -j DROP ❯ iptables -A INPUT -p udp -m udp --dport 53 -j DROP #Stop ❯ iptables -D INPUT -p tcp -m tcp --dport 53 -j DROP ❯ iptables -D INPUT -p udp -m udp --dport 53 -j DROP</code> </pre> <br><h3 id="vvedenie-otkazov-s-ispolzovaniem-toxiproxy"> 使用Toxiproxy进行故障介绍。 </h3><br><p> 诸如<code>tc</code>和<code>iptables</code>类的Linux工具<code>iptables</code>一个（但不是唯一的）严重问题。 他们需要root权限才能运行，这给某些组织和环境带来了问题。 请爱与宠爱<strong>-Toxiproxy</strong> ！ </p><br><p>  <a href="https://github.com/shopify/toxiproxy">Toxiproxy</a>是<a href="https://engineering.shopify.com/">由Shopify工程师团队</a>开发<a href="https://engineering.shopify.com/">的</a>开源TCP代理。 它有助于模拟混沌网络和系统状况或实际系统。 如下所示，将其放置在体系结构的各个组件之间。 </p><br><p><img src="https://habrastorage.org/webt/9u/k6/w-/9uk6w-tyk0jk6n1jgdg8awf0oyo.png"></p><br><p> 它是专门为测试，CI和开发环境而创建的，并引入了预定义的或随机的混乱，这些混乱可通过设置来控制。  Toxiproxy使用<a href="https://github.com/shopify/toxiproxy"><strong>有毒物质</strong></a>来操纵客户端和开发人员代码之间的关系，并且可以通过<a href="&amp;xid=17259,15700021,15700186,15700191,15700259,15700271&amp;usg=ALkJrhjKkqcTAJNVUsBCS91SodCxk2Ly8Q#">HTTP API</a>对其进行配置。 对他来说，药盒中有足够的毒物可以上手。 </p><br><p> 以下示例通过在我的Redis客户端，redis-cli和Redis本身之间的连接中引入1000毫秒的延迟，展示了Toxiproxy如何与有毒客户端代码一起工作。 </p><br><p><img src="https://habrastorage.org/webt/vg/zg/gf/vgzggft6l5n0eywx2gn__njbc08.png"></p><br><p> 自2014年10月起，Shopify已成功在所有生产和开发环境中使用Toxiproxy。 更多信息在他们的<a href="https://shopifyengineering.myshopify.com/blogs/engineering/building-and-testing-resilient-ruby-on-rails-applications">博客上</a> 。 </p><br><h2 id="3---vvedenie-otkazov-na-urovne-prilozheniya-processa-i-servisa">  3-在应用程序，流程和服务级别引入故障 </h2><br><p> 该软件正在下降。 这是事实。 那你怎么办？ 我是否应该通过SSH在服务器上登录并重新启动失败的进程？ 过程控制系统提供启动，停止，重新启动类型的状态控制或状态更改功能。 控制系统通常用于确保稳定的过程控制。  <a href="https://en.wikipedia.org/wiki/Systemd"><code>systemd</code></a>就是这样的工具，为Linux提供了基本的过程控制块。  <a href="http://supervisord.org/introduction.html"><code>Supervisord</code></a>可控制诸如UNIX之类的操作系统上的多个进程。 </p><br><p> 部署应用程序时，应使用这些工具。 测试杀死关键进程所造成的损害当然是一种好习惯。 确保收到警报，并且该过程会自动重新启动。 </p><br><p>  <strong>-杀死Java进程</strong> </p><br><pre> <code class="plaintext hljs">❯ pkill -KILL -f java #Alternative ❯ pkill -f 'java -jar'</code> </pre> <br><p>  <strong>-杀死Python进程</strong> </p><br><pre> <code class="plaintext hljs">❯ pkill -KILL -f python</code> </pre> <br><p> 当然，您可以使用<code>pkill</code>命令杀死系统上运行的许多其他进程。 </p><br><h2 id="vvedenie-otkazov-bazy-dannyh"> 引入数据库故障 </h2><br><p> 如果存在操作员不希望收到的故障消息，则这些故障消息与数据库故障有关。 数据价值不菲，因此，每当数据库崩溃时，丢失客户数据的风险就会增加。 </p><br><p><img src="https://habrastorage.org/webt/3c/lz/ye/3clzye5agj95ocxbo0vyorq2opc.png"><br>  <em>它将很容易维护。</em>  <em>越来越等等...一切都下降了</em> </p><br><p> 有时，恢复数据并使数据库尽快进入工作状态的能力决定了公司的未来。 不幸的是，为各种模式的数据库故障做准备也不总是很容易-其中许多仅会在生产环境中弹出。 </p><br><p> 但是，如果您使用的是<a href="https://aws.amazon.com/rds/aurora/">Amazon Aurora</a> ，则可以使用<a href="https://docs.aws.amazon.com/AmazonRDS/latest/AuroraUserGuide/AuroraMySQL.Managing.FaultInjectionQueries.html">故障转移请求</a>来测试Amazon Aurora数据库集群对故障的<a href="https://docs.aws.amazon.com/AmazonRDS/latest/AuroraUserGuide/AuroraMySQL.Managing.FaultInjectionQueries.html">恢复能力</a> 。 </p><br><h3 id="vvedenie-otkaza-amazon-aurora">  Amazon Aurora崩溃介绍 </h3><br><p> 失败请求作为SQL命令发布到Amazon Aurora实例，并允许您安排以下事件之一的模拟： </p><br><ul><li> 写入数据库实例失败。 </li><li> 极光副本失败。 </li><li> 磁盘故障。 </li><li> 磁盘过载。 </li></ul><br><p> 发送故障请求时，还必须指定模拟故障事件的时间。 </p><br><p>  <strong>-导致Amazon Aurora实例故障：</strong> </p><br><pre> <code class="plaintext hljs">ALTER SYSTEM CRASH [ INSTANCE | DISPATCHER | NODE ];</code> </pre> <br><p>  <strong>-模拟Aurora副本的故障：</strong> </p><br><pre> <code class="plaintext hljs">ALTER SYSTEM SIMULATE percentage PERCENT READ REPLICA FAILURE [ TO ALL | TO "replica name" ] FOR INTERVAL quantity { YEAR | QUARTER | MONTH | WEEK | DAY | HOUR | MINUTE | SECOND };</code> </pre> <br><p>  <strong>-模拟Aurora数据库集群的磁盘故障：</strong> </p><br><pre> <code class="plaintext hljs">ALTER SYSTEM SIMULATE percentage PERCENT DISK FAILURE [ IN DISK index | NODE index ] FOR INTERVAL quantity { YEAR | QUARTER | MONTH | WEEK | DAY | HOUR | MINUTE | SECOND };</code> </pre> <br><p>  <strong>-模拟Aurora数据库集群的磁盘故障：</strong> </p><br><pre> <code class="plaintext hljs">ALTER SYSTEM SIMULATE percentage PERCENT DISK CONGESTION BETWEEN minimum AND maximum MILLISECONDS [ IN DISK index | NODE index ] FOR INTERVAL quantity { YEAR | QUARTER | MONTH | WEEK | DAY | HOUR | MINUTE | SECOND };</code> </pre> <br><h2 id="otkazy-v-mire-besservernyh-prilozheniy"> 无服务器应用程序世界崩溃 </h2><br><p> 如果您使用无服务器组件，那么失败可能是一个真正的挑战，因为无服务器服务（例如AWS Lambda）本身并不支持故障转移。 </p><br><h3 id="vvedenie-otkazov-v-funkcii-lambda"> 引入Lambda失败 </h3><br><p> 为了理解此问题，我编写了一个<a href="https://github.com/adhorn/aws-lambda-chaos-injection">小型python库</a>和一个<a href="https://github.com/adhorn/aws-lambda-layer-chaos-injection">lambda层</a> -来介绍<a href="https://aws.amazon.com/lambda/">AWS Lambda中的</a>故障。 当前，两者都支持延迟，错误，异常以及HTTP错误代码的引入。 通过如下配置<a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-parameter-store.html">AWS SSM参数存储</a>来实现故障： </p><br><pre> <code class="plaintext hljs">{ "isEnabled": true, "delay": 400, "error_code": 404, "exception_msg": "I really failed seriously", "rate": 1 }</code> </pre> <br><p> 您可以在处理函数中添加python装饰器，以引入故障。 </p><br><p>  <strong>-抛出异常：</strong> </p><br><pre> <code class="plaintext hljs">@inject_exception def handler_with_exception(event, context): return { 'statusCode': 200, 'body': 'Hello from Lambda!' } &gt;&gt;&gt; handler_with_exception('foo', 'bar') Injecting exception_type &lt;class "Exception"&gt; with message I really failed seriously a rate of 1 corrupting now Traceback (most recent call last): File "&lt;stdin&gt;", line 1, in &lt;module&gt; File "/.../chaos_lambda.py", line 316, in wrapper raise _exception_type(_exception_msg) Exception: I really failed seriously</code> </pre> <br><p>  <strong>-输入错误代码“无效的HTTP”：</strong> </p><br><pre> <code class="plaintext hljs">@inject_statuscode def handler_with_statuscode(event, context): return { 'statusCode': 200, 'body': 'Hello from Lambda!' } &gt;&gt;&gt; handler_with_statuscode('foo', 'bar') Injecting Error 404 at a rate of 1 corrupting now {'statusCode': 404, 'body': 'Hello from Lambda!'}</code> </pre> <br><p>  <strong>-输入延迟：</strong> </p><br><pre> <code class="plaintext hljs">@inject_delay def handler_with_delay(event, context): return { 'statusCode': 200, 'body': 'Hello from Lambda!' } &gt;&gt;&gt; handler_with_delay('foo', 'bar') Injecting 400 of delay with a rate of 1 Added 402.20ms to handler_with_delay {'statusCode': 200, 'body': 'Hello from Lambda!'}</code> </pre> <br><p> 单击<a href="https://github.com/adhorn/aws-lambda-chaos-injection">此处</a>以了解有关此python库的更多信息。 </p><br><h3 id="vvedenie-otkaza-v-ispolnenie-lambda-cherez-ogranichenie-parallelizma"> 通过并发限制介绍Lambda故障 </h3><br><p> 出于安全原因，默认情况下，Lambda会调整每个帐户在特定区域中所有功能的并行执行。 并行执行是指功能代码在任何单个时间点发生的多次执行。 它们用于将函数调用扩展到传入的请求。 但这可以达到相反的目的：停止执行Lambda。 </p><br><pre> <code class="plaintext hljs">❯ aws lambda put-function-concurrency --function-name &lt;value&gt; --reserved-concurrent-executions 0</code> </pre> <br><p> 此命令会将并行性降低为零，从而导致查询失败，并显示诸如“制动”-DTC <code>429</code>类的错误。 </p><br><h3 id="thundra---trassirovka-besservernyh-peredach">  Thundra-无服务器传输跟踪 </h3><br><p>  <a href="https://www.thundra.io/"><strong>Thundra</strong></a>是一种无服务器应用程序监视工具，具有将故障注入无服务器应用程序的内置功能。 他使用<a href="https://docs.thundra.io/docs/python-span-listeners">包装处理程序</a>来引入故障，例如使用DynamoDB进行操作时“无错误处理程序”，数据源“无错误中和”或“输出HTTP请求中无超时”。 我自己还没有尝试过，但是在这篇有关<a href="https://twitter.com/theburningmonk">严翠</a>的作者的<a href="https://blog.thundra.io/chaos-test-your-lambda-functions-with-thundra">帖子</a>中以及在<a href="https://twitter.com/mavi888uy">Marsha Villalba的</a>这段<a href="https://www.youtube.com/watch%3Fv%3DTpoN1wm2bok">宏伟的视频中</a> <a href="https://twitter.com/mavi888uy">，对</a>过程进行了很好的描述。 看起来很有希望。 </p><br><p> 在关于无服务器应用程序这一节的总结中，我将说Yan Chui在<a href="https://hackernoon.com/how-can-we-apply-the-principles-of-chaos-engineering-to-aws-lambda-80f87e3237e2">一篇</a>关于无服务器应用程序混乱工程的困难方面<a href="https://hackernoon.com/how-can-we-apply-the-principles-of-chaos-engineering-to-aws-lambda-80f87e3237e2">的文章非常出色</a> 。 我建议大家阅读。 </p><br><h2 id="4---vvedenie-otkazov-na-urovne-infrastruktury">  4-在基础架构级别引入故障 </h2><br><p> 一切始于在基础架构级别引入故障-对于<a href="https://medium.com/%40adhorn/chaos-engineering-ab0cc9fbd12a">Amazon和Netflix。</a> 在基础架构级别引入故障-从断开整个数据中心的连接到随机停止实例-可能是最容易实现的。 </p><br><p> 当然，首先想到“ <a href="https://github.com/Netflix/chaosmonkey">混乱的猴子</a> ”的例子。 </p><br><h3 id="ostanovka-instansov-ec2-vybrannyh-sluchayno-v-nekotoroy-zone-dostupnosti"> 停止在某个可用性区域中随机选择的EC2实例。 </h3><br><p> 在起步阶段，Netflix希望引入严格的架构规则。 他将“混乱的猴子”部署为安装自动缩放无状态微服务的首批AWS应用程序之一-从某种意义上说，任何实例都可以自动销毁或替换，而不会造成任何状态损失。 混沌猴子确保没有人违反这一规则。 </p><br><p> 下一个场景（类似于“混乱的猴子”）是在同一区域内的特定可用性区域中随机停止任何实例。 </p><br><pre> <code class="plaintext hljs">❯ stop_random_instance(az="eu-west-1a", tag_name="chaos", tag_value="chaos-ready", region="eu-west-1")</code> </pre> <br><pre> <code class="plaintext hljs">import boto3 import random REGION = 'eu-west-1' def stop_random_instance(az, tag_name, tag_value, region=REGION): ''' &gt;&gt;&gt; stop_random_instance(az="eu-west-1a", tag_name='chaos', tag_value="chaos-ready", region='eu-west-1') ['i-0ddce3c81bc836560'] ''' ec2 = boto3.client("ec2", region_name=region) paginator = ec2.get_paginator('describe_instances') pages = paginator.paginate( Filters=[ { "Name": "availability-zone", "Values": [ az ] }, { "Name": "tag:" + tag_name, "Values": [ tag_value ] } ] ) instance_list = [] for page in pages: for reservation in page['Reservations']: for instance in reservation['Instances']: instance_list.append(instance['InstanceId']) print("Going to stop any of these instances", instance_list) selected_instance = random.choice(instance_list) print("Randomly selected", selected_instance) response = ec2.stop_instances(InstanceIds=[selected_instance]) return response</code> </pre> <br><p> 您是否<code>tag_name</code> <code>tag_value</code>和<code>tag_value</code> ？ 这样的小事将防止错误实例的失败。  #lessonlearned </p><br><p><img src="https://habrastorage.org/webt/fj/a3/uq/fja3uq8zoomlzrr4zomp1ycnh3k.jpeg"><br>  <em>是的...重新启动数据库-做得好[糟糕，不是该实例]</em> </p><br><h2 id="5---vvedenie-otkazov-i-instrumenty-orkestracii-tipa-vse-v-odnom">  5-故障介绍和多合一编排工具 </h2><br><p> 您可能迷失了太多工具。 幸运的是，有很多拒绝介绍和编排工具，其中包括大多数，并且易于使用。 </p><br><h3 id="chaos-toolkit"> 混沌工具包 </h3><br><p> 我最喜欢的工具之一是<a href="https://github.com/chaostoolkit">Chaos Toolkit</a> ，这是一个由伟大的<a href="https://chaosiq.io/">ChaosIQ</a>团队提供商业支持的开源混沌工程平台。 以下是其中一些： <a href="https://twitter.com/russmiles">Russ Miles</a> ， <a href="https://twitter.com/lawouach">Sylvain Helleguarch</a>和<a href="https://twitter.com/mperrien">Marc Parrien</a> 。 </p><br><p>  Chaos Toolkit定义了一个声明性和可扩展的API，可方便地进行混沌工程实验。 它包括适用于AWS，Google Cloud Engine，Microsoft Azure，Cloud Foundry，Humino，Prometheus和Gremlin的驱动程序。 </p><br><p> 扩展是用于实验的一组检查和操作，如下所示：如果<code>tag-key</code>包含<code>chaos-ready</code>值，我们将在特定的可用区域中停止随机选择的实例。 </p><br><pre> <code class="plaintext hljs">{ "version": "1.0.0", "title": "What is the impact of randomly terminating an instance in an AZ", "description": "terminating EC2 instance at random should not impact my app from running", "tags": ["ec2"], "configuration": { "aws_region": "eu-west-1" }, "steady-state-hypothesis": { "title": "more than 0 instance in region", "probes": [ { "provider": { "module": "chaosaws.ec2.probes", "type": "python", "func": "count_instances", "arguments": { "filters": [ { "Name": "availability-zone", "Values": ["eu-west-1c"] } ] } }, "type": "probe", "name": "count-instances", "tolerance": [0, 1] } ] }, "method": [ { "type": "action", "name": "stop-random-instance", "provider": { "type": "python", "module": "chaosaws.ec2.actions", "func": "stop_instance", "arguments": { "az": "eu-west-1c" }, "filters": [ { "Name": "tag-key", "Values": ["chaos-ready"] } ] }, "pauses": { "after": 60 } } ], "rollbacks": [ { "type": "action", "name": "start-all-instances", "provider": { "type": "python", "module": "chaosaws.ec2.actions", "func": "start_instances", "arguments": { "az": "eu-west-1c" }, "filters": [ { "Name": "tag-key", "Values": ["chaos-ready"] } ] } } ] }</code> </pre> <br><p> 进行上述实验很简单： </p><br><pre> <code class="plaintext hljs">❯ chaos run experiment_aws_random_instance.json</code> </pre> <br><p><img src="https://habrastorage.org/webt/0l/tb/qz/0ltbqz2b-ppule8qm6xxn0jb6p4.png"></p><br><p>  Chaos Toolkit的优势在于，首先，它是开源的，可以根据您的需求进行定制。 其次，它非常适合CI / CD管道，并支持连续的混乱测试。 </p><br><p>  Chaos Toolkit的缺点是需要花费时间来掌握它。 而且，其中没有现成的实验，因此您必须自己编写它们。 但是，我熟悉ChaosIQ的团队，该团队不懈地工作，了解此任务。 </p><br><h3 id="gremlin"> 格林姆林 </h3><br><p> 我的另一个最爱是Gremlin。 它包含一组全面的模式，用于在具有直观用户界面的简单工具中引入故障。 这样的混乱即服务。 </p><br><p>  Gremlin支持在<a href="https://www.gremlin.com/docs/infrastructure-layer/attacks/">资源，网络和查询</a>级别引入故障，使您可以快速尝试整个系统，包括 硬件，各种云提供商，容器化环境（包括Kubernetes），应用程序以及某种程度上无服务器的应用程序。 </p><br><p> 再加上奖金-来自<a href="https://twitter.com/GremlinInc">Gremlin</a>的家伙<a href="https://twitter.com/GremlinInc">们</a>很棒，为<a href="https://www.gremlin.com/blog/">博客</a>写了很多精彩的<a href="https://www.gremlin.com/blog/">文章</a> ，并随时准备提供帮助！ 以下是其中一些： <a href="https://twitter.com/callmeforni">Matthew</a> ， <a href="https://twitter.com/KoltonAndrus">Colton</a> ， <a href="https://twitter.com/tammybutow">Tammy</a> ， <a href="https://twitter.com/richburroughs">Rich</a> ， <a href="https://twitter.com/Ana_M_Medina">Ana</a>和<a href="https://twitter.com/HoReaL">HML</a> 。 </p><br><p>  Gremlin无处可使用： </p><br><p> 首先进入Gremlin应用程序，然后选择“创建攻击”。 </p><br><p><img src="https://habrastorage.org/webt/xw/cv/m9/xwcvm9psqdr8uottkvc2nt4kexi.png"></p><br><p> 分配目标-实例。 </p><br><p><img src="https://habrastorage.org/webt/v_/2v/u7/v_2vu75wvlrzgdem88t2ml0rggu.png"></p><br><p> 选择您要引入的故障类型，否则可能会造成混乱！ </p><br><p><img src="https://habrastorage.org/webt/bx/oq/ox/bxoqoxv4vvxlayqtbtwpgkxd_yw.png"></p><br><p> 我必须承认，我一直都很喜欢Gremlin：与他一起，混沌工程的实验非常直观。 </p><br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">减价</font></font><a href="https://www.gremlin.com/pricing/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">政策</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -工作需要许可证，该许可证可能不适合新手用户或一次性工作。</font><font style="vertical-align: inherit;">但是，最近添加了其免费版本。</font><font style="vertical-align: inherit;">而且，Gremlin客户端和守护程序需要安装在需要受到攻击的实例中，这并不是每个人都喜欢的。</font></font></p><br><h3 id="run-command-ot-aws-system-manager"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 从AWS System Manager运行命令 </font></font></h3><br><p>  <a href="https://aws.amazon.com/blogs/aws/new-ec2-run-command-remote-instance-management-at-scale/">Run command    EC2</a> ,   2015 ,       .           —   2,      <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-managedinstances.html"> </a> .       ,       ,   Systems Manager. </p><br><p> Run Command    DevOps   ad-hoc  ,      . </p><br><p>   ,  Run Command            ,        Windows,       -. </p><br><p>       <a href="https://medium.com/%40adhorn/injecting-chaos-to-amazon-ec2-using-amazon-system-manager-ca95ee7878f5">    AWS System Manager</a>   <a href="https://github.com/adhorn/chaos-ssm-documents">  </a>    .  — ! </p><br><h2 id="zakruglyaemsya"> ! </h2><br><p>     ,          . </p><br><p> 1 — - —    ,     -   .  .          —    , —     , ,    .   ,     !    <a href="https://twitter.com/ovhall"> </a> : </p><br><blockquote> "  .      ". <br> — ,    - Amazon Prime Video </blockquote><p> 2 —    , ,        .                ,        -. </p><br><p> 3 —        ,        ,    . </p><br><p> 4 — , , ,     . ,  - —        ,     . </p><br><p>    , , ,    . ,    . ,     ,       :-) </p><br><p> —  </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN480802/">https://habr.com/ru/post/zh-CN480802/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN480790/index.html">“工厂效率”。 找到瓶颈并实施拉动系统以提高生产率</a></li>
<li><a href="../zh-CN480792/index.html">礼品工程</a></li>
<li><a href="../zh-CN480794/index.html">关于开门搜索算法实施的特殊情况</a></li>
<li><a href="../zh-CN480796/index.html">Schrodinger程序员，开发者和猫</a></li>
<li><a href="../zh-CN480800/index.html">寻找工作测试仪？ 准备展示开发人员技能</a></li>
<li><a href="../zh-CN480804/index.html">选择完美的3D设计系统</a></li>
<li><a href="../zh-CN480806/index.html">我喜欢自定义CSS属性的5大原因</a></li>
<li><a href="../zh-CN480810/index.html">如何为数字化转型做准备？ 提前销毁您的业务</a></li>
<li><a href="../zh-CN480812/index.html">Nvidia RTX-实时光线追踪技术终于出现在SOLIDWORKS Visualize中</a></li>
<li><a href="../zh-CN480816/index.html">Lamoda上的Dynamics 365和Power Platform聚会-公告</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>