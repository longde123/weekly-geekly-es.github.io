<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßü ü•Ç üëñ Desarrollo de su propio n√∫cleo para incrustar en un sistema de procesador basado en FPGA ‚úàÔ∏è üçç üî∫</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Entonces, en el primer art√≠culo del ciclo , se dijo que es mejor usar un sistema de procesador para controlar nuestro equipo implementado usando FPGAs...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Desarrollo de su propio n√∫cleo para incrustar en un sistema de procesador basado en FPGA</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/454938/"><img src="https://habrastorage.org/webt/ze/eo/9f/zeeo9fw5rmqp8pk7lsmr0cytbve.jpeg"><br><br>  Entonces, en el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">primer art√≠culo del ciclo</a> , se dijo que es mejor usar un sistema de procesador para controlar nuestro equipo implementado usando FPGAs para el complejo Redd, despu√©s de lo cual durante el primer y segundo art√≠culo se mostr√≥ c√≥mo hacer este sistema.  Bueno, est√° hecho, incluso podemos elegir algunos n√∫cleos listos de la lista para incluirlos en √©l, pero el objetivo final es administrar nuestros propios n√∫cleos personalizados.  Ha llegado el momento de considerar c√≥mo incluir un n√∫cleo arbitrario en el sistema del procesador. <br><a name="habracut"></a><br>  Todos los art√≠culos del ciclo: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Desarrollo del "firmware" m√°s simple para FPGAs instalados en Redd, y depuraci√≥n utilizando la prueba de memoria como ejemplo</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Desarrollo del "firmware" m√°s simple para FPGAs instalados en Redd.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Parte 2. C√≥digo del programa</a> <br><br>  Para comprender la teor√≠a de hoy, debe encontrar y descargar el documento de <b>especificaciones de la interfaz de Avalon</b> , ya que el bus <b>Avalon</b> es el bus base para el sistema NIOS II.  Me referir√© a secciones, tablas y figuras para la revisi√≥n del documento del 26 de septiembre de 2018. <br><br>  Abrimos la secci√≥n 3 dedicada a las interfaces mapeadas de memoria, o m√°s bien - 3.2.  La Tabla 9 enumera las se√±ales del bus.  Tenga en cuenta que todas estas se√±ales son opcionales.  No encontr√© una sola se√±al que tuviera "S√≠" en la columna Requerido.  Es posible que no enviemos esta o aquella se√±al a nuestro dispositivo.  Por lo tanto, en el caso m√°s simple, el bus es extremadamente simple de implementar.  El comienzo de la tabla se ve as√≠: <br><br><img src="https://habrastorage.org/webt/qj/et/kn/qjetkngv8gubiwwtqtx8atvab7c.png"><br><br>  Como puede ver, todas las se√±ales est√°n muy bien descritas (excepto que esto se hace en ingl√©s).  A continuaci√≥n se muestran los cuadros de tiempo para varios casos.  El caso m√°s simple no plantea ninguna pregunta.  Ahora tomar√© el diagrama de tiempo del documento y cubrir√© algunas de las l√≠neas con un relleno transl√∫cido (todas son opcionales, tenemos el derecho de excluir cualquiera de las consideraciones). <br><br><img src="https://habrastorage.org/webt/q4/oz/w_/q4ozw_efgf6v6adbdhnkdeacply.png"><br><br>  Miedo  Pero todo es simple: se nos da la direcci√≥n y la luz estrobosc√≥pica de <b>lectura</b> , debemos configurar los datos en el bus readdata.  Y viceversa: se nos da la direcci√≥n, los datos en el bus de escritura de datos y la luz estrobosc√≥pica de escritura, y tenemos que ajustar los datos.  No es para nada aterrador, un bus sincr√≥nico t√≠pico. <br><br>  <b>Se</b> necesitan l√≠neas ocultas byteenable para el caso cuando el acceso a la memoria no es palabras de 32 bits.  Esto es extremadamente importante cuando dise√±amos n√∫cleos universales.  Pero cuando dise√±amos un n√∫cleo de un d√≠a, simplemente escribimos en el documento sobre este n√∫cleo (soy un oponente de la marca en mi cabeza, pero alguien puede limitarlo a esto) que necesitamos usar palabras de 32 bits y eso es todo.  Bueno, y la se√±al de <b>respuesta</b> , es muy especial, y no nos interesa en principio. <br><br>  Algunas veces es importante que cuando el equipo no est√© listo, sea posible retrasar la operaci√≥n del bus por varios ciclos de reloj.  En este caso, se debe agregar la se√±al <b>WaitRequest</b> .  La tabla de tiempos cambiar√° de la siguiente manera: <br><br><img src="https://habrastorage.org/webt/sy/hr/lf/syhrlf64dvm-zrr262xvveicea4.png"><br><br>  Mientras <b>WaitRequest est√° activado</b> , el asistente sabe que nuestro dispositivo est√° ocupado.  Tenga cuidado si esta se√±al no se restablece, todo el sistema se "congelar√°" al manipularlo, por lo que solo un reinicio del FPGA puede restablecerlo.  JTAG se cuelga con el sistema.  La √∫ltima vez que observ√© este fen√≥meno fue en la preparaci√≥n de este art√≠culo, por lo que los recuerdos a√∫n son v√≠vidos. <br><br>  Adem√°s, en el documento de la compa√±√≠a se consideran casos m√°s productivos de canalizaci√≥n de datos y transacciones por lotes, pero la tarea del art√≠culo no es considerar todas las opciones posibles, sino mostrarle al lector la forma de trabajar, enfatizando que todo esto no da miedo, por lo que nos limitaremos a estas dos opciones simples. <br><br>  Dise√±emos un dispositivo simple que peri√≥dicamente no estar√° disponible en el bus.  Lo primero que viene a la mente es la interfaz en serie.  Mientras la transmisi√≥n est√© en progreso, haremos que el sistema espere.  Y en la vida, aconsejo encarecidamente que no haga esto: el procesador se detendr√° hasta el final de una transacci√≥n ocupada, pero este es un caso ideal para un art√≠culo, ya que el c√≥digo de implementaci√≥n ser√° comprensible y no muy engorroso.  En general, haremos un transmisor en serie que pueda enviar datos y se√±ales de selecci√≥n de chips a dos dispositivos. <br><br><img src="https://habrastorage.org/webt/fr/uj/_u/fruj_ufw0phhzgbovupezinxo6c.png"><br><br>  Comencemos con la opci√≥n de llanta m√°s simple.  Hagamos un puerto de salida paralelo, que forma las se√±ales de la elecci√≥n de los cristales. <br><br><img src="https://habrastorage.org/webt/rc/z6/yg/rcz6ygig6s3yz-bxsjwsbonygp4.png"><br><br>  Para esto, tomar√© el proyecto obtenido en el art√≠culo anterior, pero para evitar confusiones, lo pondr√© en el directorio AVALON_DEMO.  No cambiar√© los nombres de otros archivos.  En este directorio, cree el directorio <b>my_cores</b> .  El nombre del directorio puede ser cualquier cosa.  Almacenaremos nuestros n√∫cleos en √©l.  Es cierto, hoy ser√° uno.  Cree un archivo <b>CrazySerial.sv</b> con el siguiente contenido: <br><pre><code class="plaintext hljs">module CrazySerial ( input clk, input reset, input [1:0] address, input write, input [31:0] writedata, output reg [1:0] cs ); always @(posedge clk, posedge reset) begin if (reset == 1) begin cs &lt;= 0; end else begin if (write) case (address) 2'h00: cs &lt;= writedata [1:0]; default:; endcase end end endmodule</code> </pre> <br>  Vamos a hacerlo bien.  En primer lugar, las l√≠neas de interfaz.  <b>clk</b> y <b>reset</b> son las l√≠neas de reloj y reset.  Los nombres de las <b>direcciones</b> , <b>escribir</b> y <b>escribir</b> <b>l√≠neas de datos</b> se toman de la tabla con la lista de se√±ales del documento de <b>Interfaces Mapeadas de Memoria</b> . <br><br><img src="https://habrastorage.org/webt/lz/q9/rv/lzq9rvmj8mekwwiqqene5mvbu7i.png"><br><br><img src="https://habrastorage.org/webt/pe/xz/a-/pexza-dsswt01-shzs4sy0pkjay.png"><br><br>  De hecho, podr√≠a dar cualquier nombre.  Vincular las l√≠neas l√≥gicas con las f√≠sicas se realizar√° m√°s adelante.  Pero si da los nombres, como en la tabla, el entorno de desarrollo los conectar√° por s√≠ mismo.  Por lo tanto, es mejor tomar los nombres de la tabla. <br><br>  Bueno, <b>cs</b> son las l√≠neas de selecci√≥n de cristal que saldr√°n del chip. <br><br>  La implementaci√≥n en s√≠ es trivial.  Cuando se reinicia, las salidas se ponen a cero.  Y as√≠, en cada medida verificamos si hay una se√±al de <b>escritura</b> .  Si hay una direcci√≥n igual a cero, haga clic en los datos.  Por supuesto, ser√≠a posible agregar un decodificador aqu√≠, lo que evitar√° la elecci√≥n de dos dispositivos a la vez, pero lo que es bueno en la vida sobrecargar√° el art√≠culo.  El art√≠culo proporciona solo los pasos m√°s necesarios, sin embargo, se observa que en la vida todo se puede hacer m√°s complicado. <br><br>  Genial  Estamos listos para introducir este c√≥digo en el sistema del procesador.  Vamos a <b>Platform Designer</b> , seleccionamos como archivo de entrada el sistema que creamos en experimentos anteriores: <br><br><img src="https://habrastorage.org/webt/vd/a3/mp/vda3mpnhkbmfl9gj037h7kyefs8.png"><br><br>  Llamamos la atenci√≥n sobre el elemento <b>Nuevo componente</b> en la esquina superior izquierda: <br><br><img src="https://habrastorage.org/webt/iz/xq/hw/izxqhw8wg6jshahucg0ardu7ukg.png"><br><br>  Para agregar su componente, haga clic en este elemento.  En el cuadro de di√°logo que se abre, complete los campos.  Y para el art√≠culo, complete solo el nombre del componente: <br><br><img src="https://habrastorage.org/webt/nn/l8/mt/nnl8mtcsdxmqyp6cjnkrcr-qlc0.png"><br><br>  Ahora vaya a la pesta√±a <b>Archivos</b> y haga clic en <b>Agregar archivo</b> : <br><br><img src="https://habrastorage.org/webt/fo/rw/jx/forwjxin05orcsaaw7uuuiw1mra.png"><br><br>  Agregue el archivo creado anteriormente, selecci√≥nelo en la lista y haga clic en <b>Analizar archivo de s√≠ntesis</b> : <br><br><img src="https://habrastorage.org/webt/a_/-i/g0/a_-ig0-b-v--safmwwco-gcblvi.png"><br><br>  No hay errores al analizar <b>SystemVerilog</b> , pero hay varios errores conceptuales.  Son causados ‚Äã‚Äãpor el hecho de que algunas l√≠neas estaban conectadas incorrectamente por el entorno de desarrollo.  Vamos a la pesta√±a <b>Se√±ales e interfaces</b> y prestamos atenci√≥n aqu√≠: <br><br><img src="https://habrastorage.org/webt/be/7s/nb/be7snb0yjnqj8qn-ku_dboeirjs.png"><br><br>  Las l√≠neas <b>cs</b> se asignaron incorrectamente a la interfaz <b>avalon_slave0</b> , la se√±al <b>readdata</b> .  Pero luego todas las otras l√≠neas se reconocieron correctamente, gracias al hecho de que les dimos nombres de la tabla de documentos.  ¬øPero qu√© hacer con las l√≠neas problem√°ticas?  Deben asignarse a una interfaz como <b>conducto</b> .  Para hacer esto, haga clic en el elemento "agregar interfaz" <br><br><img src="https://habrastorage.org/webt/ur/ce/je/urcejebzbrayxcoyvs16vorleik.png"><br><br>  En el men√∫ desplegable, seleccione <b>conducto</b> : <br><br><img src="https://habrastorage.org/webt/2-/l-/45/2-l-45h1b_8jnat3uazcscgcpt0.png"><br><br>  Obtenemos una nueva interfaz: <br><br><img src="https://habrastorage.org/webt/g_/r4/j0/g_r4j0acbfvawp7plewjmsolw1e.png"><br><br>  Si lo desea, puede cambiarle el nombre.  Es cierto que esto sin duda ser√° necesario si queremos hacer varias interfaces externas.  Como parte del art√≠culo, le dejaremos el nombre <b>conduit_end</b> .  Ahora conectamos la l√≠nea <b>cs</b> con el mouse y la arrastramos a esta interfaz.  Debemos lograr lanzar una se√±al debajo de la l√≠nea <b>conduit_end</b> , luego se nos permitir√° hacer esto.  En otros lugares, el cursor aparecer√° como un c√≠rculo tachado.  Al final, deber√≠amos tener esto: <br><br><img src="https://habrastorage.org/webt/gb/2e/lw/gb2elw6dvx2iw11y28uq0qlye5q.png"><br><br>  Reemplace el tipo de se√±al con <b>readdata</b> con, digamos, <b>chipselect</b> .  Imagen final: <br><br><img src="https://habrastorage.org/webt/6o/ur/gq/6ourgq054tn85rth2nixk33_pvs.png"><br><br>  Pero los errores permanecieron.  El <b>bus avalon</b> no tiene asignada una se√±al de reinicio.  Seleccionamos <b>avalon_slave_0</b> de la lista y miramos sus propiedades. <br><br><img src="https://habrastorage.org/webt/s6/0i/--/s60i--4ijigk6exutkovd5zlwi0.png"><br><br>  Reemplace <b>ninguno</b> con <b>reinicio</b> .  Al mismo tiempo, examinaremos las otras propiedades de la interfaz. <br><br><img src="https://habrastorage.org/webt/xn/4d/kf/xn4dkf5jpxsi-6ujubxeuptddo4.png"><br><br>  Se puede ver que el direccionamiento es en palabras.  Bueno, aqu√≠ se configuran otras cosas de la documentaci√≥n.  Los diagramas de tiempo que se obtienen en este caso se dibujar√°n en la parte inferior de las propiedades: <br><br><img src="https://habrastorage.org/webt/xc/nw/xq/xcnwxqjxkz7y4qgxtcmn6ulb5eu.png"><br><br>  En realidad, no hay m√°s errores.  Puedes hacer clic en <b>Finalizar</b> .  Nuestro m√≥dulo creado apareci√≥ en el √°rbol de dispositivos: <br><br><img src="https://habrastorage.org/webt/rt/qe/bz/rtqebza22wictmnw0cpgvw_uu3g.png"><br><br>  Agr√©guelo al sistema del procesador, conecte las se√±ales del reloj y reinicie.  Conectamos el bus de <b>datos al</b> procesador <b>Data Master</b> .  Haga doble clic en <b>Conduit_end</b> y <b>asigne</b> a la se√±al externa un nombre, por ejemplo, <b>l√≠neas</b> .  Resulta de alguna manera as√≠: <br><br><img src="https://habrastorage.org/webt/ob/mm/al/obmmalo6x1jytho2mzkvy4emdbu.png"><br><br>  Es importante no olvidar que, dado que agregamos un bloque al sistema, debemos asegurarnos de que no entre en conflicto con nadie en el espacio de direcciones.  En este caso particular, no hay conflictos en la figura, pero de todos modos, seleccionar√© el elemento del men√∫ <b>Sistema-&gt; Asignar direcciones base</b> . <br><br>  Eso es todo.  El bloque se crea, configura y agrega al sistema.  Haga clic en el bot√≥n <b>Generar HDL</b> , luego en <b>Finalizar</b> . <br><br>  Hacemos un borrador del proyecto, luego de lo cual vamos al <b>Pin Planner</b> y asignamos las piernas.  Result√≥ as√≠: <br><br><img src="https://habrastorage.org/webt/mn/fs/39/mnfs39ezihwpwese2tsdto4ialc.png"><br><br>  Que corresponde a los contactos B22 y C22 del conector de interfaz. <br><br>  Hacemos el ensamblaje final, cargamos el sistema del procesador en el FPGA.  Ahora necesitamos refinar el c√≥digo del programa.  Lanzamiento de Eclipse. <br><br>  Perm√≠tame recordarle que actualmente estoy trabajando con un proyecto que se encuentra en un directorio diferente en relaci√≥n con mi √∫ltimo trabajo con Redd.  Para no confundirme, eliminar√© proyectos antiguos del √°rbol (pero solo del √°rbol, sin borrar los archivos mismos). <br><br><img src="https://habrastorage.org/webt/xm/jv/ch/xmjvchikm8_ukin_evoqdw28op8.png"><br><br>  A continuaci√≥n, hago clic con el bot√≥n derecho del mouse en un √°rbol vac√≠o y selecciono <b>Importar</b> en el men√∫: <br><br><img src="https://habrastorage.org/webt/yp/kt/sf/ypktsfboxaxgfhqcubjnlwogoxq.png"><br><br>  Siguiente - <b>General-&gt; Proyecto existente en el espacio de trabajo</b> : <br><br><img src="https://habrastorage.org/webt/rb/dw/me/rbdwmebel6yu6hjmvyxn7hik0q8.png"><br><br>  Y simplemente seleccione el directorio en el que se almacenan los archivos del proyecto: <br><br><img src="https://habrastorage.org/webt/nd/3t/6h/nd3t6hwmddm9pfrwr4cjd4iw4hy.png"><br><br><img src="https://habrastorage.org/webt/ei/qg/de/eiqgdehf_klzhkyyleod_opnlgq.png"><br><br>  Ambos proyectos heredados de experimentos anteriores se conectar√°n al entorno de desarrollo. <br><br><img src="https://habrastorage.org/webt/qq/vw/jk/qqvwjkfgoli7vu3wedt3qhbnsf0.png"><br><br>  Destacar√© el siguiente elemento en un marco: <br><blockquote>  Cada vez que cambie la configuraci√≥n del hardware, seleccione el elemento <b>Nios II -&gt; Generar</b> men√∫ <b>BSP</b> para el proyecto BSP nuevamente. </blockquote><br><br><img src="https://habrastorage.org/webt/ks/jn/mt/ksjnmtcdfbf2p0vej4qeeltlkxk.png"><br><br>  En realidad, despu√©s de esta operaci√≥n, apareci√≥ un nuevo bloque en el <b>archivo \ AVALON_DEMO \ software \ SDRAMtest_bsp \ system.h</b> : <br><pre> <code class="plaintext hljs">/* * CrazySerial_0 configuration * */ #define ALT_MODULE_CLASS_CrazySerial_0 CrazySerial #define CRAZYSERIAL_0_BASE 0x4011020 #define CRAZYSERIAL_0_IRQ -1 #define CRAZYSERIAL_0_IRQ_INTERRUPT_CONTROLLER_ID -1 #define CRAZYSERIAL_0_NAME "/dev/CrazySerial_0" #define CRAZYSERIAL_0_SPAN 16 #define CRAZYSERIAL_0_TYPE "CrazySerial"</code> </pre><br>  En primer lugar, estamos interesados ‚Äã‚Äãen la constante <b>CRAZYSERIAL_0_BASE</b> . <br><br>  Agregue el siguiente c√≥digo a la funci√≥n <b>main ()</b> : <br><pre> <code class="plaintext hljs"> while (true) { IOWR_ALTERA_AVALON_PIO_DATA (CRAZYSERIAL_0_BASE,0x00); IOWR_ALTERA_AVALON_PIO_DATA (CRAZYSERIAL_0_BASE,0x01); IOWR_ALTERA_AVALON_PIO_DATA (CRAZYSERIAL_0_BASE,0x02); IOWR_ALTERA_AVALON_PIO_DATA (CRAZYSERIAL_0_BASE,0x03); }</code> </pre><br>  Comenzamos a depurar y miramos el contenido de las l√≠neas con un osciloscopio.  Debe haber un c√≥digo binario incremental.  El esta ahi. <br><br><img src="https://habrastorage.org/webt/fm/xp/0z/fmxp0z5mactvzv-vdv2cahbvj1i.png"><br><br>  Adem√°s, la frecuencia de acceso a los puertos es simplemente maravillosa: <br><br><img src="https://habrastorage.org/webt/cm/rd/of/cmrdofrh6yzmo2xwdkjynz6gwwm.png"><br><br>  Aproximadamente 25 MHz es la mitad de la frecuencia del bus (2 ciclos de reloj).  A veces el tiempo de acceso no es de 2 ciclos, sino m√°s largo.  Esto se debe a la ejecuci√≥n de operaciones de ramificaci√≥n en el programa.  En general, el acceso m√°s simple al autob√∫s funciona. <br><br>  Es hora de agregar, por ejemplo, la funcionalidad del puerto serie.  Para hacer esto, agregue la se√±al de interfaz de <b>solicitud de espera</b> relacionada con el bus y un par de se√±ales de puerto serie: <b>sck</b> y <b>sdo</b> .  Total, obtenemos el siguiente fragmento de c√≥digo en <b>systemverilog</b> : <br><br><img src="https://habrastorage.org/webt/dy/wc/vt/dywcvtwz6_h4ccubotauamcnnju.png"><br><br><div class="spoiler">  <b class="spoiler_title">Mismo texto:</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">module CrazySerial ( input clk, input reset, input [1:0] address, input write, input [31:0] writedata, output waitrequest, output reg [1:0] cs, output reg sck, output sdo );</code> </pre><br></div></div><br>  De acuerdo con las reglas de buena forma, debe hacer una m√°quina simple que transmita datos.  Desafortunadamente, la m√°quina m√°s sencilla en el art√≠culo se ver√° muy dif√≠cil.  Pero, de hecho, si no aumento la funcionalidad de la m√°quina (y no voy a hacerlo dentro del marco del art√≠culo), entonces solo tendr√° dos estados: la transmisi√≥n est√° en progreso y la transmisi√≥n no est√° en progreso.  Por lo tanto, puedo codificar el estado con una sola se√±al: <br>  env√≠o de registros = 0; <br><br>  Durante la transmisi√≥n, necesito un contador de bits, un divisor de reloj (estoy haciendo un dispositivo deliberadamente lento) y un registro de desplazamiento para los datos transmitidos.  Agregue los registros apropiados: <br><pre> <code class="plaintext hljs"> reg [2:0] bit_cnt = 0; reg [3:0] clk_div = 0; reg [7:0] shifter = 0;</code> </pre><br>  Dividir√© la frecuencia por 10 (guiado por el principio de "¬øpor qu√© no?").  En consecuencia, en el quinto paso, llamar√© a SCK, y en el d√©cimo, dejar esta l√≠nea, despu√©s de lo cual, pasar√© al siguiente bit de datos.  En todas las dem√°s medidas, simplemente aumente el contador divisor.  Es importante no olvidar que en la cuarta medida tambi√©n necesita aumentar el contador, y en la novena - cero.  Si omitimos la transici√≥n al siguiente bit, la l√≥gica especificada se ve as√≠: <br><pre> <code class="plaintext hljs"> if (sending) begin case (clk_div) 4: begin sck &lt;= 1; clk_div &lt;= clk_div + 1; end 9: begin sck &lt;= 0; clk_div &lt;= 0; // &lt;   &gt; end default: clk_div &lt;= clk_div + 1; endcase end else</code> </pre><br>  Ir al siguiente bit es f√°cil.  Cambiaron el registro de desplazamiento, luego, si el bit actual es el s√©ptimo, dejaron de funcionar cambiando el estado de la m√°quina, de lo contrario aumentaron el contador de bits. <br><pre> <code class="plaintext hljs"> shifter &lt;= {shifter[6:0],1'b0}; if (bit_cnt == 7) begin sending &lt;= 0; end else begin bit_cnt &lt;= bit_cnt + 1; end</code> </pre><br>  En realidad, eso es todo.  El bit de salida siempre se toma del bit alto del registro de desplazamiento: <br><pre> <code class="plaintext hljs"> assign sdo = shifter [7];</code> </pre><br>  Y la l√≠nea m√°s importante para la revisi√≥n actual.  La se√±al de <b>solicitud de espera se activa</b> hasta la unidad siempre que se transmiten datos en serie.  Es decir, es una copia de la se√±al de <b>env√≠o</b> que establece el estado de la m√°quina: <br><pre> <code class="plaintext hljs"> assign waitrequest = sending;</code> </pre><br>  Bueno, y al escribir en la direcci√≥n 1 (recuerde, aqu√≠ tenemos el direccionamiento en palabras de 32 bits), ajustamos los datos en el registro de desplazamiento, ponemos a cero los contadores e iniciamos el proceso de transferencia: <br><pre> <code class="plaintext hljs"> if (write) //... 2'h01: begin bit_cnt &lt;= 0; clk_div &lt;= 0; sending &lt;= 1; shifter &lt;= writedata [7:0]; end default:; endcase end</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Ahora dar√© todos los fragmentos descritos como un solo texto:</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">module CrazySerial ( input clk, input reset, input [1:0] address, input write, input [31:0] writedata, output waitrequest, output reg [1:0] cs, output reg sck, output sdo ); reg sending = 0; reg [2:0] bit_cnt = 0; reg [3:0] clk_div = 0; reg [7:0] shifter = 0; always @(posedge clk, posedge reset) begin if (reset == 1) begin cs &lt;= 0; sck &lt;= 0; sending &lt;= 0; end else begin if (sending) begin case (clk_div) 4: begin sck &lt;= 1; clk_div &lt;= clk_div + 1; end 9: begin clk_div &lt;= 0; shifter &lt;= {shifter[6:0],1'b0}; sck &lt;= 0; if (bit_cnt == 7) begin sending &lt;= 0; end else begin bit_cnt &lt;= bit_cnt + 1; end end default: clk_div &lt;= clk_div + 1; endcase end else if (write) case (address) 2'h00: cs &lt;= writedata [1:0]; 2'h01: begin bit_cnt &lt;= 0; clk_div &lt;= 0; sending &lt;= 1; shifter &lt;= writedata [7:0]; end default:; endcase end end assign sdo = shifter [7]; assign waitrequest = sending; endmodule</code> </pre><br></div></div><br>  Comenzamos a introducir nuevo c√≥digo en el sistema.  En realidad, la ruta es la misma que cuando se crea el componente, pero algunos de los pasos ya pueden omitirse.  Ahora nos familiarizaremos con el proceso de refinamiento.  Vaya a <b>Dise√±ador de plataforma</b> .  Si solo cambiamos el c√≥digo verilog, ser√≠a bastante simple realizar la operaci√≥n <b>Generar HDL</b> para el sistema terminado.  Pero dado que el m√≥dulo tiene nuevas l√≠neas (es decir, la interfaz ha cambiado), necesita ser rehecho.  Para hacer esto, selecci√≥nelo en el √°rbol, presione el bot√≥n derecho del mouse y seleccione <b>Editar</b> . <br><br><img src="https://habrastorage.org/webt/sg/el/hx/sgelhxlzgzwjz81z6q7xhkhbxzs.png"><br><br>  Estamos editando un sistema existente.  Tan solo vaya a la pesta√±a <b>Archivos</b> y haga clic en <b>Analizar archivos de s√≠ntesis</b> : <br><br><img src="https://habrastorage.org/webt/qy/nw/0q/qynw0q5tul7k26yaygdyzsigouu.png"><br><br>  Predeciblemente se produjeron errores.  Pero ya sabemos que las l√≠neas equivocadas tienen la culpa.  Por lo tanto, vamos a la pesta√±a <b>Se√±ales e interfaces</b> , arrastramos <b>sck</b> y <b>sdo a lo</b> largo de la misma l√≠nea desde la interfaz <b>avalon_slave_0</b> a la interfaz <b>conduit_end</b> : <br><br><img src="https://habrastorage.org/webt/z_/rz/jj/z_rzjjaaiaqzey6gczf6ptt0vfa.png"><br><br>  Tambi√©n cambie el nombre de los campos de <b>Tipo de se√±al</b> para ellos.  El resultado debe ser el siguiente: <br><br><img src="https://habrastorage.org/webt/ng/3_/t_/ng3_t_kiebqf_jw3wwljh0aqsig.png"><br><br>  En realidad, eso es todo.  Haga clic en <b>Finalizar</b> , llame a <b>Generar archivo HDL</b> para el sistema del procesador, redacte el proyecto en Quartus, asigne nuevos tramos: <br><br><img src="https://habrastorage.org/webt/ul/hg/rh/ulhgrhytzp1y9149j8x11apyvcy.png"><br><br>  Estos son los contactos A21 y A22 del conector de interfaz, hacemos el ensamblaje final, completamos el "firmware" en el FPGA. <br><br>  Plancha actualizada.  Ahora el programa.  Vamos a Eclipse.  ¬øQu√© recordamos hacer all√≠?  As√≠ es, no te olvides de elegir <b>Generate BSP</b> . <br><br>  En realidad, eso es todo.  Queda por agregar funcionalidad al programa.  Transfieramos un par de bytes al puerto serie, pero enviaremos el primer byte al dispositivo seleccionado por la l√≠nea <b>cs [0]</b> y el segundo - <b>cs [1]</b> . <br><pre> <code class="plaintext hljs"> IOWR_ALTERA_AVALON_PIO_DATA (CRAZYSERIAL_0_BASE,0x01); IOWR_ALTERA_AVALON_PIO_DATA (CRAZYSERIAL_0_BASE+4,0x12); IOWR_ALTERA_AVALON_PIO_DATA (CRAZYSERIAL_0_BASE,0x02); IOWR_ALTERA_AVALON_PIO_DATA (CRAZYSERIAL_0_BASE+4,0x34); IOWR_ALTERA_AVALON_PIO_DATA (CRAZYSERIAL_0_BASE,0x00);</code> </pre><br>  Tenga en cuenta que no hay controles de disponibilidad all√≠.  Las parcelas van una tras otra.  Sin embargo, en el osciloscopio todo result√≥ bastante consistente <br><br><img src="https://habrastorage.org/webt/vh/qm/ig/vhqmigcblrnmmcizbs11jwdgsig.png"><br><br>  El rayo amarillo es <b>cs [0]</b> , el <b>rayo</b> verde es <b>sdo</b> , el <b>rayo</b> violeta es <b>sck</b> y el <b>rayo</b> azul es <b>cs [1]</b> .  Se puede ver que el c√≥digo 0x12 fue al primer dispositivo, 0x34 al segundo. <br><br>  La lectura se realiza de manera similar, pero no puedo encontrar ning√∫n ejemplo hermoso, excepto la lectura banal del contenido del pie del conector.  Pero ese ejemplo es tan degenerado que ni siquiera es interesante hacerlo.  Pero aqu√≠ vale la pena se√±alar que al leer esta configuraci√≥n de bus puede ser extremadamente importante: <br><br><img src="https://habrastorage.org/webt/m4/7g/i6/m47gi6xbkat-jct5iuuffqmyya8.png"><br><br>  Si hay una l√≠nea de <b>Lectura</b> , aparecer√° un cuadro de tiempo de lectura en el cuadro de di√°logo de configuraci√≥n.  Y mostrar√° la influencia de este par√°metro.  Al leer las patas del conector, a√∫n no se notar√°, pero al leer desde el mismo FIFO o RAM, completamente.  La RAM se puede configurar para emitir datos inmediatamente despu√©s de que se env√≠e la direcci√≥n, o se puede emitir sincr√≥nicamente.  En el segundo caso, se agrega latencia.  Despu√©s de todo, el bus estableci√≥ la direcci√≥n, configur√≥ la luz estrobosc√≥pica ... Pero no hay datos en el borde m√°s cercano de la se√±al del reloj.  Aparecer√°n despu√©s de este frente ... Es decir, el sistema tiene una latencia de latencia √∫nica.  Y solo debe tenerse en cuenta al configurar este par√°metro.  En resumen, si no est√° leyendo lo que se esperaba, primero verifique si necesita configurar la latencia.  El resto: leer no es diferente de escribir. <br><br>  Bien, perm√≠tame recordarle una vez m√°s que es mejor no eliminar la preparaci√≥n del bus para operaciones a largo plazo, de lo contrario es muy posible reducir dr√°sticamente el rendimiento del sistema.  La se√±al de listo es buena para mantener la transacci√≥n durante un par de ciclos de reloj, y no hasta 80 ciclos de reloj, como en mi ejemplo.  Pero, en primer lugar, cualquier otro ejemplo ser√≠a inconveniente para el art√≠culo y, en segundo lugar, para los n√∫cleos de un d√≠a, esto es bastante aceptable.  Estar√° completamente consciente de sus acciones y evitar√° situaciones en las que el autob√∫s est√© bloqueado.  Es cierto que si el n√∫cleo sobrevive el tiempo que se le asigna, tal suposici√≥n puede arruinar la vida en el futuro, cuando todos se olviden de ello, y ralentizar√° todo.  Pero ser√° m√°s tarde. <br><br>  Sin embargo, hemos aprendido a hacer que el n√∫cleo del procesador controle nuestros n√∫cleos.  Todo est√° claro con el mundo direccionable, ahora es el momento de lidiar con el mundo de la transmisi√≥n.  Pero haremos esto en el pr√≥ximo art√≠culo, y posiblemente incluso en varios art√≠culos. <br><br><h3>  Conclusi√≥n </h3><br>  El art√≠culo muestra c√≥mo se puede conectar un kernel arbitrario de Verilog para controlar el sistema de procesador Nios II.  Se muestran las opciones para la conexi√≥n m√°s simple al bus Avalon, as√≠ como la conexi√≥n en la que el bus puede estar ocupado.  Se proporcionan enlaces a la literatura, desde la cual puede encontrar otros modos de funcionamiento del bus Avalon en el modo Asignaci√≥n de memoria. <br><br>  El proyecto resultante se puede descargar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/454938/">https://habr.com/ru/post/454938/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../454924/index.html">Configuraci√≥n de autenticaci√≥n en Veeam Backup para Microsoft Office 365 v3</a></li>
<li><a href="../454926/index.html">Todo lo que sab√≠as sobre word2vec no es cierto</a></li>
<li><a href="../454930/index.html">Recolecci√≥n de basura en V8: como funciona el nuevo Orinoco GC</a></li>
<li><a href="../454932/index.html">Inversiones y software: 5 terminales comerciales para operar en bolsa</a></li>
<li><a href="../454936/index.html">Vivaldi: el bloqueo de anuncios debe ser la elecci√≥n del usuario</a></li>
<li><a href="../454940/index.html">Seguro m√©dico de viaje: instrucciones detalladas</a></li>
<li><a href="../454944/index.html">C√≥mo funciona el formato JPEG</a></li>
<li><a href="../454946/index.html">Estados globales: por qu√© y c√≥mo evitarlos</a></li>
<li><a href="../454958/index.html">Una mirada al interior: escuela de posgrado en EPFL. Parte 4.1: vida cotidiana</a></li>
<li><a href="../454960/index.html">Microbiota C√≥mo las drogas afectan las bacterias intestinales</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>