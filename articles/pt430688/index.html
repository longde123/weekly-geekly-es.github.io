<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üé≠ üë©‚ÄçüöÄ üì≤ Transfer√™ncia de dados via QR animado para Gomobile e GopherJS üíÖüèæ üèÇüèº üë©üèæ‚ÄçüöÄ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Neste artigo, quero falar sobre um projeto de fim de semana pequeno e engra√ßado para transferir arquivos por meio de c√≥digos QR animados. O projeto fo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Transfer√™ncia de dados via QR animado para Gomobile e GopherJS</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/430688/"><p> Neste artigo, quero falar sobre um projeto de fim de semana pequeno e engra√ßado para transferir arquivos por meio de c√≥digos QR animados.  O projeto foi escrito em Go, usando Gomobile e Gopherjs - o mais recente para um aplicativo da Web para medir automaticamente as taxas de transfer√™ncia de dados.  Se voc√™ estiver interessado na id√©ia de transmitir dados atrav√©s de c√≥digos visuais, desenvolvendo aplicativos da Web que n√£o sejam JS ou o Go - to Wellcome to Cat. </p><br><p><img src="https://habrastorage.org/webt/2p/zg/t_/2pzgt_2anc92t0udxgl3cnt3xy0.gif" alt="demo txqr"></p><a name="habracut"></a><br><p>  A id√©ia do projeto nasceu de uma tarefa espec√≠fica para um aplicativo m√≥vel - como transferir uma pequena por√ß√£o de dados (~ 15 KB) para outro dispositivo de maneira mais simples e r√°pida, em condi√ß√µes de bloqueio de rede.  O primeiro pensamento foi usar o Bluetooth, mas n√£o √© t√£o conveniente quanto parece - o processo relativamente longo e nem sempre funcional de detectar e emparelhar dispositivos √© muito dif√≠cil para a tarefa.  Uma boa id√©ia seria usar NFC (Near Field Communication), mas ainda existem muitos dispositivos nos quais o suporte a NFC √© limitado ou inexistente.  Precis√°vamos de algo mais simples e mais acess√≠vel. </p><br><p>  E os c√≥digos QR? </p><br><h1 id="qr-kody">  C√≥digos QR </h1><br><p>  O c√≥digo QR (resposta r√°pida) √© o tipo de c√≥digo visual mais popular do mundo.  Ele permite codificar at√© 3 KB de dados arbitr√°rios e possui v√°rios n√≠veis de corre√ß√£o de erros, permitindo a leitura confi√°vel de at√© um ter√ßo de um c√≥digo fechado ou sujo. </p><br><p>  Mas com os c√≥digos QR, existem dois problemas: </p><br><ul><li>  3KB n√£o √© suficiente </li><li>  quanto mais dados forem codificados, maiores ser√£o os requisitos de qualidade para a imagem digitalizar </li></ul><br><p>  Aqui est√° o c√≥digo QR da 40¬™ vers√£o (a maior densidade de grava√ß√£o) com 1276 bytes: </p><br><p><img src="https://habrastorage.org/webt/wp/r1/mp/wpr1mp7p-uz4vzzssaai5zp8v44.gif" alt="qrv40"></p><br><p>  Para a minha tarefa, eu precisava aprender a transferir ~ 15 KB de dados em dispositivos padr√£o (smartphones / tablets), para que a quest√£o surgisse por si s√≥ - por que n√£o animar a sequ√™ncia de c√≥digos QR e transferir os dados em peda√ßos? </p><br><p>  Uma r√°pida pesquisa de implementa√ß√µes prontas levou a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">v√°rios</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">desses</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">projetos</a> - principalmente projetos em hackathons (embora houvesse uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tese de gradua√ß√£o</a> ) - mas todos eles foram escritos em Java, Python ou JavaScript, que, infelizmente, tornaram o c√≥digo praticamente n√£o port√°vel e n√£o utilizado.  Mas, dada a grande popularidade dos c√≥digos QR e a baixa complexidade t√©cnica da ideia, foi decidido escrever do zero no Go - uma linguagem multiplataforma, leg√≠vel e r√°pida.  Normalmente, a plataforma cruzada implica a capacidade de criar c√≥digo bin√°rio para Windows, Mac e Linux, mas no meu caso tamb√©m foi importante constru√≠-lo para a web (gopherjs) e para sistemas m√≥veis (iOS / Android).  O Go fornece tudo pronto para uso com custo m√≠nimo. </p><br><p>  Tamb√©m considerei op√ß√µes alternativas para c√≥digos visuais - como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">c√≥digo HCCB</a> ou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">JAB</a> , mas para eles eu teria que escrever um scanner OpenCV, implementar um codificador / decodificador do zero e isso era demais para um projeto em um fim de semana.  Os c√≥digos QR <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">round-robin</a> (c√≥digos de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">captura</a> ) e seus equivalentes usados ‚Äã‚Äãno Facebook, Kik e Snapchat permitem codificar muito menos informa√ß√µes, e a abordagem patenteada incrivelmente legal da Apple para emparelhar Apple Watch e iPhone - uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">nuvem animada de part√≠culas coloridas</a> - tamb√©m √© otimizada para o efeito uau, e n√£o abaixo da largura de banda m√°xima.  Os c√≥digos QR s√£o integrados √†s c√¢meras SDK nativas do sistema operacional m√≥vel, o que facilita muito o trabalho com eles. </p><br><h1 id="txqr">  TXQR </h1><br><p>  Assim, <em>nasceu o</em> projeto <em>txqr</em> (de transmiss√£o e QR), que implementa uma biblioteca para codifica√ß√£o / decodifica√ß√£o de QR no Go puro e um protocolo para transmiss√£o de dados. </p><br><p>  A id√©ia principal √© a seguinte: um cliente seleciona um arquivo ou dados a serem enviados, o programa no dispositivo divide o arquivo em peda√ßos, codifica cada um deles em quadros QR e os mostra em um loop infinito com uma determinada taxa de quadros at√© que o destinat√°rio receba todos os dados.  O protocolo √© feito de forma que o destinat√°rio possa come√ßar de qualquer quadro, receber quadros QR em qualquer ordem - isso evita a necessidade de sincronizar a frequ√™ncia da anima√ß√£o e a frequ√™ncia da varredura.  O receptor pode ser um dispositivo antigo, cuja pot√™ncia permite decodificar 2 quadros por segundo e o remetente com um novo smartphone que produz anima√ß√£o em 120Hz, ou vice-versa, e isso n√£o ser√° um problema fundamental para o protocolo. </p><br><p> Isso √© obtido da seguinte maneira - quando o arquivo √© dividido em partes ( <em>quadros</em> adicionais), um prefixo com informa√ß√µes sobre o deslocamento relativo a todos os dados e o comprimento total - <code>OFFSET/TOTAL|</code>  (onde OFFSET e TOTAL s√£o valores inteiros de deslocamento e comprimento, respectivamente).  Atualmente, os dados bin√°rios s√£o codificados no Base64, mas isso n√£o √© realmente necess√°rio - a especifica√ß√£o QR permite n√£o apenas codificar dados como bin√°rios, mas tamb√©m otimizar partes diferentes dos dados para codifica√ß√µes diferentes (por exemplo, um prefixo com pequenas altera√ß√µes pode ser codificado como <em>alfanum√©rico</em> e o restante do conte√∫do - como o <em>bin√°rio</em> ), mas por simplicidade, o Base64 executou sua fun√ß√£o perfeitamente. </p><br><p>  Al√©m disso, o tamanho e a frequ√™ncia do quadro podem ser alterados dinamicamente, adaptando-se aos recursos do destinat√°rio. </p><br><p><img src="https://habrastorage.org/webt/qm/7g/dg/qm7gdgycvmlhgjflhc_xudrfeu8.png" alt="protocolo"></p><br><p>  O protocolo em si √© muito simples, e seu principal ponto negativo √© que, para arquivos grandes (embora isso esteja al√©m do escopo da tarefa, mas ainda assim), um quadro ignorado durante a verifica√ß√£o dobrar√° o tempo de verifica√ß√£o - o destinat√°rio ter√° que esperar pelo ciclo completo novamente.  Na teoria da codifica√ß√£o, existem solu√ß√µes para esses casos - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">c√≥digos-fonte</a> , mas deixarei isso para um pr√≥ximo fim de semana gratuito. </p><br><p>  O ponto mais interessante foi escrever um aplicativo m√≥vel que possa usar esse protocolo. </p><br><h2 id="gomobile">  Gomobile </h2><br><p>  Se voc√™ n√£o ouviu falar sobre o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">gomobile</a> , este √© um projeto que permite o uso de bibliotecas Go em projetos iOS e Android e torna esse procedimento simples e obsceno. </p><br><p>  O processo padr√£o √© o seguinte: </p><br><ul><li>  voc√™ escreve c√≥digo Go regular </li><li>  executar <code>gomobile bind ...</code> </li><li>  copie os artefatos resultantes ( <code>yourpackage.framework.</code> ou <code>yourpackage.aar</code> ) em seu projeto m√≥vel </li><li>  importe seu <code>yourpackage</code> e trabalhe com ele como em uma biblioteca comum </li></ul><br><p>  Voc√™ pode tentar como √© f√°cil. </p><br><p>  Portanto, escrevi rapidamente um aplicativo no Swift que verifica os c√≥digos QR (gra√ßas a este <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">maravilhoso artigo</a> ) e os decodifica, cola-os e, quando o arquivo inteiro √© recebido, mostra-o na janela de visualiza√ß√£o. </p><br><p>  Como um novato na Swift (apesar de ler o livro Swift 4), houve alguns momentos em que fiquei preso em algo simples, tentando descobrir como faz√™-lo corretamente e, no final, a melhor solu√ß√£o era implementar essa funcionalidade no Go e usar via gomobile.  N√£o me interpretem mal, o Swift √©, de muitas maneiras, uma linguagem maravilhosa, mas, como a maioria das outras linguagens de programa√ß√£o, oferece muitas maneiras de fazer a mesma coisa e j√° possui um hist√≥rico decente de altera√ß√µes incompat√≠veis com vers√µes anteriores.  Por exemplo, eu precisava fazer uma coisa simples - medir a dura√ß√£o de um evento com precis√£o de milissegundos.  Uma pesquisa no Google e no StackOverflow levou a uma s√©rie de solu√ß√µes diferentes, conflitantes e frequentemente desatualizadas, nenhuma das quais, no final, parecia bonita para mim ou correta para o compilador.  Ap√≥s 40 minutos de tempo gasto, acabei de <code>time.Since(start) / time.Millisecond</code> outro m√©todo no pacote Go que chamava <code>time.Since(start) / time.Millisecond</code> e usou seu resultado diretamente do Swift. </p><br><p>  Tamb√©m escrevi o utilit√°rio do console <code>txqr-ascii</code> para teste r√°pido de aplicativos.  Ele codifica o arquivo e anima os c√≥digos QR no terminal.  No conjunto, funcionou surpreendentemente bem - eu poderia enviar uma imagem pequena em alguns segundos, mas assim que comecei a testar diferentes valores da taxa de quadros, o n√∫mero de bytes em cada quadro QR e o n√≠vel de corre√ß√£o de erros no codificador QR, ficou claro que a solu√ß√£o do terminal n√£o estava lida com a alta frequ√™ncia (mais de 10) da anima√ß√£o e testar e medir manualmente os resultados √© uma coisa desastrosa. </p><br><h1 id="txqr-tester">  TXQR Tester </h1><br><p><img src="https://habrastorage.org/webt/bc/tp/a6/bctpa6fnru8q-kxbezmo27dcc1w.jpeg"></p><br><p>  Para encontrar a combina√ß√£o ideal de taxa de quadros, tamanho dos dados em um quadro QR e o n√≠vel de corre√ß√£o de erros entre os limites razo√°veis ‚Äã‚Äãdesses valores, tive que executar mais de 1000 testes, alterando manualmente os par√¢metros, aguardando um ciclo completo com o telefone na m√£o e escrevendo os resultados em uma placa.  Claro, isso deve ser automatizado! </p><br><p>  Aqui surgiu a id√©ia do pr√≥ximo aplicativo - <code>txqr-tester</code> .  Inicialmente, planejei usar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">x / exp / shiny</a> - uma estrutura experimental de interface do usu√°rio para aplicativos de desktop nativos no Go, mas parece ter sido abandonada.  H√° cerca de um ano, eu tentei, e a impress√£o n√£o era ruim - ela se encaixava perfeitamente em coisas de baixo n√≠vel.  Mas hoje, o ramo principal nem sequer foi compilado.  Parece que n√£o h√° mais nenhum incentivo para investir no desenvolvimento de estruturas de desktop - uma tarefa complexa e complicada, com demanda quase zero hoje em dia, todas as solu√ß√µes de interface do usu√°rio j√° est√£o na Web h√° muito tempo. </p><br><p>  Na programa√ß√£o da Web, como voc√™ sabe, as linguagens de programa√ß√£o come√ßaram a entrar, gra√ßas ao WebAssembly, mas ainda s√£o os primeiros passos para as crian√ßas.  √â claro que ainda h√° JavaScript e complementos, mas os amigos n√£o permitem que os amigos escrevam aplicativos em JavaScript, ent√£o eu decidi usar minha descoberta recente - a estrutura <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Vecty</a> , que permite escrever frontends no Go puro, que s√£o convertidos automaticamente em JavaScript usando um adulto muito bom e surpreendentemente bem trabalhando. Projeto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">GopherJS</a> . </p><br><h1 id="vecty-i-gopherjs">  Vecty e GopherJS </h1><br><p><img src="https://habrastorage.org/webt/rf/xc/zz/rfxczzfu4b5efmhjtu_lmf7ema4.png" alt="vecty"></p><br><p>  Na minha vida, n√£o recebi tanto prazer com o desenvolvimento de interfaces front-end. </p><br><p>  Um pouco mais tarde, pretendo escrever mais alguns artigos sobre minha experi√™ncia no desenvolvimento de frontends no Vecty, incluindo aplicativos WebGL, mas o ponto principal √© que, depois de v√°rios projetos no React, Angulars e Ember, escrever um frontend em uma linguagem de programa√ß√£o simples e atenciosa √© uma lufada de ar fresco. ar!  Posso escrever front-ends muito legais em pouco tempo sem escrever uma √∫nica linha em JavaScript! </p><br><p>  Para iniciantes, √© assim que voc√™ inicia um novo projeto no Vecty (sem geradores de c√≥digo de "projeto inicial" que criam toneladas de arquivos e pastas) - apenas main.go: </p><br><pre> <code class="go hljs">ackage main <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ( <span class="hljs-string"><span class="hljs-string">"github.com/gopherjs/vecty"</span></span> ) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { app := NewApp() vecty.SetTitle(<span class="hljs-string"><span class="hljs-string">"My App"</span></span>) vecty.AddStylesheet(<span class="hljs-comment"><span class="hljs-comment">/* ... add your css... */</span></span>) vecty.RenderBody(app) }</code> </pre> <br><p>  Um aplicativo, como qualquer componente da interface do usu√°rio, √© apenas um tipo: uma estrutura que inclui o tipo <code>vecty.Core</code> e deve implementar a interface <code>vecty.Component</code> (que consiste em um m√©todo <code>Render()</code> ).  E isso √© tudo!  Ent√£o voc√™ trabalha com tipos, m√©todos, fun√ß√µes, bibliotecas para trabalhar com o DOM e assim por diante - sem m√°gica oculta e novos termos e conceitos.  Aqui est√° o c√≥digo simplificado para a p√°gina principal: </p><br><pre> <code class="go hljs">/ App is a top-level app component. <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> App <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { vecty.Core session *Session settings *Settings <span class="hljs-comment"><span class="hljs-comment">// any other stuff you need, // it's just a struct } // Render implements the vecty.Component interface. func (a *App) Render() vecty.ComponentOrHTML { return elem.Body( a.header(), elem.Div( vecty.Markup( vecty.Class("columns"), ), // Left half elem.Div( vecty.Markup( vecty.Class("column", "is-half"), ), elem.Div(a.QR()), // QR display zone ), // Right half elem.Div( vecty.Markup( vecty.Class("column", "is-half"), ), vecty.If(!a.session.Started(), elem.Div( a.settings, )), vecty.If(a.session.Started(), elem.Div( a.resultsTable, )), ), ), vecty.Markup( event.KeyDown(a.KeyListener), ), ) }</span></span></code> </pre> <br><p>  Voc√™ provavelmente est√° olhando o c√≥digo agora e pensando - quanto √© infundado o trabalho com o DOM!  Eu tamb√©m pensava assim no come√ßo, mas assim que comecei a trabalhar, percebi como era conveniente: </p><br><ol><li>  N√£o h√° m√°gica - cada bloco (marca√ß√£o ou HTML) √© apenas uma vari√°vel do tipo desejado, com limites claros onde voc√™ pode colocar algo, gra√ßas √† digita√ß√£o est√°tica. </li><li>  N√£o h√° tags de abertura / fechamento que voc√™ precise lembrar de alterar ao refatorar ou use o IDE que faz isso para voc√™. </li><li>  De repente, a estrutura fica clara - por exemplo, eu nunca entendi por que no React at√© a 16¬™ vers√£o era imposs√≠vel retornar v√°rias tags de um componente - isso √© "apenas uma string".  Vendo como isso √© feito no Vecty, de repente ficou claro onde as ra√≠zes dessa restri√ß√£o cresceram no React.  Mesmo assim, n√£o est√° claro, no entanto, por que, ap√≥s o React 16, isso se tornou poss√≠vel, mas n√£o necess√°rio. </li></ol><br><p>  Em geral, assim que voc√™ tentar esta abordagem para trabalhar com o DOM, suas vantagens se tornar√£o muito √≥bvias.  Tamb√©m h√° desvantagens, √© claro, mas ap√≥s as desvantagens dos m√©todos usuais, elas s√£o invis√≠veis. </p><br><p>  O Vecty √© chamado de estrutura do tipo React, mas isso n√£o √© totalmente verdade.  Existe uma biblioteca GopherJS nativa para React - <a href="">myitcv.io/react</a> , mas n√£o acho que seja uma boa ideia repetir as solu√ß√µes arquitet√¥nicas do React para o Go.  Quando voc√™ escreve um frontend no Vecty, de repente fica claro o qu√£o mais f√°cil √© realmente.  De repente, toda essa m√°gica oculta e os novos termos e conceitos que toda estrutura JavaScript inventa tornam-se sup√©rfluos - eles s√£o apenas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">mais complexidade</a> , nada mais.  Tudo o que √© necess√°rio √© descrever clara e claramente os componentes, seu comportamento e conect√°-los juntos - tipos, m√©todos e fun√ß√µes, e isso √© tudo. </p><br><p>  Para CSS, usei uma estrutura <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Bulma</a> surpreendentemente decente - ela possui nomes de classe muito claros e uma boa estrutura, e o c√≥digo declarado da interface do usu√°rio √© muito leg√≠vel. </p><br><p>  A verdadeira m√°gica, no entanto, come√ßa quando voc√™ compila o c√≥digo Go em JavaScript.  Parece muito intimidador, mas, na verdade, voc√™ chama apenas <code>gopherjs build</code> e, em menos de um segundo, voc√™ tem um arquivo JavaScript gerado automaticamente pronto para ser inclu√≠do em sua p√°gina HTML b√°sica (um aplicativo regular consiste apenas em uma tag de corpo vazia e na inclus√£o deste Script JS).  Quando executei este comando pela primeira vez, esperava ver muitas mensagens, avisos e erros, mas n√£o - funciona extraordinariamente r√°pido e silenciosamente, s√≥ imprime uma linha em caso de erros de compila√ß√£o gerados pelo compilador Go, por isso √© muito claro.  Mas foi ainda mais bacana ver erros no console do navegador, com rastreamentos de pilha apontando para arquivos .go e a linha correta!  Isso √© muito legal. </p><br><h2 id="testirovanie-parametrov-qr-animacii">  Testando par√¢metros de anima√ß√£o QR </h2><br><p>  Por v√°rias horas, eu tinha um aplicativo da Web pronto que me permitia alterar rapidamente os par√¢metros para o teste: </p><br><ul><li>  FPS - taxa de quadros </li><li>  Tamanho do quadro QR - quantos bytes devem existir em cada quadro </li><li>  QR Recovery Level - N√≠vel de corre√ß√£o de erros QR </li></ul><br><p>  e execute o teste automaticamente. </p><br><p><img src="https://habrastorage.org/webt/dl/51/my/dl51myjlg-kfbii5wxjx3ggu9tm.png" alt="app"></p><br><p>  O aplicativo m√≥vel, √© claro, tamb√©m precisava ser automatizado - ele precisava entender quando a pr√≥xima rodada come√ßa com novos par√¢metros, entender quando a recep√ß√£o leva muito tempo e interromper a rodada, enviar os resultados para a aplica√ß√£o e assim por diante. </p><br><p>  O problema foi que o aplicativo da Web, sendo iniciado na caixa de prote√ß√£o do navegador, n√£o pode criar novas conex√µes e, se n√£o me engano, a √∫nica possibilidade de uma conex√£o ponto a ponto real com o navegador √© apenas pelo WebRTC (n√£o √© necess√°rio perfurar o NAT ), mas era muito complicado.  O aplicativo da web pode ser apenas um cliente. </p><br><p>  A solu√ß√£o foi simples - o servi√ßo web Go que entregou o aplicativo Web (e iniciou o navegador no URL desejado) tamb√©m lan√ßou o proxy WebSocket para dois clientes.  Assim que dois clientes ingressam, ele envia mensagens de forma transparente de uma conex√£o para outra, permitindo que os clientes (aplicativo Web e cliente m√≥vel) se comuniquem diretamente.  Eles devem ser para isso, em uma rede WIFI, √© claro. </p><br><p>  Houve um problema de como informar a um dispositivo m√≥vel onde, de fato, conectar-se e foi resolvido usando ... C√≥digo QR! </p><br><p>  O processo de teste √© assim: </p><br><ul><li>  um aplicativo m√≥vel est√° procurando um c√≥digo QR com um marcador de in√≠cio e um link para um proxy WebSocket </li><li>  assim que o token √© lido, o aplicativo se conecta a esse proxy WebSocket </li><li>  o aplicativo da Web (j√° conectado ao proxy) entende que o aplicativo m√≥vel est√° pronto e exibe um c√≥digo QR com o marcador "pronto para a pr√≥xima rodada?" </li><li>  o aplicativo m√≥vel reconhece o sinal, redefine o decodificador e envia uma mensagem "sim" via WebSocket. </li><li>  o aplicativo Web, ap√≥s receber a confirma√ß√£o, gera uma nova anima√ß√£o QR e a torce at√© receber os resultados ou o tempo limite. </li><li>  os resultados s√£o adicionados a uma placa ao lado da qual voc√™ pode fazer o download imediatamente como CSV </li></ul><br><p><img src="https://habrastorage.org/webt/u_/gm/jx/u_gmjxdtzg16tus3pboxicibyuk.png" alt="design"></p><br><p>  Como resultado, tudo o que me restou foi simplesmente colocar o telefone em um trip√©, iniciar o aplicativo e, em seguida, os dois programas fizeram todo o trabalho sujo, comunicando-se educadamente atrav√©s dos c√≥digos QR e WebSocket :) </p><br><p><img src="https://habrastorage.org/webt/b-/no/wn/b-nownnc3g_qjijctnqqwpjppri.gif" alt="demonstra√ß√£o do testador"></p><br><p>  No final, baixei o arquivo CSV com os resultados, o levei ao RStudio e ao <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Plotly Online Chart Maker</a> e analisei os resultados. </p><br><h1 id="rezultaty">  Resultados </h1><br><p>  O ciclo completo de testes leva cerca de 4 horas (infelizmente, a parte mais dif√≠cil do processo - gerar uma imagem GIF animada com quadros QR, teve que ser executada no navegador e, como o c√≥digo resultante ainda est√° em JS, apenas um processador √© usado) durante que era necess√°rio observar para que a tela n√£o ficasse repentinamente em branco ou algum aplicativo n√£o fechasse a janela com o aplicativo da web.  Os seguintes par√¢metros foram testados: </p><br><ul><li>  FPS - 3 a 12 </li><li>  O tamanho do quadro QR √© de 100 a 1000 bytes (em incrementos de 50) </li><li>  Todos os 4 n√≠veis de corre√ß√£o de erro QR (baixo, m√©dio, alto, mais alto) </li><li>  Tamanho do arquivo transferido - 13 KB de bytes gerados aleatoriamente </li></ul><br><p>  Algumas horas depois, baixei o CSV e comecei a analisar os resultados. </p><br><p>  Uma imagem √© mais importante que mil palavras, mas visualiza√ß√µes 3D interativas s√£o mais importantes que mil imagens.  Aqui est√° uma visualiza√ß√£o dos resultados (clic√°veis): </p><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" title="qr_scan_results"><img src="https://habrastorage.org/getpro/habr/post_images/ba3/833/7f1/ba38337f18e68ef62245173481e497f7.png" alt="qr_scan_results" width="600"></a> <br><br><br><p>  O melhor resultado foi 1,4 segundos, ou seja, aproximadamente 9KB / s!  Esse resultado foi registrado com uma frequ√™ncia de 11 quadros por segundo, um tamanho de quadro de 850 bytes e um n√≠vel m√©dio de corre√ß√£o de erros.  Na maioria dos casos, no entanto, a essa velocidade, o decodificador da c√¢mera pulou alguns quadros e teve que aguardar a pr√≥xima repeti√ß√£o do quadro perdido, que teve um efeito muito negativo nos resultados - em vez de dois segundos, ele poderia facilmente gerar 15 ou um tempo limite definido para 30 segundos. </p><br><p>  Aqui est√£o os gr√°ficos da depend√™ncia dos resultados em vari√°veis ‚Äã‚Äãvari√°veis: </p><br><h3 id="vremya--razmer-freyma">  Tempo / tamanho do quadro </h3><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img src="https://habrastorage.org/webt/pd/9c/rp/pd9crp3igj0djkv3uftlpxcgb2y.png" alt="Tempo versus tamanho"></a> </p><br><p>  Como voc√™ pode ver, em valores baixos do n√∫mero de bytes em cada quadro, a codifica√ß√£o em excesso √© muito grande e o tempo total de leitura, respectivamente.  H√° um m√≠nimo local de 500 a 600 bytes por quadro, mas os valores pr√≥ximos a ele ainda levam a quadros perdidos.  O melhor resultado foi observado em 900 bytes, mas 1000 e acima √© quase garantida a perda de quadros. </p><br><h3 id="vremya--fps">  Time / FPS </h3><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img src="https://habrastorage.org/webt/-g/al/up/-galupwvvmk5k78p2bqgmsg1zme.png" alt="Time vs FPS"></a> </p><br><p>  O valor do n√∫mero de quadros por segundo, para minha surpresa, n√£o teve um efeito muito grande - valores pequenos aumentaram muito o tempo de transmiss√£o geral e valores grandes aumentaram a probabilidade de um quadro perdido.  O valor ideal, a julgar por esses testes, est√° na regi√£o de 6-7 quadros por segundo para os dispositivos nos quais eu testei. </p><br><h3 id="vremya--uroven-korrekcii-oshibok">  N√≠vel de corre√ß√£o de hora / erro </h3><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img src="https://habrastorage.org/webt/c4/2g/di/c42gdiq0sqjxynepawom9j6bpi4.png" alt="Time vs Nvl"></a> </p><br><p>  O n√≠vel de corre√ß√£o de erros mostrou uma rela√ß√£o clara entre o tempo de transfer√™ncia do arquivo e o n√≠vel de redund√¢ncia, o que n√£o √© surpreendente.  O vencedor aqui √© o baixo n√≠vel de corre√ß√£o (L) - quanto menos dados redundantes, mais leg√≠vel o c√≥digo QR do scanner com o mesmo tamanho de dados.  De fato, a redund√¢ncia n√£o √© necess√°ria para este experimento, mas o padr√£o n√£o oferece essa op√ß√£o. </p><br><p>  Obviamente, para dados mais objetivos, esse teste deve ser executado centenas e milhares de vezes, em diferentes dispositivos e telas diferentes, mas, para minha experi√™ncia de fim de semana, foi um resultado mais que suficiente. </p><br><h1 id="vyvody">  Conclus√µes </h1><br><p>  Esse projeto divertido provou que a transfer√™ncia de dados unidirecional por meio de c√≥digos animados √© certamente poss√≠vel e, para situa√ß√µes em que voc√™ precisa transferir uma pequena quantidade na aus√™ncia de qualquer tipo de rede, √© bastante adequado.  Embora meu resultado m√°ximo tenha sido de cerca de 9 KB / s, na maioria dos casos a velocidade real foi de 1-2 KB / s. </p><br><p>  Tamb√©m gostei muito de usar o Gomobile e o GopherJS com o Vecty como uma ferramenta rotineira de solu√ß√£o de problemas.  S√£o projetos muito maduros, com excelente velocidade de trabalho e, na maioria dos casos, dando experi√™ncia "simplesmente funciona". </p><br><p>  Por fim, ainda admiro o qu√£o produtivo voc√™ pode ser com o Go quando voc√™ sabe claramente o que deseja implementar - o ciclo extremamente curto ‚Äúmudan√ßa‚Äù - ‚Äúmontagem‚Äù - ‚Äúverifica√ß√£o‚Äù permite que voc√™ experimente muitas e muitas vezes c√≥digo simples e a falta de hierarquia de classes na estrutura O programa torna poss√≠vel refator√°-los de maneira f√°cil e indolor em movimento, e a fant√°stica plataforma cruzada incorporada ao idioma desde o in√≠cio permite escrever o c√≥digo uma vez e us√°-lo no servidor, no cliente da Web e no aplicativo m√≥vel nativo.  Ao mesmo tempo, apesar do desempenho mais do que suficiente, ainda h√° muito espa√ßo para otimiza√ß√£o e acelera√ß√£o. </p><br><p>  Portanto, se voc√™ nunca experimentou o Gomobile ou o GopherJS - recomendo que tente na pr√≥xima oportunidade.  Levar√° uma hora do seu tempo, mas poder√° abrir uma nova camada de oportunidades no desenvolvimento para a Web ou para dispositivos m√≥veis.  Sinta-se livre para experimentar! </p><br><h1 id="ssylki">  Refer√™ncias </h1><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://github.com/divan/txqr</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://github.com/divan/txqr/tree/master/cmd/txqr-tester</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://github.com/divan/txqr-tester-ios</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://github.com/divan/txqr-reader</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://github.com/gopherjs/vecty</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://github.com/golang/mobile</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt430688/">https://habr.com/ru/post/pt430688/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt430678/index.html">Teste de dez dimmers com l√¢mpadas LED</a></li>
<li><a href="../pt430680/index.html">Escrevendo um processador e ambiente simples para ele</a></li>
<li><a href="../pt430682/index.html">Tr√™s anos do projeto de microssat√©lites lunares: est√°gios de crescimento</a></li>
<li><a href="../pt430684/index.html">Digitaliza√ß√£o de contratos do Ethereum ao vivo para erro de envio n√£o verificado. Parte 2</a></li>
<li><a href="../pt430686/index.html">Vis√£o geral: a primeira m√°quina de corte a jato de √°gua da WAZER</a></li>
<li><a href="../pt430690/index.html">Exce√ß√µes determin√≠sticas e tratamento de erros em "C ++ do futuro"</a></li>
<li><a href="../pt430692/index.html">Engenharia social com software Universal Windows Platform (APPX)</a></li>
<li><a href="../pt430694/index.html">Um pequeno guia para aprender C ++: o que, quando e sobre o que criar</a></li>
<li><a href="../pt430700/index.html">Um sistema unificado para gravar visualiza√ß√µes de filmes on-line come√ßar√° a funcionar na R√∫ssia</a></li>
<li><a href="../pt430702/index.html">Treinamento muito estranho</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>