<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👇🏼 🍲 👨🏻‍🎤 OpenHABs Wireless Home Air Conditioner Controller über Modbus über RF24Network 👩🏼‍🍳 🙍🏾 🤾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nach meinem ersten Artikel über die Steuerung der Klimaanlage mit einer Steuerung vergingen etwas mehr als zwei Jahre. Während dieser Zeit verließ mic...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>OpenHABs Wireless Home Air Conditioner Controller über Modbus über RF24Network</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/384243/"><img align="left" src="https://habrastorage.org/files/1d4/8ed/b4b/1d48edb4b2b24079a0e2a7e7d5d7e584.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nach </font><font style="vertical-align: inherit;">meinem </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ersten</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Artikel über die Steuerung der Klimaanlage mit einer Steuerung vergingen etwas mehr als zwei Jahre. </font><font style="vertical-align: inherit;">Während dieser Zeit verließ mich die Idee, die Klimaanlage fernzusteuern, nicht und hatte mehrere Wiedergeburten. </font><font style="vertical-align: inherit;">Die Hauptbedingung war das Fehlen von Kabeln zur Klimaanlage. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das heißt, die Steuerung des Controllers muss drahtlos sein.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hintergrund</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der erste Prototyp war der Arduino UNO. Sie akzeptierte Teams auf UART und wusste, wie man die Klimaanlage ein- und ausschaltet. weil Die an den funktionierenden Computer angeschlossene Arduinka hatte wenig praktischen Sinn. Der Kopf suchte ständig nach der Möglichkeit, diese mit dem Heimserver zu verbinden. Es gab keine direkte Sicht vom Server auf den Schuldigen aller Rätsel. Das Maximum ist eine Steckdose mit einem LAN auf demselben funktionierenden Computer - da sie fast gegenüber der Klimaanlage steht. Ein Ethernet-Shield war nicht verfügbar. Aber denken Sie daran, dass irgendwo in der Zashashnik ein DSL-2500U-DSL-Modem mit D-Link liegt, das seit langem nicht mehr verwendet wird und nur einen Port an Bord hat. Der Wunsch, dem Stück Eisen ein zweites Leben zu geben, führte zu Googeln, was wiederum auf wundersame Weise zu dem Artikel führte, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ein ADSL-Modem in ein Ethernet-Shield für Arduino / CraftDuino zu verwandeln</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich sprang voran und übersprang den interessantesten Prozess zum Erstellen einer benutzerdefinierten Firmware. Trotzdem gelang es mir, das Modem dazu zu bringen, den gewünschten Port abzuhören und den UART durch diesen weiterzuleiten. </font><font style="vertical-align: inherit;">Auf dem Heimserver könnte ich also einen Befehl zum Ein- und Ausschalten des Ports an die lokale Modemadresse senden, die an das mit ihm verbundene Arduino geht. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aber in diesem Artikel geht es nicht darum. </font><font style="vertical-align: inherit;">Die </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ultimative</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Lösung verwendet das Modbus-Protokoll und </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">das</font></a><font style="vertical-align: inherit;"> drahtlose </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">RF24Network-</font></a><font style="vertical-align: inherit;"> Netzwerk </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Und alles wird in OpenHAB gesteuert.</font></font><br>
<a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Während dieser zwei Jahre konnte ich viele Nishtyaks aus China bestellen und die meisten warteten in den Startlöchern. </font><font style="vertical-align: inherit;">Diese Liste enthielt das NRF24L01 + -Modul, das von einer Handvoll zum Experimentieren gekauft wurde. </font><font style="vertical-align: inherit;">Und er wäre irgendwo im Leerlauf weiter gegangen, wenn ich eines Tages nicht auf eine Reihe von Artikeln gestoßen wäre:</font></font><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wie man Freunde OpenHAB und Arduino macht</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arduino &amp; Modbus</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arduino &amp; OpenHAB</font></font></a></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
von  </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Borich</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Danke für das! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dank ihnen habe ich das Modbus-Protokoll kennengelernt. </font><font style="vertical-align: inherit;">Vor allem aber habe ich OpenHAB für mich entdeckt - was ich schon lange gesucht habe. </font><font style="vertical-align: inherit;">Dies veranlasste mich, langjährige Ideen umzusetzen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nachdem ich mit Beispielen aus den Artikeln herumgespielt hatte, beschloss ich, den Controller und den Server mithilfe des Ethernet-Shields vom oben beschriebenen Modem zu trennen. </font><font style="vertical-align: inherit;">Diese Lösung ermöglichte es uns, die gestellte Aufgabe zu erfüllen - das Schild und der Controller befanden sich auf dem Desktop, ohne einen funktionierenden Computer zu verwenden. Gleichzeitig ist das Schild immer mit dem lokalen Netzwerk verbunden und vom Heimserver aus zugänglich.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aber diese Entscheidung war zum Scheitern verurteilt.</font></font></b><div class="spoiler_text">     ModbusRtu over TCP   .    modpoll,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Arduino &amp; Modbus</a>  .     —          192.168.1.110   3000  !<br>
<br>
    OpenHAB. ,  , Modbus Binding   «RTU over TCP».        —     ModbusRtu   c      TCP.            OpenHAB-(ethernet)--(UART)-.<br>
<br>
 ,   ?      Item  .      1 Item     .      —      . ,   ,    TCP    Modbus Binding. ..              .<br>
<br>
   Modbus Binding     Item'   host-port-slaveID     .<br>
<br>
        ,     .                .       ,    .<br>
</div></div><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Idee</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und dann habe ich endlich festgestellt, dass ich einen Controller machen muss, der auf dem Luftweg zugänglich ist. </font><font style="vertical-align: inherit;">Die NRF24L01 + -Module sollten nicht verschwinden! .. Richtig, dies erforderte mindestens zwei Controller - einer spielt eine direkte Rolle, der zweite spielt die Rolle eines Routers. </font><font style="vertical-align: inherit;">Der zweite sollte mit dem Server verbunden sein und über diesen wird die drahtlose Kommunikation mit den anderen ausgeführt. </font><font style="vertical-align: inherit;">Bei der Verbindung geben wir die ID des Untergebenen an, für den das Paket bestimmt ist. </font><font style="vertical-align: inherit;">Es stellt sich heraus, dass viele Slaves an einer seriellen Schnittstelle verfügbar sind. </font><font style="vertical-align: inherit;">Ja, dies ist ein Modbus-basiertes drahtloses Netzwerk. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Modbus ermöglichte es übrigens, ein Netzwerk mit einem Master aufzubauen - vielen Untergebenen. </font><font style="vertical-align: inherit;">Und die </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RF24Network-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Bibliothek </font><font style="vertical-align: inherit;">- um alles drahtlos zu machen und sogar mit automatischem Routing zwischen Netzwerkknoten.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bibliotheksentwicklung für Arduino</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um eine solche Lösung zu implementieren, war es ziemlich lang, die </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modbus-Master-Slave-for-Arduino-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Bibliothek </font><font style="vertical-align: inherit;">so </font><font style="vertical-align: inherit;">zu ändern </font><font style="vertical-align: inherit;">, dass sie von ihr erben und einige Methoden überladen konnte. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Meine Implementierung wurde</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> auch für die neueste Arduino IDE 1.6.5 aktualisiert (library.properties wird hinzugefügt, die Bibliotheksdatei ist in Header und Body unterteilt). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mit der </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modbus-over-RF24Network-for-Arduino-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Bibliothek </font><font style="vertical-align: inherit;">können Sie zwei mögliche Verhaltensweisen implementieren - Proxy und Slave. </font><font style="vertical-align: inherit;">Beispiel ModbusRF24Proxy ist eigentlich eine Implementierung eines „Routers“ und erfordert keine anderen Modifikationen als das Setzen der erforderlichen Pins.</font></font><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modbus ExampleRF24Proxy</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;RF24Network.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;RF24.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;SPI.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;ModbusRtu.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;ModbusRtuRF24.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> stlPin  13  <span class="hljs-comment">//     (   Arduino)</span></span><font></font>
<font></font>
<span class="hljs-comment">// nRF24L01(+) radio attached using Getting Started board </span>
<span class="hljs-function">RF24 <span class="hljs-title">radio</span><span class="hljs-params">(<span class="hljs-number">9</span>, <span class="hljs-number">10</span>)</span></span>;<font></font>
<font></font>
<span class="hljs-comment">// Network uses that radio</span>
<span class="hljs-function">RF24Network <span class="hljs-title">network</span><span class="hljs-params">(radio)</span></span>;<font></font>
<font></font>
<span class="hljs-comment">// Address of our node</span>
<span class="hljs-keyword">const</span> <span class="hljs-keyword">uint16_t</span> this_node = <span class="hljs-number">0</span>;<font></font>
<font></font>
<span class="hljs-comment">//  ,   TX</span>
<span class="hljs-function">ModbusRF24 <span class="hljs-title">proxy</span><span class="hljs-params">(network, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)</span></span>;
<span class="hljs-keyword">int8_t</span> state = <span class="hljs-number">0</span>;
<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> tempus;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">//    </span><font></font>
    io_setup();<font></font>
    <span class="hljs-comment">//    </span><font></font>
<font></font>
    proxy.begin(<span class="hljs-number">57600</span>);<font></font>
<font></font>
    SPI.begin();<font></font>
    radio.begin();<font></font>
    network.begin(<span class="hljs-comment">/*channel*/</span> <span class="hljs-number">90</span>, <span class="hljs-comment">/*node address*/</span> this_node);<font></font>
<font></font>
    <span class="hljs-comment">//    100 </span>
    tempus = millis() + <span class="hljs-number">100</span>;<font></font>
    digitalWrite(stlPin, HIGH);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">io_setup</span><span class="hljs-params">()</span> </span>{<font></font>
    digitalWrite(stlPin, HIGH);<font></font>
    pinMode(stlPin, OUTPUT);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">loop</span><span class="hljs-params">()</span> </span>{<font></font>
<font></font>
    <span class="hljs-comment">// Pump the network regularly</span><font></font>
    network.update();<font></font>
<font></font>
    <span class="hljs-comment">//  </span><font></font>
    state = proxy.proxy();<font></font>
<font></font>
    <span class="hljs-comment">//      -    50  </span>
    <span class="hljs-keyword">if</span> (state &gt; <span class="hljs-number">4</span>) {<font></font>
        tempus = millis() + <span class="hljs-number">50</span>;<font></font>
        digitalWrite(stlPin, HIGH);<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span> (millis() &gt; tempus) digitalWrite(stlPin, LOW);<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein Router oder Proxy verwendet ein spezielles Konstruktorformat:</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-comment">//  ,   TX</span>
<span class="hljs-function">ModbusRF24 <span class="hljs-title">proxy</span><span class="hljs-params">(network, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)</span></span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
und Funktion </font></font><br>
<pre><code class="cpp hljs">proxy.proxy();
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um eingehende Pakete an der seriellen Schnittstelle zu verarbeiten, senden Sie sie an das RF24-Netzwerk, empfangen Sie eine Antwort vom Netzwerk und senden Sie das Ergebnis an die serielle Schnittstelle zurück. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In dieser Implementierung hat der Proxy eine RF24Network-Adresse von Null:</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-comment">// Address of our node</span>
<span class="hljs-keyword">const</span> <span class="hljs-keyword">uint16_t</span> this_node = <span class="hljs-number">0</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - d.h. </font><font style="vertical-align: inherit;">Dies ist das Root-Gerät des Netzwerks. </font><font style="vertical-align: inherit;">Bei Bedarf kann die Position in der Topologie des Proxy-Controllers geändert werden.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modbus Beispiel RF24Slave</font></font></b><div class="spoiler_text">    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Arduino &amp; Modbus</a>:<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;RF24Network.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;RF24.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;SPI.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;ModbusRtu.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;ModbusRtuRF24.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ID   1      <span class="hljs-comment">//  </span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> btnPin  2   <span class="hljs-comment">//  ,   </span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ledPin  7  <span class="hljs-comment">//   </span></span><font></font>
<font></font>
<span class="hljs-comment">// nRF24L01(+) radio attached using Getting Started board </span>
<span class="hljs-function">RF24 <span class="hljs-title">radio</span><span class="hljs-params">(<span class="hljs-number">9</span>, <span class="hljs-number">10</span>)</span></span>;<font></font>
<font></font>
<span class="hljs-comment">// Network uses that radio</span>
<span class="hljs-function">RF24Network <span class="hljs-title">network</span><span class="hljs-params">(radio)</span></span>;<font></font>
<font></font>
<span class="hljs-comment">// Address of our node</span>
<span class="hljs-keyword">const</span> <span class="hljs-keyword">uint16_t</span> this_node = ID;<font></font>
<font></font>
<span class="hljs-comment">//  </span>
<span class="hljs-function">ModbusRF24 <span class="hljs-title">slave</span><span class="hljs-params">(network, ID)</span></span>;<font></font>
<font></font>
<span class="hljs-comment">//   modbus</span>
<span class="hljs-keyword">uint16_t</span> au16data[<span class="hljs-number">11</span>];<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">io_setup</span><span class="hljs-params">()</span> </span>{<font></font>
    digitalWrite(ledPin, LOW);<font></font>
    pinMode(ledPin, OUTPUT);<font></font>
    pinMode(btnPin, INPUT);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">io_poll</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// Coil[1]  Discrete[0]</span>
    au16data[<span class="hljs-number">0</span>] = au16data[<span class="hljs-number">1</span>];
    <span class="hljs-comment">//   1.3   </span>
    digitalWrite(ledPin, bitRead(au16data[<span class="hljs-number">1</span>], <span class="hljs-number">3</span>));
    <span class="hljs-comment">//     0.3</span>
    bitWrite(au16data[<span class="hljs-number">0</span>], <span class="hljs-number">3</span>, digitalRead(btnPin));
    <span class="hljs-comment">// Holding[5,6,7]  Input[2,3,4]</span>
    au16data[<span class="hljs-number">2</span>] = au16data[<span class="hljs-number">5</span>];<font></font>
    au16data[<span class="hljs-number">3</span>] = au16data[<span class="hljs-number">6</span>];<font></font>
    au16data[<span class="hljs-number">4</span>] = au16data[<span class="hljs-number">7</span>];
    <span class="hljs-comment">//    </span>
    au16data[<span class="hljs-number">8</span>] = slave.getInCnt();<font></font>
    au16data[<span class="hljs-number">9</span>] = slave.getOutCnt();<font></font>
    au16data[<span class="hljs-number">10</span>] = slave.getErrCnt();<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">//    </span><font></font>
    io_setup();<font></font>
<font></font>
    Serial.begin(<span class="hljs-number">57600</span>);<font></font>
    Serial.println(<span class="hljs-string">"RF24Network/examples/modbus_slave/"</span>);<font></font>
<font></font>
    SPI.begin();<font></font>
    radio.begin();<font></font>
    network.begin(<span class="hljs-comment">/*channel*/</span> <span class="hljs-number">90</span>, <span class="hljs-comment">/*node address*/</span> this_node);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">loop</span><span class="hljs-params">()</span> </span>{<font></font>
<font></font>
    <span class="hljs-comment">// Pump the network regularly</span><font></font>
    network.update();<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (network.available()) {<font></font>
        slave.poll(au16data, <span class="hljs-number">11</span>);<font></font>
    }<font></font>
    <span class="hljs-comment">//    Modbus    </span><font></font>
    io_poll();<font></font>
}<font></font>
</code></pre><br>
<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Konstruktor ist in diesem Fall bereits anders:</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-comment">//  </span>
<span class="hljs-function">ModbusRF24 <span class="hljs-title">slave</span><span class="hljs-params">(network, ID)</span></span>;
</code></pre><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modbus-Registerstruktur</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nach den ersten erfolgreichen Versuchen, die Klimaanlage mit der Fähigkeit zu steuern, nur ein- und auszuschalten, nahm mein Appetit nur zu. </font><font style="vertical-align: inherit;">Dies war jetzt noch nicht genug, und da ich OpenHAB-Funktionalität in meiner mobilen Anwendung habe, sollte mindestens die gesamte Funktionalität des nativen Control Panels ausgeführt werden. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dies bedeutet, dass hier mindestens eine Liste von Funktionen aufgeführt ist:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anzeige des aktuellen Status</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ein- und Ausschalten der Klimaanlage, einzelne Modi (O </font></font><sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , Ionisation, Silent Mode);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Auswahl des aktuellen Modus (Auto, Heizung, Kühlung, Entwässerung, Lüfter);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anzeige von Temperatur und Lüfterdrehzahl für jeden Modus. </font><font style="vertical-align: inherit;">Für den Lüftermodus nur Geschwindigkeit;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vertikale Vorhangeinstellung (automatisch, 0 °, 15 °, 30 °, 45 °, 60 °);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">horizontale Vorhangeinstellung (automatisch, "| |", "/ /", "/ |", "|", "");</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zeiteinstellung (Stunde, Minute);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">auf Timer-Einstellung;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aus-Timer-Einstellung;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pünktliche Einstellung (Stunde, Minute);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Einstellung der Abschaltzeit (Stunde, Minute);</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Während des Entwicklungsprozesses hat sich die Struktur der Register bei mir oft geändert. </font><font style="vertical-align: inherit;">Die aktuelle Version befindet sich unten unter dem Spoiler.</font></font><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modbus-Register</font></font></b><div class="spoiler_text"><table>
<tbody><tr>
<th>Type</th>
<th>Byte</th>
<th>Bit</th>
<th>Name</th>
<th></th>
</tr>
<tr>
<td>Bit RO</td>
<td>0</td>
<td>0</td>
<td>CFG_OXYGEN</td>
<td>1 —   </td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>1</td>
<td>CFG_ION</td>
<td>1 —   </td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>2</td>
<td>CFG_QUIET</td>
<td>1 —   </td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>3</td>
<td>CFG_TIMER</td>
<td>1 —  /   </td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>4</td>
<td>CFG_DELAY</td>
<td>1 —   /</td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>5</td>
<td>CFG_SWING</td>
<td>1 —   </td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>6</td>
<td>CFG_SWINGH</td>
<td>1 —    </td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>7</td>
<td>CFG_SWINGV</td>
<td>1 —    </td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>8</td>
<td>CFG_CLOCK</td>
<td>1 —  </td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>9</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>10</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>11</td>
<td>CFG_AUTO</td>
<td>1 —   AUTO</td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>12</td>
<td>CFG_COOL</td>
<td>1 —   COOL</td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>13</td>
<td>CFG_HEAT</td>
<td>1 —   HEAT</td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>14</td>
<td>CFG_DRY</td>
<td>1 —   DRY</td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>15</td>
<td>CFG_FAN</td>
<td>1 —   FAN</td>
</tr>
<tr>
<td>Integer RO</td>
<td>1</td>
<td></td>
<td>CFG_TEMP</td>
<td>.  . : Min + Max*256</td>
</tr>
<tr>
<td>Integer RO</td>
<td>2</td>
<td></td>
<td>CFG_FAN_SPEED</td>
<td>  FAN</td>
</tr>
<tr>
<td>Bit RO</td>
<td>3</td>
<td>0</td>
<td>STATE_POWER</td>
<td>:0 — , 1 — </td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>1</td>
<td>STATE_OXYGEN</td>
<td>:0 — , 1 — </td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>2</td>
<td>STATE_ION</td>
<td>:0 — , 1 — </td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>3</td>
<td>STATE_QUIET</td>
<td>:0 — , 1 — </td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>4</td>
<td>STATE_TIMER</td>
<td>:0 — , 1 — </td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>8</td>
<td>CONTROL_POWER</td>
<td></td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>9</td>
<td>CONTROL_OXYGEN</td>
<td></td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>10</td>
<td>CONTROL_ION</td>
<td></td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>11</td>
<td>CONTROL_QUIET</td>
<td></td>
</tr>
<tr>
<td>Integer RO</td>
<td>4</td>
<td></td>
<td>RTC_HR_MI</td>
<td>0x1308</td>
</tr>
<tr>
<td>Integer RW</td>
<td>5</td>
<td></td>
<td>RTCW_HR_MI</td>
<td>0x1308</td>
</tr>
<tr>
<td>Integer RO</td>
<td>6</td>
<td></td>
<td>TEMPERATURE1</td>
<td> . INT16,   </td>
</tr>
<tr>
<td>Integer RO</td>
<td>7</td>
<td></td>
<td>TEMPERATURE2</td>
<td> . INT16,   </td>
</tr>
<tr>
<td>Bit RW</td>
<td>8</td>
<td>0</td>
<td>MODE_AUTO</td>
<td></td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>1</td>
<td>MODE_COOL</td>
<td></td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>2</td>
<td>MODE_HEAT</td>
<td></td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>3</td>
<td>MODE_DRY</td>
<td></td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>4</td>
<td>MODE_FAN</td>
<td></td>
</tr>
<tr>
<td>Integer RW</td>
<td>9</td>
<td></td>
<td>TEMP_AUTO</td>
<td> AUTO</td>
</tr>
<tr>
<td>Integer RW</td>
<td>10</td>
<td></td>
<td>TEMP_COOL</td>
<td> COOL</td>
</tr>
<tr>
<td>Integer RW</td>
<td>11</td>
<td></td>
<td>TEMP_HEAT</td>
<td> HEAT</td>
</tr>
<tr>
<td>Integer RW</td>
<td>12</td>
<td></td>
<td>TEMP_DRY</td>
<td> DRY</td>
</tr>
<tr>
<td>Integer RW</td>
<td>13</td>
<td></td>
<td>FAN_AUTO</td>
<td> AUTO. 0: Auto</td>
</tr>
<tr>
<td>Integer RW</td>
<td>14</td>
<td></td>
<td>FAN_COOL</td>
<td> COOL. 0: Auto</td>
</tr>
<tr>
<td>Integer RW</td>
<td>15</td>
<td></td>
<td>FAN_HEAT</td>
<td> HEAT. 0: Auto</td>
</tr>
<tr>
<td>Integer RW</td>
<td>16</td>
<td></td>
<td>FAN_DRY</td>
<td> DRY. 0: Auto</td>
</tr>
<tr>
<td>Integer RW</td>
<td>17</td>
<td></td>
<td>FAN_SPEED</td>
<td> FAN. 0: Auto</td>
</tr>
<tr>
<td>Bit RW</td>
<td>18</td>
<td>0</td>
<td>SWING_AUTO</td>
<td> </td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>1</td>
<td>SWINGV_0</td>
<td>   0°</td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>2</td>
<td>SWINGV_15</td>
<td>   15°</td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>3</td>
<td>SWINGV_30</td>
<td>   30°</td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>4</td>
<td>SWINGV_45</td>
<td>   45°</td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>5</td>
<td>SWINGV_60</td>
<td>   60°</td>
</tr>
<tr>
<td>Bit RW</td>
<td>19</td>
<td>0</td>
<td>SWINGH_AUTO</td>
<td> </td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>1</td>
<td>SWINGH_VV</td>
<td>  | &nbsp;|</td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>2</td>
<td>SWINGH_LL</td>
<td>  / &nbsp;/</td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>3</td>
<td>SWINGH_LV</td>
<td>  / &nbsp;|</td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>4</td>
<td>SWINGH_VR</td>
<td>  | &nbsp;\</td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>5</td>
<td>SWINGH_RR</td>
<td>  \ &nbsp;\</td>
</tr>
<tr>
<td>Bit RW</td>
<td>20</td>
<td>0</td>
<td>TIMER_ON</td>
<td></td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>1</td>
<td>TIMER_OFF</td>
<td></td>
</tr>
<tr>
<td>Integer RW</td>
<td>21</td>
<td></td>
<td>TIME_ON_HOUR</td>
<td> </td>
</tr>
<tr>
<td>Integer RW</td>
<td>22</td>
<td></td>
<td>TIME_ON_MINUTE</td>
<td> </td>
</tr>
<tr>
<td>Integer RW</td>
<td>23</td>
<td></td>
<td>TIME_OFF_HOUR</td>
<td> </td>
</tr>
<tr>
<td>Integer RW</td>
<td>24</td>
<td></td>
<td>TIME_OFF_MINUTE</td>
<td> </td>
</tr>
<tr>
<td>Integer RW</td>
<td>25</td>
<td></td>
<td>DS18B20_ENV</td>
<td>. </td>
</tr>
<tr>
<td>Integer RW</td>
<td>26</td>
<td></td>
<td>DS18B20_NOZ</td>
<td>. </td>
</tr>
</tbody></table><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Register sind so organisiert, dass das gesamte Datenarray beim Start der Steuerung vom EEPROM aus initialisiert wird. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die ersten 3 Register (CFG_ *) enthalten die Konfiguration von Funktionen, sie ändern sich nie und werden von der EEPROM-Firmware initialisiert. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Register 3-7 zeigen immer den aktuellen Status der Steuerung an. Die hohen Bits von Register 3 werden verwendet, um den Zustand zu ändern. Ihre Änderungen lösen das Ein- und Ausschalten der Klimaanlage und spezielle Modi aus. Nachdem der Befehl ausgeführt wurde, werden die niederwertigen Bits dieses Registers in die höherwertigen kopiert. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Register 4 enthält die aktuelle Reglerzeit, die aus der RTC gelesen wird. Der Wert wird im BCD-Format gespeichert, sodass bei Anzeige des Registers in hexadezimaler Schreibweise die Zeit unverändert gelesen wird - 12:34 ist 0x1234. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Register 5 wird verwendet, um die RTC-Zeit zu ändern.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Register 6-7 enthalten die Temperatur der DS18B20-Sensoren. </font><font style="vertical-align: inherit;">Der Wert enthält eine vorzeichenbehaftete ganze Zahl und ist gleich T * 100, d.h. </font><font style="vertical-align: inherit;">25,67 ° C = 2567. </font><font style="vertical-align: inherit;">Es sind maximal 2 Sensoren vorgesehen, die Anzahl kann jedoch leicht geändert werden, indem die Registertabelle erweitert wird, um die Sensoradressen und ihre Temperaturen zu speichern. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die letzten 2 Bytes der Sensoradresse werden in den Registern 25-26 gespeichert. </font><font style="vertical-align: inherit;">Setzen Sie beim Sensorwechsel das entsprechende Adressregister zurück. </font><font style="vertical-align: inherit;">Wenn ein neuer Sensor erkannt wird, wird seine Adresse in den Registern 25-26 auf Vorhandensein überprüft. </font><font style="vertical-align: inherit;">Befindet sich die Adresse in der Tabelle, wird der Temperaturwert des Sensors in das entsprechende Register 6-7 eingetragen. </font><font style="vertical-align: inherit;">Wenn die Adresse nicht in der Tabelle enthalten ist und die Tabelle keine Zellen enthält, wird die aktuelle Sensoradresse in eine freie Zelle geschrieben. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die vom Benutzer geänderten Register 8-26 werden im EEPROM gespeichert.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Drüsen</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Hardware besteht aus folgenden Komponenten:</font></font><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arduino Pro Mini. </font></font><div class="spoiler"><b class="spoiler_title"> </b><div class="spoiler_text"><img src="https://habrastorage.org/files/e8a/460/33b/e8a46033b9cf45609d87e9a08f9f4ba9.png" alt="Arduino Pro Mini NEW"></div></div></li>
<li>NRF24L01+ —   2.4</li>
<li>LM1117-3.3 —  3.3  NRF24L01+</li>
<li>DS1302 — RTC</li>
<li> 32768  RTC</li>
<li>DS18B20 —  . 2</li>
<li> — , , </li>
</ol><br>
<br>
<img src="https://habrastorage.org/files/b4f/6f2/357/b4f6f2357e044c78a3472d4d6b25ad07.jpg"><br>
<img src="https://habrastorage.org/files/025/6de/902/0256de902fed444682fc2e16f3e9be88.jpg"><br>
<img src="https://habrastorage.org/files/e45/604/4aa/e456044aabe0499c9b8016d908411434.jpg"><br>
<img src="https://habrastorage.org/files/3f2/818/d9a/3f2818d9af814ffba67ed9e271c1450d.jpg"><br>
<img src="https://habrastorage.org/files/f76/385/124/f76385124e4e4c2ca573b268365f5e40.jpg"><br>
<img src="https://habrastorage.org/files/be6/ded/b3c/be6dedb3c93a40fe9841a17dead1b723.jpg"><br>
<img src="https://habrastorage.org/files/80a/50c/1b7/80a50c1b7e154c87ae07296e704d6674.jpg"><br>
<img src="https://habrastorage.org/files/a5b/f61/96e/a5bf6196ee764f90bf535df517477363.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Rückmeldung an die Klimaanlage erfolgt durch Anschluss von Optokopplern an die entsprechenden LEDs. Somit ist eine galvanische Trennung mit dem Stromkreis der Klimaanlage gewährleistet. Der Strom der Eingänge für die Optokoppler wurde experimentell unter Verwendung von Widerständen so ausgewählt, dass der Ausgang des Optokopplers öffnet und die Helligkeit der Haupt-LED an der Klimaanlage nicht abfällt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Neben dem IR-Empfänger der Klimaanlage wurde eine IR-LED installiert. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Controller wird durch Mini-USB-Aufladung mit einem chinesischen Wunder betrieben. Chinesische Netzspannungskontakte wurden aus dem Ladegehäuse entfernt, Drähte wurden entfernt. Die Aufladung selbst hat sich im Darm des Klimakastens niedergelassen und ist parallel dazu mit dem Eingang 220 verbunden. Der Controller wird über ein normales USB-AB-Kabel mit dem Laden verbunden.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Router-Controller basiert auf dem Arduino Mega2560 und NRF24L01 + mit einem separaten LM1117-3.3. </font><font style="vertical-align: inherit;">Zusätzlich zu einem separaten 3,3-Netzteil ist ein Elektrolyt an das Funkmodul (ich fand es bei 470uf * 16 V) an den Leistungsbeinen angeschlossen. </font><font style="vertical-align: inherit;">Wie Sie wissen, ist der interne Mega2560 3,3-V-Energiebus sehr verrauscht und das Modul hat sich geweigert, Daten zu übertragen, obwohl es richtig geantwortet hat. </font><font style="vertical-align: inherit;">Aber auch mit einem separaten Netzteil ohne Kondensator war die Verbindung sehr instabil. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Damit der Mega2560 beim Öffnen des Anschlusses über USB nicht zurückgesetzt wird, wird ein 10μf Elektrolyt an den Reset-Pin angeschlossen.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Openhab</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Artikel von Arduino &amp; OpenHAB</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> beschreibt eine Funktion des Modbus Binding-Plug-Ins, bei der das Plug-In bei jeder Abfrage des Controllers ein Ereignis an den Bus sendet, auch wenn sich nichts geändert hat. </font><font style="vertical-align: inherit;">Ich folgte dem Beispiel und stellte das Plugin fertig.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konfiguration des Modbus-Bindungs-Plugins</font></font></b><div class="spoiler_text">#<br>
modbus:serial.ac_hall_state.connection=/dev/ttyACM0:57600:8:none:1:rtu<br>
modbus:serial.ac_hall_state.id=1<br>
modbus:serial.ac_hall_state.start=48<br>
modbus:serial.ac_hall_state.length=5<br>
modbus:serial.ac_hall_state.type=discrete<br>
<br>
#<br>
modbus:serial.ac_hall_power.connection=/dev/ttyACM0:57600:8:none:1:rtu<br>
modbus:serial.ac_hall_power.id=1<br>
modbus:serial.ac_hall_power.start=56<br>
modbus:serial.ac_hall_power.length=4<br>
modbus:serial.ac_hall_power.type=coil<br>
<br>
#<br>
modbus:serial.ac_hall_rtc.connection=/dev/ttyACM0:57600:8:none:1:rtu<br>
modbus:serial.ac_hall_rtc.id=1<br>
modbus:serial.ac_hall_rtc.start=4<br>
modbus:serial.ac_hall_rtc.length=1<br>
modbus:serial.ac_hall_rtc.type=holding<br>
<br>
# <br>
modbus:serial.ac_hall_temperature.connection=/dev/ttyACM0:57600:8:none:1:rtu<br>
modbus:serial.ac_hall_temperature.id=1<br>
modbus:serial.ac_hall_temperature.start=6<br>
modbus:serial.ac_hall_temperature.length=2<br>
modbus:serial.ac_hall_temperature.type=holding<br>
modbus:serial.ac_hall_temperature.valuetype=int16<br>
<br>
#<br>
modbus:serial.ac_hall_mode.connection=/dev/ttyACM0:57600:8:none:1:rtu<br>
modbus:serial.ac_hall_mode.id=1<br>
modbus:serial.ac_hall_mode.start=8<br>
modbus:serial.ac_hall_mode.length=1<br>
modbus:serial.ac_hall_mode.type=holding<br>
<br>
# <br>
modbus:serial.ac_hall_temp.connection=/dev/ttyACM0:57600:8:none:1:rtu<br>
modbus:serial.ac_hall_temp.id=1<br>
modbus:serial.ac_hall_temp.start=9<br>
modbus:serial.ac_hall_temp.length=4<br>
modbus:serial.ac_hall_temp.type=holding<br>
<br>
# <br>
modbus:serial.ac_hall_fan.connection=/dev/ttyACM0:57600:8:none:1:rtu<br>
modbus:serial.ac_hall_fan.id=1<br>
modbus:serial.ac_hall_fan.start=13<br>
modbus:serial.ac_hall_fan.length=5<br>
modbus:serial.ac_hall_fan.type=holding<br>
<br>
#<br>
modbus:serial.ac_hall_swing.connection=/dev/ttyACM0:57600:8:none:1:rtu<br>
modbus:serial.ac_hall_swing.id=1<br>
modbus:serial.ac_hall_swing.start=18<br>
modbus:serial.ac_hall_swing.length=2<br>
modbus:serial.ac_hall_swing.type=holding<br>
<br>
#<br>
modbus:serial.ac_hall_timer.connection=/dev/ttyACM0:57600:8:none:1:rtu<br>
modbus:serial.ac_hall_timer.id=1<br>
modbus:serial.ac_hall_timer.start=320<br>
modbus:serial.ac_hall_timer.length=2<br>
modbus:serial.ac_hall_timer.type=coil<br>
<br>
# <br>
modbus:serial.ac_hall_timer_time.connection=/dev/ttyACM0:57600:8:none:1:rtu<br>
modbus:serial.ac_hall_timer_time.id=1<br>
modbus:serial.ac_hall_timer_time.start=21<br>
modbus:serial.ac_hall_timer_time.length=4<br>
modbus:serial.ac_hall_timer_time.type=holding<br>
<br>
#  DS18B20<br>
modbus:serial.ac_hall_ds18b20.connection=/dev/ttyACM0:57600:8:none:1:rtu<br>
modbus:serial.ac_hall_ds18b20.id=1<br>
modbus:serial.ac_hall_ds18b20.start=25<br>
modbus:serial.ac_hall_ds18b20.length=2<br>
modbus:serial.ac_hall_ds18b20.type=holding<br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Elementeinstellungen</font></font></b><div class="spoiler_text"><pre>Contact AC_HALL_STATE_POWER             "AC_HALL_STATE_POWER [MAP(air_cond.map):%s]"    (){modbus="ac_hall_state:0"}<font></font>
Contact AC_HALL_STATE_OXYGEN            "AC_HALL_STATE_OXYGEN [MAP(air_cond.map):%s]"   (){modbus="ac_hall_state:1"}<font></font>
Contact AC_HALL_STATE_ION               "AC_HALL_STATE_ION [MAP(air_cond.map):%s]"      (){modbus="ac_hall_state:2"}<font></font>
Contact AC_HALL_STATE_QUIET             "AC_HALL_STATE_QUIET [MAP(air_cond.map):%s]"    (){modbus="ac_hall_state:3"}<font></font>
Contact AC_HALL_STATE_TIMER             "[MAP(air_cond.map):%s]"                  (){modbus="ac_hall_state:4"}<font></font>
<font></font>
Switch  AC_HALL_CONTROL_POWER           ""                   &lt;climate&gt;       (){modbus="ac_hall_power:0"}<font></font>
Switch  AC_HALL_CONTROL_OXYGEN          " O2"                                  (){modbus="ac_hall_power:1"}<font></font>
Switch  AC_HALL_CONTROL_ION             ""                                     (){modbus="ac_hall_power:2"}<font></font>
Switch  AC_HALL_CONTROL_QUIET           " "                                   (){modbus="ac_hall_power:3"}<font></font>
<font></font>
Number  AC_HALL_RTC                     "RTC[%x]"                                       (){modbus="ac_hall_rtc:0"}<font></font>
String  AC_HALL_RTC_S                   " [%s]"         &lt;clock&gt;         ()<font></font>
<font></font>
Group   gAC_HALL_TEMPERATURE            "Living Room temp"<font></font>
<font></font>
Number  AC_HALL_TEMPERATURE_ENV         "[%d]"                                   (){modbus="ac_hall_temperature:0"}<font></font>
Number  AC_HALL_TEMPERATURE_NOZ         "[%d]"                                     (){modbus="ac_hall_temperature:1"}<font></font>
Number  AC_HALL_TEMPERATURE_ENVF        " [%.2f °C]"     &lt;temperature&gt;           (gAC_HALL_TEMPERATURE)<font></font>
Number  AC_HALL_TEMPERATURE_NOZF        " [%.2f °C]"       &lt;temperature&gt;           (gAC_HALL_TEMPERATURE)<font></font>
<font></font>
Number  AC_HALL_DS18B20_ENV             "ENV[%x]"                                       (){modbus="ac_hall_ds18b20:0"}<font></font>
Number  AC_HALL_DS18B20_NOZ             "NOZZLES[%x]"                                   (){modbus="ac_hall_ds18b20:1"}<font></font>
<font></font>
Number  AC_HALL_MODE                    ""                                              (){modbus="ac_hall_mode:0"}<font></font>
<font></font>
Number  AC_HALL_TEMP_AUTO               "[%d °C]"    &lt;temperature&gt;           (){modbus="ac_hall_temp:0"}<font></font>
Number  AC_HALL_TEMP_COOL               "[%d °C]"    &lt;temperature&gt;           (){modbus="ac_hall_temp:1"}<font></font>
Number  AC_HALL_TEMP_HEAT               "[%d °C]"    &lt;temperature&gt;           (){modbus="ac_hall_temp:2"}<font></font>
Number  AC_HALL_TEMP_DRY                "[%d °C]"    &lt;temperature&gt;           (){modbus="ac_hall_temp:3"}<font></font>
<font></font>
Number  AC_HALL_FAN_AUTO                "[%d]"                                  (){modbus="ac_hall_fan:0"}<font></font>
Number  AC_HALL_FAN_COOL                "[%d]"                                  (){modbus="ac_hall_fan:1"}<font></font>
Number  AC_HALL_FAN_HEAT                "[%d]"                                  (){modbus="ac_hall_fan:2"}<font></font>
Number  AC_HALL_FAN_DRY                 "[%d]"                                  (){modbus="ac_hall_fan:3"}<font></font>
Number  AC_HALL_FAN_SPEED               "[%d]"                                  (){modbus="ac_hall_fan:4"}<font></font>
<font></font>
Number  AC_HALL_SWINGV                  ""                                              (){modbus="ac_hall_swing:0"}<font></font>
Number  AC_HALL_SWINGH                  ""                                              (){modbus="ac_hall_swing:1"}<font></font>
<font></font>
Switch  AC_HALL_TIMER_ON                " "              &lt;clock&gt;         (){modbus="ac_hall_timer:0"}<font></font>
Switch  AC_HALL_TIMER_OFF               " "             &lt;clock&gt;         (){modbus="ac_hall_timer:1"}<font></font>
<font></font>
Number  AC_HALL_TIME_ON_HR              "[%02d]"                                     (){modbus="ac_hall_timer_time:0"}<font></font>
Number  AC_HALL_TIME_ON_MI              "[%02d]"                                  (){modbus="ac_hall_timer_time:1"}<font></font>
Number  AC_HALL_TIME_OFF_HR             "[%02d]"                                     (){modbus="ac_hall_timer_time:2"}<font></font>
Number  AC_HALL_TIME_OFF_MI             "[%02d]"                                  (){modbus="ac_hall_timer_time:3"}<font></font>
</pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Regeln werden verwendet, um ganzzahlige Temperaturen in reale zu konvertieren und die Reglerzeit in die Form HH: MM zu formatieren.</font></font><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Regeleinstellungen</font></font></b><div class="spoiler_text"><pre>import org.openhab.core.library.types.*<font></font>
import org.openhab.core.persistence.*<font></font>
import org.openhab.model.script.actions.*<font></font>
import java.io.File<font></font>
<font></font>
rule "Update AC_HALL ENV temp"<font></font>
        when<font></font>
                Item AC_HALL_TEMPERATURE_ENV received update<font></font>
        then<font></font>
                var Number T = AC_HALL_TEMPERATURE_ENV.state as DecimalType<font></font>
                var Number H = T/100<font></font>
                postUpdate(AC_HALL_TEMPERATURE_ENVF, H)<font></font>
end<font></font>
rule "Update AC_HALL NOZZLES temp"<font></font>
        when<font></font>
                Item AC_HALL_TEMPERATURE_NOZ received update<font></font>
        then<font></font>
                var Number T = AC_HALL_TEMPERATURE_NOZ.state as DecimalType<font></font>
                var Number H = T/100<font></font>
                postUpdate(AC_HALL_TEMPERATURE_NOZF, H)<font></font>
end<font></font>
rule "Update AC_HALL_RTC clock"<font></font>
        when<font></font>
                Item AC_HALL_RTC received update<font></font>
        then<font></font>
                var Number T = AC_HALL_RTC.state as DecimalType<font></font>
                var H = T.intValue / 256<font></font>
                var M = T.intValue % 256<font></font>
                var S = String::format("%02x:%02x",H,M)<font></font>
                postUpdate(AC_HALL_RTC_S, S)<font></font>
end<font></font>
</pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sitemaps-Einstellungen</font></font></b><div class="spoiler_text"><pre>sitemap demo label="Demo House"{<font></font>
        Frame label="HOME"{<font></font>
                Text label=" " icon="ac_cond"{<font></font>
                        Frame label="" {<font></font>
                                Switch item= AC_HALL_CONTROL_POWER labelcolor=[AC_HALL_STATE_POWER==OPEN="blue"]<font></font>
                                Switch item= AC_HALL_CONTROL_OXYGEN labelcolor=[AC_HALL_STATE_OXYGEN==OPEN="blue"]<font></font>
                                Switch item= AC_HALL_CONTROL_ION labelcolor=[AC_HALL_STATE_ION==OPEN="blue"]<font></font>
                                Switch item= AC_HALL_CONTROL_QUIET labelcolor=[AC_HALL_STATE_QUIET==OPEN="blue"]<font></font>
                                Text item=AC_HALL_STATE_TIMER labelcolor=[AC_HALL_STATE_TIMER==OPEN="blue"] icon="clock-on"<font></font>
                                Text item=AC_HALL_RTC_S<font></font>
                                Text item=AC_HALL_TEMPERATURE_ENVF<font></font>
                                Text item=AC_HALL_TEMPERATURE_NOZF<font></font>
                        }<font></font>
<font></font>
                        Frame label=""{<font></font>
                                Selection item=AC_HALL_MODE label="" mappings=[1=AUTO, 2=COOL, 4=HEAT, 8=DRY, 16=FAN]<font></font>
                                Text item=AC_HALL_TEMP_AUTO visibility=[AC_HALL_MODE==1]<font></font>
                                Text item=AC_HALL_TEMP_COOL visibility=[AC_HALL_MODE==2]<font></font>
                                Text item=AC_HALL_TEMP_HEAT visibility=[AC_HALL_MODE==4]<font></font>
                                Text item=AC_HALL_TEMP_DRY visibility=[AC_HALL_MODE==8]<font></font>
<font></font>
                                Text item=AC_HALL_FAN_AUTO visibility=[AC_HALL_MODE==1]<font></font>
                                Text item=AC_HALL_FAN_COOL visibility=[AC_HALL_MODE==2]<font></font>
                                Text item=AC_HALL_FAN_HEAT visibility=[AC_HALL_MODE==4]<font></font>
                                Text item=AC_HALL_FAN_DRY visibility=[AC_HALL_MODE==8]<font></font>
                                Text item=AC_HALL_FAN_SPEED visibility=[AC_HALL_MODE==16]<font></font>
<font></font>
                                Selection item=AC_HALL_SWINGV label="" mappings=[1=AUTO, 2="0°", 4="15°", 8="30°", 16="45°", 32="60°"]<font></font>
                                Selection item=AC_HALL_SWINGH label="" mappings=[1=AUTO, 4="/   /", 8="/   |", 2="|   |", 16="|   \\", 32="\\   \\"]<font></font>
<font></font>
                                Text label="" icon="settings"{<font></font>
                                        Frame label="AUTO"{<font></font>
                                                Setpoint item=AC_HALL_TEMP_AUTO minValue=16 maxValue=30 step=1<font></font>
                                                Switch   item=AC_HALL_FAN_AUTO mappings=[0=AUTO, 1="1", 2="2", 3="3", 4="4", 5="5"]<font></font>
                                        }<font></font>
                                        Frame label="COOL"{<font></font>
                                                Setpoint item=AC_HALL_TEMP_COOL minValue=16 maxValue=30 step=1<font></font>
                                                Switch   item=AC_HALL_FAN_COOL mappings=[0=AUTO, 1="1", 2="2", 3="3", 4="4", 5="5"]<font></font>
                                        }<font></font>
                                        Frame label="HEAT"{<font></font>
                                                Setpoint item=AC_HALL_TEMP_HEAT minValue=16 maxValue=30 step=1<font></font>
                                                Switch   item=AC_HALL_FAN_HEAT mappings=[0=AUTO, 1="1", 2="2", 3="3", 4="4", 5="5"]<font></font>
                                        }<font></font>
                                        Frame label="DRY"{<font></font>
                                                Setpoint item=AC_HALL_TEMP_DRY minValue=16 maxValue=30 step=1<font></font>
                                                Switch   item=AC_HALL_FAN_DRY mappings=[0=AUTO, 1="1", 2="2", 3="3", 4="4", 5="5"]<font></font>
                                        }<font></font>
                                        Frame label="FAN"{<font></font>
                                                Switch item=AC_HALL_FAN_SPEED mappings=[0=AUTO, 1="1", 2="2", 3="3", 4="4", 5="5"]<font></font>
                                        }<font></font>
                                        Frame label=""{<font></font>
                                                Text item=AC_HALL_DS18B20_ENV<font></font>
                                                Text item=AC_HALL_DS18B20_NOZ<font></font>
                                        }<font></font>
                                }<font></font>
                        }<font></font>
                        Frame label="" {<font></font>
                                Switch item= AC_HALL_TIMER_ON labelcolor=[AC_HALL_STATE_TIMER==OPEN="blue"]<font></font>
                                Setpoint item=AC_HALL_TIME_ON_HR minValue=0 maxValue=23 step=1<font></font>
                                Setpoint item=AC_HALL_TIME_ON_MI minValue=0 maxValue=50 step=5<font></font>
<font></font>
                                Switch item= AC_HALL_TIMER_OFF labelcolor=[AC_HALL_STATE_TIMER==OPEN="blue"]<font></font>
                                Setpoint item=AC_HALL_TIME_OFF_HR minValue=0 maxValue=23 step=1<font></font>
                                Setpoint item=AC_HALL_TIME_OFF_MI minValue=0 maxValue=50 step=5<font></font>
                        }<font></font>
                }<font></font>
                Text item=AC_HALL_RTC_S<font></font>
                Text item=AC_HALL_TEMPERATURE_ENVF{<font></font>
                        Frame label=" "{<font></font>
                                Chart item=gAC_HALL_TEMPERATURE period=h refresh=60000<font></font>
                        }<font></font>
                        Frame label=" 4 " {<font></font>
                                Chart item=gAC_HALL_TEMPERATURE period=4h refresh=600000<font></font>
                        }<font></font>
                }<font></font>
        }<font></font>
}<font></font>
</pre><br>
</div></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Ergebnis sieht über einen Browser ungefähr so ​​aus:</font></font><br>
<img align="left" src="https://habrastorage.org/files/5c0/129/0f3/5c01290f365b47399e9b16123c21f6fa.png"><img align="left" src="https://habrastorage.org/files/634/45b/94b/63445b94b4ab47349482b85667313e10.png"><img align="left" src="https://habrastorage.org/files/09c/8cb/8ff/09c8cb8ffb8240349ce57e8c7ccc6629.png"><br clear="all">
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fazit</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich bin mit dem Ergebnis als Elefant zufrieden. Die Steuerung der Klimaanlage steht mir jetzt überall dort zur Verfügung, wo es mobiles Internet oder WLAN gibt. Mit einem VPN-Client auf einem Smartphone kann ich auf OpenHAB auf meinem Heimserver sowohl über den Browser als auch über die mobile Anwendung zugreifen. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die drahtlose Lösung ermöglichte die enge Integration der Steuerung in die Klimaanlage. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Vorhandensein von Rückmeldungen gibt die Gewissheit, dass der gesendete Befehl von der Klimaanlage empfangen wurde, und die Temperatursensoren zeigen dies deutlich - nach einigen Sekunden können Sie eine Änderung des Temperaturmesswerts am Ausgang der Klimaanlage beobachten. Nun, nach ein paar Minuten - und der Umgebungstemperatur. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es war interessant, das Profil der Klimaanlage zu beobachten, wenn man sich den gegebenen Bedingungen nähert.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zweifellos wird dies nicht der einzige drahtlose Controller sein, den ich verwenden möchte. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es ist geplant, den IR-Empfänger der Klimaanlage selbst zu verwenden, um die Befehle der nativen Fernbedienung zu lesen und die Einstellungen in der Steuerung zu aktualisieren. </font><font style="vertical-align: inherit;">Darüber hinaus ist der IR-Empfänger selbst bereits über einen Optokoppler mit der Steuerung verbunden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lesen Sie bis zum Ende ein besonderes Dankeschön!</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verweise</font></font></h4><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arduino-Bibliothek ModbusRtu </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modbus-Master-Slave-für-Arduino</font></font></a></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arduino-Bibliothek ModbusRtuRF24 </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modbus-over-RF24-Netzwerk-für-Arduino</font></font></a></li>
</ol></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de384243/">https://habr.com/ru/post/de384243/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de384229/index.html">Nach dem Lesen anwenden. 25 Bücher für den Spieleentwickler</a></li>
<li><a href="../de384231/index.html">Wenn niemand natürliches Uran benötigt, wie kann man sich dann anreichern?</a></li>
<li><a href="../de384235/index.html">UAVs werden den russischen Himmel bis 2020 öffnen</a></li>
<li><a href="../de384239/index.html">Rückblick auf Sphero BB-8, einen Roboter aus Star Wars</a></li>
<li><a href="../de384241/index.html">Emercoin: Kryptowährung und ein digitaler Schlüssel in einem</a></li>
<li><a href="../de384247/index.html">Meinungen: Twitter teilt Software zum Testen</a></li>
<li><a href="../de384249/index.html">Eine Auswahl nützlicher Geräte: 5 Geräte, die im Büro nützlich sind</a></li>
<li><a href="../de384251/index.html">Roboter und Mensch. Vom Inhalt zur Form</a></li>
<li><a href="../de384253/index.html">Giraffe Neural Network hat in 72 Stunden gelernt, auf der Ebene eines internationalen FIDE-Meisters Schach zu spielen</a></li>
<li><a href="../de384257/index.html">Wie Restaurants Websites erstellen: 4 Designlösungen</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>