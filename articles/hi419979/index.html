<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>тЬКЁЯП╛ ЁЯНД ЁЯТ░ рдкрд╛рдпрдерди рд╡рд┐рддреНрддреАрдп рд╕рд▓рд╛рд╣рдХрд╛рд░реЛрдВ рдХреЛ рдмрджрд▓рдиреЗ рдореЗрдВ рдХреИрд╕реЗ рдорджрдж рдХрд░рддрд╛ рд╣реИ ЁЯТЖ ЁЯЪв ЁЯИ│</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="рдЕрддреНрдпрдзрд┐рдХ рд╡рд┐рд╡рд┐рдзреАрдХрд░рдг рдХреЗ рдЦрддрд░реЛрдВ рдкрд░ рд▓реЗрдЦ рдХреЛ рдЬрд╛рд░реА рд░рдЦрдиреЗ рдХреЗ рд▓рд┐рдП, рд╣рдо рдЙрдкрдпреЛрдЧреА рд╕реНрдЯреЙрдХ рдЪрдпрди рдЙрдкрдХрд░рдг рдмрдирд╛рдПрдВрдЧреЗред рдЙрд╕рдХреЗ рдмрд╛рдж, рд╣рдо рдПрдХ рд╕рд░рд▓ рд░реАрдмреИрд▓реЗрдВрд╕рд┐рдВрдЧ рдХрд░реЗрдВрдЧреЗ рдФрд░ рддрдХрдиреАрдХреА рд╕рдВрдХреЗрддрдХреЛрдВ рдХреА...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>рдкрд╛рдпрдерди рд╡рд┐рддреНрддреАрдп рд╕рд▓рд╛рд╣рдХрд╛рд░реЛрдВ рдХреЛ рдмрджрд▓рдиреЗ рдореЗрдВ рдХреИрд╕реЗ рдорджрдж рдХрд░рддрд╛ рд╣реИ</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/419979/"> рдЕрддреНрдпрдзрд┐рдХ рд╡рд┐рд╡рд┐рдзреАрдХрд░рдг рдХреЗ рдЦрддрд░реЛрдВ рдкрд░ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рд▓реЗрдЦ</a> рдХреЛ рдЬрд╛рд░реА рд░рдЦрдиреЗ рдХреЗ рд▓рд┐рдП, рд╣рдо рдЙрдкрдпреЛрдЧреА рд╕реНрдЯреЙрдХ рдЪрдпрди рдЙрдкрдХрд░рдг рдмрдирд╛рдПрдВрдЧреЗред  рдЙрд╕рдХреЗ рдмрд╛рдж, рд╣рдо рдПрдХ рд╕рд░рд▓ рд░реАрдмреИрд▓реЗрдВрд╕рд┐рдВрдЧ рдХрд░реЗрдВрдЧреЗ рдФрд░ рддрдХрдиреАрдХреА рд╕рдВрдХреЗрддрдХреЛрдВ рдХреА рдЕрдиреВрдареА рд╢рд░реНрддреЛрдВ рдХреЛ рдЬреЛрдбрд╝реЗрдВрдЧреЗ, рдЬреЛ рдХрд┐ рд▓реЛрдХрдкреНрд░рд┐рдп рд╕реЗрд╡рд╛рдУрдВ рдореЗрдВ рдЕрдХреНрд╕рд░ рдХрдореА рд╣реЛрддреА рд╣реИред  рдФрд░ рдлрд┐рд░ рд╡реНрдпрдХреНрддрд┐рдЧрдд рдкрд░рд┐рд╕рдВрдкрддреНрддрд┐рдпреЛрдВ рдФрд░ рд╡рд┐рднрд┐рдиреНрди рд╡рд┐рднрд╛рдЧреЛрдВ рдкрд░ рд░рд┐рдЯрд░реНрди рдХреА рддреБрд▓рдирд╛ рдХрд░реЗрдВред <br><br>  рдЗрд╕ рд╕рдм рдореЗрдВ рд╣рдо рдкрдВрдбреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ рдФрд░ рдЪрдХреНрд░реЛрдВ рдХреА рд╕рдВрдЦреНрдпрд╛ рдХреЛ рдХрдо рдХрд░рддреЗ рд╣реИрдВред  рд╕рдордп рд╢реНрд░реГрдВрдЦрд▓рд╛ рд╕рдореВрд╣ рдФрд░ рд░реЗрдЦрд╛рдВрдХрди рдЖрдХрд░реНрд╖рд┐рдд рдХрд░реЗрдВред  рдЖрдЗрдП рдмрд╣реБ-рд╕реВрдЪрдХрд╛рдВрдХреЛрдВ рдФрд░ рдЙрдирдХреЗ рд╡реНрдпрд╡рд╣рд╛рд░ рд╕реЗ рдкрд░рд┐рдЪрд┐рдд рд╣реЛрдВред  рдФрд░ рдпрд╣ рд╕рдм Python 3.6 рдореЗрдВ Jupyter рдореЗрдВред <br><a name="habracut"></a><br><blockquote>  рдпрджрд┐ рдЖрдк рдХреБрдЫ рдЕрдЪреНрдЫрд╛ рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ, рддреЛ рд╕реНрд╡рдпрдВ рдХрд░реЗрдВред <br>  рдлрд░реНрдбрд┐рдиреЗрдВрдб рдкреЛрд░реНрд╢ </blockquote><br>  рд╡рд░реНрдгрд┐рдд рдЯреВрд▓ рдЖрдкрдХреЛ рдкреЛрд░реНрдЯрдлреЛрд▓рд┐рдпреЛ рдХреЗ рд▓рд┐рдП рдЗрд╖реНрдЯрддрдо рд╕рдВрдкрддреНрддрд┐ рдХрд╛ рдЪрдпрди рдХрд░рдиреЗ рдФрд░ рд╕рд▓рд╛рд╣рдХрд╛рд░реЛрдВ рджреНрд╡рд╛рд░рд╛ рд▓рдЧрд╛рдП рдЧрдП рдЯреВрд▓ рдХреЛ рдмрд╛рд╣рд░ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдЧрд╛ред  рд▓реЗрдХрд┐рди рд╣рдо рдХреЗрд╡рд▓ рдмрдбрд╝реА рддрд╕реНрд╡реАрд░ рджреЗрдЦреЗрдВрдЧреЗ - рдЦрд╛рддреЗ рдХреА рддрд░рд▓рддрд╛, рдкрджреЛрдВ рдХреА рднрд░реНрддреА рдХреЗ рд▓рд┐рдП рд╕рдордп, рдмреНрд░реЛрдХрд░ рдХрдореАрд╢рди рдФрд░ рдПрдХ рд╢реЗрдпрд░ рдХреА рд▓рд╛рдЧрдд рдХреЗ рдмрд┐рдирд╛ред  рд╕рд╛рдорд╛рдиреНрдп рддреМрд░ рдкрд░, рдмрдбрд╝реЗ рджрд▓рд╛рд▓реЛрдВ рдХреЗ рдорд╛рд╕рд┐рдХ рдпрд╛ рд╡рд╛рд░реНрд╖рд┐рдХ рдкреБрдирд░реНрд╕рдВрддреБрд▓рди рдХреЗ рд╕рд╛рде рдпрд╣ рдорд╣рддреНрд╡рд╣реАрди рд▓рд╛рдЧрдд рд╣реЛрдЧреАред  рд╣рд╛рд▓рд╛рдВрдХрд┐, рдЖрд╡реЗрджрди рдХрд░рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ, рд╕рдВрднрд╛рд╡рд┐рдд рддреНрд░реБрдЯрд┐рдпреЛрдВ рдХреЛ рдЦрддреНрдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдЪреБрдиреЗ рдЧрдП рд░рдгрдиреАрддрд┐ рдХреЛ рдЗрд╡реЗрдВрдЯ-рд╕рдВрдЪрд╛рд▓рд┐рдд рдмреИрдХрдЯреЗрд╕реНрдЯрд░ рдореЗрдВ рдЬрд╛рдВрдЪрдирд╛ рдЪрд╛рд╣рд┐рдП, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдХреНрд╡рд╛рдВрдЯреЛрдкрд┐рдпрди (рдХреНрдпреВрдкреА)ред <br><br>  рдХреНрдпреВрдкреА рдореЗрдВ рддреБрд░рдВрдд рдХреНрдпреЛрдВ рдирд╣реАрдВ?  рд╕рдордпред  рд╡рд╣рд╛рдВ, рд╕рдмрд╕реЗ рд╕рд░рд▓ рдкрд░реАрдХреНрд╖рдг рд▓рдЧрднрдЧ 5 рдорд┐рдирдЯ рддрдХ рд░рд╣рддрд╛ рд╣реИред  рдФрд░ рд╡рд░реНрддрдорд╛рди рд╕рдорд╛рдзрд╛рди рдЖрдкрдХреЛ рдПрдХ рдорд┐рдирдЯ рдореЗрдВ рдЕрджреНрд╡рд┐рддреАрдп рд╕реНрдерд┐рддрд┐рдпреЛрдВ рдХреЗ рд╕рд╛рде рд╕реИрдХрдбрд╝реЛрдВ рд╡рд┐рднрд┐рдиреНрди рд░рдгрдиреАрддрд┐рдпреЛрдВ рдХреА рдЬрд╛рдВрдЪ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдЧрд╛ред <br><br><h2>  рдХрдЪреНрдЪрд╛ рдбреЗрдЯрд╛ рд▓реЛрдб рд╣реЛ рд░рд╣рд╛ рд╣реИ </h2><br>  рдбреЗрдЯрд╛ рд▓реЛрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдЗрд╕ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдЖрд▓реЗрдЦ</a> рдореЗрдВ рд╡рд░реНрдгрд┐рдд рд╡рд┐рдзрд┐ рд▓реЗрдВред  рдореИрдВ рджреИрдирд┐рдХ рдХреАрдорддреЛрдВ рдХреЛ рд╕реНрдЯреЛрд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП PostgreSQL рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реВрдВ, рд▓реЗрдХрд┐рди рдЕрдм рдпрд╣ рдореБрдлреНрдд рд╕реНрд░реЛрддреЛрдВ рд╕реЗ рднрд░рд╛ рд╣реИ, рдЬрд╣рд╛рдВ рд╕реЗ рдЖрдк рдЖрд╡рд╢реНрдпрдХ рдбреЗрдЯрд╛рдлрд╝реНрд░реЗрдо рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВред <br><br>  рдбреЗрдЯрд╛рдмреЗрд╕ рд╕реЗ рдореВрд▓реНрдп рдЗрддрд┐рд╣рд╛рд╕ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдиреЗ рдХрд╛ рдХреЛрдб рд░рд┐рдкреЙрдЬрд┐рдЯрд░реА рдореЗрдВ рдЙрдкрд▓рдмреНрдз рд╣реИред  рд▓рд┐рдВрдХ рд▓реЗрдЦ рдХреЗ рдЕрдВрдд рдореЗрдВ рд╣реЛрдЧрд╛ред <br><br><h2>  DataFrame рд╕рдВрд░рдЪрдирд╛ </h2><br>  рдореВрд▓реНрдп рдЗрддрд┐рд╣рд╛рд╕ рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рддреЗ рд╕рдордп, рд╕реБрд╡рд┐рдзрд╛рдЬрдирдХ рд╕рдореВрд╣реАрдХрд░рдг рдФрд░ рд╕рднреА рдбреЗрдЯрд╛ рддрдХ рдкрд╣реБрдВрдЪ рдХреЗ рд▓рд┐рдП, рд╕рдмрд╕реЗ рдЕрдЪреНрдЫрд╛ рд╕рдорд╛рдзрд╛рди рддрд╛рд░реАрдЦ рдФрд░ рдЯрд┐рдХрд░ рдХреЗ рд╕рд╛рде рдПрдХ рдмрд╣реБ-рд╕реВрдЪрдХрд╛рдВрдХ (рдорд▓реНрдЯреАрдЗрдВрдбреЗрдХреНрд╕) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рд╣реИред <br><br><pre><code class="python hljs">df = df.set_index([<span class="hljs-string"><span class="hljs-string">'dt'</span></span>, <span class="hljs-string"><span class="hljs-string">'symbol'</span></span>], drop=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>).sort_index() df.tail(len(df.index.levels[<span class="hljs-number"><span class="hljs-number">1</span></span>]) * <span class="hljs-number"><span class="hljs-number">2</span></span>)</code> </pre> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e63/f7d/80a/e63f7d80a7d25c5099c940b03cd38e33.png" alt="рдЫрд╡рд┐"><br><br>  рдПрдХ рдорд▓реНрдЯреА-рдЗрдВрдбреЗрдХреНрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ, рд╣рдо рдЖрд╕рд╛рдиреА рд╕реЗ рд╕рднреА рдкрд░рд┐рд╕рдВрдкрддреНрддрд┐рдпреЛрдВ рдХреЗ рд▓рд┐рдП рдкреВрд░реЗ рдореВрд▓реНрдп рдЗрддрд┐рд╣рд╛рд╕ рддрдХ рдкрд╣реБрдВрдЪ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рд╕рд░рдгреА рдХреЛ рддрд┐рдерд┐ рдФрд░ рдкрд░рд┐рд╕рдВрдкрддреНрддрд┐ рджреНрд╡рд╛рд░рд╛ рдЕрд▓рдЧ-рдЕрд▓рдЧ рд╕рдореВрд╣ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред  рд╣рдо рдПрдХ рд╕рдВрдкрддреНрддрд┐ рдХреЗ рд▓рд┐рдП рдореВрд▓реНрдп рдЗрддрд┐рд╣рд╛рд╕ рднреА рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред <br><br>  рдпрд╣рд╛рдВ рдЗрд╕ рдмрд╛рдд рдХрд╛ рдЙрджрд╛рд╣рд░рдг рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдХрд┐ рдЖрдк рд╕рдкреНрддрд╛рд╣, рдорд╣реАрдиреЗ, рдФрд░ рд╡рд░реНрд╖ рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рдЗрддрд┐рд╣рд╛рд╕ рдХреЛ рдЖрд╕рд╛рдиреА рд╕реЗ рдХреИрд╕реЗ рд╕рдордЭ рд╕рдХрддреЗ рд╣реИрдВред  рдФрд░ рдкрдВрдбреЛрдВ рдмрд▓реЛрдВ рджреНрд╡рд╛рд░рд╛ рд░реЗрдЦрд╛рдВрдХрди рдкрд░ рдпрд╣ рд╕рдм рджрд┐рдЦрд╛рдиреЗ рдХреЗ рд▓рд┐рдП: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#      agg_rules = { 'dt': 'last', 'symbol': 'last', 'open': 'first', 'high': 'max', 'low': 'min', 'close': 'last', 'volume': 'sum', 'adj': 'last' } level_values = df.index.get_level_values #  fig = plt.figure(figsize=(15, 3), facecolor='white') df.groupby([pd.Grouper(freq='W', level=0)] + [level_values(i) for i in [1]]).agg( agg_rules).set_index(['dt', 'symbol'], drop=False ).close.unstack(1).plot(ax=fig.add_subplot(131), title="Weekly") df.groupby([pd.Grouper(freq='M', level=0)] + [level_values(i) for i in [1]]).agg( agg_rules).set_index(['dt', 'symbol'], drop=False ).close.unstack(1).plot(ax=fig.add_subplot(132), title="Monthly") df.groupby([pd.Grouper(freq='Y', level=0)] + [level_values(i) for i in [1]]).agg( agg_rules).set_index(['dt', 'symbol'], drop=False ).close.unstack(1).plot(ax=fig.add_subplot(133), title="Yearly") plt.show()</span></span></code> </pre> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6f7/af2/5da/6f7af25dae49fd088111cc457143ae34.png" alt="рдЫрд╡рд┐"><br><br>  рдЪрд╛рд░реНрдЯ рдХрд┐рдВрд╡рджрдВрддреА рдХреЗ рд╕рд╛рде рдХреНрд╖реЗрддреНрд░ рдХреЛ рд╕рд╣реА рдврдВрдЧ рд╕реЗ рдкреНрд░рджрд░реНрд╢рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рд╣рдо рд╢реНрд░реГрдВрдЦрд▓рд╛ () (рдЕрдирд╕реНрдЯреИрдХ (1) рдХрдорд╛рдВрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реБрдП рд╕реНрддрдВрднреЛрдВ рдХреЗ рдКрдкрд░ рд╕реВрдЪрдХрд╛рдВрдХ рд╕реНрддрд░ рдХреЛ рджреВрд╕рд░реЗ рд╕реНрддрд░ рдкрд░ рдЯрд┐рдХрд░ рдХреЗ рд╕рд╛рде рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд░рддреЗ рд╣реИрдВред  DataFrame () рдХреЗ рд╕рд╛рде, рдРрд╕реА рд╕рдВрдЦреНрдпрд╛ рдХрд╛рдо рдирд╣реАрдВ рдХрд░реЗрдЧреА, рд▓реЗрдХрд┐рди рд╕рдорд╛рдзрд╛рди рдиреАрдЪреЗ рд╣реИред <br><br>  рдЬрдм рдорд╛рдирдХ рдЕрд╡рдзрд┐ рдХреЗ рдЕрдиреБрд╕рд╛рд░ рд╕рдореВрд╣реАрдХрд░рдг рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдкрдВрдбрд╛рд╕ рд╕реВрдЪрдХрд╛рдВрдХ рдореЗрдВ рд╕рдореВрд╣ рдХреА рдирд╡реАрдирддрдо рдХреИрд▓реЗрдВрдбрд░ рддрд┐рдерд┐ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ, рдЬреЛ рдЕрдХреНрд╕рд░ рд╡рд╛рд╕реНрддрд╡рд┐рдХ рддрд┐рдерд┐рдпреЛрдВ рд╕реЗ рднрд┐рдиреНрди рд╣реЛрддрд╛ рд╣реИред  рдЗрд╕реЗ рдареАрдХ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдЗрдВрдбреЗрдХреНрд╕ рдХреЛ рдЕрдкрдбреЗрдЯ рдХрд░реЗрдВред <br><br><pre> <code class="python hljs">monthly = df.groupby([pd.Grouper(freq=<span class="hljs-string"><span class="hljs-string">'M'</span></span>, level=<span class="hljs-number"><span class="hljs-number">0</span></span>), level_values(<span class="hljs-number"><span class="hljs-number">1</span></span>)]).agg(agg_rules) \ .set_index([<span class="hljs-string"><span class="hljs-string">'dt'</span></span>, <span class="hljs-string"><span class="hljs-string">'symbol'</span></span>], drop=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>)</code> </pre> <br>  рдПрдХ рд╡рд┐рд╢рд┐рд╖реНрдЯ рд╕рдВрдкрддреНрддрд┐ рдХрд╛ рдореВрд▓реНрдп рдЗрддрд┐рд╣рд╛рд╕ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХрд╛ рдПрдХ рдЙрджрд╛рд╣рд░рдг (рд╣рдо рд╕рднреА рддрд┐рдерд┐рдпрд╛рдВ, QQQ рдЯрд┐рдХрд░ рдФрд░ рд╕рднреА рдХреЙрд▓рдо рд▓реЗрддреЗ рд╣реИрдВ): <br><br><pre> <code class="python hljs">monthly.loc[(slice(<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>), [<span class="hljs-string"><span class="hljs-string">'QQQ'</span></span>]), :] <span class="hljs-comment"><span class="hljs-comment">#   </span></span></code> </pre> <br><h2>  рдорд╛рд╕рд┐рдХ рд╕рдВрдкрддреНрддрд┐ рдХреА рдЕрд╕реНрдерд┐рд░рддрд╛ </h2><br>  рдЕрдм рд╣рдо рдЪрд╛рд░реНрдЯ рдкрд░ рдХреБрдЫ рдкрдВрдХреНрддрд┐рдпреЛрдВ рдХреЛ рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рд╣рдорд╛рд░реЗ рд▓рд┐рдП рдмреНрдпрд╛рдЬ рдХреА рдЕрд╡рдзрд┐ рдХреЗ рд▓рд┐рдП рдкреНрд░рддреНрдпреЗрдХ рд╕рдВрдкрддреНрддрд┐ рдХреА рдХреАрдордд рдореЗрдВ рдмрджрд▓рд╛рд╡ред  рдРрд╕рд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рд╣рдо рдПрдХ рдкрд░рд┐рд╕рдВрдкрддреНрддрд┐ рдЯрд┐рдХрд░ рдХреЗ рд╕рд╛рде рдмрд╣реБ-рд╕реВрдЪрдХрд╛рдВрдХ рд╕реНрддрд░ рджреНрд╡рд╛рд░рд╛ рдбреЗрдЯрд╛рдлреНрд░реЗрдо рдХреЛ рд╕рдореВрд╣реАрдХреГрдд рдХрд░рдХреЗ рдореВрд▓реНрдп рдкрд░рд┐рд╡рд░реНрддрдиреЛрдВ рдХрд╛ рдкреНрд░рддрд┐рд╢рдд рдкреНрд░рд╛рдкреНрдд рдХрд░рддреЗ рд╣реИрдВред <br><br><pre> <code class="python hljs">monthly = df.groupby([pd.Grouper(freq=<span class="hljs-string"><span class="hljs-string">'M'</span></span>, level=<span class="hljs-number"><span class="hljs-number">0</span></span>), level_values(<span class="hljs-number"><span class="hljs-number">1</span></span>)]).agg( agg_rules).set_index([<span class="hljs-string"><span class="hljs-string">'dt'</span></span>, <span class="hljs-string"><span class="hljs-string">'symbol'</span></span>], drop=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>) <span class="hljs-comment"><span class="hljs-comment">#     .   . monthly['pct_close'] = monthly.groupby(level=1)['close'].pct_change().fillna(0) #  ax = monthly.pct_close.unstack(1).plot(title="Monthly", figsize=(15, 4)) ax.axhline(0, color='k', linestyle='--', lw=0.5) plt.show()</span></span></code> </pre> <br><img src="https://habrastorage.org/getpro/habr/post_images/284/7b8/23b/2847b823be4247ecf47418120b78cb15.png" alt="рдЫрд╡рд┐"><br><br><h2>  рдПрд╕реЗрдЯ рд░рд┐рдЯрд░реНрди рдХреА рддреБрд▓рдирд╛ рдХрд░реЗрдВ </h2><br>  рдЕрдм рд╣рдо рд╢реНрд░реГрдВрдЦрд▓рд╛ ()) рд░реЛрд▓рд┐рдВрдЧ () рд╡рд┐рдВрдбреЛ рд╡рд┐рдзрд┐ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВрдЧреЗ рдФрд░ рдПрдХ рдирд┐рд╢реНрдЪрд┐рдд рдЕрд╡рдзрд┐ рдХреЗ рд▓рд┐рдП рдкрд░рд┐рд╕рдВрдкрддреНрддрд┐рдпреЛрдВ рдкрд░ рд░рд┐рдЯрд░реНрди рдкреНрд░рджрд░реНрд╢рд┐рдд рдХрд░реЗрдВрдЧреЗ: <br><br><div class="spoiler">  <b class="spoiler_title">рдкрд╛рдпрдерди рдХреЛрдб</b> <div class="spoiler_text"><pre> <code class="python hljs">rolling_prod = <span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> x: x.rolling(len(x), min_periods=<span class="hljs-number"><span class="hljs-number">1</span></span>).apply(np.prod) <span class="hljs-comment"><span class="hljs-comment">#   monthly = df.groupby([pd.Grouper(freq='M', level=0), level_values(1)]).agg( agg_rules).set_index(['dt', 'symbol'], drop=False) #     .   .   1. monthly['pct_close'] = monthly.groupby(level=1)['close'].pct_change().fillna(0) + 1 #  DataFrame    2007  fltr = monthly.dt &gt;= '2007-01-01' test = monthly[fltr].copy().set_index(['dt', 'symbol'], drop=False) #  dataframe    test.loc[test.index.levels[0][0], 'pct_close'] = 1 #    1 #    test['performance'] = test.groupby(level=1)['pct_close'].transform(rolling_prod) - 1 #  ax = test.performance.unstack(1).plot(title="Performance (Monthly) from 2007-01-01", figsize=(15, 4)) ax.axhline(0, color='k', linestyle='--', lw=0.5) plt.show() #       test.tail(len(test.index.levels[1])).sort_values('performance', ascending=False)</span></span></code> </pre> <br></div></div><br><img src="https://habrastorage.org/getpro/habr/post_images/3a0/07d/83c/3a007d83c19b3635f969351d3b288818.png" alt="рдЫрд╡рд┐"><br><br><h2>  рдкреЛрд░реНрдЯрдлреЛрд▓рд┐рдпреЛ рд░реАрдмреИрд▓реЗрдВрд╕рд┐рдВрдЧ рдХреЗ рддрд░реАрдХреЗ </h2><br>  рддреЛ рд╣рдо рд╕рдмрд╕реЗ рд╕реНрд╡рд╛рджрд┐рд╖реНрдЯ рд╣реЛ рдЧрдПред  рдЙрджрд╛рд╣рд░рдгреЛрдВ рдореЗрдВ, рд╣рдо рдХрдИ рдкрд░рд┐рд╕рдВрдкрддреНрддрд┐рдпреЛрдВ рдХреЗ рдмреАрдЪ рдкреВрд░реНрд╡ рдирд┐рд░реНрдзрд╛рд░рд┐рдд рд╢реЗрдпрд░реЛрдВ рдХреЛ рдкреВрдВрдЬреА рдХреЗ рдЖрд╡рдВрдЯрди рдореЗрдВ рдкреЛрд░реНрдЯрдлреЛрд▓рд┐рдпреЛ рдХреЗ рдкрд░рд┐рдгрд╛рдореЛрдВ рдХреЛ рджреЗрдЦреЗрдВрдЧреЗред  рдФрд░ рдЕрджреНрд╡рд┐рддреАрдп рд╢рд░реНрддреЗрдВ рднреА рдЬреЛрдбрд╝реЗрдВ рдЬрд┐рдирдХреЗ рддрд╣рдд рд╣рдо рдкреВрдВрдЬреА рдХреЗ рд╡рд┐рддрд░рдг рдХреЗ рд╕рдордп рдХреБрдЫ рд╕рдВрдкрддреНрддрд┐рдпреЛрдВ рдХреЛ рдЫреЛрдбрд╝ рджреЗрдВрдЧреЗред  рдпрджрд┐ рдХреЛрдИ рдЙрдкрдпреБрдХреНрдд рд╕рдВрдкрддреНрддрд┐ рдирд╣реАрдВ рд╣реИ, рддреЛ рд╣рдо рдорд╛рдирддреЗ рд╣реИрдВ рдХрд┐ рджрд▓рд╛рд▓ рдХреЗ рдкрд╛рд╕ рдХреИрд╢ рдореЗрдВ рдкреВрдВрдЬреА рд╣реИред <br><br>  рдкреБрдирд░реНрд╕рдВрддреБрд▓рди рдХреЗ рд▓рд┐рдП рдкрдВрдбреЛрдВ рдХреЗ рддрд░реАрдХреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рд╣рдореЗрдВ рдПрдХ рдбреЗрдЯрд╛рдлрд╝реНрд░реЗрдо рдореЗрдВ рд╕рдореВрд╣реАрдХреГрдд рдбреЗрдЯрд╛ рдХреЗ рд╕рд╛рде рд╡рд┐рддрд░рдг рд╢реЗрдпрд░реЛрдВ рдФрд░ рдЕрд╕рдВрддреБрд▓рди рдХреА рд╕реНрдерд┐рддрд┐рдпреЛрдВ рдХреЛ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред  рдЕрдм рд░рд┐рдмреИрд▓реЗрдВрд╕рд┐рдВрдЧ рдлрдВрдХреНрд╢рдиреНрд╕ рдкрд░ рд╡рд┐рдЪрд╛рд░ рдХрд░реЗрдВ рдЬрд┐рд╕реЗ рд╣рдо рдбреЗрдЯрд╛рдлрд╝реНрд░реЗрдо () рд▓рд╛рдЧреВ рдХрд░реЗрдВрдЧреЗред рд▓рд╛рдЧреВ рдХрд░реЗрдВ () рд╡рд┐рдзрд┐: <br><br><div class="spoiler">  <b class="spoiler_title">рдкрд╛рдпрдерди рдХреЛрдб</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rebalance_simple</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(x)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment">#     data = x.unstack(1) return (data.pct_close * data['size']).sum() / data['size'].sum() def rebalance_sma(x): #   ,   SMA50 &gt; SMA200 data = x.unstack(1) fltr = data['sma50'] &gt; data['sma200'] if not data[fltr]['size'].sum(): return 1 #   ,    return (data[fltr].pct_close * data[fltr]['size']).sum() / data[fltr]['size'].sum() def rebalance_rsi(x): #   ,   RSI100 &gt; 50 data = x.unstack(1) fltr = data['rsi100'] &gt; 50 if not data[fltr]['size'].sum(): return 1 #   ,    return (data[fltr].pct_close * data[fltr]['size']).sum() / data[fltr]['size'].sum() def rebalance_custom(x, df=None): #         data = x.unstack(1) for s in data.index: if data['dt'][s]: fltr_dt = df['dt'] &lt; data['rebalance_dt'][s] #   values = df[fltr_dt].loc[(slice(None), [s]), 'close'].values data.loc[s, 'custom'] = 0 #    if len(values) &gt; len(values[np.isnan(values)]): #  RSI  100  data.loc[s, 'custom'] = talib.RSI(values, timeperiod=100)[-1] fltr = data['custom'] &gt; 50 if not data[fltr]['size'].sum(): return 1 #   ,    return (data[fltr].pct_close * data[fltr]['size']).sum() / data[fltr]['size'].sum() def drawdown(chg, is_max=False): #    total = len(chg.index) rolling_max = chg.rolling(total, min_periods=1).max() daily_drawdown = chg/rolling_max - 1.0 if is_max: return daily_drawdown.rolling(total, min_periods=1).min() return daily_drawdown</span></span></code> </pre> <br></div></div><br>  рдХреНрд░рдо рдореЗрдВ: <br><br><ul><li>  rebalance_simple рд╕рдмрд╕реЗ рд╕рд░рд▓ рдХрд╛рд░реНрдп рд╣реИ рдЬреЛ рд╢реЗрдпрд░реЛрдВ рдореЗрдВ рдкреНрд░рддреНрдпреЗрдХ рдкрд░рд┐рд╕рдВрдкрддреНрддрд┐ рдХреА рд▓рд╛рднрдкреНрд░рджрддрд╛ рдХреЛ рд╡рд┐рддрд░рд┐рдд рдХрд░реЗрдЧрд╛ред </li><li>  rebalance_sma рдПрдХ рдРрд╕рд╛ рдХрд╛рд░реНрдп рд╣реИ рдЬреЛ рдЙрди рдкрд░рд┐рд╕рдВрдкрддреНрддрд┐рдпреЛрдВ рдХреЗ рдмреАрдЪ рдкреВрдВрдЬреА рдХрд╛ рд╡рд┐рддрд░рдг рдХрд░рддрд╛ рд╣реИ рдЬрд┐рдирдХреА рдЪрд▓рддреА рдФрд╕рдд рдкреНрд░рддрд┐рдкреВрд░реНрддрд┐ рдХреЗ рд╕рдордп 200 рджрд┐рдиреЛрдВ рдХреА рддреБрд▓рдирд╛ рдореЗрдВ 50 рджрд┐рди рдЕрдзрд┐рдХ рд╣реЛрддреА рд╣реИред </li><li>  rebalance_rsi - рдПрдХ рдРрд╕рд╛ рдлрд╝рдВрдХреНрд╢рди рдЬреЛ рдкрд░рд┐рд╕рдВрдкрддреНрддрд┐рдпреЛрдВ рдХреЗ рдмреАрдЪ рдкреВрдВрдЬреА рд╡рд┐рддрд░рд┐рдд рдХрд░рддрд╛ рд╣реИ рдЬрд┐рд╕рдХреЗ рд▓рд┐рдП 100 рджрд┐рдиреЛрдВ рдХреЗ рд▓рд┐рдП рдЖрд░рдПрд╕рдЖрдИ рд╕рдВрдХреЗрддрдХ рдХрд╛ рдореВрд▓реНрдп 50 рд╕реЗ рдКрдкрд░ рд╣реИред </li><li>  rebalance_custom рд╕рдмрд╕реЗ рдзреАрдорд╛ рдФрд░ рд╕рдмрд╕реЗ рд╕рд╛рд░реНрд╡рднреМрдорд┐рдХ рдлрд╝рдВрдХреНрд╢рди рд╣реИ, рдЬрд╣рд╛рдВ рд╣рдо рд░рд┐рдмреИрд▓реЗрдВрд╕рд┐рдВрдЧ рдХреЗ рд╕рдордп рджреИрдирд┐рдХ рд╕рдВрдкрддреНрддрд┐ рдореВрд▓реНрдп рдЗрддрд┐рд╣рд╛рд╕ рд╕реЗ рд╕рдВрдХреЗрддрдХ рдореВрд▓реНрдпреЛрдВ рдХреА рдЧрдгрдирд╛ рдХрд░реЗрдВрдЧреЗред  рдпрд╣рд╛рдВ рдЖрдк рдХрд┐рд╕реА рднреА рд╕реНрдерд┐рддрд┐ рдФрд░ рдбреЗрдЯрд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред  рдпрд╣рд╛рдВ рддрдХ тАЛтАЛрдХрд┐ рд╣рд░ рдмрд╛рд░ рдмрд╛рд╣рд░реА рд╕реНрд░реЛрддреЛрдВ рд╕реЗ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВред  рд▓реЗрдХрд┐рди рдЖрдк рдПрдХ рдЪрдХреНрд░ рдХреЗ рдмрд┐рдирд╛ рдирд╣реАрдВ рдХрд░ рд╕рдХрддреЗред </li><li>  рдбреНрд░рд╛рдбрд╛рдЙрди - рд╕рд╣рд╛рдпрдХ рдлрд╝рдВрдХреНрд╢рди, рдкреЛрд░реНрдЯрдлреЛрд▓рд┐рдпреЛ рдореЗрдВ рдЕрдзрд┐рдХрддрдо рдЧрд┐рд░рд╛рд╡рдЯ рджрд┐рдЦрд╛ рд░рд╣рд╛ рд╣реИред </li></ul><br>  рд░рд┐рдмреИрд▓реЗрдВрд╕рд┐рдВрдЧ рдлрдВрдХреНрд╢рдВрд╕ рдореЗрдВ, рд╣рдореЗрдВ рдПрд╕реЗрдЯреНрд╕ рджреНрд╡рд╛рд░рд╛ рдЯреВрдЯреА рддрд╛рд░реАрдЦ рдХреЗ рд▓рд┐рдП рд╕рднреА рдбреЗрдЯрд╛ рдХреА рдПрдХ рд╕рд░рдгреА рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИред  рдбреЗрдЯрд╛рдлреНрд░реЗрдо () рд▓рд╛рдЧреВ рдХрд░реЗрдВ () рд╡рд┐рдзрд┐, рдЬрд┐рд╕рдХреЗ рджреНрд╡рд╛рд░рд╛ рд╣рдо рдкреЛрд░реНрдЯрдлреЛрд▓рд┐рдпреЛ рдХреЗ рдкрд░рд┐рдгрд╛рдореЛрдВ рдХреА рдЧрдгрдирд╛ рдХрд░реЗрдВрдЧреЗ, рд╣рдорд╛рд░реЗ рдлрд╝рдВрдХреНрд╢рди рдХреЗ рд▓рд┐рдП рдПрдХ рд╕рд░рдгреА рдкрд╛рд╕ рдХрд░реЗрдВрдЧреЗ, рдЬрд╣рд╛рдВ рдХреЙрд▓рдо рдкрдВрдХреНрддрд┐ рд╕реВрдЪрдХрд╛рдВрдХ рдмрди рдЬрд╛рдПрдЧрд╛ред  рдФрд░ рдЕрдЧрд░ рд╣рдо рдПрдХ рдмрд╣реБ-рд╕реВрдЪрдХрд╛рдВрдХ рдмрдирд╛рддреЗ рд╣реИрдВ, рдЬрд╣рд╛рдВ рдЯрд┐рдХрд░ рд╢реВрдиреНрдп рд╕реНрддрд░ рд╣реЛрдЧрд╛, рддреЛ рдПрдХ рдмрд╣реБ-рд╕реВрдЪрдХрд╛рдВрдХ рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рдЖрдПрдЧрд╛ред  рд╣рдо рдЗрд╕ рдмрд╣реБ-рд╕реВрдЪрдХрд╛рдВрдХ рдХреЛ рджреЛ-рдЖрдпрд╛рдореА рд╕рд░рдгреА рдореЗрдВ рд╡рд┐рд╕реНрддрд╛рд░рд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдкреНрд░рддреНрдпреЗрдХ рдкрдВрдХреНрддрд┐ рдкрд░ рд╕рдВрдмрдВрдзрд┐рдд рд╕рдВрдкрддреНрддрд┐ рдХрд╛ рдбреЗрдЯрд╛ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред <br><br><img src="https://habrastorage.org/getpro/habr/post_images/fa8/2d1/d1c/fa82d1d1ca7cfca3f8f554e46f8e433a.png" alt="рдЫрд╡рд┐"><br><br><h2>  рдкреЛрд░реНрдЯрдлреЛрд▓рд┐рдпреЛ рд░рд┐рдмреИрд▓реЗрдВрд╕рд┐рдВрдЧ </h2><br>  рдЕрдм рдЖрд╡рд╢реНрдпрдХ рд╢рд░реНрддреЛрдВ рдХреЛ рддреИрдпрд╛рд░ рдХрд░рдирд╛ рдФрд░ рдЪрдХреНрд░ рдореЗрдВ рдкреНрд░рддреНрдпреЗрдХ рдкреЛрд░реНрдЯрдлреЛрд▓рд┐рдпреЛ рдХреЗ рд▓рд┐рдП рдПрдХ рдЧрдгрдирд╛ рдХрд░рдирд╛ рдкрд░реНрдпрд╛рдкреНрдд рд╣реИред  рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ, рд╣рдо рджреИрдирд┐рдХ рдореВрд▓реНрдп рдЗрддрд┐рд╣рд╛рд╕ рдкрд░ рд╕рдВрдХреЗрддрдХ рдХреА рдЧрдгрдирд╛ рдХрд░рддреЗ рд╣реИрдВ: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#    1  ,      df['sma50'] = df.groupby(level=1)['close'].transform(lambda x: talib.SMA(x.values, timeperiod=50)).shift(1) df['sma200'] = df.groupby(level=1)['close'].transform(lambda x: talib.SMA(x.values, timeperiod=200)).shift(1) df['rsi100'] = df.groupby(level=1)['close'].transform(lambda x: talib.RSI(x.values, timeperiod=100)).shift(1)</span></span></code> </pre> <br>  рдЕрдм рд╣рдо рдЙрдкрд░реЛрдХреНрдд рд╡рд░реНрдгрд┐рдд рд╡рд┐рдзрд┐рдпреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╡рд╛рдВрдЫрд┐рдд рдкреБрдирд░реНрд╡рд┐рддреНрдд рдЕрд╡рдзрд┐ рдХреЗ рд▓рд┐рдП рдХрд╣рд╛рдиреА рдХрд╛ рд╕рдореВрд╣ рдмрдирд╛рдПрдВрдЧреЗред  рдЙрд╕реА рд╕рдордп, рд╣рдо рднрд╡рд┐рд╖реНрдп рдХреА рддрд▓рд╛рд╢ рдХреЛ рдмрд╛рд╣рд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЕрд╡рдзрд┐ рдХреА рд╢реБрд░реБрдЖрдд рдореЗрдВ рд╕рдВрдХреЗрддрдХ рдХреЗ рдореВрд▓реНрдпреЛрдВ рдХреЛ рд▓реЗ рд▓реЗрдВрдЧреЗред <br><br>  рд╣рдо рд╡рд┐рднрд╛рдЧреЛрдВ рдХреА рд╕рдВрд░рдЪрдирд╛ рдХрд╛ рд╡рд░реНрдгрди рдХрд░рддреЗ рд╣реИрдВ рдФрд░ рд╡рд╛рдВрдЫрд┐рдд рдкреБрдирд░реНрд╕рдВрддреБрд▓рди рдХрд╛ рд╕рдВрдХреЗрдд рджреЗрддреЗ рд╣реИрдВред  рд╣рдо рдПрдХ рдЪрдХреНрд░ рдореЗрдВ рд╡рд┐рднрд╛рдЧреЛрдВ рдХреА рдЧрдгрдирд╛ рдХрд░реЗрдВрдЧреЗ, рдХреНрдпреЛрдВрдХрд┐ рд╣рдореЗрдВ рдЕрджреНрд╡рд┐рддреАрдп рд╢реЗрдпрд░реЛрдВ рдФрд░ рд╢рд░реНрддреЛрдВ рдХреЛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ: <br><br><div class="spoiler">  <b class="spoiler_title">рдкрд╛рдпрдерди рдХреЛрдб</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#  :  ,  ,  portfolios = [ {'symbols': [('SPY', 0.8), ('AGG', 0.2)], 'func': rebalance_sma, 'name': 'Portfolio 80/20 SMA50x200'}, {'symbols': [('SPY', 0.8), ('AGG', 0.2)], 'func': rebalance_rsi, 'name': 'Portfolio 80/20 RSI100&gt;50'}, {'symbols': [('SPY', 0.8), ('AGG', 0.2)], 'func': partial(rebalance_custom, df=df), 'name': 'Portfolio 80/20 Custom'}, {'symbols': [('SPY', 0.8), ('AGG', 0.2)], 'func': rebalance_simple, 'name': 'Portfolio 80/20'}, {'symbols': [('SPY', 0.4), ('AGG', 0.6)], 'func': rebalance_simple, 'name': 'Portfolio 40/60'}, {'symbols': [('SPY', 0.2), ('AGG', 0.8)], 'func': rebalance_simple, 'name': 'Portfolio 20/80'}, {'symbols': [('DIA', 0.2), ('QQQ', 0.3), ('SPY', 0.2), ('IWM', 0.2), ('AGG', 0.1)], 'func': rebalance_simple, 'name': 'Portfolio DIA &amp; QQQ &amp; SPY &amp; IWM &amp; AGG'}, ] for p in portfolios: #    rebalance['size'] = 0. for s, pct in p['symbols']: #       rebalance.loc[(slice(None), [s]), 'size'] = pct #            rebalance_perf = rebalance.stack().unstack([1, 2]).apply(p['func'], axis=1) #    p['performance'] = (rebalance_perf.rolling(len(rebalance_perf), min_periods=1).apply(np.prod) - 1) #    p['drawdown'] = drawdown(p['performance'] + 1, is_max=True)</span></span></code> </pre> <br></div></div><br>  рдЗрд╕ рдмрд╛рд░ рд╣рдореЗрдВ рдЕрд╕рдВрддреБрд▓рди рдлрд╝рдВрдХреНрд╢рди рдореЗрдВ рд╡рд╛рдВрдЫрд┐рдд рдмрд╣реБ-рд╕реВрдЪрдХрд╛рдВрдХ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреЙрд▓рдо рдФрд░ рдкрдВрдХреНрддрд┐ рд╕реВрдЪрдХрд╛рдВрдХреЛрдВ рдХреЗ рд╕рд╛рде рдПрдХ рдЪрд╛рд▓ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред  рд╣рдо рдЗрд╕реЗ DataFrame ()ред Stack ()ред Unstack ([1, 2]) рдХреНрд░рдо рдореЗрдВ рдХреЙрд▓ рдХрд░рдХреЗ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВрдЧреЗред  рдпрд╣ рдХреЛрдб рдХреЙрд▓рдо рдХреЛ рд▓реЛрдЕрд░рдХреЗрд╕ рдорд▓реНрдЯреА-рдЗрдВрдбреЗрдХреНрд╕ рдореЗрдВ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд░реЗрдЧрд╛, рдФрд░ рдлрд┐рд░ рд╡рд╛рдВрдЫрд┐рдд рдХреНрд░рдо рдореЗрдВ рдЯрд┐рдХрд░ рдФрд░ рдХреЙрд▓рдо рдХреЗ рд╕рд╛рде рдорд▓реНрдЯреА-рдЗрдВрдбреЗрдХреНрд╕ рдХреЛ рд╡рд╛рдкрд╕ рдХрд░реЗрдЧрд╛ред <br><br><h2>  рдЪрд╛рд░реНрдЯ рдХреЗ рд▓рд┐рдП рддреИрдпрд╛рд░ рдмреНрд░реАрдлрдХреЗрд╕ </h2><br>  рдЕрдм рдпрд╣ рд╕рдм рдХреБрдЫ рдЖрдХрд░реНрд╖рд┐рдд рдХрд░рддрд╛ рд╣реИред  рдРрд╕рд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдкреЛрд░реНрдЯрдлреЛрд▓рд┐рдпреЛ рдЪрдХреНрд░ рдХреЛ рдлрд┐рд░ рд╕реЗ рдЪрд▓рд╛рдПрдВ, рдЬреЛ рдЪрд╛рд░реНрдЯ рдкрд░ рдбреЗрдЯрд╛ рдкреНрд░рджрд░реНрд╢рд┐рдд рдХрд░рддрд╛ рд╣реИред  рдЕрдВрдд рдореЗрдВ рд╣рдо рдПрд╕рдкреАрд╡рд╛рдИ рдХреЛ рдПрдХ рдмреЗрдВрдЪрдорд╛рд░реНрдХ рдХреЗ рд░реВрдк рдореЗрдВ рддреБрд▓рдирд╛ рдХреЗ рд▓рд┐рдП рддреИрдпрд╛рд░ рдХрд░реЗрдВрдЧреЗред <br><br><div class="spoiler">  <b class="spoiler_title">рдкрд╛рдпрдерди рдХреЛрдб</b> <div class="spoiler_text"><pre> <code class="python hljs">fig = plt.figure(figsize=(<span class="hljs-number"><span class="hljs-number">15</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>), facecolor=<span class="hljs-string"><span class="hljs-string">'white'</span></span>) ax_perf = fig.add_subplot(<span class="hljs-number"><span class="hljs-number">121</span></span>) ax_dd = fig.add_subplot(<span class="hljs-number"><span class="hljs-number">122</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> p <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> portfolios: p[<span class="hljs-string"><span class="hljs-string">'performance'</span></span>].rename(p[<span class="hljs-string"><span class="hljs-string">'name'</span></span>]).plot(ax=ax_perf, legend=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, title=<span class="hljs-string"><span class="hljs-string">'Performance'</span></span>) p[<span class="hljs-string"><span class="hljs-string">'drawdown'</span></span>].rename(p[<span class="hljs-string"><span class="hljs-string">'name'</span></span>]).plot(ax=ax_dd, legend=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, title=<span class="hljs-string"><span class="hljs-string">'Max drawdown'</span></span>) <span class="hljs-comment"><span class="hljs-comment">#       print(f"{p['name']}: {p['performance'][-1]*100:.2f}% / {p['drawdown'][-1]*100:.2f}%") # SPY,   rebalance.loc[(slice(None), ['SPY']), :].set_index('dt', drop=False).performance. \ rename('SPY').plot(ax=ax_perf, legend=True) drawdown(rebalance.loc[(slice(None), ['SPY']), :].set_index('dt', drop=False).performance + 1, is_max=True).rename('SPY').plot(ax=ax_dd, legend=True) ax_perf.axhline(0, color='k', linestyle='--', lw=0.5) ax_dd.axhline(0, color='k', linestyle='--', lw=0.5) plt.show()</span></span></code> </pre> <br></div></div><br><img src="https://habrastorage.org/getpro/habr/post_images/c68/2e2/870/c682e287032885dea4b266758934f7e5.png" alt="рдЫрд╡рд┐"><br><br><h2>  рдирд┐рд╖реНрдХрд░реНрд╖ </h2><br>  рдорд╛рдирд╛ рдЧрдпрд╛ рдХреЛрдб рдЖрдкрдХреЛ рд╡рд┐рднрд┐рдиреНрди рдкреЛрд░реНрдЯрдлреЛрд▓рд┐рдпреЛ рд╕рдВрд░рдЪрдирд╛рдУрдВ рдФрд░ рд░реАрдмреИрд▓реЗрдВрд╕рд┐рдВрдЧ рд╕реНрдерд┐рддрд┐рдпреЛрдВ рдХрд╛ рдЪрдпрди рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред  рдЗрд╕рдХреА рдорджрдж рд╕реЗ, рдЖрдк рдЬрд▓реНрджреА рд╕реЗ рдЬрд╛рдВрдЪ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдХреНрдпрд╛ рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдпрд╣ рдПрдХ рдкреЛрд░реНрдЯрдлреЛрд▓рд┐рдпреЛ рдореЗрдВ рд╕реЛрдиреЗ (рдЬреАрдПрд▓рдбреА) рдпрд╛ рдЙрднрд░рддреЗ рдмрд╛рдЬрд╛рд░реЛрдВ (рдИрдИрдПрдо) рдХреЗ рд▓рд╛рдпрдХ рд╣реИред  рдЗрд╕реЗ рд╕реНрд╡рдпрдВ рдЖрдЬрд╝рдорд╛рдПрдВ, рд╕рдВрдХреЗрддрдХ рдХреЗ рд▓рд┐рдП рдЕрдкрдиреА рд╢рд░реНрддреЛрдВ рдХреЛ рдЬреЛрдбрд╝реЗрдВ рдпрд╛ рдкрд╣рд▓реЗ рд╕реЗ рд╡рд░реНрдгрд┐рдд рдорд╛рдкрджрдВрдбреЛрдВ рдХрд╛ рдЪрдпрди рдХрд░реЗрдВред  (рд▓реЗрдХрд┐рди рдЙрддреНрддрд░рдЬреАрд╡реА рдХреА рдЧрд▓рддреА рдХреЛ рдпрд╛рдж рд░рдЦреЗрдВ рдФрд░ рдкрд┐рдЫрд▓реЗ рдбреЗрдЯрд╛ рдХреЗ рд▓рд┐рдП рдлрд┐рдЯрд┐рдВрдЧ рднрд╡рд┐рд╖реНрдп рдореЗрдВ рдЙрдореНрдореАрджреЛрдВ рдкрд░ рдЦрд░рд╛ рдирд╣реАрдВ рдЙрддрд░ рд╕рдХрддреАред) рдФрд░ рдлрд┐рд░ рддрдп рдХрд░реЗрдВ рдХрд┐ рдЖрдк рдХрд┐рд╕рдХреЗ рд╕рд╛рде рдЕрдкрдиреЗ рдкреЛрд░реНрдЯрдлреЛрд▓рд┐рдпреЛ рдкрд░ рднрд░реЛрд╕рд╛ рдХрд░рддреЗ рд╣реИрдВ - рдкрд╛рдпрдерди рдпрд╛ рд╡рд┐рддреНрддреАрдп рд╕рд▓рд╛рд╣рдХрд╛рд░? <br><br>  рд░рд┐рдкреЛрдЬрд┐рдЯрд░реА: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">rebalance.portfolio</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/hi419979/">https://habr.com/ru/post/hi419979/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../hi419969/index.html">рд░реВрдмреА рдореЗрдВ рдЪрд┐рдВрддрд╛ред рд╕рд╛рде рд╣реА рдЯреЙрдк-рд▓реЗрд╡рд▓ рд╕реЗ рдХреНрд▓рд╛рд╕реЗрд╕ рднреА рдЫрд┐рдкрд╛рддреЗ рд╣реИрдВ</a></li>
<li><a href="../hi419971/index.html">рд░реЙрдХреЗрдЯ рд▓реИрдм рдлреИрд▓рддрд╛ рд╣реИ, рдлреИрд▓рддрд╛ рд╣реИ рдФрд░ рддреЗрдЬреА рд▓рд╛рддрд╛ рд╣реИ</a></li>
<li><a href="../hi419973/index.html">13 рд╕реЗ 19 рдЕрдЧрд╕реНрдд рддрдХ рдорд╛рд╕реНрдХреЛ рдореЗрдВ рдбрд┐рдЬрд┐рдЯрд▓ рдХрд╛рд░реНрдпрдХреНрд░рдо</a></li>
<li><a href="../hi419975/index.html">рд╣рдо рд╡рд┐рдВрдбреЛрдЬ рдХреЙрд░рдкреЛрд░реЗрдЯ рд╕реЗ рдХреИрд╕реЗ рднрд╛рдЧреЗ</a></li>
<li><a href="../hi419977/index.html">рд╢реЛрдзрдХрд░реНрддрд╛: рд╕рднреА рд╕реНрддрд░ 2 рдСрдЯреЛрдкрд┐рд▓реЙрдЯ рд╕рдорд╛рди рд░реВрдк рд╕реЗ рдЕрдЪреНрдЫреА рддрд░рд╣ рд╕реЗ рдХрд╛рдо рдирд╣реАрдВ рдХрд░рддреЗ рд╣реИрдВ, рд▓реЗрдХрд┐рди рдкреНрд░рдЧрддрд┐ рд╕реНрдкрд╖реНрдЯ рд╣реИ</a></li>
<li><a href="../hi419981/index.html">рдирд╛рдЗрдЯрд▓рд╛рдЗрдлрд╝ рдЖрдХрд╛рд╢ рдпрд╛ рдЫрджреНрдо рдХреА рдЦреЛрдЬ</a></li>
<li><a href="../hi419983/index.html">рдЕрдВрддрд┐рдо рд╕рдкреНрддрд╛рд╣ рд╕рдВред 326 (6 рдЕрдЧрд╕реНрдд - 12, 2018) рдХреЗ рд▓рд┐рдП рджреБрдирд┐рдпрд╛ рдХреЗ рд╕рд╛рдордиреЗ рд╕реЗ рддрд╛рдЬрд╛ рд╕рд╛рдордЧреНрд░реА рдХрд╛ рдкрд╛рдЪрди</a></li>
<li><a href="../hi419985/index.html">рдХреНрд▓реИрдЯ, рдХреНрд▓реИрдЯ: рдЪреЗрд░реА рдХреА рдХрд╣рд╛рдиреА, рдЬреЛ рдХреАрдмреЛрд░реНрдб рд╕реНрд╡рд┐рдЪ рдХреЗ рд▓рд┐рдП рдкреНрд░рд╕рд┐рджреНрдз рд╣реЛ рдЧрдИ</a></li>
<li><a href="../hi419987/index.html">рд░рдХреНрдд рдХреА рдмреВрдВрджреЗрдВ рдХреНрдпрд╛ рдмрддрд╛рдПрдВрдЧреА: рдЕрдкрд░рд╛рдзреЛрдВ рдХрд╛ рддреНрд░рд┐рдХреЛрдгрдорд┐рддрд┐</a></li>
<li><a href="../hi419989/index.html">рдиреНрдпреВрдЬреАрд▓реИрдВрдб рдкреНрд▓рд╛рд╕реНрдЯрд┐рдХ рдмреИрдЧ рдкрд░ рдкреНрд░рддрд┐рдмрдВрдз рд▓рдЧрд╛рддрд╛ рд╣реИ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>