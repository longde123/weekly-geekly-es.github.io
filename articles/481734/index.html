<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üóÉÔ∏è üï† üóúÔ∏è Experiencia con impresoras de tarjetas, parte 1 üå•Ô∏è üë®‚Äç‚ù§Ô∏è‚Äçüíã‚Äçüë® üßùüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Este art√≠culo ser√° √∫til para aquellos que comienzan a trabajar con impresoras de tarjetas ( Evolis Primacy y Smart-51 ) y tarjetas codificadas con NFC...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Experiencia con impresoras de tarjetas, parte 1</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/481734/"><p>  Este art√≠culo ser√° √∫til para aquellos que comienzan a trabajar con impresoras de tarjetas ( <strong>Evolis Primacy</strong> y <strong>Smart-51</strong> ) y tarjetas codificadas con NFC como <strong>Mifare Classic</strong> y <strong>Mifare DESFire EV2</strong> .  En la primera parte describiremos la impresi√≥n general de trabajar con impresoras de tarjetas, as√≠ como los problemas que tuvimos que enfrentar.  En la segunda parte, se planea mostrar partes m√°s pr√°cticas: c√≥digo, consejos de operaci√≥n. </p><br><h3 id="1-kak-poyavilas-zadacha">  1. ¬øC√≥mo apareci√≥ la tarea? </h3><br><p>  Estamos desarrollando un sistema de tickets electr√≥nicos, que incluye trabajar con tarjetas NFC.  Cada tarjeta NFC tiene un n√∫mero f√°cil de usar y una <strong>identificaci√≥n</strong> individual.  <strong>El n√∫mero</strong> debe estar impreso en la tarjeta y la <strong>identificaci√≥n est√°</strong> escrita en el chip NFC.  Una de las tareas era establecer una producci√≥n estable de tarjetas de transporte. </p><br><p>  En la primera etapa, el problema se resolvi√≥ de la manera m√°s simple: el proveedor de la tarjeta NFC imprime las impresiones con <strong>N√∫meros</strong> , y nosotros registramos las ID utilizando lectores de escritorio, software especial y una persona.  Despu√©s de recibir las tarjetas del proveedor, es necesario registrar la tarjeta en el sistema y asociar la <strong>identificaci√≥n</strong> y el <strong>n√∫mero</strong> entre s√≠.  Como lector de escritorio, utilizamos el lector Z-2 [1]. </p><br><p>  El proceso se parec√≠a a esto: </p><br><ul><li>  El operador recoge una tarjeta.  El n√∫mero de la tarjeta ya est√° impreso en la tarjeta, pero se requiere el registro de la tarjeta en el sistema y el registro de la <strong>identificaci√≥n</strong> en el chip NFC </li><li>  El operador coloca la tarjeta en el Lector Z-2 y registra el <strong>N√∫mero</strong> en el sistema de tickets electr√≥nicos ingresando manualmente el <strong>N√∫mero de</strong> Tarjeta.  Para la agrupaci√≥n y el registro, se realiza una llamada a la API HTTPS </li><li>  El operador toma la siguiente tarjeta y la vuelve a hacer. </li></ul><br><p>  Una soluci√≥n simple y r√°pida con un <em>peque√±o</em> inconveniente.  La influencia del factor humano genera tarjetas fantasma para las cuales el <strong>N√∫mero</strong> impreso en la tarjeta no corresponde al <strong>ID de</strong> enlace - <strong>N√∫mero</strong> en la base de datos del sistema. </p><a name="habracut"></a><br><p>  As√≠ naci√≥ la siguiente declaraci√≥n del problema: se requiere imprimir el <strong>N√∫mero</strong> , escribir la <strong>ID</strong> y registrar las tarjetas NFC en el sistema <strong>at√≥micamente</strong> y con una m√≠nima participaci√≥n humana. </p><br><p>  En este art√≠culo describiremos todo el equipo con el que trabajamos, y todos los escollos.  Al final, trataremos de decir qu√© equipo nos parece mejor. </p><br><h3 id="11-nfc-karty">  1.1.  Tarjetas NFC </h3><br><p>  Revisamos las tarjetas NFC MIFARE Classic 1K y MIFARE DESFire EV2.  MIFARE Classic es el m√°s com√∫n y m√°s vulnerable para copiar.  Sin embargo, siguen siendo populares en lugares como universidades y transporte p√∫blico.  Cuando se manejan flujos de efectivo, se necesita una soluci√≥n m√°s confiable.  Por lo tanto, las tarjetas MIFARE DESFire EV2 se convirtieron en una alternativa.  Este es uno de los √∫ltimos tipos de tarjetas que utilizan DES, TDES (2KTDES, 3KTDES), algoritmos de cifrado AES [2, 3].  Brevemente sobre cada mapa: </p><br><p>  <em>MIFARE Classic</em> </p><br><p>  La tarjeta de memoria es un sector y bloques.  La primera unidad de memoria es un sector.  Hay 16 sectores en el mapa, cada uno de los cuales tiene 4 bloques de datos.  La memoria de cada bloque es de 16 bytes.  Para leer y / o escribir datos, el lector debe iniciar sesi√≥n en el sector.  Un bloque especial en cada sector, el bloque de remolque, est√° dise√±ado para almacenar llaves.  En primer lugar, para trabajar con el sector, debe iniciar sesi√≥n en el bloque de tr√°iler.  El bloque de avance tambi√©n almacena 16 bytes: 6 bytes por clave tipo A, 4 bytes por derechos de acceso, 6 bytes por clave tipo B. </p><br><p>  La Figura 1 [4] muestra claramente los sectores, bloques y claves. </p><br><br><p><img src="https://habrastorage.org/webt/lj/mr/as/ljmrasis1ncssiee0chfn8ougie.png"><br>  Figura 1 - Dispositivo de memoria en Mifare Classic </p><br><p>  <em>MIFARE DESFire</em> </p><br><p>  El dispositivo de tarjeta se parece a un sistema de archivos.  La tarjeta consta de aplicaciones y archivos.  En el mapa hay una aplicaci√≥n principal (aplicaci√≥n) con id - 000000 (0x00, 0x00, 0x00).  Dentro de la aplicaci√≥n principal, puede crear una nueva aplicaci√≥n y crear archivos de datos dentro de ella. <br>  Las caracter√≠sticas de las tarjetas DESFire se presentan en la Figura 2 [5].  A cada aplicaci√≥n se le asignan sus propias claves de acceso a los archivos de la aplicaci√≥n. </p><br><p><img src="https://habrastorage.org/webt/6q/xc/6f/6qxc6fkpk9i2jjpocy9v6iwgf0c.png"><br>  Figura 2 - Caracter√≠sticas de las tarjetas Mifare DESFire </p><br><h3 id="12-printery-kak-reshenie">  1.2.  Impresoras como soluci√≥n </h3><br><p>  Para realizar esta tarea, se utilizan impresoras de tarjetas especiales.  En este momento hay muchas compa√±√≠as diferentes que suministran estas impresoras.  Por ejemplo: Evolis, Smart, Zebra, Datacard, etc. Utilizamos las impresoras <strong>Evolis Primacy</strong> y <strong>Smart-51</strong> .  Estas impresoras tienen mucho en com√∫n en el coraz√≥n del trabajo: ambas usan cartuchos de cinta para imprimir y tienen un principio de limpieza similar.  Tambi√©n hay diferencias: diferentes codificadores NFC.  Ambas impresoras se pueden complementar o reemplazar seg√∫n las necesidades del cliente. </p><br><p>  Los programadores para tarjetas NFC se basan en los est√°ndares ISO / IEC 14443A e ISO / IEC 7816-4 para DESFire, ISO / IEC 14443 Tipo A para Classic.  Sin embargo, dependiendo del fabricante, los programadores pueden aceptar comandos nativos de acuerdo con los est√°ndares o ajustar los comandos nativos en forma espec√≠fica para un programador en particular.  Nos enfrentamos con uno y el otro. </p><br><div class="scrollable-table"><table><thead><tr><th></th><th>  Evoluci√≥n primac√≠a </th><th>  Smart-51 </th></tr></thead><tbody><tr><td>  Imprimir </td><td>  La cinta se utiliza para imprimir (color o monocromo).  Se suministra un casete de cinta completo. </td><td>  La cinta se utiliza para imprimir (color o monocromo).  Solo se suministra cinta, un cartucho y viene con la propia impresora.  Se incluye un rodillo de limpieza con la cinta. </td></tr><tr><td>  Codificador </td><td>  Elyctis Encoder.  F√°cil de usar porque  admite la interacci√≥n con las bibliotecas predeterminadas de Windows para la comunicaci√≥n con tarjetas NFC, winscard. </td><td>  Codificador DUALi.  El soporte t√©cnico proporciona un SDK especial para trabajar con el codificador. </td></tr><tr><td>  Limpieza </td><td>  Para mantener la impresora en condiciones de funcionamiento, requiere una limpieza constante.  Hay dos tipos de limpieza: peri√≥dica (despu√©s de cada 1000 tarjetas) y extendida (despu√©s de 5000 tarjetas).  El cumplimiento del programa de limpieza es un requisito previo en el acuerdo de garant√≠a. </td><td>  Se requiere limpieza despu√©s de usar la cinta impresa.  Dependiendo del tipo de cinta y el tama√±o de la imagen para imprimir, se requerir√° limpieza despu√©s de 2-4 mil tarjetas. </td></tr><tr><td>  Vivienda </td><td>  La carcasa de pl√°stico permite que la impresora sea bastante ligera.  Se puede acceder f√°cilmente a los interiores porque las paredes de la impresora se abren por ambos lados. </td><td>  La carcasa met√°lica hace que la impresora sea confiable para la operaci√≥n.  Algunas entra√±as solo se pueden ver abriendo la cubierta superior. </td></tr><tr><td>  Software </td><td>  Viene con el software especial "Evolis Print Center" y CardPresso.  El primero es necesario para la configuraci√≥n de la impresora, equipado con varios ayudantes.  El segundo software le permite probar r√°pidamente las capacidades de la impresora para imprimir y codificar. </td><td>  No se requiere un software separado para controlar la impresora.  Suficientes propiedades de impresora en la lista de dispositivos Windows.  Viene con el software SmartID para imprimir y codificar. </td></tr></tbody></table></div><br>  Tabla 1 - Comparaci√≥n de Evolis Primacy y Smart-51 <br><h3 id="2-eksperimenty">  2. Experimentos </h3><br><p>  En general, el trabajo con impresoras se puede dividir en varias partes: comunicaci√≥n con soporte t√©cnico, estudio de la interacci√≥n de tarjetas y codificadores, impresi√≥n. </p><br><h3 id="21-vpechatlenie-ot-tehnicheskoy-podderzhki">  2.1.  Impresi√≥n de soporte t√©cnico. </h3><br><p>  El trabajo con impresoras inclu√≠a comunicaci√≥n constante con soporte t√©cnico, ya que necesit√°bamos escribir nuestro propio software.  En ambos casos, hablamos m√°s con distribuidores de empresas en nuestro pa√≠s y pa√≠ses vecinos. </p><br><p>  Los distribuidores de Evolis siempre han estado siempre en contacto.  Sin embargo, casi de inmediato los detalles de los problemas mostraron la necesidad de comunicarse con los representantes de Evolis.  Desafortunadamente, no nos dieron sus contactos y tuvieron que intercambiar mensajes a trav√©s de un distribuidor.  Sin embargo, esto solo se refer√≠a a problemas de impresi√≥n; en cuestiones de codificaci√≥n, nos dieron el correo de un representante de Elyctis.  La comunicaci√≥n directa con Elyctis simplific√≥ enormemente el proceso de codificaci√≥n.  Puramente t√©cnicamente, nos entendimos de inmediato y no hubo malentendidos.  En el caso de los ejemplos de impresi√≥n y c√≥digo para Evolis Primacy, la comunicaci√≥n en alg√∫n momento se detuvo.  B√°sicamente, la impresi√≥n negativa fue causada por los momentos en que los ejemplos de impresi√≥n a doble cara no funcionaron para nosotros y tom√≥ mucho tiempo probarlo.  Llegu√© a las grabaciones de los procesos de impresi√≥n en video, despu√©s de lo cual siguieron consejos m√°s productivos de Evolis. </p><br><p>  Una de las √∫ltimas preguntas de soporte t√©cnico de Evolis fue c√≥mo conectar la impresora a trav√©s de Ethernet.  En este momento, estamos conectando la impresora a trav√©s de USB a la computadora port√°til, lo cual es tolerable en presencia de 1-2 impresoras.  Las respuestas a√∫n est√°n esperando.  Sin embargo, Elyctis ya recibi√≥ una respuesta de que su codificador para la impresora Evolis Primacy no proporciona una conexi√≥n de red. </p><br><p>  La comunicaci√≥n con el soporte t√©cnico de Smart-51 tambi√©n se redujo a comunicarse con los representantes de la compa√±√≠a a trav√©s de un distribuidor.  Al principio, todo sali√≥ bien.  Cuando se trataba de codificar tarjetas como Mifare DESFire, comenzaron los problemas.  Las dificultades fueron causadas por equipos espec√≠ficos que no encontrar√°s en Internet.  Por esta raz√≥n, solo ten√≠a que copiar algunas partes del c√≥digo de trabajo proporcionado por el fabricante como ejemplo.  Sin embargo, la copia irreflexiva no conduce al bien.  Como resultado, pasaron dos semanas explicando el error al fabricante, en cuyo lado el hombre estaba sentado claramente, no muy cerca de las complejidades del sistema, pero con documentaci√≥n general con √©l.  Qued√≥ un precipitado desagradable, pero comenz√≥ muy bien. </p><br><p>  La comunicaci√≥n a trav√©s de un distribuidor no tiene ventajas, desventajas s√≥lidas.  Por ejemplo: </p><br><ol><li>  Retraso en las respuestas, porque la persona responsable del lado del distribuidor puede estar ocupada con otras cosas o irse de vacaciones. </li><li>  Cuando el distribuidor se encuentra en otro pa√≠s, estos son d√≠as festivos adicionales, por lo tanto, no son d√≠as h√°biles.  En el caso de Smart-51, la comunicaci√≥n se realiz√≥ con la participaci√≥n de personas de 3 pa√≠ses. </li><li>  Las respuestas no se reenv√≠an.  El texto de respuesta se inserta en una nueva carta del distribuidor.  Por esta raz√≥n, a veces los archivos adjuntos se pierden y no llegan de inmediato. </li><li>  No hay una certeza clara de que su mensaje haya llegado al fabricante sin cambios. </li></ol><br><p>  A continuaci√≥n se muestra una tabla con el n√∫mero de letras que conformaron la comunicaci√≥n con el soporte t√©cnico.  B√°sicamente, las preguntas para Evolis y Smart eran casi las mismas.  Por ejemplo, "¬øPor qu√© la impresi√≥n no es un color uniforme? ¬øTiene ejemplos de c√≥digo en C # o Java?"  y preguntas m√°s espec√≠ficas sobre por qu√© algo no funciona como se esperaba. </p><br><div class="scrollable-table"><table><thead><tr><th></th><th>  Evolis </th><th>  Elyctis </th><th>  Smart-51 </th></tr></thead><tbody><tr><td>  Numero de letras </td><td>  97 </td><td>  37 </td><td>  61 </td></tr></tbody></table></div><br>  Tabla 2 - Comparaci√≥n de la cantidad de correos electr√≥nicos con soporte t√©cnico <br><h3 id="22-kodirovka">  2.2.  Codificaci√≥n </h3><br><p>  La comunicaci√≥n con el lector ocurre a trav√©s de comandos APDU.  APDU (Application Protocol Data Unit) es un formato est√°ndar para la comunicaci√≥n entre una tarjeta y un lector.  Este art√≠culo describir√° los equipos b√°sicos APDU para MIFARE Classic y MIFARE DESFire. </p><br><div class="scrollable-table"><table><thead><tr><th>  Titulo </th><th>  Tama√±o </th><th>  Descripci√≥n </th></tr></thead><tbody><tr><td>  CLA </td><td>  1 byte </td><td>  Bytes de clase </td></tr><tr><td>  Ins </td><td>  1 byte </td><td>  Byte de instrucciones </td></tr><tr><td>  P1 </td><td>  1 byte </td><td>  Par√°metro 1 </td></tr><tr><td>  P2 </td><td>  1 byte </td><td>  Par√°metro 2 </td></tr><tr><td>  Longitud de datos </td><td>  1 byte </td><td>  Tama√±o de datos transmitidos </td></tr><tr><td>  Datos </td><td>  ... </td><td>  Datos transmitidos </td></tr><tr><td>  Longitud de datos esperada </td><td>  1 byte </td><td>  El tama√±o de los datos esperados en la respuesta. </td></tr></tbody></table></div><br>  Tabla 3 - Formato de los comandos APDU <br><div class="scrollable-table"><table><thead><tr><th>  Titulo </th><th>  Tama√±o </th><th>  Descripci√≥n </th></tr></thead><tbody><tr><td>  SW1 </td><td>  1 byte </td><td>  C√≥digo de √©xito o error com√∫n </td></tr><tr><td>  SW2 </td><td>  1 byte </td><td>  C√≥digo de error detallado </td></tr><tr><td>  Datos </td><td>  ... </td><td>  Datos devueltos </td></tr></tbody></table></div><br>  Tabla 4 - Formato de respuesta APDU <br><p>  Puede encontrar una descripci√≥n de todos los c√≥digos de respuesta posibles aqu√≠ [6].  Puede encontrar un dispositivo para comunicar tarjetas con un lector en [7]. </p><br><p>  Un breve algoritmo de codificaci√≥n es el siguiente: </p><br><ol><li>  Obtenga el UID de la tarjeta.  Este es un n√∫mero √∫nico, es actualizado por el proveedor y no cambia. </li><li>  Leer datos de cada sector: <br>  2.1 Inicie sesi√≥n en el sector utilizando la clave predeterminada (0x00 o 0xFF) <br>  2.2 Leer datos de tres bloques de datos </li><li>  Si los datos le√≠dos est√°n vac√≠os, vaya al registro de datos <br>  3.1 Inicie sesi√≥n en el sector utilizando la clave predeterminada (0x00 o 0xFF) <br>  3.2 Escribir datos en bloques de datos de tres sectores <br>  3.3 Crear una nueva clave basada en el UID de la tarjeta <br>  3.4 Reemplace la clave de autorizaci√≥n en el bloque de remolque con una nueva clave. </li></ol><br><h3 id="221-elyctis">  2.2.1.  Elyctis </h3><br><p>  La impresora Evolis utiliza un <strong>lector ELYCTIS CL</strong> .  Usando la biblioteca <strong>WinSCard</strong> (C ++ y C #) y jnasmartcardio (java), puede interactuar f√°cilmente con el lector.  Para crear r√°pidamente software con una interfaz bastante simple, se decidi√≥ escribir c√≥digo en <strong>C #</strong> .  Principalmente, nuestro equipo escribe c√≥digo en Java, lo que hizo que la transici√≥n a C # fuera menos dolorosa.  Tambi√©n a favor de C # fue el hecho de que Windows es m√°s adecuado para trabajar con impresoras. </p><br><p>  La siguiente tabla muestra ejemplos de comandos APDU nativos que son aceptados por el lector Elyctis. </p><br><div class="scrollable-table"><table><thead><tr><th>  Descripci√≥n </th><th>  Datos </th><th>  APDU </th></tr></thead><tbody><tr><td>  Obtener una tarjeta UID </td><td>  - </td><td>  <strong>0xFF 0xCA 0x00 0x00 0x00</strong> </td></tr><tr><td>  Carga de clave de autorizaci√≥n en la memoria del lector </td><td>  Clave de 6 bytes </td><td>  Un ejemplo de carga de una clave predeterminada.  <strong>0xFF 0x82 0x20 0x00 0x06 0x00 0x00 0x00 0x00 0x00 0x00 0x00</strong> </td></tr><tr><td>  Iniciar sesi√≥n </td><td>  N√∫mero de bloque de autorizaci√≥n del sector (bloque del tercer sector) y tipo de clave (A - 0x60 o B - 0x61) </td><td>  Un ejemplo de autorizaci√≥n para el sector 1. Los n√∫meros de bloque de este sector son 4-7, el bloque de tr√°iler es el n√∫mero 7. <strong>0xFF 0x86 0x00 0x00 0X05 0x01 0x00 0x07 0X60 0x00 0x00</strong> </td></tr><tr><td>  Leer datos de un bloque </td><td>  - </td><td>  Un ejemplo de lectura de datos del bloque 4 (primer bloque del sector 1).  El n√∫mero de sector se ingresa en el par√°metro 2. 0xFF 0xB0 0x00 0x04 0x00 0x10 </td></tr><tr><td>  Escribir datos en el bloque </td><td>  16 bytes de datos </td><td>  Un ejemplo de escritura de datos en el bloque 4. <strong>0xFF 0xD6 0x00 0x04 0x10 0x11 0x22 0x33 0x44 0x55 0x66 0x77 0x88 0x11 0x22 0x33 0x44 0x55 0x66 0x77 0x88 0x00</strong> </td></tr></tbody></table></div><br>  Tabla 5 - Ejemplos de comandos APDU para Mifare Classic <br><p>  Despu√©s de asegurarnos de que la codificaci√≥n de tarjetas como Mifare Classic fue exitosa, cambiamos a <strong>comandos para DESFire</strong> .  Por referencia [8] puede encontrar ejemplos simples de comandos con explicaciones.  Sin embargo, ya en el equipo de autorizaci√≥n, nos encontramos con un comportamiento interesante del lector.  En resumen, el lector realiz√≥ la autorizaci√≥n completa.  Result√≥ que el soporte t√©cnico de Elyctis nos proporcion√≥ un firmware especial que inclu√≠a la <em>inteligencia easyDESFire</em> .  Solo es necesario determinar qu√© algoritmo de cifrado usa el lector.  En nuestro caso, fue 3DES. </p><br><p>  En casos normales, la autorizaci√≥n se lleva a cabo intercambiando varios mensajes. </p><br><ol><li>  Enviamos el comando APDU para autorizaci√≥n: <strong>0x90 0x0A 0x00 0x00 0x00 0x00</strong> . </li><li>  Dependiendo del algoritmo, una matriz de 8 bytes aleatorios codificados por la clave de la tarjeta viene en respuesta al comando; lo denotamos por <strong>RandBEnc</strong> . </li><li>  <strong>Desciframos RandBEnc</strong> y hacemos un cambio de byte a la izquierda.  Denota el resultado por <strong>RandBLeft</strong> . </li><li>  <strong>Generamos de</strong> nuestro lado una matriz de 8 bytes aleatorios, <strong>RandA</strong> . </li><li>  <strong>Agrupamos RandA</strong> y <strong>RandBLeft</strong> , encriptamos con la clave de la tarjeta y enviamos la matriz resultante de 16 bytes. </li><li>  En respuesta, obtenemos la clave de sesi√≥n, iniciando sesi√≥n en la aplicaci√≥n en el mapa. </li></ol><br><p>  Puede encontrar m√°s detalles sobre el proceso de autorizaci√≥n aqu√≠ [9].  El c√≥digo del github tambi√©n es muy √∫til [10]. </p><br><p>  Durante la codificaci√≥n, surgieron problemas con el uso de comandos de la fuente [8].  Con la ayuda del soporte t√©cnico de Elyctis, recibimos los comandos necesarios adecuados para la <em>inteligencia easyDESFire</em> . </p><br><p>  Durante la codificaci√≥n en Elyctis, se revel√≥ un gran <strong>problema del</strong> lector: el <strong>retraso de la comunicaci√≥n</strong> .  Muy a menudo, las se√±ales no llegan al lector, por lo que a veces es necesario enviar el mismo comando varias veces.  Este comportamiento es menos com√∫n, pero a√∫n se nota al enviar comandos para imprimir.  Como resultado, el env√≠o de todos los comandos se realiza en un bucle, hasta la ejecuci√≥n exitosa. </p><br><h3 id="222-duali">  2.2.2.  DUALi </h3><br><p>  El fabricante entrega su SDK para trabajar con un codificador DUALi.  En la etapa de trabajar con Mifare Classic, los comandos para leer y escribir podr√≠an tomarse del c√≥digo de plantilla que nos dieron los distribuidores.  Ejemplos fueron en C ++, Visual Basic, Java.  Sin embargo, fue posible compilar completamente el c√≥digo solo en C ++.  La primera solicitud para un ejemplo de c√≥digo C #, nos rechazaron, o m√°s bien, el distribuidor no tiene uno.  No hay programadores seguros de C ++ en nuestro equipo, por lo que escribir todo el c√≥digo fue muy complicado por cosas bastante simples.  Por ejemplo: </p><br><ol><li>  Trabajar con matrices <br>  Al pasar una matriz como par√°metro a una funci√≥n, no pasamos el tama√±o de la matriz.  Para determinar la longitud de la matriz, se utiliz√≥ la funci√≥n sizeOf ().  Sin embargo, la funci√≥n constantemente devolvi√≥ un tama√±o de 4, independientemente del tama√±o real de la matriz.  Este comportamiento no se registr√≥ de inmediato, ya que algunas matrices eran de tama√±o 4. </li><li>  Configurar todas las bibliotecas <br>  Se experiment√≥ mucho dolor al instalar todo el entorno necesario.  Estamos demasiado acostumbrados a cosas como maven y apt (en Ubuntu).  Se supon√≠a que nuestro programa llamar√≠a a la API de back-end a trav√©s de solicitudes HTTP y encriptar√≠a los datos en Base64.  Para esto, se decidi√≥ utilizar las bibliotecas libcurl y openssl.  La escritura del programa en s√≠ tuvo lugar en el entorno de Microsoft Visual Studio.  Mayor alboroto con la instalaci√≥n de libcurl. </li></ol><br><p>  El SDK en s√≠ es una biblioteca dll escrita en C ++.  Gracias al ejemplo de c√≥digo, escribimos relativamente r√°pido un programa para interactuar con la tarjeta Mifare Classic.  Como se mencion√≥ anteriormente, los comandos APDU para DUALi fueron muy espec√≠ficos, es decir, los dos primeros bytes no coincid√≠an con los que se pueden encontrar en Internet.  Debido a esto, tuve que copiarlos a ciegas, porque, en principio, todo funciona como se esperaba.  Los problemas comienzan con las pruebas con tarjetas DESFire. </p><br><p>  El principio de los comandos APDU para <strong>DESFire</strong> en DUALi es al menos comprensible.  Hay dos bytes para <strong>{CLA, INS}</strong> , no cambian y, de hecho, dicen que el comando est√° destinado a tarjetas como DESFire.  Los par√°metros 1 y 2 tampoco cambian.  Los datos transmitidos ya contienen parte del comando DESFire nativo, es decir, los bytes <strong>{INS, Data}</strong> .  Durante aproximadamente una semana, no pudimos obtener las respuestas esperadas a comandos simples, por ejemplo, el comando "seleccionar aplicaci√≥n".  Al comienzo del c√≥digo, dejamos la ejecuci√≥n APDU del comando GetCardStatus, que no era un formato de comando para DESFire.  Sin embargo, ella trabaj√≥ y emiti√≥ tarjetas UID.  Al final result√≥ que, despu√©s de la ejecuci√≥n de GetCardStatus, los equipos DESFire dejaron de funcionar.  Esta omisi√≥n fue determinada por nuestras fuerzas, despu√©s de un di√°logo de una semana con el proveedor, que no condujo a nada. </p><br><p>  Despu√©s de un mes de operaci√≥n estable de nuestro programa, llegamos a la necesidad de reescribir el programa en C #.  La raz√≥n principal fue la configuraci√≥n de CI.  El programa C ++ se compil√≥ con Microsoft Visual Studio.  Todos nuestros servidores se ejecutan en Linux, por lo que no fue posible iniciar la ventana acoplable con Windows y el Visual Studio ToolKit necesario.  Por supuesto, podr√≠a crear una m√°quina virtual con Windows y a√∫n configurar todo para C ++, pero realmente no quer√≠a hacerlo.  Despu√©s de solicitar repetidamente un c√≥digo C # de muestra al fabricante, se nos proporcion√≥ un ejemplo.  Puede escribirlo usted mismo, seg√∫n las definiciones de m√©todo en el ejemplo de interfaz de C ++, pero result√≥ que no se describieron todas las funciones.  El ejemplo ayud√≥ mucho y al final reescribimos el programa en C # y configuramos CI. </p><br><h3 id="23-pechat">  2.3.  Imprimir </h3><br><p>  A primera vista, parece que la impresi√≥n no deber√≠a causar problemas, porque en primer lugar usamos impresoras de impresi√≥n.       ,    ,            . </p><br><p>       .       ,       ,   . </p><br><h3 id="231-pechat-na-evolis-primacy"> 2.3.1.   Evolis Primacy </h3><br><p>     JSON ,   HTTP .    Evolis Services Provider,          .      8 : </p><br><ol><li>      </li><li>   </li><li>   :  ,   ,  . . </li><li>    </li><li>     </li><li>    </li><li>   </li><li>    </li></ol><br><p>     -  4-6, . .               .      .         SDK,       .     . <br>      : </p><br><ol><li>   <br>       . </li><li>   <br>      . </li></ol><br><p>                    .          ,      .           .    ,   .          .         .      ,   ,         ,  3. </p><br><img src="https://habrastorage.org/webt/pa/4_/i8/pa4_i8xhdbhicczzxejgvzayzne.jpeg" alt="drawing" width="300"><br><p>  3 ‚Äî    </p><br><p>     3         . </p><br><p>             , . .    QR-.      ,        QR-  .     ,     ,  4  6 . </p><br><p>   , Evolis ,   Evolis Print Center,     ,    ,              .            . </p><br><h3 id="232-pechat-na-smart-51"> 2.3.2.   Smart-51 </h3><br><p>     ,     SmartID,     .      ,      Evolis.        : </p><br><ol><li>   ,        . </li><li>     ,     . </li></ol><br><p>          ,     .       Smart-51.   : </p><br><ol><li>      </li><li>    ,  . </li><li>   </li><li>   </li><li>    ,   QR- </li><li>   </li><li>   </li><li>    </li></ol><br><p>    ,     User Manuals .      ,         ,        . </p><br><h3 id="233-obschie-problemy-s-pechatyu"> 2.3.3.     </h3><br><p>    ,        .      ,      ,         .           .        .      ,    . </p><br><p>      Evolis Primacy    100 ,   0,76 .      ,  86 .   Smart-51    100 ,          .   ,      . </p><br><h3 id="3-rezultaty"> 3.  </h3><br><p>         .        .        .     17 .        . </p><br><div class="scrollable-table"><table><thead><tr><th>  </th><th>  ,  </th><th>  ,  </th><th>  Total </th></tr></thead><tbody><tr><td> Evolis Primacy </td><td> ‚âà 10 </td><td> ‚âà 10 </td><td> ‚âà 20 </td></tr><tr><td> Smart-51 </td><td> ‚âà 17 </td><td> ‚âà 6 </td><td> ‚âà 23 </td></tr></tbody></table></div><br><img src="https://habrastorage.org/webt/aa/tu/r2/aatur26peetmxaj2ynj4jxwxshm.jpeg" alt="drawing" width="400"><br><p> ) </p><br><img src="https://habrastorage.org/webt/ll/y1/ed/lly1edhu6n42rdbybxn4-gwvniu.jpeg" alt="drawing" width="400"><br><p> ) <br>  4 ‚Äî  :  ‚Äî  ,  ‚Äî   </p><br><h3 id="4-zaklyuchenie"> 4.  </h3><br><p>         NFC   -.      , ..      .   Smart-51   Evolis Primacy.    Evolis       ,     . Smart-51             .       Smart-51      Evolis.              ,   .  Evolis Primacy   ,     .      .  Smart-51    .   ,          . </p><br><p>       , ..         .              ,         . </p><br><h3 id="spisok-literatury">  Referencias </h3><br><ol><li> <a href="https://ironlogic.ru/il.nsf/htm/ru_z2usb">https://ironlogic.ru/il.nsf/htm/ru_z2usb</a> </li><li> <a href="https://www.nxp.com/products/rfid-nfc/mifare-hf/mifare-desfire/mifare-desfire-ev2:MIFARE_DESFIRE_EV2_2K_8K">https://www.nxp.com/products/rfid-nfc/mifare-hf/mifare-desfire/mifare-desfire-ev2:MIFARE_DESFIRE_EV2_2K_8K</a> </li><li> <a href="https://www.nxp.com/docs/en/data-sheet/MF3DX2_MF3DHX2_SDS.pdf">https://www.nxp.com/docs/en/data-sheet/MF3DX2_MF3DHX2_SDS.pdf</a> </li><li> <a href="https://www.nxp.com/docs/en/data-sheet/MF1S50YYX_V1.pdf">https://www.nxp.com/docs/en/data-sheet/MF1S50YYX_V1.pdf</a> </li><li> <a href="https://www.nxp.com/docs/en/data-sheet/MF3DX2_MF3DHX2_SDS.pdf">https://www.nxp.com/docs/en/data-sheet/MF3DX2_MF3DHX2_SDS.pdf</a> </li><li> <a href="https://www.eftlab.com/knowledge-base/complete-list-of-apdu-responses/">https://www.eftlab.com/knowledge-base/complete-list-of-apdu-responses/</a> </li><li> Advanced Card Systems Guide <a href="http://downloads.acs.com.hk/drivers/en/API-ACR122U-2.02.pdf">http://downloads.acs.com.hk/drivers/en/API-ACR122U-2.02.pdf</a> </li><li> Mifare Desfire communication example <a href="https://ridrix.wordpress.com/2009/09/19/mifare-desfire-communication-example/">https://ridrix.wordpress.com/2009/09/19/mifare-desfire-communication-example/</a> </li><li> Mifare DESFire Data Sheet <a href="http://neteril.org/files/M075031_desfire.pdf">http://neteril.org/files/M075031_desfire.pdf</a> </li><li>   GitHub  DESFire <a href="">https://github.com/EsupPortail/esup-nfc-tag-server/blob/master/src/main/java/nfcjlib/core/DESFireEV1.java</a> </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/481734/">https://habr.com/ru/post/481734/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../479462/index.html">Serialization in C ++</a></li>
<li><a href="../479464/index.html">Pipes & Filters. Example application and implementation using Spring</a></li>
<li><a href="../479466/index.html">Habraiting 2019: statistics and ranking of the best articles for 2019</a></li>
<li><a href="../479468/index.html">Edge of Honesty and John Doe</a></li>
<li><a href="../479474/index.html">Why is self-organization of teams so important in Scrum and why there cannot be managers in it</a></li>
<li><a href="../481736/index.html">¬øSobre qu√© construir la infraestructura de Wi-Fi 6?</a></li>
<li><a href="../481738/index.html">Tareas de programaci√≥n: una mala forma de evaluar las calificaciones de desarrollador senior</a></li>
<li><a href="../481740/index.html">¬øLa luz azul perturba el biorritmo humano?</a></li>
<li><a href="../481742/index.html">Estrategia de Apple. Vinculaci√≥n del sistema operativo al hardware: ¬øventaja competitiva o desventaja?</a></li>
<li><a href="../481746/index.html">Configuraci√≥n del entorno en la CLI. Terminal WSL / Windows</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>