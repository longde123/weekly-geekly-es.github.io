<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üÖøÔ∏è üë©üèª‚Äçüöí ‚òùüèæ Fazendo uma pesquisa realmente inteligente: guia passo a passo üëÇüèº üëÖ üëÜüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pesquise no sistema de informa√ß√µes corporativas - j√° a partir dessa frase, ela fica presa na boca. √â bom que voc√™ tenha uma, nem precisa pensar em uma...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Fazendo uma pesquisa realmente inteligente: guia passo a passo</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/directum/blog/460263/"><p>  <em>Pesquise no sistema de informa√ß√µes corporativas</em> - j√° a partir dessa frase, ela fica presa na boca.  √â bom que voc√™ tenha uma, nem precisa pensar em uma experi√™ncia positiva do usu√°rio.  Como reverter a atitude dos usu√°rios estragados pelos mecanismos de pesquisa e criar um produto r√°pido, preciso e perfeitamente compreens√≠vel?  Precisamos pegar uma boa parte do Elasticsearch, um punhado de servi√ßos inteligentes e amass√°-los neste guia. </p><br><p>  Existem muitos artigos sobre como fixar a pesquisa de texto completo com base no Elasticsearch no banco de dados existente.  Mas claramente n√£o h√° artigos suficientes sobre como fazer uma pesquisa realmente inteligente. </p><br><blockquote>  Ao mesmo tempo, a frase "Pesquisa Inteligente" j√° se transformou em um chav√£o e √© usada para o local e n√£o.  Ent√£o, o que um mecanismo de pesquisa deve fazer para ser considerado inteligente?  Por fim, isso pode ser descrito como fornecendo o resultado que o usu√°rio realmente precisa, mesmo que esse resultado n√£o corresponda exatamente ao texto da solicita√ß√£o.  Mecanismos de pesquisa populares como Google e Yandex v√£o al√©m e n√£o apenas encontram as informa√ß√µes necess√°rias, mas respondem diretamente √†s perguntas dos usu√°rios. </blockquote><p>  Ok, n√£o tomaremos uma decis√£o de ultimato imediatamente, mas o que pode ser feito para aproximar uma pesquisa de texto completo <em>regular de</em> uma pesquisa <em>inteligente</em> ? </p><a name="habracut"></a><br><h2 id="elementy-intellektualnosti">  Elementos de intelig√™ncia </h2><br><p>  Pesquisa inteligente - este √© apenas o caso em que a quantidade pode ter qualidade e muitos recursos pequenos e bastante simples podem formar uma sensa√ß√£o de m√°gica. </p><br><ul><li>  Corre√ß√£o de erros do usu√°rio - se √© um erro de digita√ß√£o, um layout incorreto ou talvez uma solicita√ß√£o com um n√∫mero suspeito de resultados, mas semelhante a uma solicita√ß√£o para a qual h√° muito mais informa√ß√µes. </li><li>  Para <del>  th </del>  Bate-papos de PNL (processamento de linguagem natural, n√£o o que voc√™ pensou) - se o usu√°rio inseriu <em><strong>ofertas comerciais no √∫ltimo ano</strong></em> , ele realmente queria procurar essas palavras no texto de todos os documentos ou realmente precisava apenas de ofertas comerciais e somente no ano passado ? </li><li>  Preveja entrada com base em consultas anteriores ou documentos populares. </li><li> A apresenta√ß√£o do resultado √© o destaque usual do fragmento encontrado, informa√ß√µes adicionais dependendo do que voc√™ estava procurando.  Como as propostas comerciais eram necess√°rias no par√°grafo anterior, talvez fa√ßa sentido mostrar imediatamente o assunto da proposta e de qual organiza√ß√£o ela veio? </li><li>  Pesquisa detalhada - a capacidade de refinar a consulta de pesquisa usando filtros e facetas adicionais. </li></ul><br><h2 id="vvodnaya">  Introdut√≥rio </h2><br><p>  H√° um ECM DIRECTUM com muitos documentos.  O documento consiste em um cart√£o com meta-informa√ß√£o e um corpo, que pode ter v√°rias vers√µes. </p><br><p>  O objetivo √© procurar r√°pida e convenientemente informa√ß√µes nesses documentos da maneira usual para um usu√°rio de mecanismos de pesquisa. </p><br><h2 id="indeksirovanie">  Indexa√ß√£o </h2><br><blockquote>  Para procurar algo bem, voc√™ precisa index√°-lo bem primeiro. </blockquote><p>  Os documentos no ECM n√£o s√£o est√°ticos, os usu√°rios modificam o texto, criam novas vers√µes, alteram os dados nos cart√µes;  novos documentos s√£o constantemente criados e os antigos s√£o exclu√≠dos. <br>  Para manter as informa√ß√µes atualizadas no Elasticsearch, os documentos precisam ser constantemente reindexados.  Felizmente, o ECM j√° possui sua pr√≥pria fila de eventos ass√≠ncronos; portanto, quando voc√™ altera um documento, basta adicion√°-lo √† fila para indexa√ß√£o. </p><br><h3 id="otobrazhenie-dokumentov-ecm-na-dokumenty-elasticsearch">  Mapeando documentos ECM para documentos Elasticsearch </h3><br><p>  Um corpo do documento no ECM pode ter v√°rias vers√µes.  No Elasticsearch, isso pode ser pensado como uma matriz de objetos aninhados, mas torna-se inconveniente trabalhar com eles - fica mais dif√≠cil escrever consultas, ao alterar uma das vers√µes, voc√™ precisa reindexar tudo, vers√µes diferentes do mesmo documento n√£o podem ser armazenadas em √≠ndices diferentes (por que isso pode ser necess√°rio - na pr√≥xima se√ß√£o).  Portanto, desnormalizamos um documento do ECM em v√°rios documentos do Elasticsearch com o mesmo cart√£o, mas com corpos diferentes. </p><br><p>  Al√©m do cart√£o e do corpo, v√°rias informa√ß√µes de servi√ßo s√£o adicionadas ao documento Elasticsearch, que vale a pena mencionar separadamente: </p><br><ul><li>  uma lista de IDs de grupos e usu√°rios que t√™m direitos sobre o documento - para pesquisas com direitos; </li><li>  o n√∫mero de chamadas para o documento - para ajustar a relev√¢ncia; </li><li>  hora da √∫ltima indexa√ß√£o. </li></ul><br><h3 id="sostav-indeksov">  Composi√ß√£o do √çndice </h3><br><p>  Sim, √≠ndices plurais.  Geralmente, v√°rios √≠ndices para armazenar informa√ß√µes com significado semelhante no Elasticsearch s√£o usados ‚Äã‚Äãapenas se essas informa√ß√µes forem imut√°veis ‚Äã‚Äãe vinculadas a algum tipo de per√≠odo de tempo, por exemplo, logs.  Em seguida, os √≠ndices s√£o criados todos os meses / dia ou mais frequentemente, dependendo da intensidade da carga.  No nosso caso, qualquer documento pode ser alterado, e seria poss√≠vel armazenar tudo em um √≠ndice. </p><br><p>  Mas - os documentos no sistema podem estar em diferentes idiomas, e o armazenamento de dados multil√≠ngues no Elasticsearch traz 2 problemas: </p><br><ul><li>  Stemming errado.  Para algumas palavras, a base ser√° encontrada corretamente, para algumas - incorretamente (haver√° outra palavra no √≠ndice), para algumas - n√£o ser√° encontrada (o √≠ndice ficar√° entupido com as formas de palavras).  Para algumas palavras de idiomas diferentes e com significados diferentes, a base ser√° a mesma e, em seguida, o significado da palavra ser√° perdido.  O uso de v√°rias hastes consecutivas pode levar a um c√°lculo adicional da base para uma j√° calculada. </li></ul><br><blockquote>  Stamming - encontrar a base da palavra.  O caule n√£o precisa ser a raiz da palavra ou sua forma normal.  Geralmente, basta que as palavras relacionadas sejam projetadas em uma estrutura. <br>  A lematiza√ß√£o √© um tipo de deriva√ß√£o em que a forma normal (vocabul√°rio) de uma palavra √© considerada a base. </blockquote><br><ul><li>  Frequ√™ncia incorreta de palavras.  Alguns mecanismos de determina√ß√£o de relev√¢ncia no ES levam em considera√ß√£o a frequ√™ncia das palavras pesquisadas no documento (quanto mais frequentemente, maior a relev√¢ncia) e a frequ√™ncia das palavras pesquisadas no √≠ndice (quanto mais frequentemente, menor a relev√¢ncia).  Portanto, uma pequena dissemina√ß√£o da fala russa em um documento em ingl√™s, quando os documentos em ingl√™s estiverem predominantemente no √≠ndice, ter√° alto peso, mas vale a pena misturar os documentos em ingl√™s e russo no √≠ndice, e o peso diminuir√°. </li></ul><br><p>  O primeiro problema pode ser resolvido para o caso em que idiomas diferentes usam conjuntos de caracteres diferentes (documentos em russo-ingl√™s usam letras cir√≠licas e latinas) - os tradutores de idiomas processam apenas "seus" caracteres. </p><br><p>  Apenas para resolver o segundo problema, usamos a abordagem com um √≠ndice separado para cada idioma. </p><br><p>  Combinando as duas abordagens, obtemos √≠ndices de idiomas, que cont√™m analisadores para v√°rios idiomas que n√£o se cruzam em conjuntos de caracteres: russo-ingl√™s (e separadamente ingl√™s-russo), polon√™s-russo, alem√£o-russo, ucraniano-ingl√™s etc. . </p><br><p>  Para n√£o criar antecipadamente todos os √≠ndices poss√≠veis, usamos modelos de √≠ndice - o Elasticsearch permite especificar um modelo que cont√©m configura√ß√µes e mapeamentos e especificar um padr√£o de nome de √≠ndice.  Quando voc√™ tenta indexar um documento em um √≠ndice inexistente, cujo nome corresponde a um dos padr√µes do modelo, n√£o apenas um novo √≠ndice ser√° criado, mas as configura√ß√µes e os mapeamentos do modelo correspondente ser√£o aplicados a ele. </p><br><h3 id="struktura-indeksov">  Estrutura do √≠ndice </h3><br><p>  Para indexa√ß√£o, usamos dois analisadores de uma s√≥ vez (por v√°rios campos): padr√£o para pesquisar por frase exata e personalizado para todo o resto: </p><br><pre><code class="json hljs"><span class="hljs-string"><span class="hljs-string">"ru_en_analyzer"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"filter"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"lowercase"</span></span>, <span class="hljs-string"><span class="hljs-string">"russian_morphology"</span></span>, <span class="hljs-string"><span class="hljs-string">"english_morphology"</span></span>, <span class="hljs-string"><span class="hljs-string">"word_delimiter"</span></span>, <span class="hljs-string"><span class="hljs-string">"ru_en_stopwords"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"char_filter"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"yo_filter"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"custom"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tokenizer"</span></span>: <span class="hljs-string"><span class="hljs-string">"standard"</span></span>}</code> </pre> <br><p>  Com o filtro em min√∫sculas, tudo fica claro, vou falar sobre o resto. </p><br><p>  Os filtros russian_morphology e english_morphology destinam-se √† an√°lise morfol√≥gica do texto em russo e em ingl√™s, respectivamente.  Eles n√£o fazem parte do Elasticsearch e s√£o inclu√≠dos como parte de um plug-in de an√°lise-morfologia separado.  Estes s√£o lematizadores que usam a abordagem de vocabul√°rio em combina√ß√£o com algumas heur√≠sticas e funcionam significativamente MUITO, melhor do que os filtros internos para os idiomas correspondentes. </p><br><pre> <code class="json hljs">POST _analyze { <span class="hljs-attr"><span class="hljs-attr">"analyzer"</span></span>: <span class="hljs-string"><span class="hljs-string">"russian"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"text"</span></span>: <span class="hljs-string"><span class="hljs-string">"   "</span></span> } &gt;&gt;   </code> </pre> <br><p>  E: </p><br><pre> <code class="json hljs">POST _analyze { <span class="hljs-attr"><span class="hljs-attr">"analyzer"</span></span>: <span class="hljs-string"><span class="hljs-string">"ru_en_analyzer"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"text"</span></span>: <span class="hljs-string"><span class="hljs-string">"   "</span></span> } &gt;&gt;   </code> </pre> <br><p>  Filtro word_delimiter muito curioso.  Por exemplo, ajuda a eliminar erros de digita√ß√£o quando n√£o h√° espa√ßo ap√≥s o ponto.  Usamos a seguinte configura√ß√£o: </p><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"word_delimiter"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"catenate_all"</span></span>: <span class="hljs-string"><span class="hljs-string">"true"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"word_delimiter"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"preserve_original"</span></span>: <span class="hljs-string"><span class="hljs-string">"true"</span></span> }</code> </pre> <br><p>  O yo_filter permite ignorar a diferen√ßa entre E e E: </p><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"yo_filter"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"mapping"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"mappings"</span></span>: [ <span class="hljs-string"><span class="hljs-string">" =&gt; "</span></span>, <span class="hljs-string"><span class="hljs-string">" =&gt; "</span></span> ] }</code> </pre> <br><p>  tipo de filtro ru_en_stopwords stop - nosso dicion√°rio de palavras stop. </p><br><h3 id="process-indeksirovaniya">  Processo de indexa√ß√£o </h3><br><p>  Os corpos dos documentos no ECM s√£o, em regra, arquivos de formatos de escrit√≥rio: .docx, .pdf, etc.  Para extrair o texto, o plug-in de inser√ß√£o de anexo √© usado com o seguinte pipeline: </p><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"document_version"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"processors"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"attachment"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"field"</span></span>: <span class="hljs-string"><span class="hljs-string">"content"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"target_field"</span></span>: <span class="hljs-string"><span class="hljs-string">"attachment"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"properties"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"content"</span></span>, <span class="hljs-string"><span class="hljs-string">"content_length"</span></span>, <span class="hljs-string"><span class="hljs-string">"content_type"</span></span>, <span class="hljs-string"><span class="hljs-string">"language"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"indexed_chars"</span></span>: <span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ignore_failure"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> } }, { <span class="hljs-attr"><span class="hljs-attr">"remove"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"field"</span></span>: <span class="hljs-string"><span class="hljs-string">"content"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ignore_failure"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> } }, { <span class="hljs-attr"><span class="hljs-attr">"script"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"lang"</span></span>: <span class="hljs-string"><span class="hljs-string">"painless"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"params"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"languages"</span></span>: [<span class="hljs-string"><span class="hljs-string">"ru"</span></span>, <span class="hljs-string"><span class="hljs-string">"en"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"language_delimeter"</span></span>: <span class="hljs-string"><span class="hljs-string">"_"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"source"</span></span>: <span class="hljs-string"><span class="hljs-string">"..."</span></span> } }, { <span class="hljs-attr"><span class="hljs-attr">"remove"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"field"</span></span>: <span class="hljs-string"><span class="hljs-string">"attachment"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ignore_failure"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> } } ] } }</code> </pre> <br><p>  Do incomum no pipeline, ignorar erros da aus√™ncia do corpo (isso acontece para documentos criptografados) e determinar o √≠ndice de destino com base no idioma do texto.  O √∫ltimo √© feito em um roteiro indolor, cujo corpo darei separadamente, porque  devido a restri√ß√µes JSON, ele deve ser gravado em uma linha.  Juntamente com dificuldades de depura√ß√£o (a maneira recomendada √© lan√ßar exce√ß√µes aqui e ali), ela se torna completamente dolorosa. </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ctx.attachment != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">params</span></span>.languages.contains(ctx.attachment.language)) ctx._index = ctx._index + <span class="hljs-keyword"><span class="hljs-keyword">params</span></span>.language_delimeter + ctx.attachment.language; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ctx.attachment.content != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) ctx.content = ctx.attachment.content; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ctx.attachment.content_length != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) ctx.content_length = ctx.attachment.content_length; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ctx.attachment.content_type != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) ctx.content_type = ctx.attachment.content_type; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ctx.attachment.language != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) ctx.language = ctx.attachment.language; }</code> </pre> <br><p>  Assim, sempre enviamos o documento para <em>index_name</em> .  Se o idioma n√£o estiver definido ou n√£o for suportado, o documento ser√° estabelecido nesse √≠ndice, caso contr√°rio, ele se enquadra no <em>index_name_language</em> . </p><br><p>  N√£o armazenamos o corpo original do arquivo, mas o campo _source est√° ativado, porque  √© necess√°rio atualizar parcialmente o documento e destacar o encontrado. </p><br><p>  Se apenas o cart√£o foi alterado desde a √∫ltima indexa√ß√£o, usamos a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">API Atualizar por consulta</a> sem pipeline para atualiz√°-lo.  Isso permite, em primeiro lugar, n√£o extrair corpos de documentos potencialmente pesados ‚Äã‚Äãdo ECM e, em segundo lugar, acelera significativamente a atualiza√ß√£o no lado do Elasticsearch - voc√™ n√£o precisa extrair o texto dos documentos dos formatos de escrit√≥rio, o que consome muitos recursos. </p><br><blockquote>  Como tal, n√£o h√° nenhuma atualiza√ß√£o do documento no Elasticsearch, tecnicamente, ao atualizar a partir do √≠ndice, o documento antigo √© retirado, alterado e completamente indexado novamente. </blockquote><p>  Mas se o corpo foi alterado, o documento antigo geralmente √© exclu√≠do e indexado do zero.  Isso permite que os documentos sejam <em>movidos</em> de um √≠ndice de idioma para outro. </p><br><h2 id="poisk">  Pesquisar </h2><br><p>  Para facilitar a descri√ß√£o, darei uma captura de tela do resultado final </p><br><p><img src="https://habrastorage.org/webt/ni/l4/xm/nil4xm-qrg7meikrjbd16mt_ziq.png"></p><br><h3 id="polnotekst">  Texto completo </h3><br><p>  O principal tipo de consulta que temos √© a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Query Simple Query String Query</a> : </p><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"simple_query_string"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"fields"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"card.d*.*_text"</span></span>, <span class="hljs-string"><span class="hljs-string">"card.d*.*_text.exact"</span></span>, <span class="hljs-string"><span class="hljs-string">"card.name^2"</span></span>, <span class="hljs-string"><span class="hljs-string">"card.name.exact^2"</span></span>, <span class="hljs-string"><span class="hljs-string">"content"</span></span>, <span class="hljs-string"><span class="hljs-string">"content.exact"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"query"</span></span>: <span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"default_operator"</span></span>: <span class="hljs-string"><span class="hljs-string">"or"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"analyze_wildcard"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"minimum_should_match"</span></span>: <span class="hljs-string"><span class="hljs-string">"-35%"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"quote_field_suffix"</span></span>: <span class="hljs-string"><span class="hljs-string">".exact"</span></span> }</code> </pre> <br><p>  onde <em>.exact</em> s√£o os campos indexados pelo analisador <em>padr√£o</em> .  A import√¢ncia do nome do documento √© duas vezes maior que o restante dos campos.  A combina√ß√£o de <code>"default_operator": "or"</code> e <code>"minimum_should_match": "-35%"</code> permite encontrar documentos que n√£o cont√™m at√© 35% das palavras pesquisadas. </p><br><h3 id="sinonimy">  Sin√¥nimos </h3><br><p>  Em geral, diferentes analisadores s√£o usados ‚Äã‚Äãpara indexa√ß√£o e pesquisa, mas a √∫nica diferen√ßa neles √© a adi√ß√£o de um filtro para adicionar sin√¥nimos √† consulta de pesquisa: </p><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"search_analyzer"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"filter"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"lowercase"</span></span>, <span class="hljs-string"><span class="hljs-string">"russian_morphology"</span></span>, <span class="hljs-string"><span class="hljs-string">"english_morphology"</span></span>, <span class="hljs-string"><span class="hljs-string">"synonym_filter"</span></span>, <span class="hljs-string"><span class="hljs-string">"word_delimiter"</span></span>, <span class="hljs-string"><span class="hljs-string">"ru_en_stopwords"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"char_filter"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"yo_filter"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"tokenizer"</span></span>: <span class="hljs-string"><span class="hljs-string">"standard"</span></span> }</code> </pre> <br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"synonym_filter"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"synonym_graph"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"synonyms_path"</span></span>: <span class="hljs-string"><span class="hljs-string">"synonyms.txt"</span></span> }</code> </pre> <br><h3 id="uchyot-prav">  Direitos cont√°beis </h3><br><p>  Para pesquisas baseadas em direitos, a consulta principal √© incorporada na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Consulta Bool</a> , com a adi√ß√£o de um filtro: </p><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"bool"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"must"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"simple_query_string"</span></span>: {...} } ], <span class="hljs-attr"><span class="hljs-attr">"filter"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"terms"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"rights"</span></span>: [           ] } } ] }</code> </pre> <br><p>  Como lembramos da se√ß√£o sobre indexa√ß√£o, o √≠ndice possui um campo com o ID de usu√°rios e grupos que t√™m direitos sobre o documento.  Se houver uma interse√ß√£o desse campo com a matriz passada, haver√° direitos. </p><br><h3 id="tyuning-relevantnosti">  Ajuste de Relev√¢ncia </h3><br><p>  Por padr√£o, o Elasticsearch avalia a relev√¢ncia dos resultados usando o algoritmo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">BM25</a> usando a consulta e o texto do documento.  Decidimos que mais tr√™s fatores devem influenciar a avalia√ß√£o da conformidade com o resultado desejado e real: </p><br><ul><li>  a hora da √∫ltima edi√ß√£o do documento - quanto mais ele estava no passado, menos prov√°vel era a necessidade desse documento; </li><li>  o n√∫mero de chamadas para o documento - quanto mais, maior a probabilidade de que este documento seja necess√°rio; </li><li><p>  As vers√µes do corpo do ECM t√™m v√°rios estados poss√≠veis: sendo desenvolvidos, operacionais e obsoletos.  √â l√≥gico que a atua√ß√£o seja mais importante que as outras. </p><br><p>  Voc√™ pode obter esse efeito com a ajuda da <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">fun√ß√£o Score Query</a> : </p><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"function_score"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"functions"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"gauss"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"modified_date"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"origin"</span></span>: <span class="hljs-string"><span class="hljs-string">"now"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"scale"</span></span>: <span class="hljs-string"><span class="hljs-string">"1095d"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"offset"</span></span>: <span class="hljs-string"><span class="hljs-string">"31d"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"decay"</span></span>: <span class="hljs-number"><span class="hljs-number">0.5</span></span> } } }, { <span class="hljs-attr"><span class="hljs-attr">"field_value_factor"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"field"</span></span>: <span class="hljs-string"><span class="hljs-string">"access_count"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"missing"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"modifier"</span></span>: <span class="hljs-string"><span class="hljs-string">"log2p"</span></span> } }, { <span class="hljs-attr"><span class="hljs-attr">"filter"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"term"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"life_stage_value_id"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span> } } }, <span class="hljs-attr"><span class="hljs-attr">"weight"</span></span>: <span class="hljs-number"><span class="hljs-number">1.1</span></span> } ], <span class="hljs-attr"><span class="hljs-attr">"query"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"bool"</span></span>: {...} } }</code> </pre> <br><p>  Como resultado, ceteris paribus, obtemos aproximadamente a seguinte depend√™ncia do modificador de classifica√ß√£o de resultados na data de sua √∫ltima altera√ß√£o X e no n√∫mero de ocorr√™ncias Y: </p><br></li></ul><br><p></p><div style="text-align:center;"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img src="https://habrastorage.org/webt/wa/wz/td/wawztd9zvlz-fetkplnfrjw8ddy.png"></a> </div><p></p><br><h3 id="vneshniy-intellekt">  Intelig√™ncia externa </h3><br><p>  Para parte da funcionalidade da pesquisa inteligente, precisamos extrair v√°rios <em>fatos</em> da consulta de pesquisa: datas com sua aplica√ß√£o (cria√ß√£o, modifica√ß√£o, aprova√ß√£o etc.), nomes de organiza√ß√µes, tipos de documentos procurados etc. </p><br><p>  Tamb√©m √© desej√°vel classificar a solicita√ß√£o em uma determinada categoria, por exemplo, documentos por organiza√ß√£o, funcion√°rio, √≥rg√£o regulador etc. </p><br><p>  Essas duas opera√ß√µes s√£o executadas pelo M√≥dulo Inteligente ECM - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">DIRECTUM Ario</a> . </p><br><h3 id="process-umnogo-poiska">  Processo de pesquisa inteligente </h3><br><p>  √â hora de considerar mais detalhadamente quais mecanismos s√£o implementados elementos de intelig√™ncia. </p><br><h4 id="ispravlenie-oshibok-polzovatelya">  Corre√ß√£o de erro do usu√°rio </h4><br><p>  A corre√ß√£o do layout √© determinada com base no modelo de idioma do trigrama - para uma linha, √© calculado qual a probabilidade de atender √†s seq√º√™ncias de tr√™s caracteres em textos em ingl√™s e russo.  Se o layout atual for considerado menos prov√°vel, primeiro, uma dica com o layout correto ser√° exibida: </p><br><p><img src="https://habrastorage.org/webt/ek/ow/c5/ekowc5ikjiwx1xe87b5wewhoohm.png"></p><br><p>  e segundo, as etapas adicionais da pesquisa s√£o executadas com o layout correto: </p><br><p><img src="https://habrastorage.org/webt/ug/dr/tc/ugdrtchejvx024datttkc_zcxxw.png"></p><br><p>  E se nada puder ser encontrado com o layout corrigido, a pesquisa come√ßar√° com a linha original. </p><br><p>  A corre√ß√£o de erros de digita√ß√£o √© implementada usando o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Phrase Suggester</a> .  Existe um problema: se voc√™ executar uma consulta em v√°rios √≠ndices ao mesmo tempo, sugira que n√£o retorne nada, enquanto que, se voc√™ executar em apenas um √≠ndice, haver√° resultados.  Isso <em>√© tratado</em> definindo confian√ßa = 0, mas, em seguida, sugira sugerir a substitui√ß√£o de palavras por sua forma normal.  Concordo, ser√° estranho quando voc√™ procurar por "letra <strong>a</strong> " para obter uma resposta no esp√≠rito: <em>Talvez voc√™ estivesse procurando uma carta?</em> </p><br><p>  Isso pode ser contornado usando dois prompts na solicita√ß√£o: </p><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"suggest"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"content_suggest"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"text"</span></span>: <span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"phrase"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"collate"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"query"</span></span>: {         {{suggestion}} } }, } }, <span class="hljs-string"><span class="hljs-string">"check_suggest"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"text"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"phrase"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"collate"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"query"</span></span>: {         {{suggestion}} - ({{source_query}}) }, <span class="hljs-string"><span class="hljs-string">"params"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"source_query"</span></span>: <span class="hljs-string"><span class="hljs-string">" "</span></span> } }, } } }</code> </pre> <br><p>  Dos par√¢metros comuns usados </p><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"confidence"</span></span>: <span class="hljs-number"><span class="hljs-number">0.0</span></span>, <span class="hljs-string"><span class="hljs-string">"max_errors"</span></span>: <span class="hljs-number"><span class="hljs-number">3.0</span></span>, <span class="hljs-string"><span class="hljs-string">"size"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br><p>  Se o primeiro opinador retornou o resultado, mas o segundo n√£o, esse resultado √© a pr√≥pria string original, possivelmente com palavras de outras formas, e n√£o h√° necessidade de mostrar uma dica.  Se a dica ainda for necess√°ria, a frase de pesquisa original ser√° mesclada √† dica.  Isso acontece substituindo apenas as palavras corrigidas e somente aquelas que o corretor ortogr√°fico (usando Hunspell) considera incorretas. </p><br><p>  Se a pesquisa na cadeia de origem retornou 0 resultados, ela ser√° substitu√≠da pela cadeia obtida pela mesclagem e a pesquisa ser√° realizada novamente: </p><br><p><img src="https://habrastorage.org/webt/up/r3/wx/upr3wxky4mkbeyy3exjocbwzocy.png"></p><br><p>  Caso contr√°rio, a sequ√™ncia de prompt resultante ser√° retornada apenas como um prompt para a pesquisa: </p><br><p><img src="https://habrastorage.org/webt/qv/ts/4t/qvts4tauspo9yspwy_itbzcdttq.png"></p><br><h4 id="klassifikaciya-zaprosov-i-izvlechenie-faktov">  Classifica√ß√£o de consulta e extra√ß√£o de fatos </h4><br><p>  Como mencionei, usamos o DIRECTUM Ario, a saber, o servi√ßo de classifica√ß√£o de texto e o servi√ßo de extra√ß√£o de fatos.  Para fazer isso, fornecemos aos analistas consultas de pesquisa an√¥nimas e uma lista de fatos nos quais estamos interessados.  Com base em consultas e conhecimento sobre quais documentos est√£o no sistema, os analistas identificaram v√°rias categorias e treinaram o servi√ßo de classifica√ß√£o para determinar a categoria de acordo com o texto da consulta.  Com base nas categorias resultantes e na lista de fatos, formulamos as regras para o uso desses fatos.  Por exemplo, a frase <em><strong>do √∫ltimo ano</strong></em> na categoria <strong>Todos</strong> √© considerada a data de cria√ß√£o do documento e na categoria <strong>Por organiza√ß√£o</strong> - a data do registro.  Ao mesmo tempo, os <em><strong>criados no ano passado</strong></em> devem, em qualquer categoria, cair na data de cria√ß√£o. </p><br><p>  Do lado da pesquisa - eles fizeram uma configura√ß√£o na qual registraram as categorias, quais fatos s√£o aplicados a quais filtros de faceta. </p><br><h4 id="avtodopolnenie-vvoda">  Conclus√£o da entrada </h4><br><p>  Al√©m das corre√ß√µes de layout j√° mencionadas, pesquisas anteriores do usu√°rio e documentos p√∫blicos caem no preenchimento autom√°tico. </p><br><p><img src="https://habrastorage.org/webt/zc/52/yo/zc52yohihrkkrnny6ekla80-mro.png"></p><br><p>  Eles s√£o implementados usando outro tipo de Sugeridor - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Sugeridor de conclus√£o</a> , mas cada um tem suas pr√≥prias nuances. </p><br><h5 id="avtodopolnenie-istoriya-poiskov">  Preenchimento autom√°tico: hist√≥rico de pesquisa </h5><br><p>  Existem muito menos usu√°rios no ECM que os mecanismos de pesquisa e alocam consultas comuns suficientes para eles <del>  por que lenin cogumelo </del>  n√£o √© poss√≠vel.  Mostrar tudo em uma linha tamb√©m n√£o vale a pena devido a considera√ß√µes de privacidade.  O Sugestor de Conclus√£o usual pode pesquisar apenas o conjunto inteiro de documentos no √≠ndice, mas o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Context Suggester</a> vem em socorro - uma maneira de definir um contexto para cada dica e filtrar por esses contextos.  Se os nomes de usu√°rio forem usados ‚Äã‚Äãcomo contextos, apenas a hist√≥ria dele poder√° ser mostrada a todos. </p><br><p>  Voc√™ tamb√©m precisa dar ao usu√°rio a oportunidade de remover o prompt pelo qual ele tem vergonha.  Como chave para exclus√£o, usamos o nome do usu√°rio e o texto da dica de ferramenta.  Como resultado, para o √≠ndice com dicas, obtivemos um mapeamento t√£o duplicado: </p><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"mappings"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"document"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"properties"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"input"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"keyword"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"suggest"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"completion"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"analyzer"</span></span>: <span class="hljs-string"><span class="hljs-string">"simple"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"preserve_separators"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"preserve_position_increments"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_input_length"</span></span>: <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-attr"><span class="hljs-attr">"contexts"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"user"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"CATEGORY"</span></span> } ] }, <span class="hljs-attr"><span class="hljs-attr">"user"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"keyword"</span></span> } } } }</code> </pre> <br><p>  O peso de cada nova dica √© definido como um e aumenta cada vez que voc√™ a digita novamente usando a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">API Atualizar por consulta</a> com um script <code>ctx._source.suggest.weight++</code> muito simples. </p><br><h5 id="avtodopolnenie-dokumenty">  Preenchimento autom√°tico: documentos </h5><br><p>  Mas pode haver muitos documentos e poss√≠veis combina√ß√µes de direitos.  Portanto, aqui, pelo contr√°rio, decidimos n√£o fazer a filtragem por direitos ao preencher automaticamente, mas apenas indexar documentos p√∫blicos.  Sim, e voc√™ n√£o precisa remover dicas individuais desse √≠ndice.  Parece que a implementa√ß√£o em tudo √© mais f√°cil do que a anterior, se n√£o por dois pontos: </p><br><p>  O primeiro - o Completion Suggester oferece suporte apenas √† pesquisa de prefixos, e os clientes adoram atribuir n√∫meros de itens a tudo, e algumas <code>.01.01   </code> ao digitar uma consulta.  Aqui, junto com o nome completo, voc√™ tamb√©m pode indexar n-gramas derivados: </p><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"extension"</span></span>: <span class="hljs-string"><span class="hljs-string">"pdf"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">".01.01   "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"suggest"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"input"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"weight"</span></span>: <span class="hljs-number"><span class="hljs-number">70</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"input"</span></span>: <span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"weight"</span></span>: <span class="hljs-number"><span class="hljs-number">80</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"input"</span></span>: <span class="hljs-string"><span class="hljs-string">"  "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"weight"</span></span>: <span class="hljs-number"><span class="hljs-number">90</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"input"</span></span>: <span class="hljs-string"><span class="hljs-string">".01.01   "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"weight"</span></span>: <span class="hljs-number"><span class="hljs-number">100</span></span> } ] }</code> </pre> <br><p>  Isso n√£o foi t√£o cr√≠tico com a hist√≥ria, mas o mesmo usu√°rio entra aproximadamente na mesma linha se ele procurar algo novamente.  <em>Provavelmente</em> . </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/bi/rc/dv/bircdvzu2hvcblxhrryvauzajf0.png"></div><br><p>  A segunda - por padr√£o, todas as dicas s√£o iguais, mas gostar√≠amos de torn√°-las mais iguais e de prefer√™ncia para que isso seja consistente com a classifica√ß√£o dos resultados da pesquisa.  Para fazer isso, repita aproximadamente as fun√ß√µes gauss e field_value_factor usadas na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Consulta de Pontua√ß√£o</a> da <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Fun√ß√£o</a> . </p><br><p>  Acontece que aqui est√° um pipeline: </p><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"dir_public_documents_pipeline"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"processors"</span></span>: [ ... { <span class="hljs-attr"><span class="hljs-attr">"set"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"field"</span></span>: <span class="hljs-string"><span class="hljs-string">"terms_array"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">"{{name}}"</span></span> } }, { <span class="hljs-attr"><span class="hljs-attr">"split"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"field"</span></span>: <span class="hljs-string"><span class="hljs-string">"terms_array"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"separator"</span></span>: <span class="hljs-string"><span class="hljs-string">"\\s+|$"</span></span> } }, { <span class="hljs-attr"><span class="hljs-attr">"script"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"source"</span></span>: <span class="hljs-string"><span class="hljs-string">"..."</span></span> } } ] } }</code> </pre> <br><p>  com o seguinte script: </p><br><pre> <code class="cs hljs">Date modified = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Date(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ctx.modified_date != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) modified = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SimpleDateFormat(<span class="hljs-string"><span class="hljs-string">'dd.MM.yyyy'</span></span>).parse(ctx.modified_date); <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> dayCount = (System.currentTimeMillis() - modified.getTime())/(<span class="hljs-number"><span class="hljs-number">1000</span></span>*<span class="hljs-number"><span class="hljs-number">60</span></span>*<span class="hljs-number"><span class="hljs-number">60</span></span>*<span class="hljs-number"><span class="hljs-number">24</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> score = Math.exp((<span class="hljs-number"><span class="hljs-number">-0.7</span></span>*Math.max(<span class="hljs-number"><span class="hljs-number">0</span></span>, dayCount - <span class="hljs-number"><span class="hljs-number">31</span></span>))/<span class="hljs-number"><span class="hljs-number">1095</span></span>) * Math.log10(ctx.access_count + <span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> count = ctx.terms_array.length; ctx.suggest = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList(); ctx.suggest.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>([ <span class="hljs-string"><span class="hljs-string">'input'</span></span>: ctx.terms_array[count - <span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-string"><span class="hljs-string">'weight'</span></span>: Math.round(score * (<span class="hljs-number"><span class="hljs-number">255</span></span> - count + <span class="hljs-number"><span class="hljs-number">1</span></span>)) ]); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = count - <span class="hljs-number"><span class="hljs-number">2</span></span>; i &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span> ; --i) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ctx.terms_array[i].trim() != <span class="hljs-string"><span class="hljs-string">""</span></span>) { ctx.suggest.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>([ <span class="hljs-string"><span class="hljs-string">"input"</span></span>: ctx.terms_array[i] + <span class="hljs-string"><span class="hljs-string">" "</span></span> + ctx.suggest[ctx.suggest.length - <span class="hljs-number"><span class="hljs-number">1</span></span>].input, <span class="hljs-string"><span class="hljs-string">"weight"</span></span>: Math.round(score * (<span class="hljs-number"><span class="hljs-number">255</span></span> - i))]); } } ctx.<span class="hljs-keyword"><span class="hljs-keyword">remove</span></span>(<span class="hljs-string"><span class="hljs-string">'terms_array'</span></span>); ctx.<span class="hljs-keyword"><span class="hljs-keyword">remove</span></span>(<span class="hljs-string"><span class="hljs-string">'access_count'</span></span>); ctx.<span class="hljs-keyword"><span class="hljs-keyword">remove</span></span>(<span class="hljs-string"><span class="hljs-string">'modified_date'</span></span>);</code> </pre> <br><p>  Por que se preocupar com um oleoduto indolor em vez de escrev√™-lo em um idioma mais conveniente?  Como agora, usando a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">API Reindex</a> , voc√™ pode <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">substituir</a> o conte√∫do dos √≠ndices de pesquisa em √≠ndices para obter dicas (especificando apenas os campos necess√°rios, √© claro) em apenas um comando. </p><br><p>  A composi√ß√£o dos documentos p√∫blicos realmente necess√°rios n√£o √© atualizada com frequ√™ncia, portanto esse comando pode ser deixado em um in√≠cio manual. </p><br><h3 id="otobrazhenie-rezultatov">  Exibir resultados </h3><br><h4 id="kategorii">  Categorias </h4><br><p>  A categoria determina quais facetas estar√£o dispon√≠veis e como ser√° o snippet.  Ele pode ser detectado automaticamente por <em>intelig√™ncia externa</em> ou selecionado manualmente acima da barra de pesquisa. </p><br><h4 id="fasety">  Facetas </h4><br><p>  As facetas s√£o uma coisa t√£o intuitiva para todos cujo comportamento, no entanto, √© descrito por regras muito triviais.  Aqui est√£o alguns deles: </p><br><ol><li><p>  Os valores das facetas dependem dos resultados da pesquisa, MAS os resultados da pesquisa dependem das facetas selecionadas.  Como evitar recurs√£o? </p><br></li><li><p>  A sele√ß√£o de valores em uma faceta n√£o afeta outros valores dessa faceta, mas afeta valores em outras facetas: </p><br></li></ol><br><p><img src="https://habrastorage.org/webt/60/ei/g6/60eig601ltskcwvcesh5zno8crc.png"></p><br><ol><li>  Os valores de faceta selecionados pelo usu√°rio n√£o devem desaparecer, mesmo se uma op√ß√£o em outra faceta os <em>aniquilar</em> para 0 ou eles n√£o estiverem mais no topo: </li></ol><br><p><img src="https://habrastorage.org/webt/mu/6u/e-/mu6ue-ybxh3sa9h6ymkj1idn_ti.png"></p><br><p>  Na elasticidade, as facetas s√£o realizadas atrav√©s do mecanismo de agrega√ß√£o, mas, para cumprir as regras descritas, essas agrega√ß√µes devem ser investidas uma na outra e filtradas uma pela outra. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/zd/jt/zu/zdjtzudyw9iei8x-tjarja-a5tm.jpeg"></div><br><p>  Considere os fragmentos de solicita√ß√£o respons√°veis ‚Äã‚Äãpor isso: </p><br><div class="spoiler">  <b class="spoiler_title">C√≥digo muito grande</b> <div class="spoiler_text"><pre> <code class="json hljs">{ ... <span class="hljs-attr"><span class="hljs-attr">"post_filter"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"bool"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"must"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"terms"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"card.author_value_id"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"1951063"</span></span> ] } }, { <span class="hljs-attr"><span class="hljs-attr">"terms"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"editor_value_id"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"2337706"</span></span>, <span class="hljs-string"><span class="hljs-string">"300643"</span></span> ] } } ] } }, <span class="hljs-attr"><span class="hljs-attr">"query"</span></span>: {...} <span class="hljs-string"><span class="hljs-string">"aggs"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"card.author_value_id"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"filter"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"terms"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"editor_value_id"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"2337706"</span></span>, <span class="hljs-string"><span class="hljs-string">"300643"</span></span> ] } }, <span class="hljs-attr"><span class="hljs-attr">"aggs"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"card.author_value_id"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"terms"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"field"</span></span>: <span class="hljs-string"><span class="hljs-string">"card.author_value_id"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"size"</span></span>: <span class="hljs-number"><span class="hljs-number">11</span></span>, <span class="hljs-attr"><span class="hljs-attr">"exclude"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"1951063"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"missing"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span> } }, <span class="hljs-attr"><span class="hljs-attr">"card.author_value_id_selected"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"terms"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"field"</span></span>: <span class="hljs-string"><span class="hljs-string">"card.author_value_id"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"size"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"include"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"1951063"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"missing"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span> } } } }, ... <span class="hljs-attr"><span class="hljs-attr">"editor_value_id"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"filter"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"terms"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"card.author_value_id"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"1951063"</span></span> ] } }, <span class="hljs-attr"><span class="hljs-attr">"aggs"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"editor_value_id"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"terms"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"field"</span></span>: <span class="hljs-string"><span class="hljs-string">"editor_value_id"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"size"</span></span>: <span class="hljs-number"><span class="hljs-number">11</span></span>, <span class="hljs-attr"><span class="hljs-attr">"exclude"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"2337706"</span></span>, <span class="hljs-string"><span class="hljs-string">"300643"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"missing"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span> } }, <span class="hljs-attr"><span class="hljs-attr">"editor_value_id_selected"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"terms"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"field"</span></span>: <span class="hljs-string"><span class="hljs-string">"editor_value_id"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"size"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-attr"><span class="hljs-attr">"include"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"2337706"</span></span>, <span class="hljs-string"><span class="hljs-string">"300643"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"missing"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span> } } } }, ... } }</code> </pre> </div></div><br><p>  O que h√° aqui que: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">post_filter</a> permite impor uma condi√ß√£o adicional aos resultados de uma consulta j√° conclu√≠da e n√£o afeta os resultados das agrega√ß√µes.  Essa mesma lacuna de recurs√£o.  Inclui todos os valores selecionados de todas as facetas. </li><li>  agrega√ß√µes de n√≠vel superior, no exemplo <em>card.author_value_id</em> e <em>editor_value_id</em> .  Cada um tem: <br><ul><li>  filtre pelos valores de todas as outras facetas, exceto a sua; </li><li>  agrega√ß√£o aninhada para valores de faceta selecionados - <em>prote√ß√£o contra aniquila√ß√£o</em> ; </li><li>  agrega√ß√£o aninhada para outros valores de faceta.  Mostramos os 10 principais e solicitamos os 11 principais - para determinar se o bot√£o <strong>Mostrar tudo ser√°</strong> exibido. </li></ul></li></ul><br><h4 id="snippety">  Snippets </h4><br><p>  Dependendo da categoria selecionada, o snippet pode parecer diferente, por exemplo, o mesmo documento ao pesquisar em uma categoria </p><br><p>  <strong>Todos</strong> : </p><br><p><img src="https://habrastorage.org/webt/ka/_b/ia/ka_biaaygfgbsk2msyfhu-bnkse.png"></p><br><p>  e <strong>funcion√°rios</strong> : </p><br><p><img src="https://habrastorage.org/webt/5i/po/k_/5ipok_qgkc9170ucyidespnnitc.png"></p><br><p>  Ou lembre-se, quer√≠amos ver o assunto de uma oferta comercial e de quem ela veio? </p><br><p><img src="https://habrastorage.org/webt/-i/7z/g7/-i7zg7dwh7kbs9e9_2yk3fnxc6k.png"></p><br><p>  Para n√£o arrastar o cart√£o inteiro do el√°stico (isso diminui a velocidade da pesquisa), a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">filtragem de origem √© usada</a> : </p><br><pre> <code class="json hljs">{ ... <span class="hljs-attr"><span class="hljs-attr">"_source"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"includes"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"id"</span></span>, <span class="hljs-string"><span class="hljs-string">"card.name"</span></span>, <span class="hljs-string"><span class="hljs-string">"card.card_type_value_id"</span></span>, <span class="hljs-string"><span class="hljs-string">"card.life_stage_value_id"</span></span>, <span class="hljs-string"><span class="hljs-string">"extension"</span></span>, ... ] }, <span class="hljs-attr"><span class="hljs-attr">"query"</span></span>: {...} ... }</code> </pre> <br><p>  Para destacar as palavras encontradas no texto do documento, o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Marcador Fast Vector</a> √© usado - como gerador dos trechos mais apropriados para textos grandes e para o nome - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Marcador unificado</a> - como o menos exigente em recursos e estrutura de √≠ndice: </p><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"highlight"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"pre_tags"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"&lt;strong&gt;"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"post_tags"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"&lt;/strong&gt;"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"encoder"</span></span>: <span class="hljs-string"><span class="hljs-string">"html"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"fields"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"card.name"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"number_of_fragments"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"content"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"fragment_size"</span></span>: <span class="hljs-number"><span class="hljs-number">300</span></span>, <span class="hljs-attr"><span class="hljs-attr">"number_of_fragments"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"fvh"</span></span> } } },</code> </pre> <br><p>  Nesse caso, o nome √© destacado por inteiro e, a partir do texto, temos at√© 3 fragmentos com 300 caracteres.  O texto retornado pelo marca-texto Fast Vector √© ainda compactado por um algoritmo improvisado para obter um estado de snippet minimizado. </p><br><h3 id="kollaps">  Reduzir </h3><br><p>  Historicamente, os usu√°rios desse ECM est√£o acostumados ao fato de que a pesquisa retorna <em>documentos para</em> eles, mas, na verdade, o Elasticsearch pesquisa entre <em>vers√µes de documentos</em> .  Pode acontecer que v√°rias vers√µes quase id√™nticas sejam encontradas na mesma consulta.  Isso ir√° confundir os resultados e confundir o usu√°rio.  Felizmente, esse comportamento pode ser evitado usando o mecanismo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Field Collapsing</a> - uma vers√£o leve de agrega√ß√µes que j√° funciona nos resultados finais (nesse caso, ele se parece com post_filter, <em>duas muletas s√£o um par</em> ).  O <em>recolhimento</em> resultar√° no mais relevante dos objetos <em>recolhidos</em> . </p><br><pre> <code class="json hljs">{ ... <span class="hljs-attr"><span class="hljs-attr">"query"</span></span>: {...} ... <span class="hljs-string"><span class="hljs-string">"collapse"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"field"</span></span>: <span class="hljs-string"><span class="hljs-string">"id"</span></span> } }</code> </pre> <br><p>  Infelizmente, o colapso tem v√°rios efeitos desagrad√°veis, por exemplo, v√°rias caracter√≠sticas num√©ricas do resultado da pesquisa continuam retornando como se n√£o houvesse colapso.  Ou seja, o n√∫mero de resultados, o n√∫mero de valores das facetas - todos estar√£o <em>levemente</em> incorretos, mas o usu√°rio geralmente n√£o percebe isso, assim como o leitor cansado, que provavelmente n√£o leu essa proposta antes. </p><br><p>  O fim </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt460263/">https://habr.com/ru/post/pt460263/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt460253/index.html">10 raz√µes para fazer sua habilidade para assistente de voz</a></li>
<li><a href="../pt460255/index.html">Backdoor no Node.js: por que, por que e como funciona</a></li>
<li><a href="../pt460257/index.html">Ol√° Mundo! Imers√£o profunda em terminais</a></li>
<li><a href="../pt460259/index.html">O que √© design de interface do usu√°rio e UX? O que √© comum e diferente?</a></li>
<li><a href="../pt460261/index.html">Amazon: 25 anos de sucesso no com√©rcio eletr√¥nico</a></li>
<li><a href="../pt460265/index.html">Criar um modelo de projeto do Xcode</a></li>
<li><a href="../pt460273/index.html">Autoriza√ß√£o no Apple Pay pelo menor</a></li>
<li><a href="../pt460275/index.html">Por que voc√™ n√£o precisa da solu√ß√£o perfeita</a></li>
<li><a href="../pt460279/index.html">Contrato de 10 bilh√µes: quem lidar√° com a nuvem para o Pent√°gono</a></li>
<li><a href="../pt460281/index.html">Como o UX Writer ajuda a melhorar o produto</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>