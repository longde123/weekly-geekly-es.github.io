<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üò° üë≠ üé¶ Serveur DHCP natif utilisant bash üõåüèº üõÇ ü•î</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="J'adore automatiser le processus et √©crire mes propres v√©los pour √©tudier tel ou tel mat√©riel. Mon nouvel objectif √©tait un serveur DHCP, qui √©mettra ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Serveur DHCP natif utilisant bash</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/435148/"><img src="https://habrastorage.org/webt/cy/g3/b8/cyg3b8lmcpgxrj7j7_1jbfkxfta.png" align="left">  J'adore automatiser le processus et √©crire mes propres v√©los pour √©tudier tel ou tel mat√©riel.  Mon nouvel objectif √©tait un serveur DHCP, qui √©mettra une adresse dans les petits r√©seaux afin que la configuration initiale de l'√©quipement puisse √™tre faite. <br><br>  Dans cet article, je vais parler un peu du protocole DHCP et de quelques subtilit√©s de bash. <br><a name="habracut"></a><br><br><br><h1>  R√©sultat final </h1><br>  Commen√ßons par la fin, pour que ce soit pourquoi nous nous battons. <br><br>  D√©monstration de travail: <br><br><img src="https://habrastorage.org/webt/co/za/6j/coza6jzioblfbafujqfcanrffco.gif"><br><br>  R√©f√©rentiel avec script: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">firemoon777 / bash-dhcp-server</a> <br><br><h1>  Probl√®me initial </h1><br>  La configuration dont j'ai besoin se fait de cette fa√ßon: nous nous connectons directement via une paire torsad√©e √† l'√©quipement, √©mettons une adresse temporaire via DHCP et la configurons avec un script d√©j√† cr√©√©.  Et donc dix √† vingt fois de suite. <br><br>  Pour beaucoup, le serveur isc-dhcp bien connu fait parfaitement son travail, mais, h√©las, il n'informe pas mon script que l'adresse est √©mise, vous devez donc en quelque sorte bloquer l'ex√©cution jusqu'√† ce que l'adresse soit √©mise. <br><br>  La solution, semble-t-il, est en surface: cingler jusqu'√† ce que le visage soit bleu, jusqu'√† ce que l'√©quipement r√©ponde: <br><br><pre><code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ! ping -c1 -W1 <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$DHCP</span></span></span><span class="hljs-string">"</span></span> | grep -q <span class="hljs-string"><span class="hljs-string">"time="</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"Waiting for </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$DHCP</span></span></span><span class="hljs-string">..."</span></span> <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre> <br>  Mais cette d√©cision manque d√©finitivement d'aventurisme. <br><br><h1>  Partie th√©orique </h1><br><h3>  Obtention d'une adresse avec un seul serveur DHCP </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/1t/5q/u9/1t5qu9ltl-tjqlkmc7egjfgjvpe.png"></div><br>  Le protocole DHCP fonctionne sur UDP sur les ports 67 et 68. Le serveur ne fonctionne toujours qu'√† 67, et le client uniquement √† 68. Comme le client n'a pas d'adresse (a l'adresse 0.0.0.0), les paquets DHCP sont diffus√©s.  C'est-√†-dire  le client envoie toujours des paquets √† l'adresse 255.255.255.255:67 √† partir de l'adresse 0.0.0.0:68 et le serveur envoie de son adresse: 67 √† l'adresse 255.255.255.255:68. <br><br>  Le client <b>re√ßoit l'</b> adresse en quatre paquets ( <b>DORA</b> ): <br><br><ol><li>  Le client d√©couvre o√π se trouve le serveur DHCP ( <b>D</b> iscover) </li><li>  Le serveur r√©pond et propose son adresse (offre) </li><li>  Le client demande l'adresse propos√©e √† un serveur sp√©cifique ( <b>R</b> equest) </li><li>  Le serveur accepte et d√©livre l'adresse ( <b>A</b> ck) </li></ol><br>  Visuellement, le sch√©ma peut √™tre repr√©sent√© comme suit: <br><br><img src="https://habrastorage.org/webt/j5/ug/zy/j5ugzyefd8qvd-wrcsjtdahmnbs.png"><br><br><h3>  Obtention d'une adresse avec plusieurs serveurs DHCP </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/28/uo/fc/28uofcx-gthwmwhs8sgz0jrdysk.png"></div><br>  Lorsque le client envoie Discover, tous les serveurs qui peuvent entendre envoient leur offre au client.  Mais le client doit en choisir un.  La s√©lection du client est annonc√©e dans le message de demande avec l'option 54 (serveur DHCP), qui contient l'adresse IP du serveur DHCP pr√©f√©r√©.  Bien que la demande soit √©galement envoy√©e √† tous les utilisateurs du r√©seau, seul le serveur DHCP dont l'adresse IP est sp√©cifi√©e dans l'option 54 r√©pondra. <br><br><img src="https://habrastorage.org/webt/ke/xi/rv/kexirvjfnljlm3pdhcpfqglh02a.png"><br><br><h3>  Contenu du paquet DHCP </h3><br>  Un paquet DHCP se compose de deux parties: une constante de 236 octets et une variable qui contient des options (option DHCP). <br><br><div class="spoiler">  <b class="spoiler_title">Tableau avec tous les champs du paquet DHCP de Wikipedia</b> <div class="spoiler_text"><table><tbody><tr><th>  Le terrain </th><th>  La description </th><th>  Longueur (en octets) </th></tr><tr><td>  <b>op</b> <br></td><td>  Type de message.  Par exemple, il peut prendre des valeurs: BOOTREQUEST (0x01, demande du client au serveur) et BOOTREPLY (0x02, r√©ponse du serveur au client). <br></td><td>  1 <br></td></tr><tr><td>  <b>htype</b> <br></td><td>  Type d'adresse mat√©rielle.  Les valeurs valides pour ce champ sont d√©finies dans RFC 1700 Assigned Numbers.  Par exemple, pour une adresse MAC Ethernet, ce champ est d√©fini sur 0x01. <br></td><td>  1 <br></td></tr><tr><td>  <b>hlen</b> <br></td><td>  La longueur de l'adresse mat√©rielle en octets.  L'adresse MAC Ethernet est 0x06. <br></td><td>  1 <br></td></tr><tr><td>  <b>le houblon</b> <br></td><td>  Nombre de routeurs interm√©diaires (appel√©s <i>agents relais DHCP</i> ) par lesquels le message est pass√©.  Le client d√©finit ce champ sur 0x00. <br></td><td>  1 <br></td></tr><tr><td>  <b>xid</b> <br></td><td>  Un identifiant de transaction unique de 4 octets g√©n√©r√© par le client au d√©but du processus d'obtention de l'adresse. <br></td><td>  4 <br></td></tr><tr><td>  <b>secondes</b> <br></td><td>  Temps en secondes depuis le d√©but du processus d'obtention de l'adresse.  Ne peut pas √™tre utilis√© (dans ce cas, il est d√©fini sur 0x0000). <br></td><td>  2 <br></td></tr><tr><td>  <b>drapeaux</b> <br></td><td>  Le champ pour les indicateurs est des param√®tres sp√©ciaux du protocole DHCP. <br></td><td>  2 <br></td></tr><tr><td>  <b>ciaddr</b> <br></td><td>  Adresse IP du client.  Il est renseign√© uniquement si le client a d√©j√† sa propre adresse IP et est capable de r√©pondre aux requ√™tes ARP (cela est possible si le client effectue la proc√©dure de mise √† jour de l'adresse apr√®s l'expiration du bail). <br></td><td>  4 <br></td></tr><tr><td>  <b>yiaddr</b> <br></td><td>  La nouvelle adresse IP du client propos√©e par le serveur. <br></td><td>  4 <br></td></tr><tr><td>  <b>siaddr</b> <br></td><td>  Adresse IP du serveur.  Renvoy√© dans la clause DHCP (voir ci-dessous). <br></td><td>  4 <br></td></tr><tr><td>  <b>giaddr</b> <br></td><td>  L'adresse IP de l'agent de relais, si elle √©tait impliqu√©e dans le processus de remise du message DHCP au serveur. <br></td><td>  4 <br></td></tr><tr><td>  <b>chaddr</b> <br></td><td>  L'adresse mat√©rielle (g√©n√©ralement l'adresse MAC) du client. <br></td><td>  16 <br></td></tr><tr><td>  <b>ronfler</b> <br></td><td>  Nom de serveur facultatif sous forme de cha√Æne termin√©e par null. <br></td><td>  64 <br></td></tr><tr><td>  <b>fichier</b> <br></td><td>  Nom de fichier serveur facultatif utilis√© par les postes de travail sans disque lors du t√©l√©chargement √† distance.  Comme <b>sname</b> , il est repr√©sent√© comme une cha√Æne termin√©e par un caract√®re nul. <br></td><td>  128 <br></td></tr><tr><td>  <b>les options</b> <br></td><td>  Champ d' <i>options DHCP</i> .  Diverses options de configuration suppl√©mentaires sont indiqu√©es ici.  Au d√©but de ce champ, quatre octets sp√©ciaux de valeurs 99, 130, 83, 99 (¬´nombres magiques¬ª) sont indiqu√©s, permettant au serveur de d√©terminer la pr√©sence de ce champ.  Le champ a une longueur variable, mais le client DHCP doit √™tre pr√™t √† recevoir un message DHCP de 576 octets (dans ce message, le champ d' <b>options</b> fait 340 octets). <br></td><td>  variable <br></td></tr></tbody></table><br></div></div><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Liste de toutes les options DHCP dans RFC 2132</a> <br><br>  Les options DHCP sont cod√©es comme suit: <br><table><tbody><tr><td>  Num√©ro </td><td>  La longueur </td><td>  Les donn√©es </td></tr></tbody></table><br>  Par exemple, le param√®tre 3 (passerelle propos√©e) avec une valeur de 10.0.0.1: <br><table><tbody><tr><td>  3 </td><td>  4 </td><td>  10 </td><td>  0 </td><td>  0 </td><td>  1 </td></tr></tbody></table><br>  Si vous devez transmettre plusieurs param√®tres, la longueur du param√®tre augmente. <br>  Par exemple, dans le param√®tre 6 (serveur DNS), nous transmettrons deux adresses (1.1.1.1 et 8.8.4.4): <br><table><tbody><tr><td>  6 </td><td>  8 </td><td>  1 </td><td>  1 </td><td>  1 </td><td>  1 </td><td>  8 </td><td>  8 </td><td>  4 </td><td>  4 </td></tr></tbody></table><br>  Un signe de la fin du champ d'option est un param√®tre avec le nombre 255 (0xFF) et une longueur de 0. <br><br>  Le plus souvent, le client met le param√®tre 55 (une liste de param√®tres qu'il souhaite recevoir en r√©ponse) dans DHCP Discover, cependant, nous avons le droit de ne pas lui donner tout ce qu'il a demand√©. <br><br><h1>  Partie pratique </h1><br>  Il √©tait initialement pr√©vu d'√©crire le serveur dans un langage plus appropri√© (C) pour cela, cependant, ce serait banal et simple.  Il s'agit soit d'√©crire un script qui reprendra les fonctions du serveur DHCP. <br><br><h3>  Simplification </h3><br>  Le serveur en cours de d√©veloppement √©tant cens√© √™tre utilis√© dans des r√©seaux de deux n≈ìuds reli√©s par un patch, les simplifications suivantes ont √©t√© adopt√©es: <br><br><ul><li>  garanti qu'un client sur le r√©seau; </li><li>  il est garanti qu'il n'y a plus de serveurs DHCP sur le r√©seau </li><li>  l'initiateur d√©cide de l'adresse √† √©mettre </li><li>  La version DHCP et le d√©clin DHCP sont ignor√©s </li></ul><br><h3>  Auditeur </h3><br>  Tout d'abord, vous devez apprendre √† recevoir des paquets.  Cela n√©cessite un auditeur <strike>sympathique certifi√©</strike> , par exemple, nc.  Mais tous les nc ne conviennent pas √† ces fins.  OpenBSD netcat 1.130 de Debian convient, mais 1.105 avec Ubuntu a disparu.  Ex√©cutez nc pour √©couter tous les paquets UDP arrivant sur le port 67. <br><br><pre> <code class="bash hljs">nc -l 0.0.0.0 -up 67 -w0</code> </pre><br>  OpenBSD netcat est √©galement n√©cessaire en raison du commutateur -w avec une valeur de 0. Apr√®s avoir re√ßu un paquet (diffusion UDP), le nc traditionnel ne re√ßoit plus de paquets, mais il ne se termine pas. <br><br><h3>  Gestion des octets bruts </h3><br>  Dans le shell, il est tr√®s difficile de travailler avec des caract√®res non imprimables, comme un caract√®re nul: il l'ignore simplement.  Un paquet DHCP contient plusieurs octets 0x00 (par exemple, le champ de fichier).  La solution au probl√®me se pr√©sente sous la forme d'un vidage hexad√©cimal: <br><br><pre> <code class="bash hljs"> nc -l 0.0.0.0 -up 67 -w0 | stdbuf -o0 od -v -w1 -t x1 -An</code> </pre><br>  Un octet par ligne, sans sortir l'adresse, sans ignorer les octets en double.  Vous pouvez √©galement pimenter stdbuf -o0 afin que la sortie ne soit pas mise en m√©moire tampon. <br><br><h3>  R√©ception, stockage et traitement des colis </h3><br>  √Ä partir de la commande od stdout, les octets sont pris par la commande read et ajout√©s √† un tableau. <br><br><pre> <code class="bash hljs">msg=() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> {0..235}; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> -r tmp msg[<span class="hljs-variable"><span class="hljs-variable">$i</span></span>]=<span class="hljs-variable"><span class="hljs-variable">$tmp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre><br>  Bien que toutes les valeurs soient transmises en notation hexad√©cimale, le num√©ro d'option DHCP et la longueur de l'option sont mieux affich√©s √† l'√©cran / dans les journaux sous la forme d√©cimale habituelle.  Pour ce faire, vous pouvez utiliser une entr√©e bash'a courte: <br><br><pre> <code class="bash hljs">$ op=AC $ <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> $((16<span class="hljs-comment"><span class="hljs-comment">#$op)) 172</span></span></code> </pre><br>  Le paquet re√ßu est √©dit√© selon le type de demande (Discover ou Request) et renvoy√©. <br><br><h3>  R√©ponse </h3><br>  Cependant, l'envoi d'un colis n'est pas une t√¢che aussi simple.  Vous devez d'abord convertir les octets du vidage en octets bruts et envoyer tout en une fois avec un seul paquet. <br><br>  La conversion peut √™tre effectu√©e avec l'utilitaire printf √† l'aide de s√©quences d'√©chappement.  Et pour que rien ne soit perdu, √©crivez imm√©diatement des octets dans un fichier. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   &gt;/tmp/dhcp.payload #     for i in ${msg[*]}; do printf "\x$i" &gt;&gt; /tmp/dhcp.payload done</span></span></code> </pre><br>  OpenBSD netcat est √©galement utilis√© pour l'envoi.  Cependant, si la version 1.105 avec Ubuntu convient comme √©couteur, elle ne convient pas pour diffuser des messages UDP: nous obtenons l'erreur de protocole non disponible. <br><br><pre> <code class="bash hljs">cat /tmp/dhcp.payload | nc -ub 255.255.255.255 68 -s <span class="hljs-variable"><span class="hljs-variable">$SERVER</span></span> -p 67 -w0</code> </pre><br>  Le commutateur -b permet d'envoyer des messages de diffusion, et c'est la deuxi√®me raison pour laquelle le serveur doit √™tre ex√©cut√© sous le superutilisateur. <br><br><h1>  Quelles sont les limitations? </h1><br>  Ce serveur DHCP a √©t√© con√ßu avec des simplifications comme un seul client sur le r√©seau.  Cependant, cela fonctionnera avec plusieurs clients.  Obtenez simplement l'adresse la plus rapide. <br><br><img src="https://habrastorage.org/webt/yq/45/5f/yq455faeeblrxvyhtp9zeffiktg.png"><br><br><h1>  Conclusion </h1><br>  Bien que les scripts bash puissent difficilement √™tre appel√©s un langage de programmation √† part enti√®re, n√©anmoins, avec le d√©sir, vous pouvez m√™me r√©soudre des probl√®mes tels que l'√©mission d'une adresse IP sur le r√©seau sans utiliser de logiciel sp√©cialement con√ßu pour cela.  Et r√©soudre des probl√®mes sp√©cifiques apporte non seulement de la joie, mais aussi de nouvelles connaissances qui se sont ouvertes au moment de la solution. <br><br><h1>  Les sources </h1><br><ol><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">DHCP - Wikipedia</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Param√®tres DHCP et BOOTP - IANA</a> </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr435148/">https://habr.com/ru/post/fr435148/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr435134/index.html">Simplifiez l'utilisation des bases de donn√©es dans Qt avec QSqlRelationalTableModel</a></li>
<li><a href="../fr435136/index.html">Sergey et la m√©thode scientifique</a></li>
<li><a href="../fr435138/index.html">Comment prendre le contr√¥le de votre infrastructure r√©seau. Chapitre Trois S√©curit√© du r√©seau. Premi√®re partie</a></li>
<li><a href="../fr435142/index.html">Learning Trace Using eBPF: A Guide and Exemples</a></li>
<li><a href="../fr435144/index.html">Introduction √† Spring Boot: cr√©ation d'une API REST simple en Java</a></li>
<li><a href="../fr435150/index.html">Essais cliniques sur le pas de la porte - Entretien avec Aubrey de Gray</a></li>
<li><a href="../fr435152/index.html">Un diff√©rend sur les brevets entre Apple et Qualcomm a entra√Æn√© l'arr√™t des ventes d'iPhone 7 et 8 en Allemagne</a></li>
<li><a href="../fr435156/index.html">Besoin de plus d'appareils photo: Nokia 9 en a 5 imm√©diatement</a></li>
<li><a href="../fr435160/index.html">Internet des objets en russe. Param√®tres spectraux du signal radio</a></li>
<li><a href="../fr435164/index.html">Le Big Data et l'IA peuvent-ils r√©soudre la crise mondiale de l'eau?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>