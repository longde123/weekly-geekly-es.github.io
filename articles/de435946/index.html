<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üìÜ ü§ó üë∏ DIY W√§rmebildkamera auf Raspberry PI oder "Jetzt denke ich, ich wei√ü, was ich diesen Sommer tun werde" üé¶ üòè üë©üèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo allerseits! 

 Der Winter ist gekommen, und damit ist es die Aufgabe, die w√§rmeisolierenden Eigenschaften der Geb√§ude des Landsitzes der Datscha...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>DIY W√§rmebildkamera auf Raspberry PI oder "Jetzt denke ich, ich wei√ü, was ich diesen Sommer tun werde"</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/435946/"><img src="https://habrastorage.org/webt/ei/lx/7g/eilx7ge_qfo9qu0xnwi1wvhjajs.jpeg" alt="Bild"><br><br>  Hallo allerseits! <br><br>  Der Winter ist gekommen, und damit ist es die Aufgabe, die w√§rmeisolierenden Eigenschaften der <s>Geb√§ude des Landsitzes der</s> Datscha zu √ºberpr√ºfen.  Und dann stellte sich heraus, dass auf der bekannten chinesischen Website recht erschwingliche W√§rmebildmodule erschienen.  Ist es m√∂glich, eine exotische und m√∂glicherweise sogar n√ºtzliche Sache zusammenzustellen - eine hausgemachte W√§rmebildkamera?  Warum nicht, als ob Raspberry irgendwo gelegen h√§tte ... Was dabei herausgekommen ist - ich werde es dir unter dem Schnitt sagen. <br><a name="habracut"></a><br><h2>  MLX90640.  Was ist das? </h2><br>  Und dies ist in der Tat eine W√§rmebildmatrix mit einem Mikrocontroller an Bord.  Produktion der bisher unbekannten Firma Melexis.  Die W√§rmebildmatrix hat eine Abmessung von 32 x 24 Pixel.  Das ist nicht viel, aber wenn man das Bild interpoliert, scheint es genug zu sein, um zumindest etwas zu erkennen. <br><br><img src="https://habrastorage.org/webt/vg/dz/aj/vgdzajxguwnre-4onijasyukl8o.jpeg" alt="Bild"><br><br>  Der Sensor ist in zwei Versionen erh√§ltlich, deren Geh√§use sich im Betrachtungswinkel der Matrix unterscheiden.  Eine gedrungenere Struktur A √ºberblickt die Au√üenwelt in einem Winkel von 110 (horizontal) bei 75 (vertikal) Grad.  B - unter 55 um 37,5 Grad.  Das Ger√§tegeh√§use verf√ºgt nur √ºber vier Ausg√§nge - zwei f√ºr die Stromversorgung und zwei f√ºr die Kommunikation mit dem Steuerger√§t √ºber die I2C-Schnittstelle.  Interessierte Datenbl√§tter k√∂nnen hier heruntergeladen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">werden</a> . <br><br><h2>  Und was ist dann der GY-MCU90640? </h2><br>  Chinesische Kameraden haben den MLX90640 mit einem weiteren Mikrocontroller (STM32F103) an Bord gebracht.  Anscheinend zur einfacheren Matrixverwaltung.  Diese ganze Farm hei√üt GY-MCU90640.  Und es kostet zum Zeitpunkt der Akquisition (Ende Dezember 2018) in der Gr√∂√üenordnung von 5.000 Rubel.  Es sieht so aus: <br><br><img src="https://habrastorage.org/webt/jd/h9/w4/jdh9w4phuzdtcccd8gsgcd5_gjk.jpeg" alt="Bild"><br><br>  Wie Sie sehen k√∂nnen, gibt es zwei Arten von Platinen mit einer schmalen oder Weitwinkelversion des Sensors an Bord. <br><br>  Welche Version passt am besten zu Ihnen?  Eine gute Frage, leider hatte ich sie erst, nachdem das Modul bereits bestellt und erhalten wurde.  Aus irgendeinem Grund habe ich diese Nuancen zum Zeitpunkt der Bestellung nicht beachtet.  Aber vergebens. <br><br>  Eine breitere Version eignet sich f√ºr selbstfahrende Roboter oder f√ºr Sicherheitssysteme (das Sichtfeld wird gr√∂√üer).  Laut Datenblatt hat es auch weniger Rauschen und eine h√∂here Messgenauigkeit. <br><br><img src="https://habrastorage.org/webt/_r/f1/vw/_rf1vwk_urgqftzfjdsy9lucsxo.jpeg" alt="Bild"><br><br>  F√ºr Visualisierungsaufgaben w√ºrde ich jedoch eher eine Version mit gr√∂√üerer Reichweite von B empfehlen. Aus einem sehr wichtigen Grund.  Zuk√ºnftig kann es beim Aufnehmen bereitgestellt werden (manuell oder auf einer Plattform mit einem Laufwerk) und zusammengesetzte "Fotos" aufnehmen, wodurch die mehr als bescheidene Aufl√∂sung von 32 x 24 Pixel erh√∂ht wird.  Sammeln Sie beispielsweise W√§rmebilder mit einer Gr√∂√üe von 64 x 96 Pixel ... Okay, in Zukunft werden die Fotos aus der Weitwinkelversion A stammen. <br><br><h2>  Stellen Sie eine Verbindung zu Raspberry PI her </h2><br>  Es gibt zwei M√∂glichkeiten, das W√§rmebildmodul zu steuern: <br><br><ol><li>  K√ºrzen Sie den SET-Jumper auf der Platine und verwenden Sie I2C, um den internen Mikrocontroller MLX90640 direkt zu kontaktieren. </li><li>  Lassen Sie den Jumper in Ruhe und kommunizieren Sie mit dem Modul √ºber eine √§hnliche Schnittstelle, die √ºber RS-232 auf der STM32F103-Karte installiert ist. </li></ol><br>  Wenn Sie in C ++ schreiben, ist es wahrscheinlich bequemer, den zus√§tzlichen Mikrocontroller zu ignorieren, den Jumper kurzzuschlie√üen und die API des Herstellers zu verwenden, die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> liegt. <br><br>  Bescheidene Pythonisten k√∂nnen auch den ersten Weg gehen.  Es scheint, als g√§be es ein paar Python-Bibliotheken ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> ).  Aber leider hat kein einziger f√ºr mich gearbeitet. <br><br>  Fortgeschrittene Pythonisten k√∂nnen grunds√§tzlich einen Modulsteuerungstreiber in Python schreiben.  Die Vorgehensweise zum Abrufen eines Frames ist im Datenblatt ausf√ºhrlich beschrieben.  Aber dann m√ºssen Sie alle Kalibrierungsverfahren vorschreiben, was etwas l√§stig erscheint.  Deshalb musste ich den zweiten Weg gehen.  Es stellte sich als m√§√üig dornig heraus, aber ziemlich passabel. <br><br>  Dank der Einsicht chinesischer Ingenieure oder einfach nur eines gl√ºcklichen Zufalls stellte sich heraus, dass der Schal eine sehr gute Position f√ºr die Schlussfolgerungen hatte: <br><br><img src="https://habrastorage.org/webt/wr/t1/iu/wrt1iuw0xxqw0cze8sb0wg4bl54.jpeg" alt="Bild"><br><br>  Es bleibt nur der Block zu setzen und den Schal in den Himbeeranschluss einzuf√ºhren.  Auf der Platine ist ein 5- bis 3-Volt-Wandler installiert, sodass anscheinend nichts die empfindlichen Rx- und Tx-Ausg√§nge von Raspberry gef√§hrdet. <br><br>  Es sollte hinzugef√ºgt werden, dass die Verbindung gem√§√ü der ersten Option ebenfalls m√∂glich ist, jedoch mehr Arbeit und L√∂tf√§higkeiten erfordert.  Die Karte muss auf der anderen Seite des Himbeer-Anschlusses installiert sein (siehe Titelfoto dieses Beitrags). <br><br><h2>  Software </h2><br>  Auf einer bekannten chinesischen Website wird ein solches Wunder angeboten, um auf die GY-MCU90640 zuzugreifen: <br><br><img src="https://habrastorage.org/webt/ri/fo/pq/rifopqyhbfzldcrxujqgobydntm.jpeg" alt="Bild"><br><br>  H√∂chstwahrscheinlich sollte das Interaktionsprotokoll mit dem auf der Karte installierten Mikrocontroller beschrieben werden, nach dem dieses Softwareprodukt funktioniert!  Nach einem kurzen Gespr√§ch mit dem Verk√§ufer von Schals (in Bezug auf diese angesehenen Herren) wurde mir ein solches Protokoll zugesandt.  Es erschien im PDF und in reinem Chinesisch. <br><br>  Dank des Google-√úbersetzers und des aktiven Kopierens und Einf√ºgens wurde das Protokoll in etwa anderthalb Stunden entschl√ºsselt, und diejenigen, die dies w√ºnschen, k√∂nnen es auf <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Github kennenlernen</a> .  Es stellte sich heraus, dass der Schal sechs grundlegende Befehle versteht, unter denen sich eine Rahmenanforderung am COM-Port befindet. <br><br>  Jedes Pixel der Matrix ist tats√§chlich der Temperaturwert des Objekts, das dieses Pixel betrachtet.  Temperatur in Grad Celsius mal 100 (Doppelbytezahl).  Tats√§chlich gibt es sogar einen speziellen Modus, in dem der Schal 4 Mal pro Sekunde Frames von der Matrix an die Himbeere sendet. <br><br><div class="spoiler">  <b class="spoiler_title">Das Skript zum Erhalten von W√§rmebildern hier:</b> <div class="spoiler_text"><pre><code class="python">"""MIT License

Copyright (c) 2019 

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE."""

import serial, time
import datetime as dt
import numpy as np
import cv2

# function to get Emissivity from MCU
def get_emissivity():
	ser.write(serial.to_bytes([0xA5,0x55,0x01,0xFB]))
	read = ser.read(4)
	return read[2]/100

# function to get temperatures from MCU (Celsius degrees x 100)
def get_temp_array(d):

	# getting ambient temperature
	T_a = (int(d[1540]) + int(d[1541])*256)/100

	# getting raw array of pixels temperature
	raw_data = d[4:1540]
	T_array = np.frombuffer(raw_data, dtype=np.int16)
	
	return T_a, T_array

# function to convert temperatures to pixels on image
def td_to_image(f):
	norm = np.uint8((f/100 - Tmin)*255/(Tmax-Tmin))
	norm.shape = (24,32)
	return norm

########################### Main cycle #################################
# Color map range
Tmax = 40
Tmin = 20

print ('Configuring Serial port')
ser = serial.Serial ('/dev/serial0')
ser.baudrate = 115200

# set frequency of module to 4 Hz
ser.write(serial.to_bytes([0xA5,0x25,0x01,0xCB]))
time.sleep(0.1)

# Starting automatic data colection
ser.write(serial.to_bytes([0xA5,0x35,0x02,0xDC]))
t0 = time.time()

try:
	while True:
		# waiting for data frame
		data = ser.read(1544)
		
		# The data is ready, let's handle it!
		Ta, temp_array = get_temp_array(data)
		ta_img = td_to_image(temp_array)
		
		# Image processing
		img = cv2.applyColorMap(ta_img, cv2.COLORMAP_JET)
		img = cv2.resize(img, (320,240), interpolation = cv2.INTER_CUBIC)
		img = cv2.flip(img, 1)
		
		text = 'Tmin = {:+.1f} Tmax = {:+.1f} FPS = {:.2f}'.format(temp_array.min()/100, temp_array.max()/100, 1/(time.time() - t0))
		cv2.putText(img, text, (5, 15), cv2.FONT_HERSHEY_SIMPLEX, 0.45, (0, 0, 0), 1)
		cv2.imshow('Output', img)
		
		# if 's' is pressed - saving of picture
		key = cv2.waitKey(1) &amp; 0xFF
		if key == ord("s"):
			fname = 'pic_' + dt.datetime.now().strftime('%Y-%m-%d_%H-%M-%S') + '.jpg'
			cv2.imwrite(fname, img)
			print('Saving image ', fname)
		
		t0 = time.time()

except KeyboardInterrupt:
	# to terminate the cycle
	ser.write(serial.to_bytes([0xA5,0x35,0x01,0xDB]))
	ser.close()
	cv2.destroyAllWindows()
	print(' Stopped')

# just in case 
ser.close()
cv2.destroyAllWindows()</code></pre><br>
</div></div><br>
<h2></h2><br>
         ,    Raspberry PI, 4   .    ,        .      OpenCV.     ¬´s¬ª       ¬´ ¬ª   jpg. <br>
<br>
<img src="https://habrastorage.org/webt/6n/9o/gw/6n9ogwhkr1klkw_qvcaej45vqnw.jpeg" alt="image"><br>
<br>
          .     ,           .   ‚Äî     .     20  40 .      Ctrl + C.<br>
<br>
<img src="https://habrastorage.org/webt/ik/e9/cy/ike9cyyu4h3wbdde2tfubq6yhwu.jpeg" alt="image"><br>
<br>
      Raspberry Pi Zero W   Pi 3 B+.   VNC   .  ,    ,   powerbank'     VNC         . ,    ,   .<br>
<br>
       .          .<br>
<br>
, ,    .      .            , .   -        ,    .<br>
<br>
       !<br>
<br>
UPD:         .  . -   ,   ,     .        .   ‚Äî   .<br>
<br>
<img src="https://habrastorage.org/webt/-y/ww/kd/-ywwkdovoeqvolceev0zu--0bi4.jpeg" alt="image"><br>
<br>
     .  +20...+40  -10...+5.</div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de435946/">https://habr.com/ru/post/de435946/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de435936/index.html">Das russische Weltraumteleskop "Spectrum-R" gehorchte nicht mehr den Befehlen der Erde, der Start von "Spectra-RG" verz√∂gert sich</a></li>
<li><a href="../de435938/index.html">Top 3D Shop ist jetzt in Tscheljabinsk</a></li>
<li><a href="../de435940/index.html">Mehrere Hostversionen von PHP mit Docker</a></li>
<li><a href="../de435942/index.html">One Billion Queens Problem Solution oder "Untersuchung von Mustern in der Liste der L√∂sungen f√ºr das n-Queens-Verteilungsproblem"</a></li>
<li><a href="../de435944/index.html">Food Design Digest, Dezember 2018</a></li>
<li><a href="../de435948/index.html">MIT-Kurs "Computer Systems Security". Vorlesung 23: Sicherheits√∂konomie, Teil 3</a></li>
<li><a href="../de435950/index.html">Modulares Rechenzentrum im Dienste des Large Hadron Collider</a></li>
<li><a href="../de435952/index.html">Wer sind "ungewaschene Hoster"?</a></li>
<li><a href="../de435954/index.html">Entwicklung von Modulen f√ºr Puppen mit Puppenentwicklungskit</a></li>
<li><a href="../de435956/index.html">PHP Digest Nr. 147 (1. - 14. Januar 2019)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>