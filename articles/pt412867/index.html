<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üà∏ üßöüèø üî° Como compilar um arquivo COM do DOS pelo compilador GCC üöû ü§∑üèª üêøÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Artigo publicado em 9 de dezembro de 2014 
 Atualiza√ß√£o para 2018: Ren√©Rebe fez um v√≠deo interessante com base neste artigo ( parte 2 ) 

 No final de...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como compilar um arquivo COM do DOS pelo compilador GCC</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/412867/"> <font color="gray">Artigo publicado em 9 de dezembro de 2014</font> <br>  <i>Atualiza√ß√£o para 2018: Ren√©Rebe fez um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">v√≠deo interessante com</a> base neste artigo ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">parte 2</a> )</i> <br><br>  No final de semana passado, participei do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Ludum Dare # 31</a> .  Mas mesmo antes do an√∫ncio da confer√™ncia, por causa do meu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">hobby recente,</a> eu queria criar um jogo da velha escola no DOS.  A plataforma de destino √© o DOSBox.  Essa √© a maneira mais pr√°tica de executar aplicativos DOS, apesar de todos os processadores x86 modernos serem totalmente compat√≠veis com os antigos, at√© o 8086 de 16 bits. <br><br>  Criei e mostrei com sucesso o jogo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">DOS Defender</a> na confer√™ncia.  O programa funciona no modo real do 80386 de 32 bits. Todos os recursos est√£o embutidos no arquivo COM execut√°vel, sem depend√™ncias externas, portanto o jogo todo √© compactado em um bin√°rio de 10 kilobytes. <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://github.com/skeeto/dosdefender-ld31</a> </li><li>  <a href="">DOSDEF.COM</a> (10 KB, v1.1.0, funciona no DOSBox) </li></ul><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ay/na/qs/aynaqsaenvt32x5oa8y7z4fmnfy.gif"></div><a name="habracut"></a><br>  Voc√™ precisar√° de um joystick ou gamepad para jogar.  Inclu√≠ o suporte ao mouse no lan√ßamento do Ludum Dare por uma quest√£o de apresenta√ß√£o, mas o exclu√≠ porque n√£o funcionou muito bem. <br><br>  A parte mais tecnicamente interessante √© que <b><i>n√£o</i> foram necess√°rias ferramentas de desenvolvimento do DOS para criar o jogo</b> !  Eu usei apenas o compilador Linux C regular (gcc).  Na realidade, voc√™ n√£o pode nem criar um DOS Defender para DOS.  Eu vejo o DOS apenas como uma plataforma incorporada, que √© a √∫nica forma na qual o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">DOS ainda existe hoje</a> .  Juntamente com o DOSBox e o DOSEMU, este √© um conjunto de ferramentas bastante conveniente. <br><br>  Se voc√™ est√° interessado apenas na parte pr√°tica do desenvolvimento, v√° para a se√ß√£o "Cheat on GCC", onde escreveremos o programa DOS COM "Hello, World" com o GCC Linux. <br><br><h1>  Encontrando as ferramentas certas </h1><br>  Quando iniciei este projeto, n√£o pensei no GCC.  Na realidade, eu fui assim quando descobri o pacote <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">bcc</a> (Bruce's C Compiler) para o Debian, que coleta bin√°rios de 16 bits para o 8086. Ele √© usado para compilar os carregadores de inicializa√ß√£o x86 e outras coisas, mas o bcc tamb√©m pode ser usado para compilar arquivos COM do DOS.  Isso me interessou. <br><br>  Para refer√™ncia: o microprocessador Intel 8086 de 16 bits foi lan√ßado em 1978.  N√£o possu√≠a recursos bizarros dos processadores modernos: nenhuma prote√ß√£o de mem√≥ria, instru√ß√µes de ponto flutuante e apenas 1 MB de RAM endere√ß√°vel.  Todos os desktops e laptops x86 modernos ainda podem fingir ser esse processador de 16 bits 8086 h√° quarenta anos, com o mesmo endere√ßamento limitado e tudo mais.  Essa √© uma compatibilidade bastante antiga.  Essa fun√ß√£o √© chamada <i>modo real</i> .  Este √© o modo no qual todos os computadores x86 s√£o inicializados.  Os SOs modernos mudam imediatamente para o <i>modo protegido</i> com endere√ßamento virtual e multitarefa segura.  O DOS n√£o fez isso. <br><br>  Infelizmente, o bcc n√£o √© um compilador ANSI C. Ele suporta um subconjunto do K&amp;R C, bem como o c√≥digo do assembler x86 embutido.  Diferentemente de outros compiladores 8086 C, ele n√£o possui o conceito de ponteiros "long" ou "long", portanto, o c√≥digo do assembler interno √© necess√°rio para acessar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">outros segmentos de mem√≥ria</a> (VGA, rel√≥gios, etc.).  Nota: os remanescentes desses "ponteiros longos" 8086 ainda s√£o preservados na API do Win32: <code>LPSTR</code> , <code>LPWORD</code> , <code>LPDWORD</code> , etc. Esse montador <code>LPDWORD</code> nem se compara ao GCC do montador interno.  No assembler, voc√™ precisa carregar manualmente vari√°veis ‚Äã‚Äãda pilha e, como o bcc suporta duas conven√ß√µes de chamada diferentes, as vari√°veis ‚Äã‚Äãno c√≥digo devem ser codificadas de acordo com uma ou outra conven√ß√£o. <br><br>  Dadas essas limita√ß√µes, decidi procurar alternativas. <br><br><h1>  DJGPP </h1><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">DJGPP</a> - porta GCC no DOS.  Um projeto realmente muito impressionante que transfere quase todo o POSIX no DOS.  Muitos programas com porta DOS s√£o criados no DJGPP.  Mas ele cria apenas programas de 32 bits para o modo protegido.  Se no modo protegido voc√™ precisar trabalhar com hardware (por exemplo, VGA), o programa far√° solicita√ß√µes ao servi√ßo da DPMI ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">interface de modo protegido do</a> DOS).  Se eu tomasse o DJGPP, n√£o poderia me limitar a um √∫nico bin√°rio independente, porque teria que ter um servidor DPMI.  O desempenho tamb√©m sofre com solicita√ß√µes de DPMI. <br><br>  Obter as ferramentas necess√°rias para o DJGPP √© dif√≠cil, para dizer o m√≠nimo.  Felizmente, encontrei um projeto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">build-djgpp</a> √∫til que executa tudo, pelo menos no Linux. <br><br>  Houve um erro grave ou os bin√°rios oficiais do DJGPP foram <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">infectados pelo v√≠rus novamente</a> , mas quando iniciei meus programas no DOSBox, o erro "N√£o √© COFF: verifique se h√° v√≠rus" constantemente aparecia.  Para verificar se os v√≠rus n√£o est√£o em minha pr√≥pria m√°quina, configurei o ambiente DJGPP no meu Raspberry Pi, que funciona como uma sala limpa.  Este dispositivo baseado em ARM n√£o pode ser infectado com o v√≠rus x86.  E ainda surgiu o mesmo problema, e todos os hashes bin√°rios eram os mesmos entre as m√°quinas, por isso n√£o √© minha culpa. <br><br>  Ent√£o, considerando esse problema e o DPMI, comecei a procurar mais. <br><br><h1>  Enganando gcc </h1><br>  Finalmente decidi o truque de "trapacear" o GCC para criar arquivos COM do DOS em modo real.  O truque funciona at√© 80386 (que geralmente √© o que voc√™ precisa).  O processador 80386 foi lan√ßado em 1985 e se tornou o primeiro microprocessador x86 de 32 bits.  O GCC ainda segue esse conjunto de instru√ß√µes, mesmo em ambientes x86-64.  Infelizmente, o GCC n√£o pode produzir c√≥digo de 16 bits de forma alguma, ent√£o tive que abandonar o objetivo original de criar um jogo para o 8086.  No entanto, isso n√£o importa, porque a plataforma DOSBox de destino √© essencialmente um emulador 80386. <br><br>  Em teoria, o truque tamb√©m deve funcionar no compilador MinGW, mas h√° um erro de longa data que o impede de funcionar corretamente (‚Äún√£o √© poss√≠vel executar opera√ß√µes de PE no arquivo de sa√≠da que n√£o √© PE‚Äù).  No entanto, voc√™ pode contornar isso, e eu fiz isso sozinho: voc√™ deve remover a diretiva <code>OUTPUT_FORMAT</code> e adicionar uma etapa de <code>objcopy</code> adicional ( <code>objcopy -O binary</code> ). <br><br><h3>  Ol√° Mundo no DOS </h3><br>  Para demonstra√ß√£o, criaremos o programa DOS COM "Hello, World" usando o GCC no Linux. <br><br>  H√° um obst√°culo importante e significativo nesse m√©todo: <b>n√£o haver√° biblioteca padr√£o</b> .  √â como escrever um sistema operacional a partir do zero, com exce√ß√£o de alguns servi√ßos que o DOS fornece.  Isso significa que n√£o <code>printf()</code> ou similar.  Em vez disso, pedimos ao DOS para imprimir a string no console.  A cria√ß√£o de uma solicita√ß√£o do DOS requer uma interrup√ß√£o, o que significa c√≥digo montador embutido! <br><br>  O DOS possui nove interrup√ß√µes: 0x20, 0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x2F.  O mais importante que nos interessa √© 0x21, a fun√ß√£o 0x09 (imprimir uma linha).  Entre o DOS e o BIOS, existem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">milhares de fun√ß√µes nomeadas ap√≥s esse padr√£o</a> .  N√£o vou tentar explicar o montador x86, mas, em poucas palavras, o n√∫mero da fun√ß√£o fica preso no registro <code>ah</code> - e a interrup√ß√£o 0x21 √© acionada.  A fun√ß√£o 0x09 tamb√©m recebe um argumento - um ponteiro para uma linha para impress√£o, que √© passada nos registros <code>dx</code> e <code>ds</code> . <br><br>  Aqui est√° a fun√ß√£o <code>print()</code> do montador embutido do GCC.  As linhas passadas para esta fun√ß√£o devem terminar com o caractere $.  Porque  Porque DOS. <br><br><pre> <code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">asm</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">volatile</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"mov $0x09, %%ah\n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"int $0x21\n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> : </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* no output */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> : </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"d"</span></span></span></span><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">) : </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"ah"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; }</code> </pre> <br>  O c√≥digo √© declarado <code>volatile</code> porque tem um efeito colateral (impress√£o de linha).  Para o GCC, o c√≥digo do montador √© opaco e o otimizador depende de restri√ß√µes de sa√≠da / entrada / bloqueio (√∫ltimas tr√™s linhas).  Para esses programas DOS, qualquer assembler interno ter√° efeitos colaterais.  Isso ocorre porque ele foi escrito n√£o para otimiza√ß√£o, mas para acesso a recursos de hardware e DOS - coisas inacess√≠veis ao simples C. <br><br>  Voc√™ tamb√©m deve cuidar da instru√ß√£o de chamada, porque o GCC n√£o sabe que a mem√≥ria apontada pela <code>string</code> j√° foi lida.  √â prov√°vel que um array que suporte a string tamb√©m precise ser declarado <code>volatile</code> .  Tudo isso pressagia o inevit√°vel: qualquer a√ß√£o nesse ambiente se transforma em uma luta sem fim com o otimizador.  Nem todas essas batalhas podem ser vencidas. <br><br>  Agora para a fun√ß√£o principal.  Seu nome n√£o √© importante em princ√≠pio, mas evito cham√°-lo de <code>main()</code> , porque o MinGW tem id√©ias engra√ßadas sobre como processar esses personagens especificamente, mesmo se eles pedirem que ele n√£o o fa√ßa. <br><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dosmain</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span></span><span class="hljs-function">)</span></span> { print(<span class="hljs-string"><span class="hljs-string">"Hello, World!\n$"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br>  Arquivos COM s√£o limitados a 65279 bytes de tamanho.  Isso ocorre porque o segmento de mem√≥ria x86 tem 64 KB e o DOS simplesmente baixa os arquivos COM para o endere√ßo do segmento 0x0100 e √© executado.  Sem t√≠tulos, apenas um bin√°rio limpo.  Como o programa COM, em princ√≠pio, n√£o pode ter um tamanho significativo, nenhum layout real (independente) deve ocorrer, tudo √© compilado como uma √∫nica unidade de tradu√ß√£o.  Essa ser√° uma chamada do GCC com v√°rios par√¢metros. <br><br><h3>  Op√ß√µes do compilador </h3><br>  Aqui est√£o as principais op√ß√µes do compilador. <br><br> <code>-std=gnu99 -Os -nostdlib -m32 -march=i386 -ffreestanding</code> <br> <br>  Como as bibliotecas padr√£o n√£o s√£o usadas, a √∫nica diferen√ßa entre gnu99 e c99 s√£o os trigraphs desativados (como deveriam ser), e o assembler <code>__asm__</code> pode ser escrito como <code>asm</code> vez de <code>__asm__</code> .  Este n√£o √© o escaninho de Newton.  O projeto estar√° t√£o intimamente relacionado ao GCC que ainda n√£o estou preocupado com as extens√µes do GCC. <br><br>  A op√ß√£o <code>-Os</code> reduz o resultado da compila√ß√£o, tanto quanto poss√≠vel.  Portanto, o programa funcionar√° mais r√°pido.  Isso √© importante de olho no DOSBox, porque o emulador padr√£o roda lentamente como uma m√°quina dos anos 80.  Eu quero me encaixar nessa limita√ß√£o.  Se o otimizador estiver causando problemas, <code>-O0</code> temporariamente <code>-O0</code> para determinar se o seu erro ou o otimizador est√° aqui. <br><br>  Como voc√™ pode ver, o otimizador n√£o entende que o programa funcionar√° em modo real com as restri√ß√µes de endere√ßamento correspondentes.  <b>Ele executa todos os tipos de otimiza√ß√µes inv√°lidas que quebram seus programas perfeitamente v√°lidos.</b>  Este n√£o √© um bug do GCC, porque n√≥s mesmos estamos fazendo coisas loucas aqui.  Tive que refazer o c√≥digo v√°rias vezes para impedir que o otimizador interrompesse o programa.  Por exemplo, tivemos que evitar o retorno de estruturas complexas a partir de fun√ß√µes porque elas √†s vezes eram preenchidas com lixo.  O verdadeiro perigo √© que a vers√£o futura do GCC se torne ainda mais inteligente e quebre ainda mais o c√≥digo.  Aqui est√° seu amigo <code>volatile</code> . <br><br>  O pr√≥ximo par√¢metro √© <code>-nostdlib</code> , pois n√£o poderemos vincular a nenhuma biblioteca v√°lida, mesmo estaticamente. <br><br>  Os par√¢metros <code>-m32-march=i386</code> compilador a emitir o c√≥digo 80386. Se eu escrevesse o gerenciador de inicializa√ß√£o para um computador moderno, a exibi√ß√£o no 80686 tamb√©m seria normal, mas o DOSBox √© 80386. <br><br>  O argumento <code>-ffreestanding</code> exige que o GCC n√£o emita c√≥digo que acesse as fun√ß√µes auxiliares da biblioteca padr√£o interna.  √Äs vezes, em vez de trabalhar com c√≥digo, ele produz um c√≥digo para chamar uma fun√ß√£o interna, especialmente com operadores matem√°ticos.  Eu tive um dos principais problemas com o cco, em que esse comportamento n√£o pode ser desativado.  Essa op√ß√£o √© usada com mais frequ√™ncia ao gravar carregadores de inicializa√ß√£o e kernels do SO.  E agora os arquivos dos dos .com. <br><br><h3>  Op√ß√µes do vinculador </h3><br>  A <code>-Wl</code> usada para passar argumentos para o vinculador ( <code>ld</code> ).  Precisamos disso porque fazemos tudo em uma chamada para o GCC. <br><br><pre> <code class="hljs powershell"><span class="hljs-literal"><span class="hljs-literal">-Wl</span></span>,-<span class="hljs-literal"><span class="hljs-literal">-nmagic</span></span>,-<span class="hljs-literal"><span class="hljs-literal">-script</span></span>=com.ld</code> </pre> <br>  <code>--nmagic</code> desativa o alinhamento da p√°gina de se√ß√£o.  Em primeiro lugar, n√£o precisamos disso.  Em segundo lugar, desperdi√ßa um espa√ßo precioso.  Nos meus testes, isso n√£o parece ser uma medida necess√°ria, mas por precau√ß√£o, deixo essa op√ß√£o. <br><br>  O par√¢metro <code>--script</code> indica que queremos usar um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">script vinculador</a> especial.  Isso permite que voc√™ coloque com precis√£o as se√ß√µes ( <code>text</code> , <code>data</code> , <code>bss</code> , <code>rodata</code> ) do nosso programa.  Aqui est√° o script <code>com.ld</code> <br><br><pre> <code class="hljs haskell"><span class="hljs-type"><span class="hljs-type">OUTPUT_FORMAT</span></span>(binary) <span class="hljs-type"><span class="hljs-type">SECTIONS</span></span> { . = <span class="hljs-number"><span class="hljs-number">0x0100</span></span>; .text : { *(.text); } .<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class"> : { *(.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">); *(.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bss</span></span></span><span class="hljs-class">); *(.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rodata</span></span></span><span class="hljs-class">); } _heap = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ALIGN</span></span></span><span class="hljs-class">(4); }</span></span></code> </pre> <br>  <code>OUTPUT_FORMAT(binary)</code> diz para voc√™ n√£o colocar isso em um arquivo ELF (ou PE, etc.).  O vinculador deve apenas redefinir o c√≥digo limpo.  Um arquivo COM √© apenas um c√≥digo limpo, ou seja, damos o comando ao vinculador para criar um arquivo COM! <br><br>  Eu disse que os arquivos COM s√£o carregados em <code>0x0100</code> .  A quarta linha muda o bin√°rio para l√°.  O primeiro byte do arquivo COM ainda √© o primeiro byte do c√≥digo, mas ser√° iniciado a partir desse deslocamento de mem√≥ria. <br><br>  Em seguida, todas as se√ß√µes seguem: <code>text</code> (programa), <code>data</code> ( <code>data</code> est√°ticos), <code>bss</code> (dados com inicializa√ß√£o zero), <code>rodata</code> (strings).  Por fim, <code>_heap</code> o final do bin√°rio com o s√≠mbolo <code>_heap</code> .  Isso ser√° √∫til mais tarde ao escrever <code>sbrk()</code> quando terminarmos com ‚ÄúHello, World‚Äù.  Eu indiquei para alinhar <code>_heap</code> com 4 bytes. <br><br>  Quase pronto. <br><br><h3>  Lan√ßamento do programa </h3><br>  O vinculador geralmente conhece nosso ponto de entrada ( <code>main</code> ) e o define para n√≥s.  Mas desde que solicitamos um problema "bin√°rio", teremos que descobrir por n√≥s mesmos.  Se a fun√ß√£o <code>print()</code> for a primeira a ser executada, o programa iniciar√° a partir dela, o que est√° errado.  O programa precisa de um cabe√ßalho pequeno para come√ßar. <br><br>  Existe uma op√ß√£o <code>STARTUP</code> no script do vinculador para essas coisas, mas por simplicidade, a implementaremos diretamente no programa.  Geralmente, essas coisas s√£o chamadas de <code>crt0.o</code> ou <code>Boot.o</code> , caso voc√™ as <code>Boot.o</code> em algum lugar.  Nosso c√≥digo <i>deve</i> come√ßar com este assembler interno, antes de qualquer inclus√£o e similares.  O DOS far√° a maior parte da instala√ß√£o para n√≥s, s√≥ precisamos ir para o ponto de entrada. <br><br><pre> <code class="hljs perl">asm (<span class="hljs-string"><span class="hljs-string">".code16gcc\n"</span></span> <span class="hljs-string"><span class="hljs-string">"call dosmain\n"</span></span> <span class="hljs-string"><span class="hljs-string">"mov $0x4C, %ah\n"</span></span> <span class="hljs-string"><span class="hljs-string">"int $0x21\n"</span></span>);</code> </pre> <br>  <code>.code16gcc</code> diz ao assembler que vamos trabalhar em modo real, para que ele fa√ßa a configura√ß√£o correta.  Apesar do nome, ele <i>n√£o</i> produzir√° c√≥digo de 16 bits!  Primeiro, a fun√ß√£o <code>dosmain</code> , que escrevemos anteriormente, √© chamada.  Ele ent√£o diz ao DOS usando a fun√ß√£o 0x4C (‚Äúterminar com o c√≥digo de retorno‚Äù) que terminamos passando o c√≥digo de sa√≠da para o registro de 1 byte <code>al</code> (j√° definido pelo <code>dosmain</code> ).  Esse montador embutido √© automaticamente <code>volatile</code> porque n√£o possui entradas e sa√≠das. <br><br><h3>  Todos juntos </h3><br>  Aqui est√° o programa inteiro em C. <br><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">asm</span></span> (<span class="hljs-string"><span class="hljs-string">".code16gcc\n"</span></span> <span class="hljs-string"><span class="hljs-string">"call dosmain\n"</span></span> <span class="hljs-string"><span class="hljs-string">"mov $0x4C,%ah\n"</span></span> <span class="hljs-string"><span class="hljs-string">"int $0x21\n"</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">asm</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">volatile</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"mov $0x09, %%ah\n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"int $0x21\n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> : </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* no output */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> : </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"d"</span></span></span></span><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">) : </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"ah"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dosmain</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ print(<span class="hljs-string"><span class="hljs-string">"Hello, World!\n$"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br>  N√£o vou repetir <code>com.ld</code>  Aqui est√° o desafio do GCC. <br><br><pre> <code class="hljs powershell">gcc <span class="hljs-literal"><span class="hljs-literal">-std</span></span>=gnu99 <span class="hljs-literal"><span class="hljs-literal">-Os</span></span> <span class="hljs-literal"><span class="hljs-literal">-nostdlib</span></span> <span class="hljs-literal"><span class="hljs-literal">-m32</span></span> <span class="hljs-literal"><span class="hljs-literal">-march</span></span>=i386 <span class="hljs-literal"><span class="hljs-literal">-ffreestanding</span></span> \ <span class="hljs-literal"><span class="hljs-literal">-o</span></span> hello.com <span class="hljs-literal"><span class="hljs-literal">-Wl</span></span>,-<span class="hljs-literal"><span class="hljs-literal">-nmagic</span></span>,-<span class="hljs-literal"><span class="hljs-literal">-script</span></span>=com.ld hello.c</code> </pre> <br>  E seus testes no DOSBox: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4c5/478/358/4c5478358be0cdd9cc05eafd66bd44d2.png"><br><br>  Ent√£o, se voc√™ quiser belos gr√°ficos, a √∫nica quest√£o √© chamar a interrup√ß√£o e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">gravar na mem√≥ria VGA</a> .  Se voc√™ deseja som, use a interrup√ß√£o do alto-falante do PC.  Ainda n√£o descobri como ligar para o Sound Blaster.  A partir desse momento, o DOS Defender cresceu. <br><br><h1>  Aloca√ß√£o de mem√≥ria </h1><br>  Para cobrir outro t√≥pico, lembre-se que <code>_heap</code> ?  Podemos us√°-lo para implementar <code>sbrk()</code> e alocar mem√≥ria dinamicamente na se√ß√£o principal do programa.  Este √© um modo real e n√£o h√° mem√≥ria virtual, para que possamos gravar em qualquer mem√≥ria que possamos acessar a qualquer momento.  Algumas √°reas s√£o reservadas (por exemplo, mem√≥ria inferior e superior) para o equipamento.  Portanto, n√£o h√° necessidade <i>real</i> de usar sbrk (), mas √© interessante tentar. <br><br>  Como de costume no x86, seu programa e parti√ß√µes est√£o na mem√≥ria inferior (0x0100 nesse caso) e a pilha est√° na mem√≥ria superior (no nosso caso, na regi√£o 0xffff).  Em sistemas tipo Unix, a mem√≥ria retornada por <code>malloc()</code> vem de dois lugares: <code>sbrk()</code> e <code>mmap()</code> .  O que o <code>sbrk()</code> faz √© alocar mem√≥ria logo acima dos segmentos de programa / dados, incrementando-a na dire√ß√£o da pilha.  Cada chamada para <code>sbrk()</code> aumentar√° esse espa√ßo (ou deixar√° exatamente o mesmo).  Essa mem√≥ria ser√° gerenciada por <code>malloc()</code> e similares. <br><br>  Veja como implementar <code>sbrk()</code> em um programa COM.  Observe que voc√™ precisa definir seu pr√≥prio <code>size_t</code> , porque n√£o temos uma biblioteca padr√£o. <br><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> _heap; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *hbreak = &amp;_heap; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sbrk</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> size)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *ptr = hbreak; hbreak += size; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ptr; }</code> </pre> <br>  Simplesmente define o ponteiro para <code>_heap</code> e o incrementa conforme necess√°rio.  Um pouco mais inteligente <code>sbrk()</code> tamb√©m ter√° cuidado com o alinhamento. <br><br>  Uma coisa interessante aconteceu durante a cria√ß√£o do DOS Defender.  Eu (incorretamente) considerei que a mem√≥ria do meu <code>sbrk()</code> redefinida.  Ent√£o foi depois do primeiro jogo.  No entanto, o DOS n√£o redefine essa mem√≥ria entre os programas.  Quando iniciei o jogo novamente, <i>ele continuou exatamente onde parei</i> , porque as mesmas estruturas de dados com o mesmo conte√∫do foram carregadas no lugar.  Muito legal coincid√™ncia!  Isso faz parte do que torna essa plataforma incorporada divertida. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt412867/">https://habr.com/ru/post/pt412867/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt412855/index.html">As vulnerabilidades do CSRF ainda s√£o relevantes</a></li>
<li><a href="../pt412859/index.html">Autentica√ß√£o de dois fatores no Windows e criptografia de dados sem uma autoridade de certifica√ß√£o e dom√≠nio</a></li>
<li><a href="../pt412861/index.html">Criando um mapa de caminho do usu√°rio para manequins</a></li>
<li><a href="../pt412863/index.html">Dialogflower - Google Dialogflow para Yandex Alice</a></li>
<li><a href="../pt412865/index.html">Como fotografar uma c√¢mera Motion Eye na Sony Xperia XZ2</a></li>
<li><a href="../pt412869/index.html">Entrevista com um especialista em engenharia de tecidos e medicina regenerativa, Professor Tal Tal Dvir</a></li>
<li><a href="../pt412871/index.html">Eclair - Biblioteca de log declarativa do Java Spring</a></li>
<li><a href="../pt412873/index.html">Discos r√≠gidos estragados pelo som dos alto-falantes comuns de laptop</a></li>
<li><a href="../pt412877/index.html">Rut√™nio (Ru) - o quarto elemento com propriedades ferromagn√©ticas √† temperatura ambiente</a></li>
<li><a href="../pt412879/index.html">Edi√ß√£o 24: Treinamento em TI - problemas e desafios atuais das principais empresas</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>