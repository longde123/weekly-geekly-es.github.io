<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚈 🎮 🤳🏼 [Traducción] Cómo funciona Graal - Compilador JVM JVM de Java ☦️ 🥝 🍔</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola Habr! Le presento la traducción del artículo " Comprender cómo funciona Graal: un compilador JIT de Java escrito en Java ". 
 Introduccion 


 Un...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>[Traducción] Cómo funciona Graal - Compilador JVM JVM de Java</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/419637/"><p> Hola Habr!  Le presento la traducción del artículo " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Comprender cómo funciona Graal: un compilador JIT de Java escrito en Java</a> ". </p><br><h2 id="vvedenie">  Introduccion </h2><br><p>  Una de las razones por las cuales me convertí en investigador en lenguajes de programación es que, en una gran comunidad de personas involucradas en tecnología informática, casi todos usan lenguajes de programación, y muchos están interesados ​​en cómo funcionan.  Cuando conocí la programación cuando era niño y me familiaricé con un lenguaje de programación, lo primero que quería saber era cómo funciona, y lo primero que quería hacer era crear mi propio lenguaje. </p><br><p>  En esta presentación, le mostraré algunos de los mecanismos de trabajo del lenguaje que todos usan: Java.  La peculiaridad es que <em>usaré</em> un proyecto llamado <em>Graal</em> , que implementa el concepto de <em>Java en Java</em> . </p><a name="habracut"></a><br><p>  Graal es solo uno de los componentes en el trabajo de Java: es un compilador <em>justo a tiempo</em> .  Esta es la parte de la JVM que convierte el bytecode de Java en código de máquina durante la ejecución del programa, y ​​es uno de los factores que aseguran un alto rendimiento de la plataforma.  También es, me parece, lo que la mayoría de las personas considera una de las partes más complejas y vagas de la JVM, que está más allá de su comprensión.  Cambiar esta opinión es el propósito de este discurso. </p><br><p>  Si sabes lo que es una JVM;  generalmente entiendo qué significan los términos <em>bytecode</em> y <em>machine code</em>  y capaz de leer código escrito en Java, entonces, espero, esto será suficiente para entender el material presentado. </p><br><p>  Comenzaré discutiendo por qué podríamos querer un nuevo compilador JIT para la JVM escrito en Java, y luego mostraré que no hay nada más especial en esto, como podría pensar, al dividir la tarea en ensamblador, uso y demostración de compilación. que su código es el mismo que en cualquier otra aplicación. </p><br><p>  Tocaré un poco la teoría y luego mostraré cómo se aplica durante todo el proceso de compilación, desde el código de bytes hasta el código de máquina.  También mostraré algunos detalles, y al final hablaremos sobre los beneficios de esta característica además de implementar <em>Java en Java</em> por sí mismo. </p><br><p>  Usaré las capturas de pantalla del código en Eclipse, en lugar de lanzarlas durante la presentación, para evitar los problemas inevitables de la codificación en vivo. </p><br><h2 id="chto-takoe-jit-kompilyator">  ¿Qué es un compilador JIT? </h2><br><p>  Estoy seguro de que muchos de ustedes saben lo que es un compilador JIT, pero aún voy a tocar los conceptos básicos para que nadie esté sentado aquí con miedo de hacer esta pregunta principal. </p><br><p> Cuando ejecuta el comando <code>javac</code> o <em>compile-on-save</em> en el IDE, su programa Java compila del código Java al código de bytes JVM, que es la representación binaria del programa.  Es más compacto y simple que el código fuente de Java.  Sin embargo, el procesador normal de su computadora portátil o servidor no puede simplemente ejecutar el código de bytes JVM. </p><br><p>  Para el funcionamiento de su programa, la JVM interpreta este código de bytes.  Los intérpretes suelen ser mucho más lentos que el código de máquina que se ejecuta en el procesador.  Por esta razón, la JVM, mientras el programa se está ejecutando, puede lanzar otro compilador que convierte su código de bytes en código de máquina, que el procesador ya puede ejecutar. </p><br><p>  Este compilador, generalmente mucho más sofisticado que <code>javac</code> , realiza optimizaciones complejas para producir código de máquina de alta calidad como resultado. </p><br><h2 id="zachem-pisat-jit-kompilyator-na-java">  ¿Por qué escribir un compilador JIT en Java? </h2><br><p>  Hasta la fecha, una implementación de JVM llamada <em>OpenJDK</em> incluye dos compiladores JIT principales.  El compilador del cliente, conocido como <em>C1</em> , está diseñado para una operación más rápida, pero al mismo tiempo produce un código menos optimizado.  El compilador del servidor, conocido como <em>opto</em> o <em>C2</em> , requiere un poco más de tiempo para funcionar, pero produce un código más optimizado. </p><br><p>  La idea era que el compilador del cliente era más adecuado para aplicaciones de escritorio, donde las pausas largas en el compilador JIT no eran deseables, y el compilador del servidor para aplicaciones de servidor de larga duración, que podrían pasar más tiempo compilando. </p><br><p>  Hoy se pueden combinar para que C1 compile primero el código y luego, si continúa ejecutándose intensamente y tiene sentido gastar tiempo adicional, - C2.  Esto se llama <em>compilación escalonada</em> . </p><br><p>  Hablemos de C2, el compilador del servidor que realiza más optimizaciones. </p><br><p>  Podemos clonar OpenJDK desde el espejo en <em>GitHub</em> , o simplemente abrir el árbol del proyecto en el sitio. </p><br><pre> <code class="hljs ruby">$ git clone <span class="hljs-symbol"><span class="hljs-symbol">https:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/github.com/dmlloyd</span></span><span class="hljs-regexp"><span class="hljs-regexp">/openjdk.git</span></span></code> </pre> <br><p>  El código C2 está en <em>openjdk / hotspot / src / share / vm / opto</em> . </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/c2.png" alt="Código fuente c2"></p><br><p>  En primer lugar, vale la pena señalar que C2 está escrito en <em>C ++</em> .  Por supuesto, esto no es algo malo, pero hay ciertas desventajas.  C ++ es un lenguaje inseguro.  Esto significa que los errores en C ++ pueden bloquear la VM.  La razón de esto es probablemente la antigüedad del código, pero el código C2 C ++ se ha vuelto muy difícil de mantener y desarrollar. </p><br><p>  Una de las figuras clave detrás del compilador de C2, Cliff Click dijo que nunca más volvería a escribir VM en C ++, y escuchamos al equipo de <em>Twitter</em> JVM decir que C2 se estancó y necesita ser reemplazado por alguna razón. dificultades de mayor desarrollo. </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/click-1.jpeg" alt="Presentación de cliff click"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/click-2.png" alt="Lo que Cliff Click no quiere volver a hacer"></p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://www.youtube.com/watch?v=Hqw57GJSrac</a> </p><br><p>  Entonces, volviendo a la pregunta, ¿qué es esto en Java que puede ayudar a resolver estos problemas?  Lo mismo que da escribir un programa en Java en lugar de C ++.  Probablemente sea seguridad (excepciones en lugar de bloqueos, sin pérdida de memoria real o punteros colgantes), buenos <em>ayudantes</em> (depuradores, perfiladores y herramientas como <em>VisualVM</em> ), buen soporte IDE, etc. </p><br><p>  Puede pensar: <em>¿cómo puedo escribir algo como un compilador JIT de Java?</em>  , y que esto solo es posible en un lenguaje de programación de sistema de bajo nivel como C ++.  ¡En esta presentación, espero convencerlos de que esto no es en absoluto!  Esencialmente, el compilador JIT solo debe aceptar el código de <code>byte[]</code> JVM y entregar el código de la máquina; usted le da el <code>byte[]</code> en la entrada y también desea recuperar el <code>byte[]</code> .  Se necesita mucho trabajo complejo para hacer esto, pero no afecta el nivel del sistema y, por lo tanto, no requiere un lenguaje del <em>sistema</em> como C o C ++. </p><br><h2 id="nastroyka-graal">  Configuración de Graal </h2><br><p>  Lo primero que necesitamos es Java 9. La interfaz de Graal llamada <em>JVMCI utilizada</em> se agregó a Java como parte de la <em>interfaz del compilador JVM de nivel Java JEP 243,</em> y la primera versión que la incluye es Java 9. Uso <em>9 + 181</em> .  En caso de requisitos especiales, hay puertos (backports) para Java 8. </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> export JAVA_HOME=`pwd`/jdk9 <span class="hljs-variable"><span class="hljs-variable">$</span></span> export PATH=<span class="hljs-variable"><span class="hljs-variable">$JAVA_HOME</span></span>/bin:<span class="hljs-variable"><span class="hljs-variable">$PATH</span></span> <span class="hljs-variable"><span class="hljs-variable">$</span></span> java <span class="hljs-literal"><span class="hljs-literal">-version</span></span> java version <span class="hljs-string"><span class="hljs-string">"9"</span></span> Java(TM) SE Runtime Environment (build <span class="hljs-number"><span class="hljs-number">9</span></span>+<span class="hljs-number"><span class="hljs-number">181</span></span>) Java HotSpot(TM) <span class="hljs-number"><span class="hljs-number">64</span></span><span class="hljs-literal"><span class="hljs-literal">-Bit</span></span> Server VM (build <span class="hljs-number"><span class="hljs-number">9</span></span>+<span class="hljs-number"><span class="hljs-number">181</span></span>, mixed mode)</code> </pre> <br><p>  Lo siguiente que necesitamos es un sistema de compilación llamado <code>mx</code> .  Es un poco como <em>Maven</em> o <em>Gradle</em> , pero lo más probable es que no lo elija para su aplicación.  Implementa cierta funcionalidad para admitir algunos casos de uso complejos, pero la usaremos solo para ensamblajes simples. </p><br><p>  Puedes clonar <code>mx</code> con GitHub.  Estoy usando commit <code>#7353064</code> .  Ahora solo agregue el ejecutable a la ruta. </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> git clone https://github.com/graalvm/mx.git <span class="hljs-variable"><span class="hljs-variable">$</span></span> cd mx; git checkout <span class="hljs-number"><span class="hljs-number">7353064</span></span> <span class="hljs-variable"><span class="hljs-variable">$</span></span> export PATH=`pwd`/mx:<span class="hljs-variable"><span class="hljs-variable">$PATH</span></span></code> </pre> <br><p>  Ahora necesitamos clonar a Graal.  Estoy usando una distribución llamada <em>GraalVM</em> versión <em>0.28.2</em> . </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> git clone https://github.com/graalvm/graal.git -<span class="hljs-literal"><span class="hljs-literal">-branch</span></span> vm<span class="hljs-literal"><span class="hljs-literal">-enterprise</span></span><span class="hljs-literal"><span class="hljs-literal">-0</span></span>.<span class="hljs-number"><span class="hljs-number">28.2</span></span></code> </pre> <br><p>  Este repositorio contiene otros proyectos en los que no estamos interesados, por lo que simplemente vamos al subproyecto del <em>compilador</em> , que es el compilador Graal JIT, y lo <code>mx</code> usando <code>mx</code> . </p><br><pre> <code class="hljs ruby">$ cd graal/compiler $ mx build</code> </pre> <br><p>  Para trabajar con el código Graal, usaré el <em>IDE de Eclipse</em> .  Estoy usando Eclipse 4.7.1.  <code>mx</code> puede generar archivos de proyecto de Eclipse para nosotros. </p><br><pre> <code class="hljs ruby">$ mx eclipseinit</code> </pre> <br><p>  Para abrir el directorio <em>graal</em> como un <em>espacio de trabajo,</em> debe ejecutar <em>Archivo, Importar ..., General, Proyectos existentes</em> y seleccionar <em>nuevamente el</em> directorio <em>graal</em> .  Si no ejecutó Eclipse en Java 9, es posible que también necesite adjuntar las fuentes JDK. </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/eclipse.png" alt="Graal en eclipse"></p><br><p>  Bueno  Ahora que todo está listo, veamos cómo funciona.  Usaremos este código muy simple. </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Demo</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { workload(<span class="hljs-number"><span class="hljs-number">14</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a + b; } }</code> </pre> <br><p>  Primero, compilamos este código <code>javac</code> y luego ejecutamos la JVM.  Primero, le mostraré cómo funciona el compilador JIT C2 estándar.  Para hacer esto, especificaremos varios indicadores: <code>-XX:+PrintCompilation</code> , que es necesario para que la JVM escriba un registro al compilar un método, y <code>-XX:CompileOnly=Demo::workload</code> , para que solo este método se compile.  Si no lo hacemos, se mostrará demasiada información y la JVM será más inteligente de lo que necesitamos y optimizará el código que queremos ver. </p><br><pre> <code class="hljs ruby">$ javac Demo.java $ java \ -<span class="hljs-symbol"><span class="hljs-symbol">XX:</span></span>+PrintCompilation \ -<span class="hljs-symbol"><span class="hljs-symbol">XX:</span></span>CompileOnly=Demo::workload \ Demo ... <span class="hljs-number"><span class="hljs-number">113</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> Demo::workload (<span class="hljs-number"><span class="hljs-number">4</span></span> bytes) ...</code> </pre> <br><p>  No explicaré esto en detalle, pero solo diré que este es un resultado de registro que muestra que el método de <code>workload</code> sido compilado. </p><br><p>  Ahora, como compilador JIT de nuestra JVM Java 9, utilizamos el Graal recién compilado.  Para hacer esto, agregue algunas banderas más. </p><br><p>  <code>--module-path=...</code> y <code>--upgrade-module-path=...</code> agregan Graal a la <em>ruta del módulo</em> .  Permítame recordarle que la <em>ruta del módulo</em> apareció en Java 9 como parte del sistema de módulos <em>Jigsaw</em> , y para nuestros propósitos podemos considerarlo por analogía con <em>classpath</em> . </p><br><p>  Necesitamos el <code>-XX:+UnlockExperimentalVMOptions</code> debido a que JVMCI (la interfaz utilizada por Graal) en esta versión es una característica experimental. </p><br><p>  La bandera <code>-XX:+EnableJVMCI</code> necesaria para decir que queremos usar JVMCI, y <code>-XX:+UseJVMCICompiler</code> - para habilitar e instalar un nuevo compilador JIT. </p><br><p>  Para no complicar el ejemplo, y, en lugar de utilizar C1 junto con JVMCI, tener solo el compilador JVMCI, especifique el indicador <code>-XX:-TieredCompilation</code> , que deshabilitará la compilación por pasos. </p><br><p>  Como antes, especificamos las banderas <code>-XX:+PrintCompilation</code> y <code>-XX:CompileOnly=Demo::workload</code> . </p><br><p>  Como en el ejemplo anterior, vemos que se compiló un método.  Pero, esta vez, para la compilación utilizamos el ensamblado de Graal.  Por ahora, solo toma mi palabra. </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> java \ -<span class="hljs-literal"><span class="hljs-literal">-module</span></span><span class="hljs-literal"><span class="hljs-literal">-path</span></span>=graal/sdk/mxbuild/modules/org.graalvm.graal_sdk.jar:graal/truffle/mxbuild/modules/com.oracle.truffle.truffle_api.jar \ -<span class="hljs-literal"><span class="hljs-literal">-upgrade</span></span><span class="hljs-literal"><span class="hljs-literal">-module</span></span><span class="hljs-literal"><span class="hljs-literal">-path</span></span>=graal/compiler/mxbuild/modules/jdk.internal.vm.compiler.jar \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+UnlockExperimentalVMOptions \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+EnableJVMCI \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+UseJVMCICompiler \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:<span class="hljs-literal"><span class="hljs-literal">-TieredCompilation</span></span> \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+PrintCompilation \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:CompileOnly=Demo::workload \ Demo ... <span class="hljs-number"><span class="hljs-number">583</span></span> <span class="hljs-number"><span class="hljs-number">25</span></span> Demo::workload (<span class="hljs-number"><span class="hljs-number">4</span></span> bytes) ...</code> </pre> <br><h2 id="interfeys-kompilyatora-jvm">  Interfaz del compilador JVM </h2><br><p>  ¿No crees que hicimos algo bastante inusual?  Tenemos una JVM instalada, y reemplazamos el compilador JIT por uno nuevo compilado sin cambiar nada en la propia JVM.  Esta característica es proporcionada por una nueva interfaz JVM llamada JVMCI, la <em>interfaz del compilador JVM</em> , que, como dije anteriormente, era <em>JEP 243</em> y llegó en Java 9. </p><br><p>  La idea es similar a algunas otras tecnologías JVM existentes. </p><br><p>  Quizás haya encontrado procesamiento de código fuente adicional en <code>javac</code> utilizando la <em>API de procesamiento de anotaciones de Java</em> .  Este mecanismo permite identificar anotaciones y el modelo de código fuente en el que se utilizan, y crear nuevos archivos basados ​​en ellas. </p><br><p>  Además, es posible que haya utilizado un procesamiento de código de bytes adicional en la JVM utilizando <em>agentes Java</em> .  Este mecanismo le permite modificar el código de bytes de Java interceptándolo en el momento del arranque. </p><br><p>  La idea de JVMCI es similar.  Le permite conectar su propio compilador JIT de Java escrito en Java. </p><br><p>  Ahora quiero decir algunas palabras sobre cómo mostraré el código durante esta presentación.  Primero, para comprender la idea, mostraré algunos identificadores y lógica simplificados en forma de texto en diapositivas, y luego cambiaré a capturas de pantalla de Eclipse y mostraré el código real, que puede ser un poco más complicado, pero la idea principal seguirá siendo la misma.  La parte principal de esta presentación está destinada a mostrar que es realmente posible trabajar con el código real del proyecto y, por lo tanto, no quiero ocultarlo, aunque puede ser algo complicado. </p><br><p>  A partir de ahora, empiezo a disipar la opinión de que podría tener que el compilador JIT es muy complicado. </p><br><p>  ¿Qué acepta el compilador JIT para la entrada?  Acepta el bytecode del método a compilar.  Y el bytecode, como su nombre lo indica, es solo una matriz de bytes. </p><br><p>  ¿Qué produce el compilador JIT como resultado?  Da el código de máquina del método.  El código de máquina también es solo una matriz de bytes. </p><br><p>  Como resultado, la interfaz que debe implementarse al escribir un nuevo compilador JIT para incrustarlo en la JVM se verá más o menos así. </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JVMCICompiler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] compileMethod(<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] bytecode); }</code> </pre> <br><p>  Por lo tanto, si no puede imaginar cómo Java puede hacer algo tan bajo como la compilación JIT en código máquina, ahora puede ver que este no es un trabajo de tan bajo nivel.  Derecho?  Esto es solo una función del <code>byte[]</code> al <code>byte[]</code> . </p><br><p>  En realidad, todo es algo más complicado.  Solo el bytecode no es suficiente; también necesitamos más información, como el número de variables locales, el tamaño de pila requerido y la información recopilada por el perfilador del intérprete para comprender cómo se ejecuta el código.  Por lo tanto, imagine la entrada en forma de <code>JavaMethod</code> de <code>CompilationRequest</code> , que nos informará sobre el <code>JavaMethod</code> que debe compilarse y proporcionará toda la información necesaria. </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JVMCICompiler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compileMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CompilationRequest request)</span></span></span></span>; } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CompilationRequest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">JavaMethod </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JavaMethod</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] getCode(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMaxLocals</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMaxStackSize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">ProfilingInfo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getProfilingInfo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; ... }</code> </pre> <br><p>  Además, la interfaz no requiere la devolución del código compilado.  En cambio, se usa otra API para instalar el código de máquina en la JVM. </p><br><pre> <code class="java hljs">HotSpot.installCode(targetCode);</code> </pre> <br><p>  Ahora, para escribir un nuevo compilador JIT para JVM, solo necesita implementar esta interfaz.  Obtenemos información sobre el método que debe compilarse, y debemos compilarlo en código máquina y llamar a <code>installCode</code> . </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GraalCompiler</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JVMCICompiler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compileMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CompilationRequest request)</span></span></span><span class="hljs-function"> </span></span>{ HotSpot.installCode(...); } }</code> </pre> <br><p>  Cambiemos al IDE de Eclipse con Graal y echemos un vistazo a algunas interfaces y clases reales.  Como se mencionó anteriormente, serán algo más complicados, pero no por mucho. </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/jvmci-compiler-interface.png" alt="JVMCICompiler"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/hotspot-graal-compiler-1.png" alt="HotSpotGraalCompiler"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/hotspot-graal-compiler-2.png" alt="método de compilación"></p><br><p>  Ahora quiero mostrar que podemos hacer cambios en Graal e inmediatamente usarlos en Java 9. Agregaré un nuevo mensaje de registro que se mostrará al compilar el método usando Graal.  Agréguelo al método de interfaz implementado, que es llamado por JVMCI. </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HotSpotGraalCompiler</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JVMCICompiler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">CompilationRequestResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compileMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CompilationRequest request)</span></span></span><span class="hljs-function"> </span></span>{ System.err.println(<span class="hljs-string"><span class="hljs-string">"Going to compile "</span></span> + request.getMethod().getName()); ... } }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/hotspot-graal-compiler-3.png" alt="Compilación"></p><br><p>  Por ahora, deshabilite el registro de compilación en HotSpot.  Ahora podemos ver nuestro mensaje desde la versión modificada del compilador. </p><br><pre> <code class="java hljs">$ java \ --<span class="hljs-keyword"><span class="hljs-keyword">module</span></span>-path=graal/sdk/mxbuild/modules/org.graalvm.graal_sdk.jar:graal/truffle/mxbuild/modules/com.oracle.truffle.truffle_api.jar \ --upgrade-<span class="hljs-keyword"><span class="hljs-keyword">module</span></span>-path=graal/compiler/mxbuild/modules/jdk.internal.vm.compiler.jar \ -XX:+UnlockExperimentalVMOptions \ -XX:+EnableJVMCI \ -XX:+UseJVMCICompiler \ -XX:-TieredCompilation \ -XX:CompileOnly=Demo::workload \ Demo Going to compile workload</code> </pre> <br><p>  Si intenta repetir esto usted mismo, notará que ni siquiera necesita ejecutar nuestro sistema de compilación: <code>mx build</code> .  Suficiente, normal para Eclipse, <em>compilar al guardar</em> .  Y ciertamente no necesitamos reconstruir la JVM en sí.  Simplemente incorporamos el compilador modificado en la JVM existente. </p><br><h2 id="graf-graal">  Conde Graal </h2><br><p>  Bueno, sabemos que Graal convierte un <code>byte[]</code> a otro <code>byte[]</code> .  Ahora hablemos sobre la teoría y las estructuras de datos que usa, porque  son un poco inusuales incluso para el compilador. </p><br><p>  Esencialmente, el compilador maneja su programa.  Para esto, el programa debe presentarse en forma de algún tipo de estructura de datos.  Una opción es bytecode y listas de instrucciones similares, pero no son muy expresivas. </p><br><p>  En cambio, Graal usa un gráfico para representar su programa.  Si tomamos un operador de suma simple que suma dos variables locales, entonces el gráfico incluirá un nodo para cargar cada variable, un nodo para la suma y dos bordes que muestran que el resultado de cargar variables locales va a la entrada del operador de suma. </p><br><p>  Esto a veces se llama un <em>gráfico de dependencia del programa</em> . </p><br><p>  Teniendo una expresión de la forma <code>x + y</code> obtenemos nodos para las variables locales <code>x</code> e <code>y</code> , y un nodo de su suma. </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/data-graph.png" alt="Gráfico de flujo de datos"></p><br><p>  Los bordes azules en este gráfico muestran la dirección del flujo de datos desde la lectura de las variables locales hasta la suma. </p><br><p>  Además, podemos usar aristas para reflejar el orden de ejecución del programa.  Si, en lugar de leer variables locales, llamamos a métodos, entonces necesitamos recordar el orden de la llamada, y no podemos reorganizarlos (sin conocer el código interno).  Para hacer esto, hay bordes adicionales que definen este orden.  Se muestran en rojo. </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/control-graph.png" alt="Gráfico de flujo de control"></p><br><p>  Entonces, el gráfico de Graal, de hecho, es dos gráficos combinados en uno.  Los nodos son iguales, pero algunos bordes indican la dirección del flujo de datos, mientras que otros muestran la transferencia de control entre ellos. </p><br><p>  Para ver el gráfico de Graal, puede usar una herramienta llamada <em>IdealGraphVisualiser</em> o <em>IGV</em> .  El inicio se realiza utilizando el <code>mx igv</code> . </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/igv.png" alt="IdealGraphVisualiser"></p><br><p>  Después de eso, ejecute la JVM con el indicador <code>-Dgraal.Dump</code> . </p><br><p>  Se puede ver un flujo de datos simple escribiendo una expresión simple. </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">average</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (a + b) / <span class="hljs-number"><span class="hljs-number">2</span></span>; }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/average.png" alt="Media aritmética igv"></p><br><p>  Puede ver cómo los parámetros <code>0</code> ( <code>P(0</code> ) y <code>1</code> ( <code>P(1)</code> ) van a la entrada de la operación de suma, que, junto con la constante <code>2</code> ( <code>C(2)</code> ) va a la entrada de la operación de división, después de lo cual se devuelve este valor. </p><br><p>  Para observar un flujo de datos y control más complejo, presentamos un ciclo. </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">average</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] values)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> sum = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> n = <span class="hljs-number"><span class="hljs-number">0</span></span>; n &lt; values.length; n++) { sum += values[n]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sum / values.length; }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/average-loop.png" alt="Media aritmética igv con ciclo"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/average-loop-detail.png" alt="Medio aritmético igv detallado con bucle"></p><br><p>  En este caso, tenemos nodos del principio y el final del ciclo, que leen los elementos de la matriz y leen la longitud de la matriz.  Como antes, las líneas azules indican la dirección del flujo de datos, y las líneas rojas indican el flujo de control. </p><br><p>  Ahora puede ver por qué esta estructura de datos a veces se llama <em>mar de nodos</em> o <em>sopa de nodos</em> . </p><br><p>  Quiero decir que C2 utiliza una estructura de datos muy similar y, de hecho, fue C2 que popularizó la idea de un compilador de un <em>mar de nodos</em> , por lo que esto no es una innovación de Graal. </p><br><p>  No mostraré el proceso de construcción de este gráfico hasta la siguiente parte de la presentación, pero cuando Graal recibe el programa en este formato, la optimización y la compilación se realizan modificando esta estructura de datos.  Y esta es una de las razones por las cuales escribir un compilador JIT en Java tiene sentido.  Java es un lenguaje orientado a objetos, y un gráfico es una colección de objetos conectados por bordes en forma de enlaces. </p><br><h2 id="ot-baytkoda-k-mashinnomu-kodu">  Del código de bytes al código de máquina </h2><br><p>  Veamos cómo se ven estas ideas en la práctica y sigamos algunos pasos del proceso de compilación. </p><br><h3 id="poluchenie-baytkoda">  Obteniendo Bytecode </h3><br><p>  La compilación comienza con bytecode.  Volvamos a nuestro pequeño ejemplo de resumen. </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a + b; }</code> </pre> <br><p>  Emitiremos el código de bytes recibido en la entrada justo antes del inicio de la compilación. </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HotSpotGraalCompiler</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JVMCICompiler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">CompilationRequestResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compileMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CompilationRequest request)</span></span></span><span class="hljs-function"> </span></span>{ System.err.println(request.getMethod().getName() + <span class="hljs-string"><span class="hljs-string">" bytecode: "</span></span> + Arrays.toString(request.getMethod().getCode())); ... } }</code> </pre> <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">workload</span></span> bytecode: [<span class="hljs-number"><span class="hljs-number">26</span></span>, <span class="hljs-number"><span class="hljs-number">27</span></span>, <span class="hljs-number"><span class="hljs-number">96</span></span>, -<span class="hljs-number"><span class="hljs-number">84</span></span>]</code> </pre> <br><p>  Como puede ver, la entrada al compilador es bytecode. </p><br><h3 id="parser-baytkoda-i-postroitel-grafa">  Analizador de código de bytes y generador de gráficos </h3><br><p>  <em>El constructor</em> , al percibir esta matriz de bytes como el código de bytes JVM, la convierte en un gráfico de Graal.  Este es un tipo de <em>interpretación abstracta</em> : el constructor interpreta el código de bytes de Java, pero, en lugar de pasar valores, manipula los extremos libres de los bordes y los conecta gradualmente entre sí. </p><br><p>  Aprovechemos el hecho de que Graal está escrito en Java y veamos cómo funciona usando las herramientas de navegación de Eclipse.  Sabemos que en nuestro ejemplo hay un nodo de suma, así que busquemos dónde se crea. </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/parser-1.png" alt="Addnode"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/parser-2.png" alt="Llamadas de búsqueda AddNode.create"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/parser-3.png" alt="Analizador"></p><br><p>  Se puede ver que son creados por el analizador de bytecode, y esto nos llevó al <code>IADD</code> procesamiento de <code>IADD</code> ( <code>96</code> , que vimos en la matriz de entrada impresa). </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">genArithmeticOp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JavaKind kind, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> opcode)</span></span></span><span class="hljs-function"> </span></span>{ ValueNode y = frameState.pop(kind); ValueNode x = frameState.pop(kind); ValueNode v; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (opcode) { ... <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> LADD: v = genIntegerAdd(x, y); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; ... } frameState.push(kind, append(v)); }</code> </pre> <br><p>  Dije anteriormente que esta es una interpretación abstracta, porque  Todo esto es muy similar a un intérprete de bytecode.  Si se tratara de un verdadero intérprete de JVM, tomaría dos valores de la pila, realizaría la suma y devolvería el resultado.  En este caso, eliminamos dos nodos de la pila, que, cuando se inicia el programa, serán cálculos, sumar, que es el resultado de la suma, un nuevo nodo para sumar, y colocarlo en la pila. </p><br><p>  Así se construye el gráfico Graal. </p><br><h3 id="poluchenie-mashinnogo-koda">  Obtener el código de la máquina </h3><br><p>  Para convertir un gráfico de Graal a código de máquina, debe generar bytes para todos sus nodos.  Esto se hace por separado para cada nodo llamando a su método de <code>generate</code> . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">generate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Generator gen)</span></span></span><span class="hljs-function"> </span></span>{ gen.emitAdd(a, b); }</code> </pre> <br><p>  Repito, aquí trabajamos a un nivel muy alto de abstracción.  Tenemos una clase con la que emitimos instrucciones de código de máquina sin entrar en detalles de cómo funciona esto. </p><br><p>  <code>emitAdd</code>       ,          , ,  ,       .      . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a + <span class="hljs-number"><span class="hljs-number">1</span></span>; }</code> </pre> <br><p>       ,        . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">incl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Register dst)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> encode = prefixAndEncode(dst.encoding); emitByte(<span class="hljs-number"><span class="hljs-number">0xFF</span></span>); emitByte(<span class="hljs-number"><span class="hljs-number">0xC0</span></span> | encode); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">emitByte</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b)</span></span></span><span class="hljs-function"> </span></span>{ data.put((<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>) (b &amp; <span class="hljs-number"><span class="hljs-number">0xFF</span></span>)); }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/incl.png" alt="Instrucciones de montaje en ensamblador"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/emit-byte.png" alt="Salida de bytes"></p><br><p>  ,    ,     <code>ByteBuffer</code> —    . </p><br><h3 id="vyhodnoy-mashinnyy-kod">    </h3><br><p>               —       . </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HotSpotGraalCompiler</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JVMCICompiler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">CompilationResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compileHelper</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(...)</span></span></span><span class="hljs-function"> </span></span>{ ... System.err.println(method.getName() + <span class="hljs-string"><span class="hljs-string">" machine code: "</span></span> + Arrays.toString(result.getTargetCode())); ... } }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/machine-code.png" alt="Código de máquina de impresión"></p><br><p>           .    HotSpot.     .     OpenJDK, , -,     JVM,      . </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> cd openjdk/hotspot/src/share/tools/hsdis <span class="hljs-variable"><span class="hljs-variable">$</span></span> curl <span class="hljs-literal"><span class="hljs-literal">-O</span></span> http://ftp.heanet.ie/mirrors/gnu/binutils/binutils<span class="hljs-literal"><span class="hljs-literal">-2</span></span>.<span class="hljs-number"><span class="hljs-number">24</span></span>.tar.gz <span class="hljs-variable"><span class="hljs-variable">$</span></span> tar <span class="hljs-literal"><span class="hljs-literal">-xzf</span></span> binutils<span class="hljs-literal"><span class="hljs-literal">-2</span></span>.<span class="hljs-number"><span class="hljs-number">24</span></span>.tar.gz <span class="hljs-variable"><span class="hljs-variable">$</span></span> make BINUTILS=binutils<span class="hljs-literal"><span class="hljs-literal">-2</span></span>.<span class="hljs-number"><span class="hljs-number">24</span></span> ARCH=amd64 CFLAGS=<span class="hljs-literal"><span class="hljs-literal">-Wno</span></span><span class="hljs-literal"><span class="hljs-literal">-error</span></span> <span class="hljs-variable"><span class="hljs-variable">$</span></span> cp build/macosx<span class="hljs-literal"><span class="hljs-literal">-amd64</span></span>/hsdis<span class="hljs-literal"><span class="hljs-literal">-amd64</span></span>.dylib ../../../../../..</code> </pre> <br><p>      : <code>-XX:+UnlockDiagnosticVMOptions</code>  <code>-XX:+PrintAssembly</code> . </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> java \ -<span class="hljs-literal"><span class="hljs-literal">-module</span></span><span class="hljs-literal"><span class="hljs-literal">-path</span></span>=graal/sdk/mxbuild/modules/org.graalvm.graal_sdk.jar:graal/truffle/mxbuild/modules/com.oracle.truffle.truffle_api.jar \ -<span class="hljs-literal"><span class="hljs-literal">-upgrade</span></span><span class="hljs-literal"><span class="hljs-literal">-module</span></span><span class="hljs-literal"><span class="hljs-literal">-path</span></span>=graal/compiler/mxbuild/modules/jdk.internal.vm.compiler.jar \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+UnlockExperimentalVMOptions \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+EnableJVMCI \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+UseJVMCICompiler \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:<span class="hljs-literal"><span class="hljs-literal">-TieredCompilation</span></span> \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+PrintCompilation \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+UnlockDiagnosticVMOptions \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+PrintAssembly \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:CompileOnly=Demo::workload \ Demo</code> </pre> <br><p>             . </p><br><pre> <code class="hljs perl">workload machine code: [<span class="hljs-number"><span class="hljs-number">15</span></span>, <span class="hljs-number"><span class="hljs-number">31</span></span>, <span class="hljs-number"><span class="hljs-number">68</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, -<span class="hljs-number"><span class="hljs-number">14</span></span>, -<span class="hljs-number"><span class="hljs-number">117</span></span>, -<span class="hljs-number"><span class="hljs-number">58</span></span>, -<span class="hljs-number"><span class="hljs-number">123</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, ...] ... <span class="hljs-number"><span class="hljs-number">0x000000010f71cda0</span></span>: nopl <span class="hljs-number"><span class="hljs-number">0x0</span></span>(%rax,%rax,<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">0x000000010f71cda5</span></span>: add %edx,%esi ;\*iadd {reexecute=<span class="hljs-number"><span class="hljs-number">0</span></span> rethrow=<span class="hljs-number"><span class="hljs-number">0</span></span> return_oop=<span class="hljs-number"><span class="hljs-number">0</span></span>} ; - Demo::workload@2 (line <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-number"><span class="hljs-number">0x000000010f71cda7</span></span>: mov %esi,%eax ;\*ireturn {reexecute=<span class="hljs-number"><span class="hljs-number">0</span></span> rethrow=<span class="hljs-number"><span class="hljs-number">0</span></span> return_oop=<span class="hljs-number"><span class="hljs-number">0</span></span>} ; - Demo::workload@3 (line <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-number"><span class="hljs-number">0x000000010f71cda9</span></span>: test %eax,-<span class="hljs-number"><span class="hljs-number">0xcba8da9</span></span>(%rip) <span class="hljs-comment"><span class="hljs-comment"># 0x0000000102b74006 ; {poll_return} 0x000000010f71cdaf: vzeroupper 0x000000010f71cdb2: retq</span></span></code> </pre> <br><p> .  ,           .    <code>generate</code>   ,         . </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AddNode</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">generate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(...)</span></span></span><span class="hljs-function"> </span></span>{ ... gen.emitSub(op1, op2, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) ... <span class="hljs-comment"><span class="hljs-comment">// changed from emitAdd } }</span></span></code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/emit-add.png" alt="Problema de la instrucción AddNode"></p><br><p>    ,  ,      ,      . </p><br><pre> <code class="hljs perl">workload mechine code: [<span class="hljs-number"><span class="hljs-number">15</span></span>, <span class="hljs-number"><span class="hljs-number">31</span></span>, <span class="hljs-number"><span class="hljs-number">68</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">43</span></span>, -<span class="hljs-number"><span class="hljs-number">14</span></span>, -<span class="hljs-number"><span class="hljs-number">117</span></span>, -<span class="hljs-number"><span class="hljs-number">58</span></span>, -<span class="hljs-number"><span class="hljs-number">123</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, ...] <span class="hljs-number"><span class="hljs-number">0x0000000107f451a0</span></span>: nopl <span class="hljs-number"><span class="hljs-number">0x0</span></span>(%rax,%rax,<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">0x0000000107f451a5</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> %</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">edx</span></span></span><span class="hljs-function">,%</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">esi</span></span></span><span class="hljs-function"> </span></span>;\*iadd {reexecute=<span class="hljs-number"><span class="hljs-number">0</span></span> rethrow=<span class="hljs-number"><span class="hljs-number">0</span></span> return_oop=<span class="hljs-number"><span class="hljs-number">0</span></span>} ; - Demo::workload@2 (line <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-number"><span class="hljs-number">0x0000000107f451a7</span></span>: mov %esi,%eax ;\*ireturn {reexecute=<span class="hljs-number"><span class="hljs-number">0</span></span> rethrow=<span class="hljs-number"><span class="hljs-number">0</span></span> return_oop=<span class="hljs-number"><span class="hljs-number">0</span></span>} ; - Demo::workload@3 (line <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-number"><span class="hljs-number">0x0000000107f451a9</span></span>: test %eax,-<span class="hljs-number"><span class="hljs-number">0x1db81a9</span></span>(%rip) <span class="hljs-comment"><span class="hljs-comment"># 0x000000010618d006 ; {poll_return} 0x0000000107f451af: vzeroupper 0x0000000107f451b2: retq</span></span></code> </pre> <br><p> ,   ? Graal     ;         ;       ;    .  ,       Graal. </p><br><pre> <code class="hljs powershell">[<span class="hljs-number"><span class="hljs-number">26</span></span>, <span class="hljs-number"><span class="hljs-number">27</span></span>, <span class="hljs-number"><span class="hljs-number">96</span></span>, -<span class="hljs-number"><span class="hljs-number">84</span></span>] → [<span class="hljs-number"><span class="hljs-number">15</span></span>, <span class="hljs-number"><span class="hljs-number">31</span></span>, <span class="hljs-number"><span class="hljs-number">68</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">43</span></span>, -<span class="hljs-number"><span class="hljs-number">14</span></span>, -<span class="hljs-number"><span class="hljs-number">117</span></span>, -<span class="hljs-number"><span class="hljs-number">58</span></span>, -<span class="hljs-number"><span class="hljs-number">123</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-type"><span class="hljs-type">...</span></span>]</code> </pre> <br><h2 id="optimizaciya">  </h2><br><p>  ,     ,        .       Graal  ,    . </p><br><p> <em> </em> —          .      . </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Phase</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Graph graph)</span></span></span></span>; }</code> </pre> <br><h3 id="kanonikalizaciya-canonicalisation">  (canonicalisation) </h3><br><p> <em></em>      .       ,       ,      <em> </em> ( <em>constant folding</em> )   . </p><br><p>       —       <code>canonical</code> . </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Node</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">Node </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">canonical</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; }</code> </pre> <br><p> ,  ,    ,      .                  —    .    <code>-(-x)</code>  <code>x</code> . </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NegateNode</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Node</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">Node </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">canonical</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> NegateNode) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ((NegateNode) value).getValue(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } } }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/negate-node.png" alt="findSynonym en NegateNode"></p><br><p>       Graal   . ,       . </p><br><p>           Java,       <code>canonical</code> . </p><br><h3 id="global-value-numbering"> Global value numbering </h3><br><p> <em>Global value numbering (GVN)</em> —       .    <code>a + b</code>    ,   — . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (a + b) * (a + b); }</code> </pre> <br><p> Graal     .   —        .   GVN         .        <em>hash map</em>  ,  ,  . </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/gvn.png" alt="Numeración de valor global"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/gvn-igv-1.png" alt="Gráfico de numeración de valor global"></p><br><p>    ,   <em></em> —  ,      ,     -  .  ,  ,  ,       ,      — . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (getA() + getB()) * (getA() + getB()); }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/gvn-igv-2.png" alt="Un gráfico que no puede tener un valor global numerado"></p><br><h3 id="ukrupnenie-blokirovok-lock-coarsening">   (lock coarsening) </h3><br><p>     .               <em></em> . ,     ,      ,   <em></em> ( <em>inlining</em> ). </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">synchronized</span></span> (monitor) { counter++; } <span class="hljs-keyword"><span class="hljs-keyword">synchronized</span></span> (monitor) { counter++; } }</code> </pre> <br><p>   ,   , , , . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ monitor.enter(); counter++; monitor.exit(); monitor.enter(); counter++; monitor.exit(); }</code> </pre> <br><p>                    .    <em> </em> . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ monitor.enter(); counter++; counter++; monitor.exit(); }</code> </pre> <br><p>  Graal       <code>LockEliminationPhase</code> .   <code>run</code>      ,         .  ,        ,           . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(StructuredGraph graph)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (monitorExitNode monitorExitNode : graph.getNodes(MonitorExitNode.class)) { FixedNode next = monitorExitNode.next(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (next <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> monitorEnterNode) { AccessmonitorNode monitorEnterNode = (AccessmonitorNode) next; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (monitorEnterNode.object() ## monitorExitNode.object()) { monitorExitNode.remove(); monitorEnterNode.remove(); } } } }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/lock-elimination.png" alt="Simplificación de bloqueo"></p><br><p>            , , ,      ,          <code>2</code> . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ monitor.enter(); counter += <span class="hljs-number"><span class="hljs-number">2</span></span>; monitor.exit(); }</code> </pre> <br><p>    IGV   .  ,   ,       \   ,  , ,        <code>2</code> . </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/lock-elimination-before.png" alt="Simplifique las cerraduras a"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/lock-elimination-after.png" alt="Simplifica los bloqueos después"></p><br><h2 id="ne-zatronutye-prakticheskie-aspekty">     </h2><br><p>   Graal   ,  ,      ,          . , , ,          . </p><br><p>       Graal   ,  , ,         ,    ,  ,    . </p><br><h3 id="naznachenie-registrov">   </h3><br><p>    Graal      ,   ,  .        ?          ,      ? </p><br><p> ,  ,    .      .       ,      , ,   ,    .        ,  ,  ,             , ,  . </p><br><p>        <em> </em> ( <em>register allocation</em> ). Graal ,    JIT-,    — <em>  </em> ( <em>linear scan algorithm</em> ). </p><br><h3 id="dispetcherizaciya">  </h3><br><p>    ,     ,   ,        -    ,         . </p><br><p> ,       ,   , ,         (..     ),        . ,    ,     . </p><br><p>    <em> </em> ( <em>graph scheduling</em> ).       .       ,          .       ,      , ,        . </p><br><p>                ,     . </p><br><h2 id="v-kakih-sluchayah-ispolzovat-graal">     Graal? </h2><br><p>        , ,   , Graal —   ,       <em>Oracle</em> .      ,    Graal? </p><br><h3 id="kompilyator-nizhnego-urovnya-final-tier-compiler">    (final-tier compiler) </h3><br><p> C  JVMCI Graal    <em>  </em>  HotSpot — ,     .     (   HotSpot)   Graal    ,    . </p><br><p> <em>Twitter</em>       Graal   ,    Java 9           .       : <code>-XX:+UseJVMCICompiler</code>  . </p><br><p>    JVMCI   ,      Graal   JVM.    (deploy) -  JVM,      Graal.      Java-,   Graal,       JVM. </p><br><p>  OpenJDK   <em>Metropolis</em>       JVM   Java. Graal        . </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/metropolis.png" alt="Proyecto Metrópolis"></p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">http://cr.openjdk.java.net/\~jrose/metropolis/Metropolis-Proposal.html</a> </p><br><h3 id="polzovatelskie-optimizacii">   </h3><br><p> Graal    .    Graal   JVM,     Graal   .           ,  Graal       . ,     -     ,    ,                 JNI. </p><br><p> Charles Nutter      <em>JRuby</em>         Graal       Ruby. ,        - . </p><br><h3 id="aot-ahead-of-time-kompilyaciya"> AOT (ahead-of-time)  </h3><br><p> Graal —    Java. JVMCI  ,  Graal,    ,     ,    Graal     .  ,     Graal    ,     JIT-. </p><br><p>     JIT-  AOT-      ,  Graal     .       AOT   Graal. </p><br><p> Java 9              JIT-,     .        JVM,          . </p><br><p> AOT Java 9     Graal,       Linux.            ,  ,            . </p><br><p>    . <em>SubstrateVM</em> —  AOT-,   Java-    JVM  . ,     - (statically linked)  .    JVM  ,         .     SubstrateVM  Graal.          ( <em>just-in-time</em> ) SubstrateVM, ,   Graal  .   Graal AOT-  . </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> javac Hello.java <span class="hljs-variable"><span class="hljs-variable">$</span></span> graalvm<span class="hljs-literal"><span class="hljs-literal">-0</span></span>.<span class="hljs-number"><span class="hljs-number">28.2</span></span>/bin/native<span class="hljs-literal"><span class="hljs-literal">-image</span></span> Hello classlist: <span class="hljs-number"><span class="hljs-number">966.44</span></span> ms (cap): <span class="hljs-number"><span class="hljs-number">804.46</span></span> ms setup: <span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">514.31</span></span> ms (typeflow): <span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">580.70</span></span> ms (objects): <span class="hljs-number"><span class="hljs-number">719.04</span></span> ms (features): <span class="hljs-number"><span class="hljs-number">16.27</span></span> ms analysis: <span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">422.58</span></span> ms universe: <span class="hljs-number"><span class="hljs-number">262.09</span></span> ms (parse): <span class="hljs-number"><span class="hljs-number">528.44</span></span> ms (inline): <span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">259.94</span></span> ms (compile): <span class="hljs-number"><span class="hljs-number">6</span></span>,<span class="hljs-number"><span class="hljs-number">716.20</span></span> ms compile: <span class="hljs-number"><span class="hljs-number">8</span></span>,<span class="hljs-number"><span class="hljs-number">817.97</span></span> ms image: <span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">070.29</span></span> ms debuginfo: <span class="hljs-number"><span class="hljs-number">672.64</span></span> ms write: <span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">797.45</span></span> ms [<span class="hljs-type"><span class="hljs-type">total</span></span>]: <span class="hljs-number"><span class="hljs-number">17</span></span>,<span class="hljs-number"><span class="hljs-number">907.56</span></span> ms <span class="hljs-variable"><span class="hljs-variable">$</span></span> ls <span class="hljs-literal"><span class="hljs-literal">-lh</span></span> hello <span class="hljs-literal"><span class="hljs-literal">-rwxr</span></span><span class="hljs-literal"><span class="hljs-literal">-xr</span></span><span class="hljs-literal"><span class="hljs-literal">-x</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> chrisseaton staff <span class="hljs-number"><span class="hljs-number">6.6</span></span>M <span class="hljs-number"><span class="hljs-number">4</span></span> Oct <span class="hljs-number"><span class="hljs-number">18</span></span>:<span class="hljs-number"><span class="hljs-number">35</span></span> hello <span class="hljs-variable"><span class="hljs-variable">$</span></span> file ./hello ./hellojava: Mach<span class="hljs-literal"><span class="hljs-literal">-O</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span><span class="hljs-literal"><span class="hljs-literal">-bit</span></span> executable x86_64 <span class="hljs-variable"><span class="hljs-variable">$</span></span> time ./hello Hello! real <span class="hljs-number"><span class="hljs-number">0</span></span>m0.<span class="hljs-number"><span class="hljs-number">010</span></span>s user <span class="hljs-number"><span class="hljs-number">0</span></span>m0.<span class="hljs-number"><span class="hljs-number">003</span></span>s sys <span class="hljs-number"><span class="hljs-number">0</span></span>m0.<span class="hljs-number"><span class="hljs-number">003</span></span>s</code> </pre> <br><h3 id="truffle"> Truffle </h3><br><p>     Graal      <em>Truffle</em> . Truffle —         JVM. </p><br><p>  ,   JVM,  ,   JIT-   (,    ,   ,  JIT- JVM    ,        ). Truffle    —       ,   ,  Truffle, ,              <em> </em> ( <em>partial evaluation</em> ). </p><br><p>         ,             <em> </em> ( <em>inlining</em> )  <em> </em> ( <em>constant folding</em> )      . Graal       ,  Truffle       . </p><br><p>       Graal —  Truffle.       Ruby,   <em>TruffleRuby</em>    Truffle , , Graal. TruffleRuby —     Ruby,   10   , ,  ,        . </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://github.com/graalvm/truffleruby</a> </p><br><h2 id="vyvody">  Conclusiones </h2><br><p>  ,      ,   ,   JIT- Java         . JIT-   ,          , , -           . ,  ,   .   JIT-    ,   <code>byte[]</code>  JVM  <code>byte[]</code>  . </p><br><p>  ,       Java.           ,   C++. </p><br><p> Java- Graal   - .   ,    ,            . </p><br><p>          .        ,        Eclipse     .           (definitions),     ..    . </p><br><p>          JIT      JIT- JVM,   <em>JITWatch</em> ,   ,        Graal     ,   . ,   ,  -       ,     Graal     JVM.         IDE,       <em>hello-world</em> . </p><br><p>         SubstrateVM  Truffle,   Graal,     ,     Java  .     ,   Graal    Java.  ,    ,   -  <em>LLVM</em> ,    , ,   ,     . </p><br><p> , ,       Graal      JVM.  Porque JVMCI   Java 9, Graal      ,  ,    Java-. </p><br><p> Graal —        .    ,      Graal.    ,      ! </p><br><hr><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">More information about TruffleRuby</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Low Overhead Polling For Ruby</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Top 10 Things To Do With GraalVM</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Ruby Objects as C Structs and Vice Versa</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Understanding How Graal Works — a Java JIT Compiler Written in Java</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Flip-Flops — the 1-in-10-million operator</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Deoptimizing Ruby</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Very High Performance C Extensions For JRuby+Truffle</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Optimising Small Data Structures in JRuby+Truffle</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Pushing Pixels with JRuby+Truffle</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Tracing With Zero Overhead in JRuby+Truffle</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">How Method Dispatch Works in JRuby+Truffle</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">A Truffle/Graal High Performance Backend for JRuby</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es419637/">https://habr.com/ru/post/es419637/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es419623/index.html">"ELLA": cómo se nos ocurrieron imágenes de inteligencia artificial</a></li>
<li><a href="../es419625/index.html">Descripción general de mis características favoritas de PHP7</a></li>
<li><a href="../es419627/index.html">Estamos buscando oradores en Moscú Data Science Major</a></li>
<li><a href="../es419633/index.html">Ahora, Let's Encrypt confía en todas las principales listas de certificados raíz</a></li>
<li><a href="../es419635/index.html">Lanzamiento de la versión estable de Dart 2.0 y Dart Web Platform</a></li>
<li><a href="../es419641/index.html">Crear una IA simple de C # en Unity</a></li>
<li><a href="../es419643/index.html">Conferencia de Ingeniería de Software EPAM de Minsk: Hazlo Real</a></li>
<li><a href="../es419647/index.html">Seminario “Viernes negro en comercio electrónico. Secretos de supervivencia, 16 de agosto, Moscú</a></li>
<li><a href="../es419649/index.html">Un poco sobre los gatos, o qué CAT elegimos para los podcasts de sincronización</a></li>
<li><a href="../es419651/index.html">Ni GA ni YM. Cómo hicimos nuestro propio clickstream</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>