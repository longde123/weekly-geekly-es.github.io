<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöà üéÆ ü§≥üèº [Traducci√≥n] C√≥mo funciona Graal - Compilador JVM JVM de Java ‚ò¶Ô∏è ü•ù üçî</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola Habr! Le presento la traducci√≥n del art√≠culo " Comprender c√≥mo funciona Graal: un compilador JIT de Java escrito en Java ". 
 Introduccion 


 Un...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>[Traducci√≥n] C√≥mo funciona Graal - Compilador JVM JVM de Java</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/419637/"><p> Hola Habr!  Le presento la traducci√≥n del art√≠culo " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Comprender c√≥mo funciona Graal: un compilador JIT de Java escrito en Java</a> ". </p><br><h2 id="vvedenie">  Introduccion </h2><br><p>  Una de las razones por las cuales me convert√≠ en investigador en lenguajes de programaci√≥n es que, en una gran comunidad de personas involucradas en tecnolog√≠a inform√°tica, casi todos usan lenguajes de programaci√≥n, y muchos est√°n interesados ‚Äã‚Äãen c√≥mo funcionan.  Cuando conoc√≠ la programaci√≥n cuando era ni√±o y me familiaric√© con un lenguaje de programaci√≥n, lo primero que quer√≠a saber era c√≥mo funciona, y lo primero que quer√≠a hacer era crear mi propio lenguaje. </p><br><p>  En esta presentaci√≥n, le mostrar√© algunos de los mecanismos de trabajo del lenguaje que todos usan: Java.  La peculiaridad es que <em>usar√©</em> un proyecto llamado <em>Graal</em> , que implementa el concepto de <em>Java en Java</em> . </p><a name="habracut"></a><br><p>  Graal es solo uno de los componentes en el trabajo de Java: es un compilador <em>justo a tiempo</em> .  Esta es la parte de la JVM que convierte el bytecode de Java en c√≥digo de m√°quina durante la ejecuci√≥n del programa, y ‚Äã‚Äães uno de los factores que aseguran un alto rendimiento de la plataforma.  Tambi√©n es, me parece, lo que la mayor√≠a de las personas considera una de las partes m√°s complejas y vagas de la JVM, que est√° m√°s all√° de su comprensi√≥n.  Cambiar esta opini√≥n es el prop√≥sito de este discurso. </p><br><p>  Si sabes lo que es una JVM;  generalmente entiendo qu√© significan los t√©rminos <em>bytecode</em> y <em>machine code</em>  y capaz de leer c√≥digo escrito en Java, entonces, espero, esto ser√° suficiente para entender el material presentado. </p><br><p>  Comenzar√© discutiendo por qu√© podr√≠amos querer un nuevo compilador JIT para la JVM escrito en Java, y luego mostrar√© que no hay nada m√°s especial en esto, como podr√≠a pensar, al dividir la tarea en ensamblador, uso y demostraci√≥n de compilaci√≥n. que su c√≥digo es el mismo que en cualquier otra aplicaci√≥n. </p><br><p>  Tocar√© un poco la teor√≠a y luego mostrar√© c√≥mo se aplica durante todo el proceso de compilaci√≥n, desde el c√≥digo de bytes hasta el c√≥digo de m√°quina.  Tambi√©n mostrar√© algunos detalles, y al final hablaremos sobre los beneficios de esta caracter√≠stica adem√°s de implementar <em>Java en Java</em> por s√≠ mismo. </p><br><p>  Usar√© las capturas de pantalla del c√≥digo en Eclipse, en lugar de lanzarlas durante la presentaci√≥n, para evitar los problemas inevitables de la codificaci√≥n en vivo. </p><br><h2 id="chto-takoe-jit-kompilyator">  ¬øQu√© es un compilador JIT? </h2><br><p>  Estoy seguro de que muchos de ustedes saben lo que es un compilador JIT, pero a√∫n voy a tocar los conceptos b√°sicos para que nadie est√© sentado aqu√≠ con miedo de hacer esta pregunta principal. </p><br><p> Cuando ejecuta el comando <code>javac</code> o <em>compile-on-save</em> en el IDE, su programa Java compila del c√≥digo Java al c√≥digo de bytes JVM, que es la representaci√≥n binaria del programa.  Es m√°s compacto y simple que el c√≥digo fuente de Java.  Sin embargo, el procesador normal de su computadora port√°til o servidor no puede simplemente ejecutar el c√≥digo de bytes JVM. </p><br><p>  Para el funcionamiento de su programa, la JVM interpreta este c√≥digo de bytes.  Los int√©rpretes suelen ser mucho m√°s lentos que el c√≥digo de m√°quina que se ejecuta en el procesador.  Por esta raz√≥n, la JVM, mientras el programa se est√° ejecutando, puede lanzar otro compilador que convierte su c√≥digo de bytes en c√≥digo de m√°quina, que el procesador ya puede ejecutar. </p><br><p>  Este compilador, generalmente mucho m√°s sofisticado que <code>javac</code> , realiza optimizaciones complejas para producir c√≥digo de m√°quina de alta calidad como resultado. </p><br><h2 id="zachem-pisat-jit-kompilyator-na-java">  ¬øPor qu√© escribir un compilador JIT en Java? </h2><br><p>  Hasta la fecha, una implementaci√≥n de JVM llamada <em>OpenJDK</em> incluye dos compiladores JIT principales.  El compilador del cliente, conocido como <em>C1</em> , est√° dise√±ado para una operaci√≥n m√°s r√°pida, pero al mismo tiempo produce un c√≥digo menos optimizado.  El compilador del servidor, conocido como <em>opto</em> o <em>C2</em> , requiere un poco m√°s de tiempo para funcionar, pero produce un c√≥digo m√°s optimizado. </p><br><p>  La idea era que el compilador del cliente era m√°s adecuado para aplicaciones de escritorio, donde las pausas largas en el compilador JIT no eran deseables, y el compilador del servidor para aplicaciones de servidor de larga duraci√≥n, que podr√≠an pasar m√°s tiempo compilando. </p><br><p>  Hoy se pueden combinar para que C1 compile primero el c√≥digo y luego, si contin√∫a ejecut√°ndose intensamente y tiene sentido gastar tiempo adicional, - C2.  Esto se llama <em>compilaci√≥n escalonada</em> . </p><br><p>  Hablemos de C2, el compilador del servidor que realiza m√°s optimizaciones. </p><br><p>  Podemos clonar OpenJDK desde el espejo en <em>GitHub</em> , o simplemente abrir el √°rbol del proyecto en el sitio. </p><br><pre> <code class="hljs ruby">$ git clone <span class="hljs-symbol"><span class="hljs-symbol">https:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/github.com/dmlloyd</span></span><span class="hljs-regexp"><span class="hljs-regexp">/openjdk.git</span></span></code> </pre> <br><p>  El c√≥digo C2 est√° en <em>openjdk / hotspot / src / share / vm / opto</em> . </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/c2.png" alt="C√≥digo fuente c2"></p><br><p>  En primer lugar, vale la pena se√±alar que C2 est√° escrito en <em>C ++</em> .  Por supuesto, esto no es algo malo, pero hay ciertas desventajas.  C ++ es un lenguaje inseguro.  Esto significa que los errores en C ++ pueden bloquear la VM.  La raz√≥n de esto es probablemente la antig√ºedad del c√≥digo, pero el c√≥digo C2 C ++ se ha vuelto muy dif√≠cil de mantener y desarrollar. </p><br><p>  Una de las figuras clave detr√°s del compilador de C2, Cliff Click dijo que nunca m√°s volver√≠a a escribir VM en C ++, y escuchamos al equipo de <em>Twitter</em> JVM decir que C2 se estanc√≥ y necesita ser reemplazado por alguna raz√≥n. dificultades de mayor desarrollo. </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/click-1.jpeg" alt="Presentaci√≥n de cliff click"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/click-2.png" alt="Lo que Cliff Click no quiere volver a hacer"></p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://www.youtube.com/watch?v=Hqw57GJSrac</a> </p><br><p>  Entonces, volviendo a la pregunta, ¬øqu√© es esto en Java que puede ayudar a resolver estos problemas?  Lo mismo que da escribir un programa en Java en lugar de C ++.  Probablemente sea seguridad (excepciones en lugar de bloqueos, sin p√©rdida de memoria real o punteros colgantes), buenos <em>ayudantes</em> (depuradores, perfiladores y herramientas como <em>VisualVM</em> ), buen soporte IDE, etc. </p><br><p>  Puede pensar: <em>¬øc√≥mo puedo escribir algo como un compilador JIT de Java?</em>  , y que esto solo es posible en un lenguaje de programaci√≥n de sistema de bajo nivel como C ++.  ¬°En esta presentaci√≥n, espero convencerlos de que esto no es en absoluto!  Esencialmente, el compilador JIT solo debe aceptar el c√≥digo de <code>byte[]</code> JVM y entregar el c√≥digo de la m√°quina; usted le da el <code>byte[]</code> en la entrada y tambi√©n desea recuperar el <code>byte[]</code> .  Se necesita mucho trabajo complejo para hacer esto, pero no afecta el nivel del sistema y, por lo tanto, no requiere un lenguaje del <em>sistema</em> como C o C ++. </p><br><h2 id="nastroyka-graal">  Configuraci√≥n de Graal </h2><br><p>  Lo primero que necesitamos es Java 9. La interfaz de Graal llamada <em>JVMCI utilizada</em> se agreg√≥ a Java como parte de la <em>interfaz del compilador JVM de nivel Java JEP 243,</em> y la primera versi√≥n que la incluye es Java 9. Uso <em>9 + 181</em> .  En caso de requisitos especiales, hay puertos (backports) para Java 8. </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> export JAVA_HOME=`pwd`/jdk9 <span class="hljs-variable"><span class="hljs-variable">$</span></span> export PATH=<span class="hljs-variable"><span class="hljs-variable">$JAVA_HOME</span></span>/bin:<span class="hljs-variable"><span class="hljs-variable">$PATH</span></span> <span class="hljs-variable"><span class="hljs-variable">$</span></span> java <span class="hljs-literal"><span class="hljs-literal">-version</span></span> java version <span class="hljs-string"><span class="hljs-string">"9"</span></span> Java(TM) SE Runtime Environment (build <span class="hljs-number"><span class="hljs-number">9</span></span>+<span class="hljs-number"><span class="hljs-number">181</span></span>) Java HotSpot(TM) <span class="hljs-number"><span class="hljs-number">64</span></span><span class="hljs-literal"><span class="hljs-literal">-Bit</span></span> Server VM (build <span class="hljs-number"><span class="hljs-number">9</span></span>+<span class="hljs-number"><span class="hljs-number">181</span></span>, mixed mode)</code> </pre> <br><p>  Lo siguiente que necesitamos es un sistema de compilaci√≥n llamado <code>mx</code> .  Es un poco como <em>Maven</em> o <em>Gradle</em> , pero lo m√°s probable es que no lo elija para su aplicaci√≥n.  Implementa cierta funcionalidad para admitir algunos casos de uso complejos, pero la usaremos solo para ensamblajes simples. </p><br><p>  Puedes clonar <code>mx</code> con GitHub.  Estoy usando commit <code>#7353064</code> .  Ahora solo agregue el ejecutable a la ruta. </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> git clone https://github.com/graalvm/mx.git <span class="hljs-variable"><span class="hljs-variable">$</span></span> cd mx; git checkout <span class="hljs-number"><span class="hljs-number">7353064</span></span> <span class="hljs-variable"><span class="hljs-variable">$</span></span> export PATH=`pwd`/mx:<span class="hljs-variable"><span class="hljs-variable">$PATH</span></span></code> </pre> <br><p>  Ahora necesitamos clonar a Graal.  Estoy usando una distribuci√≥n llamada <em>GraalVM</em> versi√≥n <em>0.28.2</em> . </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> git clone https://github.com/graalvm/graal.git -<span class="hljs-literal"><span class="hljs-literal">-branch</span></span> vm<span class="hljs-literal"><span class="hljs-literal">-enterprise</span></span><span class="hljs-literal"><span class="hljs-literal">-0</span></span>.<span class="hljs-number"><span class="hljs-number">28.2</span></span></code> </pre> <br><p>  Este repositorio contiene otros proyectos en los que no estamos interesados, por lo que simplemente vamos al subproyecto del <em>compilador</em> , que es el compilador Graal JIT, y lo <code>mx</code> usando <code>mx</code> . </p><br><pre> <code class="hljs ruby">$ cd graal/compiler $ mx build</code> </pre> <br><p>  Para trabajar con el c√≥digo Graal, usar√© el <em>IDE de Eclipse</em> .  Estoy usando Eclipse 4.7.1.  <code>mx</code> puede generar archivos de proyecto de Eclipse para nosotros. </p><br><pre> <code class="hljs ruby">$ mx eclipseinit</code> </pre> <br><p>  Para abrir el directorio <em>graal</em> como un <em>espacio de trabajo,</em> debe ejecutar <em>Archivo, Importar ..., General, Proyectos existentes</em> y seleccionar <em>nuevamente el</em> directorio <em>graal</em> .  Si no ejecut√≥ Eclipse en Java 9, es posible que tambi√©n necesite adjuntar las fuentes JDK. </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/eclipse.png" alt="Graal en eclipse"></p><br><p>  Bueno  Ahora que todo est√° listo, veamos c√≥mo funciona.  Usaremos este c√≥digo muy simple. </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Demo</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { workload(<span class="hljs-number"><span class="hljs-number">14</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a + b; } }</code> </pre> <br><p>  Primero, compilamos este c√≥digo <code>javac</code> y luego ejecutamos la JVM.  Primero, le mostrar√© c√≥mo funciona el compilador JIT C2 est√°ndar.  Para hacer esto, especificaremos varios indicadores: <code>-XX:+PrintCompilation</code> , que es necesario para que la JVM escriba un registro al compilar un m√©todo, y <code>-XX:CompileOnly=Demo::workload</code> , para que solo este m√©todo se compile.  Si no lo hacemos, se mostrar√° demasiada informaci√≥n y la JVM ser√° m√°s inteligente de lo que necesitamos y optimizar√° el c√≥digo que queremos ver. </p><br><pre> <code class="hljs ruby">$ javac Demo.java $ java \ -<span class="hljs-symbol"><span class="hljs-symbol">XX:</span></span>+PrintCompilation \ -<span class="hljs-symbol"><span class="hljs-symbol">XX:</span></span>CompileOnly=Demo::workload \ Demo ... <span class="hljs-number"><span class="hljs-number">113</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> Demo::workload (<span class="hljs-number"><span class="hljs-number">4</span></span> bytes) ...</code> </pre> <br><p>  No explicar√© esto en detalle, pero solo dir√© que este es un resultado de registro que muestra que el m√©todo de <code>workload</code> sido compilado. </p><br><p>  Ahora, como compilador JIT de nuestra JVM Java 9, utilizamos el Graal reci√©n compilado.  Para hacer esto, agregue algunas banderas m√°s. </p><br><p>  <code>--module-path=...</code> y <code>--upgrade-module-path=...</code> agregan Graal a la <em>ruta del m√≥dulo</em> .  Perm√≠tame recordarle que la <em>ruta del m√≥dulo</em> apareci√≥ en Java 9 como parte del sistema de m√≥dulos <em>Jigsaw</em> , y para nuestros prop√≥sitos podemos considerarlo por analog√≠a con <em>classpath</em> . </p><br><p>  Necesitamos el <code>-XX:+UnlockExperimentalVMOptions</code> debido a que JVMCI (la interfaz utilizada por Graal) en esta versi√≥n es una caracter√≠stica experimental. </p><br><p>  La bandera <code>-XX:+EnableJVMCI</code> necesaria para decir que queremos usar JVMCI, y <code>-XX:+UseJVMCICompiler</code> - para habilitar e instalar un nuevo compilador JIT. </p><br><p>  Para no complicar el ejemplo, y, en lugar de utilizar C1 junto con JVMCI, tener solo el compilador JVMCI, especifique el indicador <code>-XX:-TieredCompilation</code> , que deshabilitar√° la compilaci√≥n por pasos. </p><br><p>  Como antes, especificamos las banderas <code>-XX:+PrintCompilation</code> y <code>-XX:CompileOnly=Demo::workload</code> . </p><br><p>  Como en el ejemplo anterior, vemos que se compil√≥ un m√©todo.  Pero, esta vez, para la compilaci√≥n utilizamos el ensamblado de Graal.  Por ahora, solo toma mi palabra. </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> java \ -<span class="hljs-literal"><span class="hljs-literal">-module</span></span><span class="hljs-literal"><span class="hljs-literal">-path</span></span>=graal/sdk/mxbuild/modules/org.graalvm.graal_sdk.jar:graal/truffle/mxbuild/modules/com.oracle.truffle.truffle_api.jar \ -<span class="hljs-literal"><span class="hljs-literal">-upgrade</span></span><span class="hljs-literal"><span class="hljs-literal">-module</span></span><span class="hljs-literal"><span class="hljs-literal">-path</span></span>=graal/compiler/mxbuild/modules/jdk.internal.vm.compiler.jar \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+UnlockExperimentalVMOptions \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+EnableJVMCI \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+UseJVMCICompiler \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:<span class="hljs-literal"><span class="hljs-literal">-TieredCompilation</span></span> \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+PrintCompilation \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:CompileOnly=Demo::workload \ Demo ... <span class="hljs-number"><span class="hljs-number">583</span></span> <span class="hljs-number"><span class="hljs-number">25</span></span> Demo::workload (<span class="hljs-number"><span class="hljs-number">4</span></span> bytes) ...</code> </pre> <br><h2 id="interfeys-kompilyatora-jvm">  Interfaz del compilador JVM </h2><br><p>  ¬øNo crees que hicimos algo bastante inusual?  Tenemos una JVM instalada, y reemplazamos el compilador JIT por uno nuevo compilado sin cambiar nada en la propia JVM.  Esta caracter√≠stica es proporcionada por una nueva interfaz JVM llamada JVMCI, la <em>interfaz del compilador JVM</em> , que, como dije anteriormente, era <em>JEP 243</em> y lleg√≥ en Java 9. </p><br><p>  La idea es similar a algunas otras tecnolog√≠as JVM existentes. </p><br><p>  Quiz√°s haya encontrado procesamiento de c√≥digo fuente adicional en <code>javac</code> utilizando la <em>API de procesamiento de anotaciones de Java</em> .  Este mecanismo permite identificar anotaciones y el modelo de c√≥digo fuente en el que se utilizan, y crear nuevos archivos basados ‚Äã‚Äãen ellas. </p><br><p>  Adem√°s, es posible que haya utilizado un procesamiento de c√≥digo de bytes adicional en la JVM utilizando <em>agentes Java</em> .  Este mecanismo le permite modificar el c√≥digo de bytes de Java intercept√°ndolo en el momento del arranque. </p><br><p>  La idea de JVMCI es similar.  Le permite conectar su propio compilador JIT de Java escrito en Java. </p><br><p>  Ahora quiero decir algunas palabras sobre c√≥mo mostrar√© el c√≥digo durante esta presentaci√≥n.  Primero, para comprender la idea, mostrar√© algunos identificadores y l√≥gica simplificados en forma de texto en diapositivas, y luego cambiar√© a capturas de pantalla de Eclipse y mostrar√© el c√≥digo real, que puede ser un poco m√°s complicado, pero la idea principal seguir√° siendo la misma.  La parte principal de esta presentaci√≥n est√° destinada a mostrar que es realmente posible trabajar con el c√≥digo real del proyecto y, por lo tanto, no quiero ocultarlo, aunque puede ser algo complicado. </p><br><p>  A partir de ahora, empiezo a disipar la opini√≥n de que podr√≠a tener que el compilador JIT es muy complicado. </p><br><p>  ¬øQu√© acepta el compilador JIT para la entrada?  Acepta el bytecode del m√©todo a compilar.  Y el bytecode, como su nombre lo indica, es solo una matriz de bytes. </p><br><p>  ¬øQu√© produce el compilador JIT como resultado?  Da el c√≥digo de m√°quina del m√©todo.  El c√≥digo de m√°quina tambi√©n es solo una matriz de bytes. </p><br><p>  Como resultado, la interfaz que debe implementarse al escribir un nuevo compilador JIT para incrustarlo en la JVM se ver√° m√°s o menos as√≠. </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JVMCICompiler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] compileMethod(<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] bytecode); }</code> </pre> <br><p>  Por lo tanto, si no puede imaginar c√≥mo Java puede hacer algo tan bajo como la compilaci√≥n JIT en c√≥digo m√°quina, ahora puede ver que este no es un trabajo de tan bajo nivel.  Derecho?  Esto es solo una funci√≥n del <code>byte[]</code> al <code>byte[]</code> . </p><br><p>  En realidad, todo es algo m√°s complicado.  Solo el bytecode no es suficiente; tambi√©n necesitamos m√°s informaci√≥n, como el n√∫mero de variables locales, el tama√±o de pila requerido y la informaci√≥n recopilada por el perfilador del int√©rprete para comprender c√≥mo se ejecuta el c√≥digo.  Por lo tanto, imagine la entrada en forma de <code>JavaMethod</code> de <code>CompilationRequest</code> , que nos informar√° sobre el <code>JavaMethod</code> que debe compilarse y proporcionar√° toda la informaci√≥n necesaria. </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JVMCICompiler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compileMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CompilationRequest request)</span></span></span></span>; } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CompilationRequest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">JavaMethod </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JavaMethod</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] getCode(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMaxLocals</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMaxStackSize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">ProfilingInfo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getProfilingInfo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; ... }</code> </pre> <br><p>  Adem√°s, la interfaz no requiere la devoluci√≥n del c√≥digo compilado.  En cambio, se usa otra API para instalar el c√≥digo de m√°quina en la JVM. </p><br><pre> <code class="java hljs">HotSpot.installCode(targetCode);</code> </pre> <br><p>  Ahora, para escribir un nuevo compilador JIT para JVM, solo necesita implementar esta interfaz.  Obtenemos informaci√≥n sobre el m√©todo que debe compilarse, y debemos compilarlo en c√≥digo m√°quina y llamar a <code>installCode</code> . </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GraalCompiler</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JVMCICompiler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compileMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CompilationRequest request)</span></span></span><span class="hljs-function"> </span></span>{ HotSpot.installCode(...); } }</code> </pre> <br><p>  Cambiemos al IDE de Eclipse con Graal y echemos un vistazo a algunas interfaces y clases reales.  Como se mencion√≥ anteriormente, ser√°n algo m√°s complicados, pero no por mucho. </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/jvmci-compiler-interface.png" alt="JVMCICompiler"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/hotspot-graal-compiler-1.png" alt="HotSpotGraalCompiler"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/hotspot-graal-compiler-2.png" alt="m√©todo de compilaci√≥n"></p><br><p>  Ahora quiero mostrar que podemos hacer cambios en Graal e inmediatamente usarlos en Java 9. Agregar√© un nuevo mensaje de registro que se mostrar√° al compilar el m√©todo usando Graal.  Agr√©guelo al m√©todo de interfaz implementado, que es llamado por JVMCI. </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HotSpotGraalCompiler</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JVMCICompiler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">CompilationRequestResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compileMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CompilationRequest request)</span></span></span><span class="hljs-function"> </span></span>{ System.err.println(<span class="hljs-string"><span class="hljs-string">"Going to compile "</span></span> + request.getMethod().getName()); ... } }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/hotspot-graal-compiler-3.png" alt="Compilaci√≥n"></p><br><p>  Por ahora, deshabilite el registro de compilaci√≥n en HotSpot.  Ahora podemos ver nuestro mensaje desde la versi√≥n modificada del compilador. </p><br><pre> <code class="java hljs">$ java \ --<span class="hljs-keyword"><span class="hljs-keyword">module</span></span>-path=graal/sdk/mxbuild/modules/org.graalvm.graal_sdk.jar:graal/truffle/mxbuild/modules/com.oracle.truffle.truffle_api.jar \ --upgrade-<span class="hljs-keyword"><span class="hljs-keyword">module</span></span>-path=graal/compiler/mxbuild/modules/jdk.internal.vm.compiler.jar \ -XX:+UnlockExperimentalVMOptions \ -XX:+EnableJVMCI \ -XX:+UseJVMCICompiler \ -XX:-TieredCompilation \ -XX:CompileOnly=Demo::workload \ Demo Going to compile workload</code> </pre> <br><p>  Si intenta repetir esto usted mismo, notar√° que ni siquiera necesita ejecutar nuestro sistema de compilaci√≥n: <code>mx build</code> .  Suficiente, normal para Eclipse, <em>compilar al guardar</em> .  Y ciertamente no necesitamos reconstruir la JVM en s√≠.  Simplemente incorporamos el compilador modificado en la JVM existente. </p><br><h2 id="graf-graal">  Conde Graal </h2><br><p>  Bueno, sabemos que Graal convierte un <code>byte[]</code> a otro <code>byte[]</code> .  Ahora hablemos sobre la teor√≠a y las estructuras de datos que usa, porque  son un poco inusuales incluso para el compilador. </p><br><p>  Esencialmente, el compilador maneja su programa.  Para esto, el programa debe presentarse en forma de alg√∫n tipo de estructura de datos.  Una opci√≥n es bytecode y listas de instrucciones similares, pero no son muy expresivas. </p><br><p>  En cambio, Graal usa un gr√°fico para representar su programa.  Si tomamos un operador de suma simple que suma dos variables locales, entonces el gr√°fico incluir√° un nodo para cargar cada variable, un nodo para la suma y dos bordes que muestran que el resultado de cargar variables locales va a la entrada del operador de suma. </p><br><p>  Esto a veces se llama un <em>gr√°fico de dependencia del programa</em> . </p><br><p>  Teniendo una expresi√≥n de la forma <code>x + y</code> obtenemos nodos para las variables locales <code>x</code> e <code>y</code> , y un nodo de su suma. </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/data-graph.png" alt="Gr√°fico de flujo de datos"></p><br><p>  Los bordes azules en este gr√°fico muestran la direcci√≥n del flujo de datos desde la lectura de las variables locales hasta la suma. </p><br><p>  Adem√°s, podemos usar aristas para reflejar el orden de ejecuci√≥n del programa.  Si, en lugar de leer variables locales, llamamos a m√©todos, entonces necesitamos recordar el orden de la llamada, y no podemos reorganizarlos (sin conocer el c√≥digo interno).  Para hacer esto, hay bordes adicionales que definen este orden.  Se muestran en rojo. </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/control-graph.png" alt="Gr√°fico de flujo de control"></p><br><p>  Entonces, el gr√°fico de Graal, de hecho, es dos gr√°ficos combinados en uno.  Los nodos son iguales, pero algunos bordes indican la direcci√≥n del flujo de datos, mientras que otros muestran la transferencia de control entre ellos. </p><br><p>  Para ver el gr√°fico de Graal, puede usar una herramienta llamada <em>IdealGraphVisualiser</em> o <em>IGV</em> .  El inicio se realiza utilizando el <code>mx igv</code> . </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/igv.png" alt="IdealGraphVisualiser"></p><br><p>  Despu√©s de eso, ejecute la JVM con el indicador <code>-Dgraal.Dump</code> . </p><br><p>  Se puede ver un flujo de datos simple escribiendo una expresi√≥n simple. </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">average</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (a + b) / <span class="hljs-number"><span class="hljs-number">2</span></span>; }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/average.png" alt="Media aritm√©tica igv"></p><br><p>  Puede ver c√≥mo los par√°metros <code>0</code> ( <code>P(0</code> ) y <code>1</code> ( <code>P(1)</code> ) van a la entrada de la operaci√≥n de suma, que, junto con la constante <code>2</code> ( <code>C(2)</code> ) va a la entrada de la operaci√≥n de divisi√≥n, despu√©s de lo cual se devuelve este valor. </p><br><p>  Para observar un flujo de datos y control m√°s complejo, presentamos un ciclo. </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">average</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] values)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> sum = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> n = <span class="hljs-number"><span class="hljs-number">0</span></span>; n &lt; values.length; n++) { sum += values[n]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sum / values.length; }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/average-loop.png" alt="Media aritm√©tica igv con ciclo"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/average-loop-detail.png" alt="Medio aritm√©tico igv detallado con bucle"></p><br><p>  En este caso, tenemos nodos del principio y el final del ciclo, que leen los elementos de la matriz y leen la longitud de la matriz.  Como antes, las l√≠neas azules indican la direcci√≥n del flujo de datos, y las l√≠neas rojas indican el flujo de control. </p><br><p>  Ahora puede ver por qu√© esta estructura de datos a veces se llama <em>mar de nodos</em> o <em>sopa de nodos</em> . </p><br><p>  Quiero decir que C2 utiliza una estructura de datos muy similar y, de hecho, fue C2 que populariz√≥ la idea de un compilador de un <em>mar de nodos</em> , por lo que esto no es una innovaci√≥n de Graal. </p><br><p>  No mostrar√© el proceso de construcci√≥n de este gr√°fico hasta la siguiente parte de la presentaci√≥n, pero cuando Graal recibe el programa en este formato, la optimizaci√≥n y la compilaci√≥n se realizan modificando esta estructura de datos.  Y esta es una de las razones por las cuales escribir un compilador JIT en Java tiene sentido.  Java es un lenguaje orientado a objetos, y un gr√°fico es una colecci√≥n de objetos conectados por bordes en forma de enlaces. </p><br><h2 id="ot-baytkoda-k-mashinnomu-kodu">  Del c√≥digo de bytes al c√≥digo de m√°quina </h2><br><p>  Veamos c√≥mo se ven estas ideas en la pr√°ctica y sigamos algunos pasos del proceso de compilaci√≥n. </p><br><h3 id="poluchenie-baytkoda">  Obteniendo Bytecode </h3><br><p>  La compilaci√≥n comienza con bytecode.  Volvamos a nuestro peque√±o ejemplo de resumen. </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a + b; }</code> </pre> <br><p>  Emitiremos el c√≥digo de bytes recibido en la entrada justo antes del inicio de la compilaci√≥n. </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HotSpotGraalCompiler</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JVMCICompiler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">CompilationRequestResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compileMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CompilationRequest request)</span></span></span><span class="hljs-function"> </span></span>{ System.err.println(request.getMethod().getName() + <span class="hljs-string"><span class="hljs-string">" bytecode: "</span></span> + Arrays.toString(request.getMethod().getCode())); ... } }</code> </pre> <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">workload</span></span> bytecode: [<span class="hljs-number"><span class="hljs-number">26</span></span>, <span class="hljs-number"><span class="hljs-number">27</span></span>, <span class="hljs-number"><span class="hljs-number">96</span></span>, -<span class="hljs-number"><span class="hljs-number">84</span></span>]</code> </pre> <br><p>  Como puede ver, la entrada al compilador es bytecode. </p><br><h3 id="parser-baytkoda-i-postroitel-grafa">  Analizador de c√≥digo de bytes y generador de gr√°ficos </h3><br><p>  <em>El constructor</em> , al percibir esta matriz de bytes como el c√≥digo de bytes JVM, la convierte en un gr√°fico de Graal.  Este es un tipo de <em>interpretaci√≥n abstracta</em> : el constructor interpreta el c√≥digo de bytes de Java, pero, en lugar de pasar valores, manipula los extremos libres de los bordes y los conecta gradualmente entre s√≠. </p><br><p>  Aprovechemos el hecho de que Graal est√° escrito en Java y veamos c√≥mo funciona usando las herramientas de navegaci√≥n de Eclipse.  Sabemos que en nuestro ejemplo hay un nodo de suma, as√≠ que busquemos d√≥nde se crea. </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/parser-1.png" alt="Addnode"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/parser-2.png" alt="Llamadas de b√∫squeda AddNode.create"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/parser-3.png" alt="Analizador"></p><br><p>  Se puede ver que son creados por el analizador de bytecode, y esto nos llev√≥ al <code>IADD</code> procesamiento de <code>IADD</code> ( <code>96</code> , que vimos en la matriz de entrada impresa). </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">genArithmeticOp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JavaKind kind, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> opcode)</span></span></span><span class="hljs-function"> </span></span>{ ValueNode y = frameState.pop(kind); ValueNode x = frameState.pop(kind); ValueNode v; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (opcode) { ... <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> LADD: v = genIntegerAdd(x, y); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; ... } frameState.push(kind, append(v)); }</code> </pre> <br><p>  Dije anteriormente que esta es una interpretaci√≥n abstracta, porque  Todo esto es muy similar a un int√©rprete de bytecode.  Si se tratara de un verdadero int√©rprete de JVM, tomar√≠a dos valores de la pila, realizar√≠a la suma y devolver√≠a el resultado.  En este caso, eliminamos dos nodos de la pila, que, cuando se inicia el programa, ser√°n c√°lculos, sumar, que es el resultado de la suma, un nuevo nodo para sumar, y colocarlo en la pila. </p><br><p>  As√≠ se construye el gr√°fico Graal. </p><br><h3 id="poluchenie-mashinnogo-koda">  Obtener el c√≥digo de la m√°quina </h3><br><p>  Para convertir un gr√°fico de Graal a c√≥digo de m√°quina, debe generar bytes para todos sus nodos.  Esto se hace por separado para cada nodo llamando a su m√©todo de <code>generate</code> . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">generate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Generator gen)</span></span></span><span class="hljs-function"> </span></span>{ gen.emitAdd(a, b); }</code> </pre> <br><p>  Repito, aqu√≠ trabajamos a un nivel muy alto de abstracci√≥n.  Tenemos una clase con la que emitimos instrucciones de c√≥digo de m√°quina sin entrar en detalles de c√≥mo funciona esto. </p><br><p>  <code>emitAdd</code>       ,          , ,  ,       .      . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a + <span class="hljs-number"><span class="hljs-number">1</span></span>; }</code> </pre> <br><p>       ,        . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">incl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Register dst)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> encode = prefixAndEncode(dst.encoding); emitByte(<span class="hljs-number"><span class="hljs-number">0xFF</span></span>); emitByte(<span class="hljs-number"><span class="hljs-number">0xC0</span></span> | encode); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">emitByte</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b)</span></span></span><span class="hljs-function"> </span></span>{ data.put((<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>) (b &amp; <span class="hljs-number"><span class="hljs-number">0xFF</span></span>)); }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/incl.png" alt="Instrucciones de montaje en ensamblador"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/emit-byte.png" alt="Salida de bytes"></p><br><p>  ,    ,     <code>ByteBuffer</code> ‚Äî    . </p><br><h3 id="vyhodnoy-mashinnyy-kod">    </h3><br><p>               ‚Äî       . </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HotSpotGraalCompiler</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JVMCICompiler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">CompilationResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compileHelper</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(...)</span></span></span><span class="hljs-function"> </span></span>{ ... System.err.println(method.getName() + <span class="hljs-string"><span class="hljs-string">" machine code: "</span></span> + Arrays.toString(result.getTargetCode())); ... } }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/machine-code.png" alt="C√≥digo de m√°quina de impresi√≥n"></p><br><p>           .    HotSpot.     .     OpenJDK, , -,     JVM,      . </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> cd openjdk/hotspot/src/share/tools/hsdis <span class="hljs-variable"><span class="hljs-variable">$</span></span> curl <span class="hljs-literal"><span class="hljs-literal">-O</span></span> http://ftp.heanet.ie/mirrors/gnu/binutils/binutils<span class="hljs-literal"><span class="hljs-literal">-2</span></span>.<span class="hljs-number"><span class="hljs-number">24</span></span>.tar.gz <span class="hljs-variable"><span class="hljs-variable">$</span></span> tar <span class="hljs-literal"><span class="hljs-literal">-xzf</span></span> binutils<span class="hljs-literal"><span class="hljs-literal">-2</span></span>.<span class="hljs-number"><span class="hljs-number">24</span></span>.tar.gz <span class="hljs-variable"><span class="hljs-variable">$</span></span> make BINUTILS=binutils<span class="hljs-literal"><span class="hljs-literal">-2</span></span>.<span class="hljs-number"><span class="hljs-number">24</span></span> ARCH=amd64 CFLAGS=<span class="hljs-literal"><span class="hljs-literal">-Wno</span></span><span class="hljs-literal"><span class="hljs-literal">-error</span></span> <span class="hljs-variable"><span class="hljs-variable">$</span></span> cp build/macosx<span class="hljs-literal"><span class="hljs-literal">-amd64</span></span>/hsdis<span class="hljs-literal"><span class="hljs-literal">-amd64</span></span>.dylib ../../../../../..</code> </pre> <br><p>      : <code>-XX:+UnlockDiagnosticVMOptions</code>  <code>-XX:+PrintAssembly</code> . </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> java \ -<span class="hljs-literal"><span class="hljs-literal">-module</span></span><span class="hljs-literal"><span class="hljs-literal">-path</span></span>=graal/sdk/mxbuild/modules/org.graalvm.graal_sdk.jar:graal/truffle/mxbuild/modules/com.oracle.truffle.truffle_api.jar \ -<span class="hljs-literal"><span class="hljs-literal">-upgrade</span></span><span class="hljs-literal"><span class="hljs-literal">-module</span></span><span class="hljs-literal"><span class="hljs-literal">-path</span></span>=graal/compiler/mxbuild/modules/jdk.internal.vm.compiler.jar \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+UnlockExperimentalVMOptions \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+EnableJVMCI \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+UseJVMCICompiler \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:<span class="hljs-literal"><span class="hljs-literal">-TieredCompilation</span></span> \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+PrintCompilation \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+UnlockDiagnosticVMOptions \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+PrintAssembly \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:CompileOnly=Demo::workload \ Demo</code> </pre> <br><p>             . </p><br><pre> <code class="hljs perl">workload machine code: [<span class="hljs-number"><span class="hljs-number">15</span></span>, <span class="hljs-number"><span class="hljs-number">31</span></span>, <span class="hljs-number"><span class="hljs-number">68</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, -<span class="hljs-number"><span class="hljs-number">14</span></span>, -<span class="hljs-number"><span class="hljs-number">117</span></span>, -<span class="hljs-number"><span class="hljs-number">58</span></span>, -<span class="hljs-number"><span class="hljs-number">123</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, ...] ... <span class="hljs-number"><span class="hljs-number">0x000000010f71cda0</span></span>: nopl <span class="hljs-number"><span class="hljs-number">0x0</span></span>(%rax,%rax,<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">0x000000010f71cda5</span></span>: add %edx,%esi ;\*iadd {reexecute=<span class="hljs-number"><span class="hljs-number">0</span></span> rethrow=<span class="hljs-number"><span class="hljs-number">0</span></span> return_oop=<span class="hljs-number"><span class="hljs-number">0</span></span>} ; - Demo::workload@2 (line <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-number"><span class="hljs-number">0x000000010f71cda7</span></span>: mov %esi,%eax ;\*ireturn {reexecute=<span class="hljs-number"><span class="hljs-number">0</span></span> rethrow=<span class="hljs-number"><span class="hljs-number">0</span></span> return_oop=<span class="hljs-number"><span class="hljs-number">0</span></span>} ; - Demo::workload@3 (line <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-number"><span class="hljs-number">0x000000010f71cda9</span></span>: test %eax,-<span class="hljs-number"><span class="hljs-number">0xcba8da9</span></span>(%rip) <span class="hljs-comment"><span class="hljs-comment"># 0x0000000102b74006 ; {poll_return} 0x000000010f71cdaf: vzeroupper 0x000000010f71cdb2: retq</span></span></code> </pre> <br><p> .  ,           .    <code>generate</code>   ,         . </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AddNode</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">generate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(...)</span></span></span><span class="hljs-function"> </span></span>{ ... gen.emitSub(op1, op2, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) ... <span class="hljs-comment"><span class="hljs-comment">// changed from emitAdd } }</span></span></code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/emit-add.png" alt="Problema de la instrucci√≥n AddNode"></p><br><p>    ,  ,      ,      . </p><br><pre> <code class="hljs perl">workload mechine code: [<span class="hljs-number"><span class="hljs-number">15</span></span>, <span class="hljs-number"><span class="hljs-number">31</span></span>, <span class="hljs-number"><span class="hljs-number">68</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">43</span></span>, -<span class="hljs-number"><span class="hljs-number">14</span></span>, -<span class="hljs-number"><span class="hljs-number">117</span></span>, -<span class="hljs-number"><span class="hljs-number">58</span></span>, -<span class="hljs-number"><span class="hljs-number">123</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, ...] <span class="hljs-number"><span class="hljs-number">0x0000000107f451a0</span></span>: nopl <span class="hljs-number"><span class="hljs-number">0x0</span></span>(%rax,%rax,<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">0x0000000107f451a5</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> %</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">edx</span></span></span><span class="hljs-function">,%</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">esi</span></span></span><span class="hljs-function"> </span></span>;\*iadd {reexecute=<span class="hljs-number"><span class="hljs-number">0</span></span> rethrow=<span class="hljs-number"><span class="hljs-number">0</span></span> return_oop=<span class="hljs-number"><span class="hljs-number">0</span></span>} ; - Demo::workload@2 (line <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-number"><span class="hljs-number">0x0000000107f451a7</span></span>: mov %esi,%eax ;\*ireturn {reexecute=<span class="hljs-number"><span class="hljs-number">0</span></span> rethrow=<span class="hljs-number"><span class="hljs-number">0</span></span> return_oop=<span class="hljs-number"><span class="hljs-number">0</span></span>} ; - Demo::workload@3 (line <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-number"><span class="hljs-number">0x0000000107f451a9</span></span>: test %eax,-<span class="hljs-number"><span class="hljs-number">0x1db81a9</span></span>(%rip) <span class="hljs-comment"><span class="hljs-comment"># 0x000000010618d006 ; {poll_return} 0x0000000107f451af: vzeroupper 0x0000000107f451b2: retq</span></span></code> </pre> <br><p> ,   ? Graal     ;         ;       ;    .  ,       Graal. </p><br><pre> <code class="hljs powershell">[<span class="hljs-number"><span class="hljs-number">26</span></span>, <span class="hljs-number"><span class="hljs-number">27</span></span>, <span class="hljs-number"><span class="hljs-number">96</span></span>, -<span class="hljs-number"><span class="hljs-number">84</span></span>] ‚Üí [<span class="hljs-number"><span class="hljs-number">15</span></span>, <span class="hljs-number"><span class="hljs-number">31</span></span>, <span class="hljs-number"><span class="hljs-number">68</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">43</span></span>, -<span class="hljs-number"><span class="hljs-number">14</span></span>, -<span class="hljs-number"><span class="hljs-number">117</span></span>, -<span class="hljs-number"><span class="hljs-number">58</span></span>, -<span class="hljs-number"><span class="hljs-number">123</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-type"><span class="hljs-type">...</span></span>]</code> </pre> <br><h2 id="optimizaciya">  </h2><br><p>  ,     ,        .       Graal  ,    . </p><br><p> <em> </em> ‚Äî          .      . </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Phase</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Graph graph)</span></span></span></span>; }</code> </pre> <br><h3 id="kanonikalizaciya-canonicalisation">  (canonicalisation) </h3><br><p> <em></em>      .       ,       ,      <em> </em> ( <em>constant folding</em> )   . </p><br><p>       ‚Äî       <code>canonical</code> . </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Node</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">Node </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">canonical</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; }</code> </pre> <br><p> ,  ,    ,      .                  ‚Äî    .    <code>-(-x)</code>  <code>x</code> . </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NegateNode</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Node</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">Node </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">canonical</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> NegateNode) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ((NegateNode) value).getValue(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } } }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/negate-node.png" alt="findSynonym en NegateNode"></p><br><p>       Graal   . ,       . </p><br><p>           Java,       <code>canonical</code> . </p><br><h3 id="global-value-numbering"> Global value numbering </h3><br><p> <em>Global value numbering (GVN)</em> ‚Äî       .    <code>a + b</code>    ,   ‚Äî . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (a + b) * (a + b); }</code> </pre> <br><p> Graal     .   ‚Äî        .   GVN         .        <em>hash map</em>  ,  ,  . </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/gvn.png" alt="Numeraci√≥n de valor global"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/gvn-igv-1.png" alt="Gr√°fico de numeraci√≥n de valor global"></p><br><p>    ,   <em></em> ‚Äî  ,      ,     -  .  ,  ,  ,       ,      ‚Äî . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (getA() + getB()) * (getA() + getB()); }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/gvn-igv-2.png" alt="Un gr√°fico que no puede tener un valor global numerado"></p><br><h3 id="ukrupnenie-blokirovok-lock-coarsening">   (lock coarsening) </h3><br><p>     .               <em></em> . ,     ,      ,   <em></em> ( <em>inlining</em> ). </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">synchronized</span></span> (monitor) { counter++; } <span class="hljs-keyword"><span class="hljs-keyword">synchronized</span></span> (monitor) { counter++; } }</code> </pre> <br><p>   ,   , , , . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ monitor.enter(); counter++; monitor.exit(); monitor.enter(); counter++; monitor.exit(); }</code> </pre> <br><p>                    .    <em> </em> . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ monitor.enter(); counter++; counter++; monitor.exit(); }</code> </pre> <br><p>  Graal       <code>LockEliminationPhase</code> .   <code>run</code>      ,         .  ,        ,           . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(StructuredGraph graph)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (monitorExitNode monitorExitNode : graph.getNodes(MonitorExitNode.class)) { FixedNode next = monitorExitNode.next(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (next <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> monitorEnterNode) { AccessmonitorNode monitorEnterNode = (AccessmonitorNode) next; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (monitorEnterNode.object() ## monitorExitNode.object()) { monitorExitNode.remove(); monitorEnterNode.remove(); } } } }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/lock-elimination.png" alt="Simplificaci√≥n de bloqueo"></p><br><p>            , , ,      ,          <code>2</code> . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ monitor.enter(); counter += <span class="hljs-number"><span class="hljs-number">2</span></span>; monitor.exit(); }</code> </pre> <br><p>    IGV   .  ,   ,       \   ,  , ,        <code>2</code> . </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/lock-elimination-before.png" alt="Simplifique las cerraduras a"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/lock-elimination-after.png" alt="Simplifica los bloqueos despu√©s"></p><br><h2 id="ne-zatronutye-prakticheskie-aspekty">     </h2><br><p>   Graal   ,  ,      ,          . , , ,          . </p><br><p>       Graal   ,  , ,         ,    ,  ,    . </p><br><h3 id="naznachenie-registrov">   </h3><br><p>    Graal      ,   ,  .        ?          ,      ? </p><br><p> ,  ,    .      .       ,      , ,   ,    .        ,  ,  ,             , ,  . </p><br><p>        <em> </em> ( <em>register allocation</em> ). Graal ,    JIT-,    ‚Äî <em>  </em> ( <em>linear scan algorithm</em> ). </p><br><h3 id="dispetcherizaciya">  </h3><br><p>    ,     ,   ,        -    ,         . </p><br><p> ,       ,   , ,         (..     ),        . ,    ,     . </p><br><p>    <em> </em> ( <em>graph scheduling</em> ).       .       ,          .       ,      , ,        . </p><br><p>                ,     . </p><br><h2 id="v-kakih-sluchayah-ispolzovat-graal">     Graal? </h2><br><p>        , ,   , Graal ‚Äî   ,       <em>Oracle</em> .      ,    Graal? </p><br><h3 id="kompilyator-nizhnego-urovnya-final-tier-compiler">    (final-tier compiler) </h3><br><p> C  JVMCI Graal    <em>  </em>  HotSpot ‚Äî ,     .     (   HotSpot)   Graal    ,    . </p><br><p> <em>Twitter</em>       Graal   ,    Java 9           .       : <code>-XX:+UseJVMCICompiler</code>  . </p><br><p>    JVMCI   ,      Graal   JVM.    (deploy) -  JVM,      Graal.      Java-,   Graal,       JVM. </p><br><p>  OpenJDK   <em>Metropolis</em>       JVM   Java. Graal        . </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/metropolis.png" alt="Proyecto Metr√≥polis"></p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">http://cr.openjdk.java.net/\~jrose/metropolis/Metropolis-Proposal.html</a> </p><br><h3 id="polzovatelskie-optimizacii">   </h3><br><p> Graal    .    Graal   JVM,     Graal   .           ,  Graal       . ,     -     ,    ,                 JNI. </p><br><p> Charles Nutter      <em>JRuby</em>         Graal       Ruby. ,        - . </p><br><h3 id="aot-ahead-of-time-kompilyaciya"> AOT (ahead-of-time)  </h3><br><p> Graal ‚Äî    Java. JVMCI  ,  Graal,    ,     ,    Graal     .  ,     Graal    ,     JIT-. </p><br><p>     JIT-  AOT-      ,  Graal     .       AOT   Graal. </p><br><p> Java 9              JIT-,     .        JVM,          . </p><br><p> AOT Java 9     Graal,       Linux.            ,  ,            . </p><br><p>    . <em>SubstrateVM</em> ‚Äî  AOT-,   Java-    JVM  . ,     - (statically linked)  .    JVM  ,         .     SubstrateVM  Graal.          ( <em>just-in-time</em> ) SubstrateVM, ,   Graal  .   Graal AOT-  . </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> javac Hello.java <span class="hljs-variable"><span class="hljs-variable">$</span></span> graalvm<span class="hljs-literal"><span class="hljs-literal">-0</span></span>.<span class="hljs-number"><span class="hljs-number">28.2</span></span>/bin/native<span class="hljs-literal"><span class="hljs-literal">-image</span></span> Hello classlist: <span class="hljs-number"><span class="hljs-number">966.44</span></span> ms (cap): <span class="hljs-number"><span class="hljs-number">804.46</span></span> ms setup: <span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">514.31</span></span> ms (typeflow): <span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">580.70</span></span> ms (objects): <span class="hljs-number"><span class="hljs-number">719.04</span></span> ms (features): <span class="hljs-number"><span class="hljs-number">16.27</span></span> ms analysis: <span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">422.58</span></span> ms universe: <span class="hljs-number"><span class="hljs-number">262.09</span></span> ms (parse): <span class="hljs-number"><span class="hljs-number">528.44</span></span> ms (inline): <span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">259.94</span></span> ms (compile): <span class="hljs-number"><span class="hljs-number">6</span></span>,<span class="hljs-number"><span class="hljs-number">716.20</span></span> ms compile: <span class="hljs-number"><span class="hljs-number">8</span></span>,<span class="hljs-number"><span class="hljs-number">817.97</span></span> ms image: <span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">070.29</span></span> ms debuginfo: <span class="hljs-number"><span class="hljs-number">672.64</span></span> ms write: <span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">797.45</span></span> ms [<span class="hljs-type"><span class="hljs-type">total</span></span>]: <span class="hljs-number"><span class="hljs-number">17</span></span>,<span class="hljs-number"><span class="hljs-number">907.56</span></span> ms <span class="hljs-variable"><span class="hljs-variable">$</span></span> ls <span class="hljs-literal"><span class="hljs-literal">-lh</span></span> hello <span class="hljs-literal"><span class="hljs-literal">-rwxr</span></span><span class="hljs-literal"><span class="hljs-literal">-xr</span></span><span class="hljs-literal"><span class="hljs-literal">-x</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> chrisseaton staff <span class="hljs-number"><span class="hljs-number">6.6</span></span>M <span class="hljs-number"><span class="hljs-number">4</span></span> Oct <span class="hljs-number"><span class="hljs-number">18</span></span>:<span class="hljs-number"><span class="hljs-number">35</span></span> hello <span class="hljs-variable"><span class="hljs-variable">$</span></span> file ./hello ./hellojava: Mach<span class="hljs-literal"><span class="hljs-literal">-O</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span><span class="hljs-literal"><span class="hljs-literal">-bit</span></span> executable x86_64 <span class="hljs-variable"><span class="hljs-variable">$</span></span> time ./hello Hello! real <span class="hljs-number"><span class="hljs-number">0</span></span>m0.<span class="hljs-number"><span class="hljs-number">010</span></span>s user <span class="hljs-number"><span class="hljs-number">0</span></span>m0.<span class="hljs-number"><span class="hljs-number">003</span></span>s sys <span class="hljs-number"><span class="hljs-number">0</span></span>m0.<span class="hljs-number"><span class="hljs-number">003</span></span>s</code> </pre> <br><h3 id="truffle"> Truffle </h3><br><p>     Graal      <em>Truffle</em> . Truffle ‚Äî         JVM. </p><br><p>  ,   JVM,  ,   JIT-   (,    ,   ,  JIT- JVM    ,        ). Truffle    ‚Äî       ,   ,  Truffle, ,              <em> </em> ( <em>partial evaluation</em> ). </p><br><p>         ,             <em> </em> ( <em>inlining</em> )  <em> </em> ( <em>constant folding</em> )      . Graal       ,  Truffle       . </p><br><p>       Graal ‚Äî  Truffle.       Ruby,   <em>TruffleRuby</em>    Truffle , , Graal. TruffleRuby ‚Äî     Ruby,   10   , ,  ,        . </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://github.com/graalvm/truffleruby</a> </p><br><h2 id="vyvody">  Conclusiones </h2><br><p>  ,      ,   ,   JIT- Java         . JIT-   ,          , , -           . ,  ,   .   JIT-    ,   <code>byte[]</code>  JVM  <code>byte[]</code>  . </p><br><p>  ,       Java.           ,   C++. </p><br><p> Java- Graal   - .   ,    ,            . </p><br><p>          .        ,        Eclipse     .           (definitions),     ..    . </p><br><p>          JIT      JIT- JVM,   <em>JITWatch</em> ,   ,        Graal     ,   . ,   ,  -       ,     Graal     JVM.         IDE,       <em>hello-world</em> . </p><br><p>         SubstrateVM  Truffle,   Graal,     ,     Java  .     ,   Graal    Java.  ,    ,   -  <em>LLVM</em> ,    , ,   ,     . </p><br><p> , ,       Graal      JVM.  Porque JVMCI   Java 9, Graal      ,  ,    Java-. </p><br><p> Graal ‚Äî        .    ,      Graal.    ,      ! </p><br><hr><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">More information about TruffleRuby</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Low Overhead Polling For Ruby</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Top 10 Things To Do With GraalVM</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Ruby Objects as C Structs and Vice Versa</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Understanding How Graal Works ‚Äî a Java JIT Compiler Written in Java</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Flip-Flops ‚Äî the 1-in-10-million operator</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Deoptimizing Ruby</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Very High Performance C Extensions For JRuby+Truffle</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Optimising Small Data Structures in JRuby+Truffle</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Pushing Pixels with JRuby+Truffle</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Tracing With Zero Overhead in JRuby+Truffle</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">How Method Dispatch Works in JRuby+Truffle</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">A Truffle/Graal High Performance Backend for JRuby</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es419637/">https://habr.com/ru/post/es419637/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es419623/index.html">"ELLA": c√≥mo se nos ocurrieron im√°genes de inteligencia artificial</a></li>
<li><a href="../es419625/index.html">Descripci√≥n general de mis caracter√≠sticas favoritas de PHP7</a></li>
<li><a href="../es419627/index.html">Estamos buscando oradores en Mosc√∫ Data Science Major</a></li>
<li><a href="../es419633/index.html">Ahora, Let's Encrypt conf√≠a en todas las principales listas de certificados ra√≠z</a></li>
<li><a href="../es419635/index.html">Lanzamiento de la versi√≥n estable de Dart 2.0 y Dart Web Platform</a></li>
<li><a href="../es419641/index.html">Crear una IA simple de C # en Unity</a></li>
<li><a href="../es419643/index.html">Conferencia de Ingenier√≠a de Software EPAM de Minsk: Hazlo Real</a></li>
<li><a href="../es419647/index.html">Seminario ‚ÄúViernes negro en comercio electr√≥nico. Secretos de supervivencia, 16 de agosto, Mosc√∫</a></li>
<li><a href="../es419649/index.html">Un poco sobre los gatos, o qu√© CAT elegimos para los podcasts de sincronizaci√≥n</a></li>
<li><a href="../es419651/index.html">Ni GA ni YM. C√≥mo hicimos nuestro propio clickstream</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>