<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üóΩ üë∫ üîü Obtention de donn√©es d'√©num√©ration dans une perspective Automapper üìΩÔ∏è üìã üòΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Un peu de programme √©ducatif 


 J'aime vraiment Automapper, en particulier ses QueryableExtensions et la m√©thode ProjectTo <> . En bref, cette m√©thod...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Obtention de donn√©es d'√©num√©ration dans une perspective Automapper</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/439484/"><h1 id="nemnogo-likbeza">  Un peu de programme √©ducatif </h1><br><p> J'aime vraiment Automapper, en particulier ses <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">QueryableExtensions et la m√©thode ProjectTo &lt;&gt;</a> .  En bref, cette m√©thode permet la projection de types directement dans la requ√™te SQL.  Il permettait de recevoir dto r√©ellement d'une base de donn√©es.  C'est-√†-dire  pas besoin de r√©cup√©rer toutes les entit√©s de la base de donn√©es, de les charger en m√©moire, d'utiliser <code>Automapper.Map&lt;&gt;</code> , ce qui a entra√Æn√© une consommation et un trafic m√©moire importants. </p><a name="habracut"></a><br><h1 id="proekciya-tipa">  Type de projection </h1><br><p>  Pour obtenir une projection en linq, vous devez √©crire quelque chose comme ceci: </p><br><pre> <code class="plaintext hljs"> from user in dbContext.Users where user.IsActive select new { Name = user.Name, Status = user.IsConnected ? "Connected" : "Disconnected" }</code> </pre> <br><p>  En utilisant QueryableExtensions, ce code peut √™tre remplac√© par ce qui suit (bien s√ªr, √† condition que les r√®gles de conversion User -&gt; UserInfo soient d√©j√† d√©crites) </p><br><pre> <code class="plaintext hljs">dbContext.Users.Where(x =&gt; x.IsActive).ProjectTo&lt;UserInfo&gt;();</code> </pre> <br><h1 id="enum-i-problemy-s-nim">  Enum et probl√®mes avec </h1><br><p>  La projection a un inconv√©nient qui doit √™tre pris en compte.  Il s'agit d'une restriction sur les op√©rations effectu√©es.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Tout ne peut pas √™tre traduit en une requ√™te SQL</a> .  En particulier, il n'est pas possible d'obtenir des informations par type d'√©num√©ration.  Par exemple, il y a l'√©num√©ration suivante </p><br><pre> <code class="plaintext hljs"> public enum FooEnum { [Display(Name = "")] Any, [Display(Name = "")] Open, [Display(Name = "")] Closed }</code> </pre> <br><p>  Il existe une entit√© dans laquelle une propri√©t√© de type FooEnum est d√©clar√©e.  Dans dto, vous devez obtenir non Enum lui-m√™me, mais la valeur de la propri√©t√© Name de l'attribut DisplayAttribute.  R√©aliser cela √† travers la projection ne fonctionne pas, car  obtenir la valeur de l'attribut n√©cessite Reflection, dont SQL ¬´ne sait rien¬ª. </p><br><p>  En cons√©quence, vous devez soit utiliser la <code>Map&lt;&gt;</code> habituelle <code>Map&lt;&gt;</code> , charger toutes les entit√©s en m√©moire, soit d√©marrer une table suppl√©mentaire avec des valeurs Enum et des cl√©s √©trang√®res. </p><br><h1 id="reshenie-est---expressions">  Il y a une solution - Expressions </h1><br><p>  Mais "il y aura un slammer sur la vieille femme".  Apr√®s tout, toutes les valeurs d'Enum sont connues √† l'avance.  SQL a une impl√©mentation de <code>switch</code> que vous pouvez ins√©rer lors de la formation d'une projection.  Reste √† comprendre comment proc√©der.  HashTag: "Expression Trees-Our-All". </p><br><p>  Automapper, lors de la projection de types, peut convertir une expression en une expression qui, apr√®s Entity Framework, se convertit en requ√™te SQL correspondante. </p><br><p>  √Ä premi√®re vue, la syntaxe pour cr√©er des arborescences d'expressions lors de l'ex√©cution est extr√™mement g√™nante.  Mais apr√®s quelques petits probl√®mes r√©solus, tout devient √©vident.  Pour r√©soudre le probl√®me avec Enum, vous devez cr√©er un arbre imbriqu√© d'expressions conditionnelles qui renvoient des valeurs, en fonction des donn√©es source.  Quelque chose comme √ßa </p><br><pre> <code class="plaintext hljs">IF enum=Any THEN RETURN "" ELSE IF enum=Open THEN RETURN "" ELSE enum=Closed THEN RETURN "" ELSE RETURN ""</code> </pre> <br><p>  D√©cidez de la signature de la m√©thode. </p><br><pre> <code class="plaintext hljs"> public class FooEntity { public int Id { get; set; } public FooEnum Enum { get; set; } } public class FooDto { public int Id { get; set; } public string Name { get; set; } } //  Automapper CreateMap&lt;FooEntity, FooDto&gt;() .ForMember(x =&gt; x.Enum, options =&gt; options.MapFrom(GetExpression())); private Expression&lt;Func&lt;FooEntity, string&gt;&gt; GetExpression() { }</code> </pre> <br><p>  La m√©thode <code>GetExpression()</code> doit g√©n√©rer une expression qui re√ßoit une instance de FooEntity et renvoie une repr√©sentation sous forme de cha√Æne pour la propri√©t√© <code>Enum</code> . <br>  Tout d'abord, d√©finissez le param√®tre d'entr√©e et obtenez la valeur de la propri√©t√© elle-m√™me </p><br><pre> <code class="plaintext hljs">ParameterExpression value = Expression.Parameter(typeof(FooEntity), "x"); var propertyExpression = Expression.Property(value, "Enum");</code> </pre> <br><p>  Au lieu de la cha√Æne de nom de propri√©t√©, vous pouvez utiliser la <code>nameof(FooEntity.Enum)</code> compilateur <code>nameof(FooEntity.Enum)</code> ou m√™me obtenir des donn√©es sur la propri√©t√© <code>System.Reflection.PropertyInfo</code> ou le getter <code>System.Reflection.MethodInfo</code> .  Mais par exemple, il nous suffit de d√©finir explicitement le nom de la propri√©t√©. </p><br><p>  Pour renvoyer une valeur sp√©cifique, nous utilisons la m√©thode <code>Expression.Constant</code> .  Nous formons la valeur par d√©faut </p><br><pre> <code class="plaintext hljs"> Expression resultExpression = Expression.Constant(string.Empty);</code> </pre> <br><p>  Apr√®s cela, nous "enveloppons" successivement le r√©sultat dans une condition. </p><br><pre> <code class="plaintext hljs"> resultExpression = Expression.Condition( Expression.Equal(propertyExpression, Expression.Constant(FooEnum.Any)), Expression.Constant(EnumHelper.GetShortName(FooEnum.Any)), resultExpression); resultExpression = Expression.Condition( Expression.Equal(propertyExpression, Expression.Constant(FooEnum.Open)), Expression.Constant(EnumHelper.GetShortName(FooEnum.Open)), resultExpression); resultExpression = Expression.Condition( Expression.Equal(propertyExpression, Expression.Constant(FooEnum.Closed)), Expression.Constant(EnumHelper.GetShortName(FooEnum.Closed)), resultExpression);</code> </pre> <br><pre> <code class="plaintext hljs"> public static class EnumHelper { public static string GetShortName(this Enum enumeration) { return (enumeration .GetType() .GetMember(enumeration.ToString())? .FirstOrDefault()? .GetCustomAttributes(typeof(DisplayAttribute), false)? .FirstOrDefault() as DisplayAttribute)? .ShortName ?? enumeration.ToString(); } }</code> </pre> <br><p>  Il ne reste plus qu'√† √©tablir le r√©sultat </p><br><pre> <code class="plaintext hljs"> return Expression.Lambda&lt;Func&lt;TEntity, string&gt;&gt;(resultExpression, value);</code> </pre> <br><h1 id="esche-nemnogo-refleksii">  Un peu plus de r√©flexion </h1><br><p>  Copier toutes les valeurs d'Enum est extr√™mement g√™nant.  Fixons-le </p><br><pre> <code class="plaintext hljs"> var enumValues = Enum.GetValues(typeof(FooEnum)).Cast&lt;Enum&gt;(); Expression resultExpression = Expression.Constant(string.Empty); foreach (var enumValue in enumValues) { resultExpression = Expression.Condition( Expression.Equal(propertyExpression, Expression.Constant(enumValue)), Expression.Constant(EnumHelper.GetShortName(enumValue)), resultExpression); }</code> </pre> <br><h1 id="usovershenstvuem-poluchenie-znacheniya-svoystva">  Am√©liorons l'obtention de la valeur de la propri√©t√© </h1><br><p>  L'inconv√©nient du code ci-dessus est la liaison √©troite du type d'entit√© utilis√©.  Si un probl√®me similaire doit √™tre r√©solu par rapport √† une autre classe, vous devez trouver un moyen d'obtenir la valeur d'une propri√©t√© de type √©num√©ration.  Alors laissez l'expression le faire pour nous.  En tant que param√®tre de la m√©thode, nous passerons une expression qui re√ßoit la valeur de la propri√©t√©, et le code lui-m√™me - nous formons simplement un ensemble de r√©sultats pour cette propri√©t√© possible.  Mod√®les pour nous aider </p><br><pre> <code class="plaintext hljs"> public static Expression&lt;Func&lt;TEntity, string&gt;&gt; CreateEnumShortNameExpression&lt;TEntity, TEnum&gt;(Expression&lt;Func&lt;TEntity, TEnum&gt;&gt; propertyExpression) where TEntity : class where TEnum : struct { var enumValues = Enum.GetValues(typeof(TEnum)).Cast&lt;Enum&gt;(); Expression resultExpression = Expression.Constant(string.Empty); foreach (var enumValue in enumValues) { resultExpression = Expression.Condition( Expression.Equal(propertyExpression.Body, Expression.Constant(enumValue)), Expression.Constant(EnumHelper.GetShortName(enumValue)), resultExpression); } return Expression.Lambda&lt;Func&lt;TEntity, string&gt;&gt;(resultExpression, propertyExpression.Parameters); }</code> </pre> <br><p>  Quelques pr√©cisions.  Parce que  nous obtenons la valeur d'entr√©e via une autre expression, puis nous n'avons pas besoin de d√©clarer le param√®tre via <code>Expression.Parameter</code> .  Nous prenons ce param√®tre de la propri√©t√© de l'expression d'entr√©e et utilisons le corps de l'expression pour obtenir la valeur de la propri√©t√©. <br>  Ensuite, vous pouvez utiliser la nouvelle m√©thode comme ceci: </p><br><pre> <code class="plaintext hljs"> CreateMap&lt;FooEntity, FooDto&gt;() .ForMember(x =&gt; x.Enum, options =&gt; options.MapFrom(GetExpression&lt;FooEntity, FooEnum&gt;(x =&gt; x.Enum)));</code> </pre> <br><hr><br><p>  Tout d√©veloppement r√©ussi d'arbres d'expression. </p><br><p>  Je recommande fortement de lire les articles de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Maxim Arshinov</a> .  En particulier sur les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">arbres d'expression dans le d√©veloppement des entreprises</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr439484/">https://habr.com/ru/post/fr439484/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr439472/index.html">Automatisation du contr√¥le des fronti√®res au sein de l'entreprise</a></li>
<li><a href="../fr439476/index.html">Argot de Cockney: histoire moderne et statut social</a></li>
<li><a href="../fr439478/index.html">C # divertissant. Cinq exemples de pauses caf√©</a></li>
<li><a href="../fr439480/index.html">C√©dez le passage, ou pourquoi votre CRM (et CRM) ralentit-il?</a></li>
<li><a href="../fr439482/index.html">devleads - motivation (non) financi√®re</a></li>
<li><a href="../fr439486/index.html">Types de r√©f√©rence .NET vs types de valeur. Partie 1</a></li>
<li><a href="../fr439488/index.html">Enregistrement vid√©o Meetup QA</a></li>
<li><a href="../fr439490/index.html">Types de r√©f√©rence .NET vs types de valeur. 2e partie</a></li>
<li><a href="../fr439492/index.html">10 conseils pour √™tre un bon leader technologique</a></li>
<li><a href="../fr439496/index.html">Comment la facturation se fait-elle: lorsque le client et le d√©veloppeur parlent des langues diff√©rentes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>