<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçÄ üôåüèº üßó Wir schreiben unser Protokoll √ºber UDP üçã ‚ÜîÔ∏è üë®üèæ‚Äçüíª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Die ersten Live-√úbertragungen der Szene wurden vor fast 70 Jahren in Russland ausgestrahlt und von einem mobilen Fernsehsender (PTS) ausgestrahlt, der...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Wir schreiben unser Protokoll √ºber UDP</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/413479/">  Die ersten Live-√úbertragungen der Szene wurden vor fast 70 Jahren in Russland ausgestrahlt und von einem mobilen Fernsehsender (PTS) ausgestrahlt, der wie ein Obus aussah und es Ihnen erm√∂glichte, von au√üerhalb des Studios zu senden.  Und noch vor drei Jahren durfte Periscope ein Mobiltelefon anstelle eines ‚ÄûObus‚Äú verwenden. <br><br>  Diese Anwendung hatte jedoch eine Reihe von Problemen, die beispielsweise mit Verz√∂gerungen bei der Ausstrahlung, der Unf√§higkeit, Sendungen in hoher Qualit√§t anzusehen, usw. verbunden waren. <br><br><img src="https://habrastorage.org/webt/ah/bx/dh/ahbxdhk3rew0amnby0xhqmwct98.jpeg"><br>  Sechs Monate sp√§ter, im Sommer 2016, startete Odnoklassniki seine mobile OK Live Streaming-Anwendung, mit der versucht wurde, diese Probleme zu l√∂sen. <br><br>  Alexander Tobol ist f√ºr den technischen Teil des Videos in Odnoklassniki verantwortlich und sprach bei Highload ++ 2017 dar√ºber, wie Sie Ihr UDP-Protokoll schreiben und warum dies m√∂glicherweise erforderlich ist. <br><br>  Aus der Abschrift seines Berichts erfahren Sie alles √ºber andere Video-Streaming-Protokolle, welche Nuancen es gibt und welche Tricks manchmal erforderlich sind. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/1Ih0bL2Zp1c" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Sie sagen, wir sollten immer mit Architektur und TK beginnen - angeblich ist das ohne das nicht m√∂glich!  Also lass es uns tun. <br><a name="habracut"></a><br><h2>  Architektur und TK </h2><br>  Auf der Folie unten sehen Sie das Architekturdiagramm eines Streaming-Dienstes: Das <strong>Video wird dem Eingang zugef√ºhrt, konvertiert und zum Ausgang √ºbertragen</strong> .  Wir haben dieser Architektur etwas mehr Anforderungen hinzugef√ºgt: Das Video sollte von Desktops und Mobiltelefonen geliefert werden, und die Ausgabe sollte an dieselben Desktops, Mobiltelefone, SmartTV, Chromcast, AppleTV und andere Ger√§te gehen - das gesamte Video kann abgespielt werden. <br><br><img src="https://habrastorage.org/webt/g2/ju/k_/g2juk_sfrmjcu1hv_4ieulhse44.jpeg"><br>  Als n√§chstes fahren wir mit der Leistungsbeschreibung fort.  Wenn Sie einen Kunden haben, haben Sie TK.  Wenn Sie ein soziales Netzwerk sind, haben Sie keine TK.  Wie macht man das? <br><br>  Sie k√∂nnen nat√ºrlich Benutzer interviewen und alles herausfinden, was sie wollen.  Aber es wird eine ganze Reihe von W√ºnschen geben, die nicht mit dem korrelieren, was die Menschen wirklich brauchen. <br><br>  Wir haben uns f√ºr den umgekehrten Weg entschieden und gesehen, was Benutzer vom Rundfunkdienst NICHT sehen wollten. <br><br><ul><li>  Das erste, was der Benutzer nicht m√∂chte, ist, die <strong>Verz√∂gerung zu Beginn der Sendung zu sehen</strong> . <br></li><li>  Der Benutzer m√∂chte kein <strong>Stream-Bild mit geringer Qualit√§t sehen</strong> . <br></li><li>  Wenn die Sendung interaktiv ist, wenn der Benutzer mit seinem Publikum kommuniziert (entgegenkommende Live-Sendungen, Anrufe usw.), m√∂chte er die <strong>Verz√∂gerung zwischen dem Streamer und dem Betrachter nicht sehen</strong> . <br></li></ul><br>  So sieht ein normaler Streaming-Dienst aus.  Mal sehen, was getan werden kann, um einen regul√§ren Streaming-Dienst anstelle des √ºblichen durchzuf√ºhren. <br><br><img src="https://habrastorage.org/webt/ik/68/zp/ik68zpbfkto_uh2ukzdpdinqoqi.jpeg"><br>  Sie k√∂nnen sich zun√§chst alle Streaming-Protokolle ansehen, die interessantesten ausw√§hlen und vergleichen.  Aber wir haben es anders gemacht. <br><br><h2>  Was haben Wettbewerber? </h2><br>  Wir haben zun√§chst die Dienstleistungen von Wettbewerbern untersucht.  <strong>Open Periscope - was haben sie?</strong> <br><br>  Hauptsache ist wie immer die Architektur. <br><br><img src="https://habrastorage.org/webt/ex/-e/xo/ex-exowlx_iyvaq5xvqmpsjnata.jpeg"><br>  Sara Hyder, Periscopes leitende Ingenieurin, schreibt, dass sie Wowza f√ºr das Backend verwenden.  Wenn wir ein wenig mehr Artikel lesen, werden wir sehen, was sie mit dem <strong>RTMP-</strong> Protokoll streamen, und es entweder in RTMP oder in HLS verteilen.  Mal sehen, was diese Protokolle sind und wie sie funktionieren. <br><br>  Wir testen Periscope auf unsere drei Hauptanforderungen. <br><img src="https://habrastorage.org/webt/i5/6n/y-/i56ny-rn2pymgbg_pujoroehycm.jpeg"><br>  Sie haben eine akzeptable <strong>Startgeschwindigkeit</strong> (weniger als eine Sekunde in guten Netzwerken), eine konstante <strong>Qualit√§t von</strong> etwa 600 px (nicht HD) und gleichzeitig k√∂nnen <strong>Verz√∂gerungen bis zu 12 Sekunden betragen</strong> . <br><br>  Wie kann man √ºbrigens die Verz√∂gerung des Rundfunks messen? <br><img src="https://habrastorage.org/webt/ug/hs/pa/ughspadkdie3xrgpmxt1vjwrmdm.jpeg"><br>  Dies ist ein Foto einer Verz√∂gerungsmessung.  Es gibt ein Handy mit Timer.  Wir schalten die Sendung ein und sehen das Bild dieses Telefons auf dem Bildschirm.  F√ºr 0,15 Millisekunden fiel das Bild auf den Sensor der Kamera und wurde aus dem Videospeicher auf den Telefonbildschirm entfernt.  Danach schalten wir den Browser ein und schauen uns die Sendung an. <br><br>  Autsch!  Sie ist etwas zur√ºck - ungef√§hr 12 Sekunden. <br><br>  Um die Gr√ºnde f√ºr die Verz√∂gerung zu finden, stellen wir Video-Streaming vor. <br><img src="https://habrastorage.org/webt/ce/3u/jg/ce3ujgyeow2snntsekcqqq6xcr4.jpeg"><br>  Es gibt also ein Mobiltelefon, das Video geht von der Kamera und tritt in den Videopuffer ein.  Hier sind die Verz√∂gerungen minimal (~ 0,15 ms).  Dann codiert der Codierer das Signal, packt es in ein Paket und sendet es an den Socket-Puffer.  Es fliegt alles ins Web.  Au√üerdem passiert dasselbe auf dem Empfangsger√§t. <br><br>  Grunds√§tzlich sind zwei Hauptprobleme zu ber√ºcksichtigen: <br><br><ul><li>  <strong>Videokodierung / -decodierung;</strong> <br></li><li>  <strong>Netzwerkprotokolle</strong> . <br></li></ul><br><h2>  Videokodierung / -decodierung </h2><br>  Ich werde ein wenig √ºber das Codieren erz√§hlen.  Sie werden es trotzdem antreffen, wenn Sie Live-Streaming mit geringer Latenz durchf√ºhren. <br><img src="https://habrastorage.org/webt/gr/op/o_/gropo_fxvnlubkxnrwdjrbhrj-w.jpeg"><br>  Was ist ein Video?  Dies ist eine Reihe von Frames, aber nicht ganz einfach.  Es gibt drei Arten von Rahmen: I-, P- und B-Rahmen: <br><br><ul><li>  <strong>I-Frame</strong> ist nur JPG.  In der Tat ist dies ein Referenzrahmen, er h√§ngt von niemandem ab und enth√§lt ein klares Bild. <br></li><li>  <strong>P-Frame</strong> h√§ngt ausschlie√ülich von vorherigen Frames ab. <br></li><li>  Der knifflige <strong>B-Frame</strong> kann von der Zukunft abh√§ngen.  Dies bedeutet, dass zur Berechnung des B-Frames auch zuk√ºnftige Frames von der Kamera stammen m√ºssen.  Nur dann kann ein B-Frame mit einer gewissen Verz√∂gerung decodiert werden. <br></li></ul><br>  Dies zeigt, dass <strong>B-</strong> <strong>Frames sch√§dlich sind</strong> .  Versuchen wir, sie zu entfernen. <br><br><ol><li>  Wenn Sie von einem mobilen Ger√§t streamen, k√∂nnen Sie versuchen <strong>, das Basisprofil zu aktivieren</strong> .  Dadurch wird der B-Frame deaktiviert. <br></li><li>  Sie k√∂nnen versuchen, den Codec zu konfigurieren und die Verz√∂gerung f√ºr zuk√ºnftige Frames zu verringern, damit Frames schneller eintreffen. <br></li><li>  Eine weitere wichtige Sache bei der Optimierung des Codecs ist die <strong>Einbeziehung von CBR</strong> (konstante Bitrate). <br></li></ol><br><img src="https://habrastorage.org/webt/yu/xr/0t/yuxr0tpvsdyvqzkfxd_c7k4rop4.jpeg"><br>  Wie Codecs funktionieren, ist in der obigen Folie dargestellt.  In diesem Beispiel ist das Video ein statisches Bild, dessen Codierung Speicherplatz spart, weil  Dort √§ndert sich fast nichts und die Videobitrate ist niedrig.  √Ñnderungen finden statt - die Entropie w√§chst, die Videobitrate w√§chst - es ist gro√üartig, sie auf der Festplatte zu speichern. <br><br>  Aber in dem Moment, in dem die aktiven √Ñnderungen begannen und die Bitrate zunahm, w√ºrden sich h√∂chstwahrscheinlich nicht alle Daten in das Netzwerk einschleichen.  Dies ist genau das, was passiert, wenn Sie einen Videoanruf t√§tigen und sich umdrehen und Ihr Abonnent das Bild verlangsamt.  Dies liegt an der Tatsache, dass das Netzwerk keine Zeit hat, sich an die √Ñnderung der Bitrate anzupassen. <br><br>  <strong>Man muss CBR einschlie√üen</strong> .  Nicht alle Android-Codecs werden es korrekt unterst√ºtzen, aber sie werden danach streben.  Das hei√üt, Sie m√ºssen verstehen, dass Sie mit CBR nicht das perfekte Bild der Welt erhalten, wie im unteren Bild, aber es lohnt sich trotzdem, es einzuschalten. <br><br>  4. Und im Backend m√ºssen Sie H264 den <strong>Nullcatency-</strong> Codec hinzuf√ºgen. <strong>Dadurch</strong> k√∂nnen Sie f√ºr die Zukunft keine Abh√§ngigkeiten in Frames herstellen. <br><br><h2>  Video√ºbertragungsprotokolle </h2><br>  √úberlegen Sie, welche Streaming-Protokolle die Branche anbietet.  Ich habe sie bedingt in zwei Typen unterteilt: <br><br><ol><li>  Streaming-Protokolle; <br></li><li>  Segmentprotokolle. <br></li></ol><br><img src="https://habrastorage.org/webt/hc/fr/qn/hcfrqnga93h7wofbe6j8ojk1h4g.jpeg"><br>  <strong>Streaming-Protokolle</strong> sind Protokolle aus der Welt der P2P-Aufrufe: <strong>RTMP, webRTC, RTSP / RTP</strong> .  Sie unterscheiden sich darin, dass Benutzer sich √ºber den Kanal einig sind und die Codec-Bitrate entsprechend dem Kanal ausw√§hlen.  Und sie haben auch zus√§tzliche Teams dieser Art, wie zum Beispiel "Gib mir einen Referenzschuss".  Wenn Sie einen Frame verloren haben, k√∂nnen Sie ihn in diesen Protokollen erneut anfordern. <br><br>  Der Unterschied zwischen <strong>Segmentprotokollen</strong> besteht darin, dass niemand mit jemandem verhandelt.  Sie schneiden Videos in Segmente, speichern jedes Segment in verschiedenen Qualit√§ten und der Kunde kann ausw√§hlen, welches Segment er ansehen m√∂chte.  Jedes Segment beginnt mit einem Referenzrahmen. <br><br>  Betrachten Sie die Protokolle genauer.  Beginnen wir mit Streaming-Protokollen und finden heraus, auf welche Probleme wir sto√üen k√∂nnen, wenn wir Streaming-Protokolle f√ºr Broadcast-Streaming verwenden. <br><br><h3>  Streaming-Protokolle </h3><br>  Periscope verwendet RTMP.  Dieses Protokoll wurde 2009 ver√∂ffentlicht und von Adobe zun√§chst nicht vollst√§ndig spezifiziert.  Dann hatte er eine gewisse Schwierigkeit damit, dass Adobe ausschlie√ülich seinen Server verkaufen wollte.  Das hei√üt, RTMP entwickelte sich ziemlich schwierig.  Sein Hauptproblem ist, dass <strong>er TCP verwendet</strong> , aber aus irgendeinem Grund hat Periscope ihn ausgew√§hlt. <br><br><img src="https://habrastorage.org/webt/p3/qf/8x/p3qf8x_qmpcxxs1ydjzdrewzpv8.jpeg"><br><br>  Wenn Sie ausf√ºhrlich lesen, stellt sich heraus, dass Periscope RTMP verwendet, um mit einer kleinen Anzahl von Zuschauern zu senden.  Gerade solche Sendungen, wenn Sie einen unzureichenden Kanal haben, k√∂nnen Sie h√∂chstwahrscheinlich nicht sehen. <br><br><img src="https://habrastorage.org/webt/42/cc/oy/42ccoy-bvsta9_1wi47vsetzrpy.jpeg"><br><br>  Betrachten Sie ein bestimmtes Beispiel.  Es gibt einen Benutzer mit einem engen Kommunikationskanal, der Ihre Sendung sieht.  Sie stimmen ihm bei RTMP bez√ºglich der niedrigen Bitrate zu und beginnen, f√ºr ihn pers√∂nlich zu streamen. <br><br>  Ein Benutzer mit coolem Internet kommt zu Ihnen, Sie haben auch cooles Internet, aber Sie haben sich bereits auf eine schlechte Qualit√§t mit jemandem geeinigt, und es stellt sich heraus, dass dieser dritte Benutzer mit coolem Internet einen Stream in schlechter Qualit√§t sieht, obwohl dies m√∂glich ist gut aussehen <br><br>  Wir haben uns entschlossen, dieses Problem zu beheben.  Wir haben es m√∂glich gemacht, dass RTMP f√ºr jeden Client einzeln abgeschnitten wird, dh, Streamer verhandeln mit dem Server, streamen mit der h√∂chstm√∂glichen Qualit√§t und jeder Client erh√§lt die Qualit√§t, die das Netzwerk zul√§sst. <br><br>  Wow! <br><br>  Trotzdem haben wir RTMP √ºber TCP und niemand hat uns versichert, den Beginn der Warteschlange zu blockieren. <br><br><img src="https://habrastorage.org/webt/pr/ri/db/prridbql3upjieh2baseexcnkoa.jpeg"><br><br>  Dies ist in der Abbildung dargestellt: Wir empfangen Audio- und Videobilder, RTMP packt sie, vielleicht mischen sie sie irgendwie und sie fliegen zum Netzwerk. <br><br>  Angenommen, wir verlieren ein Paket.  Es ist m√∂glich, dass dasselbe gelbe verlorene Paket - dies ist im Allgemeinen ein P-Frame von einem vorherigen - verworfen wurde.  Vielleicht k√∂nnte man zumindest Audio abspielen.  TCP gibt uns jedoch nicht den Rest der Pakete, da es <strong>die Zustellung und die Reihenfolge der Pakete garantiert</strong> .  Wir m√ºssen irgendwie damit umgehen. <br><br><img src="https://habrastorage.org/webt/me/vz/at/mevzattuvqxtwrbnu61ubb40nm8.jpeg"><br>  Es gibt ein weiteres Problem bei der Verwendung des TCP-Protokolls beim Streaming. <br><br>  Nehmen wir an, wir haben einen Puffer und eine hohe Netzwerkbandbreite.  Dort generieren wir aus unserem Codec hochaufl√∂sende Pakete.  Dann - op!  - Das Netzwerk begann schlechter zu funktionieren.  Im Codec haben wir bereits angegeben, dass die Bitrate gesenkt werden muss, aber fertige Pakete befinden sich bereits in der Warteschlange und <strong>Sie k√∂nnen sie</strong> in keiner Weise <strong>von dort entfernen</strong> .  TCP ist verzweifelt daran interessiert, HD-Pakete durch unser 3G zu √ºbertragen. <br><br>  Wir haben keine Pufferverwaltung, keine Priorisierung, daher ist <strong>TCP f√ºr das Streaming √§u√üerst ungeeignet</strong> . <br><br><img src="https://habrastorage.org/webt/nh/ed/xr/nhedxrx0krpqjjtcq3txpq4a0_i.jpeg"><br><br>  Werfen wir jetzt einen Blick auf Mobilfunknetze.  F√ºr die Einwohner der Hauptst√§dte mag es √ºberraschend sein, aber unser durchschnittliches Mobilfunknetz sieht ungef√§hr so ‚Äã‚Äãaus: <br><br><ul><li>  1,1 Mbit / s Verkehr; <br></li><li>  0,1% Paketverlust; <br></li><li>  300 ms durchschnittliche RTT. <br></li></ul><br>  Wenn Sie sich einige Regionen und bestimmte Betreiber ansehen, haben sie einen <strong>durchschnittlichen t√§glichen Paketverlust von mehr als 3%</strong> , und eine RTT von 600 ms ist normal. <br><br>  TCP ist einerseits ein cooles Protokoll - es ist sehr schwierig, einem Auto das Fahren auf Autobahnen und im Gel√§nde beizubringen.  Aber es war sehr schwierig, ihr dann auch das Fliegen √ºber drahtlose Netzwerke beizubringen. <br><br><img src="https://habrastorage.org/webt/7d/1u/la/7d1ula7h-j6sf-4mb4xyw-pqi_m.jpeg"><br><br><blockquote>  Der Verlust von sogar 0,001% der Pakete f√ºhrt zu einer Reduzierung des Durchsatzes um 30%.  Das hei√üt, unser Benutzer nutzt den Kanal aufgrund der Ineffizienz des TCP-Protokolls in Netzwerken mit zuf√§lligem Paketverlust nicht zu 30%. <br></blockquote><br>  In bestimmten Regionen erreicht der Paketverlust 1%, dann hat der Benutzer ungef√§hr 10% Prozent der Bandbreite. <br><br>  Daher werden <strong>wir kein TCP durchf√ºhren</strong> . <br><br>  Mal sehen, was es sonst noch in der Welt des Streaming von UDP gibt. <br><br>  <strong>Das WebRTC-Protokoll</strong> hat bei P2P-Aufrufen sehr gut funktioniert.  Auf sehr beliebten Websites schreiben sie, dass es sehr cool ist, es f√ºr Anrufe zu verwenden, aber f√ºr die Bereitstellung von Video und Musik ist es nicht gut. <br><br>  Sein Hauptproblem ist, dass er <strong>Verluste vernachl√§ssigt</strong> .  Bei all den seltsamen Situationen l√§sst er sich einfach fallen. <br><br>  Es gibt immer noch ein Problem in seiner Bindung an Anrufe, Tatsache ist, dass er alles verschl√ºsselt.  Wenn Sie also Broadcasts senden und nicht den gesamten Audio- / Videostream durch Starten von WebRTC verschl√ºsseln m√ºssen, wird Ihr Prozessor trotzdem belastet.  M√∂glicherweise ben√∂tigen Sie dies nicht. <br><br><img src="https://habrastorage.org/webt/h4/qq/1o/h4qq1o8awojsly2-fo-mggjb30y.jpeg"><br><br>  <strong>RTP-Streaming</strong> ist das Basisprotokoll f√ºr die Daten√ºbertragung √ºber UDP.  Unten auf der Folie rechts finden Sie eine Reihe von Erweiterungen und RFCs, die in WebRTC implementiert werden mussten, um dieses Protokoll f√ºr Anrufe anzupassen.  Im Prinzip k√∂nnen Sie versuchen, so etwas zu tun: W√§hlen Sie eine Reihe von Nebenstellen f√ºr RTP und erhalten Sie UDP-Streaming.  <strong>Aber es ist sehr schwierig</strong> . <br><br>  Das zweite Problem ist, dass das Protokoll nicht funktioniert, wenn einer Ihrer Clients keine Erweiterung unterst√ºtzt. <br><br><img src="https://habrastorage.org/webt/vi/ny/wl/vinywlwh6wfdwrrfznzoiccjjzc.jpeg"><br><br><h3>  Segmentprotokolle </h3><br>  Ein gutes Beispiel f√ºr ein segmentiertes Videoprotokoll ist <strong>MPEG-Dash</strong> .  Es besteht aus einer Manifest-Datei, die Sie auf Ihrem Portal ver√∂ffentlichen.  Es enth√§lt Links zu Dateien in verschiedenen Qualit√§ten. Am Anfang der Datei befindet sich ein Index, der angibt, an welcher Stelle der Datei welches Segment beginnt. <br><br><img src="https://habrastorage.org/webt/9x/kd/py/9xkdpywmis1cfrdrmx6peob2gag.jpeg"><br><br>  Das gesamte Video ist in Segmente unterteilt, z. B. 3 Sekunden lang, wobei jedes Segment mit einem Referenzrahmen beginnt.  Wenn Sie sich ein solches Video ansehen und sich Ihre Bitrate √§ndert, beginnen Sie nur auf der Clientseite, das Segment der Qualit√§t zu √ºbernehmen, das Sie ben√∂tigen. <br><br>  Ein weiteres Beispiel f√ºr segmentiertes Streaming ist <strong>HLS</strong> . <br><br>  MPEG-Dash ist eine L√∂sung von Google, funktioniert gut in Android und die Apple-L√∂sung ist √§lter und weist eine Reihe bestimmter Nachteile auf. <br><br><img src="https://habrastorage.org/webt/ed/jv/wv/edjvwvr9g_-n_tihydmscth_rym.jpeg"><br><br>  Das erste ist, dass das Hauptmanifest Links zu sekund√§ren Manifesten enth√§lt, die sekund√§ren Manifeste f√ºr jede bestimmte Qualit√§t Links zu jedem einzelnen Segment enthalten und jedes einzelne Segment durch eine separate Datei dargestellt wird. <br><br>  Wenn Sie noch genauer hinschauen, befindet sich in jedem Segment MPEG2-TS.  Dieses Protokoll wurde auch f√ºr den Satelliten erstellt, seine Paketgr√∂√üe betr√§gt <strong>188 Bytes</strong> .  Es ist sehr unpraktisch, Videos in dieser Gr√∂√üe zu packen, insbesondere weil Sie sie st√§ndig mit einem kleinen Header versehen. <br><br>  Tats√§chlich ist dies nicht nur f√ºr Server schwierig, die zur Verarbeitung von 40 GB Datenverkehr <strong>26 Millionen Pakete</strong> sammeln m√ºssen, sondern auch f√ºr den Client.  Daher haben wir beim Umschreiben des iOS-Players auf MPEG-Dash sogar einige Leistungssteigerungen festgestellt. <br><br><img src="https://habrastorage.org/webt/li/iy/-b/liiy-bk2b4hbreygtlsrypgykb4.jpeg"><br><br>  Aber Apple steht nicht still.  2016 gaben sie schlie√ülich bekannt, dass sie die M√∂glichkeit haben, ein Fragment von MPEG4 in HLS zu verschieben.  Dann versprachen sie, dies nur f√ºr Entwickler hinzuzuf√ºgen, aber es scheint, dass jetzt Unterst√ºtzung f√ºr MacOS und iOS erscheinen sollte. <br><br>  Das hei√üt, es scheint, dass Fragment-Streaming praktisch ist - kommen Sie, nehmen Sie das gew√ºnschte Fragment, beginnen Sie mit dem Referenzrahmen - es funktioniert. <br><br>  Minus: Es ist klar, dass der Referenzrahmen, von dem aus Sie gestartet haben, nicht der Rahmen ist, den derjenige, der ihn jetzt streamt, hat.  Daher <strong>gibt es immer eine Verz√∂gerung</strong> . <br><br>  Im Allgemeinen ist es m√∂glich, HLS mit Verz√∂gerungen in der Gr√∂√üenordnung von 5 Sekunden zu beenden. Jemand sagt, er habe es geschafft, 4 zu erhalten, aber im Prinzip ist die <strong>Entscheidung, Fragment-Streaming f√ºr die √úbersetzung zu verwenden, nicht sehr gut</strong> . <br><br><img src="https://habrastorage.org/webt/ot/5d/fx/ot5dfxmgkfjri9h6uqxttl7dwoo.jpeg"><br><br><h3>  Schwierigkeit gegen Verz√∂gerung </h3><br>  Schauen wir uns alle verf√ºgbaren Protokolle an und sortieren sie nach zwei Parametern: <br><br><ul><li>  die Latenz, die sie zwischen der Sendung und dem Zuschauer geben; </li><li>  Komplexit√§t </li></ul><br>  Je k√ºrzer die vom Protokoll garantierte Verz√∂gerung ist, desto komplexer ist es. <br><br><img src="https://habrastorage.org/webt/va/or/jm/vaorjm1gkqcpwvxf1eos4uds90a.jpeg"><br><br><h3>  Was wollen wir </h3><br>  Wir m√∂chten ein UDP-Protokoll f√ºr das Streaming von 1 nach N mit einer Verz√∂gerung erstellen, die mit der P2P-Kommunikation vergleichbar ist, mit der Option der optionalen Verschl√ºsselung von Paketen, je nachdem, ob es sich um eine private oder eine √∂ffentliche Sendung handelt. <br><br>  <strong>Welche anderen M√∂glichkeiten gibt es?</strong>  Sie k√∂nnen beispielsweise warten, bis Google sein QUIC ver√∂ffentlicht. <br><br>  Ich werde Ihnen ein wenig sagen, was es ist.  Google positioniert Google QUIC als Ersatz f√ºr TCP - eine Art TCP 2.0.  Es wurde seit 2013 entwickelt, hat jetzt keine Spezifikation, ist aber in Google Chrome vollst√§ndig verf√ºgbar, und es scheint mir, dass sie es manchmal f√ºr einige Benutzer aktivieren, um zu sehen, wie es funktioniert.  Im Prinzip k√∂nnen Sie in die Einstellungen gehen, QUIC aktivieren, zu einer beliebigen Google-Site gehen und diese Ressource √ºber UDP abrufen. <br><br>  Wir haben uns entschlossen, nicht zu warten, bis alle angegeben sind, und unsere Entscheidung einzureichen. <br><br>  Protokollanforderungen: <br><br><ol><li>  <strong>Multithreading</strong> , das hei√üt, wir haben mehrere Streams - Steuerung, Video, Audio. <br></li><li>  <strong>Eine optionale Liefergarantie</strong> - der Kontrollstrom hat eine 100% ige Garantie, das Video, das wir am wenigsten ben√∂tigen - wir k√∂nnen den Frame dort ablegen, wir m√∂chten immer noch Audio. <br></li><li>  <strong>Priorisierung von Streams</strong> - damit das Audio vorw√§rts geht und der Manager im Allgemeinen fliegt. <br></li><li>  <strong>Optionale Verschl√ºsselung</strong> : entweder alle Daten oder nur Header und kritische Daten. <br></li></ol><br><img src="https://habrastorage.org/webt/k6/un/6t/k6un6tc2qxdngdgbjgvycugso80.jpeg"><br><br>  Dies ist ein Standarddreieck: Wenn ein gutes Netzwerk, dann hohe Qualit√§t und geringe Latenz.  Sobald ein instabiles Netzwerk auftritt und Pakete verschwinden, gleichen wir Qualit√§t und Verz√∂gerung aus.  Wir haben die Wahl: entweder warten, bis das Netzwerk besser wird, und alles senden, was sich angesammelt hat, oder absteigen und irgendwie damit leben. <br><br>  Wenn Sie die Protokolle nach diesem Prinzip sortieren, ist klar, dass <strong>die Qualit√§t</strong> umso <strong>schlechter</strong> ist, je <strong>k√ºrzer die Wartezeit ist</strong> - eine ziemlich einfache Schlussfolgerung. <br><br>  Wir wollen unser Protokoll in die Zone keilen, in der die Verz√∂gerungen in der N√§he von WebRTC liegen, aber gleichzeitig in der Lage sein, es ein wenig zu pushen, weil wir schlie√ülich keine Anrufe haben, sondern Sendungen.  Der Benutzer m√∂chte letztendlich einen Qualit√§tsstrom erhalten. <br><br><h2>  Entwicklung </h2><br>  Beginnen wir mit dem Schreiben des UDP-Protokolls, aber schauen wir uns zuerst die Statistiken an. <br><br><img src="https://habrastorage.org/webt/7f/pa/g2/7fpag2oc-8grjh0sprl-xjok9hg.jpeg"><br><br>  Dies sind unsere Statistiken zu Mobilfunknetzen.  Es ist ersichtlich, dass das durchschnittliche Internet etwas mehr als Megabit betr√§gt, ein Paketverlust von etwa 1% normal ist und RTT im Bereich von 600 ms - bei 3G sind dies nur Durchschnittswerte. <br><br>  Wir werden uns beim Schreiben des Protokolls darauf konzentrieren - lass uns gehen! <br><br><h2>  UDP-Protokoll </h2><br>  Wir √∂ffnen Socket UDP, wir nehmen die Daten weg, wir packen, wir senden.  Wir nehmen das zweite Paket aus dem Codec, den wir noch senden.  Alles scheint gro√üartig zu sein! <br><br><img src="https://habrastorage.org/webt/_z/mn/pb/_zmnpbiqjqaylvgxteujqyehvi4.jpeg"><br><br>  Wir erhalten jedoch das folgende Bild: Wenn wir anfangen, UDP-Pakete zuf√§llig an den Socket zu senden, betr√§gt die Wahrscheinlichkeit, dass es bis zum 21. Paket erreicht wird, laut Statistik nur 85%.  Das hei√üt, der Paketverlust betr√§gt bereits 15%, was nicht gut ist.  Dies muss behoben werden. <br><br><img src="https://habrastorage.org/webt/-k/9x/yf/-k9xyfgw5atqxwbfgsoz4hwdzpo.jpeg"><br><br>  Dies ist standardm√§√üig festgelegt.  Die Abbildung zeigt das Leben ohne Pacer und das Leben mit <strong>Pacer</strong> . <br><br>  Pacer ist so etwas, das Pakete rechtzeitig verbreitet und ihren Verlust kontrolliert.  Es wird untersucht, was der Paketverlust jetzt ist, abh√§ngig davon passt es sich an die Kanalgeschwindigkeit an. <br><br>  Wie wir uns erinnern, ist bei Mobilfunknetzen ein Paketverlust von 1 bis 3% die Norm.  Dementsprechend m√ºssen wir irgendwie damit arbeiten.  Was ist, wenn wir Pakete verlieren? <br><br><h3>  Erneut √ºbertragen </h3><br><img src="https://habrastorage.org/webt/rm/6c/sn/rm6csnnevyp8uer3y_88usgnxvi.jpeg"><br><br>  Wie Sie wissen, gibt es in TCP einen schnellen Neu√ºbertragungsalgorithmus: Wir senden ein Paket, das zweite, wenn das Paket verloren geht, und nach einer Weile (Neu√ºbertragungsperiode) senden wir dasselbe Paket. <br><br>  Was sind die Vorteile?  Keine Probleme, keine Redundanz, aber es gibt ein Minus - eine gewisse <strong>Zeit f√ºr die erneute √úbertragung</strong> . <br><br><img src="https://habrastorage.org/webt/wa/91/8x/wa918xscu2p_r9dym0hxtexa-te.jpeg"><br><br>  Es scheint sehr einfach zu sein: Nach einiger Zeit m√ºssen Sie das Paket wiederholen, wenn Sie keine Best√§tigung erhalten haben.  Logischerweise kann dies eine Zeit sein, die der Ping-Zeit entspricht.  ping ‚Äî    ,      RTT time ,   ,   . <br><br>  ,    , ,   ,  jitter:       ping-. ,   ,    46 .     jitter ‚Äî 50. <br><br><img src="https://habrastorage.org/webt/tc/ut/qp/tcutqprunmcey5nsfas7jobk1ju.jpeg"><br><br>        .   RTT   ,      ,  acknowledge      .  ,  RFC6298,   TCP ,     . <br><br>     jitter.     jitter  ping  15%. ,  retransmit period  ,  ,  20% ,  RTT. <br><br><img src="https://habrastorage.org/webt/ro/0f/ut/ro0futlozzfwqp7frtgd4-26ufg.jpeg"><br><br>     retransmit.       acknowledge   .    ,  ,    .    retransmit period,       .    ,      . <br><br>       ,   retransmit   .   , , packet loss 5%,    400 ,   400    1      packet-drop,  ,    retransmit period  ,      . <br><br>    ,   .    , ,    acknowledge   . ,   ‚Äî   ,       ,  speculative retransmit   . <br><br>      retransmit,     . <br><br>      .  ,   <strong>Forward Error Correction</strong> ?      , , XOR.    ,       ,       . <br><br><img src="https://habrastorage.org/webt/zd/b1/pe/zdb1pedfxegynl5dx-m7qopdgqw.jpeg"><br><br>  Wow!     round trip,      . <br><br>  ,     ,   ?   XOR    ‚Äî ,   Reed-Solomon, Fountain codes  ..  :   K ,     N  ,   N   . <br><br>   ! <br><br> ,      ,     ,    Forward Error Correction    negative acknowledgement. <br><br><h3> NACK </h3><br><img src="https://habrastorage.org/webt/yy/6d/uv/yy6duvocxiqc43veskkksrfj7s0.jpeg"><br><br>     ,   parity protection (  )    ,    . <br><br>  NACK: <br><br><ul><li>   ,      negative acknowledgement,    . <br></li><li>    FEC. <br></li></ul><br> ,    : <br><br><ol><li>   , FEC + NACK; <br></li><li>   , Fast retransmit. <br></li></ol><br> ,    . <br><br><img src="https://habrastorage.org/webt/zs/tg/dr/zstgdrqijyhnsnbfx4xfpgfixa8.jpeg"><br><br> ,        ,   (  ).    , ,  11 ,     60-80 .  ,   ,   . <br><br>        6 . <br><br><img src="https://habrastorage.org/webt/7p/bm/1e/7pbm1elkbfopc4zogdohequo4zo.jpeg"><br><br>     ,    ,    .    ,    . , Wi-Fi  22    5 , 3G   34   8 . <br><br><img src="https://habrastorage.org/webt/-1/7_/sg/-17_sgwf_vd6x88lryeyqarozfq.jpeg"><br><br> :   ,    90% packet loss     10 ,     gap  25 ,     ‚Äî FEC + NACK  Fast retransmit? <br><br> , ,  ,  Google,     QUIC  2013 ,  Forward Error Correction  , ,     .   2015   . <br><br>           FEC + NACK,       . <br><br> ,   . <br><br><img src="https://habrastorage.org/webt/vo/vx/en/vovxendpcptrbqle5r-_dsphz7o.jpeg"><br><br>  ,    , c    : <br><br><ul><li> 1 / ; <br></li><li> 1% packet loss; <br></li><li> 300  RTT; <br></li><li> 1 000  ‚Äî   ; <br></li><li> 1 000    . <br></li></ul><br>        10 .   packet loss  1%    1 000   10.  ‚Äî    100   1 ‚Äî  ,        2 ,   . <br><br>     ,     .    500- ,      10 . <br><br>    : <br><br><ul><li>   500      Forward Error Correction.        ,     . <br></li><li>   NACK,   ,    . <br></li><li>      Fast Retransmit,           . <br></li></ul><br>  Forward Error Correction  ,       ‚Äî  gap      200-300     . <br><br><h3> Fast Retransmit </h3><br>   :  ,      10 ,    , ,    retransmit period ,     . <br><br><img src="https://habrastorage.org/webt/uf/8l/vu/uf8lvu8cm-golfpmgpng1rln25y.jpeg"><br><br>    ,  retransmit period     350 ,     packet gap ‚Äî 25-30 ,   100.  ,   ,  retransmit   ,         . <br><br>   ,       . <br><br><h3>  Zus√§tzliche Optionen </h3><br>       UDP       ,    . <br><br><img src="https://habrastorage.org/webt/rh/lr/nf/rhlrnfukoaeiiy8vxnrku7qbopg.jpeg"><br><br>   ,     ,   p/b-.     .      ,      . <br><br>  ,      ,    ,     ,   , ,  0,5          . <br><br>  ,    ,       ,     ,    p/b,   ,       ,     . <br><br><h3> MTU </h3><br>  Da wir das Protokoll selbst schreiben, m√ºssen wir uns mit der IP-Fragmentierung befassen.  Ich denke, viele Leute wissen davon, aber nur f√ºr den Fall, ich werde es Ihnen kurz sagen. <br><br><img src="https://habrastorage.org/webt/wy/wy/lt/wywyltg-bw2a3ypzpvmkpz1zcsw.jpeg"><br><br>  Wir haben einen Server, der einige Pakete an das Netzwerk sendet, sie kommen zum Router und auf seiner Ebene wird die MTU (maximale √úbertragungseinheit) niedriger als die Gr√∂√üe des angekommenen Pakets.  Es teilt das Paket in gro√üe und kleine (hier 1100 und 400 Bytes) und sendet. <br><br>  Im Prinzip gibt es kein Problem, alles sammelt sich auf dem Client und funktioniert.  Wenn wir jedoch 1 Paket verlieren, verwerfen wir alle Pakete und erhalten zus√§tzliche Kosten f√ºr Paket-Header.  Wenn Sie Ihr Protokoll schreiben, ist es daher ideal, in der Menge an MTU zu arbeiten. <br><br>  <strong>Wie z√§hlt man es?</strong> <br><br>  Tats√§chlich k√ºmmert sich Google nicht darum, f√ºgt ungef√§hr 1200 Bytes in sein QUIC ein und w√§hlt es nicht aus, da dann die IP-Fragmentierung alle Pakete sammelt. <br><br><img src="https://habrastorage.org/webt/lj/q0/eu/ljq0eutloqqgituniq6jhfodjwo.jpeg"><br><br>  Wir machen genau das Gleiche - zuerst legen wir eine Standardgr√∂√üe fest und beginnen mit dem Senden von Paketen - lassen Sie sie fragmentieren. <br><br>  F√ºhren Sie parallel einen separaten Thread aus und erstellen Sie einen Socket mit dem Fragmentierungsverbotsflag f√ºr alle Pakete.  Wenn der Router auf ein solches Paket st√∂√üt und diese Daten nicht fragmentieren kann, wird das Paket verworfen und Sie m√∂glicherweise per ICMP dar√ºber informiert, dass Probleme vorliegen. H√∂chstwahrscheinlich wird ICMP jedoch geschlossen, und dies geschieht nicht.  Daher versuchen wir beispielsweise einfach dreimal, in einem bestimmten Intervall ein Paket einer bestimmten Gr√∂√üe zu senden.  Wenn es nicht erreicht wird, glauben wir, dass die MTU √ºberschritten wird und reduzieren sie weiter. <br><br>  Mit der MTU der Internetschnittstelle auf dem Ger√§t und einer minimalen MTU w√§hlen wir einfach die richtige MTU durch eindimensionale Suche aus.  Danach passen wir die Paketgr√∂√üe im Protokoll an. <br><br>  Tats√§chlich √§ndert es sich manchmal.  Wir waren √ºberrascht, aber beim Umschalten von Wi-Fi usw. √§ndert sich die MTU.  Es ist besser, diesen parallelen Prozess nicht zu stoppen und die MTU von Zeit zu Zeit zu korrigieren. <br><br><img src="https://habrastorage.org/webt/x5/db/hy/x5dbhy0sbgn990swfjmqp2s9z8w.jpeg"><br><br>  H√∂here MTU-Verteilung in der Welt.  Wir haben ungef√§hr 1100 Bytes auf dem Portal. <br><br><h3>  Verschl√ºsselung </h3><br>  Wir haben gesagt, dass wir optional die Verschl√ºsselung verwalten m√∂chten.  Wir machen die einfachste Option - Diffie-Hellman auf elliptischen Kurven.  Wir tun dies optional - wir verschl√ºsseln nur die Steuerpakete und Header, damit Man-in-the-Middle den Broadcast-Schl√ºssel nicht empfangen, abfangen und so weiter kann. <br><br><img src="https://habrastorage.org/webt/nn/sv/h3/nnsvh3c3wxoulkrg31ggc8kkvyg.jpeg"><br><br>  Wenn die Sendung privat ist, k√∂nnen wir auch die Verschl√ºsselung aller Daten hinzuf√ºgen. <br><br>  Pakete werden unabh√§ngig mit AES-256 verschl√ºsselt, sodass der Paketverlust die weitere Paketverschl√ºsselung nicht beeintr√§chtigt. <br><br><h3>  Priorisierung </h3><br>  Denken Sie daran, wir wollten mehr Priorisierung aus dem Protokoll. <br><br><img src="https://habrastorage.org/webt/cc/ob/hd/ccobhdbwn5xelxwurrvsz7rxttg.jpeg"><br><br>  Wir haben Metadaten, Audio- und Videobilder, die wir erfolgreich an das Netzwerk senden.  Dann brennt unser Netzwerk in der H√∂lle nieder und funktioniert lange Zeit nicht - wir verstehen, dass wir Pakete verwerfen m√ºssen. <br><br>  Wir verwerfen haupts√§chlich Videopakete, versuchen dann, Audio zu verwerfen und ber√ºhren niemals Steuerpakete, da Daten wie Aufl√∂sungs√§nderungen und andere wichtige Probleme diese durchlaufen k√∂nnen. <br><br><h3>  Zus√§tzliches Br√∂tchen √ºber UDP </h3><br>  Wenn Sie Ihr UDP-Protokoll beispielsweise mit bidirektionaler Kommunikation schreiben, m√ºssen Sie verstehen, dass NAT Unbinding besteht und dass Sie den Client m√∂glicherweise nicht vom Server zur√ºckfinden. <br><br><img src="https://habrastorage.org/webt/zs/my/ii/zsmyiips__dpgzghjbdeovvz_6g.jpeg"><br><br>  Auf der Folie gab es Zeiten, in denen es nicht m√∂glich war, den Client vom Server √ºber UDP zu erreichen. <br><br>  Viele Skeptiker sagen, dass Router so konzipiert sind, dass NAT Unbinding in erster Linie UDP-Routen verdr√§ngt.  Das Obige zeigt jedoch, dass es mit einer Wahrscheinlichkeit von 99% m√∂glich ist, den Client zu erreichen, wenn Keep-Alive oder Ping weniger als 30 Sekunden betr√§gt. <br><br><h3>  UDP-Verf√ºgbarkeit auf Mobilger√§ten weltweit </h3><br><img src="https://habrastorage.org/webt/nt/mv/5u/ntmv5u_uv_pl1jdgabyewmmhk80.jpeg"><br><br>  Google sagt 6%, aber es stellte sich heraus, dass <strong>7% der mobilen Benutzer UDP nicht verwenden k√∂nnen</strong> .  In diesem Fall verlassen wir unser sch√∂nes Protokoll mit Priorisierung, Verschl√ºsselung und allem, nur auf TCP. <br><br>  Unter UDP funktioniert VOIP jetzt unter WebRTC, Google QUIC und viele Spiele unter UDP.  Daher w√ºrde ich nicht glauben, dass UDP auf mobilen Ger√§ten geschlossen wird. <br><br>  Als Ergebnis: <br><br><ul><li>  Die Verz√∂gerung zwischen dem Streamer und dem Watcher wurde auf 1 s reduziert. <br></li><li>  Wir haben den kumulativen Effekt in den Puffern beseitigt, dh die Sendung bleibt nicht zur√ºck. <br></li><li>  Die Anzahl der <strong>St√§nde</strong> im Publikum hat <strong>abgenommen</strong> . <br></li><li>  Sie konnten Streaming auf Mobilger√§ten FullHD unterst√ºtzen. <br></li></ul><br><img src="https://habrastorage.org/webt/im/ql/le/imqlle87zr_gdvhaflkcxe-25_q.jpeg"><br><ul><li>  Die Verz√∂gerung in unserer mobilen OK Live-Anwendung ist 25 ms - 10 ms l√§nger als der Kamerascanner, aber nicht so be√§ngstigend. <br></li><li>  Webcasting zeigt eine Verz√∂gerung von nur 690 ms - Speicherplatz! <br></li></ul><br><h2>  Was kann man sonst noch auf Odnoklassniki streamen </h2><img src="https://habrastorage.org/webt/le/zu/zc/lezuzc64qct36iohbnoyukuab8o.jpeg"><br><br><ul><li>  Akzeptiert unser OKMP-Protokoll von Mobilger√§ten. <br></li><li>  kann RTMP und WebRTC akzeptieren; <br></li><li>  gibt HLS, MPEG-Dash usw. aus. <br></li></ul><br>  Wenn Sie vorsichtig waren, haben Sie bemerkt, dass ich gesagt habe, wir k√∂nnen beispielsweise WebRTC vom Benutzer nehmen und in RTMP konvertieren. <br><br><img src="https://habrastorage.org/webt/me/hc/3c/mehc3cteyxhn2hcsrjd1vmx9z_y.jpeg"><br><br>  Es gibt eine Nuance.  Tats√§chlich ist WebRTC ein paketorientiertes Protokoll und verwendet den OPUS-Audiocodec.  Sie k√∂nnen OPUS nicht in RTMP verwenden. <br><br>  Auf Backend-Servern verwenden wir RTMP √ºberall.  Daher mussten wir einige Korrekturen in FF MPEG vornehmen, die es uns erm√∂glichen, OPUS in RTMP zu verschieben, es in AAC zu konvertieren und es Benutzern zu geben, die bereits in HLS oder etwas anderem sind. <br><br><h2>  Wie sieht es in uns aus? </h2><img src="https://habrastorage.org/webt/v_/s2/z4/v_s2z4ja4xlfcuacadyelfpcdj0.jpeg"><br><br><ul><li>  Benutzer, die eines der Protokolle verwenden, laden das Originalvideo auf unseren Upload-Server hoch. <br></li><li>  Dort setzen wir das Protokoll ein. <br></li><li>  Wir senden RTMP an einen der Videotransformationsserver. <br></li><li>  Das Original wird immer in einem verteilten Speicher gespeichert, damit nichts verloren geht. <br></li><li>  Danach gehen alle Videos zum Verteilungsserver. <br></li></ul><br>  F√ºr Eisen haben wir Folgendes: <br><br><img src="https://habrastorage.org/webt/hb/zc/nl/hbzcnl6smz5tevhx5ud_phg0m0q.jpeg"><br>  Ich erz√§hle Ihnen etwas mehr √ºber Fehlertoleranz: <br><br><ul><li>  Upload-Server sind in verschiedenen Rechenzentren verteilt und stehen hinter verschiedenen IPs. <br></li><li>  Benutzer kommen, erhalten IP auf DNS. <br></li><li>  Der Upload-Server sendet das Video an die Slicing-Server, die sie schneiden und an die Verteilungsserver weitergeben. <br></li><li>  F√ºr popul√§rere Sendungen f√ºgen wir eine gr√∂√üere Anzahl von Verteilungsservern hinzu. <br></li><li>  Wir speichern alles, was vom Benutzer kam, im Repository, damit wir sp√§ter ein Broadcast-Archiv erstellen und nichts verlieren k√∂nnen. <br></li><li>  Fehlertoleranter Speicher, verteilt auf drei Rechenzentren. <br></li></ul><br>  Um festzustellen, welcher Server derzeit f√ºr die √úbersetzung verantwortlich ist, verwenden wir <strong>ZooKeeper</strong> .  F√ºr jede √úbersetzung speichern wir einen Knoten und erstellen kurzlebige Knoten f√ºr jeden Server.  Tats√§chlich erm√∂glicht dies einem Stream, eine Warteschlange von Servern zu erstellen, die verarbeitet werden.  Immer ist der aktuelle Marktf√ºhrer in dieser Zeile mit der Stream-Verarbeitung besch√§ftigt. <br><br>  Wir werden die Fehlertoleranz schnell testen.  Wir beginnen sofort mit dem Verschwinden des gesamten Rechenzentrums. <br><br>  <strong>Was wird passieren?</strong> <br><br><ul><li>  Der DNS-Benutzer √ºbernimmt die n√§chste IP eines anderen Upload-Servers. <br></li><li>  Zu diesem Zeitpunkt wird ZooKeeper verstehen, dass der Server in diesem Rechenzentrum gestorben ist, und den Slicing-Server f√ºr einen anderen ausw√§hlen. <br></li><li>  Download-Server werden herausfinden, wer jetzt f√ºr die Transformation dieses Streams verantwortlich ist, und ihn verteilen. <br></li></ul><br>  Im Prinzip geschieht dies alles mit minimalen Verz√∂gerungen. <br><br><h2>  Verwendung des Protokolls im Produkt </h2>  Wir haben die OK Live Streaming Mobile App erstellt.  Es ist vollst√§ndig in das Portal integriert.  Dort k√∂nnen Benutzer kommunizieren, Live-Sendungen durchf√ºhren, es gibt eine Karte mit Sendungen, eine Liste mit beliebten Sendungen - im Allgemeinen alles, was Sie wollen. <br><br><img src="https://habrastorage.org/webt/kz/4n/on/kz4nonh4fuveoh5iilwwhipapl8.jpeg"><br><br>  Wir haben auch die M√∂glichkeit hinzugef√ºgt, in FullHD zu senden.  Sie k√∂nnen eine Action-Kamera unter Android mit einem Android-Ger√§t verbinden. <br><br><img src="https://habrastorage.org/webt/pi/ut/ga/piutgamml44x_nzqt41dlg3t9za.jpeg"><br><br>  Jetzt haben wir einen Mechanismus, der Live-√úbertragungen erm√∂glicht.  Zum Beispiel haben wir √ºber OK Live eine direkte Verbindung zum Pr√§sidenten hergestellt und diese im <strong>ganzen Land ausgestrahlt</strong> .  Benutzer sahen zu und konnten √ºber den entgegenkommenden Stream auf Sendung gehen und ihre Fragen stellen. <br><br>  Das hei√üt, zwei entgegenkommende Streams mit einer minimalen Verz√∂gerung bieten ein bestimmtes Format f√ºr √∂ffentliche Konferenzen. <br><br>  Tats√§chlich haben wir uns in 2 Sekunden irgendwo getroffen - eine Sekunde dort und eine Sekunde zur√ºck.  Denken Sie an den ‚ÄûWagen‚Äú, √ºber den ich am Anfang des Artikels gesprochen habe - jetzt sieht es aus wie zwei riesige Lastwagen.  Bei Fernsehsendungen ist es v√∂llig normal, von der Kamera zu entfernen und alles mit einer Verz√∂gerung von ca. 1-2 s zu mischen. <br><br>  Tats√§chlich ist es uns gelungen, etwas zu reproduzieren, das mit dem aktuellen modernen TCP vergleichbar ist. <br><br><img src="https://habrastorage.org/webt/si/io/dg/siiodgw1g17mn3b1jt8270ezuo8.jpeg"><br><br>  Live-√úbertragungen sind der aktuelle Trend.  In den letzten anderthalb Jahren haben sie sich auf dem OK-Portal verdreifacht (nicht ohne die Hilfe der OK Live-Anwendung). <br><br><img src="https://habrastorage.org/webt/lx/sa/4w/lxsa4wk6ltmz8xefbsunlfbqjrq.jpeg"><br><br>  Alle Sendungen werden standardm√§√üig aufgezeichnet.  Wir haben ungef√§hr 50.000 Streams pro Tag, dies generiert ungef√§hr 17 Terabyte Verkehr pro Tag, aber im Allgemeinen generiert das gesamte Video auf dem Portal ungef√§hr ein Petabyte Daten pro Monat. <br><br><img src="https://habrastorage.org/webt/zg/n3/h6/zgn3h616zrtpcyw7dkgpuwconp4.jpeg"><br><br>  Was haben wir bekommen: <br><br><ul><li>  K√∂nnte die Dauer der Verz√∂gerung zwischen dem Streamer und dem Publikum garantieren. <br></li><li>  Wir haben die erste mobile FullHD-Anwendung f√ºr das Streaming auf einem sich dynamisch √§ndernden mobilen Internetkanal entwickelt. <br></li><li>  Wir haben die M√∂glichkeit, Rechenzentren zu verlieren und gleichzeitig die √úbertragung nicht zu unterbrechen <br></li></ul><br>  Was hast du gelernt: <br><br><ul><li>  Was ist Video und wie kann man es streamen? <br></li><li>  Dass Sie Ihr UDP-Protokoll schreiben k√∂nnen, wenn Sie sicher sind, dass Sie eine ganz bestimmte Aufgabe und bestimmte Benutzer haben. <br></li><li>  Informationen zur Architektur eines Streaming-Dienstes - Video wird eingegeben, konvertiert und beendet. <br></li></ul><br><blockquote>  Bei <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Highload ++ Siberia</a> verspricht Alexander Tobol, √ºber den OK- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Anrufdienst</a> zu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">sprechen.</a> Es wird interessant sein zu wissen, was aus dem, was in diesem Artikel besprochen wurde, angewendet werden konnte und was vollst√§ndig neu implementiert werden musste. <br><br>  Im selben Abschnitt sind Berichte zu hochspezialisierten Themen geplant: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Eugene Rossinsky</a> (ivi) √ºber das System zur Erfassung detaillierter Statistiken √ºber den Betrieb von CDN-Knoten. <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Anton Rusakova</a> (Badoo) √ºber die Integration von Zahlungssystemen ohne eigene Abrechnung. <br></li></ul><br></blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de413479/">https://habr.com/ru/post/de413479/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de413465/index.html">AMD k√ºndigt 32-Core Threadripper 2 an</a></li>
<li><a href="../de413467/index.html">Schnelle und zuverl√§ssige Datensicherung in der Cloud</a></li>
<li><a href="../de413469/index.html">Ein Ged√§chtnistest, bei dem Laptops get√∂tet werden, ist fast eine Detektivgeschichte</a></li>
<li><a href="../de413471/index.html">Freitag Mini Tomy Fancy Toy Retrospektive</a></li>
<li><a href="../de413473/index.html">Entwicklung eines Touch-Z-Wave-Schalters am Akku mit Leuchttasten</a></li>
<li><a href="../de413481/index.html">Exportieren Sie den Testbaum von JMeter in Text</a></li>
<li><a href="../de413485/index.html">GitLab 10.8 ver√∂ffentlicht: Open-Source-Push-Spiegelung und inkrementelle Bereitstellung</a></li>
<li><a href="../de413487/index.html">Was sollte ein Entwickler im Finanzbereich erwarten: Arbeitsbedingungen, Projekte und notwendige F√§higkeiten</a></li>
<li><a href="../de413489/index.html">Wie man einen wirklich sicheren Messenger ausw√§hlt und was die Blockchain damit zu tun hat</a></li>
<li><a href="../de413491/index.html">Food Design Digest, Mai 2018</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>