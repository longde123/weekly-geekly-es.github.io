<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤳🏾 🦄 👨🏾‍🤝‍👨🏽 Station météo sur Arduino de A à Z. Partie 5 🚬 👳🏿 👕</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="La fin. La partie précédente . 


 Table des matières: 


- Partie 1. Exigences. Le choix du fer. Schéma général 
- Partie 2. Logiciel. Unité centrale...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Station météo sur Arduino de A à Z. Partie 5</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/426019/"><p>  La fin.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">La partie précédente</a> . </p><br><p>  Table des matières: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Partie 1. Exigences.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Le choix du fer.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Schéma général</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Partie 2. Logiciel.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Unité centrale, fer</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Partie 3. Unité centrale, logiciel</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Partie 4. Capteur de fenêtre</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Partie 5. MySQL, PHP, WWW, Android</a> </li></ul><br><h1 id="zaokonnyy-datchik-programmnoe-obespechenie">  Capteur extérieur.  Logiciels </h1><br><p>  Parlez du logiciel pour le capteur d'outre-mer.  Après cela, vous obtiendrez un système complet avec lequel vous pourrez déjà expérimenter. </p><br><p>  Permettez-moi de vous rappeler que le <em>serveur</em> est une unité centrale à domicile qui peut communiquer avec Internet via le WiFi, et le <em>client</em> est un capteur prêt à l'emploi qui transmet les données au serveur par voie hertzienne. </p><br><p> Le code source du serveur et du client <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">est ici</a> . <br>  Les textes sources sont accompagnés de commentaires détaillés. </p><br><p>  Presque rien n'a besoin d'être configuré sur le client. </p><a name="habracut"></a><br><p>  L'émetteur radio nRF24L01 +, plus précisément la bibliothèque RadioHead, nécessite la spécification des adresses serveur et client.  Les adresses sont fournies si vous avez plusieurs serveurs et clients.  Une adresse est n'importe quel entier.  Lorsqu'un client envoie un paquet de données à un serveur, il indique à quel serveur ce paquet est destiné.  Le serveur, connaissant à son tour sa propre adresse, détermine si ce paquet lui est destiné. </p><br><p> Par conséquent, <code>SERVER_ADDRESS</code> sur le serveur et sur le client doit être identique, mais <code>CLIENT_ADDRESS</code> pour différents clients doit être différent.  En d'autres termes, si vous connectez un autre nouveau capteur à notre système à l'avenir, alors <code>CLIENT_ADDRESS</code> devra être modifié pour cela. </p><br><pre> <code class="hljs erlang-repl">//     #define SERVER_ADDRESS <span class="hljs-number"><span class="hljs-number">10</span></span> #define CLIENT_ADDRESS <span class="hljs-number"><span class="hljs-number">20</span></span> //     !!!</code> </pre> <br><p>  Le <code>RF_CHANNEL</code> canal radio <code>RF_CHANNEL</code> doit être le même pour tout le monde.  Par défaut, c'est 2. J'ai changé le numéro par défaut, vous pouvez en choisir un autre. </p><br><pre> <code class="hljs objectivec"><span class="hljs-comment"><span class="hljs-comment">//  .       #define RF_CHANNEL 73</span></span></code> </pre> <br><p>  Les réglages du voltmètre pour mesurer la tension d'alimentation de la batterie doivent être modifiés: </p><br><pre> <code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">/   ,   const float r1 = 100400; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ 100K const float r2 = 9960; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ 10K /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/      /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/    http:/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/localhost/arduino</span></span>-secret-<span class="hljs-literal"><span class="hljs-literal">true</span></span>-voltmeter/ const float typVbg = <span class="hljs-number"><span class="hljs-number">1.082</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    <span class="hljs-number"><span class="hljs-number">1.0</span></span> -- <span class="hljs-number"><span class="hljs-number">1.2</span></span> </code> </pre> <br><p>  Pour économiser de l'énergie, la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">bibliothèque légère de faible puissance pour Arduino est utilisée</a> . </p><br><p>  Voici mes mesures de consommation réelles pour l'Arduino Pro Mini avec cette lib: </p><br><ul><li>  généralement 25mA </li><li>  lorsque vous travaillez avec DHT le même </li><li>  avec transmission radio 38 mA </li><li>  à LowPower.idle 15 mA </li><li>  à LowPower.powerdown 7,5 mA </li></ul><br><p>  Le client prend des mesures de température, d'humidité et de tension d'alimentation, regroupe tout cela dans une structure de données, envoie les données au serveur et «s'endort».  Si des erreurs se sont produites pendant le transfert, le transfert est immédiatement répété. </p><br><p>  Le serveur (central, unité d'origine), à ​​son tour, reçoit les données, confirme la réception et les traite. </p><br><h1 id="baza-dannyh-mysql-php-www-server">  Base de données, MySQL, PHP, serveur WWW </h1><br><p>  Après le travail effectué, nous avons une conception entièrement fonctionnelle de la station météo.  Mais maintenant il y a un sou une douzaine de ces stations météorologiques, l'artisanat local n'est plus à la mode.  Après tout, nous avons un Internet des objets. </p><br><p>  Par conséquent, nous parlerons de la façon dont l'accès à ceux-ci est effectué sur votre Internet, nous y attacherons une base de données et une face Web à notre station météo. </p><br><p>  L'énoncé du problème pour la "webcam": </p><br><ul><li>  recevoir et stocker les données de la station météo: température, humidité, pression atmosphérique, tension d'alimentation </li><li>  afficher ces données </li><li>  construire des graphiques. </li></ul><br><p>  Dans ce cas, nous avons besoin d'un hébergement avec prise en charge d'Apache, PHP et MySQL avec le module mysqli.  Et ces conditions sont satisfaites par presque tous les hébergements de la planète Terre.  Ou au lieu d'héberger, votre ordinateur jouera le rôle d'un serveur connecté à un routeur de réseau domestique et disposant d'un accès à Internet. </p><br><h2 id="sozdanie-bazy-dannyh">  Création de base de données </h2><br><p>  Commençons par le tout début, à savoir avec la conception et la création de la base de données. </p><br><p>  Les bases de données sont votre monde et vous pouvez l’étudier pendant longtemps. Nous allons donc brièvement aborder uniquement les éléments dont nous avons directement besoin. </p><br><p>  Tous les scripts SQL se trouvent dans le répertoire <code>weather-station/server/php-sql/</code> </p><br><p>  Où commence la conception de la base de données?  Avec une représentation logique et physique. </p><br><p>  Vue logique ou schéma de base de données: </p><br><ul><li>  Tableau de température et d'humidité DHT </li><li>  capteur de pression et de température tableau de données BMP </li><li>  les tables indiquées n'ont aucune relation entre elles, plus précisément, aucun lien n'est nécessaire. </li></ul><br><p>  Le schéma physique repose sur un SGBD et des types de données spécifiques.  Il est plus facile de démonter avec un exemple spécifique.  Le script SQL <code>make_tables.sql</code> les schémas logiques et physiques. </p><br><p>  Chaque table doit avoir un champ type </p><br><pre> <code class="sql hljs">id INTEGER UNSIGNED NOT NULL AUTO_INCREMENT</code> </pre> <br><p>  Le nom du champ peut différer dans différentes bases de données, mais il n'y a qu'un sens: il s'agit d'un identifiant unique, une clé d'enregistrement.  Pour l'avenir, si vous voyez une base de données dans des tables qui n'ont pas un tel compteur, vous devez savoir que cette base de données a été conçue par une personne très éloignée de la programmation, très probablement des sciences humaines. </p><br><p>  Nous stockons les données des capteurs du même type dans une table; pour les capteurs d'un autre type, nous créons une autre table.  Cela complique légèrement la base de données et la liaison PHP avec celle-ci, mais cela simplifie l'extension ou la modification de l'ensemble du système à l'avenir. </p><br><p>  Il y a deux tableaux dans notre projet.  La table <code>arduino_dht</code> stocke les données des capteurs de type DHT (température, humidité), la table <code>arduino_bmp</code> stocke les données des capteurs de type BMP (température, pression).  Si à l'avenir vous souhaitez avoir, par exemple, un capteur de gaz ou un détecteur de mouvement, alors créez des tableaux supplémentaires, ne soyez pas paresseux.  Si vous connectez un autre capteur de type DHT11 ou DHT22, vous n'avez pas besoin de créer une table supplémentaire, utilisez la table <code>arduino_dht</code> .  J'espère que le principe est clair: une entité physique distincte est une table distincte. </p><br><p>  Si les données de plusieurs capteurs du même type sont stockées dans un tableau, comment les distinguer?  Pour ce faire, entrez un champ dans chaque table </p><br><pre> <code class="hljs pgsql">idSensor <span class="hljs-type"><span class="hljs-type">INTEGER</span></span></code> </pre> <br><p>  En fait, c'est <code>CLIENT_ADDRESS</code> que nous avons enregistré dans le <code>client/client.ino</code> pour chaque instance du client-client distant et dans <code>server/server.ino</code> pour le capteur qui est connecté directement au serveur - l'unité centrale. </p><br><p>  Dans les systèmes industriels, il devrait y avoir un autre tableau - la correspondance d' <code>idSensor</code> et sa description verbale et lisible par l'homme.  Par exemple, un capteur avec <code>idSensor</code> = 2 est <em>«Température, humidité dans l'appartement»</em> , etc.  Mais dans notre projet, nous ne compliquerons pas, rappelez-vous simplement que: </p><br><ul><li>  un capteur avec <code>idSensor</code> , il s'agit de <code>CLIENT_ADDRESS</code> , égal à 11 - c'est le capteur domestique sur le serveur - l'unité centrale, </li><li>  un capteur avec <code>idSensor</code> , c'est aussi <code>CLIENT_ADDRESS</code> , égal à 20 - c'est le premier (dans notre projet et le seul) client de capteur basé sur la fenêtre. </li></ul><br><p>  Ensuite.  Les tableaux stockent les données suivantes: </p><br><ul><li>  ipRemote - Adresse IP de la station météo (serveur) d'où proviennent les données, utile pour le débogage et la surveillance, </li><li>  dateCreate - date de la création de l'enregistrement, </li><li>  millis - utile pour le débogage, c'est le temps en millisecondes depuis le début de l'esquisse sur l'Arduino, </li><li>  température - température </li><li>  humidité - humidité </li><li>  tension - tension d'alimentation, </li><li>  pression - pression </li><li>  erreurs - le nombre d'erreurs (non utilisées).  Il était destiné à stocker le nombre d'erreurs de transmission, etc., afin que vous puissiez évaluer à distance l'état de l'ensemble du système. </li></ul><br><p>  Comme vous pouvez le voir, les <code>arduino_bmp</code> <code>arduino_dht</code> et <code>arduino_bmp</code> très similaires, la différence ne concerne que les champs de pression et d'humidité, et il y a un désir de tout vider dans un tas (table).  Mais la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">première forme normale</a> n'ordonne pas de le faire, de nombreux programmeurs débutants ont essayé de contourner cela, mais aucun d'entre eux n'a réussi, et nous ne le ferons pas.  Voilà comment ne pas remarquer la loi de la gravitation universelle, pour le moment elle pourrait bien se révéler. </p><br><p>  La table <code>arduino_error_log</code> utile pour le débogage - c'est un journal des erreurs et autres messages système. </p><br><p>  La création d'une base de données et de son utilisateur avec des droits est décrite dans <code>make_db.sql</code> </p><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">-- .  config.php --   CREATE DATABASE IF NOT EXISTS db_weather; --   CREATE USER 'u_weather'@'localhost' IDENTIFIED BY '***PASSWORD***'; GRANT ALL ON db_weather.* TO 'u_weather'@'localhost';</span></span></code> </pre> <br><p>  Ceci est fait une fois, le nom et le nom d'utilisateur de la base de données peuvent venir avec le vôtre.  Et ce qui doit être fait exactement, c'est de définir votre mot de passe. </p><br><h2 id="php-i-veb-server">  PHP et serveur web </h2><br><p>  Tous les paramètres de l'interface Web sont stockés dans <code>config.php</code> .  Modifiez-le en fonction des paramètres de votre base de données. </p><br><p>  Définissez votre fuseau horaire au format PHP </p><br><pre> <code class="hljs lisp">date_default_timezone_set('Europe/Prague')<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><p>  Tous les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">fuseaux horaires</a> disponibles <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sont décrits ici</a> . </p><br><p>  Définissez votre clé secrète pour l'accès (sous forme de nombre) qui doit correspondre à la constante <code>SOURCE_KEY</code> du sketch <code>server.ino</code> </p><br><pre> <code class="hljs perl">$access_key = <span class="hljs-string"><span class="hljs-string">'***KEY***'</span></span>;</code> </pre> <br><p>  Dans notre serveur Web, il n'y a pas d'autorisation, de saisie de mot de passe, cela compliquerait la conception entière.  Pour un prototype, ce n'est pas nécessaire.  Par conséquent, toute la protection repose sur le fichier <code>robots.txt</code> , l'absence d' <code>index.php</code> et cette clé secrète d'accès. </p><br><p>  Le script PHP principal <code>weather.php</code> accepte une simple requête HTTP GET avec des données et les stocke dans les tables de base de données correspondantes.  Si la clé <code>$access_key</code> ne correspond pas, la demande sera rejetée. </p><br><p>  Le <code>weather-view.php</code> utilisé pour afficher les tableaux de données et contient des hyperliens vers d'autres scripts d'interface Web.  Appelez-le comme ça </p><br><pre> <code class="hljs objectivec">http:<span class="hljs-comment"><span class="hljs-comment">// / /weather-view.php?k= access_key</span></span></code> </pre> <br><p>  Par exemple </p><br><pre> <code class="hljs objectivec">http:<span class="hljs-comment"><span class="hljs-comment">//yourhost/iot/weather-view.php?k=12345</span></span></code> </pre> <br><p>  <code>weather-view.php</code> affiche des étiquettes simples où vous devez vous rappeler que: </p><br><ul><li>  le capteur avec l'identifiant 11 est le capteur domestique sur le serveur, </li><li>  Le capteur avec id 20 est un capteur de fenêtre. </li></ul><br><p>  Le script <code>function.php</code> contient des fonctions communes à tous les scripts PHP. </p><br><p>  Le <code>chart-dht.php</code> est responsable de la cartographie à l'aide de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Google Charts</a> .  Voici, par exemple, un graphique de la tension d'alimentation du capteur étranger.  La tension augmente lors d'une journée ensoleillée en raison de la batterie solaire, puis l'alimentation électrique des batteries se décharge progressivement. </p><br><p><img src="https://habrastorage.org/webt/fb/ne/sg/fbnesguoqhfpwcgfa--lcrtpf4m.png" alt="Graphique"></p><br><p>  <code>export-dht.php</code> exporte les données des tables de base de données MySQL vers un fichier CSV.  Pour une importation et une analyse supplémentaires dans des feuilles de calcul. </p><br><p>  <code>export-voltage.php</code> exporte les données sur la tension d'alimentation du capteur de fenêtre de la base de données MySQL vers un fichier CSV.  Utile pour le débogage. </p><br><p>  <code>truncate.php</code> efface toutes les tables, c'est-à-dire  supprime toutes nos données.  Utile pour le débogage.  Il n'y a pas de lien vers ce script depuis <code>weather-view.php</code> , vous devez donc l'appeler via un lien direct dans la barre d'adresse de votre navigateur avec <code>$access_key</code> . </p><br><p>  Lors de la réception de données, la fonction <code>mysqli_real_escape_string()</code> est couramment utilisée pour empêcher des valeurs incorrectes d'entrer dans la base de données. </p><br><p>  N'oubliez pas de mettre <code>robots.txt</code> à la racine de votre site pour l'empêcher de pénétrer dans les moteurs de recherche. </p><br><h1 id="esp8266-wifi-i-peredacha-dannyh">  ESP8266, WiFi et transfert de données </h1><br><p>  Et maintenant, revenons à l'esquisse <code>server.ino</code> , à la partie qui se connecte au point d'accès WiFi et envoie des données au serveur Web. </p><br><p>  Comme je l'ai déjà écrit, je ne pouvais pas trouver une bibliothèque normale pour Arduino pour contrôler le module ESP8266 à l'aide des commandes AT, j'ai dû me "regrouper".  Permettez-moi également de vous rappeler que vous devez flasher une version spécifique du firmware dans ESP8266-01.  Et maintenant, quand tout est prêt, voyons comment cela fonctionne. </p><br><p>  Pour accéder au serveur Web dans l'esquisse <code>server.ino</code> , <code>server.ino</code> devez modifier ces constantes </p><br><pre> <code class="hljs julia"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> DEST_HOST = <span class="hljs-string"><span class="hljs-string">" "</span></span>; //  habr.com <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> DEST_PORT = <span class="hljs-string"><span class="hljs-string">" "</span></span>; //  <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> DEST_URL = <span class="hljs-string"><span class="hljs-string">"/ /weather.php"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> SOURCE_KEY= <span class="hljs-string"><span class="hljs-string">"  "</span></span>; //    $access_key  config.php</code> </pre> <br><p>  Dans <code>server.ino</code> dans la fonction <code>void setup()</code> , l'ESP8266 passe d'abord en mode Station, c'est-à-dire  il commence à fonctionner en tant que client WiFi </p><br><pre> <code class="hljs lisp">espSendCmd(«AT+CWMODE_CUR=1», «OK», <span class="hljs-number"><span class="hljs-number">3000</span></span>)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><p>  puis suit la connexion au point d'accès </p><br><pre> <code class="hljs lisp">espState = espConnectToWiFi()<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><p>  Si la connexion ne se produit pas, la tentative est répétée (une fois) </p><br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( espState != <span class="hljs-type"><span class="hljs-type">ESP_SUCCESS</span></span> ) { delay(<span class="hljs-number"><span class="hljs-number">5000</span></span>); <span class="hljs-type"><span class="hljs-type">Serial</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">println</span></span>(<span class="hljs-string"><span class="hljs-string">"WiFi not connected! Try again ..."</span></span>); espConnectToWiFi(); }</code> </pre> <br><p>  Sélectionnez ensuite le mode de connexion unique TCP / IP </p><br><pre> <code class="hljs lisp">espSendCmd(<span class="hljs-string"><span class="hljs-string">"AT+CIPMUX=0"</span></span>, <span class="hljs-string"><span class="hljs-string">"OK"</span></span>, <span class="hljs-number"><span class="hljs-number">2000</span></span>)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><p>  Lors de l'envoi de données de capteurs de type DHT au serveur Web, une fonction est utilisée qui indique le <code>type=dht</code> données comme <code>type=dht</code> </p><br><pre> <code class="hljs lisp">espSendData( <span class="hljs-string"><span class="hljs-string">"type=dht&amp;t="</span></span> + String(<span class="hljs-name"><span class="hljs-name">dhtData</span></span>.temperature) + <span class="hljs-string"><span class="hljs-string">"&amp;h="</span></span> + String(<span class="hljs-name"><span class="hljs-name">dhtData</span></span>.humidity) + <span class="hljs-string"><span class="hljs-string">"&amp;v="</span></span> + String(<span class="hljs-name"><span class="hljs-name">dhtData</span></span>.voltage) + <span class="hljs-string"><span class="hljs-string">"&amp;s="</span></span> + String(<span class="hljs-name"><span class="hljs-name">CLIENT_ADDRESS</span></span>) )<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><p>  Lors de l'envoi de données de capteurs BMP vers un serveur Web, la même fonction est utilisée avec le type de données indiqué par <code>type=bmp</code> </p><br><pre> <code class="hljs lisp">espSendData( <span class="hljs-string"><span class="hljs-string">"type=bmp&amp;t="</span></span> + String(<span class="hljs-name"><span class="hljs-name">temperature_bmp</span></span>) + <span class="hljs-string"><span class="hljs-string">"&amp;p="</span></span> + String(<span class="hljs-name"><span class="hljs-name">pressure_bmp</span></span>) + <span class="hljs-string"><span class="hljs-string">"&amp;s="</span></span> + String(<span class="hljs-name"><span class="hljs-name">CLIENT_ADDRESS</span></span>) )<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><p>  La fonction <code>espSendData()</code> accepte une chaîne de requête HTTP GET et l'envoie au serveur Web comme prévu. </p><br><p>  À l'intérieur de lui-même, <code>espSendData()</code> vérifie la disponibilité du module ESP en lui envoyant la commande «AT», puis il vérifie la connexion WiFi et se reconnecte si nécessaire.  Ensuite, les données sont envoyées et la connexion TCP est fermée. </p><br><h1 id="android-prilozhenie">  Application Android </h1><br><p>  De nos jours, quand tout le monde peut clignoter une LED, vous ne surprendrez personne avec une station météo.  Mais si l'engin sait communiquer avec le serveur via le WiFi, a un visage web et une application mobile, alors c'est quelque chose!  Par serveur, nous entendons ici bien sûr le serveur d'applications, c'est-à-dire  dans notre cas, il s'agit d'une liaison PHP et d'un SGBD MySQL.  Il n'y a pas assez de cerises sur le gâteau, à savoir l'application Android, que nous allons écrire maintenant. </p><br><h2 id="arhitektura">  L'architecture </h2><br><p>  L'architecture de l'ensemble de la plateforme logicielle de station météo est simple: </p><br><ul><li>  la partie serveur (unité centrale) de la station météo collecte les données des clients capteurs à distance </li><li>  puis il transfère des données au serveur Web d'applications, qui enregistre ces données dans la base de données </li><li>  L'application Android (ou toute autre application distante: iOS, navigateur) demande des données à un serveur Web et les affiche à l'écran. </li></ul><br><p>  Sur l'écran de l'appareil Android, nous afficherons les lectures de capteur actuelles et les plus récentes. </p><br><h2 id="http-get-i-json">  HTTP GET et JSON </h2><br><p>  La question qui doit être résolue en premier lieu est de savoir comment les données seront transférées du serveur Web vers l'application Android. </p><br><p>  Il n'est pas nécessaire d'inventer quoi que ce soit ici, tout a déjà été inventé pour nous - ce sont HTTP GET et JSON. </p><br><p>  Dans notre cas, une simple demande GET au serveur Web peut être compilée et déboguée manuellement alors que l'application Android n'est pas encore prête. </p><br><p>  En Java et Android, il existe des bibliothèques prêtes à l'emploi pour le traitement des données au format JSON.  JSON est un format de texte lisible par l'homme, utile pour le débogage. </p><br><p>  Afin de générer des données actuelles à partir des capteurs des stations météorologiques, créez un nouveau script PHP <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">last-data-to-json.php</a> sur le serveur Web. </p><br><p>  Appel de script: </p><br><pre> <code class="hljs powershell">http://&lt;&gt;/last<span class="hljs-literal"><span class="hljs-literal">-data</span></span><span class="hljs-literal"><span class="hljs-literal">-to</span></span><span class="hljs-literal"><span class="hljs-literal">-json</span></span>.php?k=&lt;access_key&gt;</code> </pre> <br><p>  où <code>&lt;access_key&gt;</code> , comme nous nous en souvenons, est la clé d'accès secrète à la base de données. </p><br><p>  Exemple de réponse au format JSON: </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"DHT 11"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"idSensor"</span></span>:<span class="hljs-string"><span class="hljs-string">"11"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dateCreate"</span></span>:<span class="hljs-string"><span class="hljs-string">"2016-04-20 18:06:03"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"temperature"</span></span>:<span class="hljs-string"><span class="hljs-string">"19"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"humidity"</span></span>:<span class="hljs-string"><span class="hljs-string">"26"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"voltage"</span></span>:<span class="hljs-string"><span class="hljs-string">"5.01"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"DHT 20"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"idSensor"</span></span>:<span class="hljs-string"><span class="hljs-string">"20"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dateCreate"</span></span>:<span class="hljs-string"><span class="hljs-string">"2016-04-18 07:36:26"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"temperature"</span></span>:<span class="hljs-string"><span class="hljs-string">"10"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"humidity"</span></span>:<span class="hljs-string"><span class="hljs-string">"26"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"voltage"</span></span>:<span class="hljs-string"><span class="hljs-string">"3.7"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"BMP 11"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"idSensor"</span></span>:<span class="hljs-string"><span class="hljs-string">"11"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dateCreate"</span></span>:<span class="hljs-string"><span class="hljs-string">"2016-04-20 18:06:22"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"temperature"</span></span>:<span class="hljs-string"><span class="hljs-string">"19"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pressure"</span></span>:<span class="hljs-string"><span class="hljs-string">"987.97"</span></span> } }</code> </pre> <br><p>  Il faut rappeler que nous avons 3 capteurs.  Leur ID et leur type (DHT ou BMP) sont codés en dur dans tout le code de la station météo.  Cette méthode de codage hardcore est idéologiquement incorrecte, mais pour un prototype dessiné au genou (où une solution rapide et facile est nécessaire), c'est un compromis raisonnable. </p><br><pre> <code class="hljs ruby">$idSensor = <span class="hljs-number"><span class="hljs-number">11</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  DHT  $idSensor = <span class="hljs-number"><span class="hljs-number">11</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  BMP  $idSensor = <span class="hljs-number"><span class="hljs-number">20</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  DHT </code> </pre> <br><p>  Le <code>last-data-to-json.php</code> prend les dernières données de ces capteurs hétérogènes de la base de données et les emballe au format JSON.  La sélection des données de la base de données «de bout en bout» se déroule ainsi: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> &lt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> &lt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> <br><h2 id="android">  Android </h2><br><p>  Nous allons maintenant écrire une application Android simple qui demande, reçoit, décode les données JSON et affiche des informations à l'écran. </p><br><p>  Notre application Android sera aussi simple que possible, seule l'essence de la technologie.  Plus loin autour de ce "squelette" il sera déjà possible de remonter différentes "beautés". </p><br><p>  Voici une capture d'écran de ce qui devrait se traduire par </p><br><p><img src="https://habrastorage.org/webt/ca/qb/wx/caqbwxzdlsu2a83atqsmzslebvy.jpeg" alt="Android"></p><br><p>  Comme vous pouvez le voir, l'interface utilisateur est juste Spartan, basée sur LinearLayout, rien de plus. </p><br><p>  En haut de TextView, l'ID des capteurs et leurs données météorologiques sont affichés.  Le bouton Actualiser lance une deuxième demande au serveur Web.  Ensuite dans EditText est le seul paramètre de programme - c'est l'URL de demande dans le formulaire </p><br><pre> <code class="hljs powershell">http://&lt; &gt;/last<span class="hljs-literal"><span class="hljs-literal">-data</span></span><span class="hljs-literal"><span class="hljs-literal">-to</span></span><span class="hljs-literal"><span class="hljs-literal">-json</span></span>.php?k=&lt;access_key&gt;</code> </pre> <br><p>  Que faut-il noter? </p><br><p>  Dans le manifeste, ajoutez des lignes autorisant Internet et vérifiant l'état de la connexion réseau: </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.permission.ACCESS_NETWORK_STATE"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.permission.INTERNET"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre> <br><p>  Travailler avec le réseau et recevoir des données du site Web est le suivant. </p><br><p>  Nous utilisons AsyncTask pour créer une tâche d'arrière-plan distincte du thread d'interface utilisateur principal.  Cette tâche en arrière-plan prend l'URL de la demande et l'utilise pour créer la <code>HttpURLConnection</code> . </p><br><p>  Une fois la connexion établie, AsyncTask charge le contenu de la page Web (JSON) en tant que InputStream.  Ensuite, InputStream est converti en chaîne, qui est décodée à l'aide de JSONObject et affichée dans l'interface utilisateur à l'aide de la méthode <code>onPostExecute()</code> . </p><br><p>  Dans MainActivity.java, modifiez l'URL de votre: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String defUrl = <span class="hljs-string"><span class="hljs-string">"http://host/dir/last-data-to-json.php?k=&lt; &gt;"</span></span>;</code> </pre> <br><p>  il sera utilisé par défaut la première fois que vous exécuterez une application Android. </p><br><h2 id="epilog">  Épilogue </h2><br><p>  Eh bien, quelque chose a déjà fonctionné.  Ensuite, vous pouvez optimiser quelque chose, remplacer quelque chose, vous pouvez tout jeter, mais aussi emprunter quelque chose. </p><br><p>  Un autre point sensible distinct est <strong>la consommation d'énergie</strong> .  Je recommande de lire les commentaires sur les articles où il existe de nombreux conseils pratiques. </p><br><p>  <em>À l'infini ... et au-delà.</em> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr426019/">https://habr.com/ru/post/fr426019/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr426001/index.html">Cours MIT "Sécurité des systèmes informatiques". Conférence 11: Langage de programmation Ur / Web, partie 3</a></li>
<li><a href="../fr426009/index.html">Epic fail resistance 1 ou Fox se faufilait inaperçu. Test d'anonymat et de sécurité + VPN pour l'utilisateur</a></li>
<li><a href="../fr426013/index.html">Stéroïdes de carrière</a></li>
<li><a href="../fr426015/index.html">L'utilisation de drones civils sciés pour la photographie aérienne géodésique professionnelle de la région</a></li>
<li><a href="../fr426017/index.html">Comment réduire le nombre d'expériences sur des animaux</a></li>
<li><a href="../fr426021/index.html">libgdx et sentiments</a></li>
<li><a href="../fr426023/index.html">Leçon ouverte "Laboratoire virtuel à Vagrant"</a></li>
<li><a href="../fr426025/index.html">Utiliser des méthodes offensives pour enrichir Threat Intelligence</a></li>
<li><a href="../fr426027/index.html">Amazon Cloud Services et analyse de portefeuille d'investissement</a></li>
<li><a href="../fr426029/index.html">Vous abandonnez et souhaitez quitter la tâche? Voici à quoi ressemble une formation de développeur efficace</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>