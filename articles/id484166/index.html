<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🐼 👨🏽‍🚒 🔴 VVVVVV ??? VVVVVV !!! :) 👫 🍇 ⏫</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Jika Anda membaca teks ini, itu berarti Anda berpikir ada sesuatu yang salah dengan judul artikel tersebut, atau Anda melihat nama permainan komputer ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>VVVVVV ??? VVVVVV !!! :)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/484166/">  Jika Anda membaca teks ini, itu berarti Anda berpikir ada sesuatu yang salah dengan judul artikel tersebut, atau Anda melihat nama permainan komputer yang akrab di dalamnya.  VVVVVV adalah game platformer indie yang telah memenangkan hati banyak pemain dengan kesederhanaan eksternal yang menyenangkan dan kompleksitas internal yang sama-sama menyenangkan.  Beberapa hari yang lalu VVVVVV berusia 10 tahun, dan penulis permainan - Terry Cavanagh - merayakan liburan ini dengan mempublikasikan kode sumbernya.  Apa yang "enak" dapat ditemukan di dalamnya?  Baca jawabannya di artikel ini. <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/i1/ij/g8/i1ijg8lekultgdxwi426mbnaers.png" alt="Gambar 1"></div><br><a name="habracut"></a><br><h2>  Pendahuluan </h2><br>  Oh, VVVVVVV ... Saya ingat bagaimana saya menemukannya sesaat setelah rilis, dan, sebagai penggemar berat game retro pixel, saya dengan senang hati memasangnya di komputer saya.  Saya ingat kesan pertama saya: “Jadi, apakah hanya itu?  Lari saja di sekitar ruangan persegi? ”Saya berpikir setelah beberapa menit pertandingan.  Saya belum tahu apa yang menunggu saya.  Segera setelah saya meninggalkan lokasi awal, saya mendapati diri saya berada di dunia dua dimensi yang kecil namun membingungkan dan penuh hiasan lanskap dan artefak piksel yang tidak diketahui oleh saya. <br><br>  Game ini menyeretku.  Meskipun kompleksitasnya tinggi, dengan terampil dikalahkan oleh kontrol yang tidak biasa pada waktu itu (karakter utama tidak tahu cara melompat, tetapi mampu membalikkan arah vektor gravitasi untuk saya sendiri), saya benar-benar melewatinya.  Saya tidak tahu berapa kali karakter saya mati, tetapi saya yakin bahwa jumlah kematian diukur dalam puluhan ratusan.  Meski begitu, ada beberapa pesona unik dalam game ini :) <br><br>  Mari kita kembali ke kode sumber yang <a href="https://habr.com/ru/post/483518/">ditata untuk menghormati hari jadi permainan</a> . <br><br>  Saat ini, saya C ++ - pengembang di tim PVS-Studio - penganalisa kode statis untuk C, C ++, C # dan Java.  Selain pengembangan itu sendiri, kami juga terlibat dalam promosi produk kami.  Bagi kami, salah satu cara terbaik untuk melakukan ini adalah menulis artikel tentang memeriksa proyek sumber terbuka.  Pembaca kami menerima artikel menarik tentang topik pemrograman, dan kami mendapat kesempatan untuk menunjukkan dengan jelas kemampuan PVS-Studio.  Karena itu, ketika saya mengetahui tentang pembukaan kode sumber VVVVVV, saya tidak bisa melewatinya. <br><br>  Pada artikel ini kita akan melihat beberapa kesalahan menarik yang ditemukan oleh penganalisa PVS-Studio dalam kode VVVVVV, serta melakukan analisis terperinci atas kesalahan ini.  Kembalikan vektor gravitasi ke posisi "turun" dan duduk: kita mulai! <br><br><h2>  Ikhtisar peringatan yang dikeluarkan oleh penganalisa </h2><br><h3>  Peringatan 1 </h3><br>  <a href="https://www.viva64.com/ru/w/v512/">V512</a> Panggilan fungsi 'sprintf' akan menyebabkan meluapnya buffer 'fileSearch'.  FileSystemUtils.cpp 307 <br><br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MAX_PATH 260 .... void PLATFORM_migrateSaveData(char *output) { char oldLocation[MAX_PATH]; char newLocation[MAX_PATH]; char oldDirectory[MAX_PATH]; char fileSearch[MAX_PATH]; .... </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Same place, different layout. */</span></span></span><span class="hljs-meta"> strcpy(oldDirectory, output); sprintf(fileSearch, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"%s\\*.vvvvvv"</span></span></span><span class="hljs-meta">, oldDirectory); .... }</span></span></code> </pre> <br>  Seperti yang Anda lihat, baris <i>pencarian File</i> dan <i>oldDirectory</i> berukuran sama: 260 karakter.  String pemformatan (argumen ketiga ke <i>sprintf</i> ) setelah mengganti konten string <i>oldDirectory</i> ke dalamnya akan terlihat seperti ini: <br><br><pre> <code class="cpp hljs">&lt;i&gt;_oldDirectory\*.vvvvvv&lt;/i&gt;</code> </pre> <br>  String ini lebih panjang 9 karakter dari pada <i>direktori old</i> original.  Urutan karakter inilah yang akan ditulis lebih lanjut ke <i>fileSearch</i> .  Apa yang terjadi jika string <i>oldDirectory</i> lebih panjang dari 251?  String yang dihasilkan akan lebih panjang daripada yang bisa ditampung oleh <i>fileSearch</i> , yang akan mengarah pada penulisan di luar array.  Jenis data apa dalam RAM yang mungkin rusak dan apa akibatnya adalah pertanyaan retoris :) <br><br><h3>  Peringatan 2 </h3><br>  <a href="https://www.viva64.com/ru/w/v519/">V519 Variabel</a> 'latar belakang' diberi nilai dua kali berturut-turut.  Mungkin ini sebuah kesalahan.  Periksa baris: 1367, 1373. Map.cpp 1373 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> mapclass::loadlevel(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>: <span class="hljs-comment"><span class="hljs-comment">//The Warpzone tmap = warplevel.loadlevel(rx, ry, game, obj); fillcontent(tmap); roomname = warplevel.roomname; tileset = 1; background = 3; // &lt;= dwgfx.rcol = warplevel.rcol; dwgfx.backgrounddrawn = false; warpx = warplevel.warpx; warpy = warplevel.warpy; background = 5; // &lt;= if (warpy) background = 4; if (warpx) background = 3; if (warpx &amp;&amp; warpy) background = 5; break; .... }</span></span></code> </pre> <br>  Satu dan variabel yang sama diberi nilai dua kali berturut-turut.  Selain itu, antara penugasan, variabel ini tidak digunakan di mana pun.  Aneh ... Mungkin urutan ini tidak melanggar logika program, tetapi penugasan semacam itu sendiri berbicara tentang beberapa kebingungan saat menulis kode.  Apakah ini sebenarnya sebuah kesalahan hanya bisa dikatakan oleh penulis.  Meskipun ada contoh yang lebih terang dari kesalahan ini dalam kode: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Game::loadquick(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pKey == <span class="hljs-string"><span class="hljs-string">"frames"</span></span>) { frames = atoi(pText); frames = <span class="hljs-number"><span class="hljs-number">0</span></span>; } .... }</code> </pre> <br>  Sudah jelas di sini bahwa di suatu tempat di sini ada kesalahan dalam logika, atau setidaknya tugas yang tidak perlu.  Mungkin baris kedua ditulis sementara untuk debugging, dan kemudian mereka lupa untuk menghapusnya.  Secara total, PVS-Studio mengeluarkan 8 peringatan tentang situasi seperti itu. <br><br><h3>  Peringatan 3 </h3><br>  Objek 'pKey' V808 dari tipe 'basic_string' telah dibuat tetapi tidak digunakan.  editor.cpp 1866 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> editorclass::load(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> &amp;_path) { .... <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-function"><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pKey</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pElem-&gt;Value())</span></span></span></span>; .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pKey == <span class="hljs-string"><span class="hljs-string">"edEntities"</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (TiXmlElement *edEntityEl = pElem-&gt;FirstChildElement(); edEntityEl; edEntityEl = edEntityEl-&gt;NextSiblingElement()) { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-function"><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pKey</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(edEntityEl-&gt;Value())</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">// &lt;= //const char* pText = edEntityEl-&gt;GetText() ; if (edEntityEl-&gt;GetText() != NULL) { edentity[i].scriptname = std::string(edEntityEl-&gt;GetText()); } edEntityEl-&gt;QueryIntAttribute("x", &amp;edentity[i].x); edEntityEl-&gt;QueryIntAttribute("y", &amp;edentity[i].y); edEntityEl-&gt;QueryIntAttribute("t", &amp;edentity[i].t); edEntityEl-&gt;QueryIntAttribute("p1", &amp;edentity[i].p1); edEntityEl-&gt;QueryIntAttribute("p2", &amp;edentity[i].p2); edEntityEl-&gt;QueryIntAttribute("p3", &amp;edentity[i].p3); edEntityEl-&gt;QueryIntAttribute("p4", &amp;edentity[i].p4); edEntityEl-&gt;QueryIntAttribute("p5", &amp;edentity[i].p5); edEntityEl-&gt;QueryIntAttribute("p6", &amp;edentity[i].p6); i++; } EditorData::GetInstance().numedentities = i; } .... }</span></span></code> </pre> <br>  Kode yang sangat aneh  Penganalisa memperingatkan tentang variabel <i>pKey yang</i> dibuat tetapi tidak digunakan, tetapi sebenarnya masalahnya ternyata lebih menarik.  Saya secara khusus ditandai dengan panah garis di mana peringatan itu dikeluarkan, karena fungsi ini berisi lebih dari satu definisi baris dengan nama <i>pKey</i> .  Ya, variabel lain yang dideklarasikan di dalam <i>for</i> loop, dan dengan namanya itu tumpang tindih dengan yang dinyatakan di luar loop. <br><br>  Jadi, jika Anda mengakses nilai string <i>pKey di</i> luar loop <i>for</i> , Anda akan mendapatkan nilai yang sama dengan <i>pElem-&gt; Value ()</i> , tetapi jika Anda melakukan hal yang sama di dalam loop, Anda akan mendapatkan nilai yang sama dengan <i>edEntityEl-&gt; Value ()</i> .  Nama yang tumpang tindih adalah kesalahan yang agak kasar, yang bisa sangat sulit ditemukan sendiri saat Anda meninjau kode. <br><br><h3>  Peringatan 4 </h3><br>  <a href="https://www.viva64.com/ru/w/v805/">V805</a> Menurunkan Kinerja.  Tidak efisien untuk mengidentifikasi string kosong dengan menggunakan konstruksi 'strlen (str)&gt; 0'.  Cara yang lebih efisien adalah dengan memeriksa: str [0]! = '\ 0'.  physfs.c 1604 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *prefDir = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; .... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">char</span></span></span><span class="hljs-function"> *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PHYSFS_getPrefDir</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *org, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *app)</span></span></span><span class="hljs-function"> </span></span>{ .... assert(<span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>(prefDir) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>); ... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> prefDir; } <span class="hljs-comment"><span class="hljs-comment">/* PHYSFS_getPrefDir */</span></span></code> </pre> <br>  Penganalisa menemukan tempat untuk optimasi mikro potensial.  Ini menggunakan fungsi <i>strlen</i> untuk memeriksa string C-style untuk membatalkan.  Fungsi ini "menjalankan" semua elemen dari string dan memeriksa masing-masing untuk kesetaraan ke terminal nol ('\ 0').  Jika string besar dimasukkan, maka masing-masing karakternya masih akan dibandingkan dengan string nol. <br><br>  Tetapi kita hanya perlu memeriksa bahwa string tersebut tidak kosong!  Untuk melakukan ini, cari tahu apakah karakter pertama dari string adalah nol terminal.  Oleh karena itu, untuk mengoptimalkan cek dalam ini, Anda harus menulis: <br><br><pre> <code class="cpp hljs">str[<span class="hljs-number"><span class="hljs-number">0</span></span>] != <span class="hljs-string"><span class="hljs-string">'\0'</span></span></code> </pre> <br>  Ini adalah rekomendasi yang diberikan oleh analisa.  Tentu saja, pemanggilan fungsi strlen dalam kondisi makro yang <i>tegas</i> , jadi itu hanya akan dieksekusi dalam versi debug, di mana kecepatan tidak begitu penting.  Dalam versi rilis, pemanggilan fungsi akan hilang dan kode akan bekerja dengan cepat.  Namun demikian, saya ingin menunjukkan kemampuan penganalisa dalam mengusulkan optimasi mikro. <br><br><h3>  Peringatan 5 </h3><br>  Untuk memperlihatkan kesalahan berikut, saya perlu melampirkan dua <i>potong</i> kode di sini: deklarasi kelas <i>entclass</i> dan konstruktornya.  Mari kita mulai dengan pengumuman: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">entclass</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: entclass(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">clear</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">outside</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-comment"><span class="hljs-comment">//Fundamentals bool active, invis; int type, size, tile, rule; int state, statedelay; int behave, animate; float para; int life, colour; //Position and velocity int oldxp, oldyp; float ax, ay, vx, vy; int cx, cy, w, h; float newxp, newyp; bool isplatform; int x1, y1, x2, y2; //Collision Rules int onentity; bool harmful; int onwall, onxwall, onywall; //Platforming specific bool jumping; bool gravity; int onground, onroof; int jumpframe; //Animation int framedelay, drawframe, walkingframe, dir, actionframe; int yp; int xp; };</span></span></code> </pre> <br>  Konstruktor kelas ini terlihat seperti ini: <br><br><pre> <code class="cpp hljs">entclass::entclass() { clear(); } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> entclass::clear() { <span class="hljs-comment"><span class="hljs-comment">// Set all values to a default, // required for creating a new entity active = false; invis = false; type = 0; size = 0; tile = 0; rule = 0; state = 0; statedelay = 0; life = 0; colour = 0; para = 0; behave = 0; animate = 0; xp = 0; yp = 0; ax = 0; ay = 0; vx = 0; vy = 0; w = 16; h = 16; cx = 0; cy = 0; newxp = 0; newyp = 0; x1 = 0; y1 = 0; x2 = 320; y2 = 240; jumping = false; gravity = false; onground = 0; onroof = 0; jumpframe = 0; onentity = 0; harmful = false; onwall = 0; onxwall = 0; onywall = 0; isplatform = false; framedelay = 0; drawframe = 0; walkingframe = 0; dir = 0; actionframe = 0; }</span></span></code> </pre> <br>  Bidang yang cukup, bukan?  Tidak mengherankan bahwa kesalahan mengintai di sini, di mana PVS-Studio mengeluarkan peringatan: <br><br>  <a href="https://www.viva64.com/ru/w/v730/">V730</a> Ada kemungkinan bahwa tidak semua anggota kelas diinisialisasi di dalam konstruktor.  Pertimbangkan untuk memeriksa: oldxp, oldyp.  Ent.cpp 3 <br><br>  Seperti yang Anda lihat, dalam daftar yang sedemikian besar, inisialisasi dua bidang kelas hilang.  Dengan demikian, nilai-nilai mereka tetap tidak terdefinisi, karena itu, di tempat lain dalam program ini, nilai yang tidak diketahui dapat dibaca dan digunakan dari mereka.  Sangat sulit untuk mendeteksi kesalahan seperti itu melalui mata. <br><br><p><img src="https://habrastorage.org/webt/mi/8n/du/mi8nduqzzi75r1jhntbsqwarlns.png" alt="Gambar 2"></p><br><br><h3>  Peringatan 6 </h3><br>  Pertimbangkan kodenya: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> mapclass::loadlevel(....) { .... <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; tmap; .... tmap = otherlevel.loadlevel(rx, ry, game, obj); fillcontent(tmap); .... <span class="hljs-comment"><span class="hljs-comment">//  tmap    . }</span></span></code> </pre> <br>  Peringatan PVS-studio: <a href="https://www.viva64.com/ru/w/v688/">V688</a> Variabel lokal 'tmap' memiliki nama yang sama dengan salah satu anggota kelas, yang dapat mengakibatkan kebingungan.  Map.cpp 1192 <br><br>  Memang, jika Anda melihat ke dalam kelas <i>mapclass</i> , Anda dapat menemukan di sana vektor yang sama dengan nama yang sama: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mapclass</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: .... <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; roomdeaths; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; roomdeathsfinal; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; areamap; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; contents; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; explored; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; vmult; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span> &lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; tmap; <span class="hljs-comment"><span class="hljs-comment">// &lt;= .... };</span></span></code> </pre> <br>  Sayangnya, mendeklarasikan vektor dengan nama yang sama di dalam suatu fungsi membuat vektor yang dinyatakan dalam kelas tidak terlihat.  Ternyata di seluruh fungsi tingkat <i>beban,</i> vektor <i>tmap</i> hanya berubah di dalam fungsi.  Vektor yang dideklarasikan di kelas tetap tidak berubah! <br><br>  Menariknya, PVS-Studio menemukan sebanyak 20 fragmen kode seperti itu!  Sebagian besar, mereka terkait dengan variabel sementara, yang, untuk kenyamanan, dinyatakan sebagai anggota kelas.  Penulis permainan (dan satu-satunya pengembang) sendiri menulis bahwa ia dulu memiliki kebiasaan buruk ini.  Anda dapat membaca tentang ini di pos yang saya tautkan pada awal artikel ini. <br><br>  Dia juga mencatat bahwa penamaan tersebut menyebabkan bug yang berbahaya dan sulit ditangkap.  Nah, bug seperti itu benar-benar bisa berbahaya, tetapi menggunakan analisis statis untuk menangkapnya tidak akan sulit :) <br><br><h3>  Peringatan 7 </h3><br>  <a href="https://www.viva64.com/ru/w/v601/">V601</a> Tipe integer secara implisit dilemparkan ke tipe char.  Game.cpp 4997 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Game::loadquick(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pKey == <span class="hljs-string"><span class="hljs-string">"totalflips"</span></span>) { totalflips = atoi(pText); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pKey == <span class="hljs-string"><span class="hljs-string">"hardestroom"</span></span>) { hardestroom = atoi(pText); <span class="hljs-comment"><span class="hljs-comment">// &lt;= } else if (pKey == "hardestroomdeaths") { hardestroomdeaths = atoi(pText); } .... }</span></span></code> </pre> <br>  Untuk memahami apa masalahnya, mari kita lihat definisi variabel dari bagian kode yang diberikan: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//Some stats: int totalflips; std::string hardestroom; int hardestroomdeaths;</span></span></code> </pre> <br>  Variabel <i>totalflip</i> dan <i>hardestroomdeaths</i> adalah tipe integer, dan karenanya menugaskan hasilnya ke fungsi <i>atoi</i> di dalamnya benar-benar normal.  Tetapi apa yang terjadi jika Anda menetapkan nilai integer ke <i>std :: string</i> ?  Ternyata dari sudut pandang bahasa, penugasan semacam itu benar-benar valid.  Akibatnya, beberapa nilai yang tidak dapat dipahami akan ditulis ke dalam variabel <i>hardestroom</i> ! <br><br><h3>  Peringatan 8 </h3><br>  <a href="https://www.viva64.com/ru/w/v1004/">V1004 Pointer</a> 'pElem' digunakan dengan tidak aman setelah diverifikasi terhadap nullptr.  Periksa baris: 1739, 1744. editor.cpp 1744 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> editorclass::load(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> &amp;_path) { .... <span class="hljs-function"><span class="hljs-function">TiXmlHandle </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hDoc</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(&amp;doc)</span></span></span></span>; TiXmlElement *pElem; <span class="hljs-function"><span class="hljs-function">TiXmlHandle </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hRoot</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; version = <span class="hljs-number"><span class="hljs-number">0</span></span>; { pElem = hDoc.FirstChildElement().Element(); <span class="hljs-comment"><span class="hljs-comment">// should always have a valid root // but handle gracefully if it does if (!pElem) { printf("No valid root! Corrupt level file?\n"); } pElem-&gt;QueryIntAttribute("version", &amp;version); // &lt;= // save this for later hRoot = TiXmlHandle(pElem); } .... }</span></span></code> </pre> <br>  Penganalisa memperingatkan bahwa pointer <i>pElem</i> tidak aman digunakan segera setelah diperiksa untuk <i>nullptr</i> .  Untuk memastikan bahwa penganalisisnya benar, lihat definisi fungsi <i>Elemen ()</i> , nilai balik yang menginisialisasi penunjuk <i>pElem</i> : <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/** @deprecated use ToElement. Return the handle as a TiXmlElement. This may return null. */</span></span> <span class="hljs-function"><span class="hljs-function">TiXmlElement *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Element</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ToElement(); }</code> </pre> <br>  Seperti yang Anda lihat dari komentar, fungsi ini dapat mengembalikan <i>nol</i> . <br><br>  Sekarang bayangkan ini benar-benar terjadi.  Apa yang akan terjadi dalam kasus ini?  Faktanya adalah bahwa situasi seperti itu tidak akan ditangani dengan cara apa pun.  Ya, sebuah pesan akan ditampilkan yang menyatakan bahwa ada sesuatu yang salah, tetapi secara harfiah garis di bawah penunjuk yang salah akan disangkal.  Dereferencing seperti itu, pada gilirannya, akan menyebabkan crash program atau perilaku yang tidak terdefinisi.  Ini adalah kesalahan yang cukup serius. <br><br><h3>  Peringatan 9 </h3><br>  Di bagian kode berikutnya, PVS-Studio mengeluarkan empat peringatan: <ul><li>  <a href="https://www.viva64.com/ru/w/v560/">V560</a> Bagian dari ekspresi kondisional selalu benar: x&gt; = 0. editor.cpp 1137 </li><li>  <a href="https://www.viva64.com/ru/w/v560/">V560</a> Bagian dari ekspresi kondisional selalu benar: y&gt; = 0. editor.cpp 1137 </li><li>  <a href="https://www.viva64.com/ru/w/v560/">V560</a> Bagian dari ekspresi kondisional selalu benar: x &lt;40. editor.cpp 1137 </li><li>  <a href="https://www.viva64.com/ru/w/v560/">V560</a> Bagian dari ekspresi kondisional selalu benar: y &lt;30. editor.cpp 1137 </li></ul><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> editorclass::at( <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> y ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(x&lt;<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> at(<span class="hljs-number"><span class="hljs-number">0</span></span>,y); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(y&lt;<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> at(x,<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(x&gt;=<span class="hljs-number"><span class="hljs-number">40</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> at(<span class="hljs-number"><span class="hljs-number">39</span></span>,y); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(y&gt;=<span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> at(x,<span class="hljs-number"><span class="hljs-number">29</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(x&gt;=<span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; y&gt;=<span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; x&lt;<span class="hljs-number"><span class="hljs-number">40</span></span> &amp;&amp; y&lt;<span class="hljs-number"><span class="hljs-number">30</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> contents[x+(levx*<span class="hljs-number"><span class="hljs-number">40</span></span>)+vmult[y+(levy*<span class="hljs-number"><span class="hljs-number">30</span></span>)]]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br>  Semua peringatan berlaku untuk pernyataan <i>if</i> terakhir.  Masalahnya adalah bahwa keempat pemeriksaan yang dilakukan di atasnya akan selalu kembali <i>benar</i> .  Saya tidak akan mengatakan bahwa ini adalah kesalahan serius, tetapi ternyata cukup lucu.  Penulis memutuskan untuk mengambil fungsi ini dengan serius dan, untuk berjaga-jaga, memeriksa setiap variabel lagi :) <br><br>  Pemeriksaan ini dapat dihapus, karena  utas eksekusi tidak akan pernah mencapai ekspresi " <i>return 0;</i> ".  Meskipun ini tidak mengubah logika program, itu akan membebaskannya dari pemeriksaan yang tidak perlu dan kode mati. <br><br><h3>  Peringatan 10 </h3><br>  Dalam artikelnya pada hari peringatan permainan, Terry mengatakan dengan ironi bahwa salah satu elemen yang mengendalikan logika permainan adalah peralihan besar dari fungsi <i>Game :: updatestate ()</i> , yang bertanggung jawab langsung untuk sejumlah besar kondisi permainan yang berbeda.  Dan sangat diharapkan bahwa saya akan menemukan peringatan berikut: <br><br>  <a href="https://www.viva64.com/ru/w/v2008/">V2008</a> Kompleksitas siklus: 548. Pertimbangkan untuk melakukan refactoring pada fungsi 'Game :: updatestate'.  Game.cpp 612 <br><br>  Ya, Anda mengerti dengan benar: PVS-Studio memperkirakan kompleksitas siklomatik suatu fungsi pada 548 unit.  Lima ratus empat puluh delapan !!!  Ini saya mengerti - "kode rapi."  Dan ini terlepas dari kenyataan bahwa, pada kenyataannya, tidak ada yang lebih dari ekspresi saklar dalam suatu fungsi.  Di sakelar itu sendiri, saya menghitung lebih dari 300 ekspresi kasus. <br><br>  Di kantor kami ada kompetisi kecil antara penulis untuk artikel terpanjang.  Saya dengan senang hati akan membawa semua kode fungsi di sini (3450 baris), tetapi kemenangan seperti itu akan tidak jujur, jadi saya akan membatasi diri hanya dengan <a href="">merujuk</a> ke saklar besar.  Saya merekomendasikan untuk mengikuti dan mengevaluasi seluruh skala sendiri!  Omong-omong, selain <i>Game :: updatestate ()</i> , PVS-Studio menemukan sebanyak 44 fungsi dengan kompleksitas siklomatik yang berlebihan, 10 di antaranya memiliki kompleksitas lebih dari 200. <br><br><p><img src="https://habrastorage.org/webt/pu/s9/a2/pus9a2tqqeyzmdkg90auf5r2d0q.png" alt="Gambar 3"></p><br><br><h2>  Kesimpulan </h2><br>  Saya pikir kesalahan tertulis sudah cukup untuk artikel ini.  Ya, ada banyak kesalahan dalam proyek, tetapi ini persis trik: setelah meletakkan kodenya, Terry Cavanagh menunjukkan bahwa tidak perlu menjadi pemrogram yang baik untuk membuat permainan yang baik.  Sekarang, setelah 10 tahun, Terry mengingat saat-saat itu dengan ironi.  Belajar dari kesalahan Anda adalah penting, dan berlatih adalah cara terbaik untuk melakukan ini.  Dan jika latihan Anda masih bisa memunculkan gim seperti VVVVVVV, maka ini umumnya cantik!  Ehh ... Saya akan pergi dan saya mungkin akan memainkannya lagi :) <br><br>  Ini bukan semua kesalahan yang ditemukan dalam kode game.  Jika Anda ingin melihat sendiri apa lagi yang bisa Anda temukan, saya sarankan <a href="https://www.viva64.com/ru/pvs-studio-download/">mengunduh dan mencoba PVS-Studio</a> !  Juga jangan lupa bahwa untuk proyek open source kami <a href="https://www.viva64.com/ru/b/0614/">memberikan</a> lisensi gratis. <br><br><p> <a href="https://habr.com/en/company/pvs-studio/blog/484388/"><img src="https://habrastorage.org/getpro/habr/post_images/c78/30f/70c/c7830f70c5577c3d6704f254d7cad6a3.png" align="left"></a> </p><br><br>  Jika Anda ingin berbagi artikel ini dengan audiens yang berbahasa Inggris, silakan gunakan tautan ke terjemahan: George Gribkov.  <a href="https://habr.com/en/company/pvs-studio/blog/484388/">VVVVVV ???</a>  <a href="https://habr.com/en/company/pvs-studio/blog/484388/">VVVVVV !!!</a>  <a href="https://habr.com/en/company/pvs-studio/blog/484388/">:)</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id484166/">https://habr.com/ru/post/id484166/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id484150/index.html">5 alat baru untuk membuat konten yang menyenangkan</a></li>
<li><a href="../id484152/index.html">Kontroler PAC Kecepatan Tinggi WISE-5580</a></li>
<li><a href="../id484154/index.html">Metode untuk memecahkan sistem persamaan diophantine</a></li>
<li><a href="../id484160/index.html">Bakat Elusif: Rusia Kehilangan Profesional TI Terbaik</a></li>
<li><a href="../id484164/index.html">Sejarah buku dan masa depan perpustakaan</a></li>
<li><a href="../id484168/index.html">Kami menulis strategi kami untuk pengguliran virtual dari Angular CDK</a></li>
<li><a href="../id484170/index.html">Perbarui Titik Periksa dari R77.30 hingga 80.20</a></li>
<li><a href="../id484172/index.html">Integrasi berkelanjutan di Unity: cara mengurangi waktu perakitan dan menghemat sumber daya + payline sebagai hadiah</a></li>
<li><a href="../id484174/index.html">Castle minum dalam kondisi "ekstrim" atau bagaimana kami mengambil bagian dalam acara "DOZOR"</a></li>
<li><a href="../id484176/index.html">Menerapkan Template Status dalam Persatuan</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>