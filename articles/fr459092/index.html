<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👊 ⛴️ 📏 X.Spectator - surveillance de l'état dans .NET 📆 ⚙️ 🧓🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Aujourd'hui, la plupart des systèmes d'information sont des solutions complexes avec une architecture assez complexe et un grand nombre de dépendances...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>X.Spectator - surveillance de l'état dans .NET</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/459092/"><img src="https://habrastorage.org/webt/7o/ze/ym/7ozeymv3v4yjpenayz7cwhfjavi.png"><br><br>  Aujourd'hui, la plupart des systèmes d'information sont des solutions complexes avec une architecture assez complexe et un grand nombre de dépendances mutuelles.  Pendant le fonctionnement de ces systèmes, au moment des pics de charge, certains modules peuvent tomber en panne ou ne pas fonctionner correctement.  Dans ce cas, le système cesse d'être stable et peut cesser de traiter correctement toutes les demandes entrantes.  Pour assurer un fonctionnement stable du système, différentes stratégies peuvent être mises en œuvre. <br><a name="habracut"></a><br>  Dans certains cas (si cela est autorisé), la traduction du système dans le soi-disant.  "Mode sans échec".  Dans ce mode, le système peut traiter un plus grand nombre d'appels avec une légère diminution de la précision des résultats du traitement des requêtes.  Dans d'autres cas, la mise à l'échelle des ressources informatiques et l'augmentation du nombre de modules système individuels chargés du traitement des demandes entrantes peuvent aider.  Dans ce cas, la tâche la plus importante est de <b>déterminer l'état du système</b> , en fonction de laquelle, l'une ou l'autre action doit déjà être entreprise pour stabiliser son fonctionnement. <br><br>  Dans mes projets, j'ai résolu un problème similaire de diverses manières depuis un certain temps.  Depuis que j'étais à l'université, j'avais un petit projet écrit en .NET 4.0, à partir duquel de temps en temps je prenais de petits morceaux de code pour de vrais projets.  J'ai longtemps prévu de refactoriser ce projet, de le nettoyer et de l'organiser sous la forme d'un mini-framework séparé qui nous permet de résoudre magnifiquement et de manière minimaliste le problème de la surveillance de l'état du système.  Après avoir passé plusieurs soirées et quelques jours de congé, j'ai mis ce code en ordre et l'ai publié sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">GitHub</a> .  De plus, je propose d'examiner plus en détail ce qui et comment est mis en œuvre dans ce projet. <br><br>  Pour déterminer la nécessité de modifier le mode de fonctionnement du système, il est proposé d’utiliser une approche utilisant des «capteurs» et des «observateurs» virtuels. <br><br><img src="https://habrastorage.org/webt/ro/x1/zt/rox1ztsyy4gvvg85e-hkxdja9uy.png"><br><br><h2>  <font color="#ff9c00">▌</font> Entités et définitions </h2><br>  Entités de base à utiliser: <br><br><ul><li>  <b>Capteur</b> - est chargé de vérifier l'état de l'un des indicateurs du système; </li><li>  <b>Observateur</b> - interroge un ou plusieurs capteurs.  Change son état en fonction des lectures actuelles des capteurs; </li><li>  <b>Calculatrice d'état</b> - calcule l'état actuel en fonction du journal des métriques. </li><li>  <b>Journal d'état</b> - un ensemble d'indicateurs pour chacun des capteurs indiquant le temps d'interrogation. </li></ul><br>  Pour chaque abstraction, il existe une implémentation de base, ainsi que des mécanismes pour une expansion simple et pratique.  Examinons-les plus en détail. <br><br><h3>  Capteur </h3><br>  Interface <i>IProbe de</i> base.  Les classes implémentant IProbe fournissent, sur demande, la valeur des paramètres système qu'ils observent, ou un module / service spécifique. <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IProbe</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-function"><span class="hljs-function">Task&lt;ProbeResult&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Check</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; }</code> </pre> <br>  À la suite de la méthode <i>Check</i> , l'instance IProbe renvoie une structure ProbeResult <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> ProbeResult { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ProbeName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DateTime Time { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> Success { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Data { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Exception Exception { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">$"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{Time}</span></span></span><span class="hljs-string">: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{Success}</span></span></span><span class="hljs-string">"</span></span>; }</code> </pre><br>  où le champ Success détermine si le paramètre a été testé avec succès du point de vue du capteur, et les champs Data et Exception peuvent stocker des informations supplémentaires au cas où cela serait nécessaire pour le débogage ou la journalisation. <br><br><h3>  Observateur </h3><br>  L'interface de base d' <i>ISpectator</i> .  Il surveille le système, génère des événements au moment de changer l'état du système pour notifier tous les modules qui sont abonnés à ces événements.  Il utilise une instance d'une classe qui implémente l'interface IStateEvaluator pour calculer l'état actuel. <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">ISpectator</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TState</span></span>&gt; <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">TState</span></span> : <span class="hljs-title"><span class="hljs-title">struct</span></span>, <span class="hljs-title"><span class="hljs-title">IConvertible</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> EventHandler&lt;StateEventArgs&lt;TState&gt;&gt; StateChanged; <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> EventHandler&lt;HealthCheckEventArgs&gt; HealthChecked; TState State { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } TimeSpan Uptime { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddProbe</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IProbe probe</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CheckHealth</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; }</code> </pre><br>  Lors de chaque interrogation de capteur, l'observateur déclenche l'événement StateChanged et un objet de type <a href="">StateEventArgs</a> est transmis aux abonnés de cet événement, qui contient des informations sur l'état actuel du système. <br><br><h3>  Calculatrice d'état </h3><br>  L'interface <i>IEvaluator de</i> base.  Calcule l'état actuel du système en fonction du journal d'état du capteur. <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IStateEvaluator</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TState</span></span>&gt; { <span class="hljs-function"><span class="hljs-function">TState </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Evaluate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> TState currentState, DateTime stateChangedLastTime, IReadOnlyCollection&lt;JournalRecord&gt; journal</span></span></span><span class="hljs-function">)</span></span>; }</code> </pre><br><h3>  Journal d'état </h3><br>  Une collection d'instances de la structure JournalRecord.  L'instance JournalRecord stocke des informations sur tous les capteurs interrogés au moment où le sondage a été lancé par l'observateur. <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> JournalRecord { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">JournalRecord</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DateTime time, IEnumerable&lt;ProbeResult&gt; values</span></span></span><span class="hljs-function">)</span></span> { Time = time; Values = values.ToImmutableList(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DateTime Time { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IReadOnlyCollection&lt;ProbeResult&gt; Values { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">$"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{Time}</span></span></span><span class="hljs-string">: [</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{</span></span><span class="hljs-keyword"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-string"><span class="hljs-subst">.Join(</span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">","</span></span></span></span><span class="hljs-string"><span class="hljs-subst">, Values)}</span></span></span><span class="hljs-string">]"</span></span>; }</code> </pre><br><h2>  <font color="#ff9c00">▌</font> Comment ça marche </h2><br>  Le processus de calcul de l'état du système peut être décrit comme suit: chacun des capteurs intégrés dans le système peut déterminer l'un des paramètres du système / module / service observé.  Par exemple, il peut être en train de fixer le nombre de requêtes actives externes à l'API, la quantité de RAM utilisée, le nombre d'entrées dans le cache, etc. <br><br>  Chaque capteur peut être affecté à un ou plusieurs observateurs.  Chaque observateur peut travailler avec un ou plusieurs capteurs.  L'observateur doit implémenter l'interface ISpectator et générer des événements en cas de changement d'état ou d'interrogation des capteurs. <br><br>  Lors de la prochaine vérification de l'état du système, l'observateur interroge tous ses «capteurs», formant un réseau pour l'écriture dans le journal d'état.  Si l'état du système a changé, l'observateur génère un événement approprié.  Les abonnés aux événements qui reçoivent des informations sur la modification peuvent modifier les paramètres de fonctionnement du système.  De plus, pour déterminer l'état du système, on peut utiliser des "calculateurs" de différents types. <br><br><h3>  Modes de fonctionnement synchrones et asynchrones </h3><br>  Considérons deux scénarios principaux dans lesquels l'observateur lance une étude des «capteurs». <br><br><h4>  Mode synchrone </h4><br>  Un relevé des capteurs suivi d'un recalcul de l'état du système est provoqué par l'appel direct d'un des modules du système à l'observateur. <br>  Dans ce cas, l'observateur et les capteurs fonctionnent dans le même fil.  L'erreur de calcul de l'état du système est effectuée dans le cadre d'une opération au sein du système. <br><br>  Le projet a déjà une implémentation de base d'un tel observateur - <b>SpectatorBase</b> . <br><br><div class="spoiler">  <b class="spoiler_title">Afficher le code</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SpectatorBase</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TState</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">ISpectator</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TState</span></span>&gt; <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">TState</span></span> : <span class="hljs-title"><span class="hljs-title">struct</span></span>, <span class="hljs-title"><span class="hljs-title">IConvertible</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> TState _state; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IList&lt;IProbe&gt; _probes; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IStateEvaluator&lt;TState&gt; _stateEvaluator; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> List&lt;JournalRecord&gt; _journal; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> ReaderWriterLockSlim _journalLock; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> ReaderWriterLockSlim _stateLock; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Stopwatch _stopwatch; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> EventHandler&lt;StateEventArgs&lt;TState&gt;&gt; StateChanged; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> EventHandler&lt;HealthCheckEventArgs&gt; HealthChecked; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> TState State { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { _stateLock.EnterReadLock(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _state; } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { _stateLock.ExitReadLock(); } } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> TimeSpan Uptime =&gt; _stopwatch.Elapsed; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IReadOnlyCollection&lt;JournalRecord&gt; Journal { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { _journalLock.EnterReadLock(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _journal; } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { _journalLock.ExitReadLock(); } } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DateTime StateChangedDate { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> TimeSpan RetentionPeriod { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SpectatorBase</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IStateEvaluator&lt;TState&gt; stateEvaluator, TimeSpan retentionPeriod, TState initialState</span></span></span><span class="hljs-function">)</span></span> { RetentionPeriod = retentionPeriod; _state = initialState; StateChangedDate = DateTime.UtcNow; _stateEvaluator = stateEvaluator; _stopwatch = Stopwatch.StartNew(); _probes = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;IProbe&gt;(); _journal = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;JournalRecord&gt;(); _journalLock = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReaderWriterLockSlim(); _stateLock = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReaderWriterLockSlim(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddProbe</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IProbe probe</span></span></span><span class="hljs-function">)</span></span> =&gt; _probes.Add(probe); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ChangeState</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">TState state, IEnumerable&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; failedProbes</span></span></span><span class="hljs-function">)</span></span> { _stateLock.EnterWriteLock(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { _state = state; } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { _stateLock.ExitWriteLock(); } StateChangedDate = DateTime.UtcNow; StateChanged?.Invoke(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StateEventArgs&lt;TState&gt;(state, StateChangedDate, failedProbes)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CheckHealth</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> results = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Stack&lt;ProbeResult&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tasks = _probes .Select(<span class="hljs-keyword"><span class="hljs-keyword">async</span></span> o =&gt; { results.Push(<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> o.Check().ConfigureAwait(<span class="hljs-literal"><span class="hljs-literal">false</span></span>)); }) .ToArray(); Task.WaitAll(tasks); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> now = DateTime.UtcNow; _journalLock.EnterWriteLock(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">//cleanup state records _journal.RemoveAll(o =&gt; o.Time &lt; now.Subtract(RetentionPeriod)); _journal.Add(new JournalRecord(now, results)); } finally { _journalLock.ExitWriteLock(); } //Recalculate state var state = _stateEvaluator.Evaluate(State, StateChangedDate, _journal); if (!EqualityComparer&lt;TState&gt;.Default.Equals(State, state)) { ChangeState(state, results.Where(o =&gt; !o.Success).Select(o =&gt; o.ProbeName)); } OnHealthChecked(now, results); } protected virtual void OnHealthChecked(DateTime now, IReadOnlyCollection&lt;ProbeResult&gt; results) =&gt; HealthChecked?.Invoke(this, new HealthCheckEventArgs(now, results)); }</span></span></code> </pre><br></div></div><br><h4>  Mode asynchrone </h4><br>  Dans ce cas, l'interrogation des capteurs se produit de manière asynchrone à partir des processus du système et peut être effectuée dans un thread séparé.  La mise en œuvre de base d'un tel observateur est également déjà un projet - <b>AutomatedSpectator</b> . <br><br><div class="spoiler">  <b class="spoiler_title">Afficher le code</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">AutomatedSpectator</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TState</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">SpectatorBase</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TState</span></span>&gt;, <span class="hljs-title"><span class="hljs-title">IAutomatedSpectator</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TState</span></span>&gt; <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">TState</span></span> : <span class="hljs-title"><span class="hljs-title">struct</span></span>, <span class="hljs-title"><span class="hljs-title">IConvertible</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> TimeSpan CheckHealthPeriod { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> System.Timers.Timer _timer; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AutomatedSpectator</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> TimeSpan checkHealthPeriod, TimeSpan retentionPeriod, IStateEvaluator&lt;TState&gt; stateEvaluator, TState initialState</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">stateEvaluator, retentionPeriod, initialState</span></span></span><span class="hljs-function">)</span></span> { CheckHealthPeriod = checkHealthPeriod; _timer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> System.Timers.Timer(CheckHealthPeriod.TotalMilliseconds); _timer.Elapsed += (sender, args) =&gt; CheckHealth(); _timer.AutoReset = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Start</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> =&gt; _timer.Start(); }</code> </pre><br></div></div><br><h2>  <font color="#ff9c00">▌</font> Conclusion </h2><br>  L'utilisation de X.Spectator m'a aidé personnellement dans plusieurs projets très chargés pour augmenter considérablement la stabilité d'un certain nombre de services.  Le meilleur cadre proposé a fait ses preuves lorsqu'il est mis en œuvre dans des systèmes distribués construits sur la base d'une architecture de microservices.  L'option d'intégration la plus optimale consiste à utiliser le principe d'inversion de contrôle, à savoir l'implémentation de dépendances, lorsque le processus d'implémentation de capteurs est implémenté à l'aide d'un conteneur IoC, et les observateurs sont présentés sous la forme de singletones, où une seule instance de chacun des observateurs est accessible par différentes classes de modules et de services. <br><br><h2>  <font color="#ff9c00">▌</font> Liens et informations utiles </h2><br>  → <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Dépôt de projets</a> <br>  → <a href="">Exemples</a> <br>  → <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Package NuGet</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr459092/">https://habr.com/ru/post/fr459092/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr459082/index.html">Qui sont l'eidétique, comment fonctionnent les faux souvenirs et trois mythes populaires sur la mémoire</a></li>
<li><a href="../fr459084/index.html">Un peu sur Google Home Hub, ou comment j'ai acheté un cadre photo pour 130 euros</a></li>
<li><a href="../fr459086/index.html">Distribution statique des objets FreeRTOS</a></li>
<li><a href="../fr459088/index.html">Méthodes de segmentation ponctuelle dans les nuages ​​de points</a></li>
<li><a href="../fr459090/index.html">Faites passer votre expérience de développement Linux sous Windows au niveau supérieur avec WSL et Visual Studio Code Remote</a></li>
<li><a href="../fr459094/index.html">C # ou Java? TypeScript ou JavaScript? Classification basée sur l'apprentissage automatique des langages de programmation</a></li>
<li><a href="../fr459098/index.html">Le registre des packages GitHub prend en charge les packages Swift</a></li>
<li><a href="../fr459100/index.html">Le registre des packages GitHub prend en charge les packages Swift</a></li>
<li><a href="../fr459102/index.html">Assiette cadeau ou musique gratuite pour les amateurs de cola et petits déjeuners prêts</a></li>
<li><a href="../fr459104/index.html">C # ou Java? TypeScript ou JavaScript? La classification des langages de programmation basée sur l'apprentissage automatique</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>