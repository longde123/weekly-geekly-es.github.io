<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚û°Ô∏è üë©‚Äç‚ù§Ô∏è‚Äçüë® üéÖüèº Drei kurze Windows-Registrierungsgeschichten üò£ ‚ú¥Ô∏è ü§òüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Guten Tag, liebe Leser. 

 Die Registrierung ist eines der sichtbarsten und bedeutendsten Windows-Systeme. Es gibt kaum jemanden, der nichts von ihm g...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Drei kurze Windows-Registrierungsgeschichten</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/kaspersky/blog/415699/">  Guten Tag, liebe Leser. <br><br>  Die Registrierung ist eines der sichtbarsten und bedeutendsten Windows-Systeme.  Es gibt kaum jemanden, der nichts von ihm geh√∂rt hat.  Nachdem ich ungef√§hr 20 Jahre unter Windows programmiert hatte, dachte ich, ich w√ºsste alles √ºber ihn.  Aber von Zeit zu Zeit erscheint etwas Neues, das mir zeigt, wie falsch ich war.  Daher m√∂chte ich Ihnen heute √ºber die ungew√∂hnlichen Arbeitsweisen mit der Registrierung berichten, die ich bei der Recherche nach Rootkits kennengelernt habe und die mich √ºberrascht haben. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/pb/ae/nr/pbaenrjbdncrwdoqvjdxvj4i2bw.png"></div><a name="habracut"></a><br><h2>  Die erste Geschichte.  Namen von Registrierungswerten und Schl√ºsseln </h2><br>  Wir alle wissen, dass es in Windows einige Regeln f√ºr die Benennung von Objekten gibt, sei es Dateien, Verzeichnisse oder Registrierungsschl√ºssel.  Dateinamen d√ºrfen nicht das Zeichen "\" enthalten.  Namen d√ºrfen nicht leer sein.  Namen haben einige L√§ngenbeschr√§nkungen usw. <br><br>  Unwillk√ºrlich erweitern wir diese Einschr√§nkungen auf alle Windows-Systeme und beachten sie bei der Arbeit mit der Registrierung.  Und hier liegt unser Fehler.  Es gibt √ºberraschend wenige Einschr√§nkungen f√ºr die Registrierung beim Erstellen von Namen.  Im Namen der Werte k√∂nnen Sie beispielsweise das Zeichen "\" verwenden. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/p_/wg/mw/p_wgmwlgimtqj6vclgogspff19y.png"></div><br>  √úberrascht?  Nein?  Was werden Sie dann sagen, wenn ich Ihnen zeige, dass das Symbol "\ 0" im Namen eines Wertes verwendet werden kann?  Ja, ja, genau das Nullzeichen.  Diejenige, die traditionell verwendet wird, um das Ende einer Zeile anzuzeigen. <br><br>  Dazu ben√∂tigen wir die aus ntdll.dll exportierte NtSetValueKey-Funktion <br><br><pre><code class="cpp hljs">HKEY hKey = <span class="hljs-number"><span class="hljs-number">0</span></span>; RegOpenKeyA( HKEY_LOCAL_MACHINE, <span class="hljs-string"><span class="hljs-string">"Software\\Microsoft\\Windows\\CurrentVersion\\Run"</span></span>, &amp;hKey); UNICODE_STRING uName; uName.Buffer = <span class="hljs-string"><span class="hljs-string">L"Test\0Zero"</span></span>; uName.MaxLen = uName.Length = <span class="hljs-number"><span class="hljs-number">9</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">wchar_t</span></span>); NTSTATUS status = <span class="hljs-number"><span class="hljs-number">0</span></span>; status = NtSetValueKey( hKey, &amp;uName, <span class="hljs-number"><span class="hljs-number">0</span></span>, REG_SZ, (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>*)lpData, DataSize); RegCloseKey(hKey);</code> </pre> <br>  Zum Ausf√ºhren der NtSetValueKey-Funktion ben√∂tigen Sie Administratorrechte.  Infolgedessen wird in Ihrer Registrierung ein Wert mit dem Namen Test \ 0Zero angezeigt. <br><br>  Einige Microsoft-Entwickler werden ebenfalls √ºberrascht sein, da der Standard-Registrierungseditor keinen so ungew√∂hnlichen Registrierungswert anzeigen kann. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/66/zi/zp/66zizpvsxtkhxhbuglu4xymqla8.png"></div><br><h2>  Zweite Geschichte </h2><br>  Die zweite Geschichte, die ich Ihnen heute erz√§hlen werde, geschah 2013. <br><br>  Zuerst ein kleiner Exkurs.  Bei Kaspersky Lab bin ich Mitglied des Teams, das unter anderem Kaspersky Rescue Disk erstellt.  Um Windows unter Linux zu heilen, m√ºssen wir die Registrierungsdateien selbst analysieren.  Und um die korrekte Funktion dieses Mechanismus zu √ºberpr√ºfen, verwenden wir viele Tests.  Unter ihnen gibt es eine ziemlich einfache: <br><br><ul><li>  Unter Windows schreiben wir Testwerte in die Registrierung. </li><li>  Kopieren Sie die Registrierungsstrukturdatei in das Testverzeichnis. </li><li>  Wir starten das Programm, das das Entfernen von Testwerten durchf√ºhrt. </li><li>  Wir laden den ge√§nderten Busch in die Registrierung, um die Entfernung zu √ºberpr√ºfen. </li></ul><br>  Und eines sch√∂nen Tages haben wir auf dem Windows-Pr√ºfstand auf Version 8.1 aktualisiert, und der Test hat das L√∂schen von Testwerten gestoppt.  Wie so, ich war √ºberrascht.  Ich habe die Datei mit der Registrierungsstruktur auf meinen Arbeitscomputer kopiert - keine Werte!  Mein erster Gedanke: Ich muss dem Flush-Test ge√§nderte Schl√ºssel hinzuf√ºgen.  RegFlushKey wurde aufgerufen und der Test neu gestartet - keine Werte! <br><br>  Funktioniert RegFlushKey nicht, dachte ich.  Aber wie sich herausstellte, hatte ich nur teilweise recht. <br><br>  Der Trick war, dass Microsoft in Windows 8.1 den Mechanismus zum Speichern von √Ñnderungen in der Registrierung ge√§ndert hat.  Zuvor wurden alle Registrierungs√§nderungen im Speicher gespeichert, und dann, wenn der Schl√ºssel geschlossen wurde, wenn RegFlushKey ausgef√ºhrt wurde oder nach einiger Zeit das System die √Ñnderungen in der Registrierungsbuschdatei speicherte.  In Windows 8.1 werden √Ñnderungen anstelle der Registrierungsstrukturdatei in gleichnamigen Dateien mit den Erweiterungen .LOG, .LOG1 und .LOG2 gespeichert, und mein Code hat diese Dateien damals ignoriert. <br><br>  In diesen Dateien sammeln sich √Ñnderungen etwa eine Stunde lang an.  Und erst danach beginnt Windows mit der Integration von √Ñnderungen in die Hauptdatei.  Diese Aufgabe wird als Abstimmung bezeichnet und beginnt entweder alle 40 Minuten oder wenn Windows heruntergefahren wird.  Das Aufrufen der RegFlushKey-Funktion l√∂st die Abstimmungsaufgabe nicht aus.  Um den Start der √Ñnderungsintegrationsaufgabe zu erzwingen, m√ºssen Sie ZwSetSystemInformation mit dem undokumentierten Argument SystemRegistryReconciliationInformation aufrufen. <br><br><pre> <code class="cpp hljs">ZwSetSystemInformation( <span class="hljs-number"><span class="hljs-number">0x9b</span></span>, <span class="hljs-comment"><span class="hljs-comment">//SystemRegistryReconciliationInformation NULL, 0);</span></span></code> </pre><br>  Zum Ausf√ºhren der ZwSetSystemInformation-Funktion ben√∂tigen Sie Administratorrechte.  Die Architektur der ausf√ºhrbaren Datei muss mit der Architektur des Systems √ºbereinstimmen.  Das Aufrufen dieser Funktion von einem 32-Bit-Programm unter 64-Bit-Windows schl√§gt fehl. <br><br><h2>  Dritte Geschichte </h2><br>  Vor einiger Zeit haben wir ein Rootkit entdeckt, das den Start seines Treibers in der Registrierung vorschreibt.  Unsere Produkte haben die entsprechenden Registrierungsschl√ºssel gel√∂scht, aber nach dem Neustart befanden sich die Schl√ºssel an ihrer Stelle.  Es sieht so aus, als w√ºrde er seine R√ºckruffunktionen auf Registrierungs√§nderungen setzen und seine Schl√ºssel nach unseren √Ñnderungen wiederherstellen, dachte ich.  Aber es stellte sich heraus, dass nein.  Genauer gesagt ja.  Das Rootkit stellte R√ºckruffunktionen ein, die jedoch nichts mit der Aufgabe der Schl√ºsselwiederherstellung zu tun hatten.  Alles wurde einfacher und eleganter gemacht. <br><br>  Der Rootkit-Treiber hat beim Start die SYSTEM-Registrierungsstrukturdatei in HARDWARE umbenannt.  Ich habe meine SYSTEM-Datei erstellt und den HKLM / System-Zweig mithilfe der RegSaveKey-Funktion regelm√§√üig darin gespeichert.  Beim Speichern stellte er seine Schl√ºssel wieder her.  Beim Neustart von Windows hat das System die SYSTEM-Datei geladen und den Rootkit-Treiber gestartet.  Ist es sch√∂n  Sch√∂n. <br><br><h3>  Gesucht </h3><br>  PS Hier suchen wir einen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Entwickler-Forscher</a> in einem Team, das eine Anti-Spam-Engine s√§gt, und wir brauchen auch <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">einen Testingenieur</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de415699/">https://habr.com/ru/post/de415699/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de415689/index.html">Wir spielen Seeschlacht auf BGP</a></li>
<li><a href="../de415691/index.html">Vergleich der Austauschsortierung</a></li>
<li><a href="../de415693/index.html">Oumuamua. Angekommen, ratlos, flog weg (und versprach nicht zur√ºckzukehren). Und eines Tages war es wieder einmal r√§tselhaft</a></li>
<li><a href="../de415695/index.html">Google gab zu, dass es auch GitHub kaufen wollte</a></li>
<li><a href="../de415697/index.html">Rhino IoT</a></li>
<li><a href="../de415701/index.html">Top 10: Die besten Joker 2017 Papers</a></li>
<li><a href="../de415705/index.html">Hacker haben Gentoo Linux-Repositories auf GitHub kompromittiert</a></li>
<li><a href="../de415707/index.html">Richard Hamming: Kapitel 18. Modellierung - I.</a></li>
<li><a href="../de415709/index.html">7 S√ºnden des Produktbesitzers</a></li>
<li><a href="../de415713/index.html">Aspektorientierte PHP-Programmierung</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>