<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚öóÔ∏è ‚ôãÔ∏è üëãüèª Syst√®me de protection contre les fuites pour une machine √† laver üë©üèæ‚Äçüè≠ üèôÔ∏è üëµ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pr√©sentation 
 Je pense que chaque maison a une machine √† laver. Habituellement, il est connect√© √† l'alimentation en eau via un tuyau flexible. Mais u...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Syst√®me de protection contre les fuites pour une machine √† laver</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/472296/"><img src="https://habrastorage.org/webt/7q/2r/xp/7q2rxpr6f9jntwgc-3ai-qwqglo.jpeg"><br><br><h2>  Pr√©sentation </h2><br>  Je pense que chaque maison a une machine √† laver.  Habituellement, il est connect√© √† l'alimentation en eau via un tuyau flexible.  Mais une grosse nuisance peut se produire avec un tuyau: parfois, ils √©clatent, ce qui entra√Ænera une inondation √† la fois dans votre appartement et chez vos voisins.  Par cons√©quent, les machines √† laver sont connect√©es √† l'alimentation en eau par un robinet sp√©cial, qui doit √™tre ouvert avant le lavage et ferm√© apr√®s.  Je ne sais pas pour vous, mais j'ai cette grue dans un endroit extr√™mement g√™nant.  Oui, et je pr√©f√®re commencer √† me laver avant de partir au travail, afin que la majeure partie de la journ√©e, le tuyau soit sous pression et puisse √©clater √† un moment o√π je ne suis pas √† la maison.  Ce serait formidable si la grue s'ouvre et se ferme au bon moment! <br><br>  L'id√©e m'a sembl√© tout √† fait capable et j'ai d√©cid√© de la mettre en ≈ìuvre: sur microcontr√¥leurs et avec valve motoris√©e. <br><a name="habracut"></a><br>  Pour commencer, j'ai formul√© les exigences pour le syst√®me d√©velopp√©: <br><br><ul><li>  surveiller l'√©tat de la machine √† laver: eau libre au d√©but du lavage et fermeture √† la fin; </li><li>  la possibilit√© de contr√¥ler manuellement la vanne; </li><li>  fonctionnement sur batterie et fermeture de la valve en cas de d√©charge de la batterie; </li><li>  pr√©sence d'un capteur de fuite: fermer la vanne en cas de d√©tection de fuite. </li></ul><br>  Il a ensuite compris de quelles pi√®ces il s'agissait: un moniteur, qui est install√© dans la machine √† laver, et un contr√¥leur, qui re√ßoit les signaux du moniteur et contr√¥le une vanne motoris√©e.  La communication entre le moniteur et le contr√¥leur se fait via un canal radio unidirectionnel. <br><br>  Il semble que cela soit suffisant pour la t√¢che technique.  Commen√ßons! <br><br><h2>  S√©lection MCU </h2><br>  √âtant donn√© que l'ensemble du syst√®me se compose de deux appareils, il devrait y avoir deux microcontr√¥leurs.  J'ai jet√© les tripes et trouv√© deux Atmega8: un dans le package DIP et l'autre dans TQFP.  Celui en DIP - est all√© au moniteur, et TQFP - au contr√¥leur.  Plus tard, il s'est av√©r√© que le firmware du contr√¥leur envahi ne correspond plus √† l'Atmega8 de 8 Ko, j'ai donc d√ª passer √† Atmega328 - un analogue complet, mais maintenant il y a quatre fois plus de m√©moire pour le programme. <br>  Soit dit en passant, l'une de mes motivations pour r√©aliser de tels projets est l'√©limination des d√©chets √©lectroniques que j'ai accumul√©s au fil des ann√©es.  Certes, √† la fin du projet, la corbeille ne devient pas plus petite.  √áa devient encore plus gros! <br><br><h2>  Premi√®re partie  Moniteur </h2><br><h3>  Interaction avec une machine √† laver </h3><br>  Le premier probl√®me: comment d√©terminer ce que la machine √† laver fait maintenant?  Au d√©but du projet, cette partie de la t√¢che m'a paru tr√®s simple.  Il ne restait plus qu'√† d√©terminer les moments de d√©but et de fin de lavage.  Sur le panneau avant de la machine, il y a une LED qui s'allume et s'√©teint au moment voulu.  Je m'attendais √† lui souder un GPIO avec le pied du microcontr√¥leur, donc pendant la dur√©e du d√©bogage, j'ai simplement √©mul√© les √©v√©nements n√©cessaires sur le moniteur avec le bouton.  J'ai appuy√© sur le bouton - la LED s'est allum√©e, le lavage a commenc√©.  L√¢chez prise - le contraire est vrai.  Cependant, apr√®s avoir analys√© la machine √† laver, il s'est av√©r√© que cette LED faisait partie de l'affichage dynamique et, h√©las, il n'est pas si facile de d√©terminer si elle est allum√©e ou √©teinte. <br><br>  En tournant le panneau de contr√¥le entre mes mains (quelques jours), j'ai trouv√© qu'il √©tait impl√©ment√© sur un contr√¥leur PIC.  De plus, il est connect√© √† la carte principale avec des pieds r√©pondant au mat√©riel I2C.  Ouais, je pensais, vous pouvez renifler le bus I2C et ainsi d√©terminer quoi faire la machine √† laver maintenant.  J'ai trouv√© le code de renifleur I2C pour Atmega sur Internet.  Bien s√ªr, je devais jouer quelque chose. <br><br>  Franchement: je n'ai pas pu comprendre le protocole compl√®tement (et je ne l'ai pas trop essay√©), mais j'ai r√©ussi √† d√©terminer les mod√®les pour le d√©but et la fin du lavage (ainsi que pour allumer et √©teindre) assez pr√©cis√©ment.  Cela m'a pris environ une semaine. <br><br>  Mod√®le: <b>Candy GC4 1072 D.</b>  L'ordinateur envoie p√©riodiquement une s√©rie de s√©quences de cinq octets √† l'unit√© d'affichage.  Les quatre premi√®res s√©quences sont au format: <br><br> <code>12 A7 00 ‚Äì NN ‚Äì X0 X1 X2 X3 X4 X5 X6 X7 ‚Äì CS</code> <br>  o√π: 12 A7 00 - en-t√™te, NN - num√©ro de s√©quence, X [0..7] - 8 octets de donn√©es, CS - somme de contr√¥le.  La cinqui√®me s√©quence est une poubelle de taille variable, dont l'essence est pour moi rest√©e un myst√®re. <br><br>  J'ai r√©ussi √† r√©soudre les sch√©mas suivants: <br><br>  <b>Allumer</b> <br><br> <code>12 A7 00 ‚Äì 01 ‚Äì X0 X1 X2 X3 X4 X5 X6 X7 ‚Äì CS <br> 12 A7 00 ‚Äì 02 ‚Äì X0 X1 X2 X3 X4 X5 X6 X7 ‚Äì CS</code> <br>  o√π X [0..7] au moins un n'est pas √©gal √† 0 <br><br>  <b>COMMENCER</b> <br><br> <code>12 A7 00 ‚Äì 03 ‚Äì X0 X1 X2 X3 01 01 01 01 ‚Äì CS</code> <br>  o√π X [0..3] est un nombre quelconque <br><br>  <b>STOP</b> <br><br> <code>12 A7 00 ‚Äì 03 ‚Äì X0 X1 X2 X3 00 00 00 00 ‚Äì CS</code> <br>  o√π X [0..3] est un nombre quelconque <br><br>  On peut voir que ce ne sont pas des s√©quences strictes, √† savoir des mod√®les, j'ai donc d√ª bricoler l'analyseur. <br><br>  La logique de travail est approximativement la suivante: si nous obtenons la s√©quence POWER ON, mais qu'il n'y a pas de START, alors nous commen√ßons √† diffuser des paquets avec le statut 0. Si la s√©quence START appara√Æt, changez le statut √† 1. Dans d'autres cas, il n'y a pas de casque. <br><br>  Nous parlerons des packages et de leur statut suivant. <br><br>  C'est dr√¥le, mais quand j'ai espionn√© des paquets I2C, je n'ai pas eu l'occasion de me connecter √† l'ordinateur renifleur.  J'ai utilis√© pour ce Raspberry Pi c powerbank'om, qui avait un bo√Ætier en aluminium.  Donc, d√®s que ce b√¢timent est entr√© en contact avec le corps de la laveuse, un RCD a √©t√© retir√© dans le bouclier, la lumi√®re s'est √©teinte dans l'appartement et j'ai commenc√© √† chercher la lampe de poche avec le matyuki.  :) Pourquoi ces ordures se sont produites - est toujours un myst√®re pour moi. <br><br><h3>  Cha√Æne radio </h3><br>  Au d√©part, je ne voulais pas que les fils suppl√©mentaires proviennent de la machine √† laver.  Autrement dit, la connexion √©tait cens√©e √™tre sans fil.  √Ä partir de l√†, il y avait trois solutions possibles au probl√®me: WiFi, Bluetooth et le module RF pour Arduino.  Je me suis install√© sur ce dernier en s√©lectionnant le module FS1000A. <br><br>  Bien s√ªr, sur Habr√© il y aura beaucoup de gens qui me reprocheront ce choix.  Ils laisseront entendre que sur Ali-Express, il est possible d'acheter un module ESP avec WiFi complet pour pas cher.  Mais j'ai pens√© que cela compliquerait grandement le projet et j'ai d√©cid√© d'agir plus simplement. <br><br>  Comme vous le savez, le module RF FS1000A ne peut pas √™tre connect√© directement √† l'interface RS232: une longue s√©quence de z√©ros ou de uns interrompt la synchronisation du r√©cepteur.  La biblioth√®que VirtualWire a √©t√© cr√©√©e pour r√©soudre ce probl√®me.  Cependant, cette biblioth√®que est √©crite pour Arduino, et je programme exclusivement en natif sous Atmega en C. Heureusement, le code pour Arduino est tr√®s similaire au C pur, et avec des modifications mineures, la biblioth√®que a √©t√© correctement port√©e. <br><br>  Il y a eu quelques difficult√©s: au d√©but, les paquets ne voulaient pas atteindre le r√©cepteur.  J'ai bl√¢m√© mes mains tordues pour tout, mais en connectant directement les terminaux des contr√¥leurs du r√©cepteur et de l'√©metteur, j'√©tais convaincu que tout fonctionnait dans la partie logicielle.  L'√©metteur command√© en Chine s'est r√©v√©l√© d√©fectueux.  J'ai d√ª acheter un autre kit.  Ensuite, j'ai r√©par√© l'ancien et maintenant j'ai deux ensembles d'√©metteur-r√©cepteur.  Rappelez-vous ce que j'ai √©crit sur la r√©duction des d√©chets? <br><br>  Les donn√©es ont √©t√© envoy√©es, mais que contiennent exactement ces donn√©es?  Voici ce qu'est le paquet transmis: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> dst; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> src; <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> WMP_MSG_STATUS_ALIVE _BV(0) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> WMP_MSG_STATUS_VALVE _BV(1) uint8_t status; } wmp_msg_t; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> WMP_ADDR_MONITOR 0x4d504d57 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> WMP_ADDR_CONTROLLER 0x43504d57</span></span></code> </pre><br>  Les deux premiers mots doubles sont les adresses physiques du r√©cepteur et de l'√©metteur.  Dans mon cas, ils sont strictement fixes: 0x43504d57 - r√©cepteur (contr√¥leur) et 0x4d504d57 - √©metteur (moniteur).  En fait, les 8 premiers octets sont cette signature de paquet.  Des informations importantes ne sont trouv√©es que dans le dernier octet - l'indicateur de bit.  Le bit z√©ro d√©fini de ce drapeau signifie que le moniteur est allum√© et fonctionne - il doit toujours √™tre 1. Le premier bit est l'√©tat de la vanne: 0 - la vanne doit √™tre ferm√©e, 1 - ouverte.  C‚Äôest tout. <br><br>  Il est suppos√© que le moniteur doit envoyer p√©riodiquement des paquets au contr√¥leur, confirmant son fonctionnement et la facilit√© de maintenance du canal de donn√©es.  En cas de perte du canal de communication, le contr√¥leur doit fermer d'urgence la vanne. <br><br>  La biblioth√®que VirtualWire surveille l'int√©grit√© des donn√©es transmises √† l'aide de CRC32.  Je n'ai pas eu √† faire d'efforts suppl√©mentaires dans ce sens.  La beaut√©! <br><br><h3>  La construction </h3><br>  Structurellement, le moniteur se pr√©sente sous la forme d'un petit tableau, qui est coll√© sur la colle chaude "Uncle Liao snot" √† l'int√©rieur du panneau avant de la machine √† laver. Par des connecteurs, le tableau est connect√© √† l'espace entre l'ordinateur et le tableau d'affichage.  La machine elle-m√™me n'a subi aucune modification: √† tout moment elle peut √™tre ramen√©e √† son √©tat d'origine. <br><br><h2>  Deuxi√®me partie  Contr√¥leur </h2><br><h3>  Cha√Æne radio </h3><br>  Ici, tout est simple: le r√©cepteur du kit FS1000A et le r√©cepteur de la biblioth√®que VirtualWire sont install√©s.  Le package est analys√© et son √©tat est transmis √† la sortie.  Le r√©cepteur VirtualWire occupe TIMER1 dans le microcontr√¥leur. <br><br><h3>  Contr√¥le de soupape </h3><br>  Dans la boutique en ligne chinoise, une vanne motoris√©e 3/4 ‚Äùa √©t√© s√©lectionn√©e avec une alimentation de 5 volts et des capteurs terminaux connect√©s au c√¢ble.  Cette vanne a √©t√© install√©e entre le robinet √† boisseau sph√©rique et le tuyau de la machine √† laver.  Pour contr√¥ler la vanne, sur le m√™me site chinois, un pilote de moteur pas √† pas de faible puissance a √©t√© command√© sur les pilotes L9110.  Je l'ai connect√© au contr√¥leur comme suit: <br><br><img src="https://habrastorage.org/webt/0a/dr/h9/0adrh9lsveasvy1hpqc6ogngsac.png"><br><br>  Du point de vue logiciel, il n'y a pas eu de difficult√©s particuli√®res: par les entr√©es VALVE_CLOSE et VALVE_OPEN on d√©termine l'√©tat actuel de la vanne.  Si cet √©tat doit √™tre chang√©, allumez le moteur pour l'ouverture ou la fermeture et attendez qu'un 0 logique soit √©tabli √† l'entr√©e correspondante. Cependant, comme l'ouverture ou la fermeture prend un certain temps, je voudrais ne pas perdre le contr√¥le de tout √† ce moment appareil.  Par cons√©quent, sur la minuterie Atmega, un planificateur primitif a √©t√© construit et le contr√¥le de la vanne a √©t√© transf√©r√© vers une t√¢che sp√©ciale.  Dans le m√™me temps, le module logiciel sp√©cial WatchDog mesure le temps n√©cessaire √† la valve pour commuter, et s'il est trop long, un signal de son dysfonctionnement est g√©n√©r√©.  Plus tard, d'autres choses int√©ressantes ont √©t√© accroch√©es √† ce planificateur, telles que les LED clignotantes et l'interrogation du capteur de fuite.  Mais plus √† ce sujet plus tard. <br><br>  En outre, une LED d'√©tat tricolore et un interrupteur √† bascule de commande manuelle √† trois positions appartiennent au circuit de commande de la vanne.  En position m√©diane de l'interrupteur √† bascule, la commande automatique est activ√©e en fonction des signaux de la machine √† laver et d'autres capteurs.  En cas de dysfonctionnement de la vanne, les couleurs rouge et verte s'allument alternativement. <br><br><h3>  LED et indication sonore </h3><br>  Avec les LED, tout est simple: elles s'accrochent directement aux ports d'E / S via des r√©sistances de limitation.  Les courants n'y sont pas importants et les ports d'Atmega sont assez puissants. <br><br>  Mais le son devait bricoler.  Premi√®rement, je n'ai pas trouv√© d'√©metteur pi√©zo√©lectrique grand et bruyant.  Il semble que de telles personnes existent dans la nature, mais d√®s que j'ai assist√© √† l'achat, il s'est av√©r√© que le choix n'√©tait m√™me pas grand du tout.  La chose la plus cool que j'ai r√©ussi √† faire √©tait tr√®s calme.  J'ai d√ª surfer sur Internet pour trouver des recettes. <br><br>  Je me suis install√© sur un circuit avec un transistor et un autotransformateur, qui fait passer la tension sonore de 5V √† 50V.  Et puis cela s'est av√©r√© relativement fort.  Pas √† toutes les fr√©quences, bien s√ªr, mais plus pr√®s de la r√©sonance. <br><br>  Ce n'est que lors de la g√©n√©ration du son que la luminosit√© des LED (jambage avec alimentation) a l√©g√®rement diminu√©, mais le microcontr√¥leur n'a pas gel√© et le programme de contr√¥le n'a pas cass√©.  Je pensais que c'√©tait une caract√©ristique de la disposition de d√©bogage et que tout fonctionnerait bien sur la carte finale.  Je me trompais - √ßa ne s'est pas am√©lior√©.  Pire aussi, cependant. <br><br><img src="https://habrastorage.org/webt/w8/ca/pb/w8capblzyb0abagztoygcputhsi.png"><br><br>  Un autre probl√®me √©tait que je manquais de minuteries et en arri√®re-plan, je ne pouvais pas g√©n√©rer de son.  Je devais demander la p√©riode de couinements avec sommeil.  Ainsi, lors de la g√©n√©ration du son, Atmega ne peut rien faire, mais les interruptions ont √©galement d√ª √™tre d√©sactiv√©es, sinon le ton n'est pas clair.  Mais cela ne s'est pas r√©v√©l√© tr√®s effrayant, car la sortie sonore n'a pas intercept√© d'autres t√¢ches critiques, telles que le contr√¥le d'une vanne ou la r√©ception de donn√©es par radio. <br><br>  Ensuite, j'ai s√©lectionn√© les constantes de sommeil pour qu'elles correspondent aux notes et j'ai trouv√© plusieurs combinaisons plus ou moins harmonieuses: ¬´la valve est ouverte¬ª, ¬´la valve est ferm√©e¬ª, ¬´le lavage est termin√©¬ª et ¬´fuite¬ª.  Je vous parlerai s√©par√©ment du signal "lavage termin√©" plus tard. <br><br><h3>  D√©tecteur de fuite </h3><br>  Le d√©tecteur de fuite √©tait initialement pr√©vu pour √™tre r√©alis√© sur l'ADC int√©gr√© du microcontr√¥leur.  Des exp√©riences ont montr√© qu'il s'agit d'une solution parfaitement op√©rationnelle.  Cependant, j'ai rencontr√© que parfois un condensateur est ajout√© au capteur avec des contacts pour qu'il soit connect√© et s'il n'y a pas de rupture du fil quelque part.  Vous pouvez v√©rifier la pr√©sence d'un condensateur (et mesurer sa capacit√©) √† l'aide de: cha√Æne RC, comparateur et horloge.  Comme comparateur, une entr√©e GPIO conventionnelle est utilis√©e (c'est aussi une entr√©e logique et passe de 0 √† 1 √† une certaine tension), et il y a suffisamment d'heures dans le microcontr√¥leur. <br><br><img src="https://habrastorage.org/webt/sh/um/rn/shumrnvjljzhpc_m7fdyye9ugwi.png"><br><br>  On a suppos√© que de temps en temps je v√©rifiais la pr√©sence d'un condensateur sur la ligne, puis j'utilisais l'ADC pour d√©terminer si les contacts du capteur √©taient dans l'eau.  Il s'est av√©r√© qu'il suffit de mesurer uniquement la capacit√© du condensateur: si vous l'abaissez dans l'eau, le temps de charge augmentera et la d√©charge diminuera.  De plus, l'heure changera d'une quantit√© suffisante pour pouvoir √™tre d√©tect√©e en toute confiance. <br><br>  Pour mon syst√®me, j'ai choisi de mesurer le temps de charge: si le condensateur n'est pas connect√©, alors il est nul, s'il est sec il est relativement petit, et s'il est dans l'eau, alors le temps de charge est beaucoup plus long.  Les valeurs exactes ont √©t√© d√©termin√©es en utilisant une soucoupe avec de l'eau et une s√©rie d'exp√©riences. <br><br>  Le d√©tecteur de fuite a sa propre LED rouge.  Si le capteur n'est pas d√©tect√©, il s'allume et l'ordre de fermer la vanne est transmis √† l'air.  Il suffit de r√©tablir la communication avec le capteur, la LED s'√©teint et la vanne peut √™tre ouverte (si seulement la machine est en √©tat de lavage, bien s√ªr).  Une autre chose est que si le capteur d√©tecte de l'eau.  Dans ce cas, l'indicateur commence √† clignoter, un bruit intermittent d√©sagr√©able se fait entendre et la valve est ferm√©e de force.  Mais surtout, le contr√¥leur ne quitte jamais cet √©tat.  Une fuite est consid√©r√©e comme un accident grave et l'alimentation en eau ne reprendra pas tant que vous n'aurez pas red√©marr√© l'appareil. <br><br><h3>  La nutrition </h3><br>  La nourriture est la partie la plus incompr√©hensible pour moi dans ce projet.  Si je suis un peu vers√© dans les circuits num√©riques, puis en analogique, pour le dire l√©g√®rement - pas vraiment.  Mais, gr√¢ce aux Chinois: je peux acheter des modules pr√™ts √† l'emploi pour les convertisseurs DC-DC avec des contr√¥leurs de charge de batterie, et en me basant sur eux, je peux penser √† quelque chose de r√©alisable. <br><br>  D√®s le d√©but, il a √©t√© pr√©vu de rendre l'appareil autonome, afin qu'en cas de panne de courant, assurez-vous que l'eau sera coup√©e.  De plus, j'avais une alimentation 9V qui devait √™tre connect√©e quelque part.  Au total, le r√©sultat introductif √©tait le suivant: <br><br><ul><li>  9V provient du r√©seau; </li><li>  3.4 ~ 3.7V provient de la batterie; </li><li>  pour charger la batterie, vous avez besoin de 5V; </li><li>  5 V est n√©cessaire pour alimenter la logique et les circuits de puissance; </li><li>  si la tension secteur tombe en panne, mettez la batterie sous tension; </li><li>  il est n√©cessaire de transmettre le signal de charge de la batterie, la tension sur la batterie et le signal de fonctionnement du r√©seau au contr√¥leur. </li></ul><br>  Le sch√©ma fonctionnel s'est av√©r√© comme sur la figure. <br><br><img src="https://habrastorage.org/webt/7g/ma/5l/7gma5lv_yub5aunjhing_cbnmjw.jpeg"><br><br>  Deux diodes Schottky sont utilis√©es comme √©l√©ment de commutation.  Le contr√¥leur de charge a deux LED: CHARGE et STANDBY.  Le signal du premier a √©t√© connect√© au port GPIO du contr√¥leur afin que le moniteur puisse savoir que la batterie √©tait en charge.  De plus, un signal provenant du premier convertisseur CC-CC est appliqu√© au port du microcontr√¥leur pour d√©terminer si l'appareil fonctionne sur secteur ou sur batterie.  Pour contr√¥ler le niveau de charge, la tension de la batterie est fournie √† l'ADC du contr√¥leur.  Si la tension est trop basse, le moniteur ferme la vanne et passe en mode veille: il ne r√©pond √† aucune commande tant que la tension secteur n'appara√Æt pas. <br><br>  Malheureusement, il y avait des jambages ici: pour une raison quelconque, le moteur de la valve prend une partie de l'√©nergie de la batterie.  Apparemment, j'ai fait une erreur avec la puissance du convertisseur r√©seau DC / DC ou avec l'√©paisseur des pistes d'alimentation sur la carte.  R√©sultat: apr√®s ouverture ou fermeture de la valve, la batterie commence √† se charger. <br><br>  Pour surveiller l'√©tat de l'alimentation, il y a une LED bicolore sp√©ciale.  S'il est vert, cela signifie que l'appareil fonctionne sur le r√©seau.  Si rouge - puis de la batterie.  S'il est vert, mais rouge clignote, la batterie est en charge. <br><br><h3>  Logique de travail </h3><br>  Eh bien, nous avons tout le mat√©riel et leur support logiciel, maintenant nous devons faire en sorte que tout cela interagisse les uns avec les autres.  Au d√©part, j'ai vu la mise en ≈ìuvre de la logique du travail sous la forme d'une grande boucle (ce qu'on appelle la boucle principale) avec un tas d'if √† l'int√©rieur. <br><br>  Dans le processus, il y avait un besoin d'un planificateur de t√¢ches pour des actions simples telles que: clignoter une LED, interroger un capteur de fuite, suivre le temps de commutation de la vanne et le contr√¥le de l'alimentation, que j'ai raccroch√© sur TIMER0.  Le planificateur lui-m√™me n'a pas d√©marr√© les fonctions associ√©es √† la t√¢che, mais a uniquement d√©fini le bit de synchronisation sur un dans le descripteur associ√© √† la t√¢che.  La t√¢che √©tait toujours effectu√©e dans le cycle principal, nous avons r√©ussi √† nous d√©barrasser des intervalles de temps de suivi, ce qui a rendu les choses tr√®s simples. <br><br>  Depuis les zoos du zoo, qui v√©rifient l'√©tat des diff√©rents sous-syst√®mes du contr√¥leur et prennent une d√©cision: il fallait refuser d'ouvrir ou de fermer la vanne.  Il est tr√®s difficile de d√©boguer cela et il est tr√®s facile de se confondre.  Au lieu de cela, j‚Äôai aim√© l‚Äôid√©e tir√©e de l‚Äôancien livre de D. Hazerman: ¬´Comment fabriquer soi-m√™me un robot¬ª.  Le livre a sugg√©r√© que chaque module g√©n√®re ses propres signaux de contr√¥le: avant, arri√®re, rotation, etc. Ensuite, seul celui qui provient d'un bloc avec une priorit√© plus √©lev√©e est s√©lectionn√© parmi ces signaux.  J'ai fait √† peu pr√®s la m√™me chose. <br><br>  J'ai prioris√© les blocs comme suit: <br><br><ol><li>  Bloc de fuite </li><li>  Unit√© de contr√¥le de batterie </li><li>  Unit√© de commande manuelle de soupape </li><li>  Unit√© de commande de vanne de commande radio </li><li>  Minuterie de soupape bloc WatchDog </li></ol><br>  Chaque bloc g√©n√®re trois commandes: UNDEFINED, OPEN et CLOSE. <br><br>  Le bloc de fuite a la priorit√© la plus √©lev√©e, mais il n'a pas la commande OPEN, mais sa commande CLOSE ferme d√©finitivement la vanne, peu importe ce que disent les autres blocs.  L'unit√© de commande manuelle peut interrompre n'importe quel signal de l'unit√© de canal radio, ce qui vous permet de contr√¥ler la vanne ind√©pendamment de ce que la machine √† laver nous indique.  Eh bien et ainsi de suite.  Autrement dit, une structure hi√©rarchique logique est apparue qui est facile √† comprendre et √† d√©boguer. <br><br>  Maintenant, revenons au signal: "le lavage est termin√©".  H√©las, mon mod√®le de machine √† laver n'a pas la possibilit√© d'informer de la fin de son travail √† l'aide du son: les ing√©nieurs de Candy n'ont pas pr√©vu une telle opportunit√©.  D'un autre c√¥t√©, j'ai un appareil suppl√©mentaire qui a un √©metteur pi√©zo et qui sait √† chaque instant ce que fait la machine √† laver.  Pourquoi ne pas lui faire rapporter la fin du lavage?  Eh bien, faisons grincer le contr√¥leur fort et m√©chant (√† la fr√©quence de r√©sonance) lorsque la valve ferme le signal.  Ajoutez un autre intervalle de garde de cinq minutes afin de ne pas √©couter ce grincement √† chaque fois que vous allumez et √©teignez la machine.  La valve est ouverte pendant cinq minutes - le lavage a d√©finitivement commenc√©. <br><br><h2>  R√©sultats </h2><br>  Le d√©veloppement m'a pris environ un an de travail sans h√¢te (tr√®s sans h√¢te).  L'appareil fonctionne depuis deux ans maintenant.  En fonctionnement, il s'est r√©v√©l√© assez satisfaisant.  Mais pas sans d√©fauts.  √ânum√©rons-les honn√™tement: <br><br><ol><li>  J'ai g√¢ch√© quelque chose avec la puissance: le moteur de la valve prend une partie de l'√©nergie de la batterie. </li><li>  Le circuit de g√©n√©ration de son tire la tension d'alimentation.  Vous pouvez voir clairement comment les LED changent de luminosit√© lorsque le son est jou√©. </li><li>  La cha√Æne radio n'est pas tr√®s stable.  Premi√®rement, le signal dispara√Æt si une personne se tient pr√®s du lave-linge.  Et deuxi√®mement, parfois le signal s'aggrave de lui-m√™me.  Dans ce cas, vous devez utiliser l'interrupteur √† bascule manuel, mais cela se produit extr√™mement rarement. </li><li>  Le moniteur de la machine √† laver a √©t√© suspendu plusieurs fois.  Le bloc contr√¥leur n'a pas √©t√© suspendu une seule fois. </li><li>  Le son de l'√©metteur pi√©zo √©tait tr√®s noy√© √† l'int√©rieur du bo√Ætier.  J'ai perc√© un trou dans le koprus: √ßa s'est am√©lior√©, mais pas vraiment.  J'ai d√ª souder l'√©metteur de la carte et le coller sur le bo√Ætier, directement en face du trou. </li></ol><br>  En g√©n√©ral, je consid√®re le d√©veloppement r√©ussi et tr√®s utile.  Je d√©marre la machine le matin et pars calmement pour le travail: je sais qu'au bon moment le robinet d'arriv√©e d'eau sera ferm√©. <br><br>  L'archive avec les fichiers du projet peut √™tre t√©l√©charg√©e <a href="">ici</a> . <br><br><h3>  Quelques photos. </h3><br><div class="spoiler">  <b class="spoiler_title">Vue de dessus avec couvercle sup√©rieur retir√©</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/pk/ac/1q/pkac1q7wwkmwbptyd814mobigx4.jpeg"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Vue arri√®re, du c√¥t√© des connecteurs</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/-z/3g/zq/-z3gzqv3s-dwhfuvlco9jkkqbcm.jpeg"><br></div></div><br><div class="spoiler"> <b class="spoiler_title">   </b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/kc/cv/sx/kccvsxlyr0qtrtirqf_c5hthamq.jpeg"><br></div></div><br><div class="spoiler"> <b class="spoiler_title">   </b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/bg/kh/yy/bgkhyyih1i083nb9omlxrqxo9be.jpeg"><br></div></div><br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/p5/qu/2y/p5qu2ygeapyr_ivwdguhkjmkcxs.jpeg"><br></div></div><br> <i>  <br> -  ¬´¬ª</i> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr472296/">https://habr.com/ru/post/fr472296/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr472280/index.html">La t√¢che de d√©terminer la pr√©sence d'une paume sur un scanner veineux</a></li>
<li><a href="../fr472288/index.html">9 extensions de navigateur utiles pour les d√©veloppeurs (liste pour 2020)</a></li>
<li><a href="../fr472290/index.html">Structures vs classes</a></li>
<li><a href="../fr472292/index.html">Blocage de contenu: la sc√®ne mondiale</a></li>
<li><a href="../fr472294/index.html">Cr√©ez des jeux et des vid√©os sur YouTube. Mon exp√©rience d'interaction et les revenus de cette</a></li>
<li><a href="../fr472298/index.html">Le condens√© de mati√®res fra√Æches du monde du front-end de la derni√®re semaine n ¬∞ 385 (14-20 octobre 2019)</a></li>
<li><a href="../fr472300/index.html">Descente de gradient stochastique (SGD) pour la fonction de perte logarithmique (LogLoss) dans un probl√®me de classification binaire</a></li>
<li><a href="../fr472304/index.html">La NASA embauche des ing√©nieurs pour d√©velopper un robot humano√Øde de nouvelle g√©n√©ration</a></li>
<li><a href="../fr472306/index.html">PHP Digest n ¬∞ 166 (7-21 octobre 2019)</a></li>
<li><a href="../fr472310/index.html">Identification des clients sur les sites sans mots de passe et cookies: application pour standard</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>