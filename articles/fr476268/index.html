<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👈 💬 📔 Solutions aux défis de détection de bugs proposés par l'équipe PVS-Studio lors de conférences en 2018-2019 👩🏾‍🤝‍👨🏿 😠 🐟</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Salut! Bien que la saison des conférences 2019 ne soit pas encore terminée, nous aimerions parler des défis de détection de bogues que nous avons prop...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Solutions aux défis de détection de bugs proposés par l'équipe PVS-Studio lors de conférences en 2018-2019</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/476268/"><p><img src="https://habrastorage.org/getpro/habr/post_images/701/9e4/589/7019e458975e9931a108882b6fd126a8.png" alt="Image 2" align="left"></p><br>  Salut!  Bien que la saison des conférences 2019 ne soit pas encore terminée, nous aimerions parler des défis de détection de bogues que nous avons proposés aux visiteurs sur notre stand lors des dernières conférences.  À partir de l'automne 2019, nous avons apporté un nouvel ensemble de défis, afin que nous puissions maintenant révéler les solutions aux tâches précédentes de 2018 et du premier semestre de 2019 - après tout, bon nombre d'entre elles provenaient d'articles précédemment publiés, et nous avions un lien ou un code QR avec des informations sur les articles respectifs imprimés sur nos brochures de défi. <br><a name="habracut"></a><br>  Si vous avez assisté à des événements auxquels nous avons participé avec un stand, vous avez probablement vu ou même essayé de résoudre certains de nos défis.  Ce sont des extraits de code de vrais projets open-source écrits en C, C ++, C # ou Java.  Chaque extrait contient un bogue, et les invités sont mis au défi d'essayer de le trouver.  Une solution réussie (ou simplement une participation à la discussion du bug) est récompensée par un prix: un statut de bureau en spirale, un trousseau de clés, etc.: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2d9/aff/240/2d9aff24000a4a61dd4eac65fef38083.jpg" alt="Image 4"></div><br>  Vous en voulez aussi?  Alors n'hésitez pas à passer nous voir sur notre stand lors des prochains événements. <br><br>  Soit dit en passant, dans les articles " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Conference Time! Summing up 2018</a> " et " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Conferences. Sub-totals for the first semestre of 2019</a> ", nous partageons notre expérience de participation aux événements organisés plus tôt cette année et en 2018. <br><br>  D'accord, jouons à notre jeu "Find the bug".  Nous allons d'abord jeter un coup d'œil aux défis antérieurs de 2018, regroupés par langue. <br><br><h2>  2018 </h2><br><h3>  C ++ </h3><br>  <b>Bug de chrome</b> <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> kDaysInMonth[<span class="hljs-number"><span class="hljs-number">13</span></span>] = { <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">31</span></span>, <span class="hljs-number"><span class="hljs-number">28</span></span>, <span class="hljs-number"><span class="hljs-number">31</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">31</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">31</span></span>, <span class="hljs-number"><span class="hljs-number">31</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">31</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">31</span></span> }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ValidateDateTime</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> DateTime&amp; time)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (time.year &lt; <span class="hljs-number"><span class="hljs-number">1</span></span> || time.year &gt; <span class="hljs-number"><span class="hljs-number">9999</span></span> || time.month &lt; <span class="hljs-number"><span class="hljs-number">1</span></span> || time.month &gt; <span class="hljs-number"><span class="hljs-number">12</span></span> || time.day &lt; <span class="hljs-number"><span class="hljs-number">1</span></span> || time.day &gt; <span class="hljs-number"><span class="hljs-number">31</span></span> || time.hour &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || time.hour &gt; <span class="hljs-number"><span class="hljs-number">23</span></span> || time.minute &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || time.minute &gt; <span class="hljs-number"><span class="hljs-number">59</span></span> || time.second &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || time.second &gt; <span class="hljs-number"><span class="hljs-number">59</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (time.month == <span class="hljs-number"><span class="hljs-number">2</span></span> &amp;&amp; IsLeapYear(time.year)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> time.month &lt;= kDaysInMonth[time.month] + <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> time.month &lt;= kDaysInMonth[time.month]; } }</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Solution</b> <div class="spoiler_text">  Ce bug trouvé dans Chromium était probablement le défi le plus «long»;  nous l'avons proposé tout au long de 2018 et l'avons également inclus dans plusieurs présentations. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (time.month == <span class="hljs-number"><span class="hljs-number">2</span></span> &amp;&amp; IsLeapYear(time.year)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> time.month &lt;= kDaysInMonth[time.month] + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-comment"><span class="hljs-comment">// &lt;= day } else { return time.month &lt;= kDaysInMonth[time.month]; // &lt;= day }</span></span></code> </pre> <br>  Le corps du dernier bloc <i>If-else</i> contient des fautes de frappe dans les instructions de retour: <i>time.month a</i> été accidentellement écrit une deuxième fois au lieu de <i>time.day</i> .  Cette erreur fait que la fonction retourne <i>vrai</i> tout le temps.  Le bogue est discuté en détail dans l'article " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">31 février</a> " et est un exemple sympa d'un bogue qui n'est pas facilement repéré par la révision du code.  Ce cas est également une bonne démonstration de la façon dont nous utilisons l'analyse de flux de données. <br></div></div><br>  <b>Bug moteur irréel</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">VertInfluencedByActiveBone</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( FParticleEmitterInstance* Owner, USkeletalMeshComponent* InSkelMeshComponent, int32 InVertexIndex, int32* OutBoneIndex = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">NULL</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> UParticleModuleLocationSkelVertSurface::Spawn(....) { .... int32 BoneIndex1, BoneIndex2, BoneIndex3; BoneIndex1 = BoneIndex2 = BoneIndex3 = INDEX_NONE; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!VertInfluencedByActiveBone( Owner, SourceComponent, VertIndex[<span class="hljs-number"><span class="hljs-number">0</span></span>], &amp;BoneIndex1) &amp;&amp; !VertInfluencedByActiveBone( Owner, SourceComponent, VertIndex[<span class="hljs-number"><span class="hljs-number">1</span></span>], &amp;BoneIndex2) &amp;&amp; !VertInfluencedByActiveBone( Owner, SourceComponent, VertIndex[<span class="hljs-number"><span class="hljs-number">2</span></span>]) &amp;BoneIndex3) { .... }</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Solution</b> <div class="spoiler_text">  La première chose à noter ici est que le dernier argument de la fonction <i>VertInfluencedByActiveBone ()</i> a une valeur par défaut et n'a pas besoin d'être spécifié.  Regardez maintenant le bloc <i>if</i> sous une forme simplifiée: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!foo(....) &amp;&amp; !foo(....) &amp;&amp; !foo(....) &amp; arg)</code> </pre> <br>  Le bug est maintenant clairement visible.  En raison de la faute de frappe, le troisième appel de la fonction <i>VertInfluencedByActiveBone ()</i> est effectué avec trois arguments au lieu de quatre, la valeur de retour participant alors à une opération <i>&amp;</i> (bit à bit ET: l'opérande de gauche est la valeur de type <i>bool</i> retournée par <i>VertInfluencedByActiveBone ( )</i> , et l'opérande de droite est la variable entière <i>BoneIndex3</i> ).  Le code est toujours compilable.  Il s'agit de la version fixe (une virgule ajoutée, la parenthèse fermante déplacée à la fin de l'expression): <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!VertInfluencedByActiveBone( Owner, SourceComponent, VertIndex[<span class="hljs-number"><span class="hljs-number">0</span></span>], &amp;BoneIndex1) &amp;&amp; !VertInfluencedByActiveBone( Owner, SourceComponent, VertIndex[<span class="hljs-number"><span class="hljs-number">1</span></span>], &amp;BoneIndex2) &amp;&amp; !VertInfluencedByActiveBone( Owner, SourceComponent, VertIndex[<span class="hljs-number"><span class="hljs-number">2</span></span>], &amp;BoneIndex3))</code> </pre> <br>  Cette erreur a été mentionnée à l'origine dans l'article " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Une vérification tant attendue de Unreal Engine 4</a> ", où elle était intitulée "la plus belle erreur", avec laquelle je suis totalement d'accord. <br></div></div><br>  <b>Bugs Android</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> TagMonitor::parseTagsToMonitor(String8 tagNames) { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::lock_guard&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::mutex&gt; lock(mMonitorMutex); <span class="hljs-comment"><span class="hljs-comment">// Expand shorthands if (ssize_t idx = tagNames.find("3a") != -1) { ssize_t end = tagNames.find(",", idx); char* start = tagNames.lockBuffer(tagNames.size()); start[idx] = '\0'; .... } .... }</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Solution</b> <div class="spoiler_text">  Le programmeur avait des hypothèses erronées sur la priorité des opérations dans l'état du bloc <i>if</i> .  Ce code ne fonctionne pas comme prévu: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ssize_t</span></span> idx = (tagNames.find(<span class="hljs-string"><span class="hljs-string">"3a"</span></span>) != <span class="hljs-number"><span class="hljs-number">-1</span></span>))</code> </pre> <br>  La variable <i>idx se</i> verra attribuer la valeur 0 ou 1, et si la condition est vraie ou fausse dépendra de cette valeur, ce qui est une erreur.  Ceci est la version fixe: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">ssize_t</span></span> idx = tagNames.find(<span class="hljs-string"><span class="hljs-string">"3a"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (idx != <span class="hljs-number"><span class="hljs-number">-1</span></span>)</code> </pre> <br>  Ce bug a été mentionné dans l'article " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Nous avons vérifié le code source Android par PVS-Studio, ou rien n'est parfait</a> ." <br></div></div><br>  Voici un autre défi non trivial avec un bogue Android: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int32_t</span></span> GGLfixed; <span class="hljs-function"><span class="hljs-function">GGLfixed </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gglFastDivx</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(GGLfixed n, GGLfixed d)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((d&gt;&gt;<span class="hljs-number"><span class="hljs-number">24</span></span>) &amp;&amp; ((d&gt;&gt;<span class="hljs-number"><span class="hljs-number">24</span></span>)+<span class="hljs-number"><span class="hljs-number">1</span></span>)) { n &gt;&gt;= <span class="hljs-number"><span class="hljs-number">8</span></span>; d &gt;&gt;= <span class="hljs-number"><span class="hljs-number">8</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> gglMulx(n, gglRecip(d)); }</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Solution</b> <div class="spoiler_text">  Le problème est dans l'expression <i>(d &gt;&gt; 24) + 1</i> . <br><br>  Le programmeur a voulu vérifier que les 8 bits les plus significatifs de la variable <i>d</i> sont mis à 1 mais pas tous à la fois.  En d'autres termes, ils voulaient vérifier que l'octet le plus significatif stocke n'importe quelle valeur sauf 0x00 et 0xFF.  Tout d'abord, le programmeur vérifie les bits les plus significatifs pour null en utilisant l'expression (d &gt;&gt; 24).  Ensuite, ils décalent les huit bits les plus significatifs vers l'octet le moins significatif, s'attendant à ce que le bit de signe le plus significatif soit dupliqué dans tous les autres bits.  Autrement dit, si la variable d a la valeur 0b11111111'00000000'00000000'00000000, elle deviendra 0b11111111'11111111'11111111'11111111 après le décalage.  En ajoutant 1 à la valeur <i>int</i> 0xFFFFFFFF, le programmeur s'attend à obtenir 0 (-1 + 1 = 0).  Ainsi, l'expression <i>((d &gt;&gt; 24) +1)</i> est utilisée pour vérifier que les huit bits les plus significatifs ne sont pas tous mis à 1. <br><br>  Cependant, le bit de signe le plus significatif n'est pas nécessairement "étalé" lorsqu'il est décalé.  Voici ce que dit la norme: «La valeur de E1 &gt;&gt; E2 correspond aux positions de bit E2 décalées vers la droite E1.  Si E1 a un type non signé ou si E1 a un type signé et une valeur non négative, la valeur du résultat est la partie intégrante du quotient de E1 / 2 ^ E2.  <i>Si E1 a un type signé et une valeur négative, la valeur résultante est définie par l'implémentation</i> . " <br><br>  Il s'agit donc d'un exemple de comportement défini par l'implémentation.  Le fonctionnement exact de ce code dépend de l'architecture du processeur et de l'implémentation du compilateur.  Les bits les plus significatifs peuvent bien finir comme des zéros après le décalage, et l'expression <i>((d &gt;&gt; 24) +1)</i> retournerait alors toujours une valeur autre que 0, c'est-à-dire une valeur toujours vraie. <br><br>  Il s'agit en effet d'un défi non trivial.  Comme le bug précédent, celui-ci a été initialement discuté dans l'article " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Nous avons vérifié le code source Android par PVS-Studio, ou rien n'est parfait</a> ". <br></div></div><br><h2>  2019 </h2><br><h3>  C ++ </h3><br>  <b>"C'est la faute de GCC"</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *s)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> r = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(*s) { r += ((r * <span class="hljs-number"><span class="hljs-number">20891</span></span> + *s *<span class="hljs-number"><span class="hljs-number">200</span></span>) | *s ^ <span class="hljs-number"><span class="hljs-number">4</span></span> | *s ^ <span class="hljs-number"><span class="hljs-number">3</span></span>) ^ (r &gt;&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>); s++; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> r &amp; <span class="hljs-number"><span class="hljs-number">0x7fffffff</span></span>; }</code> </pre> <br>  Le programmeur blâme le compilateur GCC 8 pour le bogue.  Est-ce vraiment la faute de GCC? <br><br><div class="spoiler">  <b class="spoiler_title">Solution</b> <div class="spoiler_text">  La fonction renvoie des valeurs négatives car le compilateur ne génère pas de code pour le AND au niveau du bit (&amp;).  Le bogue a à voir avec un comportement non défini.  Le compilateur remarque que la variable <i>r</i> est utilisée pour calculer et stocker une somme, avec uniquement des valeurs positives impliquées.  La variable <i>r</i> ne doit pas déborder car ce serait un comportement indéfini, avec lequel le compilateur n'est pas du tout tenu compte.  Il conclut donc que puisque <i>r</i> ne peut pas avoir de valeur négative à la fin de la boucle, l'opération <i>r &amp; 0x7fffffff</i> , qui efface le bit de signe, est inutile, donc il dit simplement à la fonction de renvoyer la valeur de <i>r</i> . <br><br>  Cette erreur a été décrite dans l'article " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PVS-Studio 6.26 Released</a> ". <br></div></div><br>  <b>Bug QT</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> QMetaObjectPrivate *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">priv</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> uint* data)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">reinterpret_cast</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QMetaObjectPrivate*&gt;(data); } <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> QMetaEnum::isFlag() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> offset = priv(mobj-&gt;d.data)-&gt;revision &gt;= <span class="hljs-number"><span class="hljs-number">8</span></span> ? <span class="hljs-number"><span class="hljs-number">2</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mobj &amp;&amp; mobj-&gt;d.data[handle + offset] &amp; EnumIsFlag; }</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Solution</b> <div class="spoiler_text">  Le pointeur <i>mobj</i> est traité de manière non sécurisée: déréférencé d'abord, puis vérifié.  Un classique. <br><br>  Le bug a été mentionné dans l'article " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Une troisième vérification de Qt 5 avec PVS-Studio</a> ". <br></div></div><br><h3>  C # </h3><br>  <b>Bogue Infer.NET</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WriteAttribute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(TextWriter writer, </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> name, object defaultValue, object value, Func&lt;object, </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; converter = null)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( defaultValue == null &amp;&amp; value == null || value.Equals(defaultValue)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> stringValue = converter == null ? value.ToString() : converter(value); writer.Write($<span class="hljs-string"><span class="hljs-string">"{name}=\"{stringValue}\" "</span></span>); }</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Solution</b> <div class="spoiler_text">  Une déréférence nulle de la variable de <i>valeur</i> peut se produire lors de l'évaluation de l' <i>expression value.Equals (defaultValue)</i> .  Cela se produit lorsque les valeurs des variables sont telles que <i>defaultValue! = Null</i> et <i>value == null</i> . <br><br>  Ce bogue provient de l'article " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Quelles erreurs se cachent dans le code Infer.NET?</a> " <br></div></div><br>  <b>Bogue FastReport</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FastString</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> initCapacity = <span class="hljs-number"><span class="hljs-number">32</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> iniCapacity)</span></span></span><span class="hljs-function"> </span></span>{ sb = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(iniCapacity); .... } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FastString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Init(initCapacity); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FastString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> iniCapacity)</span></span></span><span class="hljs-function"> </span></span>{ Init(initCapacity); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> StringBuilder StringBuilder =&gt; sb; } .... Console.WriteLine(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FastString(<span class="hljs-number"><span class="hljs-number">256</span></span>).StringBuilder.Capacity);</code> </pre> <br>  Quelle sera la sortie du programme dans la console?  Quel est le problème avec la classe <i>FastString</i> ? <br><br><div class="spoiler">  <b class="spoiler_title">Solution</b> <div class="spoiler_text">  Le programme affichera la valeur 32. La raison en est le nom mal orthographié de la variable passée à la méthode <i>Init</i> dans le constructeur: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FastString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> iniCapacity)</span></span></span></span>{ Init(initCapacity); }</code> </pre> <br>  Le paramètre constructeur <i>iniCapacity</i> ne sera pas utilisé;  ce qui est passé à la place est la constante <i>initCapacity</i> . <br><br>  Le bug a été discuté dans l'article " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Les rapports les plus rapides du Far West - et une poignée de bugs ...</a> " <br></div></div><br>  <b>Bug de Roslyn</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> SyntaxNode </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetNode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SyntaxNode root)</span></span></span><span class="hljs-function"> </span></span>{ var current = root; .... <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (current.FullSpan.Contains(....)) { .... var nodeOrToken = current.ChildThatContainsPosition(....); .... current = nodeOrToken.AsNode(); } .... } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> SyntaxNode </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AsNode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_token != null) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _nodeOrParent; }</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Solution</b> <div class="spoiler_text">  Déréférence nulle potentielle du <i>courant</i> dans l'expression <i>current.FullSpan.Contains (....)</i> .  La variable <i>actuelle</i> peut se voir attribuer une valeur nulle suite à l'appel de la méthode <i>nodeOrToken.AsNode ()</i> . <br><br>  Ce bogue provient de l'article " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Vérification du code source de Roslyn</a> ". <br></div></div><br>  <b>Bug Unity</b> <br><br><pre> <code class="cpp hljs">.... staticFields = packedSnapshot.typeDescriptions .Where(t =&gt; t.staticFieldBytes != null &amp; t.staticFieldBytes.Length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) .Select(t =&gt; UnpackStaticFields(t)) .ToArray() ....</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Solution</b> <div class="spoiler_text">  Une faute de frappe: l'opérateur <i>&amp;</i> est utilisé à la place de <i>&amp;&amp;</i> .  Cela se traduit par l'exécution de la <i>vérification t.staticFieldBytes.Length&gt; 0</i> tout le temps, même si la variable <i>t.staticFieldBytes</i> est <i>nulle</i> , ce qui, à son tour, conduit à une déréférence nulle. <br><br>  Ce bogue a été initialement montré dans l'article " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Discuter des erreurs dans les composants Open-Source d'Unity3D</a> ". <br></div></div><br><h3>  Java </h3><br>  <b>Bogue IntelliJ IDEA</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> boolean </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkSentenceCapitalization</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@NotNull String value)</span></span></span><span class="hljs-function"> </span></span>{ List&lt;String&gt; words = StringUtil.split(value, <span class="hljs-string"><span class="hljs-string">" "</span></span>); .... <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> capitalized = <span class="hljs-number"><span class="hljs-number">1</span></span>; .... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> capitalized / words.size() &lt; <span class="hljs-number"><span class="hljs-number">0.2</span></span>; <span class="hljs-comment"><span class="hljs-comment">// allow reasonable amount of // capitalized words }</span></span></code> </pre> <br>  Pourquoi le programme calcule-t-il incorrectement le nombre de mots en majuscule? <br><br><div class="spoiler">  <b class="spoiler_title">Solution</b> <div class="spoiler_text">  La fonction devrait renvoyer <i>true</i> si le nombre de mots en majuscule est inférieur à 20%.  Mais la vérification ne fonctionne pas à cause de la division entière, qui n'évalue que 0 ou 1. La fonction ne retournera <i>false</i> que si tous les mots sont en majuscule.  Sinon, la division donnera 0 et la fonction renverra <i>true</i> . <br><br>  Ce bug provient de l'article " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PVS-Studio pour Java</a> ". <br></div></div><br>  <b>Bogue Spotbugs</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getXMLType</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@WillNotClose InputStream in)</span></span></span><span class="hljs-function"> throws IOException </span></span>{ .... String s; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> count = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (count &lt; <span class="hljs-number"><span class="hljs-number">4</span></span>) { s = r.readLine(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (s == null) { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } Matcher m = tag.matcher(s); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (m.find()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> m.group(<span class="hljs-number"><span class="hljs-number">1</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IOException(<span class="hljs-string"><span class="hljs-string">"Didn't find xml tag"</span></span>); .... }</code> </pre> <br>  Quel est le problème avec la recherche de la balise xml? <br><br><div class="spoiler">  <b class="spoiler_title">Solution</b> <div class="spoiler_text">  La condition <i>count &lt;4</i> sera toujours vraie car le <i>nombre de</i> variables n'est pas incrémenté à l'intérieur de la boucle.  La balise xml était censée être recherchée dans les quatre premières lignes du fichier, mais en raison de l'incrément manquant, le programme lira l'intégralité du fichier. <br><br>  Comme le bug précédent, celui-ci a été décrit dans l'article " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PVS-Studio for Java</a> ". <br></div></div><br>  C'est tout pour aujourd'hui.  Venez nous voir lors des prochains événements - cherchez la licorne.  Nous proposerons de nouveaux défis intéressants et, bien sûr, donnerons des prix.  A bientôt! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr476268/">https://habr.com/ru/post/fr476268/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr476258/index.html">Migration de la base de données GitLab vers PostgreSQL externe</a></li>
<li><a href="../fr476260/index.html">Nous collectons dans rpm WireMock - un utilitaire pour créer des talons sur les services Web dans Fedora COPR analogique de PPA dans Ubuntu</a></li>
<li><a href="../fr476262/index.html">À propos des miroirs du référentiel Centos et choisir le meilleur</a></li>
<li><a href="../fr476264/index.html">Bot télégramme pour l'apprentissage des langues étrangères: du bourrage de mots à la parole</a></li>
<li><a href="../fr476266/index.html">Stage chez Mars Digital Technologies. Comment nous avons appliqué le deep learning chez M&M's</a></li>
<li><a href="../fr476270/index.html">Notre victoire: TopCoder Open 2019</a></li>
<li><a href="../fr476272/index.html">Réponses aux tâches du stand PVS-Studio lors des conférences 2018-2019</a></li>
<li><a href="../fr476276/index.html">Écrire un simple équilibreur sur Go</a></li>
<li><a href="../fr476278/index.html">Conférence BLACK HAT USA. Devenez riche ou mourez: gagnez de l'argent sur Internet en utilisant Black Hat. 3e partie</a></li>
<li><a href="../fr476280/index.html">À travers les épines jusqu'au DOS: quatre disquettes qui ont changé le monde</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>