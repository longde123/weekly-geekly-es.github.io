<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👐🏽 👨🏻‍🔬 ➰ تهيئة وتشغيل مترجم bytecode في JVM HotSpot تحت x86 👨🏻‍🌾 ✊🏽 🚛</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="يعرف كل مطور برامج Java تقريبًا أن البرامج المكتوبة بلغة Java يتم تجميعها مبدئيًا في رمز JVM وتخزينها في صورة ملفات فئة بتنسيق قياسي . بعد الحصول على ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>تهيئة وتشغيل مترجم bytecode في JVM HotSpot تحت x86</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/469291/" style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl"> يعرف كل مطور برامج Java تقريبًا أن البرامج المكتوبة بلغة Java يتم تجميعها مبدئيًا في رمز JVM وتخزينها في صورة ملفات فئة <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">بتنسيق قياسي</a> .  بعد الحصول على ملفات الفئة هذه داخل الجهاز الظاهري وحتى يقوم المترجم بالوصول إليها ، يفسر JVM الرمز الفرعي الوارد في ملفات الفئة هذه.  توفر هذه المقالة نظرة عامة حول كيفية عمل المترجم الشفهي فيما يتعلق بـ OpenJDK JVM HotSpot. </p><a name="habracut"></a><br><p style=";text-align:right;direction:rtl">  محتوى المقال: </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  البيئة </li><li style=";text-align:right;direction:rtl">  تشغيل تطبيق جافا </li><li style=";text-align:right;direction:rtl">  تهيئة المترجم والتحكم في النقل إلى كود جافا </li><li style=";text-align:right;direction:rtl">  مثال </li></ul><br><h4 id="okruzhenie" style=";text-align:right;direction:rtl">  البيئة </h4><br><p style=";text-align:right;direction:rtl">  للتجارب ، نستخدم مجموعة أحدث إصدارات OpenJDK JDK12 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">المتاحة</a> مع <a href="">التكوين التلقائي</a> </p><br><pre style=";text-align:right;direction:rtl"><code class="plaintext hljs">--enable-debug --with-native-debug-symbols=internal</code> </pre> <br><p style=";text-align:right;direction:rtl">  على Ubuntu 18.04 / gcc 7.4.0. </p><br><p style=";text-align:right;direction:rtl">  <code>--with-native-debug-symbols=internal</code> يعني أنه عند بناء JDK ، سيتم تضمين رموز debazh في الثنائيات نفسها. </p><br><p style=";text-align:right;direction:rtl">  <code>--enable-debug</code> - أن الثنائي سيحتوي على رمز تصحيح إضافي. </p><br><p style=";text-align:right;direction:rtl">  بناء JDK 12 في مثل هذه البيئة ليست عملية معقدة.  كل ما كنت بحاجة إلى القيام به هو تثبيت JDK11 ( <a href="">JDK n-1 مطلوب لإنشاء JDK n</a> ) وتسليم المكتبات اللازمة تلقائيًا للإشارة التلقائية.  بعد ذلك ، قم بتشغيل الأمر </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">bash configure --enable-debug --with-native-debug-symbols=internal &amp;&amp; make CONF=fastdebug images</code> </pre> <br><p style=";text-align:right;direction:rtl">  وبعد الانتظار قليلاً (على جهاز الكمبيوتر المحمول الخاص بي حوالي 10 دقائق) ، نحصل على fastdebug build JDK 12. </p><br><p style=";text-align:right;direction:rtl">  من حيث المبدأ ، سيكون من السهل جدًا تثبيت jdk من المستودعات العامة وتزويد حزمة openjdk-xx-dbg بالإضافة إلى ذلك برموز التصحيح ، حيث أن xx هي إصدار jdk ، ولكن التجميع fastdebug يوفر وظائف للتصحيح من gdb ، والتي يمكن أن تجعل الحياة أسهل في بعض الحالات.  في الوقت الحالي ، أستخدم بنشاط <a href="">ps ()</a> ، وهي وظيفة لعرض آثار مكدس Java من gdb ، و <a href="">pfl ()</a> ، وهي وظيفة لتحليل مكدس الإطارات (مفيد جدًا عند تصحيح أخطاء المترجم الفوري في gdb). </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">مثال ps () و pfl ()</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl">  على سبيل المثال ، ضع في الاعتبار برنامج نصي gdb التالي </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">#   java file /home/dmitrii/jdk12/build/linux-x86_64-server-fastdebug/images/jdk/bin/java #   SEGV-, HotSpot #  SEGV  . #, https://hg.openjdk.java.net/jdk/jdk12/file/06222165c35f/src/hotspot/cpu/x86/vm_version_x86.cpp#l361 handle SIGSEGV nostop noprint set breakpoint pending on set pagination off #  ,   #    # java- public static void main(String args[]) b PostJVMInit thread 2 commands #   , #    set $buf = (char *) malloc(1000) #        #(   ) b *AbstractInterpreter::_entry_table[0] thread 2 commands #      rbx. #   Method* set $mthd = ((Method *) $rbx) #    $buf call $mthd-&gt;name_and_sig_as_C_string($buf, 1000) # ,  public static void main(String args) if strcmp()("Main.main([Ljava/lang/String;)V", $buf) == 0 #   ,      # ps/pfl        #(    ps/pfl) b InterpreterRuntime::build_method_counters(JavaThread*, Method*) commands #  ,    #   delete breakpoints call ps() call pfl() c end end c end c end r -cp /home/dmitrii/jdk12/ Main</code> </pre> <br><p style=";text-align:right;direction:rtl">  نتيجة تشغيل مثل هذا البرنامج النصي هي: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">"Executing ps" for thread: "main" #1 prio=5 os_prio=0 cpu=468,61ms elapsed=58,65s tid=0x00007ffff001b800 nid=0x5bfa runnable [0x00007ffff7fd9000] java.lang.Thread.State: RUNNABLE Thread: 0x00007ffff001b800 [0x5bfa] State: _running _has_called_back 0 _at_poll_safepoint 0 JavaThread state: _thread_in_Java 1 - frame( sp=0x00007ffff7fd9920, unextended_sp=0x00007ffff7fd9920, fp=0x00007ffff7fd9968, pc=0x00007fffd828748b) Main.main(Main.java:10) "Executing pfl" for thread: "main" #1 prio=5 os_prio=0 cpu=468,83ms elapsed=58,71s tid=0x00007ffff001b800 nid=0x5bfa runnable [0x00007ffff7fd9000] java.lang.Thread.State: RUNNABLE Thread: 0x00007ffff001b800 [0x5bfa] State: _running _has_called_back 0 _at_poll_safepoint 0 JavaThread state: _thread_in_Java [Describe stack layout] 0x00007ffff7fd99e0: 0x00007ffff7fd9b00 #2 entry frame call_stub word fp - 0 0x00007ffff7fd99d8: 0x00007ffff7fd9c10 call_stub word fp - 1 0x00007ffff7fd99d0: 0x00007fffd8287160 call_stub word fp - 2 0x00007ffff7fd99c8: 0x00007fffbf1fb3e0 call_stub word fp - 3 0x00007ffff7fd99c0: 0x000000000000000a call_stub word fp - 4 0x00007ffff7fd99b8: 0x00007ffff7fd9ce8 call_stub word fp - 5 0x00007ffff7fd99b0: 0x00007ffff7fd9a80 call_stub word fp - 6 0x00007ffff7fd99a8: 0x00007ffff001b800 call_stub word fp - 7 0x00007ffff7fd99a0: 0x00007ffff7fd9b40 call_stub word fp - 8 0x00007ffff7fd9998: 0x00007ffff7fd9c00 call_stub word fp - 9 0x00007ffff7fd9990: 0x00007ffff7fd9a80 call_stub word fp - 10 0x00007ffff7fd9988: 0x00007ffff7fd9ce0 call_stub word fp - 11 0x00007ffff7fd9980: 0x00007fff00001fa0 call_stub word fp - 12 0x00007ffff7fd9978: 0x0000000716a122b8 sp for #2 locals for #1 unextended_sp for #2 local 0 0x00007ffff7fd9970: 0x00007fffd82719f3 0x00007ffff7fd9968: 0x00007ffff7fd99e0 #1 method Main.main([Ljava/lang/String;)V @ 0 - 1 locals 1 max stack 0x00007ffff7fd9960: 0x00007ffff7fd9978 interpreter_frame_sender_sp 0x00007ffff7fd9958: 0x0000000000000000 interpreter_frame_last_sp 0x00007ffff7fd9950: 0x00007fffbf1fb3e0 interpreter_frame_method 0x00007ffff7fd9948: 0x0000000716a11c40 interpreter_frame_mirror 0x00007ffff7fd9940: 0x0000000000000000 interpreter_frame_mdp 0x00007ffff7fd9938: 0x00007fffbf1fb5e8 interpreter_frame_cache 0x00007ffff7fd9930: 0x00007ffff7fd9978 interpreter_frame_locals 0x00007ffff7fd9928: 0x00007fffbf1fb3d0 interpreter_frame_bcp 0x00007ffff7fd9920: 0x00007ffff7fd9920 sp for #1 interpreter_frame_initial_sp unextended_sp for #1</code> </pre> <br><p style=";text-align:right;direction:rtl">  كما ترون ، في حالة <code>ps()</code> نحصل فقط على مكدس الاستدعاءات ، في حالة <code>pfl()</code> - المنظمة الكاملة للمكدس. </p></div></div><br><h4 id="zapusk-java-prilozheniya" style=";text-align:right;direction:rtl">  تشغيل تطبيق جافا </h4><br><p style=";text-align:right;direction:rtl">  قبل متابعة مناقشة المترجم الفوري مباشرةً ، سنراجع بإيجاز الإجراءات التي يتم تنفيذها قبل نقل التحكم إلى شفرة java.  على سبيل المثال ، خذ برنامج جافا "لا يفعل شيئًا على الإطلاق": </p><br><pre style=";text-align:right;direction:rtl"> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Main</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String args[])</span></span></span></span>{ } }</code> </pre> <br><p style=";text-align:right;direction:rtl">  وحاول معرفة ما يحدث عند تشغيل مثل هذا التطبيق: </p><br><p style=";text-align:right;direction:rtl"> <code>javac Main.java &amp;&amp; java Main</code> </p> <br><p style=";text-align:right;direction:rtl">  أول ما يجب فعله للإجابة على هذا السؤال هو العثور على java binary وإلقاء نظرة عليه - وهو الذي نستخدمه لتشغيل جميع تطبيقات JVM الخاصة بنا.  في حالتي ، وهي تقع على طول الطريق </p><br><p style=";text-align:right;direction:rtl">  <code>/home/dmitrii/jdk12/build/linux-x86_64-server-fastdebug/images/jdk/bin/java</code> . </p><br><p style=";text-align:right;direction:rtl">  لكن في النهاية ، لا يوجد شيء مميز يمكن مشاهدته.  هذا ثنائي والذي ، إلى جانب رموز debazhnymi ، لا يستغرق سوى 20 كيلو بايت ويتم تجميعه من <a href="">قاذفة /</a> مصدر ملف مصدر واحد فقط. </p><br><p style=";text-align:right;direction:rtl">  كل ما يفعله هو تلقي وسيطات سطر الأوامر (char * argv []) ، <a href="">وقراءة الوسائط من متغير البيئة JDK_JAVA_OPTIONS</a> ، وإجراء المعالجة المسبقة الأساسية والتحقق من الصحة (على سبيل المثال ، لا يمكنك إضافة <a href="">خيار المحطة الطرفية</a> أو اسم الفئة الرئيسية إلى متغير البيئة هذا) <a href="">واستدعاء الوظيفة JLI_La</a> مع قائمة الوسيطة الناتجة. </p><br><p style=";text-align:right;direction:rtl">  لا <a href="">يتم</a> تضمين تعريف وظيفة JLI_Launch في java binary ، وإذا نظرت إلى التبعيات المباشرة: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">$ ldd java linux-vdso.so.1 (0x00007ffcc97ec000) libjli.so =&gt; /home/dmitrii/jdk12/build/linux-x86_64-server-fastdebug/images/jdk/bin/./../lib/libjli.so (0x00007ff27518d000) // &lt;---------    libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007ff274d9c000) libz.so.1 =&gt; /lib/x86_64-linux-gnu/libz.so.1 (0x00007ff274b7f000) libdl.so.2 =&gt; /lib/x86_64-linux-gnu/libdl.so.2 (0x00007ff27497b000) libpthread.so.0 =&gt; /lib/x86_64-linux-gnu/libpthread.so.0 (0x00007ff27475c000) /lib64/ld-linux-x86-64.so.2 (0x00007ff27559f000)</code> </pre> <br><p style=";text-align:right;direction:rtl">  تستطيع أن ترى <strong>libjli.so</strong> الذي يرتبط به.  تحتوي هذه المكتبة على واجهة قاذفة - مجموعة من الوظائف التي تستخدم java لتهيئة وبدء تشغيل جهاز ظاهري ، من بينها JLI_Launch. </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">قائمة كاملة من ميزات واجهة</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">$ objdump -T -j .text libjli.so libjli.so: file format elf64-x86-64 DYNAMIC SYMBOL TABLE: 0000000000009280 g DF .text 0000000000000038 Base JLI_List_add 0000000000003330 g DF .text 00000000000001c3 Base JLI_PreprocessArg 0000000000008180 g DF .text 0000000000000008 Base JLI_GetStdArgs 0000000000008190 g DF .text 0000000000000008 Base JLI_GetStdArgc 0000000000007e50 g DF .text 00000000000000b8 Base JLI_ReportErrorMessage 000000000000a400 g DF .text 00000000000000df Base JLI_ManifestIterate 0000000000002e70 g DF .text 0000000000000049 Base JLI_InitArgProcessing 0000000000008000 g DF .text 0000000000000011 Base JLI_ReportExceptionDescription 0000000000003500 g DF .text 0000000000000074 Base JLI_AddArgsFromEnvVar 0000000000007f10 g DF .text 00000000000000e9 Base JLI_ReportErrorMessageSys 0000000000005840 g DF .text 00000000000000b8 Base JLI_ReportMessage 0000000000009140 g DF .text 000000000000003a Base JLI_SetTraceLauncher 0000000000009020 g DF .text 000000000000000a Base JLI_MemFree 0000000000008f90 g DF .text 0000000000000026 Base JLI_MemAlloc 00000000000059c0 g DF .text 0000000000002013 Base JLI_Launch 00000000000091c0 g DF .text 000000000000003b Base JLI_List_new 0000000000008ff0 g DF .text 0000000000000026 Base JLI_StringDup 0000000000002ec0 g DF .text 000000000000000c Base JLI_GetAppArgIndex</code> </pre> </div></div><br><p style=";text-align:right;direction:rtl">  بعد نقل التحكم إلى JLI_Launch ، يلزم اتخاذ عدد من الإجراءات لبدء JVM ، مثل: </p><br><p style=";text-align:right;direction:rtl">  <strong>I.</strong>  تحميل أحرف JVM HotSpot في الذاكرة والحصول على مؤشر إلى وظيفة لإنشاء VM. </p><br><p style=";text-align:right;direction:rtl">  كل كود JVM HotSpot موجود في مكتبة libjvm.so.  بعد تحديد المسار المطلق إلى libjvm.so ، يتم <a href="">تحميل المكتبة في الذاكرة</a> <a href="">وتمزيق المؤشر إلى دالة JNI_CreateJavaVM</a> .  يتم تخزين مؤشر الوظيفة هذا واستخدامه فيما بعد لإنشاء الجهاز الظاهري وتهيئته. </p><br><p style=";text-align:right;direction:rtl">  من الواضح أن libjvm.so غير مرتبط بـ libjli.so </p><br><p style=";text-align:right;direction:rtl">  <strong>الثاني</strong> .  تحليل الحجج التي تم تمريرها بعد المعالجة المسبقة. </p><br><p style=";text-align:right;direction:rtl">  تقوم دالة تحمل الاسم الناطق <a href="">ParseArguments</a> بتوزيع الوسائط التي تم تمريرها من سطر الأوامر.  يعرّف محلل الوسيطة <a href="">وضع بدء تشغيل التطبيق</a> </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> LaunchMode { <span class="hljs-comment"><span class="hljs-comment">// cf. sun.launcher.LauncherHelper LM_UNKNOWN = 0, LM_CLASS, LM_JAR, LM_MODULE, LM_SOURCE };</span></span></code> </pre> <br><p style=";text-align:right;direction:rtl">  كما أنه يحول جزءًا من الوسائط إلى التنسيق <code>-DpropertyName=propertyValue</code> ، على سبيل المثال ، <code>-cp=/path</code> تحويل <code>-cp=/path</code> إلى <code>-Djava.class.path=/path</code> .  علاوة على ذلك ، يتم تخزين <code>SystemProperty</code> في <a href="">الصفيف العمومي</a> في JVM HotSpot وإعادة توجيهه إلى <code>java.lang.System::props</code> في <a href="">المرحلة الأولى من التهيئة</a> (في JDK12 ، تم تعديل آلية التهيئة لـ java.lang.System.props ، أكثر في <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">هذا الالتزام</a> ). </p><br><p style=";text-align:right;direction:rtl">  تحليل الحجج يتجاهل أيضًا بعض الخيارات التي لم تتم معالجتها بواسطة JVM (على سبيل المثال <code>--list-modules</code> ، تحدث معالجة هذا الخيار مباشرة في المشغّل في <a href="">هذه المرحلة</a> ). </p><br><p style=";text-align:right;direction:rtl">  <strong>ثالثا</strong> .  شوكة موضوع بدائية وإنشاء VM فيه </p><br><p style=";text-align:right;direction:rtl">  ولكن إذا حدث خطأ ما ، يتم إجراء محاولة <a href="">لبدء تشغيل JVM في الخيط الرئيسي</a> "فقط قم بتجربته". </p><br><p style=";text-align:right;direction:rtl">  بعد دراسة السؤال ، وجدت أحد الأسباب المحتملة لعدم بدء JVM في سلسلة الرسائل الرئيسية.  والحقيقة هي أن (على الأقل على لينكس) pthreads والخيط الرئيسي العمل بشكل مختلف مع المكدس.  يقتصر حجم thread- الرئيسي بواسطة ulimit <code>ulimit -s</code> ، أي  عند تحديد قيمة كبيرة بشكل تعسفي ، نحصل على كومة كبيرة بشكل تعسفي.  يستخدم مؤشر الترابط الرئيسي شيئًا مشابهًا لـ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">MAP_GROWSDOWN</a> ، ولكن لا <code>MAP_GROWSDOWN</code> .  استخدام <code>MAP_GROWSDOWN</code> في شكله النقي ليس آمنًا ، وإذا كانت الذاكرة <code>MAP_GROWSDOWN</code> صحيح ، تكون مؤمنة.  على الجهاز الخاص بي ، لا يضيف <code>MAP_GROWSDOWN</code> أي تأثير.  يتمثل الاختلاف بين تعيين مؤشر الترابط الرئيسي و MAP_GROWSDOWN في أنه لا يوجد ملف <code>mmap</code> ، باستثناء <code>MAP_FIXED</code> ، سيكون قادراً على التصادم مع منطقة توسيع المكدس المحتملة.  كل ما نحتاجه من البرنامج هو تعيين قيمة <code>rsp</code> المقابلة ومن ثم سيقوم نظام التشغيل <code>rsp</code> : وسيعمل خطأ الصفحة <code>rsp</code> <a href="">الحارس</a> .  يؤثر هذا الاختلاف على عدد من المكابس: <a href="">عند تحديد حجم مكدس الدفق الحالي</a> ، <a href="">عند إنشاء صفحات الحماية</a> </p><br><p style=";text-align:right;direction:rtl">  لذلك ، سوف نفترض أنه في الوقت الحالي قمنا بتحليل الخيارات بنجاح وقمنا بإنشاء مؤشر ترابط لـ VM.  بعد ذلك ، يبدأ مؤشر الترابط forked فقط في إنشاء جهاز افتراضي <a href="">وإدخال دالة Threads :: create_vm</a> </p><br><p style=";text-align:right;direction:rtl">  في هذه الوظيفة ، يتم إجراء عدد كبير إلى حد ما <del>  السحر الاسود </del>  التهيئة ، سنكون مهتمين فقط عدد قليل منهم. </p><br><h4 id="inicializaciya-intepretatora-i-peredacha-upravleniya-java-kodu" style=";text-align:right;direction:rtl">  تهيئة المترجم ونقل السيطرة على كود جافا </h4><br><p style=";text-align:right;direction:rtl">  لكل تعليمات في JVM HotSpot ، يوجد قالب رمز آلة معين لهيكل معين.  عندما يبدأ المترجم في تنفيذ التعليمات ، فإن أول شيء يبحث عنه هو عنوان القالب الخاص به في جدول <a href="">DispatchTable</a> الخاص.  بعد ذلك ، <a href="">انتقل</a> إلى عنوان هذا القالب وبعد اكتمال تنفيذ التعليمات ، تقوم jvm بإخراج عنوان <a href="">التعليمة التالية بالترتيب</a> ) وتبدأ في تنفيذها بالطريقة نفسها ، وهكذا.  يتم ملاحظة هذا السلوك مع المترجم فقط للإرشادات التي لا "ترسل" ، على سبيل المثال ، الإرشادات الحسابية ( <code>xsub</code> ، <code>xdiv</code> ، إلخ ، حيث <code>x</code> - <code>i</code> ، <code>l</code> ، <code>f</code> ، <code>d</code> ).  كل ما يفعلونه هو إجراء العمليات الحسابية. </p><br><p style=";text-align:right;direction:rtl">  في حالة تعليمات الاحتجاج بالإجراءات ( <code>invokestatic</code> ، <code>invokevirtual</code> ، إلخ) ، فإن التعليمة التالية التي سيتم تنفيذها ستكون هي التعليمة الأولى في الإجراء المدعو.  تضع هذه التعليمات نفسها عنوان التعليمة البرمجية التالية التي سيتم تنفيذها في قالبها. </p><br><p style=";text-align:right;direction:rtl">  لضمان تشغيل هذا الجهاز في <a href=""><code>Threads::create_vm</code></a> ، يتم تنفيذ عدد من عمليات التهيئة التي يعتمد عليها المترجم: </p><br><p style=";text-align:right;direction:rtl">  <strong>I.</strong>  تهيئة جدول الرموز المتاحة </p><br><p style=";text-align:right;direction:rtl">  قبل الشروع في تهيئة المترجم الشفهي ، من الضروري تهيئة جدول الشفرات المستخدمة.  يتم تنفيذه في الدالة <a href="">Bytecodes :: initialize</a> ويتم تقديمه كتسمية قابلة للقراءة للغاية.  شظتها هي كما يلي: </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"> <span class="hljs-comment"><span class="hljs-comment">// Java bytecodes // bytecode bytecode name format wide f. result tp stk traps def(_nop , "nop" , "b" , NULL , T_VOID , 0, false); def(_aconst_null , "aconst_null" , "b" , NULL , T_OBJECT , 1, false); def(_iconst_m1 , "iconst_m1" , "b" , NULL , T_INT , 1, false); def(_iconst_0 , "iconst_0" , "b" , NULL , T_INT , 1, false); def(_iconst_1 , "iconst_1" , "b" , NULL , T_INT , 1, false); def(_iconst_2 , "iconst_2" , "b" , NULL , T_INT , 1, false); def(_iconst_3 , "iconst_3" , "b" , NULL , T_INT , 1, false); def(_iconst_4 , "iconst_4" , "b" , NULL , T_INT , 1, false); def(_iconst_5 , "iconst_5" , "b" , NULL , T_INT , 1, false); def(_lconst_0 , "lconst_0" , "b" , NULL , T_LONG , 2, false); def(_lconst_1 , "lconst_1" , "b" , NULL , T_LONG , 2, false); def(_fconst_0 , "fconst_0" , "b" , NULL , T_FLOAT , 1, false); def(_fconst_1 , "fconst_1" , "b" , NULL , T_FLOAT , 1, false); def(_fconst_2 , "fconst_2" , "b" , NULL , T_FLOAT , 1, false); def(_dconst_0 , "dconst_0" , "b" , NULL , T_DOUBLE , 2, false); def(_dconst_1 , "dconst_1" , "b" , NULL , T_DOUBLE , 2, false); def(_bipush , "bipush" , "bc" , NULL , T_INT , 1, false); def(_sipush , "sipush" , "bcc" , NULL , T_INT , 1, false); def(_ldc , "ldc" , "bk" , NULL , T_ILLEGAL, 1, true ); def(_ldc_w , "ldc_w" , "bkk" , NULL , T_ILLEGAL, 1, true ); def(_ldc2_w , "ldc2_w" , "bkk" , NULL , T_ILLEGAL, 2, true );</span></span></code> </pre> <br><p style=";text-align:right;direction:rtl">  وفقًا لهذا الجدول ، يتم تعيين طوله لكل رمز ثانوي (يكون الحجم دائمًا بايت واحد ، ولكن قد يكون هناك أيضًا فهرس في <code>ConstantPool</code> ، وكذلك الرموز الجانبية الواسعة) والاسم والرمز الثانوي والأعلام: </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> Bytecodes::_is_initialized = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* Bytecodes::_name [Bytecodes::number_of_codes]; BasicType Bytecodes::_result_type [Bytecodes::number_of_codes]; s_char Bytecodes::_depth [Bytecodes::number_of_codes]; u_char Bytecodes::_lengths [Bytecodes::number_of_codes]; Bytecodes::Code Bytecodes::_java_code [Bytecodes::number_of_codes]; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> Bytecodes::_flags [(<span class="hljs-number"><span class="hljs-number">1</span></span>&lt;&lt;BitsPerByte)*<span class="hljs-number"><span class="hljs-number">2</span></span>];</code> </pre> <br><p style=";text-align:right;direction:rtl">  هناك حاجة إلى هذه المعلمات أيضًا لإنشاء رمز قالب مترجم. </p><br><p style=";text-align:right;direction:rtl">  <strong>الثاني</strong> .  تهيئة رمز ذاكرة التخزين المؤقت </p><br><p style=";text-align:right;direction:rtl">  لإنشاء رمز لقوالب المترجمين الفوريين ، يجب عليك أولاً تخصيص ذاكرة لهذا العمل.  يتم تطبيق حجز الذاكرة لرمز ذاكرة التخزين المؤقت في وظيفة تحمل نفس الاسم <a href="">CodeCache :: initialize ()</a> .  كما يتبين من قسم الكود التالي لهذه الوظيفة </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"> CodeCacheExpansionSize = align_up(CodeCacheExpansionSize, os::vm_page_size()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (SegmentedCodeCache) { <span class="hljs-comment"><span class="hljs-comment">// Use multiple code heaps initialize_heaps(); } else { // Use a single code heap FLAG_SET_ERGO(uintx, NonNMethodCodeHeapSize, 0); FLAG_SET_ERGO(uintx, ProfiledCodeHeapSize, 0); FLAG_SET_ERGO(uintx, NonProfiledCodeHeapSize, 0); ReservedCodeSpace rs = reserve_heap_memory(ReservedCodeCacheSize); add_heap(rs, "CodeCache", CodeBlobType::All); }</span></span></code> </pre> <br><p style=";text-align:right;direction:rtl">  يتم التحكم رمز التخزين المؤقت بواسطة الخيارات <a href=""><code>-XX:ReservedCodeCacheSize</code></a> ، <a href=""><code>-XX:SegmentedCodeCache</code></a> ، <a href=""><code>-XX:CodeCacheExpansionSize</code></a> ، <a href=""><code>-XX:NonNMethodCodeHeapSize</code></a> ، <a href=""><code>-XX:ProfiledCodeHeapSize</code></a> <a href=""><code>-XX:NonProfiledCodeHeapSize</code></a> .  يمكن العثور على وصف موجز لهذه الخيارات على الروابط التي تؤدي إليها.  بالإضافة إلى سطر الأوامر ، يتم ضبط قيم بعض هذه الخيارات بشكل مريح ، على سبيل المثال ، إذا تم <code>SegmentedCodeCache</code> قيمة <code>SegmentedCodeCache</code> افتراضيًا (إيقاف) ، ثم مع حجم الرمز <code>&gt;= 240Mb</code> ، سيتم تضمين <code>SegmentedCodeCache</code> في <a href="">CompilerConfig :: set_tiered_flags</a> . </p><br><p style=";text-align:right;direction:rtl">  بعد إجراء عمليات التحقق ، يتم حجز مساحة بحجم <code>ReservedCodeCacheSize</code> بايت.  إذا تبين أن <code>SegmentedCodeCache</code> مكشوف ، فسيتم تقسيم هذه المنطقة إلى أجزاء: الأساليب المترجمة من JIT ، إجراءات الرعنة ، إلخ. </p><br><p style=";text-align:right;direction:rtl">  <strong>ثالثا</strong> .  تهيئة أنماط المترجم الفوري </p><br><p style=";text-align:right;direction:rtl">  بعد تهيئة جدول bytecode ورمز ذاكرة التخزين المؤقت ، يمكنك المتابعة إلى إنشاء التعليمات البرمجية لقوالب المترجم.  للقيام بذلك ، يحجز المترجم مخزن مؤقت من رمز ذاكرة التخزين المؤقت الذي تمت تهيئته مسبقًا.  في كل مرحلة من مراحل إنشاء الكود ، سيتم قطع <a href="">الكودلات</a> - المقاطع الصغيرة من الكود - من <a href="">المخزن المؤقت</a> .  بعد الانتهاء من الجيل الحالي ، يتم تحرير جزء الكودلت الذي لا يستخدمه الكود ويصبح متاحًا لأجيال الكود اللاحقة. </p><br><p style=";text-align:right;direction:rtl">  ضع في اعتبارك كل خطوة من هذه الخطوات بشكل فردي: </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  <a href="">slow_signature_handler</a> </li></ul><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"> { <span class="hljs-function"><span class="hljs-function">CodeletMark </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cm</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_masm, </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"slow signature handler"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; AbstractInterpreter::_slow_signature_handler = generate_slow_signature_handler(); }</code> </pre><br><p style=";text-align:right;direction:rtl">  يتم استخدام معالج التوقيع لإعداد الوسائط للمكالمات إلى الأساليب الأصلية.  في هذه الحالة ، يتم إنشاء معالج عام إذا كان الأسلوب الأصلي ، على سبيل المثال ، يحتوي على أكثر من 13 وسيطة (لم أقم بفحصها في مصحح الأخطاء ، لكن إذا حكمنا من خلال <a href="">الكود ،</a> يجب أن يكون الأمر هكذا) </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  <a href="">معالجة شفرة غير صالحة</a> </li></ul><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"> { <span class="hljs-function"><span class="hljs-function">CodeletMark </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cm</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_masm, </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"error exits"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; _unimplemented_bytecode = generate_error_exit(<span class="hljs-string"><span class="hljs-string">"unimplemented bytecode"</span></span>); _illegal_bytecode_sequence = generate_error_exit(<span class="hljs-string"><span class="hljs-string">"illegal bytecode sequence - method not verified"</span></span>); }</code> </pre> <br><p style=";text-align:right;direction:rtl">  يقوم VM بالتحقق من صحة classfiles أثناء التهيئة ، ولكن هذا في حالة أن الوسائط الموجودة في بنية تخزين العناصر ليست بالتنسيق المطلوب أو الرمز الفرعي الذي لا يعرفه VM.  يتم استخدام هذه الرهانات عند إنشاء رمز القالب لكل من الرموز الثانوية. </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  <a href="">العودة من وظيفة</a> </li></ul><br><p style=";text-align:right;direction:rtl">  بعد استدعاء الإجراءات ، من الضروري استعادة بيانات رصة الإطار ، والتي كانت قبل استدعاء الإجراء الذي تم إجراء الإرجاع منه. </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  <a href="">earlyret</a> </li></ul><br><p style=";text-align:right;direction:rtl">  تستخدم عند استدعاء وقت التشغيل من مترجم. </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl">  <a href="">استثناءات رمي</a> </p><br></li><li style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl">  <a href="">طريقة إدخال النقاط</a> </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> method_entry(kind) \ { CodeletMark cm(_masm, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"method entry point (kind = "</span></span></span><span class="hljs-meta"> #kind </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">")"</span></span></span><span class="hljs-meta">); \ Interpreter::_entry_table[Interpreter::kind] = generate_method_entry(Interpreter::kind); \ Interpreter::update_cds_entry_table(Interpreter::kind); \ }</span></span></code> </pre> <br><p style=";text-align:right;direction:rtl">  قدم على شكل ماكرو اعتمادا على نوع الطريقة.  في الحالة العامة ، يتم تنفيذ إعداد <a href="">إطار مكدس تفسير</a> ، والتحقق StackOverflow ، ضجيج المكدس.  للأساليب الأصلية ، يتم تعريف معالج التوقيع. </p><br></li><li style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl">  <a href="">Bytecode قالب الجيل</a> </p><br></li></ul><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"> <span class="hljs-comment"><span class="hljs-comment">// Bytecodes set_entry_points_for_all_bytes(); // installation of code in other places in the runtime // (ExcutableCodeManager calls not needed to copy the entries) set_safepoints_for_all_bytes();</span></span></code> </pre> <br><p style=";text-align:right;direction:rtl">  لتنفيذ التعليمات ، تتطلب مواصفات VM أن تكون المعامِلات في <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">حزمة المعامل</a> ، لكن هذا لا يمنع HotSpot من تخزينها مؤقتًا في السجل.  لتحديد الحالة الحالية لأعلى المكدس ، استخدم <a href="">التعداد</a> </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> TosState { <span class="hljs-comment"><span class="hljs-comment">// describes the tos cache contents btos = 0, // byte, bool tos cached ztos = 1, // byte, bool tos cached ctos = 2, // char tos cached stos = 3, // short tos cached itos = 4, // int tos cached ltos = 5, // long tos cached ftos = 6, // float tos cached dtos = 7, // double tos cached atos = 8, // object cached vtos = 9, // tos not cached number_of_states, ilgl // illegal state: should not occur };</span></span></code> </pre> <br><p style=";text-align:right;direction:rtl">  يعرّف كل تعليمي حالات المدخلات والمخرجات في <code>TosState</code> العلوي من المكدس <code>TosState</code> ، ويحدث إنشاء الأنماط وفقًا لهذه الحالة.  تتم تهيئة هذه القوالب في <a href="">جدول قالب</a> قابل للقراءة.  جزء من هذا الجدول كما يلي: </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// interpr. templates // Java spec bytecodes ubcp|disp|clvm|iswd in out generator argument def(Bytecodes::_nop , ____|____|____|____, vtos, vtos, nop , _ ); def(Bytecodes::_aconst_null , ____|____|____|____, vtos, atos, aconst_null , _ ); def(Bytecodes::_iconst_m1 , ____|____|____|____, vtos, itos, iconst , -1 ); def(Bytecodes::_iconst_0 , ____|____|____|____, vtos, itos, iconst , 0 ); def(Bytecodes::_iconst_1 , ____|____|____|____, vtos, itos, iconst , 1 ); def(Bytecodes::_iconst_2 , ____|____|____|____, vtos, itos, iconst , 2 ); def(Bytecodes::_iconst_3 , ____|____|____|____, vtos, itos, iconst , 3 ); def(Bytecodes::_iconst_4 , ____|____|____|____, vtos, itos, iconst , 4 ); def(Bytecodes::_iconst_5 , ____|____|____|____, vtos, itos, iconst , 5 ); def(Bytecodes::_lconst_0 , ____|____|____|____, vtos, ltos, lconst , 0 ); def(Bytecodes::_lconst_1 , ____|____|____|____, vtos, ltos, lconst , 1 ); def(Bytecodes::_fconst_0 , ____|____|____|____, vtos, ftos, fconst , 0 ); def(Bytecodes::_fconst_1 , ____|____|____|____, vtos, ftos, fconst , 1 ); def(Bytecodes::_fconst_2 , ____|____|____|____, vtos, ftos, fconst , 2 ); def(Bytecodes::_dconst_0 , ____|____|____|____, vtos, dtos, dconst , 0 ); def(Bytecodes::_dconst_1 , ____|____|____|____, vtos, dtos, dconst , 1 ); def(Bytecodes::_bipush , ubcp|____|____|____, vtos, itos, bipush , _ ); def(Bytecodes::_sipush , ubcp|____|____|____, vtos, itos, sipush , _ );</span></span></code> </pre> <br><p style=";text-align:right;direction:rtl">  سنهتم بشكل خاص بالأعمدة <code>generator</code> والخارجة والمولدة. </p><br><p style=";text-align:right;direction:rtl">  <code>in</code> - حالة الجزء العلوي من المكدس في وقت بدء التعليمات <br>  <code>out</code> - حالة الجزء العلوي من المكدس في وقت الانتهاء من التعليمات <br>  <code>generator</code> - مولد رمز التعليمات البرمجية الآلة </p><br><p style=";text-align:right;direction:rtl">  يمكن وصف طريقة العرض العامة للقالب لجميع الرموز الثانوية على النحو التالي: </p><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl">  إذا لم يتم تعيين بت إرسال للإرشادات ، يتم تنفيذ prolog التعليمات (no-op على x86) </p><br></li><li style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl">  باستخدام <code>generator</code> ، يتم إنشاء رمز الجهاز </p><br></li><li style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl">  إذا لم يتم تعيين بت إرسال للإرشادات ، يتم تنفيذ الانتقال إلى التعليمات التالية بالترتيب على حالة <code>out</code> من الجزء العلوي من المكدس ، والتي ستكون <code>in</code> التعليمات التالية </p><br></li></ol><br><p style=";text-align:right;direction:rtl">  يتم تخزين عنوان نقطة الإدخال للقالب الناتج في الجدول العمومي ويمكن استخدامه لتصحيح الأخطاء. </p><br><p style=";text-align:right;direction:rtl">  في HotSpot ، الجزء التالي من التعليمات البرمجية الغبي نسبياً هو المسؤول عن هذا: </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">مولد رمز التعليمات</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> TemplateInterpreterGenerator::set_entry_points(Bytecodes::Code code) { <span class="hljs-function"><span class="hljs-function">CodeletMark </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cm</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_masm, Bytecodes::name(code), code)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">// initialize entry points assert(_unimplemented_bytecode != NULL, "should have been generated before"); assert(_illegal_bytecode_sequence != NULL, "should have been generated before"); address bep = _illegal_bytecode_sequence; address zep = _illegal_bytecode_sequence; address cep = _illegal_bytecode_sequence; address sep = _illegal_bytecode_sequence; address aep = _illegal_bytecode_sequence; address iep = _illegal_bytecode_sequence; address lep = _illegal_bytecode_sequence; address fep = _illegal_bytecode_sequence; address dep = _illegal_bytecode_sequence; address vep = _unimplemented_bytecode; address wep = _unimplemented_bytecode; // code for short &amp; wide version of bytecode if (Bytecodes::is_defined(code)) { Template* t = TemplateTable::template_for(code); assert(t-&gt;is_valid(), "just checking"); set_short_entry_points(t, bep, cep, sep, aep, iep, lep, fep, dep, vep); } if (Bytecodes::wide_is_defined(code)) { Template* t = TemplateTable::template_for_wide(code); assert(t-&gt;is_valid(), "just checking"); set_wide_entry_point(t, wep); } // set entry points EntryPoint entry(bep, zep, cep, sep, aep, iep, lep, fep, dep, vep); Interpreter::_normal_table.set_entry(code, entry); Interpreter::_wentry_point[code] = wep; } //... void TemplateInterpreterGenerator::set_short_entry_points(Template* t, address&amp; bep, address&amp; cep, address&amp; sep, address&amp; aep, address&amp; iep, address&amp; lep, address&amp; fep, address&amp; dep, address&amp; vep) { assert(t-&gt;is_valid(), "template must exist"); switch (t-&gt;tos_in()) { case btos: case ztos: case ctos: case stos: ShouldNotReachHere(); // btos/ctos/stos should use itos. break; case atos: vep = __ pc(); __ pop(atos); aep = __ pc(); generate_and_dispatch(t); break; case itos: vep = __ pc(); __ pop(itos); iep = __ pc(); generate_and_dispatch(t); break; case ltos: vep = __ pc(); __ pop(ltos); lep = __ pc(); generate_and_dispatch(t); break; case ftos: vep = __ pc(); __ pop(ftos); fep = __ pc(); generate_and_dispatch(t); break; case dtos: vep = __ pc(); __ pop(dtos); dep = __ pc(); generate_and_dispatch(t); break; case vtos: set_vtos_entry_points(t, bep, cep, sep, aep, iep, lep, fep, dep, vep); break; default : ShouldNotReachHere(); break; } } //... void TemplateInterpreterGenerator::generate_and_dispatch(Template* t, TosState tos_out) { if (PrintBytecodeHistogram) histogram_bytecode(t); #ifndef PRODUCT // debugging code if (CountBytecodes || TraceBytecodes || StopInterpreterAt &gt; 0) count_bytecode(); if (PrintBytecodePairHistogram) histogram_bytecode_pair(t); if (TraceBytecodes) trace_bytecode(t); if (StopInterpreterAt &gt; 0) stop_interpreter_at(); __ verify_FPU(1, t-&gt;tos_in()); #endif // !PRODUCT int step = 0; if (!t-&gt;does_dispatch()) { step = t-&gt;is_wide() ? Bytecodes::wide_length_for(t-&gt;bytecode()) : Bytecodes::length_for(t-&gt;bytecode()); if (tos_out == ilgl) tos_out = t-&gt;tos_out(); // compute bytecode size assert(step &gt; 0, "just checkin'"); // setup stuff for dispatching next bytecode if (ProfileInterpreter &amp;&amp; VerifyDataPointer &amp;&amp; MethodData::bytecode_has_profile(t-&gt;bytecode())) { __ verify_method_data_pointer(); } __ dispatch_prolog(tos_out, step); } // generate template t-&gt;generate(_masm); // advance if (t-&gt;does_dispatch()) { #ifdef ASSERT // make sure execution doesn't go beyond this point if code is broken __ should_not_reach_here(); #endif // ASSERT } else { // dispatch to next bytecode __ dispatch_epilog(tos_out, step); } }</span></span></code> </pre> </div></div><br><p style=";text-align:right;direction:rtl">     ,     .         JVM.       Java-    .       <a href="">JavaCalls</a> .     JVM  ,     <a href="">  main</a> . </p><br><h4 id="primer" style=";text-align:right;direction:rtl">  مثال </h4><br><p style=";text-align:right;direction:rtl">  ,        ,     : </p><br><pre style=";text-align:right;direction:rtl"> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Sum</span></span></span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sum</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a + b; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Main</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String args[])</span></span></span></span>{ Sum.sum(<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>); } }</code> </pre> <br><p style=";text-align:right;direction:rtl">         <code>Sum.sum(II)</code> . </p><br><p style=";text-align:right;direction:rtl">   2  <code>javac -c *.java</code>    ,      . <br>  <code>Sum.sum</code> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs"> descriptor: (II)I flags: (0x0009) ACC_PUBLIC, ACC_STATIC Code: stack=2, locals=2, args_size=2 0: iload_0 1: iload_1 2: iadd 3: ireturn LineNumberTable: line 3: 0</code> </pre> <br><p style=";text-align:right;direction:rtl">  Main.main </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs"> descriptor: ([Ljava/lang/String;)V flags: (0x0009) ACC_PUBLIC, ACC_STATIC Code: stack=2, locals=1, args_size=1 0: iconst_2 1: iconst_3 2: invokestatic #2 // Method Sum.sum:(II)I 5: pop 6: return LineNumberTable: line 13: 0 line 14: 6</code> </pre> <br><p style=";text-align:right;direction:rtl">   ,          —      . </p><br><p style=";text-align:right;direction:rtl">   <code>invokestatic</code> '  x86   -   HotSpot    <a href=""></a> </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> TemplateTable::invokestatic(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> byte_no) { transition(vtos, vtos); assert(byte_no == f1_byte, <span class="hljs-string"><span class="hljs-string">"use this argument"</span></span>); prepare_invoke(byte_no, rbx); <span class="hljs-comment"><span class="hljs-comment">// get f1 Method* // do the call __ profile_call(rax); __ profile_arguments_type(rax, rbx, rbcp, false); __ jump_from_interpreted(rbx, rax); }</span></span></code> </pre> <br><p style=";text-align:right;direction:rtl"> <code>byte_no == f1_byte</code> —   <code>ConstantPoolCache</code> ,    , <code>rbx</code> — ,      <code>Method *</code> .      :  , ,      ( <code>method_entry</code>    ). </p><br><p style=";text-align:right;direction:rtl">   <code>prepare_invoke</code> .  ,     <code>invokestatic</code>    <code>ConstantPool</code>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><code>Constant_Methodref_Info</code></a> .   HotSpot    .  2      .. <a href=""><code>ConstantPoolCache</code></a> . <code>ConstantPoolCache</code>       ,    (,    <code>ConstantPoolCacheEntry</code>   ,      ).     <code>ConstantPoolCacheEntry</code> ,      (   0)        / .   ,         <code>ConstantPool</code> ,        <code>ConstantPoolCache</code>      ( x86 Little Endian). </p><br><p style=";text-align:right;direction:rtl"> , ,  HotSpot    <code>prepare_invoke</code> —     <code>ConstantPoolCache</code> .  ,   ,     <code>ConstantPoolCacheEntry</code>    </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"> __ get_cache_and_index_and_bytecode_at_bcp(Rcache, index, temp, byte_no, <span class="hljs-number"><span class="hljs-number">1</span></span>, index_size); __ cmpl(temp, code); <span class="hljs-comment"><span class="hljs-comment">// have we resolved this bytecode? __ jcc(Assembler::equal, resolved); // resolve first time through address entry = CAST_FROM_FN_PTR(address, InterpreterRuntime::resolve_from_cache); __ movl(temp, code); __ call_VM(noreg, entry, temp); // Update registers with resolved info __ get_cache_and_index_at_bcp(Rcache, index, 1, index_size); __ bind(resolved);</span></span></code> </pre> <br><p style=";text-align:right;direction:rtl">  ,    <code>InterpreterRuntime::resolve_from_cache</code> . </p><br><p style=";text-align:right;direction:rtl">       receiver'a   ,         .     (, ,  ,  <code>ConstantPoolCache</code>   <code>&lt;clinit&gt;</code> ,      ). <a href="">  </a>      define class,    <code>EagerInitialization</code> ( ,      ,           :)).     HotSpot   ( CDS  )     . </p><br><p style=";text-align:right;direction:rtl">  ,         ,   <code>ConstantPoolCacheEntry</code>    .      <code>Method *</code>  <code>rbx</code> ,   ,         . </p><br><p style=";text-align:right;direction:rtl">       <code>Sum.sum(2, 3)</code> .      gdb-script <code>sum.gdb</code> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">#    java file /home/dmitrii/jdk12/build/linux-x86_64-server-fastdebug/images/jdk/bin/java # gdb    SEGV' #,   https://hg.openjdk.java.net/jdk/jdk12/file/06222165c35f/src/hotspot/cpu/x86/vm_version_x86.cpp#l361 handle SIGSEGV nostop noprint #       set breakpoint pending on #    , #    set pagination off #      main b PostJVMInit commands #   , #    set $buffer = malloc(1000) #   . #jmp       # invokestatic b *AbstractInterpreter::_entry_table[0] thread 2 commands #     invokestatic, # Method*   rbx set $mthd = (Method *) $rbx #    $buffer call $mthd-&gt;name_and_sig_as_C_string($buffer, 1000) if strcmp()($buffer, "Sum.sum(II)I") == 0 #  iload_0,     b *TemplateInterpreter::_normal_table._table[vtos][26] thread 2 #  iload_1,   - int,  #  iload_0 b *TemplateInterpreter::_normal_table._table[itos][27] thread 2 #   iadd b *TemplateInterpreter::_normal_table._table[itos][96] thread 2 end c end c end r -cp . Main</code> </pre><br><p style=";text-align:right;direction:rtl">    <code>gdb -x sum.gdb</code> ,       <code>Sum.sum</code> </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">$453 = 0x7ffff7fdcdd0 "Sum.sum(II)I"</code> </pre> <br><p style=";text-align:right;direction:rtl">   <code>layout asm</code> ,    ,   <a href="">generate_normal_entry</a> .      -,  StackOverflow, stack-banging    dispatch    <code>iload_0</code>    .       : </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">0x7fffd828fa1f mov eax,DWORD PTR [r14] ;, iload_0 0x7fffd828fa22 movzx ebx,BYTE PTR [r13+0x1] ;   0x7fffd828fa27 inc r13 ; bcp (byte code pointer) 0x7fffd828fa2a movabs r10,0x7ffff717e8a0 ; DispatchTable 0x7fffd828fa34 jmp QWORD PTR [r10+rbx*8] ;jump     </code> </pre> <br><p style=";text-align:right;direction:rtl">        <code>rax</code> ,        </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">0x7fffd828fabe push rax ;     ;   ,      0x7fffd828fabf mov eax,DWORD PTR [r14-0x8] 0x7fffd828fac3 movzx ebx,BYTE PTR [r13+0x1] 0x7fffd828fac8 inc r13 0x7fffd828facb movabs r10,0x7ffff717e8a0 0x7fffd828fad5 jmp QWORD PTR [r10+rbx*8]</code> </pre> <br><p style=";text-align:right;direction:rtl">       <code>iadd</code> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">0x7fffd8292ba7 mov edx,DWORD PTR [rsp] ; ,     iload_1 0x7fffd8292baa add rsp,0x8 ; rsp    0x7fffd8292bae add eax,edx ;   0x7fffd8292bb0 movzx ebx,BYTE PTR [r13+0x1] 0x7fffd8292bb5 inc r13 0x7fffd8292bb8 movabs r10,0x7ffff717e8a0 0x7fffd8292bc2 jmp QWORD PTR [r10+rbx*8]</code> </pre> <br><p style=";text-align:right;direction:rtl">    <code>gdb</code>  <code>eax</code>  <code>edx</code>    ,    </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">(gdb) p $eax $457 = 3 (gdb) p $edx $458 = 2</code> </pre> <br><p style=";text-align:right;direction:rtl">       ,     <code>Sum.sum</code> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar469291/">https://habr.com/ru/post/ar469291/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar469271/index.html">إجراء تسلسل وإلغاء التسلسل. NET Core مقابل Go Data</a></li>
<li><a href="../ar469275/index.html">كما فعلت في 18 جامعة أمريكية</a></li>
<li><a href="../ar469277/index.html">من هم ديفوبس؟</a></li>
<li><a href="../ar469287/index.html">معركة Golems من البطاقات. كيف حولنا اللعبة إلى دوري بطاقات Parobot</a></li>
<li><a href="../ar469289/index.html">ما هو التداول بالهامش في البورصة وكيف يعمل؟</a></li>
<li><a href="../ar469295/index.html">"اكتشافات رجل الصوت": شجرة من الأنواع الموسيقية ، إكسيليفون من أحداث جيثب ، والبث الفضائي</a></li>
<li><a href="../ar469297/index.html">مؤتمرات الحديد. SOM i.MX6 ، Aliceduino ، Keras + STM32Cube.AI</a></li>
<li><a href="../ar469299/index.html">مشاهدة فورية ، لحظة ولا يمكن الوصول إليها</a></li>
<li><a href="../ar469301/index.html">أجيلين: العجاف + رشيق</a></li>
<li><a href="../ar469303/index.html">أندريه بيليف عن التفكير في جافا في اجتماع jug.msk.ru</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>