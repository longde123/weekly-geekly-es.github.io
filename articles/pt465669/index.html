<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèæ‚Äçüé§ üëºüèø üöé Contando a velocidade de download em seu aplicativo üòÄ üí• üê™</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Antecedentes 


 Eu tenho um projeto pequeno e acolhedor para animais de estima√ß√£o, que permite baixar arquivos da Internet. Os arquivos s√£o agrupados...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Contando a velocidade de download em seu aplicativo</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/465669/"><h2 id="predystoriya">  Antecedentes </h2><br><p>  Eu tenho um projeto pequeno e acolhedor para animais de estima√ß√£o, que permite baixar arquivos da Internet.  Os arquivos s√£o agrupados e o usu√°rio n√£o mostra cada arquivo, mas sim alguns agrupamentos.  E todo o processo de download (e a exibi√ß√£o desse processo) dependia muito dos dados.  Os dados foram obtidos em tempo real, ou seja,  o usu√°rio come√ßa a baixar e n√£o h√° informa√ß√µes sobre o quanto voc√™ precisa baixar na realidade. </p><br><p>  A implementa√ß√£o ing√™nua de pelo menos algum tipo de informa√ß√£o √© simplificada - o progresso do download √© exibido como a propor√ß√£o entre o n√∫mero de downloads e o n√∫mero total.  N√£o h√° muitas informa√ß√µes para o usu√°rio - apenas uma faixa rastejante, mas isso √© melhor que nada, e √© notavelmente melhor que o mecanismo de carregamento atualmente popular sem indicar progresso. </p><br><p>  E ent√£o um usu√°rio aparece com um problema l√≥gico - em um grupo grande, n√£o est√° claro por que o progresso est√° apenas se arrastando - eu preciso baixar muitos arquivos ou uma velocidade baixa?  Como mencionei acima - o n√∫mero de arquivos n√£o √© conhecido antecipadamente.  Por isso, decidi adicionar um contador de velocidade. </p><br><h2 id="analiz">  An√°lise </h2><br><p>  √â uma boa pr√°tica ver quem j√° resolveu um problema semelhante para n√£o reinventar a roda.  Um software diferente fecha essas tarefas diferentes, mas a tela parece praticamente a mesma: </p><br><div class="scrollable-table"><table><thead><tr><th>  uTorrent </th><th>  Downloadmaster </th></tr></thead><tbody><tr><td><img src="https://habrastorage.org/webt/gb/af/1o/gbaf1ooewqcrbnsuyafn1dyxzvk.png" alt="uTorrent"></td><td><img src="https://habrastorage.org/webt/qg/mc/fa/qgmcfangfeegvjjtkcy6w-vloxe.png" alt="Downloadmaster"></td></tr></tbody></table></div><br><p>  O ponto chave que identifiquei por mim mesmo √© que a primeira exibi√ß√£o de velocidade √© necess√°ria no momento atual.  N√£o qual velocidade era m√©dia, nem qual velocidade como um todo era m√©dia desde o momento em que come√ßou, ou seja, qual √© esse valor no momento atual.  De fato, isso √© importante quando eu chegar ao c√≥digo - explicarei separadamente. </p><br><p> Portanto, precisamos de um d√≠gito simples como <code>10 MB/s</code> ou algo assim.  Como calculamos isso? </p><a name="habracut"></a><br><h2 id="teoriya-i-praktika">  Teoria e Pr√°tica </h2><br><p>  A implementa√ß√£o de download existente usava o <code>HttpWebRequest</code> e eu decidi n√£o refazer o download em si - n√£o toque no mecanismo de trabalho. </p><br><p>  Portanto, a implementa√ß√£o inicial sem qualquer c√°lculo: </p><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> request = WebRequest.Create(uri); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> response = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> request.GetResponseAsync(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ms = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MemoryStream()) { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> response.GetResponseStream().CopyToAsync(ms); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ms.ToArray(); }</code> </pre> <br><p>  No n√≠vel dessa API, voc√™ s√≥ pode responder a um download completo de um arquivo; em pequenos grupos (ou mesmo em um √∫nico arquivo), n√£o √© poss√≠vel calcular a velocidade.  Seguimos o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">c√≥digo-</a> fonte <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">CopyToAsync</a> , copie e cole a l√≥gica simples a partir da√≠: </p><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] buffer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[bufferSize]; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> bytesRead; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ((bytesRead = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> ReadAsync(buffer, <span class="hljs-number"><span class="hljs-number">0</span></span>, buffer.Length, cancellationToken).ConfigureAwait(<span class="hljs-literal"><span class="hljs-literal">false</span></span>)) != <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> destination.WriteAsync(buffer, <span class="hljs-number"><span class="hljs-number">0</span></span>, bytesRead, cancellationToken).ConfigureAwait(<span class="hljs-literal"><span class="hljs-literal">false</span></span>); }</code> </pre> <br><p>  Agora podemos responder a todos os buffers que nos foram dados pela rede. </p><br><p>  Ent√£o, primeiro, o que fazemos em vez do CopyToAsync in a box: </p><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> Task&lt;<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[]&gt; GetBytesAsync(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> Stream <span class="hljs-keyword"><span class="hljs-keyword">from</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> memory = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MemoryStream()) { <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] buffer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[<span class="hljs-number"><span class="hljs-number">81920</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> bytesRead; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ((bytesRead = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span>.ReadAsync(buffer, <span class="hljs-number"><span class="hljs-number">0</span></span>, buffer.Length).ConfigureAwait(<span class="hljs-literal"><span class="hljs-literal">false</span></span>)) != <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> memory.WriteAsync(buffer, <span class="hljs-number"><span class="hljs-number">0</span></span>, bytesRead).ConfigureAwait(<span class="hljs-literal"><span class="hljs-literal">false</span></span>); NetworkSpeed.AddInfo(bytesRead); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> memory.ToArray(); } }</code> </pre> <br><p>  A √∫nica coisa realmente adicionada √© o <code>NetworkSpeed.AddInfo</code> .  E a √∫nica coisa que transmitimos √© o n√∫mero de bytes baixados. </p><br><p>  O c√≥digo em si para o download √© semelhante a este: </p><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> request = WebRequest.Create(uri); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> response = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> request.GetResponseAsync(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> array = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> response.GetResponseStream().GetBytesAsync();</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Op√ß√£o para WebClient</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> client = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WebClient(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lastRecorded = <span class="hljs-number"><span class="hljs-number">0L</span></span>; client.DownloadProgressChanged += (sender, eventArgs) =&gt; { NetworkSpeed.AddInfo(eventArgs.BytesReceived - lastRecorded); lastRecorded = eventArgs.BytesReceived; }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> array = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> client.DownloadDataTaskAsync(uri);</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Op√ß√£o para HttpClient</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> httpClient = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HttpClient(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> content = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> httpClient.GetStreamAsync(uri); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> array = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> content.GetBytesAsync();</code> </pre> </div></div><br><p>  Bem, metade do problema est√° resolvido - sabemos <em>o quanto</em> baixamos.  N√≥s nos voltamos para a velocidade. </p><br><p>  De acordo com a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">wikipedia</a> : </p><br><blockquote>  Taxa de transfer√™ncia de dados - a quantidade de dados transmitidos por unidade de tempo. </blockquote><br><h3 id="pervyy-naivnyy-podhod">  Primeira abordagem ing√™nua </h3><br><p>  N√≥s temos um volume.  O tempo pode ser gasto literalmente desde a inicializa√ß√£o e obtenha a diferen√ßa com o <code>DateTime.Now</code> .  Tirar e compartilhar? <br>  Para utilit√°rios de console como <strong>curl,</strong> isso √© poss√≠vel e faz sentido. <br>  Mas se o seu aplicativo for um pouco mais complicado, literalmente o bot√£o de pausa complicar√° drasticamente sua vida. </p><br><p>  <strong><em>Um pouco sobre a pausa</em></strong> <br>  Talvez eu seja muito ing√™nua, ou talvez a pergunta n√£o seja t√£o simples - mas a pausa me faz pensar constantemente.  Uma pausa durante o download pode se comportar de pelo menos tr√™s maneiras: </p><br><ul><li>  interromper o upload do arquivo, comece novamente depois </li><li>  apenas n√£o fa√ßa o download do arquivo, espere que o servidor continue ap√≥s </li><li>  baixar arquivos j√° iniciados, n√£o baixar novos, baixar novos depois </li></ul><br><p>  Como os dois primeiros levam √† perda de informa√ß√µes j√° baixadas, eu uso o terceiro. <br>  Um pouco mais alto, notei que a velocidade √© necess√°ria precisamente em um ponto no tempo.  Portanto, uma pausa complica este assunto: </p><br><ul><li>  voc√™ n√£o pode calcular corretamente qual era a velocidade m√©dia, apenas tomando o volume por um tempo </li><li>  Uma pausa pode ter motivos externos que alteram a velocidade e o canal (reconectando-se √† rede do provedor, alternando para VPN, encerrando o uTorrent que levou todo o canal), o que levar√° a uma altera√ß√£o na velocidade real <br>  De fato, uma pausa divide todos os indicadores em antes e depois dela.  Isso n√£o afeta particularmente o c√≥digo abaixo, apenas um minuto de informa√ß√µes divertidas para se pensar. </li></ul><br><h3 id="vtoroy-naivnyy-podhod">  Segunda abordagem ing√™nua </h3><br><p>  Adicione um cron√¥metro.  O temporizador a cada per√≠odo recolhe todas as informa√ß√µes mais recentes sobre o volume baixado e recalcula o indicador de velocidade.  E se voc√™ definir o cron√¥metro por segundo, todas as informa√ß√µes recebidas para este segundo sobre o volume baixado ser√£o iguais √† velocidade desse segundo: </p><br><div class="spoiler">  <b class="spoiler_title">Toda a implementa√ß√£o da classe NetworkSpeed</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">NetworkSpeed</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> TotalSpeed { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> totalSpeed; } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> totalSpeed = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> TimerInterval = <span class="hljs-number"><span class="hljs-number">1000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Timer speedTimer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Timer(state =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> now = <span class="hljs-number"><span class="hljs-number">0L</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (ReceivedStorage.TryDequeue(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> added)) now += added; totalSpeed = now; }, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, TimerInterval); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> ConcurrentQueue&lt;<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>&gt; ReceivedStorage = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConcurrentQueue&lt;<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>&gt;(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Clear</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (ReceivedStorage.TryDequeue(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> _)) { } totalSpeed = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddInfo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> received</span></span></span><span class="hljs-function">)</span></span> { ReceivedStorage.Enqueue(received); } }</code> </pre> </div></div><br><p>  Comparado com a primeira op√ß√£o, essa implementa√ß√£o come√ßa a responder a uma pausa - a velocidade cai para 0 no pr√≥ximo segundo ap√≥s a chegada dos dados externos. <br>  Mas tamb√©m existem desvantagens.  Estamos trabalhando com um buffer de 80kb, o que significa que o download iniciado em um segundo ser√° exibido apenas no pr√≥ximo.  E com um grande fluxo de downloads paralelos, esses erros de medi√ß√£o exibir√£o qualquer coisa - eu tive um spread de at√© 30% dos n√∫meros reais.  Eu poderia n√£o ter notado, mas exceder 100 Mbit parecia <em>muito suspeito</em> . </p><br><h3 id="tretiy-podhod">  Terceira abordagem </h3><br><p>  A segunda op√ß√£o j√° est√° pr√≥xima o suficiente da verdade, e seu erro foi observado mais no in√≠cio do download, e n√£o ao longo do ciclo de vida. <br>  Portanto, uma solu√ß√£o simples √© tomar como indicador, n√£o o valor por segundo, mas a m√©dia nos √∫ltimos tr√™s segundos.  Tr√™s aqui √© uma constante m√°gica combinada a olho.  Por um lado, queria uma exibi√ß√£o agrad√°vel do crescimento e decl√≠nio da velocidade, por outro - para que a velocidade estivesse mais pr√≥xima da verdade. </p><br><p>  A implementa√ß√£o √© um pouco complicada, mas, em geral, nada como isto: </p><br><div class="spoiler">  <b class="spoiler_title">Toda a implementa√ß√£o da classe NetworkSpeed</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">NetworkSpeed</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> TotalSpeed { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> totalSpeed; } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> totalSpeed = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> Seconds = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> TimerInterval = <span class="hljs-number"><span class="hljs-number">1000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Timer speedTimer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Timer(state =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> now = <span class="hljs-number"><span class="hljs-number">0L</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (ReceivedStorage.TryDequeue(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> added)) now += added; LastSpeeds.Enqueue(now); totalSpeed = LastSpeeds.Average(); OnUpdated(totalSpeed); }, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, TimerInterval); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> LimitedConcurrentQueue&lt;<span class="hljs-keyword"><span class="hljs-keyword">double</span></span>&gt; LastSpeeds = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LimitedConcurrentQueue&lt;<span class="hljs-keyword"><span class="hljs-keyword">double</span></span>&gt;(Seconds); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> ConcurrentQueue&lt;<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>&gt; ReceivedStorage = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConcurrentQueue&lt;<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>&gt;(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Clear</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (ReceivedStorage.TryDequeue(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> _)) { } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (LastSpeeds.TryDequeue(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> _)) { } totalSpeed = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddInfo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> received</span></span></span><span class="hljs-function">)</span></span> { ReceivedStorage.Enqueue(received); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> Action&lt;<span class="hljs-keyword"><span class="hljs-keyword">double</span></span>&gt; Updated; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">LimitedConcurrentQueue</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">ConcurrentQueue</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> Limit { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> new </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Enqueue</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T item</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (Count &gt;= Limit) TryDequeue(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> _); <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.Enqueue(item); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LimitedConcurrentQueue</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> limit</span></span></span><span class="hljs-function">)</span></span> { Limit = limit; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnUpdated</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> obj</span></span></span><span class="hljs-function">)</span></span> { Updated?.Invoke(obj); } }</code> </pre> </div></div><br><p>  Alguns pontos: </p><br><ul><li>  no momento da implementa√ß√£o, n√£o encontrei a fila finalizada com um limite no n√∫mero de elementos e a levei √† Internet, no c√≥digo acima √© <code>LimitedConcurrentQueue</code> . </li><li>  em vez de implementar <code>INotifyPropertyChanged</code> por algum motivo, <code>Action</code> , o uso √© praticamente o mesmo, n√£o me lembro dos motivos.  A l√≥gica √© simples - o indicador est√° mudando, os usu√°rios precisam ser notificados sobre isso.  A implementa√ß√£o pode ser qualquer, mesmo <code>IObservable</code> , para quem √© mais conveniente. </li></ul><br><h2 id="i-nemnogo-chitabelnosti">  E um pouco de legibilidade </h2><br><p>  A API fornece a velocidade em bytes, para facilitar a leitura, uma simples (usada na Internet) √© √∫til </p><br><div class="spoiler">  <b class="spoiler_title">conversor</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HumanizeByteSize</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> byteCount</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] suf = { <span class="hljs-string"><span class="hljs-string">"B"</span></span>, <span class="hljs-string"><span class="hljs-string">"KB"</span></span>, <span class="hljs-string"><span class="hljs-string">"MB"</span></span>, <span class="hljs-string"><span class="hljs-string">"GB"</span></span>, <span class="hljs-string"><span class="hljs-string">"TB"</span></span>, <span class="hljs-string"><span class="hljs-string">"PB"</span></span>, <span class="hljs-string"><span class="hljs-string">"EB"</span></span> }; <span class="hljs-comment"><span class="hljs-comment">//Longs run out around EB if (byteCount == 0) return "0" + suf[0]; long bytes = Math.Abs(byteCount); int place = Convert.ToInt32(Math.Floor(Math.Log(bytes, 1024))); double num = Math.Round(bytes / Math.Pow(1024, place), 1); return Math.Sign(byteCount) * num + suf[place]; } public static string HumanizeByteSize(this double byteCount) { if (double.IsNaN(byteCount) || double.IsInfinity(byteCount) || byteCount == 0) return string.Empty; return HumanizeByteSize((long)byteCount); }</span></span></code> </pre> </div></div><br><p>  Deixe-me lembr√°-lo de que a velocidade em bytes, ou seja,  por canal de 100 bits n√£o deve emitir mais de 12,5 MB. </p><br><p>  Como finalmente se parece: </p><br><div class="spoiler">  <b class="spoiler_title">Fa√ßa o download da imagem do ubuntu</b> <div class="spoiler_text"><blockquote>  Velocidade atual 904.5KB / s <br>  Velocidade atual 1.8MB / s <br>  Velocidade atual 2.9MB / s <br>  Velocidade atual 3.2MB / s <br>  Velocidade atual 2.9MB / s <br>  Velocidade atual 2.8MB / s <br>  Velocidade atual 3MB / s <br>  Velocidade atual 3.1MB / s <br>  Velocidade atual 3.2MB / s <br>  Velocidade atual 3.3MB / s <br>  Velocidade atual 3,5MB / s <br>  Velocidade atual 3.6MB / s <br>  Velocidade atual 3.6MB / s <br>  Velocidade atual 3.6MB / s <br>  ... </blockquote></div></div><br><div class="spoiler">  <b class="spoiler_title">Bem, v√°rias imagens de uma s√≥ vez</b> <div class="spoiler_text"><blockquote>  Velocidade atual 1,2MB / s <br>  Velocidade atual 3.8MB / s <br>  Velocidade atual 7.3MB / s <br>  Velocidade atual 10MB / s <br>  Velocidade atual 10.3MB / s <br>  Velocidade atual 10MB / s <br>  Velocidade atual 9.7MB / s <br>  Velocidade atual 9.8MB / s <br>  Velocidade atual 10.1MB / s <br>  Velocidade atual 9.8MB / s <br>  Velocidade atual 9.1MB / s <br>  Velocidade atual 8.6MB / s <br>  Velocidade atual 8.4MB / s <br>  ... </blockquote></div></div><br><h2 id="zaklyuchenie">  Conclus√£o </h2><br><p>  Foi interessante lidar com uma tarefa aparentemente banal de contar velocidade.  E mesmo que o c√≥digo funcione e d√™ alguns n√∫meros, quero ouvir os cr√≠ticos - o que perdi, como poderia fazer melhor, talvez existam algumas solu√ß√µes prontas. </p><br><p>  Quero agradecer ao <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Stack Overflow em russo</a> e especificamente ao <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">VladD-exrabbit</a> - embora exista metade da resposta em uma boa pergunta, qualquer dica e ajuda sempre o levam adiante. </p><br><p>  Quero lembr√°-lo de que este √© um projeto de estima√ß√£o - √© por isso que a classe √© est√°tica e uma, de modo que a precis√£o n√£o √© realmente.  Vejo muitas pequenas coisas que poderiam ser feitas melhor, mas ... sempre h√° mais algo a fazer, ent√£o, por enquanto, acho que √© a velocidade e acho que essa n√£o √© uma m√° op√ß√£o. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt465669/">https://habr.com/ru/post/pt465669/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt465657/index.html">A lei de Parkinson: voc√™ pode venc√™-la</a></li>
<li><a href="../pt465659/index.html">Resposta ao artigo ‚ÄúA conquista da Sib√©ria pelos moscovitas‚Äù ou vinte anos depois</a></li>
<li><a href="../pt465661/index.html">Voc√™ tamb√©m tem um amigo? Ou talvez seja voc√™?</a></li>
<li><a href="../pt465663/index.html">Perguntas frequentes sobre a API Superjob (publica√ß√£o de emprego)</a></li>
<li><a href="../pt465667/index.html">Spring Cache: da conex√£o do cache em 1 minuto √† configura√ß√£o flex√≠vel do gerenciador de cache</a></li>
<li><a href="../pt465673/index.html">Hedi Lamarr: inventor de Hollywood</a></li>
<li><a href="../pt465675/index.html">Como a NASA se preocupa com a seguran√ßa e a intelig√™ncia de seus astronautas</a></li>
<li><a href="../pt465677/index.html">Esque√ßa o Walkman: tudo sobre os fones de ouvido</a></li>
<li><a href="../pt465679/index.html">O que um rel√≥gio pode fazer al√©m de mostrar a hora e como escolher seu primeiro rel√≥gio</a></li>
<li><a href="../pt465681/index.html">Como o crepitar de um inc√™ndio, o rangido de portas e o ru√≠do mais comum tornam-se m√∫sica e caem em faixas eletroac√∫sticas</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>