<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🈁 🔕 💃🏾 Mencadangkan sejumlah besar proyek web heterogen 👸 💟 🧞</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Tampaknya topik sudah basi - banyak yang telah dikatakan dan ditulis tentang cadangan, jadi tidak ada yang menemukan kembali roda, ambil saja dan laku...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Mencadangkan sejumlah besar proyek web heterogen</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/nixys/blog/424717/"><p>  Tampaknya topik sudah basi - banyak yang telah dikatakan dan ditulis tentang cadangan, jadi tidak ada yang menemukan kembali roda, ambil saja dan lakukan.  Namun demikian, setiap kali ketika administrator sistem proyek web menghadapi tugas mengatur cadangan, bagi banyak orang menggantung di udara dengan tanda tanya besar.  Bagaimana cara mengumpulkan cadangan data dengan benar?  Di mana menyimpan cadangan?  Bagaimana cara menyediakan tingkat penyimpanan salinan retrospektif yang diperlukan?  Bagaimana cara menyatukan proses pencadangan untuk seluruh kebun binatang dari berbagai perangkat lunak? </p><br><p><img src="https://habrastorage.org/webt/xk/rn/7r/xkrn7rrnask1pgpv4uvrby6tnrc.jpeg"></p><a name="habracut"></a><br><p>  Bagi kami sendiri, kami pertama-tama memecahkan masalah ini pada 2011. Kemudian kami duduk dan menulis skrip cadangan kami.  Selama bertahun-tahun, kami hanya menggunakan mereka, dan mereka berhasil menyediakan proses yang andal untuk mengumpulkan dan menyinkronkan cadangan proyek web klien kami.  Cadangan disimpan di kami atau beberapa penyimpanan eksternal lainnya, dengan kemungkinan penyempurnaan untuk proyek tertentu. </p><br><p>  Saya harus mengatakan, skrip ini bekerja sepenuhnya.  Tetapi semakin jauh kami tumbuh, semakin kami memiliki beragam proyek dengan berbagai perangkat lunak dan repositori eksternal yang tidak didukung oleh skrip kami.  Misalnya, kami tidak memiliki dukungan untuk Redis dan cadangan MySQL dan PostgreSQL yang muncul kemudian.  Proses pencadangan tidak dipantau, hanya ada peringatan email. </p><br><p>  Masalah lain adalah proses dukungan.  Selama bertahun-tahun, skrip kami yang dulu kompak telah tumbuh dan berubah menjadi monster canggung yang besar.  Dan ketika kami berkumpul dan merilis versi baru, layak upaya terpisah untuk meluncurkan pembaruan untuk bagian dari pelanggan yang menggunakan versi sebelumnya dengan semacam penyesuaian. </p><br><p>  Akibatnya, pada awal tahun ini, kami membuat keputusan dengan tekad kuat: untuk mengganti skrip cadangan lama kami dengan sesuatu yang lebih modern.  Karena itu, pada awalnya kami duduk dan menulis semua Daftar Keinginan untuk solusi baru.  Ternyata kira-kira sebagai berikut: </p><br><ul><li>  Cadangkan data perangkat lunak yang paling sering digunakan: <br><ul><li>  File (menyalin diskrit dan inkremental) </li><li>  MySQL (cadangan dingin / panas) </li><li>  PostgreSQL (cadangan dingin / panas) </li><li>  Mongodb </li><li>  Redis </li></ul></li><li>  Simpan cadangan di repositori populer: <br><ul><li>  Lokal </li><li>  FTP </li><li>  Ssh </li><li>  SMB </li><li>  Nfs </li><li>  Webdav </li><li>  S3 </li></ul></li><li>  Terima peringatan jika ada masalah selama proses pencadangan </li><li>  Memiliki satu file konfigurasi yang memungkinkan Anda mengelola cadangan secara terpusat </li><li>  Tambahkan dukungan untuk perangkat lunak baru dengan menghubungkan modul eksternal </li><li>  Tentukan opsi tambahan untuk mengumpulkan dump </li><li>  Memiliki kemampuan untuk memulihkan cadangan dengan cara biasa </li><li>  Konfigurasi awal yang mudah </li></ul><br><h1 id="analiziruem-imeyuschiesya-resheniya">  Kami menganalisis solusi yang tersedia </h1><br><p>  Kami melihat solusi open-source yang sudah ada: </p><br><ul><li>  Bacula dan garpunya, misalnya, Bareos </li><li>  Amanda </li><li>  Borg </li><li>  Duplikat </li><li>  Duplicity </li><li>  Rsnapshot </li><li>  Cadangan tinggi </li></ul><br><p>  Tetapi masing-masing memiliki kelemahan.  Sebagai contoh, Bacula kelebihan beban dengan fungsi yang tidak kita butuhkan, konfigurasi awal adalah tugas yang agak melelahkan karena banyaknya pekerjaan manual (misalnya, untuk menulis / mencari skrip cadangan basis data), dan untuk mengembalikan salinan Anda perlu menggunakan utilitas khusus, dll. </p><br><p>  Pada akhirnya, kami sampai pada dua kesimpulan penting: </p><br><ol><li>  Tidak ada solusi yang ada yang sepenuhnya sesuai untuk kita; </li><li>  Tampaknya kita sendiri memiliki cukup pengalaman dan kegilaan untuk mulai menulis keputusan kita. </li></ol><br><p>  Jadi kami melakukannya. </p><br><h1 id="rozhdenie-nxs-backup">  Kelahiran nxs-backup </h1><br><p>  Python dipilih sebagai bahasa untuk implementasi - mudah untuk menulis dan memelihara, fleksibel dan nyaman.  Diputuskan untuk menggambarkan file konfigurasi dalam format yaml. </p><br><p>  Untuk kenyamanan mendukung dan menambahkan cadangan perangkat lunak baru, arsitektur modular dipilih di mana proses pengumpulan cadangan dari setiap perangkat lunak tertentu (misalnya, MySQL) dijelaskan dalam modul terpisah. </p><br><h2 id="podderzhka-faylov-bd-i-udalyonnyh-hranilisch">  Dukungan untuk file, database, dan penyimpanan jarak jauh </h2><br><p>  Saat ini, jenis cadangan file, database, dan repositori jarak jauh berikut ini didukung: </p><br><p>  DB: </p><br><ul><li>  MySQL (cadangan panas / dingin) </li><li>  PostgreSQL (cadangan panas / dingin) </li><li>  Redis </li><li>  Mongodb </li></ul><br><p>  File: </p><br><ul><li>  Penyalinan terpisah </li><li>  Penyalinan tambahan </li></ul><br><p>  Repositori jarak jauh: </p><br><ul><li>  Lokal </li><li>  S3 </li><li>  SMB </li><li>  Nfs </li><li>  FTP </li><li>  Ssh </li><li>  Webdav </li></ul><br><h2 id="diskretnoe-rezervnoe-kopirovanie">  Cadangan diskrit </h2><br><p>  Untuk tugas yang berbeda, baik cadangan diskrit atau inkremental cocok, oleh karena itu, mereka menerapkan kedua jenis ini.  Anda dapat menentukan metode mana yang digunakan pada tingkat file dan direktori individual. </p><br><p>  Untuk salinan diskrit (baik file dan database), Anda dapat mengatur retrospektif dalam format hari / minggu / bulan. </p><br><h2 id="inkrementnoe-rezervnoe-kopirovanie">  Cadangan tambahan </h2><br><p>  Salinan file tambahan dibuat sebagai berikut: <br><img src="https://habrastorage.org/webt/c7/wk/ss/c7wksse4j_mxjkgdffptngpglkw.jpeg"></p><br><p>  Pada awal tahun, cadangan penuh akan.  Selanjutnya, pada awal setiap bulan - salinan bulanan tambahan relatif terhadap salinan tahunan.  Dalam menstruasi - kenaikan decadal relatif terhadap bulanan.  Dalam setiap sepuluh hari tambahan siang hari relatif terhadap periode sepuluh hari. </p><br><p>  Perlu dicatat bahwa sementara ada beberapa masalah ketika bekerja dengan direktori yang mengandung banyak subdirektori (puluhan ribu).  Dalam kasus seperti itu, koleksi salinan diperlambat secara signifikan dan dapat memakan waktu lebih dari sehari.  Kami secara aktif menangani kekurangan ini. </p><br><h2 id="vosstanavlivaemsya-iz-inkrementnyh-bekapov">  Kami pulih dari cadangan inkremental </h2><br><p>  Tidak ada masalah dengan memulihkan dari cadangan diskrit - cukup ambil salinan untuk tanggal yang diperlukan dan gunakan dengan tar konsol biasa.  Salinan tambahan sedikit lebih rumit.  Untuk memulihkan, misalnya, pada 24 Juli 2018, Anda perlu melakukan yang berikut: </p><br><ol><li>  Perluas cadangan satu tahun, bahkan jika dalam kasus kami mulai dari 1 Januari 2018 (dalam praktiknya, ini bisa tanggal kapan saja, tergantung pada saat diputuskan untuk menerapkan cadangan tambahan) </li><li>  Gulung padanya cadangan bulanan untuk bulan Juli </li><li>  Gulung cadangan dekade 21 Juli </li><li>  Gulung cadangan harian untuk 24 Juli </li></ol><br><p>  Pada saat yang sama, untuk melakukan 2-4 poin, Anda harus menambahkan -G beralih ke perintah tar, dengan demikian menunjukkan bahwa ini adalah cadangan tambahan.  Tentu saja, ini bukan proses tercepat, tetapi ketika Anda menganggap bahwa tidak sering diperlukan untuk memulihkan dari cadangan dan efektivitas biaya itu penting, skema semacam itu cukup efektif. </p><br><h2 id="isklyucheniya">  Pengecualian </h2><br><p>  Seringkali, Anda perlu mengecualikan file atau direktori individual dari cadangan, misalnya, direktori dengan cache.  Ini dapat dilakukan dengan menentukan aturan pengecualian yang sesuai: </p><br><div class="spoiler">  <b class="spoiler_title">contoh file konfigurasi</b> <div class="spoiler_text"><pre><code class="hljs ruby">- <span class="hljs-symbol"><span class="hljs-symbol">target:</span></span> - <span class="hljs-regexp"><span class="hljs-regexp">/var/www</span></span><span class="hljs-regexp"><span class="hljs-regexp">/*/data</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ excludes: - exclude1/exclude</span></span>_file - exclude2 - <span class="hljs-regexp"><span class="hljs-regexp">/var/www</span></span><span class="hljs-regexp"><span class="hljs-regexp">/exclude_3</span></span></code> </pre> </div></div><br><h2 id="rotaciya-bekapov">  Rotasi cadangan </h2><br><p>  Dalam skrip lama kami, rotasi diimplementasikan sehingga salinan lama dihapus hanya setelah yang baru berhasil disusun.  Hal ini menyebabkan masalah pada proyek-proyek di mana ruang untuk cadangan, pada prinsipnya, dialokasikan tepat untuk satu salinan - salinan baru tidak dapat dikumpulkan di sana karena kurangnya ruang. </p><br><p>  Dalam implementasi baru, kami memutuskan untuk mengubah pendekatan ini: pertama-tama hapus yang lama dan baru kemudian kumpulkan salinan baru.  Dan proses pengumpulan cadangan harus dipantau untuk mencari tahu tentang masalah apa pun. </p><br><p>  Untuk cadangan diskrit, arsip dianggap sebagai salinan lama yang melampaui skema penyimpanan yang ditentukan dalam format hari / minggu / bulan.  Dalam hal cadangan inkremental, cadangan disimpan secara default selama satu tahun, dan salinan lama dihapus pada awal setiap bulan, sedangkan arsip untuk bulan yang sama tahun lalu dianggap sebagai cadangan lama.  Misalnya, sebelum mengumpulkan cadangan bulanan pada 1 Agustus 2018, sistem akan memeriksa apakah ada cadangan untuk Agustus 2017, dan jika demikian, itu akan menghapusnya.  Ini memungkinkan penggunaan ruang disk yang optimal. </p><br><h2 id="logirovanie">  Penebangan </h2><br><p>  Dalam proses apa pun, dan terutama dalam pencadangan, penting untuk mengikuti dan mengetahui apakah ada kesalahan.  Sistem menyimpan log pekerjaannya dan menangkap hasil dari setiap langkah: mulai / hentikan dana, mulai / berakhirnya tugas tertentu, hasil pengumpulan salinan dalam direktori sementara, hasil menyalin / memindahkan salinan dari direktori sementara ke lokasi permanen, hasil rotasi cadangan, dll. .. </p><br><p>  Acara dibagi menjadi 2 level: </p><br><ul><li>  <em>Info</em> : tingkat informasi - penerbangan normal, tahap berikutnya selesai dengan sukses, entri informasi yang sesuai dibuat dalam log </li><li>  <em>Kesalahan</em> : tingkat kesalahan - ada yang salah, tahap berikutnya gagal, catatan kesalahan yang sesuai dibuat di log </li></ul><br><h2 id="e-mail-notifikacii">  Pemberitahuan Email </h2><br><p>  Di akhir pengumpulan cadangan, sistem dapat mengirim pemberitahuan email. </p><br><p>  2 daftar penerima didukung: </p><br><ul><li>  <em>Administrator</em> adalah mereka yang melayani server.  Mereka hanya menerima pemberitahuan kesalahan, mereka tidak tertarik dengan pemberitahuan operasi yang berhasil </li><li>  <em>Pengguna bisnis</em> - dalam kasus kami, ini adalah pelanggan yang terkadang ingin menerima pemberitahuan untuk memastikan bahwa semuanya baik-baik saja dengan cadangan.  Atau, sebaliknya, tidak juga.  Mereka dapat memilih apakah akan menerima log lengkap atau hanya log dengan kesalahan. </li></ul><br><h2 id="struktura-konfiguracionnyh-faylov">  Struktur file konfigurasi </h2><br><p>  Struktur file konfigurasi adalah sebagai berikut: </p><br><div class="spoiler">  <b class="spoiler_title">contoh struktur</b> <div class="spoiler_text"><pre> <code class="bash hljs">/etc/nxs-backup ├── conf.d │ ├── desc_files_local.conf │ ├── external_clickhouse_local.conf │ ├── inc_files_smb.conf │ ├── mongodb_nfs.conf │ ├── mysql_s3.conf │ ├── mysql_xtradb_scp.conf │ ├── postgresql_ftp.conf │ ├── postgresql_hot_webdav.conf │ └── redis_local_ftp.conf └── nxs-backup.conf</code> </pre> </div></div><br><p>  Di sini <em>/etc/nxs-backup/nxs-backup.conf</em> adalah file konfigurasi utama di mana pengaturan global ditunjukkan: </p><br><div class="spoiler">  <b class="spoiler_title">file konfigurasi</b> <div class="spoiler_text"><pre> <code class="hljs sql">main: server_name: SERVER_NAME admin_mail: project-tech@nixys.ru client_mail: - '' mail_from: <span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>@domain.ru level_message: <span class="hljs-keyword"><span class="hljs-keyword">error</span></span> block_io_read: <span class="hljs-string"><span class="hljs-string">''</span></span> block_io_write: <span class="hljs-string"><span class="hljs-string">''</span></span> blkio_weight: <span class="hljs-string"><span class="hljs-string">''</span></span> general_path_to_all_tmp_dir: /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span> cpu_shares: <span class="hljs-string"><span class="hljs-string">''</span></span> log_file_name: /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/nxs-backup.log jobs: !<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> [conf.d<span class="hljs-comment"><span class="hljs-comment">/*.conf]</span></span></code> </pre> </div></div><br><p>  Array tugas (pekerjaan) berisi daftar tugas (pekerjaan), yang merupakan deskripsi tentang apa yang harus dicadangkan, tempat menyimpan, dan dalam jumlah berapa.  Sebagai aturan, mereka dipindahkan ke file yang terpisah (satu file per pekerjaan), yang terhubung melalui sertakan dalam file konfigurasi utama. </p><br><p>  Mereka juga berusaha mengoptimalkan proses mempersiapkan file-file ini sebanyak mungkin dan menulis generator sederhana.  Oleh karena itu, administrator tidak perlu menghabiskan waktu mencari templat konfigurasi untuk beberapa layanan, misalnya, MySQL, tetapi cukup jalankan perintah: </p><br><pre> <code class="bash hljs">nxs-backup generate --storage <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> scp --<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> mysql --path /etc/nxs-backup/conf.d/mysql_local_scp.conf</code> </pre> <br><p>  Keluaran menghasilkan file <em>/etc/nxs-backup/conf.d/mysql_local_scp.conf</em> : </p><br><div class="spoiler">  <b class="spoiler_title">Isi file</b> <div class="spoiler_text"><pre> <code class="hljs sql"> - job: PROJECT-mysql type: mysql tmp_dir: /var/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">databases</span></span>/mysql/dump_tmp sources: - <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>: db_host: <span class="hljs-string"><span class="hljs-string">''</span></span> db_port: <span class="hljs-string"><span class="hljs-string">''</span></span> socket: <span class="hljs-string"><span class="hljs-string">''</span></span> db_user: <span class="hljs-string"><span class="hljs-string">''</span></span> db_password: <span class="hljs-string"><span class="hljs-string">''</span></span> auth_file: <span class="hljs-string"><span class="hljs-string">''</span></span> target: - all excludes: - information_schema - performance_schema - mysql - <span class="hljs-keyword"><span class="hljs-keyword">sys</span></span> gzip: <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> is_slave: <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> extra_keys: <span class="hljs-string"><span class="hljs-string">'--opt --add-drop-database --routines --comments --create-options --quote-names --order-by-primary --hex-blob'</span></span> storages: - <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span>: yes backup_dir: /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">databases</span></span>/mysql/dump <span class="hljs-keyword"><span class="hljs-keyword">store</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">days</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span> weeks: <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">month</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span> - <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>: scp <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span>: yes backup_dir: /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">databases</span></span>/mysql/dump <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span> host: <span class="hljs-string"><span class="hljs-string">''</span></span> port: <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span> path_to_key: <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">store</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">days</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span> weeks: <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">month</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span></code> </pre> </div></div><br><p>  Di mana itu tetap hanya untuk menggantikan beberapa nilai yang diperlukan. </p><br><p>  Mari kita ambil contoh.  Misalkan pada server kami di direktori / var / www ada dua situs dari toko online 1C-Bitrix (bitrix-1.ru, bitrix-2.ru), yang masing-masing berfungsi dengan basis datanya sendiri dalam berbagai instance MySQL (port 3306 untuk bitrix_1_db dan 3307 port untuk bitrix_2_db). </p><br><p>  Struktur file dari proyek Bitrix pada umumnya kira-kira sebagai berikut: </p><br><pre> <code class="bash hljs">├── ... ├── bitrix │ ├── .. │ ├── admin │ ├── backup │ ├── cache │ ├── .. │ ├── managed_cache │ ├── .. │ ├── stack_cache │ └── .. ├── upload └── ...</code> </pre> <br><p>  Sebagai aturan, direktori <em>unggah sangat</em> berbobot, dan hanya bertambah seiring waktu, sehingga akan didukung secara bertahap.  Semua direktori lain bersifat diskrit, dengan pengecualian direktori dengan cache dan cadangan yang dikumpulkan oleh alat Bitrix asli.  Biarkan skema penyimpanan cadangan untuk kedua situs ini harus sama, sedangkan salinan file harus disimpan secara lokal dan pada penyimpanan ftp jarak jauh, dan basis data harus disimpan hanya pada penyimpanan jarak jauh seseorang. </p><br><p>  File konfigurasi yang dihasilkan untuk pengaturan seperti itu akan terlihat seperti ini: </p><br><div class="spoiler">  <b class="spoiler_title">bitrix-desc-files.conf (file konfigurasi dengan deskripsi tugas untuk cadangan diskrit)</b> <div class="spoiler_text"><pre> <code class="hljs powershell"> - job: Bitrix<span class="hljs-literal"><span class="hljs-literal">-desc</span></span><span class="hljs-literal"><span class="hljs-literal">-files</span></span> type: desc_files tmp_dir: /var/nxs<span class="hljs-literal"><span class="hljs-literal">-backup</span></span>/files/desc/dump_tmp sources: - target: - /var/www/*/ excludes: - bitrix/backup - bitrix/cache - bitrix/managed_cache - bitrix/stack_cache - upload gzip: yes storages: - storage: local enable: yes backup_dir: /var/nxs<span class="hljs-literal"><span class="hljs-literal">-backup</span></span>/files/desc/dump store: days: <span class="hljs-number"><span class="hljs-number">6</span></span> weeks: <span class="hljs-number"><span class="hljs-number">4</span></span> month: <span class="hljs-number"><span class="hljs-number">6</span></span> - storage: ftp enable: yes backup_dir: /nxs<span class="hljs-literal"><span class="hljs-literal">-backup</span></span>/databases/mysql/dump host: ftp_host user: ftp_usr password: ftp_usr_pass store: days: <span class="hljs-number"><span class="hljs-number">6</span></span> weeks: <span class="hljs-number"><span class="hljs-number">4</span></span> month: <span class="hljs-number"><span class="hljs-number">6</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">bitrix-inc-files.conf (file konfigurasi dengan deskripsi tugas untuk cadangan tambahan)</b> <div class="spoiler_text"><pre> <code class="hljs coffeescript"> - job: Bitrix-inc-files type: inc_files sources: - target: - <span class="hljs-regexp"><span class="hljs-regexp">/var/www/</span></span>*<span class="hljs-regexp"><span class="hljs-regexp">/upload/</span></span> gzip: <span class="hljs-literal"><span class="hljs-literal">yes</span></span> storages: - storage: ftp enable: <span class="hljs-literal"><span class="hljs-literal">yes</span></span> backup_dir: /nxs-backup/files/inc host: ftp_host user: ftp_usr password: ftp_usr_pass - storage: local enable: <span class="hljs-literal"><span class="hljs-literal">yes</span></span> backup_dir: /var/nxs-backup/files/inc</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">bitrix-mysql.conf (file konfigurasi dengan deskripsi tugas untuk backup MySQL)</b> <div class="spoiler_text"><pre> <code class="hljs sql"> - job: Bitrix-mysql type: mysql tmp_dir: /var/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">databases</span></span>/mysql/dump_tmp sources: - <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>: db_host: localhost db_port: <span class="hljs-number"><span class="hljs-number">3306</span></span> db_user: bitrux_usr_1 db_password: password_1 target: - bitrix_1_db excludes: - information_schema - performance_schema - mysql - <span class="hljs-keyword"><span class="hljs-keyword">sys</span></span> gzip: <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> is_slave: <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> extra_keys: <span class="hljs-string"><span class="hljs-string">'--opt --add-drop-database --routines --comments --create-options --quote-names --order-by-primary --hex-blob'</span></span> - <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>: db_host: localhost db_port: <span class="hljs-number"><span class="hljs-number">3307</span></span> db_user: bitrix_usr_2 db_password: password_2 target: - bitrix_2_db excludes: - information_schema - performance_schema - mysql - <span class="hljs-keyword"><span class="hljs-keyword">sys</span></span> gzip: yes is_slave: <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> extra_keys: <span class="hljs-string"><span class="hljs-string">'--opt --add-drop-database --routines --comments --create-options --quote-names --order-by-primary --hex-blob'</span></span> storages: - <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>: smb <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span>: yes backup_dir: /nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">databases</span></span>/mysql/dump host: smb_host port: smb_port <span class="hljs-keyword"><span class="hljs-keyword">share</span></span>: smb_share_name <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: smb_usr <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>: smb_usr_pass <span class="hljs-keyword"><span class="hljs-keyword">store</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">days</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span> weeks: <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">month</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span></code> </pre> </div></div><br><h2 id="parametry-dlya-zapuska-sbora-bekapov">  Opsi untuk mulai mengumpulkan cadangan </h2><br><p>  Dalam contoh sebelumnya, kami menyiapkan file konfigurasi pekerjaan untuk mengumpulkan cadangan semua elemen sekaligus: file (diskrit dan inkremental), dua database dan menyimpannya di penyimpanan lokal dan eksternal (ftp, smb). </p><br><p>  Masih menjalankan semuanya.  Peluncuran dilakukan dengan perintah: </p><br><pre> <code class="bash hljs">nxs-backup start <span class="hljs-variable"><span class="hljs-variable">$JOB_NAME</span></span> -c <span class="hljs-variable"><span class="hljs-variable">$PATH_TO_MAIN_CONFIG</span></span></code> </pre> <br><p>  Ada beberapa nama pekerjaan yang dipesan: </p><br><ul><li>  <strong>file</strong> - eksekusi sembarang dari semua <em>pekerjaan</em> dengan tipe <em>desc_files</em> , <em>inc_files</em> (yaitu, pada dasarnya, hanya file yang <em>didukung</em> ) </li><li>  <strong>database</strong> - mengeksekusi semua pekerjaan secara acak dengan tipe <em>mysql</em> , <em>mysql_xtradb</em> , <em>postgresql</em> , <em>postgresql_hot</em> , <em>mongodb</em> , <em>redis</em> (yaitu, cadangan hanya database) </li><li>  <strong>eksternal</strong> - mengeksekusi semua pekerjaan secara acak dengan tipe <em>eksternal</em> (hanya menjalankan skrip khusus tambahan, lebih lanjut tentang ini di bawah) </li><li>  <strong>semua</strong> - meniru menjalankan perintah satu per satu dengan <em>file</em> pekerjaan, <em>database</em> , <em>eksternal</em> (nilai default) </li></ul><br><p>  Karena kita perlu mendapatkan backup data dari kedua file dan database pada saat yang sama (atau dengan perbedaan minimum) pada output, disarankan untuk menjalankan backup-nxs dengan pekerjaan <strong>semua</strong> , yang akan memastikan eksekusi yang konsisten dari pekerjaan yang dijelaskan (Bitrix-desc- file, Bitrix-inc_files, Bitrix-mysql). </p><br><p>  Artinya, poin penting - cadangan tidak akan dikumpulkan secara paralel, tetapi secara berurutan, satu demi satu, dengan perbedaan waktu minimum.  Selain itu, pada awal berikutnya, perangkat lunak itu sendiri memeriksa proses yang sudah berjalan dalam sistem dan jika terdeteksi, ia akan secara otomatis mengakhiri kerjanya dengan tanda yang sesuai di log.  Pendekatan ini secara signifikan mengurangi beban pada sistem.  Minus - cadangan elemen individu dikumpulkan tidak sekaligus, tetapi dengan beberapa perbedaan waktu.  Tetapi sementara latihan kami menunjukkan bahwa ini tidak kritis. </p><br><h2 id="vneshnie-moduli">  Modul eksternal </h2><br><p>  Sebagaimana disebutkan di atas, berkat arsitektur modular, kemampuan sistem dapat diperluas menggunakan modul pengguna tambahan yang berinteraksi dengan sistem melalui antarmuka khusus.  Tujuannya adalah agar di masa depan dapat menambahkan dukungan untuk cadangan perangkat lunak baru tanpa perlu menulis ulang cadangan-nxs. </p><br><div class="spoiler">  <b class="spoiler_title">contoh file konfigurasi</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"> - job: TEST-<span class="hljs-keyword"><span class="hljs-keyword">external</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">external</span></span> dump_cmd: <span class="hljs-string"><span class="hljs-string">''</span></span> storages: ….</code> </pre> </div></div><br><p>  Perhatian khusus harus diberikan pada kunci <strong>dump_cmd</strong> , di mana nilainya adalah perintah penuh untuk menjalankan skrip eksternal.  Selain itu, setelah menyelesaikan perintah ini, diharapkan bahwa: </p><br><ul><li>  Arsip data perangkat lunak yang sudah jadi akan dikumpulkan </li><li>  Data akan dikirim ke stdout dalam format json, dari bentuk: <br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"full_path"</span></span>: <span class="hljs-string"><span class="hljs-string">"ABS_PATH_TO_ARCHIVE"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"basename"</span></span>: <span class="hljs-string"><span class="hljs-string">"BASENAME_ARCHIVE"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"extension"</span></span>: <span class="hljs-string"><span class="hljs-string">"EXTERNSION_OF_ARCHIVE"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"gzip"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>/<span class="hljs-literal"><span class="hljs-literal">false</span></span> }</code> </pre> <br><ul><li>  Dalam hal ini, nama kunci, <em>ekstensi</em> , <em>gzip</em> diperlukan secara eksklusif untuk pembentukan nama cadangan akhir. </li></ul></li><li>  Jika naskah berhasil diselesaikan, kode pengembalian harus 0 dan yang lainnya jika ada masalah. </li></ul><br><p>  Sebagai contoh, misalkan kita memiliki skrip untuk membuat snapshot, etcd <em>/etc/nxs-backup-ext/etcd.py</em> : </p><br><div class="spoiler">  <b class="spoiler_title">kode skrip</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#! /usr/bin/env python3 # -*- coding: utf-8 -*- import json import os import subprocess import sys import tarfile def archive(snapshot_path): abs_tmp_path = '%s.tar' %(snapshot_path) with tarfile.open(abs_tmp_path, 'w:') as tar: tar.add(snapshot_path) os.unlink(snapshot_path) return abs_tmp_path def exec_cmd(cmdline): data_dict = {} current_process = subprocess.Popen([cmdline], stdout=subprocess.PIPE, stderr=subprocess.PIPE, shell=True, executable='/bin/bash') data = current_process.communicate() data_dict['stdout'] = data[0][0:-1].decode('utf-8') data_dict['stderr'] = data[1][0:-1].decode('utf-8') data_dict['code'] = current_process.returncode return data_dict def main(): snapshot_path = "/var/backups/snapshot.db" dump_cmd = "ETCDCTL_API=3 etcdctl --cacert=/etc/ssl/etcd/ssl/ca.pem --cert=/etc/ssl/etcd/ssl/member-node1.pem"+\ " --key=/etc/ssl/etcd/ssl/member-node1-key.pem --endpoints 'https://127.0.0.1:2379' snapshot save %s" %snapshot_path command = exec_cmd(dump_cmd) result_code = command['code'] if result_code: sys.stderr.write(command['stderr']) else: try: new_path = archive(snapshot_path) except tarfile.TarError as e: sys.exit(1) else: result_dict = { "full_path": new_path, "basename": "etcd", "extension": "tar", "gzip": False } print(json.dumps(result_dict)) sys.exit(result_code) if __name__ == '__main__': main()</span></span></code> </pre> </div></div><br><p>  Konfigurasi untuk menjalankan skrip ini adalah sebagai berikut: </p><br><div class="spoiler">  <b class="spoiler_title">file konfigurasi</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"> - job: etcd-<span class="hljs-keyword"><span class="hljs-keyword">external</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">external</span></span> dump_cmd: <span class="hljs-string"><span class="hljs-string">'/etc/nxs-backup-ext/etcd.py'</span></span> storages: - <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span>: yes backup_dir: /var/nxs-backup/<span class="hljs-keyword"><span class="hljs-keyword">external</span></span>/dump store: days: <span class="hljs-number"><span class="hljs-number">6</span></span> weeks: <span class="hljs-number"><span class="hljs-number">4</span></span> month: <span class="hljs-number"><span class="hljs-number">6</span></span></code> </pre> </div></div><br><p>  Dalam hal ini, program saat menjalankan pekerjaan <em>etcd-external</em> : </p><br><ul><li>  Jalankan script <em>/etc/nxs-backup-ext/etcd.py</em> tanpa parameter </li><li>  Setelah skrip selesai, ia akan memeriksa kode penyelesaian dan ketersediaan data yang diperlukan di stdout </li><li>  Jika semua pemeriksaan berhasil, maka mekanisme yang sama digunakan seperti dengan modul yang sudah terpasang, di mana nilai kunci full_path digunakan sebagai tmp_path.  Jika tidak, itu akan menyelesaikan tugas ini dengan tanda yang sesuai di log. </li></ul><br><h1 id="podderzhka-i-obnovlenie">  Dukungan dan pembaruan </h1><br><p>  Proses mengembangkan dan mendukung sistem cadangan baru telah dilaksanakan dengan semua kanon CI / CD.  Tidak ada lagi pembaruan dan suntingan skrip di server pertempuran.  Semua perubahan melewati repositori central git kami di Gitlab, tempat perakitan versi baru paket deb / rpm terdaftar dalam pipa, yang kemudian diunggah ke repositori deb / rpm kami.  Dan setelah itu, melalui manajer paket, mereka dikirim ke server klien akhir. </p><br><h1 id="kak-skachat-nxs-backup">  Bagaimana cara mengunduh nxs-backup? </h1><br><p>  Kami membuat proyek open-source nxs-backup.  Siapa pun dapat mengunduh dan menggunakannya untuk mengatur proses pencadangan dalam proyek mereka, serta memodifikasi kebutuhan mereka, menulis modul eksternal. </p><br><p>  Kode sumber untuk cadangan-nxs dapat diunduh dari repositori Github <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">di tautan ini</a> .  Ada juga petunjuk instalasi dan konfigurasi. </p><br><p>  Kami juga menyiapkan gambar Docker dan mempostingnya di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">DockerHub</a> . </p><br><p>  Jika Anda memiliki pertanyaan selama proses pengaturan atau penggunaan, tuliskan kepada kami.  Kami akan membantu untuk memahami dan menyelesaikan instruksi. </p><br><h1 id="zaklyuchenie">  Kesimpulan </h1><br><p>  Dalam waktu dekat, kami akan menerapkan fungsi berikut: </p><br><ul><li>  Memantau integrasi </li><li>  Enkripsi cadangan </li><li>  Antarmuka berbasis web untuk mengelola pengaturan cadangan </li><li>  Menyebarkan cadangan menggunakan nxs-cadangan </li><li>  Dan masih banyak lagi </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id424717/">https://habr.com/ru/post/id424717/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id424701/index.html">Cerita-cerita TI fiksi tentang penipu dan mengapa praktik-praktik tidak jelas ini muncul saat wawancara</a></li>
<li><a href="../id424703/index.html">Dan lagi tentang depersonalisasi</a></li>
<li><a href="../id424709/index.html">Karya konstruksi kolom dunia: 225 W RMS untuk 28.000 rubel</a></li>
<li><a href="../id424711/index.html">Dari hidrogel ke usus babi: bahan yang tidak biasa dalam robotika</a></li>
<li><a href="../id424713/index.html">Seluruh kebenaran tentang RTOS. Artikel # 12. Layanan untuk bekerja dengan tugas</a></li>
<li><a href="../id424723/index.html">Webinar Skillbox Friday: Berguna untuk Pemula dan Lainnya</a></li>
<li><a href="../id424725/index.html">Tentang Oracle JDK 11+ (lisensi dan distribusi)</a></li>
<li><a href="../id424729/index.html">Mengapa kompiler mengubah loop kondisional saya menjadi tak terbatas?</a></li>
<li><a href="../id424731/index.html">Riwayat dukungan teknis, atau Mengapa AutoCAD menghapus objek proxy?</a></li>
<li><a href="../id424733/index.html">Pil biru STM32F103 sebagai PLC</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>