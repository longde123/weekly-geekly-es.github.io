<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧚🏻 🚴🏿 🔳 Annotations de printemps: AOP Magic ☝️ 👨‍👩‍👧 🥟</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="La connaissance sacrée du fonctionnement des annotations n'est pas accessible à tous. Il semble que ce soit une sorte de magie: je mets un sort avec u...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Annotations de printemps: AOP Magic</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/439594/">  La connaissance sacrée du fonctionnement des annotations n'est pas accessible à tous.  Il semble que ce soit une sorte de magie: je mets un sort avec un chien sur la méthode / le champ / la classe - et l'élément commence à changer ses propriétés et à en obtenir de nouvelles. <br><br><img src="https://habrastorage.org/webt/ew/-m/tw/ew-mtwk_cr7xgt37h_0w4we9rmq.jpeg" alt="image"><br><br>  Aujourd'hui, nous allons apprendre la magie des annotations en utilisant Spring Annotations comme exemple: initialiser des champs de haricots. <a name="habracut"></a><br><br>  Comme d'habitude, à la fin de l'article, il y a un lien vers le projet sur GitHub, qui peut être téléchargé et voir comment tout fonctionne. <br><br>  Dans un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article</a> précédent <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">,</a> j'ai décrit le fonctionnement de la bibliothèque ModelMapper, qui vous permet de convertir une entité et un DTO l'un dans l'autre.  Nous maîtriserons le travail des annotations sur l'exemple de ce mappeur. <br><br>  Dans le projet, nous avons besoin de quelques entités liées et DTO.  Je donnerai sélectivement une paire. <br><br><div class="spoiler">  <b class="spoiler_title">Planète</b> <div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Entity</span></span> <span class="hljs-meta"><span class="hljs-meta">@Table</span></span>(name = <span class="hljs-string"><span class="hljs-string">"planets"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@EqualsAndHashCode</span></span>(callSuper = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Setter</span></span> <span class="hljs-meta"><span class="hljs-meta">@AllArgsConstructor</span></span> <span class="hljs-meta"><span class="hljs-meta">@NoArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Planet</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractEntity</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String name; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;Continent&gt; continents; <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"name"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> name; } <span class="hljs-meta"><span class="hljs-meta">@OneToMany</span></span>(fetch = FetchType.EAGER, cascade = CascadeType.ALL, mappedBy = <span class="hljs-string"><span class="hljs-string">"planet"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> List&lt;Continent&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getContinents</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> continents; } }</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Planetetto</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@EqualsAndHashCode</span></span>(callSuper = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Data</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PlanetDto</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractDto</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String name; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;ContinentDto&gt; continents; }</code> </pre> <br></div></div><br>  Mappeur.  La raison pour laquelle il est organisé de cette manière est décrite dans l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article</a> correspondant. <br><br><div class="spoiler">  <b class="spoiler_title">EntityDtoMapper</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EntityDtoMapper</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">E</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractEntity</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">D</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractDto</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-function">E </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toEntity</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(D dto)</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">D </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toDto</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(E entity)</span></span></span></span>; }</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">AbstractMapper</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Setter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractMapper</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">E</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractEntity</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">D</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractDto</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EntityDtoMapper</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">E</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">D</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> ModelMapper mapper; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Class&lt;E&gt; entityClass; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Class&lt;D&gt; dtoClass; AbstractMapper(Class&lt;E&gt; entityClass, Class&lt;D&gt; dtoClass) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.entityClass = entityClass; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dtoClass = dtoClass; } <span class="hljs-meta"><span class="hljs-meta">@PostConstruct</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> E </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toEntity</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(D dto)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Objects.isNull(dto) ? <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> : mapper.map(dto, entityClass); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> D </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toDto</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(E entity)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Objects.isNull(entity) ? <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> : mapper.map(entity, dtoClass); } <span class="hljs-function"><span class="hljs-function">Converter&lt;E, D&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toDtoConverter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context -&gt; { E source = context.getSource(); D destination = context.getDestination(); mapSpecificFields(source, destination); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context.getDestination(); }; } <span class="hljs-function"><span class="hljs-function">Converter&lt;D, E&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toEntityConverter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context -&gt; { D source = context.getSource(); E destination = context.getDestination(); mapSpecificFields(source, destination); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context.getDestination(); }; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mapSpecificFields</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(E source, D destination)</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mapSpecificFields</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(D source, E destination)</span></span></span><span class="hljs-function"> </span></span>{ } }</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">PlanetMapper</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PlanetMapper</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractMapper</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Planet</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PlanetDto</span></span></span><span class="hljs-class">&gt; </span></span>{ PlanetMapper() { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(Planet.class, PlanetDto.class); } }</code> </pre> <br></div></div><br><h2>  Initialisation du champ. </h2><br>  La classe mapper abstraite a deux champs dans la classe Class que nous devons initialiser dans l'implémentation. <br><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Class&lt;E&gt; entityClass; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Class&lt;D&gt; dtoClass;</code> </pre> <br>  Maintenant, nous le faisons via le constructeur.  Pas la solution la plus élégante, quoique tout à fait pour moi.  Cependant, je suggère d'aller plus loin et d'écrire une annotation qui définira ces champs sans constructeur. <br><br>  Pour commencer, écrivez l'annotation elle-même.  Aucune dépendance supplémentaire ne doit être ajoutée. <br><br>  Pour qu'un chien magique apparaisse devant la classe, nous écrirons ce qui suit: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Retention</span></span>(RetentionPolicy.RUNTIME) <span class="hljs-meta"><span class="hljs-meta">@Target</span></span>({ElementType.TYPE}) <span class="hljs-meta"><span class="hljs-meta">@Documented</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-meta"><span class="hljs-meta">@interface</span></span> Mapper { Class&lt;?&gt; entity(); Class&lt;?&gt; dto(); }</code> </pre> <br>  <b>@Retention (RetentionPolicy.RUNTIME)</b> - définit la politique que l'annotation suivra lors de la compilation.  Il y en a trois: <br><br>  <i>SOURCE</i> - ces annotations ne seront pas prises en compte lors de la compilation.  Cette option ne nous convient pas. <br><br>  <i>CLASS</i> - les annotations seront appliquées lors de la compilation.  Cette option est <br>  stratégie par défaut. <br><br>  <i>RUNTIME</i> - les annotations seront prises en compte lors de la compilation, de plus, la machine virtuelle continuera à les voir comme des annotations, c'est-à-dire qu'elles peuvent être appelées récursivement déjà pendant l'exécution du code, et puisque nous allons travailler avec des annotations via le processeur, c'est l'option qui nous convient . <br><br>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">Cible</a> ({ElementType.TYPE})</b> - définit sur quoi cette annotation peut être accrochée.  Il peut s'agir d'une classe, d'une méthode, d'un champ, d'un constructeur, d'une variable locale, d'un paramètre, etc. - seulement 10 options.  Dans notre cas, <i>TYPE</i> signifie une classe (interface). <br><br>  Dans l'annotation, nous définissons les champs.  Les champs peuvent avoir des valeurs par défaut (par défaut "champ par défaut", par exemple), alors il y a une possibilité de ne pas les remplir.  S'il n'y a pas de valeurs par défaut, le champ doit être rempli. <br><br>  Maintenant, mettons une annotation sur notre implémentation du mappeur et remplissons les champs. <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-meta"><span class="hljs-meta">@Mapper</span></span>(entity = Planet.class, dto = PlanetDto.class) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PlanetMapper</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractMapper</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Planet</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PlanetDto</span></span></span><span class="hljs-class">&gt; </span></span>{</code> </pre> <br>  Nous avons souligné que l'essence de notre mappeur est Planet.class, et le DTO est PlanetDto.class. <br><br>  Afin d'injecter les paramètres d'annotation dans notre bean, nous utiliserons bien sûr le BeanPostProcessor.  Pour ceux qui ne le savent pas, BeanPostProcessor est exécuté lorsque chaque bean est initialisé.  Il existe deux méthodes dans l'interface: <br><br>  postProcessBeforeInitialization () - exécuté avant l'initialisation du bean. <br><br>  postProcessAfterInitialization () - exécuté après l'initialisation du bean. <br><br>  Ce processus est décrit plus en détail dans la vidéo du célèbre Spring-ripper Evgeny Borisov, qui s'appelle: "Evgeny Borisov - Spring-ripper".  Je recommande de voir. <br><br>  Alors voilà.  Nous avons un bean avec une annotation <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">Mapper</a> avec des paramètres contenant des champs de la classe Class.  Vous pouvez ajouter n'importe quel champ de n'importe quelle classe aux annotations.  Ensuite, nous obtenons ces valeurs de champ et pouvons tout faire avec.  Dans notre cas, nous initialisons les champs de bean avec des valeurs d'annotation. <br><br>  Pour ce faire, nous créons un MapperAnnotationProcessor (selon les règles de Spring, tous les processeurs d'annotation doivent se terminer par ... AnnotationProcessor) et l'hériter de BeanPostProcessor.  Ce faisant, nous devrons remplacer ces deux méthodes. <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MapperAnnotationProcessor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BeanPostProcessor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Object </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">postProcessBeforeInitialization</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Nullable Object bean, String beanName)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Objects.nonNull(bean) ? init(bean) : <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Object </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">postProcessAfterInitialization</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Nullable Object bean, String beanName)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bean; } }</code> </pre> <br>  S'il y a un bac, nous l'initialisons avec des paramètres d'annotation.  Nous le ferons dans une méthode distincte.  La manière la plus simple: <br><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Object </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object bean)</span></span></span><span class="hljs-function"> </span></span>{ Class&lt;?&gt; managedBeanClass = bean.getClass(); Mapper mapper = managedBeanClass.getAnnotation(Mapper.class); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Objects.nonNull(mapper)) { ((AbstractMapper) bean).setEntityClass(mapper.entity()); ((AbstractMapper) bean).setDtoClass(mapper.dto()); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bean; }</code> </pre> <br>  Lors de l'initialisation du bac, nous les parcourons et si nous trouvons l'annotation <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">Mapper</a> au-dessus du bac, nous initialisons les champs du bac avec les paramètres d'annotation. <br><br>  Cette méthode est simple mais pas parfaite et contient une vulnérabilité.  Nous ne typifions pas un bac, mais comptons sur une certaine connaissance de ce bac.  Et tout code dans lequel le programmeur s'appuie sur ses propres conclusions est mauvais et vulnérable.  Oui, et l'Idée jure à l'appel non contrôlé. <br><br>  La tâche de tout faire correctement est difficile, mais réalisable. <br><br>  Spring a un excellent composant ReflectionUtils qui vous permet de travailler avec la réflexion de la manière la plus sûre.  Et nous allons définir les classes de terrain à travers elle. <br><br>  Notre méthode init () ressemblera à ceci: <br><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Object </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object bean)</span></span></span><span class="hljs-function"> </span></span>{ Class&lt;?&gt; managedBeanClass = bean.getClass(); Mapper mapper = managedBeanClass.getAnnotation(Mapper.class); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Objects.nonNull(mapper)) { ReflectionUtils.doWithFields(managedBeanClass, field -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> field != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; String fieldName = field.getName(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!fieldName.equals(<span class="hljs-string"><span class="hljs-string">"entityClass"</span></span>) &amp;&amp; !fieldName.equals(<span class="hljs-string"><span class="hljs-string">"dtoClass"</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } ReflectionUtils.makeAccessible(field); Class&lt;?&gt; targetClass = fieldName.equals(<span class="hljs-string"><span class="hljs-string">"entityClass"</span></span>) ? mapper.entity() : mapper.dto(); Class&lt;?&gt; expectedClass = Stream.of(ResolvableType.forField(field).getGenerics()).findFirst() .orElseThrow(() -&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalArgumentException(<span class="hljs-string"><span class="hljs-string">"Unable to get generic type for "</span></span> + fieldName)).resolve(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (expectedClass != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; !expectedClass.isAssignableFrom(targetClass)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalArgumentException(String.format(<span class="hljs-string"><span class="hljs-string">"Unable to assign Class %s to expected Class %s"</span></span>, targetClass, expectedClass)); } field.set(bean, targetClass); }); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bean; }</code> </pre> <br>  Dès que nous découvrons que notre composant est marqué avec l'annotation <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">Mapper</a> , nous appelons ReflectionUtils.doWithFields, qui définira les champs dont nous avons besoin d'une manière plus élégante.  Nous nous assurons que le champ existe, obtenons son nom et vérifions que ce nom est ce dont nous avons besoin. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> field != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; String fieldName = field.getName(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!fieldName.equals(<span class="hljs-string"><span class="hljs-string">"entityClass"</span></span>) &amp;&amp; !fieldName.equals(<span class="hljs-string"><span class="hljs-string">"dtoClass"</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; }</code> </pre> <br>  Nous mettons le champ à disposition (il est privé). <br><br><pre> <code class="java hljs">ReflectionUtils.makeAccessible(field);</code> </pre> <br>  Nous définissons la valeur dans le champ. <br><br><pre> <code class="java hljs">Class&lt;?&gt; targetClass = fieldName.equals(<span class="hljs-string"><span class="hljs-string">"entityClass"</span></span>) ? mapper.entity() : mapper.dto(); field.set(bean, targetClass);</code> </pre> <br>  C'est déjà suffisant, mais nous pouvons en outre protéger le futur code contre les tentatives de le casser en indiquant la mauvaise entité ou DTO dans les paramètres du mappeur (facultatif).  Nous vérifions que la classe que nous allons mettre sur le terrain est vraiment adaptée à cela. <br><br><pre> <code class="java hljs">Class&lt;?&gt; expectedClass = Stream.of(ResolvableType.forField(field).getGenerics()).findFirst() .orElseThrow(() -&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalArgumentException(<span class="hljs-string"><span class="hljs-string">"Unable to get generic type for "</span></span> + fieldName)).resolve(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (expectedClass != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; !expectedClass.isAssignableFrom(targetClass)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalArgumentException(String.format(<span class="hljs-string"><span class="hljs-string">"Unable to assign Class %s to expected Class: %s"</span></span>, targetClass, expectedClass)); }</code> </pre> <br>  Cette connaissance est suffisante pour créer une sorte d'annotation et surprendre les collègues du projet avec cette magie.  Mais soyez prudent - préparez-vous au fait que tous n'apprécieront pas vos compétences :) <br><br>  Le projet sur Github est ici: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">promoscow@annotations.git</a> <br><br>  En plus de l'exemple d'initialisation bin, le projet contient également l'implémentation AspectJ.  Je voulais également inclure une description de Spring AOP / AspectJ dans l'article, mais j'ai trouvé que Habré avait déjà un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">merveilleux article</a> sur ce sujet, donc je ne le reproduirai pas.  Eh bien, je vais laisser le code de travail et le test écrit - cela aidera peut-être quelqu'un à comprendre le travail d'AspectJ. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr439594/">https://habr.com/ru/post/fr439594/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr439584/index.html">Le projet Lenergy comme repenser les alimentations portables</a></li>
<li><a href="../fr439586/index.html">Le protocole SPBm comme fondement de Extreme Automated Campus</a></li>
<li><a href="../fr439588/index.html">ESET a découvert de nouvelles versions du cheval de Troie DanaBot</a></li>
<li><a href="../fr439590/index.html">Quals: Saudi and Oman National Cyber ​​Security CTF 2019.</a></li>
<li><a href="../fr439592/index.html">Automatisation des activités éthiques</a></li>
<li><a href="../fr439596/index.html">Comment j'ai accéléré le traitement d'image sur Android 15 fois</a></li>
<li><a href="../fr439598/index.html">Microsoft a parlé du coût de l'assistance payante pour Windows 7</a></li>
<li><a href="../fr439600/index.html">La Finlande résume les résultats préliminaires d'une expérience sur le revenu de base garanti</a></li>
<li><a href="../fr439602/index.html">L'éthique dans l'espace numérique - les règles de base des relations numériques internationales</a></li>
<li><a href="../fr439604/index.html">Comment le code-barres est-il organisé?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>