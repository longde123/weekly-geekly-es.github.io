<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ÅâÔ∏è üóìÔ∏è üïØÔ∏è Como criamos interface do usu√°rio para sistemas de an√∫ncios ‚úäüèæ üë©üèª‚Äçüé® üòê</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Em vez de se juntar 
 No in√≠cio de nosso blog, escrevemos o que o IPONWEB est√° fazendo - automatizamos a exibi√ß√£o de an√∫ncios na Internet. Nossos sist...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como criamos interface do usu√°rio para sistemas de an√∫ncios</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/iponweb/blog/455720/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/c0/4s/qy/c04sqydw6na8nhopdgeb9raqc74.jpeg" alt="imagem"></div><br><h2>  Em vez de se juntar </h2><br>  No in√≠cio de nosso blog, escrevemos o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">que o IPONWEB</a> est√° <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">fazendo</a> - automatizamos a exibi√ß√£o de an√∫ncios na Internet.  Nossos sistemas tomam decis√µes n√£o apenas com base em dados hist√≥ricos, mas tamb√©m usam ativamente as informa√ß√µes obtidas em tempo real.  No caso do DSP (Demand Side Platform - uma plataforma de publicidade para anunciantes), o anunciante (ou seu representante) deve criar e fazer upload de um banner de publicidade (criativo) em um dos formatos (foto, v√≠deo, banner interativo, foto + texto etc.) , selecione o p√∫blico de usu√°rios para quem esse banner ser√° exibido, determine quantas vezes √© poss√≠vel exibir publicidade para um usu√°rio, em quais pa√≠ses, em quais sites, em quais dispositivos e reflita isso (e muito mais) nas configura√ß√µes de segmenta√ß√£o da campanha publicit√°ria, al√©m de distribuir publicidade o or√ßamento  s.  Para o SSP (Supply Side Platform - uma plataforma de publicidade para propriet√°rios de plataformas de publicidade), o propriet√°rio do site (aplicativo m√≥vel, quadro de avisos, canal de televis√£o) deve determinar os pontos de publicidade em seu site e indicar, por exemplo, quais categorias de publicidade ele est√° pronto para exibir neles.  Todas essas configura√ß√µes s√£o feitas manualmente com anteced√™ncia (n√£o no momento da exibi√ß√£o de an√∫ncios) usando a interface do usu√°rio.  Neste artigo, falarei sobre nossa abordagem para criar essas interfaces, desde que existam muitas, elas s√£o semelhantes umas √†s outras e, ao mesmo tempo, t√™m caracter√≠sticas individuais. <br><a name="habracut"></a><br><h2>  Como tudo come√ßou </h2><br><img src="https://habrastorage.org/webt/rl/2x/sq/rl2xsqfekchguv2ku2exurixvl0.png" alt="imagem"><br><br>  Come√ßamos os neg√≥cios de publicidade em 2007, mas n√£o fizemos interfaces imediatamente, mas apenas em 2014.  Tradicionalmente, estamos engajados no desenvolvimento de plataformas personalizadas, completamente projetadas de acordo com as especificidades dos neg√≥cios de cada cliente - entre as dezenas de plataformas que constru√≠mos, n√£o h√° duas id√™nticas.  E como nossas plataformas de publicidade foram projetadas sem restri√ß√µes sobre as possibilidades de personaliza√ß√£o, a interface do usu√°rio precisava atender aos mesmos requisitos. <br><br>  Quando recebemos o primeiro pedido de uma interface de publicidade para o DSP, cinco anos atr√°s, nossa escolha caiu na pilha de tecnologia popular e conveniente: JavaScript e AngularJS no front-end e o back-end no Python, Django e Django Rest Framework (DRF).  A partir disso, o projeto mais comum foi realizado, cuja principal tarefa era fornecer a funcionalidade CRUD.  O resultado de seu trabalho foi um arquivo de configura√ß√µes para o sistema de publicidade no formato XML.  Agora, esse protocolo de intera√ß√£o pode parecer estranho, mas, como j√° discutimos, os primeiros sistemas de publicidade (mesmo sem uma interface do usu√°rio) que come√ßamos a construir nos "zero", e esse formato foi preservado at√© hoje. <br><br>  Ap√≥s o lan√ßamento bem-sucedido do primeiro projeto, o seguinte n√£o levou muito tempo.  Essa tamb√©m era a interface do usu√°rio para o DSP e os requisitos para eles eram os mesmos do primeiro projeto.  Quase.  Apesar de tudo ser muito parecido, o diabo estava oculto nos detalhes - h√° uma hierarquia de objetos um pouco diferente, alguns campos s√£o adicionados l√° ... A maneira mais √≥bvia de obter o segundo projeto, muito semelhante ao primeiro, mas com melhorias, foi o m√©todo de replica√ß√£o que usamos .  E isso implicava problemas familiares para muitos - junto com o c√≥digo "bom", os bugs tamb√©m eram copiados, cujos patches tinham que ser distribu√≠dos manualmente.  O mesmo aconteceu com todos os novos recursos lan√ßados em todos os projetos ativos. <br><br>  Nesse modo, era poss√≠vel trabalhar enquanto havia poucos projetos, mas quando seu n√∫mero excedia 20, a abordagem familiar deixou de crescer.  Portanto, decidimos transferir as partes comuns dos projetos para a biblioteca, da qual o projeto conectar√° os componentes necess√°rios.  Se um bug for detectado, ele √© reparado uma vez na biblioteca e √© automaticamente distribu√≠do aos projetos quando a vers√£o da biblioteca √© atualizada, e o mesmo ocorre com a reutiliza√ß√£o de novos recursos. <br><br><h2>  Configura√ß√£o e terminologia </h2><br>  Tivemos v√°rias itera√ß√µes na implementa√ß√£o dessa abordagem, e todas elas evolu√≠ram uma para a outra de forma evolutiva, come√ßando com nosso projeto usual sobre DRF puro.  Na implementa√ß√£o mais recente, nosso projeto √© descrito usando DSL baseado em JSON (veja a figura).  Este JSON descreve a estrutura dos componentes do projeto e suas interconex√µes, e o front-end e o back-end podem l√™-lo. <br><br>  Ap√≥s inicializar o aplicativo Angular, o front-end solicita uma configura√ß√£o JSON do back-end.  O back-end n√£o apenas fornece um arquivo de configura√ß√£o est√°tico, mas tamb√©m o processa, complementando-o com v√°rios metadados ou excluindo partes da configura√ß√£o respons√°veis ‚Äã‚Äãpor partes do sistema inacess√≠veis ao usu√°rio.  Isso permite que voc√™ mostre a diferentes usu√°rios a interface de diferentes maneiras, incluindo formul√°rios interativos, estilos CSS de todo o aplicativo e elementos de design espec√≠ficos.  O √∫ltimo √© especialmente verdadeiro para interfaces de usu√°rio de plataformas que s√£o usadas por diferentes tipos de clientes com diferentes fun√ß√µes e n√≠veis de acesso. <br><br><img src="https://habrastorage.org/webt/n8/pt/q-/n8ptq-qevfrhnqtotqv7wytdbts.jpeg" alt="imagem"><br><br>  O back-end, ao contr√°rio do front-end, l√™ a configura√ß√£o uma vez no est√°gio de inicializa√ß√£o do aplicativo Django.  Assim, a quantidade total de funcionalidades √© registrada no back-end e o acesso a v√°rias partes do sistema √© verificado em tempo real. <br><br>  Antes de passar para a parte mais interessante - estrutura do banco de dados -, quero introduzir v√°rios conceitos que usamos quando falamos sobre a estrutura de nossos projetos, a fim de manter o mesmo comprimento de onda que o leitor. <br><br>  Esses conceitos - Entidade e Recurso - est√£o bem ilustrados no formul√°rio de entrada de dados (veja a figura).  O formul√°rio inteiro √© Entidade, e os campos individuais s√£o Recurso.  A imagem tamb√©m mostra o Endpoint (apenas por precau√ß√£o).  Portanto, Entidade √© um objeto independente no sistema no qual as opera√ß√µes CRUD podem ser executadas, enquanto o Recurso √© apenas parte de "algo mais", parte da Entidade.  Com o Feature, voc√™ n√£o pode executar opera√ß√µes CRUD sem estar vinculado a nenhuma Entidade.  Por exemplo: o or√ßamento de uma campanha publicit√°ria sem refer√™ncia √† pr√≥pria campanha √© simplesmente um n√∫mero que n√£o pode ser usado sem informa√ß√µes sobre a campanha principal. <br><br><img src="https://habrastorage.org/webt/rf/a3/mg/rfa3mgfmgjubcafiegwiz5a5yf0.jpeg" alt="imagem"><br><br>  Os mesmos conceitos podem ser encontrados na configura√ß√£o JSON do projeto (veja a figura). <br><br><img src="https://habrastorage.org/webt/nx/vq/hv/nxvqhvhbxtfmrq6pbxogjqrwyg0.jpeg" alt="imagem"><br><br><h2>  Estrutura de banco de dados </h2><br>  A parte mais interessante de nossos projetos √© a estrutura do banco de dados e a mec√¢nica que o suporta.  Tendo come√ßado a usar o PostgreSQL nas primeiras vers√µes de nossos projetos, continuamos com essa tecnologia hoje.  Junto com isso, estamos usando ativamente o Django ORM.  Nas implementa√ß√µes iniciais, usamos o modelo padr√£o de relacionamento entre objetos (entidades) na Chave Externa; no entanto, essa abordagem causava dificuldades quando era necess√°rio alterar a hierarquia dos relacionamentos.  Portanto, por exemplo, na hierarquia padr√£o da Unidade de neg√≥cios DSP -&gt; Anunciante -&gt; Campanha, alguns clientes precisavam entrar no n√≠vel da ag√™ncia (Unidade de neg√≥cios -&gt; Ag√™ncia -&gt; Anunciante -&gt; ...).  Portanto, abandonamos gradualmente o uso de chave estrangeira e organizamos links entre objetos usando links Many To Many atrav√©s de uma tabela separada, denominada `LinkRegistry`. <br><br>  Al√©m disso, gradualmente abandonamos o c√≥digo r√≠gido para preencher entidades e come√ßamos a armazenar a maioria dos campos em tabelas separadas, vinculando-os tamb√©m atrav√©s do `LinkRegistry` (veja a figura).  Por que isso foi necess√°rio?  Para cada cliente, o conte√∫do da entidade pode variar - alguns campos ser√£o adicionados ou exclu√≠dos.  Acontece que teremos de armazenar em cada entidade um superconjunto de campos para todos os nossos clientes.  Ao mesmo tempo, todos ter√£o que ser opcionais, para que os campos obrigat√≥rios "alien√≠genas" n√£o interfiram no trabalho. <br><br><img src="https://habrastorage.org/webt/xc/bl/hb/xcblhbhejijacnilogffvcd3hko.jpeg" alt="imagem"><br><br>  Considere o exemplo da figura: aqui a estrutura do banco de dados para o criativo com um campo adicional √© descrita - `image_url`.  Somente seu ID √© armazenado na tabela de criativos e image_url √© armazenado em uma tabela separada, o relacionamento deles √© descrito por outra entrada na tabela LinkRegistry.  Portanto, esse criativo ser√° descrito por tr√™s entradas, uma em cada uma das tabelas.  Dessa forma, para salvar um criativo, voc√™ precisa fazer uma entrada em cada um deles e l√™-lo da mesma maneira, visitando 3 tabelas.  Seria muito inconveniente escrever esse processamento sempre do zero, para que nossa biblioteca abstraia todos esses detalhes do programador.  Para trabalhar com dados, o Django e o DRF usam modelos e serializadores descritos pelo c√≥digo.  Em nossos projetos, o conjunto de campos em modelos e serializadores √© determinado em tempo de execu√ß√£o pela configura√ß√£o JSON, as classes de modelo s√£o criadas dinamicamente (usando a fun√ß√£o type) e armazenadas em um registro especial, de onde est√£o dispon√≠veis durante a opera√ß√£o do aplicativo.  Tamb√©m usamos classes base especiais para esses modelos e serializadores, que ajudam no trabalho com estrutura base n√£o padr√£o. <br><br>  Ao salvar um novo objeto (ou atualizar um existente), os dados recebidos do front-end entram no serializador, onde s√£o validados - n√£o h√° nada de incomum, os mecanismos DRF padr√£o funcionam.  Mas salvar e atualizar s√£o redefinidos aqui.  O serializador sempre sabe com qual modelo ele trabalha e, de acordo com a representa√ß√£o interna de nosso modelo din√¢mico, pode entender em qual tabela os dados do pr√≥ximo campo devem ser colocados.  Codificamos essas informa√ß√µes nos campos de modelo personalizado (lembre-se de como a `ForeignKey` √© descrita no Django - um modelo relacionado √© passado dentro do campo, fazemos o mesmo).  Nesses campos especiais, tamb√©m resumimos a necessidade de adicionar um terceiro registro de liga√ß√£o ao LinkRegistry usando o mecanismo do descritor - no c√≥digo que voc√™ escreve `creative.image_url = 'http: // foo.bar' 'e no m√©todo substitu√≠do __set__ que escrevemos para `LinkRegistry`. <br>  Isso se aplica √† grava√ß√£o no banco de dados.  E agora vamos lidar com a leitura.  Como uma tupla √© retirada de um banco de dados convertida em uma inst√¢ncia de modelo do Django?  No modelo base do Django, existe um m√©todo `from_db`, que √© chamado para cada tupla recebida ao executar uma consulta no` queryset`.  Na entrada, ele recebe uma tupla e retorna a inst√¢ncia do modelo Django.  Redefinimos esse m√©todo em nosso modelo base, onde, de acordo com a tupla do modelo principal (onde apenas `id` entra), obtemos dados de outras tabelas relacionadas e, tendo esse conjunto completo, instanciamos o modelo.  Obviamente, tamb√©m trabalhamos para otimizar o mecanismo de pr√©-busca do Django para o nosso caso de uso n√£o padr√£o. <br><br><h2>  Teste </h2><br>  Nossa estrutura √© bastante complexa, por isso escrevemos muitos testes.  Temos testes para o front-end e o back-end.  Vou me debru√ßar sobre os testes de back-end em detalhes. <br><br>  Para executar os testes, usamos pytest.  No back-end, temos duas grandes classes de testes: testes de nossa estrutura (tamb√©m denominamos "n√∫cleo") e testes de projeto. <br><br>  No kernel, escrevemos testes de unidade isolados e funcionais para testar pontos de extremidade usando o plugin pytest-django.  Em geral, todo o trabalho com o banco de dados √© testado principalmente por meio de solicita√ß√µes √† API - como acontece na produ√ß√£o. <br><br>  Testes funcionais podem especificar uma configura√ß√£o JSON.  Para n√£o se apegar √† terminologia do design, usamos nomes "fict√≠cios" para entidades com as quais testamos nossos Recursos no kernel ("Emma", "Alla", "Karl", "Maria" e assim por diante).  Como, ao escrever o recurso image_url, n√£o queremos limitar a consci√™ncia do desenvolvedor ao fato de que ele pode ser usado apenas com a entidade Criativa - os recursos e as entidades s√£o universais e podem ser conectados entre si em qualquer combina√ß√£o relevante para um cliente em particular. <br><br>  Quanto aos projetos de teste, todos os casos de teste s√£o executados com a configura√ß√£o de produ√ß√£o, sem entidades fict√≠cias, pois √© importante verificar exatamente com o que o cliente trabalhar√°.  No projeto, voc√™ pode escrever qualquer teste que cubra os recursos da l√≥gica de neg√≥cios do projeto.  Ao mesmo tempo, testes b√°sicos de CRUD podem ser conectados ao projeto a partir do kernel.  Eles s√£o escritos de maneira geral e podem ser conectados a qualquer projeto: um teste de recurso pode ler a configura√ß√£o JSON de um projeto, determinar a quais entidades esse recurso est√° conectado e executar verifica√ß√µes apenas nas entidades necess√°rias.  Para facilitar a prepara√ß√£o dos dados de teste, desenvolvemos um sistema de auxiliares que tamb√©m podem preparar conjuntos de dados de teste com base na configura√ß√£o JSON.  Um lugar especial nos testes do projeto √© ocupado pelos testes E2E no Transferidor, que testam todas as fun√ß√µes b√°sicas do projeto.  Esses testes tamb√©m s√£o descritos usando JSON, eles s√£o escritos e suportados por desenvolvedores de front-end. <br><br><h2>  Posf√°cio </h2><br>  Neste artigo, examinamos a abordagem de design modular desenvolvida pelo IPONWEB no departamento de interface do usu√°rio.  Esta solu√ß√£o opera com sucesso na produ√ß√£o h√° tr√™s anos.  No entanto, essa solu√ß√£o ainda possui v√°rias limita√ß√µes que n√£o nos permitem descansar sobre os louros.  Em primeiro lugar, nossa base de c√≥digo ainda √© bastante complexa.  Em segundo lugar, o c√≥digo b√°sico que suporta modelos din√¢micos est√° associado a componentes cr√≠ticos como pesquisa, carregamento em massa de objetos, direitos de acesso e outros.  Por esse motivo, as altera√ß√µes em um dos componentes podem afetar significativamente os outros.  Em um esfor√ßo para nos livrar dessas restri√ß√µes, continuamos processando ativamente nossa biblioteca, dividindo-a em v√°rias partes independentes e reduzindo a complexidade do c√≥digo.  Vamos falar sobre os resultados nos seguintes artigos. <br><br>  Este artigo √© uma transcri√ß√£o estendida da minha apresenta√ß√£o no MoscowPythonConf ++ 2019, ent√£o eu tamb√©m compartilho links para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">v√≠deos</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">slides</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt455720/">https://habr.com/ru/post/pt455720/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt455700/index.html">4 truques que nos ajudaram a otimizar o frontend</a></li>
<li><a href="../pt455702/index.html">Gera√ß√£o efetiva de n√∫meros em um determinado intervalo</a></li>
<li><a href="../pt455710/index.html">Por que n√≥s da Leroy Merlin precisamos de nosso pr√≥prio departamento de desenvolvimento russo para 200 pessoas</a></li>
<li><a href="../pt455714/index.html">Exporte automaticamente o Google Forms para o Notion usando IFTTT e Django</a></li>
<li><a href="../pt455716/index.html">15 pr√°ticas recomendadas para implantar o software de Business Intelligence</a></li>
<li><a href="../pt455722/index.html">Python consome muita mem√≥ria ou como reduzir o tamanho dos objetos?</a></li>
<li><a href="../pt455726/index.html">C ++ Enterprise Edition. Isso √© poss√≠vel?</a></li>
<li><a href="../pt455728/index.html">Fazendo seu bot√£o de a√ß√£o flutuante quase estendido</a></li>
<li><a href="../pt455730/index.html">Instale o MacOS High Sierra quando apenas o WiFi estiver dispon√≠vel</a></li>
<li><a href="../pt455734/index.html">H√°bito de fazer agora</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>