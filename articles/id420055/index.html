<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚝 🍈 📴 Teori dan praktik backup dengan Borg 👳 🍙 🛠️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Yang mengejutkan kami, tidak ada satu bahan pun tentang alat Open Source yang hebat untuk cadangan data - Borg (jangan dikelirukan dengan nenek moyang...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Teori dan praktik backup dengan Borg</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/420055/"><img src="https://habrastorage.org/webt/xx/7w/tn/xx7wtnr5mv7mjndz-uzowsql58o.png"><br><br>  Yang mengejutkan kami, tidak ada satu bahan pun tentang alat Open Source yang hebat untuk cadangan data - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Borg</a> <i>(jangan dikelirukan dengan nenek moyang dari nama yang sama Kubernet!)</i> .  Karena kami telah menggunakannya dalam produksi selama lebih dari setahun, dalam artikel ini saya akan membagikan "kesan" yang kami dapatkan tentang Borg. <a name="habracut"></a><br><br><h2>  Latar Belakang: Pengalaman dengan Bacula dan Bareos </h2><br>  Pada tahun 2017, kami bosan dengan Bacula dan Bareos, yang kami gunakan sejak awal kegiatan kami (yaitu, sekitar 9 tahun dalam produksi pada waktu itu).  Mengapa  Selama operasi, kami telah mengumpulkan banyak ketidakpuasan: <br><br><ul><li>  SD (Storage Daemon) membeku.  Jika Anda telah mengkonfigurasi paralelisme, maka perawatan SD menjadi lebih rumit, dan pembekuannya akan memblokir cadangan lebih lanjut sesuai jadwal dan kemungkinan pemulihan. </li><li>  Diperlukan untuk membuat konfigurasi untuk klien dan direktur.  Bahkan jika kita mengotomatiskan ini (dalam kasus kami, Chef, Ansible, dan pengembangan kami digunakan pada waktu yang berbeda), kita perlu memantau bahwa sutradara, setelah <i>memuat ulang,</i> benar-benar mengambil konfigurasi.  Ini hanya dilacak pada output perintah <i>reload</i> dan setelah panggilan <i>pesan</i> (untuk mendapatkan teks kesalahan itu sendiri). </li><li>  Jadwalkan cadangan.  Pengembang Bacula memutuskan untuk bertindak sendiri dan menulis format jadwal mereka sendiri, yang tidak dapat Anda parsing atau ubah ke yang lain.  Berikut adalah contoh jadwal cadangan standar di instalasi lama kami: <ul><li>  Cadangan penuh harian pada hari Rabu dan tambahan pada hari-hari lain: <br> <code>Run = Level=Full Pool="Foobar-low7" wed at 18:00 <br> Run = Level=Incremental Pool="Foobar-low7" at 18:00</code> </li> <li>  Cadangan penuh file wal 2 kali sebulan dan setiap jam bertambah: <br> <code>Run = Level=Full FullPool=CustomerWALPool 1st fri at 01:45 <br> Run = Level=Full FullPool=CustomerWALPool 3rd fri at 01:45 <br> Run = Level=Incremental FullPool=CustomerWALPool IncrementalPool=CustomerWALPool on hourly</code> </li> <li>  <code>schedule</code> dihasilkan untuk semua kesempatan (pada hari yang berbeda dalam seminggu setiap 2 jam) kami dapatkan sekitar 1665 ... karena apa yang Bacula / Bareos secara berkala menjadi gila. </li></ul></li><li>  Bacula-fd (dan bareos-fd) memiliki direktori dengan banyak data (katakanlah 40 TB, yang 35 TB berisi file besar [100+ MB], dan 5 TB sisanya berisi file kecil [1 KB hingga 100 MB ]) kebocoran memori lambat dimulai, yang merupakan situasi yang sangat tidak menyenangkan pada produksi. <br><br><img src="https://habrastorage.org/webt/eu/33/ao/eu33aocunyesaxcwtlyzzim_eha.png"></li><li>  Pada cadangan dengan sejumlah besar file, Bacula dan Bareos sangat tergantung pada kinerja DBMS yang digunakan.  Drive apa yang dimilikinya?  Seberapa terampil Anda tahu bagaimana menyesuaikannya dengan kebutuhan khusus ini?  Dan dalam database, omong-omong, satu (!) Tabel non-partisi dibuat dengan daftar semua file di semua cadangan dan yang kedua - dengan daftar semua jalur di semua cadangan.  Jika Anda belum siap untuk mengalokasikan setidaknya 8 GB RAM untuk basis + 40 GB SSD untuk server cadangan Anda - segera bersiaplah untuk rem. </li><li>  Ketergantungan database layak mendapat satu poin lagi.  Bacula / Bareos untuk setiap file bertanya kepada direktur apakah sudah ada file seperti itu.  Direktur, tentu saja, merangkak ke dalam database, ke dalam tabel-tabel yang sangat besar ... Ternyata cadangan dapat diblokir hanya dengan fakta bahwa beberapa cadangan berat dimulai pada saat yang sama - bahkan jika perbedaannya adalah beberapa megabyte di sana. </li></ul><br><img src="https://habrastorage.org/webt/nh/iw/dz/nhiwdzn69dvunjisjzcwcy1fyna.png"><br><br>  Tidak adil untuk mengatakan bahwa tidak ada masalah yang terpecahkan sama sekali, tetapi kami sampai pada titik di mana kami benar-benar lelah dengan berbagai solusi dan menginginkan solusi yang andal "di sini dan sekarang." <br><br>  Bacula / Bareos bekerja dengan baik dengan sejumlah kecil (10-30) pekerjaan yang seragam.  Apakah ada hal kecil yang pecah seminggu sekali?  Tidak apa-apa: mereka memberikan tugas kepada petugas jaga (atau insinyur lain) - mereka memperbaikinya.  Namun, kami memiliki proyek di mana jumlah pekerjaan dalam ratusan, dan jumlah file di dalamnya adalah ratusan ribu.  Akibatnya, 5 menit seminggu untuk memperbaiki cadangan (tidak termasuk beberapa jam pengaturan sebelum ini) mulai bertambah banyak.  Semua ini mengarah pada fakta bahwa 2 jam sehari itu perlu untuk memperbaiki cadangan di semua proyek, karena secara harfiah di mana-mana ada sesuatu yang sepele atau serius rusak. <br><br>  Kemudian seseorang mungkin berpikir bahwa seorang insinyur yang berdedikasi untuk hal ini harus melakukan pencadangan.  Tentu saja, dia akan berjanggut dan seberat mungkin, dan dari penampilannya, cadangan diperbaiki secara instan, sementara dia dengan tenang menyeruput kopi.  Dan ide ini mungkin benar dalam beberapa cara ... Tapi selalu ada tapi.  Tidak semua orang mampu memperbaiki dan memantau cadangan sepanjang waktu, dan bahkan lebih - seorang insinyur yang dialokasikan untuk tujuan ini.  Kami yakin bahwa lebih baik menghabiskan 2 jam sehari ini untuk sesuatu yang lebih produktif dan berguna.  Oleh karena itu, kami beralih ke mencari solusi alternatif yang “hanya berfungsi”. <br><br><h2>  Borg sebagai cara baru </h2><br>  Pencarian untuk opsi Open Source lainnya tersebar dari waktu ke waktu, sehingga sulit untuk memperkirakan total biaya, tetapi pada satu titik (tahun lalu), perhatian kami beralih ke " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">pahlawan</a> acara" - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">BorgBackup</a> (atau hanya Borg).  Sebagian, ini difasilitasi oleh pengalaman nyata penggunaannya oleh salah satu insinyur kami (di tempat kerja sebelumnya). <br><br>  Borg ditulis dalam Python (versi&gt; = 3.4.0 diperlukan), dan kode yang menuntut kinerja (kompresi, enkripsi, dll.) Diimplementasikan dalam C / Cython.  Didistribusikan di bawah lisensi BSD gratis (3-klausa).  Ini mendukung banyak platform termasuk Linux, * BSD, macOS, serta pada tingkat eksperimental Cygwin dan Linux Subsystem Windows 10. Untuk menginstal BorgBackup, paket tersedia untuk distribusi Linux populer dan OS lainnya, serta kode sumber, yang juga dapat diinstal melalui pip, - informasi lebih rinci tentang ini dapat ditemukan dalam <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">dokumentasi proyek</a> . <br><br>  Mengapa Borg menyuap kami begitu banyak?  Berikut ini keunggulan utamanya: <br><br><ul><li>  <b>Deduplikasi</b> : nyata dan sangat efektif (contoh di bawah).  File dalam repositori Borg tunggal (mis., Direktori khusus dalam format spesifik-Borg) dibagi menjadi blok-blok n megabyte, dan blok-blok Borg yang berulang dideduplikasi.  Deduplikasi terjadi tepat sebelum kompresi. </li><li>  <b>Kompresi</b> : setelah deduplikasi, data juga dikompresi.  Algoritma kompresi yang berbeda tersedia: lz4, lzma, zlib, zstd.  Fitur standar cadangan apa pun, tetapi ini tidak kalah bermanfaat. </li><li>  <b>Bekerja pada SSH</b> : Borg mencadangkan ke server jauh melalui SSH.  Di sisi server, Anda hanya perlu menginstal Borg dan hanya itu!  Dari sini, keuntungan seperti keamanan dan enkripsi segera menyusul.  Anda dapat mengkonfigurasi akses hanya dengan kunci dan, apalagi, eksekusi Borg hanya satu dari perintahnya ketika memasuki server.  Misalnya, seperti ini: <br><br><pre> <code class="bash hljs">$ cat .ssh/authorized_keys <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=<span class="hljs-string"><span class="hljs-string">"/usr/bin/borg serve"</span></span> ssh-rsa AAAAB3NzaC1yc…</code> </pre> </li><li>  Itu disampaikan baik dalam PPA (kami terutama menggunakan Ubuntu) dan dalam <b>biner statis</b> .  Borg dalam bentuk biner statis memungkinkan untuk menjalankannya hampir di mana-mana di mana ada setidaknya glibc modern minimal.  (Tapi tidak di mana-mana - misalnya, tidak mungkin untuk memulai pada CentOS 5.) </li><li>  <b>Pembersihan cadangan lama yang</b> fleksibel.  Anda dapat mengatur penyimpanan n cadangan terakhir, dan 2 cadangan per jam / hari / minggu.  Dalam kasus terakhir, cadangan terakhir di akhir minggu akan ditinggalkan.  Ketentuan dapat digabungkan dengan menyimpan 7 cadangan harian selama 7 hari terakhir dan 4 cadangan mingguan. </li></ul><br>  Transisi ke Borg dimulai perlahan pada proyek-proyek kecil.  Pada awalnya, ini adalah skrip cron sederhana yang melakukan pekerjaan mereka setiap hari.  Ini berlangsung selama sekitar enam bulan.  Selama waktu ini, kami harus mendapatkan backup berkali-kali ... dan ternyata Borg tidak harus diperbaiki sama sekali!  Mengapa  Karena prinsip sederhana bekerja di sini: "Semakin sederhana mekanismenya, semakin sedikit tempat di mana ia akan hancur." <br><br><h2>  Latihan: bagaimana cara membuat cadangan dengan Borg? </h2><br>  Pertimbangkan contoh sederhana membuat cadangan: <br><br><ol><li>  Unduh binary rilis terbaru ke server cadangan dan mesin yang akan kami cadangkan dari <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">repositori resmi</a> : <br><br><pre> <code class="bash hljs">sudo wget https://github.com/borgbackup/borg/releases/download/1.1.6/borg-linux64 -O /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/borg sudo chmod +x /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/borg</code> </pre> <br>  <i><b>Catatan</b> : Jika Anda menggunakan mesin lokal untuk pengujian baik sebagai sumber dan sebagai penerima, maka seluruh perbedaan hanya akan ada di URI, yang akan kami sampaikan, tetapi kami ingat bahwa cadangan tersebut perlu disimpan secara terpisah, dan bukan pada mesin yang sama.</i> </li><li>  Di server cadangan, buat pengguna <code>borg</code> : <br><br><pre> <code class="bash hljs">sudo useradd -m borg</code> </pre> <br>  Sederhana: tanpa grup dan dengan shell standar, tetapi selalu dengan direktori home. </li><li>  Kunci SSH dihasilkan pada klien: <br><br><pre> <code class="bash hljs">ssh-keygen</code> </pre> </li><li>  Di server, tambahkan kunci yang dihasilkan ke pengguna <code>borg</code> : <br><br><pre> <code class="bash hljs">mkdir ~borg/.ssh <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'command="/usr/local/bin/borg serve" ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDNdaDfqUUf/XmSVWfF7PfjGlbKW00MJ63zal/E/mxm+vJIJRBw7GZofe1PeTpKcEUTiBBEsW9XUmTctnWE6p21gU/JNU0jITLx+vg4IlVP62cac71tkx1VJFMYQN6EulT0alYxagNwEs7s5cBlykeKk/QmteOOclzx684t9d6BhMvFE9w9r+c76aVBIdbEyrkloiYd+vzt79nRkFE4CoxkpvptMgrAgbx563fRmNSPH8H5dEad44/Xb5uARiYhdlIl45QuNSpAdcOadp46ftDeQCGLc4CgjMxessam+9ujYcUCjhFDNOoEa4YxVhXF9Tcv8Ttxolece6y+IQM7fbDR'</span></span> &gt; ~borg/.ssh/authorized_keys chown -R borg:borg ~borg/.ssh</code> local / bin / borg melayani" ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDNdaDfqUUf / XmSVWfF7PfjGlbKW00MJ63zal / E / mxm + vJIJRBw7GZofe1PeTpKcEUTiBBEsW9XUmTctnWE6p21gU / JNU0jITLx + vg4IlVP62cac71tkx1VJFMYQN6EulT0alYxagNwEs7s5cBlykeKk / QmteOOclzx684t9d6BhMvFE9w9r + c76aVBIdbEyrkloiYd + vzt79nRkFE4CoxkpvptMgrAgbx563fRmNSPH8H5dEad44 / Xb5uARiYhdlIl45QuNSpAdcOadp46ftDeQCGLc4CgjMxessam + 9ujYcUCjhFDNOoEa4YxVhXF9Tcv8Ttxolece6y + IQM7fbDR'&gt; ~ borg / .ssh <code class="bash hljs">mkdir ~borg/.ssh <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'command="/usr/local/bin/borg serve" ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDNdaDfqUUf/XmSVWfF7PfjGlbKW00MJ63zal/E/mxm+vJIJRBw7GZofe1PeTpKcEUTiBBEsW9XUmTctnWE6p21gU/JNU0jITLx+vg4IlVP62cac71tkx1VJFMYQN6EulT0alYxagNwEs7s5cBlykeKk/QmteOOclzx684t9d6BhMvFE9w9r+c76aVBIdbEyrkloiYd+vzt79nRkFE4CoxkpvptMgrAgbx563fRmNSPH8H5dEad44/Xb5uARiYhdlIl45QuNSpAdcOadp46ftDeQCGLc4CgjMxessam+9ujYcUCjhFDNOoEa4YxVhXF9Tcv8Ttxolece6y+IQM7fbDR'</span></span> &gt; ~borg/.ssh/authorized_keys chown -R borg:borg ~borg/.ssh</code> </pre> </li><li>  Kami menginisialisasi <i>repo borg</i> di server dari klien: <br><br><pre> <code class="bash hljs">ssh borg@172.17.0.3 hostname <span class="hljs-comment"><span class="hljs-comment">#     borg init -e none borg@172.17.0.3:MyBorgRepo</span></span></code> </pre> <br>  Switch <code>-e</code> digunakan untuk memilih metode enkripsi untuk repositori (ya, Anda juga dapat mengenkripsi setiap repositori dengan kata sandi Anda!).  Dalam hal ini, karena  ini adalah contoh, kami tidak menggunakan enkripsi.  <code>MyBorgRepo</code> adalah nama direktori di mana <i>borg repo</i> akan berada (Anda tidak perlu membuatnya di muka - Borg akan melakukan semuanya sendiri). </li><li>  Luncurkan cadangan pertama menggunakan Borg: <br><br><pre> <code class="bash hljs">borg create --stats --list borg@172.17.0.3:MyBorgRepo::<span class="hljs-string"><span class="hljs-string">"MyFirstBackup-{now:%Y-%m-%d_%H:%M:%S}"</span></span> /etc /root</code> </pre> <br>  Tentang kunci: <br><ul><li>  <code>--stats</code> dan <code>--list</code> memberi kami statistik tentang cadangan dan file yang masuk ke dalamnya; </li><li>  <code>borg@172.17.0.3:MyBorgRepo</code> - semuanya jelas di sini, ini adalah server dan direktori kami.  Dan untuk sihir apa selanjutnya? </li><li>  <code>::"MyFirstBackup-{now:%Y-%m-%d_%H:%M:%S}"</code> adalah nama arsip di dalam repositori.  Ini arbitrer, tetapi kami mematuhi format <code>_-timestamp</code> (timestamp dalam format Python). </li></ul></li></ol><br>  Apa selanjutnya  Tentu saja, lihat apa yang masuk ke cadangan kami!  Daftar arsip di dalam repositori: <br><br><pre> <code class="bash hljs">borg@b3e51b9ed2c2:~$ borg list MyBorgRepo/ Warning: Attempting to access a previously unknown unencrypted repository! Do you want to <span class="hljs-built_in"><span class="hljs-built_in">continue</span></span>? [yN] y MyFirstBackup-2018-08-04_16:55:53 Sat, 2018-08-04 16:55:54 [89f7b5bccfb1ed2d72c8b84b1baf477a8220955c72e7fcf0ecc6cd5a9943d78d]</code> </pre> <br>  Kami melihat cadangan dengan cap waktu dan bagaimana Borg bertanya kepada kami apakah kami benar-benar ingin mengakses repositori yang tidak dienkripsi yang belum pernah kami kunjungi sebelumnya. <br><br>  Kami melihat daftar file: <br><br><pre> <code class="bash hljs">borg list MyBorgRepo::MyFirstBackup-2018-08-04_16:55:53</code> </pre> <br>  Kami mendapatkan file dari cadangan (Anda juga dapat seluruh direktori): <br><br><pre> <code class="bash hljs">borg@b3e51b9ed2c2:~$ borg extract MyBorgRepo::MyFirstBackup-2018-08-04_16:55:53 etc/hostname borg@b3e51b9ed2c2:~$ ll etc/hostname -rw-r--r-- 1 borg borg 13 Aug 4 16:27 etc/hostname</code> </pre> <br>  Selamat, cadangan Borg pertama Anda siap! <br><br><h2>  Latihan: mengotomatiskan ini [dengan GitLab]! </h2><br>  Setelah membungkus semua ini dalam skrip, kami mengkonfigurasi cadangan secara manual dengan cara yang mirip pada sekitar 40 host.  Menyadari bahwa Borg benar-benar berfungsi, mereka mulai mentransfer lebih banyak dan lebih banyak proyek ke sana ... <br><br>  Dan di sini kita dihadapkan dengan apa yang ada di Bareos, tetapi tidak di Borg!  Yaitu: WebUI atau semacam tempat terpusat untuk mengonfigurasi cadangan.  Dan kami sangat berharap ini adalah fenomena sementara, tetapi sejauh ini kami harus menyelesaikan sesuatu.  Menelusuri alat-alat yang sudah jadi dan berkumpul di konferensi video, kami mulai berbisnis.  Ada ide bagus untuk mengintegrasikan Borg dengan layanan internal kami, seperti yang kami lakukan sebelumnya dengan Bacula (Bacula sendiri mengambil daftar pekerjaan dari API kami yang terpusat, yang mana kami memiliki antarmuka kami sendiri terintegrasi dengan pengaturan proyek lainnya).  Kami memikirkan cara melakukannya, menguraikan rencana bagaimana dan di mana membangunnya, tapi ... Cadangan normal diperlukan sekarang, tetapi tidak ada tempat untuk mengambil rencana waktu muluk.  Apa yang harus dilakukan <br><br>  Pertanyaan dan persyaratan kira-kira sebagai berikut: <br><br><ul><li>  Apa yang harus digunakan sebagai manajemen cadangan terpusat? </li><li>  Apa yang bisa dilakukan oleh administrator Linux? </li><li>  Apa yang bahkan dapat dipahami dan dikonfigurasikan oleh manajer yang menunjukkan jadwal cadangan kepada pelanggan? </li><li>  Apa yang tugas terjadwal lakukan pada sistem Anda setiap hari? </li><li>  Apa yang tidak akan sulit untuk dikonfigurasi dan tidak akan rusak? .. </li></ul><br>  Jawabannya jelas: ini adalah kain tua yang bagus, yang dengan gagah berani melakukan tugasnya setiap hari.  Sederhana  Itu tidak membeku.  Bahkan manajer yang dari Unix ke "Anda" dapat memperbaikinya. <br><br>  Jadi crontab, tapi di mana Anda menyimpan semua ini?  Apakah setiap kali pergi ke mesin proyek dan mengedit file dengan tangan Anda?  Tentu saja tidak.  Kita dapat menempatkan jadwal kita di repositori Git dan mengkonfigurasi GitLab Runner, yang dengan komit akan memperbaruinya di host. <br><br>  <i><b>Catatan</b> : GitLab yang dipilih sebagai alat otomatisasi, karena nyaman untuk tugas dan dalam kasus kami hampir di mana-mana.</i>  <i>Tetapi saya harus mengatakan bahwa dia sama sekali bukan keharusan.</i> <br><br>  Anda dapat memperluas crontab untuk cadangan dengan alat otomasi yang sudah dikenal atau umumnya secara manual (pada proyek kecil atau instalasi rumah). <br><br>  Jadi, inilah yang Anda butuhkan untuk otomatisasi sederhana: <br><br>  1. <b>GitLab dan repositori</b> , di mana untuk memulai akan ada dua file: <br><br><ul><li>  <code>schedule</code> - jadwal cadangan </li><li>  <code>borg_backup_files.sh</code> - skrip sederhana untuk membuat cadangan file (seperti pada contoh di atas). </li></ul><br>  Contoh <code>schedule</code> : <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># WARNING! CRONTAB MANAGED FROM GITLAB CI RUNNER IN ${CI_PROJECT_URL} # CI_COMMIT_SHA: ${CI_COMMIT_SHA} # Branch/tag: ${CI_COMMIT_REF_NAME} # Timestamp: ${TIMESTAMP} PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin # MyRemoteHost 0 0 * * * ${CI_PROJECT_DIR}/borg_backup_files.sh 'SYSTEM /etc,/opt'</span></span></code> </pre> <br>  Variabel CI digunakan untuk memverifikasi bahwa pembaruan crontab berhasil, dan <code>CI_PROJECT_DIR</code> adalah direktori di mana repositori akan setelah mengkloning pelari.  Baris terakhir menunjukkan bahwa pencadangan dilakukan setiap hari pada tengah malam. <br><br>  Contoh <code>borg_backup_files.sh</code> : <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash BORG_SERVER="borg@10.100.1.1" NAMEOFBACKUP=${1} DIRS=${2} REPOSITORY="${BORG_SERVER}:$(hostname)-${NAMEOFBACKUP}" borg create --list -v --stats \ $REPOSITORY::"files-{now:%Y-%m-%d_%H:%M:%S}" \ $(echo $DIRS | tr ',' ' ') || \ echo "borg create failed"</span></span></code> </pre> <br>  Argumen <i>pertama di</i> sini adalah nama cadangan, dan yang <i>kedua</i> adalah daftar direktori untuk cadangan, dipisahkan dengan koma.  Sebenarnya, daftar juga dapat berupa kumpulan file terpisah. <br><br>  2. <b>GitLab Runner</b> , berjalan pada mesin yang perlu dicadangkan, dan diblokir hanya untuk pekerjaan repositori ini. <br><br>  3. <b>Script CI itu sendiri</b> , diimplementasikan oleh file <code>.gitlab-ci.yml</code> : <br><br><pre> <code class="hljs pgsql">stages: - deploy Deploy: stage: deploy script: - export <span class="hljs-type"><span class="hljs-type">TIMESTAMP</span></span>=$(<span class="hljs-type"><span class="hljs-type">date</span></span> <span class="hljs-string"><span class="hljs-string">'+%Y.%m.%d %H:%M:%S'</span></span>) - cat schedule | envsubst | crontab - tags: - borg-backup</code> </pre> <br>  4. <b>Kunci SSH</b> untuk pengguna <code>gitlab-runner</code> dengan akses ke server <code>gitlab-runner</code> (dalam contoh, adalah 10.100.1.1).  Secara default, ini harus di direktori home <code>.ssh/id_rsa</code> ( <code>gitlab-runner</code> ). <br><br>  5. <b>Pengguna <code>borg</code></b> pada 10.100.1.1 yang sama dengan akses hanya ke perintah <code>borg serve</code> : <br><br><pre> <code class="bash hljs">$ cat .ssh/authorized_keys <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=<span class="hljs-string"><span class="hljs-string">"/usr/bin/borg serve"</span></span> ssh-rsa AAAAB3NzaC1yc2EAA...</code> </pre> <br>  Sekarang, ketika Anda komit ke repositori Runner, itu akan mengisi konten crontab.  Dan ketika waktu respons cron tiba, cadangan dari direktori <code>/etc</code> dan <code>/opt</code> akan dilakukan, yang akan berada di server cadangan di direktori <code>MyHostname-SYSTEM</code> server 10.100.1.1. <br><br><img src="https://habrastorage.org/webt/ud/n7/wb/udn7wbd4vqknfq6cguw5wmi7tcq.png"><br><br><h2>  Alih-alih kesimpulan: apa lagi yang bisa Anda lakukan? </h2><br>  Penggunaan Borg pada ini, tentu saja, tidak berakhir di sana.  Berikut adalah beberapa ide untuk implementasi lebih lanjut, beberapa di antaranya telah kami terapkan di rumah: <br><br><ul><li>  <b>Tambahkan skrip universal</b> untuk cadangan berbeda, yang pada akhir eksekusi dijalankan <code>borg_backup_files.sh</code> , ditujukan pada direktori dengan hasil pekerjaan mereka.  Misalnya, Anda dapat mencadangkan PostgreSQL (pg_basebackup), MySQL (innobackupex), GitLab (pekerjaan menyapu bawaan, membuat arsip). </li><li>  <b>Tuan rumah pusat dengan <i>jadwal</i> untuk cadangan</b> .  Tidak mengkonfigurasi pada setiap host GitLab Runner?  Biarkan saja di server cadangan, dan crontab saat startup mentransfer skrip cadangan ke mesin dan menjalankannya di sana.  Untuk ini, tentu saja, Anda akan memerlukan pengguna <code>borg</code> di mesin klien dan <code>ssh-agent</code> , agar tidak meletakkan kunci ke server cadangan di setiap mesin. </li><li>  <b>Pemantauan</b>  Di mana tanpa dia!  Lansiran tentang cadangan yang salah diselesaikan harus. </li><li>  <b>Membersihkan repositori borg dari arsip lama.</b>  Meskipun ada deduplikasi yang baik, backup lama masih harus dibersihkan.  Untuk melakukan ini, Anda dapat melakukan panggilan ke <code>borg prune</code> di akhir skrip cadangan. </li><li>  <b>Antarmuka web</b> dengan jadwal.  Ini akan berguna jika mengedit crontab dengan tangan atau di antarmuka web tidak terlihat solid / tidak nyaman untuk Anda. </li><li>  <b>Pie chart</b> .  Beberapa grafik untuk representasi visual dari persentase cadangan yang berhasil diselesaikan, waktu pelaksanaannya, lebar saluran "yang dimakan".  Tidak heran saya menulis bahwa tidak ada cukup WebUI, seperti di Bareos ... </li><li>  <b>Tindakan sederhana</b> yang ingin saya terima dengan tombol: meluncurkan cadangan sesuai permintaan, memulihkan ke mesin, dll. </li></ul><br>  Dan pada akhirnya, saya ingin menambahkan contoh efektivitas deduplikasi pada cadangan kerja nyata file-file WAL PostgreSQL dalam lingkungan produksi: <br><br><pre> <code class="bash hljs">borg@backup ~ $ borg info PROJECT-PG-WAL Repository ID: 177eeb28056a60487bdfce96cfb33af1c186cb2a337226bc3d5380a78a6aeeb6 Location: /mnt/borg/PROJECT-PG-WAL Encrypted: No Cache: /mnt/borg/.cache/borg/177eeb28056a60487bdfce96cfb33af1c186cb2a337226bc3d5380a78a6aeeb6 Security dir: /mnt/borg/.config/borg/security/177eeb28056a60487bdfce96cfb33af1c186cb2a337226bc3d5380a78a6aeeb6 ------------------------------------------------------------------------------ Original size Compressed size Deduplicated size All archives: 6.68 TB 6.70 TB 19.74 GB Unique chunks Total chunks Chunk index: 11708 3230099</code> </pre> <br>  Ini adalah 65 hari cadangan file WAL yang dilakukan setiap jam.  Saat menggunakan Bacula / Bareos, mis.  tanpa deduplikasi, kami akan mendapatkan 6,7 TB data.  Bayangkan saja: kita mampu menyimpan hampir 7 terabyte data yang dilewatkan melalui PostgreSQL, hanya 20 GB ruang yang benar-benar terisi. <br><br><h2>  PS </h2><br>  Baca juga di blog kami: <br><br><ul><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Teori dan praktik peningkatan tanpa pengawasan di Ubuntu</a> "; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Junior, yang pada hari pertama bekerja menghapus database dari produksi</a> "; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Mempercepat bootstrap dari database besar dengan Kubernetes</a> ." </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id420055/">https://habr.com/ru/post/id420055/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id420041/index.html">Perang TypeScript atau Enum Conquest</a></li>
<li><a href="../id420045/index.html">Bunker untuk tanggal: bagaimana saya diizinkan berjalan di sekitar pusat data RUVDS di wilayah pabrik luar angkasa</a></li>
<li><a href="../id420049/index.html">Buku "Pria itu sedang berbicara. Evolusi dan Bahasa</a></li>
<li><a href="../id420051/index.html">[DotNetBook] Rentang, Memori, dan ReadOnlyMemory</a></li>
<li><a href="../id420053/index.html">Veeam Academy untuk Pengembang C #: Musim Baru</a></li>
<li><a href="../id420057/index.html">8 aturan untuk freelancer yang sukses</a></li>
<li><a href="../id420059/index.html">Sekarang saya adalah pemimpin tim, tetapi mengapa saya begitu sakit? Kiat praktis</a></li>
<li><a href="../id420061/index.html">Kami mengevaluasi proses dalam tim pengembangan berdasarkan pada data objektif</a></li>
<li><a href="../id420063/index.html">"Saint" Timlid dan para pengikutnya</a></li>
<li><a href="../id420065/index.html">Komunikasi sebagai zona kinerja kerja tim</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>