<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§öüèΩ üíõ ‚õ≤Ô∏è Teor√≠a y pr√°ctica de copias de seguridad con Borg üíë üëãüèº üññüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Para nuestra gran sorpresa, no hab√≠a una sola pieza de material sobre la maravillosa herramienta de c√≥digo abierto para la copia de seguridad de datos...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Teor√≠a y pr√°ctica de copias de seguridad con Borg</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/420055/"><img src="https://habrastorage.org/webt/xx/7w/tn/xx7wtnr5mv7mjndz-uzowsql58o.png"><br><br>  Para nuestra gran sorpresa, no hab√≠a una sola pieza de material sobre la maravillosa herramienta de c√≥digo abierto para la copia de seguridad de datos: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Borg</a> <i>(¬°no debe confundirse con el progenitor del mismo nombre Kubernetes!)</i> .  Como lo hemos estado utilizando en producci√≥n durante m√°s de un a√±o, en este art√≠culo compartir√© las "impresiones" que hemos obtenido sobre Borg. <a name="habracut"></a><br><br><h2>  Antecedentes: experiencia con Bacula y Bareos </h2><br>  En 2017, est√°bamos cansados ‚Äã‚Äãde Bacula y Bareos, que utilizamos desde el comienzo de nuestra actividad (es decir, alrededor de 9 a√±os en producci√≥n en ese momento).  Por qu√©  Durante la operaci√≥n, hemos acumulado mucho descontento: <br><br><ul><li>  SD (Storage Daemon) se congela.  Si ha configurado el paralelismo, el mantenimiento de SD se vuelve m√°s complicado y su congelaci√≥n bloquear√° m√°s copias de seguridad seg√∫n lo programado y la posibilidad de recuperaci√≥n. </li><li>  Es necesario generar configuraciones tanto para el cliente como para el director.  Incluso si automatizamos esto (en nuestro caso, Chef, Ansible, y nuestro propio desarrollo se usaron en diferentes momentos), necesitamos monitorear que el director, despu√©s de su <i>recarga,</i> realmente recogi√≥ la configuraci√≥n.  Esto solo se rastrea en la salida del comando de <i>recarga</i> y en la llamada de <i>mensajes</i> despu√©s (para obtener el texto de error en s√≠). </li><li>  Programar copias de seguridad.  Los desarrolladores de Bacula decidieron seguir su propio camino y escribieron su propio formato de programaci√≥n, que no se puede analizar o convertir a otro.  Aqu√≠ hay ejemplos de programaciones de respaldo est√°ndar en nuestras antiguas instalaciones: <ul><li>  Copia de seguridad completa diaria los mi√©rcoles e incremental en otros d√≠as: <br> <code>Run = Level=Full Pool="Foobar-low7" wed at 18:00 <br> Run = Level=Incremental Pool="Foobar-low7" at 18:00</code> </li> <li>  Copia de seguridad completa de archivos wal 2 veces al mes e incremente cada hora: <br> <code>Run = Level=Full FullPool=CustomerWALPool 1st fri at 01:45 <br> Run = Level=Full FullPool=CustomerWALPool 3rd fri at 01:45 <br> Run = Level=Incremental FullPool=CustomerWALPool IncrementalPool=CustomerWALPool on hourly</code> </li> <li>  El <code>schedule</code> generado para todas las ocasiones (en diferentes d√≠as de la semana cada 2 horas) obtuvimos alrededor de 1665 ... debido a lo que Bacula / Bareos peri√≥dicamente se volv√≠a loco. </li></ul></li><li>  Bacula-fd (y bareos-fd) tienen directorios con muchos datos (digamos 40 TB, de los cuales 35 TB contienen archivos grandes [100+ MB], y los 5 TB restantes contienen archivos peque√±os [1 KB a 100 MB ]) comienza una p√©rdida lenta de memoria, que es una situaci√≥n muy desagradable en la producci√≥n. <br><br><img src="https://habrastorage.org/webt/eu/33/ao/eu33aocunyesaxcwtlyzzim_eha.png"></li><li>  En las copias de seguridad con una gran cantidad de archivos, Bacula y Bareos dependen mucho del rendimiento del DBMS utilizado.  ¬øQu√© unidades tiene?  ¬øCu√°n h√°bilmente sabes c√≥mo sintonizarla con estas necesidades espec√≠ficas?  Y en la base de datos, por cierto, se crea una (!) Tabla no particionable con una lista de todos los archivos en todas las copias de seguridad y la segunda, con una lista de todas las rutas en todas las copias de seguridad.  Si no est√° listo para asignar al menos 8 GB de RAM para la base + 40 GB de SSD para su servidor de respaldo, prep√°rese inmediatamente para los frenos. </li><li>  La dependencia de la base de datos merece un punto m√°s.  Bacula / Bareos para cada archivo le pregunta al director si ya exist√≠a dicho archivo.  El director, por supuesto, se arrastra a la base de datos, a esas tablas muy grandes ... Resulta que la copia de seguridad se puede bloquear simplemente por el hecho de que varias copias de seguridad pesadas comenzaron al mismo tiempo, incluso si la diferencia es de varios megabytes all√≠. </li></ul><br><img src="https://habrastorage.org/webt/nh/iw/dz/nhiwdzn69dvunjisjzcwcy1fyna.png"><br><br>  Ser√≠a injusto decir que no se resolvi√≥ ning√∫n problema, pero llegamos al punto en el que est√°bamos realmente cansados ‚Äã‚Äãde varias soluciones y quer√≠amos una soluci√≥n confiable "aqu√≠ y ahora". <br><br>  Bacula / Bareos funcionan muy bien con un peque√±o n√∫mero (10-30) de trabajos uniformes.  ¬øSe rompi√≥ una cosita una vez a la semana?  Est√° bien: le dieron la tarea al oficial de servicio (u otro ingeniero), la repararon.  Sin embargo, tenemos proyectos en los que la cantidad de trabajos es de cientos y la cantidad de archivos en ellos es de cientos de miles.  Como resultado, 5 minutos a la semana para arreglar la copia de seguridad (sin contar varias horas de configuraci√≥n antes de esto) comenzaron a multiplicarse.  Todo esto condujo al hecho de que 2 horas al d√≠a era necesario reparar las copias de seguridad en todos los proyectos, porque literalmente en todas partes algo estaba jugando o rompiendo seriamente. <br><br>  Entonces alguien podr√≠a pensar que un ingeniero dedicado dedicado a esto deber√≠a hacer copias de seguridad.  Ciertamente, ser√° lo m√°s barbudo y severo posible, y por su aspecto, las copias de seguridad se reparan al instante, mientras bebe caf√© con calma.  Y esta idea puede ser cierta de alguna manera ... Pero siempre hay un pero.  No todos pueden permitirse reparar y monitorear las copias de seguridad las 24 horas, y a√∫n m√°s: un ingeniero asignado para estos fines.  Estamos seguros de que es mejor pasar estas 2 horas al d√≠a en algo m√°s productivo y √∫til.  Por lo tanto, pasamos a la b√∫squeda de soluciones alternativas que "simplemente funcionan". <br><br><h2>  Borg como una nueva forma </h2><br>  La b√∫squeda de otras opciones de c√≥digo abierto se extendi√≥ a lo largo del tiempo, por lo que es dif√≠cil estimar los costos totales, pero en un momento (el a√±o pasado), nuestra atenci√≥n se dirigi√≥ al " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">h√©roe de la</a> ocasi√≥n": <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">BorgBackup</a> (o simplemente Borg).  En parte, esto fue facilitado por la experiencia real de su uso por uno de nuestros ingenieros (en el lugar de trabajo anterior). <br><br>  Borg est√° escrito en Python (se requiere la versi√≥n&gt; = 3.4.0), y el c√≥digo exigente de rendimiento (compresi√≥n, cifrado, etc.) se implementa en C / Cython.  Distribuido bajo una licencia BSD gratuita (3 cl√°usulas).  Admite muchas plataformas, incluidas Linux, * BSD, macOS, as√≠ como a nivel experimental Cygwin y Linux Subsystem de Windows 10. Para instalar BorgBackup, hay paquetes disponibles para distribuciones populares de Linux y otros sistemas operativos, as√≠ como c√≥digos fuente, que tambi√©n se pueden instalar a trav√©s de pip, - Se puede encontrar informaci√≥n m√°s detallada sobre esto en la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">documentaci√≥n del proyecto</a> . <br><br>  ¬øPor qu√© Borg nos soborn√≥ tanto?  Estas son sus principales ventajas: <br><br><ul><li>  <b>Deduplicaci√≥n</b> : real y muy efectiva (ejemplos a continuaci√≥n).  Los archivos dentro de un solo repositorio Borg (es decir, un directorio especial en un formato espec√≠fico de Borg) se dividen en bloques de n megabytes, y los bloques Borg que se repiten se deduplican.  La deduplicaci√≥n ocurre precisamente antes de la compresi√≥n. </li><li>  <b>Compresi√≥n</b> : despu√©s de la deduplicaci√≥n, los datos tambi√©n se comprimen.  Hay diferentes algoritmos de compresi√≥n disponibles: lz4, lzma, zlib, zstd.  La caracter√≠stica est√°ndar de cualquier copia de seguridad, pero esto no es menos √∫til. </li><li>  <b>Trabajar en SSH</b> : Borg realiza copias de seguridad en un servidor remoto a trav√©s de SSH.  En el lado del servidor, solo necesita instalar Borg y listo.  A partir de aqu√≠, siguen ventajas como la seguridad y el cifrado.  Puede configurar el acceso solo con teclas y, adem√°s, la ejecuci√≥n de Borg de solo uno de sus comandos al ingresar al servidor.  Por ejemplo, as√≠: <br><br><pre> <code class="bash hljs">$ cat .ssh/authorized_keys <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=<span class="hljs-string"><span class="hljs-string">"/usr/bin/borg serve"</span></span> ssh-rsa AAAAB3NzaC1yc‚Ä¶</code> </pre> </li><li>  Se entrega tanto en PPA (principalmente utilizamos Ubuntu) como en un <b>binario est√°tico</b> .  Borg en forma de binario est√°tico hace posible ejecutarlo en casi todas partes donde hay al menos un glibc m√≠nimamente moderno.  (Pero no en todas partes, por ejemplo, no fue posible comenzar en CentOS 5). </li><li>  <b>Limpieza</b> flexible <b>de copias de seguridad antiguas</b> .  Puede configurar el almacenamiento de las √∫ltimas n copias de seguridad y 2 copias de seguridad por hora / d√≠a / semana.  En este √∫ltimo caso, quedar√° la √∫ltima copia de seguridad al final de la semana.  Las condiciones se pueden combinar almacenando 7 copias de seguridad diarias durante los √∫ltimos 7 d√≠as y 4 copias de seguridad semanales. </li></ul><br>  La transici√≥n a Borg comenz√≥ lentamente en peque√±os proyectos.  Al principio, estos eran simples scripts cron que hac√≠an su trabajo todos los d√≠as.  Esto continu√≥ durante unos seis meses.  Durante este tiempo, tuvimos que obtener copias de seguridad muchas veces ... ¬°y result√≥ que Borg no ten√≠a que ser reparado literalmente!  Por qu√©  Porque el principio simple funciona aqu√≠: "Cuanto m√°s simple sea el mecanismo, menos lugares se romper√°". <br><br><h2>  Pr√°ctica: ¬øc√≥mo hacer una copia de seguridad con Borg? </h2><br>  Considere un ejemplo simple de crear una copia de seguridad: <br><br><ol><li>  Descargue el √∫ltimo binario de lanzamiento en el servidor de respaldo y en la m√°quina que respaldaremos desde el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">repositorio oficial</a> : <br><br><pre> <code class="bash hljs">sudo wget https://github.com/borgbackup/borg/releases/download/1.1.6/borg-linux64 -O /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/borg sudo chmod +x /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/borg</code> </pre> <br>  <i><b>Nota</b> : Si utiliza una m√°quina local para la prueba como fuente y como receptor, la diferencia completa solo estar√° en el URI, que transmitiremos, pero recordamos que la copia de seguridad debe almacenarse por separado, y no en la misma m√°quina.</i> </li><li>  En el servidor de respaldo, cree el usuario <code>borg</code> : <br><br><pre> <code class="bash hljs">sudo useradd -m borg</code> </pre> <br>  Simple: sin grupos y con un shell est√°ndar, pero siempre con un directorio de inicio. </li><li>  Se genera una clave SSH en el cliente: <br><br><pre> <code class="bash hljs">ssh-keygen</code> </pre> </li><li>  En el servidor, agregue la clave generada al usuario <code>borg</code> : <br><br><pre> <code class="bash hljs">mkdir ~borg/.ssh <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'command="/usr/local/bin/borg serve" ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDNdaDfqUUf/XmSVWfF7PfjGlbKW00MJ63zal/E/mxm+vJIJRBw7GZofe1PeTpKcEUTiBBEsW9XUmTctnWE6p21gU/JNU0jITLx+vg4IlVP62cac71tkx1VJFMYQN6EulT0alYxagNwEs7s5cBlykeKk/QmteOOclzx684t9d6BhMvFE9w9r+c76aVBIdbEyrkloiYd+vzt79nRkFE4CoxkpvptMgrAgbx563fRmNSPH8H5dEad44/Xb5uARiYhdlIl45QuNSpAdcOadp46ftDeQCGLc4CgjMxessam+9ujYcUCjhFDNOoEa4YxVhXF9Tcv8Ttxolece6y+IQM7fbDR'</span></span> &gt; ~borg/.ssh/authorized_keys chown -R borg:borg ~borg/.ssh</code> / bin locales / Borg servir" ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDNdaDfqUUf / XmSVWfF7PfjGlbKW00MJ63zal / E / MXM + vJIJRBw7GZofe1PeTpKcEUTiBBEsW9XUmTctnWE6p21gU / JNU0jITLx + vg4IlVP62cac71tkx1VJFMYQN6EulT0alYxagNwEs7s5cBlykeKk / QmteOOclzx684t9d6BhMvFE9w9r + + c76aVBIdbEyrkloiYd vzt79nRkFE4CoxkpvptMgrAgbx563fRmNSPH8H5dEad44 / Xb5uARiYhdlIl45QuNSpAdcOadp46ftDeQCGLc4CgjMxessam + + 9ujYcUCjhFDNOoEa4YxVhXF9Tcv8Ttxolece6y IQM7fbDR'&gt; ~ Borg / .ssh <code class="bash hljs">mkdir ~borg/.ssh <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'command="/usr/local/bin/borg serve" ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDNdaDfqUUf/XmSVWfF7PfjGlbKW00MJ63zal/E/mxm+vJIJRBw7GZofe1PeTpKcEUTiBBEsW9XUmTctnWE6p21gU/JNU0jITLx+vg4IlVP62cac71tkx1VJFMYQN6EulT0alYxagNwEs7s5cBlykeKk/QmteOOclzx684t9d6BhMvFE9w9r+c76aVBIdbEyrkloiYd+vzt79nRkFE4CoxkpvptMgrAgbx563fRmNSPH8H5dEad44/Xb5uARiYhdlIl45QuNSpAdcOadp46ftDeQCGLc4CgjMxessam+9ujYcUCjhFDNOoEa4YxVhXF9Tcv8Ttxolece6y+IQM7fbDR'</span></span> &gt; ~borg/.ssh/authorized_keys chown -R borg:borg ~borg/.ssh</code> </pre> </li><li>  Inicializamos el <i>repositorio borg</i> en el servidor desde el cliente: <br><br><pre> <code class="bash hljs">ssh borg@172.17.0.3 hostname <span class="hljs-comment"><span class="hljs-comment">#     borg init -e none borg@172.17.0.3:MyBorgRepo</span></span></code> </pre> <br>  El <code>-e</code> se usa para seleccionar el m√©todo de cifrado para el repositorio (s√≠, ¬°tambi√©n puede cifrar cada repositorio con su contrase√±a!).  En este caso, porque  Este es un ejemplo, no utilizamos cifrado.  <code>MyBorgRepo</code> es el nombre del directorio en el que estar√° el <i>borg repo</i> (no es necesario crearlo de antemano; Borg har√° todo por s√≠ mismo). </li><li>  Inicie la primera copia de seguridad con Borg: <br><br><pre> <code class="bash hljs">borg create --stats --list borg@172.17.0.3:MyBorgRepo::<span class="hljs-string"><span class="hljs-string">"MyFirstBackup-{now:%Y-%m-%d_%H:%M:%S}"</span></span> /etc /root</code> </pre> <br>  Sobre las llaves: <br><ul><li>  <code>--stats</code> y <code>--list</code> nos dan estad√≠sticas sobre la copia de seguridad y los archivos que ingresaron; </li><li>  <code>borg@172.17.0.3:MyBorgRepo</code> todo est√° claro, este es nuestro servidor y directorio.  ¬øY qu√© sigue para la magia? .. </li><li>  <code>::"MyFirstBackup-{now:%Y-%m-%d_%H:%M:%S}"</code> es el nombre del archivo dentro del repositorio.  Es arbitrario, pero cumplimos con el formato <code>_-timestamp</code> (marca de tiempo en formato Python). </li></ul></li></ol><br>  Que sigue  ¬°Por supuesto, mira lo que hay en nuestro respaldo!  Lista de archivos dentro del repositorio: <br><br><pre> <code class="bash hljs">borg@b3e51b9ed2c2:~$ borg list MyBorgRepo/ Warning: Attempting to access a previously unknown unencrypted repository! Do you want to <span class="hljs-built_in"><span class="hljs-built_in">continue</span></span>? [yN] y MyFirstBackup-2018-08-04_16:55:53 Sat, 2018-08-04 16:55:54 [89f7b5bccfb1ed2d72c8b84b1baf477a8220955c72e7fcf0ecc6cd5a9943d78d]</code> </pre> <br>  Vemos una copia de seguridad con una marca de tiempo y c√≥mo Borg nos pregunta si realmente queremos acceder a un repositorio sin cifrar al que nunca hemos estado antes. <br><br>  Nos fijamos en la lista de archivos: <br><br><pre> <code class="bash hljs">borg list MyBorgRepo::MyFirstBackup-2018-08-04_16:55:53</code> </pre> <br>  Obtenemos el archivo de la copia de seguridad (tambi√©n puede hacer todo el directorio): <br><br><pre> <code class="bash hljs">borg@b3e51b9ed2c2:~$ borg extract MyBorgRepo::MyFirstBackup-2018-08-04_16:55:53 etc/hostname borg@b3e51b9ed2c2:~$ ll etc/hostname -rw-r--r-- 1 borg borg 13 Aug 4 16:27 etc/hostname</code> </pre> <br>  ¬°Felicitaciones, su primera copia de seguridad Borg est√° lista! <br><br><h2>  Pr√°ctica: ¬°automatiza esto [con GitLab]! </h2><br>  Habiendo envuelto todo esto en scripts, configuramos manualmente las copias de seguridad de manera similar en aproximadamente 40 hosts.  Al darse cuenta de que Borg realmente funciona, comenzaron a transferirle proyectos cada vez m√°s grandes ... <br><br>  ¬°Y aqu√≠ nos enfrentamos con lo que hay en Bareos, pero no en Borg!  A saber: WebUI o alg√∫n tipo de lugar centralizado para configurar copias de seguridad.  Y realmente esperamos que este sea un fen√≥meno temporal, pero hasta ahora tuvimos que resolver algo.  Buscando en Google las herramientas terminadas y reuni√©ndonos en una video conferencia, nos pusimos manos a la obra.  Fue una gran idea integrar Borg con nuestros servicios internos, como lo hicimos antes con Bacula (Bacula misma elimin√≥ la lista de trabajos de nuestra API centralizada, a la que ten√≠amos nuestra propia interfaz integrada con otras configuraciones del proyecto).  Pensamos en c√≥mo hacerlo, describimos un plan de c√≥mo y d√≥nde construirlo, pero ... Ahora se necesitan copias de seguridad normales, pero no hay lugares para tomar planes de tiempo grandiosos.  Que hacer <br><br>  Las preguntas y los requisitos fueron aproximadamente los siguientes: <br><br><ul><li>  ¬øQu√© usar como gesti√≥n centralizada de copias de seguridad? </li><li>  ¬øQu√© puede hacer cualquier administrador de Linux? </li><li>  ¬øQu√© puede incluso entender y configurar un gerente que muestra un cronograma de respaldo a los clientes? </li><li>  ¬øQu√© hace una tarea programada en su sistema todos los d√≠as? </li><li>  ¬øQu√© no ser√° dif√≠cil de configurar y no se romper√°? </li></ul><br>  La respuesta fue obvia: este es el viejo amigo, que heroicamente cumple con su deber todos los d√≠as.  Simple  No se congela.  Incluso el administrador que es de Unix a "usted" puede arreglarlo. <br><br>  Entonces crontab, pero ¬ød√≥nde guardas todo esto?  ¬øEs cada vez que va a la m√°quina del proyecto y edita el archivo con las manos?  Por supuesto que no.  Podemos poner nuestro horario en el repositorio de Git y configurar GitLab Runner, que mediante commit lo actualizar√° en el host. <br><br>  <i><b>Nota</b> : Fue GitLab el que se eligi√≥ como herramienta de automatizaci√≥n, porque es conveniente para la tarea y en nuestro caso est√° en casi todas partes.</i>  <i>Pero debo decir que de ninguna manera es una necesidad.</i> <br><br>  Puede expandir crontab para copias de seguridad mediante una herramienta de automatizaci√≥n familiar o generalmente de forma manual (en proyectos peque√±os o instalaciones dom√©sticas). <br><br>  Entonces, esto es lo que necesita para una automatizaci√≥n simple: <br><br>  1. <b>GitLab y un repositorio</b> , en el que, para empezar, habr√° dos archivos: <br><br><ul><li>  <code>schedule</code> - horario de respaldo </li><li>  <code>borg_backup_files.sh</code> : un script simple para hacer una copia de seguridad de los archivos (como en el ejemplo anterior). </li></ul><br>  Ejemplo de <code>schedule</code> : <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># WARNING! CRONTAB MANAGED FROM GITLAB CI RUNNER IN ${CI_PROJECT_URL} # CI_COMMIT_SHA: ${CI_COMMIT_SHA} # Branch/tag: ${CI_COMMIT_REF_NAME} # Timestamp: ${TIMESTAMP} PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin # MyRemoteHost 0 0 * * * ${CI_PROJECT_DIR}/borg_backup_files.sh 'SYSTEM /etc,/opt'</span></span></code> </pre> <br>  Las variables de CI se usan para verificar que la actualizaci√≥n de crontab fue exitosa, y <code>CI_PROJECT_DIR</code> es el directorio en el que estar√° el repositorio despu√©s de clonar el corredor.  La √∫ltima l√≠nea indica que la copia de seguridad se realiza todos los d√≠as a medianoche. <br><br>  Ejemplo <code>borg_backup_files.sh</code> : <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash BORG_SERVER="borg@10.100.1.1" NAMEOFBACKUP=${1} DIRS=${2} REPOSITORY="${BORG_SERVER}:$(hostname)-${NAMEOFBACKUP}" borg create --list -v --stats \ $REPOSITORY::"files-{now:%Y-%m-%d_%H:%M:%S}" \ $(echo $DIRS | tr ',' ' ') || \ echo "borg create failed"</span></span></code> </pre> <br>  <i>El primer</i> argumento aqu√≠ es el nombre de la copia de seguridad, y el <i>segundo</i> es la lista de directorios para la copia de seguridad, separados por comas.  Estrictamente hablando, una lista tambi√©n puede ser un conjunto de archivos separados. <br><br>  2. <b>GitLab Runner</b> , que se ejecuta en la m√°quina que necesita una copia de seguridad y se bloquea solo para los trabajos de este repositorio. <br><br>  3. <b>El script de CI en s√≠</b> , implementado por el <code>.gitlab-ci.yml</code> : <br><br><pre> <code class="hljs pgsql">stages: - deploy Deploy: stage: deploy script: - export <span class="hljs-type"><span class="hljs-type">TIMESTAMP</span></span>=$(<span class="hljs-type"><span class="hljs-type">date</span></span> <span class="hljs-string"><span class="hljs-string">'+%Y.%m.%d %H:%M:%S'</span></span>) - cat schedule | envsubst | crontab - tags: - borg-backup</code> </pre> <br>  4. La <b>clave SSH</b> para el usuario <code>gitlab-runner</code> con acceso al servidor de <code>gitlab-runner</code> (en el ejemplo, es 10.100.1.1).  Por defecto, debe estar en el <code>.ssh/id_rsa</code> ( <code>gitlab-runner</code> ). <br><br>  5. <b>El usuario <code>borg</code></b> en el mismo 10.100.1.1 con acceso solo al comando <code>borg serve</code> : <br><br><pre> <code class="bash hljs">$ cat .ssh/authorized_keys <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=<span class="hljs-string"><span class="hljs-string">"/usr/bin/borg serve"</span></span> ssh-rsa AAAAB3NzaC1yc2EAA...</code> </pre> <br>  Ahora, cuando se compromete con el repositorio Runner, rellenar√° el contenido de crontab.  Y cuando llegue el tiempo de respuesta del cron, se realizar√° una copia de seguridad de los directorios <code>/etc</code> y <code>/opt</code> , que estar√° en el servidor de copia de seguridad en el directorio <code>MyHostname-SYSTEM</code> del servidor 10.100.1.1. <br><br><img src="https://habrastorage.org/webt/ud/n7/wb/udn7wbd4vqknfq6cguw5wmi7tcq.png"><br><br><h2>  En lugar de una conclusi√≥n: ¬øqu√© m√°s puedes hacer? </h2><br>  El uso de Borg en esto, por supuesto, no termina ah√≠.  Aqu√≠ hay algunas ideas para una mayor implementaci√≥n, algunas de las cuales ya hemos implementado en casa: <br><br><ul><li>  <b>Agregue scripts universales</b> para diferentes copias de seguridad, que al final de la ejecuci√≥n ejecutan <code>borg_backup_files.sh</code> , dirigidas al directorio con el resultado de su trabajo.  Por ejemplo, puede hacer una copia de seguridad de PostgreSQL (pg_basebackup), MySQL (innobackupex), GitLab (trabajo de rastrillo incorporado, crear un archivo). </li><li>  <b>Host central con <i>horario</i> de respaldo</b> .  ¬øNo configurar en cada host GitLab Runner?  Deje que est√© solo en el servidor de respaldo, y crontab al inicio transfiere el script de respaldo a la m√°quina y lo ejecuta all√≠.  Para esto, por supuesto, necesitar√° el usuario <code>borg</code> en la m√°quina del cliente y <code>ssh-agent</code> , para no dise√±ar la clave del servidor de respaldo en cada m√°quina. </li><li>  <b>Monitoreo</b>  Donde sin el!  Las alertas sobre una copia de seguridad completada incorrectamente deben ser. </li><li>  <b>Borrando el repositorio borg de archivos antiguos.</b>  A pesar de una buena deduplicaci√≥n, las copias de seguridad antiguas a√∫n deben limpiarse.  Para hacer esto, puede hacer una llamada para <code>borg prune</code> las <code>borg prune</code> al final del script de copia de seguridad. </li><li>  <b>Interfaz web</b> para el horario.  Te resultar√° √∫til si editar crontab a mano o en la interfaz web no te parece s√≥lido / inc√≥modo. </li><li>  <b>Gr√°ficos circulares</b>  Unos gr√°ficos para una representaci√≥n visual del porcentaje de copias de seguridad completadas con √©xito, su tiempo de ejecuci√≥n, el ancho del canal "comido".  No es de extra√±ar que escrib√≠ que no hay suficiente WebUI, como en Bareos ... </li><li>  <b>Acciones simples</b> que me gustar√≠a recibir mediante un bot√≥n: iniciar una copia de seguridad a pedido, restaurar en una m√°quina, etc. </li></ul><br>  Y al final, me gustar√≠a agregar un ejemplo de la efectividad de la deduplicaci√≥n en una copia de seguridad real de los archivos WAL de PostgreSQL en un entorno de producci√≥n: <br><br><pre> <code class="bash hljs">borg@backup ~ $ borg info PROJECT-PG-WAL Repository ID: 177eeb28056a60487bdfce96cfb33af1c186cb2a337226bc3d5380a78a6aeeb6 Location: /mnt/borg/PROJECT-PG-WAL Encrypted: No Cache: /mnt/borg/.cache/borg/177eeb28056a60487bdfce96cfb33af1c186cb2a337226bc3d5380a78a6aeeb6 Security dir: /mnt/borg/.config/borg/security/177eeb28056a60487bdfce96cfb33af1c186cb2a337226bc3d5380a78a6aeeb6 ------------------------------------------------------------------------------ Original size Compressed size Deduplicated size All archives: 6.68 TB 6.70 TB 19.74 GB Unique chunks Total chunks Chunk index: 11708 3230099</code> </pre> <br>  Estos son 65 d√≠as de respaldo de los archivos WAL que se realizan cada hora.  Al usar Bacula / Bareos, es decir  sin deduplicaci√≥n, obtendr√≠amos 6,7 TB de datos.  Solo piense: podemos permitirnos almacenar casi 7 terabytes de datos pasados ‚Äã‚Äãa trav√©s de PostgreSQL, solo 20 GB de espacio realmente ocupado. <br><br><h2>  PS </h2><br>  Lea tambi√©n en nuestro blog: <br><br><ul><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Teor√≠a y pr√°ctica de actualizaciones desatendidas en Ubuntu</a> "; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Junior, que el primer d√≠a de trabajo elimin√≥ la base de datos de la producci√≥n</a> "; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Acelerar el arranque de grandes bases de datos con Kubernetes</a> ". </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es420055/">https://habr.com/ru/post/es420055/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es420041/index.html">TypeScript War o Enum Conquest</a></li>
<li><a href="../es420045/index.html">Bunker para la fecha: c√≥mo se me permiti√≥ caminar por el centro de datos RUVDS en el territorio de la planta espacial</a></li>
<li><a href="../es420049/index.html">El libro "El hombre est√° hablando. Evoluci√≥n y lenguaje</a></li>
<li><a href="../es420051/index.html">[DotNetBook] Span, Memory y ReadOnlyMemory</a></li>
<li><a href="../es420053/index.html">Veeam Academy para desarrolladores de C #: nueva temporada</a></li>
<li><a href="../es420057/index.html">8 reglas para un profesional independiente exitoso</a></li>
<li><a href="../es420059/index.html">Ahora soy un l√≠der de equipo, pero ¬øpor qu√© estoy tan enfermo? Consejos pr√°cticos</a></li>
<li><a href="../es420061/index.html">Evaluamos los procesos en el equipo de desarrollo basados ‚Äã‚Äãen datos objetivos.</a></li>
<li><a href="../es420063/index.html">"San" Timlid y sus seguidores</a></li>
<li><a href="../es420065/index.html">La comunicaci√≥n como zona de actuaci√≥n del trabajo en equipo.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>