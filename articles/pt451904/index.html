<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíç üßóüèø üë∑ √Äs vezes, mais √© menos. Quando uma diminui√ß√£o na carga leva a um aumento no atraso ‚óæÔ∏è üåï üíÖüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Como na maioria das postagens , houve um problema com um servi√ßo distribu√≠do, vamos chamar esse servi√ßo de Alvin. Dessa vez eu n√£o encontrei o problem...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>√Äs vezes, mais √© menos. Quando uma diminui√ß√£o na carga leva a um aumento no atraso</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/451904/"> Como na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">maioria das postagens</a> , houve um problema com um servi√ßo distribu√≠do, vamos chamar esse servi√ßo de Alvin.  Dessa vez eu n√£o encontrei o problema, informaram os caras da parte do cliente. <br><br>  Certa vez, acordei de uma carta descontente devido aos grandes atrasos de Alvin, que planej√°vamos lan√ßar em um futuro pr√≥ximo.  Em particular, o cliente encontrou um atraso do 99¬∫ percentil em torno de 50 ms, muito acima do nosso or√ßamento de atraso.  Isso foi surpreendente, pois testei minuciosamente o servi√ßo, principalmente por atrasos, porque esse √© o assunto de queixas frequentes. <br><br>  Antes de testar o Alvin, realizei muitas experi√™ncias com 40 mil solicita√ß√µes por segundo (QPS), todas com atraso inferior a 10 ms.  Eu estava pronto para declarar que n√£o estava de acordo com os resultados deles.  Mas, mais uma vez, olhando para a carta, chamei a aten√ß√£o para algo novo: eu definitivamente n√£o testei as condi√ß√µes que eles mencionaram, o QPS deles era muito menor que o meu.  Eu testei em 40k QPS, e eles apenas em 1k.  Fiz outro experimento, desta vez com QPS menor, apenas para agrad√°-los. <br><a name="habracut"></a><br>  Desde que escrevi sobre isso no meu blog, voc√™ provavelmente j√° entendeu: os n√∫meros deles estavam corretos.  Testei meu cliente virtual repetidamente, tudo com o mesmo resultado: um n√∫mero baixo de solicita√ß√µes n√£o apenas aumenta o atraso, mas tamb√©m aumenta o n√∫mero de solicita√ß√µes com um atraso de mais de 10 ms.  Em outras palavras, se no QPS de 40k, cerca de 50 solicita√ß√µes por segundo excederam 50 ms, em 1k QPS a cada segundo, havia 100 solicita√ß√µes acima de 50 ms.  Paradoxo! <br><br><img src="https://habrastorage.org/webt/xd/86/x-/xd86x-er30ek6tg4hkv4qdevvgq.png"><br><br><h1>  Limite a sua pesquisa </h1><br>  Diante do problema de atraso em um sistema distribu√≠do com muitos componentes, a primeira coisa que voc√™ precisa fazer √© fazer uma pequena lista de suspeitos.  N√≥s nos aprofundamos um pouco mais na arquitetura de Alvin: <br><br><img src="https://habrastorage.org/webt/lh/is/s5/lhiss5mqv9dq2h9moyhlss_chlk.png"><br><br>  Um bom ponto de partida √© uma lista de transi√ß√µes de E / S conclu√≠das (chamadas de rede / pesquisas de disco, etc.).  Vamos tentar descobrir onde est√° o atraso.  Al√©m da E / S √≥bvia com o cliente, Alvin d√° um passo adicional: ele acessa o armaz√©m de dados.  No entanto, esse armazenamento funciona no mesmo cluster que o Alvin, portanto, deve haver menos atraso do que com o cliente.  Ent√£o, a lista de suspeitos: <br><br><ol><li>  Chamada de rede do cliente para Alvin. <br></li><li>  Chamada de rede da Alvin para o data warehouse. <br></li><li>  Pesquise no disco no armaz√©m de dados. <br></li><li>  Chamada de rede do data warehouse para a Alvin. <br></li><li>  Chamada de rede da Alvin para o cliente. </li></ol><br>  Vamos tentar riscar alguns pontos. <br><br><h3>  Data Warehouse </h3><br>  A primeira coisa que fiz foi converter o Alvin em um servidor de ping que n√£o lida com solicita√ß√µes.  Ao receber a solicita√ß√£o, ele retorna uma resposta vazia.  Se o atraso diminuir, um erro na implementa√ß√£o do Alvin ou no data warehouse n√£o √© algo in√©dito.  No primeiro experimento, obtemos o seguinte gr√°fico: <br><br><img src="https://habrastorage.org/webt/i4/zs/9s/i4zs9saymr5ra4tmry3diqbgdyy.png"><br><br>  Como voc√™ pode ver, ao usar o servidor ping-ping, n√£o h√° melhorias.  Isso significa que o armaz√©m de dados n√£o aumenta o atraso e a lista de suspeitos √© reduzida pela metade: <br><br><ol><li>  Chamada de rede do cliente para Alvin. <br></li><li>  Chamada de rede da Alvin para o cliente. </li></ol><br>  Uau!  A lista est√° diminuindo rapidamente.  Eu pensei que quase descobri o motivo. <br><br><h3>  gRPC </h3><br>  Agora √© a hora de apresentar um novo player: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">gRPC</a> .  Esta √© uma biblioteca de c√≥digo aberto do Google para comunica√ß√µes <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">RPC</a> em processo.  Embora o <code>gRPC</code> bem otimizado e amplamente utilizado, a primeira vez que o usei em um sistema dessa escala, e esperava que minha implementa√ß√£o fosse abaixo do ideal - para dizer o m√≠nimo. <br><br>  A presen√ßa de <code>gRPC</code> na pilha levantou uma nova pergunta: talvez essa seja minha implementa√ß√£o ou o pr√≥prio <code>gRPC</code> cause um problema de atraso?  Adicione √† lista do novo suspeito: <br><br><ol><li>  O cliente chama a biblioteca <code>gRPC</code> <br></li><li>  A biblioteca <code>gRPC</code> no cliente faz uma chamada de rede para a biblioteca <code>gRPC</code> no servidor <br></li><li>  Biblioteca <code>gRPC</code> acessa Alvin (nenhuma opera√ß√£o no caso de servidor de ping-pong) </li></ol><br>  Para fazer voc√™ entender como √© o c√≥digo, minha implementa√ß√£o cliente / Alvin n√£o √© muito diferente dos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">exemplos de</a> cliente-servidor <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ass√≠ncrono</a> . <br><br><blockquote>  <i>Nota: a lista acima √© um pouco simplificada, pois o <code>gRPC</code> permite que voc√™ use seu pr√≥prio modelo de fluxo (modelo?), No qual a <code>gRPC</code> execu√ß√£o do <code>gRPC</code> e a implementa√ß√£o do usu√°rio est√£o entrela√ßadas.</i>  <i>Por uma quest√£o de simplicidade, mantemos esse modelo.</i> </blockquote><br><h3>  A cria√ß√£o de perfil corrigir√° tudo </h3><br>  Atravessando os data warehouses, pensei que estava quase pronto: ‚ÄúAgora √© f√°cil!  Vamos aplicar o perfil e descobrir onde ocorre o atraso ".  Sou um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">grande f√£ de perfis precisos,</a> porque as CPUs s√£o muito r√°pidas e, na maioria das vezes, n√£o representam um gargalo.  A maioria dos atrasos ocorre quando o processador deve parar o processamento para fazer outra coisa.  A cria√ß√£o de perfil preciso da CPU foi feita justamente para isso: registra com precis√£o todas as <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">altern√¢ncias de contexto</a> e deixa claro onde ocorrem atrasos. <br><br>  Tomei quatro perfis: em QPS alto (baixa lat√™ncia) e com um servidor de ping-pong em QPS baixo (alta lat√™ncia), tanto no lado do cliente quanto no lado do servidor.  E, por precau√ß√£o, tamb√©m peguei um perfil de processador de amostra.  Ao comparar perfis, geralmente procuro uma pilha de chamadas anormal.  Por exemplo, no lado ruim com um atraso alto, h√° muito mais op√ß√µes de contexto (10 ou mais vezes).  Mas no meu caso, o n√∫mero de altern√¢ncias de contexto quase coincidiu.  Para meu horror, n√£o havia nada significativo l√°. <br><br><h1>  Depura√ß√£o adicional </h1><br>  Eu estava desesperado.  Eu n√£o sabia que outras ferramentas poderiam ser usadas, e meu pr√≥ximo plano era essencialmente repetir experimentos com diferentes varia√ß√µes, e n√£o diagnosticar claramente o problema. <br><br><h3>  E se </h3><br>  Desde o in√≠cio, fiquei preocupado com o tempo de atraso espec√≠fico de 50 ms.  Este √© um momento muito grande.  Decidi cortar as partes do c√≥digo at√© descobrir exatamente qual parte estava causando esse erro.  Em seguida, seguiu um experimento que funcionou. <br><br>  Como sempre, pensando bem, tudo parece √≥bvio.  Coloquei o cliente na mesma m√°quina com Alvin - e enviei a solicita√ß√£o para o <code>localhost</code> .  E o aumento do atraso desapareceu! <br><br><img src="https://habrastorage.org/webt/kl/bk/fv/klbkfv7ajppr9uqp_tywvxwgjre.png"><br><br>  Algo estava errado com a rede. <br><br><h3>  Aprendendo as habilidades de um engenheiro de rede </h3><br>  Devo admitir: meu conhecimento de tecnologias de rede √© terr√≠vel, principalmente considerando o fato de trabalhar diariamente com elas.  Mas a rede era o principal suspeito e eu precisava aprender como depur√°-la. <br><br>  Felizmente, a Internet ama quem quer aprender.  A combina√ß√£o de ping e tracert parecia um come√ßo suficientemente bom para depurar problemas de transporte de rede. <br><br>  Primeiro, eu executei o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">PsPing</a> na porta TCP de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Alvin</a> .  Eu usei as op√ß√µes padr√£o - nada de especial.  Dos mais de mil pings, nenhum excedeu 10 ms, com exce√ß√£o do primeiro para aquecimento.  Isso contradiz o aumento observado no atraso de 50 ms no percentil 99: l√°, para cada 100 solicita√ß√µes, devemos ver cerca de uma solicita√ß√£o com um atraso de 50 ms. <br><br>  Ent√£o tentei <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">rastrear</a> : talvez o problema esteja em um dos n√≥s ao longo do caminho entre Alvin e o cliente.  Mas o rastreador voltou de m√£os vazias. <br><br>  Portanto, o motivo do atraso n√£o foi o meu c√≥digo, nem a implementa√ß√£o do gRPC, nem a rede.  Eu j√° comecei a me preocupar que nunca vou entender isso. <br><br><h3>  Agora em que SO estamos </h3><br>  <code>gRPC</code> amplamente usado no Linux, mas √© ex√≥tico para Windows.  Decidi realizar um experimento que funcionou: criei uma m√°quina virtual Linux, compilei o Alvin para Linux e implantei. <br><br><img src="https://habrastorage.org/webt/z1/t8/tk/z1t8tkyhrobvurzcdqlmpdtetzc.png"><br><br>  E aqui est√° o que aconteceu: o servidor Linux de pingue-pongue n√£o teve atrasos como um n√≥ semelhante do Windows, embora a fonte de dados n√£o tenha diferido.  Acontece que o problema est√° na implementa√ß√£o do gRPC para Windows. <br><br><h3>  Algoritmo Nagle </h3><br>  Todo esse tempo, pensei que estava faltando a flag <code>gRPC</code> .  Agora eu percebi que isso <code>gRPC</code> n√£o tem a bandeira do Windows no <code>gRPC</code> .  Encontrei a biblioteca RPC interna, na qual eu tinha certeza de que ela funciona bem para todos os sinalizadores <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Winsock</a> instalados.  Em seguida, ele adicionou todos esses sinalizadores ao gRPC e implantou o Alvin no Windows, no servidor de ping-pong fixo do Windows! <br><br><img src="https://habrastorage.org/webt/7o/it/sf/7oitsfp2rzxotix0cf1xhktbrri.png"><br><br>  <i>Quase</i> pronto: comecei a excluir os sinalizadores adicionados um de cada vez at√© a regress√£o retornar, para que eu pudesse identificar sua causa.  Era o infame <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">TCP_NODELAY</a> , um comutador do algoritmo Nagle. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O algoritmo Neigl</a> tenta reduzir o n√∫mero de pacotes enviados pela rede atrasando a transmiss√£o de mensagens at√© que o tamanho do pacote exceda um determinado n√∫mero de bytes.  Embora isso possa ser agrad√°vel para o usu√°rio m√©dio, √© destrutivo para servidores em tempo real, pois o sistema operacional atrasar√° algumas mensagens, causando atrasos no QPS baixo.  <code>gRPC</code> tinha esse sinalizador definido na implementa√ß√£o do Linux para soquetes TCP, mas n√£o para o Windows.  Eu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">consertei</a> . <br><br><h1>  Conclus√£o </h1><br>  Um grande atraso no baixo QPS foi causado pela otimiza√ß√£o do sistema operacional.  Olhando para tr√°s, a cria√ß√£o de perfil n√£o detectou um atraso porque foi executada no modo kernel e n√£o no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">modo usu√°rio</a> .  N√£o sei se √© poss√≠vel observar o algoritmo Nagle por meio de capturas ETW, mas isso seria interessante. <br><br>  Quanto ao experimento localhost, provavelmente ele n√£o tocou no c√≥digo de rede real e o algoritmo Neigl n√£o foi iniciado; portanto, os problemas de atraso desapareceram quando o cliente entrou em contato com a Alvin atrav√©s do localhost. <br><br>  Na pr√≥xima vez que voc√™ observar um aumento na lat√™ncia enquanto diminui o n√∫mero de solicita√ß√µes por segundo, o algoritmo Neigl deve estar na sua lista de suspeitos! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt451904/">https://habr.com/ru/post/pt451904/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt451894/index.html">Uma vis√£o geral breve e din√¢mica da arquitetura do compilador</a></li>
<li><a href="../pt451896/index.html">Um eyeDisk "inquebr√°vel" √© protegido por uma varredura de √≠ris, mas transmite uma senha em texto n√£o criptografado</a></li>
<li><a href="../pt451898/index.html">Inova√ß√£o em russo</a></li>
<li><a href="../pt451900/index.html">Primeira contribui√ß√£o para a API do navegador do Facebook</a></li>
<li><a href="../pt451902/index.html">Acampamento do desenvolvedor do Microsoft Azure na R√∫ssia</a></li>
<li><a href="../pt451906/index.html">Vulnerabilidade do Exchange: Como detectar eleva√ß√£o de privil√©gio para um administrador de dom√≠nio</a></li>
<li><a href="../pt451908/index.html">A hist√≥ria dos computadores: uma noite no Museu Yandex</a></li>
<li><a href="../pt451912/index.html">Rede neural profunda do MuseNet grava m√∫sica</a></li>
<li><a href="../pt451916/index.html">PHP ass√≠ncrono e a hist√≥ria de uma bicicleta</a></li>
<li><a href="../pt451918/index.html">Para a quest√£o da TI</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>