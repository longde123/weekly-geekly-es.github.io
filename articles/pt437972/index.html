<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ùóÔ∏è üîõ üßóüèø PHP para iniciantes. A sess√£o üßòüèª üßú ü§ß</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Tenham um bom dia. Aqui est√° o primeiro artigo da s√©rie PHP para desenvolvedores iniciantes. Esta ser√° uma s√©rie incomum de artigos, n√£o haver√° echo "...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>PHP para iniciantes. A sess√£o</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/437972/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c0a/389/8cf/c0a3898cf539ad6a3dc7ffb833d9715d.png" alt="ElePHPant. PHP para iniciantes. Sess√£o"></div><br>  Tenham um bom dia.  Aqui est√° o primeiro artigo da s√©rie PHP para desenvolvedores iniciantes.  Esta ser√° uma s√©rie incomum de artigos, n√£o haver√° <code>echo "Hello World"</code> , haver√° hardcore na vida dos programadores PHP com uma pequena mistura de "li√ß√£o de casa" para consolidar o material. <br><br>  Come√ßarei com as sess√µes - este √© um dos componentes mais importantes com os quais voc√™ deve trabalhar.  N√£o entendendo os princ√≠pios de seu trabalho - fa√ßa neg√≥cios.  Ent√£o, para evitar problemas, tentarei falar sobre todas as nuances poss√≠veis. <br><a name="habracut"></a><br>  Mas para iniciantes, para entender por que precisamos de uma sess√£o, voltamos para as origens - para o protocolo HTTP. <br><br><h3>  Protocolo HTTP </h3><br>  O protocolo HTTP √© o HyperText Transfer Protocol - o "Hypertext Transfer Protocol" - ou seja,  de fato - um protocolo de texto, e entender que n√£o √© dif√≠cil. <br><blockquote>  Inicialmente, entendeu-se que, de acordo com este protocolo, somente o HTML ser√° transmitido, o endere√ßo e o nome, mas agora eles apenas n√£o enviar√£o e = ^. ^ = E Ôºà‚Ä¢ _ „ÖÖ _ ‚Ä¢Ôºâ </blockquote><br>  Para n√£o ficar parado, deixe-me dar um exemplo de comunica√ß√£o atrav√©s do protocolo HTTP. <br>  Aqui est√° um exemplo da solicita√ß√£o de como o navegador a envia quando voc√™ solicita a p√°gina <code>http://example.com</code> : <br><br><pre> <code class="plaintext hljs">GET / HTTP/1.1 Host: example.com Accept: text/html &lt; &gt;</code> </pre> <br>  E aqui est√° um exemplo de resposta: <br><br><pre> <code class="plaintext hljs">HTTP/1.1 200 OK Content-Length: 1983 Content-Type: text/html; charset=utf-8 &lt;html&gt; &lt;head&gt;...&lt;/head&gt; &lt;body&gt;...&lt;/body&gt; &lt;/html&gt;</code> </pre><br>  Estes s√£o exemplos muito simplificados, mas mesmo aqui voc√™ pode ver em que consiste a solicita√ß√£o e resposta HTTP: <br><br><ol><li>  <strong>linha de partida</strong> - para uma solicita√ß√£o cont√©m o m√©todo e o caminho da p√°gina solicitada, para uma resposta - a vers√£o do protocolo e o c√≥digo de resposta </li><li>  <strong>cabe√ßalhos</strong> - t√™m um formato de valor-chave separado por dois pontos, cada novo cabe√ßalho √© gravado a partir de uma nova linha </li><li>  <strong>corpo da mensagem</strong> - diretamente HTML ou dados s√£o separados dos cabe√ßalhos por duas quebras de linha, podem estar ausentes, como na solicita√ß√£o acima </li></ol><br>  Ent√£o, descobrimos o protocolo - √© simples, lidera sua hist√≥ria desde 1992, ent√£o voc√™ n√£o o nomear√° ideal, mas o que √© - envie uma solicita√ß√£o - obtenha uma resposta e √© isso, o servidor e o cliente n√£o est√£o mais conectados.  Mas esse cen√°rio n√£o √© o √∫nico poss√≠vel, podemos ter autoriza√ß√£o, o servidor deve entender de alguma forma que essa solicita√ß√£o veio de um usu√°rio espec√≠fico, ou seja,  o cliente e o servidor devem se comunicar dentro de uma determinada sess√£o.  E sim, o seguinte mecanismo foi inventado para isso: <br><br><ol><li>  Quando um usu√°rio autoriza, o servidor gera e se lembra de uma chave exclusiva - o identificador da sess√£o e a reporta ao navegador </li><li>  O navegador salva essa chave e, a cada solicita√ß√£o subsequente, envia </li></ol><br>  Para implementar esse mecanismo, foram criados cookies (cookies, cookies) - arquivos de texto simples no seu computador, por arquivo para cada dom√≠nio (embora alguns navegadores sejam mais avan√ßados e usem um banco de dados para armazenar SQLite), enquanto o navegador imp√µe um limite no n√∫mero de registros e o tamanho dos dados armazenados (para a maioria dos navegadores s√£o 4096 bytes, consulte <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">RFC 2109</a> de 1997) <br><blockquote>  I.e.  se voc√™ roubar um cookie do seu navegador, pode acessar a sua p√°gina do facebook em seu nome?  N√£o se assuste, isso n√£o pode ser feito, pelo menos com o facebook, e ent√£o mostrarei uma das maneiras poss√≠veis de se proteger contra esse tipo de ataque aos seus usu√°rios. </blockquote><br>  Agora vamos ver como nossas respostas a pedidos mudam, esteja l√° a autoriza√ß√£o: <br><br>  <b>Pedido</b> <br><pre> <code class="plaintext hljs">POST /login/ HTTP/1.1 Host: example.com Accept: text/html login=Username&amp;password=Userpass</code> </pre> <br><br>  Nosso m√©todo mudou para POST, e o login e a senha s√£o transmitidos no corpo da solicita√ß√£o.  Se voc√™ usar o m√©todo GET, a string de consulta conter√° um nome de usu√°rio e senha, o que n√£o √© muito correto do ponto de vista ideol√≥gico e tem v√°rios efeitos colaterais na forma de log (por exemplo, no mesmo <code>access.log</code> ) e no cache de senhas de forma clara. <br><br>  <b>Resposta</b> <br><pre> <code class="plaintext hljs">HTTP/1.1 200 OK Content-Type: text/html; charset=utf-8 Set-Cookie: KEY=VerySecretUniqueKey &lt;html&gt; &lt;head&gt;...&lt;/head&gt; &lt;body&gt;...&lt;/body&gt; &lt;/html&gt;</code> </pre> <br>  A resposta do servidor conter√° o cabe√ßalho <code>Set-Cookie: KEY=VerySecretUniqueKey</code> , que for√ßar√° o navegador a salvar esses dados em cookies e, na pr√≥xima vez em que acessar o servidor, ele ser√° enviado e reconhecido pelo servidor: <br><br>  <b>Pedido</b> <br><pre> <code class="plaintext hljs">GET / HTTP/1.1 Host: example.com Accept: text/html Cookie: KEY=VerySecretUniqueKey &lt; &gt;</code> </pre> <br><blockquote>  Como voc√™ pode ver, os cabe√ßalhos enviados pelo navegador (Request Headers) e pelo servidor (Response Headers) s√£o diferentes, embora sejam comuns para solicita√ß√µes e respostas (General Headers) </blockquote><br>  O servidor reconheceu nosso usu√°rio pelo cookie enviado e fornecer√° ainda mais acesso a informa√ß√µes pessoais.  Ent√£o, bem, com sess√µes e HTTP resolvidos, agora voc√™ pode retornar ao PHP e seus recursos. <br><br><h3>  PHP e sess√£o </h3><br><blockquote>  Espero que voc√™ j√° tenha o PHP instalado no seu computador, como  Al√©m disso, darei exemplos, e eles precisar√£o ser executados </blockquote><br>  A linguagem PHP foi criada para corresponder ao protocolo HTTP - ou seja,  Sua principal tarefa √© dar uma resposta √† solicita√ß√£o HTTP e "morrer" liberando mem√≥ria e recursos.  Portanto, o mecanismo da sess√£o n√£o funciona no PHP no modo autom√°tico, mas no modo manual, e voc√™ precisa saber o que chamar e em que ordem. <br><blockquote>  Aqui voc√™ tem um artigo sobre o t√≥pico <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">PHP deve morrer</a> , ou aqui est√° <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">em russo</a> , mas √© melhor coloc√°-lo nos favoritos "para mais tarde". </blockquote><br>  Primeiro, voc√™ precisa "iniciar" a sess√£o - para isso, usamos a fun√ß√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">session_start ()</a> , crie um arquivo <em>session.start.php</em> com o seguinte conte√∫do: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> session_start();</code> </pre> <br>  Execute o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">servidor web</a> PHP <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">embutido</a> na pasta com o seu script: <br><br><pre> <code class="bash hljs">php -S 127.0.0.1:8080</code> </pre> <br>  Inicie o navegador e abra as Ferramentas do desenvolvedor (ou o que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">for</a> ) e v√° para a p√°gina <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">http://127.0.0.1:8080/session.start.php</a> - voc√™ deve ver apenas uma p√°gina em branco, mas n√£o se apresse para fechar - veja para os cabe√ßalhos que o servidor nos enviou: <br><br> <a href="" rel="attachment"><img src="https://habrastorage.org/getpro/habr/post_images/3e8/b2d/145/3e8b2d145c8f29ce0fe30664dcc36119.png" alt="Cookie" width="460" height="222"></a> <br><br>  Haver√° muitas coisas. Estamos interessados ‚Äã‚Äãapenas nesta linha na resposta do servidor (cookies limpos, se n√£o houver essa linha e atualize a p√°gina): <br><br><pre> <code class="plaintext hljs">Set-Cookie: PHPSESSID=dap83arr6r3b56e0q7t5i0qf91; path=/</code> </pre> <br>  Ao ver isso, o navegador salvar√° um cookie chamado `PHPSESSID`: <br><br> <a href="" rel="attachment wp-att-2816"><img src="https://habrastorage.org/getpro/habr/post_images/f06/d02/09e/f06d0209e68ccac4b99570758c23a2ad.png" alt="Cookie de sess√£o do navegador" width="460" height="410"></a> <br><br><blockquote>  <code>PHPSESSID</code> - o nome da sess√£o padr√£o, √© ajustado na configura√ß√£o do php.ini com a diretiva <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">session.name</a> ; se necess√°rio, o nome pode ser alterado no pr√≥prio arquivo de configura√ß√£o ou usando a fun√ß√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">session_name ()</a> </blockquote><br>  E agora - atualizamos a p√°gina e vemos que o navegador envia esse cookie para o servidor, voc√™ pode tentar atualizar a p√°gina algumas vezes, o resultado ser√° id√™ntico: <br><br> <a href="" rel="attachment wp-att-2817"><img src="https://habrastorage.org/getpro/habr/post_images/272/4e6/001/2724e60013b929e3e9e7f1bfa9212ef1.png" alt="Pedido do navegador com cookie" width="460" height="87"></a> <br><br>  O total que temos - a teoria coincidiu com a pr√°tica, e isso √© √≥timo. <br><br>  O pr√≥ximo passo √© salvar um valor arbitr√°rio na sess√£o, para isso, a vari√°vel super global <code>$_SESSION</code> usada no PHP, economizaremos o tempo atual - para isso, chame a fun√ß√£o <a href="">date ()</a> : <br><br><pre> <code class="php hljs">session_start(); $_SESSION[<span class="hljs-string"><span class="hljs-string">'time'</span></span>] = date(<span class="hljs-string"><span class="hljs-string">"H:i:s"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> $_SESSION[<span class="hljs-string"><span class="hljs-string">'time'</span></span>];</code> </pre> <br>  Atualizamos a p√°gina e vemos a hora do servidor, atualizamos novamente - e a hora foi atualizada.  Agora, verifique se o tempo definido n√£o muda a cada atualiza√ß√£o da p√°gina: <br><br><pre> <code class="php hljs">session_start(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_SESSION[<span class="hljs-string"><span class="hljs-string">'time'</span></span>])) { $_SESSION[<span class="hljs-string"><span class="hljs-string">'time'</span></span>] = date(<span class="hljs-string"><span class="hljs-string">"H:i:s"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> $_SESSION[<span class="hljs-string"><span class="hljs-string">'time'</span></span>];</code> </pre> <br>  N√≥s atualizamos - o tempo n√£o muda, o que √© necess√°rio.  Mas, ao mesmo tempo, lembramos que o PHP est√° morrendo, o que significa que ele armazena esta sess√£o em algum lugar e encontraremos esse lugar ... <br><br><h3>  Tudo segredo fica claro </h3><br>  Por padr√£o, o PHP armazena a sess√£o em arquivos - a diretiva <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">session.save_handler</a> √© respons√°vel por isso, procure o caminho no qual os arquivos s√£o salvos na diretiva <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">session.save_path</a> ou use a fun√ß√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">session_save_path ()</a> para obter o caminho necess√°rio. <br><blockquote>  Na sua configura√ß√£o, o caminho para os arquivos pode n√£o ser especificado, ent√£o os arquivos da sess√£o ser√£o armazenados em arquivos tempor√°rios do seu sistema - chame a fun√ß√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">sys_get_temp_dir ()</a> e descubra onde est√° esse local oculto. </blockquote><br>  Ent√£o, seguimos esse caminho e localizamos seu arquivo de sess√£o (eu tenho esse arquivo <code>sess_dap83arr6r3b56e0q7t5i0qf91</code> ), abra-o em um editor de texto: <br><br><pre> <code class="bash hljs">time|s:8:<span class="hljs-string"><span class="hljs-string">"16:19:51"</span></span>;</code> </pre> <br>  Como voc√™ pode ver, aqui √© a nossa hora, este √© o formato complicado em que nossa sess√£o √© armazenada, mas podemos fazer altera√ß√µes, alterar a hora ou simplesmente inserir qualquer linha, por que n√£o: <br><br><pre> <code class="bash hljs">time|s:13:<span class="hljs-string"><span class="hljs-string">"\m/ (@.@) \m/"</span></span>;</code> </pre> <br>  Para converter essa string em uma matriz, voc√™ precisa usar a fun√ß√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">session_decode ()</a> , para a convers√£o reversa - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">session_encode ()</a> - isso √© chamado de serializa√ß√£o, apenas no PHP para sess√µes - √© o seu pr√≥prio - especial, embora voc√™ possa usar a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">serializa√ß√£o</a> padr√£o do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">PHP</a> - escreva na diretiva de configura√ß√£o da <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">sess√£o O</a> valor <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">.serialize_handler</a> √© <code>php_serialize</code> e voc√™ ficar√° feliz, e <code>$_SESSION</code> pode ser usado sem restri√ß√µes - agora voc√™ pode usar n√∫meros e caracteres especiais como √≠ndice <code>|</code>  e <code>!</code>  em nome (para todos os mais de 10 anos de trabalho, nunca precisei :) <br><br><div class="spoiler">  <b class="spoiler_title">Tarefa</b> <div class="spoiler_text">  Escreva sua fun√ß√£o, semelhante em fun√ß√£o a <code>session_decode()</code> , aqui voc√™ tem um conjunto de dados de teste para a sess√£o (n√£o √© necess√°rio resolver o conhecimento de express√µes regulares), pegue o texto para convers√£o do arquivo da sua sess√£o atual: <br><br><pre> <code class="php hljs">$_SESSION[<span class="hljs-string"><span class="hljs-string">'integer var'</span></span>] = <span class="hljs-number"><span class="hljs-number">123</span></span>; $_SESSION[<span class="hljs-string"><span class="hljs-string">'float var'</span></span>] = <span class="hljs-number"><span class="hljs-number">1.23</span></span>; $_SESSION[<span class="hljs-string"><span class="hljs-string">'octal var'</span></span>] = <span class="hljs-number"><span class="hljs-number">0x123</span></span>; $_SESSION[<span class="hljs-string"><span class="hljs-string">'string var'</span></span>] = <span class="hljs-string"><span class="hljs-string">"Hello world"</span></span>; $_SESSION[<span class="hljs-string"><span class="hljs-string">'array var'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'one'</span></span>, <span class="hljs-string"><span class="hljs-string">'two'</span></span>, [<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>]); $object = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> stdClass(); $object-&gt;foo = <span class="hljs-string"><span class="hljs-string">'bar'</span></span>; $object-&gt;arr = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'hello'</span></span>, <span class="hljs-string"><span class="hljs-string">'world'</span></span>); $_SESSION[<span class="hljs-string"><span class="hljs-string">'object var'</span></span>] = $object; $_SESSION[<span class="hljs-string"><span class="hljs-string">'integer again'</span></span>] = <span class="hljs-number"><span class="hljs-number">42</span></span>;</code> </pre> <br></div></div><br>  Ent√£o, o que ainda n√£o tentamos?  √â isso mesmo - para roubar cookies, vamos lan√ßar outro navegador e adicionar os mesmos cookies.  Para isso, escrevi um javascript simples para voc√™, copie-o no console do navegador e execute-o, lembre-se de alterar o identificador da sess√£o para o seu: <br><br><pre> <code class="javascript hljs">javascript:(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.cookie=<span class="hljs-string"><span class="hljs-string">'PHPSESSID=dap83arr6r3b56e0q7t5i0qf91;path=/;'</span></span>;<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.location.reload();})()</code> </pre> <br>  Agora, os dois navegadores est√£o olhando para a mesma sess√£o.  Mencionei acima que falarei sobre m√©todos de prote√ß√£o, considerarei a maneira mais simples - vincularemos a sess√£o ao navegador, mais precisamente, a apar√™ncia do navegador ao servidor - lembraremos do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">User-Agent</a> e verificaremos sempre: <br><br><pre> <code class="php hljs">session_start(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_SESSION[<span class="hljs-string"><span class="hljs-string">'time'</span></span>])) { $_SESSION[<span class="hljs-string"><span class="hljs-string">'ua'</span></span>] = $_SERVER[<span class="hljs-string"><span class="hljs-string">'HTTP_USER_AGENT'</span></span>]; $_SESSION[<span class="hljs-string"><span class="hljs-string">'time'</span></span>] = date(<span class="hljs-string"><span class="hljs-string">"H:i:s"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($_SESSION[<span class="hljs-string"><span class="hljs-string">'ua'</span></span>] != $_SERVER[<span class="hljs-string"><span class="hljs-string">'HTTP_USER_AGENT'</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">die</span></span>(<span class="hljs-string"><span class="hljs-string">'Wrong browser'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> $_SESSION[<span class="hljs-string"><span class="hljs-string">'time'</span></span>];</code> </pre> <br>  √â mais dif√≠cil falsificar, mas ainda √© poss√≠vel, adicionar as <code>$_SERVER['HTTP_X_FORWARDED_FOR']</code> salvar e verificar <code>$_SERVER['REMOTE_ADDR']</code> e <code>$_SERVER['HTTP_X_FORWARDED_FOR']</code> , e isso parecer√° mais ou menos com prote√ß√£o contra invasores que invadem nossos cookies. <br><br><blockquote>  A palavra-chave no par√°grafo anterior <b>parece que os</b> cookies est√£o rodando o protocolo HTTPS em projetos reais h√° muito tempo, para que ningu√©m possa roub√°-los sem acesso f√≠sico ao seu computador ou smartphone </blockquote><br><br>  Vale mencionar a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=http://php.net/session.configuration.php&amp;usg=ALkJrhg0uMepIeRoLYBYG8heoebgxt7EbQ#ini.session.cookie-">diretiva session.cookie-activationponly</a> , gra√ßas a ela o cookie da sess√£o ficar√° inacess√≠vel a partir do JavaScript.  Al√©m disso, se voc√™ olhar o manual da fun√ß√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">setcookie ()</a> , notar√° que o √∫ltimo par√¢metro tamb√©m √© respons√°vel pelo HttpOnly.  Lembre-se disso - essa configura√ß√£o permite lidar efetivamente com ataques XSS em quase <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">todos os navegadores</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Tarefa</b> <div class="spoiler_text">  Adicione uma verifica√ß√£o ao IP do usu√°rio no c√≥digo; se a verifica√ß√£o falhar, exclua a sess√£o comprometida. <br></div></div><br><h3>  Passo a passo </h3><br>  E agora vou explicar em etapas o algoritmo como uma sess√£o funciona em PHP, usando o seguinte c√≥digo como exemplo (configura√ß√µes padr√£o): <br><br><pre> <code class="php hljs">session_start(); $_SESSION[<span class="hljs-string"><span class="hljs-string">'id'</span></span>] = <span class="hljs-number"><span class="hljs-number">42</span></span>;</code> </pre> <br><ol><li>  depois de chamar <code>session_start()</code> PHP procura no identificador de sess√£o o cookie pelo nome especificado em <code>session.name</code> - este √© <code>PHPSESSID</code> </li><li>  se n√£o houver identificador, ele ser√° criado (consulte <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">session_id ()</a> ) e criar√° um arquivo de sess√£o vazio no caminho <code>session.save_path</code> com o nome <code>sess_{session_id()}</code> , os cabe√ßalhos ser√£o adicionados √† resposta do servidor para definir o cookie <code>{session_name()}={session_id()}</code> </li><li>  se o identificador estiver presente, procure o arquivo da sess√£o na pasta <code>session.save_path</code> : <br><ul><li>  n√£o o encontramos - criamos um arquivo vazio com o nome <code>sess_{$_COOKIE[session_name()]}</code> (o identificador pode conter apenas caracteres dos intervalos <code>az</code> , <code>AZ</code> , <code>0-9</code> , v√≠rgula e sinal de menos) </li><li>  encontre, leia o arquivo e descompacte os dados (consulte <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">session_decode ()</a> ) na vari√°vel super global <code>$_SESSION</code> (o arquivo est√° bloqueado para leitura / grava√ß√£o) </li></ul></li><li>  quando o script terminar seu trabalho, todos os dados de <code>$_SESSION</code> ser√£o compactados usando <code>session_encode()</code> em um arquivo no caminho <code>session.save_path</code> chamado <code>sess_{session_id()}</code> (o bloqueio √© liberado) </li></ol><br><div class="spoiler">  <b class="spoiler_title">Tarefa</b> <div class="spoiler_text">  Defina um valor arbitr√°rio de cookie no seu navegador com o nome <code>PHPSESSID</code> , <code>1234567890</code> , atualize a p√°gina, verifique se voc√™ criou um novo arquivo <code>sess_1234567890</code> <br></div></div><br><h3>  Existe vida sem biscoitos? </h3><br>  O PHP pode funcionar com a sess√£o mesmo se os cookies estiverem desativados no navegador, mas todos os URLs no site conter√£o um par√¢metro com o identificador da sua sess√£o e sim - voc√™ ainda precisa configurar isso, mas precisa?  N√£o precisava us√°-lo, mas se realmente quiser, direi onde cavar: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">session.use_cookies</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">session.use_only_cookies</a> </li></ul><br><h3>  E se voc√™ precisar armazenar uma sess√£o em um banco de dados? </h3><br>  Para armazenar uma sess√£o no banco de dados, voc√™ precisar√° alterar o armazenamento da sess√£o e informar ao PHP como us√°- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">la.Para</a> esse efeito, a interface <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">SessionHandlerInterface</a> e a fun√ß√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">session_set_save_handler</a> foram criadas. <br><blockquote>  Separadamente, observo que voc√™ n√£o precisa escrever seus pr√≥prios manipuladores de sess√£o para redis e memcache - quando voc√™ instala essas extens√µes, os manipuladores correspondentes tamb√©m os acompanham, portanto o RTFM √© tudo.  Bem, sim, o manipulador deve ser especificado antes de chamar <code>session_start()</code> ;) </blockquote><br><div class="spoiler">  <b class="spoiler_title">Tarefa</b> <div class="spoiler_text">  Implemente <code>SessionHandlerInterface</code> para armazenar a sess√£o no MySQL, verifique se funciona. <br>  Essa √© uma tarefa de asterisco para aqueles que j√° se familiarizaram com os bancos de dados. <br></div></div><br><br><h3>  Quando a sess√£o morre? </h3><br>  A diretiva <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">session.gc_maxlifetime</a> √© respons√°vel pelo tempo de vida de uma sess√£o.  Por padr√£o, essa diretiva √© igual a 1440 segundos (24 minutos); deve-se entender que, se uma sess√£o n√£o tiver sido acessada por um tempo especificado, a sess√£o ser√° considerada "podre" e aguardar√° sua vez de excluir. <br><br>  Outra pergunta √© interessante: voc√™ pode pedir a desenvolvedores maduros - quando o PHP exclui arquivos de sess√µes expiradas?  A resposta est√° no guia oficial, mas n√£o explicitamente - lembre-se: <br><br>  A coleta de lixo pode ser iniciada quando a fun√ß√£o <code>session_start()</code> √© chamada, a probabilidade de iniciar depende de duas diretivas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">session.gc_probability</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">session.gc_divisor</a> , a primeira atua como um dividendo, a segunda atua como um divisor e, por padr√£o, esses valores s√£o 1 e 100, etc. e  a probabilidade de o coletor ser iniciado e os arquivos da sess√£o serem exclu√≠dos √© de aproximadamente 1%. <br><br><div class="spoiler">  <b class="spoiler_title">Tarefa</b> <div class="spoiler_text">  Altere o valor da diretiva <code>session.gc_divisor</code> para que o coletor de lixo seja iniciado sempre, verifique se isso acontece. <br></div></div><br><br><h3>  O erro mais trivial </h3><br>  Um erro com mais de meio milh√£o de resultados nos resultados do Google: <br><br><blockquote>  N√£o √© poss√≠vel enviar o cookie da sess√£o - os <strong>cabe√ßalhos j√° enviados</strong> por <br>  N√£o √© poss√≠vel enviar o limitador de cache da sess√£o - os <strong>cabe√ßalhos j√° enviados</strong> </blockquote><br>  Para obter um, crie um arquivo <em>session.error.php</em> com o seguinte conte√∫do: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> str_pad(<span class="hljs-string"><span class="hljs-string">' '</span></span>, ini_get(<span class="hljs-string"><span class="hljs-string">'output_buffering'</span></span>)); session_start();</code> </pre> <br><blockquote>  Na segunda linha, uma estranha "m√°gica" √© um foco com um buffer de sa√≠da, falarei sobre isso em um dos seguintes artigos, at√© agora considero que seja apenas uma sequ√™ncia com um comprimento de 4096 caracteres, nesse caso, s√£o todos os espa√ßos </blockquote><br>  Comece excluindo o cookie antecipadamente e voc√™ receber√° os erros acima, embora o texto do erro seja diferente, mas a ess√™ncia seja a mesma: o trem partiu - o servidor j√° enviou o conte√∫do da p√°gina para o navegador e √© tarde para enviar os cabe√ßalhos, isso n√£o funcionar√° nos cookies e o identificador de sess√£o estimado n√£o aparecer√° nos cookies.  Se voc√™ encontrar esse erro - procure um local em que o texto seja exibido antes do tempo, pode haver um espa√ßo antes dos caracteres <code>&lt;?php</code> ou after <code>?&gt;</code> Em um dos arquivos conectados e, se for um espa√ßo, pode haver algum segmento que n√£o pode ser impresso como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">BOM</a> , tenha cuidado, e esta infec√ß√£o n√£o afetar√° voc√™ (afinal ... risadas hom√©ricas). <br><br><div class="spoiler">  <b class="spoiler_title">Tarefa</b> <div class="spoiler_text">  Para testar esse conhecimento, quero que voc√™ implemente seu pr√≥prio mecanismo de sess√£o e fa√ßa o c√≥digo acima funcionar: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span> <span class="hljs-string"><span class="hljs-string">'include/sess.php'</span></span>; sess_start(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_SESS[<span class="hljs-string"><span class="hljs-string">"id"</span></span>])) { <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> $_SESS[<span class="hljs-string"><span class="hljs-string">"id"</span></span>]; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $_SESS[<span class="hljs-string"><span class="hljs-string">"id"</span></span>] = <span class="hljs-number"><span class="hljs-number">42</span></span>; }</code> </pre> <br><blockquote>  Para implementar seu plano, voc√™ precisar√° da fun√ß√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">register_shutdown_function ()</a> </blockquote><br></div></div><br><br><h3>  Bloquear </h3><br>  Outro erro comum entre iniciantes √© uma tentativa de ler o arquivo da sess√£o enquanto ele est√° bloqueado por outro script.  Na verdade, isso n√£o √© um erro, √© um mal-entendido do princ√≠pio do bloqueio :) <br><br>  Mas vamos dar os passos novamente: <br><br><ol><li>  <code>session_start()</code> n√£o apenas cria / l√™ um arquivo, mas tamb√©m o bloqueia para que ningu√©m possa fazer altera√ß√µes no momento em que o script √© executado ou ler dados n√£o consistentes do arquivo da sess√£o </li><li>  o bloqueio √© liberado no final do script </li></ol><br><br>  "Furar" nesse erro √© muito f√°cil, crie dois arquivos: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// start.php session_start(); echo "OK";</span></span></code> </pre><br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// lock.php session_start(); sleep(10); echo "OK";</span></span></code> </pre><br><br>  Agora, se voc√™ abrir a p√°gina <code>lock.php</code> no navegador e abrir <code>start.php</code> em uma nova guia, ver√° que a segunda p√°gina ser√° aberta somente ap√≥s a execu√ß√£o do primeiro script, que bloqueia o arquivo da sess√£o por 10 segundos. <br><br>  Existem algumas op√ß√µes para evitar esse fen√¥meno - ‚Äúdesajeitado‚Äù e ‚Äúpensativo‚Äù. <br><br>  <b>"Machado"</b> <br>  Use um manipulador de sess√£o personalizado no qual "esquecer" para implementar o bloqueio :) <br>  Uma op√ß√£o um pouco melhor √© pegar uma pronta e desabilitar o bloqueio (por exemplo, o memcached possui essa op√ß√£o - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">memcached.sess_locking</a> ) O_o <br>  Passe horas depurando o c√≥digo em busca de um erro pop-up raro ... <br><br>  <b>"Pensativo"</b> <br>  Onde √© a melhor maneira - monitorar voc√™ mesmo a trava de sess√£o e remov√™-la quando n√£o for necess√°ria: <br><br>  - Se tiver certeza de que n√£o precisa fazer altera√ß√µes nos dados da sess√£o, use a op√ß√£o <code>read_and_close</code> ao iniciar a sess√£o: <br><br><pre> <code class="php hljs">session_start([ <span class="hljs-string"><span class="hljs-string">'read_and_close'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> ]);</code> </pre><br><br>  Assim, o bloqueio ser√° liberado imediatamente ap√≥s a leitura dos dados da sess√£o. <br><br>  - Se voc√™ ainda precisar fazer altera√ß√µes na sess√£o, depois de faz√™-las fechar a sess√£o da grava√ß√£o: <br><br><pre> <code class="php hljs">session_start(); <span class="hljs-comment"><span class="hljs-comment">// some changes session_write_close();</span></span></code> </pre><br><br><div class="spoiler">  <b class="spoiler_title">Tarefa</b> <div class="spoiler_text">  A listagem dos dois arquivos <code>lock.php</code> e <code>lock.php</code> foi um pouco maior: crie mais <code>read-close.php</code> e <code>write-close.php</code> , nos quais voc√™ controlar√° o bloqueio das maneiras listadas.  Verifique como o bloqueio funciona (ou n√£o). <br></div></div><br><br><h3>  Em conclus√£o </h3><br>  Neste artigo, voc√™ recebeu sete tarefas, enquanto elas se referem n√£o apenas ao trabalho com <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">sess√µes</a> , mas tamb√©m apresentam o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">MySQL</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">fun√ß√µes de string</a> .  Para a assimila√ß√£o deste material - voc√™ n√£o precisa de um artigo separado, basta o manual nos links fornecidos - ningu√©m o ler√° para voc√™.  V√° em frente! <br><br>  <b>PS</b> Se voc√™ aprendeu algo novo com o artigo - agrade√ßa ao autor - compartilhe o artigo nas redes sociais;) <br>  <b>PPS</b> Sim, este √© um artigo de postagem cruzada do meu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">blog</a> , mas ainda √© relevante :) <br><br>  <b>Uma s√©rie de artigos "PHP para iniciantes":</b> <br><br><ul><li>  <b>A sess√£o</b> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Conex√£o de arquivo</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt437972/">https://habr.com/ru/post/pt437972/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt437958/index.html">Autoriza√ß√£o na ESIA em um servidor de terminal com assinatura digital de acordo com GOST-2012</a></li>
<li><a href="../pt437960/index.html">Conselho do diretor t√©cnico de uma empresa de TI para capacitar os graduados</a></li>
<li><a href="../pt437962/index.html">ROI do PVS-Studio</a></li>
<li><a href="../pt437964/index.html">Livro "Aprendizado de m√°quina e fluxo de tens√£o"</a></li>
<li><a href="../pt437968/index.html">ROI do PVS-Studio</a></li>
<li><a href="../pt437974/index.html">Como ganhar WorldSkills digitais? Em um exemplo pr√°tico</a></li>
<li><a href="../pt437976/index.html">"Vkontakte" permitido esconder registros individuais da pol√≠cia</a></li>
<li><a href="../pt437978/index.html">Bem-vindo ao SuperJob do SphinxSearch-meetup</a></li>
<li><a href="../pt437980/index.html">Semin√°rio on-line aberto "M√©todo de teste em pares em testes de caixa preta"</a></li>
<li><a href="../pt437982/index.html">Novo ataque de criptografia da Shade visa usu√°rios de neg√≥cios russos</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>