<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🔄 🍔 💟 Post mortem: suivez le middleware ou comment nous avons rompu les commentaires 👨🏿‍💻 🐦 🖊️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Salut Nous n'avons pas de très bonnes nouvelles: nous avons fait une erreur dans la version mobile, ce qui pourrait vous déranger pendant toutes les v...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Post mortem: suivez le middleware ou comment nous avons rompu les commentaires</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/habr/blog/443268/"><p>  Salut  Nous n'avons pas de très bonnes nouvelles: nous avons fait une erreur dans la version mobile, ce qui pourrait vous déranger pendant toutes les vacances. </p><br><p><img src="https://habrastorage.org/webt/4f/f9/nu/4ff9nutagu7mnz6llaqeonv3ghs.jpeg"></p><br><p>  L'essence du problème: une personne envoie un commentaire à un message, le voit avec son identifiant et quitte la page, mais si vous actualisez la page, ce commentaire sera déjà sous un nom d'utilisateur différent.  Cela ne fonctionnait que si les utilisateurs étaient simultanément sur la page d'un article. </p><br><p>  Selon nos données, au cours du week-end, 774 commentaires ont été envoyés depuis la version mobile.  Chacun d'eux pourrait souffrir. <a name="habracut"></a></p><br><div class="spoiler">  <b class="spoiler_title">Quelques détails techniques</b> <div class="spoiler_text"><p>  Nous utilisons un tas de VueJS + NodeJS (Express, SSR). </p><br><p>  NodeJS sert plusieurs connexions dans un même flux de manière asynchrone, c'est-à-dire qu'il utilise une instance pour tous les clients.  Cela signifie que les variables globales ne sont initialisées qu'une seule fois et vivent tant que l'instance est vivante. </p><br><p>  Par conséquent, vous devez être extrêmement prudent sur l'ordre d'exécution de middlewar'ov, ainsi que sur la définition et la redéfinition des valeurs de variable (surtout si elles sont globales). </p><br><p>  Et c'est ce qui nous est arrivé (c'est un exemple de code): </p><br><pre><code class="javascript hljs">global.foo = <span class="hljs-string"><span class="hljs-string">'bar'</span></span>; app.get(<span class="hljs-string"><span class="hljs-string">'/main'</span></span>, (req, res, next) =&gt; { res.send(global.foo); }); app.get(<span class="hljs-string"><span class="hljs-string">'/change'</span></span>, (req, res, next) =&gt; { global.foo = global.foo === <span class="hljs-string"><span class="hljs-string">'bar'</span></span> ? <span class="hljs-string"><span class="hljs-string">'barbar'</span></span>: <span class="hljs-string"><span class="hljs-string">'bar'</span></span>; res.send(global.foo); });</code> </pre> <br><h3 id="chto-vernyot-server">  Que va rendre le serveur? </h3><br><ul><li>  Client 1 sur <code>/main</code> &gt;&gt;&gt; 'bar' </li><li>  Client 2 at <code>/change</code> &gt;&gt;&gt; 'barbar' </li><li>  Client 1 à nouveau activé <code>/main</code> &gt;&gt;&gt; 'barbar' </li></ul><br><p>  L'exemple, bien sûr, est grandement simplifié, mais le principe est le même. </p></div></div><br><p>  Maintenant, tout fonctionne comme il se doit.  Veuillez excuser la gêne occasionnée et si vous êtes concerné par ce problème, veuillez nous contacter via le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">formulaire de commentaires</a> . </p><br><p>  Nous recherchons une opportunité de retourner les commentaires à leurs propriétaires légitimes, nous vous dirons ce qui en est arrivé plus tard. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr443268/">https://habr.com/ru/post/fr443268/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr443258/index.html">Gotify - un projet open source pour délivrer des notifications et envoyer des messages au serveur</a></li>
<li><a href="../fr443260/index.html">Migrez vers Zimbra sans risquer une entreprise avec un domaine commun</a></li>
<li><a href="../fr443262/index.html">Mauvais conseil: comment rédiger la documentation technique? Troisième partie et dernière</a></li>
<li><a href="../fr443264/index.html">Il parle et montre: la rhétorique des politiciens ukrainiens populaires est-elle différente?</a></li>
<li><a href="../fr443266/index.html">Comment nous avons contribué à transformer le travail de comptabilité dans une grande entreprise énergétique</a></li>
<li><a href="../fr443270/index.html">L'annonce de Sony Xperia 1: un nouveau concept phare</a></li>
<li><a href="../fr443272/index.html">Le mythe des parasites nichromes</a></li>
<li><a href="../fr443274/index.html">Compilation de nouvelles sur l'industrie du jeu du 8 mars au dimanche</a></li>
<li><a href="../fr443276/index.html">Planificateur de requêtes surprise dans la base de données PostgreSQL</a></li>
<li><a href="../fr443278/index.html">Le crypto-échange Coinbase perd des utilisateurs en raison de l'achat d'une startup pour les créateurs de logiciels espions de la Hacking Team</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>