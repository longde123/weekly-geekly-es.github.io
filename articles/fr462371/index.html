<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§±üèª ü¶ä ‚úäüèæ D√©marrer Spring StateMachine üèáüèº ü§∏ üö®</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Entr√©e 
 Dans les projets, j'ai rencontr√© trois exemples, d'une mani√®re ou d'une autre li√©s √† la th√©orie des automates finis 



- Exemple 1. Un code ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>D√©marrer Spring StateMachine</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/462371/"><h3>  Entr√©e </h3><br>  Dans les projets, j'ai rencontr√© trois exemples, d'une mani√®re ou d'une autre li√©s √† la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">th√©orie des automates finis</a> <br><br><ul><li>  Exemple 1. <b>Un</b> <b>code</b> <s>govnokod</s> <b>divertissant</b> .  Il faut beaucoup de temps pour comprendre ce qui se passe.  Une caract√©ristique du mode de r√©alisation de la th√©orie indiqu√©e dans le code est un clich√© assez f√©roce qui ressemble parfois √† un code proc√©dural.  Le fait que cette version du code soit pr√©f√©rable de ne pas toucher au projet conna√Æt tous les technologues, m√©thodologistes et sp√©cialistes des produits.  Ils vont dans ce code pour r√©parer quelque chose en cas d'urgence (quand il est compl√®tement cass√©), il n'est pas question de finaliser les fonctionnalit√©s.  Car √ßa fait peur de casser.  La deuxi√®me caract√©ristique frappante qui isole ce type est la pr√©sence de tels commutateurs puissants, en plein √©cran. <br>  Il y a m√™me une blague sur ce score: <a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">Taille optimale</b> <div class="spoiler_text">  Sur l'un des JPoint, l'un des haut-parleurs, peut-√™tre Nikolai Alimenkov, a parl√© du nombre de cas dans le commutateur sont normaux, a d√©clar√© que la premi√®re r√©ponse est "jusqu'√† pr√©sent, s'inscrit dans l'√©cran."  Par cons√©quent, s'il interf√®re et que votre commutateur n'est pas d√©j√† normal, prenez et r√©duisez la taille de la police dans l'IDE <br></div></div></li><li>  Exemple 2. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><b>√âtat du mod√®le</b></a> .  L'id√©e principale (pour ceux qui n'aiment pas suivre les liens) est de d√©composer une certaine t√¢che commerciale en un ensemble d'√©tats finaux et de les d√©crire avec du code. <br>  Le principal inconv√©nient de Pattern State est que les √âtats se connaissent, savent qu'il y a des fr√®res et s'appellent.  Un tel code est assez difficile √† rendre universel.  Par exemple, lorsque vous impl√©mentez un syst√®me de paiement avec plusieurs types de paiements, vous risquez de creuser dans Generic-s √† tel point que la d√©claration de vos m√©thodes peut devenir quelque chose comme ceci: <cut></cut><br><br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> &lt; T extends BaseContextPayment, Q extends BaseDomainPaymentRequest, S, B extends AbstractPaymentDetailBuilder&lt;T, Q, S, B&gt;, F extends AbstractPaymentBuilder&lt;T, Q, S, B&gt; &gt; <span class="hljs-function"><span class="hljs-function">PaymentContext&lt;T, S&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">build</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Q request, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Class&lt;F&gt; factoryClass)</span></span></span></span>{ <span class="hljs-comment"><span class="hljs-comment">//""  }</span></span></code> </pre> <br>  √âtat de synth√®se: une impl√©mentation peut entra√Æner un code assez compliqu√©. </li><li>  Exemple 3 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">StateMachine</a> L'id√©e principale du Pattern est que les √©tats ne se connaissent pas, le contr√¥le de transition est effectu√© par le contexte, c'est mieux, moins de connectivit√© - le code est plus simple. <br></li></ul><br>  Apr√®s avoir exp√©riment√© toute la ¬´puissance¬ª du premier type et la complexit√© du second, nous avons d√©cid√© d'utiliser Pattern StateMachine pour la nouvelle analyse de rentabilisation. <br>  Afin de ne pas r√©inventer la roue, il a √©t√© d√©cid√© de prendre Statemachine Spring comme base (c'est Spring). <br><br>  Apr√®s avoir lu les quais, je suis all√© sur YouTube et Habr (pour comprendre comment les gens travaillent avec lui, comment √ßa se sent sur la prod, quel type de r√¢teau, etc.) Il s'est av√©r√© qu'il y a peu d'informations, sur YouTube il y a quelques vid√©os, toutes sont assez superficielles.  Sur Habr√© √† ce sujet je n'ai trouv√© qu'un seul article, ainsi que la vid√©o, assez superficielle. <br>  Dans un article, il est impossible de d√©crire toutes les subtilit√©s du travail de Spring statemachine, de faire le tour du quai et de d√©crire tous les cas, mais j'essaierai de dire les plus importants et les plus demand√©s, et sur le r√¢teau, sp√©cialement pour moi, lorsque je me suis familiaris√© avec le cadre, les informations ci-dessous √©taient serait tr√®s utile. <br><br><h3>  Corps principal </h3><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Nous allons cr√©er une application Spring Boot,</a> ajouter un d√©marreur Web (nous ferons fonctionner l'application Web le plus rapidement possible). L'application sera une abstraction du processus d'achat.  Le produit √† l'achat passera par les √©tapes de nouveau, r√©serv√©, de refus r√©serv√© et d'achat termin√©. <br>  Un peu d'improvisation, il y aurait plus de statuts dans un vrai projet, mais bon, on a aussi un vrai projet. <br>  Dans le pom.xml de l'application Web nouvellement cr√©√©e, ajoutez la d√©pendance √† la machine et aux tests pour celle-ci (Web Starter devrait d√©j√† l'√™tre, s'il est collect√© via <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">start.spring.io</a> ): <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.springframework.statemachine<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>spring-statemachine-core<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>2.1.3.RELEASE<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.springframework.statemachine<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>spring-statemachine-test<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>2.1.3.RELEASE<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">scope</span></span></span><span class="hljs-tag">&gt;</span></span>test<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">scope</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">cut</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre><br>  Cr√©ez la structure: <br><img src="https://habrastorage.org/webt/u8/nw/oq/u8nwoqaezenqp1pouozil4qjwno.png"><br>  Je n'ai pas encore √† entrer dans les d√©tails de cette structure, je vais tout expliquer s√©quentiellement, et il y aura un lien vers la source √† la fin de l'article. <br><br>  Alors allons-y. <br>  Nous avons un projet propre avec les d√©pendances n√©cessaires, pour commencer nous allons cr√©er une √©num√©ration, avec des √©tats et des √©v√©nements, une abstraction assez simple, ces composants eux-m√™mes ne portent aucune logique. <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> PurchaseEvent { RESERVE, BUY, RESERVE_DECLINE }</code> </pre> <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> PurchaseState { NEW, RESERVED, CANCEL_RESERVED, PURCHASE_COMPLETE }</code> </pre> <br>  Bien que formellement, vous pouvez ajouter des champs √† ces √©num√©rations et y coder en dur quelque chose qui est caract√©ristique, par exemple, d'un √©tat particulier, ce qui est assez logique (nous l'avons fait en r√©solvant notre cas, tr√®s facilement). <br>  Nous allons configurer la machine via la configuration java, cr√©er le fichier de configuration et, pour la classe √©tend EnumStateMachineConfigurerAdapter &lt;PurchaseState, PurchaseEvent&gt;.  √âtant donn√© que notre √©tat et √©v√©nement est enum, l'interface est appropri√©e, mais elle n'est pas n√©cessaire, tout type d'objet peut √™tre utilis√© comme g√©n√©rique (nous ne consid√©rerons pas d'autres exemples dans l'article, car EnumStateMachineConfigurerAdapter est plus que suffisant √† mon avis). <br><br>  Le point important suivant est de savoir si une machine vivra dans le contexte de l'application: dans une seule instance de @EnableStateMachine, ou chaque fois qu'une nouvelle @EnableStateMachineFactory sera cr√©√©e.  S'il s'agit d'une application Web multi-utilisateurs avec un groupe d'utilisateurs, la premi√®re option ne vous convient pas, nous utiliserons donc la seconde comme la plus populaire.  StateMachine peut √©galement √™tre cr√©√© via le g√©n√©rateur en tant que bean standard (voir la documentation), ce qui est pratique dans certains cas (par exemple, vous avez besoin que la machine soit explicitement d√©clar√©e en tant que bean), et s'il s'agit d'un bean distinct, alors nous pouvons lui indiquer notre port√©e par exemple session ou demande.  Dans notre projet, le wrapper (caract√©ristiques de notre logique m√©tier) a √©t√© impl√©ment√© sur le bean statemachine, le wrapper √©tait singleton et la machine prototype elle-m√™me <br><div class="spoiler">  <b class="spoiler_title">R√¢teau</b> <div class="spoiler_text">  Comment impl√©menter un prototype en singlton? <br>  En fait, tout ce que vous devez faire est d'obtenir un nouveau bean √† partir de l'applicationContext chaque fois que vous acc√©dez √† l'objet.  Injecter un ApplicationContext dans la logique m√©tier est un p√©ch√©, par cons√©quent, un statemachine de bean doit impl√©menter une interface avec au moins une m√©thode ou une m√©thode abstraite (injection de m√©thode), lors de la cr√©ation d'une configuration java, vous devrez impl√©menter la m√©thode abstraite indiqu√©e, et dans l'impl√©mentation, nous tirerons de applicationContext nouveau bean.  Il est normal d'avoir un lien vers l'applicationContext dans la classe config, et √† travers la m√©thode abstraite, nous appellerons .getBean (); <br></div></div><br>  La classe EnumStateMachineConfigurerAdapter a plusieurs m√©thodes, rempla√ßant celle que nous configurons la machine. <br>  Pour commencer, enregistrez les statuts: <br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configure</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> StateMachineStateConfigurer&lt;PurchaseState, PurchaseEvent&gt; states)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ states .withStates() .initial(NEW) .end(PURCHASE_COMPLETE) .states(EnumSet.allOf(PurchaseState.class)); }</code> </pre> <br>  initial (NEW) est l'√©tat dans lequel la machine sera apr√®s la cr√©ation du bean, end (PURCHASE_COMPLETE) est l'√©tat en allant vers lequel la machine ex√©cute statemachine.stop (), pour une machine non d√©terministe (dont la plupart) n'est pas pertinente, mais quelque chose doit √™tre sp√©cifi√© .  .states (EnumSet.allOf (PurchaseState.class) liste de tous les statuts, vous pouvez pousser en masse. <br><br>  Configurer les param√®tres globaux de la machine <br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configure</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> StateMachineConfigurationConfigurer&lt;PurchaseState, PurchaseEvent&gt; config)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ config .withConfiguration() .autoStartup(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) .listener(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PurchaseStateMachineApplicationListener()); }</code> </pre> <br>  Ici, le d√©marrage automatique d√©termine si la machine sera d√©marr√©e imm√©diatement apr√®s sa cr√©ation par d√©faut, en d'autres termes - si elle passera automatiquement au statut NOUVEAU (faux par d√©faut).  Imm√©diatement, nous enregistrons un √©couteur pour le contexte de la machine (√† ce sujet un peu plus tard), dans la m√™me configuration, vous pouvez d√©finir un TaskExecutor distinct, ce qui est pratique lorsqu'une longue action est effectu√©e sur certaines de leurs transitions, et l'application devrait aller plus loin. <br>  Eh bien, les transitions elles-m√™mes: <br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configure</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> StateMachineTransitionConfigurer&lt;PurchaseState, PurchaseEvent&gt; transitions)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ transitions .withExternal() .source(NEW) .target(RESERVED) .event(RESERVE) .action(reservedAction(), errorAction()) .and() .withExternal() .source(RESERVED) .target(CANCEL_RESERVED) .event(RESERVE_DECLINE) .action(cancelAction(), errorAction()) .and() .withExternal() .source(RESERVED) .target(PURCHASE_COMPLETE) .event(BUY) .guard(hideGuard()) .action(buyAction(), errorAction()); }</code> </pre> <br>  Toute la logique des transitions ou des transitions est d√©finie ici, Guard peut √™tre suspendu aux transitions, un composant qui retourne toujours bool√©en, que v√©rifierez-vous exactement sur la transition d'un √©tat √† un autre √† votre discr√©tion, toute logique peut √™tre parfaite dans Guard, c'est un composant tout √† fait ordinaire mais il doit revenir bool√©en.  Dans le cadre de notre projet, par exemple, HideGuard peut v√©rifier un certain param√®tre que l'utilisateur pourrait d√©finir (ne pas montrer ce produit) et, conform√©ment √† cela, ne pas laisser la machine dans l'√©tat prot√©g√© par Guard.  Je note que Guard, une seule peut √™tre ajout√©e √† une transition dans la configuration, une telle conception ne fonctionnera pas: <br><pre> <code class="java hljs"> .withExternal() .source(RESERVED) .target(PURCHASE_COMPLETE) .event(BUY) .guard(hideGuard()) .guard(veryHideGuard())</code> </pre> <br>  Plus pr√©cis√©ment, cela fonctionnera, mais seulement le premier garde (hideGuard ()) <br>  Mais vous pouvez ajouter plusieurs actions (maintenant nous parlons d'action, que nous prescrivons dans la configuration des transitions), j'ai personnellement essay√© d'ajouter trois actions √† une transition. <br><pre> <code class="java hljs"> .withExternal() .source(NEW) .target(RESERVED) .event(RESERVE) .action(reservedAction(), errorAction())</code> </pre> <br>  le deuxi√®me argument est ErrorAction, le contr√¥le y arrivera si ReservedAction l√®ve une exception (throw ). <br><div class="spoiler">  <b class="spoiler_title">R√¢teau</b> <div class="spoiler_text">  Gardez √† l'esprit que si dans votre action vous g√©rez toujours l'erreur via try / catch, vous n'entrerez pas dans ErrorAction, si vous devez traiter et aller dans ErrorAction, vous devez alors lancer RuntimeException () √† partir de catch, par exemple (vous avez dit vous-m√™me que c'√©tait tr√®s n√©cessaire). <br></div></div><br>  En plus de "suspendre" l'action dans les transitions, vous pouvez √©galement les "suspendre" dans la m√©thode configure pour l'√©tat, sous la forme approximative suivante: <br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configure</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> StateMachineStateConfigurer&lt;PurchaseState, PurchaseEvent&gt; states)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ states .withStates() .initial(NEW) .end(PURCHASE_COMPLETE) .stateEntry() .stateExit() .state() .states(EnumSet.allOf(PurchaseState.class)); }</code> </pre> <br>  Tout d√©pend de la fa√ßon dont vous souhaitez ex√©cuter l'action. <br><div class="spoiler">  <b class="spoiler_title">R√¢teau</b> <div class="spoiler_text">  Notez que si vous sp√©cifiez une action lors de la configuration de state (), comme par exemple <br><pre> <code class="java hljs"> states .withStates() .initial(NEW) .end(PURCHASE_COMPLETE) .state(randomAction())</code> </pre> <br>  il sera ex√©cut√© de mani√®re asynchrone, on suppose que si vous dites .stateEntry () par exemple, alors l'action doit √™tre ex√©cut√©e directement √† l'entr√©e, mais si vous dites .state () alors l'action doit √™tre ex√©cut√©e dans l'√©tat cible, mais ce n'est pas si important quand. <br>  Dans notre projet, nous avons configur√© toutes les actions sur la configuration de transition, car vous pouvez les suspendre plusieurs √† la fois. <br></div></div><br>  La version finale de la configuration ressemblera √† ceci: <br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-meta"><span class="hljs-meta">@EnableStateMachineFactory</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StateMachineConfig</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EnumStateMachineConfigurerAdapter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PurchaseState</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PurchaseEvent</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configure</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> StateMachineConfigurationConfigurer&lt;PurchaseState, PurchaseEvent&gt; config)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ config .withConfiguration() .autoStartup(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) .listener(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PurchaseStateMachineApplicationListener()); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configure</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> StateMachineStateConfigurer&lt;PurchaseState, PurchaseEvent&gt; states)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ states .withStates() .initial(NEW) .end(PURCHASE_COMPLETE) .stateEntry() .stateExit() .state() .states(EnumSet.allOf(PurchaseState.class)); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configure</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> StateMachineTransitionConfigurer&lt;PurchaseState, PurchaseEvent&gt; transitions)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ transitions .withExternal() .source(NEW) .target(RESERVED) .event(RESERVE) .action(reservedAction(), errorAction()) .and() .withExternal() .source(RESERVED) .target(CANCEL_RESERVED) .event(RESERVE_DECLINE) .action(cancelAction(), errorAction()) .and() .withExternal() .source(RESERVED) .target(PURCHASE_COMPLETE) .event(BUY) .guard(hideGuard()) .action(buyAction(), errorAction()); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Action&lt;PurchaseState, PurchaseEvent&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reservedAction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReservedAction(); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Action&lt;PurchaseState, PurchaseEvent&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cancelAction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CancelAction(); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Action&lt;PurchaseState, PurchaseEvent&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">buyAction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BuyAction(); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Action&lt;PurchaseState, PurchaseEvent&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">errorAction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ErrorAction(); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Guard&lt;PurchaseState, PurchaseEvent&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hideGuard</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HideGuard(); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> StateMachinePersister&lt;PurchaseState, PurchaseEvent, String&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">persister</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DefaultStateMachinePersister&lt;&gt;(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PurchaseStateMachinePersister()); }</code> </pre> <br>  Faites attention au sch√©ma de la machine, il est tr√®s clairement visible sur ce que nous avons encod√© exactement (quelles transitions sur quels √©v√©nements sont valides, quel Guard prot√®ge l'√©tat et ce qui sera effectu√© lorsque l'√©tat est chang√©, quelle action). <br><img src="https://habrastorage.org/webt/l8/2z/2v/l82z2v6pwdaudcrvdpqi99xw48s.png"><br>  Faisons le contr√¥leur: <br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RestController</span></span> <span class="hljs-meta"><span class="hljs-meta">@SuppressWarnings</span></span>(<span class="hljs-string"><span class="hljs-string">"unused"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PurchaseController</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> PurchaseService purchaseService; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PurchaseController</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(PurchaseService purchaseService)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.purchaseService = purchaseService; } <span class="hljs-meta"><span class="hljs-meta">@RequestMapping</span></span>(path = <span class="hljs-string"><span class="hljs-string">"/reserve"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reserve</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String userId, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String productId)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> purchaseService.reserved(userId, productId); } <span class="hljs-meta"><span class="hljs-meta">@RequestMapping</span></span>(path = <span class="hljs-string"><span class="hljs-string">"/cancel"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cancelReserve</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String userId)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> purchaseService.cancelReserve(userId); } <span class="hljs-meta"><span class="hljs-meta">@RequestMapping</span></span>(path = <span class="hljs-string"><span class="hljs-string">"/buy"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">buyReserve</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String userId)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> purchaseService.buy(userId); } }</code> </pre> <br><cut></cut><br>  interface de service <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PurchaseService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** *    ,          * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> userId id ,    ,      id  *    http- * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> productId id ,     * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> /  ,             *      . */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reserved</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String userId, String productId)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/** *   /    * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> userId id ,    ,      id  *    http- * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> /  ,             *      . */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cancelReserve</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String userId)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/** *     * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> userId id ,    ,      id  *    http- * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> /  ,             *      . */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">buy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String userId)</span></span></span></span>; }</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">R√¢teau</b> <div class="spoiler_text">  Savez-vous pourquoi il est important de cr√©er un bean via l'interface lorsque vous travaillez avec Spring?  Face √† ce probl√®me (enfin, oui, oui, et Zhenya Borisov l'a dit dans le ripper), lorsqu'une fois dans le contr√¥leur, ils ont essay√© de mettre en ≈ìuvre une interface improvis√©e non vide.  Spring cr√©e un proxy pour les composants, et si le composant n'impl√©mente aucune interface, il le fera via CGLIB, mais d√®s que vous impl√©menterez une interface - Spring essaiera de cr√©er un proxy via un proxy dynamique, par cons√©quent vous obtiendrez un type d'objet incompr√©hensible et NoSuchBeanDefinitionException . <br></div></div><br>  Le point important suivant est de savoir comment vous allez restaurer l'√©tat de votre machine, car pour chaque appel un nouveau bean sera cr√©√© qui ne sait rien de vos √©tats pr√©c√©dents de la machine et de son contexte. <br>  √Ä ces fins, la statemachine √† ressort a un m√©canisme Persistens: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PurchaseStateMachinePersister</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StateMachinePersist</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PurchaseState</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PurchaseEvent</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">String</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> HashMap&lt;String, StateMachineContext&lt;PurchaseState, PurchaseEvent&gt;&gt; contexts = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap&lt;&gt;(); <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> StateMachineContext&lt;PurchaseState, PurchaseEvent&gt; context, String contextObj)</span></span></span><span class="hljs-function"> </span></span>{ contexts.put(contextObj, context); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> StateMachineContext&lt;PurchaseState, PurchaseEvent&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String contextObj)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> contexts.get(contextObj); } }</code> </pre> <br>  Pour notre impl√©mentation na√Øve, nous utilisons la carte habituelle comme magasin d'√©tat, dans une impl√©mentation non na√Øve, ce sera une sorte de base de donn√©es, faites attention au troisi√®me type g√©n√©rique Cha√Æne, c'est la cl√© par laquelle l'√©tat de votre machine sera enregistr√©, avec tous les statuts, variables dans le contexte, id et ainsi de suite.  Dans mon exemple, j'ai utilis√© l'ID utilisateur pour la cl√© de sauvegarde, qui peut √™tre absolument n'importe quelle cl√© (utilisateur session_id, connexion unique, etc.). <br><div class="spoiler">  <b class="spoiler_title">R√¢teau</b> <div class="spoiler_text">  Dans notre projet, le m√©canisme de sauvegarde et de restauration des √©tats de la bo√Æte ne nous convenait pas, car nous stockions les statuts de la machine dans la base de donn√©es et pouvaient √™tre modifi√©s par un travail ne connaissant rien de la machine. <br>  J'ai d√ª attacher le statut re√ßu de la base de donn√©es, faire une InitAction qui, lorsque la machine d√©marre, a re√ßu le statut de la base de donn√©es, et le d√©finir de force, et seulement ensuite a lanc√© l'√©v√©nement, un exemple de code qui fait ce qui pr√©c√®de: <br><pre> <code class="java hljs">stateMachine .getStateMachineAccessor() .doWithAllRegions(access -&gt; { access.resetStateMachine(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DefaultStateMachineContext&lt;&gt;({ResetState}, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>)); }); stateMachine.start(); stateMachine.sendEvent({NewEventFromResetState});</code> </pre> <br></div></div><br>  Nous consid√©rerons l'impl√©mentation du service dans chaque m√©thode: <br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reserved</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String userId, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String productId)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> StateMachine&lt;PurchaseState, PurchaseEvent&gt; stateMachine = stateMachineFactory.getStateMachine(); stateMachine.getExtendedState().getVariables().put(<span class="hljs-string"><span class="hljs-string">"PRODUCT_ID"</span></span>, productId); stateMachine.sendEvent(RESERVE); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { persister.persist(stateMachine, userId); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Exception e) { e.printStackTrace(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; }</code> </pre> <br>  Nous r√©cup√©rons la voiture de l'usine, mettons un param√®tre dans le contexte de la machine, dans notre cas, c'est un productId, le contexte est une sorte de bo√Æte dans laquelle vous pouvez mettre tout ce dont vous avez besoin, partout o√π il y a acc√®s au bean statemachine ou √† son contexte, car la machine d√©marre automatiquement au d√©marrage du contexte , puis apr√®s le d√©part, notre voiture sera dans le nouveau statut, jetez l'√©v√©nement sur la r√©servation des marchandises. <br><br>  Les deux m√©thodes restantes sont similaires: <br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cancelReserve</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String userId)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> StateMachine&lt;PurchaseState, PurchaseEvent&gt; stateMachine = stateMachineFactory.getStateMachine(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { persister.restore(stateMachine, userId); stateMachine.sendEvent(RESERVE_DECLINE); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { e.printStackTrace(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">buy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String userId)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> StateMachine&lt;PurchaseState, PurchaseEvent&gt; stateMachine = stateMachineFactory.getStateMachine(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { persister.restore(stateMachine, userId); stateMachine.sendEvent(BUY); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { e.printStackTrace(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; }</code> </pre> <br>  Ici, nous restaurons d'abord l'√©tat de la machine pour l'ID utilisateur d'un utilisateur particulier, puis lan√ßons un √©v√©nement qui correspond √† la m√©thode api. <br>  Notez que productId n'appara√Æt plus dans la m√©thode, nous l'avons ajout√© au contexte de la machine et l'obtiendrons apr√®s la restauration de la machine √† partir de sa sauvegarde. <br>  Dans l'impl√©mentation de l'action, nous obtiendrons l'ID du produit dans le contexte de la machine et afficherons un message correspondant √† la transition dans le journal, par exemple, je donnerai le code ReservedAction: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ReservedAction</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Action</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PurchaseState</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PurchaseEvent</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(StateContext&lt;PurchaseState, PurchaseEvent&gt; context)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String productId = context.getExtendedState().get(<span class="hljs-string"><span class="hljs-string">"PRODUCT_ID"</span></span>, String.class); System.out.println(<span class="hljs-string"><span class="hljs-string">"   "</span></span> + productId + <span class="hljs-string"><span class="hljs-string">" ."</span></span>); } }</code> </pre> <br>  Nous ne pouvons que mentionner l'auditeur, qui, d√®s la sortie de la bo√Æte, propose de nombreux scripts auxquels vous pouvez vous accrocher, voyez par vous-m√™me: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PurchaseStateMachineApplicationListener</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StateMachineListener</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PurchaseState</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PurchaseEvent</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stateChanged</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(State&lt;PurchaseState, PurchaseEvent&gt; from, State&lt;PurchaseState, PurchaseEvent&gt; to)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (from.getId() != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { System.out.println(<span class="hljs-string"><span class="hljs-string">"   "</span></span> + from.getId() + <span class="hljs-string"><span class="hljs-string">"   "</span></span> + to.getId()); } } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stateEntered</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(State&lt;PurchaseState, PurchaseEvent&gt; state)</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stateExited</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(State&lt;PurchaseState, PurchaseEvent&gt; state)</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">eventNotAccepted</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Message&lt;PurchaseEvent&gt; event)</span></span></span><span class="hljs-function"> </span></span>{ System.out.println(<span class="hljs-string"><span class="hljs-string">"   "</span></span> + event); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">transition</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Transition&lt;PurchaseState, PurchaseEvent&gt; transition)</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">transitionStarted</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Transition&lt;PurchaseState, PurchaseEvent&gt; transition)</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">transitionEnded</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Transition&lt;PurchaseState, PurchaseEvent&gt; transition)</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stateMachineStarted</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(StateMachine&lt;PurchaseState, PurchaseEvent&gt; stateMachine)</span></span></span><span class="hljs-function"> </span></span>{ System.out.println(<span class="hljs-string"><span class="hljs-string">"Machine started"</span></span>); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stateMachineStopped</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(StateMachine&lt;PurchaseState, PurchaseEvent&gt; stateMachine)</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stateMachineError</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(StateMachine&lt;PurchaseState, PurchaseEvent&gt; stateMachine, Exception exception)</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">extendedStateChanged</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object key, Object value)</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stateContext</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(StateContext&lt;PurchaseState, PurchaseEvent&gt; stateContext)</span></span></span><span class="hljs-function"> </span></span>{ } }</code> </pre> <br>  Le seul probl√®me est qu'il s'agit d'une interface, ce qui signifie que vous devez impl√©menter toutes ces m√©thodes, mais comme il est peu probable que vous en ayez toutes besoin, certaines d'entre elles resteront vides, ce qui signifie que les m√©thodes ne sont pas couvertes par les tests. <br>  Ici, en √©couteur, nous pouvons accrocher absolument toutes les m√©triques sur des √©v√©nements compl√®tement diff√©rents de la machine (par exemple, les paiements ne passent pas, la machine passe souvent dans une sorte d'√©tat PAYMENT_FAIL, nous √©coutons les transitions et si la machine est entr√©e dans un √©tat erron√© - nous √©crivons, dans un journal impair, ou base ou appeler la police, peu importe). <br><div class="spoiler">  <b class="spoiler_title">R√¢teau</b> <div class="spoiler_text">  Il y a un √©v√©nement stateMachineError dans lisener-e, mais avec une nuance, lorsque vous avez une exception et que vous la g√©rez dans catch, la machine ne consid√®re pas qu'il y a eu une erreur, vous devez parler explicitement dans catch <br>  stateMachine.setStateMachineError (exception) et passez une erreur. <br></div></div><br>  Pour v√©rifier ce que nous avons fait, nous ex√©cuterons deux cas: <br><ul><li>  1. R√©servation et refus ult√©rieur de l'achat.  Nous enverrons √† l'application une demande pour l'URI "/ reserve", avec les param√®tres userId = 007, productId = 10001, puis la demande "/ cancel" avec le param√®tre userId = 007, la sortie de la console sera la suivante: <br> <code>Machine started <br>    10001 . <br>    NEW   RESERVED <br> Machine started <br>   10001  <br>    RESERVED   CANCEL_RESERVED</code> </li> <li>  2. R√©servation et achat r√©ussi: <br> <code>Machine started <br>    10001 . <br>    NEW   RESERVED <br> Machine started <br>    10001   <br>    RESERVED   PURCHASE_COMPLETE</code> </li> </ul><br><h3>  Conclusion </h3><br>  En conclusion, je vais donner un exemple de test du framework, je pense que tout deviendra clair √† partir du code, vous avez juste besoin d'une d√©pendance sur la machine de test, et vous pouvez v√©rifier la configuration de mani√®re d√©clarative. <br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testWhenReservedCancel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ StateMachine&lt;PurchaseState, PurchaseEvent&gt; machine = factory.getStateMachine(); StateMachineTestPlan&lt;PurchaseState, PurchaseEvent&gt; plan = StateMachineTestPlanBuilder.&lt;PurchaseState, PurchaseEvent&gt;builder() .defaultAwaitTime(<span class="hljs-number"><span class="hljs-number">2</span></span>) .stateMachine(machine) .step() .expectStates(NEW) .expectStateChanged(<span class="hljs-number"><span class="hljs-number">0</span></span>) .and() .step() .sendEvent(RESERVE) .expectState(RESERVED) .expectStateChanged(<span class="hljs-number"><span class="hljs-number">1</span></span>) .and() .step() .sendEvent(RESERVE_DECLINE) .expectState(CANCEL_RESERVED) .expectStateChanged(<span class="hljs-number"><span class="hljs-number">1</span></span>) .and() .build(); plan.test(); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testWhenPurchaseComplete</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ StateMachine&lt;PurchaseState, PurchaseEvent&gt; machine = factory.getStateMachine(); StateMachineTestPlan&lt;PurchaseState, PurchaseEvent&gt; plan = StateMachineTestPlanBuilder.&lt;PurchaseState, PurchaseEvent&gt;builder() .defaultAwaitTime(<span class="hljs-number"><span class="hljs-number">2</span></span>) .stateMachine(machine) .step() .expectStates(NEW) .expectStateChanged(<span class="hljs-number"><span class="hljs-number">0</span></span>) .and() .step() .sendEvent(RESERVE) .expectState(RESERVED) .expectStateChanged(<span class="hljs-number"><span class="hljs-number">1</span></span>) .and() .step() .sendEvent(BUY) .expectState(PURCHASE_COMPLETE) .expectStateChanged(<span class="hljs-number"><span class="hljs-number">1</span></span>) .and() .build(); plan.test(); }</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">R√¢teau</b> <div class="spoiler_text">  Si vous voulez soudainement tester votre machine sans augmenter le contexte avec les tests unitaires habituels, vous pouvez cr√©er une machine via le constructeur (partiellement discut√© ci-dessus), cr√©er une instance de la classe avec une configuration et obtenir une action et une protection √† partir de l√†, cela fonctionnera sans contexte, vous pouvez √©crire un petit test Le cadre est sur maquette, ce sera un plus pour v√©rifier quelles actions ont √©t√© appel√©es, lesquelles ne le sont pas, combien de fois, etc., dans diff√©rents cas. <br></div></div><br><h3>  PS </h3><br>     ,         ,    ,          ,   (Guard-   Action-   ) <br><br><h3>  </h3><br>    ,        choice,   ,     switch,     Guards,        ,    choice      Guard,    Events,  ,    ,        . <br><br><h3>  Les r√©f√©rences </h3><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a> <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr462371/">https://habr.com/ru/post/fr462371/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr462355/index.html">Programmation JavaScript asynchrone (rappel, promesse, RxJs)</a></li>
<li><a href="../fr462357/index.html">Premier prototype: Unikernels comme √©tape de l'√©volution de Linux</a></li>
<li><a href="../fr462359/index.html">Dat - de quel protocole s'agit-il et qui l'utilise</a></li>
<li><a href="../fr462365/index.html">Limitations de l'apprentissage automatique</a></li>
<li><a href="../fr462367/index.html">13 faits sur le capital-risque pour les fondateurs</a></li>
<li><a href="../fr462377/index.html">Comment les donjons sont g√©n√©r√©s dans Enter The Gungeon</a></li>
<li><a href="../fr462379/index.html">Chiffrement du fichier de configuration</a></li>
<li><a href="../fr462381/index.html">R√©seaux de neurones et apprentissage profond, chapitre 5: pourquoi les r√©seaux de neurones profonds sont-ils si difficiles √† former?</a></li>
<li><a href="../fr462383/index.html">D'un entrep√¥t au Daghestan aux programmeurs: comment je suis devenu d√©veloppeur iOS √† partir de z√©ro</a></li>
<li><a href="../fr462385/index.html">Une nouvelle approche peut nous aider √† nous d√©barrasser des calculs en virgule flottante</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>