<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§µüèø üñï üßîüèø Telegraff: DSL Kotlin para telegrama üë®‚Äç‚öïÔ∏è üà∑Ô∏è ü§òüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="No Habr√©, milhares de artigos sobre como fazer um bot do Telegram para diferentes linguagens e plataformas de programa√ß√£o. O t√≥pico est√° longe de ser ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Telegraff: DSL Kotlin para telegrama</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/445072/"><p><img src="https://habrastorage.org/webt/3v/da/0z/3vda0ztz83mtq8efycve_gfyrqa.png" alt="Logomarca"></p><br><p>  No Habr√©, milhares de artigos sobre como fazer um bot do Telegram para diferentes linguagens e plataformas de programa√ß√£o.  O t√≥pico est√° longe de ser novo. </p><br><p>  Mas o Telegraff √© a melhor estrutura para implementar os bots do Telegram, e vou provar isso por baixo. </p><a name="habracut"></a><br><h2 id="preambula">  Pre√¢mbulo </h2><br><p>  Em 2015, o rublo russo estava com febre.  Economizei d√≥lares e verifiquei a taxa literalmente a cada cinco minutos para vender a moeda na taxa que eu precisava.  A febre se arrastou, eu me cansei e escrevi para o bot do Telegram ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">@TinkoffRatesBot</a> ), que o notifica se a taxa de c√¢mbio atingir o valor limite (esperado). <br>  Fiquei muito emocionado com esta tarefa.  Botha escreveu muito rapidamente, mas ele n√£o recebeu satisfa√ß√£o. </p><br><p> A integra√ß√£o com o Telegram n√£o √© e n√£o houve problemas.  Esse problema foi resolvido em algumas horas.  E at√© me surpreendo que existam bibliotecas inteiras em Java (subjetivamente, com c√≥digo nojento em qualidade) para integra√ß√£o com os Telegrams, que ganharam mais de mil estrelas no Github. </p><br><p>  O principal desafio para mim foi o sistema de script: o usu√°rio chama um comando, por exemplo, "/ taxi", o bot faz uma s√©rie de perguntas, cada resposta √© validada e pode afetar a ordem das perguntas subsequentes, a "forma" usual √© formada, dada ao m√©todo de processamento final para a forma√ß√£o resposta. <br>  Eu fiz isso, mas a estrutura das classes, os n√≠veis de abstra√ß√£o, era tudo t√£o heterog√™neo que era amargo de se olhar.  Fiquei atormentado com a pergunta: como isso pode ser sucinta e organicamente transferido para um modelo orientado a objetos? </p><br><p>  Eu queria ter algo simples, conveniente e mais importante - para poder descrever o script inteiro em um arquivo isolado, para n√£o precisar visualizar metade do projeto para entender a cadeia de intera√ß√£o do usu√°rio. </p><br><p>  Para n√£o dizer que o problema foi muito agudo, porque a tarefa j√° foi resolvida.  Em vez disso, √†s vezes eu pensava nele.  O pensamento era Groovy DSL, mas quando Kotlin chegou, a escolha se tornou √≥bvia.  Ent√£o Telegraff apareceu. </p><br><p>  Sim, claro, n√£o havia competi√ß√£o que a Telegraff vencesse.  E a alega√ß√£o de que Telegraff √© o melhor n√£o deve ser tomada literalmente.  Mas o Telegraff √© uma abordagem nova e √∫nica para esse desafio.  √â f√°cil ser o melhor, sendo o √∫nico. </p><br><h2 id="kak-etim-polzovatsya">  Como us√°-lo? </h2><br><h3 id="zavisimosti">  Depend√™ncias </h3><br><p>  A primeira etapa √© especificar um reposit√≥rio adicional para depend√™ncias.  Talvez em algum momento eu publiquei o Telegraff no Maven Central ou no JCenter, mas por enquanto. </p><br><div class="spoiler">  <b class="spoiler_title">Gradle</b> <div class="spoiler_text"><pre><code class="kotlin hljs">repositories { maven { url <span class="hljs-string"><span class="hljs-string">"https://dl.bintray.com/ruslanys/maven"</span></span> } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Maven</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">repositories</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">repository</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">snapshots</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">enabled</span></span></span><span class="hljs-tag">&gt;</span></span>false<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">enabled</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">snapshots</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">id</span></span></span><span class="hljs-tag">&gt;</span></span>bintray-ruslanys-maven<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">id</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>bintray<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">url</span></span></span><span class="hljs-tag">&gt;</span></span>https://dl.bintray.com/ruslanys/maven<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">url</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">repository</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">repositories</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> </div></div><br><p>  Continua sendo o caso dos pequenos.  Para usar o Telegraff, √© necess√°rio especificar apenas uma depend√™ncia do iniciador de inicializa√ß√£o por mola: </p><br><div class="spoiler">  <b class="spoiler_title">Gradle</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">compile("me.ruslanys.telegraff:telegraff-starter:1.0.0")</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Maven</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>me.ruslanys.telegraff<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>telegraff-starter<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>1.0.0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> </div></div><br><h3 id="konfiguraciya">  Configura√ß√£o </h3><br><p>  A configura√ß√£o do projeto √© simples e pode ser limitada aos dois ou tr√™s primeiros par√¢metros: </p><br><div class="spoiler">  <b class="spoiler_title">application.properties</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">telegram.access-key=123 # ‚ë† telegram.mode=webhook # ‚ë° telegram.webhook-base-url=https://ruslanys.me # ‚ë¢ telegram.webhook-endpoint-url=/telegram # ‚ë£ telegram.handlers-path=handlers # ‚ë§ telegram.unresolved-filter.enabled=false # ‚ë•</code> </pre> </div></div><br><ol><li>  Sua chave para a API do Telegram. </li><li>  O modo de receber mensagens (atualiza√ß√µes) do Telegram.  Pode ser polling ou webhook. </li><li>  Se o m√©todo para receber atualiza√ß√µes for indicado por "webhook", voc√™ dever√° especificar o caminho para o seu aplicativo. </li><li>  Se desejar, voc√™ pode especificar seu pr√≥prio caminho para o terminal.  Se esse par√¢metro n√£o for redefinido, ser√° gerado um caminho com o seguinte formul√°rio: <code>/telegram/${UUID}</code> .  Antes de iniciar o aplicativo, o endere√ßo especificado √© definido como o endere√ßo do gancho da web.  No final do trabalho, o endere√ßo do gancho da Web √© substitu√≠do para poder mudar para a pesquisa na pr√≥xima vez em que for iniciado. </li><li>  Se desejar, voc√™ pode alterar a pasta na qual os scripts dos manipuladores ser√£o localizados.  Por padr√£o, esta √© a pasta de <code>handlers</code> . </li><li>  <code>UnresolvedFilter</code> est√° inclu√≠do na "entrega" e est√° ativado por padr√£o.  Caso nenhum manipulador tenha sido encontrado na mensagem do usu√°rio, o <code>UnresolvedFilter</code> responde com algo como "Desculpe, eu n√£o entendo voc√™ :(". </li></ol><br><p>  √â hora de escrever scripts! </p><br><h3 id="obrabotchiki">  Manipuladores </h3><br><p>  Manipuladores (scripts) s√£o uma parte essencial do Telegraff.  √â aqui que a cadeia de intera√ß√£o do usu√°rio √© definida.  A linha inferior √© que cada comando, como ‚Äú/ start‚Äù, ‚Äú/ taxi‚Äù, ‚Äú/ help‚Äù, √© um script / script / manipulador / manipulador separado. </p><br><p>  Um script pode conter um conjunto de etapas (perguntas) pelas quais um usu√°rio precisa executar para executar um comando.  Em outras palavras, o usu√°rio deve preencher o formul√°rio.  E como o messenger √© da interface, voc√™ precisa conversar e perguntar ao usu√°rio. </p><br><p>  Preciso explicar que as respostas do usu√°rio precisam ser validadas?  A primeira coisa que o usu√°rio far√° √© que ele responda de maneira diferente do que voc√™ espera. </p><br><p>  Bem, no final, o script pode ramificar, ou seja,  Cada resposta a uma pergunta pode afetar a ordem das seguintes. </p><br><p>  Por exemplo! </p><br><p>  Para iniciar, coloque o arquivo com a extens√£o <code>.kts</code> na pasta com <code>handlers</code> recursos: <code>src/main/resources/handlers/ExampleHandler.kts</code> . </p><br><div class="spoiler">  <b class="spoiler_title">Cen√°rio de chamada de t√°xi</b> <div class="spoiler_text"><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PaymentMethod</span></span></span><span class="hljs-class"> </span></span>{ CARD, CASH } handler(<span class="hljs-string"><span class="hljs-string">"/taxi"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// ‚ë† step&lt;String&gt;("locationFrom") { // ‚ë° question { // ‚ë¢ MarkdownMessage(" ?") } } step&lt;String&gt;("locationTo") { question { MarkdownMessage(" ?") } } step&lt;PaymentMethod&gt;("paymentMethod") { question { state -&gt; MarkdownMessage("   ?", "", "") // ‚ë£ } validation { // ‚ë§ when (it.toLowerCase()) { "" -&gt; PaymentMethod.CARD "" -&gt; PaymentMethod.CASH else -&gt; throw ValidationException(",    ") // ‚ë• } } next { state -&gt; null // ‚ë¶ } } process { state, answers -&gt; // ‚ëß val from = answers["locationFrom"] as String val to = answers["locationTo"] as String val paymentMethod = answers["paymentMethod"] as PaymentMethod // ‚ë® // Business logic MarkdownMessage("""     #${state.chat.id}.   $from  $to.  $paymentMethod. """.trimIndent()) // ‚ë© } }</span></span></code> </pre> </div></div><br><p>  As chaves das estepes n√£o foram deliberadamente tomadas em constantes.  Na produ√ß√£o, √© claro, √© melhor evitar isso. </p><br><p>  Vamos descobrir isso: </p><br><ol><li>  Declaramos o script.  √â necess√°rio pelo menos um nome de equipe.  Nesse caso, existem duas equipes: "/ taxi", "taxi".  Se a mensagem do usu√°rio come√ßar com essas palavras, o manipulador correspondente ser√° chamado. </li><li>  N√≥s determinamos as etapas (perguntas).  Um nome de etapa exclusivo √© necess√°rio porque  posteriormente, a resposta do usu√°rio pode ser acessada com precis√£o por essa chave ("locationFrom"). </li><li>  Cada etapa cont√©m tr√™s se√ß√µes, a primeira das quais √© a pr√≥pria pergunta.  A quest√£o √© uma se√ß√£o obrigat√≥ria que deve estar presente em todas as etapas.  N√£o h√° sentido em uma etapa sem uma pergunta. </li><li>  Voc√™ pode preencher a pergunta como desejar.  Nesse caso, o usu√°rio ser√° solicitado, atrav√©s do teclado, a selecionar uma das op√ß√µes: "Cart√£o" ou "Dinheiro".  Como resultado da chamada desse bloco, deve haver um objeto do tipo <code>TelegramSendRequest</code> .  Desculpe, n√£o consegui encontrar nada melhor que o sufixo <code>SendRequest</code> , que descreve a estrutura como uma solicita√ß√£o de sa√≠da no Telegram. <br><img src="https://habrastorage.org/webt/zc/fg/u0/zcfgu08yo--cn3bhnrnhawcfad0.png" alt="Estrutura de classe"></li><li>  A segunda se√ß√£o da etapa mais importante √© verificar a resposta do usu√°rio.  O tipo de cada etapa √© parametrizado (gen√©rico) e, portanto, o bloco de valida√ß√£o deve retornar exatamente o tipo pelo qual sua etapa √© parametrizada. </li><li>  Se a resposta do usu√°rio for insatisfat√≥ria, voc√™ poder√° lan√ßar uma <code>ValidationException</code> com texto esclarecedor, mas com o mesmo teclado, se indicado na pergunta. </li><li>  A se√ß√£o da etapa final √© um bloco que indica a pr√≥xima etapa.  Por padr√£o, as etapas ser√£o executadas na ordem de sua declara√ß√£o, de cima para baixo.  Mas esse processo pode ser influenciado substituindo o bloco correspondente.  A chave da pr√≥xima etapa ( <code>String</code> ) ou ‚Äúnull‚Äù pode ser retornada como resultado da execu√ß√£o deste bloco, indicando que n√£o h√° mais etapas e √© hora de prosseguir com a execu√ß√£o do comando. </li><li>  Quando uma solicita√ß√£o do usu√°rio √© gerada, seu processamento √© necess√°rio.  Os argumentos no lambda s√£o State (isso √© algo como uma sess√£o) e respostas do usu√°rio. </li><li>  Observe que a resposta com falha n√£o √© mais a sequ√™ncia de respostas do usu√°rio, mas um objeto j√° processado do tipo desejado. </li><li>  A resposta ao comando pode ser qualquer uma, semelhante ao par√°grafo 4. Se a resposta ao comando n√£o for necess√°ria, voc√™ poder√° retornar "nulo". </li></ol><br><p>  Um manipulador pode n√£o ter etapas.  Nesse caso, voc√™ s√≥ precisa determinar o comportamento do manipulador para chamar o comando. </p><br><div class="spoiler">  <b class="spoiler_title">Script de boas-vindas</b> <div class="spoiler_text"><pre> <code class="kotlin hljs">handler(<span class="hljs-string"><span class="hljs-string">"/start"</span></span>) { process { _, _ -&gt; MarkdownMessage(<span class="hljs-string"><span class="hljs-string">"!"</span></span>) } }</code> </pre> </div></div><br><h3 id="probuem">  Experimente </h3><br><p>  Para tentar, bifurque o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">reposit√≥rio</a> , clone-o na m√°quina local e v√° para a pasta <code>telegraff-sample</code> .  Configure, inicie, toque! </p><br><p>  Em geral, <code>telegraff-sample</code> √© um projeto deliberadamente independente, que n√£o est√° relacionado ao pai e tem seu pr√≥prio Gradle Wrapper.  Voc√™ pode deixar apenas esta pasta.  Este √© um tipo de arqu√©tipo. </p><br><h2 id="kak-eto-ustroeno">  Como isso funciona? </h2><br><h3 id="telegram">  Telegram </h3><br><p>  A integra√ß√£o com o Telegram √© muito simples e implementada no <a href=""><code>TelegramApi</code></a> . </p><br><p>  Cada m√©todo foi deliberadamente implementado individualmente devido a v√°rias circunst√¢ncias: a partir do uso do RestTemplate da Spring (e testes para ele), at√© a especificidade da API do Telegram. </p><br><p>  Como voc√™ pode ver na configura√ß√£o, existem dois tipos de clientes dessa API no Telegraff: <a href="">PollingClient</a> , <a href="">WebhookClient</a> .  Dependendo da configura√ß√£o, uma posi√ß√£o espec√≠fica ser√° declarada. </p><br><p>  E embora os m√©todos para receber atualiza√ß√µes (novas mensagens) sejam diferentes do Telegram, a ess√™ncia permanece inalterada e resume-se a uma coisa: publicar um evento ( <a href=""><code>TelegramUpdateEvent</code></a> ) sobre novas mensagens no <code>EventPublisher</code> da Spring (padr√£o "Observer").  Se desejar, voc√™ pode implementar seu pr√≥prio ouvinte assinando esse tipo de evento.  Uma camada l√≥gica, como me parece, de abstra√ß√£o, porque absolutamente n√£o importa como a mensagem foi recebida. </p><br><h3 id="filtry">  Filtros </h3><br><p>  Assim que uma nova mensagem for recebida, √© necess√°rio process√°-la e responder ao usu√°rio.  Para fazer isso, a mensagem precisa passar pela cadeia de filtros. </p><br><p>  Isso √© semelhante aos filtros Java EE familiares aos programadores Java.  A √∫nica diferen√ßa √© que os chamados Manipuladores (se tra√ßarmos um paralelo com o Java EE, estes s√£o Servlets) n√£o s√£o independentes dos filtros, mas fazem parte deles. </p><br><p><img src="https://habrastorage.org/webt/uo/ok/y8/uooky82zpiurpncn-szq4bdejni.png" alt="Cadeia de filtro"></p><br><p>  Portanto, os filtros s√£o otimizados e podem deixar as mensagens irem mais longe na cadeia, talvez n√£o. </p><br><p>  <code>LoggingFilter</code> √© obviamente o filtro de prioridade mais alta (primeiro) que ser√° chamado como parte do processamento de uma nova mensagem.  Registra as informa√ß√µes em uma mensagem recebida e as envia mais adiante na cadeia.  Eu propositadamente adicionei o <code>LoggingFilter</code> como exemplo.  De fato, pode n√£o fazer sentido, porque  As mensagens recebidas s√£o registradas no n√≠vel do cliente. </p><br><p>  O pr√≥ximo filtro √© <code>CancelFilter</code> .  Funciona essencialmente em conjunto com o <code>HandlersFilter</code> e √© um complemento para ele.  Sua tarefa √© simples: se o usu√°rio deseja abandonar o script atual, ele pode escrever "/ cancel" ou "cancel" e seu Status (sess√£o) deve ser limpo.  Ele pode iniciar qualquer novo cen√°rio sem concluir o anterior.  Por esse motivo, o <code>CancelFilter</code> " <code>CancelFilter</code> " mais alto (priorit√°rio). </p><br><p>  <code>HandlersFilter</code> √© o principal filtro no processo atual.  √â esse filtro que armazena o estado dos bate-papos do usu√°rio, encontra e chama o manipulador (script) desejado, aplica blocos de valida√ß√£o, determina a ordem das etapas e responde ao usu√°rio. </p><br><p>  Se o <code>HandlersFilter</code> n√£o encontrou nenhum manipulador adequado para a mensagem do usu√°rio, na sess√£o ou no conte√∫do, a mensagem √© enviada mais adiante na cadeia.  O filtro extremo √© <code>UnresolvedFilter</code> .  Este √© um filtro que sabe que √© o √∫ltimo, portanto, sua funcionalidade √© simples: se eles chegaram at√© mim, como responder a uma mensagem n√£o est√° claro, direi que n√£o entendi nada.  Parece-me que √© melhor receber pelo menos algumas mensagens do bot se n√£o souber responder, do que n√£o receber nada. </p><br><p>  Para adicionar seu filtro, voc√™ precisa declarar um Bean da classe <code>TelegramFilter</code> e especificar a anota√ß√£o <code>@TelegramFilterOrder(ORDER_NUMBER)</code> . </p><br><div class="spoiler">  <b class="spoiler_title">Exemplo de filtro</b> <div class="spoiler_text"><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-meta"><span class="hljs-meta">@TelegramFilterOrder(Integer.MIN_VALUE)</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LoggingFilter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TelegramFilter { override fun handleMessage</span></span></span></span>(message: TelegramMessage, chain: TelegramFilterChain) { log.info(<span class="hljs-string"><span class="hljs-string">"New message from #{}: {}"</span></span>, message.chat.id, message.text) chain.doFilter(message) } <span class="hljs-keyword"><span class="hljs-keyword">companion</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> log = LoggerFactory.getLogger(LoggingFilter::<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java</span></span></span><span class="hljs-class">) } }</span></span></code> </pre> </div></div><br><p>  √â assim que o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">@TinkoffRatesBot</a> implementa uma ‚Äúcalculadora‚Äù.  Sem chamar nenhum script e comando, voc√™ pode enviar um n√∫mero, por exemplo, "1000" ou at√© uma express√£o inteira, por exemplo, "4500 * 3 - 12000".  O bot calcular√° o resultado da express√£o, aplicar√° as taxas de c√¢mbio atuais ao resultado e exibir√° informa√ß√µes sobre ele.  De fato, o resultado de tais a√ß√µes √© a execu√ß√£o do <code>CalculationFilter</code> , que est√° na cadeia abaixo do <code>HandlersFilter</code> , mas acima do <code>UnresolvedFilter</code> . </p><br><h3 id="obrabotchiki-1">  Manipuladores </h3><br><p>  O sistema de script Telegraff (manipuladores) √© constru√≠do no DSL do Kotlin.  Em resumo, trata-se de lambdas e construtores. </p><br><p>  N√£o vejo o objetivo de visualizar separadamente o DSL Kotlin, porque  essa √© uma conversa completamente diferente.  H√° uma excelente <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documenta√ß√£o</a> do JetBrains e um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">relat√≥rio</a> abrangente do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">i_osipov</a> . </p><br><h3 id="nyuansy">  Nuances </h3><br><p>  Esta se√ß√£o √© dedicada aos recursos atuais.  Todos eles, na minha opini√£o, n√£o s√£o cr√≠ticos, alguns podem ser corrigidos, outros n√£o.  Mas voc√™ precisa saber sobre esses aspectos. </p><br><p>  Se voc√™ deseja participar ou conhece como corrigir um ou outro ponto desta se√ß√£o, ficarei muito agradecido. </p><br><h4 id="telegram-1">  Telegram </h4><br><p>  A camada de integra√ß√£o com o Telegram provavelmente n√£o est√° totalmente descrita.  Apenas os m√©todos que eu precisava foram implementados.  Se houver algo que lhe falte pessoalmente, corrija o <a href=""><code>TelegramApi</code></a> e envie o PR! </p><br><p>  Uma das partes importantes no momento √© a falta de suporte ao teclado embutido (√© quando o teclado est√° diretamente abaixo da mensagem na faixa de op√ß√µes).  A tarefa √© agravada pelo fato de que os teclados em linha precisam ser corretamente "inseridos" na estrutura existente, para que ela permane√ßa simples, conveniente e isolada.  J√° existe uma boa id√©ia para implementar essa funcionalidade, mas ainda n√£o foi implementada e testada de nenhuma forma. </p><br><h4 id="fat-jar">  Frasco de gordura </h4><br><p>  Infelizmente, algumas bibliotecas, como <code>JRuby</code> e provavelmente o <code>Kotlin Embedded Compiler</code> (necess√°rio para compilar scripts), podem ter problemas como parte do <code>Fat JAR</code> .  <code>Fat JAR</code> √© quando seu c√≥digo e todas as suas depend√™ncias s√£o compactados em um arquivo ( <code>*.jar</code> ). </p><br><p>  Para resolver esse problema, voc√™ pode descompactar depend√™ncias em tempo de execu√ß√£o.  Ou seja, quando o aplicativo √© iniciado, a depend√™ncia JAR do pacote principal √© implementada em algum lugar do disco e o caminho de classe √© indicado antes dele.  Isso √© muito f√°cil de fazer atrav√©s <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">da configura√ß√£o</a> <code>bootJar</code> : </p><br><div class="spoiler">  <b class="spoiler_title">Configura√ß√£o de plugins</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">bootJar { requiresUnpack "**/**kotlin**.jar" requiresUnpack "**/**telegraff**.jar" }</code> </pre> </div></div><br><p>  No entanto, para se referir dos manipuladores (scripts) aos seus beans (servi√ßos, por exemplo), eles tamb√©m devem ser descompactados.  O que, em princ√≠pio, elimina os benef√≠cios dessa abordagem. </p><br><p>  A meu ver, o uso do plugin do <code>application</code> Gradle continua sendo o m√©todo mais confi√°vel, simples e conveniente.  Al√©m disso, se voc√™ estiver continhando seu aplicativo, n√£o h√° diferen√ßa no resultado. </p><br><p>  Sobre tudo isso, escrevi com alguns detalhes <a href="">aqui</a> . </p><br><h4 id="poryadok-inicializacii">  Ordem de inicializa√ß√£o </h4><br><p>  Aqui eu gostaria de observar duas circunst√¢ncias. </p><br><p>  Primeiro, se voc√™ observar o cen√°rio de chamada de t√°xi, poder√° ver que a classe <code>enum</code> est√° definida acima da chamada para o <code>handler(...)</code> .  Essa necessidade √© imposta pelo fato de que, de fato, <code>handler</code> √© uma chamada de fun√ß√£o.  Uma chamada de fun√ß√£o, cujo resultado deve ser alguma estrutura, que o Telegraff usar√° mais tarde.  Se, de acordo com o resultado da execu√ß√£o do seu script, a f√°brica n√£o puder trazer o resultado para o tipo desejado, ocorrer√° um erro no est√°gio de inicializa√ß√£o. </p><br><p>  Em segundo lugar, √© necess√°rio lembrar que seus scripts podem ser inicializados antes de todo o aplicativo e beans.  Se, por exemplo, colocarmos um link para o contexto em uma vari√°vel est√°tica e tentarmos obter algum servi√ßo na primeira linha do arquivo de script, pode acontecer que o contexto n√£o o tenha, porque  ainda n√£o foi inicializado.  Para evitar esses problemas, use <a href="">este</a> m√©todo Telegraff.  Ele garante que o contexto seja inicializado e que todos os beans necess√°rios estejam dispon√≠veis.  Um exemplo pode ser visto <a href="">aqui</a> . </p><br><h2 id="zaklyuchenie">  Conclus√£o </h2><br><p>  Eu queria tentar - garfo, <br>  Eu queria corrigi-lo - enviar PR, <br>  Queria agradecer - coloque um asterisco no Github, curta o post e conte para seus amigos! </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Reposit√≥rio do projeto</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt445072/">https://habr.com/ru/post/pt445072/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt445060/index.html">Organizando pesquisas de dados usando os reposit√≥rios de dados-chave do Spring Data</a></li>
<li><a href="../pt445062/index.html">Formato de apresenta√ß√£o moderno?</a></li>
<li><a href="../pt445064/index.html">A batalha pela neutralidade da rede - uma chance de voltar</a></li>
<li><a href="../pt445066/index.html">Como escrevo notas de matem√°tica no LaTeX no Vim</a></li>
<li><a href="../pt445070/index.html">O resumo de materiais interessantes para o desenvolvedor m√≥vel # 291 (18 a 24 de mar√ßo)</a></li>
<li><a href="../pt445074/index.html">Programando o LibreOffice Base. Parte 1</a></li>
<li><a href="../pt445076/index.html">Gigante de TI introduziu firewall definido por servi√ßo</a></li>
<li><a href="../pt445078/index.html">A f√≠sica qu√¢ntica provavelmente proteger√° as redes el√©tricas dos EUA contra hackers</a></li>
<li><a href="../pt445080/index.html">Na R√∫ssia, criar√° uma "ferrovia digital"</a></li>
<li><a href="../pt445082/index.html">No m√™s passado, chamamos Zuckerberg de boob; corrigido: de fato, ele e seu Facebook s√£o uma vergonha</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>