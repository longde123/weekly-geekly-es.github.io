<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçÜ ü§æüèø üå´Ô∏è Acc√®s aux pneus Redd sur les ponts FTDI üßïüèø üîî ü¶è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nous avons termin√© un grand bloc th√©orique montrant comment construire un sous-syst√®me FPGA pour le complexe Redd; comment organiser la communication ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Acc√®s aux pneus Redd sur les ponts FTDI</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/477662/">  Nous avons termin√© un grand bloc th√©orique montrant comment construire un sous-syst√®me FPGA pour le complexe Redd;  comment organiser la communication entre le FPGA et le processeur central du complexe;  combien il est facile d'enregistrer des flux de donn√©es √† haute vitesse dans la RAM, qui est directement connect√©e au FPGA, pour leur transfert ult√©rieur tranquillement vers le processeur central (ou vice versa, pour placer les donn√©es dans cette RAM pour une sortie rapide ult√©rieure sur le canal).  Nous avons examin√© les techniques de tra√ßage du processeur Nios II.  Nous sommes en mesure d'optimiser les performances du syst√®me de processeur bas√© sur Nios II afin que le travail se d√©roule le plus efficacement possible.  En g√©n√©ral, nous avons √©tudi√© toutes les th√©ories minimales n√©cessaires, et il serait temps de passer √† la pratique en concevant un appareil pas tr√®s complexe, mais pratiquement utile ... Mais il y a un MAIS. <br><br>  D'apr√®s les commentaires sur les articles, j'ai remarqu√© que certains lecteurs croient que Redd et FPGA sont comme L√©nine et le Parti.  Qu'elles sont inextricablement li√©es.  En fait, ce n'est pas du tout le cas.  Je voulais juste entamer une conversation sur le complexe Redd avec quelque chose d'int√©ressant, mais quoi de plus int√©ressant que le FPGA?  Eh bien, et commencer une conversation, interrompre d'un coup d'≈ìil est stupide.  Et enfin, le gros bloc logique est termin√©.  Et pour montrer que les FPGA sont loin de l'ensemble de Redd, je propose de faire environ trois articles sur des choses qui ne leur sont pas li√©es.  Eh bien, et apr√®s avoir termin√© ce bloc, allez d√©j√† √† la pratique FPGA. <br><br><img src="https://habrastorage.org/webt/nu/nw/7p/nunw7p7f7c5hcnmlsv7haliroz8.png"><br><a name="habracut"></a><br><h2>  Pr√©sentation </h2><br>  La chose la plus √©tonnante est que d√®s que j'ai d√©cid√© de faire une digression sur d'autres sujets, les bons patrons m'ont lanc√© dans une bataille difficile sur un projet o√π le travail se poursuit avec le langage VHDL et Xilinx FPGA.  Premi√®rement, c'est pourquoi pendant longtemps je n'ai pas pris de stylo en g√©n√©ral, et deuxi√®mement, il est clair que la pr√©paration d'articles pratiques n√©cessite un grand nombre d'exp√©riences.  Il est quelque peu difficile de g√©rer simultan√©ment VHDL / Verilog et Xilinx / Altera.  Il faudrait donc de toute fa√ßon faire une pause dans les histoires sur les FPGA. <br><br>  Alors.  Dans le <a href="https://habr.com/ru/post/452656/">premier article de la s√©rie,</a> nous avons d√©j√† examin√© le sch√©ma structurel du complexe de Redd.  Faisons-le encore une fois. <br><br><img src="https://habrastorage.org/webt/vf/hv/da/vfhvda1kmsax-zkxaue4xu_ysmk.png"><br><br>  Dans l'article d'aujourd'hui, les experts Linux ne trouveront probablement pas beaucoup d'informations pr√©cieuses, mais cela vaut la peine de passer en revue les images superficiellement.  Ceux qui, comme moi, sont habitu√©s √† travailler √† partir de Windows, trouveront une liste de techniques toutes faites qui vous permettront de travailler avec le complexe.  En g√©n√©ral, cet article apportera les comp√©tences de ceux-ci et d'autres groupes de lecteurs √† un d√©nominateur commun. <br><br><div class="spoiler">  <b class="spoiler_title">Articles du cycle pr√©c√©dent</b> <div class="spoiler_text"><ol><li>  <a href="https://habr.com/ru/post/452656/">D√©veloppement du ¬´firmware¬ª le plus simple pour les FPGA install√©s dans Redd, et d√©bogage en utilisant le test de m√©moire comme exemple.</a> </li><li>  <a href="https://habr.com/ru/post/453682/">D√©veloppement du ¬´firmware¬ª le plus simple pour les FPGA install√©s dans Redd.</a>  <a href="https://habr.com/ru/post/453682/">Partie 2. Code de programme.</a> </li><li>  <a href="https://habr.com/ru/post/454938/">D√©veloppement de son propre noyau pour l'int√©gration dans un syst√®me de processeur FPGA.</a> </li><li>  <a href="https://habr.com/ru/post/456008/">D√©veloppement de programmes pour le processeur central Redd sur l'exemple d'acc√®s au FPGA.</a> </li><li>  <a href="https://habr.com/ru/post/462253/">Les premi√®res exp√©riences utilisant le protocole de streaming sur l'exemple de la communication CPU et processeur dans le FPGA Redd.</a> </li><li>  <a href="https://habr.com/ru/post/464795/">Joyeux Quartusel, ou comment le processeur est arriv√© √† une telle vie.</a> </li><li>  <a href="https://habr.com/ru/post/467353/">M√©thodes d'optimisation de code pour Redd.</a>  <a href="https://habr.com/ru/post/467353/">Partie 1: effet de cache.</a> </li><li>  <a href="https://habr.com/ru/post/468027/">M√©thodes d'optimisation de code pour Redd.</a>  <a href="https://habr.com/ru/post/468027/">Partie 2: m√©moire non mise en cache et fonctionnement sur bus parall√®le.</a> </li><li>  <a href="https://habr.com/ru/post/469985/">Optimisation √©tendue du code: remplacement d'un g√©n√©rateur d'horloge pour am√©liorer les performances du syst√®me.</a> </li></ol><br></div></div><br><h2>  Blocs UART (ports s√©rie) </h2><br>  Dans le diagramme, nous voyons le contr√¥leur FT4232 qui impl√©mente 4 ports s√©rie (UART): <br><br><img src="https://habrastorage.org/webt/75/bh/hy/75bhhyfnu_19uedfnkc7bzyrido.png"><br><br>  Mais si vous parlez un peu plus globalement, le complexe Redd n'a pas quatre, mais six ports s√©rie.  Je viens de mentionner que quatre ont des niveaux CMOS et deux autres sont soud√©s sur la carte m√®re, car le complexe est bas√© sur un PC ordinaire. <br><br><img src="https://habrastorage.org/webt/14/vj/pl/14vjplsdplqalj4lcm-4g4nmnvg.png"><br><br>  En cons√©quence, ils ont des niveaux - RS232 (plus ou moins 12 volts).  Ports RS232 - tout est clair avec eux, ils sont affich√©s sous la forme de deux connecteurs DB-9 standard, <br><br><img src="https://habrastorage.org/webt/xk/d0/h6/xkd0h6xvaxlz7gxl8v-r4t9n8de.png"><br><br>  et o√π chercher des lignes avec des niveaux CMOS?  En g√©n√©ral - sur un connecteur commun.  Son brochage est indiqu√© sur le sch√©ma √©lectrique.  Il existe, entre autres, des contacts correspondant √† l'UART. <br><br><img src="https://habrastorage.org/webt/nm/pv/cr/nmpvcraxowuy0oea7wkin1aqulu.png"><br><br>  Ext√©rieurement, ce connecteur se pr√©sente comme suit: <br><br><img src="https://habrastorage.org/webt/mf/qa/8h/mfqa8hkbar6y7u8shn39eiend2a.png"><br><br>  Comment l'utiliser d√©pend de la t√¢che.  Vous pouvez cr√©er un faisceau pour connecter chaque appareil.  Cette approche est utile si quelqu'un utilise le complexe Redd pour tester des appareils du m√™me type fabriqu√©s p√©riodiquement.  Mais le but principal du complexe est toujours de d√©boguer l'√©quipement en cours de d√©veloppement.  Et dans ce cas, il est plus facile de s'y connecter de mani√®re temporaire.  Ce motif temporaire est visible sur les √©conomiseurs d'√©cran pour tous les articles: les fils Aruino sont ins√©r√©s directement dans le connecteur.  Bien s√ªr, compter les contacts est toujours un plaisir, et s'ils s'envolent accidentellement, il est si difficile de r√©tablir la commutation qu'il est plus facile de tout reconnecter √† partir de z√©ro;  par cons√©quent, pour faciliter la vie, il existe une carte de montage sur laquelle vous pouvez vous connecter en utilisant au moins des connecteurs √† deux rang√©es, au moins avec le m√™me c√¢blage Arduino. <br><br><img src="https://habrastorage.org/webt/rb/we/66/rbwe66z9f5eahs3efqpxq93di6e.png"><br><br><h2>  Acc√®s au logiciel UART </h2><br>  Le port s√©rie est un √©l√©ment bien √©tabli et bien standardis√©, donc travailler avec lui ne passe pas par certaines biblioth√®ques FTDI sp√©cifiques, mais par des moyens standard.  Voyons √† quoi ressemblent ces outils sous Linux. <br><br><h4>  Noms des ports </h4><br>  √Ä partir d'un certain nombre d'articles et de forums sur le r√©seau, il s'ensuit que les noms de port fournis par les adaptateurs USB-s√©rie sont au format / dev / ttyUSB0, / dev / ttyUSB1, etc.  Sous Linux, tous les p√©riph√©riques peuvent √™tre visualis√©s en utilisant les m√™mes commandes que pour afficher les r√©pertoires ordinaires (en fait, les p√©riph√©riques sont les m√™mes fichiers).  Voyons quels sont les noms dans notre syst√®me.  Nous donnons la commande: <br>  <b>ls / dev /</b> <br><br><img src="https://habrastorage.org/webt/dj/ho/4g/djho4ghfwyceuqy6fjzezh3gyo8.png"><br><br>  Les noms qui nous int√©ressent sont surlign√©s en rouge.  Quelque chose d'entre eux.  Quel port correspond √† quoi?  Ceux qui connaissent bien Linux connaissent des milliers de sorts pour toutes les occasions.  Mais pour ceux qui travaillaient encore avec Windows 3.1 (enfin, en parall√®le avec la vieille dame tr√®s nerveuse RT-11), c'est toujours difficile √† retenir, avec l'√¢ge, le nouveau est plus difficile √† retenir.  Par cons√©quent, il est plus facile de tout trouver √† chaque fois, en utilisant des m√©thodes simples.  Et j'ai mis en √©vidence l'entr√©e de ce chemin simple avec un cadre vert.  Sous-r√©pertoire conditionnel s√©rie.  Nous regardons maintenant l'espace de noms <b>/ dev /</b> .  Et voyons l'espace <b>/ dev / serial</b> : <br><br><img src="https://habrastorage.org/webt/kw/fc/31/kwfc3189zwxl3ut80xwehvplt70.png"><br><br>  Super!  Nous plongons dans la hi√©rarchie, regardons l'espace <b>/ dev / serial / by-id</b> .  En regardant juste en avant, je dirai que pour un affichage correct, vous devez utiliser la <b>commande ls</b> avec le commutateur <b>‚Äìl</b> (merci √† mon patron pour la clarification).  Autrement dit, nous donnons la commande: <br>  <b>ls ‚Äìl / dev / serial / by-id</b> <br><br><img src="https://habrastorage.org/webt/qq/vl/vd/qqvlvdgcgak3c5cembrbmj4myue.png"><br><br>  D'une part, tout va bien.  Nous savons maintenant quels noms dans l'espace <b>/ dev / ttyUSBX</b> correspondent √† quel p√©riph√©rique.  En particulier, les ports organis√©s par le pont FT4232 (Quad) ont des noms de <b>ttyUSB3</b> √† <b>ttyUSB6</b> .  Mais d'un autre c√¥t√©, en consid√©rant ce site, je me suis rendu compte qu'√† Paris, dans la chambre des poids et mesures, il doit n√©cessairement y avoir une pi√®ce dans laquelle le standard du bordel est plac√© ... Parce qu'en quelque sorte il faut pouvoir mesurer sa valeur.  Eh bien, disons que le manque de ports <b>/ dev / ttyUSB0</b> et <b>/ dev / ttyUSB1</b> peut √™tre facilement expliqu√©.  Mais comment expliquer que les ports ¬´natifs¬ª bas√©s sur la prog√©niture du pont FTDI install√© sont num√©rot√©s parmi les trois premiers, et le contr√¥leur Prolific tiers, ins√©r√© pour un projet sp√©cifique, a pris le port num√©ro 2?  Comment travailler dans un tel environnement?  Demain, quelqu'un va brancher un autre contr√¥leur dans le complexe (car le complexe permet √† diff√©rents groupes de d√©veloppeurs de travailler simultan√©ment avec diff√©rents √©quipements), et les ports se d√©placent √† nouveau.  Quels ports devons-nous enregistrer dans le fichier de configuration pour une application qui fonctionne? <br><br>  Il s'av√®re que tout n'est pas si mal.  Premi√®rement, le nom jaune <b>/ dev / ttyUSB3</b> et le nom bleu <b>/ dev / serial / by-id / usb-FTDI_Quad_RS232-HS-if00-port0</b> sont deux alias du m√™me p√©riph√©rique.  Et la deuxi√®me option peut √©galement √™tre pr√©sent√©e comme le nom du port, mais elle est d√©j√† plus permanente que la premi√®re.  Certes, dans ce cas, tout est quelque peu mauvais.  Un contr√¥leur externe bas√© sur FT4232 peut √™tre branch√© sur le complexe, et il sera d√©j√† n√©cessaire de g√©rer leur num√©rotation.  Et voici ¬´en second lieu¬ª vient √† notre aide.  √Ä savoir, une autre convention de d√©nomination alternative.  Nous nous souvenons que le <b>r√©pertoire / dev / serial</b> contenait non seulement le <b>sous-</b> r√©pertoire <b>/ by-id</b> , mais aussi le <b>sous-</b> r√©pertoire <b>/ by-path</b> .  Nous v√©rifions son contenu (il est situ√© en bas de la figure suivante, sous une ligne rouge). <br><br><img src="https://habrastorage.org/webt/y1/mm/xa/y1mmxabnvjburuzedzirgzusjbm.png"><br><br>  Tout ici est li√© √† l'architecture physique.  Et j'ai d√©j√† dit √† plusieurs reprises que tous les contr√¥leurs √† l'int√©rieur du complexe sont soud√©s aux cartes, donc la hi√©rarchie interne ne changera pas.  Ainsi, le nom <b>/dev/serial/by-path/pci-0000:00:15.0-usb-0:6.5:1.0-port0</b> sera le plus difficile. <br><br>  Au total, nous avons la fa√ßon suivante de rechercher le nom du port (cela doit √™tre fait une fois, les r√©sultats de votre instance du complexe peuvent √™tre mis dans le tableau et utilis√©s en permanence): <br><br><ol><li>  Ex√©cutez la commande <b>ls ‚Äìl / dev / serial / by-id</b> . </li><li>  Ex√©cutez la commande <b>ls ‚Äìl / dev / serial / by-path</b> . </li><li>  √Ä partir des r√©sultats du point 1, recherchez le nom du port correspondant au port requis du pont requis.  Recherchez le m√™me nom de port dans les r√©sultats du paragraphe 2. Prenez le nom physique correspondant √† ce paragraphe. </li></ol><br>  Pour les ports desservis par le contr√¥leur sur la carte m√®re, tout est un peu plus compliqu√©.  Ici, vous ne pouvez pas faire le chemin √† partir de la commande la plus simple " <b>ls / dev</b> ", mais vous devez vous souvenir de quelque chose (enfin, ou du moins, rappelez-vous que vous pouvez contacter ici pour obtenir de l'aide).  Partout, il est indiqu√© que les noms de port typiques sont <b>ttyS0-ttyS3</b> .  La question demeure, sur quels noms sont les vrais ports de notre syst√®me?  J'ai trouv√© le sort suivant r√©pondant √† cette question: <br>  <b>ls / sys / class / tty / * / device / driver</b> <br><br>  Voici la r√©ponse du syst√®me: <br><br><img src="https://habrastorage.org/webt/oc/gi/v7/ocgiv7g8ffmcmzr_bfypwrn__6g.png"><br><br>  Il s'av√®re que nous devons utiliser les noms <b>/ dev / ttyS2</b> et <b>/ dev / ttyS3</b> .  Pourquoi - je ne sais pas.  Mais une chose pla√Æt: ici aucun changement sp√©cial n'est pr√©vu, donc ces constantes peuvent √™tre m√©moris√©es et utilis√©es sans crainte de changer. <br><br><h4>  D√©veloppement de code </h4><br>  Lors du d√©veloppement, vous devez utiliser le merveilleux <b>Guide de programmation s√©rie pour les syst√®mes d'exploitation POSIX</b> (le premier lien direct que vous obtenez est <a href="https://www.cmrr.umn.edu/~strupp/serial.html" rel="nofollow">https://www.cmrr.umn.edu/~strupp/serial.html</a> , mais personne ne sait combien de temps il durera).  Il est particuli√®rement important qu'il indique comment travailler avec un ensemble complet de signaux, car les ports du complexe sont enti√®rement impl√©ment√©s.  Certes, nous n'utiliserons aujourd'hui que les lignes Tx et Rx. <br><br>  Habituellement, je donne les r√©sultats de la forme d'onde, mais maintenant il s'av√®re que je suis dans des conditions presque r√©elles: le complexe est situ√© l√† o√π mes mains ne peuvent pas atteindre, donc je ne peux pas connecter la sonde de l'oscilloscope.  Pour voir au moins un r√©sultat, √† ma demande, mes coll√®gues ont ajout√© quelques publications au complexe selon le sch√©ma classique suivant: <br><br><img src="https://habrastorage.org/webt/4k/it/be/4kitbevmwnyxbllumfdz0qzr2a0.png"><br><br>  Essayons de transf√©rer d'un port √† un autre.  Dans notre cas, les ports <b>/dev/serial/by-path/pci-0000:00:15.0-usb-0:6.5:1.2-port0</b> et <b>/dev/serial/by-path/pci-0000:00:15.0- sont connect√©s usb-0: 6.5: 1.3-port0</b> . <br><br>  Nous avons d√©j√† discut√© de la fa√ßon dont les programmes du processeur central Redd sont √©crits dans l'un des <a href="https://habr.com/ru/post/456008/">articles pr√©c√©dents</a> , donc aujourd'hui nous nous limiterons au texte du programme √©crit sous l'impression du document <b>Serial Programming Guide for POSIX Operating Systems</b> .  En fait, le principal point int√©ressant est de passer de la strat√©gie de r√©ception √† une lecture non bloquante, le reste est trivial.  N√©anmoins, compte tenu du d√©sordre dans les exemples sur le r√©seau √† ce sujet, il est pr√©f√©rable d'avoir un √©chantillon trivial √† port√©e de main (il sera montr√© plus tard que m√™me un exemple bas√© sur ce merveilleux document n'a pas fonctionn√© √† 100%, le code ci-dessous diff√®re des canons qui y sont d√©crits en une seule ligne, mais plus sur celle ci-dessous). <br><br><div class="spoiler">  <b class="spoiler_title">Le m√™me exemple de code</b> <div class="spoiler_text"><pre><code class="plaintext hljs">#include &lt;cstdio&gt; #include &lt;unistd.h&gt; /* UNIX standard function definitions */ #include &lt;fcntl.h&gt; /* File control definitions */ #include &lt;errno.h&gt; /* Error number definitions */ #include &lt;termios.h&gt; /* POSIX terminal control definitions */ int OpenUART(const char* portName, speed_t baudRate) { //   int fd = open(portName, O_RDWR | O_NOCTTY | O_NDELAY); //     if (fd == -1) { return fd; } //     fcntl(fd, F_SETFL, FNDELAY); //    termios options; tcgetattr(fd, &amp;options); // ,       // ,   .  ... cfsetspeed(&amp;options, baudRate); //    ... // 1  ,   , 8    options.c_cflag &amp;= ~PARENB; options.c_cflag &amp;= ~CSTOPB; options.c_cflag &amp;= ~CSIZE; options.c_cflag |= CS8; options.c_cflag |= (CLOCAL | CREAD); // , ... tcsetattr(fd, TCSANOW, &amp;options); return fd; } int main() { printf("hello from ReddUARTTest!\n"); int fd1 = OpenUART("/dev/serial/by-path/pci-0000:00:15.0-usb-0:6.5:1.3-port0", 9600); int fd2 = OpenUART("/dev/serial/by-path/pci-0000:00:15.0-usb-0:6.5:1.2-port0", 9600); if ((fd1 != -1) &amp;&amp; (fd2 != -1)) { static const unsigned char dataForSend[] = {0xff,0xfe,0xfd,0xfb}; //      write(fd1, dataForSend, sizeof(dataForSend)); unsigned char dataForReceive[128]; ssize_t cnt = 0; //     ,  , //         int readSteps = 0; //      ,   while (cnt &lt; (ssize_t)sizeof(dataForSend)) { readSteps += 1; ssize_t rd = read(fd2, dataForReceive + cnt, sizeof(dataForReceive) - cnt); //   - ,     if (rd &lt;= 0) { usleep(1000); } else //  -   { cnt += rd; } } //   printf("%d read operations\n", readSteps); printf("Read Data: "); for (unsigned int i = 0; i &lt; cnt; i++) { printf("%X ", dataForReceive[i]); } printf("\n"); } else { printf("Error with any port open!\n"); } //   if (fd1 != -1) { close(fd1); } if (fd2 != -1) { close(fd2); } return 0; }</code> </pre> <br></div></div><br>  Run - nous obtenons le r√©sultat pr√©vu: <br><br><pre> <code class="plaintext hljs">hello from ReddUARTTest! 14 read operations Read Data: FF FE FD FB</code> </pre><br>  On peut voir que 4 octets ont pris 14 tentatives, c'est-√†-dire que la lecture n'√©tait pas bloquante.  Parfois, le syst√®me renvoyait un √©tat ¬´aucune nouvelle donn√©e¬ª et le programme s'endormait pendant une milliseconde. <br><br>  En g√©n√©ral, tout va bien, mais sans oscilloscope, je ne peux pas √™tre s√ªr que deux ports bas√©s sur la m√™me puce d√©finissent vraiment la vitesse.  J'ai d√©j√† saut√© sur le fait que la vitesse √©tait la m√™me (pour cela il avait un contr√¥leur), mais pas celle que j'avais command√©e.  V√©rifions au moins en quelque sorte qu'il est au moins contr√¥l√©.  Pour ce faire, je vais r√©gler la vitesse du port de r√©ception pour doubler celle du port de transmission.  Et connaissant la physique du processus de transfert de donn√©es, vous pouvez pr√©dire comment ces donn√©es sont d√©form√©es lors de la r√©ception.  Regardons le transfert de l'octet 0xff sous forme graphique.  S - bit de d√©part (il y a toujours z√©ro), P - bit d'arr√™t (il y en a toujours un), 0-7 - bits de donn√©es (pour la constante 0xFF - toutes les unit√©s). <br><br><img src="https://habrastorage.org/webt/kx/0p/cz/kx0pczh7nor5fcn1nhkor8nrwum.png"><br><br>  Maintenant, superposons cette vue avec une vue de la fa√ßon dont tout sera vu par un r√©cepteur fonctionnant √† deux fois la vitesse: <br><br><img src="https://habrastorage.org/webt/mp/n7/qn/mpn7qngefktxruxtyrex7ykrpwk.png"><br><br>  Super.  La valeur "1111 1110" doit √™tre accept√©e (les donn√©es avancent le bit le moins significatif), c'est-√†-dire 0xFE.  La seconde moiti√© de la valeur transmise n'affecte pas la r√©ception, car les unit√©s correspondent au silence dans la ligne.  Autrement dit, nous avons transmis un octet, un octet viendra √©galement. <br><br>  Nous allons construire le m√™me graphique pour la v√©rification, qui correspondra √† la valeur 0xFE transmise: <br><br><img src="https://habrastorage.org/webt/do/e6/x2/doe6x2t9aapieqiat4gtkp9j8_y.png"><br><br>  Attendez-vous √† la valeur "1111 1000" ou 0xF8.  Eh bien, v√©rifions √† quoi s'attendre avec la valeur pass√©e 0xFD: <br><br><img src="https://habrastorage.org/webt/c9/er/d0/c9erd0bsjla_b5bkwpmmzbqnrlm.png"><br><br>  Nous obtenons la valeur 0xE6.  Eh bien, pour la valeur transmise 0xFB, nous obtenons le 0x9E re√ßu (vous pouvez tracer le graphique et voir par vous-m√™me).  Super!  Nous modifions une seule ligne dans l'application de test, en rempla√ßant la vitesse de 9600 par 19200: <br><br><pre> <code class="plaintext hljs"> int fd2 = OpenUART("/dev/serial/by-path/pci-0000:00:15.0-usb-0:6.5:1.2-port0", 19200);</code> </pre><br>  Nous commen√ßons et obtenons ce r√©sultat de travail: <br><br><pre> <code class="plaintext hljs">hello from ReddUARTTest! 9 read operations Read Data: FE F8 E6 9E</code> </pre><br>  Soit dit en passant, je n'ai pas effectu√© en vain cette v√©rification.  Au d√©but, j'ai utilis√© d'autres fonctions de r√©glage de la vitesse (paire cfsetispeed / cfsetospeed), et elles n'ont pas fonctionn√©!  Gr√¢ce √† ce test, le probl√®me a √©t√© identifi√© et r√©solu en temps opportun.  Lorsque vous travaillez avec un √©quipement, vous ne pouvez jamais faire confiance √† l'intuition.  Tout doit √™tre v√©rifi√©! <br><br><h4>  Gestion de la ligne √©lectrique 220 volts </h4><br>  En g√©n√©ral, les lignes √©lectriques 220 volts ne sont pas li√©es au sujet de l'article (ponts FTDI), mais elles sont li√©es au sujet de cette section (ports s√©rie).  Jetons un coup d'≈ìil √† eux. <br><br><img src="https://habrastorage.org/webt/fj/py/1f/fjpy1fqzjfykydgxo28fctebh1c.png"><br><br>  Lorsque nous avons r√©pertori√© les ports, nous avons vu ce nom: <br><br><img src="https://habrastorage.org/webt/rt/0g/k7/rt0gk7ammjno5n1hgfh5waz85ri.png"><br><br>  Il s'agit d'un port s√©rie virtuel.  Il est tellement virtuel qu'il n'a pas d'importance quels param√®tres il a (vitesse du port, nombre de bits, format de parit√©, etc.).  Quels que soient les param√®tres d√©finis, il sera toujours en mesure de g√©rer parfaitement les commandes.  Et ce sont ces √©quipes qui contr√¥lent les prises de courant sur le complexe. <br><br><img src="https://habrastorage.org/webt/yc/ry/sk/ycryskkv2xpfkxnex41xbn5pooo.png"><br><br>  Lors du d√©veloppement du syst√®me de commande, il a √©t√© d√©cid√© d'abandonner les interfaces de commande complexes.  La gestion prend un octet, sans encadrer les cha√Ænes et autres fioritures, bien que l'octet soit textuel (afin qu'il puisse √™tre facilement transf√©r√© du terminal lors du d√©bogage).  Cette concision s'explique facilement: l'interface de cha√Æne vous permet de g√©rer les interf√©rences dans un canal UART non s√©curis√©.  Mais dans notre cas, physiquement, le travail passe par le canal USB, qui est prot√©g√© par des codes de contr√¥le cycliques.  Le traitement du flux de retour n√©cessite d'√©crire du code suppl√©mentaire ou de vider constamment les tampons, ce qui n'est pas toujours pratique.  C'est pourquoi il n'y a pas de rep√®res pour les cha√Ænes, il n'y a pas de r√©ponses.  On pense que le canal est stable.  Si vous voulez une r√©ponse, vous pouvez la demander explicitement.  Autrement dit, les performances du bloc peuvent toujours √™tre facilement v√©rifi√©es en envoyant un octet suppl√©mentaire apr√®s la commande. <br><br>  Consid√©rez les commandes qui peuvent √™tre envoy√©es: <br><div class="scrollable-table"><table><tbody><tr><th>  L'√©quipe </th><th>  Rendez-vous </th></tr><tr><td>  'A' </td><td>  Allumez la premi√®re prise </td></tr><tr><td>  'a' </td><td>  √âteignez la premi√®re prise </td></tr><tr><td>  ¬´B¬ª </td><td>  Allumez la deuxi√®me prise </td></tr><tr><td>  ¬´b¬ª </td><td>  √âteignez la deuxi√®me prise </td></tr><tr><td>  ¬´C¬ª </td><td>  Allumez la troisi√®me prise (le cas √©ch√©ant) </td></tr><tr><td>  ¬´c¬ª </td><td>  √âteignez la troisi√®me prise (le cas √©ch√©ant) </td></tr><tr><td>  '?' </td><td>  Restaurer l'√©tat de la prise </td></tr></tbody></table></div><br>  La commande '?'  (point d'interrogation) est le seul qui renvoie une r√©ponse.  En r√©ponse, 3 octets viennent toujours, chacun correspondant √† l'√©tat de l'une des prises.  En fait, les √©tats correspondent aux commandes.  Par exemple, 'abc' - les trois prises sont maintenant ferm√©es, 'Abc' - la premi√®re est allum√©e, la deuxi√®me et la troisi√®me sont √©teintes, etc. <br><br>  Pour les exp√©riences avec ce sous-syst√®me, je sugg√®re de ne pas √©crire un programme sp√©cial (il n'est pas diff√©rent de celui donn√© pr√©c√©demment, seules les donn√©es envoy√©es aux ports seront diff√©rentes), mais d'utiliser les outils du syst√®me d'exploitation et de jouer de mani√®re interactive avec les sockets. <br><br>  Apr√®s de nombreuses exp√©riences avec le suivi du port via la commande cat et l'envoi de commandes dans une fen√™tre parall√®le en utilisant le programme echo, je me suis rendu compte que pour une raison quelconque je ne peux pas obtenir de r√©sultats dans une paire de terminaux ssh √† base de mastic (m√™me en jouant avec les ports avec lesquels seuls qu'il a parfaitement exp√©riment√© avec son programme).  Par cons√©quent, j'ai d√ª installer le programme minicom standard.  Permettez-moi de vous rappeler la commande d'installation: <br>  <b>sudo apt-get minicom</b> <br><br>  Ensuite, ex√©cutez-le avec la commande: <br>  <b>minicom ‚ÄìD / dev / ttyACM0</b> <br><br>  Le nom du port est court, car avec des exp√©riences manuelles, il est plus facile d'entrer.  Dans le travail logiciel, comme toujours, il est pr√©f√©rable d'utiliser un nom li√© √† la hi√©rarchie mat√©rielle.  Encore une fois, je note que je ne configure aucun autre param√®tre de port car il est virtuel.  Cela fonctionnera avec tous les param√®tres. <br><br>  Ensuite, nous appuyons sur le point d'interrogation dans le terminal et instantan√©ment (sans saut de ligne) nous obtenons une r√©ponse <br><br><img src="https://habrastorage.org/webt/41/my/-j/41my-jjk9cffmmflot_zk_ph0ck.png"><br><br>  Cela signifie que toutes les prises sont actuellement d√©sactiv√©es.  Disons que nous voulons activer la deuxi√®me prise.  Appuyez sur la majuscule ¬´B¬ª.  Il n'y a aucune r√©action √† l'√©cran.  Appuyez sur "?" Encore une fois, nous obtenons une nouvelle ligne avec la r√©ponse: <br><br><img src="https://habrastorage.org/webt/5i/uz/-r/5iuz-rrjfbmier5bfmazwx1svb0.png"><br><br>  Tout fonctionne.  N'oubliez pas de couper 220 volts (commande 'b').  Vous pouvez quitter le terminal en appuyant successivement sur ctrl + A, puis sur X. L'exp√©rience est termin√©e. <br><br><h2>  Pneus SPI et I <sup>2</sup> C </h2><br>  Les bus SPI (qui peuvent √©galement fonctionner en mode Quad-SPI) et I <sup>2</sup> C sont impl√©ment√©s en combinaison avec des ponts universels.  Autrement dit, le complexe a deux ponts, chacun pouvant √™tre allum√© soit en mode SPI soit en I <sup>2</sup> C. Dans le sch√©ma structurel, la section correspondante ressemble √† ceci: <br><br><img src="https://habrastorage.org/webt/uy/lp/6k/uylp6kc6vcqjrlwluk5nxzpcezc.png"><br><br>  L'essence de l'allumage des bus finaux est visible sur le sch√©ma √©lectrique.  Consid√©rez un seul des deux contr√¥leurs: <br><br><img src="https://habrastorage.org/webt/ah/rj/ah/ahrjahvujglcs3uoxl-wsdxfcpy.png"><br><br>  Ainsi, les bus SPI et I <sup>2</sup> C ne se croisent en aucune fa√ßon.  Les restrictions √† leur utilisation conjointe ne sont d√©termin√©es que par les restrictions impos√©es par FTDI dans le contr√¥leur FT4222H.  Malheureusement, la documentation indique qu'une seule interface peut √™tre active √† la fois: <br><br><img src="https://habrastorage.org/webt/zc/7d/dw/zc7ddwfm-tstpt9lumoydqexceu.png"><br><br>  Comment g√©rer les lignes CFG1_0..CFG1_1 et CFG2_0..CFG2_1, nous nous rencontrerons dans le prochain article.  Maintenant, nous pensons qu'ils sont tous annul√©s. <br><br>  En g√©n√©ral, le travail avec le contr√¥leur est tr√®s bien d√©crit dans le document <b>FT4222H USB2.0 TO QUADSPI / I2C BRIDGE IC</b> , donc nous ne consid√©rerons pas les caract√©ristiques des modes de fonctionnement des contr√¥leurs.  Tout est tr√®s clair √† partir du document mentionn√©. <br><br>  Quant au support logiciel, sa description se trouve dans le document non moins remarquable <b>AN_329 User Guide For LibFT4222</b> .  Nous avons d√©j√† travaill√© deux fois avec le pont FTDI: dans la seconde moiti√© de <a href="https://habr.com/ru/post/456008/">cet article</a> et dans la seconde moiti√© de <a href="https://habr.com/ru/post/462253/">celui-ci</a> .  Par cons√©quent, en comparant ce document avec ces articles, vous pouvez rapidement le comprendre et commencer √† √©crire votre propre code.  Permettez-moi de vous montrer le code de r√©f√©rence qui envoie des donn√©es au bus SPI, sans s'attarder sur les d√©tails de sa mise en ≈ìuvre, il semble douloureusement qu'il a d√©j√† √©t√© analys√© avec FT2232. <br><br><div class="spoiler">  <b class="spoiler_title">Code qui envoie des donn√©es au bus SPI.</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">#include "../ftd2xx/ftd2xx.h" #include "../LibFT4222/inc/LibFT4222.h" void SpiTest (int pos) { FT_HANDLE ftHandle = NULL; FT_STATUS ftStatus; FT4222_STATUS ft4222Status; //   ftStatus = FT_Open(pos, &amp;ftHandle); if (FT_OK != ftStatus) { // open failed printf ("error: Cannot Open FTDI Device\n"); return; } ft4222Status = FT4222_SPIMaster_Init(ftHandle, SPI_IO_SINGLE, CLK_DIV_4, CLK_IDLE_LOW, CLK_LEADING, 0x01); if (FT4222_OK != ft4222Status) { printf ("error: Cannot switch to SPI Master Mode\n"); // spi master init failed return; } uint8 wrBuf [] = {0x9f,0xff,0xff,0xff,0xff,0xff,0xff}; uint8 rdBuf [sizeof (wrBuf)]; uint16 dwRead; ft4222Status = FT4222_SPIMaster_SingleReadWrite (ftHandle,rdBuf,wrBuf,sizeof (wrBuf),&amp;dwRead,TRUE); if (FT4222_OK != ft4222Status) { printf ("error: Error on ReadWrite\n"); } else { printf ("received: "); for (int i=0;i&lt;6;i++) { printf ("0x%X ",rdBuf[i]); } printf ("\n"); } FT4222_UnInitialize(ftHandle); FT_Close(ftHandle); }</code> </pre><br></div></div><br><h4>  Pi√®ces d'autobus SPI </h4><br>  Les d√©veloppeurs de code pour microcontr√¥leurs utilisent souvent le bus SPI comme g√©n√©rateur d'une fr√©quence pr√©d√©termin√©e.  En effet, les impulsions g√©n√©r√©es uniquement par programmation via les lignes GPIO d√©pendent de nombreux facteurs.  Tout d'abord, la ramification, la rotation de la boucle, n√©cessitent des cycles de processeur.  Deuxi√®mement, les interruptions, le DMA et d'autres facteurs impr√©vus peuvent interf√©rer avec le processeur.  SPI est plus ou moins stable, sachez vous-m√™me r√©ussir √† mettre des octets dans le buffer.  Une application typique du bloc SPI, qui n'a pas de relation directe avec ce SPI lui-m√™me, est le contr√¥le des LED RVB, pour lesquelles la pr√©cision du r√©glage de la dur√©e des impulsions est tr√®s importante. <br><br>  Malheureusement, cela n'est pas acceptable pour les ponts FTDI.  Le fragment de code ci-dessus g√©n√©rera ces impulsions sur le bus: <br><br><img src="https://habrastorage.org/webt/dv/zx/pe/dvzxpe6cevog4qaklf2zy8tkdye.png"><br><br>  Dans ce cas, les r√®gles de fonctionnement SPI ne sont pas viol√©es, du point de vue de ce bus, tout fonctionne correctement.  Gardez √† l'esprit que les solutions personnalis√©es habituelles sur les contr√¥leurs ne fonctionneront pas ici.  Certes, le complexe a beaucoup de connecteurs USB gratuits.  Tous les blocs non standard peuvent √™tre d√©velopp√©s s√©par√©ment et connect√©s √† eux. <br><br><h4>  Pi√®ces de pneu I <sup>2</sup> C </h4><br>  La seule chose sens√©e est d'indiquer l'absence de r√©sistances pull-up pour le bus I <sup>2</sup> C du c√¥t√© du complexe.  Mais c'est normal: sur le c√¥t√© de l'appareil de travail, il y a encore un ascenseur.  De nos jours, un pull-up peut √™tre √† n'importe quelle tension, il est donc logique qu'il soit r√©gl√© sur le p√©riph√©rique cible. <br><br><h2>  Conclusion </h2><br>  Aujourd'hui, nous avons acquis des comp√©tences pratiques pour travailler avec des pneus mis en ≈ìuvre par des ponts FTDI.  En g√©n√©ral, travailler avec eux est standard, c'est juste que toutes les connaissances sont r√©sum√©es dans un seul article, afin de ne pas les chercher petit √† petit.  La prochaine fois, nous consid√©rerons un module qui contr√¥le des appareils non standard, impl√©ment√© sur la base du contr√¥leur STM32.  Dans le sch√©ma structurel, cette section y correspond: <br><br><img src="https://habrastorage.org/webt/ic/w4/9g/icw49gdqjdx26qahasd425ul-sm.png"><br><br>  Mais vraiment, tout y est un peu plus int√©ressant ... </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr477662/">https://habr.com/ru/post/fr477662/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr477648/index.html">MVCC dans PostgreSQL-3. Versions en ligne</a></li>
<li><a href="../fr477650/index.html">Cryptage du trafic TLS selon les algorithmes GOST-2012 avec Stunnel</a></li>
<li><a href="../fr477654/index.html">Essayer l'op√©rateur instanceof am√©lior√© dans Java 14</a></li>
<li><a href="../fr477656/index.html">Alors, pourquoi avez-vous besoin de faire?</a></li>
<li><a href="../fr477658/index.html">Active Restore: la reprise apr√®s sinistre peut-elle √™tre plus rapide? Beaucoup plus vite?</a></li>
<li><a href="../fr477668/index.html">29 novembre, 18 h - devleads-mitap</a></li>
<li><a href="../fr477670/index.html">Ce qui donne l'automatisation des tests</a></li>
<li><a href="../fr477672/index.html">Droits et obligations des membres de l'√©quipe: aspects juridiques et culturels</a></li>
<li><a href="../fr477674/index.html">AI signifie amour?</a></li>
<li><a href="../fr477678/index.html">Perspectives pour la t√©l√©vision num√©rique en Russie</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>