<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçó üö£üèæ „Ä∞Ô∏è Clusterspeicher f√ºr kleine Webcluster basierend auf drbd + ocfs2 üë®üèø‚Äçü§ù‚Äçüë®üèª ‚å®Ô∏è üöô</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Wor√ºber wir sprechen werden: 
 So stellen Sie schnell gemeinsam genutzten Speicher f√ºr zwei Server bereit, basierend auf drbd + ocfs2-L√∂sungen. 

 F√ºr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Clusterspeicher f√ºr kleine Webcluster basierend auf drbd + ocfs2</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/445612/">  <b>Wor√ºber wir sprechen werden:</b> <br>  So stellen Sie schnell gemeinsam genutzten Speicher f√ºr zwei Server bereit, basierend auf drbd + ocfs2-L√∂sungen. <br><br>  <b>F√ºr wen wird es n√ºtzlich sein:</b> <br>  Das Lernprogramm ist n√ºtzlich f√ºr Systemadministratoren und alle, die eine Speicherimplementierungsmethode ausw√§hlen oder eine L√∂sung ausprobieren m√∂chten. <br><br><h3>  Welche Entscheidungen haben wir abgelehnt und warum? </h3><br>  Oft sind wir mit einer Situation konfrontiert, in der wir einen gemeinsamen Speicher in einem kleinen Webcluster mit guter Lese- / Schreibleistung implementieren m√ºssen.  Wir haben verschiedene Optionen f√ºr die Implementierung eines gemeinsamen Repositorys f√ºr unsere Projekte ausprobiert, aber wenig konnte uns f√ºr mehrere Indikatoren sofort zufriedenstellen.  Lassen Sie uns nun erkl√§ren, warum. <br><br><ul><li> Glusterfs passte nicht zu unserer Lese- und Schreibleistung, es gab Probleme beim gleichzeitigen Lesen einer gro√üen Anzahl von Dateien, es gab eine hohe Belastung f√ºr die CPU.  Das Problem beim Lesen von Dateien k√∂nnte gel√∂st werden, indem sie direkt im Baustein beantragt werden. Dies ist jedoch nicht immer zutreffend und im Allgemeinen falsch. </li></ul><br><ul><li>  Ceph gefiel die √ºberm√§√üige Komplexit√§t nicht, die bei Projekten mit 2 bis 4 Servern sch√§dlich sein kann, insbesondere wenn das Projekt anschlie√üend gewartet wird.  Auch hier gibt es schwerwiegende Leistungseinschr√§nkungen, die Sie dazu zwingen, separate Speichercluster wie bei glusterfs zu erstellen. </li></ul><br><ul><li>  Die Verwendung eines NFS-Servers zum Implementieren von gemeinsam genutztem Speicher f√ºhrt zu Fehlertoleranzproblemen. </li></ul><br><ul><li>  s3 ist eine ausgezeichnete und beliebte L√∂sung f√ºr eine Reihe von Aufgaben, aber es ist kein Dateisystem, das den Umfang einschr√§nkt. </li></ul><a name="habracut"></a><br><ul><li>  lsyncd.  Wenn wir bereits √ºber "Nicht-Dateisysteme" gesprochen haben, lohnt es sich, diese beliebte L√∂sung zu betrachten.  Es ist nicht nur nicht f√ºr den bidirektionalen Austausch geeignet (aber wenn Sie es wirklich wollen, k√∂nnen Sie es auch), es funktioniert auch nicht stabil bei einer gro√üen Anzahl von Dateien.  Eine sch√∂ne Erg√§nzung zu allem wird sein, dass es Single-Threaded ist.  Der Grund liegt in der Architektur des Programms: Es verwendet inotify, um die Arbeitsobjekte zu √ºberwachen, die beim Start und beim erneuten Scannen h√§ngen bleiben.  Rsync wird als √úbertragungsmedium verwendet. </li></ul><br><h3>  Tutorial: Bereitstellen von gemeinsam genutztem Speicher basierend auf drbd + ocfs2 </h3><br>  Eine der bequemsten L√∂sungen f√ºr uns war eine Reihe von <b>ocfs2 + drbd</b> .  Jetzt zeigen wir Ihnen, wie Sie gemeinsam genutzten Speicher f√ºr zwei Server basierend auf einer Datenbank mit L√∂sungen schnell bereitstellen k√∂nnen.  Aber zuerst ein wenig zu den Komponenten: <br><br>  <b>DRBD</b> ist das Standard-Linux-Speichersystem, mit dem Daten zwischen Serverbl√∂cken repliziert werden k√∂nnen.  Die Hauptanwendung ist das Erstellen fehlertoleranter Speicher. <br><br>  <b>OCFS2</b> ist ein Dateisystem, das die gemeinsame Nutzung desselben Speichers durch mehrere Systeme erm√∂glicht.  In der Distribution von Linux enthalten und ist ein Kernelmodul und Userspace-Tools f√ºr die Arbeit mit FS.  OCFS2 kann nicht nur √ºber DRBD, sondern auch √ºber iSCSI mit mehreren Verbindungen verwendet werden.  In unserem Beispiel verwenden wir DRBD. <br><br>  Alle Aktionen werden auf dem Ubuntu-Server 18.04 in einer minimalen Konfiguration ausgef√ºhrt. <br><br>  <b>Schritt 1. DRBD konfigurieren:</b> <b><br></b> <br>  In der Datei /etc/drbd.d/drbd0.res beschreiben wir unser virtuelles Blockger√§t / dev / drbd0: <br><br><pre><code class="plaintext hljs">resource drbd0 { syncer { rate 1000M; } net { allow-two-primaries; after-sb-0pri discard-zero-changes; after-sb-1pri discard-secondary; after-sb-2pri disconnect; } startup { become-primary-on both; } on drbd1 { meta-disk internal; device /dev/drbd0; disk /dev/vdb1; address 10.10.10.192:7789; } on drbd2 { meta-disk internal; device /dev/drbd0; disk /dev/vdb1; address 10.10.10.193:7789; } }</code> </pre> <br>  <i>Meta-Disk intern</i> - Verwenden Sie dieselben Blockger√§te zum Speichern von Metadaten <br>  <i>device / dev / drbd0</i> - Verwenden Sie / dev / drbd0 als Pfad zum drbd-Volume. <br>  <i>disk / dev / vdb1</i> - benutze / dev / vdb1 <br>  <i>Syncer {Rate 1000M;</i>  <i>}</i> - Verwenden Sie die Gigabit-Kanalbandbreite <br>  <i>allow-two-primaries</i> - eine wichtige Option, um √Ñnderungen auf zwei prim√§ren Servern zu akzeptieren <br>  <i>after-sb-0pri, after-sb-1pri, after-sb-2pri</i> - Optionen, die f√ºr die Aktionen des Knotens verantwortlich sind, wenn Splitbrain erkannt wird.  Weitere Informationen finden Sie in der Dokumentation. <br>  <i>auf beiden prim√§r werden</i> - setzt beide Knoten auf prim√§r. <br><br>  In unserem Fall haben wir zwei absolut identische VMs mit einer dedizierten virtuellen Netzwerkbandbreite von 10 Gigabit. <br><br>  In unserem Beispiel lauten die Netzwerknamen zweier Clusterknoten drbd1 und drbd2.  F√ºr einen ordnungsgem√§√üen Betrieb m√ºssen Sie die Namen und IP-Adressen der Knoten in / etc / hosts zuordnen. <br><br><pre> <code class="bash hljs">10.10.10.192 drbd1 10.10.10.193 drbd2</code> </pre> <br>  <b>Schritt 2. Konfigurieren Sie die Knoten:</b> <br><br>  Auf beiden Servern f√ºhren wir aus: <br><pre> <code class="bash hljs">drbdadm create-md drbd0</code> </pre> <br><img src="https://habrastorage.org/webt/8d/_s/cu/8d_scupzapinrfgfcfybxipxfbk.png" alt="Bild"><br><br><pre> <code class="bash hljs">modprobe drbd drbdadm up drbd0 cat /proc/drbd</code> </pre> <br>  Wir bekommen folgendes: <br><br><img src="https://habrastorage.org/webt/c4/zp/kx/c4zpkxvdupcfqbbmfccp3bbjqws.png" alt="Bild"><br><br>  Sie k√∂nnen die Synchronisierung starten.  Auf dem ersten Knoten m√ºssen Sie Folgendes tun: <br><pre> <code class="bash hljs">drbdadm primary --force drbd0</code> </pre> <br>  Wir schauen uns den Status an: <br><pre> <code class="bash hljs">cat /proc/drbd</code> </pre> <br><img src="https://habrastorage.org/webt/vd/nn/xd/vdnnxdcrmmufhf7sdz_gxyzcezy.png" alt="Bild"><br><br>  Gro√üartig, die Synchronisation hat begonnen.  Wir warten auf das Ende und sehen das Bild: <br><br><img src="https://habrastorage.org/webt/fx/j1/5k/fxj15krpylof_f5uok4zq8xfznq.png" alt="Bild"><br><br>  <b>Schritt 3. Wir beginnen die Synchronisation mit der zweiten Note:</b> <br><br><pre> <code class="bash hljs">drbdadm primary --force drbd0</code> </pre><br>  Wir bekommen folgendes: <br><br><img src="https://habrastorage.org/webt/zl/8f/_w/zl8f_ws9wacesr88mtoo9b_dxbm.png" alt="Bild"><br><br>  Jetzt k√∂nnen wir von zwei Servern auf drbd schreiben. <br><br>  <b>Schritt 4. Installieren und konfigurieren Sie ocfs2.</b> <br><br>  Wir werden eine ziemlich triviale Konfiguration verwenden: <br><br><pre> <code class="plaintext hljs">cluster: node_count = 2 name = ocfs2cluster node: number = 1 cluster = ocfs2cluster ip_port = 7777 ip_address = 10.10.10.192 name = drbd1 node: number = 2 cluster = ocfs2cluster ip_port = 7777 ip_address = 10.10.10.193 name = drbd2</code> </pre><br>  Es muss auf beiden Knoten in <i>/etc/ocfs2/cluster.conf</i> geschrieben werden. <br><br>  Erstellen Sie FS auf drbd0 auf einem beliebigen Knoten: <br><pre> <code class="bash hljs">mkfs.ocfs2 -L <span class="hljs-string"><span class="hljs-string">"testVol"</span></span> /dev/drbd0</code> </pre><br>  Hier haben wir ein Dateisystem mit der Bezeichnung testVol auf drbd0 mit den Standardeinstellungen erstellt. <br><br><img src="https://habrastorage.org/webt/9l/sr/gl/9lsrgldfbco5qrzkjhkoh4oefly.png" alt="Bild"><br><br>  In / etc / default muss / o2cb gesetzt sein (wie in unserer Konfigurationsdatei) <br><pre> <code class="bash hljs">O2CB_ENABLED=<span class="hljs-literal"><span class="hljs-literal">true</span></span> O2CB_BOOTCLUSTER=ocfs2cluster</code> </pre> <br>  und auf jedem Knoten ausf√ºhren: <br><pre> <code class="bash hljs">o2cb register-cluster ocfs2cluster</code> </pre> <br>  Schalten Sie danach alle ben√∂tigten Einheiten ein und f√ºgen Sie sie zum Start hinzu: <br><pre> <code class="bash hljs">systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> drbd o2cb ocfs2 systemctl start drbd o2cb ocfs2</code> </pre> <br>  Ein Teil davon wird bereits w√§hrend des Setup-Vorgangs ausgef√ºhrt. <br><br>  <b>Schritt 5. F√ºgen Sie fstab auf beiden Knoten Mount-Punkte hinzu:</b> <br><br><pre> <code class="bash hljs">/dev/drbd0 /media/shared ocfs2 defaults,noauto,heartbeat=<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> 0 0</code> </pre> <br>  Das Verzeichnis <i>/ media / shared</i> muss im Voraus erstellt werden. <br><br>  Hier verwenden wir die Optionen noauto, was bedeutet, dass der FS beim Start nicht gemountet wird (ich bevorzuge das Mounten des Netzwerk-FS √ºber systemd) und heartbeat = local, was bedeutet, dass der Heartbeat-Dienst auf jedem Knoten verwendet wird.  Es gibt auch einen globalen Herzschlag, der f√ºr gro√üe Cluster besser geeignet ist. <br><br>  Als N√§chstes k√∂nnen Sie <i>/ media / shared bereitstellen</i> und die Synchronisierung des Inhalts √ºberpr√ºfen. <br><br>  <b>Fertig!</b>  Als Ergebnis erhalten wir einen mehr oder weniger fehlertoleranten Speicher mit Skalierbarkeit und anst√§ndiger Leistung. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de445612/">https://habr.com/ru/post/de445612/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de445594/index.html">Tools zum Erstellen einer reaktionsf√§higen Site ohne Zugriff auf die Site</a></li>
<li><a href="../de445596/index.html">Tipps und Tricks von Kubernetes: Personalisierte Fehlerseiten in NGINX Ingress</a></li>
<li><a href="../de445600/index.html">[Umfrage und b√∂se] Hostings, seien sie falsch</a></li>
<li><a href="../de445602/index.html">PHP Russland 2019: sein "Stadion" f√ºr die Sprache der ersten Liga</a></li>
<li><a href="../de445608/index.html">Spielende: Analysten berichten von einem Anstieg der Anzahl von DDoS-Angriffen auf das Spielesegment</a></li>
<li><a href="../de445618/index.html">Wir schreiben ein Betriebssystem auf Rust. Implementieren des Seitenspeichers (neu)</a></li>
<li><a href="../de445620/index.html">Was macht ein UX-Writer?</a></li>
<li><a href="../de445622/index.html">Neu in Java 12: The Teeing Collector</a></li>
<li><a href="../de445626/index.html">Wie tief ist das Kaninchenloch? CLRium # 5: Garbage Collector</a></li>
<li><a href="../de445632/index.html">Vom Parser des Python-Theaterplakats bis zum Telegrammbot. Teil 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>