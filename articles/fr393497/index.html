<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü•Å üç∫ ü§† Interrupteur d'√©clairage wifi intelligent üò£ üë©üèΩ‚Äçüé® üë®üèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, cher lecteur. 
 
 Un peu de paroles au d√©but. L'id√©e d'un interrupteur d'√©clairage ¬´intelligent¬ª n'est pas nouvelle du tout et, probablement,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Interrupteur d'√©clairage wifi intelligent</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/393497/"><img src="https://habrastorage.org/files/8cf/a56/9c8/8cfa569c88ff458c8c84c600a6b3c67a.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bonjour, cher lecteur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un peu de paroles au d√©but. L'id√©e d'un interrupteur d'√©clairage ¬´intelligent¬ª n'est pas nouvelle du tout et, probablement, c'est la premi√®re chose qui vient √† l'esprit pour ceux qui ont commenc√© √† se familiariser avec la plate-forme Arduino et les √©l√©ments IoT. Et je ne fais pas exception √† cela. Apr√®s avoir exp√©riment√© des √©l√©ments de circuit, des moteurs et des LED, je veux faire quelque chose de plus appliqu√©, qui est demand√© dans la vie quotidienne et, surtout, sera pratique √† utiliser et ne restera pas victime de l'exp√©rience pour le confort. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans cet article, je vais vous dire comment j'ai fait un interrupteur qui fonctionnera comme un interrupteur normal (c'est-√†-dire qui est g√©n√©ralement mont√© sur un mur) et en m√™me temps lui permettre d'√™tre contr√¥l√© via WiFi (ou via Internet, comme cela se fait dans ce cas).</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous allons donc dresser une liste de ce qui sera n√©cessaire pour mettre en ≈ìuvre le plan. </font><font style="vertical-align: inherit;">Je dois dire tout de suite que j'avais l'intention de ne pas faire de folies sur les composants et j'ai choisi des composants en fonction des commentaires sur les forums et du rapport qualit√©-prix. </font><font style="vertical-align: inherit;">Par cons√©quent, certains composants peuvent sembler inappropri√©s ici pour les amateurs √©lectriques exp√©riment√©s, mais ne jugez pas strictement, car </font><font style="vertical-align: inherit;">Je suis nouveau dans l'√©lectrom√©canique et j'appr√©cierais grandement les commentaires de professionnels plus exp√©riment√©s.</font></font><br>
<table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Non.</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nom</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La description</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prix</font></font></th>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></td>
<td><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HLK-PM01</font></font></a></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adaptateur 220VAC √† 5VDC</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4,02 ‚Ç¨</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></td>
<td><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SSR-40DA</font></font></a></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Relais √† semi-conducteurs pour le contr√¥le du courant du circuit</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3,35 ‚Ç¨</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3</font></font></td>
<td><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AMS1117-3.3</font></font></a></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Suppresseur de tension 5V √† 3V</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1,29 ‚Ç¨</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4</font></font></td>
<td><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ESP8266-01</font></font></a></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Microcontr√¥leur avec WiFi</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2,35 ‚Ç¨</font></font></td>
</tr>
<tr>
<td colspan="3" align="right"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Total:</font></font></b></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">11,01 ‚Ç¨</font></font></td>
</tr>
</tbody></table><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'avais √©galement besoin: d'un serveur avec lequel le commutateur sera contr√¥l√© via Internet, Arduino Uno, avec lequel j'ai programm√© ESP, un routeur et des consommables comme des fils, des terminaux, etc., tout cela peut varier selon les go√ªts et n'affectera pas au r√©sultat final. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les prix sont tir√©s d'Ebay, o√π je les ai achet√©s. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et voici √† quoi ressemblent les √©l√©ments du tableau: </font></font><br>
<br>
<img src="https://habrastorage.org/files/1ef/70b/dc9/1ef70bdc91704739b496786442c19517.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez maintenant dessiner un sch√©ma de connexion:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/eb8/740/8f0/eb87408f0f4743d986dbe39f4abe02b3.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme vous l'avez probablement remarqu√©, le sch√©ma est tr√®s simple. Tout est assembl√© facilement, rapidement et sans soudure. Une sorte de prototype fonctionnel, qui n'a pas besoin d'√™tre d√©rang√© longtemps. Tout est connect√© par des fils et des bornes. Le seul point n√©gatif est que le relais ne rentre pas dans la prise de l'interrupteur. Oui, au d√©part, j'avais pr√©vu de tout enfoncer dans le mur derri√®re l'interrupteur pour qu'il soit esth√©tique. Mais √† mon regret, il n'y avait pas assez d'espace dans la prise et le relais ne montait tout simplement pas vers le haut ou vers le bas: </font></font><br>
<br>
<img src="https://habrastorage.org/files/ce9/090/c6f/ce9090c6ff18427486c49ce2f48570e6.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par cons√©quent, j'ai temporairement retir√© le relais de la prise jusqu'√† ce que je trouve un coffret √©lectrique appropri√© avec une prise pour cacher le fer √† l'int√©rieur. Mais il n'y a rien de plus permanent que temporaire, n'est-ce pas? Par cons√©quent, tout cela ressemble maintenant √† ceci: du </font></font><br>
<br>
<img src="https://habrastorage.org/files/69c/45e/792/69c45e79281a4ce8a02bd6cf17ece631.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ruban isolant sauvera des chocs √©lectriques ... j'esp√®re. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parlons maintenant de la partie logicielle.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et avant de proc√©der √† l'analyse du code et des d√©tails, je vais donner un sch√©ma g√©n√©ral de la mise en ≈ìuvre du contr√¥le des lampes. </font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/9b7/7cc/efe/9b77ccefe7c84f339fd25435ba3c74f0.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'esp√®re qu'un jour je r√©√©crirai tout et que la connexion sera bas√©e sur un protocole plus rapide que HTTP, mais pour commencer, ce sera le cas. </font><font style="vertical-align: inherit;">√Ä distance, l'ampoule change son √©tat en environ 1-1,5 secondes, et √† partir du commutateur instantan√©ment, comme il sied √† un commutateur d√©cent.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Programmation ESP8266-01</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La fa√ßon la plus simple de le faire est d'utiliser Arduino. Vous pouvez t√©l√©charger les biblioth√®ques n√©cessaires pour l'IDE Arduino depuis </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Il y a toutes les instructions d'installation et de configuration. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, nous devons connecter l'ESP √† l'ordinateur, pour cela, nous avons besoin d'un adaptateur USB vers s√©rie (tel que </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FTDi</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CH340</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FT232RL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) ou de toute plate-forme Arduino (j'avais Arduino Uno) avec des sorties RX et TX. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est √† noter que l'ESP8266-01 est aliment√© en 3,3 Volts, ce qui signifie qu'en aucun cas ne le connectez √† l'Arduino, qui (souvent) est aliment√© en 5 Volts, sinon tout ira en enfer directement. Vous pouvez utiliser le r√©ducteur de tension, comme indiqu√© dans le tableau ci-dessus. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le sch√©ma de connexion est simple: nous connectons </font></font><abbr title="√âmetteur"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TX</font></font></abbr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ,</font></font><abbr title="R√©cepteur"><font style="vertical-align: inherit;"></font></abbr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adaptateur </font><abbr title="R√©cepteur"><font style="vertical-align: inherit;">RX</font></abbr><font style="vertical-align: inherit;"> et </font></font><abbr title="Au sol"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GND</font></font></abbr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ESP vers RX, TX et GND / Arduino respectivement. </font><font style="vertical-align: inherit;">Apr√®s cela, en fait, la connexion est pr√™te √† l'emploi. </font><font style="vertical-align: inherit;">Le microcontr√¥leur peut √™tre programm√© √† l'aide de l'IDE Arduino. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quelques nuances lors de l'utilisation d'Arduino Uno:</font></font></b> <br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uno a une sortie pour 3,3 V, mais ce n'√©tait pas suffisant. </font><font style="vertical-align: inherit;">Lorsque vous y connectez un ESP, tout semble fonctionner, les indicateurs sont allum√©s, mais la communication avec le port COM est perdue. </font><font style="vertical-align: inherit;">J'ai donc utilis√© une alimentation 3,3 V diff√©rente pour ESP.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De plus, UNO n'a eu aucun probl√®me de communication avec ESP, √©tant donn√© que UNO √©tait aliment√© par 5V et ESP √† partir de 3V.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s plusieurs exp√©riences avec ESP8266-01, il s'est av√©r√© que les ESP sont sensibles aux tensions connect√©es √† GPIO0 et GPIO2. </font><font style="vertical-align: inherit;">Au moment du lancement, ils ne doivent en aucun cas √™tre mis √† la terre si vous comptez le d√©marrer en mode normal. </font><font style="vertical-align: inherit;">Plus de d√©tails sur le d√©marrage du microcontr√¥leur </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Je ne le savais pas et j'ai d√ª changer l√©g√®rement le circuit, car </font><font style="vertical-align: inherit;">dans la version ESP-01, seules ces 2 broches sont pr√©sentes et les deux sont utilis√©es dans mon circuit. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et voici le programme pour ESP lui-m√™me:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Afficher le code</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;ESP8266WiFi.h&gt;</span></span></span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;WiFiClient.h&gt;</span></span></span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;ESP8266WebServer.h&gt;</span></span></span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;ESP8266mDNS.h&gt;</span></span></span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;ESP8266HTTPClient.h&gt;</span></span></span></span>
<span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-string"><span class="hljs-string">"C"</span></span> { <span class="hljs-comment"><span class="hljs-comment">//         initVariant</span></span>
  <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"user_interface.h"</span></span></span></span><font></font>
}<font></font>
<font></font>
<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* ssid = <span class="hljs-string"><span class="hljs-string">"WIFISSID"</span></span>; <span class="hljs-comment"><span class="hljs-comment">//  WiFi</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* password = <span class="hljs-string"><span class="hljs-string">"***************"</span></span>; <span class="hljs-comment"><span class="hljs-comment">//  WiFi</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> String self_token = <span class="hljs-string"><span class="hljs-string">"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"</span></span>; <span class="hljs-comment"><span class="hljs-comment">//     </span></span>
<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> String serv_token = <span class="hljs-string"><span class="hljs-string">"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"</span></span>; <span class="hljs-comment"><span class="hljs-comment">//     </span></span>
<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> String name = <span class="hljs-string"><span class="hljs-string">"IOT_lamp"</span></span>; <span class="hljs-comment"><span class="hljs-comment">//  ,  </span></span>
<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> String serverIP = <span class="hljs-string"><span class="hljs-string">"192.168.1.111"</span></span>; <span class="hljs-comment"><span class="hljs-comment">//  IP WEB  </span></span>
<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> lamp_on =  <span class="hljs-literal"><span class="hljs-literal">false</span></span>;
<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> can_toggle = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;
<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> button_state;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-function">ESP8266WebServer </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">server</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">80</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">//  </span></span>
HTTPClient http; <span class="hljs-comment"><span class="hljs-comment">//  </span></span><font></font>
<font></font>
<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> lamp = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-comment"><span class="hljs-comment">//    GPIO2</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> button = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">// ""   GPIO0</span></span><font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">//    </span></span>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handleRoot</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <font></font>
  server.send(<span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-string"><span class="hljs-string">"text/plain"</span></span>, <span class="hljs-string"><span class="hljs-string">"Hello! I am "</span></span> + name);<font></font>
}<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">//    </span></span>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handleNotFound</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{<font></font>
  String message = <span class="hljs-string"><span class="hljs-string">"not found"</span></span>;<font></font>
  server.send(<span class="hljs-number"><span class="hljs-number">404</span></span>, <span class="hljs-string"><span class="hljs-string">"text/plain"</span></span>, message);<font></font>
}<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">//   </span></span>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">turnOnLamp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{<font></font>
  digitalWrite(lamp, LOW);<font></font>
  lamp_on = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">//   </span></span>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">turnOffLamp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{<font></font>
  digitalWrite(lamp, HIGH);<font></font>
  lamp_on = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">//     ./.</span></span>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendServer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> state)</span></span></span></span>{<font></font>
  http.begin(<span class="hljs-string"><span class="hljs-string">"http://"</span></span>+serverIP+<span class="hljs-string"><span class="hljs-string">"/iapi/setstate"</span></span>);<font></font>
  String post = <span class="hljs-string"><span class="hljs-string">"token="</span></span>+self_token+<span class="hljs-string"><span class="hljs-string">"&amp;state="</span></span>+(state?<span class="hljs-string"><span class="hljs-string">"on"</span></span>:<span class="hljs-string"><span class="hljs-string">"off"</span></span>); <span class="hljs-comment"><span class="hljs-comment">//         </span></span>
  http.addHeader(<span class="hljs-string"><span class="hljs-string">"Content-Type"</span></span>, <span class="hljs-string"><span class="hljs-string">"application/x-www-form-urlencoded"</span></span>);
  <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> httpCode = http.POST(post);<font></font>
  http.end();  <font></font>
}<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">//   </span></span>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toggleLamp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{
  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(lamp_on == <span class="hljs-literal"><span class="hljs-literal">true</span></span>) {<font></font>
    turnOffLamp();<font></font>
    sendServer(<span class="hljs-literal"><span class="hljs-literal">false</span></span>);<font></font>
  } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {<font></font>
    turnOnLamp();<font></font>
    sendServer(<span class="hljs-literal"><span class="hljs-literal">true</span></span>);<font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">//     </span></span>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handleOn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{<font></font>
  String token = server.arg(<span class="hljs-string"><span class="hljs-string">"token"</span></span>);
  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(serv_token != token) {<font></font>
    String message = <span class="hljs-string"><span class="hljs-string">"access denied"</span></span>;<font></font>
    server.send(<span class="hljs-number"><span class="hljs-number">401</span></span>, <span class="hljs-string"><span class="hljs-string">"text/plain"</span></span>, message);
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>;<font></font>
  }<font></font>
  turnOnLamp();<font></font>
  String message = <span class="hljs-string"><span class="hljs-string">"success"</span></span>;<font></font>
  server.send(<span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-string"><span class="hljs-string">"text/plain"</span></span>, message);<font></font>
}<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">//     </span></span>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handleOff</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{<font></font>
  String token = server.arg(<span class="hljs-string"><span class="hljs-string">"token"</span></span>);
  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(serv_token != token) {<font></font>
    String message = <span class="hljs-string"><span class="hljs-string">"access denied"</span></span>;<font></font>
    server.send(<span class="hljs-number"><span class="hljs-number">401</span></span>, <span class="hljs-string"><span class="hljs-string">"text/plain"</span></span>, message);
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>;<font></font>
  }<font></font>
  turnOffLamp();<font></font>
  String message = <span class="hljs-string"><span class="hljs-string">"success"</span></span>;<font></font>
  server.send(<span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-string"><span class="hljs-string">"text/plain"</span></span>, message);<font></font>
}<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">//  MAC    IP</span></span>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initVariant</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{
  <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> mac[<span class="hljs-number"><span class="hljs-number">6</span></span>] = {<span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xA3</span></span>, <span class="hljs-number"><span class="hljs-number">0xA0</span></span>, <span class="hljs-number"><span class="hljs-number">0x1C</span></span>, <span class="hljs-number"><span class="hljs-number">0x8C</span></span>, <span class="hljs-number"><span class="hljs-number">0x45</span></span>};<font></font>
  wifi_set_macaddr(STATION_IF, &amp;mac[<span class="hljs-number"><span class="hljs-number">0</span></span>]);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>{<font></font>
  pinMode(lamp, OUTPUT);<font></font>
  pinMode(button, INPUT_PULLUP); <span class="hljs-comment"><span class="hljs-comment">//   INPUT_PULLUP</span></span><font></font>
  turnOffLamp();<font></font>
  WiFi.hostname(name);<font></font>
  WiFi.begin(ssid, password);<font></font>
<font></font>
  <span class="hljs-comment"><span class="hljs-comment">//     WiFi</span></span>
  <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (WiFi.status() != WL_CONNECTED) {<font></font>
    delay(<span class="hljs-number"><span class="hljs-number">500</span></span>);<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment"><span class="hljs-comment">//    </span></span>
  server.on(<span class="hljs-string"><span class="hljs-string">"/"</span></span>, handleRoot);<font></font>
  server.on(<span class="hljs-string"><span class="hljs-string">"/on"</span></span>,  HTTP_POST, handleOn);<font></font>
  server.on(<span class="hljs-string"><span class="hljs-string">"/off"</span></span>, HTTP_POST, handleOff);<font></font>
  server.onNotFound(handleNotFound);<font></font>
<font></font>
  <span class="hljs-comment"><span class="hljs-comment">//  </span></span><font></font>
  server.begin();<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>{<font></font>
  server.handleClient();<font></font>
<font></font>
  <span class="hljs-comment"><span class="hljs-comment">//   </span></span><font></font>
  button_state = digitalRead(button);<font></font>
  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (button_state == HIGH &amp;&amp; can_toggle) {<font></font>
    toggleLamp();<font></font>
    can_toggle = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;<font></font>
    delay(<span class="hljs-number"><span class="hljs-number">500</span></span>);<font></font>
  } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(button_state == LOW){<font></font>
    can_toggle = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;<font></font>
  }<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quelques commentaires sur le code:</font></font></b><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il est tr√®s important de d√©clarer la broche GPIO0 comme pinMode (bouton, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">INPUT_PULLUP</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), car </font><font style="vertical-align: inherit;">Dans le circuit, nous n'utilisons pas de r√©sistance pour ce bouton. </font><font style="vertical-align: inherit;">Et ESP a son propre "cousu" √† ces fins.</font></font></li>
<li>               .</li>
</ul><br>
<h2> WEB </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, vous pouvez donner libre cours √† votre imagination et utiliser tous les moyens disponibles pour cr√©er un service qui traitera les demandes envoy√©es par le commutateur et enverra des demandes d'activation / d√©sactivation. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai utilis√© </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yii</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √† cet effet </font><font style="vertical-align: inherit;">. J'ai choisi ce framework pour plusieurs raisons, j'avais besoin d'une autorisation (puisque le portail est disponible sur Internet) et d'une gestion des r√¥les (pour de futures exp√©riences), et j'aime √ßa. Et maintenant, mon portail de gestion ressemble √† ceci: </font></font><br>
<br>
<img src="https://habrastorage.org/files/119/cb0/e72/119cb0e72f4845f8a6cac74fc856787a.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour contr√¥ler l'ampoule dans la zone d'acc√®s au r√©seau, le serveur lui-m√™me sur l'ESP serait suffisant. Mais vous voulez vraiment avoir des journaux, de la logique et d'autres appareils √† l'avenir, il est donc pr√©f√©rable d'utiliser toujours un serveur distinct pour la gestion.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout cela concerne le portail, je pense que cela n'a aucun sens d'en √©crire plus, mais si vous avez des questions, je r√©pondrai avec plaisir dans les commentaires.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Au lieu d'une conclusion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Merci si vous avez lu l'article jusqu'au bout et que vous y avez peut-√™tre trouv√© quelque chose d'utile. </font><font style="vertical-align: inherit;">Je me ferai un plaisir de vous conseiller et critiquer. </font><font style="vertical-align: inherit;">En g√©n√©ral, il me semble toujours que le goulot d'√©tranglement dans le circuit est l'adaptateur 5V et je serai heureux si vous partagez votre exp√©rience dans la r√©solution de tels probl√®mes. </font><font style="vertical-align: inherit;">Quant √† l'ESP8266-01, il n'a jusqu'√† pr√©sent soulev√© aucune plainte de ma part, √† l'exception de l'utilisation sp√©ciale des broches GPIO. </font><font style="vertical-align: inherit;">Il fonctionne de mani√®re stable depuis la deuxi√®me semaine. </font><font style="vertical-align: inherit;">Succ√®s dans les projets.</font></font></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr393497/">https://habr.com/ru/post/fr393497/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr393485/index.html">Lampe de poche LED DIY refroidie √† l'eau de 100 000 lumens</a></li>
<li><a href="../fr393487/index.html">Turbo s√©cheuse: un moyen facile de s√©cher rapidement des chaussures, des chaussettes ou des v√™tements mouill√©s</a></li>
<li><a href="../fr393491/index.html">Les sept scooters de nouveaut√© abordables</a></li>
<li><a href="../fr393493/index.html">Le retour d'Eric - le premier robot parlant du Royaume-Uni</a></li>
<li><a href="../fr393495/index.html">Un homme est en prison parce qu'il n'a pas pu d√©crypter le contenu du disque dur</a></li>
<li><a href="../fr393505/index.html">Le Xiaomi mi Band2 s'est ¬´accidentellement¬ª allum√© de la main du PDG</a></li>
<li><a href="../fr393507/index.html">Projet "Eye" partie 21</a></li>
<li><a href="../fr393509/index.html">Craig Wright continue d'essayer de se faire passer pour le cr√©ateur de Bitcoin</a></li>
<li><a href="../fr393513/index.html">La probabilit√© d'extinction de l'humanit√© a √©t√© estim√©e √† 0,1% par an</a></li>
<li><a href="../fr393515/index.html">PrivatBank a commenc√© √† vendre du solent</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>