<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🥁 🍺 🤠 Interrupteur d'éclairage wifi intelligent 😣 👩🏽‍🎨 👨🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, cher lecteur. 
 
 Un peu de paroles au début. L'idée d'un interrupteur d'éclairage «intelligent» n'est pas nouvelle du tout et, probablement,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Interrupteur d'éclairage wifi intelligent</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/393497/"><img src="https://habrastorage.org/files/8cf/a56/9c8/8cfa569c88ff458c8c84c600a6b3c67a.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bonjour, cher lecteur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un peu de paroles au début. L'idée d'un interrupteur d'éclairage «intelligent» n'est pas nouvelle du tout et, probablement, c'est la première chose qui vient à l'esprit pour ceux qui ont commencé à se familiariser avec la plate-forme Arduino et les éléments IoT. Et je ne fais pas exception à cela. Après avoir expérimenté des éléments de circuit, des moteurs et des LED, je veux faire quelque chose de plus appliqué, qui est demandé dans la vie quotidienne et, surtout, sera pratique à utiliser et ne restera pas victime de l'expérience pour le confort. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans cet article, je vais vous dire comment j'ai fait un interrupteur qui fonctionnera comme un interrupteur normal (c'est-à-dire qui est généralement monté sur un mur) et en même temps lui permettre d'être contrôlé via WiFi (ou via Internet, comme cela se fait dans ce cas).</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous allons donc dresser une liste de ce qui sera nécessaire pour mettre en œuvre le plan. </font><font style="vertical-align: inherit;">Je dois dire tout de suite que j'avais l'intention de ne pas faire de folies sur les composants et j'ai choisi des composants en fonction des commentaires sur les forums et du rapport qualité-prix. </font><font style="vertical-align: inherit;">Par conséquent, certains composants peuvent sembler inappropriés ici pour les amateurs électriques expérimentés, mais ne jugez pas strictement, car </font><font style="vertical-align: inherit;">Je suis nouveau dans l'électromécanique et j'apprécierais grandement les commentaires de professionnels plus expérimentés.</font></font><br>
<table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Non.</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nom</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La description</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prix</font></font></th>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></td>
<td><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HLK-PM01</font></font></a></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adaptateur 220VAC à 5VDC</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4,02 €</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></td>
<td><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SSR-40DA</font></font></a></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Relais à semi-conducteurs pour le contrôle du courant du circuit</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3,35 €</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3</font></font></td>
<td><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AMS1117-3.3</font></font></a></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Suppresseur de tension 5V à 3V</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1,29 €</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4</font></font></td>
<td><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ESP8266-01</font></font></a></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Microcontrôleur avec WiFi</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2,35 €</font></font></td>
</tr>
<tr>
<td colspan="3" align="right"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Total:</font></font></b></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">11,01 €</font></font></td>
</tr>
</tbody></table><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'avais également besoin: d'un serveur avec lequel le commutateur sera contrôlé via Internet, Arduino Uno, avec lequel j'ai programmé ESP, un routeur et des consommables comme des fils, des terminaux, etc., tout cela peut varier selon les goûts et n'affectera pas au résultat final. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les prix sont tirés d'Ebay, où je les ai achetés. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et voici à quoi ressemblent les éléments du tableau: </font></font><br>
<br>
<img src="https://habrastorage.org/files/1ef/70b/dc9/1ef70bdc91704739b496786442c19517.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez maintenant dessiner un schéma de connexion:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/eb8/740/8f0/eb87408f0f4743d986dbe39f4abe02b3.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme vous l'avez probablement remarqué, le schéma est très simple. Tout est assemblé facilement, rapidement et sans soudure. Une sorte de prototype fonctionnel, qui n'a pas besoin d'être dérangé longtemps. Tout est connecté par des fils et des bornes. Le seul point négatif est que le relais ne rentre pas dans la prise de l'interrupteur. Oui, au départ, j'avais prévu de tout enfoncer dans le mur derrière l'interrupteur pour qu'il soit esthétique. Mais à mon regret, il n'y avait pas assez d'espace dans la prise et le relais ne montait tout simplement pas vers le haut ou vers le bas: </font></font><br>
<br>
<img src="https://habrastorage.org/files/ce9/090/c6f/ce9090c6ff18427486c49ce2f48570e6.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par conséquent, j'ai temporairement retiré le relais de la prise jusqu'à ce que je trouve un coffret électrique approprié avec une prise pour cacher le fer à l'intérieur. Mais il n'y a rien de plus permanent que temporaire, n'est-ce pas? Par conséquent, tout cela ressemble maintenant à ceci: du </font></font><br>
<br>
<img src="https://habrastorage.org/files/69c/45e/792/69c45e79281a4ce8a02bd6cf17ece631.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ruban isolant sauvera des chocs électriques ... j'espère. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parlons maintenant de la partie logicielle.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et avant de procéder à l'analyse du code et des détails, je vais donner un schéma général de la mise en œuvre du contrôle des lampes. </font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/9b7/7cc/efe/9b77ccefe7c84f339fd25435ba3c74f0.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'espère qu'un jour je réécrirai tout et que la connexion sera basée sur un protocole plus rapide que HTTP, mais pour commencer, ce sera le cas. </font><font style="vertical-align: inherit;">À distance, l'ampoule change son état en environ 1-1,5 secondes, et à partir du commutateur instantanément, comme il sied à un commutateur décent.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Programmation ESP8266-01</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La façon la plus simple de le faire est d'utiliser Arduino. Vous pouvez télécharger les bibliothèques nécessaires pour l'IDE Arduino depuis </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Il y a toutes les instructions d'installation et de configuration. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, nous devons connecter l'ESP à l'ordinateur, pour cela, nous avons besoin d'un adaptateur USB vers série (tel que </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FTDi</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CH340</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FT232RL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) ou de toute plate-forme Arduino (j'avais Arduino Uno) avec des sorties RX et TX. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est à noter que l'ESP8266-01 est alimenté en 3,3 Volts, ce qui signifie qu'en aucun cas ne le connectez à l'Arduino, qui (souvent) est alimenté en 5 Volts, sinon tout ira en enfer directement. Vous pouvez utiliser le réducteur de tension, comme indiqué dans le tableau ci-dessus. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le schéma de connexion est simple: nous connectons </font></font><abbr title="Émetteur"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TX</font></font></abbr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ,</font></font><abbr title="Récepteur"><font style="vertical-align: inherit;"></font></abbr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adaptateur </font><abbr title="Récepteur"><font style="vertical-align: inherit;">RX</font></abbr><font style="vertical-align: inherit;"> et </font></font><abbr title="Au sol"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GND</font></font></abbr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ESP vers RX, TX et GND / Arduino respectivement. </font><font style="vertical-align: inherit;">Après cela, en fait, la connexion est prête à l'emploi. </font><font style="vertical-align: inherit;">Le microcontrôleur peut être programmé à l'aide de l'IDE Arduino. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quelques nuances lors de l'utilisation d'Arduino Uno:</font></font></b> <br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uno a une sortie pour 3,3 V, mais ce n'était pas suffisant. </font><font style="vertical-align: inherit;">Lorsque vous y connectez un ESP, tout semble fonctionner, les indicateurs sont allumés, mais la communication avec le port COM est perdue. </font><font style="vertical-align: inherit;">J'ai donc utilisé une alimentation 3,3 V différente pour ESP.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De plus, UNO n'a eu aucun problème de communication avec ESP, étant donné que UNO était alimenté par 5V et ESP à partir de 3V.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après plusieurs expériences avec ESP8266-01, il s'est avéré que les ESP sont sensibles aux tensions connectées à GPIO0 et GPIO2. </font><font style="vertical-align: inherit;">Au moment du lancement, ils ne doivent en aucun cas être mis à la terre si vous comptez le démarrer en mode normal. </font><font style="vertical-align: inherit;">Plus de détails sur le démarrage du microcontrôleur </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Je ne le savais pas et j'ai dû changer légèrement le circuit, car </font><font style="vertical-align: inherit;">dans la version ESP-01, seules ces 2 broches sont présentes et les deux sont utilisées dans mon circuit. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et voici le programme pour ESP lui-même:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Afficher le code</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;ESP8266WiFi.h&gt;</span></span></span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;WiFiClient.h&gt;</span></span></span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;ESP8266WebServer.h&gt;</span></span></span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;ESP8266mDNS.h&gt;</span></span></span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;ESP8266HTTPClient.h&gt;</span></span></span></span>
<span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-string"><span class="hljs-string">"C"</span></span> { <span class="hljs-comment"><span class="hljs-comment">//         initVariant</span></span>
  <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"user_interface.h"</span></span></span></span><font></font>
}<font></font>
<font></font>
<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* ssid = <span class="hljs-string"><span class="hljs-string">"WIFISSID"</span></span>; <span class="hljs-comment"><span class="hljs-comment">//  WiFi</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* password = <span class="hljs-string"><span class="hljs-string">"***************"</span></span>; <span class="hljs-comment"><span class="hljs-comment">//  WiFi</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> String self_token = <span class="hljs-string"><span class="hljs-string">"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"</span></span>; <span class="hljs-comment"><span class="hljs-comment">//     </span></span>
<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> String serv_token = <span class="hljs-string"><span class="hljs-string">"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"</span></span>; <span class="hljs-comment"><span class="hljs-comment">//     </span></span>
<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> String name = <span class="hljs-string"><span class="hljs-string">"IOT_lamp"</span></span>; <span class="hljs-comment"><span class="hljs-comment">//  ,  </span></span>
<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> String serverIP = <span class="hljs-string"><span class="hljs-string">"192.168.1.111"</span></span>; <span class="hljs-comment"><span class="hljs-comment">//  IP WEB  </span></span>
<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> lamp_on =  <span class="hljs-literal"><span class="hljs-literal">false</span></span>;
<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> can_toggle = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;
<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> button_state;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-function">ESP8266WebServer </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">server</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">80</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">//  </span></span>
HTTPClient http; <span class="hljs-comment"><span class="hljs-comment">//  </span></span><font></font>
<font></font>
<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> lamp = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-comment"><span class="hljs-comment">//    GPIO2</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> button = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">// ""   GPIO0</span></span><font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">//    </span></span>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handleRoot</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <font></font>
  server.send(<span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-string"><span class="hljs-string">"text/plain"</span></span>, <span class="hljs-string"><span class="hljs-string">"Hello! I am "</span></span> + name);<font></font>
}<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">//    </span></span>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handleNotFound</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{<font></font>
  String message = <span class="hljs-string"><span class="hljs-string">"not found"</span></span>;<font></font>
  server.send(<span class="hljs-number"><span class="hljs-number">404</span></span>, <span class="hljs-string"><span class="hljs-string">"text/plain"</span></span>, message);<font></font>
}<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">//   </span></span>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">turnOnLamp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{<font></font>
  digitalWrite(lamp, LOW);<font></font>
  lamp_on = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">//   </span></span>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">turnOffLamp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{<font></font>
  digitalWrite(lamp, HIGH);<font></font>
  lamp_on = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">//     ./.</span></span>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendServer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> state)</span></span></span></span>{<font></font>
  http.begin(<span class="hljs-string"><span class="hljs-string">"http://"</span></span>+serverIP+<span class="hljs-string"><span class="hljs-string">"/iapi/setstate"</span></span>);<font></font>
  String post = <span class="hljs-string"><span class="hljs-string">"token="</span></span>+self_token+<span class="hljs-string"><span class="hljs-string">"&amp;state="</span></span>+(state?<span class="hljs-string"><span class="hljs-string">"on"</span></span>:<span class="hljs-string"><span class="hljs-string">"off"</span></span>); <span class="hljs-comment"><span class="hljs-comment">//         </span></span>
  http.addHeader(<span class="hljs-string"><span class="hljs-string">"Content-Type"</span></span>, <span class="hljs-string"><span class="hljs-string">"application/x-www-form-urlencoded"</span></span>);
  <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> httpCode = http.POST(post);<font></font>
  http.end();  <font></font>
}<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">//   </span></span>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toggleLamp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{
  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(lamp_on == <span class="hljs-literal"><span class="hljs-literal">true</span></span>) {<font></font>
    turnOffLamp();<font></font>
    sendServer(<span class="hljs-literal"><span class="hljs-literal">false</span></span>);<font></font>
  } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {<font></font>
    turnOnLamp();<font></font>
    sendServer(<span class="hljs-literal"><span class="hljs-literal">true</span></span>);<font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">//     </span></span>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handleOn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{<font></font>
  String token = server.arg(<span class="hljs-string"><span class="hljs-string">"token"</span></span>);
  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(serv_token != token) {<font></font>
    String message = <span class="hljs-string"><span class="hljs-string">"access denied"</span></span>;<font></font>
    server.send(<span class="hljs-number"><span class="hljs-number">401</span></span>, <span class="hljs-string"><span class="hljs-string">"text/plain"</span></span>, message);
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>;<font></font>
  }<font></font>
  turnOnLamp();<font></font>
  String message = <span class="hljs-string"><span class="hljs-string">"success"</span></span>;<font></font>
  server.send(<span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-string"><span class="hljs-string">"text/plain"</span></span>, message);<font></font>
}<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">//     </span></span>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handleOff</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{<font></font>
  String token = server.arg(<span class="hljs-string"><span class="hljs-string">"token"</span></span>);
  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(serv_token != token) {<font></font>
    String message = <span class="hljs-string"><span class="hljs-string">"access denied"</span></span>;<font></font>
    server.send(<span class="hljs-number"><span class="hljs-number">401</span></span>, <span class="hljs-string"><span class="hljs-string">"text/plain"</span></span>, message);
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>;<font></font>
  }<font></font>
  turnOffLamp();<font></font>
  String message = <span class="hljs-string"><span class="hljs-string">"success"</span></span>;<font></font>
  server.send(<span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-string"><span class="hljs-string">"text/plain"</span></span>, message);<font></font>
}<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">//  MAC    IP</span></span>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initVariant</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{
  <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> mac[<span class="hljs-number"><span class="hljs-number">6</span></span>] = {<span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xA3</span></span>, <span class="hljs-number"><span class="hljs-number">0xA0</span></span>, <span class="hljs-number"><span class="hljs-number">0x1C</span></span>, <span class="hljs-number"><span class="hljs-number">0x8C</span></span>, <span class="hljs-number"><span class="hljs-number">0x45</span></span>};<font></font>
  wifi_set_macaddr(STATION_IF, &amp;mac[<span class="hljs-number"><span class="hljs-number">0</span></span>]);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>{<font></font>
  pinMode(lamp, OUTPUT);<font></font>
  pinMode(button, INPUT_PULLUP); <span class="hljs-comment"><span class="hljs-comment">//   INPUT_PULLUP</span></span><font></font>
  turnOffLamp();<font></font>
  WiFi.hostname(name);<font></font>
  WiFi.begin(ssid, password);<font></font>
<font></font>
  <span class="hljs-comment"><span class="hljs-comment">//     WiFi</span></span>
  <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (WiFi.status() != WL_CONNECTED) {<font></font>
    delay(<span class="hljs-number"><span class="hljs-number">500</span></span>);<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment"><span class="hljs-comment">//    </span></span>
  server.on(<span class="hljs-string"><span class="hljs-string">"/"</span></span>, handleRoot);<font></font>
  server.on(<span class="hljs-string"><span class="hljs-string">"/on"</span></span>,  HTTP_POST, handleOn);<font></font>
  server.on(<span class="hljs-string"><span class="hljs-string">"/off"</span></span>, HTTP_POST, handleOff);<font></font>
  server.onNotFound(handleNotFound);<font></font>
<font></font>
  <span class="hljs-comment"><span class="hljs-comment">//  </span></span><font></font>
  server.begin();<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>{<font></font>
  server.handleClient();<font></font>
<font></font>
  <span class="hljs-comment"><span class="hljs-comment">//   </span></span><font></font>
  button_state = digitalRead(button);<font></font>
  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (button_state == HIGH &amp;&amp; can_toggle) {<font></font>
    toggleLamp();<font></font>
    can_toggle = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;<font></font>
    delay(<span class="hljs-number"><span class="hljs-number">500</span></span>);<font></font>
  } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(button_state == LOW){<font></font>
    can_toggle = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;<font></font>
  }<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quelques commentaires sur le code:</font></font></b><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il est très important de déclarer la broche GPIO0 comme pinMode (bouton, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">INPUT_PULLUP</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), car </font><font style="vertical-align: inherit;">Dans le circuit, nous n'utilisons pas de résistance pour ce bouton. </font><font style="vertical-align: inherit;">Et ESP a son propre "cousu" à ces fins.</font></font></li>
<li>               .</li>
</ul><br>
<h2> WEB </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, vous pouvez donner libre cours à votre imagination et utiliser tous les moyens disponibles pour créer un service qui traitera les demandes envoyées par le commutateur et enverra des demandes d'activation / désactivation. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai utilisé </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yii</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> à cet effet </font><font style="vertical-align: inherit;">. J'ai choisi ce framework pour plusieurs raisons, j'avais besoin d'une autorisation (puisque le portail est disponible sur Internet) et d'une gestion des rôles (pour de futures expériences), et j'aime ça. Et maintenant, mon portail de gestion ressemble à ceci: </font></font><br>
<br>
<img src="https://habrastorage.org/files/119/cb0/e72/119cb0e72f4845f8a6cac74fc856787a.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour contrôler l'ampoule dans la zone d'accès au réseau, le serveur lui-même sur l'ESP serait suffisant. Mais vous voulez vraiment avoir des journaux, de la logique et d'autres appareils à l'avenir, il est donc préférable d'utiliser toujours un serveur distinct pour la gestion.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout cela concerne le portail, je pense que cela n'a aucun sens d'en écrire plus, mais si vous avez des questions, je répondrai avec plaisir dans les commentaires.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Au lieu d'une conclusion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Merci si vous avez lu l'article jusqu'au bout et que vous y avez peut-être trouvé quelque chose d'utile. </font><font style="vertical-align: inherit;">Je me ferai un plaisir de vous conseiller et critiquer. </font><font style="vertical-align: inherit;">En général, il me semble toujours que le goulot d'étranglement dans le circuit est l'adaptateur 5V et je serai heureux si vous partagez votre expérience dans la résolution de tels problèmes. </font><font style="vertical-align: inherit;">Quant à l'ESP8266-01, il n'a jusqu'à présent soulevé aucune plainte de ma part, à l'exception de l'utilisation spéciale des broches GPIO. </font><font style="vertical-align: inherit;">Il fonctionne de manière stable depuis la deuxième semaine. </font><font style="vertical-align: inherit;">Succès dans les projets.</font></font></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr393497/">https://habr.com/ru/post/fr393497/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr393485/index.html">Lampe de poche LED DIY refroidie à l'eau de 100 000 lumens</a></li>
<li><a href="../fr393487/index.html">Turbo sécheuse: un moyen facile de sécher rapidement des chaussures, des chaussettes ou des vêtements mouillés</a></li>
<li><a href="../fr393491/index.html">Les sept scooters de nouveauté abordables</a></li>
<li><a href="../fr393493/index.html">Le retour d'Eric - le premier robot parlant du Royaume-Uni</a></li>
<li><a href="../fr393495/index.html">Un homme est en prison parce qu'il n'a pas pu décrypter le contenu du disque dur</a></li>
<li><a href="../fr393505/index.html">Le Xiaomi mi Band2 s'est «accidentellement» allumé de la main du PDG</a></li>
<li><a href="../fr393507/index.html">Projet "Eye" partie 21</a></li>
<li><a href="../fr393509/index.html">Craig Wright continue d'essayer de se faire passer pour le créateur de Bitcoin</a></li>
<li><a href="../fr393513/index.html">La probabilité d'extinction de l'humanité a été estimée à 0,1% par an</a></li>
<li><a href="../fr393515/index.html">PrivatBank a commencé à vendre du solent</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>