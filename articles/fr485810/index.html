<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèΩ‚Äçüöí üôÜüèæ üë≤üèø Crochets Elixir au moment de la compilation üë©üèø‚Äçüè´ üì¨ üéã</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Elixir est √©quip√© d'une macro-infrastructure sophistiqu√©e et tr√®s bien con√ßue. Avec la main l√©g√®re de Chris McCord, il existe une loi non √©crite dans ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Crochets Elixir au moment de la compilation</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/485810/"><p>  <em>Elixir</em> est √©quip√© d'une macro-infrastructure sophistiqu√©e et tr√®s bien con√ßue.  Avec la main l√©g√®re de Chris McCord, il existe une loi non √©crite dans la communaut√© qui est in√©vitablement exprim√©e imm√©diatement en ce qui concerne les macros: "La premi√®re r√®gle pour utiliser des macros est que vous ne devez pas les utiliser."  Parfois avec une remarque subtile tap√©e dans une police gris p√¢le de la quatri√®me taille: "seulement si vous ne pouvez pas l'√©viter, et que vous comprenez tr√®s bien ce que vous allez faire et ce que vous risquez."  Cela est d√ª au fait que les macros ont acc√®s √† l'ensemble de l' <em>AST du</em> module dans lequel elles sont utilis√©es et, d'une mani√®re g√©n√©rale, elles peuvent changer le code r√©sultant au-del√† de la reconnaissance. </p><br><p> En principe, je conviens que vous ne devez pas utiliser de macros dans le processus de familiarisation avec la langue.  Jusqu'√† pr√©sent, vous ne pouvez pas, √©tant r√©veill√© √† trois heures du matin avec une gueule de bois, r√©pondre √† la question de savoir si ce code est ex√©cut√© au stade de la compilation ou lors de l'ex√©cution.  <em>Elixir</em> est un langage compil√©, et pendant le processus de compilation, le code de ¬´haut niveau¬ª est ex√©cut√©, l'arbre de syntaxe est compl√®tement d√©velopp√© jusqu'√† ce que nous nous trouvions dans une situation o√π il n'y a plus rien √† ouvrir, et ce r√©sultat est finalement compil√© dans <em>BEAM</em> .  Lorsque le compilateur rencontre un appel de macro dans le code source, il expose enti√®rement l' <em>AST</em> pour celui <em>-</em> ci <em>et se bloque √† la place de l'appel r√©el</em> .  Il est impossible de comprendre, on ne peut que s'en souvenir. </p><a name="habracut"></a><br><p>  Mais d√®s que nous nous sentirons libres dans la syntaxe, nous voudrons in√©vitablement utiliser toute la puissance de la bo√Æte √† outils;  ici sans macros - nulle part.  L'essentiel est de ne pas en abuser.  Les macros peuvent r√©duire consid√©rablement (√† des valeurs n√©gatives) la quantit√© de code passe-partout qui peut √™tre requise, et elles fournissent un moyen naturel et tr√®s pratique de manipuler l' <em>AST</em> .  <em>Phoenix</em> , <em>Ecto</em> et toutes les biblioth√®ques notables utilisent tr√®s fortement les macros. </p><br><p>  Ce qui pr√©c√®de est vrai pour toute biblioth√®que / package universel.  D'apr√®s mon exp√©rience, les projets ordinaires ne sont probablement pas des macros n√©cessaires, ou sont n√©cessaires dans un domaine d'application tr√®s limit√©.  Les biblioth√®ques, en revanche, se composent souvent de macros dans un rapport de 80/20 au code normal. </p><br><p>  Je ne vais pas faire un bac √† sable ici et sculpter des muffins de macros pour ceux qui ne sont pas tr√®s conscients de ce qu'ils mangent;  s'il est int√©ressant de commencer √† apprendre des bases, de comprendre de quoi il s'agit, ou comment et pourquoi elles sont utilis√©es dans <em>Elixir</em> lui-m√™me, il est pr√©f√©rable de fermer imm√©diatement cette page et de lire le brillant livre <a href="https://pragprog.com/book/cmelixir/metaprogramming-elixir">Metaprogramming Elixir de</a> Chris McCord, cr√©ateur du <a href="https://phoenixframework.org/">Phoenix Framework</a> .  Je veux juste montrer quelques astuces pour am√©liorer un macro-√©cosyst√®me existant. </p><br><hr><br><p>  Les macros sont intentionnellement mal document√©es.  Ce couteau est trop tranchant pour faire de la publicit√© pour les enfants. </p><br><p> Il existe deux fa√ßons d'utiliser les macros.  Le plus simple est que vous indiquez au compilateur que ce module utilisera les macros d'un autre √† l'aide de la directive <a href="https://hexdocs.pm/elixir/Kernel.SpecialForms.html%3F"><code>Kernel.SpecialForms.require/2</code></a> , et appellera la macro elle-m√™me apr√®s cela (pour les macros d√©finies dans le m√™me module, une <code>require</code> explicite <code>require</code> pas n√©cessaire).  Dans cet article, nous nous int√©ressons √† une autre mani√®re plus complexe.  Lorsque les appels de code externe <code>use MyLib</code> , il est pr√©vu que notre module <code>MyLib</code> impl√©mente la <code>__using__/1</code> , que le compilateur <code>use MyLib</code> lorsqu'il rencontrera <code>use MyLib</code> .  Sucre syntaxique, oui.  Convention sur la configuration.  Le chemin de fer pass√© de Jos√© ne passa pas sans laisser de trace. </p><br><p>  <em>Attention:</em> si le paragraphe ci-dessus vous intrigue et que tout ce qui pr√©c√®de vous semble ridicule, arr√™tez de manger ce cactus et lisez le livre que j'ai mentionn√© ci-dessus √† la place de ma note sabl√©e. </p><br><p>  <code>__using__/1</code> prend un argument, donc le propri√©taire de la biblioth√®que peut autoriser les utilisateurs √† lui passer certains param√®tres.  Voici un exemple de l'un de mes projets internes qui utilise un appel de macro avec des param√®tres: </p><br><pre> <code class="ruby hljs">defmodule User <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> use MyApp.ActiveRecord, <span class="hljs-symbol"><span class="hljs-symbol">repo:</span></span> MyApp.Repo, <span class="hljs-symbol"><span class="hljs-symbol">roles:</span></span> ~w<span class="hljs-params"><span class="hljs-params">|supervisor client subscriber|</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">preload:</span></span> ~w<span class="hljs-params"><span class="hljs-params">|setting companies|</span></span>a</code> </pre> <br><p>  Un argument de type <code>keyword()</code> sera pass√© √† <code>MyApp.ActiveRecord.__using__/1</code> , et l√† je l'utilise pour cr√©er divers assistants pour travailler avec ce mod√®le.  ( <em>Remarque:</em> ce code a longtemps √©t√© bu car <em>ActiveRecord</em> perd √† tous √©gards aux appels natifs <em>Ecto</em> ). </p><br><hr><br><p>  Parfois, nous voulons limiter l'utilisation des macros √† un sous-ensemble de modules (par exemple, autoriser son utilisation uniquement dans les structures).  Une v√©rification explicite √† l'int√©rieur de l' <code>__using__/1</code> ne fonctionnera pas, comme nous le souhaiterions, car pendant la compilation du module, nous n'avons pas acc√®s √† son <code>__ENV__</code> (et ce serait - c'√©tait loin d'√™tre termin√© au moment o√π le compilateur a rencontr√© un appel <code>__using__/1</code> Il serait id√©al d'effectuer cette v√©rification une fois la compilation termin√©e. </p><br><p>  Pas de probl√®me!  Il existe deux <a href="https://hexdocs.pm/elixir/Module.html">attributs de module</a> qui configurent exactement cela.  Bienvenue √† nous rendre visite, chers <a href="https://hexdocs.pm/elixir/Module.html">rappels de temps de compilation</a> . </p><br><p>  Voici un bref extrait de la documentation. </p><br><blockquote>  <code>@after_compile</code> rappel sera appel√© imm√©diatement apr√®s la compilation du module actuel. <br><br>  Accepte un module ou un tuple <code>{module, function_name}</code> .  Le rappel lui-m√™me doit prendre deux arguments: l'environnement du module et son bytecode.  Lorsque seul un module est pass√© en argument, il est suppos√© que ce module exporte la fonction <code>__after_compile__/2</code> existe. <br><br>  Les rappels enregistr√©s en premier seront ex√©cut√©s en dernier. <br><pre> <code class="plaintext hljs">defmodule MyModule do @after_compile __MODULE__ def __after_compile__(env, _bytecode) do IO.inspect env end end</code> </pre> <br></blockquote><p>  Je d√©conseille fortement d'injecter <code>__after_compile__/2</code> directement dans le code g√©n√©r√©, car cela peut entra√Æner des conflits avec les intentions des utilisateurs finaux (qui peuvent vouloir utiliser leurs propres gestionnaires).  D√©finissez une fonction quelque part dans votre <code>MyLib.Helpers</code> ou quelque chose, et passez le tuple √† <code>@after_compile</code> : </p><br><pre> <code class="ruby hljs">quote <span class="hljs-symbol"><span class="hljs-symbol">location:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">:keep</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> @after_compile({MyLib.Helpers, <span class="hljs-symbol"><span class="hljs-symbol">:after_mymodule_callback</span></span>}) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><hr><br><p>  Ce rappel sera appel√© imm√©diatement apr√®s la compilation du module correspondant, qui utilise notre biblioth√®que, et recevra deux param√®tres: la structure <code>__ENV__</code> et le bytecode du module compil√©.  Ce dernier est rarement utilis√© par de simples mortels;  le premier fournit tout ce dont nous avons besoin.  Ce qui suit est un exemple de la fa√ßon dont je me prot√®ge d'essayer d'appeler <code>use Iteraptable</code> depuis des modules qui <code>use Iteraptable</code> pas de structures.  En fait, le code de v√©rification appelle simplement depuis le <code>__struct__</code> __struct__ sur le module compil√© et d√©lecte d√©l√®gue <em>Elixir le</em> droit de lever une exception avec un texte clair expliquant la cause du probl√®me: </p><br><pre> <code class="ruby hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">struct_checker</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(env, _bytecode)</span></span></span></span>, <span class="hljs-symbol"><span class="hljs-symbol">do:</span></span> env.<span class="hljs-keyword"><span class="hljs-keyword">module</span></span>.__struct_<span class="hljs-number"><span class="hljs-number">_</span></span></code> </pre> <br><p>  Le code ci-dessus l√®vera une exception si le module compil√© n'est pas une structure.  Bien s√ªr, le code de v√©rification peut √™tre beaucoup plus compliqu√©, mais l'id√©e principale est de savoir si <em>votre module utilis√©</em> attend quelque chose du module <em>qui l'utilise</em> .  Si c'est le cas, il est logique de ne pas oublier <code>@after_compile</code> et de mal√©diction √† partir de l√† si toutes les conditions n√©cessaires ne sont pas remplies.  Lancer une exception est la bonne approche dans ce cas un peu plus que toujours, car ce code est ex√©cut√© au stade de la compilation. </p><br><hr><br><p>  Une histoire amusante est li√©e √† <code>@after_callback</code> , ce qui explique pleinement pourquoi j'aime <em>OSS</em> en g√©n√©ral et <em>Elixir</em> en particulier.  Il y a environ un an, j'ai fait une erreur de copier-coller et <code>@after_callback</code> copi√© quelque part <code>@after_callback</code> au lieu de <code>@before_callback</code> .  La diff√©rence entre eux est probablement √©vidente: la seconde est appel√©e <em>avant la compilation</em> , et √† partir de l√†, tout le monde peut changer l'arbre de syntaxe au-del√† de la reconnaissance.  Et je - oh, comment - je l'ai chang√©.  Mais cela n'a conduit √† aucun r√©sultat dans le code compil√©: cela n'a pas chang√© du tout.  Apr√®s trois tasses de caf√©, j'ai remarqu√© une faute de frappe, remplac√©e <code>after</code> par <code>before</code> et tout a commenc√©;  mais la question me tourmentait: pourquoi le compilateur se taisait-il, comme un partisan.  Il s'est av√©r√© que <code>Module.open?/1</code> renvoie <code>true</code> partir de ce rappel (qui, en principe, n'est pas loin de la v√©rit√© - le module n'est toujours pas ferm√©, l'acc√®s √† ses attributs n'est pas ferm√©, et de nombreuses biblioth√®ques utilisent ce bogue non document√©). </p><br><p>  Eh bien, j'ai esquiss√© un correctif, envoy√© une demande de traction √† la cro√ªte linguistique (au compilateur, si strictement strictement), et moins d'un jour plus tard, il <a href="https://github.com/elixir-lang/elixir/pull/9278/files">s'est retrouv√© dans le ma√Ætre</a> . </p><br><p>  C'est donc lorsque j'ai eu besoin de param√®tres utilisateur dans <code>IO.inspect/2</code> , et dans certains cas.  Que se passerait-il si je tombais dessus en Java?  - C'est effrayant d'imaginer. </p><br><hr><br><p>  Ayez une belle macro! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr485810/">https://habr.com/ru/post/fr485810/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr485792/index.html">Ivan Lilekvist et Kim Dotkom, une grande interview: l'histoire de Megaupload, l'extradition vers les √âtats-Unis, la libert√©, le bitcoin. 2e partie</a></li>
<li><a href="../fr485796/index.html">R√©soudre l'insoluble</a></li>
<li><a href="../fr485800/index.html">Num√©risation vs Automatisation</a></li>
<li><a href="../fr485804/index.html">Et encore une fois, CAPTCHA ou nginx sait aussi broder</a></li>
<li><a href="../fr485806/index.html">Coronavirus: du SRAS √† 2019-nCoV</a></li>
<li><a href="../fr485812/index.html">7 √©tapes d'√©volution des tests dans une entreprise</a></li>
<li><a href="../fr485820/index.html">Personne tr√®s attaqu√©e: d√©couvrez qui est la principale cible des cybercriminels dans votre entreprise.</a></li>
<li><a href="../fr485824/index.html">Comment faire un bot qui transforme une photo en bande dessin√©e. Troisi√®me partie. Mod√®le d'h√©bergement gratuit sans serveur + GPU</a></li>
<li><a href="../fr485828/index.html">Quelles lois dans le domaine du droit num√©rique pourraient appara√Ætre cette ann√©e</a></li>
<li><a href="../fr485834/index.html">Op√©ration Night Fury: avec la participation du Groupe IB en Indon√©sie, des cybercriminels d√©tenus ont infect√© des centaines de boutiques en ligne</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>