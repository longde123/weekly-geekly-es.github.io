<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöΩ ‚úîÔ∏è üç§ Gerar e preencher automaticamente elementos de configura√ß√£o de dispositivos de rede com o Nornir üôÜüèæ ü§æüèº üëçüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√° Habr! 


 Recentemente, um artigo de Mikrotik e Linux apareceu aqui . Rotina e automa√ß√£o onde um problema semelhante foi resolvido por meios f√≥sse...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Gerar e preencher automaticamente elementos de configura√ß√£o de dispositivos de rede com o Nornir</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/482194/"><p><img src="https://habrastorage.org/webt/7z/bp/zt/7zbpztvjkn5yfvxwcxudhj7hrja.png"></p><br><p>  Ol√° Habr! </p><br><p>  Recentemente, um artigo de <a href="https//habr.com/en/post/480404/" rel="nofollow">Mikrotik e Linux apareceu</a> aqui <a href="https//habr.com/en/post/480404/" rel="nofollow">.</a>  <a href="https//habr.com/en/post/480404/" rel="nofollow">Rotina e automa√ß√£o</a> onde um problema semelhante foi resolvido por meios f√≥sseis.  E embora a tarefa seja completamente t√≠pica, Habr√© n√£o encontra nada parecido.  Atrevo-me a oferecer minha bicicleta √† respeit√°vel comunidade de TI. </p><a name="habracut"></a><br><p>  Esta n√£o √© a primeira bicicleta para esta tarefa.  A primeira op√ß√£o foi implementada h√° v√°rios anos na vers√£o ansible 1.x.x.  A bicicleta era raramente usada e, portanto, constantemente enferrujada.  No sentido de que a tarefa em si n√£o ocorre com a mesma frequ√™ncia que as vers√µes atualizadas do <em>ansible</em> .  E toda vez que voc√™ precisar ir, a corrente cair√°, a roda cair√°.  No entanto, a primeira parte, a gera√ß√£o de configura√ß√µes - sempre funciona com muita clareza, pois o mecanismo foi estabelecido h√° muito tempo.  Mas a segunda parte - lan√ßando configura√ß√µes, como regra, trouxe surpresas.  E como tenho que implantar a configura√ß√£o remotamente no ch√£o de centenas de dispositivos, alguns dos quais est√£o a milhares de quil√¥metros de dist√¢ncia, o uso dessa ferramenta foi um pouco assustador. </p><br><p>  Aqui devo admitir que minha inseguran√ßa reside antes na falta de familiaridade comigo, do que em suas defici√™ncias.  E isso, a prop√≥sito, √© um ponto importante.  <em>ansible</em> √© um dom√≠nio de conhecimento pr√≥prio completamente separado, com sua pr√≥pria DSL (Domain Specific Language), que deve ser mantida em um n√≠vel confi√°vel.  Bem, o momento em que o <em>ansible</em> est√° se desenvolvendo rapidamente, e sem aten√ß√£o especial √† compatibilidade com vers√µes anteriores, n√£o adiciona confian√ßa. </p><br><p>  Portanto, n√£o faz muito tempo, a segunda vers√£o da bicicleta foi implementada.  Desta vez em <em>python</em> , ou melhor, em uma estrutura escrita em <em>python</em> e para <em>python</em> chamada <a href="https://nornir.readthedocs.io/" rel="nofollow">Nornir</a> </p><br><p>  So - <em>Nornir</em> √© uma microfrabalhagem escrita em <em>python</em> e para <em>python</em> e destinada √† automa√ß√£o.  Como no caso do <em>ansible</em> , para resolver problemas, aqui √© necess√°ria a prepara√ß√£o competente de dados, isto √©,  invent√°rio de hosts e seus par√¢metros, mas os scripts n√£o s√£o gravados em uma DSL separada, mas todos no mesmo tom n√£o muito antigo, mas muito bom [e | ah]. </p><br><p>  Vejamos o que √© o seguinte exemplo vivo. </p><br><p>  Eu tenho uma rede de ag√™ncias com v√°rias dezenas de escrit√≥rios em todo o pa√≠s.  Em cada escrit√≥rio, h√° um roteador WAN que encerra v√°rios canais de comunica√ß√£o de diferentes operadoras.  O protocolo de roteamento √© BGP.  Existem dois tipos de roteadores WAN: Cisco ISG ou Juniper SRX. </p><br><p>  Agora a tarefa: √© necess√°rio configurar uma sub-rede dedicada para vigil√¢ncia por v√≠deo em uma porta separada em todos os roteadores WAN da rede da filial - anuncie esta sub-rede no BGP - configure o limite de velocidade para a porta dedicada. </p><br><p>  Primeiro, precisamos preparar alguns modelos, com base nas configura√ß√µes que ser√£o geradas separadamente para Cisco e Juniper.  E tamb√©m √© necess√°rio preparar dados para cada ponto e par√¢metros de conex√£o, ou seja,  para coletar esse invent√°rio </p><br><p>  Modelo pronto para Cisco: </p><br><pre><code class="bash hljs">$ cat templates/ios/base.j2 class-map match-all VIDEO_SURV match access-group 111 policy-map VIDEO_SURV class VIDEO_SURV police 1500000 conform-action transmit exceed-action drop interface {{ host.task_data.ifname }} description VIDEOSURV ip address 10.10.{{ host.task_data.ipsuffix }}.254 255.255.255.0 service-policy input VIDEO_SURV router bgp {{ host.task_data.asn }} network 10.40.{{ host.task_data.ipsuffix }}.0 mask 255.255.255.0 access-list 11 permit 10.10.{{ host.task_data.ipsuffix }}.0 0.0.0.255 access-list 111 permit ip 10.10.{{ host.task_data.ipsuffix }}.0 0.0.0.255 any</code> </pre> <br><p>  Modelo para o Juniper: </p><br><pre> <code class="bash hljs">$ cat templates/junos/base.j2 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> interfaces {{ host.task_data.ifname }} unit 0 description <span class="hljs-string"><span class="hljs-string">"Video surveillance"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> interfaces {{ host.task_data.ifname }} unit 0 family inet filter input <span class="hljs-built_in"><span class="hljs-built_in">limit</span></span>-in <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> interfaces {{ host.task_data.ifname }} unit 0 family inet address 10.10.{{ host.task_data.ipsuffix }}.254/24 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> policy-options policy-statement export2bgp term 1 from route-filter 10.10.{{ host.task_data.ipsuffix }}.0/24 exact <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> security zones security-zone WAN interfaces {{ host.task_data.ifname }} <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> firewall policer policer-1m <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>-exceeding bandwidth-limit 1m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> firewall policer policer-1m <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>-exceeding burst-size-limit 187k <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> firewall policer policer-1m <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> discard <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> firewall policer policer-1.5m <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>-exceeding bandwidth-limit 1500000 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> firewall policer policer-1.5m <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>-exceeding burst-size-limit 280k <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> firewall policer policer-1.5m <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> discard <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> firewall filter <span class="hljs-built_in"><span class="hljs-built_in">limit</span></span>-in term 1 <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> policer policer-1.5m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> firewall filter <span class="hljs-built_in"><span class="hljs-built_in">limit</span></span>-in term 1 <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> count limiter</code> </pre> <br><p>  Os modelos, √© claro, n√£o s√£o retirados do teto.  Essa √© essencialmente a diferen√ßa entre as configura√ß√µes de trabalho - foi depois de resolver a tarefa em dois roteadores espec√≠ficos de modelos diferentes. </p><br><p>  Nos nossos modelos, vemos que, para resolvermos o problema, dois par√¢metros para o Juniper e tr√™s para a Cisco s√£o suficientes.  aqui est√£o eles: </p><br><ul><li>  ifname </li><li>  ipsuffix </li><li>  asn </li></ul><br><p>  Agora, precisamos definir esses par√¢metros para cada dispositivo, ou seja,  fa√ßa o mesmo <em>invent√°rio</em> . </p><br><p>  Para o <em>invent√°rio</em> , seguiremos claramente a <a href="https://nornir.readthedocs.io/en/latest/tutorials/intro/initializing_nornir.html" rel="nofollow">se√ß√£o Inicializando o Nornir</a> </p><br><p>  ou seja, crie o mesmo esqueleto de arquivo: </p><br><pre> <code class="bash hljs">. ‚îú‚îÄ‚îÄ config.yaml ‚îú‚îÄ‚îÄ inventory ‚îÇ ‚îú‚îÄ‚îÄ defaults.yaml ‚îÇ ‚îú‚îÄ‚îÄ groups.yaml ‚îÇ ‚îî‚îÄ‚îÄ hosts.yaml</code> </pre> <br><p>  Arquivo Config.yaml - arquivo de configura√ß√£o padr√£o do nornir </p><br><pre> <code class="plaintext hljs">$ cat config.yaml --- core: num_workers: 10 inventory: plugin: nornir.plugins.inventory.simple.SimpleInventory options: host_file: "inventory/hosts.yaml" group_file: "inventory/groups.yaml" defaults_file: "inventory/defaults.yaml"</code> </pre> <br><p>  Vamos especificar os principais par√¢metros no arquivo <em>hosts.yaml</em> , group (no meu caso, nomes de usu√°rio / senhas) em <em>groups.yaml</em> , e n√£o especificaremos nada em <em>defaults.yaml</em> , mas deve haver tr√™s menos para indicar que este √© um arquivo <em>yaml</em> embora vazio. </p><br><p>  √â assim que o hosts.yaml se parece: </p><br><pre> <code class="plaintext hljs">--- srx-test: hostname: srx-test groups: - juniper data: task_data: ifname: fe-0/0/2 ipsuffix: 111 cisco-test: hostname: cisco-test groups: - cisco data: task_data: ifname: GigabitEthernet0/1/1 ipsuffix: 222 asn: 65111</code> </pre> <br><p>  E aqui est√° groups.yaml: </p><br><pre> <code class="plaintext hljs">--- cisco: platform: ios username: admin1 password: cisco1 juniper: platform: junos username: admin2 password: juniper2</code> </pre> <br><p>  Aqui est√° o <em>invent√°rio</em> da nossa tarefa.  Durante a inicializa√ß√£o, os par√¢metros dos arquivos de invent√°rio s√£o mapeados para o modelo de objeto <strong>InventoryElement</strong> . </p><br><div class="spoiler">  <b class="spoiler_title">Sob o spoiler, o diagrama do modelo InventoryElement</b> <div class="spoiler_text"><pre> <code class="json hljs">print(json.dumps(InventoryElement.schema(), indent=<span class="hljs-number"><span class="hljs-number">4</span></span>)) { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"InventoryElement"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"object"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"properties"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"hostname"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Hostname"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"string"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"port"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Port"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"integer"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"username"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Username"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"string"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"password"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Password"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"string"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"platform"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Platform"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"string"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"groups"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Groups"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"default"</span></span>: [], <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"array"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"items"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"string"</span></span> } }, <span class="hljs-attr"><span class="hljs-attr">"data"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Data"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"default"</span></span>: {}, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"object"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"connection_options"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Connection_Options"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"default"</span></span>: {}, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"object"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"additionalProperties"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"$ref"</span></span>: <span class="hljs-string"><span class="hljs-string">"#/definitions/ConnectionOptions"</span></span> } } }, <span class="hljs-attr"><span class="hljs-attr">"definitions"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"ConnectionOptions"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"ConnectionOptions"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"object"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"properties"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"hostname"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Hostname"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"string"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"port"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Port"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"integer"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"username"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Username"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"string"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"password"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Password"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"string"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"platform"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Platform"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"string"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"extras"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Extras"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"object"</span></span> } } } } }</code> </pre> </div></div><br><p>  Este modelo pode parecer um pouco confuso, especialmente no in√≠cio.  O modo interativo no <strong>ipython</strong> ajuda muito para descobrir isso. </p><br><pre> <code class="bash hljs"> $ ipython3 Python 3.6.9 (default, Nov 7 2019, 10:44:02) Type <span class="hljs-string"><span class="hljs-string">'copyright'</span></span>, <span class="hljs-string"><span class="hljs-string">'credits'</span></span> or <span class="hljs-string"><span class="hljs-string">'license'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> more information IPython 7.1.1 -- An enhanced Interactive Python. Type <span class="hljs-string"><span class="hljs-string">'?'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-built_in"><span class="hljs-built_in">help</span></span>. In [1]: from nornir import InitNornir In [2]: nr = InitNornir(config_file=<span class="hljs-string"><span class="hljs-string">"config.yaml"</span></span>, dry_run=True) In [3]: nr.inventory.hosts Out[3]: {<span class="hljs-string"><span class="hljs-string">'srx-test'</span></span>: Host: srx-test, <span class="hljs-string"><span class="hljs-string">'cisco-test'</span></span>: Host: cisco-test} In [4]: nr.inventory.hosts[<span class="hljs-string"><span class="hljs-string">'srx-test'</span></span>].data Out[4]: {<span class="hljs-string"><span class="hljs-string">'task_data'</span></span>: {<span class="hljs-string"><span class="hljs-string">'ifname'</span></span>: <span class="hljs-string"><span class="hljs-string">'fe-0/0/2'</span></span>, <span class="hljs-string"><span class="hljs-string">'ipsuffix'</span></span>: 111}} In [5]: nr.inventory.hosts[<span class="hljs-string"><span class="hljs-string">'srx-test'</span></span>][<span class="hljs-string"><span class="hljs-string">'task_data'</span></span>] Out[5]: {<span class="hljs-string"><span class="hljs-string">'ifname'</span></span>: <span class="hljs-string"><span class="hljs-string">'fe-0/0/2'</span></span>, <span class="hljs-string"><span class="hljs-string">'ipsuffix'</span></span>: 111} In [6]: nr.inventory.hosts[<span class="hljs-string"><span class="hljs-string">'srx-test'</span></span>].platform Out[6]: <span class="hljs-string"><span class="hljs-string">'junos'</span></span></code> </pre><br><p>  Bem, finalmente, vamos seguir para o pr√≥prio script.  N√£o h√° nada de especial para eu me orgulhar.  Eu apenas peguei o exemplo final do <a href="https://nornir.readthedocs.io/en/latest/tutorials/intro/grouping_tasks.html" rel="nofollow">tutorial</a> e o usei quase sem altera√ß√µes.  √â assim que o script de trabalho final se parece: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> nornir <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> InitNornir <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> nornir.plugins.tasks <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> networking, text <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> nornir.plugins.functions.text <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> print_title, print_result <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">config_and_deploy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(task)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># Transform inventory data to configuration via a template file r = task.run(task=text.template_file, name="Base Configuration", template="base.j2", path=f"templates/{task.host.platform}") # Save the compiled configuration into a host variable task.host["config"] = r.result # Save the compiled configuration into a file with open(f"configs/{task.host.hostname}", "w") as f: f.write(r.result) # Deploy that configuration to the device using NAPALM task.run(task=networking.napalm_configure, name="Loading Configuration on the device", replace=False, configuration=task.host["config"]) nr = InitNornir(config_file="config.yaml", dry_run=True) # set dry_run=False, cross your fingers and run again # run tasks result = nr.run(task=config_and_deploy) print_result(result)</span></span></code> </pre> <br><p>  Observe o par√¢metro <em>dry_run = True</em> na linha de inicializa√ß√£o do objeto <strong>nr</strong> . <br>  Aqui, assim como √© <em>poss√≠vel</em> , √© executada uma execu√ß√£o de teste na qual a conex√£o ao roteador √© feita, uma nova configura√ß√£o alterada √© preparada, que √© validada pelo dispositivo (mas isso n√£o √© exato; depende do suporte e da implementa√ß√£o do driver no NAPALM), mas a nova configura√ß√£o n√£o √© aplicada diretamente .  Para uso em combate, voc√™ deve remover o par√¢metro <em>dry_run</em> ou alterar seu valor para <em>False</em> . </p><br><p>  Quando o script √© executado, o Nornir exibe logs detalhados no console. </p><br><div class="spoiler">  <b class="spoiler_title">Sob o spoiler, a conclus√£o do combate √© executada em dois roteadores de teste:</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">config_and_deploy*************************************************************** * cisco-test ** changed : True ******************************************* vvvv config_and_deploy ** changed : True vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv INFO ---- Base Configuration ** changed : True ------------------------------------- INFO class-map match-all VIDEO_SURV match access-group 111 policy-map VIDEO_SURV class VIDEO_SURV police 1500000 conform-action transmit exceed-action drop interface GigabitEthernet0/1/1 description VIDEOSURV ip address 10.10.222.254 255.255.255.0 service-policy input VIDEO_SURV router bgp 65001 network 10.10.222.0 mask 255.255.255.0 access-list 11 permit 10.10.222.0 0.0.0.255 access-list 111 permit ip 10.10.222.0 0.0.0.255 any ---- Loading Configuration on the device ** changed : True --------------------- INFO +class-map match-all VIDEO_SURV + match access-group 111 +policy-map VIDEO_SURV + class VIDEO_SURV +interface GigabitEthernet0/1/1 + description VIDEOSURV + ip address 10.10.222.254 255.255.255.0 + service-policy input VIDEO_SURV +router bgp 65001 + network 10.10.222.0 mask 255.255.255.0 +access-list 11 permit 10.10.222.0 0.0.0.255 +access-list 111 permit ip 10.10.222.0 0.0.0.255 any ^^^^ END config_and_deploy ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ * srx-test ** changed : True ******************************************* vvvv config_and_deploy ** changed : True vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv INFO ---- Base Configuration ** changed : True ------------------------------------- INFO set interfaces fe-0/0/2 unit 0 description "Video surveillance" set interfaces fe-0/0/2 unit 0 family inet filter input limit-in set interfaces fe-0/0/2 unit 0 family inet address 10.10.111.254/24 set policy-options policy-statement export2bgp term 1 from route-filter 10.10.111.0/24 exact set security zones security-zone WAN interfaces fe-0/0/2 set firewall policer policer-1m if-exceeding bandwidth-limit 1m set firewall policer policer-1m if-exceeding burst-size-limit 187k set firewall policer policer-1m then discard set firewall policer policer-1.5m if-exceeding bandwidth-limit 1500000 set firewall policer policer-1.5m if-exceeding burst-size-limit 280k set firewall policer policer-1.5m then discard set firewall filter limit-in term 1 then policer policer-1.5m set firewall filter limit-in term 1 then count limiter ---- Loading Configuration on the device ** changed : True --------------------- INFO [edit interfaces] + fe-0/0/2 { + unit 0 { + description "Video surveillance"; + family inet { + filter { + input limit-in; + } + address 10.10.111.254/24; + } + } + } [edit] + policy-options { + policy-statement export2bgp { + term 1 { + from { + route-filter 10.10.111.0/24 exact; + } + } + } + } [edit security zones] security-zone test-vpn { ... } + security-zone WAN { + interfaces { + fe-0/0/2.0; + } + } [edit] + firewall { + policer policer-1m { + if-exceeding { + bandwidth-limit 1m; + burst-size-limit 187k; + } + then discard; + } + policer policer-1.5m { + if-exceeding { + bandwidth-limit 1500000; + burst-size-limit 280k; + } + then discard; + } + filter limit-in { + term 1 { + then { + policer policer-1.5m; + count limiter; + } + } + } + } ^^^^ END config_and_deploy ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</code> </pre> </div></div><br><h3 id="pryachem-paroli-v-ansible_vault">  Ocultando senhas no ansible_vault </h3><br><p>  No come√ßo do artigo, fiquei <em>um pouco ansioso</em> , mas nem tudo √© t√£o ruim l√°.  Eu realmente gosto do <strong>cofre</strong> , projetado para esconder informa√ß√µes confidenciais fora da vista.  E provavelmente muitos notaram que temos todos os nomes de usu√°rio / senhas para todos os roteadores de batalha brilhando no formul√°rio aberto no arquivo <em>groups.yaml</em> .  √â feio, √© claro.  Vamos proteger esses dados com o <strong>vault</strong> . </p><br><p>  Transferimos os par√¢metros de groups.yaml para creds.yaml e criptografamos com AES256 com uma senha de 20 d√≠gitos: </p><br><pre> <code class="bash hljs">$ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> inventory $ cat creds.yaml --- cisco: username: admin1 password: cisco1 juniper: username: admin2 password: juniper2 $ pwgen 20 -N 1 &gt; vault.passwd ansible-vault encrypt creds.yaml --vault-password-file vault.passwd Encryption successful $ cat creds.yaml <span class="hljs-variable"><span class="hljs-variable">$ANSIBLE_VAULT</span></span>;1.1;AES256 39656463353437333337356361633737383464383231366233386636333965306662323534626131 3964396534396333363939373539393662623164373539620a346565373439646436356438653965 39643266333639356564663961303535353364383163633232366138643132313530346661316533 6236306435613132610a656163653065633866626639613537326233653765353661613337393839 62376662303061353963383330323164633162386336643832376263343634356230613562643533 30363436343465306638653932366166306562393061323636636163373164613630643965636361 34343936323066393763323633336366366566393236613737326530346234393735306261363239 35663430623934323632616161636330353134393435396632663530373932383532316161353963 31393434653165613432326636616636383665316465623036376631313162646435</code> </pre> <br><p>  T√£o simples.  Resta ensinar nosso script <em>Nornir</em> a obter e usar esses dados. <br>  Para fazer isso, em nosso script, ap√≥s a linha de inicializa√ß√£o <em>nr = InitNornir (config_file = ...</em> adicione o seguinte c√≥digo: </p><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">... </span></span>nr = InitNornir(config_file=<span class="hljs-string"><span class="hljs-string">"config.yaml"</span></span>, dry_run=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) <span class="hljs-comment"><span class="hljs-comment"># set dry_run=False, cross your fingers and run again # enrich Inventory with the encrypted vault data from ansible_vault import Vault vault_password_file="inventory/vault.passwd" vault_file="inventory/creds.yaml" with open(vault_password_file, "r") as fp: password = fp.readline().strip() vault = Vault(password) vaultdata = vault.load(open(vault_file).read()) for a in nr.inventory.hosts.keys(): item = nr.inventory.hosts[a] item.username = vaultdata[item.groups[0]]['username'] item.password = vaultdata[item.groups[0]]['password'] #print("hostname={}, username={}, password={}\n".format(item.hostname, item.username, item.password)) # run tasks ...</span></span></code> </pre> <br><p>  Obviamente, o vault.passwd n√£o deve estar ao lado de creds.yaml, como no meu exemplo.  Mas, para jogar, serve. </p><br><p>  Por enquanto √© tudo.  Alguns artigos sobre o Cisco + Zabbix est√£o chegando, mas isso n√£o √© um pouco sobre automa√ß√£o.  E, em um futuro pr√≥ximo, pretendo escrever sobre o RESTCONF na Cisco. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt482194/">https://habr.com/ru/post/pt482194/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt482178/index.html">A hist√≥ria de um estudante coreano que recebeu um pr√™mio do minist√©rio por um sistema de monitoramento de filas</a></li>
<li><a href="../pt482182/index.html">Que problemas eu teria se lutasse pelo equil√≠brio de g√™nero em TI?</a></li>
<li><a href="../pt482186/index.html">Vida e TI ou no ano em que larguei meu √∫ltimo emprego</a></li>
<li><a href="../pt482188/index.html">Enquete de sexta-feira sobre atualiza√ß√µes</a></li>
<li><a href="../pt482190/index.html">Como √© o conte√∫do da Durex nas redes sociais na China</a></li>
<li><a href="../pt482196/index.html">O que √© modelagem de produ√ß√£o e por que √© necess√°rio?</a></li>
<li><a href="../pt482198/index.html">Como fazer o seu autoescalonador para um cluster</a></li>
<li><a href="../pt482200/index.html">Blockchain para seguran√ßa cibern√©tica: expectativas e realidade</a></li>
<li><a href="../pt482202/index.html">M√©todos para atualizar a criptografia no equipamento Check Point para o GOST 2012</a></li>
<li><a href="../pt482206/index.html">Como tornar a produ√ß√£o 3D de pe√ßas para aeronaves mais econ√¥mica</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>