<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨‍🏫 🥣 🍇 Akses data dalam aplikasi multi-pengguna 🚏 😏 👐</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Masalah membatasi akses ke data muncul hampir selalu ketika mengembangkan sistem multi-pengguna. Skenario utama adalah sebagai berikut: 



1. pembata...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Akses data dalam aplikasi multi-pengguna</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/414897/"><img align="left" src="https://habrastorage.org/webt/ep/hy/af/ephyaff-x0gnkq1llhit-ryczsc.jpeg">  Masalah membatasi akses ke data muncul hampir selalu ketika mengembangkan sistem multi-pengguna.  Skenario utama adalah sebagai berikut: <br><br><ol><li>  pembatasan akses data untuk pengguna yang diautentikasi </li><li>  pembatasan akses ke data untuk diautentikasi tetapi tidak memiliki hak pengguna yang diperlukan </li><li>  mencegah akses tidak sah melalui panggilan langsung ke API </li><li>  <b>memfilter data dalam permintaan pencarian dan daftar elemen UI (tabel, daftar)</b> </li><li>  <b>mencegah perubahan data milik satu pengguna oleh pengguna lain</b> </li></ol><br>  Skenario 1-3 dijelaskan dengan baik dan biasanya diselesaikan dengan menggunakan alat kerangka kerja bawaan, seperti otorisasi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">berbasis</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">peran</a> atau <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">klaim</a> .  Tetapi situasi ketika pengguna yang berwenang dapat secara langsung mengakses data "tetangga" atau mengambil tindakan dalam akunnya terjadi setiap saat.  Ini paling sering terjadi karena fakta bahwa programmer lupa untuk menambahkan cek yang diperlukan.  Anda dapat mengandalkan tinjauan kode, atau Anda dapat mencegah situasi seperti itu dengan menerapkan aturan penyaringan data global.  Mereka akan dibahas dalam artikel. <br><a name="habracut"></a><br><h3>  Daftar dan tabel </h3><br>  Pengontrol khas untuk menerima data dalam ASP.NET MVC mungkin terlihat <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">seperti ini</a> : <br><br><pre><code class="hljs pgsql">[HttpGet] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> virtual IActionResult <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>([FromQuery]T parameter) { var total = _dbContext .<span class="hljs-keyword"><span class="hljs-keyword">Set</span></span>&lt;TEntity&gt;() .<span class="hljs-keyword"><span class="hljs-keyword">Where</span></span>(<span class="hljs-comment"><span class="hljs-comment">/* some business rules */</span></span>) .Count(); var items= _dbContext .<span class="hljs-keyword"><span class="hljs-keyword">Set</span></span>&lt;TEntity&gt;() .<span class="hljs-keyword"><span class="hljs-keyword">Where</span></span>(<span class="hljs-comment"><span class="hljs-comment">/* some business rules */</span></span>) .ProjectTo&lt;TDto&gt;() .Skip(parameter.Skip) .Take(parameter.Take) .ToList(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Ok(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> {items, total}); }</code> </pre> <br>  Dalam hal ini, semua tanggung jawab untuk memfilter data hanya ada pada programmer.  Apakah dia akan ingat bahwa perlu untuk menambahkan kondisi di <code>Where</code> atau tidak? <br><br>  Anda dapat memecahkan masalah menggunakan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">filter global</a> .  Namun, untuk membatasi akses, kami memerlukan informasi tentang pengguna saat ini, yang berarti bahwa konstruksi <code>DbContext</code> harus rumit untuk menginisialisasi bidang tertentu. <br><br>  Jika ada banyak aturan, maka implementasi <code>DbContext</code> pasti akan harus belajar "terlalu banyak", yang akan melanggar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">prinsip tanggung jawab tunggal</a> . <br><br><h3>  Arsitektur engah </h3><br>  Masalah dengan akses ke data dan copy-paste terjadi karena dalam contoh kami mengabaikan pembagian menjadi lapisan dan dari pengendali kami segera mencapai lapisan akses data, melewati lapisan logika bisnis.  Pendekatan ini bahkan telah dijuluki " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">pengendali jelek dan bodoh</a> ."  Dalam artikel ini saya tidak ingin menyentuh masalah yang berkaitan dengan repositori, layanan, dan penataan logika bisnis.  Filter global melakukan pekerjaan ini dengan baik, Anda hanya perlu menerapkannya pada abstraksi dari lapisan lain. <br><br><h3>  Tambahkan abstraksi </h3><br>  .NET sudah memiliki <code>IQueryable</code> untuk mengakses data.  Ganti akses langsung ke <code>DbContext</code> dengan akses ke penyedia tersebut: <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IQueryableProvider</span></span> { IQueryable&lt;T&gt; Query&lt;T&gt;() <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T: <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>; <span class="hljs-function"><span class="hljs-function">IQueryable </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Query</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Type type</span></span></span><span class="hljs-function">)</span></span>; }</code> </pre> <br>  Dan untuk mengakses data, kami akan membuat filter ini: <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IPermissionFilter</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; { <span class="hljs-function"><span class="hljs-function">IQueryable&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetPermitted</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IQueryable&lt;T&gt; queryable</span></span></span><span class="hljs-function">)</span></span>; }</code> </pre><br>  Kami menerapkan penyedia sedemikian rupa sehingga mencari semua filter yang dinyatakan dan secara otomatis menerapkannya: <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">QueryableProvider</span></span>: <span class="hljs-title"><span class="hljs-title">IQueryableProvider</span></span> { <span class="hljs-comment"><span class="hljs-comment">//       private static Type[] Filters = typeof(PermissionFilter&lt;&gt;) .Assembly .GetTypes() .Where(x =&gt; x.GetInterfaces().Any(y =&gt; y.IsGenericType &amp;&amp; y.GetGenericTypeDefinition() == typeof(IPermissionFilter&lt;&gt;))) .ToArray(); private readonly DbContext _dbContext; private readonly IIdentity _identity; public QueryableProvider(DbContext dbContext, IIdentity identity) { _dbContext = dbContext; _identity = identity; } private static MethodInfo QueryMethod = typeof(QueryableProvider) .GetMethods() .First(x =&gt; x.Name == "Query" &amp;&amp; x.IsGenericMethod); private IQueryable&lt;T&gt; Filter&lt;T&gt;(IQueryable&lt;T&gt; queryable) =&gt; Filters //     .Where(x =&gt; x.GetGenericArguments().First() == typeof(T)) //         Queryable&lt;T&gt; .Aggregate(queryable, (c, n) =&gt; ((dynamic)Activator.CreateInstance(n, _dbContext, _identity)).GetPermitted(queryable)); public IQueryable&lt;T&gt; Query&lt;T&gt;() where T : class =&gt; Filter(_dbContext.Set&lt;T&gt;()); //  EF Core  Set(Type type),    :( public IQueryable Query(Type type) =&gt; (IQueryable)QueryMethod .MakeGenericMethod(type) .Invoke(_dbContext, new object[]{}); }</span></span></code> </pre> <br>  Kode untuk mendapatkan dan membuat filter dalam contoh ini tidak optimal.  Alih-alih <code>Activator.CreateInstance</code> lebih baik menggunakan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Pohon Ekspresi yang dikompilasi</a> .  Beberapa kontainer IOC mendukung <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">registrasi obat generik terbuka</a> .  Saya akan meninggalkan pertanyaan pengoptimalan di luar cakupan artikel ini. <br><br><h3>  Kami menyadari filter </h3><br>  Implementasi filter mungkin terlihat seperti ini: <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">EntityPermissionFilter</span></span>: <span class="hljs-title"><span class="hljs-title">PermissionFilter</span></span>&lt;<span class="hljs-title"><span class="hljs-title">Entity</span></span>&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EntityPermissionFilter</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DbContext dbContext, IIdentity identity</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">dbContext, identity</span></span></span><span class="hljs-function">)</span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> IQueryable&lt;Practice&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetPermitted</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> IQueryable&lt;Practice&gt; queryable</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> DbContext .Set&lt;Practice&gt;() .WhereIf(User.OrganizationType == OrganizationType.Client, x =&gt; x.Manager.OrganizationId == User.OrganizationId) .WhereIf(User.OrganizationType == OrganizationType.StaffingAgency, x =&gt; x.Partners .Select(y =&gt; y.OrganizationId) .Contains(User.OrganizationId)); } }</code> </pre> <br><h3>  Kami memperbaiki kode pengontrol </h3><br><pre> <code class="hljs cs"> [<span class="hljs-meta"><span class="hljs-meta">HttpGet</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> IActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Get</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[FromQuery]T parameter</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> total = QueryableProvider .Query&lt;TEntity&gt;() .Where(<span class="hljs-comment"><span class="hljs-comment">/* some business rules */</span></span>) .Count(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> items = QueryableProvider .Query&lt;TEntity&gt;() .Where(<span class="hljs-comment"><span class="hljs-comment">/* some business rules */</span></span>) .ProjectTo&lt;TDto&gt;() .Skip(parameter.Skip) .Take(parameter.Take) .ToList(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Ok(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> {items, total}); }</code> </pre><br>  Tidak banyak perubahan sama sekali.  Tetap melarang akses langsung ke <code>DbContext</code> dari pengontrol dan jika filter ditulis dengan benar, maka masalah akses data dapat dianggap tertutup.  Filternya cukup kecil, jadi menutupinya dengan tes tidaklah sulit.  Selain itu, filter yang sama ini dapat digunakan untuk menulis kode otorisasi yang mencegah akses tidak sah ke data "asing".  Saya akan meninggalkan pertanyaan ini untuk artikel selanjutnya. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id414897/">https://habr.com/ru/post/id414897/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id414887/index.html">Membuat hook kucing di Unity. Bagian 1</a></li>
<li><a href="../id414889/index.html">Ketika Lembaga Digital Membutuhkan IaaS</a></li>
<li><a href="../id414891/index.html">Kebiasaan Pengembang</a></li>
<li><a href="../id414893/index.html">Viber, WhatsApp, Telegram - mana yang lebih baik?</a></li>
<li><a href="../id414895/index.html">Dan bagi kami semuanya "tegak" - DBMS Vertica</a></li>
<li><a href="../id414899/index.html">Cara mengumpulkan analitik dan tidak membunuh produktivitas</a></li>
<li><a href="../id414901/index.html">Dell dan DROVA: cara bermain game yang menuntut bahkan pada laptop yang lemah</a></li>
<li><a href="../id414905/index.html">Komponen web Bagian 3: templat dan impor html</a></li>
<li><a href="../id414907/index.html">Apa yang menghubungkan teori bilangan dengan lintasan cahaya?</a></li>
<li><a href="../id414909/index.html">Sejarah jabat tangan SSL tunggal</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>