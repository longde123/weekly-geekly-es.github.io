<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèΩ‚Äç‚öïÔ∏è üòâ üöï 9 anos em um mon√≥lito no Node.JS üìµ üí∑ üïç</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="H√° uma semana, falei em uma reuni√£o do Node.JS e prometi a muitos que publicassem uma grava√ß√£o da apresenta√ß√£o. Mais tarde, percebi que n√£o era capaz ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>9 anos em um mon√≥lito no Node.JS</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/459206/"><p><img src="https://habrastorage.org/webt/p-/5g/we/p-5gweh68uzyj3_baevjuocr8xi.png" alt="mon√≥lito de https://reneaigner.deviantart.com"></p><br><p>  H√° uma semana, falei em uma reuni√£o do Node.JS e prometi a muitos que publicassem uma grava√ß√£o da apresenta√ß√£o.  Mais tarde, percebi que n√£o era capaz de acomodar alguns fatos interessantes em meia hora regulamentada.  Sim, e eu mesmo prefiro ler, em vez de assistir e ouvir, ent√£o decidi postar minha apresenta√ß√£o no formato de um artigo.  No entanto, o v√≠deo tamb√©m estar√° no final da postagem na se√ß√£o de links. </p><br><p> Decidi falar sobre um ponto delicado - a vida em um mon√≥lito.  J√° existem centenas de artigos sobre o assunto no hub, milhares de c√≥pias est√£o quebradas nos coment√°rios, a verdade h√° muito morre na controv√©rsia, mas ... O fato √© que temos uma experi√™ncia muito espec√≠fica no OneTwoTrip, ao contr√°rio de muitas pessoas que escrevem sobre certos padr√µes arquiteturais no v√°cuo: </p><br><ul><li>  Em primeiro lugar, nosso mon√≥lito j√° tem 9 anos. </li><li>  Em segundo lugar, ele passou a vida inteira sob carga pesada (agora s√£o 23 milh√µes de solicita√ß√µes por hora). </li><li>  E no NaN, escrevemos nosso mon√≥lito no Node.JS, que mudou al√©m do reconhecimento nos √∫ltimos 9 anos.  Sim, come√ßamos a escrever sobre o n√≥ em 2010, cantamos uma m√∫sica para o frenesi dos bravos! </li></ul><br><p>  Portanto, temos muita especificidade e experi√™ncia real.  Interessante?  Vamos l√°! </p><a name="habracut"></a><br><p>  <strong>Tempos de isen√ß√£o</strong> </p><br><blockquote>  Esta apresenta√ß√£o reflete apenas a opini√£o privada de seu autor.  Pode coincidir com a posi√ß√£o do OneTwoTrip ou pode n√£o coincidir.  Isso √© que sorte.  Trabalho como especialista t√©cnico de uma das equipes da empresa e n√£o pretendo ser objetivo ou expressar a opini√£o de algu√©m que n√£o seja a minha. </blockquote><p>  <strong>Isen√ß√£o de responsabilidade dois</strong> </p><br><blockquote>  Este artigo descreve eventos hist√≥ricos e, no momento, tudo est√° completamente errado, portanto, n√£o se assuste. </blockquote><br><h2 id="0-kak-zhe-tak-vyshlo">  0. Como isso aconteceu </h2><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">A tend√™ncia da consulta da</a> palavra "microsservi√ßo" no google: <br><img src="https://habrastorage.org/webt/i5/ss/lm/i5sslmpta1fldeztaxgmmnd50ag.png"><br>  Tudo √© muito simples - h√° nove anos, ningu√©m sabia sobre microsservi√ßos.  Ent√£o come√ßamos a escrever, como todo mundo - em um mon√≥lito. </p><br><h2 id="1-bol-v-monolite">  1. Dor no mon√≥lito </h2><br><p>  Aqui vou descrever as situa√ß√µes problem√°ticas que tivemos durante esses 9 anos.  Alguns deles foram resolvidos, outros foram contornados por hacks, alguns simplesmente perderam a relev√¢ncia.  Mas a lembran√ßa deles, como cicatrizes de batalha, nunca vai me deixar. </p><br><h3 id="11-obnovlenie-svyaznyh-komponentov">  1.1 Atualizando componentes conectados </h3><br><p><img src="https://habrastorage.org/webt/0a/h-/8f/0ah-8f7ijb259t-blaohq1_dceg.png"><br>  Este √© o caso quando a sinergia √© m√°.  Como qualquer componente foi reutilizado v√°rias centenas de vezes e, se foi poss√≠vel us√°-lo de forma torta, n√£o foi perdido.  Qualquer a√ß√£o pode causar efeitos completamente imprevis√≠veis, e nem todos s√£o rastreados por unidades e testes de integra√ß√£o.  Lembre-se da hist√≥ria sobre esfreg√µes, um f√£ e um bal√£o?  Caso contr√°rio, pesquise no Google.  Ela √© a melhor ilustra√ß√£o do c√≥digo no mon√≥lito. </p><br><h3 id="12-migraciya-na-novye-tehnologii">  1.2 Migra√ß√£o para novas tecnologias </h3><br><p>  Voc√™ quer Express?  Linter?  Outra estrutura para testes ou moks?  Atualizar validador ou pelo menos lodash?  Atualizar o Node.js?  Me desculpe  Para fazer isso, voc√™ precisa editar milhares de linhas de c√≥digo. </p><br><p>  Muitos falam sobre a vantagem do mon√≥lito, que √© que <strong>qualquer revis√£o √© um commit at√¥mico</strong> .  Essas pessoas ficam caladas sobre uma <strong>coisa</strong> - <strong>essa revis√£o nunca ser√° feita</strong> . </p><br><p>  Voc√™ conhece a velha piada sobre controle de vers√£o sem√¢ntico? </p><br><blockquote>  a sem√¢ntica real do versionamento sem√¢ntico: <br><br>  major = uma mudan√ßa de ruptura <br>  menor = uma pequena mudan√ßa de quebra <br>  patch = uma mudan√ßa de √∫ltima hora </blockquote><p>  Agora imagine que qualquer altera√ß√£o min√∫scula que quase certamente aparecer√° no seu c√≥digo.  N√£o, √© poss√≠vel viver com isso, e periodicamente reunimos for√ßas e migramos, mas foi realmente muito dif√≠cil.  Muito. </p><br><h3 id="13-relizy">  1.3 Lan√ßamentos </h3><br><p>  Aqui devo dizer sobre algumas especificidades do nosso produto.  Temos um grande n√∫mero de integra√ß√µes externas e v√°rios ramos da l√≥gica de neg√≥cios que surgem separadamente muito raramente.  Eu realmente invejo os produtos que realmente executam todas as ramifica√ß√µes de seu c√≥digo em 10 minutos de produ√ß√£o, mas esse n√£o √© o caso aqui.  Por tentativa e erro, descobrimos para n√≥s um ciclo ideal de lan√ßamento que minimizava o n√∫mero de erros que atingem os usu√°rios finais: </p><br><ol><li>  o lan√ßamento est√° indo e os testes de integra√ß√£o passam em meio dia </li><li>  depois, sob cuidadosa supervis√£o no palco por um dia (para 10% dos usu√°rios) </li><li>  depois fica outro dia na produ√ß√£o sob supervis√£o ainda mais cuidadosa. </li><li>  E somente depois disso, damos a ele a luz verde no mestre. </li></ol><br><p>  Como amamos nossos colegas e n√£o fazemos o lan√ßamento √†s sextas-feiras, no final, isso significa que o lan√ßamento vai para o mestre cerca de 1,5 a 2 vezes por semana.  O que leva ao fato de que o lan√ßamento pode ter 60 tarefas ou mais.  essa quantidade causa conflitos de mesclagem, efeitos sin√©rgicos repentinos, carga total de controle de qualidade na an√°lise de logs e outras tristezas.  Em geral, foi muito dif√≠cil lan√ßar um mon√≥lito. </p><br><h3 id="14-prosto-ochen-mnogo-koda">  1.4 Apenas muito c√≥digo </h3><br><p>  Parece que a quantidade de c√≥digo n√£o deve ser de import√¢ncia fundamental.  Mas ... na verdade n√£o.  No mundo real √©: </p><br><ul><li>  Limiar de entrada mais alto </li><li>  Artefatos de constru√ß√£o enormes para cada tarefa </li><li>  Processos longos de IC, incluindo testes de integra√ß√£o, testes de unidade e at√© mesmo c√≥digo </li><li>  Trabalho lento do IDE (no in√≠cio do desenvolvimento do Jetbrains, n√≥s os chocamos com nossos logs mais de uma vez) </li><li>  Pesquisa contextual sofisticada (n√£o se esque√ßa, n√£o temos digita√ß√£o est√°tica) </li><li>  Dificuldade em localizar e remover c√≥digo n√£o utilizado </li></ul><br><h3 id="15-otsutstvuyut-vladelcy-koda">  1.5 Propriet√°rios de c√≥digo ausentes </h3><br><p>  Muitas vezes, as tarefas surgem com uma esfera de responsabilidade incompreens√≠vel - por exemplo, em bibliotecas relacionadas.  E o desenvolvedor original j√° pode se mudar para outra equipe ou at√© sair da empresa.  A √∫nica maneira de se responsabilizar nesse caso √© a arbitrariedade administrativa - levar e nomear uma pessoa.  O que nem sempre √© agrad√°vel tanto para o desenvolvedor quanto para quem o faz. </p><br><h3 id="16-slozhnost-otladki">  1.6 Dificuldade de depura√ß√£o </h3><br><p>  A mem√≥ria est√° fluindo?  Maior consumo de CPU?  Queria criar gr√°ficos de chama?  Me desculpe  Em um mon√≥lito, tantas coisas acontecem ao mesmo tempo que se torna insanamente dif√≠cil localizar um problema.  Por exemplo, para entender qual das 60 tarefas ao iniciar a produ√ß√£o causa um aumento no consumo de recursos (embora isso n√£o seja reproduzido localmente nos ambientes de teste e prepara√ß√£o), √© quase irreal. </p><br><h3 id="17-odin-stek">  1.7 Uma pilha </h3><br><p>  Por um lado, √© bom quando todos os desenvolvedores "falam" o mesmo idioma.  No caso do JS, verifica-se que mesmo os desenvolvedores do Backend com Frontend se entendem.  Mas ... </p><br><ul><li>  N√£o existe uma bala de prata e, para algumas tarefas, √†s vezes voc√™ deseja usar outra coisa.  Mas temos um mon√≥lito e n√£o temos onde ficar com outros desenvolvedores. </li><li>  N√£o podemos simplesmente tomar uma boa equipe com a recomenda√ß√£o, que nos chegou a conselho de amigos - n√£o temos onde colocar. </li><li>  Com o tempo, nos baseamos no fato de que o mercado simplesmente n√£o possui desenvolvedores suficientes na pilha certa. </li></ul><br><h3 id="18-mnogo-komand-s-raznym-predstavleniem-o-schaste">  1.8 Muitas equipes com id√©ias diferentes sobre felicidade </h3><br><p><img src="https://habrastorage.org/webt/1k/bc/k1/1kbck116yjf9-ozmoee08oeacxi.png"></p><br><p>  Se voc√™ tem dois desenvolvedores, j√° tem duas id√©ias diferentes sobre qual √© a melhor estrutura, quais padr√µes devem ser respeitados, usar bibliotecas e assim por diante. <br>  Se voc√™ possui dez equipes, cada uma com v√°rios desenvolvedores, isso √© apenas um desastre. <br>  E h√° apenas duas maneiras de resolv√™-lo - seja "democr√°tico" (todo mundo faz o que quer) ou totalit√°rio (os padr√µes s√£o impostos de cima).  No primeiro caso, qualidade e padroniza√ß√£o sofrem, no segundo - pessoas que n√£o t√™m permiss√£o para realizar sua id√©ia de felicidade. </p><br><h2 id="2-plyusy-monolita">  2. As vantagens do mon√≥lito </h2><br><p>  Obviamente, existem algumas vantagens no mon√≥lito que podem ser diferentes para diferentes pilhas, produtos e equipes.  √â claro que existem muito mais que tr√™s, mas n√£o serei respons√°vel por tudo que for poss√≠vel, apenas por aqueles que foram relevantes para n√≥s. </p><br><h3 id="21-prostota-razvyortyvaniya">  2.1 F√°cil de implantar </h3><br><p>  Quando voc√™ tem um servi√ßo, aumentar e testar √© muito mais f√°cil do que uma d√∫zia de servi√ßos.  √â verdade que esse plus √© relevante apenas no est√°gio inicial - por exemplo, voc√™ pode elevar o ambiente de teste e usar todos os servi√ßos, exceto os desenvolvidos.  Ou de recipientes.  Ou o que mais. </p><br><h3 id="22-net-overheda-na-peredachu-dannyh">  2.2 Sem sobrecarga de transfer√™ncia de dados </h3><br><p>  Uma vantagem bastante duvidosa, se voc√™ n√£o tiver carga alta.  Mas temos exatamente esse caso - portanto, o custo do transporte entre microsservi√ßos √© percept√≠vel para n√≥s.  N√£o importa como voc√™ tente fazer isso rapidamente, armazene e transfira tudo na RAM mais rapidamente do que qualquer outra coisa - isso √© √≥bvio. </p><br><h3 id="22-odna-sborka">  2.2 Um conjunto </h3><br><p>  Se voc√™ precisar retroceder em algum momento da hist√≥ria, √© muito simples faz√™-lo com um mon√≥lito - pegue e retroceda.  No caso de microsservi√ßos, √© necess√°rio selecionar vers√µes compat√≠veis de servi√ßos que foram usadas entre si em um determinado momento, o que nem sempre pode ser simples.  √â verdade que isso tamb√©m √© resolvido com a ajuda da infraestrutura. </p><br><h2 id="3-mnimye-plyusy-monolita">  3. Vantagens imagin√°rias de um mon√≥lito </h2><br><p>  Aqui eu peguei todas as coisas que geralmente s√£o consideradas vantagens, mas do meu ponto de vista elas n√£o s√£o. </p><br><h3 id="31-kod---eto-i-est-dokumentaciya">  3.1 C√≥digo - esta √© a documenta√ß√£o </h3><br><p>  Muitas vezes ouvi essa opini√£o.  Mas geralmente √© seguido por desenvolvedores iniciantes que n√£o viram arquivos em dezenas de milhares de linhas de c√≥digo escritas por pessoas que sa√≠ram anos atr√°s.  Bem, por algum motivo, na maioria das vezes esse item √© adicionado a favor dos apoiadores do mon√≥lito - eles dizem que n√£o precisamos de documenta√ß√£o, n√£o temos transporte ou API - tudo est√° no c√≥digo, √© f√°cil e claro.  N√£o discutirei com esta afirma√ß√£o, apenas digo que n√£o acredito nela. </p><br><h3 id="32-net-raznyh-versiy-bibliotek-servisov-i-api-net-raznyh-repozitoriev">  3.2 N√£o h√° vers√µes diferentes de bibliotecas, servi√ßos e APIs.  N√£o h√° reposit√≥rios diferentes. </h3><br><p>  Sim  Mas n√£o.  Porque, √† segunda vista, voc√™ entende que o servi√ßo n√£o existe no v√°cuo.  E entre um grande n√∫mero de outros c√≥digos e produtos com os quais se integra - a partir de bibliotecas de terceiros, continuando com vers√µes de software para servidor e n√£o terminando com integra√ß√µes externas, uma vers√£o IDE, ferramentas de CI e assim por diante.  E assim que voc√™ entender quantas coisas diferentes de vers√£o seu servi√ßo inclui indiretamente, fica imediatamente claro que esse plus √© apenas demagogia. </p><br><h3 id="33-prosche-monitoring">  3.3 monitoramento mais f√°cil </h3><br><p>  Mais f√°cil.  Porque voc√™ tem aproximadamente um painel, em vez de algumas dezenas.  Mas √© mais complicado, e √†s vezes at√© imposs√≠vel, porque voc√™ n√£o pode decompor seus gr√°ficos em diferentes partes do c√≥digo, e voc√™ s√≥ tem a temperatura m√©dia no hospital.  Em geral, eu j√° disse tudo no par√°grafo sobre a complexidade da depura√ß√£o, apenas esclarecerei que a mesma complexidade se aplica ao monitoramento. </p><br><h3 id="34-prosche-soblyudat-edinye-standarty">  3.4 √â mais f√°cil cumprir padr√µes comuns </h3><br><p>  Sim  Mas, como j√° escrevi no par√°grafo, sobre muitas equipes com a ideia de felicidade - os padr√µes s√£o impostos totalitariamente ou enfraquecidos quase √† aus√™ncia deles. </p><br><h3 id="35-menshe-veroyatnost-dublirovaniya-koda">  3.5 Menos chance de duplica√ß√£o de c√≥digo </h3><br><p>  A opini√£o estranha √© que o c√≥digo n√£o √© duplicado no mon√≥lito.  Mas o conhecia com bastante frequ√™ncia.  Na minha pr√°tica, verifica-se que a duplica√ß√£o de c√≥digo depende unicamente da cultura de desenvolvimento na empresa.  Se for, o c√≥digo geral √© alocado para todos os tipos de bibliotecas, m√≥dulos e microsservi√ßos.  Se n√£o estiver l√°, haver√° uma c√≥pia-pasta vinte vezes no mon√≥lito. </p><br><h2 id="4-plyusy-mikroservisov">  4. Profissionais de microsservi√ßos </h2><br><p>  Agora vou escrever sobre o que conseguimos ap√≥s a migra√ß√£o.  Novamente, essas s√£o conclus√µes reais de uma situa√ß√£o real. </p><br><h3 id="41-mozhno-delat-geterogennuyu-infrastrukturu">  4.1 Voc√™ pode criar uma infraestrutura heterog√™nea </h3><br><p>  Agora, podemos escrever c√≥digo em uma pilha ideal para resolver um problema espec√≠fico.  E √© racional usar bons desenvolvedores que vieram at√© n√≥s.  Por exemplo, aqui est√° uma lista de exemplo de tecnologias que temos atualmente: <br><img src="https://habrastorage.org/webt/mt/oc/nr/mtocnrvjvhfhxxtsjfnjx3z8knc.png"></p><br><h3 id="42-mozhno-delat-mnogo-chastyh-relizov">  4.2 Voc√™ pode fazer muitos lan√ßamentos frequentes </h3><br><p>  Agora podemos fazer v√°rios lan√ßamentos independentes pequenos, e eles s√£o mais simples, r√°pidos e n√£o dolorosos.  No passado, t√≠nhamos apenas um time, mas agora j√° existem 18 anos. Teria havido um intervalo se todos permanecessem no mon√≥lito.  Ou as pessoas respons√°veis ‚Äã‚Äãpor isso ... </p><br><h3 id="43-prosche-delat-nezavisimye-testy">  4.3 Mais f√°cil de realizar testes independentes </h3><br><p>  Reduzimos o tempo para testes de integra√ß√£o, que agora testam apenas o que realmente mudou e, ao mesmo tempo, n√£o temos medo dos efeitos de uma sinergia repentina.  Obviamente, tive que come√ßar a andar pelo rake - por exemplo, aprendendo a criar APIs compat√≠veis com vers√µes anteriores - mas, com o tempo, tudo se acalmou. </p><br><h3 id="44-legche-vnedryat-i-testirovat-novye-fichi">  4.4 Mais f√°cil de implementar e testar novos recursos </h3><br><p>  Agora estamos abertos √† experimenta√ß√£o.  Quaisquer estruturas, pilhas, bibliotecas - voc√™ pode tentar de tudo e, se for bem-sucedido, seguir em frente. </p><br><h3 id="45-mozhno-obnovlyat-chto-ugodno">  4.5 Voc√™ pode atualizar qualquer coisa </h3><br><p>  Voc√™ pode atualizar a vers√£o do mecanismo, bibliotecas, mas qualquer coisa!  Como parte de um pequeno servi√ßo, encontrar e consertar todas as altera√ß√µes de √∫ltima hora √© uma quest√£o de minutos.  E n√£o semanas, como era antes. </p><br><h3 id="46--a-mozhno-ne-obnovlyat">  4.6 E voc√™ n√£o pode atualizar </h3><br><p>  Curiosamente, esse √© um dos recursos mais interessantes dos microsservi√ßos.  Se voc√™ tem um c√≥digo de trabalho est√°vel, basta congel√°-lo e esquec√™-lo.  E voc√™ nunca precisar√° atualiz√°-lo, por exemplo, para executar o c√≥digo do produto em um novo mecanismo.  O produto em si funciona em um novo mecanismo e o microsservi√ßo continua a viver como ele viveu.  As moscas com costeletas podem finalmente ser consumidas separadamente. </p><br><h2 id="5-minusy-mikroservisov">  5 Contras de microsservi√ßos </h2><br><p>  Obviamente, uma mosca na pomada n√£o estava completa e uma solu√ß√£o perfeita para apenas sentar e receber o pagamento n√£o funcionou.  O que encontramos: </p><br><h3 id="51-nuzhna-shina-dlya-obmena-dannymi-i-vnyatnoe-logirovanie">  5.1 Precisa de um barramento para troca de dados e registro limpo. </h3><br><p>  A intera√ß√£o de servi√ßos atrav√©s de HTTP √© um modelo cl√°ssico e, em geral, mesmo funcional, desde que existam camadas de log e balanceamento entre eles.  Mas √© melhor ter um pneu mais distinto.  Al√©m disso, voc√™ deve pensar em como coletar e combinar logs entre si - caso contr√°rio, ter√° apenas mingau em suas m√£os. </p><br><h3 id="52-nuzhno-sledit-za-tem-chto-delayut-razrabotchiki">  5.2 Acompanhe o que os desenvolvedores est√£o fazendo. </h3><br><p>  Em geral, isso sempre deve ser feito, mas em microsservi√ßos, os desenvolvedores obviamente t√™m mais liberdade, o que √†s vezes pode dar origem a coisas das quais Stephen King teria arrepios.  Mesmo que externamente pare√ßa que o servi√ßo esteja funcionando - n√£o esque√ßa que deve haver uma pessoa que monitora o que est√° dentro dele. </p><br><h3 id="53-nuzhna-horoshaya-komanda-devops-chtoby-vsem-etim-upravlyat">  5.3 Voc√™ precisa de uma boa equipe de DevOps para gerenciar tudo. </h3><br><p>  Quase qualquer desenvolvedor pode implantar um mon√≥lito de uma maneira ou de outra e fazer upload de seus lan√ßamentos (por exemplo, via FTP ou SSH, eu vi isso).  Mas com microsservi√ßos, existem todos os tipos de servi√ßos centralizados para coletar logs, m√©tricas, pain√©is, chefs para gerenciar configura√ß√µes, volts, jenkins e outras coisas boas, sem as quais voc√™ geralmente pode viver - mas √© ruim e incompreens√≠vel o porqu√™.  Portanto, para gerenciar microsservi√ßos, voc√™ precisa de uma boa equipe de DevOps. </p><br><h3 id="54-mozhno-popytatsya-slovit-hayp-i-vystrelit-sebe-v-nogu">  5.4 Voc√™ pode tentar pegar um hype e dar um tiro no pr√≥prio p√©. </h3><br><p>  Talvez este seja o principal sinal negativo da arquitetura e seu perigo.  Muitas vezes, as pessoas seguem cegamente as tend√™ncias e come√ßam a introduzir arquitetura e tecnologia sem entend√™-las.  Depois que tudo cai, eles ficam confusos na bagun√ßa resultante e escrevem um artigo no Habr "como passamos de microsservi√ßos para um mon√≥lito", por exemplo.  Em geral, mude apenas se voc√™ souber por que est√° fazendo isso e quais problemas resolver√°.  E quais voc√™ recebe. </p><br><h2 id="6-haki-v-monolite">  6 caqui em mon√≥lito </h2><br><p>  Alguns dos hacks que nos permitiram viver em um mon√≥lito s√£o um pouco melhores e um pouco mais. </p><br><h3 id="61-linting">  6.1 Linting </h3><br><p>  A introdu√ß√£o de um linter em um mon√≥lito n√£o √© uma tarefa t√£o simples como parece √† primeira vista.  Claro, voc√™ pode fazer regras estritas, adicionar uma configura√ß√£o e ... Nada mudar√°, todo mundo simplesmente desliga o linter, porque metade do c√≥digo fica vermelho. </p><br><p>  Para a introdu√ß√£o gradual do linting, escrevemos um complemento simples para o eslint - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">slowlint</a> , que permite fazer uma coisa simples - para conter uma lista de arquivos ignorados temporariamente.  Como resultado: </p><br><ul><li>  Todo o c√≥digo incorreto √© destacado no IDE </li><li>  Novos arquivos s√£o criados de acordo com as regras do linting, caso contr√°rio, o CI n√£o sentir√° falta deles </li><li>  Os idosos gradualmente governam e se afastam das exce√ß√µes </li></ul><br><p>  Ao longo do ano, foi poss√≠vel incorporar metade do c√≥digo do mon√≥lito em um √∫nico estilo, ou seja, quase todos os c√≥digos adicionados ativamente. </p><br><h3 id="62-dorabotki-yunit-testov">  6.2 Melhorias no teste de unidade </h3><br><p>  Uma vez que os testes de unidade foram realizados conosco por tr√™s minutos.  Os desenvolvedores n√£o queriam esperar tanto tempo, ent√£o tudo foi verificado apenas no IC no servidor.  Depois de algum tempo, o desenvolvedor descobriu que os testes ca√≠am, amaldi√ßoavam, abriam um ramo, retornavam ao c√≥digo ... Em geral, ele sofreu.  O que fizemos com isso: </p><br><ol><li>  Para iniciantes, come√ßamos a executar testes multithread.  O Yandex tem uma variante do mocha multiencadeado, mas conosco n√£o decolou, ent√£o eles mesmos escreveram um inv√≥lucro simples.  Os testes come√ßaram a ser realizados uma vez e meia mais r√°pido. </li><li>  Em seguida, passamos de 0,12 n√≥s para o 8¬∫ (sim, o pr√≥prio processo atrai para um relat√≥rio separado).  Por mais estranho que possa parecer, n√£o deu um ganho fundamental em produtividade na produ√ß√£o, mas os testes come√ßaram a ser realizados 20% mais r√°pido. </li><li>  E ent√£o nos sentamos para depurar os testes e otimiz√°-los individualmente.  O que deu o maior aumento de velocidade. </li></ol><br><p>  Em geral, no momento, os testes de unidade s√£o executados no gancho de prepara√ß√£o e s√£o executados em 10 segundos, o que √© bastante confort√°vel e permite que voc√™ os execute no trabalho. </p><br><h3 id="63--oblegchenie-vesa-artefakta">  6.3 Diminuindo o peso do artefato </h3><br><p>  O artefato monol√≠tico acabou ocupando 400 megabytes.  Considerando o fato de que ele √© criado para cada confirma√ß√£o, o volume total acabou sendo bastante grande.  O m√≥dulo de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">diarr√©ia</a> , um garfo do m√≥dulo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">modclean</a> , nos ajudou com isso.  Removemos os testes de unidade do artefato e limpamos v√°rios tipos de lixo, como arquivos leia-me, testes dentro de pacotes e assim por diante.  O ganho foi de cerca de 30% do peso! </p><br><h3 id="64--keshirovanie-zavisimostey">  6.4 Cache de Depend√™ncia </h3><br><p>  Antigamente, a instala√ß√£o de depend√™ncias usando o npm levava tanto tempo que voc√™ n√£o s√≥ podia tomar caf√©, mas tamb√©m, por exemplo, assar pizza.  Portanto, no in√≠cio, usamos o m√≥dulo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">npm-cache</a> , que foi bifurcado e um pouco terminado.  Ele permitiu armazenar depend√™ncias em uma unidade de rede compartilhada, da qual todas as outras compila√ß√µes a usariam. </p><br><p>  Depois pensamos na reprodutibilidade das montagens.  Quando voc√™ tem um mon√≥lito, a mudan√ßa de depend√™ncias transitivas √© o flagelo de Deus.  Dado o fato de estarmos muito atrasados ‚Äã‚Äãna vers√£o do mecanismo na √©poca, a altera√ß√£o de alguma depend√™ncia do quinto n√≠vel quebrou facilmente toda a nossa montagem.  Ent√£o come√ßamos a usar o npm-shrinkwrap.  J√° era mais f√°cil para ele, embora mesclar suas mudan√ßas fosse um prazer para os fortes de esp√≠rito. </p><br><p> E ent√£o o package-lock e o excelente comando <code>npm ci</code> finalmente apareceram - que rodavam a uma velocidade ligeiramente menor que a instala√ß√£o de depend√™ncias do cache de arquivos.  Portanto, come√ßamos a us√°-lo apenas e paramos de armazenar assemblies de depend√™ncia.  Nesse dia, trouxe para o trabalho v√°rias caixas de donuts. </p><br><h3 id="65--raspredelenie-ocheryodnosti-relizov">  6.5 Distribui√ß√£o da ordem dos releases. </h3><br><p>  E isso √© mais um truque administrativo, n√£o t√©cnico.  Inicialmente, eu era contra ele, mas o tempo mostrou que o segundo especialista t√©cnico estava certo e geralmente bem-feito.  Quando as vers√µes foram distribu√≠das entre v√°rias equipes, ficou claro onde exatamente os erros apareciam e, mais importante, cada equipe sentia sua responsabilidade pela velocidade e tentava resolver problemas e implementar o mais r√°pido poss√≠vel. </p><br><h3 id="66-udalenie-myortvogo-koda">  6.6 Excluindo c√≥digo morto </h3><br><p>  Em um mon√≥lito, √© muito assustador excluir o c√≥digo - voc√™ nunca sabe onde pode ficar preso nele.  Portanto, na maioria das vezes, resta apenas ficar de lado.  Ao longo dos anos.  E mesmo o c√≥digo morto precisa ser suportado, sem mencionar a confus√£o que ele introduz.  Portanto, com o tempo, come√ßamos a usar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">a an√°lise de requisitos</a> para uma pesquisa superficial de c√≥digo morto e testes de integra√ß√£o, al√©m de iniciar no modo de verifica√ß√£o de cobertura para uma pesquisa mais profunda. </p><br><h2 id="7-raspil-monolita">  7 Corte de mon√≥lito </h2><br><p>  Por alguma raz√£o, muitas pessoas pensam que, para mudar para microsservi√ßos, voc√™ precisa abandonar seu mon√≥lito, escrever v√°rios microsservi√ßos perto do zero, execut√°-lo de uma s√≥ vez - e haver√° felicidade.  Mas esse modelo ... Hmm ... √â repleto de fato de voc√™ n√£o fazer nada, e apenas gastar muito tempo e dinheiro escrevendo c√≥digos que precisa jogar fora. </p><br><p>  Proponho outra op√ß√£o, que me parece mais funcional e que foi implementada conosco: </p><br><ol><li>  Come√ßamos a escrever novos servi√ßos em microsservi√ßos.  Executamos a tecnologia, saltamos para o rake, entendemos se queremos faz√™-lo. </li><li>  Extra√≠mos o c√≥digo em m√≥dulos, bibliotecas ou o que for usado l√°. </li><li>  Distinguimos servi√ßos de um mon√≥lito. </li><li>  Distinguimos microsservi√ßos de servi√ßos.  Sem pressa e um de cada vez. </li></ol><br><h2 id="8-i-naposledok">  8 e finalmente </h2><br><p><img src="https://habrastorage.org/webt/z8/tl/cv/z8tlcv6aibivr83m9q-fxzhusay.png" alt="foto tirada em https://fvl1-01.livejournal.com/"></p><br><p>  No final, decidi deixar a coisa mais importante. </p><br><p>  Lembre-se: </p><br><ul><li>  Voc√™ n√£o √© google </li><li>  Voc√™ n√£o √© microsoft </li><li>  Voc√™ n√£o √© facebook </li><li>  Voc√™ n√£o √© Yandex </li><li>  Voc√™ n√£o √© netflix </li><li>  Voc√™ n√£o √© OneTwoTrip </li></ul><br><p>  Se algo funcionar em outras empresas, n√£o √© absolutamente um fato que o beneficie.  Se voc√™ tentar copiar cegamente a experi√™ncia de outras empresas com as palavras "funciona para elas", isso provavelmente terminar√° mal.  Toda empresa, todo produto e toda equipe s√£o √∫nicos.  O que funciona para alguns n√£o funciona para outros.  N√£o gosto de dizer coisas √≥bvias, mas muitas pessoas come√ßam a criar um culto √† carga em torno de outras empresas, copiando cegamente abordagens e enterrando-se sob as falsas decora√ß√µes da √°rvore de Natal.  N√£o fa√ßa isso.  Experimente, experimente, desenvolva as solu√ß√µes ideais para voc√™.  E s√≥ ent√£o tudo vai dar certo. </p><br><h2 id="poleznye-ssylki">  Links √∫teis: </h2><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Meu relat√≥rio</a> em formato de v√≠deo </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Lista de reprodu√ß√£o completa</a> de mitap by Node.JS </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt459206/">https://habr.com/ru/post/pt459206/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt459188/index.html">Lan√ßamento do Debian 10 Buster e Linux 5.2</a></li>
<li><a href="../pt459194/index.html">Como fizemos amigos do SCSS com vari√°veis ‚Äã‚ÄãCSS usando o tema do kit de interface do usu√°rio</a></li>
<li><a href="../pt459196/index.html">Dos mon√≥litos √†s equipes modulares</a></li>
<li><a href="../pt459198/index.html">An√°lise de desempenho de consulta no ClickHouse. Relat√≥rio Yandex</a></li>
<li><a href="../pt459204/index.html">10 ++ maneiras de trabalhar com registros de hardware em C ++ (por exemplo, IAR e Cortex M)</a></li>
<li><a href="../pt459208/index.html">Corrida com pr√≥teses: simula√ß√£o Nekstgen do movimento humano usando m√∫sculos, ossos e uma rede neural</a></li>
<li><a href="../pt459212/index.html">Implementa√ß√£o de propriedade em C ++</a></li>
<li><a href="../pt459214/index.html">Toler√¢ncia a falhas no armazenamento Qsan</a></li>
<li><a href="../pt459216/index.html">Estrutura de dados em √°rvore B</a></li>
<li><a href="../pt459220/index.html">Teste de integra√ß√£o para verificar vazamentos de mem√≥ria</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>