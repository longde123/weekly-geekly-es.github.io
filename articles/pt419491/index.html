<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëÇüèª üöë üêà Como o STP funciona üíÉ üë∫ ü§≥üèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Motivo para criar STP 
 O motivo da cria√ß√£o do protocolo STP foi o aparecimento de loops nos comutadores. O que √© um loop? A defini√ß√£o do loop √© a seg...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como o STP funciona</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/419491/"><h4>  Motivo para criar STP </h4><br>  O motivo da cria√ß√£o do protocolo STP foi o aparecimento de loops nos comutadores.  O que √© um loop?  A defini√ß√£o do loop √© a seguinte: <br><br>  <b>Bridging loop (loop de comuta√ß√£o)</b> - um estado da rede em que h√° uma transfer√™ncia intermin√°vel de quadros entre os comutadores conectados ao mesmo segmento de rede. <br><br>  A partir da defini√ß√£o, fica claro que a apar√™ncia de um loop cria grandes problemas - leva √† sobrecarga de switches e √† inoperabilidade desse segmento de rede.  Como surge um loop?  A figura abaixo mostra a topologia na qual um loop ocorrer√° na aus√™ncia de quaisquer mecanismos de prote√ß√£o: <br><br><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img src="https://habrastorage.org/getpro/habr/post_images/126/e5d/0de/126e5d0dea4a92a1d6ec0c4dd2c7c897.jpg" alt="Minha imagem"></a> <a name="habracut"></a><br><br>  A apar√™ncia de um loop nas seguintes condi√ß√µes: <br><br>  <b>1. Um dos hosts envia um quadro de transmiss√£o:</b> <br><br><ol><li>  Por exemplo, o VPC5 envia um pacote com um endere√ßo de destino de Broadcast. </li><li>  Depois de aceitar esse pacote, o Switch1 deve envi√°-lo por todas as portas, exceto a porta da qual esse pacote veio.  O pacote passar√° pelas portas Gi0 / 0, Gi1 / 0. </li><li>  Os comutadores Switch2, Switch3, que aceitaram este pacote, tamb√©m dever√£o enviar o pacote.  Assim, o Switch2, que recebeu o pacote do Switch1, o enviar√° para o Switch3 e o Switch3 o enviar√° para o Switch2. </li><li>  Em seguida, o Switch2 recebeu um pacote do Switch3, envie-o para o Switch1 e o Switch3 recebeu um pacote do Switch2, envie-o tamb√©m para o Switch1.  Assim, chegamos √† etapa 1) e ela continuar√° indefinidamente.  Al√©m disso, tudo √© agravado pelo fato de que, na etapa 4), o Switch1 j√° ter√° duas inst√¢ncias de quadro, uma vez que as receber√° do Switch2 e do Switch3. </li></ol><br>  Os passos 1) - 4) ser√£o repetidos indefinidamente e, nos comutadores, isso acontece em uma fra√ß√£o de segundo.  Al√©m disso, a forma√ß√£o de um loop leva ao fato de que a tabela de endere√ßos de papoula nos comutadores muda constantemente e o endere√ßo de papoula do remetente do VPC5 ser√° constantemente atribu√≠do √† interface Gi0 / 0, Gi1 / 0 ou Gi0 / 2 (se nesse momento o VPC5 enviar outros pacotes).  Esse ciclo levar√° √† opera√ß√£o incorreta da rede e de todos os comutadores.  E enviar pacotes de transmiss√£o para hosts √© uma coisa comum, como um exemplo, o protocolo ARP. <br><br>  <b>2. Um loop tamb√©m pode se formar sem enviar um quadro de Broadcast.</b> <br><br><ol><li>  Por exemplo, o VPC5 envia um quadro com um endere√ßo mac de destino unicast. </li><li>  √â poss√≠vel que o endere√ßo mac de destino n√£o esteja na tabela de endere√ßos mac do switch.  Nesse caso, o switch encaminhar√° o pacote por todas as portas, exceto a porta da qual recebeu o quadro.  E temos a mesma situa√ß√£o do quadro de transmiss√£o. </li><li>  Abaixo, veremos o protocolo STP nos comutadores Cisco.  Eles usam o STP separadamente para cada vlan, o protocolo PVST +.  Como temos apenas uma vlan, o significado disso n√£o muda. </li></ol><br><h4>  No√ß√µes b√°sicas de STP </h4><br>  O princ√≠pio de opera√ß√£o deste protocolo √© baseado no fato de que todos os canais redundantes entre os comutadores s√£o logicamente bloqueados e o tr√°fego n√£o √© transmitido atrav√©s deles.  Para construir uma topologia sem canais redundantes, uma √°rvore √© constru√≠da (gr√°fico matem√°tico).  Para construir uma √°rvore, √© necess√°rio primeiro determinar a raiz da √°rvore a partir da qual o gr√°fico ser√° constru√≠do.  Portanto, a primeira etapa do protocolo STP √© determinar o comutador raiz (comutador raiz).  Para determinar o comutador raiz, os comutadores trocam mensagens BPDU.  Em geral, o protocolo STP usa dois tipos de mensagens: BPDU - cont√©m informa√ß√µes sobre os comutadores e o TCN - notifica uma altera√ß√£o na topologia.  Vamos considerar o BPDU em mais detalhes.  Falaremos mais sobre o TCN abaixo.  Quando voc√™ habilita o STP nos comutadores, os comutadores come√ßam a enviar mensagens BPDU.  Essas mensagens cont√™m as seguintes informa√ß√µes: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8ab/b03/95d/8abb0395d6af59aa1d0d89717a430640.jpg" alt="Minha imagem"><br><br>  O quadro BPDU possui os seguintes campos: <br><br><ul><li>  Identificador da vers√£o do protocolo STA (2 bytes).  Os comutadores devem suportar a mesma vers√£o do protocolo STA </li><li>  Vers√£o do protocolo STP (1 byte) </li><li>  Tipo BPDU (1 byte).  Existem 2 tipos de BPDUs - notifica√ß√£o de configura√ß√£o e reconfigura√ß√£o </li><li>  Sinalizadores (1 byte) </li><li>  Identificador do comutador raiz (8 bytes) </li><li>  O custo da rota para o comutador raiz (custo do caminho raiz) </li><li>  ID do remetente (ID da ponte) (8 bytes) </li><li>  O identificador da porta da qual este pacote foi enviado (ID da porta) (2 bytes) </li><li>  Dura√ß√£o da mensagem (2 bytes).  Medido em unidades de 0,5 s, usado para detectar mensagens obsoletas </li><li>  Dura√ß√£o m√°xima da mensagem (2 bytes).  Se o quadro BPDU tiver uma vida √∫til superior ao m√°ximo, o quadro ser√° ignorado pelos comutadores </li><li>  Ol√° intervalo (2 bytes), o intervalo no qual os pacotes BPDU s√£o enviados </li><li>  Atraso de altera√ß√£o de estado (2 bytes).  Tempo ativo m√≠nimo da chave </li></ul><br>  Os principais campos que requerem aten√ß√£o especial s√£o os seguintes: <br><br><ul><li>  ID do remetente (ID da ponte) </li><li>  ID da ponte raiz </li><li>  O identificador da porta da qual este pacote foi enviado (ID da porta) </li><li>  O custo da rota para o comutador raiz (custo do caminho raiz) </li></ul><br>  Para determinar o comutador raiz, o identificador do comutador √© usado - ID da ponte.  O ID da ponte √© um n√∫mero de 8 bytes que consiste na prioridade da ponte (prioridade, 0 a 65535, padr√£o 32768) e no endere√ßo MAC do dispositivo.  O comutador raiz seleciona o comutador com a prioridade mais baixa, se as prioridades forem iguais, os endere√ßos MAC ser√£o comparados (em termos de caracteres, o menor vence). <br><br>  Aqui est√° a sa√≠da das informa√ß√µes de ID da ponte do Switch1 da primeira imagem.  Prioridade - 32769 (padr√£o 32768 + ID da Vlan), endere√ßos MAC - Endere√ßo 5000.0001.0000: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f0e/0a9/a20/f0e0a9a20fcaf20601fb2e5ffb02564e.jpg" alt="Minha imagem"><br><br>  Imagine a imagem, os comutadores acabaram de ligar e agora est√£o come√ßando a criar uma topologia sem loop.  Assim que os switches s√£o inicializados, eles come√ßam a enviar BPDUs, onde informam a todos que s√£o a raiz da √°rvore.  Nos BPDU, como o ID da ponte raiz, os comutadores indicam seu pr√≥prio ID da ponte.  Por exemplo, o Switch1 envia BPDUs para o Switch3 e o Switch3 envia para o Switch1.  BPDU do Switch1 para o Switch3: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/dc9/6ef/4e3/dc96ef4e309f4c565aa7fc68eda75137.jpg" alt="Minha imagem"><br><br>  BPDU do Switch3 para o Switch1: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/809/4de/aee/8094deaeef6449cdf3dc280000fc6e78.jpg" alt="Minha imagem"><br><br>  Como voc√™ pode ver no Identificador Raiz, os dois comutadores dizem um ao outro que √© ele quem √© o comutador Raiz. <br><br><h4>  Escolhendo uma op√ß√£o raiz </h4><br>  At√© que a topologia STP seja constru√≠da, o tr√°fego normal n√£o √© transmitido devido a estados de porta especiais, que ser√£o discutidos abaixo.  Portanto, o Switch3 obt√©m o BPDU do Switch1 e examina essa mensagem.  O Switch3 olha no campo ID da ponte raiz e v√™ que um ID da ponte raiz diferente √© indicado l√° do que na mensagem enviada pelo pr√≥prio Switch3.  Ele compara o ID da ponte raiz nesta mensagem com o seu ID da ponte raiz e v√™ que, embora a Prioridade seja a mesma, o endere√ßo MAC desse comutador (Switch1) √© melhor (menor) do que tem.  Portanto, o Switch3 recebe o ID da ponte raiz do Switch1 e para de enviar seus BPDUs, mas apenas escuta os BPDUs do Switch1.  A porta na qual o melhor BPDU foi recebido se torna a Porta Raiz.  O Switch1 tamb√©m recebeu um BPDU do Switch3, faz uma compara√ß√£o, mas, neste caso, o comportamento do Switch1 n√£o muda, pois o BPDU recebido cont√©m um ID de ponte raiz pior que o Switch1.  Assim, entre o Switch1 e o Switch3, um switch raiz foi definido.  De maneira semelhante, o switch raiz √© selecionado entre o Switch1 e o Switch2.  As portas Gi0 / 0 no Switch2 e Switch3 tornam-se porta raiz - a porta que leva ao switch raiz.  Por essa porta, o Switch2 e o Switch3 aceitam BPDUs do Root Bridge.  Agora vamos descobrir o que acontecer√° com o canal entre o Switch2 e o Switch3. <br><br><h4>  Bloqueando canais redundantes </h4><br>  Como vemos na topologia, o canal entre o Switch2 e o Switch3 deve ser bloqueado para impedir a forma√ß√£o de loops.  Como o STP lida com isso? <br><br>  Depois que o Root Bridge √© selecionado, o Switch2 e o Switch3 param de enviar BPDUs por portas raiz, mas eles recebem BPDUs recebidos do Root Bridge por todas as outras portas ativas, alterando apenas os seguintes campos nos dados BPDU: <br><br><ul><li>  ID do remetente (ID da ponte) - substitu√≠do pelo seu ID. </li><li>  O identificador da porta da qual este pacote foi enviado (ID da porta) - muda para o identificador da porta da qual o BPDU ser√° enviado. </li><li>  O custo da rota para o switch raiz (custo do caminho raiz) - o custo da rota √© calculado em rela√ß√£o ao pr√≥prio switch. </li></ul><br>  Assim, o Switch2 recebe o seguinte BPDU do Switch3: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0cb/1cb/bdf/0cb1cbbdfae70fb3ccf78a2ef590e847.jpg" alt="Minha imagem"><br>  E o Switch3 do Switch2 recebe um BPDU: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/91e/cc4/3a4/91ecc43a4ba7a061e38552d59fa26075.jpg" alt="Minha imagem"><br><br>  Ap√≥s a troca dessas BPDUs, o Switch2 e o Switch3 percebem que a topologia √© redundante.  Por que os comutadores entendem que a topologia √© redundante?  O Switch2 e o Switch3 relatam a mesma ponte raiz em seus BPDUs.  Isso significa que existem duas maneiras de fazer o Root Bridge, com rela√ß√£o ao Switch3, atrav√©s do Switch1 e do Switch2, e essa √© a pr√≥pria redund√¢ncia em que estamos lutando.  Existem tamb√©m duas maneiras para o Switch2 - atrav√©s do Switch1 e Switch3.  Para se livrar dessa redund√¢ncia <br>  voc√™ deve bloquear o canal entre o Switch3 e o Switch2.  Como est√° indo isso? <br><br>  A escolha em qual comutador bloquear a porta √© a seguinte: <br><br><ul><li>  Menor custo do caminho raiz. </li><li>  ID da ponte menor. </li><li>  ID de porta menor. </li></ul><br>  Nesse esquema, o custo do caminho raiz desempenha um papel mais importante que o ID da ponte.  Costumava pensar que essa op√ß√£o √© semelhante √† escolha do comutador Raiz e fiquei surpreso que, por exemplo, nessa topologia, a porta no comutador com a pior prioridade n√£o seja bloqueada: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a36/58f/9fc/a3658f9fca69d52cadf3b6d632e9d4c3.jpg" alt="Minha imagem"><br><br>  Aqui, como se viu, a porta Gi 0/1 no comutador Sw2 est√° bloqueada.  Nesta vota√ß√£o, o custo do caminho raiz se torna decisivo.  Vamos voltar √† nossa topologia.  Como o caminho para o Root Bridge √© o mesmo, o Switch2 vence nessa op√ß√£o, pois sua prioridade √© igual, os IDs do Bridge s√£o comparados.  O Switch2 possui 50: 00: 00: 02: 00: 00, o Switch3 possui 50: 00: 00: 03: 00: 00.  O Switch2 tem um endere√ßo MAC melhor (menos).  Depois que a escolha √© feita, o Switch3 para de encaminhar quaisquer pacotes por essa porta - Gi1 / 0, incluindo BPDU, mas apenas escuta o BPDU do Switch2.  Esse estado da porta no STP √© chamado de Bloqueio (BLK).  A porta Gi1 / 0 no Switch2 est√° funcionando normalmente e encaminha v√°rios pacotes, se necess√°rio, mas o Switch3 os descarta imediatamente, ouvindo apenas as BPDU.  Assim, neste exemplo, constru√≠mos uma topologia sem canais redundantes.  O √∫nico canal redundante entre o Switch2 e o Switch3 foi bloqueado comutando a porta Gi1 / 0 no Switch3 para um estado de bloqueio especial - BLK.  Agora examinaremos mais detalhadamente os mecanismos do STP. <br><br><h4>  Estados da porta </h4><br>  Dissemos acima que, por exemplo, a porta Gi1 / 0 no Switch3 entra em um estado de bloqueio especial - Blocking.  Os seguintes estados da porta existem no STP: <br><br>  <b>Bloqueio</b> - bloqueio.  Nesse estado, nenhum quadro √© transmitido pela porta.  Usado para evitar redund√¢ncia de topologia. <br><br>  <b>Ouvindo</b> - ouvindo.  Como dissemos acima, antes que o comutador raiz ainda seja selecionado, as portas est√£o em um estado especial em que apenas as BPDUs s√£o transmitidas, os quadros de dados n√£o s√£o transmitidos e n√£o s√£o aceitos neste caso.  O estado de escuta n√£o passa para o pr√≥ximo, mesmo que a ponte raiz esteja definida.  Esse estado da porta dura o timer de atraso de encaminhamento, que, por padr√£o, √© 15. Por que sempre tenho que esperar 15 segundos?  Isso ocorre devido ao cuidado com o protocolo STP, para que a Root Bridge incorreta n√£o seja selecionada acidentalmente.  Ap√≥s esse per√≠odo, a porta entra no pr√≥ximo estado - Aprendizado. <br><br>  <b>Aprendizagem</b> - treinamento.  Nesse estado, a porta escuta e envia BPDUs, mas n√£o envia informa√ß√µes com dados.  A diferen√ßa entre esse estado e a Escuta √© que os quadros com os dados que chegam √† porta s√£o estudados e as informa√ß√µes do endere√ßo MAC s√£o inseridas na tabela de endere√ßos MAC do switch.  A transi√ß√£o para o pr√≥ximo estado tamb√©m leva um temporizador de atraso de avan√ßo. <br><br>  <b>Encaminhamento</b> - Encaminhamento.  Este √© o estado normal da porta para onde as BPDUs e os quadros com dados normais s√£o enviados.  Assim, se passarmos pelo esquema quando os switches forem inicializados, obteremos o seguinte esquema: <br><br><ol><li>  O switch coloca todas as suas portas conectadas no estado de escuta e come√ßa a enviar BPDUs onde se declara o switch raiz.  Durante esse per√≠odo, o comutador permanece raiz se n√£o receber o melhor BPDU ou seleciona o comutador raiz.  Dura 15 segundos. </li><li>  Depois que entra no estado de aprendizado e aprende os endere√ßos MAC.  15 segundos </li><li>  Determina quais portas definir como Encaminhamento e quais Bloquear. </li></ol><br><h4>  Fun√ß√µes de porta </h4><br>  Al√©m dos estados das portas, o STP tamb√©m precisa definir √†s portas suas fun√ß√µes.  Isso √© feito para que em qual porta seja esperado o BPDU do comutador raiz e atrav√©s de quais portas transmitir c√≥pias do BPDU recebidas do comutador raiz.  As fun√ß√µes de porta s√£o as seguintes: <br><br>  <b>Porta raiz</b> - a porta raiz do comutador.  Ao escolher um switch raiz, a porta raiz tamb√©m √© determinada.  Essa √© a porta atrav√©s da qual o switch raiz est√° conectado.  Por exemplo, em nossa topologia, as portas Gi0 / 0 no Switch2 e Switch3 s√£o as portas raiz.  Por meio dessas portas, o Switch2 e o Switch3 n√£o enviam BPDUs, mas apenas os ouvem no Root Bridge.  Surge a pergunta - como a porta raiz √© selecionada?  Por que a porta Gi1 / 0 n√£o est√° selecionada?  Afinal, voc√™ tamb√©m pode se comunicar com o switch atrav√©s dele?  Para determinar a porta raiz no STP, √© usada uma m√©trica que indica o Custo do caminho raiz (o custo da rota para o comutador raiz) no campo BPDU.  Esse custo √© determinado pela velocidade do canal. <br><br>  O Switch1 em seu BPDU no campo Root Path Cost define 0, pois ele pr√≥prio √© o Root Bridge.  Mas quando o Switch2, quando envia o BPDU para o Switch3, ele altera esse campo.  Ele define o custo do caminho raiz igual ao custo do canal entre ele e o Switch1.  Na imagem BPDU do Switch2 e do Switch3, voc√™ pode ver que, neste campo, o custo do caminho raiz √© 4, j√° que o canal entre o Switch1 e o Switch2 √© de 1 Gbps.  Se o n√∫mero de comutadores for maior, cada pr√≥ximo comutador adicionar√° o custo do caminho raiz.  Tabela de custo do caminho raiz. <br><br>  <b>Porta designada</b> - a porta atribu√≠da no segmento.  Para cada segmento de rede, deve haver uma porta respons√°vel por conectar esse segmento √† rede.  Relativamente falando, um segmento de rede pode significar um cabo que conecta esse segmento.  Por exemplo, as portas Gi0 / 2 no Switch1, Switch3 conectam segmentos de rede individuais aos quais apenas esse cabo leva.  Al√©m disso, por exemplo, as portas na ponte raiz n√£o podem ser bloqueadas e todas s√£o portas designadas no segmento.  Ap√≥s esta explica√ß√£o, voc√™ pode fornecer defini√ß√µes mais rigorosas para as portas atribu√≠das: <br>  Porta Designada - Uma porta de ponte n√£o raiz entre segmentos de rede que recebe tr√°fego do segmento correspondente.  Cada segmento de rede pode ter apenas uma porta atribu√≠da.  O switch raiz possui todas as portas atribu√≠das. <br><br>  Tamb√©m √© importante observar que a porta Gi1 / 0 no Switch2 tamb√©m √© atribu√≠da, apesar de esse canal de comunica√ß√£o estar bloqueado no Switch3.  Relativamente falando, o Switch2 n√£o tem informa√ß√µes de que a porta est√° bloqueada na outra extremidade. <br><br>  <b>Porta n√£o designada</b> - Uma porta de segmento n√£o atribu√≠da.  Porta n√£o designada - Uma porta que n√£o √© uma raiz ou uma porta designada.  √â proibida a transmiss√£o de quadros de dados atrav√©s dessa porta.  No nosso exemplo, a porta Gi1 / 0 n√£o est√° atribu√≠da. <br><br>  <b>Porta desativada</b> - uma porta que est√° no estado desligado. <br><br><h4>  Temporizadores e converg√™ncia STP </h4><br>  Depois que o STP concluiu a constru√ß√£o de uma topologia sem loop, a pergunta permanece: como detectar altera√ß√µes na rede e como responder a elas?  As mensagens BPDU usadas pelo STP s√£o enviadas pelo Root Bridge a cada 2 segundos, por padr√£o.  Esse timer √© chamado de Hello Timer.  O restante dos comutadores, tendo recebido essa mensagem por meio da porta raiz, encaminha-a ainda mais por todas as portas atribu√≠das.  J√° foi dito com mais detalhes que mudan√ßas acontecem aos BPDUs ao encaminhar seus comutadores.  Se durante o tempo definido pelo cron√¥metro Max Age (por padr√£o - 20 segundos), o switch n√£o recebeu nenhuma BPDU do switch raiz, esse evento ser√° tratado como uma perda de comunica√ß√£o com o Root Bridge.  Para descrever mais corretamente a converg√™ncia do protocolo, √© necess√°rio alterar nossa topologia e colocar hubs entre os comutadores.  Adicionamos hubs para que, quando um dos comutadores falhe ou o link falhe, os outros comutadores n√£o determinem isso pela queda do link, mas usem temporizadores: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ea3/0e7/105/ea30e7105f926c505b0a46f1e2adf758.jpg" alt="imagem"><br><br>  Antes de come√ßar, tamb√©m √© importante informar mais sobre outro tipo de mensagem STP - TCN.  O TCN √© enviado pelos comutadores em caso de altera√ß√£o da topologia - assim que a topologia √© alterada em qualquer comutador, por exemplo, o estado da interface √© alterado.  O TCN √© enviado pelo switch apenas atrav√©s da porta raiz.  Assim que o switch raiz recebe o TCN, ele altera imediatamente o par√¢metro para armazenar endere√ßos MAC na tabela de 300 segundos para 15 (para o qual ser√° discutido abaixo) e no pr√≥ximo BPDU, o Root Switch coloca a bandeira - TCA (Topology Change Acknledgement), que enviado ao comutador que enviou o TCN para notificar que o TCN foi recebido.  Assim que o TCN alcan√ßa a ponte raiz, envia um BPDU especial que cont√©m o sinalizador TCN em todas as outras interfaces para outros comutadores.  A imagem mostra a estrutura do TCN: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/871/0e9/123/8710e9123047de570b5fbf6eb8127ca9.jpg" alt="imagem"><br><br>  O TCN foi inclu√≠do no STP para que os comutadores n√£o raiz pudessem notificar sobre uma altera√ß√£o na rede.  Eles n√£o podem fazer isso com BPDUs regulares, pois os switches n√£o raiz n√£o enviam BPDUs.  Como voc√™ pode ver, a estrutura do TCN n√£o cont√©m nenhuma informa√ß√£o sobre o que exatamente e onde mudou, mas simplesmente relata que em algum lugar algo mudou.  Agora vamos para a quest√£o da converg√™ncia STP. <br><br>  Vamos ver o que acontece se desativarmos a interface Gi0 / 1 no Switch1 e vermos com quais mecanismos a √°rvore STP √© reconstru√≠da.  O Switch2 deixar√° de receber BPDUs do Switch1 e n√£o receber√° BPDUs do Switch3, pois essa porta est√° bloqueada no Switch3.  O Switch2 levar√° 20 segundos (Max Age Timer) para entender a perda de conex√£o com o Root Bridge.  At√© esse momento, Gi0 / 0 no Switch2 estar√° no estado de encaminhamento com a fun√ß√£o de porta raiz.  Assim que o Max Age Timer expirar e o Switch2 entender a perda de comunica√ß√£o, ele reconstruir√° a √°rvore STP e, como √© t√≠pico para o STP, come√ßar√° a se considerar Ponte da Raiz.  Ele enviar√° um novo BPDU, onde se indicar√° como um Root Bridge atrav√©s de todas as portas ativas, incluindo o Switch3.  Mas o cron√¥metro Max Age que expirou no Switch2 tamb√©m expirou no Switch3 para a interface Gi1 / 0.  Essa porta n√£o recebe um BPDU por 20 segundos e entra no estado LISTENING e envia um BPDU indicando Root Bridge - Switch1.  Assim que o Switch2 aceitar esse BPDU, ele deixar√° de se considerar uma ponte raiz e selecionar√° Gi1 / 0 como a porta raiz.  Nesse ponto, o Switch2 tamb√©m enviar√° TCN via Gi1 / 0, pois esta √© a nova porta raiz.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Isso levar√° ao fato de que o tempo de armazenamento dos endere√ßos MAC nos comutadores ser√° reduzido de 300 segundos para 15. Mas isso n√£o restaurar√° completamente a rede; voc√™ deve aguardar at√© que a porta Gi1 / 0 no Switch3 passe a ouvir e depois a aprender. Isso levar√° um tempo igual a dois per√≠odos do timer de atraso de avan√ßo - 15 + 15 = 30 segundos. O que obtemos √© que, quando a conex√£o √© perdida, o Switch2 espera que o cron√¥metro Max Age = 20 segundos expire, seleciona novamente o Root Bridge por outra interface e aguarda mais 30 segundos at√© que a porta bloqueada anteriormente entre no estado de encaminhamento. No total, conclu√≠mos que a conex√£o entre VPC5 e VPC6 ser√° interrompida por 50 segundos. Como mencionado por v√°rias frases acima, ao alterar a porta raiz de Gi0 / 0 para Gi1 / 0 no Switch2, o TCN foi enviado. Se isso n√£o aconteceu, todos os endere√ßos MAC aprendidos atrav√©s da porta Gi 0/0,permaneceria anexado a Gi0 / 0. Por exemplo, o endere√ßo MAC de VPC5 e VPC7, apesar do STP concluir a converg√™ncia em 50 segundos, a conex√£o entre VPC6 e VPC5, VPC7 n√£o seria restaurada, pois todos os pacotes destinados a VPC5 e VPC7 foram enviados por Gi0 / 0. Seria necess√°rio esperar n√£o 50 segundos, mas 300 segundos at√© que a tabela de endere√ßos MAC seja reconstru√≠da. Usando o TCN, o tempo de armazenamento mudou de 300 segundos para 15 e, enquanto a interface Gi1 / 0 no Switch3 passava no status de Escuta, os dados de aprendizado e endere√ßo MAC s√£o atualizados.o tempo de armazenamento mudou de 300 segundos para 15 e, enquanto a interface Gi1 / 0 no Switch3 passou nos estados de escuta, os dados de aprendizado e endere√ßo MAC ser√£o atualizados.o tempo de armazenamento mudou de 300 segundos para 15 e, enquanto a interface Gi1 / 0 no Switch3 passou nos estados de escuta, os dados de aprendizado e endere√ßo MAC ser√£o atualizados.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tamb√©m √© interessante a pergunta: o que acontece se reativarmos a interface Gi0 / 1 no Switch1? </font><font style="vertical-align: inherit;">Quando a interface Gi0 / 1 √© ativada, ela conv√©m ao estado de Escuta e come√ßa a enviar BPDUs. </font><font style="vertical-align: inherit;">Assim que o Switch2 recebe um BPDU na porta Gi0 / 0, ele imediatamente seleciona novamente sua porta raiz, pois aqui o custo ser√° o menor e come√ßar√° a enviar tr√°fego pela interface Gi0 / 0, mas precisamos esperar at√© que a interface Gi0 / 1 passe o estado de escuta, aprendizado para encaminhamento . </font><font style="vertical-align: inherit;">E o atraso n√£o ser√° mais de 50 segundos, mas 30. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O protocolo STP tamb√©m pensou em v√°rias tecnologias para otimizar e proteger a opera√ß√£o do protocolo STP. </font><font style="vertical-align: inherit;">N√£o os considerarei mais detalhadamente neste artigo; os materiais sobre eles podem ser encontrados em abund√¢ncia em v√°rios sites.</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt419491/">https://habr.com/ru/post/pt419491/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt419475/index.html">Como encontrar inspira√ß√£o e n√£o perder exclusividade</a></li>
<li><a href="../pt419477/index.html">Mais f√°cil do que parece. Cap√≠tulo 11</a></li>
<li><a href="../pt419479/index.html">Seguran√ßa "Ekaterinburg Arena": como preparamos o est√°dio para a Copa do Mundo de 2018</a></li>
<li><a href="../pt419483/index.html">PowerShell e Shift + Ins, ou como obter a velocidade Hermes ao trabalhar com GPP</a></li>
<li><a href="../pt419485/index.html">H√° um aplicativo para isso: an√∫ncio do Mobius 2018 Moscow</a></li>
<li><a href="../pt419493/index.html">Por que voc√™ precisa do Splunk? An√°lise de eventos de seguran√ßa</a></li>
<li><a href="../pt419495/index.html">Quem "inventou" a condu√ß√£o √≥ssea, por que √© usada e qu√£o segura √© para a audi√ß√£o</a></li>
<li><a href="../pt419497/index.html">Teste da Impressora 3D Grande Hercules Strong</a></li>
<li><a href="../pt419501/index.html">Aprendizado profundo: reconhecendo cenas e pontos de refer√™ncia em imagens</a></li>
<li><a href="../pt419503/index.html">O livro ‚ÄúAlgoritmos e estruturas de dados. Recupera√ß√£o de informa√ß√£o Java ¬ª</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>