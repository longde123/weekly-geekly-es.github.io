<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßóüèº üÜô üë©üèæ‚Äçü§ù‚Äçüë©üèº Types pour les API HTTP √©crites en Python: exp√©rience Instagram üö∂üèΩ üßíüèΩ ü•Å</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Aujourd'hui, nous publions le deuxi√®me mat√©riel de la s√©rie consacr√©e √† l'utilisation de Python sur Instagram. La derni√®re fois, il v√©rifiait les type...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Types pour les API HTTP √©crites en Python: exp√©rience Instagram</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/474308/">  Aujourd'hui, nous publions le deuxi√®me mat√©riel de la s√©rie consacr√©e √† l'utilisation de Python sur Instagram.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">La derni√®re</a> fois, il v√©rifiait les types de code de serveur Instagram.  Le serveur est un monolithe √©crit en Python.  Il se compose de plusieurs millions de lignes de code et compte plusieurs milliers de points de terminaison Django. <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/webt/nn/gh/jg/nnghjgmcauejll98mv34awk3cok.jpeg"></a> <br><br>  Cet article explique comment Instagram utilise les types pour documenter les API HTTP et appliquer les contrats lors de leur utilisation. <br><a name="habracut"></a><br><h2>  <font color="#3AC1EF">Aper√ßu de la situation</font> </h2><br>  Lorsque vous ouvrez le client mobile Instagram, celui-ci, via HTTP, acc√®de √† l'API JSON de notre serveur Python (Django). <br><br>  Voici quelques informations sur notre syst√®me qui vous permettront de vous faire une id√©e de la complexit√© de l'API que nous utilisons pour organiser le travail du client mobile.  Voici donc ce que nous avons: <br><br><ul><li>  Plus de 2000 points de terminaison sur le serveur. </li><li>  Plus de 200 champs de niveau sup√©rieur dans un objet de donn√©es client qui repr√©sente une image, une vid√©o ou une histoire dans une application. </li><li>  Des centaines de programmeurs qui √©crivent du code serveur (et encore plus qui traitent avec le client). </li><li>  Des centaines de validations de code serveur effectu√©es quotidiennement et modifiant l'API.  Cela est n√©cessaire pour assurer la prise en charge des nouvelles fonctionnalit√©s du syst√®me. </li></ul><br>  Nous utilisons des types pour documenter nos API HTTP complexes et en constante √©volution et pour appliquer les contrats lorsque nous les utilisons. <br><br><h2>  <font color="#3AC1EF">Les types</font> </h2><br>  Commen√ßons par le tout d√©but.  La description de la syntaxe des annotations de type dans le code Python est apparue dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PEP 484</a> .  Pourquoi ajouter des annotations de type au code? <br><br>  Consid√©rez la fonction qui t√©l√©charge des informations sur le h√©ros de Star Wars: <br><br><pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_character</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(id, calendar)</span></span></span><span class="hljs-function">:</span></span>     <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> id == <span class="hljs-number"><span class="hljs-number">1000</span></span>:         <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Character(             id=<span class="hljs-number"><span class="hljs-number">1000</span></span>,             name=<span class="hljs-string"><span class="hljs-string">"Luke Skywalker"</span></span>,             birth_year=<span class="hljs-string"><span class="hljs-string">"19BBY"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> calendar == Calendar.BBY <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> ...         )     ...</code> </pre> <br>  Pour comprendre cette fonction, vous devez lire son code.  Cela fait, vous pouvez d√©couvrir les √©l√©ments suivants: <br><br><ul><li>  Il prend l'identifiant entier ( <code>id</code> ) du caract√®re. </li><li>  Il prend la valeur de l'√©num√©ration correspondante ( <code>calendar</code> ).  Par exemple, <code>Calendar.BBY</code> signifie ¬´Avant la bataille de Yavin¬ª, c'est-√†-dire ¬´Avant la bataille de Yavin¬ª. </li><li>  Il renvoie des informations sur le personnage sous la forme d'une entit√© contenant des champs repr√©sentant l'identifiant de ce personnage, son nom et son ann√©e de naissance. </li></ul><br>  La fonction a un contrat implicite, dont le programmeur doit restaurer chaque fois qu'il lit le code de la fonction.  Mais le code de fonction n'est √©crit qu'une seule fois, et vous devez le lire plusieurs fois, donc cette approche pour travailler avec ce code n'est pas particuli√®rement bonne. <br><br>  De plus, il est difficile de v√©rifier que le m√©canisme qui appelle la fonction adh√®re au contrat implicite d√©crit ci-dessus.  De m√™me, il est difficile de v√©rifier que ce contrat est respect√© dans le corps de la fonction.  Dans une grande base de code, de telles situations peuvent entra√Æner des erreurs. <br><br>  Consid√©rons maintenant la m√™me fonction qui d√©clare les annotations de type: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_character</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(id: int, calendar: Calendar)</span></span></span><span class="hljs-function"> -&gt; Character:</span></span>    ...</code> </pre> <br>  Les annotations de type vous permettent d'exprimer explicitement le contrat de cette fonction.  Afin de comprendre ce qui doit √™tre entr√© dans une fonction et ce que cette fonction renvoie, il suffit de lire sa signature.  Un syst√®me de v√©rification de type peut analyser statiquement la fonction et v√©rifier la conformit√© au contrat dans le code.  Cela vous permet de vous d√©barrasser de toute une classe d'erreurs! <br><br><h2>  <font color="#3AC1EF">Types pour diverses API HTTP</font> </h2><br>  Nous d√©velopperons une API HTTP qui vous permettra de recevoir des informations sur les h√©ros de Star Wars.  Pour d√©crire le contrat explicite utilis√© lors de l'utilisation de cette API, nous utiliserons des annotations de type. <br><br>  Notre API doit accepter l'identificateur de caract√®re ( <code>id</code> ) comme param√®tre d'URL et la valeur de l'√©num√©ration du <code>calendar</code> comme param√®tre de demande.  L'API doit renvoyer une r√©ponse JSON avec des informations sur les caract√®res. <br><br>  Voici √† quoi ressemble la demande d'API et la r√©ponse qu'elle renvoie: <br><br><pre> <code class="plaintext hljs">curl -X GET https://api.starwars.com/characters/1000?calendar=BBY {    "id": 1000,    "name": "Luke Skywalker",    "birth_year": "19BBY" }</code> </pre> <br>  Pour impl√©menter cette API dans Django, vous devez d'abord enregistrer le chemin URL et la fonction d'affichage responsable de la r√©ception de la requ√™te HTTP effectu√©e le long de ce chemin et du retour de la r√©ponse. <br><br><pre> <code class="python hljs">urlpatterns = [    url(<span class="hljs-string"><span class="hljs-string">"characters/&lt;id&gt;/"</span></span>, get_character) ]</code> </pre> <br>  La fonction, en entr√©e, accepte les param√®tres de requ√™te et d'URL (dans notre cas, <code>id</code> ).  Il analyse et convertit le param√®tre de demande de <code>calendar</code> , qui est la valeur de l'√©num√©ration correspondante, en type requis.  Il charge les donn√©es de caract√®res du magasin et renvoie un dictionnaire s√©rialis√© en JSON et envelopp√© dans une r√©ponse HTTP. <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_character</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request: IGWSGIRequest, id: str)</span></span></span><span class="hljs-function"> -&gt; JsonResponse:</span></span>    calendar = Calendar(request.GET.get(<span class="hljs-string"><span class="hljs-string">"calendar"</span></span>, <span class="hljs-string"><span class="hljs-string">"BBY"</span></span>))    character = Store.get_character(id, calendar)    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> JsonResponse(asdict(character))</code> </pre> <br>  Bien que la fonction soit fournie avec des annotations de type, elle ne d√©crit pas explicitement le contrat mat√©riel pour l'API HTTP.  √Ä partir de la signature de cette fonction, nous ne pouvons pas trouver les noms ou les types de param√®tres de demande, ou les champs de r√©ponse et leurs types. <br><br>  Est-il possible de faire en sorte que la signature de la fonction-repr√©sentation soit exactement la m√™me informative que la signature de la fonction pr√©c√©demment consid√©r√©e avec des annotations de type? <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_character</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(id: int, calendar: Calendar)</span></span></span><span class="hljs-function"> -&gt; Character:</span></span>    ...</code> </pre> <br>  Les param√®tres de fonction peuvent √™tre des param√®tres de requ√™te (URL, requ√™te ou param√®tres de corps de requ√™te).  Le type de valeur renvoy√© par la fonction peut repr√©senter le contenu de la r√©ponse.  Avec cette approche, nous aurions √† notre disposition un contrat explicite et compr√©hensible pour l'API HTTP, dont le respect pourrait √™tre assur√© par un syst√®me de v√©rification de type. <br><br><h2>  <font color="#3AC1EF">Impl√©mentation</font> </h2><br>  Comment mettre en ≈ìuvre cette id√©e? <br><br>  Nous utilisons un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">d√©corateur</a> pour convertir une fonction de repr√©sentation fortement typ√©e en une fonction de repr√©sentation Django.  Cette √©tape ne n√©cessite pas de modifications en termes de travail avec le framework Django.  Nous pouvons utiliser le m√™me middleware, les m√™mes routes et d'autres composants auxquels nous sommes habitu√©s. <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@api_view def get_character(id: int, calendar: Calendar) -&gt; Character:    ...</span></span></code> </pre> <br>  Consid√©rez les d√©tails de l' <code>api_view</code> d√©corateur <code>api_view</code> : <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">api_view</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(view)</span></span></span><span class="hljs-function">:</span></span>    @functools.wraps(view)    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">django_view</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request, *args, **kwargs)</span></span></span><span class="hljs-function">:</span></span>        params = {            param_name: param.annotation(extract(request, param))            <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> param_name, param <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> inspect.signature(view).parameters.items()        }        data = view(**params)        <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> JsonResponse(asdict(data))       <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> django_view</code> </pre> <br>  C'est un morceau de code difficile √† comprendre.  Analysons ses caract√©ristiques. <br>  Nous, en tant que valeur d'entr√©e, prenons une fonction de repr√©sentation fortement typ√©e et l'enveloppons dans une fonction de repr√©sentation Django r√©guli√®re, que nous renvoyons: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">api_view</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(view)</span></span></span><span class="hljs-function">:</span></span>    @functools.wraps(view)    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">django_view</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request, *args, **kwargs)</span></span></span><span class="hljs-function">:</span></span>        ...    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> django_view</code> </pre> <br>  Jetez maintenant un ≈ìil √† l'impl√©mentation de la fonction de vue Django.  Nous devons d'abord construire des arguments pour une fonction de pr√©sentation fortement typ√©e.  Nous utilisons l'introspection et le module d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">inspection</a> pour obtenir la signature de cette fonction et it√©rer sur ses param√®tres: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> param_name, param <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> inspect.signature(view).parameters.items()</code> </pre> <br>  Pour chaque param√®tre, nous appelons la fonction d' <code>extract</code> , qui extrait la valeur du param√®tre de la demande. <br><br>  Ensuite, nous convertissons le param√®tre en le type attendu sp√©cifi√© dans la signature (par exemple, convertissons le <code>calendar</code> de la cha√Æne en une valeur qui est un √©l√©ment de l'√©num√©ration <code>Calendar</code> ). <br><br><pre> <code class="python hljs">param.annotation(extract(request, param))</code> </pre> <br>  Nous appelons une fonction de vue fortement typ√©e avec les arguments que nous avons construits: <br><br><pre> <code class="python hljs">data = view(**params)</code> </pre> <br>  La fonction renvoie une valeur fortement typ√©e de la classe <code>Character</code> .  Nous prenons cette valeur, la transformons en dictionnaire et l'enveloppons dans une r√©ponse HTTP au format JSON: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> JsonResponse(asdict(data))</code> </pre> <br>  Super!  Nous avons maintenant une fonction de vue Django qui encapsule une fonction de vue fortement typ√©e.  Enfin, jetez un ≈ìil √† la fonction d' <code>extract</code> : <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">extract</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request: HttpRequest, param: Parameter)</span></span></span><span class="hljs-function"> -&gt; Any:</span></span>    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> request.resolver_match.route.contains(<span class="hljs-string"><span class="hljs-string">f"&lt;</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{param}</span></span></span><span class="hljs-string">&gt;"</span></span>):        <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> request.resolver_match.kwargs.get(param.name)    <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>:        <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> request.GET.get(param.name)</code> </pre> <br>  Chaque param√®tre peut √™tre un param√®tre URL ou un param√®tre de demande.  Le chemin de l'URL de demande (le chemin que nous avons enregistr√© au tout d√©but) est disponible dans l'objet route du syst√®me de localisateur d'URL Django.  Nous v√©rifions le nom du param√®tre dans le chemin.  S'il y a un nom, alors nous avons un param√®tre URL.  Cela signifie que nous pouvons en quelque sorte l'extraire de la demande.  Sinon, il s'agit d'un param√®tre de requ√™te et nous pouvons √©galement l'extraire, mais d'une autre mani√®re. <br><br>  C‚Äôest tout.  Il s'agit d'une impl√©mentation simplifi√©e, mais elle illustre l'id√©e de base de taper une API. <br><br><h2>  <font color="#3AC1EF">Types de donn√©es</font> </h2><br>  Le type utilis√© pour repr√©senter le contenu de la r√©ponse HTTP (c'est-√†-dire <code>Character</code> ) peut √™tre repr√©sent√© soit par une classe de donn√©es soit par un dictionnaire typ√©. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Une classe de</a> donn√©es est un format de description de classe compact qui repr√©sente des donn√©es. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dataclasses <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> dataclass @dataclass(frozen=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Character</span></span></span><span class="hljs-class">:</span></span>    id: int    name: str    birth_year: str luke = Character(    id=<span class="hljs-number"><span class="hljs-number">1000</span></span>,    name=<span class="hljs-string"><span class="hljs-string">"Luke Skywalker"</span></span>,    birth_year=<span class="hljs-string"><span class="hljs-string">"19BBY"</span></span> )</code> </pre> <br>  Instagram utilise g√©n√©ralement des classes de donn√©es pour mod√©liser les objets de r√©ponse HTTP.  Voici leurs principales caract√©ristiques: <br><br><ul><li>  Ils g√©n√®rent automatiquement des constructions de mod√®les et diverses m√©thodes d'assistance. </li><li>  Ils sont compr√©hensibles pour les syst√®mes de v√©rification de type, ce qui signifie que les valeurs peuvent √™tre soumises √† des v√©rifications de type. </li><li>  Ils maintiennent l'immunit√© gr√¢ce √† la construction <code>frozen=True</code> . </li><li>  Ils sont disponibles dans la biblioth√®que standard Python 3.7 ou en tant que backport dans l'index du package Python. </li></ul><br>  Malheureusement, Instagram a une base de code obsol√®te qui utilise de gros dictionnaires non typ√©s, pass√©s entre les fonctions et les modules.  Il ne serait pas facile de traduire tout ce code des dictionnaires en classes de donn√©es.  Par cons√©quent, nous utilisons des classes de donn√©es pour le nouveau code et dans du code obsol√®te, nous utilisons <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">des dictionnaires typ√©s</a> . <br><br>  L'utilisation de dictionnaires typ√©s nous permet d'ajouter des annotations de type aux objets du dictionnaire client et, sans changer le comportement d'un syst√®me de travail, d'utiliser les capacit√©s de v√©rification de type. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> mypy_extensions <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> TypedDict <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Character</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(TypedDict)</span></span></span><span class="hljs-class">:</span></span>    id: int    name: str    birth_year: str luke: Character = {<span class="hljs-string"><span class="hljs-string">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">1000</span></span>} luke[<span class="hljs-string"><span class="hljs-string">"name"</span></span>] = <span class="hljs-string"><span class="hljs-string">"Luke Skywalker"</span></span> luke[<span class="hljs-string"><span class="hljs-string">"birth_year"</span></span>] = <span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-comment"><span class="hljs-comment"># type error, birth_year expects a str luke["invalid_key"] # type error, invalid_key does not exist</span></span></code> </pre> <br><h2>  <font color="#3AC1EF">Gestion des erreurs</font> </h2><br>  La fonction d'affichage devrait renvoyer des informations de caract√®re sous la forme d'une entit√© de <code>Character</code> .  Que devons-nous faire si nous devons renvoyer une erreur au client? <br><br>  Vous pouvez lever une exception qui sera intercept√©e par le framework et convertie en une r√©ponse HTTP avec des informations d'erreur. <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@api_view("GET") def get_character(id: str, calendar: Calendar) -&gt; Character:    try:        return Store.get_character(id)    except CharacterNotFound:        raise Http404Exception()</span></span></code> </pre> <br>  Cet exemple illustre √©galement la m√©thode HTTP dans le d√©corateur, qui d√©finit les m√©thodes HTTP autoris√©es pour cette API. <br><br><h2>  <font color="#3AC1EF">Les outils</font> </h2><br>  L'API HTTP est fortement typ√©e √† l'aide de la m√©thode HTTP, des types de demande et des types de r√©ponse.  Nous pouvons introspecter cette API et d√©terminer qu'elle doit accepter une demande GET avec la cha√Æne <code>id</code> dans le chemin URL et avec la valeur de <code>calendar</code> li√©e √† l'√©num√©ration correspondante dans la cha√Æne de requ√™te.  Nous pouvons √©galement apprendre qu'en r√©ponse √† une telle demande, une r√©ponse JSON doit √™tre fournie avec des informations sur la nature du <code>Character</code> . <br><br>  Que faire de toutes ces informations? <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">OpenAPI</a> est un format de description d'API sur la base duquel un riche ensemble d'outils auxiliaires est cr√©√©.  C'est tout un √©cosyst√®me.  Si nous √©crivons du code pour effectuer une introspection de point final et g√©n√©rer des sp√©cifications OpenAPI bas√©es sur les donn√©es re√ßues, cela signifiera que nous aurons les capacit√©s de ces outils. <br><br><pre> <code class="python hljs">paths:  /characters/{id}:    get:      parameters:        - <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>: path          name: id          schema:            type: integer          required: true        - <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>: query          name: calendar          schema:            type: string            enum: [<span class="hljs-string"><span class="hljs-string">"BBY"</span></span>]      responses:        <span class="hljs-string"><span class="hljs-string">'200'</span></span>:          content:            application/json:              schema:                type: object                ...</code> </pre> <br>  Nous pouvons g√©n√©rer la documentation de l'API HTTP pour l'API <code>get_character</code> , qui comprend les noms, les types, les informations de demande et de r√©ponse.  Il s'agit d'un niveau d'abstraction appropri√© pour les d√©veloppeurs clients qui doivent r√©pondre aux demandes au point de terminaison appropri√©.  Ils n'ont pas besoin de lire le code d'impl√©mentation Python pour ce point de terminaison. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/673/e79/28e/673e7928eb5c55d4d6ec83c506eaf450.png"><br>  <i><font color="#999999">Documentation API</font></i> <br><br>  Sur cette base, vous pouvez cr√©er des outils suppl√©mentaires.  Par exemple, un moyen d'ex√©cuter une demande √† partir d'un navigateur.  Cela permet aux d√©veloppeurs d'acc√©der aux API HTTP qui les int√©ressent sans avoir √† √©crire de code.  Nous pouvons m√™me g√©n√©rer du code client de type s√©curis√© pour nous assurer que les types fonctionnent correctement √† la fois sur le client et sur le serveur.  Pour cette raison, nous pouvons avoir √† notre disposition une API strictement typ√©e sur le serveur, dont les appels sont effectu√©s en utilisant du code client strictement typ√©. <br><br>  De plus, nous pouvons cr√©er un syst√®me de v√©rification de la compatibilit√© descendante.  Que se passe-t-il si nous publions une nouvelle version du code serveur pour acc√©der √† l'API en question, nous devons utiliser <code>id</code> , <code>name</code> et <code>birth_year</code> , puis nous comprenons que nous ne connaissons pas les anniversaires de tous les personnages?  Dans ce cas, le param√®tre <code>birth_year</code> √™tre rendu facultatif, mais les anciennes versions de clients qui attendent un param√®tre similaire peuvent simplement cesser de fonctionner.  Bien que nos API diff√®rent par leur typage explicite, les types correspondants peuvent changer (par exemple, l'API changera si l'utilisation de l'ann√©e de naissance du personnage √©tait d'abord obligatoire puis devenait facultative).  Nous pouvons suivre les modifications de l'API et avertir les d√©veloppeurs d'API en leur donnant des invites au bon moment qu'en effectuant certaines modifications, ils peuvent perturber les performances des clients. <br><br><h2>  <font color="#3AC1EF">R√©sum√©</font> </h2><br>  Il existe toute une gamme de protocoles d'application que les ordinateurs peuvent utiliser pour communiquer entre eux. <br><br>  Un c√¥t√© de ce spectre est repr√©sent√© par des cadres RPC comme Thrift et gRPC.  Ils diff√®rent en ce qu'ils d√©finissent g√©n√©ralement des types stricts pour les demandes et les r√©ponses et g√©n√®rent du code client et serveur pour organiser le fonctionnement des demandes.  Ils peuvent se passer de HTTP et m√™me de JSON. <br><br>  D'un autre c√¥t√©, il existe des frameworks Web non structur√©s √©crits en Python qui n'ont pas de contrats explicites pour les demandes et les r√©ponses.  Notre approche offre des opportunit√©s typiques pour des frameworks plus clairement structur√©s, mais en m√™me temps vous permet de continuer √† utiliser le bundle HTTP + JSON et contribue au fait que vous devez apporter un minimum de modifications au code de l'application. <br><br>  Il est important de noter que cette id√©e n'est pas nouvelle.  Il existe de nombreux frameworks √©crits dans des langages fortement typ√©s qui fournissent aux d√©veloppeurs les fonctionnalit√©s que nous avons d√©crites.  Si nous parlons de Python, alors c'est, par exemple, le framework <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">APIStar</a> . <br><br>  Nous avons r√©ussi √† commander l'utilisation de types pour l'API HTTP.  Nous avons pu appliquer l'approche d√©crite pour taper l'API dans l'ensemble de notre base de code car elle est bien applicable aux fonctions de pr√©sentation existantes.  La valeur de ce que nous avons fait est √©vidente pour tous nos programmeurs.  √Ä savoir, nous parlons du fait que la documentation g√©n√©r√©e automatiquement est devenue un moyen de communication efficace entre ceux qui d√©veloppent le serveur et ceux qui √©crivent le client Instagram. <br><br>  <b>Chers lecteurs!</b>  Comment abordez-vous la conception des API HTTP dans vos projets Python? <br><br><div style="text-align:center;"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/webt/-o/2e/tu/-o2etuqogwhmdnmysb9_vivc9v4.png"></a> </div><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/files/1ba/550/d25/1ba550d25e8846ce8805de564da6aa63.png"></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr474308/">https://habr.com/ru/post/fr474308/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr474294/index.html">Compatibilit√© binaire: maintenant ou jamais</a></li>
<li><a href="../fr474298/index.html">Mise en ≈ìuvre d'une op√©ration de transfert de carte √† carte de passerelle P2P</a></li>
<li><a href="../fr474300/index.html">Sauvegarde fiable, s√©curis√©e et polyvalente pour U2F</a></li>
<li><a href="../fr474302/index.html">Comment √©crire un script de test d'utilisabilit√© d'application efficace</a></li>
<li><a href="../fr474306/index.html">Rendre les styles de pointage, de mise au point et d'√©tat actif diff√©rents</a></li>
<li><a href="../fr474310/index.html">Y a-t-il des nombres al√©atoires dans CSS?</a></li>
<li><a href="../fr474312/index.html">Installation de l'interface graphique sur Windows Server Core</a></li>
<li><a href="../fr474316/index.html">Voiture √©lectrique faite maison - partie 1. Comment tout a commenc√© et comment j'ai marqu√© 1000000 vues sur youtube</a></li>
<li><a href="../fr474318/index.html">Qu'est-ce qu'une table de table virtuelle?</a></li>
<li><a href="../fr474320/index.html">DDD Community Crisis</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>