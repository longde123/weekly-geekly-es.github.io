<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèæ üññ üîô Tutorial de fondo de Android. Parte 5: Corutinas en Kotlin ‚úíÔ∏è ‚õ±Ô∏è üßëüèº‚Äçü§ù‚Äçüßëüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Isla Kotlin 

 Textos anteriores de esta serie: sobre AsyncTask , sobre Loaders , sobre Executors y EventBus , sobre RxJava . 

 Entonces esta hora ha...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Tutorial de fondo de Android. Parte 5: Corutinas en Kotlin</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/jugru/blog/415335/"><img src="https://habrastorage.org/webt/r3/h-/kd/r3h-kdmudutyx6g2zcisi4vly7c.png"><br>  <sup>Isla Kotlin</sup> <br><br>  <i>Textos anteriores de esta serie: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">sobre AsyncTask</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">sobre Loaders</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">sobre Executors y EventBus</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">sobre RxJava</a> .</i> <br><br>  Entonces esta hora ha llegado.  Este es el art√≠culo para el que se escribi√≥ toda la serie: una explicaci√≥n de c√≥mo funciona el nuevo enfoque "bajo el cap√≥".  Si a√∫n no sabe c√≥mo usarlo, aqu√≠ hay algunos enlaces √∫tiles para comenzar: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">P√°gina en el sitio web oficial</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Publicaci√≥n del blog de recetas de Android Coroutine</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Informe de Roman Elizarov</a> </li></ul><br>  Y habiendo dominado las corutinas, puede preguntarse qu√© permiti√≥ a Kotlin brindar esta oportunidad y c√≥mo funciona.  Tenga en cuenta que aqu√≠ nos centraremos solo en la etapa de compilaci√≥n: puede escribir un art√≠culo separado sobre la ejecuci√≥n. <br><a name="habracut"></a><br>  Lo primero que debemos entender es que, en el corpus, en realidad no existen corutinas.  El compilador convierte la funci√≥n con el modificador suspendido en una funci√≥n con el par√°metro <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Continuaci√≥n</a> .  Esta interfaz tiene dos m√©todos: <br><br><pre><code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">resume</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(value: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">T</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">resumeWithException</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(exception: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Throwable</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span></code> </pre> <br>  El tipo T es el tipo de retorno de su funci√≥n de suspensi√≥n original.  Y esto es lo que sucede realmente: esta funci√≥n se ejecuta en un determinado hilo (paciencia, tambi√©n llegamos a esto), y el resultado se pasa a la funci√≥n de reanudaci√≥n de esa continuaci√≥n, en cuyo contexto se llam√≥ a la funci√≥n de suspensi√≥n.  Si la funci√≥n no recibe el resultado y genera una excepci√≥n, se genera resumeWithException, arrojando un error al c√≥digo de llamada. <br><br>  Ok, pero ¬øde d√≥nde vino la continuaci√≥n?  ¬°Por supuesto, del constructor Corutin!  Veamos el c√≥digo que crea cualquier rutina, por ejemplo, lanzar: <br><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">actual</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">launch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( context: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">CoroutineContext</span></span></span></span><span class="hljs-function"><span class="hljs-params"> = DefaultDispatcher, start: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">CoroutineStart</span></span></span></span><span class="hljs-function"><span class="hljs-params"> = CoroutineStart.DEFAULT, parent: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Job</span></span></span></span><span class="hljs-function"><span class="hljs-params">? = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">null</span></span></span></span><span class="hljs-function"><span class="hljs-params">, block: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">suspend</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">CoroutineScope</span></span></span></span><span class="hljs-function"><span class="hljs-params">.()</span></span></span></span> -&gt; <span class="hljs-built_in"><span class="hljs-built_in">Unit</span></span> ): Job { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> newContext = newCoroutineContext(context, parent) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> coroutine = <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (start.isLazy) LazyStandaloneCoroutine(newContext, block) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> StandaloneCoroutine(newContext, active = <span class="hljs-literal"><span class="hljs-literal">true</span></span>) coroutine.start(start, coroutine, block) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> coroutine }</code> </pre><br>  Aqu√≠, el creador crea una rutina: una instancia de la clase AbstractCoroutine, que, a su vez, implementa la interfaz de Continuaci√≥n.  El m√©todo de inicio pertenece a la interfaz de trabajo.  Pero encontrar la definici√≥n del m√©todo de inicio es muy dif√≠cil.  Pero podemos venir aqu√≠ desde el otro lado.  Un lector atento ya ha notado que el primer argumento para la funci√≥n de lanzamiento es CoroutineContext, y est√° configurado en DefaultDispatcher de forma predeterminada.  Los despachadores son clases que controlan la ejecuci√≥n de las rutinas, por lo que son definitivamente importantes para comprender lo que est√° sucediendo.  Veamos la declaraci√≥n DefaultDispatcher: <br><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">actual</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> DefaultDispatcher: CoroutineDispatcher = CommonPool</code> </pre><br>  Entonces, de hecho, esto es CommonPool, aunque los muelles Java nos dicen que esto puede cambiar.  ¬øQu√© es CommonPool? <br><br>  Este es un administrador de rutina que utiliza <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ForkJoinPool</a> como una implementaci√≥n de ExecutorService.  S√≠, lo es: al final, todas sus corutinas lambda son simplemente Runnable, que entr√≥ en Ejecutor con un conjunto de transformaciones dif√≠ciles.  Pero el diablo, como siempre, est√° en los detalles. <br><br><img src="https://habrastorage.org/webt/jh/yg/wr/jhygwrz-zofdvbpe11tbvvatsqi.jpeg"><br>  <sup>Tenedor?</sup>  <sup>O unirse?</sup> <br><br>  A juzgar por los resultados de la encuesta en mi twitter, aqu√≠ necesito explicar brevemente qu√© es FJP :) <br><br><div class="oembed"><twitter-widget class="twitter-tweet twitter-tweet-rendered" id="twitter-widget-0" style="position: static; visibility: visible; display: block; transform: rotate(0deg); width: 500px; margin: 10px auto; max-width: 100%; min-width: 220px;" data-tweet-id="991950848996597760"></twitter-widget><script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></div><br>  En primer lugar, ForkJoinPool es un ejecutor moderno creado para su uso con flujos paralelos Java 8. La tarea original era un paralelismo eficiente cuando se trabajaba con la API Stream, lo que esencialmente significa dividir los flujos para procesar parte de los datos y luego combinarlos cuando todos los datos se han procesado.  Para simplificar, imagine que tiene el siguiente c√≥digo: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">IntStream</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.range</span></span>(1, 1_000_000) <span class="hljs-selector-class"><span class="hljs-selector-class">.parallel</span></span>() <span class="hljs-selector-class"><span class="hljs-selector-class">.sum</span></span>()</code> </pre><br>  La cantidad de dicha secuencia no se calcular√° en una secuencia, en su lugar, ForkJoinPool dividir√° recursivamente el rango en partes (primero en dos partes de 500,000, luego cada una de ellas en 250,000, y as√≠ sucesivamente), calcule la suma de cada parte y combine los resultados en un solo cantidad  Aqu√≠ hay una visualizaci√≥n de dicho proceso: <br><br><img src="https://habrastorage.org/webt/15/yb/uk/15ybukvbskzmzddp9lytwarsbvy.jpeg"><br>  <sup>Los subprocesos se dividen para diferentes tareas y se fusionan nuevamente despu√©s de la finalizaci√≥n</sup> <br><br>  La efectividad de FJP se basa en el algoritmo de "robo de trabajo": cuando un subproceso particular se queda sin tareas, va a las colas de otros subprocesos de grupo y roba sus tareas.  Para una mejor comprensi√≥n, puede ver el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">informe de</a> Alexei Shipilev o ver una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">presentaci√≥n</a> . <br><br>  ¬°Bueno, nos dimos cuenta de lo que est√°n haciendo nuestras corutinas!  ¬øPero c√≥mo terminan all√≠? <br><br>  Esto sucede dentro del m√©todo de despacho CommonPool #: <br><br><pre> <code class="hljs css">_<span class="hljs-selector-tag"><span class="hljs-selector-tag">pool</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.execute</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">timeSource</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.trackTask</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">block</span></span>))</code> </pre><br>  El m√©todo de despacho se llama desde el m√©todo resume (Valor: T) en DispatchedContinuation.  Suena familiar!  Recordamos que Continuation es una interfaz implementada en AbstractCoroutine.  ¬øPero c√≥mo se relacionan? <br><br>  El truco est√° dentro de la clase CoroutineDispatcher.  Implementa la interfaz ContinuationInterceptor de la siguiente manera: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> actual <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> fun &lt;T&gt; interceptContinuation(continuation: Continuation&lt;T&gt;): Continuation&lt;T&gt; = DispatchedContinuation(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, continuation)</code> </pre><br>  ¬øVes?  Usted proporciona un bloque simple al constructor de corutina.  No necesita implementar ninguna interfaz de la que no quiera saber nada.  La biblioteca de rutina se encarga de todo esto.  Ella es <br>  intercepta la ejecuci√≥n, reemplaza la continuaci√≥n con DispatchedContinuation y la env√≠a al ejecutor, lo que garantiza la ejecuci√≥n m√°s eficiente de su c√≥digo. <br><br>  Ahora, lo √∫nico que debemos tratar es c√≥mo se llama el despacho desde el m√©todo de inicio.  Llenemos este vac√≠o.  El m√©todo de reanudaci√≥n se llama desde startCoroutine en la funci√≥n de extensi√≥n del bloque: <br><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-type"><span class="hljs-function"><span class="hljs-type">&lt;R, T&gt;</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">suspend</span></span></span></span><span class="hljs-function"><span class="hljs-params"> R.()</span></span></span></span> -&gt; T).startCoroutine( receiver: R, completion: Continuation&lt;T&gt; ) { createCoroutineUnchecked(receiver, completion).resume(<span class="hljs-built_in"><span class="hljs-built_in">Unit</span></span>) }</code> </pre><br>  Y startCoroutine, a su vez, es llamado por el operador "()" en la enumeraci√≥n CoroutineStart.  Su constructor lo acepta como el segundo par√°metro, y el valor predeterminado es CoroutineStart.DEFAULT.  Eso es todo! <br><br>  Esa es la raz√≥n por la que admiro el enfoque de corutina: no es solo una sintaxis espectacular, sino tambi√©n una implementaci√≥n brillante. <br><br><blockquote>  Y para aquellos que han le√≠do hasta el final, obtienen exclusivos: un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">video de</a> mi informe "No se necesita un violinista: rechazamos RxJava a favor de la corutina en Kotlin" de la conferencia de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Mobius</a> .  Disfruta :) <br></blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es415335/">https://habr.com/ru/post/es415335/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es415323/index.html">Proyectos de graduaci√≥n de graduados de Technoproject, primavera de 2018</a></li>
<li><a href="../es415327/index.html">El teorema de Pit√°goras fue utilizado por los constructores de Stonehenge 2000 a√±os antes del nacimiento del propio Pit√°goras.</a></li>
<li><a href="../es415329/index.html">Toda la verdad sobre RTOS de Colin Walls. Art√≠culo # 3. Tareas y planificaci√≥n</a></li>
<li><a href="../es415331/index.html">Impresoras de construcci√≥n para imprentas de 5-6 pisos se producen en Yaroslavl</a></li>
<li><a href="../es415333/index.html">Arduino - transmisor de radiodifusi√≥n AM micropoderoso</a></li>
<li><a href="../es415337/index.html">C√≥mo Pusher Channels entreg√≥ 10,000,000,000,000 de mensajes ya</a></li>
<li><a href="../es415341/index.html">Cursos de administraci√≥n de PostgreSQL</a></li>
<li><a href="../es415343/index.html"># 2 HACKATON para j√≥venes profesionales en Perm</a></li>
<li><a href="../es415345/index.html">Consejos para decidir convertirse en desarrollador de iOS</a></li>
<li><a href="../es415347/index.html">2. Basado en Meyers "C ++ efectivo y moderno" - detalles de inferencia de tipo de plantilla para matrices</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>