<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤞🏽 🧔🏽 👃🏽 Réagissez: la levée de l'état tue votre application 🔷 🚀 🉐</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Avez-vous entendu parler de "lever l'état"? Je suppose que vous l'avez fait et c'est la raison exacte pour laquelle vous êtes ici. Comment pourrait-il...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Réagissez: la levée de l'état tue votre application</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/471300/"><p><img src="https://habrastorage.org/webt/gd/9i/zn/gd9iznyftdnoffeagz18yy8aqeu.jpeg" alt="Couverture"></p><br><p>  Avez-vous entendu parler de "lever l'état"?  Je suppose que vous l'avez fait et c'est la raison exacte pour laquelle vous êtes ici.  Comment pourrait-il être possible que l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">un des 12 principaux concepts répertoriés dans la documentation officielle de React</a> conduise à de mauvaises performances?  Dans cet article, nous allons considérer une situation où c'est effectivement le cas. </p><a name="habracut"></a><br><h2 id="step-1-lift-it-up">  Étape 1: soulevez-le </h2><br><p>  Je vous suggère de créer un jeu simple de tic-tac-toe.  Pour le jeu, nous aurons besoin de: </p><br><ul><li><p> Un état de jeu.  Aucune véritable logique de jeu pour savoir si nous gagnons ou perdons.  Juste un simple tableau bidimensionnel rempli de <code>"x"</code> ou de <code>"0".</code> non <code>undefined</code> <code>"0".</code> </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> size = <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-comment"><span class="hljs-comment">// Two-dimensional array (size * size) filled with `undefined`. Represents an empty field. const initialField = new Array(size).fill(new Array(size).fill(undefined))</span></span></code> </pre> <br></li><li><p>  Un conteneur parent pour héberger l'état de notre jeu. </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> App = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> [field, setField] = useState(initialField) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> &lt;div&gt; {field.map((row, rowI</span></span></span><span class="hljs-function">) =&gt;</span></span> ( <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> {row.map((cell, cellI) =&gt; ( </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Cell</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">content</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{cell}</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">setContent</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{</span></span></span></span><span class="xml"><span class="hljs-tag"> // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Update</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">a</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">single</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">cell</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">of</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">a</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">two-dimensional</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">array</span></span></span></span><span class="xml"><span class="hljs-tag"> // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">and</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">return</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">a</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">new</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">two</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">dimensional</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">array</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">newContent</span></span></span></span><span class="xml"><span class="hljs-tag">) =&gt;</span></span></span><span class="xml"> setField([ // Copy rows before our target row ...field.slice(0, rowI), [ // Copy cells before our target cell ...field[rowI].slice(0, cellI), newContent, // Copy cells after our target cell ...field[rowI].slice(cellI + 1), ], // Copy rows after our target row ...field.slice(rowI + 1), ]) } /&gt; ))} </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> ))} </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> ) }</code> </pre> <br></li><li><p>  Un composant enfant pour afficher l'état d'une seule cellule. </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> randomContent = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.random() &gt; <span class="hljs-number"><span class="hljs-number">0.5</span></span> ? <span class="hljs-string"><span class="hljs-string">'x'</span></span> : <span class="hljs-string"><span class="hljs-string">'0'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Cell = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">{ content, setContent }</span></span></span><span class="hljs-function">) =&gt;</span></span> ( <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">onClick</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{()</span></span></span></span><span class="xml"><span class="hljs-tag"> =&gt;</span></span></span><span class="xml"> setContent(randomContent())}&gt;{content}</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> )</code> </pre> <br></li></ul><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Démo en direct # 1</a> </p><br><p>  Jusqu'à présent, cela semble bien.  Un champ parfaitement réactif avec lequel vous pouvez interagir à la vitesse de la lumière :) Augmentons la taille.  Disons, à 100. Oui, il est temps de cliquer sur ce lien de démonstration et de changer la variable de <code>size</code> tout en haut.  Toujours rapide pour vous?  Essayez 200 ou utilisez la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">limitation du processeur intégrée à Chrome</a> .  Voyez-vous maintenant un décalage important entre le moment où vous cliquez sur une cellule et le moment où son contenu change? </p><br><p>  Modifions à nouveau la <code>size</code> à 10 et ajoutons du profilage pour rechercher la cause. </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Cell = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">{ content, setContent }</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'cell rendered'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">onClick</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{()</span></span></span></span><span class="xml"><span class="hljs-tag"> =&gt;</span></span></span><span class="xml"> setContent(randomContent())}&gt;{content}</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> }</code> </pre> <br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Démo en direct # 2</a> </p><br><p>  Oui, c'est ça.  Une <code>console.log</code> simple suffirait car elle s'exécute sur chaque rendu. </p><br><p>  Alors que voyons-nous?  Sur la base du nombre d'instructions "rendu cellule" (pour <code>size</code> = N, il devrait être N) dans notre console, il semble que le champ entier soit rendu à chaque fois qu'une seule cellule change. </p><br><p>  La chose la plus évidente à faire est d'ajouter des clés comme le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">suggère la documentation de React</a> . </p><br><pre> <code class="javascript hljs">&lt;div&gt; {field.map(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">row, rowI</span></span></span><span class="hljs-function">) =&gt;</span></span> ( <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">key</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{rowI}</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> {row.map((cell, cellI) =&gt; ( </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Cell</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">key</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{</span></span></span></span><span class="xml"><span class="hljs-tag">`</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">row</span></span></span></span><span class="xml"><span class="hljs-tag">${</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rowI</span></span></span></span><span class="xml"><span class="hljs-tag">}</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">cell</span></span></span></span><span class="xml"><span class="hljs-tag">${</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">cellI</span></span></span></span><span class="xml"><span class="hljs-tag">}`} </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">content</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{cell}</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">setContent</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{(newContent)</span></span></span></span><span class="xml"><span class="hljs-tag"> =&gt;</span></span></span><span class="xml"> setField([ ...field.slice(0, rowI), [ ...field[rowI].slice(0, cellI), newContent, ...field[rowI].slice(cellI + 1), ], ...field.slice(rowI + 1), ]) } /&gt; ))} </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> ))} </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre> <br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Démo en direct # 3</a> </p><br><p>  Cependant, après avoir à nouveau augmenté la <code>size</code> , nous constatons que ce problème persiste.  Si seulement nous pouvions voir pourquoi un composant est rendu ... Heureusement, nous pouvons avec l'aide de l'incroyable <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">React DevTools</a> .  Il est capable d'enregistrer pourquoi les composants sont rendus.  Vous devez cependant l'activer manuellement. </p><br><p><img src="https://habrastorage.org/webt/36/ms/b4/36msb4eskbqe6txnqv5j3phjfda.png" alt="Réagissez aux paramètres DevTools"></p><br><p>  Une fois qu'il est activé, nous pouvons voir que toutes les cellules ont été rendues à nouveau parce que leurs accessoires ont changé, en particulier, l'accessoire <code>setContent</code> . </p><br><p><img src="https://habrastorage.org/webt/nv/3o/on/nv3oon4uvu6om8oea4fnnaun8m4.png" alt="Rapport DevTools React # 1"></p><br><p>  Chaque cellule a deux accessoires: <code>content</code> et <code>setContent</code> .  Si la cellule [0] [0] change, le contenu de la cellule [0] [1] ne change pas.  D'un autre côté, <code>setContent</code> capture <code>field</code> , <code>cellI</code> et <code>rowI</code> dans sa fermeture.  <code>cellI</code> et <code>rowI</code> restent les mêmes, mais le <code>field</code> change à chaque changement de cellule. </p><br><p>  Refactorisons notre code et conservons <code>setContent</code> la même manière. </p><br><p>  Pour conserver la référence à <code>setContent</code> nous devons nous débarrasser des fermetures.  Nous pourrions éliminer la fermeture de <code>cellI</code> et <code>rowI</code> en faisant explicitement passer notre <code>Cell</code> <code>cellI</code> et <code>rowI</code> à <code>setContent</code> .  En ce qui concerne le <code>field</code> , nous pourrions utiliser une fonctionnalité <code>setState</code> de <code>setState</code> - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">il accepte les rappels</a> . </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> [field, setField] = useState(initialField) <span class="hljs-comment"><span class="hljs-comment">// `useCallback` keeps reference to `setCell` the same. const setCell = useCallback( (rowI, cellI, newContent) =&gt; setField((oldField) =&gt; [ ...oldField.slice(0, rowI), [ ...oldField[rowI].slice(0, cellI), newContent, ...oldField[rowI].slice(cellI + 1), ], ...oldField.slice(rowI + 1), ]), [], )</span></span></code> </pre> <br><p>  Ce qui fait que l' <code>App</code> ressemble à ceci </p><br><pre> <code class="javascript hljs">&lt;div&gt; {field.map(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">row, rowI</span></span></span><span class="hljs-function">) =&gt;</span></span> ( <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">key</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{rowI}</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> {row.map((cell, cellI) =&gt; ( </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Cell</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">key</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{</span></span></span></span><span class="xml"><span class="hljs-tag">`</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">row</span></span></span></span><span class="xml"><span class="hljs-tag">${</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rowI</span></span></span></span><span class="xml"><span class="hljs-tag">}</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">cell</span></span></span></span><span class="xml"><span class="hljs-tag">${</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">cellI</span></span></span></span><span class="xml"><span class="hljs-tag">}`} </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">content</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{cell}</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rowI</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{rowI}</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">cellI</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{cellI}</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">setContent</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{setCell}</span></span></span></span><span class="xml"><span class="hljs-tag"> /&gt;</span></span></span><span class="xml"> ))} </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> ))} </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre> <br><p>  <code>Cell</code> doit maintenant passer <code>cellI</code> et <code>rowI</code> à <code>setContent</code> . </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Cell = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">{ content, rowI, cellI, setContent }</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'cell render'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> &lt;div onClick={(</span></span></span><span class="hljs-function">) =&gt;</span></span> setContent(rowI, cellI, randomContent())}&gt; {content} &lt;<span class="hljs-regexp"><span class="hljs-regexp">/div&gt; ) }</span></span></code> </pre> <br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Démo en direct # 4</a> </p><br><p>  Jetons un coup d'œil au rapport DevTools. </p><br><p><img src="https://habrastorage.org/webt/63/i5/po/63i5poiao3t3rt62mr_zubgycjw.png" alt="Rapport ReaT DevTools # 2"></p><br><p>  Quoi?!  Pourquoi diable dit-il "les accessoires des parents ont changé"?  Donc, chaque fois que notre champ est mis à jour, l' <code>App</code> est restituée.  Par conséquent, ses composants enfants sont restitués.  Ok  Le stackoverflow dit-il quelque chose d'utile sur l'optimisation des performances de React?  Internet suggère d'utiliser <code>shouldComponentUpdate</code> ou ses proches: <code>PureComponent</code> et <code>memo</code> . </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Cell = memo(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">{ content, rowI, cellI, setContent }</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'cell render'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> &lt;div onClick={(</span></span></span><span class="hljs-function">) =&gt;</span></span> setContent(rowI, cellI, randomContent())}&gt; {content} &lt;<span class="hljs-regexp"><span class="hljs-regexp">/div&gt; ) })</span></span></code> </pre> <br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Démo en direct # 5</a> </p><br><p>  Ouais  Désormais, une seule cellule est restituée une fois son contenu modifié.  Mais attendez ... Y a-t-il eu une surprise?  Nous avons suivi les meilleures pratiques et obtenu le résultat attendu. </p><br><p>  Un rire diabolique était censé être ici.  Comme je ne suis pas avec vous, je vous en prie, essayez le plus possible de l'imaginer.  Allez-y et augmentez la <code>size</code> dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">démo</a> en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">direct # 5</a> .  Cette fois, vous devrez peut-être choisir un nombre un peu plus élevé.  Cependant, le décalage est toujours là.  Pourquoi ??? </p><br><p>  Jetons à nouveau un œil au rapport DebTools. </p><br><p><img src="https://habrastorage.org/webt/ls/w8/gs/lsw8gsgvp_bnjvnxjramglhrnng.png" alt="Rapport ReaT DevTools # 3"></p><br><p>  Il n'y a qu'un seul rendu de <code>Cell</code> et c'était assez rapide, mais il y a aussi un rendu d' <code>App</code> , qui a pris un certain temps.  Le fait est qu'à chaque re-rendu de l' <code>App</code> chaque <code>Cell</code> doit comparer ses nouveaux accessoires avec ses accessoires précédents.  Même s'il décide de ne pas rendre (ce qui est précisément notre cas), cette comparaison prend encore du temps.  O (1), mais que O (1) se produit <code>size</code> * <code>size</code> fois! </p><br><h2 id="step-2-move-it-down">  Étape 2: déplacez-le vers le bas </h2><br><p>  Que pouvons-nous faire pour contourner ce problème?  Si le rendu de l' <code>App</code> nous coûte trop cher, nous devons arrêter le rendu de l' <code>App</code> .  Ce n'est pas possible si vous continuez à héberger notre état dans l' <code>App</code> aide de <code>useState</code> , car c'est exactement ce qui déclenche le nouveau rendu.  Nous devons donc déplacer notre état vers le bas et laisser chaque <code>Cell</code> souscrire à l'état de son propre chef. </p><br><p>  Créons une classe dédiée qui sera un conteneur pour notre état. </p><br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Field</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(fieldSize) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.size = fieldSize <span class="hljs-comment"><span class="hljs-comment">// Copy-paste from `initialState` this.data = new Array(this.size).fill(new Array(this.size).fill(undefined)) } cellContent(rowI, cellI) { return this.data[rowI][cellI] } // Copy-paste from old `setCell` setCell(rowI, cellI, newContent) { console.log('setCell') this.data = [ ...this.data.slice(0, rowI), [ ...this.data[rowI].slice(0, cellI), newContent, ...this.data[rowI].slice(cellI + 1), ], ...this.data.slice(rowI + 1), ] } map(cb) { return this.data.map(cb) } } const field = new Field(size)</span></span></code> </pre> <br><p>  Ensuite, notre <code>App</code> pourrait ressembler à ceci: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> App = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> &lt;div&gt; {</span></span><span class="hljs-regexp"><span class="hljs-function"><span class="hljs-params"><span class="hljs-regexp">//</span></span></span></span><span class="hljs-function"><span class="hljs-params"> As you can see we still need to iterate over our state to get indexes. field.map((row, rowI</span></span></span><span class="hljs-function">) =&gt;</span></span> ( <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">key</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{rowI}</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> {row.map((cell, cellI) =&gt; ( </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Cell</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">key</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{</span></span></span></span><span class="xml"><span class="hljs-tag">`</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">row</span></span></span></span><span class="xml"><span class="hljs-tag">${</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rowI</span></span></span></span><span class="xml"><span class="hljs-tag">}</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">cell</span></span></span></span><span class="xml"><span class="hljs-tag">${</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">cellI</span></span></span></span><span class="xml"><span class="hljs-tag">}`} </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rowI</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{rowI}</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">cellI</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{cellI}</span></span></span></span><span class="xml"><span class="hljs-tag"> /&gt;</span></span></span><span class="xml"> ))} </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> ))} </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> ) }</code> </pre> <br><p>  Et notre <code>Cell</code> peut afficher le contenu du <code>field</code> de son propre chef: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Cell = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">{ rowI, cellI }</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'cell render'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> content = field.cellContent(rowI, cellI) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> &lt;div onClick={(</span></span></span><span class="hljs-function">) =&gt;</span></span> field.setCell(rowI, cellI, randomContent())}&gt; {content} &lt;<span class="hljs-regexp"><span class="hljs-regexp">/div&gt; ) }</span></span></code> </pre> <br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Démo en direct # 6</a> </p><br><p>  À ce stade, nous pouvons voir notre champ rendu.  Cependant, si nous cliquons sur une cellule, rien ne se passe.  Dans les journaux, nous pouvons voir "setCell" pour chaque clic, mais la cellule reste vide.  La raison ici est que rien ne dit à la cellule de restituer.  Notre état en dehors de React change, mais React ne le sait pas.  Cela doit changer. </p><br><p>  Comment déclencher un rendu par programme? </p><br><p>  Avec les classes, nous avons <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">forceUpdate</a> .  Cela signifie-t-il que nous devons réécrire notre code dans les classes?  Pas vraiment.  Ce que nous pouvons faire avec les composants fonctionnels est d'introduire un état factice, que nous changeons uniquement pour forcer notre composant à être restitué. </p><br><p>  Voici comment nous pouvons créer un hook personnalisé pour forcer les rendus. </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> useForceRender = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> [, setDummy] = useState(<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> forceRender = useCallback(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> setDummy(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">oldVal</span></span></span><span class="hljs-function">) =&gt;</span></span> oldVal + <span class="hljs-number"><span class="hljs-number">1</span></span>), []) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> forceRender }</code> </pre> <br><p>  Pour déclencher un nouveau rendu lorsque notre champ est mis à jour, nous devons savoir quand il est mis à jour.  Cela signifie que nous devons être en mesure de souscrire en quelque sorte aux mises à jour sur le terrain. </p><br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Field</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(fieldSize) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.size = fieldSize <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.data = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.size).fill(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.size).fill(<span class="hljs-literal"><span class="hljs-literal">undefined</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.subscribers = {} } _cellSubscriberId(rowI, cellI) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">`row</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${rowI}</span></span></span><span class="hljs-string">cell</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${cellI}</span></span></span><span class="hljs-string">`</span></span> } cellContent(rowI, cellI) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.data[rowI][cellI] } setCell(rowI, cellI, newContent) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'setCell'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.data = [ ...this.data.slice(<span class="hljs-number"><span class="hljs-number">0</span></span>, rowI), [ ...this.data[rowI].slice(<span class="hljs-number"><span class="hljs-number">0</span></span>, cellI), newContent, ...this.data[rowI].slice(cellI + <span class="hljs-number"><span class="hljs-number">1</span></span>), ], ...this.data.slice(rowI + <span class="hljs-number"><span class="hljs-number">1</span></span>), ] <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> cellSubscriber = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.subscribers[<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._cellSubscriberId(rowI, cellI)] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cellSubscriber) { cellSubscriber() } } map(cb) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.data.map(cb) } <span class="hljs-comment"><span class="hljs-comment">// Note that we subscribe not to updates of the whole filed, but to updates of one cell only subscribeCellUpdates(rowI, cellI, onSetCellCallback) { this.subscribers[this._cellSubscriberId(rowI, cellI)] = onSetCellCallback } }</span></span></code> </pre> <br><p>  Maintenant, nous pouvons nous abonner aux mises à jour sur le terrain. </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Cell = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">{ rowI, cellI }</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'cell render'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> forceRender = useForceRender() useEffect(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> field.subscribeCellUpdates(rowI, cellI, forceRender), [ forceRender, ]) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> content = field.cellContent(rowI, cellI) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> &lt;div onClick={(</span></span></span><span class="hljs-function">) =&gt;</span></span> field.setCell(rowI, cellI, randomContent())}&gt; {content} &lt;<span class="hljs-regexp"><span class="hljs-regexp">/div&gt; ) }</span></span></code> </pre> <br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Démo en direct # 7</a> </p><br><p>  Jouons avec la <code>size</code> avec cette implémentation.  Essayez de l'augmenter aux valeurs qui semblaient léthargées auparavant.  Et ... Il est temps d'ouvrir une bonne bouteille de champagne!  Nous nous sommes procuré une application qui rend une cellule et une cellule uniquement lorsque l'état de cette cellule change! </p><br><p>  Jetons un coup d'œil au rapport DevTools. </p><br><p><img src="https://habrastorage.org/webt/qm/yw/3y/qmyw3yetdbimipruhngx5pa_chu.png" alt="Rapport ReaT DevTools # 4"></p><br><p>  Comme nous pouvons le voir maintenant, seul <code>Cell</code> est rendu et c'est rapide et fou. </p><br><p>  Et si dire que maintenant le code de notre <code>Cell</code> est une cause potentielle d'une fuite de mémoire?  Comme vous pouvez le voir, dans <code>useEffect</code> nous souscrivons aux mises à jour des cellules, mais nous ne nous désinscrivons jamais.  Cela signifie que même lorsque <code>Cell</code> est détruit, son abonnement perdure.  Changeons cela. </p><br><p>  Tout d'abord, nous devons enseigner à <code>Field</code> ce que signifie se désinscrire. </p><br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Field</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... unsubscribeCellUpdates(rowI, cellI) { delete this.subscribers[this._cellSubscriberId(rowI, cellI)] } }</span></span></code> </pre> <br><p>  Nous pouvons maintenant appliquer <code>unsubscribeCellUpdates</code> à notre <code>Cell</code> . </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Cell = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">{ rowI, cellI }</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'cell render'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> forceRender = useForceRender() useEffect(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { field.subscribeCellUpdates(rowI, cellI, forceRender) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> field.unsubscribeCellUpdates(rowI, cellI) }, [forceRender]) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> content = field.cellContent(rowI, cellI) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> &lt;div onClick={(</span></span></span><span class="hljs-function">) =&gt;</span></span> field.setCell(rowI, cellI, randomContent())}&gt; {content} &lt;<span class="hljs-regexp"><span class="hljs-regexp">/div&gt; ) }</span></span></code> </pre> <br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Démo en direct # 8</a> </p><br><p>  Alors quelle est la leçon ici?  Quand est-il judicieux de déplacer l'état dans l'arborescence des composants?  Jamais!  Eh bien, pas vraiment :) Tenez-vous en aux bonnes pratiques jusqu'à ce qu'elles échouent et ne faites aucune optimisation prématurée.  Honnêtement, le cas que nous avons examiné ci-dessus est quelque peu spécifique, cependant, j'espère que vous vous en souviendrez si vous avez besoin d'afficher une très grande liste. </p><br><h2 id="bonus-step-real-world-refactoring">  Étape bonus: refactoring dans le monde réel </h2><br><p>  Dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">démo en direct # 8,</a> nous avons utilisé le <code>field</code> global, ce qui ne devrait pas être le cas dans une application réelle.  Pour le résoudre, nous pourrions héberger un <code>field</code> dans notre <code>App</code> et le transmettre dans l'arborescence à l'aide de [context] (). </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> AppContext = createContext() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> App = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-comment"><span class="hljs-comment">// Note how we used a factory to initialize our state here. // Field creation could be quite expensive for big fields. // So we don't want to create it each time we render and block the event loop. const [field] = useState(() =&gt; new Field(size)) return ( &lt;AppContext.Provider value={field}&gt; &lt;div&gt; {field.map((row, rowI) =&gt; ( &lt;div key={rowI}&gt; {row.map((cell, cellI) =&gt; ( &lt;Cell key={`row${rowI}cell${cellI}`} rowI={rowI} cellI={cellI} /&gt; ))} &lt;/div&gt; ))} &lt;/div&gt; &lt;/AppContext.Provider&gt; ) }</span></span></code> </pre> <br><p>  Maintenant, nous pouvons consommer le <code>field</code> du contexte dans notre <code>Cell</code> . </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Cell = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">{ rowI, cellI }</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'cell render'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> forceRender = useForceRender() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> field = useContext(AppContext) useEffect(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { field.subscribeCellUpdates(rowI, cellI, forceRender) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> field.unsubscribeCellUpdates(rowI, cellI) }, [forceRender]) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> content = field.cellContent(rowI, cellI) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> &lt;div onClick={(</span></span></span><span class="hljs-function">) =&gt;</span></span> field.setCell(rowI, cellI, randomContent())}&gt; {content} &lt;<span class="hljs-regexp"><span class="hljs-regexp">/div&gt; ) }</span></span></code> </pre> <br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Démo en direct # 9</a> </p><br><p>  J'espère que vous avez trouvé quelque chose d'utile pour votre projet.  N'hésitez pas à me faire part de vos retours!  J'apprécie très certainement toute critique et question. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr471300/">https://habr.com/ru/post/fr471300/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr471282/index.html">Recherche de pneumonie aux rayons X avec Fast.ai</a></li>
<li><a href="../fr471288/index.html">Création du visage d'un personnage pour le jeu "OnAir"</a></li>
<li><a href="../fr471294/index.html">Poèmes sur Haskell, C ++ et les programmeurs</a></li>
<li><a href="../fr471296/index.html">Lean Manufacturing - Un outil pour l'efficacité</a></li>
<li><a href="../fr471298/index.html">Bieber et Bilan agitent un stylo. AI chante maintenant des chansons</a></li>
<li><a href="../fr471302/index.html">Vérification des utilisateurs en Chine et crédit social</a></li>
<li><a href="../fr471304/index.html">Empire ERP. Comptabilité divertissante: grand livre, comptes, solde</a></li>
<li><a href="../fr471306/index.html">Développement du plugin VPN Continent-AP pour Sailfish OS</a></li>
<li><a href="../fr471310/index.html">Mon opinion très subjective sur la formation professionnelle et pas seulement en informatique</a></li>
<li><a href="../fr471312/index.html">Préparation à la certification professionnelle du printemps. Botte de printemps</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>