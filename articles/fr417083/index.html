<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚è© ü¶è üë®‚Äç‚öïÔ∏è Fortes charges de la Coupe du monde 2018 üï∏Ô∏è üó∫Ô∏è üéê</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="La derni√®re Coupe du Monde de la FIFA 2018 en Russie a apport√© de lourdes charges non seulement aux p√¥les de transport du pays, mais √©galement √† l'inf...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Fortes charges de la Coupe du monde 2018</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/417083/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/f6/ai/wy/f6aiwyf_p22fasac5t1n7plgxts.jpeg"></div><br>  La derni√®re Coupe du Monde de la FIFA 2018 en Russie a apport√© de lourdes charges non seulement aux p√¥les de transport du pays, mais √©galement √† l'infrastructure informatique du plus grand diffuseur russe, qui a rendu les matchs disponibles sous forme de diffusion en ligne.  Nous avons relev√© avec int√©r√™t un nouveau d√©fi qui est venu aux serveurs desservis avec la fi√®vre du football. <a name="habracut"></a><br><br><h2>  Avant-propos: des charges √©lev√©es? </h2><br>  Les conversations sur la charge √©lev√©e commencent souvent par des r√©flexions sur le sujet, quelles charges peuvent √† juste titre √™tre consid√©r√©es comme ¬´√©lev√©es¬ª: des milliers de requ√™tes par seconde pour la dynamique?  Ou m√™me un petit nombre de demandes par rapport aux ressources disponibles?  Des millions de visiteurs par jour?  Des centaines de n≈ìuds de charge de travail dans un cluster? .. <br><br>  Pour se faire une id√©e de "l'ampleur de la catastrophe", le fait que nous parlions d'utilisateurs visionnant <b>simultan√©ment</b> l'√©mission, dont le nombre a atteint la barre des <b>2 millions</b> , devrait suffire.  Que s'est-il pass√© si vous regardez les retransmissions de matches ¬´de l'int√©rieur¬ª, et comment avez-vous r√©ussi √† faire face √† un trafic sans pr√©c√©dent? <br><br><h2>  Trois baleines </h2><br><h3>  1. Architecture du site et syst√®mes de traduction </h3><br>  Le sch√©ma g√©n√©ral d'interaction entre l'utilisateur final et le syst√®me de traduction est r√©duit au sch√©ma suivant: <br><br><ul><li>  L'utilisateur vient sur le site o√π le lecteur est lanc√© pour regarder la vid√©o.  Le lecteur lui-m√™me est √©crit en JavaScript et son chargement entra√Æne de nombreuses demandes de statistiques, ainsi que diverses API li√©es aux traductions. </li><li>  Entre autres choses, il y a un appel √† l'√©quilibreur pour une liste de lecture √† lire. </li><li>  Une liste de lecture est un ensemble constamment mis √† jour de courts fragments vid√©o qui sont mis en cache sur les serveurs CDN. </li><li>  Lorsque vous regardez la vid√©o d‚Äôun utilisateur en temps r√©el, diverses statistiques sont collect√©es, qui sont notamment prises en compte pour l‚Äô√©quilibrage de charge par CDN (ainsi que la bande passante disponible r√©elle). </li></ul><br>  L'architecture de distribution directe de la vid√©o a √©t√© con√ßue et mise en ≈ìuvre par les forces internes des ing√©nieurs du client avant m√™me le d√©but de notre coop√©ration.  Plus tard, en plus du service lui-m√™me, nous avons √©t√© engag√©s dans la conception et la mise en service de l'infrastructure de certains de ses composants, ainsi que du site lui-m√™me, qui joue un r√¥le important dans le sch√©ma global. <br><br>  Le site, lanc√© en production il y a plusieurs ann√©es, est ax√© sur l'√©volutivit√© horizontale - y compris de nombreux centres de donn√©es: <br><br><img src="https://habrastorage.org/webt/bc/gn/yj/bcgnyjjy1ypstqp2vp3pnltpidk.png"><br><br>  Le sch√©ma pr√©sent√© ici est simplifi√© et vise √† d√©montrer la nature de l'√©volutivit√© du site, dont les composants sont r√©partis sur diff√©rents centres de donn√©es. <br><br><h3>  2. CDN </h3><br>  Revenant √† regarder r√©ellement la vid√©o, il est √©vident que la charge principale tombe sur les serveurs CDN.  Dans les chiffres de la derni√®re Coupe du monde, nous parlons d'un trafic constant, mesur√© en <b>t√©rabits par seconde</b> .  Et √† bien des √©gards, le succ√®s du travail de traductions avec des pics de charge est d√ª √† la mise en cache sur le CDN de tout ce qui peut leur √™tre transf√©r√©, et √† la minimisation des co√ªts de ressources (r√©seau, CPU, RAM, ...) d'autres op√©rations. <br><br>  De plus, un point important dans le travail avec CDN est l'interaction avec leur API pour obtenir des informations pertinentes sur la bande passante totale et disponible.  Dans le syst√®me de diffusion, ces donn√©es sont utilis√©es pour distribuer de nouveaux t√©l√©spectateurs et redistribuer les actuels. <br><br>  Donc, si les serveurs CDN peuvent fournir suffisamment de bande passante √† des millions de t√©l√©spectateurs Internet, alors quand des probl√®mes peuvent-ils se produire?  Pendant le championnat, nous avons observ√© deux sc√©narios principaux: <br><br><ol><li>  Pour une raison quelconque, il y a un d√©calage dans la diffusion. <br><br>  <i>Par exemple, les param√®tres du syst√®me ont tellement ¬´jou√©¬ª lors d'un match de championnat que le service de protection DDoS, qui ne s'attendait pas √† une charge soudaine, a commenc√© √† consid√©rer ce qui se passait comme une attaque, bloquant la disponibilit√© des serveurs CDN l'un apr√®s l'autre ... jusqu'√† ce qu'il soit inform√© que la situation √©tait dans un sens extr√™me, mais toujours √† plein temps (les conclusions n√©cessaires ont √©t√© tir√©es - dans les √©missions suivantes, la situation ne s'est pas r√©p√©t√©e).</i> <br><br>  √Ä de tels moments, tous les utilisateurs qui sont d√©pass√©s par un probl√®me massif commencent √† rafra√Æchir la page avec le lecteur. </li><li>  Un but marqu√© (en particulier le premier), en r√®gle g√©n√©rale, provoque un afflux √©norme de spectateurs dans un laps de temps limit√©. <br><br>  <i>Si nous parlons de chiffres plus sp√©cifiques, un tel afflux s'est √©lev√© √† des centaines de milliers d'utilisateurs en 1-1,5 minutes.</i> </li></ol><br>  Ces deux cas ont g√©n√©r√© de fortes pointes dans les demandes de contenu de site dynamique qui devaient √™tre g√©r√©es par les ressources disponibles.  Comment ces probl√®mes ont-ils √©t√© suivis et r√©solus? <br><br><h3>  3. Surveillance et statistiques en temps r√©el </h3><br>  Il est possible de plaisanter avec un degr√© de v√©rit√© significatif que pendant toute la dur√©e du championnat, nous avons eu un poste sp√©cial, dont les t√¢ches comprenaient l'observation attentive du football sur le lieu de travail.  Bien s√ªr, il ne s'agissait pas tant du football en tant que tel, mais de la r√©action rapide √† tout incident provoqu√© par des matches ou d'autres circonstances ... <br><br>  Quelles sont les ¬´autres circonstances¬ª?  Lors de tels √©v√©nements publics, m√™me l'influence de la m√©t√©o est perceptible.  Voici deux exemples du championnat que nous avons rencontr√©: <br><br><ol><li>  Lorsqu'un orage a commenc√© pendant l'un des matches, les fournisseurs de t√©l√©vision par satellite ont eu des probl√®mes d'√©quipement (ils n'ont pas pu envoyer de signal).  Cela a entra√Æn√© une augmentation sensible du trafic (environ 10%) en peu de temps, car √† la recherche d'une solution alternative urgente, les t√©l√©spectateurs ont commenc√© √† se connecter massivement en ligne et √† continuer √† y naviguer. </li><li>  Quand il a commenc√© √† pleuvoir pendant le match final, un petit saut (environ 3%) dans la d√©connexion et la reconnexion des utilisateurs (apr√®s environ 5 minutes) √©tait perceptible.  Dans ce cas, aucun probl√®me n'a √©t√© observ√© dans l'√©mission elle-m√™me, c'est-√†-dire que les raisons du saut n'avaient pas de base technique.  L'hypoth√®se est que les spectateurs qui ont regard√© le football dans la rue (comme moi-m√™me) sont entr√©s dans la salle √† cause de la pluie, et pendant cette br√®ve p√©riode, ils ont √©t√© d√©connect√©s de l'√©mission. </li></ol><br>  Revenant au sujet de la surveillance elle-m√™me - pendant toute la dur√©e du championnat, la <b>pratique de r√©unions r√©guli√®res (apr√®s chaque diffusion de pointe) a</b> √©t√© prise comme norme avec les d√©veloppeurs, qui ont analys√© toutes les situations critiques (ou proches de celles-ci) et leurs cons√©quences - afin de minimiser les probl√®mes potentiels dans la prochaine fois.  Quels serveurs / services √©taient √† la limite?  Quelles requ√™tes √©taient particuli√®rement exigeantes?  Quelles demandes peuvent √™tre supprim√©es (transf√©r√©es sur CDN pour mettre en cache pendant quelques secondes)?  Quelles demandes peuvent √™tre mises en cache plus longtemps (toutes les 3 minutes, pas par minute)?  Que se passera-t-il avec l'augmentation pr√©vue du nombre de t√©l√©spectateurs, car la Russie jouera? .. <br><br>  <i><b>En parlant</b> de Russie.</i>  <i>Comme vous pouvez le deviner, en moyenne plusieurs fois plus de personnes sont venues aux matches avec l'√©quipe nationale russe que les autres.</i>  <i>Et plus notre √©quipe montait dans le classement du tournoi, plus il √©tait difficile de combiner notre joie dans cette affaire avec l'ex√©cution de t√¢ches imm√©diates - parce que tout √©tait compliqu√© par la croissance inlassable du public.</i>  <i>Malgr√© le fait que le syst√®me a √©t√© con√ßu pour supporter des charges √©normes, dans le cadre d'un horaire de travail normal, elles ne se produisent pas si souvent (moins de 10 fois par an) ... et dans le cas de la Coupe du monde, nous avons observ√© des pics de charge presque quotidiens pendant un mois.</i>  <i>L'avantage de ce mode, cependant, √©tait les larges possibilit√©s de d√©tection de goulots d'√©tranglement r√©els qui ne sont d√©tect√©s qu'aux moments de telles charges.</i> <br><br>  Donc, si une partie des probl√®mes purement techniques a √©t√© supprim√©e par les graphiques standard des syst√®mes de surveillance, alors dans la solution de probl√®mes plus complexes et / ou orient√©s vers la logique m√©tier, les r√©alisations du projet sous le nom interne parlant de "statistiques en temps r√©el" ont jou√© un r√¥le important. <br><br><h4>  Statistiques en temps r√©el </h4><br>  Cette composante importante de l'infrastructure de diffusion Internet a √©t√© con√ßue et mise en ≈ìuvre par nos efforts pour fournir un outil de veille strat√©gique pour les donn√©es techniques collect√©es aupr√®s des joueurs dans lesquelles les utilisateurs regardent des vid√©os.  √Ä la base, c'est un syst√®me de journalisation qui: <br><br><ul><li>  recueille toutes sortes de donn√©es disponibles sur les utilisateurs (navigateur, IP, etc. - pour simplifier, nous pouvons dire que ce sont les caract√©ristiques que nous avons utilis√©es pour examiner les statistiques sur l'audience du site); </li><li>  les compl√®te avec des donn√©es techniques sur la diffusion (d√©bit binaire, etc.) et les √©v√©nements / probl√®mes survenus (commutation CDN, pannes de visualisation ...); </li><li>  fournit √† l'√©quilibreur des donn√©es pour un √©quilibrage de charge optimal sur les serveurs CDN (en fonction des caract√©ristiques de chaque utilisateur); </li><li>  envoie les alertes n√©cessaires aux ing√©nieurs de garde et cr√©e des graphiques commerciaux utiles. </li></ul><br>  Le dernier point est le plus int√©ressant, car: <br><br><ol><li>  <b>Les alertes de</b> ce syst√®me de statistiques sont un √©l√©ment cl√© du suivi qui vous permet de vous ¬´tenir au courant¬ª des indicateurs pratiques lors des diffusions.  En les analysant (dans un lieu o√π l'automatisation ne suffit pas), le pr√©pos√© prend les d√©cisions appropri√©es pour am√©liorer la qualit√© de service en temps r√©el.  <i>Par exemple:</i> <br><ul><li>  <i>De nombreux utilisateurs sont-ils pass√©s du m√™me serveur CDN?</i>  <i>Il doit √™tre temporairement d√©sactiv√© de la rotation (ou contactez le fournisseur pour une r√©ponse rapide).</i> </li><li>  <i>Les utilisateurs ont-ils commenc√© √† rencontrer d'√©normes probl√®mes pour regarder des vid√©os?</i>  <i>Il est temps d'analyser d'urgence les causes.</i> </li></ul></li><li>  <b>Les graphiques</b> sont des statistiques commerciales en temps r√©el qui vous permettent de r√©pondre √† des questions cl√©s, telles que: <br><ul><li>  <i>Combien d'utilisateurs ont regard√© la diffusion de derni√®re minute?</i> </li><li>  <i>Quel pourcentage d'utilisateurs a eu des probl√®mes √† la derni√®re minute et quelle √©tait leur nature?</i> </li></ul><br>  √âtant donn√© que des √©v√©nements similaires ont le m√™me profil de graphique, le graphique lui-m√™me vous permet de pr√©dire la croissance du nombre d'utilisateurs au cours des prochaines minutes et de prendre <b>des mesures proactives</b> si n√©cessaire. </li></ol><br>  √âtant donn√© que ces statistiques fonctionnent en temps r√©el et sont essentielles pour la qualit√© de l'ensemble du service, m√™me la simple visualisation de vid√©os par nature par des millions d'utilisateurs ne se r√©sume pas √† leur distribuer du contenu via CDN.  Le SGBD ClickHouse permet d'obtenir un enregistrement rapide des nouvelles donn√©es de nombreux joueurs (nous parlons de dizaines de milliers de requ√™tes par seconde pour l'enregistrement sur chaque serveur), et le Grafana habituel est utilis√© pour les graphiques. <br><br><img src="https://habrastorage.org/webt/uc/y0/j8/ucy0j8ygu0rs2qj50-8my9aucfg.jpeg"><br>  <i>Illustration du ratio de t√©l√©spectateurs de la vid√©o en ligne avant, pendant et apr√®s le match</i> <br><br>  <i><b>Soit dit en passant</b> : une solution de contournement int√©ressante lors des pics de charge consistait √† d√©sactiver HTTPS (en faveur de HTTP) pour les demandes du syst√®me de statistiques, ce qui a entra√Æn√© une double r√©duction de la charge du processeur sur certains serveurs.</i> <br><br><h2>  R√©sum√© </h2><br>  Le succ√®s des diffusions en ligne d'un √©v√©nement d'une telle ampleur <i>(m√™me YouTube TV <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">n'a pas toujours fait face</a> aux charges!)</i> A √©t√© fourni par trois facteurs cl√©s: <br><br><ol><li>  architecture comp√©tente (pour le syst√®me de diffusion et le site), qui, m√™me sans l'utilisation de syst√®mes modernes comme Kubernetes, √©tait initialement orient√©e vers des charges √©lev√©es, une √©volutivit√© et une disponibilit√© pour des rafales importantes; </li><li>  Serveurs CDN avec une bande passante suffisante; </li><li>  une surveillance sp√©cialis√©e qui a permis: a) de suivre les probl√®mes en temps r√©el, b) de fournir les informations n√©cessaires pour les √©viter √† l'avenir. </li></ol><br>  Bien qu'il y ait en fait plus de facteurs ... et l'un d'entre eux, peut-√™tre, est capable de d√©passer tous les facteurs techniques - humains.  Le r√¥le le plus important a √©t√© jou√© par des sp√©cialistes qui ont non seulement r√©ussi √† faire et √† lier tout ce qui est n√©cessaire sur le plan technique, mais aussi √† obtenir inlassablement des r√©sultats, ce que je tiens particuli√®rement √† souligner les m√©rites de la gestion du client. <br><br>  <i><b>PS</b> sur les Kubernetes mentionn√©s ... une histoire que de nombreux lecteurs de notre blog s'attendaient √† voir.</i>  <i>Le processus de migration du syst√®me de radiodiffusion vers celui-ci a d√©j√† commenc√©, mais pendant la Coupe du monde, ces d√©veloppements n'√©taient pas encore impliqu√©s.</i> <br><br><h2>  PPS </h2><br>  Lisez aussi dans notre blog: <br><br><ul><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">10 √©tapes √©videntes pour pr√©parer votre infrastructure de boutique en ligne pour le Black Friday</a> ." </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr417083/">https://habr.com/ru/post/fr417083/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr417071/index.html">Vendredi PHP: Webinaires Skillbox gratuits</a></li>
<li><a href="../fr417073/index.html">Uber Mobile Developer Day</a></li>
<li><a href="../fr417075/index.html">API de peinture CSS</a></li>
<li><a href="../fr417079/index.html">Gestionnaire de packages pour Kubernetes - Helm: Past, Present, Future</a></li>
<li><a href="../fr417081/index.html">Nord, volont√©, espoir, pays sans fronti√®res, ou comment les projets sont r√©alis√©s dans des conditions sib√©riennes s√©v√®res</a></li>
<li><a href="../fr417085/index.html">Les navigateurs coupent le son dans votre application WebRTC. Arr√™te quoi?</a></li>
<li><a href="../fr417087/index.html">HPE Digitize 2018: √©v√©nement et diffusion en direct</a></li>
<li><a href="../fr417089/index.html">Ordinateur quantique: un photon pour tout gouverner</a></li>
<li><a href="../fr417091/index.html">Cr√©ez un shader d'eau de dessin anim√© pour le Web. 3e partie</a></li>
<li><a href="../fr417093/index.html">Interrupteurs tactiles avec Modbus: pourquoi sont-ils n√©cessaires et comment les appliquer dans un appartement intelligent</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>