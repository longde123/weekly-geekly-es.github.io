<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëàüèø üë®‚Äçüë®‚Äçüëß‚Äçüë¶ üõµ O fio de Ariadne: como se apaixonar por JSR-133. Relat√≥rio Yandex „Ä∞Ô∏è üôÜüèº ‚õé</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Processadores multin√∫cleo s√£o comuns. Mais cedo ou mais tarde, qualquer programador pr√°tico ter√° que entrar no labirinto da programa√ß√£o multithread e ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>O fio de Ariadne: como se apaixonar por JSR-133. Relat√≥rio Yandex</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/477074/">  Processadores multin√∫cleo s√£o comuns.  Mais cedo ou mais tarde, qualquer programador pr√°tico ter√° que entrar no labirinto da programa√ß√£o multithread e se encontrar com os "monstros" que a habitam.  Vamos falar sobre por onde come√ßar dessa maneira e quais ferramentas e abordagens ajudar√£o a sair vitoriosas.  Fiz esse relat√≥rio para futuros participantes do <a href="https://ya.cc/7w_Dq">est√°gio durante</a> o <a href="https://ya.cc/7w_Dq">ano inteiro</a> na Yandex. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/veYXsOlYb2A" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  - Meu nome √© Seva Minkov.  Eu trabalho no departamento de infraestrutura em nuvem do departamento de pesquisa.  Eu lido principalmente com o back-end.  Eu escrevo em linguagens diferentes, mas na maioria das vezes s√£o Java e linguagens em execu√ß√£o na Java Virtual Machine (JVM). <br><a name="habracut"></a><br>  Nossa equipe est√° desenvolvendo uma nuvem interna na qual quase todos os servi√ßos Yandex s√£o lan√ßados - conhecidos publicamente como Search, Mail e Alice, al√©m de v√°rios servi√ßos internos, m√°quinas virtuais, al√©m de tarefas de curta dura√ß√£o do MapReduce e tarefas de aprendizado de m√°quina. <br><br>  Nossa nuvem n√£o √© est√°tica: a empresa est√° crescendo, o n√∫mero de servi√ßos e os recursos que consomem est√° aumentando.  E nossa equipe frequentemente enfrenta os desafios de dimensionar e melhorar o desempenho.  Conseguimos isso usando todas as ferramentas dispon√≠veis, incluindo a escala vertical - ou seja, acelerando componentes individuais do sistema at√© reescrever alguns algoritmos de thread √∫nico para que eles trabalhem mais rapidamente.  Fazemos escala horizontal: esmagando o sistema em pequenas partes para obter melhor desempenho adicionando servidores, processadores, n√∫cleos, etc. <br><br>  E a programa√ß√£o multithread nos ajuda muito nisso.  Hoje falaremos sobre ele - de onde veio, por que √© relevante;  o que √© um modelo de mem√≥ria e como ele geralmente √© representado em Java.  Abordaremos alguns aspectos pr√°ticos de como testar seus aplicativos e verificar sua corre√ß√£o. <br><br><img src="https://habrastorage.org/webt/me/f6/9z/mef69z0p-acv-chewvn7tuhphpk.jpeg"><br><br>  Para come√ßar, vamos olhar para este gr√°fico interessante, que mostra as tend√™ncias nas caracter√≠sticas dos microprocessadores nos √∫ltimos 40 anos.  Cerca de 10 a 15 anos atr√°s, quando a grama era mais verde e os processadores eram de rosca √∫nica, um programador comum poderia escrever um programa de rosca √∫nica correto e depois confiar na lei emp√≠rica de Moore.  Ele diz que os processadores s√£o duas vezes mais r√°pidos a cada dois anos.  Como voc√™ pode ver, por volta de 2005, por v√°rias raz√µes, os fabricantes de microprocessadores mudaram para uma arquitetura de v√°rios n√∫cleos e come√ßaram a aumentar o n√∫mero de n√∫cleos l√≥gicos.  E o ganho de desempenho de um √∫nico n√∫cleo deixou de obedecer √† lei de Moore, e o poder de processamento de um n√∫cleo come√ßou a crescer mais lentamente.  Isso fez uma revolu√ß√£o, e os programadores comuns tiveram que usar a programa√ß√£o paralela para usar esse mesmo ganho de desempenho. <br><br>  Como estamos praticando, tentaremos escrever um programa multithread simples e ver por si mesmo como ele funciona. <br><br><img src="https://habrastorage.org/webt/rl/tv/gz/rltvgzwhsnhczo7tlpu5otwekuw.jpeg"><br><br>  Como exemplo, vamos assumir uma tarefa bastante simples de leitura cruzada de registros.  Vamos ter duas vari√°veis ‚Äã‚Äãcompartilhadas X e Y, primeiro inicializadas com o valor padr√£o (zero) e dois fluxos.  Cada thread grava em uma vari√°vel e l√™ outra.  Nesse caso, o Thread1 grava uma unidade em X e l√™ Y. O segundo thread faz o mesmo, apenas para tr√°s. <br><br>  Uma implementa√ß√£o simples de Java pode se parecer com isso. <br><br><img src="https://habrastorage.org/webt/xz/dw/8g/xzdw8gsz8vr8f2p-0dvtdr1y6qw.jpeg"><br><br>  Escreveremos a classe ReadWriteTest, ela ter√° duas vari√°veis ‚Äã‚Äãest√°ticas X e Y. Diretamente no m√©todo principal, constru√≠mos duas threads Thread1 e Thread2, fornecemos a cada uma delas uma fun√ß√£o lambda de entrada que ser√° executada no momento em que a thread for executada.  Coloque o c√≥digo do slide anterior l√° e inicie dois threads. <br><br>  A ordem na qual os threads iniciam √©, de certa forma, imprevis√≠vel.  Depende de como o sistema operacional encadeamentos.  Por conseguinte, podemos ter vers√µes diferentes.  Parece entender como tudo isso funciona, teremos que executar esse programa v√°rias vezes, agregar a sa√≠da e ver com que frequ√™ncia essa ou aquela resposta ser√° encontrada no programa. <br><br><img src="https://habrastorage.org/webt/ij/os/e3/ijose3q1hdbyts7brwd31pujhou.jpeg"><br><h5>  <sup><sub><a href="https://openjdk.java.net/projects/code-tools/jcstress/">Link do slide</a></sub></sup> </h5><br>  Para n√£o reinventar a roda, podemos usar uma ferramenta pronta.  Isso √© chamado jcstress, o utilit√°rio de testes de estresse de concorr√™ncia em Java que faz parte do projeto OpenJDK. <br><br>  Este utilit√°rio fornece alguma estrutura para escrever testes de estresse.  Nesse caso, o c√≥digo do slide anterior √© reescrito com bastante facilidade.  Primeiro, vamos pendurar a anota√ß√£o jcstress Test na classe, o que simplesmente torna nossos scripts de teste vis√≠veis para o utilit√°rio.  Tamb√©m a marcamos com a classe State, que diz que a classe cont√©m dados que podem mudar: sendo modificados e lidos a partir de diferentes fluxos.  Declaramos dois m√©todos, thread1 e thread2, e os marcamos com a anota√ß√£o Actor.  A anota√ß√£o de ator significa que o m√©todo deve ser executado em um encadeamento separado.  jcstress garante que cada m√©todo ser√° executado em um thread separado em exatamente uma inst√¢ncia da classe State.  A ordem na qual eles ser√£o lan√ßados n√£o √© especificada especificamente.  E o resultado ser√° gravado em algum objeto II_Result mostrado no slide.  Podemos assumir que essa √© uma tupla de dois valores num√©ricos, que s√£o apresentados apenas pelo m√©todo de Inje√ß√£o de Depend√™ncia, sobre o qual Kirill falou em um relat√≥rio anterior. <br><br>  Antes de iniciar este teste, vamos pensar sobre quais conclus√µes os comandos podem dar e quais valores podemos adicionar em r1 e em r2. <br><br><img src="https://habrastorage.org/webt/na/ik/dn/naikdng1aeysfm7tc0fe7drjbfs.jpeg"><br><br>  Para fazer isso, usamos o chamado modelo de altern√¢ncia.  De uma forma ou de outra, cada uma das opera√ß√µes: leitura ou escrita, √© realizada em alguma ordem.  Basta apenas percorrer todas essas op√ß√µes e ver quais resultados teremos. <br><br><img src="https://habrastorage.org/webt/i5/4y/fk/i54yfklqj0mjn1jjhkwhqs8vna0.jpeg"><br><br>  Suponha que uma das poss√≠veis variantes de eventos seja que o thread um seja completamente executado antes do thread dois.  Primeiro, adicionamos um a X e lemos zero de Y, pois n√£o havia entradas.  Ent√£o eles escreveram um em Y e leram um de X, j√° que o primeiro fluxo j√° havia conseguido fazer isso. <br><br>  A primeira resposta √© zero e um. <br><br><img src="https://habrastorage.org/webt/ot/7p/ax/ot7paxx6szikzgwp9xjiusgnfny.jpeg"><br><br>  A segunda variante do desenvolvimento de eventos √© exatamente o oposto: o fluxo dois foi executado antes do fluxo um. <br><br><img src="https://habrastorage.org/webt/_r/b5/sg/_rb5sgbawfh8cczgwyz9yzomji8.jpeg"><br><br>  Conseq√ºentemente, obtemos um resultado espelhado de um zero. <br><br><img src="https://habrastorage.org/webt/ja/ft/fi/jaftfi3gbc6cwnliw1nufl66x50.jpeg"><br><br>  Existem cerca de quatro op√ß√µes que d√£o o mesmo resultado quando temos a execu√ß√£o de threads completamente confusa.  Por exemplo, registramos uma unidade em um fluxo em X, no segundo, conseguimos ter uma unidade em Y e calculamos um.  Voc√™ pode ver quais outras op√ß√µes existem como exerc√≠cio em casa. <br><br><img src="https://habrastorage.org/webt/w2/bf/tr/w2bftrexoxplrdq_v81fuxeoxic.jpeg"><br><br>  Parece que examinamos todas as op√ß√µes poss√≠veis, n√£o h√° mais nada.  Vamos executar o utilit√°rio e ver que conclus√£o ele d√°. <br><br><img src="https://habrastorage.org/webt/8-/2k/p7/8-2kp79h_iv-0il5eo9ftko91ye.jpeg"><br><h5>  <sup><sub><a href="https://openjdk.java.net/projects/code-tools/jcstress/">Link do slide</a></sub></sup> </h5><br>  A sa√≠da parece uma tabela.  A primeira coluna lista os resultados que adicionamos em II_Result - o utilit√°rio executa esse c√≥digo milh√µes de vezes - e o n√∫mero de casos em que um resultado espec√≠fico foi encontrado.  Mas provavelmente este relat√≥rio n√£o teria sido se tudo tivesse sido t√£o simples. <br><br>  De fato, nesta conclus√£o, tamb√©m podemos ver o resultado zero-zero, o que √© dif√≠cil de explicar com o modelo de altern√¢ncia.  Parece que uma das op√ß√µes poss√≠veis √© que algu√©m diretamente no c√≥digo de fluxo pegou e reorganizou as linhas. <br><br>  Vamos pensar por que isso aconteceu e como podemos viver com isso.  Pe√ßo tamb√©m que voc√™ preste aten√ß√£o ao fato de que a op√ß√£o one-one foi encontrada especificamente na minha m√°quina extremamente raramente.  Das 130 milh√µes de apresenta√ß√µes, apenas 154 apresenta√ß√µes resultaram no resultado de um.  E, pelo contr√°rio, o zero-zero ocorre com muita frequ√™ncia, em quase 30% dos casos. <br><br><img src="https://habrastorage.org/webt/kw/sb/24/kwsb24gow4nmkjkdtmhzxnnvreo.jpeg"><br><br>  Ent√£o, para resumir alguns resultados intermedi√°rios que todos vimos com voc√™.  Primeiro de tudo, poder√≠amos entender que a intera√ß√£o dos fluxos atrav√©s da mem√≥ria n√£o √© trivial.  O modelo de rota√ß√£o que usamos n√£o funciona.  Vimos algum rearranjo.  Isso pode acontecer por v√°rios motivos. <br><br>  Por exemplo, pudemos ver alguns "efeitos relativ√≠sticos" do ferro.  Isso pode ser pensado da seguinte forma: em um ciclo de clock de um processador de 3 GHz, a luz viaja cerca de 10 cm no v√°cuo. O protocolo de leitura e grava√ß√£o na mem√≥ria do processador √© complicado e, √†s vezes, s√£o necess√°rias centenas de ciclos de clock para transferir o valor de um n√∫cleo para outro.  Assim, um n√∫cleo pode parecer ver o passado.  O resultado ap√≥s o registro ocorreu, mas vemos o valor antigo.  Al√©m disso, os processadores tamb√©m n√£o ficam parados e podem alterar as instru√ß√µes em alguns locais. <br><br>  Compiladores otimizadores modernos podem levar √† mesma permuta√ß√£o.  Para alcan√ßar o desempenho m√°ximo de thread √∫nico, eles tamb√©m podem trocar instru√ß√µes para que isso n√£o prejudique a corre√ß√£o de um programa de thread √∫nico.  Mas em programas multithread pode levar a efeitos interessantes que vimos. <br><br>  E a segunda - provavelmente a principal conclus√£o: vimos que programas multithread n√£o s√£o determinados fundamentalmente.  Os programas de thread √∫nico dependem principalmente de alguns invariantes na entrada e na sa√≠da e s√£o determin√≠sticos;  dado que o gerador de n√∫meros aleat√≥rios e a entrada do usu√°rio s√£o par√¢metros de entrada. <br><br>  Isso torna as coisas muito complicadas: √© dif√≠cil entender o que o programa faz e √© dif√≠cil test√°-lo. <br><br>  Sobre a complexidade dos testes, podemos acrescentar que o mesmo resultado foi encontrado apenas 154 vezes em 130 milh√µes de chamadas.  A probabilidade de ocorr√™ncia desse resultado √© de um milion√©simo.  Na produ√ß√£o, isso significa que esse bug pode ser reproduzido ap√≥s semanas.  E certamente acontecer√° em algum lugar no domingo √† noite, quando voc√™ n√£o esperava isso. <br><br><img src="https://habrastorage.org/webt/sd/u8/hg/sdu8hgj5xiqhrnnganz3ltxzyp0.jpeg"><br><br>  Vamos pensar em como devemos ser e o que geralmente queremos da nossa l√≠ngua para dormir em paz no domingo √† noite.  Primeiro, precisamos de uma ferramenta que nos permita prever o comportamento do programa e fazer julgamentos sobre sua execu√ß√£o.  Em segundo lugar, precisamos de ferramentas de linguagem que nos permitam influenciar as permuta√ß√µes e efeitos - eles podem ser do hardware, do compilador etc. Gostaria de saber menos sobre como um processador espec√≠fico funciona, quais otimiza√ß√µes o compilador pode fazer e usar a abrevia√ß√£o que vieram do mundo Java.  Escreva uma vez, execute em qualquer lugar - escreva uma vez o c√≥digo multithread correto para que ele funcione em todas as plataformas. <br><br><img src="https://habrastorage.org/webt/tx/lr/du/txlrdugf3x6nxzxnraij4qn9yzq.jpeg"><br><br>  Essas perguntas e requisitos que listamos surgiram nas mentes dos desenvolvedores por muito tempo, te√≥ricos e profissionais.  Como qualquer tarefa complexa com um alto n√≠vel de complexidade, ela foi resolvida com a introdu√ß√£o do conceito de alguma m√°quina abstrata.  Todos n√≥s, desenvolvedores de linguagens de programa√ß√£o de alto n√≠vel, n√£o escrevemos para nenhum hardware espec√≠fico, nem para um modelo de processador, mas escrevemos alguma m√°quina abstrata.  E a especifica√ß√£o da linguagem √© projetada para descrever seu comportamento de maneira a reconciliar esses tr√™s mundos.  Por um lado, permita que desenvolvedores de compiladores e processadores fa√ßam suas otimiza√ß√µes e expliquem levemente seus c√©rebros para n√≥s, programadores que j√° escrevem em um idioma espec√≠fico. <br><br>  O modelo de mem√≥ria ocupa uma posi√ß√£o central nesta m√°quina abstrata.  Ela deve responder a uma pergunta: se eu ler uma vari√°vel X em algum fluxo, o resultado de qual das √∫ltimas entradas posso ver l√°?  Uma tentativa de formalizar o modelo de mem√≥ria foi feita pela primeira vez na linguagem Java; todos os outros modelos de mem√≥ria apareceram posteriormente.  Digamos que o C ++ 11 seja quase uma pasta de c√≥pia do modelo de mem√≥ria Java com algumas altera√ß√µes. <br><br>  Havia v√°rios modelos de mem√≥ria em Java.  Inicialmente, o chamado modelo de mem√≥ria em forma de sino, foi reconhecido como malsucedido, pois dificultava o trabalho dos programadores que escrevem em Java e proibia algumas otimiza√ß√µes para o compilador, que s√£o bastante apropriadas para si.  Consequentemente, como parte do processo da comunidade JSR-133, um modelo de mem√≥ria moderno foi escrito. <br><br>  Como temos as escrituras na forma de uma especifica√ß√£o, vamos tentar examin√°-las e entender o que realmente est√° acontecendo por dentro. <br><br><img src="https://habrastorage.org/webt/3f/w6/qi/3fw6qiwjhoeqgtrdn3jngdqntfs.jpeg"><br><br>  H√° algum problema.  Levante as m√£os, quem abriu a especifica√ß√£o do idioma e leu o que estava acontecendo l√°.  E quantos de voc√™s leram o modelo de mem√≥ria do par√°grafo 17.4?  Uma pequena surpresa espera por voc√™.  A especifica√ß√£o da linguagem √© basicamente descrita em uma linguagem bastante compreens√≠vel.  Mas o modelo de mem√≥ria est√° cheio, digamos, de algum hardcore matem√°tico.  Existem inclus√µes em grego, muitos termos matem√°ticos do fechamento transitivo da s√©rie, a uni√£o de duas ordens, etc. <br><br>  Infelizmente, n√£o h√° outro caminho.  A √∫nica coisa em que voc√™ pode confiar ao escrever programas multithread √© a especifica√ß√£o.  Ela ter√° que ler e entender.  Eu recomendo voc√™.  Al√©m disso, quando li a especifica√ß√£o pela primeira vez, tive essas impress√µes. <br><br>  Por que isso √© t√£o dif√≠cil?  Eu segui o caminho errado e te aviso muito para agir como eu. <br><br>  Eu peguei, procurei na Internet o que √© um modelo de mem√≥ria.  Encontrei um livro chamado JSR-133 Cookbook for Compiler Writers.  Ela descreve como um desenvolvedor de compilador pode implementar esse modelo de mem√≥ria de maneira simples.  O problema √© que esta √© uma implementa√ß√£o espec√≠fica e n√£o pode ser usada para julgar o modelo de mem√≥ria inteiro em geral. <br><br>  De qualquer forma, vamos tentar fazer uma pequena tentativa nas principais conclus√µes que podem ser entendidas no modelo de mem√≥ria Java. <br><br><img src="https://habrastorage.org/webt/ii/tn/by/iitnbypnfohtdb0y3gyxuhv1fea.jpeg"><br><br>  Pode haver muitas execu√ß√µes do seu programa multithread.  N√≥s mesmos vimos isso no exemplo de nosso programa antes.  No exemplo mais simples, j√° tivemos quatro resultados de sua implementa√ß√£o.  E a tarefa do modelo de mem√≥ria Java √© dizer qual dessas execu√ß√µes est√° correta e qual delas deve ser proibida.  E postula tr√™s coisas.  A primeira √© que, dentro da estrutura de um thread, sua tarefa √© executada pseudo-seq√ºencialmente.  Isso implica que o compilador pode trocar opera√ß√µes, o processador tamb√©m pode executar instru√ß√µes em paralelo, troc√°-las.  Mas eles devem fazer isso para que os efeitos vis√≠veis da execu√ß√£o do seu programa sejam os mesmos, como se fossem executados diretamente seq√ºencialmente. <br><br>  Em segundo lugar, os chamados significados fora do ar, tirados do nada, s√£o proibidos no idioma.  Infelizmente, n√£o temos tempo para mostr√°-lo, mas h√° casos em que o compilador pode realmente fazer uma convers√£o que tudo estar√° correto em um programa de thread √∫nico e voc√™ pode ter um registro em um programa de v√°rios threads que n√£o fez. <br><br>  Dessa forma, o modelo de mem√≥ria diz que a leitura de qualquer vari√°vel retornar√° o valor padr√£o ou alguns dos resultados da grava√ß√£o que j√° foi feita por outro comando.  E as a√ß√µes restantes podem ser interpretadas como seq√ºenciais, se estiverem conectadas por uma rela√ß√£o de ordem parcial, antes do ocorrido.  E agora √© o √∫nico lugar onde precisamos de matem√°tica.  Rela√ß√£o parcial, isso ocorre porque nem todas as opera√ß√µes de leitura e grava√ß√£o de vari√°veis ‚Äã‚Äãs√£o conectadas por rela√ß√£o.  Possui propriedades de reflexividade, transitividade e anti-simetria. <br><br><img src="https://habrastorage.org/webt/vq/vp/11/vqvp11dmptcgzyedx4hazndvmeo.jpeg"><br><br>  Vamos falar com mais detalhes sobre o que acontece antes de si mesmo.  A primeira regra √© que ele vincula todas as opera√ß√µes em um √∫nico encadeamento.  Se voc√™ escreveu dentro de um segmento que X √© igual a um, Y √© igual a um;  afirma-se que as opera√ß√µes de grava√ß√£o em X est√£o relacionadas a acontecer antes de Y. Ou seja, X acontece antes de Y. E tamb√©m vincula algumas a√ß√µes especiais, as chamadas a√ß√µes de sincroniza√ß√£o.  Leia mais na especifica√ß√£o.  Por exemplo, isso √© escrever e ler de uma vari√°vel vol√°til, bloquear / desbloquear em um monitor, entrar no bloco sincronizado e sair do bloco sincronizado.  Um ponto muito importante √© que todas as a√ß√µes de sincroniza√ß√£o no seu programa veem os threads exatamente na mesma ordem, como se estivessem sendo executados um por um. <br><br>  E acontece - antes vincula alguns pares dessas a√ß√µes.  N√£o importa em quais a√ß√µes de sincroniza√ß√£o de encadeamento ocorrem.  √â importante que eles passem, por exemplo, sobre uma vari√°vel vol√°til.  A especifica√ß√£o diz, digamos, que a grava√ß√£o na vari√°vel vol√°til ocorra antes de qualquer outra a√ß√£o subsequente.  Isso se refere precisamente √† maneira pela qual tivemos a√ß√µes de sincroniza√ß√£o. <br><br>  E o mais importante de tudo isso √© a regra acontece antes da consist√™ncia, que apenas responde √† pergunta mais importante sobre o modelo de mem√≥ria.  Pode ser interpretado da seguinte maneira.  Se houver uma cadeia de opera√ß√µes de leitura / grava√ß√£o em uma vari√°vel e elas estiverem conectadas por uma cadeia de relacionamentos anteriores, a leitura deve definitivamente ver o √∫ltimo registro dessa cadeia.  Se n√£o estiver l√°, voc√™ poder√° ver qualquer outro valor, qualquer outro registro ou valor padr√£o.  Agora voc√™ pode expirar, com as defini√ß√µes b√°sicas que terminamos. <br><br><img src="https://habrastorage.org/webt/q6/jv/qq/q6jvqqzesul_tjyflrgcuy8s__4.jpeg"><br><br>  Vamos tentar testar a teoria na pr√°tica?  Vamos dar um exemplo com uma leitura cruzada de registros e apenas adicionar o modificador vol√°til √†s vari√°veis ‚Äã‚ÄãX e Y. Vamos tentar provar a hip√≥tese de que n√£o veremos mais o valor zero-zero.  Para fazer isso, basta usar as regras que eu expressei acima. <br><br>  N√≥s vamos providenciar os eventos antes em um t√≥pico.  Escrever para X acontece - antes da leitura de Y e no segundo segmento.  Escrever para Y acontece - antes de ler de X. <br><br>       synchronization actions:   ,   Y,   ,   Y.      ,       . <br><br><img src="https://habrastorage.org/webt/yz/mu/vr/yzmuvrfkneks1-usipllgsgxanc.jpeg"><br><br> ,        ,        ( happens-before).    ,    Y.    Y         ,  ,    .        . ,      -, -. <br><br><img src="https://habrastorage.org/webt/yc/zi/rm/yczirmhlmh3r0c2whc-g8dpxtvu.jpeg"><br><br>  ,   .     ‚Äî   Y happens-before   Y.     . ,    ,    -, -.        . <br><br><img src="https://habrastorage.org/webt/ui/zs/7o/uizs7ojlz4smbqktuvisojvjxte.jpeg"><br><br>     .         volatile.   , , ,         .   happens-before ‚Äî        .         . <br><br><img src="https://habrastorage.org/webt/p8/xp/ao/p8xpaoj1prrfkwto0t3w7unlsli.jpeg"><br><br> ,        .  volatile     Z  volatile,  .   ,        Z;   ,  ,     ,     Z.        happens-before       .  ,     Z   ,        .           . <br><br>  , ,        ‚Äî       put value.    ‚Äî   get value    .   happens-before   ,       ,  put value happens-before get value.           ,        happens-before   ,   volatile,     .      ,    ,  ‚Äî put  happens-before get. <br><br><img src="https://habrastorage.org/webt/m6/br/hd/m6brhdf3iyak436nje-p-fyrq2a.jpeg"><br><br> ,    . -,  .  ,    ,    .         ,     .  ,     ,     .  ,         .    ,      ,      ,     ,       . <br><br> -,     ,  jcstress.       :     ,   JVM   .      ,        . <br><br>    ,   .  ‚Äî ¬´The Art of Multiprocessor Programming¬ª  .        ,   happens-before,  ,   . .     ‚Äî ¬´Java Concurrency in Practice¬ª  .     ,       .     ,   ,    . .    .       <a href="https://shipilev.net/"> </a> ,   performance-  Oracle,     Red Hat.      ,  Java-  ,   .        JMM. <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voc√™ pode ler o blog de </font></font><a href="https://elizarov.livejournal.com/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Roman Elizarov</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Ele ensinou, na minha opini√£o, a programa√ß√£o multithread do ITMO. </font><font style="vertical-align: inherit;">Ele tem um blog um pouco abandonado, mas voc√™ pode ler, pesquisar suas palestras e discursos no YouTube. </font><font style="vertical-align: inherit;">Em geral, muito adequado, eu aconselho. </font><font style="vertical-align: inherit;">Obrigado a todos.</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt477074/">https://habr.com/ru/post/pt477074/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt477054/index.html">Webasto Anuncia Sistema Modular de Bateria Automotiva</a></li>
<li><a href="../pt477058/index.html">Enterprise Agile Russia no Raiffeisenbank 26/11 + Transmiss√£o</a></li>
<li><a href="../pt477060/index.html">O DataArt sediar√° uma palestra aberta de Andrey Terekhov, Chefe do Departamento de Programa√ß√£o de Sistemas, Matmekh, Universidade Estadual de S√£o Petersburgo</a></li>
<li><a href="../pt477062/index.html">Como o compilador de otimiza√ß√£o funciona</a></li>
<li><a href="../pt477072/index.html">Desenvolvimento do cliente ou como lan√ßar um produto sem falhas?</a></li>
<li><a href="../pt477078/index.html">WebStorm 2019.3: lan√ßamento mais r√°pido, suporte aprimorado ao Vue.js e outras melhorias</a></li>
<li><a href="../pt477082/index.html">Congresso dos EUA contra Zuckerberg: que reivindica√ß√µes os reguladores fazem contra a libra est√°vel do Facebook</a></li>
<li><a href="../pt477084/index.html">O c√©rebro da empresa. Parte 2</a></li>
<li><a href="../pt477092/index.html">Vis√£o geral das ferramentas de seguran√ßa de reposit√≥rio do GitHub</a></li>
<li><a href="../pt477096/index.html">O 5G prejudicar√° nossa sa√∫de?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>