<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíà üè≥Ô∏è‚Äçüåà ü§∏üèª Veloc√≠metro / od√¥metro no IN14 üë®üèø‚Äçü§ù‚Äçüë®üèΩ üë®‚Äçüë¶ üë©üèæ‚ÄçüöÄ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bom dia 
 Mais uma vez, a criatividade atacou. Decidi atualizar o veloc√≠metro antigo no tanque de batalha VAZ 2121. Depois de fazer uma auditoria nas ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Veloc√≠metro / od√¥metro no IN14</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/396433/"><img src="https://habrastorage.org/files/223/573/535/223573535e4a4d2ab59998d867645ddf.jpg" align="left"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bom dia </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais uma vez, a criatividade atacou. </font><font style="vertical-align: inherit;">Decidi atualizar o veloc√≠metro antigo no tanque de batalha VAZ 2121. Depois de fazer uma auditoria nas caixas, encontrei 3 pe√ßas IN14. </font><font style="vertical-align: inherit;">N√£o √© suficiente para um rel√≥gio, muito para um term√¥metro. </font><font style="vertical-align: inherit;">N√£o existe - n√£o aqui. </font><font style="vertical-align: inherit;">No veloc√≠metro - √© isso.</font></font><a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para come√ßar, o veloc√≠metro padr√£o foi removido e destru√≠do. A milhagem atual √© salva em um peda√ßo de papel, para ser honesto. Foi adquirido um sensor de velocidade de 10 pulsos por rota√ß√£o (DSA-3). Como indicadores de velocidade - o mencionado IN14, para exibir quilometragem, horas e outras coisas - amplamente conhecidos em c√≠rculos estreitos de designers da AON no z80 - ALS318. </font></font><br>
<img src="https://habrastorage.org/files/a40/11d/9fb/a4011d9fb4ab4ef082540dbdbf74a2a7.jpg"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Inicialmente, o n√∫cleo do dispositivo era PIC18F452 para a abund√¢ncia de GPIO. Ent√£o me deparei com o expansor de porta i2c mcp23017, que eu desejava acessar h√° muito tempo. Com ele, a necessidade de muitos GPIOs desapareceu e o msp430g2452, que estava perto de mim nos √∫ltimos designs, foi escolhido. Tamb√©m encontrado RTC - i2c assistir ds1307. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O IN14 requer 170 volts para opera√ß√£o normal. O DC-DC de intensifica√ß√£o foi montado de acordo com um circuito testado no MC34063 + IRF740. Vou descrever algumas das nuances que apareceram durante o processo de cria√ß√£o.</font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. A caixa redonda</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . N√£o √© uma forma conveniente para a coloca√ß√£o dentro de eletr√¥nicos e monitores. Eu tive que fazer a estrutura interna modular com v√°rios conectores. A tarefa tamb√©m era tornar a caixa herm√©tica (bem, ou quase herm√©tica), j√° que a linha de √°gua √© mais alta que o teto devido √†s condi√ß√µes de opera√ß√£o do carro. Isso foi decidido preenchendo os orif√≠cios em excesso com cola ep√≥xi e instalando um √∫nico conector para comunica√ß√£o com o mundo exterior. Na verdade, design: </font></font><br>
<img src="https://habrastorage.org/files/765/1db/deb/7651dbdebe4b410cbd74102edf6f7713.jpg"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
e conector: </font></font><br>
<img src="https://habrastorage.org/files/c95/3b9/7a6/c953b97a6ddc4139b4aa30efde6990e4.jpg"><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. Indica√ß√£o din√¢mica</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Para n√£o notar a troca de descargas durante uma exibi√ß√£o din√¢mica, t√£o irritante para certas pessoas, a taxa de atualiza√ß√£o de cada descarga deve ser de pelo menos 100 Hz. √â verdade que existem quem v√™ 100 Hz, mas eu n√£o os monto neste carro. Dos dois indicadores, o mais "dif√≠cil" deste ponto de vista √© o ALS318 de 9 bits. Acontece que a taxa de atualiza√ß√£o deve ser de pelo menos 9 * 100 Hz. Para simplificar o c√°lculo dos intervalos - foi escolhida uma taxa de atualiza√ß√£o de 1 kHz. O circuito ALS318 est√° conectado ao expansor de portas mcp23017. Porta A - segmentos, porta B - bits. O nono bit √© controlado diretamente a partir do GPIO do microcontrolador. Acontece que a cada milissegundo √© necess√°rio atualizar o estado das portas A e B do expansor via i2c. A pr√≥xima nuance saiu daqui. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3. Troca lenta de i2c com ds1307</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. No nosso caso, dois escravos est√£o pendurados no barramento i2c. Expansor de porta e rel√≥gio. Estes √∫ltimos n√£o acompanham a frequ√™ncia do SCL acima de 100 kHz, enquanto o expansor pode funcionar em frequ√™ncias de at√© 1,7 MHz. Para atualizar as portas do expansor, √© necess√°rio escrever 4 palavras de 8 bits no i2c a cada 1 ms (endere√ßo do expansor, endere√ßo da porta A, dados da porta A, dados da porta B). Durante a inicializa√ß√£o, o expansor √© programado para incrementar automaticamente os endere√ßos dos registros internos ao ler / gravar. E o endere√ßo da porta B segue imediatamente o endere√ßo da porta A, que economiza na transfer√™ncia de um endere√ßo adicional da porta B. Para garantir um tempo de processamento curto do procedimento de atualiza√ß√£o, foi escolhida a frequ√™ncia de clock do SCL de 500 kHz. Al√©m disso, √© realizada uma pesquisa do estado do rel√≥gio uma vez a cada 100 ciclos de atualiza√ß√£o da tela, ou seja, a cada 100ms.O procedimento de polling do rel√≥gio define a frequ√™ncia do SCL para 100kHz aceit√°vel para ds1307. Ao depurar a troca pelo i2c, o analisador l√≥gico SaleaeLogic USB (8 canais, amostragem de at√© 24 MHz) ajudou bastante. Suave √© capaz de decodificar v√°rios protocolos, incluindo o i2c.</font></font><br>
<img src="https://habrastorage.org/files/051/7c0/dff/0517c0dffb2c4fd4b477b76b2a6e6be8.PNG"><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4. Nutri√ß√£o</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . O veloc√≠metro para armazenar o tempo √© constantemente alimentado pela bateria e para opera√ß√£o - a tens√£o fornecida quando a igni√ß√£o √© ligada. O √∫ltimo √© alimentado por um conversor e decodificador DC-DC para o IN14, um expansor de portas. Na aus√™ncia de tens√£o de igni√ß√£o - o dispositivo √© colocado no modo de armazenamento. Se a chave de igni√ß√£o estiver ligada, a indica√ß√£o inicia, s√£o permitidas interrup√ß√µes no sensor de velocidade. Quando a igni√ß√£o √© desligada, as leituras do od√¥metro s√£o registradas na mem√≥ria n√£o vol√°til do microcontrolador. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5. Gerenciamento</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Para acertar o rel√≥gio, redefina os od√¥metros (existem dois deles, exceto o contador principal de milhas), foi usado um codificador com um bot√£o (honestamente roubei a imagem na rede. Meu codificador j√° est√° cheio de adesivo hot-melt para impermeabiliza√ß√£o): </font></font><br>
<img src="https://habrastorage.org/files/02b/5de/2bc/02b5de2bc88e4bc785de3bf6a15041f1.jpg"><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6. N√≠veis l√≥gicos de escravos i2c</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Como o rel√≥gio ds1307 √© alimentado por 5V e o microcontrolador e o expansor de porta de 3,3V - os resistores pull-up do barramento i2c est√£o conectados a 3,3V. De acordo com a folha de dados do ds1307, a tens√£o da unidade l√≥gica √© de 2,2V, e 3,3V estar√° totalmente operacional. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7. C√£o de guarda</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O sistema usa uma interface i2c de hardware, enquanto o processador "dorme" enquanto aguarda o envio / recebimento de um byte. No caso de falha / desligamento da igni√ß√£o neste momento, o microcontrolador pode n√£o esperar o escravo responder e permanecer no modo "inativo". Para eliminar essas interrup√ß√µes, √© usado o watchdog de hardware do microcontrolador. No loop principal, o watchdog √© redefinido constantemente. No caso de um desligamento, o loop principal para e o c√£o de guarda transborda, enviando uma redefini√ß√£o para o microcontrolador. Para determinar a natureza da redefini√ß√£o (ativa√ß√£o ou monitoramento), uma vari√°vel √© introduzida no programa que n√£o √© inicializada durante a redefini√ß√£o (#pragma NOINIT). Se for igual ao valor conhecido, houve uma redefini√ß√£o pelo watchdog. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8. Calibra√ß√£o</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em princ√≠pio, a calibra√ß√£o j√° pode ser feita em batalha, por exemplo, para viajar a uma certa velocidade em gps. </font><font style="vertical-align: inherit;">Depois de digitar, por exemplo, 30 km / h - clique na tampa e o veloc√≠metro lembrar√° a freq√º√™ncia de pulso medida correspondente a 30 km / h. </font><font style="vertical-align: inherit;">Mas na parede traseira havia uma inscri√ß√£o interessante: </font></font><br>
<img src="https://habrastorage.org/files/3f7/2dc/0e4/3f72dc0e432f40a3894c0a17381f6e1a.jpg"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
assim, 10 pulsos do sensor de velocidade corresponder√£o a um metro percorrido pelo carro. </font><font style="vertical-align: inherit;">Se houver diferen√ßas significativas, farei os ajustes necess√°rios. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9. resist√™ncia √† vibra√ß√£o.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O dispositivo foi projetado para opera√ß√£o dif√≠cil do ponto de vista das condi√ß√µes de vibra√ß√£o. </font><font style="vertical-align: inherit;">N√£o encontrei informa√ß√µes sobre a resist√™ncia √† vibra√ß√£o do IN14 na Internet. </font><font style="vertical-align: inherit;">O tempo, como se costuma dizer, dir√°. </font><font style="vertical-align: inherit;">As conex√µes el√©tricas s√£o feitas pelo bom e velho MGTF. </font><font style="vertical-align: inherit;">Ap√≥s a verifica√ß√£o dos m√≥dulos, eles foram preenchidos com cola ep√≥xi. </font><font style="vertical-align: inherit;">A prop√≥sito, no pre√ßo fixo, achei bastante cola para mim no fator de forma das seringas duplas.</font></font><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aqui est√£o os elementos de design:</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/files/b7a/65d/60f/b7a65d60f7cd4ff294e761a868731b44.jpg"><br>
<img src="https://habrastorage.org/files/201/cde/81d/201cde81d4b64804a0a5df0940baecd6.jpg"><br>
<img src="https://habrastorage.org/files/916/413/7cf/9164137cfdb6485e8ec133a0075354b8.jpg"><br>
<img src="https://habrastorage.org/files/c65/887/2c2/c658872c26004c44983010aa6f44f6dd.jpg"><br>
</div></div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10. Diversos. </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A milhagem existente salva anteriormente dos peda√ßos de papel mencionados acima na mem√≥ria n√£o vol√°til. </font><font style="vertical-align: inherit;">Falando dela. </font><font style="vertical-align: inherit;">A mem√≥ria n√£o vol√°til √© organizada p√°gina por p√°gina no msp430. </font><font style="vertical-align: inherit;">Os tr√™s primeiros est√£o dispon√≠veis para o usu√°rio. </font><font style="vertical-align: inherit;">O quarto armazena os dados de calibra√ß√£o do rel√≥gio. </font><font style="vertical-align: inherit;">As leituras do contador principal de milhagem e dois od√¥metros adicionais redefin√≠veis s√£o salvos em sequ√™ncia, preenchendo as tr√™s primeiras p√°ginas do flash por vez. </font><font style="vertical-align: inherit;">Ao chegar ao final da terceira p√°gina - as tr√™s primeiras s√£o apagadas e a grava√ß√£o come√ßa novamente a partir do in√≠cio da primeira. </font><font style="vertical-align: inherit;">Assim, o recurso flash √© aumentado, embora o recurso do interruptor de igni√ß√£o (o salvamento ocorra quando a igni√ß√£o √© desligada) √©, obviamente, menor que o recurso de apagar o registro flash. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No painel:</font></font><br>
<img src="https://habrastorage.org/files/50c/eed/209/50ceed209cdc409fa61bfd0623f369a1.JPG"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em princ√≠pio, tudo. </font><font style="vertical-align: inherit;">√Ä espera de coment√°rios e coment√°rios. </font><font style="vertical-align: inherit;">Arquive com as fontes e o esquema no diptrace de </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">acordo com a tradi√ß√£o da figura</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Infelizmente, o habrastorage atualizado reconhece o arquivo da figura e n√£o permite que ele seja salvo. Aqui est√£o as fontes e o esquema: </font></font><br>
<a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dl.dropboxusercontent.com/u/974924/nivaCon2.rar</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
PS E sim, Essas l√¢mpadas IN14 t√™m realmente 44 anos. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o foi poss√≠vel remover o v√≠deo PPS em movimento. </font><font style="vertical-align: inherit;">M√£os insuficientes. </font><font style="vertical-align: inherit;">Determina√ß√£o da velocidade verificada pelo GPS. </font><font style="vertical-align: inherit;">Desvios de ¬± 4 km / h a uma velocidade de 40 km / h. </font><font style="vertical-align: inherit;">Precis√£o bastante suficiente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui est√° o v√≠deo:</font></font><br>
<iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://www.youtube.com/embed/tVqEW57Az5k%3Ffeature%3Doembed&amp;usg=ALkJrhiFGLIkupfJZnri5wwie39jbnb9oA" frameborder="0" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu atirei assim:</font></font><br>
<img src="https://habrastorage.org/files/e44/cbb/dc8/e44cbbdc80c04407ae47425c5b560c90.jpg"></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt396433/">https://habr.com/ru/post/pt396433/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt396423/index.html">Por que as startups falham</a></li>
<li><a href="../pt396425/index.html">Os raios X ajudaram a encontrar uma biblioteca medieval escondida</a></li>
<li><a href="../pt396427/index.html">Redmi Pro √© o primeiro smartphone de c√¢mera dupla da XIAOMI</a></li>
<li><a href="../pt396429/index.html">A Lockheed Martin est√° desenvolvendo um minissubmarino para entregar for√ßas especiais ao campo de batalha</a></li>
<li><a href="../pt396431/index.html">√â poss√≠vel encontrar Pokemon na natureza?</a></li>
<li><a href="../pt396435/index.html">Primeiro paciente dos EUA a receber o transplante de ambas as m√£os quer se livrar deles</a></li>
<li><a href="../pt396437/index.html">22 mensagens de esperan√ßa (e ci√™ncia) para criacionistas</a></li>
<li><a href="../pt396439/index.html">Por que as an√£s marrons s√£o t√£o mon√≥tonas?</a></li>
<li><a href="../pt396441/index.html">It√°lia pode perder suas oliveiras devido √† desconfian√ßa de cientistas</a></li>
<li><a href="../pt396443/index.html">"S√°bios de Si√£o" se tornou outro motivo para bloquear a Wikipedia</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>