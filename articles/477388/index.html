<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üÜî ‚öõÔ∏è üë®üèø‚Äçüç≥ NILFS2 - sistema de archivos a prueba de balas para / home üê≠ üôèüèø üë©üèæ‚Äçü§ù‚Äçüë©üèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Como saben, si los problemas pueden suceder, entonces suceder√°n. Probablemente, todos tuvieron casos en los que un archivo importante nuevo se elimin√≥...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>NILFS2 - sistema de archivos a prueba de balas para / home</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/477388/"><img src="https://habrastorage.org/webt/kb/yr/gu/kbyrgu_gfsr0kcqjrxmnu-l3oic.png"><br><br>  Como saben, si los problemas pueden suceder, entonces suceder√°n.  Probablemente, todos tuvieron casos en los que un archivo importante nuevo se elimin√≥ accidentalmente, o el texto en un editor de texto se seleccion√≥ y elimin√≥ accidentalmente. <br><br>  Si usted es el proveedor de alojamiento o el propietario del sitio, entonces probablemente se enfrent√≥ a la pirater√≠a de cuentas de usuario o de su sitio.  En tales casos, es importante restaurar la cronolog√≠a, encontrar una forma de penetraci√≥n y la vulnerabilidad que utiliz√≥ el atacante. <br><br>  Para resolver estos problemas, el sistema de archivos NILFS2 es perfecto. <br><a name="habracut"></a><br>  Ha estado presente en el kernel de Linux desde la versi√≥n 2.6.30. <br><br>  Una caracter√≠stica de este sistema de archivos es que es similar a un sistema de control de versiones: siempre puede retroceder el estado del sistema y ver lo que era hace alg√∫n tiempo. <br><br>  Para proporcionar esta funcionalidad, no necesita configurar scripts de Cron, hacer instant√°neas, etc.  El sistema de archivos NILFS2 hace todo esto por s√≠ mismo.  Ella nunca sobrescribe datos antiguos y siempre escribe en nuevas √°reas del disco si hay suficiente espacio libre en el disco.  De acuerdo con el principio de Copia en escritura. <br><br>  De hecho, cualquier cambio en el archivo implica la creaci√≥n autom√°tica de una nueva instant√°nea del sistema de archivos, por lo que puede utilizar este sistema de archivos como una m√°quina del tiempo y rebobinar el estado de los archivos. <br><br><h2>  La historia </h2><br><img src="https://habrastorage.org/webt/pt/gh/1r/ptgh1rcdscjbdoogumo8pu_dbcw.jpeg" align="right">  NILFS2 se desarroll√≥ en las entra√±as de <a href="https://ru.wikipedia.org/wiki/Nippon_Telegraph_and_Telephone">Nippon Telegraph and Telephone Corporation</a> , de hecho, de propiedad estatal (tiene una participaci√≥n de control) y la compa√±√≠a de telecomunicaciones m√°s grande de Jap√≥n.  M√°s espec√≠ficamente, los Laboratorios CyberSpace liderados por <a href="https://github.com/konis">Ryusuke Konishi</a> . <br><br>  Por qu√© se desarroll√≥ espec√≠ficamente: se desconoce, sin embargo, se puede suponer que tal FS, con su funcionalidad de "m√°quina del tiempo", es ideal para almacenar datos en los que es posible que desee profundizar en los servicios especiales para reproducir la imagen completa de SMS, correos electr√≥nicos, etc. <br><br>  NILFS2 tambi√©n es, potencialmente, una herramienta muy valiosa para los servicios de seguridad interna, ya que le permite recuperar todas las cartas eliminadas en la base de datos de correo, abrir las jambas de los empleados que posteriormente pueden intentar disimularlos eliminando o cambiando sus archivos. <br><br><div class="spoiler">  <b class="spoiler_title">¬øC√≥mo puedo rastrear toda la historia de la correspondencia?</b> <div class="spoiler_text"> En Linux, en los servidores (y vale la pena poner NILFS2 all√≠ para fines de seguridad interna), el m√©todo de almacenamiento de archivos de correos electr√≥nicos a menudo se usa para almacenar mensajes de correo.  El llamado formato <a href="https://ru.wikipedia.org/wiki/Maildir">Maildir</a> .  Es suficiente instalar <a href="http://www.courier-mta.org/">Courier Mail Server</a> y configurar el almacenamiento de cartas en Maildir.  Otro formato de <a href="https://ru.wikipedia.org/wiki/Mbox">mbox</a> es un archivo de texto grande que se analiza f√°cilmente en mensajes individuales. <br><br>  Si el servidor de correo usa la base de datos, entonces NILFS2 permitir√° restaurar el momento exacto de los cambios de la base de datos y la capacidad de restaurar la base de datos en cualquiera de estos puntos.  Y luego necesita usar las herramientas de la base de datos para ver lo que hab√≠a en ese momento ... <br></div></div><br>  Sin embargo, algo sali√≥ mal.  O el gobierno japon√©s decidi√≥ no seguir a todos (a principio de Yarovaya), o el rendimiento de NILFS2 en los discos duros tradicionales result√≥ ser inferior a la placa base, y NILFS2 se lanz√≥ bajo la licencia GPL y entr√≥ r√°pidamente en el kernel de Linux, ya que hubo quejas especiales sobre el c√≥digo escrito japoneses altamente calificados, los desarrolladores del kernel de Linux no ten√≠an. <br><br><h2>  ¬øC√≥mo se ve NILFS2? </h2><br>  Desde el punto de vista del uso: en el sistema de control de versiones <a href="https://ru.wikipedia.org/wiki/Subversion">SVN</a> .  Cada punto de control de FS es una confirmaci√≥n que se realiza autom√°ticamente sin el conocimiento del usuario ante cualquier cambio: ya sea para eliminar, cambiar el contenido de un archivo o derechos de acceso.  Cada confirmaci√≥n tiene un n√∫mero que aumenta linealmente. <br><br>  Desde el punto de vista del programador: en un b√∫fer circular.  El sistema de archivos guarda los cambios y los escribe en una pieza de aproximadamente 8 MB (2048 * 4096, donde 2048 es el n√∫mero de elementos en el bloque y 4096 es el tama√±o de la p√°gina de memoria).  Todo el disco est√° dividido en tales trozos.  La grabaci√≥n est√° en secuencia.  Cuando se agota el espacio libre, se eliminan las im√°genes m√°s antiguas y se sobrescriben los fragmentos. <br><br><h2>  Bollos b√°sicos NILFS2 </h2><br><ul><li>  Versionado !!! </li><li>  El procedimiento para recuperar un sistema de archivos despu√©s de una falla es elemental: cuando se carga, busca el √∫ltimo fragmento que tiene la suma de verificaci√≥n correcta e instala un superbloque en √©l.  Esto es casi una operaci√≥n instant√°nea. </li><li>  Debido al hecho de que la grabaci√≥n siempre es lineal, entonces: <br><br><ul><li>  puede mostrar buenos resultados cuando se trabaja en SSD, con grabaci√≥n aleatoria lenta. </li><li>  NILFS2 ahorra recursos SSD ya que casi no hay multiplicador de registros. <br><div class="spoiler">  <b class="spoiler_title">M√°s precisamente, no es m√°s de 2.</b> <div class="spoiler_text">  El hecho es que durante la reescritura c√≠clica de todo el disco, NILFS2 transferir√° datos inmutables a nuevas piezas (fragmentos). <br><br>  Si tenemos un 10% de datos que no cambian en el disco, obtendremos un aumento del 10% en la grabaci√≥n con 1 reescritura completa.  Bueno, un aumento del 50% con un dispositivo lleno del 50% para 1 reescritura completa del disco. <br><br>  La ganancia m√°xima de grabaci√≥n es 2. Esto es muy peque√±o considerando que todo est√° escrito secuencialmente.  En general, la animaci√≥n del registro ser√° menor que la de un sistema de archivos fragmentado regular con un sector de 4096 bytes.  (Coment√≥ en los pensamientos). </div></div></li></ul><br></li><li>  Posible facilidad de replicaci√≥n a un NILFS2 FS remoto </li></ul><br><h2>  NILFS2 para / hogar </h2><br>  En los sistemas operativos tipo Unix, por regla general, hay una carpeta / home en la que se almacenan los datos del usuario.  Varios programas guardan sus configuraciones relacionadas con un usuario espec√≠fico en esta carpeta. <br><br>  ¬øY qui√©n, si no los usuarios, corta con mayor frecuencia?  Por lo tanto, como dicen, Dios mismo orden√≥ usar NILFS2 en / home. <br><br>  Adem√°s, con la distribuci√≥n generalizada de SSD, ahora no podemos preocuparnos por la fuerte reducci√≥n al usar sistemas de archivos CoW. <br><br>  S√≠, podemos crear instant√°neas FS con la frecuencia que queramos en ZFS y BTRFS, pero siempre existe el riesgo de que se produzca un cambio de archivo perdido entre las instant√°neas.  Y las im√°genes a√∫n deben administrarse: elimine las antiguas.  En NILFS2, todo esto ocurre autom√°ticamente, literalmente cada pocos segundos. <br><br>  Cre√© un volumen l√≥gico usando lvcreate (en el grupo de volumen nvme, grupo delgado y delgado).  Recomiendo crearlo en el volumen lvm, ya que m√°s tarde se puede expandir f√°cilmente.  Recomiendo tener un 50% de espacio libre en disco con NILFS2 para una profundidad de versi√≥n decente. <br><br><pre><code class="bash hljs">lvcreate -V10G -T nvme/thin -n home</code> </pre> <br>  y formateado en NILFS2: <br><br><pre> <code class="bash hljs">mkfs.nilfs2 -L nvme_home /dev/nvme/home mkfs.nilfs2 (nilfs-utils 2.1.5) Start writing file system initial data to the device      Blocksize:4096 Device:/dev/nvme/home1 Device Size:10737418240 File system initialization succeeded !!</code> </pre><br>  Despu√©s de eso, debe copiar todos los datos del actual / hogar. <br><br>  Hice esto inmediatamente despu√©s de arrancar la computadora, antes de ingresar a mi cuenta, desde el usuario root.  Si inici√© sesi√≥n como mi usuario, algunos programas abrir√≠an sockets y archivos en la carpeta / inicio / usuario de mi usuario, lo que dificultar√≠a la copia.  Como sabe, la carpeta de inicio para el usuario ra√≠z generalmente se encuentra en la ruta / root, por lo que no se abrir√°n archivos en la secci√≥n / home. <br><br><pre> <code class="bash hljs">mkdir /mnt/newhome mount -t nilfs2 /dev/nvme/home /mnt/newhome cp -a /home/. /mnt/newhome</code> </pre> <br>  <i>Para la √∫ltima l√≠nea, vea el <a href="https://habr.com/ru/company/ruvds/blog/471092/">art√≠culo</a> .</i> <i><br></i> <br>  A continuaci√≥n, edite / etc / fstab, que monta el sistema de archivos para / home, en <br><br> <code>/dev/disk/by-label/nvme_home /home nilfs2  noatime 0 0</code> <br> <br>  La opci√≥n <code>noatime</code> necesaria para mejorar el rendimiento para que atime no cambie con cada acceso a archivos.  A continuaci√≥n, reiniciamos. <br><br><h2>  Tipos de im√°genes en NILFS2. </h2><br>  Una instant√°nea normal sin inmunidad de eliminaci√≥n se denomina punto de control (punto de control o punto de recuperaci√≥n). <br>  Una instant√°nea con protecci√≥n de eliminaci√≥n autom√°tica se denomina instant√°nea, luego solo una instant√°nea. <br><br>  La visualizaci√≥n de los puntos de control se realiza mediante el comando lscp <br><br>  Ver instant√°neas lscp -s <br><br>  Podemos crear instant√°neas y puntos de control nosotros mismos en cualquier momento usando: <br><br><pre> <code class="bash hljs">mkcp [-s] </code> </pre> <br><h2>  Recuperar datos. </h2><br>  NILFS nos permite montar tantas im√°genes antiguas como necesitemos en paralelo con el trabajo con la rama FS principal.  Pero solo en modo lectura. <br><br>  Todo est√° organizado de esta manera.  Los puntos de control habituales que hace NILFS2 se pueden eliminar autom√°ticamente en cualquier momento (cuando se agota el espacio en disco o seg√∫n las reglas de nilfs_cleanerd), por lo tanto, antes de montar, debemos traducir el punto de control en una instant√°nea o, en ruso, arreglar la imagen. <br><br><pre> <code class="bash hljs">chcp ss _</code> </pre> <br>  Despu√©s de eso, podemos montar la instant√°nea, por ejemplo, as√≠: <br><br><pre> <code class="bash hljs">mount -t nilfs2 -r -o cp=_ /dev/nvme/home /mnt/nilfs/_</code> </pre> <br>  Luego copiamos los archivos recuperados de la instant√°nea a / home. <br>  Y luego eliminamos la bandera de indistinguibilidad de la imagen, para que en el futuro el recolector autom√°tico de basura pueda eliminar datos obsoletos: <br><br><pre> <code class="bash hljs">chcp cp _</code> </pre> <br><h2>  Utilidades para NILFS2 </h2><br>  Pero este es el problema.  S√≠, por supuesto, podemos crear un sistema de archivos, cambiar su tama√±o en l√≠nea, ver una lista de puntos de cadena, crearlos y eliminarlos.  El paquete nilfs2-utils proporciona un conjunto m√≠nimo de caballeros. <br><br>  Dado que NTT redujo la financiaci√≥n, no hay utilidades r√°pidas de bajo nivel que puedan mostrar el historial de cambios de archivos y hacer diferencias entre las instant√°neas. <br><br><h2>  Mi utilidad n2u </h2><br>  Para llenar este vac√≠o, escrib√≠ <a href="https://github.com/sukamenev/nilfs2_tools">mi utilidad n2u</a> , que puede mostrar el historial de cambios de un archivo / directorio espec√≠fico: <br><br><pre> <code class="bash hljs">n2u <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> filename</code> </pre> <br>  El resultado es algo como esto: <br><br><pre> <code class="bash hljs"> CHECKPOINT DATE TIME TYPE SIZE MODE 1787552 2019-11-24 22:08:00 first 7079 cp 1792659 2019-11-25 23:09:05 changed 7081 cp</code> </pre> <br>  Funciona bastante r√°pido para el m√©todo de implementaci√≥n elegido: busca diferencias entre archivos utilizando el m√©todo de bisecci√≥n, montando y comparando r√°pidamente el archivo / directorio en diferentes im√°genes. <br><br>  Puede establecer el rango de puntos de control con la tecla <code>-cp CP1:CP2</code> o <code>-cp {YEAR-MM-DD}:{YEAR-MM-DD}</code> . <br><br>  Tambi√©n puede ver la diferencia entre los puntos de control para un archivo o directorio espec√≠fico: <br><br><pre> <code class="bash hljs">n2u diff -r cp1:cp2 filename</code> </pre> <br>  Puede mostrar toda la cronolog√≠a de los cambios: todas las diferencias entre los puntos de control de un archivo / directorio espec√≠fico: <br><br><pre> <code class="bash hljs">n2u blame [-r cp1:cp2] filename</code> </pre> <br>  El rango de fechas en este comando tambi√©n es compatible. <br><br><h2>  Llorar a los desarrolladores </h2><br>  Hay muchos especialistas en Habr√©.  Por favor, termine NILFS2.  ¬°Haga la replicaci√≥n, diferencia r√°pida de bajo nivel entre revisiones, reflink y otras cosas! <br><br><h2>  Referencias </h2><br>  <a href="https://nilfs.sourceforge.io/en/index.html">Sitio web oficial de NILFS</a> . <br><br>  Repositorios: <br>  <a href="https://github.com/konis/nilfs2">NILFS2</a> . <br>  <a href="http://github.com/nilfs-dev/">NILFS2 Utilidades y m√≥dulos</a> . <br><br>  Boletines informativos: <br>  <a href="http://vger.kernel.org/">Correo electr√≥nico del desarrollador NILFS2</a> .  El identificador para la suscripci√≥n de linux-nilfs. <br>  <a href="https://marc.info/%3Fl%3Dlinux-nilfs">Archivo de boletines</a> . <br><br>  <a href="https://forum.manjaro.org/t/tuning-the-nilfs2-file-system/42943">Gu√≠a de configuraci√≥n de Nilfs_cleanerd</a> . <br>  <a href="https://www.phoronix.com/scan.php%3Fpage%3Darticle%26item%3Dlinux-48-hdd">Pruebas comparativas de rendimiento de EXT4, Btrfs, XFS y NILFS2</a> . <br><hr><br>  Agradecimientos <br><br><ul><li>  Desarrolladores de NILFS2: Ryusuke Konishi, Koji Sato, Naruhiko Kamimura, Seiji Kihara, Yoshiji Amagai, Hisashi Hifumi y Satoshi Moriai.  Otros contribuyentes importantes son: Andreas Rohner, Dan McGee, David Arendt, David Smid, dexen deVries, Dmitry Smirnov, Eric Sandeen, Jiro SEKIBA, Matteo Frigo, Hitoshi Mitake, Takashi Iwai, Vyacheslav Dubeyko. </li><li>  Amblin Entertainment y Universal Pictures por su maravillosa serie de pel√≠culas <a href="https://ru.wikipedia.org/wiki/%25D0%259D%25D0%25B0%25D0%25B7%25D0%25B0%25D0%25B4_%25D0%25B2_%25D0%25B1%25D1%2583%25D0%25B4%25D1%2583%25D1%2589%25D0%25B5%25D0%25B5_(%25D1%2581%25D0%25B5%25D1%2580%25D0%25B8%25D1%258F_%25D1%2584%25D0%25B8%25D0%25BB%25D1%258C%25D0%25BC%25D0%25BE%25D0%25B2)">"Regreso al futuro"</a> .  La primera foto de la publicaci√≥n fue tomada de la pel√≠cula "Regreso al futuro - 3". </li><li>  <a href="https://ruvds.com/">Empresas de RUVDS</a> por su apoyo y la oportunidad de publicar en su blog en Habr√©. </li></ul><br>  <b>PS</b> Errores directos que notas en PM.  Aumento el karma para esto. <br><br><hr><br>  Puede experimentar con NILFS2 ordenando una m√°quina virtual de <a href="https://ruvds.com/">RUVDS</a> para el cup√≥n a continuaci√≥n.  Para todos los nuevos clientes, un per√≠odo de prueba gratuito de 3 d√≠as. <br><br> <a href="https://ruvds.com/ru-rub/"><img src="https://habrastorage.org/files/1ba/550/d25/1ba550d25e8846ce8805de564da6aa63.png"></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/477388/">https://habr.com/ru/post/477388/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../477374/index.html">Fuzzing Z-machines</a></li>
<li><a href="../477378/index.html">√Ågil mixto: enfoque de cascada al implementar aplicaciones comerciales (tambi√©n conocido como Agile-like)</a></li>
<li><a href="../477382/index.html">Esports: obtener ganancias: Mercedes, meg√°fono, apuestas y branding para esports</a></li>
<li><a href="../477384/index.html">Conferencia ‚ÄúSeguridad de la informaci√≥n. Amenazas del presente y del futuro ‚Äù</a></li>
<li><a href="../477386/index.html">Semana de la seguridad 48: fuga de datos gigantesca y vulnerabilidad de Whatsapp</a></li>
<li><a href="../477390/index.html">Depuraci√≥n de retrasos en la red en Kubernetes</a></li>
<li><a href="../477392/index.html">Micr√≥fono abierto: backend. Invitamos oradores</a></li>
<li><a href="../477396/index.html">C√≥mo inscribirse en un curso y ... ir al final</a></li>
<li><a href="../477400/index.html">Sobre la profesi√≥n de gerente de producto: ¬øc√≥mo lograr el ideal?</a></li>
<li><a href="../477402/index.html">Implementaci√≥n de Keras Deep Learning Model como una aplicaci√≥n web de Python</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>