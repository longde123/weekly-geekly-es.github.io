<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëÜüèº ü•¶ üç¥ Retour aux microservices avec Istio. Partie 1 üíú üîß üî§</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Remarque perev. : Les maillages de service sont d√©finitivement devenus une solution pertinente dans l'infrastructure moderne pour les applications qui...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Retour aux microservices avec Istio. Partie 1</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/438426/"><img src="https://habrastorage.org/webt/bj/j4/oy/bjj4oyjxqshrbjf5eks9sgsvbeg.png"><br><br>  <i><b>Remarque</b></i>  <i><b>perev.</b></i>  <i>: Les maillages de service sont d√©finitivement devenus une solution pertinente dans l'infrastructure moderne pour les applications qui suivent l'architecture de microservice.</i>  <i>Bien qu'Istio puisse √™tre entendu par de nombreux ing√©nieurs DevOps, il s'agit d'un produit assez nouveau qui, √©tant complet en termes de fonctionnalit√©s fournies, peut n√©cessiter un temps consid√©rable pour se conna√Ætre.</i>  <i>L'ing√©nieur allemand Rinor Maloku, responsable du cloud computing pour les grands clients de la soci√©t√© de t√©l√©communications Orange Networks, a √©crit une remarquable s√©rie de documents qui vous permettent de plonger rapidement et en profondeur dans Istio.</i>  <i>Il commence son histoire par ce qu'Istio peut faire et comment vous pouvez le voir rapidement de vos propres yeux.</i> <br><br>  <b>Istio</b> est un projet Open Source d√©velopp√© en collaboration avec des √©quipes de Google, IBM et Lyft.  Il r√©sout les difficult√©s qui se posent dans les applications bas√©es sur des microservices, par exemple, telles que: <a name="habracut"></a><br><br><ul><li>  <b>Gestion du trafic</b> : d√©lais d'attente, tentatives, √©quilibrage de charge; </li><li>  <b>S√©curit√©</b> : authentification et autorisation de l'utilisateur final; </li><li>  <b>Observabilit√©</b> : trace, surveillance, diagraphie. </li></ul><br>  Tous peuvent √™tre r√©solus au niveau de l'application, mais apr√®s cela, vos services cesseront d'√™tre ¬´micro¬ª.  Tous les efforts suppl√©mentaires pour r√©soudre ces probl√®mes sont un gaspillage suppl√©mentaire des ressources de l'entreprise qui pourraient √™tre utilis√©es directement pour les valeurs commerciales.  Prenons un exemple: <br><blockquote> Chef de projet: combien de temps pour ajouter des commentaires? <br>  D√©veloppeur: Two sprints. <br><br>  MP: Quoi? .. C'est juste CRUD! <br>  R: La cr√©ation de CRUD est une partie simple de la t√¢che, mais nous devons encore authentifier et autoriser les utilisateurs et les services.  √âtant donn√© que le r√©seau n'est pas fiable, vous devrez impl√©menter des demandes r√©p√©t√©es, ainsi que le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">mod√®le de disjoncteur</a> dans les clients.  Pourtant, pour vous assurer que tout le syst√®me n'est pas tomb√©, vous aurez besoin de d√©lais d'attente et de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cloisons</a> <i>(pour plus de d√©tails sur les deux mod√®les mentionn√©s, voir plus loin dans l'article - environ la traduction)</i> , et afin de d√©tecter les probl√®mes, la surveillance, le tra√ßage, [...] <br><br>  MP: Oh, alors ins√©rons simplement cette fonctionnalit√© dans le service Produit. </blockquote>  Je pense que l'id√©e est claire: le volume des √©tapes et des efforts n√©cessaires pour ajouter un service est √©norme.  Dans cet article, nous verrons comment Istio √©limine toutes les difficult√©s mentionn√©es ci-dessus (qui ne sont pas cibl√©es pour la logique m√©tier) des services. <br><br><img src="https://habrastorage.org/webt/l4/js/7o/l4js7omne2rslxitn0zr_lgusee.png"><br><br>  <b>Remarque</b> : Cet article suppose que vous avez une connaissance pratique de Kubernetes.  Sinon, je vous recommande de lire <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">mon introduction √† Kubernetes</a> et ce n'est qu'apr√®s cela de continuer √† lire ce mat√©riel. <br><br><h2>  Idea Istio </h2><br>  Dans un monde sans Istio, un service fait des requ√™tes directes √† un autre, et en cas de panne, le service doit le traiter lui-m√™me: refaire une tentative, pr√©voir un timeout, ouvrir un disjoncteur, etc. <br><br><img src="https://habrastorage.org/webt/ov/uv/g5/ovuvg5sepxqvj7wduhnl3uiixyi.png"><br>  <i>Trafic r√©seau dans Kubernetes</i> <br><br>  Istio propose √©galement une solution sp√©cialis√©e, compl√®tement distincte des services et fonctionnant en interf√©rant avec l'interaction du r√©seau.  Et donc il impl√©mente: <br><br><ul><li>  <b>Tol√©rance aux pannes</b> : en fonction du code d'√©tat dans la r√©ponse, il comprend si la demande a √©chou√© et l'ex√©cute √† nouveau. </li><li>  <b>D√©ploiements Canary</b> : redirige vers la nouvelle version du service uniquement un pourcentage fixe du nombre de demandes. </li><li>  <b>Surveillance et m√©triques</b> : combien de temps le service a-t-il r√©pondu? </li><li>  <b>Tra√ßage et observabilit√©</b> : ajoute des en-t√™tes sp√©ciaux √† chaque demande et les trace dans le cluster. </li><li>  <b>S√©curit√©</b> : extrait le jeton JWT, authentifie et autorise les utilisateurs. </li></ul><br>  Ce ne sont l√† que quelques-unes des possibilit√©s (vraiment seulement quelques-unes!) De vous intriguer.  Plongeons-nous maintenant dans les d√©tails techniques! <br><br><h2>  Architecture Istio </h2><br>  Istio intercepte tout le trafic r√©seau et lui applique un ensemble de r√®gles, en ins√©rant un proxy intelligent dans chaque module sous la forme d'un sidecar-container.  Les proxys qui activent toutes les fonctionnalit√©s forment un <b>plan de donn√©es</b> et peuvent √™tre configur√©s dynamiquement √† l'aide du <b>plan de contr√¥le</b> . <br><br><h2>  Plan de donn√©es </h2><br>  Les proxys ins√©r√©s dans les pods permettent √† Istio de r√©pondre facilement aux exigences dont nous avons besoin.  Par exemple, v√©rifiez les fonctions de nouvelle tentative et de disjoncteur. <br><br><img src="https://habrastorage.org/webt/8t/7x/xn/8t7xxntkiuakkk5sbn41b4rualg.gif"><br>  <i>Comment les nouvelles tentatives et les coupures de circuit sont impl√©ment√©es dans Envoy</i> <br><br>  Pour r√©sumer: <br><br><ol><li>  Envoy <i>(parle d'un proxy dans un conteneur de sidecar qui est distribu√© en tant que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">produit s√©par√©</a> - environ Transl.)</i> Envoie une demande √† la premi√®re instance du service B et une d√©faillance se produit. </li><li>  L'envoy√© Sidecar <i>r√©essaye</i> .  <i>(1)</i> </li><li>  La demande ayant √©chou√© est renvoy√©e au proxy qui l'a appel√©e. </li><li>  Cela ouvre le disjoncteur et appelle le service suivant pour les demandes suivantes.  <i>(2)</i> </li></ol><br>  Cela signifie que vous n'avez pas √† utiliser la prochaine biblioth√®que Retry, vous n'avez pas √† faire votre propre impl√©mentation de Circuit Breaking and Service Discovery dans le langage de programmation X, Y ou Z. Tout cela et bien plus est disponible d√®s le d√©part dans Istio et ne n√©cessite <b>aucune</b> modification du code. <br><br>  Super!  Maintenant, vous voudrez peut-√™tre partir en voyage avec Istio, mais il y a encore des doutes, des questions ouvertes.  S'il s'agit d'une solution universelle pour toutes les occasions de la vie, alors vous avez un soup√ßon l√©gitime: apr√®s tout, toutes ces d√©cisions s'av√®rent en r√©alit√© inadapt√©es √† toute occasion. <br><br>  Et enfin, vous demandez: "Est-il personnalisable?" <br><br>  Vous √™tes maintenant pr√™t pour un voyage en mer - et familiarisons-nous avec le plan de contr√¥le. <br><br><h2>  Avion de contr√¥le </h2><br>  Il se compose de trois composants: <b>Pilot</b> , <b>Mixer</b> et <b>Citadel</b> , qui travaillent ensemble pour configurer les Envoys pour acheminer le trafic, appliquer des politiques et collecter des donn√©es de t√©l√©m√©trie.  Sch√©matiquement, tout cela ressemble √† ceci: <br><br><img src="https://habrastorage.org/webt/dw/p6/hh/dwp6hh6y5g41oinfxccixuutkyo.png"><br>  <i>Interaction du plan de contr√¥le avec le plan de donn√©es</i> <br><br>  Les envoy√©s (c'est-√†-dire le plan de donn√©es) sont configur√©s √† l'aide de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Kubernetes CRD</a> (d√©finitions de ressources personnalis√©es) d√©finies par Istio et sp√©cialement con√ßues √† cet effet.  Pour vous, cela signifie qu'ils semblent √™tre la prochaine ressource de Kubernetes avec une syntaxe famili√®re.  Apr√®s sa cr√©ation, cette ressource sera r√©cup√©r√©e par le plan de contr√¥le et appliqu√©e aux Envoy√©s. <br><br><h2>  Ratio de service pour Istio </h2><br>  Nous avons d√©crit l'attitude d'Istio envers les services, mais pas l'inverse: comment les services sont-ils li√©s √† Istio? <br><br>  Honn√™tement, Istio conna√Æt la pr√©sence des services ainsi que des poissons - de l'eau, quand ils se demandent: ¬´Qu'est-ce que l'eau en g√©n√©ral?¬ª. <br><br><img src="https://habrastorage.org/webt/re/oi/ff/reoiffespub6tknffwssilkgu7c.jpeg"><br>  <i>Illustration de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Victoria Dimitrakopoulos</a> : - Comment aimez-vous l'eau?</i>  <i>- Qu'est-ce que l'eau en g√©n√©ral?</i> <br><br>  Ainsi, vous pouvez prendre un cluster fonctionnel et apr√®s le d√©ploiement des composants Istio, les services qui y sont situ√©s continueront de fonctionner, et apr√®s la suppression de ces composants, tout ira √† nouveau correctement.  Il est clair que ce faisant, vous perdrez les opportunit√©s offertes par Istio. <br><br>  Assez de th√©orie - mettons ces connaissances en pratique! <br><br><h2>  Istio en pratique </h2><br>  Istio n√©cessite un cluster Kubernetes dans lequel au moins 4 vCPU et 8 Go de RAM sont disponibles.  Pour augmenter rapidement le cluster et suivre les instructions de l'article, je recommande d'utiliser la plate-forme Google Cloud, qui offre aux nouveaux utilisateurs <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">gratuitement 300 $</a> . <br><br>  Apr√®s avoir cr√©√© un cluster et configur√© l'acc√®s √† Kubernetes via l'utilitaire de console, vous pouvez installer Istio via le gestionnaire de packages Helm. <br><br><h2>  Installation du casque </h2><br>  Installez le client Helm sur votre ordinateur, comme on dit dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation officielle</a> .  Nous l'utiliserons pour g√©n√©rer des mod√®les pour l'installation d'Istio dans la section suivante. <br><br><h2>  Installer Istio </h2><br>  T√©l√©chargez les ressources Istio √† partir de la <a href="">derni√®re version</a> <i>(le lien de l'auteur d'origine vers la version 1.0.5 est remplac√© par celui actuel, c'est-√†-dire 1.0.6 - environ la traduction)</i> , extrayez le contenu dans un r√©pertoire, que j'appellerai √† l'avenir <code>[istio-resources]</code> . <br><br>  Pour faciliter l'identification des ressources Istio, cr√©ez l'espace de noms <code>istio-system</code> dans le cluster K8s: <br><br><pre> <code class="bash hljs">$ kubectl create namespace istio-system</code> </pre> <br>  Terminez l'installation en allant dans le <code>[istio-resources]</code> et en ex√©cutant la commande: <br><br><pre> <code class="bash hljs">$ helm template install/kubernetes/helm/istio \ --<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> global.mtls.enabled=<span class="hljs-literal"><span class="hljs-literal">false</span></span> \ --<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> tracing.enabled=<span class="hljs-literal"><span class="hljs-literal">true</span></span> \ --<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> kiali.enabled=<span class="hljs-literal"><span class="hljs-literal">true</span></span> \ --<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> grafana.enabled=<span class="hljs-literal"><span class="hljs-literal">true</span></span> \ --namespace istio-system &gt; istio.yaml</code> </pre> <br>  Cette commande affichera les composants cl√©s d'Istio dans le fichier <code>istio.yaml</code> .  Nous avons chang√© le mod√®le standard pour nous-m√™mes, en sp√©cifiant les param√®tres suivants: <br><br><ul><li>  <code>global.mtls.enabled</code> d√©fini sur <code>false</code> <i>(c'est-√†-dire que l'authentification mTLS est d√©sactiv√©e - environ la traduction)</i> pour simplifier notre processus de datation; </li><li>  <code>tracing.enabled</code> active le tra√ßage des requ√™tes √† l'aide de Jaeger; </li><li>  <code>kiali.enabled</code> installe Kiali dans un cluster pour visualiser les services et le trafic; </li><li>  <code>grafana.enabled</code> d√©finit Grafana pour visualiser les m√©triques collect√©es. </li></ul><br>  Nous appliquons les ressources g√©n√©r√©es avec la commande: <br><br><pre> <code class="bash hljs">$ kubectl apply -f istio.yaml</code> </pre> <br>  L'installation d'Istio dans le cluster est termin√©e!  Attendez que tous les pods de l'espace de noms <code>istio-system</code> soient en <code>Running</code> ou <code>Completed</code> en ex√©cutant la commande ci-dessous: <br><br><pre> <code class="bash hljs">$ kubectl get pods -n istio-system</code> </pre> <br>  Maintenant, nous sommes pr√™ts √† continuer dans la section suivante, o√π nous l√®verons et lancerons l'application. <br><br><h2>  Architecture d'application de l'analyse des sentiments </h2><br>  Prenons un exemple de l'application de microservice Sentiment Analysis utilis√©e dans l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article d'introduction</a> d√©j√† mentionn√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">dans Kubernetes</a> .  Il est suffisamment sophistiqu√© pour montrer les capacit√©s d'Istio dans la pratique. <br><br>  L'application se compose de quatre microservices: <br><br><ol><li>  Service <b>SA-Frontend</b> , qui sert des applications frontales sur Reactjs; </li><li>  Un service <b>SA-WebApp</b> qui sert les demandes d'analyse de sentiment; </li><li>  Service <b>SA-Logic</b> , qui effectue une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">analyse sentimentale</a> ; </li><li>  Service <b>SA-Feedback</b> , qui re√ßoit les commentaires des utilisateurs sur la pr√©cision de l'analyse. </li></ol><br><img src="https://habrastorage.org/webt/hi/jv/oc/hijvoc4y7ercttsbopo4jzbo4w4.png"><br><br>  Dans ce diagramme, en plus des services, nous voyons √©galement le contr√¥leur d'entr√©e, qui dans Kubernetes achemine les demandes entrantes vers les services correspondants.  Istio utilise un concept similaire dans la passerelle d'entr√©e, dont les d√©tails suivront. <br><br><h2>  Lancement d'une application avec un proxy depuis Istio </h2><br>  Pour les autres op√©rations mentionn√©es dans l'article, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">clonez le</a> r√©f√©rentiel <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">istio-mastery</a> .  Il contient l'application et les manifestes pour Kubernetes et Istio. <br><br><h3>  Insert Sidecar </h3><br>  L'insertion peut se faire <b>automatiquement</b> ou <b>manuellement</b> .  Pour ins√©rer automatiquement des conteneurs sidecar, vous devez d√©finir l' <code>istio-injection=enabled</code> sur l' <code>istio-injection=enabled</code> , ce qui se fait par la commande suivante: <br><br><pre> <code class="bash hljs">$ kubectl label namespace default istio-injection=enabled namespace/default labeled</code> </pre> <br>  D√©sormais, chaque pod qui sera d√©ploy√© dans l'espace de noms par d√©faut recevra son conteneur side-car.  Pour v√©rifier cela, installons une application de test en allant dans le r√©pertoire racine du <code>[istio-mastery]</code> et en ex√©cutant la commande suivante: <br><br><pre> <code class="bash hljs">$ kubectl apply -f resource-manifests/kube persistentvolumeclaim/sqlite-pvc created deployment.extensions/sa-feedback created service/sa-feedback created deployment.extensions/sa-frontend created service/sa-frontend created deployment.extensions/sa-logic created service/sa-logic created deployment.extensions/sa-web-app created service/sa-web-app created</code> </pre> <br>  Apr√®s avoir √©tendu les services, nous v√©rifierons que les pods ont deux conteneurs (avec le service lui-m√™me et son side-car), en ex√©cutant la commande <code>kubectl get pods</code> et en nous assurant que la valeur <code>2/2</code> indiqu√©e sous la colonne <code>READY</code> , symbolisant que les deux conteneurs sont en cours d'ex√©cution: <br><br><pre> <code class="bash hljs">$ kubectl get pods NAME READY STATUS RESTARTS AGE sa-feedback-55f5dc4d9c-c9wfv 2/2 Running 0 12m sa-frontend-558f8986-hhkj9 2/2 Running 0 12m sa-logic-568498cb4d-2sjwj 2/2 Running 0 12m sa-logic-568498cb4d-p4f8c 2/2 Running 0 12m sa-web-app-599cf47c7c-s7cvd 2/2 Running 0 12m</code> </pre> <br>  Visuellement, cela ressemble √† ceci: <br><br><img src="https://habrastorage.org/webt/x9/kt/lu/x9ktluxxjopen7rn9tchuyvvioi.png"><br>  <i>Envoy√© par procuration dans l'un des pods</i> <br><br>  Maintenant que l'application est op√©rationnelle, nous devons autoriser le trafic entrant √† entrer dans l'application. <br><br><h2>  Passerelle d'entr√©e </h2><br>  La meilleure pratique pour y parvenir (pour autoriser le trafic dans le cluster) consiste √† passer par la <b>passerelle d'entr√©e</b> √† Istio, qui est situ√©e √† la ¬´fronti√®re¬ª du cluster et vous permet d'activer les fonctionnalit√©s Istio telles que le routage, l'√©quilibrage de charge, la s√©curit√© et la surveillance du trafic entrant. <br><br>  Le composant Ingress Gateway et le service qui le transf√®re √† l'ext√©rieur ont √©t√© install√©s dans le cluster lors de l'installation d'Istio.  Pour conna√Ætre l'adresse IP externe d'un service, proc√©dez comme suit: <br><br><pre> <code class="bash hljs">$ kubectl get svc -n istio-system -l istio=ingressgateway NAME TYPE CLUSTER-IP EXTERNAL-IP istio-ingressgateway LoadBalancer 10.0.132.127 13.93.30.120</code> </pre> <br>  Nous continuerons √† acc√©der √† l'application sur cette IP (je vais l'appeler EXTERNAL-IP), donc pour plus de commodit√©, nous allons √©crire la valeur dans une variable: <br><br><pre> <code class="bash hljs">$ EXTERNAL_IP=$(kubectl get svc -n istio-system \ -l app=istio-ingressgateway \ -o jsonpath=<span class="hljs-string"><span class="hljs-string">'{.items[0].status.loadBalancer.ingress[0].ip}'</span></span>)</code> </pre> <br>  Si vous essayez d'acc√©der √† cette adresse IP via un navigateur maintenant, vous recevrez une erreur Service non disponible, car  <b>Par d√©faut, Istio bloque tout le trafic entrant</b> jusqu'√† ce qu'une passerelle soit d√©finie. <br><br><h2>  Ressource de passerelle </h2><br>  La passerelle est un CRD (d√©finition de ressource personnalis√©e) dans Kubernetes, d√©fini apr√®s l'installation d'Istio dans un cluster et l'activation de la capacit√© de sp√©cifier les ports, le protocole et les h√¥tes pour lesquels nous voulons autoriser le trafic entrant. <br><br>  Dans notre cas, nous voulons autoriser le trafic HTTP vers le port 80 pour tous les h√¥tes.  La t√¢che est impl√©ment√©e par la d√©finition suivante <i>( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://gist.github.com/rinormaloku/577d0e23590f7a8dfbe56fe2a1f853d7&amp;usg=ALkJrhgkUcrXzb7Qh-njfm3DC6Df4rWyJA#file-">http-gateway.yaml</a> )</i> : <br><br><pre> <code class="plaintext hljs">apiVersion: networking.istio.io/v1alpha3 kind: Gateway metadata: name: http-gateway spec: selector: istio: ingressgateway servers: - port: number: 80 name: http protocol: HTTP hosts: - "*"</code> </pre> <br>  Cette configuration n'a besoin d'aucune explication √† l'exception du <code>istio: ingressgateway</code> .  Avec ce s√©lecteur, nous pouvons indiquer √† quelle passerelle d'entr√©e la configuration est appliqu√©e.  Dans notre cas, il s'agit du contr√¥leur Ingress Gateway, qui a √©t√© install√© par d√©faut dans Istio. <br><br>  La configuration est appliqu√©e en appelant la commande suivante: <br><br><pre> <code class="bash hljs">$ kubectl apply -f resource-manifests/istio/http-gateway.yaml gateway.networking.istio.io/http-gateway created</code> </pre> <br>  Maintenant, la passerelle permet d'acc√©der au port 80, mais n'a aucune id√©e o√π acheminer les demandes.  Cela n√©cessitera des <b>services virtuels</b> . <br><br><h2>  Ressource VirtualService </h2><br>  VirtualService indique √† Ingress Gateway comment acheminer les demandes autoris√©es dans le cluster. <br><br>  Les demandes √† notre application via la passerelle http doivent √™tre envoy√©es aux services sa-frontend, sa-web-app et sa-feedback: <br><br><img src="https://habrastorage.org/webt/zi/il/7_/ziil7_-9gfy5ejkhkzzn1wpxkxe.png"><br>  <i>Itin√©raires √† configurer avec VirtualServices</i> <br><br>  Tenez compte des demandes qui doivent √™tre envoy√©es √† SA-Frontend: <br><br><ul><li>  Une correspondance exacte sur le chemin <code>/</code> doit √™tre envoy√©e √† SA-Frontend pour obtenir index.html; </li><li>  Les chemins pr√©fix√©s avec <code>/static/*</code> doivent √™tre envoy√©s √† SA-Frontend pour recevoir les fichiers statiques utilis√©s dans le frontend, tels que CSS et JavaScript; </li><li>  Les chemins qui rel√®vent de l'expression r√©guli√®re <code>'^.*\.(ico|png|jpg)$'</code> doivent √™tre envoy√©s √† SA-Frontend, car  Ce sont les images affich√©es sur la page. </li></ul><br>  L'impl√©mentation est r√©alis√©e par la configuration suivante <i>( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sa-virtualservice-external.yaml</a> ):</i> <br><br><pre> <code class="plaintext hljs">kind: VirtualService metadata: name: sa-external-services spec: hosts: - "*" gateways: - http-gateway # 1 http: - match: - uri: exact: / - uri: exact: /callback - uri: prefix: /static - uri: regex: '^.*\.(ico|png|jpg)$' route: - destination: host: sa-frontend # 2 port: number: 80</code> </pre> <br>  Points importants: <br><br><ol><li>  Ce VirtualService fait r√©f√©rence aux demandes provenant de la <b>passerelle http</b> ; </li><li>  <code>destination</code> d√©finit le service auquel les demandes sont envoy√©es. </li></ol><br>  <b>Remarque</b> : La configuration ci-dessus est stock√©e dans le fichier <code>sa-virtualservice-external.yaml</code> , qui contient √©galement les param√®tres de routage dans SA-WebApp et SA-Feedback, mais a √©t√© raccourci ici dans l'article par souci de concision. <br><br>  Appliquez VirtualService en appelant: <br><br><pre> <code class="bash hljs">$ kubectl apply -f resource-manifests/istio/sa-virtualservice-external.yaml virtualservice.networking.istio.io/sa-external-services created</code> </pre> <br>  <b>Remarque</b> : Lorsque nous utilisons des ressources Istio, le serveur API Kubernetes d√©clenche un √©v√©nement qui re√ßoit le plan de contr√¥le Istio, puis la nouvelle configuration est appliqu√©e aux proxys Envoy de chaque module.  Et le contr√¥leur Ingress Gateway semble √™tre le prochain Envoy configur√© dans Control Plane.  Tout cela sur le diagramme ressemble √† ceci: <br><br><img src="https://habrastorage.org/webt/dz/nz/4b/dznz4bh_wpzcv7tx8jkykkiad9q.png"><br>  <i>Configuration Istio-IngressGateway pour le routage des requ√™tes</i> <br><br>  L'analyse des sentiments est disponible sur <code>http://{EXTERNAL-IP}/</code> .  Ne vous inqui√©tez pas si vous obtenez le statut Introuvable: <i>il faut parfois un peu plus de temps pour que la configuration prenne effet et les caches Envoy soient mis √† jour</i> . <br><br>  Avant de continuer, travaillez un peu avec l'application pour g√©n√©rer du trafic <i>(sa pr√©sence est n√©cessaire pour plus de clart√© dans les prochaines √©tapes - environ Transl.)</i> . <br><br><h2>  Kiali: observabilit√© </h2><br>  Pour acc√©der √† l'interface d'administration de Kiali, ex√©cutez la commande suivante: <br><br><pre> <code class="bash hljs">$ kubectl port-forward \ $(kubectl get pod -n istio-system -l app=kiali \ -o jsonpath=<span class="hljs-string"><span class="hljs-string">'{.items[0].metadata.name}'</span></span>) \ -n istio-system 20001</code> </pre> <br>  ... et ouvrez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">http: // localhost: 20001 /</a> , en vous connectant en tant qu'admin / admin.  Vous trouverez ici de nombreuses fonctionnalit√©s utiles, par exemple, pour v√©rifier la configuration des composants Istio, visualiser les services en fonction des informations collect√©es lors de l'interception des demandes r√©seau et recevoir des r√©ponses aux questions ¬´Qui contacte qui?¬ª, ¬´Quelle version du service plante?¬ª  etc.  En g√©n√©ral, explorez les possibilit√©s de Kiali avant de passer √† la visualisation des m√©triques avec Grafana. <br><br><img src="https://habrastorage.org/webt/ix/pd/wr/ixpdwrppiekv0dbk3xcbceasft8.png"><br><br><h2>  Grafana: visualisation des m√©triques </h2><br>  Les m√©triques collect√©es dans Istio entrent dans Prom√©th√©e et visualis√©es avec Grafana.  Pour acc√©der √† l'interface d'administration de Grafana, ex√©cutez la commande ci-dessous, puis ouvrez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">http: // localhost: 3000 /</a> : <br><br><pre> <code class="bash hljs">$ kubectl -n istio-system port-forward \ $(kubectl -n istio-system get pod -l app=grafana \ -o jsonpath={.items[0].metadata.name}) 3000</code> </pre> <br>  En cliquant sur le menu <b>Accueil</b> en haut √† gauche et en s√©lectionnant <b>Istio Service Dashboard</b> dans le coin sup√©rieur gauche, commencez par le service <b>sa-web-app</b> pour consulter les m√©triques collect√©es: <br><br><img src="https://habrastorage.org/webt/wb/vz/4t/wbvz4tkgi3qgoitxhhwhppk9pu8.png"><br><br>  Ici, nous attendons une performance vide et compl√®tement ennuyeuse - la direction ne l'approuvera jamais.  Cr√©ons une petite charge avec la commande suivante: <br><br><pre> <code class="bash hljs">$ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> \ curl -i http://<span class="hljs-variable"><span class="hljs-variable">$EXTERNAL_IP</span></span>/sentiment \ -H <span class="hljs-string"><span class="hljs-string">"Content-type: application/json"</span></span> \ -d <span class="hljs-string"><span class="hljs-string">'{"sentence": "I love yogobella"}'</span></span>; \ sleep .8; <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre> <br>  Nous avons maintenant des graphiques beaucoup plus agr√©ables, et en plus d'eux, de merveilleux outils Prometheus pour la surveillance et Grafana pour la visualisation des m√©triques, qui nous permettront d'en savoir plus sur les performances, l'√©tat de sant√©, les am√©liorations / la d√©gradation des services au fil du temps. <br><br>  Enfin, regardons la trace des demandes dans les services. <br><br><h2>  Jaeger: trace </h2><br>  Nous aurons besoin de recherches, car plus nous avons de services, plus il est difficile de trouver la cause de l'√©chec.  Regardons un cas simple de l'image ci-dessous: <br><br><img src="https://habrastorage.org/webt/dv/8w/iv/dv8wivmvfn20fvmaebzk8wl6h68.png"><br>  <i>Un exemple typique d'une demande √©chou√©e au hasard</i> <br><br>  La demande vient, tombe - <i>quelle est la raison?</i>  <i>Premier service?</i>  <i>Ou le second?</i>  Il y a des exceptions dans les deux - regardons les journaux de chacun.  √Ä quelle fr√©quence vous trouvez-vous en train de faire cela?  Notre travail ressemble plus √† des d√©tectives de logiciels qu'√† des d√©veloppeurs ... <br><br>  Il s'agit d'un probl√®me r√©pandu dans les microservices et il est r√©solu par des syst√®mes de trace distribu√©s dans lesquels les services se transmettent un en-t√™te unique, apr√®s quoi ces informations sont redirig√©es vers le syst√®me de trace, o√π elles sont mapp√©es aux donn√©es de demande.  En voici une illustration: <br><br><img src="https://habrastorage.org/webt/an/_h/tz/an_htzqnc3b4xxhgkzdqi5my-ki.png"><br>  <i>TraceId est utilis√© pour identifier la demande.</i> <br><br>  Istio utilise Jaeger Tracer, qui impl√©mente une infrastructure API OpenTracing ind√©pendante du fournisseur.  Vous pouvez acc√©der √† l'interface utilisateur Jaeger avec la commande suivante: <br><br><pre> <code class="bash hljs">$ kubectl port-forward -n istio-system \ $(kubectl get pod -n istio-system -l app=jaeger \ -o jsonpath=<span class="hljs-string"><span class="hljs-string">'{.items[0].metadata.name}'</span></span>) 16686</code> </pre> <br>  Allez maintenant sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">http: // localhost: 16686 /</a> et s√©lectionnez le service <b>sa-web-app</b> .  Si le service n'est pas affich√© dans le menu d√©roulant, affichez / g√©n√©rez l'activit√© sur la page et mettez √† jour l'interface.  Apr√®s cela, cliquez sur le bouton <b>Rechercher les traces</b> , qui affichera les derni√®res traces - s√©lectionnez-en une - des informations d√©taill√©es sur toutes les traces appara√Ætront: <br><br><img src="https://habrastorage.org/webt/r8/zx/1q/r8zx1qjxc2a316-4a803l4vmzv4.png"><br><br>  Cette trace montre: <br><br><ol><li>  La demande est <b>envoy√©e</b> √† <b>istio-ingressgateway</b> (il s'agit de la premi√®re interaction avec l'un des services, et l'ID de trace est g√©n√©r√© pour la demande), apr√®s quoi la passerelle envoie la demande au service <b>sa-web-app</b> . </li><li>  Dans le service <b>sa-web-app, la</b> demande est r√©cup√©r√©e par Envoy sidecar, un ¬´enfant¬ª est cr√©√© dans la plage (donc nous le voyons dans les traces) et redirig√© vers le conteneur <b>sa-web-app</b> .  <i>(La <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">port√©e</a> est une unit√© de travail logique dans Jaeger qui a un nom, l'heure de d√©but de l'op√©ration et sa dur√©e. Les port√©es peuvent √™tre imbriqu√©es et ordonn√©es. Un graphique acyclique dirig√© √† partir des port√©es forme une trace. - Env. Transl.)</i> </li><li>  Ici, la demande est trait√©e par la m√©thode <b>sentimentAnalysis</b> .  Ces traces sont d√©j√† g√©n√©r√©es par l'application, c'est-√†-dire  ils ont exig√© des changements au code. </li><li>  A partir de ce moment, une requ√™te POST √† <b>sa-logic est</b> initi√©e.  L'ID de trace doit √™tre transf√©r√© depuis <b>sa-web-app</b> . </li><li>  ... </li></ol><br>  <b>Remarque</b> : √† l'√©tape 4, l'application doit voir les en-t√™tes g√©n√©r√©s par Istio et les transmettre aux demandes suivantes, comme indiqu√© dans l'image ci-dessous: <br><br><img src="https://habrastorage.org/webt/qg/a9/ai/qga9aibwkynfogbcxfo2cnwqxfm.png"><br>  <i>(A) Istio est responsable de la transmission des en-t√™tes;</i>  <i><b>(B) Les services sont responsables des en-t√™tes.</b></i> <br><br>  Istio fait l'essentiel du travail, comme  g√©n√®re des en-t√™tes pour les demandes entrantes, cr√©e de nouvelles √©tendues dans chaque sidecare et les transf√®re.  Cependant, sans travailler avec les en-t√™tes √† l'int√©rieur des services, le chemin de trace complet de la demande sera perdu. <br><br>  Les rubriques suivantes doivent √™tre prises en compte (transmises): <br><br><pre> <code class="plaintext hljs">x-request-id x-b3-traceid x-b3-spanid x-b3-parentspanid x-b3-sampled x-b3-flags x-ot-span-context</code> </pre> <br>  C'est une t√¢che simple, cependant, pour simplifier sa mise en ≈ìuvre, de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">nombreuses biblioth√®ques</a> existent d√©j√† - par exemple, dans le service sa-web-app, le client RestTemplate transmet ces en-t√™tes si vous ajoutez simplement les biblioth√®ques Jaeger et OpenTracing en fonction de <a href="">celui-ci</a> . <br><br>  <i>Notez que l'application Sentiment Analysis illustre les impl√©mentations sur Flask, Spring et ASP.NET Core.</i> <br><br>  Maintenant que nous savons ce que nous sortons de la bo√Æte (ou presque ¬´hors de la bo√Æte¬ª), consid√©rons les probl√®mes de routage finement r√©gl√©, de gestion du trafic r√©seau, de s√©curit√©, etc.! <br><br>  <i><b>Remarque</b></i>  <i><b>perev.</b></i>  <i>: Lisez √† ce sujet dans le prochain √©pisode d'Istio de Rinor Maloku, qui sera disponible sur notre blog dans un proche avenir.</i>  <i><b>MISE √Ä JOUR</b> (14 mars): <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">La deuxi√®me partie</a> a d√©j√† √©t√© publi√©e.</i> <br><br><h2>  PS du traducteur </h2><br>  Lisez aussi dans notre blog: <br><br><ul><li>  ¬´Retour aux microservices avec Istio¬ª: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">partie 2 (routage, contr√¥le du trafic)</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">partie 3 (authentification et autorisation)</a> ; </li><li>  ¬´ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Conduit - un maillage de service l√©ger pour Kubernetes</a> ¬ª; </li><li>  ¬´ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Qu'est-ce qu'un maillage de service et pourquoi en ai-je besoin [pour une application cloud avec microservices]?</a>  "; </li><li>  ¬´ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Un guide illustr√© du r√©seautage chez Kubernetes.¬ª</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Parties 1 et 2</a> "; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Comment ce sidecar est-il arriv√© ici [√† Kubernetes]?"</a>  ". </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr438426/">https://habr.com/ru/post/fr438426/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr438412/index.html">Analyse des t√¢ches de test 112654 et des tendances sur le march√© du travail des programmeurs en 2019</a></li>
<li><a href="../fr438414/index.html">Civilisation printani√®re, 3/5</a></li>
<li><a href="../fr438416/index.html">√Ä propos des hormones</a></li>
<li><a href="../fr438420/index.html">L'IA en 2019: l'√©tat actuel des choses</a></li>
<li><a href="../fr438422/index.html">Un programme √©lectif contre les blessures (deuxi√®me partie): Longue distance en premiers soins et r√©animation</a></li>
<li><a href="../fr438428/index.html">Les agences gouvernementales ont trouv√© un moyen de saboter les logiciels nationaux</a></li>
<li><a href="../fr438430/index.html">Je suis coinc√©! Ou comment surmonter l'effet plateau en apprenant l'anglais</a></li>
<li><a href="../fr438434/index.html">Hacker Lab: P1. Libssh auth bypass</a></li>
<li><a href="../fr438436/index.html">L'id√©e de fournir aux employ√©s un acc√®s temporaire aux ressources des clients sans avoir √† refaire briller les mots de passe</a></li>
<li><a href="../fr438438/index.html">Nourriture pour perroquets Bitrix. Nous testons les performances, s√©lectionnons le fer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>