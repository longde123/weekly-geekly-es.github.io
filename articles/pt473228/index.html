<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçß üèÇ üíª Colocando o Perl direto desde 1987 üíó üë®üèª‚Äçüè≠ üßöüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Depois de ler as not√≠cias ‚Äú C√≥digo interpretador Perl portado oficialmente para o GitHub ‚Äù no LINUX.ORG.RU, decidi dar uma olhada no reposit√≥rio Perl ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Colocando o Perl direto desde 1987</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/473228/"> Depois de ler as not√≠cias ‚Äú <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" title="C√≥digo de int√©rprete Perl oficialmente portado para o GitHub, not√≠cias sobre o recurso LINUX.ORG.RU">C√≥digo interpretador Perl portado oficialmente para o GitHub</a> ‚Äù no LINUX.ORG.RU, decidi dar uma olhada no reposit√≥rio Perl 5, que j√° est√° no GitHub. <br><br>  √â incr√≠vel como tremendamente e qualitativamente eles o transferiram, preservando n√£o apenas absolutamente toda a hist√≥ria de 32 anos do projeto, mas tamb√©m relat√≥rios de erros (entrando em problemas), patches (entrando em PRs), lan√ßamentos e ramifica√ß√µes.  A inscri√ß√£o " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" title="32 anos atr√°s, em arquivos de origem Perl, reposit√≥rio oficial do Perl 5 GitHub.">32 years ago</a> " ao lado dos arquivos causa um sorriso involunt√°rio. <br><br>  O que mais fazer nesta sexta-feira mon√≥tona, quando chuva e neve desagradam na rua, e todos os caminhos est√£o atolados na lama do outono?  √â isso mesmo, olhos vermelhos!  Portanto, para fins de experi√™ncia e interesse, decidi montar e montar o Perl antigo em uma moderna m√°quina x86_64 com a vers√£o mais recente do <strong>GCC 9.2.0</strong> como compilador.  Esse c√≥digo antigo pode passar no teste do tempo? <br><br><div style="text-align:center;"><img title="Demonstra√ß√£o do twm, um dos primeiros gerenciadores de janelas do X Window System, em uma distribui√ß√£o moderna do Arch Linux." src="https://habrastorage.org/webt/-0/d5/wt/-0d5wtkg6ylqdd-h5g1hbtdiypi.png"></div><br>  <i>Demonstra√ß√£o do <strong>twm</strong> , um dos primeiros gerenciadores de janelas do X Window System, em uma distribui√ß√£o moderna do Arch Linux.</i> <br><br>  Para ser completamente aut√™ntico e nekromantnenko, implantei uma m√°quina virtual com o X e o gerenciador de janelas bare, que tamb√©m √© de 1987.  Quem sabe, talvez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" title="Larry Wall, p√°gina da Wikipedia.">Larry Wall tenha</a> escrito seu Perl usando exatamente dois <strong>twm</strong> , por assim dizer, a <em>tecnologia de ponta da</em> √©poca.  A distribui√ß√£o usada √© o Arch Linux.  S√≥ porque existem algumas coisas √∫teis em seu reposit√≥rio que foram √∫teis mais tarde.  Ent√£o vamos l√°! <br><a name="habracut"></a><br><a name="article-content"></a><h2>  Conte√∫do: </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">1. Prepara√ß√£o do meio ambiente</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">2. Configurando o c√≥digo fonte</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">3. Erros no arquivo de gram√°tica Yacc</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">4. Erros de compila√ß√£o do c√≥digo em "C"</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">5. Corre√ß√£o de alguns erros Falha na segmenta√ß√£o</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">6. Resumir</a> <br><br><a name="environment"></a><h2>  1. Prepara√ß√£o do meio ambiente </h2><br>  Primeiro, instalamos em um sistema operacional implantado em uma m√°quina virtual todo o conjunto de utilit√°rios e compiladores necess√°rios para montar e editar o c√≥digo-fonte: <strong>gcc</strong> , <strong>make</strong> , <strong>vim</strong> , <strong>git</strong> , <strong>gdb</strong> , etc. Alguns deles j√° est√£o instalados, enquanto outros est√£o dispon√≠veis no meta-pacote <strong>base-devel</strong> , ele deve ser instalado se n√£o estiver instalado.  Depois que o ambiente estiver pronto para a a√ß√£o, obtemos uma c√≥pia do c√≥digo-fonte Perl de 32 anos! <br><br><pre><code class="bash hljs">$ git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/Perl/perl5/ --depth=1 -b perl-1.0</code> </pre> <br>  Gra√ßas aos recursos do Git, n√£o precisamos arrastar muitos arquivos para chegar ao primeiro lan√ßamento do projeto: <br><br><pre> <code class="plaintext hljs">* commit 8d063cd8450e59ea1c611a2f4f5a21059a2804f1 (grafted, HEAD, tag: perl-1.0) Commit: Larry Wall &lt;lwall@jpl-devvax.jpl.nasa.gov&gt; CommitDate: Fri Dec 18 00:00:00 1987 +0000 a "replacement" for awk and sed</code> </pre><br>  Apenas baixamos uma pequena quantidade de dados e, como resultado, o reposit√≥rio com o c√≥digo-fonte da primeira vers√£o do Perl leva apenas 150 KB. <br><br>  Naquele momento sombrio e denso, n√£o havia algo elementar como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" title="Ferramentas autom√°ticas GNU, p√°gina da Wikipedia.">autotools</a> ( <em>que b√™n√ß√£o!</em> ). No entanto, existe um script <strong>Configure</strong> na raiz do reposit√≥rio.  Qual √© o problema?  Mas o fato √© que Larry Wall √© o inventor de tais scripts que permitiram gerar Makefiles para as m√°quinas UNIX mais heterog√™neas da √©poca.  Como diz o artigo da Wikipedia sobre os scripts de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" title="Configure o script, Hist√≥rico, p√°gina da Wikipedia.">mesmo nome</a> , Larry Wall forneceu ao arquivo <strong>Configure</strong> alguns de seus softwares, por exemplo, um leitor de not√≠cias <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" title="rn, Leitor de not√≠cias, p√°gina da Wikipedia.">rn</a> , mais tr√™s anos antes de escrever Perl.  Posteriormente, o Perl n√£o foi exce√ß√£o, e um script que j√° foi executado em muitas m√°quinas foi usado para constru√≠-lo.  Mais tarde, outros desenvolvedores, por exemplo, programadores da Trolltech, tamb√©m adotaram essa id√©ia.  Eles usaram um script semelhante para configurar a constru√ß√£o de sua estrutura Qt, que muitas pessoas confundem com o <strong>configure a</strong> partir de <strong>ferramentas autom√°ticas</strong> .  Foi o zool√≥gico desses scripts de diferentes desenvolvedores que serviu de impulso para a cria√ß√£o de ferramentas para sua gera√ß√£o simplificada e autom√°tica. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><em>&lt;&lt; Pular para o conte√∫do</em></a> <br><br><a name="configure"></a><h2>  2. Configurando o c√≥digo fonte </h2><br>  O script <strong>Configure</strong> da "velha escola", que j√° √© evidente em seu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" title="Shebang, Unix, p√°gina da Wikipedia.">Shebang</a> ', que tem um espa√ßo: <br><br><pre> <code class="bash hljs">$ cat Configure | head -5 <span class="hljs-comment"><span class="hljs-comment">#! /bin/sh # # If these # comments don't work, trim them. Don't worry about any other # shell scripts, Configure will trim # comments from them for you. #</span></span></code> </pre><br>  De acordo com o coment√°rio, verifica-se que havia conchas nos scripts dos quais n√£o era poss√≠vel deixar coment√°rios!  A situa√ß√£o espacial parece incomum, mas uma vez que essa era a norma, consulte o link para mais informa√ß√µes <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" title="√â permitido espa√ßo entre #! e / bin / bash em shebang? - Unix e Linux Stack Exchange.">aqui</a> .  Mais importante ainda, n√£o h√° diferen√ßa para os int√©rpretes modernos de shell, independentemente de haver um espa√ßo ou n√£o. <br><br>  Chega de letras, vamos ao que interessa!  Come√ßamos o script e vemos uma suposi√ß√£o interessante, que acaba n√£o sendo inteiramente verdadeira: <br><br><pre> <code class="plaintext hljs">$ ./Configure (I see you are using the Korn shell. Some ksh's blow up on Configure, especially on exotic machines. If yours does, try the Bourne shell instead.) Beginning of configuration questions for perl kit. Checking echo to see how to suppress newlines... ...using -n. Type carriage return to continue. Your cursor should be here--&gt;</code> </pre><br>  Surpreendentemente, o script √© interativo e cont√©m v√°rias informa√ß√µes de segundo plano.  O modelo de intera√ß√£o do usu√°rio √© constru√≠do em di√°logos, analisando as respostas para as quais o script altera seus par√¢metros, de acordo com o qual ele subsequentemente ir√° gerar Makefiles.  Eu estava pessoalmente interessado em verificar se todos os comandos do shell est√£o em vigor? <br><br><pre> <code class="plaintext hljs">Locating common programs... expr is in /bin/expr. sed is in /bin/sed. echo is in /bin/echo. cat is in /bin/cat. rm is in /bin/rm. mv is in /bin/mv. cp is in /bin/cp. tr is in /bin/tr. mkdir is in /bin/mkdir. sort is in /bin/sort. uniq is in /bin/uniq. grep is in /bin/grep. Don't worry if any of the following aren't found... test is in /bin/test. egrep is in /bin/egrep. I don't see Mcc out there, offhand.</code> </pre><br>  Aparentemente, antes disso estava longe do caso.  Gostaria de saber por que o utilit√°rio <strong>Mcc</strong> √© respons√°vel, o que n√£o foi encontrado?  O engra√ßado √© que esse script, nas melhores tradi√ß√µes de hackers da √©poca, √© cheio de humor amig√°vel.  Agora voc√™ dificilmente ver√° isso: <br><br><pre> <code class="plaintext hljs">Is your "test" built into sh? [n] (OK to guess) OK Checking compatibility between /bin/echo and builtin echo (if any)... They are compatible. In fact, they may be identical. Your C library is in /lib/libc.a. You're normal. Extracting names from /lib/libc.a for later perusal...done Hmm... Looks kind of like a USG system, but we'll see... Congratulations. You aren't running Eunice. It's not Xenix... Nor is it Venix... Checking your sh to see if it knows about # comments... Your sh handles # comments correctly. Okay, let's see if #! works on this system... It does. Checking out how to guarantee sh startup... Let's see if '#!/bin/sh' works... Yup, it does.</code> </pre><br>  Eu respondi a maioria das perguntas com o valor padr√£o ou com o que o script me ofereceu.  Particularmente satisfeito e surpreso foi o pedido de sinalizadores para o compilador e o vinculador: <br><br><pre> <code class="plaintext hljs">Any additional cc flags? [none] Any additional ld flags? [none]</code> </pre><br>  L√°, voc√™ pode escrever algo interessante, por exemplo, <strong>-m32</strong> para criar um arquivo execut√°vel de 32 bits ou uma biblioteca, necess√°ria durante a vincula√ß√£o.  Para a √∫ltima pergunta do script: <br><br><pre> <code class="plaintext hljs">Now you need to generate make dependencies by running "make depend". You might prefer to run it in background: "make depend &gt; makedepend.out &amp;" It can take a while, so you might not want to run it right now. Run make depend now? [n] y</code> </pre><br>  Eu respondi positivamente.  A julgar pela <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" title="makedepend, Hist√≥ria, p√°gina da Wikipedia.">p√°gina da</a> Wikipedia, o antigo utilit√°rio <strong>makedepend</strong> foi criado no in√≠cio da vida do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" title="Projeto Athena, p√°gina da Wikipedia.">projeto Athena</a> para facilitar o trabalho com Makefiles.  Este projeto nos deu o Sistema X Window, Kerberos, Zephyr e influenciou muitas outras coisas que hoje s√£o familiares.  Tudo isso √© maravilhoso, mas de onde vem esse utilit√°rio em um ambiente Linux moderno?  Ele tem sido usado por ningu√©m e em qualquer lugar.  Mas se voc√™ olhar atentamente para a raiz do reposit√≥rio, acontece que Larry Wall escreveu sua vers√£o de script substituta, que cuidadosamente desempacotamos e executamos o script de configura√ß√£o. <br><br>  <strong>O Makedepend foi</strong> conclu√≠do com alguns erros estranhos: <br><br><pre> <code class="bash hljs">./makedepend: <span class="hljs-built_in"><span class="hljs-built_in">command</span></span> substitution: line 82: unexpected EOF <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> looking <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> matching `<span class="hljs-string"><span class="hljs-string">''</span></span> ./makedepend: <span class="hljs-built_in"><span class="hljs-built_in">command</span></span> substitution: line 83: syntax error: unexpected end of file ./makedepend: <span class="hljs-built_in"><span class="hljs-built_in">command</span></span> substitution: line 82: unexpected EOF <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> looking <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> matching `<span class="hljs-string"><span class="hljs-string">''</span></span> ./makedepend: <span class="hljs-built_in"><span class="hljs-built_in">command</span></span> substitution: line 83: syntax error: unexpected end of file</code> </pre><br>  Talvez tenham sido eles que causaram o problema, devido ao qual os Makefiles gerados foram um pouco mastigados: <br><br><pre> <code class="bash hljs">$ make make: *** No rule to make target <span class="hljs-string"><span class="hljs-string">'&lt;built-in&gt;'</span></span>, needed by <span class="hljs-string"><span class="hljs-string">'arg.o'</span></span>. Stop.</code> </pre><br>  Eu absolutamente n√£o queria ir para a selva dos intrincados macarronetes do utilit√°rio <strong>makedepend</strong> e decidi examinar cuidadosamente os Makefiles, nos quais emergia um padr√£o estranho: <br><br><pre> <code class="plaintext hljs">arg.o: arg.c arg.o: arg.h arg.o: array.h arg.o: &lt;built-in&gt; arg.o: cmd.h arg.o: &lt;command-line&gt; arg.o: config.h arg.o: EXTERN.h ... array.o: arg.h array.o: array.c array.o: array.h array.o: &lt;built-in&gt; array.o: cmd.h array.o: &lt;command-line&gt; array.o: config.h array.o: EXTERN.h ...</code> </pre><br>  Aparentemente, algum utilit√°rio inseriu incorretamente seus argumentos no escapamento.  Pegando o utilit√°rio <s>ax</s> <strong>sed,</strong> decidi arrumar um pouco isso: <br><br><pre> <code class="bash hljs">$ sed -i <span class="hljs-string"><span class="hljs-string">'/built-in/d'</span></span> Makefile $ sed -i <span class="hljs-string"><span class="hljs-string">'/command-line/d'</span></span> Makefile</code> </pre><br>  Surpreendentemente, o truque funcionou e os Makefiles funcionaram como deveriam! <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><em>&lt;&lt; Pular para o conte√∫do</em></a> <br><br><a name="yacc"></a><h2>  3. Erros no arquivo de gram√°tica Yacc </h2><br>  Seria inacredit√°vel se o c√≥digo de 32 anos pegasse e montasse sem problemas.  Infelizmente, milagres n√£o acontecem.  Estudando a √°rvore de origem, deparei-me com um arquivo <strong>perl.y</strong> , que √© uma descri√ß√£o gramatical do utilit√°rio <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" title="yacc, p√°gina da Wikipedia.">yacc</a> , que h√° muito tempo √© substitu√≠do pelo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" title="GNU Bison, p√°gina da Wikipedia.">bison</a> nas distribui√ß√µes modernas.  O script localizado no caminho <strong>/ usr / bin / yacc</strong> simplesmente chama o <strong>bison</strong> no modo de compatibilidade com o <strong>yacc</strong> .  S√≥ que essa compatibilidade n√£o est√° completa e, ao processar esse arquivo, est√£o surgindo muitos erros, que eu n√£o sei como corrigir e realmente n√£o quero, porque h√° uma solu√ß√£o alternativa que aprendi recentemente. <br><br>  H√° apenas um ou dois anos, Helio Chissini de Castro, desenvolvedor do KDE, fez um trabalho semelhante e adaptou o KDE 1, 2 e o Qt 1, 2 aos ambientes e compiladores modernos.  Interessei-me pelo trabalho dele, baixei os c√≥digos-fonte dos projetos, mas durante a montagem me deparei com uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" title="Adapta√ß√£o moderna do Qt 2 por Helio Castro, Edi√ß√µes, reposit√≥rio GitHub.">armadilha</a> semelhante por causa da incompatibilidade de <strong>yacc</strong> e <strong>bison</strong> , que foram usados ‚Äã‚Äãpara criar a vers√£o antiga do metacompiler <strong>moc</strong> .  Posteriormente, consegui encontrar uma solu√ß√£o para esse problema na forma de substituir o <strong>bison</strong> pelo utilit√°rio <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" title="Berkeley Yacc, P√°gina oficial.">byacc</a> (Berkeley Yacc), que acabou sendo compat√≠vel com as gram√°ticas antigas do <strong>yacc</strong> e estava dispon√≠vel em muitas distribui√ß√µes Linux. <br><br>  Uma simples substitui√ß√£o do <strong>yacc</strong> pelo <strong>byacc</strong> no sistema de compila√ß√£o me ajudou, mas n√£o por muito tempo, porque um pouco mais tarde nas novas vers√µes do <strong>byacc eles</strong> ainda quebravam a compatibilidade com o <strong>yacc</strong> , interrompendo a depura√ß√£o associada √† entidade <strong>yydebug</strong> .  Portanto, tive que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" title="Corrija o erro de refer√™ncia indefinido, solicita√ß√µes pull, adapta√ß√£o moderna do Qt 2 por Helio Castro, reposit√≥rio GitHub.">corrigir</a> um pouco <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" title="Corrija o erro de refer√™ncia indefinido, solicita√ß√µes pull, adapta√ß√£o moderna do Qt 2 por Helio Castro, reposit√≥rio GitHub.">a gram√°tica do</a> utilit√°rio. <br><br>  Portanto, a estrat√©gia para corrigir erros de constru√ß√£o no arquivo <strong>perl.y</strong> foi prevista pela experi√™ncia anterior: instale o utilit√°rio <strong>byacc</strong> , altere <strong>yacc</strong> para <strong>byacc</strong> em todos os Makefiles e, em seguida, corte o <strong>yydebug</strong> de qualquer lugar.  Essas a√ß√µes resolveram todos os problemas desse arquivo, os erros desapareceram e a compila√ß√£o continuou. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><em>&lt;&lt; Pular para o conte√∫do</em></a> <br><br><a name="c-errors"></a><h2>  4. Erros de compila√ß√£o do c√≥digo em "C" </h2><br>  O c√≥digo antigo de Perl estava cheio de horrores, como a nota√ß√£o h√° muito obsoleta e esquecida das defini√ß√µes de fun√ß√£o do tipo K&amp;R: <br><br><pre> <code class="cpp hljs">format(orec,fcmd) <span class="hljs-keyword"><span class="hljs-keyword">register</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">outrec</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">orec</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">register</span></span> FCMD *fcmd; { ... } <span class="hljs-function"><span class="hljs-function">STR * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hfetch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(tb,key)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">register</span></span></span><span class="hljs-function"> HASH *tb</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *key; { ... } <span class="hljs-comment"><span class="hljs-comment">/*VARARGS1*/</span></span> fatal(pat,a1,a2,a3,a4) <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *pat; { <span class="hljs-built_in"><span class="hljs-built_in">fprintf</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">stderr</span></span>,pat,a1,a2,a3,a4); <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>); }</code> </pre><br>  Recursos semelhantes foram encontrados, por exemplo, no c√≥digo do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" title="Arqueologia divertida. Ou o PVS-Studio verifica o Microsoft Word 1.1a, Article no recurso Habr.">Microsoft Word 1.1a</a> , que tamb√©m √© bastante antigo.  O primeiro padr√£o da linguagem de programa√ß√£o "C", chamado "C89", aparecer√° apenas em dois anos.  Compiladores modernos s√£o capazes de trabalhar com esse c√≥digo, mas alguns IDEs n√£o facilitam a an√°lise de tais defini√ß√µes e as destacam como erros de sintaxe, por exemplo, o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" title="Qt Creator IDE, p√°gina da Wikipedia.">Qt Creator</a> pecou antes de analisar o c√≥digo na biblioteca <strong>libclang</strong> . <br><br>  O compilador GCC 9.2.0, lan√ßando um grande n√∫mero de avisos, se comprometeu a compilar o c√≥digo antigo da primeira vers√£o do Perl.  As folhas dos avisos eram t√£o grandes que, para chegar ao erro, tivemos que rolar v√°rias p√°ginas do escapamento.  Para minha surpresa, a maioria dos erros de compila√ß√£o era t√≠pica e estava principalmente relacionada a defini√ß√µes predefinidas, que desempenhavam o papel de sinalizadores para a montagem. <br><br><div style="text-align:center;"><img title="O trabalho do moderno compilador GCC 9.2.0 e do depurador GDB 8.3.1 no gerenciador de janelas twm e no emulador de terminal xterm." src="https://habrastorage.org/getpro/habr/post_images/3a9/b3c/004/3a9b3c0041c48a06e6805bd39883c6a4.png"></div><br>  <i>O trabalho do moderno compilador GCC 9.2.0 e do depurador GDB 8.3.1 no gerenciador de janelas <strong>twm</strong> e no emulador de terminal <strong>xterm</strong> .</i> <br><br>  Sob STDSTDIO <strong>,</strong> Larry Wall experimentou alguma biblioteca de linguagem de programa√ß√£o antiga e fora do padr√£o ‚ÄúC‚Äù, e sob DEBUGGING <strong>havia</strong> informa√ß√µes de depura√ß√£o com o not√≥rio <strong>yydebug</strong> , que mencionei acima.  Por padr√£o, essas caixas de sele√ß√£o foram ativadas.  Desativando-os no arquivo <strong>perl.h</strong> e adicionando algumas <strong>defini√ß√µes</strong> esquecidas, consegui reduzir significativamente o n√∫mero de erros. <br><br>  Outro tipo de erro √© substituir as fun√ß√µes agora padronizadas da biblioteca padr√£o e da camada POSIX.  O projeto possui seu pr√≥prio <strong>malloc ()</strong> , <strong>setenv ()</strong> e outras entidades que criaram conflitos. <br><br>  Alguns lugares definiram fun√ß√µes est√°ticas sem declara√ß√µes.  Com o tempo, os compiladores come√ßaram a adotar uma abordagem mais r√≠gida para esse problema e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" title="Como resolver uma declara√ß√£o est√°tica segue uma declara√ß√£o n√£o est√°tica no c√≥digo C do GCC? - Estouro de pilha.">transformaram o aviso em erro</a> .  E, finalmente, alguns cabe√ßalhos esquecidos, para onde voc√™ iria sem eles. <br><br>  Para minha surpresa, o patch para o c√≥digo de 32 anos acabou sendo t√£o pequeno que pode ser totalmente citado aqui: <br><br><pre> <code class="diff hljs">diff --git a/malloc.cb/malloc.c index 17c3b27..a1dfe9c 100644 --- a/malloc.c +++ b/malloc.c @@ -79,6 +79,9 @@ static u_int nmalloc[NBUCKETS]; #include &lt;stdio.h&gt; #endif +static findbucket(union overhead *freep, int srchlen); +static morecore(register bucket); + #ifdef debug #define ASSERT(p) if (!(p)) botch("p"); else static diff --git a/perl.hb/perl.h index 3ccff10..e98ded5 100644 --- a/perl.h +++ b/perl.h @@ -6,16 +6,16 @@ * */ -#define DEBUGGING -#define STDSTDIO /* eventually should be in config.h */ +//#define DEBUGGING +//#define STDSTDIO /* eventually should be in config.h */ #define VOIDUSED 1 #include "config.h" -#ifndef BCOPY -# define bcopy(s1,s2,l) memcpy(s2,s1,l); -# define bzero(s,l) memset(s,0,l); -#endif +//#ifndef BCOPY +//# define bcopy(s1,s2,l) memcpy(s2,s1,l); +//# define bzero(s,l) memset(s,0,l); +//#endif #include &lt;stdio.h&gt; #include &lt;ctype.h&gt; @@ -183,11 +183,11 @@ double atof(); long time(); struct tm *gmtime(), *localtime(); -#ifdef CHARSPRINTF - char *sprintf(); -#else - int sprintf(); -#endif +//#ifdef CHARSPRINTF +// char *sprintf(); +//#else +// int sprintf(); +//#endif #ifdef EUNICE #define UNLINK(f) while (unlink(f) &gt;= 0) diff --git a/perl.yb/perl.y index 16f8a9a..1ab769f 100644 --- a/perl.y +++ b/perl.y @@ -7,6 +7,7 @@ */ %{ +#include &lt;stdlib.h&gt; #include "handy.h" #include "EXTERN.h" #include "search.h" diff --git a/perly.cb/perly.c index bc32318..fe945eb 100644 --- a/perly.c +++ b/perly.c @@ -246,12 +246,14 @@ yylex() static bool firstline = TRUE; retry: +#ifdef DEBUGGING #ifdef YYDEBUG if (yydebug) if (index(s,'\n')) fprintf(stderr,"Tokener at %s",s); else fprintf(stderr,"Tokener at %s\n",s); +#endif #endif switch (*s) { default: diff --git a/stab.cb/stab.c index b9ef533..9757cfe 100644 --- a/stab.c +++ b/stab.c @@ -7,6 +7,7 @@ */ #include &lt;signal.h&gt; +#include &lt;errno.h&gt; #include "handy.h" #include "EXTERN.h" #include "search.h" diff --git a/util.hb/util.h index 4f92eeb..95cb9bf 100644 --- a/util.h +++ b/util.h @@ -28,7 +28,7 @@ void prexit(); char *get_a_line(); char *savestr(); int makedir(); -void setenv(); +//void setenv(); int envix(); void notincl(); char *getval();</code> </pre><br>  √ìtimo resultado para c√≥digo de 32 anos!  A <strong>refer√™ncia indefinida ao</strong> bug de liga√ß√£o <strong>`crypt '</strong> foi corrigida adicionando a diretiva <em>-lcrypt</em> ao Makefile com a biblioteca <strong>libcrypt</strong> apropriada, ap√≥s a qual finalmente consegui o execut√°vel interpretador Perl desejado: <br><br><pre> <code class="bash hljs">$ file perl perl: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=fd952ceae424613568530b3a2ca88ebd6477e0ae, <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> GNU/Linux 3.2.0, not stripped</code> </pre><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><em>&lt;&lt; Pular para o conte√∫do</em></a> <br><br><a name="segfaults"></a><h2>  5. Corre√ß√£o de alguns erros Falha na segmenta√ß√£o </h2><br>  Depois de uma compila√ß√£o quase sem complica√ß√µes, a sorte me deu as costas.  Imediatamente ap√≥s iniciar o interpretador Perl montado, obtive alguns erros estranhos e uma falha de segmenta√ß√£o no final: <br><br><pre> <code class="bash hljs">$ ./perl -e <span class="hljs-string"><span class="hljs-string">'print "Hello World!\n";'</span></span> Corrupt malloc ptr 0x2db36040 at 0x2db36000 Corrupt malloc ptr 0x2db36880 at 0x2db36800 Corrupt malloc ptr 0x2db36080 at 0x2db36040 Corrupt malloc ptr 0x2db37020 at 0x2db37000 Segmentation fault (core dumped)</code> </pre><br>  Tendo ro√≠do o texto de origem da frase <em>malloc corrompido</em> , descobriu-se que, em vez do sistema <strong>malloc (),</strong> algum tipo de alocador personalizado foi chamado a partir de 1982.  Curiosamente, <strong>Berkeley est√°</strong> escrito em uma das literais de string em seu c√≥digo-fonte e <strong>Caltech</strong> em um coment√°rio ao lado.  A colabora√ß√£o entre essas universidades ficou evidente, ent√£o, muito forte.  Em geral, comentei esse alocador de hackers e reconstru√≠ o c√≥digo fonte.  Os erros de corrup√ß√£o de mem√≥ria desapareceram, mas a falha de segmenta√ß√£o permaneceu.  Portanto, esse n√£o era o ponto, e agora precisamos descobrir o depurador. <br><br>  Executando o programa no <strong>gdb,</strong> descobri que a falha ocorre quando a fun√ß√£o de criar um arquivo tempor√°rio <strong>mktemp ()</strong> da libc √© chamada: <br><br><pre> <code class="plaintext hljs">$ gdb --args ./perl -e 'print "Hello, World!\n";' (gdb) r Starting program: /home/exl/perl5/perl -e print\ \"Hello\ World\!\\n\"\; Program received signal SIGSEGV, Segmentation fault. 0x00007ffff7cd20c7 in __gen_tempname () from /usr/lib/libc.so.6 (gdb) bt #0 0x00007ffff7cd20c7 in __gen_tempname () from /usr/lib/libc.so.6 #1 0x00007ffff7d71577 in mktemp () from /usr/lib/libc.so.6 #2 0x000055555556bb08 in main ()</code> </pre><br>  A prop√≥sito, o vinculador jurou anteriormente nessa fun√ß√£o.  N√£o √© um compilador, mas um vinculador, o que me surpreendeu: <br><br><pre> <code class="plaintext hljs">/usr/bin/ld: perl.o: in function `main': perl.c:(.text+0x978c): warning: the use of `mktemp' is dangerous, better use `mkstemp' or `mkdtemp'</code> </pre><br>  O primeiro pensamento que provavelmente veio √† sua mente tamb√©m foi substituir a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" title="A biblioteca GNU C, arquivos tempor√°rios, documenta√ß√£o oficial do GNU.">fun√ß√£o insegura</a> <strong>mktemp ()</strong> por <strong>mkstemp ()</strong> , o que eu fiz.  O aviso do vinculador desapareceu, mas a falha de segmenta√ß√£o permaneceu nesse local de qualquer maneira, s√≥ que agora estava na fun√ß√£o <strong>mkstemp ()</strong> . <br><br>  Portanto, agora voc√™ precisa examinar com muito cuidado o trecho de c√≥digo associado a essa fun√ß√£o.  L√°, descobri uma coisa bastante estranha que √© destacada neste trecho: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *e_tmpname = <span class="hljs-string"><span class="hljs-string">"/tmp/perl-eXXXXXX"</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ mktemp(e_tmpname); e_fp = f_open(e_tmpname, <span class="hljs-string"><span class="hljs-string">"w"</span></span>); ... }</code> </pre><br>  Acontece que <strong>mktemp () est√°</strong> tentando alterar o literal da m√°scara, localizada na se√ß√£o <strong>.rodata</strong> , que obviamente est√° fadada ao fracasso.  Ou, afinal, 32 anos atr√°s, isso era aceit√°vel, atendia ao c√≥digo e at√© funcionava de alguma forma? <br><br>  √â claro que a substitui√ß√£o de <strong>char * e_tmpname</strong> por <strong>char e_tmpname []</strong> corrigiu essa falha de segmenta√ß√£o e pude obter o que matei por toda a noite: <br><br><pre> <code class="bash hljs">$ ./perl -e <span class="hljs-string"><span class="hljs-string">'print "Hello World!\n";'</span></span> $ Hello, World! $ ./perl -e <span class="hljs-string"><span class="hljs-string">'$a = 5; $b = 6.3; $c = $a+$b; print $c."\n";'</span></span> $ 11.3000000000000007 $ ./perl -v <span class="hljs-variable"><span class="hljs-variable">$Header</span></span>: perly.c,v 1.0 87/12/18 15:53:31 root Exp $ Patch level: 0</code> </pre><br>  Verificamos a execu√ß√£o na linha de comando, mas e o arquivo?  Eu baixei o primeiro ‚ÄúHello World‚Äù para a linguagem de programa√ß√£o Perl da Internet: <br><br><pre> <code class="perl hljs"><span class="hljs-comment"><span class="hljs-comment">################# test.pl #!/usr/bin/perl # # The traditional first program. # Strict and warnings are recommended. use strict; use warnings; # Print a message. print "Hello, World!\n";</span></span></code> </pre><br>  Tentei execut√°-lo, mas, infelizmente, a falha de segmenta√ß√£o estava me esperando novamente.  Desta vez em um lugar completamente diferente: <br><br><pre> <code class="plaintext hljs">$ gdb --args ./perl test.pl (gdb) r Starting program: /home/exl/perl5/perl test.pl Program received signal SIGSEGV, Segmentation fault. 0x00007ffff7d1da75 in __strcpy_sse2_unaligned () from /usr/lib/libc.so.6 (gdb) bt #0 0x00007ffff7d1da75 in __strcpy_sse2_unaligned () from /usr/lib/libc.so.6 #1 0x00005555555629ea in yyerror () #2 0x0000555555568dd6 in yyparse () #3 0x000055555556bd4f in main ()</code> </pre><br>  O seguinte ponto interessante foi encontrado na fun√ß√£o <strong>yyerror ()</strong> , cito o trecho original: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// perl.y char *tokename[] = { "256", "word", "append", ... // perl.c yyerror(s) char *s; { char tmpbuf[128]; char *tname = tmpbuf; if (yychar &gt; 256) { tname = tokename[yychar-256]; // ??? if (strEQ(tname,"word")) strcpy(tname,tokenbuf); // Oops! else if (strEQ(tname,"register")) sprintf(tname,"$%s",tokenbuf); // Oops! ...</span></span></code> </pre><br>  Mais uma vez, a situa√ß√£o √© semelhante √† sobre a qual escrevi acima.  Os dados na se√ß√£o <strong>.rodata</strong> s√£o <strong>modificados novamente</strong> .  Talvez sejam apenas erros de digita√ß√£o por causa do Copy-Paste e, em vez de <strong>tname,</strong> eles quisessem escrever <strong>tmpbuf</strong> ?  Ou existe realmente algum tipo de significado oculto por tr√°s disso?  De qualquer forma, a substitui√ß√£o de <strong>char * tokename []</strong> por <strong>char tokename [] [32]</strong> remove o erro de falha de segmenta√ß√£o e o Perl nos diz o seguinte: <br><br><pre> <code class="bash hljs">$ ./perl test.pl syntax error <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> file test.pl at line 7, next token <span class="hljs-string"><span class="hljs-string">"strict"</span></span> Execution aborted due to compilation errors.</code> </pre><br>  Acontece que ele n√£o gosta de todo tipo de <strong>uso</strong> novo e <strong>estrito</strong> , √© o que ele est√° tentando nos dizer!  Se voc√™ excluir ou comentar essas linhas no arquivo, o programa inicia: <br><br><pre> <code class="bash hljs">$ ./perl test.pl Hello, World!</code> </pre><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><em>&lt;&lt; Pular para o conte√∫do</em></a> <br><br><a name="theend"></a><h2>  6. Resumir </h2><br>  De fato, alcancei meu objetivo e fiz o c√≥digo antigo de 1987 n√£o apenas compilar, mas tamb√©m trabalhar em um ambiente Linux moderno.  Sem d√∫vida, ainda resta uma grande pilha de v√°rios erros de falha de segmenta√ß√£o, possivelmente relacionados ao tamanho do ponteiro em uma arquitetura de 64 bits.  Tudo isso pode ser limpo ap√≥s algumas noites com o depurador pronto.  Mas essa n√£o √© uma tarefa muito agrad√°vel e entediante.  Afinal, inicialmente esse experimento foi planejado como entretenimento para uma noite entediante, e n√£o como um trabalho completo, que ser√° encerrado.  Existe algum benef√≠cio pr√°tico das a√ß√µes tomadas?  Talvez algum dia algum arque√≥logo digital se depare com este artigo e ser√° √∫til para ele.  Mas no mundo real, mesmo a experi√™ncia extra√≠da de tais pesquisas, na minha opini√£o, n√£o √© muito valiosa. <br><br>  Se algu√©m estiver interessado, eu posto um conjunto de dois patches.  O primeiro corrige erros de compila√ß√£o e o segundo corrige alguns erros de falha de segmenta√ß√£o. <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" title="Corrija o patch de erros de compila√ß√£o, reposit√≥rio EXLMOTODEV GitHub."><strong>Perl1987-Fix-compilation-errors.patch</strong></a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" title="Corrija um patch de falha de segmenta√ß√£o, reposit√≥rio EXLMOTODEV GitHub."><strong>Perl1987-Fix-some-Segmentation-Faults.patch</strong></a> </li></ul><br>  PS Eu me apresso em chatear os f√£s de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" title="Programa Perl de Linha √önica, Artigo Lurkmore.">jogadores destrutivos de linha √∫nica</a> , isso n√£o funciona aqui.  Talvez a vers√£o de Perl seja muito antiga para esse entretenimento. <br>  PPS Tudo de bom e tenha um bom final de semana.  Obrigado a <strong>kawaii_neko</strong> por uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" title="Perl direto de 1987, comente sobre o recurso LINUX.ORG.RU">pequena corre√ß√£o</a> . <br><br>  <em>Atualiza√ß√£o 28-Out-2019: Um</em> usu√°rio do f√≥rum LINUX.ORG.RU, usando o apelido <strong>utf8nowhere</strong> , forneceu links bastante interessantes <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" title="Perl direto de 1987, comente sobre o recurso LINUX.ORG.RU">em seu coment√°rio</a> sobre este artigo, cujas informa√ß√µes n√£o apenas esclarecem a situa√ß√£o com literais de string mut√°veis, mas tamb√©m consideram o problema de uso descrito acima fun√ß√µes <strong>mktemp ()</strong> !  Deixe-me citar essas fontes, que descrevem v√°rias incompatibilidades entre o K&amp;R C n√£o padronizado e o GNU C: <br><blockquote>  <strong>Incompatibilidades do CCG</strong> <br>  Existem v√°rias incompatibilidades not√°veis ‚Äã‚Äãentre as vers√µes GNU C e K&amp;R (n√£o ISO) do C. <br><br>  O GCC normalmente cria constantes de seq√º√™ncia de caracteres somente leitura.  Se v√°rias constantes de string com apar√™ncia id√™ntica forem usadas, o GCC armazenar√° apenas uma c√≥pia da string. <br>  Uma conseq√º√™ncia √© que voc√™ n√£o pode chamar <strong>mktemp</strong> com um argumento constante de string.  A fun√ß√£o <strong>mktemp</strong> sempre altera a string para a qual seu argumento aponta. <br><br>  Outra conseq√º√™ncia √© que o <strong>sscanf</strong> n√£o funciona em alguns sistemas quando transmitida uma constante de cadeia como sua cadeia ou entrada de controle de formato.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Isso ocorre porque o </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sscanf</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tenta gravar incorretamente na constante da string. </font><font style="vertical-align: inherit;">Da mesma forma </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fscanf</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">scanf</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A melhor solu√ß√£o para esses problemas √© alterar o programa para usar </font><font style="vertical-align: inherit;">vari√°veis ‚Äã‚Äãde matriz de </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">caracteres</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> com seq√º√™ncias de caracteres de inicializa√ß√£o para esses fins, em vez de constantes de sequ√™ncia. </font><font style="vertical-align: inherit;">Mas se isso n√£o for poss√≠vel, voc√™ pode usar o </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sinalizador -fwritable-strings</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que instrui o GCC a lidar com constantes de strings da mesma maneira que a maioria dos compiladores C. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fonte: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" title="Using the GNU Compiler Collection (GCC 3.3) Official Manual."><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Usando o Manual Oficial da GNU Compiler Collection (GCC 3.3)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sinalizador do</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> compilador </font><strong><font style="vertical-align: inherit;">-fwritable-strings</font></strong><font style="vertical-align: inherit;"> foi descontinuado no GCC 3.4 e removido permanentemente no GCC 4.0.</font></font><br><blockquote> <strong>ANSI C rationale | String literals</strong> <br> String literals are specified to be unmodifiable. This specification allows implementations to share copies of strings with identical text, to place string literals in read-only memory, and perform certain optimizations. However, string literals do not have the type array of const char, in order to avoid the problems of pointer type checking, particularly with library functions, since assigning a pointer to const char to a plain pointer to char is not valid. Those members of the Committee who insisted that string literals should be modifiable were content to have this practice designated a common extension (see F.5.5). <br><br> Existing code which modifies string literals can be made strictly conforming by replacing the string literal with an initialized static character array. For instance, <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *p, *make_temp(<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *str); <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> p = make_temp(<span class="hljs-string"><span class="hljs-string">"tempXXX"</span></span>); <span class="hljs-comment"><span class="hljs-comment">/* make_temp overwrites the literal */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* with a unique name */</span></span></code> </pre><br> can be changed to: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *p, *make_temp(<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *str); <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>[ ] = <span class="hljs-string"><span class="hljs-string">"tempXXX"</span></span>; p = make_temp( <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> ); }</code> </pre><br> : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" title="Rationale for American National Standard for Information Systems, Programming Language C, String literals.">Rationale for American National Standard for Information Systems, Programming Language C</a> . <br></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O usu√°rio </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VarfolomeyKote4ka</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> prop√¥s um </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" title="Perl   1987 ,    LINUX.ORG.RU"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hack sujo interessante</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que permite ignorar erros de falha de segmenta√ß√£o ao tentar alterar dados na se√ß√£o </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.rodata</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><font style="vertical-align: inherit;">convertendo-os </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">na</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> se√ß√£o </font><strong><font style="vertical-align: inherit;">.rwdata</font></strong><font style="vertical-align: inherit;"> . H√° pouco tempo, um artigo muito interessante apareceu na Internet </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" title="From .rodata to .rwdata ‚Äì introduction to memory mapping and LD scripts, Guy on BITS."><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúDe .rodata a .rwdata - introdu√ß√£o ao mapeamento de mem√≥ria e scripts LD‚Äù</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pelo programador </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">guye1296</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que explica como fazer esse truque. Para facilitar a obten√ß√£o do resultado desejado, o autor do artigo preparou um script bastante volumoso para o vinculador padr√£o </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ld</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><a href="" title="rwdata.ld script for ld linker, guye1296, GitHub repository."><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rwdata.ld</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Basta baixar esse script, coloc√°-lo na raiz do diret√≥rio de origem Perl, corrigir o sinalizador </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LDFLAGS da</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> seguinte maneira: </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LDFLAGS = -T rwdata.ld</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e reconstruir o projeto. </font><font style="vertical-align: inherit;">Como resultado, temos o seguinte:</font></font><br><br><pre> <code class="bash hljs">$ make clean &amp;&amp; make -j1 $ mv perl perl_rodata $ curl -LOJ https://raw.githubusercontent.com/guye1296/ld_script_elf_blog_post/master/rwdata.ld $ sed -i <span class="hljs-string"><span class="hljs-string">'s/LDFLAGS =/LDFLAGS = -T rwdata.ld/'</span></span> Makefile $ make clean &amp;&amp; make -j1 $ mv perl perl_rwdata $ objdump -s -j .rodata perl_rodata | grep tmp -2 19da0 21233f5e 7e3d2d25 30313233 34353637 !<span class="hljs-comment"><span class="hljs-comment">#?^~=-%01234567 19db0 38392e2b 262a2829 2c5c2f5b 7c002400 89.+&amp;*(),\/[|.$. 19dc0 73746465 7272002f 746d702f 7065726c stderr./tmp/perl 19dd0 2d655858 58585858 00323536 00617070 -eXXXXXX.256.app 19de0 656e6400 6c6f6f70 63746c00 66756e63 end.loopctl.func $ objdump -s -j .rwdata perl_rodata | grep tmp -2 objdump: section '.rwdata' mentioned in a -j option, but not found in any input file $ objdump -s -j .rwdata perl_rwdata | grep tmp -2 41d9c0 21233f5e 7e3d2d25 30313233 34353637 !#?^~=-%01234567 41d9d0 38392e2b 262a2829 2c5c2f5b 7c002400 89.+&amp;*(),\/[|.$. 41d9e0 73746465 7272002f 746d702f 7065726c stderr./tmp/perl 41d9f0 2d655858 58585858 00323536 00617070 -eXXXXXX.256.app 41da00 656e6400 6c6f6f70 63746c00 66756e63 end.loopctl.func $ objdump -s -j .rodata perl_rwdata | grep tmp -2 objdump: section '.rodata' mentioned in a -j option, but not found in any input file $ ./perl_rodata -e 'print "Hello, World!\n";' Segmentation fault (core dumped) $ ./perl_rwdata -e 'print "Hello, World!\n";' Hello, World!</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Acontece que, gra√ßas a esse hack, quase todas as altera√ß√µes do segundo patch podem ser simplesmente omitidas! </font><font style="vertical-align: inherit;">Embora, √© claro, levar o c√≥digo a uma apar√™ncia que n√£o viole os padr√µes ainda √© prefer√≠vel. </font></font><br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&lt;&lt; Pular para o conte√∫do</font></font></em></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt473228/">https://habr.com/ru/post/pt473228/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt473214/index.html">Yaga - contos eslavos no cen√°rio m√≥vel</a></li>
<li><a href="../pt473218/index.html">Entrevista com Ivan Kruglov, desenvolvedor principal: Service Mesh e ferramentas "n√£o padr√£o" da Booking.com</a></li>
<li><a href="../pt473220/index.html">Os pilares da destrui√ß√£o do c√≥digo lento na Wolfram Language: acelerando o c√≥digo dezenas, centenas e milhares de vezes</a></li>
<li><a href="../pt473222/index.html">Regras personalizadas de iptables para docker usando o zabbix como exemplo</a></li>
<li><a href="../pt473224/index.html">Ensino superior vs compet√™ncia. Parecer separado de um juiz do Tribunal Constitucional da Federa√ß√£o da R√∫ssia sobre o estado do ensino superior</a></li>
<li><a href="../pt473230/index.html">A Internet via sat√©lite √© uma nova corrida espacial?</a></li>
<li><a href="../pt473232/index.html">Qual sistema de controle de vers√£o voc√™ usa (no trabalho real, a maioria)?</a></li>
<li><a href="../pt473234/index.html">Criando uma API REST com Node.js e um Banco de Dados Oracle</a></li>
<li><a href="../pt473236/index.html">Trabalho em TI, gerenciamento de projetos, regulamenta√ß√£o e desenvolvimento de PD na nuvem: megadigest from 1cloud.ru</a></li>
<li><a href="../pt473238/index.html">Como funciona a Netflix</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>