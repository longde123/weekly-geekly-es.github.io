<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ЁЯЪБ ЁЯСйЁЯП╜тАНЁЯОУ ЁЯСйЁЯП┐тАНЁЯдЭтАНЁЯСиЁЯП╗ OS1: x86 рдХреЗ рд▓рд┐рдП рдЬрдВрдЧ рдкрд░ рдПрдХ рдЖрджрд┐рдо рдХрд░реНрдиреЗрд▓ред рднрд╛рдЧ 2. рд╡реАрдЬреАрдП, рдЬреАрдбреАрдЯреА, рдЖрдИрдбреАрдЯреА ЁЯд▓ тЫ╡я╕П ЁЯШ│</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="рдкрд╣рд▓рд╛ рднрд╛рдЧ 


 рдкрд╣рд▓реЗ рд▓реЗрдЦ рдХреЗ рдкрд╛рд╕ рдЕрднреА рддрдХ рдардВрдбрд╛ рд╣реЛрдиреЗ рдХрд╛ рд╕рдордп рдирд╣реАрдВ рдерд╛, рд▓реЗрдХрд┐рди рдореИрдВрдиреЗ рдлреИрд╕рд▓рд╛ рдХрд┐рдпрд╛ рдХрд┐ рдЖрдк рдЗрд╕реЗ рдкреЗрдЪреАрджрд╛ рди рд░рдЦреЗрдВ рдФрд░ рдЕрдЧрд▓реА рдХрдбрд╝реА рд▓рд┐рдЦреЗрдВред 


 рдЗрд╕рд▓рд┐рдП, рдкрд┐рдЫрд▓реЗ рд▓реЗрдЦ ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>OS1: x86 рдХреЗ рд▓рд┐рдП рдЬрдВрдЧ рдкрд░ рдПрдХ рдЖрджрд┐рдо рдХрд░реНрдиреЗрд▓ред рднрд╛рдЧ 2. рд╡реАрдЬреАрдП, рдЬреАрдбреАрдЯреА, рдЖрдИрдбреАрдЯреА</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/445584/"><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдкрд╣рд▓рд╛ рднрд╛рдЧ</a> </p><br><p>  рдкрд╣рд▓реЗ рд▓реЗрдЦ рдХреЗ рдкрд╛рд╕ рдЕрднреА рддрдХ рдардВрдбрд╛ рд╣реЛрдиреЗ рдХрд╛ рд╕рдордп рдирд╣реАрдВ рдерд╛, рд▓реЗрдХрд┐рди рдореИрдВрдиреЗ рдлреИрд╕рд▓рд╛ рдХрд┐рдпрд╛ рдХрд┐ рдЖрдк рдЗрд╕реЗ рдкреЗрдЪреАрджрд╛ рди рд░рдЦреЗрдВ рдФрд░ рдЕрдЧрд▓реА рдХрдбрд╝реА рд▓рд┐рдЦреЗрдВред </p><br><p>  рдЗрд╕рд▓рд┐рдП, рдкрд┐рдЫрд▓реЗ рд▓реЗрдЦ рдореЗрдВ рд╣рдордиреЗ рдХрд░реНрдиреЗрд▓ рдлрд╝рд╛рдЗрд▓ рдХреЛ рд▓рд┐рдВрдХ рдХрд░рдиреЗ, рд▓реЛрдб рдХрд░рдиреЗ рдФрд░ рдкреНрд░рд╛рдердорд┐рдХ рдЖрд░рдВрдн рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдмрд╛рдд рдХреА рдереАред  рдореИрдВрдиреЗ рдХреБрдЫ рдЙрдкрдпреЛрдЧреА рд▓рд┐рдВрдХ рджрд┐рдП, рдмрддрд╛рдпрд╛ рдХрд┐ рдХреИрд╕реЗ рд▓реЛрдб рдХрд┐рдпрд╛ рдЧрдпрд╛ рдХрд░реНрдиреЗрд▓ рдореЗрдореЛрд░реА рдореЗрдВ рд╕реНрдерд┐рдд рд╣реИ, рдмреВрдЯ рд╕рдордп рдкрд░ рдЖрднрд╛рд╕реА рдФрд░ рднреМрддрд┐рдХ рдкрддреЗ рдХреА рддреБрд▓рдирд╛ рдХреИрд╕реЗ рдХреА рдЬрд╛рддреА рд╣реИ, рдФрд░ рдкреГрд╖реНрда рддрдВрддреНрд░ рдХреЗ рд▓рд┐рдП рд╕рдорд░реНрдерди рдХреИрд╕реЗ рд╕рдХреНрд╖рдо рдХрд┐рдпрд╛ рдЬрд╛рдПред  рдЕрдВрдд рдореЗрдВ, рдирд┐рдпрдВрддреНрд░рдг рдореЗрд░реА рдХрд░реНрдиреЗрд▓ рдХреЗ kmain рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдкрд╛рд░рд┐рдд рдХрд░ рджрд┐рдпрд╛, рдЬрд┐рд╕реЗ рд░рд╕реНрдЯ рдореЗрдВ рд▓рд┐рдЦрд╛ рдЧрдпрд╛ рд╣реИред  рдпрд╣ рдЖрдЧреЗ рдмрдврд╝рдиреЗ рдФрд░ рдпрд╣ рдкрддрд╛ рд▓рдЧрд╛рдиреЗ рдХрд╛ рд╕рдордп рд╣реИ рдХрд┐ рдЦрд░рдЧреЛрд╢ рдЫреЗрдж рдХрд┐рддрдирд╛ рдЧрд╣рд░рд╛ рд╣реИ! </p><br><p>  рдиреЛрдЯреЛрдВ рдХреЗ рдЗрд╕ рд╣рд┐рд╕реНрд╕реЗ рдореЗрдВ рдореИрдВ <strong>рд╕рдВрдХреНрд╖реЗрдк рдореЗрдВ рдЕрдкрдиреЗ рдЬрдВрдЧ рд╡рд┐рдиреНрдпрд╛рд╕ рдХрд╛ рд╡рд░реНрдгрди рдХрд░реВрдВрдЧрд╛, рд╕рд╛рдорд╛рдиреНрдп рд╢рдмреНрджреЛрдВ рдореЗрдВ рдореИрдВ рд╡реАрдЬреАрдП рдореЗрдВ рд╕реВрдЪрдирд╛ рдХреЗ рдЙрддреНрдкрд╛рджрди рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдмрд╛рдд рдХрд░реВрдВрдЧрд╛, рдФрд░ рдЦрдВрдбреЛрдВ рдФрд░ рд╡реНрдпрд╡рдзрд╛рдиреЛрдВ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рд╡рд┐рд╕реНрддрд╛рд░ рд╕реЗ рдмрддрд╛рдКрдВрдЧрд╛</strong> ред  рдореИрдВ рдХрдЯ рдХреЗ рддрд╣рдд рд╕рднреА рджрд┐рд▓рдЪрд╕реНрдкреА рдкреВрдЫрддрд╛ рд╣реВрдВ, рдФрд░ рд╣рдо рд╢реБрд░реВ рдХрд░рддреЗ рд╣реИрдВред </p><a name="habracut"></a><br><h1 id="nastroyka-rust">  рдЬрдВрдЧ рд╕реЗрдЯрдЕрдк </h1><br><p> рд╕рд╛рдорд╛рдиреНрдп рддреМрд░ рдкрд░, рдЗрд╕ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдореЗрдВ рдХреБрдЫ рднреА рдЬрдЯрд┐рд▓ рдирд╣реАрдВ рд╣реИ, рд╡рд┐рд╡рд░рдг рдХреЗ рд▓рд┐рдП рдЖрдк <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдлрд┐рд▓рд┐рдк рдмреНрд▓реЙрдЧ рд╕реЗ</a> рд╕рдВрдкрд░реНрдХ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред  рд╣рд╛рд▓рд╛рдВрдХрд┐, рдореИрдВ рдХреБрдЫ рдмрд┐рдВрджреБрдУрдВ рдкрд░ рд░реБрдХреВрдВрдЧрд╛ред </p><br><p>  рд╕реНрдерд┐рд░ рдЬрдВрдЧ рдЕрднреА рднреА рдирд┐рдореНрди-рд╕реНрддрд░ рдХреЗ рд╡рд┐рдХрд╛рд╕ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рдХреБрдЫ рд╕реБрд╡рд┐рдзрд╛рдУрдВ рдХрд╛ рд╕рдорд░реНрдерди рдирд╣реАрдВ рдХрд░рддреА рд╣реИ, рдЗрд╕рд▓рд┐рдП, рдорд╛рдирдХ рдкреБрд╕реНрддрдХрд╛рд▓рдп рдХреЛ рдирд┐рд╖реНрдХреНрд░рд┐рдп рдХрд░рдиреЗ рдФрд░ рдирдВрдЧреЗ рд╣рдбреНрдбрд┐рдпреЛрдВ рдкрд░ рдирд┐рд░реНрдорд╛рдг рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рд╣рдореЗрдВ рд░рд╛рд╕реНрдЯ рдХреА рдЬрд░реВрд░рдд рд╣реИред  рд╕рд╛рд╡рдзрд╛рди рд░рд╣реЗрдВ, рдПрдХ рдмрд╛рд░ рдирд╡реАрдирддрдо рдореЗрдВ рдЕрдкрдЧреНрд░реЗрдб рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж рдореБрдЭреЗ рдкреВрд░реА рддрд░рд╣ рд╕реЗ рдирд┐рд╖реНрдХреНрд░рд┐рдп рдХрдВрдкрд╛рдЗрд▓рд░ рдорд┐рд▓ рдЧрдпрд╛ рдФрд░ рд╡рд╛рдкрд╕ рдирд┐рдХрдЯрддрдо рд╕реНрдерд┐рд░ рд╡рд╛рд▓реЗ рд╕реНрдерд╛рди рдкрд░ рд╡рд╛рдкрд╕ рдЬрд╛рдирд╛ рдкрдбрд╝рд╛ред  рдпрджрд┐ рдЖрдк рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рд╣реИрдВ рдХрд┐ рдЖрдкрдХрд╛ рдХрдВрдкрд╛рдЗрд▓рд░ рдХрд▓ рдХрд╛рдо рдХрд░ рд░рд╣рд╛ рдерд╛, рд▓реЗрдХрд┐рди рдЕрдкрдбреЗрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдФрд░ рдХрд╛рдо рдирд╣реАрдВ рдХрд░ рд░рд╣рд╛ рд╣реИ, рддреЛ рдХрдорд╛рдВрдб рдЪрд▓рд╛рдПрдВ, рдЬрд┐рд╕ рддрд╛рд░реАрдЦ рдХреЛ рдЖрдкрдХреА рдЬрд╝рд░реВрд░рдд рд╣реИ </p><br><pre><code class="plaintext hljs">rustup override add nightly-YYYY-MM-DD</code> </pre> <br><p>  рддрдВрддреНрд░ рдХреЗ рд╡рд┐рд╡рд░рдг рдХреЗ рд▓рд┐рдП, рдХреГрдкрдпрд╛ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдпрд╣рд╛рдВ</a> рд╕рдВрдкрд░реНрдХ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдХрд░реЗрдВ</a> ред </p><br><p>  рдЕрдЧрд▓рд╛, рдЙрд╕ рд▓рдХреНрд╖реНрдп рдкреНрд▓реЗрдЯрдлрд╝реЙрд░реНрдо рдХреЛ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░реЗрдВ рдЬрд┐рд╕рдХреЗ рд▓рд┐рдП рд╣рдо рдЬрд╛ рд░рд╣реЗ рд╣реИрдВред  рдореИрдВ рдлрд┐рд▓рд┐рдк рдУрдкрд░рдореИрди рдХреЗ рдмреНрд▓реЙрдЧ рдкрд░ рдЖрдзрд╛рд░рд┐рдд рдерд╛, рдЗрд╕рд▓рд┐рдП рдЗрд╕ рдЦрдВрдб рдХреА рдХрдИ рдЪреАрдЬреЗрдВ рдЙрдирд╕реЗ рд▓реА рдЧрдИрдВ, рд╣рдбреНрдбрд┐рдпреЛрдВ рд╕реЗ рд╡рд┐рдореБрдЦ рдФрд░ рдореЗрд░реА рдЬрд░реВрд░рддреЛрдВ рдХреЗ рдЕрдиреБрдХреВрд▓ред  рдлрд┐рд▓рд┐рдк рдЕрдкрдиреЗ рдмреНрд▓реЙрдЧ рдореЗрдВ x64 рдХреЗ рд▓рд┐рдП рд╡рд┐рдХрд╕рд┐рдд рдХрд░ рд░рд╣рд╛ рд╣реИ, рдореИрдВрдиреЗ рдореВрд▓ рд░реВрдк рд╕реЗ x32 рдЪреБрдирд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдореЗрд░рд╛ рд▓рдХреНрд╖реНрдп.рдЬреЙрди рдереЛрдбрд╝рд╛ рдЕрд▓рдЧ рд╣реЛрдЧрд╛ред  рдореИрдВ рдЗрд╕реЗ рдкреВрд░реА рддрд░рд╣ рд╕реЗ рд▓рд╛рддрд╛ рд╣реВрдВ </p><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"llvm-target"</span></span>: <span class="hljs-string"><span class="hljs-string">"i686-unknown-none"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"data-layout"</span></span>: <span class="hljs-string"><span class="hljs-string">"em:ep:32:32-f64:32:64-f80:32-n8:16:32-S128"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"arch"</span></span>: <span class="hljs-string"><span class="hljs-string">"x86"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"target-endian"</span></span>: <span class="hljs-string"><span class="hljs-string">"little"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"target-pointer-width"</span></span>: <span class="hljs-string"><span class="hljs-string">"32"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"target-c-int-width"</span></span>: <span class="hljs-string"><span class="hljs-string">"32"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"os"</span></span>: <span class="hljs-string"><span class="hljs-string">"none"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"executables"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"linker-flavor"</span></span>: <span class="hljs-string"><span class="hljs-string">"ld.lld"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"linker"</span></span>: <span class="hljs-string"><span class="hljs-string">"rust-lld"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"panic-strategy"</span></span>: <span class="hljs-string"><span class="hljs-string">"abort"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"disable-redzone"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"features"</span></span>: <span class="hljs-string"><span class="hljs-string">"-mmx,-sse,+soft-float"</span></span> }</code> </pre> <br><p>  рдпрд╣рд╛рдВ рд╕рдмрд╕реЗ рдХрдард┐рди рд╣рд┐рд╕реНрд╕рд╛ " <strong>рдбреЗрдЯрд╛-рд▓реЗрдЖрдЙрдЯ</strong> " рдкреИрд░рд╛рдореАрдЯрд░ рд╣реИред  LLVM рдкреНрд░рд▓реЗрдЦрди рд╣рдореЗрдВ рдмрддрд╛рддрд╛ рд╣реИ рдХрд┐ рдпреЗ "-" рджреНрд╡рд╛рд░рд╛ рдЕрд▓рдЧ рдХрд┐рдП рдЧрдП рдбреЗрдЯрд╛ рд▓реЗрдЖрдЙрдЯ рд╡рд┐рдХрд▓реНрдк рд╣реИрдВред  рдмрд╣реБрдд рдкрд╣рд▓реЗ "рдИ" рдЪрд░рд┐рддреНрд░ рднрд╛рд░рддреАрдпрддрд╛ рдХреЗ рд▓рд┐рдП рдЬрд┐рдореНрдореЗрджрд╛рд░ рд╣реИ - рд╣рдорд╛рд░реЗ рдорд╛рдорд▓реЗ рдореЗрдВ рдпрд╣ рдереЛрдбрд╝рд╛-рд╕рд╛ рд╣реИ, рдЬреИрд╕рд╛ рдХрд┐ рдордВрдЪ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред  рджреВрд╕рд░рд╛ рдЪрд░рд┐рддреНрд░ рд╣реИ, "рд╡рд┐рдХреГрддрд┐"ред  рд▓реЗрдЖрдЙрдЯ рдХреЗ рджреМрд░рд╛рди рдЪрд░рд┐рддреНрд░ рдХреЗ рдирд╛рдо рдХреЗ рд▓рд┐рдП рдЬрд┐рдореНрдореЗрджрд╛рд░ред  рдЪреВрдВрдХрд┐ рд╣рдорд╛рд░рд╛ рдЖрдЙрдЯрдкреБрдЯ рд╕реНрд╡рд░реВрдк ELF рд╣реЛрдЧрд╛ (рдирд┐рд░реНрдорд╛рдг рд╕реНрдХреНрд░рд┐рдкреНрдЯ рджреЗрдЦреЗрдВ), рд╣рдо "m: e" рдХрд╛ рдЪрдпрди рдХрд░рддреЗ рд╣реИрдВред  рддреАрд╕рд░рд╛ рдЪрд░рд┐рддреНрд░ рдмрд┐рдЯреНрд╕ рдФрд░ рдПрдмреАрдЖрдИ (рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдмрд╛рдЗрдирд░реА рдЗрдВрдЯрд░рдлрд╝реЗрд╕) рдореЗрдВ рд╕реВрдЪрдХ рдХрд╛ рдЖрдХрд╛рд░ рд╣реИред  рдпрд╣рд╛рдВ рд╕рдм рдХреБрдЫ рд╕рд░рд▓ рд╣реИ, рд╣рдорд╛рд░реЗ рдкрд╛рд╕ 32 рдмрд┐рдЯреНрд╕ рд╣реИрдВ, рдЗрд╕рд▓рд┐рдП рд╣рдо рд╕рд╛рд╣рд╕рдкреВрд░реНрд╡рдХ "рдкреА: 32: 32" рдбрд╛рд▓рддреЗ рд╣реИрдВред  рдЗрд╕рдХреЗ рдмрд╛рдж рдлреНрд▓реЛрдЯрд┐рдВрдЧ рдкреЙрдЗрдВрдЯ рдирдВрдмрд░ рд╣реИрдВред  рд╣рдо рд░рд┐рдкреЛрд░реНрдЯ рдХрд░ рд░рд╣реЗ рд╣реИрдВ рдХрд┐ рд╣рдо рдПрд▓рд╛рдЗрди 32 рдХреЗ рдЕрдиреБрд╕рд╛рд░ 64-рдмрд┐рдЯ рд╕рдВрдЦреНрдпрд╛ рдХреЛ рд╕рдВрд░реЗрдЦрдг 64 рдХреЗ рд╕рд╛рде рд╕рдорд░реНрдерди рдХрд░рддреЗ рд╣реИрдВ - "f64: 32: 64", рд╕рд╛рде рд╣реА рд╕рд╛рде рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рд╕рдВрд░реЗрдЦрдг рдХреЗ рд╕рд╛рде 80-рдмрд┐рдЯ рд╕рдВрдЦреНрдпрд╛ - "f80: 32"ред  рдЕрдЧрд▓рд╛ рддрддреНрд╡ рдкреВрд░реНрдгрд╛рдВрдХ рд╣реИред  рд╣рдо 8 рдмрд┐рдЯреНрд╕ рдХреЗ рд╕рд╛рде рд╢реБрд░реВ рдХрд░рддреЗ рд╣реИрдВ рдФрд░ рдкреНрд▓реЗрдЯрдлрд╝реЙрд░реНрдо рдХреА рдЕрдзрд┐рдХрддрдо 32 рдмрд┐рдЯреНрд╕ рдкрд░ рдЬрд╛рддреЗ рд╣реИрдВ - "n8: 16: 32"ред  рдЕрдВрддрд┐рдо рд╕реНрдЯреИрдХ рд╕рдВрд░реЗрдЦрдг рд╣реИред  рдореБрдЭреЗ 128 рдмрд┐рдЯ рдкреВрд░реНрдгрд╛рдВрдХ рдХреА рднреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЗрд╕реЗ S128 рд╣реЛрдиреЗ рджреЗрдВред  рдХрд┐рд╕реА рднреА рдорд╛рдорд▓реЗ рдореЗрдВ, рдПрд▓рдПрд▓рд╡реАрдПрдо рдЗрд╕ рдкреИрд░рд╛рдореАрдЯрд░ рдХреЛ рд╕реБрд░рдХреНрд╖рд┐рдд рд░реВрдк рд╕реЗ рдЕрдирджреЗрдЦрд╛ рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рдпрд╣ рд╣рдорд╛рд░реА рдкреНрд░рд╛рдердорд┐рдХрддрд╛ рд╣реИред </p><br><p>  рд╢реЗрд╖ рдорд╛рдкрджрдВрдбреЛрдВ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ, рдЖрдк рдлрд┐рд▓рд┐рдк рдХреЛ рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ, рд╡рд╣ рд╕рдм рдХреБрдЫ рдЕрдЪреНрдЫреА рддрд░рд╣ рд╕реЗ рд╕рдордЭрд╛рддрд╛ рд╣реИред </p><br><p>  рд╣рдореЗрдВ рдХрд╛рд░реНрдЧреЛ-рдПрдХреНрд╕рдмрд┐рд▓реНрдЯ рдХреА рднреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ - рдПрдХ рдЙрдкрдХрд░рдг рдЬреЛ рдЖрдкрдХреЛ рдЕрдкрд░рд┐рдЪрд┐рдд рд▓рдХреНрд╖реНрдп рдордВрдЪ рдХреЗ рддрд╣рдд рдирд┐рд░реНрдорд╛рдг рдХрд░рддреЗ рд╕рдордп рдЬрдВрдЧ-рдХреЛрд░ рдХреЛ рдкрд╛рд░ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред <br>  рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд░реЗрдВред </p><br><pre> <code class="bash hljs">cargo install cargo-xbuild</code> </pre> <br><p>  рд╣рдо рдЗрд╕реЗ рдЗрд╕ рддрд░рд╣ рдПрдХрддреНрд░рд┐рдд рдХрд░реЗрдВрдЧреЗред </p><br><pre> <code class="bash hljs">cargo xbuild -Z unstable-options --manifest-path=kernel/Cargo.toml --target kernel/targets/$(ARCH).json --out-dir=build/lib</code> </pre> <br><p>  рдореБрдЭреЗ рдореЗрдХ рдХреЗ рд╕рд╣реА рд╕рдВрдЪрд╛рд▓рди рдХреЗ рд▓рд┐рдП рдПрдХ рдореИрдирд┐рдлрд╝реЗрд╕реНрдЯ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдереА, рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ рд░реВрдЯ рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рд╕реЗ рд╢реБрд░реВ рд╣реЛрддрд╛ рд╣реИ, рдФрд░ рдХрд░реНрдиреЗрд▓ рдХрд░реНрдиреЗрд▓ рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдореЗрдВ рдирд┐рд╣рд┐рдд рд╣реЛрддрд╛ рд╣реИред </p><br><p>  рдореИрдирд┐рдлрд╝реЗрд╕реНрдЯ рдХреА рд╕реБрд╡рд┐рдзрд╛рдУрдВ рдореЗрдВ, рдореИрдВ рдХреЗрд╡рд▓ <em>рдЯреЛрдХрд░рд╛-рдкреНрд░рдХрд╛рд░ = ["рд╕реНрдЯреЗрдЯрд▓рд┐рдм"]</em> рдХреЛ рдЙрдЬрд╛рдЧрд░ рдХрд░ рд╕рдХрддрд╛ рд╣реВрдВ, рдЬреЛ рдЖрдЙрдЯрдкреБрдЯ рдХреЗ рд▓рд┐рдП рдПрдХ <em>рд▓рд┐рдВрдХ</em> рдХрд░рдиреЗ рдпреЛрдЧреНрдп рдлрд╝рд╛рдЗрд▓ рджреЗрддрд╛ рд╣реИред  рд╣рдо рдЙрд╕реЗ рдПрд▓рдПрд▓рдбреА рдореЗрдВ рдЦрд┐рд▓рд╛рдПрдВрдЧреЗред </p><br><h1 id="kmain-i-pervonachalnaya-nastroyka">  kmain рдФрд░ рдкреНрд░рд╛рд░рдВрднрд┐рдХ рд╕реЗрдЯрдЕрдк </h1><br><p>  рд░рд╕реНрдЯ рд╕рдореНрдореЗрд▓рдиреЛрдВ рдХреЗ рдЕрдиреБрд╕рд╛рд░, рдпрджрд┐ рд╣рдо рдПрдХ рд╕реНрдерд┐рд░ рдкреБрд╕реНрддрдХрд╛рд▓рдп (рдпрд╛ "рдлреНрд▓реИрдЯ" рдмрд╛рдЗрдирд░реА рдлрд╝рд╛рдЗрд▓) рдмрдирд╛рддреЗ рд╣реИрдВ, рддреЛ рдЯреЛрдХрд░реЗ рдХреА рдЬрдбрд╝ рдореЗрдВ рдлрд╝рд╛рдЗрд▓ lib.rs рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдП, рдЬреЛ рдХрд┐ рдкреНрд░рд╡реЗрд╢ рдмрд┐рдВрджреБ рд╣реИред  рдЗрд╕рдореЗрдВ, рд╡рд┐рд╢реЗрд╖рддрд╛рдУрдВ рдХреА рдорджрдж рд╕реЗ, рднрд╛рд╖рд╛ рдХреА рд╡рд┐рд╢реЗрд╖рддрд╛рдУрдВ рдХреЛ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдФрд░ рд╕рд╛рде рд╣реА рдХрд╝реАрдорддреА kmain рд╕реНрдерд┐рдд рд╣реИред </p><br><p>  рддреЛ, рдкрд╣рд▓реЗ рдЪрд░рдг рдореЗрдВ рд╣рдореЗрдВ рдПрд╕рдЯреАрдбреА рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдХреЛ рдирд┐рд╖реНрдХреНрд░рд┐рдп рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред  рдпрд╣ рдПрдХ рдореИрдХреНрд░реЛ рдХреЗ рд╕рд╛рде рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред </p><br><pre> <code class="rust hljs"><span class="hljs-meta"><span class="hljs-meta">#![no_std]</span></span></code> </pre> <br><p>  рдЗрд╕ рддрд░рд╣ рдХреЗ рдПрдХ рд╕рд░рд▓ рдХрджрдо рдХреЗ рд╕рд╛рде, рд╣рдо рддреБрд░рдВрдд рдорд╛рдирдХ рдкреБрд╕реНрддрдХрд╛рд▓рдп рдХреЗ рдорд▓реНрдЯреАрдереНрд░реЗрдбрд┐рдВрдЧ, рдЧрддрд┐рд╢реАрд▓ рдореЗрдореЛрд░реА рдФрд░ рдЕрдиреНрдп рдкреНрд░рд╕рдиреНрдирддрд╛ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рднреВрд▓ рдЬрд╛рддреЗ рд╣реИрдВред  рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рд╣рдо рдЦреБрдж рдХреЛ рдкреНрд░рд┐рдВрдЯрд▓рд╛рдЗрди рд╕реЗ рднреА рд╡рдВрдЪрд┐рдд рдХрд░рддреЗ рд╣реИрдВ!, рдореИрдХреНрд░реЛ, рдЗрд╕рд▓рд┐рдП рд╣рдореЗрдВ рдЗрд╕реЗ рд╕реНрд╡рдпрдВ рд▓рд╛рдЧреВ рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред  рдореИрдВ рдЖрдкрдХреЛ рдмрддрд╛рддрд╛ рд╣реВрдБ рдХрд┐ рдЕрдЧрд▓реА рдмрд╛рд░ рдХреИрд╕реЗ рдХрд░рдирд╛ рд╣реИред </p><br><p>  рдЗрд╕ рдЬрдЧрд╣ рдореЗрдВ рдХрдИ рдЯреНрдпреВрдЯреЛрд░рд┐рдпрд▓ "рд╣реИрд▓реЛ рд╡рд░реНрд▓реНрдб" рдХреЗ рдЖрдЙрдЯрдкреБрдЯ рдХреЗ рд╕рд╛рде рд╕рдорд╛рдкреНрдд рд╣реЛрддреЗ рд╣реИрдВ рдФрд░ рдпрд╣ рдмрддрд╛рдП рдмрд┐рдирд╛ рдХрд┐ рдХреИрд╕реЗ рдЬреАрдирд╛ рд╣реИред  рд╣рдо рджреВрд╕рд░реЗ рд░рд╛рд╕реНрддреЗ рд╕реЗ рдЬрд╛рдПрдВрдЧреЗред  рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ, рд╣рдореЗрдВ рд╕рдВрд░рдХреНрд╖рд┐рдд рдореЛрдб рдХреЗ рд▓рд┐рдП рдХреЛрдб рдФрд░ рдбреЗрдЯрд╛ рд╕реЗрдЧрдореЗрдВрдЯ рд╕реЗрдЯ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ, рд╡реАрдЬреАрдП рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░реЗрдВ, рдЗрдВрдЯрд░рдкреНрдЯ рдХреЛ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░реЗрдВ, рдЬреЛ рд╣рдо рдХрд░реЗрдВрдЧреЗред </p><br><pre> <code class="rust hljs"><span class="hljs-meta"><span class="hljs-meta">#![no_std]</span></span> <span class="hljs-meta"><span class="hljs-meta">#[macro_use]</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mod</span></span> debug; <span class="hljs-meta"><span class="hljs-meta">#[cfg(target_arch = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"x86"</span></span></span><span class="hljs-meta">)]</span></span> <span class="hljs-meta"><span class="hljs-meta">#[path = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"arch/i686/mod.rs"</span></span></span><span class="hljs-meta">]</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mod</span></span> arch; <span class="hljs-meta"><span class="hljs-meta">#[no_mangle]</span></span> <span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-string"><span class="hljs-string">"C"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">kmain</span></span></span></span>(pd: <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span>, mb_pointer: <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span>, mb_magic: <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span>) { arch::arch_init(pd); ...... } <span class="hljs-meta"><span class="hljs-meta">#[panic_handler]</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">panic</span></span></span></span>(_info: &amp;PanicInfo) -&gt; ! { <span class="hljs-built_in"><span class="hljs-built_in">println!</span></span>(<span class="hljs-string"><span class="hljs-string">"{}"</span></span>, _info); <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span> {} }</code> </pre> <br><p>  рдпрд╣рд╛рдБ рдХреНрдпрд╛ рд╣реЛ рд░рд╣рд╛ рд╣реИ?  рдЬреИрд╕рд╛ рдХрд┐ рдореИрдВрдиреЗ рдХрд╣рд╛, рд╣рдо рдорд╛рдирдХ рдкреБрд╕реНрддрдХрд╛рд▓рдп рдХреЛ рдмрдВрдж рдХрд░ рджреЗрддреЗ рд╣реИрдВред  рд╣рдо рджреЛ рдмрд╣реБрдд рдорд╣рддреНрд╡рдкреВрд░реНрдг рдореЙрдбреНрдпреВрд▓реЛрдВ рдХреА рднреА рдШреЛрд╖рдгрд╛ рдХрд░реЗрдВрдЧреЗ - рдбрд┐рдмрдЧ (рдЬрд┐рд╕рдореЗрдВ рд╣рдо рд╕реНрдХреНрд░реАрди рдкрд░ рд▓рд┐рдЦреЗрдВрдЧреЗ) рдФрд░ рдЖрд░реНрдЪ (рдЬрд┐рд╕рдореЗрдВ рд╕рднреА рдкреНрд▓реЗрдЯрдлрд╝реЙрд░реНрдо-рдбрд┐рдкреЗрдВрдбреЗрдВрдЯ рдореИрдЬрд┐рдХ рд░рд╣реЗрдВрдЧреЗ)ред  рдореИрдВ рд╡рд┐рднрд┐рдиреНрди рд╡рд╛рд╕реНрддреБ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдореЗрдВ рд╕рдорд╛рди рдЗрдВрдЯрд░рдлреЗрд╕ рдХреА рдШреЛрд╖рдгрд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЗ рд╕рд╛рде рд░рд╕реНрдЯ рд╕реБрд╡рд┐рдзрд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реВрдВ рдФрд░ рдЙрдирдХрд╛ рдЙрдкрдпреЛрдЧ рдЕрдкрдиреЗ рдкреВрд░реЗ рддрд░реАрдХреЗ рд╕реЗ рдХрд░рддрд╛ рд╣реВрдВред  рдпрд╣рд╛рдВ рдореИрдВ рдХреЗрд╡рд▓ x86 рдкрд░ рд░реБрдХрддрд╛ рд╣реВрдВ рдФрд░ рдлрд┐рд░ рд╣рдо рдХреЗрд╡рд▓ рдЗрд╕рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдмрд╛рдд рдХрд░рддреЗ рд╣реИрдВред </p><br><p>  рдореИрдВрдиреЗ рдкреВрд░реА рддрд░рд╣ рд╕реЗ рдкреНрд░рд╛рдЗрдорд░реА рдкреИрдирд┐рдХ рд╣реИрдВрдбрд▓рд░ рдШреЛрд╖рд┐рдд рдХрд┐рдпрд╛, рдЬрд┐рд╕реЗ рд░рд╕реНрдЯ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред  рдлрд┐рд░ рдЗрд╕реЗ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реЛрдЧрд╛ред </p><br><p>  kmain рддреАрди рддрд░реНрдХреЛрдВ рдХреЛ рд╕реНрд╡реАрдХрд╛рд░ рдХрд░рддрд╛ рд╣реИ рдФрд░ рдЗрд╕реЗ C рдиреЛрдЯреЗрд╢рди рдореЗрдВ рдирд╛рдо рд╡рд┐рд░реВрдкрдг рдХреЗ рдмрд┐рдирд╛ рднреА рдирд┐рд░реНрдпрд╛рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рддрд╛рдХрд┐ рд▓рд┐рдВрдХрд░ рдлрд╝рдВрдХреНрд╢рди рдХреЛ рд╕рд╣реА рдврдВрдЧ рд╕реЗ _loader рд╕реЗ рдХреЙрд▓ рдХреЗ рд╕рд╛рде рдЬреЛрдбрд╝ рд╕рдХреЗ, рдЬрд┐рд╕реЗ рдореИрдВрдиреЗ рдкрд┐рдЫрд▓реЗ рд▓реЗрдЦ рдореЗрдВ рд╡рд░реНрдгрд┐рдд рдХрд┐рдпрд╛ рдерд╛ред  рдкрд╣рд▓рд╛ рддрд░реНрдХ PD рдкреГрд╖реНрда рддрд╛рд▓рд┐рдХрд╛ рдХрд╛ рдкрддрд╛ рд╣реИ, рджреВрд╕рд░рд╛ GRUB рд╕рдВрд░рдЪрдирд╛ рдХрд╛ <strong>рднреМрддрд┐рдХ</strong> рдкрддрд╛ рд╣реИ, рдЬрд╣рд╛рдВ рд╕реЗ рд╣рдореЗрдВ рдореЗрдореЛрд░реА рдХрд╛рд░реНрдб рдорд┐рд▓реЗрдЧрд╛, рддреАрд╕рд░рд╛ рдореИрдЬрд┐рдХ рдирдВрдмрд░ рд╣реИред  рднрд╡рд┐рд╖реНрдп рдореЗрдВ, рдореИрдВ рдорд▓реНрдЯреАрдмреВрдЯ 2 рд╕рдорд░реНрдерди рдФрд░ рдЕрдкрдиреЗ рд╕реНрд╡рдпрдВ рдХреЗ рдмреВрдЯрд▓реЛрдбрд░ рджреЛрдиреЛрдВ рдХреЛ рд▓рд╛рдЧреВ рдХрд░рдирд╛ рдЪрд╛рд╣реВрдВрдЧрд╛, рдЗрд╕рд▓рд┐рдП рдореИрдВ рдмреВрдЯ рд╡рд┐рдзрд┐ рдХреА рдкрд╣рдЪрд╛рди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдореИрдЬрд┐рдХ рдирдВрдмрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реВрдВред </p><br><p>  рдкрд╣рд▓рд╛ kmain рдХреЙрд▓ рдкреНрд▓реЗрдЯрдлреЙрд░реНрдо-рд╡рд┐рд╢рд┐рд╖реНрдЯ рдЗрдирд┐рд╢рд┐рдпрд▓рд╛рдЗрдЬрд╝реЗрд╢рди рд╣реИред  рд╣рдо рдЕрдВрджрд░ рдЬрд╛рддреЗ рд╣реИрдВред  Arch_init рдлрд╝рдВрдХреНрд╢рди рдлрд╝рд╛рдЗрд▓ рдЖрд░реНрдХ / i686 / mod.rs рдореЗрдВ рд╕реНрдерд┐рдд рд╣реИ, рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ рд╣реИ, 32-рдмрд┐рдЯ x86- рд╡рд┐рд╢рд┐рд╖реНрдЯ рд╣реИ, рдФрд░ рдЗрд╕ рддрд░рд╣ рджрд┐рдЦрддрд╛ рд╣реИ: </p><br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">arch_init</span></span></span></span>(pd: <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">unsafe</span></span> { vga::VGA_WRITER.lock().init(); gdt::setup_gdt(); idt::init_idt(); paging::setup_pd(pd); } }</code> </pre> <br><p>  рдЬреИрд╕рд╛ рдХрд┐ рдЖрдк рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ, x86 рдХреЗ рд▓рд┐рдП, рдЖрдЙрдЯрдкреБрдЯ, рд╕реЗрдЧрдореЗрдВрдЯреЗрд╢рди, рдЗрдВрдЯрд░рдкреНрдЯ, рдФрд░ рдкреЗрдЬрд┐рдВрдЧ рдХреЛ рдХреНрд░рдо рдореЗрдВ рдкреНрд░рд╛рд░рдВрдн рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред  рд╢реБрд░реБрдЖрдд рдХрд░рддреЗ рд╣реИрдВ рд╡реАрдЬреАрдП рд╕реЗред </p><br><h1 id="inicializaciya-vga">  рд╡реАрдЬреАрдП рдЖрд░рдВрднреАрдХрд░рдг </h1><br><p>  рдкреНрд░рддреНрдпреЗрдХ рдЯреНрдпреВрдЯреЛрд░рд┐рдпрд▓ рд╣реИрд▓реЛ рд╡рд░реНрд▓реНрдб рдХреЛ рдкреНрд░рд┐рдВрдЯ рдХрд░рдирд╛ рдЕрдкрдирд╛ рдХрд░реНрддрд╡реНрдп рд╕рдордЭрддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЖрдк рдкрд╛рдПрдВрдЧреЗ рдХрд┐ рд╣рд░ рдЬрдЧрд╣ рд╡реАрдЬреАрдП рдХреЗ рд╕рд╛рде рдХреИрд╕реЗ рдХрд╛рдо рдХрд┐рдпрд╛ рдЬрд╛рдПред  рдЗрд╕ рдХрд╛рд░рдг рд╕реЗ, рдореИрдВ рдпрдерд╛рд╕рдВрднрд╡ рд╕рдВрдХреНрд╖реЗрдк рдореЗрдВ рдЬрд╛рдКрдВрдЧрд╛, рдореИрдВ рдХреЗрд╡рд▓ рдЙрди рдЪрд┐рдкреНрд╕ рдкрд░ рдзреНрдпрд╛рди рдХреЗрдВрджреНрд░рд┐рдд рдХрд░реВрдВрдЧрд╛ рдЬреЛ рдореИрдВрдиреЗ рдЦреБрдж рдмрдирд╛рдП рдереЗред  Lazy_static рдХреЗ рдЙрдкрдпреЛрдЧ рдкрд░ рдореИрдВ рдЖрдкрдХреЛ рдлрд┐рд▓рд┐рдк рдХреЗ рдмреНрд▓реЙрдЧ рдкрд░ рднреЗрдЬреВрдВрдЧрд╛ рдФрд░ рд╡рд┐рд╕реНрддрд╛рд░ рд╕реЗ рдирд╣реАрдВ рдмрддрд╛рдКрдВрдЧрд╛ред  const fn рдЕрднреА рд░рд┐рд▓реАрдЬрд╝ рдирд╣реАрдВ рд╣реБрдЖ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЦреВрдмрд╕реВрд░рддреА рд╕реЗ рд╕реНрдерд┐рд░ рдЗрдирд┐рд╢рд┐рдпрд▓рд╛рдЗрдЬрд╝реЗрд╢рди рдЕрднреА рддрдХ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрд╛ рд╣реИред  рдФрд░ рд╣рдо рдПрдХ рд╕реНрдкрд┐рди рд▓реЙрдХ рдЬреЛрдбрд╝реЗрдВрдЧреЗ рддрд╛рдХрд┐ рдпрд╣ рдЧрдбрд╝рдмрдбрд╝ рди рд╣реЛред </p><br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> lazy_static::lazy_static; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> spin::Mutex; lazy_static! { <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> VGA_WRITER : Mutex&lt;Writer&gt; = Mutex::new(Writer { cursor_position: <span class="hljs-number"><span class="hljs-number">0</span></span>, vga_color: ColorCode::new(Color::LightGray, Color::Black), buffer: <span class="hljs-keyword"><span class="hljs-keyword">unsafe</span></span> { &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> *(<span class="hljs-number"><span class="hljs-number">0xC00B8000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> *<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> VgaBuffer) } }); }</code> </pre> <br><p>  рдЬреИрд╕рд╛ рдХрд┐ рдЖрдк рдЬрд╛рдирддреЗ рд╣реИрдВ, рд╕реНрдХреНрд░реАрди рдмрдлрд░ рднреМрддрд┐рдХ рдкрддреЗ 0xB8000 рдкрд░ рд╕реНрдерд┐рдд рд╣реИ рдФрд░ рдЗрд╕рдХрд╛ рдЖрдХрд╛рд░ 80x25x2 рдмрд╛рдЗрдЯреНрд╕ (рд╕реНрдХреНрд░реАрди рдХреА рдЪреМрдбрд╝рд╛рдИ рдФрд░ рдКрдВрдЪрд╛рдИ, рдкреНрд░рддрд┐ рдЪрд░рд┐рддреНрд░ рдмрд╛рдЗрдЯ рдФрд░ рд╡рд┐рд╢реЗрд╖рддрд╛рдПрдБ: рд░рдВрдЧ, рдЭрд┐рд▓рдорд┐рд▓рд╛рд╣рдЯ) рд╣реИред  рдЪреВрдВрдХрд┐ рд╣рдордиреЗ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рд╡рд░реНрдЪреБрдЕрд▓ рдореЗрдореЛрд░реА рдХреЛ рд╕рдХреНрд╖рдо рдХрд░ рд▓рд┐рдпрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЗрд╕ рдкрддреЗ рддрдХ рдкрд╣реБрдВрдЪ рдХреНрд░реИрд╢ рд╣реЛ рдЬрд╛рдПрдЧреА, рдЗрд╕рд▓рд┐рдП рд╣рдо 3 рдЬреАрдмреА рдЬреЛрдбрд╝рддреЗ рд╣реИрдВред  рд╣рдо рдПрдХ рдХрдЪреНрдЪреЗ рд╕реВрдЪрдХ рдХреЛ рднреА рд░реЛрдХрддреЗ рд╣реИрдВ, рдЬреЛ рдЕрд╕реБрд░рдХреНрд╖рд┐рдд рд╣реИ - рд▓реЗрдХрд┐рди рд╣рдо рдЬрд╛рдирддреЗ рд╣реИрдВ рдХрд┐ рд╣рдо рдХреНрдпрд╛ рдХрд░ рд░рд╣реЗ рд╣реИрдВред <br>  рдЗрд╕ рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рджрд┐рд▓рдЪрд╕реНрдк рдЪреАрдЬреЛрдВ рдореЗрдВ рд╕реЗ, рд╢рд╛рдпрдж, рдХреЗрд╡рд▓ рд░рд╛рдЗрдЯрд░ рд╕рдВрд░рдЪрдирд╛ рдХрд╛ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рд╣реИ, рдЬреЛ рди рдХреЗрд╡рд▓ рдПрдХ рдкрдВрдХреНрддрд┐ рдореЗрдВ рдкрд╛рддреНрд░реЛрдВ рдХреЛ рдкреНрд░рджрд░реНрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рдмрд▓реНрдХрд┐ рд╕реНрдХреНрд░реЙрд▓ рдХрд░рдиреЗ, рд╕реНрдХреНрд░реАрди рдкрд░ рдХрд┐рд╕реА рднреА рд╕реНрдерд╛рди рдкрд░ рдЬрд╛рдиреЗ рдФрд░ рдЕрдиреНрдп рд╕реБрдЦрдж рдЯреНрд░рд┐рдлрд╝рд▓ рдХреЗ рд▓рд┐рдП рднреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред </p><br><div class="spoiler">  <b class="spoiler_title">рд╡рд╛рдЧрд╛ рд▓реЗрдЦрдХ</b> <div class="spoiler_text"><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Writer</span></span></span></span> { cursor_position: <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span>, vga_color: ColorCode, buffer: &amp;<span class="hljs-symbol"><span class="hljs-symbol">'static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> VgaBuffer, } <span class="hljs-keyword"><span class="hljs-keyword">impl</span></span> Writer { <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> vga_color = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.vga_color; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> y <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>..(VGA_HEIGHT - <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> x <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>..VGA_WIDTH { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.buffer.chars[y * VGA_WIDTH + x] = ScreenChar { ascii_character: <span class="hljs-string"><span class="hljs-string">b' '</span></span>, color_code: vga_color, } } } <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.set_cursor_abs(<span class="hljs-number"><span class="hljs-number">0</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">set_cursor_abs</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, position: <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">unsafe</span></span> { outb(<span class="hljs-number"><span class="hljs-number">0x3D4</span></span>, <span class="hljs-number"><span class="hljs-number">0x0F</span></span>); outb(<span class="hljs-number"><span class="hljs-number">0x3D5</span></span>, (position &amp; <span class="hljs-number"><span class="hljs-number">0xFF</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">u8</span></span>); outb(<span class="hljs-number"><span class="hljs-number">0x3D4</span></span>, <span class="hljs-number"><span class="hljs-number">0x0E</span></span>); outb(<span class="hljs-number"><span class="hljs-number">0x3D4</span></span>, ((position &gt;&gt; <span class="hljs-number"><span class="hljs-number">8</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0xFF</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">u8</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.cursor_position = position; } <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">set_cursor</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, x: <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span>, y: <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.set_cursor_abs(y * VGA_WIDTH + x); } <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">move_cursor</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, offset: <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.cursor_position = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.cursor_position + offset; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.set_cursor_abs(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.cursor_position); } <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_x</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) -&gt; <span class="hljs-built_in"><span class="hljs-built_in">u8</span></span> { (<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.cursor_position % VGA_WIDTH) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">u8</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_y</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) -&gt; <span class="hljs-built_in"><span class="hljs-built_in">u8</span></span> { (<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.cursor_position / VGA_WIDTH) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">u8</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">scroll</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> y <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>..(VGA_HEIGHT - <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> x <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>..VGA_WIDTH { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.buffer.chars[y * VGA_WIDTH + x] = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.buffer.chars[(y + <span class="hljs-number"><span class="hljs-number">1</span></span>) * VGA_WIDTH + x] } } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> x <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>..VGA_WIDTH { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> color_code = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.vga_color; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.buffer.chars[(VGA_HEIGHT - <span class="hljs-number"><span class="hljs-number">1</span></span>) * VGA_WIDTH + x] = ScreenChar { ascii_character: <span class="hljs-string"><span class="hljs-string">b' '</span></span>, color_code } } } <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ln</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> next_line = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.get_y() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span> + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> next_line &gt;= VGA_HEIGHT { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.scroll(); <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.set_cursor(<span class="hljs-number"><span class="hljs-number">0</span></span>, VGA_HEIGHT - <span class="hljs-number"><span class="hljs-number">1</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.set_cursor(<span class="hljs-number"><span class="hljs-number">0</span></span>, next_line) } } <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write_byte_at_xy</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, byte: <span class="hljs-built_in"><span class="hljs-built_in">u8</span></span>, color: ColorCode, x: <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span>, y: <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.buffer.chars[y * VGA_WIDTH + x] = ScreenChar { ascii_character: byte, color_code: color } } <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write_byte_at_pos</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, byte: <span class="hljs-built_in"><span class="hljs-built_in">u8</span></span>, color: ColorCode, position: <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.buffer.chars[position] = ScreenChar { ascii_character: byte, color_code: color } } <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write_byte</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, byte: <span class="hljs-built_in"><span class="hljs-built_in">u8</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.cursor_position &gt;= VGA_WIDTH * VGA_HEIGHT { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.scroll(); <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.set_cursor(<span class="hljs-number"><span class="hljs-number">0</span></span>, VGA_HEIGHT - <span class="hljs-number"><span class="hljs-number">1</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.write_byte_at_pos(byte, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.vga_color, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.cursor_position); <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.move_cursor(<span class="hljs-number"><span class="hljs-number">1</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write_string</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, s: &amp;<span class="hljs-built_in"><span class="hljs-built_in">str</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> byte <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> s.bytes() { <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> byte { <span class="hljs-number"><span class="hljs-number">0x20</span></span>...<span class="hljs-number"><span class="hljs-number">0xFF</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.write_byte(byte), <span class="hljs-string"><span class="hljs-string">b'\n'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.ln(), _ =&gt; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.write_byte(<span class="hljs-number"><span class="hljs-number">0xfe</span></span>), } } } }</code> </pre> </div></div><br><p>  рдЬрдм рд░рд┐рд╡рд╛рдЗрдВрдбрд┐рдВрдЧ рд╣реЛрддреА рд╣реИ, рддреЛ рдмрд╕ рд╕реНрдХреНрд░реАрди рдХреА рдЪреМрдбрд╝рд╛рдИ рдХреЗ рдЖрдХрд╛рд░ рдХреЛ рдкреАрдЫреЗ рдХреА рдУрд░ рд╕реНрдореГрддрд┐ рдХреЗ рд╡рд░реНрдЧреЛрдВ рдХреА рдирдХрд▓ рдХрд░рддреЗ рд╣реБрдП, рдПрдХ рдирдИ рд▓рд╛рдЗрди рдХреЗ рд╕рд╛рде рднрд░рдирд╛ (рдпрд╣ рд╣реИ рдХрд┐ рдореИрдВ рд╕рдлрд╛рдИ рдХреИрд╕реЗ рдХрд░рддрд╛ рд╣реВрдВ)ред  рдЖрдЙрдЯрдмреЗрд▓ рдХреЙрд▓ рдХреБрдЫ рдЕрдзрд┐рдХ рджрд┐рд▓рдЪрд╕реНрдк рд╣реИрдВ - I / O рдкреЛрд░реНрдЯ рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рдЕрд▓рд╛рд╡рд╛ рдХрд┐рд╕реА рдЕрдиреНрдп рддрд░реАрдХреЗ рд╕реЗ рдХрд░реНрд╕рд░ рдХреЛ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд░рдирд╛ рдЕрд╕рдВрднрд╡ рд╣реИред  рд╣рд╛рд▓рд╛рдВрдХрд┐, рд╣рдореЗрдВ рдЕрднреА рднреА рдмрдВрджрд░рдЧрд╛рд╣реЛрдВ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЗрдирдкреБрдЯ / рдЖрдЙрдЯрдкреБрдЯ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЙрдиреНрд╣реЗрдВ рдПрдХ рдЕрд▓рдЧ рдкреИрдХреЗрдЬ рдореЗрдВ рд╡рд┐рддрд░рд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рдФрд░ рд╕реБрд░рдХреНрд╖рд┐рдд рдЖрд╡рд░рдг рдореЗрдВ рд▓рдкреЗрдЯрд╛ рдЧрдпрд╛ред  рдиреАрдЪреЗ рджрд┐рдП рдЧрдП рд╕реНрдкреЙрдЗрд▓рд░ рдХреЗ рдиреАрдЪреЗ рдХреЛрдбрд░ рдХреЛрдб рд╣реИред  рдЕрднреА рдХреЗ рд▓рд┐рдП, рдпрд╣ рдЬрд╛рдирдирд╛ рдХрд╛рдлреА рд╣реИ рдХрд┐: </p><br><ul><li>  рдкреВрд░реНрдг рдХрд░реНрд╕рд░ рдСрдлрд╕реЗрдЯ, рд╕рдордиреНрд╡рдп рдирд╣реАрдВ, рдкреНрд░рджрд░реНрд╢рд┐рдд рд╣реЛрддрд╛ рд╣реИред </li><li>  рдЖрдк рдПрдХ рдмрд╛рд░ рдореЗрдВ рдПрдХ рдмрд╛рдЗрдЯ рдХрдВрдЯреНрд░реЛрд▓рд░ рдХреЛ рдЖрдЙрдЯрдкреБрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ </li><li>  рдПрдХ рдмрд╛рдЗрдЯ рдХрд╛ рдЖрдЙрдЯрдкреБрдЯ рджреЛ рдХрдорд╛рдВрдб рдореЗрдВ рд╣реЛрддрд╛ рд╣реИ - рдкрд╣рд▓реЗ рд╣рдо рдХрдВрдЯреНрд░реЛрд▓рд░ рдХреЛ рдХрдорд╛рдВрдб рд▓рд┐рдЦрддреЗ рд╣реИрдВ, рдлрд┐рд░ рдбреЗрдЯрд╛ рдХреЛред </li><li>  рдХрдорд╛рдВрдб рдХреЗ рд▓рд┐рдП рдкреЛрд░реНрдЯ 0x3D4 рд╣реИ, рдбреЗрдЯрд╛ рдкреЛрд░реНрдЯ 0x3D5 рд╣реИ </li><li>  рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ, 0x0F рдХрдорд╛рдВрдб рдХреЗ рд╕рд╛рде рд╕реНрдерд┐рддрд┐ рдХреЗ рдирд┐рдЪрд▓реЗ рдмрд╛рдЗрдЯ рдХреЛ рдкреНрд░рд┐рдВрдЯ рдХрд░реЗрдВ, рдлрд┐рд░ рдХрдорд╛рдВрдб 0x0E рдХреЗ рд╕рд╛рде рд╢реАрд░реНрд╖ </li></ul><br><div class="spoiler">  <b class="spoiler_title">out.asm</b> <div class="spoiler_text"><p>  рд╕реНрдЯреИрдХ рдкрд░ рдкрд╛рд░рд┐рдд рдЪрд░ рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдиреЗ рдкрд░ рдзреНрдпрд╛рди рджреЗрдВред  рдЪреВрдВрдХрд┐ рд╕реНрдЯреИрдХ рдЕрдВрддрд░рд┐рдХреНрд╖ рдХреЗ рдЕрдВрдд рдореЗрдВ рд╢реБрд░реВ рд╣реЛрддрд╛ рд╣реИ рдФрд░ рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдХреЙрд▓ рдХрд░рддреЗ рд╕рдордп рд╕реНрдЯреИрдХ рдкреЙрдЗрдВрдЯрд░ рдХреЛ рдХрдо рдХрд░рддрд╛ рд╣реИ, рдкреИрд░рд╛рдореАрдЯрд░, рдПрдХ рд╡рд╛рдкрд╕реА рдмрд┐рдВрджреБ, рдЖрджрд┐ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдЖрдкрдХреЛ рд╕реНрдЯреИрдХ рд╕рдВрд░реЗрдЦрдг рдХреЗ рд╕рд╛рде рд╕рдВрд░реЗрдЦрд┐рдд рддрд░реНрдХ рдЖрдХрд╛рд░ рдХреЛ рдИрдПрд╕рдкреА рд░рдЬрд┐рд╕реНрдЯрд░ рдореЗрдВ рдЬреЛрдбрд╝рдирд╛ рд╣реЛрдЧрд╛, рд╣рдорд╛рд░реЗ рдорд╛рдорд▓реЗ рдореЗрдВ 4 рдмрд╛рдЗрдЯреНрд╕ред </p><br><pre> <code class="plaintext hljs">global writeb global writew global writed section .text writeb: push ebp mov ebp, esp mov edx, [ebp + 8] ;port in stack: 8 = 4 (push ebp) + 4 (parameter port length is 2 bytes but stack aligned 4 bytes) mov eax, [ebp + 8 + 4] ;value in stack - 8 = see ^, 4 = 1 byte value aligned 4 bytes out dx, al ;write byte by port number an dx - value in al mov esp, ebp pop ebp ret writew: push ebp mov ebp, esp mov edx, [ebp + 8] ;port in stack: 8 = 4 (push ebp) + 4 (parameter port length is 2 bytes but stack aligned 4 bytes) mov eax, [ebp + 8 + 4] ;value in stack - 8 = see ^, 4 = 1 word value aligned 4 bytes out dx, ax ;write word by port number an dx - value in ax mov esp, ebp pop ebp ret writed: push ebp mov ebp, esp mov edx, [ebp + 8] ;port in stack: 8 = 4 (push ebp) + 4 (parameter port length is 2 bytes but stack aligned 4 bytes) mov eax, [ebp + 8 + 4] ;value in stack - 8 = see ^, 4 = 1 double word value aligned 4 bytes out dx, eax ;write double word by port number an dx - value in eax mov esp, ebp pop ebp ret</code> </pre> </div></div><br><h1 id="nastroyka-segmentov">  рд╕реЗрдЧрдореЗрдВрдЯ рд╕реЗрдЯрдЕрдк </h1><br><p>  рд╣рдо рд╕рдмрд╕реЗ рдЕрдзрд┐рдХ рд╣реИрд░рд╛рди рдереЗ, рд▓реЗрдХрд┐рди рдПрдХ рд╣реА рд╕рдордп рдореЗрдВ рд╕рдмрд╕реЗ рд╕рд░рд▓ рд╡рд┐рд╖рдпред  рдЬреИрд╕рд╛ рдХрд┐ рдореИрдВрдиреЗ рдкрд┐рдЫрд▓реЗ рд▓реЗрдЦ рдореЗрдВ рдХрд╣рд╛ рдерд╛, рд╕реНрдореГрддрд┐ рдореЗрдВ рдкреГрд╖реНрда рдФрд░ рдЦрдВрдб рд╕рдВрдЧрдарди рдХреЛ рдореЗрд░реЗ рд╕рд┐рд░ рдореЗрдВ рдорд┐рд▓рд╛рдпрд╛ рдЧрдпрд╛ рдерд╛, рдореИрдВрдиреЗ рдкреГрд╖реНрда рддрд╛рд▓рд┐рдХрд╛ рдХрд╛ рдкрддрд╛ GDTR рдореЗрдВ рд▓реЛрдб рдХрд┐рдпрд╛ рдФрд░ рдореЗрд░рд╛ рд╕рд┐рд░ рдкрдХрдбрд╝ рд▓рд┐рдпрд╛ред  рд╕рд╛рдордЧреНрд░реА рдХреЛ рдкрд░реНрдпрд╛рдкреНрдд рд░реВрдк рд╕реЗ рдкрдврд╝рдиреЗ, рдЙрд╕реЗ рдкрдЪрд╛рдиреЗ рдФрд░ рдЙрд╕реЗ рдорд╣рд╕реВрд╕ рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдиреЗ рдореЗрдВ рдореБрдЭреЗ рдХрдИ рдорд╣реАрдиреЗ рд▓рдЧ рдЧрдПред  рдореИрдВ рдкреАрдЯрд░ рдПрдмреЗрд▓ рдХреА рдкрд╛рдареНрдпрдкреБрд╕реНрддрдХ рдЕрд╕реЗрдВрдмрд▓рд░ рдХрд╛ рд╢рд┐рдХрд╛рд░ рд╣реЛ рд╕рдХрддрд╛ рд╣реВрдВред  рдЖрдИрдмреАрдПрдо рдкреАрд╕реА рдХреЗ рд▓рд┐рдП рднрд╛рд╖рд╛ рдФрд░ рдкреНрд░реЛрдЧреНрд░рд╛рдорд┐рдВрдЧ "(рдПрдХ рдорд╣рд╛рди рдкреБрд╕реНрддрдХ!), рдЬреЛ рдЗрдВрдЯреЗрд▓ 8086 рдХреЗ рд▓рд┐рдП рд╡рд┐рднрд╛рдЬрди рдХрд╛ рд╡рд░реНрдгрди рдХрд░рддрд╛ рд╣реИред рдЙрди рд╕реБрдЦрдж рд╕рдордп рдореЗрдВ, рд╣рдордиреЗ рдмреАрд╕-рдмрд┐рдЯ рдкрддреЗ рдХреЗ рдКрдкрд░реА 16 рдмрд┐рдЯреНрд╕ рдХреЛ рд╕реЗрдЧрдореЗрдВрдЯ рд░рдЬрд┐рд╕реНрдЯрд░ рдореЗрдВ рд▓реЛрдб рдХрд┐рдпрд╛, рдФрд░ рдпрд╣ рдореЗрдореЛрд░реА рдореЗрдВ рдкрддрд╛ рдерд╛ред  рдпрд╣ рдПрдХ рдХреНрд░реВрд░ рдирд┐рд░рд╛рд╢рд╛ рдереА рдЬреЛ рд╕рдВрд░рдХреНрд╖рд┐рдд рдореЛрдб рдореЗрдВ i286 рд╕реЗ рд╢реБрд░реВ рд╣реБрдИ, рд╕рдм рдХреБрдЫ рдкреВрд░реА рддрд░рд╣ рд╕реЗ рдЧрд▓рдд рд╣реИред </p><br><p>  рддреЛ, рдирдВрдЧреЗ рд╕рд┐рджреНрдзрд╛рдВрдд рдпрд╣ рд╣реИ рдХрд┐ x86 рдПрдХ рдЦрдВрдбрд┐рдд рд╕реНрдореГрддрд┐ рдореЙрдбрд▓ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рддрд╛ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ рдкреБрд░рд╛рдиреЗ рдкреНрд░реЛрдЧреНрд░рд╛рдо рдХреЗрд╡рд▓ 640 KB рд╕реЗ рдЖрдЧреЗ рдирд┐рдХрд▓ рд╕рдХрддреЗ рд╣реИрдВ, рдФрд░ рдлрд┐рд░ 1 рдПрдордмреА рдореЗрдореЛрд░реАред </p><br><p>  рдкреНрд░реЛрдЧреНрд░рд╛рдорд░реНрд╕ рдХреЛ рдпрд╣ рд╕реЛрдЪрдирд╛ рдерд╛ рдХрд┐ рдирд┐рд╖реНрдкрд╛рджрди рдпреЛрдЧреНрдп рдХреЛрдб рдХреИрд╕реЗ рд░рдЦреЗрдВ, рдбреЗрдЯрд╛ рдХреИрд╕реЗ рд░рдЦреЗрдВ, рдФрд░ рдЙрдирдХреА рд╕реБрд░рдХреНрд╖рд╛ рдХреИрд╕реЗ рдмрдирд╛рдП рд░рдЦреЗрдВред  рдкреГрд╖реНрда рд╕рдВрдЧрдарди рдХрд╛ рдЖрдЧрдорди рдЦрдВрдбрд┐рдд рд╕рдВрдЧрдарди рдХреЛ рдЕрдирд╛рд╡рд╢реНрдпрдХ рдмрдирд╛ рджреЗрддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдпрд╣ рд╕рдВрдЧрддрддрд╛ рдФрд░ рд╕реБрд░рдХреНрд╖рд╛ (рдХрд░реНрдиреЗрд▓-рд╕реНрдкреЗрд╕ рдФрд░ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛-рд╕реНрдерд╛рди рдХреЗ рд▓рд┐рдП рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реЛрдВ рдХреЛ рдЕрд▓рдЧ рдХрд░рдиреЗ) рдХреЗ рдЙрджреНрджреЗрд╢реНрдп рд╕реЗ рдмрдирд╛ рд░рд╣рд╛, рдЗрд╕рд▓рд┐рдП рдЗрд╕рдХреЗ рдмрд┐рдирд╛ рдпрд╣ рдХрд╣реАрдВ рдирд╣реАрдВ рд╣реИред  рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╕реНрддрд░ 0 рд╕реЗ рдХрдо рд╣реЛрдиреЗ рдкрд░ рдХреБрдЫ рдкреНрд░реЛрд╕реЗрд╕рд░ рдирд┐рд░реНрджреЗрд╢ рдирд┐рд╖рд┐рджреНрдз рд╣реИрдВ, рдФрд░ рдкреНрд░реЛрдЧреНрд░рд╛рдо рдФрд░ рдХрд░реНрдиреЗрд▓ рд╕реЗрдЧрдореЗрдВрдЯ рдХреЗ рдмреАрдЪ рдкрд╣реБрдВрдЪ рдПрдХ рд╡рд┐рднрд╛рдЬрди рддреНрд░реБрдЯрд┐ рдХрд╛ рдХрд╛рд░рдг рд╣реЛрдЧрд╛ред </p><br><p>  рдкрддрд╛ рдЕрдиреБрд╡рд╛рдж рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдлрд┐рд░ рд╕реЗ рдХрд░рддреЗ рд╣реИрдВ (рдЙрдореНрдореАрдж рд╣реИ рдХрд┐ рдЖрдЦрд┐рд░реА рдореЗрдВ) <br>  рд▓рд╛рдЗрди рдХрд╛ рдкрддрд╛ [0x08: 0xFFFFFFFF] -&gt; рд╕реЗрдЧрдореЗрдВрдЯ рдХреА рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЛ рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░реЗрдВ 0x08 -&gt; рд╡рд░реНрдЪреБрдЕрд▓ рдПрдбреНрд░реЗрд╕ [0xFFFFFFFFFF] -&gt; рдкреЗрдЬ рдЯреЗрдмрд▓ + рдЯреАрдПрд▓рдмреА -&gt; рднреМрддрд┐рдХ рдкрддрд╛ [0xAAAAFFFF] </p><br><p>  рдПрдХ рдЦрдВрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХреЗрд╡рд▓ рдкреНрд░реЛрд╕реЗрд╕рд░ рдХреЗ рдЕрдВрджрд░ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЗрд╕реЗ рдПрдХ рд╡рд┐рд╢реЗрд╖ рдЦрдВрдб рд░рдЬрд┐рд╕реНрдЯрд░ (рд╕реАрдПрд╕, рдПрд╕рдПрд╕, рдбреАрдПрд╕, рдИрдПрд╕, рдПрдлрдПрд╕, рдЬреАрдПрд╕) рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рдХреЛрдб рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдФрд░ рдирд┐рдпрдВрддреНрд░рдг рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд░рдиреЗ рдХреЗ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред  рдпрд╣реА рдХрд╛рд░рдг рд╣реИ рдХрд┐ рдЖрдк рдХрд░реНрдиреЗрд▓ рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕реНрдерд╛рди рд╕реЗ рд╕рд┐рд░реНрдл рд▓реЗ рдФрд░ рдХреЙрд▓ рдирд╣реАрдВ рдХрд░ рд╕рдХрддреЗред  0x18 рдХреЗ рдбрд┐рд╕реНрдХреНрд░рд┐рдкреНрдЯрд░ рдХреЗ рд╕рд╛рде рдПрдХ рд╕реЗрдЧрдореЗрдВрдЯ (рдореЗрд░реЗ рдкрд╛рд╕ рдПрдХ рд╣реИ, рдЖрдкрдХреЗ рдкрд╛рд╕ рдПрдХ рдЕрд▓рдЧ рд╣реИ) рдХреЗ рд╕реНрддрд░ 3 рдХреЗ рдЕрдзрд┐рдХрд╛рд░ рд╣реИрдВ, рдФрд░ 0x08 рдХреЗ рдбрд┐рд╕реНрдХреНрд░рд┐рдкреНрдЯрд░ рдХреЗ рд╕рд╛рде рдПрдХ рд╕реЗрдЧрдореЗрдВрдЯ рдХреЗ рд╕реНрддрд░ 0. рдХреЗ рдЕрдзрд┐рдХрд╛рд░ рд╣реИрдВред x86 рд╕рдореНрдореЗрд▓рди рдХреЗ рдЕрдиреБрд╕рд╛рд░, рдЕрдирдзрд┐рдХреГрдд рдкрд╣реБрдВрдЪ рдХреА рд╕реБрд░рдХреНрд╖рд╛ рдХреЗ рд▓рд┐рдП, рдХрдо рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╡рд╛рд▓реЗ рдПрдХ рд╕реЗрдЧрдореЗрдВрдЯ рдХреЛ рд╕реАрдзреЗ рдмрдбрд╝реЗ рдЦрдВрдб рдХреЗ рд╕рд╛рде рдПрдХ рд╕реЗрдЧрдореЗрдВрдЯ рдирд╣реАрдВ рдХрд╣рд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред jmp 0x08 рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЕрдзрд┐рдХрд╛рд░: [EAX], рд▓реЗрдХрд┐рди рдЕрдиреНрдп рддрдВрддреНрд░реЛрдВ, рдЬреИрд╕реЗ рдЬрд╛рд▓, рдлрд╛рдЯрдХ, рд╡реНрдпрд╡рдзрд╛рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдмрд╛рдзреНрдп рд╣реИред </p><br><p>  рд╕реЗрдЧрдореЗрдВрдЯ рдФрд░ рдЙрдирдХреЗ рдкреНрд░рдХрд╛рд░ (рдХреЛрдб, рдбреЗрдЯрд╛, рд▓реИрдбрд░, рдЧреЗрдЯреНрд╕) рдХреЛ GDT рдЧреНрд▓реЛрдмрд▓ рдбрд┐рд╕реНрдХреНрд░рд┐рдкреНрдЯрд░ рдЯреЗрдмрд▓, <strong>рд╡рд░реНрдЪреБрдЕрд▓</strong> рдПрдбреНрд░реЗрд╕ рдФрд░ рдЬрд┐рд╕рдХрд╛ рдЖрдХрд╛рд░ GDTR рд░рдЬрд┐рд╕реНрдЯрд░ рдореЗрдВ рд▓реЛрдб рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдореЗрдВ рд╡рд░реНрдгрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдПред  рд╕реЗрдЧрдореЗрдВрдЯ рдХреЗ рдмреАрдЪ рд╕реНрд╡рд┐рдЪ рдХрд░рддреЗ рд╕рдордп (рд╕рд╛рджрдЧреА рдХреЗ рд▓рд┐рдП, рдореЗрд░рд╛ рдорд╛рдирдирд╛ тАЛтАЛрд╣реИ рдХрд┐ рдПрдХ рд╕реАрдзрд╛ рд╕рдВрдХреНрд░рдордг рд╕рдВрднрд╡ рд╣реИ), рдЖрдкрдХреЛ jmp рдХреЛ 0x08: [EAX] рдирд┐рд░реНрджреЗрд╢ рдХреЛ рдХреЙрд▓ рдХрд░рдирд╛ рд╣реЛрдЧрд╛, рдЬрд╣рд╛рдВ 0x08 <strong>рддрд╛рд▓рд┐рдХрд╛ рдХреА рд╢реБрд░реБрдЖрдд рд╕реЗ рдмрд╛рдЗрдЯреНрд╕ рдореЗрдВ рдкрд╣рд▓реЗ рдорд╛рдиреНрдп рдбрд┐рд╕реНрдХреНрд░рд┐рдкреНрдЯрд░</strong> рдХреА <strong>рдСрдлрд╕реЗрдЯ рд╣реИ</strong> , рдФрд░ EAX рдЯреНрд░рд╛рдВрд╕реНрдлрд╝реЙрд░реНрдо рдПрдбреНрд░реЗрд╕ рд╡рд╛рд▓рд╛ рд░рдЬрд┐рд╕реНрдЯрд░ рд╣реИред  рдСрдлрд╝рд╕реЗрдЯ (рдЪрдпрдирдХрд░реНрддрд╛) рдХреЛ CS рд░рдЬрд┐рд╕реНрдЯрд░ рдореЗрдВ рд▓реЛрдб рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛, рдФрд░ рд╕рдВрдмрдВрдзрд┐рдд рдбрд┐рд╕реНрдХреНрд░рд┐рдкреНрдЯрд░ рдХреЛ рдкреНрд░реЛрд╕реЗрд╕рд░ рдХреЗ рдЫрд╛рдпрд╛ рд░рдЬрд┐рд╕реНрдЯрд░ рдореЗрдВ рд▓реЛрдб рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред  рдкреНрд░рддреНрдпреЗрдХ рд╡рд┐рд╡рд░рдгрдХ рдПрдХ 8-рдмрд╛рдЗрдЯ рд╕рдВрд░рдЪрдирд╛ рд╣реИред  рдпрд╣ рдЕрдЪреНрдЫреА рддрд░рд╣ рд╕реЗ рдкреНрд░рд▓реЗрдЦрд┐рдд рд╣реИ рдФрд░ рдЗрд╕рдХрд╛ рд╡рд┐рд╡рд░рдг OSDev рдФрд░ Intel рджрд╕реНрддрд╛рд╡реЗрдЬрд╝реАрдХрд░рдг рджреЛрдиреЛрдВ рдореЗрдВ рдкрд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ (рдкрд╣рд▓рд╛ рд▓реЗрдЦ рджреЗрдЦреЗрдВ)ред </p><br><p>  рдореИрдВ рд╕рдВрдХреНрд╖реЗрдк рдореЗрдВ рдмрддрд╛рддрд╛ рд╣реВрдВред  рдЬрдм рд╣рдо GDT рдХреЛ рдЗрдирд┐рд╢рд┐рдпрд▓рд╛рдЗрдЬрд╝ рдХрд░рддреЗ рд╣реИрдВ рдФрд░ jmp 0x08 рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рддреЗ рд╣реИрдВ: [EAX] рд╕рдВрдХреНрд░рдордг, рдкреНрд░реЛрд╕реЗрд╕рд░ рдХреА рд╕реНрдерд┐рддрд┐ рдЗрд╕ рдкреНрд░рдХрд╛рд░ рд╣реЛрдЧреА: </p><br><ul><li>  GDTR рдореЗрдВ <strong>рд╡рд░реНрдЪреБрдЕрд▓</strong> GDT рдПрдбреНрд░реЗрд╕ рд╣реЛрддрд╛ рд╣реИ </li><li>  CS рдореЗрдВ рдорд╛рди 0x08 рд╣реИ </li><li>  рдкрддреЗ рдкрд░ рдПрдХ рд╣реИрдВрдбрд▓ [GDTR + 0x08] рдХреЛ рдореЗрдореЛрд░реА рд╕реЗ рдЫрд╛рдпрд╛ рд░рдЬрд┐рд╕реНрдЯрд░ рд╕реАрдПрд╕ рдкрд░ рдХреЙрдкреА рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ </li><li>  EIP рд░рдЬрд┐рд╕реНрдЯрд░ рдореЗрдВ EAX рд░рдЬрд┐рд╕реНрдЯрд░ рд╕реЗ рдкрддрд╛ рд╣реЛрддрд╛ рд╣реИ </li></ul><br><p>  рд╢реВрдиреНрдп рдбрд┐рд╕реНрдХреНрд░рд┐рдкреНрдЯрд░ рдХреЛ рд╣рдореЗрд╢рд╛ рдПрдХрддрд░рдлрд╛ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП рдФрд░ рдЙрд╕ рддрдХ рдкрд╣реБрдВрдЪ рдирд┐рд╖рд┐рджреНрдз рд╣реИред  рдЬрдм рд╣рдо рдорд▓реНрдЯреАрдереНрд░реЗрдбрд┐рдВрдЧ рдкрд░ рдЪрд░реНрдЪрд╛ рдХрд░рддреЗ рд╣реИрдВ рддреЛ рдореИрдВ рдЯреАрдПрд╕рдПрд╕ рдбрд┐рд╕реНрдХреНрд░рд┐рдкреНрдЯрд░ рдФрд░ рдЗрд╕рдХреЗ рдЕрд░реНрде рдкрд░ рдЕрдзрд┐рдХ рд╡рд┐рд╕реНрддрд╛рд░ рд╕реЗ рдзреНрдпрд╛рди рджреВрдВрдЧрд╛ред  рдореЗрд░реА GDT рддрд╛рд▓рд┐рдХрд╛ рдЕрдм рдЗрд╕ рддрд░рд╣ рджрд┐рдЦрддреА рд╣реИ: </p><br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">load_gdt</span></span></span></span>(base: *<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> GdtEntry, limit: <span class="hljs-built_in"><span class="hljs-built_in">u16</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsafe</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setup_gdt</span></span></span></span>() { GDT[<span class="hljs-number"><span class="hljs-number">5</span></span>].set_offset((&amp;super::tss::TSS) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> *<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> _ <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">u32</span></span>); GDT[<span class="hljs-number"><span class="hljs-number">5</span></span>].set_limit(core::mem::size_of::&lt;super::tss::Tss&gt;() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">u32</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> gdt_ptr: *<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> GdtEntry = GDT.as_ptr(); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> limit = (GDT.len() * core::mem::size_of::&lt;GdtEntry&gt;() - <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">u16</span></span>; load_gdt(gdt_ptr, limit); } <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> GDT: [GdtEntry; <span class="hljs-number"><span class="hljs-number">7</span></span>] = [ <span class="hljs-comment"><span class="hljs-comment">//null descriptor - cannot access GdtEntry::new(0, 0, 0, 0), //kernel code GdtEntry::new(0, 0xFFFFFFFF, GDT_A_PRESENT | GDT_A_RING_0 | GDT_A_SYSTEM | GDT_A_EXECUTABLE | GDT_A_PRIVILEGE, GDT_F_PAGE_SIZE | GDT_F_PROTECTED_MODE), //kernel data GdtEntry::new(0, 0xFFFFFFFF, GDT_A_PRESENT | GDT_A_RING_0 | GDT_A_SYSTEM | GDT_A_PRIVILEGE, GDT_F_PAGE_SIZE | GDT_F_PROTECTED_MODE), //user code GdtEntry::new(0, 0xFFFFFFFF, GDT_A_PRESENT | GDT_A_RING_3 | GDT_A_SYSTEM | GDT_A_EXECUTABLE | GDT_A_PRIVILEGE, GDT_F_PAGE_SIZE | GDT_F_PROTECTED_MODE), //user data GdtEntry::new(0, 0xFFFFFFFF, GDT_A_PRESENT | GDT_A_RING_3 | GDT_A_SYSTEM | GDT_A_PRIVILEGE, GDT_F_PAGE_SIZE | GDT_F_PROTECTED_MODE), //TSS - for interrupt handling in multithreading GdtEntry::new(0, 0, GDT_A_PRESENT | GDT_A_RING_3 | GDT_A_TSS_AVAIL, 0), GdtEntry::new(0, 0, 0, 0), ];</span></span></code> </pre> <br><p>  рдФрд░ рдпрд╣рд╛рдБ рдЗрдирд┐рд╢рд┐рдпрд▓рд╛рдЗрдЬрд╝реЗрд╢рди рд╣реИ, рдЬрд┐рд╕рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдореИрдВрдиреЗ рдмрд╣реБрдд рдКрдкрд░ рдмрд╛рдд рдХреА рд╣реИред  рдЬреАрдбреАрдЯреА рдкрддрд╛ рдФрд░ рдЖрдХрд╛рд░ рд▓реЛрдбрд┐рдВрдЧ рдПрдХ рдЕрд▓рдЧ рд╕рдВрд░рдЪрдирд╛ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬрд┐рд╕рдореЗрдВ рдХреЗрд╡рд▓ рджреЛ рдлрд╝реАрд▓реНрдб рд╣реЛрддреЗ рд╣реИрдВред  рдЗрд╕ рд╕рдВрд░рдЪрдирд╛ рдХрд╛ рдкрддрд╛ lgdt рдХрдорд╛рдВрдб рдХреЛ рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред  рдбреЗрдЯрд╛ рдЦрдВрдб рд░рдЬрд┐рд╕реНрдЯрд░ рдореЗрдВ, 0x10 рдХреА рдСрдлрд╕реЗрдЯ рдХреЗ рд╕рд╛рде рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╡рд┐рд╡рд░рдгрдХ рд▓реЛрдб рдХрд░реЗрдВред </p><br><pre> <code class="plaintext hljs">global load_gdt section .text gdtr dw 0 ; For limit storage dd 0 ; For base storage load_gdt: mov eax, [esp + 4] mov [gdtr + 2], eax mov ax, [esp + 8] mov [gdtr], ax lgdt [gdtr] jmp 0x08:.reload_CS .reload_CS: mov ax, 0x10 ; 0x10 points at the new data selector mov ds, ax mov es, ax mov fs, ax mov gs, ax mov ss, ax mov ax, 0x28 ltr ax ret</code> </pre> <br><p>  рдлрд┐рд░ рд╕рдм рдХреБрдЫ рдереЛрдбрд╝рд╛ рдЖрд╕рд╛рди рд╣реЛрдЧрд╛, рд▓реЗрдХрд┐рди рдХреЛрдИ рдХрдо рджрд┐рд▓рдЪрд╕реНрдк рдирд╣реАрдВред </p><br><h1 id="preryvaniya">  рдмреАрдЪ рдореЗрдВ рдЖрддрд╛ рд╣реИ </h1><br><p>  рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ, рдпрд╣ рд╣рдореЗрдВ рдЕрдкрдиреЗ рдХреЛрд░ рдХреЗ рд╕рд╛рде рдмрд╛рддрдЪреАрдд рдХрд░рдиреЗ рдХрд╛ рдЕрд╡рд╕рд░ рджреЗрдиреЗ рдХрд╛ рд╕рдордп рд╣реИ (рдХрдо рд╕реЗ рдХрдо рдпрд╣ рджреЗрдЦрдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐ рд╣рдо рдХреАрдмреЛрд░реНрдб рдкрд░ рдХреНрдпрд╛ рджрдмрд╛рддреЗ рд╣реИрдВ)ред  рдРрд╕рд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдЖрдкрдХреЛ рдЗрдВрдЯрд░рдкреНрдЯ рдХрдВрдЯреНрд░реЛрд▓рд░ рдХреЛ рдЗрдирд┐рд╢рд┐рдпрд▓рд╛рдЗрдЬрд╝ рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред </p><br><p>  рдХреЛрдб рд╢реИрд▓реА рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЧреАрддрд╛рддреНрдордХ рд╡рд┐рд╖рдпрд╛рдВрддрд░ред </p><br><p>  рд╕рдореБрджрд╛рдп рдФрд░ рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рдлрд┐рд▓рд┐рдк рдУрдкрд░рдореИрди рдХреЗ рдкреНрд░рдпрд╛рд╕реЛрдВ рдХреЗ рд▓рд┐рдП рдзрдиреНрдпрд╡рд╛рдж, рдПрдХреНрд╕ 86-рдмрд╛рдзрд┐рдд рдХреЙрд▓рд┐рдВрдЧ рд╕рдореНрдореЗрд▓рди рдХреЛ рд░реБрд╕реНрдЯ рдореЗрдВ рдЬреЛрдбрд╝рд╛ рдЧрдпрд╛ рд╣реИ, рдЬреЛ рдЖрдкрдХреЛ iret рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рд░реБрдХрд╛рд╡рдЯ рд╕рдВрдЪрд╛рд▓рдХреЛрдВ рдХреЛ рд▓рд┐рдЦрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред  рд╣рд╛рд▓рд╛рдБрдХрд┐, рдореИрдВрдиреЗ рд╕рдЪреЗрдд рд░реВрдк рд╕реЗ рдЗрд╕ рдорд╛рд░реНрдЧ рдкрд░ рдирд╣реАрдВ рдЬрд╛рдиреЗ рдХрд╛ рдлреИрд╕рд▓рд╛ рдХрд┐рдпрд╛, рдХреНрдпреЛрдВрдХрд┐ рдореИрдВрдиреЗ рдЕрд╕реЗрдВрдмрд▓рд░ рдФрд░ рд░рд╕реНрдЯ рдХреЛ рдЕрд▓рдЧ-рдЕрд▓рдЧ рдлрд╛рдЗрд▓реЛрдВ рдореЗрдВ рдЕрд▓рдЧ рдХрд░рдиреЗ рдХрд╛ рдлреИрд╕рд▓рд╛ рдХрд┐рдпрд╛ рдерд╛, рдФрд░ рдЗрд╕рд▓рд┐рдП рдпрд╣ рдХрд╛рд░реНрдп рдХрд░рддрд╛ рд╣реИред  рд╣рд╛рдВ, рдореИрдВ рдЕрдиреБрдЪрд┐рдд рд░реВрдк рд╕реЗ рд╕реНрдЯреИрдХ рдореЗрдореЛрд░реА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣рд╛ рд╣реВрдВ, рдореБрдЭреЗ рдЗрд╕рдХреА рдЬрд╛рдирдХрд╛рд░реА рдирд╣реАрдВ рд╣реИ, рд▓реЗрдХрд┐рди рдпрд╣ рдЕрднреА рднреА рд╕реНрд╡рд╛рджрд┐рд╖реНрдЯ рд╣реИред  рдореЗрд░реЗ рдЗрдВрдЯрд░рдкреНрдЯ рд╣реИрдВрдбрд▓рд░ рдХреЛ рдЕрд╕реЗрдореНрдмрд▓рд░ рдореЗрдВ рд▓рд┐рдЦрд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ рдареАрдХ рдПрдХ рдХрд╛рдо рдХрд░рддреЗ рд╣реИрдВ: рд╡реЗ рд░реБрд╕реНрдЯ рдореЗрдВ рд▓рд┐рдЦреЗ рд▓рдЧрднрдЧ рдПрдХ рд╣реА рдмреАрдЪ рдХреЗ рд╣реИрдВрдбрд▓рд░ рдХреЛ рдХрд╣рддреЗ рд╣реИрдВред  рдХреГрдкрдпрд╛ рдЗрд╕ рддрдереНрдп рдХреЛ рд╕реНрд╡реАрдХрд╛рд░ рдХрд░реЗрдВ рдФрд░ рднреЛрдЧрд╡рд╛рджреА рдмрдиреЗрдВред </p><br><p>  рд╕рд╛рдорд╛рдиреНрдп рддреМрд░ рдкрд░, рдЗрдВрдЯрд░рдкреНрдЯ рдХреЛ рдЗрдирд┐рд╢рд┐рдпрд▓рд╛рдЗрдЬрд╝ рдХрд░рдиреЗ рдХреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ GDT рдХреЛ рдЗрдирд┐рд╢рд┐рдпрд▓рд╛рдЗрдЬрд╝ рдХрд░рдиреЗ рдХреЗ рд╕рдорд╛рди рд╣реИ, рд▓реЗрдХрд┐рди рд╕рдордЭрдиреЗ рдореЗрдВ рдЖрд╕рд╛рди рд╣реИред  рджреВрд╕рд░реА рдУрд░, рдЖрдкрдХреЛ рдПрдХ рд╕рдорд╛рди рдХреЛрдб рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред  Redox OS рдХреЗ рдбреЗрд╡рд▓рдкрд░реНрд╕ рднрд╛рд╖рд╛ рдХреЗ рд╕рднреА рдЖрдпрд╛рдореЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реБрдП, рдПрдХ рд╕реБрдВрджрд░ рдирд┐рд░реНрдгрдп рд▓реЗрддреЗ рд╣реИрдВ, рд▓реЗрдХрд┐рди рдореИрдВ "рдорд╛рдереЗ рдкрд░" рдЧрдпрд╛ рдФрд░ рдХреЛрдб рджреЛрд╣рд░рд╛рд╡ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдиреЗ рдХрд╛ рдлреИрд╕рд▓рд╛ рдХрд┐рдпрд╛ред </p><br><p>  X86 рд╕рдореНрдореЗрд▓рди рдХреЗ рдЕрдиреБрд╕рд╛рд░, рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рд░реБрдХрд╛рд╡рдЯреЗрдВ рд╣реИрдВ, рд▓реЗрдХрд┐рди рдЕрд╕рд╛рдзрд╛рд░рдг рд╕реНрдерд┐рддрд┐рдпрд╛рдВ рд╣реИрдВред  рдЗрд╕ рд╕рдВрджрд░реНрдн рдореЗрдВ, рд╣рдорд╛рд░реЗ рд▓рд┐рдП рд╕реЗрдЯрд┐рдВрдЧреНрд╕ рд╡реНрдпрд╛рд╡рд╣рд╛рд░рд┐рдХ рд░реВрдк рд╕реЗ рд╕рдорд╛рди рд╣реИрдВред  рдЕрдВрддрд░ рдХреЗрд╡рд▓ рдЗрддрдирд╛ рд╣реИ рдХрд┐ рдЬрдм рдХреЛрдИ рдЕрдкрд╡рд╛рдж рдлреЗрдВрдХрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рд╕реНрдЯреИрдХ рдореЗрдВ рдЕрддрд┐рд░рд┐рдХреНрдд рдЬрд╛рдирдХрд╛рд░реА рд╣реЛ рд╕рдХрддреА рд╣реИред  рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдореИрдВ рдПрдХ рдЧреБрдЪреНрдЫрд╛ рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рддреЗ рд╕рдордп рдПрдХ рдкреГрд╖реНрда рдХреА рдХрдореА рдХреЛ рд╕рдВрднрд╛рд▓рдиреЗ рдХреЗ рд▓рд┐рдП рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реВрдВ (рд▓реЗрдХрд┐рди рд╣рд░ рдЪреАрдЬ рдХрд╛ рдЕрдкрдирд╛ рд╕рдордп рд╣реЛрддрд╛ рд╣реИ)ред  рдЗрдВрдЯрд░рдкреНрдЯ рдФрд░ рдЕрдкрд╡рд╛рдж рджреЛрдиреЛрдВ рдХреЛ рдПрдХ рд╣реА рддрд╛рд▓рд┐рдХрд╛ рд╕реЗ рд╕рдВрд╕рд╛рдзрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬрд┐рд╕реЗ рдЖрдкрдХреЛ рдФрд░ рдореБрдЭреЗ рднрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред  рдпрд╣ рднреА PIC (рдкреНрд░реЛрдЧреНрд░рд╛рдореЗрдмрд▓ рдЗрдВрдЯрд░рдкреНрдЯ рдХрдВрдЯреНрд░реЛрд▓рд░) рдкреНрд░реЛрдЧреНрд░рд╛рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рд╣реИред  рдПрдкреАрдЖрдИрд╕реА рднреА рд╣реИ, рд▓реЗрдХрд┐рди рдореИрдВрдиреЗ рдЕрднреА рддрдХ рдЗрд╕рдХрд╛ рдкрддрд╛ рдирд╣реАрдВ рд▓рдЧрд╛рдпрд╛ рд╣реИред </p><br><p>  PIC рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдиреЗ рдкрд░ рдореИрдВ рдмрд╣реБрдд рд╕рд╛рд░реА рдЯрд┐рдкреНрдкрдгрд┐рдпрд╛рдВ рдирд╣реАрдВ рджреВрдВрдЧрд╛, рдХреНрдпреЛрдВрдХрд┐ рдЗрд╕рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рдиреЗрдЯрд╡рд░реНрдХ рдкрд░ рдХрдИ рдЙрджрд╛рд╣рд░рдг рд╣реИрдВред  рдореИрдВ рдХреЛрдбрд╛рдВрддрд░рдХ рдореЗрдВ рд╣реИрдВрдбрд▓рд░ рдХреЗ рд╕рд╛рде рд╢реБрд░реВ рдХрд░реВрдБрдЧрд╛ред  рд╡реЗ рд╕рднреА рдкреВрд░реА рддрд░рд╣ рд╕реЗ рд╕рдорд╛рди рд╣реИрдВ, рдЗрд╕рд▓рд┐рдП рдореИрдВ рд╕реНрдкреЙрдЗрд▓рд░ рдХреЗ рд▓рд┐рдП рдХреЛрдб рдирд┐рдХрд╛рд▓ рджреВрдВрдЧрд╛ред </p><br><div class="spoiler">  <b class="spoiler_title">рдЖрдИрдЖрд░рдХреНрдпреВ</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">global irq0 global irq1 ...... global irq14 global irq15 extern kirq0 extern kirq1 ...... extern kirq14 extern kirq15 section .text irq0: pusha call kirq0 popa iret irq1: pusha call kirq1 popa iret ...... irq14: pusha call kirq14 popa iret irq15: pusha call kirq15 popa iret</code> </pre> </div></div><br><p>  рдЬреИрд╕рд╛ рдХрд┐ рдЖрдк рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ, рдЬрдВрдЧ рдХрд╛рд░реНрдпреЛрдВ рдХреЗ рд▓рд┐рдП рд╕рднреА рдХреЙрд▓ рдЙрдкрд╕рд░реНрдЧ "рдХреЗ" рд╕реЗ рд╢реБрд░реВ рд╣реЛрддреЗ рд╣реИрдВ - рднреЗрдж рдФрд░ рд╕реБрд╡рд┐рдзрд╛ рдХреЗ рд▓рд┐рдПред  рдЕрдкрд╡рд╛рдж рд╣реИрдВрдбрд▓рд┐рдВрдЧ рдмрд┐рд▓реНрдХреБрд▓ рд╕рдорд╛рди рд╣реИред  рдЕрд╕реЗрдВрдмрд▓рд░ рдлрд╝рдВрдХреНрд╢рдВрд╕ рдХреЗ рд▓рд┐рдП, рдЙрдкрд╕рд░реНрдЧ "рдИ" рдХрд╛ рдЪрдпрди рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬрдВрдЧ рдХреЗ рд▓рд┐рдП, "рдХреЗ"ред  рдкреЗрдЬ рдлреЙрд▓реНрдЯ рд╣реИрдВрдбрд▓рд░ рдЕрд▓рдЧ рд╣реИ, рд▓реЗрдХрд┐рди рдЗрд╕рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ - рд╕реНрдореГрддрд┐ рдкреНрд░рдмрдВрдзрди рдкрд░ рдиреЛрдЯреНрд╕ рдореЗрдВред </p><br><div class="spoiler">  <b class="spoiler_title">рдЕрдкрд╡рд╛рдж</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">global e0_zero_divide global e1_debug ...... global eE_page_fault ...... global e14_virtualization global e1E_security extern k0_zero_divide extern k1_debug ...... extern kE_page_fault ...... extern k14_virtualization extern k1E_security section .text e0_zero_divide: pushad call k0_zero_divide popad iret e1_debug: pushad call k1_debug popad iret ...... eE_page_fault: pushad mov eax, [esp + 32] push eax mov eax, cr2 push eax call kE_page_fault pop eax pop eax popad add esp, 4 iret ...... e14_virtualization: pushad call k14_virtualization popad iret e1E_security: pushad call k1E_security popad iret</code> </pre> </div></div><br><p>  рд╣рдо рдХреЛрдбрд╛рдВрддрд░рдХ рд╕рдВрдЪрд╛рд▓рдХреЛрдВ рдХреА рдШреЛрд╖рдгрд╛ рдХрд░рддреЗ рд╣реИрдВ: </p><br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">load_idt</span></span></span></span>(base: *<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> IdtEntry, limit: <span class="hljs-built_in"><span class="hljs-built_in">u16</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">e0_zero_divide</span></span></span></span>(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">e1_debug</span></span></span></span>(); ...... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">e14_virtualization</span></span></span></span>(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">e1E_security</span></span></span></span>(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">irq0</span></span></span></span>(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">irq1</span></span></span></span>(); ...... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">irq14</span></span></span></span>(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">irq15</span></span></span></span>(); }</code> </pre> <br><p>  рд╣рдо рдЬрдВрдЧ рд╣реИрдВрдбрд▓рд░реНрд╕ рдХреЛ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд░рддреЗ рд╣реИрдВ рдЬрд┐рд╕реЗ рд╣рдо рдКрдкрд░ рдХрд╣рддреЗ рд╣реИрдВред  рдХреГрдкрдпрд╛ рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдХреАрдмреЛрд░реНрдб рдХреЛ рдмрд╛рдзрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдореИрдВ рдмрд╕ рдкреНрд░рд╛рдкреНрдд рдХреЛрдб рдкреНрд░рджрд░реНрд╢рд┐рдд рдХрд░рддрд╛ рд╣реВрдВ, рдЬреЛ рдореБрдЭреЗ рдкреЛрд░реНрдЯ 0x60 рд╕реЗ рдорд┐рд▓рддрд╛ рд╣реИ - рдпрд╣ рд╣реИ рдХрд┐ рдХреАрдмреЛрд░реНрдб рд╕рдмрд╕реЗ рд╕рд░рд▓ рдореЛрдб рдореЗрдВ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИред  рднрд╡рд┐рд╖реНрдп рдореЗрдВ, рдпрд╣ рдПрдХ рдкреВрд░реНрдг рдЪрд╛рд▓рдХ рдореЗрдВ рдмрджрд▓ рдЬрд╛рддрд╛ рд╣реИ, рдореБрдЭреЗ рдЖрд╢рд╛ рд╣реИред  рдкреНрд░рддреНрдпреЗрдХ рдмрд╛рдзрд╛ рдХреЗ рдмрд╛рдж, рдЖрдкрдХреЛ 0x20 рдкреНрд░рд╕рдВрд╕реНрдХрд░рдг рдХреЗ рдЕрдВрдд рдХреЗ рд╕рд┐рдЧреНрдирд▓ рдХреЛ рдЖрдЙрдЯрдкреБрдЯ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ, рдпрд╣ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИ!  рдЕрдиреНрдпрдерд╛, рдЖрдкрдХреЛ рдЕрдзрд┐рдХ рдЕрдВрддрд░рд╛рд▓ рдирд╣реАрдВ рдорд┐рд▓реЗрдЧрд╛ред </p><br><pre> <code class="rust hljs"><span class="hljs-meta"><span class="hljs-meta">#[no_mangle]</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsafe</span></span> <span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">kirq0</span></span></span></span>() { <span class="hljs-comment"><span class="hljs-comment">// println!("IRQ 0"); outb(0x20, 0x20); } #[no_mangle] pub unsafe extern fn kirq1() { let ch: char = inb(0x60) as char; crate::arch::vga::VGA_WRITER.force_unlock(); println!("IRQ 1 {}", ch); outb(0x20, 0x20); } #[no_mangle] pub unsafe extern fn kirq2() { println!("IRQ 2"); outb(0x20, 0x20); } ...</span></span></code> </pre> <br><p>  рдЖрдИрдбреАрдЯреА рдФрд░ рдкреАрдЖрдИрд╕реА рдХреА рд╢реБрд░реБрдЖрддред  PIC рдФрд░ рдЗрд╕рдХреЗ рд░реАрдореИрдкрд┐рдВрдЧ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ, рдореБрдЭреЗ рд╡рд┐рд╕реНрддрд╛рд░ рдХреА рдЕрд▓рдЧ-рдЕрд▓рдЧ рдбрд┐рдЧреНрд░реА рдХреЗ рдЯреНрдпреВрдЯреЛрд░рд┐рдпрд▓ рдХреА рдПрдХ рдмрдбрд╝реА рд╕рдВрдЦреНрдпрд╛ рдорд┐рд▓реА, рдЬреЛ OSDev рд╕реЗ рд╢реБрд░реВ рд╣реБрдИ рдФрд░ рд╢реМрдХрд┐рдпрд╛ рд╕рд╛рдЗрдЯреЛрдВ рдХреЗ рд╕рд╛рде рд╕рдорд╛рдкреНрдд рд╣реБрдИред  рдЪреВрдВрдХрд┐ рдкреНрд░реЛрдЧреНрд░рд╛рдорд┐рдВрдЧ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рд╕рдВрдЪрд╛рд▓рди рдФрд░ рдирд┐рд░рдВрддрд░ рдХрдорд╛рдВрдб рдХреЗ рдирд┐рд░рдВрддрд░ рдЕрдиреБрдХреНрд░рдо рдХреЗ рд╕рд╛рде рдЪрд▓рддреА рд╣реИ, рдЗрд╕рд▓рд┐рдП рдореИрдВ рдЗрд╕ рдХреЛрдб рдХреЛ рдФрд░ рд╕реНрдкрд╖реНрдЯреАрдХрд░рдг рдХреЗ рдмрд┐рдирд╛ рджреЗ рджреВрдВрдЧрд╛ред     ,        0x20-0x2F  ,       0x20  0x28,     16    IDT. </p><br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">unsafe</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setup_pic</span></span></span></span>(pic1: <span class="hljs-built_in"><span class="hljs-built_in">u8</span></span>, pic2: <span class="hljs-built_in"><span class="hljs-built_in">u8</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// Start initialization outb(PIC1, 0x11); outb(PIC2, 0x11); // Set offsets outb(PIC1 + 1, pic1); /* remap */ outb(PIC2 + 1, pic2); /* pics */ // Set up cascade outb(PIC1 + 1, 4); /* IRQ2 -&gt; connection to slave */ outb(PIC2 + 1, 2); // Set up interrupt mode (1 is 8086/88 mode, 2 is auto EOI) outb(PIC1 + 1, 1); outb(PIC2 + 1, 1); // Unmask interrupts outb(PIC1 + 1, 0); outb(PIC2 + 1, 0); // Ack waiting outb(PIC1, 0x20); outb(PIC2, 0x20); } pub unsafe fn init_idt() { IDT[0x0].set_func(e0_zero_divide); IDT[0x1].set_func(e1_debug); ...... IDT[0x14].set_func(e14_virtualization); IDT[0x1E].set_func(e1E_security); IDT[0x20].set_func(irq0); IDT[0x21].set_func(irq1); ...... IDT[0x2E].set_func(irq14); IDT[0x2F].set_func(irq15); setup_pic(0x20, 0x28); let idt_ptr: *const IdtEntry = IDT.as_ptr(); let limit = (IDT.len() * core::mem::size_of::&lt;IdtEntry&gt;() - 1) as u16; load_idt(idt_ptr, limit); }</span></span></code> </pre> <br><p>      IDTR   GDTR тАФ       .  STI        тАФ         тАФ  ,    ,  ASCII-   -. </p><br><pre> <code class="plaintext hljs">global load_idt section .text idtr dw 0 ; For limit storage dd 0 ; For base storage load_idt: mov eax, [esp + 4] mov [idtr + 2], eax mov ax, [esp + 8] mov [idtr], ax lidt [idtr] sti ret</code> </pre> <br><h1 id="posleslovie">  рдЕрдВрддрднрд╛рд╖рдг </h1><br><p>  ,     ,            .      setup_pd,           . ,   ,     ,  . </p><br><p>   - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">  GitLab</a> . </p><br><p>  рдЖрдкрдХрд╛ рдзреНрдпрд╛рди рдХреЗ рд▓рд┐рдП рдзрдиреНрдпрд╡рд╛рдж! </p><br><p> UPD: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u="> 3</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/hi445584/">https://habr.com/ru/post/hi445584/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../hi445568/index.html">рдкреЛрд░реНрдЯ 80 рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд▓рд┐рдирдХреНрд╕ рдХреА рдирд┐рдЧрд░рд╛рдиреА рдФрд░ рдкреНрд░рдмрдВрдзрди / OpenWrt / Lede- рдЖрдзрд╛рд░рд┐рдд рдЙрдкрдХрд░рдгреЛрдВ ...</a></li>
<li><a href="../hi445570/index.html">рдЕрдкреНрд░реИрд▓ 2019 рдХреЗ рд▓рд┐рдП рдЖрдИрдЯреА рдХреЗ рдХреНрд╖реЗрддреНрд░ рдореЗрдВ рдПрдЪрдЖрд░ рдкреЗрд╢реЗрд╡рд░реЛрдВ рдХреЗ рд▓рд┐рдП рдШрдЯрдирд╛рдУрдВ рдХрд╛ рдкрд╛рдЪрди</a></li>
<li><a href="../hi445572/index.html">рдЕрдореЗрд░рд┐рдХреА рд╕рд░рдХрд╛рд░ рдХреА рдпреЛрдЬрдирд╛ 5 рд╕рд╛рд▓ рдореЗрдВ рд▓реЛрдЧреЛрдВ рдХреЛ рдЪрд╛рдВрдж рдкрд░ рднреЗрдЬрдиреЗ рдХреА рд╣реИ</a></li>
<li><a href="../hi445580/index.html">VB.NET рдФрд░ C # рдХреЗ рдмреАрдЪ рдЕрдВрддрд░ рдХреА рдПрдХ рд╡рд┐рд╕реНрддреГрдд рд╕реВрдЪреАред рднрд╛рдЧ реи</a></li>
<li><a href="../hi445582/index.html">рд╕реАрдЖрд░рдПрдо рд╕рд┐рд╕реНрдЯрдо: рд╕реБрд░рдХреНрд╖рд╛ рдпрд╛ рдЦрддрд░рд╛?</a></li>
<li><a href="../hi445586/index.html">рдорд╛рд╕реНрдХреЛ рдореЗрдВ рдПрдВрдбреНрд░реЙрдЗрдб рдЕрдХрд╛рджрдореА - рдмрд╛рдд рдХрд░реЗрдВ рдХрд┐ рдпрд╣ рдХреИрд╕рд╛ рдерд╛ рдФрд░ рдкрд╛рдареНрдпрдХреНрд░рдо рд╕рд╛рдордЧреНрд░реА рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ</a></li>
<li><a href="../hi445588/index.html">рдкреНрд░рджрд░реНрд╢рдиреА рдореЗрдВ 30 рд╕реЗрдХрдВрдб рдореЗрдВ рдПрдХ рд╡реНрдпрдХреНрддрд┐ рдХреА 3 рдбреА рд╕реНрдХреИрдирд┐рдВрдЧ рджрд┐рдЦрд╛рдИ рдЬрд╛рдПрдЧреА</a></li>
<li><a href="../hi445590/index.html">рдЕрдВрдЧреНрд░реЗрдЬреА рд╡реНрдпрд╛рдХрд░рдгред рдХреМрди рдмрдирд╛рдо рдХрд┐рд╕ - рдХрд┐рд╕ рд╢рдмреНрдж рдХрд╛ рдЙрдкрдпреЛрдЧ рдХреИрд╕реЗ рдХрд░реЗрдВ, рдЗрд╕реЗ рд╕рдордЭреЗрдВ</a></li>
<li><a href="../hi445592/index.html">рд╕реНрдкреНрд░рд┐рдВрдЧ рдмреВрдЯ 2.2 рдореЗрдВ рдЖрд▓рд╕реА рдЖрд░рдВрднреАрдХрд░рдг</a></li>
<li><a href="../hi445594/index.html">рд╕рд╛рдЗрдЯ рддрдХ рдкрд╣реБрдВрдЪ рдХреЗ рдмрд┐рдирд╛ рдПрдХ рдЙрддреНрддрд░рджрд╛рдпреА рд╕рд╛рдЗрдЯ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдХрд░рдг</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>