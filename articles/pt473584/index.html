<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚öìÔ∏è üìë üìå Filtragem de conte√∫do na escola baseada no Ubuntu 18.04 e Squid transparente, com integra√ß√£o √† rede no MikroTik e n√£o apenas üï∫üèæ ü§≥ üôÖüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="1. Introdu√ß√£o 
 O t√≥pico sobre filtragem de conte√∫do nas escolas √© bastante simples e cheio de informa√ß√µes, mas j√° est√° desatualizado devido √† transi√ß...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Filtragem de conte√∫do na escola baseada no Ubuntu 18.04 e Squid transparente, com integra√ß√£o √† rede no MikroTik e n√£o apenas</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/473584/"><img src="https://habrastorage.org/webt/sl/bc/ta/slbctarcmoniq1q3aotimy8oiv8.jpeg"><br><br><h3>  1. Introdu√ß√£o </h3><br>  O t√≥pico sobre filtragem de conte√∫do nas escolas √© bastante simples e cheio de informa√ß√µes, mas j√° est√° desatualizado devido √† transi√ß√£o de muitos sites para o protocolo HTTPS seguro, com o qual a maioria das solu√ß√µes propostas n√£o funciona.  Por isso, decidi escrever o artigo mais completo de A a Z, coletando todas as informa√ß√µes que encontrei nas extens√µes do Google.  O artigo foi desenvolvido para o conhecimento b√°sico no campo da administra√ß√£o e √© adequado para professores de ci√™ncias da computa√ß√£o. <br><br><h3>  2. Termos de Refer√™ncia </h3><br>  <b>Dado:</b> 436-FZ e uma escola na qual muitos computadores est√£o em rede e conectados √† Internet atrav√©s de um roteador MikroTik ou qualquer outro. <br><br>  <b>Objetivo:</b> fazer a filtragem de conte√∫do de HTTP e HTTPS pela lista de permiss√µes para todos, exceto para quem voc√™ ama e para a administra√ß√£o da escola. <br><a name="habracut"></a><br><br><h3>  3. Resolu√ß√£o de problemas </h3><br>  Um computador de mesa n√£o utilizado foi encontrado com Intel-ohm de n√∫cleo duplo, 1 GB de RAM e 80 GB de disco r√≠gido. <br>  Para resolver isso, ser√° feito o seguinte: <br><br><ol><li>  Linux Ubuntu Server 18.04 LTS instalado </li><li>  O Transparent Proxy Squid √© instalado e configurado no servidor, compilado a partir dos c√≥digos-fonte com suporte a HTTPS. </li><li>  Integra√ß√£o do servidor na sub-rede, redirecionando solicita√ß√µes para Proxy ou uma alternativa (no final) </li></ol><br>  Vamos come√ßar. <br><br><h4>  3.1  Instale e configure o Ubuntu 18.04 </h4><br>  O processo de instala√ß√£o √© simples.  Fa√ßa o download da distribui√ß√£o do Ubuntu Server 18.04 no site oficial.  Eu recomendo fazer o download com o instalador antigo, pois o novo, pessoalmente, entrou em download infinito durante a instala√ß√£o.  Gravamos a imagem em uma unidade / disco flash USB de qualquer maneira conveniente.  Para gravar em uma unidade flash USB, recomendo usar o Rufus e, no in√≠cio da grava√ß√£o, selecione "Gravar imagem DD".  Em seguida, seguindo as informa√ß√µes na tela, instale o sistema.  N√≥s nos concentramos apenas na escolha de componentes, onde voc√™ pode selecionar imediatamente o OpenSSH e √© isso.  N√£o precisamos de muito, mas precisamos instalar o que precisamos. <br><br>  Ent√£o, o Ubuntu est√° instalado.  A rede, se voc√™ tiver DHCP, j√° est√° configurada.  Entraremos no modo superusu√°rio para que a cada vez que n√£o adicionamos sudo aos comandos. <br><br><pre><code class="javascript hljs">sudo -s</code> </pre> <br>  Digite sua senha e atualize o sistema. <br><br><pre> <code class="javascript hljs">apt-get update apt-get upgrade</code> </pre> <br>  Instale um editor de texto e um gerenciador de arquivos. <br><br><pre> <code class="javascript hljs">apt-get install nano mc</code> </pre> <br>  Para salvar o arquivo no <i><b>nano</b></i> , voc√™ deve pressionar <i>Ctrl + O</i> seguido de <i>Y.</i>  Saia do editor pressionando <i>Ctrl + X.</i>  Voc√™ pode salvar o arquivo imediatamente antes de sair pressionando <i>Ctrl + X</i> seguido de <i>Y.</i> <br>  Para abrir o gerenciador de arquivos, digite <i><b>mc</b></i> .  Um t√≠pico NortonCommander DOS ou Windows TotalCommander / FAR √© aberto com dois pain√©is.  Embora eu esteja acostumado a trabalhar com o console, o gerenciador de arquivos tamb√©m ajuda, por exemplo, a encontrar o arquivo desejado mais rapidamente. <br><br>  Se voc√™ n√£o possui DHCP ou deseja um endere√ßo IP separado para o seu servidor, como eu queria, ent√£o continuaremos com a configura√ß√£o. <br><br><div class="spoiler">  <b class="spoiler_title">Configurar endere√ßo IP est√°tico</b> <div class="spoiler_text">  Diferentemente das vers√µes anteriores do Ubuntu, no novo 18.04 a rede n√£o est√° mais configurada nas <i>interfaces</i> usuais <i>/ etc / network /</i> , mas via netplan no arquivo <i><b>/etc/netplan/*.yaml</b></i> .  O arquivo pode ter um nome diferente, mas est√° l√° sozinho.  / Etc / network / interfaces em si nos escreve o seguinte: <br><br><img src="https://habrastorage.org/webt/ye/m5/xr/yem5xrromrmumjbg5gcjyb_qkte.jpeg"><br><br>  Al√©m disso, se voc√™ deseja atualizar de uma vers√£o anterior √† 18.04, as configura√ß√µes de rede permanecer√£o onde estavam.  O Netplan √© relevante apenas para uma instala√ß√£o limpa do 18.04. <br><br>  Vamos come√ßar a configurar a rede. <br><br>  Primeiro, vejamos o nome da interface de rede atribu√≠da ao sistema operacional e lembre-se disso. <br><br><pre> <code class="javascript hljs">ifconfig</code> </pre> <br>  Agora abra o arquivo de configura√ß√µes. <br><br><pre> <code class="javascript hljs">nano /etc/netplan<span class="hljs-comment"><span class="hljs-comment">/*.yaml</span></span></code> </pre> <br>  Ele j√° deve ter uma configura√ß√£o de DHCP.  Vamos trazer o arquivo para o seguinte formul√°rio. <br><br><pre> <code class="javascript hljs"># This file describes the network interfaces available on your system # For more information, see netplan(<span class="hljs-number"><span class="hljs-number">5</span></span>). network: version: <span class="hljs-number"><span class="hljs-number">2</span></span> renderer: networkd ethernets:   : dhcp4: no dhcp6: no addresses: [/<span class="hljs-number"><span class="hljs-number">24</span></span>] gateway4:  nameservers: addresses: [<span class="hljs-number"><span class="hljs-number">77.88</span></span><span class="hljs-number"><span class="hljs-number">.8</span></span><span class="hljs-number"><span class="hljs-number">.7</span></span>, <span class="hljs-number"><span class="hljs-number">77.88</span></span><span class="hljs-number"><span class="hljs-number">.8</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span>]</code> </pre><br>  Digite sua interface, endere√ßo e gateway.  O DNS recomenda que voc√™ os deixe - Yandex.DNS Children ser√° uma prote√ß√£o adicional.  O mesmo DNS est√° configurado no meu roteador.  De qualquer forma, voc√™ deve especificar o DNS que o roteador distribui. <br><br>  Aqui voc√™ precisa prestar aten√ß√£o aos espa√ßos (ou seja, espa√ßos, n√£o tabula√ß√µes).  Cada um deles √© separado do espa√ßo anterior.  Por exemplo, se ap√≥s os servidores de nomes a linha de endere√ßo n√£o estiver separada por um espa√ßo, mas alinhada com a linha acima, quando voc√™ tentar aplicar as configura√ß√µes, o netplan apresentar√° um erro. <br><br>  Aplique as configura√ß√µes. <br><br><pre> <code class="javascript hljs">netplan apply</code> </pre> <br>  Reinicie o servidor, apenas por precau√ß√£o. <br><br><pre> <code class="javascript hljs">reboot</code> </pre> <br></div></div><br>  Al√©m disso, ele adicionou uma op√ß√£o de configura√ß√£o de rede alternativa para DHCP e IP est√°tico, se o netplan n√£o se adequar. <br><div class="spoiler">  <b class="spoiler_title">Configura√ß√£o alternativa de rede</b> <div class="spoiler_text">  No Ubuntu 18.04, voc√™ pode retornar √† op√ß√£o de configura√ß√£o de rede familiar atrav√©s de <i>/ etc / network / interfaces</i> .  Para fazer isso, o pr√≥prio arquivo indica que voc√™ precisa instalar o utilit√°rio <i>ifupdown</i> .  Instale-o: <br><pre> <code class="javascript hljs">apt-get install ifupdown</code> </pre> <br>  Agora abra o arquivo de configura√ß√µes iniciais no netplan <br><pre> <code class="javascript hljs">nano /etc/netplan<span class="hljs-comment"><span class="hljs-comment">/*.yaml</span></span></code> </pre> <br>  e comente todo o seu conte√∫do para que n√£o haja conflitos. <br>  Em seguida, abra o arquivo de configura√ß√µes de rede <br><pre> <code class="javascript hljs">nano /etc/network/interfaces</code> </pre> <br>  E adicione a ele: <br>  para IP est√°tico <br><pre> <code class="javascript hljs">auto ___ iface ___ inet <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> address IP- netmask  gateway  dns-nameservers <span class="hljs-number"><span class="hljs-number">77.88</span></span><span class="hljs-number"><span class="hljs-number">.8</span></span><span class="hljs-number"><span class="hljs-number">.7</span></span> <span class="hljs-number"><span class="hljs-number">77.88</span></span><span class="hljs-number"><span class="hljs-number">.8</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span></code> </pre> <br>  para din√¢mico (DHCP) <br><pre> <code class="javascript hljs">auto ___ iface ___ inet dhcp</code> </pre> <br>  Reinicialize o servidor <br><pre> <code class="javascript hljs">reboot</code> </pre> <br>  Se voc√™ usar esta op√ß√£o para configura√ß√µes de rede, nas configura√ß√µes de Firewall, poder√° desativar completamente o Webmin e usar a op√ß√£o de configura√ß√£o no spoiler (embora a variante do Webmin tamb√©m funcione) <br></div></div><br><br>  Agora voc√™ precisa habilitar a passagem de pacotes atrav√©s do nosso servidor.  Abra o arquivo <i>/etc/sysctl.conf</i> <br><pre> <code class="javascript hljs">nano /etc/sysctl.conf</code> </pre> <br>  Procuramos <i><b>a</b></i> string <i><b>net.ipv4.ip_forward = 1</b></i> e a descomentamos.  Se o valor for <i>0</i> , altere para <i>1</i> . <br>  Digite o comando para aplicar a configura√ß√£o <br><pre> <code class="javascript hljs">sysctl -p /etc/sysctl.conf</code> </pre> <br><br>  Ap√≥s configurar a rede, recomendo que voc√™ v√° diretamente ao terminal e continue a trabalhar nele.  Para fazer isso, se voc√™ n√£o selecionou o OpenSSH durante a fase de instala√ß√£o, instale-o. <br><br><pre> <code class="javascript hljs">apt-get install ssh</code> </pre> <br>  Por padr√£o, o SSH j√° est√° configurado para o login de usu√°rio / senha na porta 22, mas voc√™ pode configur√°-lo por si mesmo atrav√©s, por exemplo, de uma chave de autoriza√ß√£o e com outra porta para proteger o servidor contra ataques externos.  Como fazer isso est√° cheio de informa√ß√µes na Internet. <br><br>  Como terminal, eu uso o XShell.  Voc√™ pode usar o que preferir. <br><br>  N√£o precisamos de um servidor DHCP e uma segunda placa de rede, pois redirecionaremos as solicita√ß√µes do usu√°rio para o nosso proxy usando o pr√≥prio roteador. <br><br>  A funda√ß√£o est√° lan√ßada.  Agora vamos instalar e configurar o Squid. <br><br><h4>  3.2  Instalando e configurando o Squid com suporte HTTPS e filtragem de lista </h4><br>  <b>3.2.1</b>  <b>Construir e instalar o Squid</b> <br><br>  Como n√£o h√° um pacote Squid pronto com suporte a SSL nos reposit√≥rios, voc√™ precisar√° mont√°-lo manualmente a partir da fonte.  Primeiro, abra o arquivo com os reposit√≥rios. <br><br><pre> <code class="javascript hljs">nano /etc/apt/sources.list</code> </pre> <br>  Nela, removemos o coment√°rio (exclua # no in√≠cio) das linhas que come√ßam com <i><b>deb-src</b></i> . <br><br>  Depois disso, atualizaremos os pacotes. <br><br><pre> <code class="javascript hljs">apt-get update</code> </pre> <br>  Em seguida, instale as ferramentas de montagem. <br><br><pre> <code class="javascript hljs">apt-get install fakeroot build-essential devscripts</code> </pre> <br>  E adicione todos os pacotes necess√°rios para a montagem. <br><br><pre> <code class="javascript hljs">apt-get build-dep squid3</code> </pre> <br>  Instale a biblioteca para suporte SSL. <br><br><pre> <code class="javascript hljs">apt-get install libssl1<span class="hljs-number"><span class="hljs-number">.0</span></span>-dev</code> </pre> <br>  Vamos para a pasta inicial e crie uma pasta para a montagem, definindo imediatamente os direitos necess√°rios. <br><br><pre> <code class="javascript hljs">cd ~ mkdir build chown _apt:root build</code> </pre> <br>  V√° para a pasta criada e baixe as fontes do Squid. <br><br><pre> <code class="javascript hljs">cd build apt-get source squid3</code> </pre> <br>  Uma pasta aparecer√° na pasta de constru√ß√£o com o nome squid3 e o n√∫mero da vers√£o.  No Ubuntu 18.04.3, √© 3.5.27.  Vamos entrar nisso. <br><br><pre> <code class="javascript hljs">cd squid3<span class="hljs-number"><span class="hljs-number">-3.5</span></span><span class="hljs-number"><span class="hljs-number">.27</span></span></code> </pre> <br>  Antes da montagem, voc√™ deve especificar op√ß√µes.  Abra o arquivo com eles. <br><br><pre> <code class="javascript hljs">nano debian/rules</code> </pre> <br>  Estamos procurando uma lista de op√ß√µes, como na figura <br><br><img src="https://habrastorage.org/webt/w3/1a/xn/w31axng0b2nuqhjipuqc84sey78.jpeg"><br>  Adicione as seguintes op√ß√µes. <br><br><pre> <code class="javascript hljs">--enable-ssl \ --enable-ssl-crtd \ --<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-openssl</code> </pre> <br>  Observe que as op√ß√µes j√° foram adicionadas √† imagem e o caractere <b>"\"</b> deve aparecer ap√≥s cada linha nas op√ß√µes, <b>exceto a √∫ltima</b> . <br><br>  Ent√£o, tudo est√° pronto para montagem.  Agora vamos para a pasta de origem do Squid, embora voc√™ j√° deva estar nela. <br><br><pre> <code class="javascript hljs">cd ~<span class="hljs-regexp"><span class="hljs-regexp">/build/</span></span>squid3<span class="hljs-number"><span class="hljs-number">-3.5</span></span><span class="hljs-number"><span class="hljs-number">.27</span></span></code> </pre> <br>  E insira o comando para construir. <br><br><pre> <code class="javascript hljs">debuild -d</code> </pre> <br>  A montagem vai demorar muito, levei uma m√©dia de 2 a 4 horas.  Depende da velocidade do computador.  No final da montagem, voc√™ ver√° um erro de assinatura do pacote.  Isso √© normal - ignore o erro. <br><br>  Agora v√° para a pasta Build. <br><br><pre> <code class="javascript hljs">cd ~<span class="hljs-regexp"><span class="hljs-regexp">/build</span></span></code> </pre> <br>  E instale o Squid. <br><br><pre> <code class="javascript hljs">dpkg -i squid*.deb</code> </pre> <br>  Ocorre imediatamente um erro sobre depend√™ncias n√£o satisfeitas e insira o comando <br><br><pre> <code class="javascript hljs">apt-get install -f</code> </pre> <br>  Ap√≥s a instala√ß√£o, marcamos os pacotes para que n√£o sejam substitu√≠dos ap√≥s a atualiza√ß√£o do sistema. <br><br><pre> <code class="javascript hljs">apt-mark hold squid apt-mark hold squid-common apt-mark hold squidclient</code> </pre> <br>  <b>3.2.2</b>  <b>Configurando o Squid e a filtragem</b> <br><br>  Ent√£o, o Squid est√° instalado, resta configur√°-lo para nossas necessidades. <br><br>  Todas as configura√ß√µes est√£o no arquivo <i><b>/etc/squid/squid.conf</b></i> .  Ele cont√©m muitos coment√°rios e, √† primeira vista, parece muito complicado, mas na verdade n√£o h√° nada super complicado.  Para come√ßar, limparemos os coment√°rios copiando primeiro o original, se voc√™ quiser estud√°-lo de repente com mais detalhes.  Por conveni√™ncia, iremos diretamente para a pasta com o Squid. <br><br><pre> <code class="javascript hljs">cd /etc/squid cp squid.conf squid.conf.backup cat squid.conf.backup | egrep <span class="hljs-string"><span class="hljs-string">"^[^#]"</span></span> &gt; squid.conf</code> </pre> <br>  Agora abra o squid.conf <br><br><pre> <code class="javascript hljs">nano squid.conf</code> </pre> <br>  Como voc√™ pode ver, ele limpou os coment√°rios e deixou de ser t√£o volumoso quanto parecia. <br>  Sob o spoiler, postarei meu arquivo com configura√ß√µes que funcionam perfeitamente, e abaixo descreverei em blocos o que e como. <br><br><div class="spoiler">  <b class="spoiler_title">Configura√ß√£o do Squid.conf</b> <div class="spoiler_text"><pre> <code class="javascript hljs">acl localnet src <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> acl worktime time <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span><span class="hljs-number"><span class="hljs-number">-15</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span> acl SSL_ports port <span class="hljs-number"><span class="hljs-number">443</span></span> acl Safe_ports port <span class="hljs-number"><span class="hljs-number">80</span></span> # http acl Safe_ports port <span class="hljs-number"><span class="hljs-number">21</span></span> # ftp acl Safe_ports port <span class="hljs-number"><span class="hljs-number">443</span></span> # https acl Safe_ports port <span class="hljs-number"><span class="hljs-number">70</span></span> # gopher acl Safe_ports port <span class="hljs-number"><span class="hljs-number">210</span></span> # wais acl Safe_ports port <span class="hljs-number"><span class="hljs-number">1025</span></span><span class="hljs-number"><span class="hljs-number">-65535</span></span> # unregistered ports acl Safe_ports port <span class="hljs-number"><span class="hljs-number">280</span></span> # http-mgmt acl Safe_ports port <span class="hljs-number"><span class="hljs-number">488</span></span> # gss-http acl Safe_ports port <span class="hljs-number"><span class="hljs-number">591</span></span> # filemaker acl Safe_ports port <span class="hljs-number"><span class="hljs-number">777</span></span> # multiling http acl CONNECT method CONNECT acl blacklist url_regex -i <span class="hljs-string"><span class="hljs-string">"/etc/squid/blacklist"</span></span> acl whitelist url_regex -i <span class="hljs-string"><span class="hljs-string">"/etc/squid/whitelist"</span></span> http_access allow localhost http_access deny manager http_access deny !Safe_ports http_access deny CONNECT !SSL_ports http_access allow CONNECT http_access deny blacklist http_access allow whitelist http_access deny all worktime http_access allow all http_port <span class="hljs-number"><span class="hljs-number">3128</span></span> http_port <span class="hljs-number"><span class="hljs-number">3129</span></span> intercept https_port <span class="hljs-number"><span class="hljs-number">3130</span></span> intercept ssl-bump options=ALL:NO_SSLv3:NO_SSLv2 connection-auth=off cert=<span class="hljs-regexp"><span class="hljs-regexp">/etc/</span></span>squid/squid.pem always_direct allow all sslproxy_cert_error allow all sslproxy_flags DONT_VERIFY_PEER acl blacklist_ssl ssl::server_name_regex -i <span class="hljs-string"><span class="hljs-string">"/etc/squid/blacklist_ssl"</span></span> acl whitelist_ssl ssl::server_name_regex -i <span class="hljs-string"><span class="hljs-string">"/etc/squid/whitelist_ssl"</span></span> acl step1 at_step SslBump1 ssl_bump peek step1 ssl_bump terminate blacklist_ssl ssl_bump splice whitelist_ssl ssl_bump terminate all worktime ssl_bump splice all sslcrtd_program /usr/lib/squid/ssl_crtd -s /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/lib/ssl_db -M <span class="hljs-number"><span class="hljs-number">4</span></span>MB # cache_mem <span class="hljs-number"><span class="hljs-number">512</span></span> MB maximum_object_size_in_memory <span class="hljs-number"><span class="hljs-number">512</span></span> KB memory_replacement_policy lru cache_dir aufs /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/spool/squid <span class="hljs-number"><span class="hljs-number">2048</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">256</span></span> # access_log daemon:<span class="hljs-regexp"><span class="hljs-regexp">/var/</span></span>log/squid/access.log squid logfile_rotate <span class="hljs-number"><span class="hljs-number">1</span></span> coredump_dir /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/spool/squid refresh_pattern ^ftp: <span class="hljs-number"><span class="hljs-number">1440</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span>% <span class="hljs-number"><span class="hljs-number">10080</span></span> refresh_pattern ^gopher: <span class="hljs-number"><span class="hljs-number">1440</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>% <span class="hljs-number"><span class="hljs-number">1440</span></span> refresh_pattern -i (<span class="hljs-regexp"><span class="hljs-regexp">/cgi-bin/</span></span>|\?) <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>% <span class="hljs-number"><span class="hljs-number">0</span></span> refresh_pattern (Release|Packages(.gz)*)$ <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span>% <span class="hljs-number"><span class="hljs-number">2880</span></span> refresh_pattern . <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span>% <span class="hljs-number"><span class="hljs-number">4320</span></span></code> </pre> <br></div></div><br>  <i><b>O primeiro bloco √©</b></i> o seguinte. <br><br><pre> <code class="javascript hljs">acl localnet src <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> acl worktime time <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span><span class="hljs-number"><span class="hljs-number">-15</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span> acl SSL_ports port <span class="hljs-number"><span class="hljs-number">443</span></span> acl Safe_ports port <span class="hljs-number"><span class="hljs-number">80</span></span> # http acl Safe_ports port <span class="hljs-number"><span class="hljs-number">21</span></span> # ftp acl Safe_ports port <span class="hljs-number"><span class="hljs-number">443</span></span> # https acl Safe_ports port <span class="hljs-number"><span class="hljs-number">70</span></span> # gopher acl Safe_ports port <span class="hljs-number"><span class="hljs-number">210</span></span> # wais acl Safe_ports port <span class="hljs-number"><span class="hljs-number">1025</span></span><span class="hljs-number"><span class="hljs-number">-65535</span></span> # unregistered ports acl Safe_ports port <span class="hljs-number"><span class="hljs-number">280</span></span> # http-mgmt acl Safe_ports port <span class="hljs-number"><span class="hljs-number">488</span></span> # gss-http acl Safe_ports port <span class="hljs-number"><span class="hljs-number">591</span></span> # filemaker acl Safe_ports port <span class="hljs-number"><span class="hljs-number">777</span></span> # multiling http acl CONNECT method CONNECT</code> </pre> <br>  Ele √© respons√°vel pelos par√¢metros acl padr√£o.  Nele, na localnet, alteramos a rede local para a nossa e tamb√©m adicionamos um tempo de trabalho (opcional).  Acrescentei tempo de trabalho, visto que os professores costumam me procurar reclamando que n√£o conseguem encontrar nada, tudo √© inacess√≠vel.  √â claro que estou feliz que tudo funcione como deveria, mas, francamente, estou cansado de ouvir isso.  Agora, estou relatando a alega√ß√£o de que, depois das 15:00, a filtragem √© desativada e eles podem encontrar (quase) livremente (quase) as informa√ß√µes de que precisam.  Voc√™ pode adicionar seu tempo ou deixar a filtragem o tempo todo sem adicionar essa ACL. <br><br>  <i><b>O segundo bloco</b></i> define as listas de sites permitidos e proibidos para HTTP e tem a seguinte apar√™ncia. <br><br><pre> <code class="javascript hljs">acl blacklist url_regex -i <span class="hljs-string"><span class="hljs-string">"/etc/squid/blacklist"</span></span> acl whitelist url_regex -i <span class="hljs-string"><span class="hljs-string">"/etc/squid/whitelist"</span></span></code> </pre><br>  N√≥s adicionaremos listas de sites permitidos e proibidos posteriormente, e eles ser√£o colocados nos arquivos especificados em acl. <br><br>  <i><b>O terceiro bloco</b></i> determina os par√¢metros de acesso via HTTP e se parece com isso <br><br><pre> <code class="javascript hljs">http_access allow localhost http_access deny manager http_access deny !Safe_ports http_access deny CONNECT !SSL_ports http_access allow CONNECT http_access deny blacklist http_access allow whitelist http_access deny all worktime http_access allow all</code> </pre> <br>  Aqui o item <i>http_access allow CONNECT √©</i> necess√°rio, pois sem ele o Squid n√£o deixaria ningu√©m na Internet.  A seguir, est√£o as regras nas listas em preto e branco.  Os par√¢metros <i>negar</i> e <i>permitir</i> <i>negam</i> e <i>permitem</i> acesso, respectivamente.  Depois deles, vem a regra de banir completamente todo o tr√°fego HTTP durante o hor√°rio comercial.  Se voc√™ n√£o definiu o hor√°rio de trabalho, exclua o hor√°rio de <i>trabalho</i> e a proibi√ß√£o ser√° permanente.  Um ponto importante √© a ordem das regras, pois o Squid as l√™ de cima para baixo <br>  <i><b>O quarto bloco</b></i> define as configura√ß√µes de porta do Squid. <br><br><pre> <code class="javascript hljs">http_port <span class="hljs-number"><span class="hljs-number">3128</span></span> http_port <span class="hljs-number"><span class="hljs-number">3129</span></span> intercept https_port <span class="hljs-number"><span class="hljs-number">3130</span></span> intercept ssl-bump options=ALL:NO_SSLv3:NO_SSLv2 connection-auth=off cert=<span class="hljs-regexp"><span class="hljs-regexp">/etc/</span></span>squid/squid.pem</code> </pre> <br>  O primeiro par√¢metro √© necess√°rio para que o erro "ERRO: Nenhuma porta de proxy direto configurada" n√£o apare√ßa infinitamente nos logs.  Preenche o log e, portanto, a mem√≥ria.  Um erro comum, mas, por alguma raz√£o, em nosso segmento ru n√£o encontrei como corrigi-lo, f√≥runs estrangeiros ajudaram.  O segundo par√¢metro define a porta do protocolo HTTP.  <i>Intercepta√ß√£o</i> significa transpar√™ncia de proxy, ou seja, n√£o ser√° necess√°rio prescrever configura√ß√µes em cada computador. <br>  O terceiro par√¢metro define a porta HTTPS e suas op√ß√µes.  Esta √© uma longa fila.  O arquivo <i>squid.pem</i> √© o nosso certificado, que criaremos posteriormente. <br><br>  <i><b>O quinto bloco</b></i> define os par√¢metros da conex√£o SSL com o Squid.  Em particular, ele indica que todo o tr√°fego deve ser direcionado imediatamente para a Internet, sem o uso de caches mais altos, e os dois √∫ltimos permitem conex√µes mesmo com erros de verifica√ß√£o de certificado, pois a decis√£o de visitar esse recurso deve ser feita pelo usu√°rio, n√£o pelo servidor.  Parece assim. <br><br><pre> <code class="javascript hljs">always_direct allow all sslproxy_cert_error allow all sslproxy_flags DONT_VERIFY_PEER</code> </pre> <br>  <i><b>O sexto bloco</b></i> define os par√¢metros acl das listas "preta" e "branca", que ser√£o criadas posteriormente, bem como a profundidade de intercepta√ß√£o do tr√°fego HTTPS. <br><br><pre> <code class="javascript hljs">acl blacklist_ssl ssl::server_name_regex -i <span class="hljs-string"><span class="hljs-string">"/etc/squid/blacklist_ssl"</span></span> acl whitelist_ssl ssl::server_name_regex -i <span class="hljs-string"><span class="hljs-string">"/etc/squid/whitelist_ssl"</span></span> acl step1 at_step SslBump1</code> </pre> <br>  <i><b>O s√©timo bloco</b></i> determina os par√¢metros de acesso usando o protocolo HTTPS.  Aqui, a proibi√ß√£o e a permiss√£o j√° s√£o respons√°veis ‚Äã‚Äãpelo <i>t√©rmino</i> e pela <i>emenda,</i> respectivamente.  Novamente, n√£o esque√ßa de remover o <i>hor√°rio de trabalho</i> se voc√™ n√£o tiver um hor√°rio de trabalho especificado. <br><br><pre> <code class="javascript hljs">ssl_bump peek step1 ssl_bump terminate blacklist_ssl ssl_bump splice whitelist_ssl ssl_bump terminate all worktime ssl_bump splice all sslcrtd_program /usr/lib/squid/ssl_crtd -s /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/lib/ssl_db -M <span class="hljs-number"><span class="hljs-number">4</span></span>MB</code> </pre><br>  <i><b>O oitavo bloco</b></i> define o cache e o log do nosso Squid.  Aqui, √© importante observar apenas o par√¢metro <i>logfile_rotate</i> , que indica o n√∫mero de dias durante os quais o log √© armazenado. <br><br><pre> <code class="javascript hljs"># cache_mem <span class="hljs-number"><span class="hljs-number">512</span></span> MB maximum_object_size_in_memory <span class="hljs-number"><span class="hljs-number">512</span></span> KB memory_replacement_policy lru cache_dir aufs /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/spool/squid <span class="hljs-number"><span class="hljs-number">2048</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">256</span></span> # access_log daemon:<span class="hljs-regexp"><span class="hljs-regexp">/var/</span></span>log/squid/access.log squid logfile_rotate <span class="hljs-number"><span class="hljs-number">1</span></span> coredump_dir /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/spool/squid refresh_pattern ^ftp: <span class="hljs-number"><span class="hljs-number">1440</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span>% <span class="hljs-number"><span class="hljs-number">10080</span></span> refresh_pattern ^gopher: <span class="hljs-number"><span class="hljs-number">1440</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>% <span class="hljs-number"><span class="hljs-number">1440</span></span> refresh_pattern -i (<span class="hljs-regexp"><span class="hljs-regexp">/cgi-bin/</span></span>|\?) <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>% <span class="hljs-number"><span class="hljs-number">0</span></span> refresh_pattern (Release|Packages(.gz)*)$ <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span>% <span class="hljs-number"><span class="hljs-number">2880</span></span> refresh_pattern . <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span>% <span class="hljs-number"><span class="hljs-number">4320</span></span></code> </pre> <br>  Isto completa a configura√ß√£o do squid.conf.  Salvamos o arquivo e prosseguimos para a cria√ß√£o do certificado e das listas. <br><br>  Vamos para a pasta com o Squid <br><br><pre> <code class="javascript hljs">cd /etc/squid/</code> </pre> <br>  E digite o seguinte comando para criar o certificado <br><br><pre> <code class="javascript hljs">openssl req -<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> -newkey rsa:<span class="hljs-number"><span class="hljs-number">1024</span></span> -days <span class="hljs-number"><span class="hljs-number">36500</span></span> -nodes -x509 -keyout squid.pem -out squid.pem</code> </pre> <br>  Em seguida, voc√™ precisar√° inserir os dados do certificado.  O certificado √© v√°lido por 100 anos para esquec√™-lo por um longo tempo.  √â necess√°rio apenas para Proxy. <br><br>  Agora crie nossos arquivos de lista. <br><br><pre> <code class="javascript hljs">touch blacklist touch whitelist cp whitelist whitelist_ssl cp blacklist blacklist_ssl</code> </pre> <br>  Os sites s√£o listados na forma de express√µes regulares.  Por exemplo, para desbloquear mail.ru, abra a <i>lista de permiss√µes</i> <br><br><pre> <code class="javascript hljs">nano whitelist</code> </pre> <br>  e adicione a seguinte express√£o a ele. <br><br><pre> <code class="javascript hljs">mail\.ru</code> </pre> <br>  Agora bloqueie Games.Mail.ru.  Vamos abrir nossa <i>lista negra</i> <br><br><pre> <code class="javascript hljs">nano blacklist</code> </pre> <br>  e escreva a seguinte express√£o nele <br><br><pre> <code class="javascript hljs">games\.mail\.ru</code> </pre> <br>  Como, regra geral, um bloqueador de lista negra est√° acima da nossa lista branca, quando voc√™ alterna para mail.ru, o site ser√° aberto conforme o esperado (exceto para fotos, mas mais sobre isso mais tarde), e se voc√™ tentar mudar para Jogos, nos Squid n√£o vai deixar ir. <br><br>  Alguns sites t√™m muitos subdom√≠nios, subdom√≠nios etc.  Como, por exemplo, mail.ru armazena suas imagens em imgsmail.ru.  Em rela√ß√£o a outros sites semelhantes, √© necess√°rio abrir o site desejado em qualquer navegador (eu uso o Chrome) e, posteriormente, as ferramentas do desenvolvedor (no Chrome, elas s√£o chamadas pressionando F12). <br><br><img src="https://habrastorage.org/webt/ie/43/a7/ie43a7r-zkjhouxldavryxg0kjg.jpeg"><br><br>  V√° para a guia Fontes e veja de que outros recursos o site carrega informa√ß√µes. <br><br>  Ap√≥s adicionar sites, copie-os para as listas de HTTPS. <br><br><pre> <code class="javascript hljs">cp whitelist whitelist_ssl cp blacklist blacklist_ssl</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Dica de preenchimento de lista</b> <div class="spoiler_text">  Crie um arquivo de texto sem formata√ß√£o no seu computador, encontre e copie a lista de sites permitidos, adicione-a ao seu.  Em um notebook comum, substitua automaticamente o ponto por um ponto de barra (\.) E exclua o desnecess√°rio pela mesma substitui√ß√£o autom√°tica (www, http, o caractere "/" etc.).  Em seguida, esse arquivo, usando o terminal, pode ser imediatamente copiado para as folhas no servidor. <br></div></div><br>  Agora verifique a configura√ß√£o. <br><br><pre> <code class="javascript hljs">squid -k check</code> </pre> <br>  Se tudo estiver bem, pare o Squid. <br><br><pre> <code class="javascript hljs">/etc/init.d/squid stop</code> </pre> <br>  Reconstruir o cache <br><br><pre> <code class="javascript hljs">squid -z</code> </pre> <br>  E execute o Squid novamente <br><br><pre> <code class="javascript hljs">/etc/init.d/squid start</code> </pre> <br>  Ap√≥s qualquer altera√ß√£o nas listas ou na configura√ß√£o do Squid, ele deve ser recarregado com o comando <br><br><pre> <code class="javascript hljs">/etc/init.d/squid restart</code> </pre> <br>  Voc√™ tamb√©m pode alterar a p√°gina de restri√ß√£o de acesso (funciona apenas em HTTP) no caminho <i><b>/ usr / share / squid / errors / ~ Russian-1251</b></i> .  Procure na pasta o arquivo <i><b>ERR_ACCESS_DENIED</b></i> e edite-o.  A sintaxe do arquivo √© HTML. <br><br><h4>  3.3  Monitorando o status do servidor e configurando o firewall </h4><br>  Para monitorar o status do nosso servidor, instale o utilit√°rio <b>Webmin</b> , com a ajuda da qual configuramos nosso Firewall.  Al√©m disso, voc√™ pode monitorar o status da CPU, RAM, etc., atualizar pacotes, adicionar e configurar componentes e muito mais.  Possui terminal pr√≥prio, embora desajeitado.  O utilit√°rio funciona em qualquer navegador, portanto, voc√™ pode conectar-se ao nosso servidor a partir de qualquer computador na rede, o que √© conveniente o suficiente, embora n√£o seja seguro.  Se desejado, a conex√£o pode ser limitada apenas a endere√ßos IP individuais no "Controle de acesso IP" no pr√≥prio Webmin. <br><br>  Antes de iniciar a instala√ß√£o, adicione o reposit√≥rio Webmin.  Abra o sources.list. <br><br><pre> <code class="javascript hljs">nano /etc/apt/sources.list</code> </pre> <br>  E adicione a linha abaixo. <br><br><pre> <code class="javascript hljs">deb http:<span class="hljs-comment"><span class="hljs-comment">//download.webmin.com/download/repository sarge contrib</span></span></code> </pre> <br>  Agora instale a chave GPG com a qual os pacotes s√£o assinados no reposit√≥rio Webmin <br><br><pre> <code class="javascript hljs">cd /root wget http:<span class="hljs-comment"><span class="hljs-comment">//www.webmin.com/jcameron-key.asc apt-key add jcameron-key.asc</span></span></code> </pre> <br>  Em seguida, atualizamos a lista de pacotes e instalamos o utilit√°rio <br><br><pre> <code class="javascript hljs">apt-get update apt-get install webmin</code> </pre> <br>  Voc√™ pode se conectar ao servidor em qualquer navegador digitando a barra de endere√ßo <br><br><pre> <code class="javascript hljs">IP__:<span class="hljs-number"><span class="hljs-number">10000</span></span></code> </pre> <br>  Por padr√£o, o Webmin se conecta via SSL e a maioria dos navegadores gera um erro de certificado n√£o confi√°vel.  Para n√£o escolher confiar sempre, desative o SSL.  Para fazer isso, abra o arquivo <i>/etc/webmin/miniserv.conf</i> <br><br><pre> <code class="javascript hljs">nano /etc/webmin/miniserv.conf</code> </pre> <br>  Encontre a string <i><b>ssl = 1</b></i> e substitua-a por <i><b>ssl = 0</b></i> .  No mesmo arquivo, voc√™ pode alterar a porta de conex√£o.  Por padr√£o, √© 10000. Voc√™ pode colocar qualquer um gr√°tis. <br><br>  Ap√≥s conectar-se ao Webmin, v√° para <i>Webmin -&gt; Configura√ß√£o do Webmin</i> e mude o idioma para o russo.  Ent√£o v√° para <i>Rede -&gt; Firewall</i> .  Por padr√£o, nosso firewall est√° limpo.  Vamos para o final e ao lado de " <i>Ativar na inicializa√ß√£o",</i> selecione <i>"Sim"</i> .  Clique em <i>"Aplicar configura√ß√£o"</i> .  Agora, as configura√ß√µes do nosso Firewall est√£o especificadas no arquivo <i><b>/etc/webmin/firewall/iptables.save</b></i> e s√£o iniciadas com o sistema.  Se n√£o houver esse arquivo, verifique o que est√° escrito na linha "Arquivo com regras" na guia Firewall no Webmin.  Vamos abri-lo no terminal. <br><br><pre> <code class="javascript hljs">nano /etc/webmin/firewall/iptables.save</code> </pre> <br>  Vamos para o bloco <i><b>* nat</b></i> e, no final, antes do <i>COMMIT,</i> adicionamos as seguintes regras. <br><br><pre> <code class="javascript hljs">-A PREROUTING -p tcp -m tcp -i _ --dport <span class="hljs-number"><span class="hljs-number">80</span></span> -j DNAT --to-destination ip_:<span class="hljs-number"><span class="hljs-number">3129</span></span> -A PREROUTING -p tcp -m tcp -i _ --dport <span class="hljs-number"><span class="hljs-number">443</span></span> -j REDIRECT --to-ports <span class="hljs-number"><span class="hljs-number">3130</span></span></code> </pre> <br>  Essas regras direcionam o tr√°fego para as portas 80 (HTTP) e 443 (HTTPS) do servidor para as portas do nosso Squid.  Aqui apresentei duas variantes das regras com DNAT e REDIRECT.  Voc√™ pode usar os dois ou escolher uma op√ß√£o, colocando as portas apropriadas. <br><br><div class="spoiler">  <b class="spoiler_title">Configurar o FIrewall para configura√ß√£o de rede alternativa</b> <div class="spoiler_text">  Esta op√ß√£o √© adequada se voc√™ usou a configura√ß√£o de rede alternativa descrita acima. <br>  Primeiro, crie um arquivo com as regras do nosso Firewall e d√™ o direito de executar. <br><pre> <code class="javascript hljs">touch /etc/nat chmod +x /etc/nat</code> </pre> <br>  Abra <br><pre> <code class="javascript hljs">nano /etc/nat</code> </pre> <br>  E adicione o seguinte conte√∫do <br><pre> <code class="javascript hljs"><span class="hljs-meta"><span class="hljs-meta">#!/bin/sh #Firewall iptables -t nat -A PREROUTING -p tcp -m tcp -i _ --dport 80 -j DNAT --to-destination ip_:3129 iptables -t nat -A PREROUTING -p tcp -m tcp -i _ --dport 443 -j REDIRECT --to-ports 3130</span></span></code> </pre> <br>  Como no caso do Webmin, apresentei duas variantes das regras com DNAT e REDIRECT.  Voc√™ pode usar os dois ou escolher uma op√ß√£o, colocando as portas apropriadas. <br>  Agora adicione nosso arquivo ao download imediatamente ap√≥s iniciar a rede.  Abra o arquivo de configura√ß√µes de rede <br><pre> <code class="javascript hljs">nano /etc/network/interfaces</code> </pre> <br>  E adicione a linha na parte inferior do arquivo <br><pre> <code class="javascript hljs">post-up /etc/nat</code> </pre> <br>  PS: a vantagem dessa op√ß√£o √© que voc√™ pode adicionar suas pr√≥prias regras no futuro apenas editando o arquivo / etc / nat.  O Webmin √© um pouco mais complicado. <br></div></div><br>  Isso completa a configura√ß√£o do servidor.  Reinicie-o. <br><br><pre> <code class="javascript hljs">reboot</code> </pre> <br>  E vamos prosseguir com a configura√ß√£o do roteador MikroTik. <br><br><h4>  3.4  Configurando um roteador MikroTik para redirecionar o tr√°fego para o proxy </h4><br>  Assumimos que voc√™ j√° baixou o utilit√°rio <b>WinBox</b> para controle remoto, a Internet e a rede local est√£o configuradas, o firewall do roteador est√° limpo.  voc√™ sabe o nome da interface da LAN (voc√™ pode v√™-lo em <i>IP - DHCP Server - DHCP</i> ). <br><br>  <b>a)</b> V√° para WinBox, v√° para <i><b>IP - DHCP Server - Leases</b></i> .  Na lista, procuramos computadores IP para os quais a filtragem n√£o funcionar√° (diretor, gerenciamento), clique com o bot√£o direito do mouse neles e selecione <i><b>Tornar est√°tico</b></i> no menu.  Ao lado deles, a letra "D" deve desaparecer, o que significa din√¢mico.  Agora, esses endere√ßos ser√£o imediatamente atribu√≠dos estaticamente a esses computadores, independentemente do tempo de concess√£o, pelo endere√ßo MAC.  Se o laptop for usado via Wi-Fi e cabo, voc√™ dever√° selecionar Tornar est√°tico nos dois endere√ßos MAC. <br><br>  <b>b)</b> Em seguida, v√° para <i><b>IP - Firewall - Address Lists</b></i> e clique no sinal de <i><b>adi√ß√£o</b></i> azul <i><b>"+"</b></i> .  No campo <i><b>Nome</b></i> , especifique o nome do nosso grupo de endere√ßos n√£o filtrados <s>brilhantes</s> , por exemplo, "Administradores".  No campo <i><b>Endere√ßo</b></i> , especifique um endere√ßo IP daqueles aos quais foi atribu√≠do um est√°tico.  Repetimos isso para cada endere√ßo, selecionando nosso grupo no campo Nome com uma seta. <br><br>  <b>c)</b> V√° para a guia <i><b>Mangle</b></i> no mesmo <i><b>IP - Firewall</b></i> e clique em <i><b>"+"</b></i> .  Uma janela com guias ser√° aberta.  Na guia <i><b>Geral</b></i> , preencha os seguintes campos: <br><br><pre> <code class="javascript hljs">Chain - Prerouting Src. Address - __proxy Protocol - <span class="hljs-number"><span class="hljs-number">6</span></span> (tcp) Dst. Port - <span class="hljs-number"><span class="hljs-number">80</span></span> In. Interface - __</code> </pre><br>  Na guia <b><i>A√ß√£o</i></b> , verifique o valor <i><b>Aceitar</b></i> e clique em OK. <br><br>  Repita o processo, mas no campo <i>Dst.</i>  <i>Porta</i> defina o valor para <i>443</i> . <br><br>  <b>d)</b> Clique em "+" novamente e, na guia <i><b>Geral</b></i> , preencheremos novamente os seguintes campos: <br><br><pre> <code class="javascript hljs">Chain - Prerouting Protocol - <span class="hljs-number"><span class="hljs-number">6</span></span> (tcp) Dst. Port - <span class="hljs-number"><span class="hljs-number">80</span></span> In. Interface - __</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V√° para a guia </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Avan√ßado</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e no campo </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Src. </font><font style="vertical-align: inherit;">Lista de endere√ßos</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> selecione nossa lista de endere√ßos de gerenciamento </font><font style="vertical-align: inherit;">" </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Administradores</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ". </font><font style="vertical-align: inherit;">Certifique-se de clicar na caixa exibida ao lado da lista. </font><font style="vertical-align: inherit;">Um ponto de exclama√ß√£o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Äú!‚Äù</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Aparecer√° </font><b><font style="vertical-align: inherit;">. </font></b><font style="vertical-align: inherit;">, significando l√≥gico N√ÉO ou NEGATIVO. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V√° para a guia </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A√ß√£o</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e preencha os campos:</font></font><br><br><pre> <code class="javascript hljs">Action - mark routing New Routing Mark - to_proxy Passthrough -  </code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Clique em OK e execute as mesmas a√ß√µes, mas no campo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dst. </font><font style="vertical-align: inherit;">Porta</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> especifique o valor </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">443</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Finalmente, adicione a √∫ltima regra. </font><font style="vertical-align: inherit;">Clique no sinal de mais e preencha os seguintes campos na guia </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Geral</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br><br><pre> <code class="javascript hljs">Chain - Prerouting In. Interface - __ Routing Mark - to_proxy</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como resultado, o seguinte deve acontecer com seus par√¢metros. </font><font style="vertical-align: inherit;">A ordem √© importante! </font></font><br><br><img src="https://habrastorage.org/webt/tp/vw/zi/tpvwzizj0x_x4hg5quooe1t8bpo.png"><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">f)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> N√≥s seguimos </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rotas IP</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e pressionamos "+". </font><font style="vertical-align: inherit;">Preencha os seguintes campos:</font></font><br><br><pre> <code class="javascript hljs">Dst. Address - <span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> Gateway - __proxy Routing Mark - to_proxy</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Clique em OK e pronto. </font><font style="vertical-align: inherit;">Com o servidor ativado, todo o tr√°fego HTTP e HTTPS passar√° pelo nosso Squid.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.5 </font><font style="vertical-align: inherit;">Configura√ß√£o alternativa para MikroTik e outros roteadores</font></font></h4><br>       MikroTik,     ,    (       ).            ,    Squid. , . <br> <b>)</b>  ,      ,   ,     Proxy  MikroTik.     ,     <b><i>)</i></b>  <i><b>3.4</b></i>  .     3.4 (, ,  <i>)</i>  ,   IP  ),     ‚Äî     .     <i><b>IP ‚Äî Routes</b></i> ,   ,      <b><i><font color="#cc0000"> </font></i></b> ( ,  ,    ).    =&gt;  .   ,         . <br><br> <b>)</b>           Squid <br><pre> <code class="javascript hljs">cd /etc/squid/</code> </pre> <br>    <br><pre> <code class="javascript hljs">nano squid.conf</code> </pre> <br>      : <br> <i><b>  </b></i>     acl localnet‚Ä¶ <br><pre> <code class="javascript hljs">acl admins src <span class="hljs-string"><span class="hljs-string">"/etc/squid/admins-ip"</span></span> # IP   acl students src <span class="hljs-string"><span class="hljs-string">"/etc/squid/students-ip"</span></span> # IP  </code> </pre> <br>       ,   ,      .            . <br> <i><b>  </b></i> <br><pre> <code class="javascript hljs">acl whitelist-stud url_regex -i <span class="hljs-string"><span class="hljs-string">"/etc/squid/whitelist-stud"</span></span> #     </code> </pre> <br> <i><b>  </b></i>  http_access deny blacklist <br><pre> <code class="javascript hljs">http_access allow admins #      http_access allow students whitelist-stud #       http_access deny students #       </code> </pre> <br>     ,      (  IP)           ( ).      admins    ,     ,    IP ( )   acl       blacklist. <br> <i><b>   </b></i>  . <br> <i><b>  </b></i>  <br><pre> <code class="javascript hljs">acl whitelist-stud_ssl ssl::server_name_regex -i <span class="hljs-string"><span class="hljs-string">"/etc/squid/whitelist-stud_ssl"</span></span></code> </pre> <br> <i><b>  </b></i>   ssl_bump terminate blacklist_ssl <br><pre> <code class="javascript hljs">ssl_bump splice admins ssl_bump splice students whitelist-stud_ssl ssl_bump terminate students</code> </pre> <br>   ,     . <br>   .    <br><br> <b>)</b>     IP-. <br><pre> <code class="javascript hljs">touch admins-ip touch students-ip</code> </pre> <br>     . <br><pre> <code class="javascript hljs">touch whitelist-stud cp whitelist-stud whitelist-stud_ssl</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adicione os endere√ßos IP e sites necess√°rios √†s listas apropriadas. </font><font style="vertical-align: inherit;">Na lista de sites dos alunos, voc√™ pode copiar a lista dos professores removendo sites que n√£o s√£o necess√°rios para os alunos. </font><font style="vertical-align: inherit;">A c√≥pia de arquivos no Linux √© feita pelo comando</font></font><br><pre> <code class="javascript hljs">cp &lt;    &gt; <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name"></span></span></span></span><span class="xml"><span class="hljs-tag">    &gt;</span></span></span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Reinicie o Squid </font></font><br><pre> <code class="javascript hljs">/etc/init.d/squid restart</code> </pre> <br><br> <b>)</b>     ,  ,          Proxy.      DHCP-       . ,        ,    MAC. <br> <b> MikroTik:</b> <br>   <i><b>IP ‚Äî DHCP Server ‚Äî Network</b></i>       .   Gateway      Proxy-.    .   ,        .    ,  ,      (  ). <br> <b>  :</b> <br>      ,    DHCP-,  ,     :) <br><br> <i>:</i>              IP  ,     Squid  IP- .  ,  -      Proxy  ,   . <br><div class="spoiler"> <b class="spoiler_title">  Proxy</b> <div class="spoiler_text">   ,  -      Squid ,        ,   , <br></div></div><br><br><h3> 4.  </h3><br> ,   .         Linux Ubuntu 18.04 LTS,    Squid   HTTPS,     ,  Proxy-        DHCP-. <br><br><h3> 5.   </h3><br>          <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">   ¬´¬ª</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Web Safety ‚Äî Web Filter for Your Network</a> ,      . <br>         : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">Kanlas</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">PetRiot</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">Barsook</a> .       . <br><br><h3> 6.   </h3><br><ol><li>         ,  <i>sudo</i>  ,      <i>sudo -s</i> . </li><li> Squid \     ,    , ,     .          . </li><li>    , .    ,        1000 . </li><li> <s> ,           IP-  Squid.   Squid   IP- ‚Äî  Mikrotik.    ,      DHCP    ,      . ,    ,    ,     IP .</s> ‚Äî     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">Barsook</a> </li><li>   Squid     ( 50)   1  .  ,   Squid  .     ,   <i>top</i> . </li><li>       ,  ,         ( ),    . </li></ol><br><br> <b>UPD1:</b>      Firewall <br> <b>UPD2:</b>     ,         Squid. <br> <b>UPD3:</b>    3.1 ‚Äî     ,    .    .  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">Dmitry1986</a>   . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt473584/">https://habr.com/ru/post/pt473584/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt473570/index.html">Pesquise 314 km¬≤ em 10 horas - a batalha final dos engenheiros de busca contra a floresta</a></li>
<li><a href="../pt473572/index.html">‚ÄúZakroma Rodina‚Äù ser√° recontado: a Alemanha determinar√° reservas estrat√©gicas pelo novo m√©todo</a></li>
<li><a href="../pt473574/index.html">Aplicativo no TSD e comunica√ß√£o com 1C: Enterprise 8.3 atrav√©s do servi√ßo HTTP. Parte 3 (BroadcastReceiver Obtendo o c√≥digo de barras)</a></li>
<li><a href="../pt473576/index.html">Infraestrutura de experi√™ncia do desenvolvedor</a></li>
<li><a href="../pt473578/index.html">Criando m√≥dulos din√¢micos para o Nginx</a></li>
<li><a href="../pt473586/index.html">FortiConverter ou movimento sem complica√ß√µes</a></li>
<li><a href="../pt473588/index.html">Ases intrusivos: cinem√°tica da aterrissagem "invertida" em moscas azuis</a></li>
<li><a href="../pt473590/index.html">Como ganhei 3 de 4 medalhas de ouro na Olimp√≠ada de Computa√ß√£o</a></li>
<li><a href="../pt473592/index.html">Scrum Community MeetUp em Raiffeisenbank + transmiss√£o</a></li>
<li><a href="../pt473596/index.html">Python v3.x: manipulador de exce√ß√µes para corotina e fun√ß√µes s√≠ncronas. Em geral, para tudo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>