<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöà üÜñ üíÖüèª Volver a los microservicios con Istio. Parte 1 üê© üë©üèæ‚Äçü§ù‚Äçüë®üèΩ üñ§</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nota perev. : Las mallas de servicio se han convertido definitivamente en una soluci√≥n relevante en la infraestructura moderna para aplicaciones que s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Volver a los microservicios con Istio. Parte 1</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/438426/"><img src="https://habrastorage.org/webt/bj/j4/oy/bjj4oyjxqshrbjf5eks9sgsvbeg.png"><br><br>  <i><b>Nota</b></i>  <i><b>perev.</b></i>  <i>: Las mallas de servicio se han convertido definitivamente en una soluci√≥n relevante en la infraestructura moderna para aplicaciones que siguen la arquitectura del microservicio.</i>  <i>Aunque Istio puede ser escuchado por muchos ingenieros de DevOps, es un producto bastante nuevo que, al ser exhaustivo en t√©rminos de las caracter√≠sticas proporcionadas, puede requerir un tiempo considerable para conocerse.</i>  <i>El ingeniero alem√°n Rinor Maloku, responsable de la inform√°tica en la nube para grandes clientes de la empresa de telecomunicaciones Orange Networks, ha escrito una maravillosa serie de materiales que le permiten sumergirse r√°pida y profundamente en Istio.</i>  <i>Comienza su historia con lo que Istio puede hacer y c√≥mo puede verlo r√°pidamente con sus propios ojos.</i> <br><br>  <b>Istio</b> es un proyecto de c√≥digo abierto desarrollado en colaboraci√≥n con equipos de Google, IBM y Lyft.  Resuelve las dificultades que surgen en aplicaciones basadas en microservicios, por ejemplo, tales como: <a name="habracut"></a><br><br><ul><li>  <b>Gesti√≥n del tr√°fico</b> : tiempos de espera, reintentos, equilibrio de carga; </li><li>  <b>Seguridad</b> : autenticaci√≥n y autorizaci√≥n del usuario final; </li><li>  <b>Observabilidad</b> : rastreo, monitoreo, registro. </li></ul><br>  Todos ellos pueden resolverse a nivel de aplicaci√≥n, pero despu√©s de eso, sus servicios dejar√°n de ser "micro".  Todos los esfuerzos adicionales para resolver estos problemas son un desperdicio adicional de recursos de la compa√±√≠a que podr√≠an usarse directamente para los valores comerciales.  Considere un ejemplo: <br><blockquote> Gerente de proyecto: ¬øCu√°nto tiempo para agregar comentarios? <br>  Desarrollador: Dos sprints. <br><br>  MP: ¬øQu√©? ¬°Es CRUDO! <br>  R: Hacer CRUD es una parte simple de la tarea, pero a√∫n necesitamos autenticar y autorizar usuarios y servicios.  Dado que la red no es confiable, deber√° implementar solicitudes repetidas, as√≠ como el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">patr√≥n de disyuntor</a> en los clientes.  A√∫n as√≠, para asegurarse de que todo el sistema no se caiga, necesitar√° tiempos de espera y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">mamparos</a> <i>(para obtener m√°s detalles sobre los dos patrones mencionados, consulte m√°s adelante en el art√≠culo - Transl. Aprox.)</i> , Y para detectar problemas, monitoreo, rastreo, [...] <br><br>  MP: Oh, entonces simplemente insertemos esta funci√≥n en el servicio del Producto. </blockquote>  Creo que la idea es clara: el volumen de pasos y esfuerzos necesarios para agregar un servicio es enorme.  En este art√≠culo, veremos c√≥mo Istio elimina todas las dificultades mencionadas anteriormente (que no est√°n dirigidas a la l√≥gica empresarial) de los servicios. <br><br><img src="https://habrastorage.org/webt/l4/js/7o/l4js7omne2rslxitn0zr_lgusee.png"><br><br>  <b>Nota</b> : Este art√≠culo asume que tienes conocimiento pr√°ctico de Kubernetes.  De lo contrario, recomiendo leer <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">mi introducci√≥n a Kubernetes</a> y solo despu√©s de eso contin√∫e leyendo este material. <br><br><h2>  Idea Istio </h2><br>  En un mundo sin Istio, un servicio realiza solicitudes directas a otro, y en caso de falla, el servicio debe procesarlo por s√≠ mismo: hacer un nuevo intento, proporcionar un tiempo de espera, abrir un interruptor de circuito, etc. <br><br><img src="https://habrastorage.org/webt/ov/uv/g5/ovuvg5sepxqvj7wduhnl3uiixyi.png"><br>  <i>Tr√°fico de red en Kubernetes</i> <br><br>  Istio tambi√©n ofrece una soluci√≥n especializada, completamente separada de los servicios y el funcionamiento al interferir con la interacci√≥n de la red.  Y as√≠ implementa: <br><br><ul><li>  <b>Tolerancia a fallas</b> : seg√∫n el c√≥digo de estado en la respuesta, comprende si la solicitud ha fallado y la ejecuta nuevamente. </li><li>  <b>Lanzamientos de Canarias</b> : redirige a la nueva versi√≥n del servicio solo un porcentaje fijo del n√∫mero de solicitudes. </li><li>  <b>Monitoreo y m√©tricas</b> : ¬øcu√°nto tiempo respondi√≥ el servicio? </li><li>  <b>Seguimiento y observabilidad</b> : agrega encabezados especiales a cada solicitud y los rastrea en el cl√∫ster. </li><li>  <b>Seguridad</b> : extrae el token JWT, autentica y autoriza a los usuarios. </li></ul><br>  Estas son solo algunas de las posibilidades (¬°realmente solo unas pocas!) Para intrigarlo.  ¬°Ahora profundicemos en los detalles t√©cnicos! <br><br><h2>  Arquitectura Istio </h2><br>  Istio intercepta todo el tr√°fico de red y le aplica un conjunto de reglas, insertando un proxy inteligente en cada pod en forma de contenedor de sidecar.  Los proxies que activan todas las funciones forman un <b>plano de datos</b> y pueden configurarse din√°micamente usando el <b>plano de control</b> . <br><br><h2>  Plano de datos </h2><br>  Los proxies insertados en los pods le permiten a Istio cumplir f√°cilmente los requisitos que necesitamos.  Por ejemplo, verifique las funciones de reintento y disyuntor. <br><br><img src="https://habrastorage.org/webt/8t/7x/xn/8t7xxntkiuakkk5sbn41b4rualg.gif"><br>  <i>C√≥mo se implementan los reintentos y la interrupci√≥n de circuito en Envoy</i> <br><br>  Para resumir: <br><br><ol><li>  Enviado <i>(hablando de un proxy en un contenedor de sidecar que se distribuye como un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">producto separado</a> , aprox. Transl.)</i> Env√≠a una solicitud a la primera instancia del servicio B y se produce un error. </li><li>  Enviado <i>Reintentos de</i> sidecar.  <i>(1)</i> </li><li>  La solicitud fallida se devuelve al proxy que la llam√≥. </li><li>  Esto abre el disyuntor y llama al siguiente servicio para solicitudes posteriores.  <i>(2)</i> </li></ol><br>  Esto significa que no tiene que usar la pr√≥xima biblioteca Retry, no tiene que hacer su propia implementaci√≥n de Circuit Breaking and Service Discovery en el lenguaje de programaci√≥n X, Y o Z. Todo esto y mucho m√°s est√° disponible de forma inmediata en Istio y no requiere <b>ning√∫n</b> cambio en el c√≥digo. <br><br>  Genial  Ahora es posible que desee hacer un viaje con Istio, pero todav√≠a hay algunas dudas, preguntas abiertas.  Si esta es una soluci√≥n universal para todos los casos en la vida, entonces tiene una sospecha leg√≠tima: despu√©s de todo, todas esas decisiones en realidad resultan inadecuadas para cualquier caso. <br><br>  Y finalmente, preguntas: "¬øEs personalizable?" <br><br>  Ahora est√° listo para un viaje por mar, y conozcamos el plano de control. <br><br><h2>  Plano de control </h2><br>  Consta de tres componentes: <b>Piloto</b> , <b>Mezclador</b> y <b>Ciudadela</b> , que trabajan juntos para configurar Enviados para enrutar el tr√°fico, aplicar pol√≠ticas y recopilar datos de telemetr√≠a.  Esquem√°ticamente, todo se ve as√≠: <br><br><img src="https://habrastorage.org/webt/dw/p6/hh/dwp6hh6y5g41oinfxccixuutkyo.png"><br>  <i>Control de la interacci√≥n del plano con el plano de datos</i> <br><br>  Los enviados (es decir, el plano de datos) se configuran utilizando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Kubernetes CRD</a> (Definiciones de recursos personalizados) definidos por Istio y dise√±ados espec√≠ficamente para este prop√≥sito.  Para usted, esto significa que parecen ser el pr√≥ximo recurso en Kubernetes con sintaxis familiar.  Despu√©s de la creaci√≥n, este recurso ser√° recogido por el plano de control y aplicado a los Enviados. <br><br><h2>  Relaci√≥n de servicio para Istio </h2><br>  Describimos la actitud de Istio hacia los servicios, pero no lo contrario: ¬øc√≥mo se relacionan los servicios con Istio? <br><br>  Honestamente, Istio sabe acerca de la presencia de servicios y peces, sobre el agua, cuando se preguntan: "¬øQu√© es el agua en general?". <br><br><img src="https://habrastorage.org/webt/re/oi/ff/reoiffespub6tknffwssilkgu7c.jpeg"><br>  <i>Ilustraci√≥n de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Victoria Dimitrakopoulos</a> : - ¬øQu√© le parece el agua?</i>  <i>- ¬øQu√© es el agua en general?</i> <br><br>  Por lo tanto, puede tomar el cl√∫ster de trabajo y despu√©s de la implementaci√≥n de los componentes de Istio, los servicios ubicados en √©l continuar√°n funcionando, y despu√©s de la eliminaci√≥n de estos componentes, todo estar√° bien nuevamente.  Est√° claro que al hacerlo, perder√° las oportunidades que brinda Istio. <br><br>  Suficiente teor√≠a: ¬°pongamos este conocimiento en pr√°ctica! <br><br><h2>  Istio en la pr√°ctica </h2><br>  Istio requiere un cl√∫ster de Kubernetes en el que est√©n disponibles al menos 4 vCPU y 8 GB de RAM.  Para elevar r√°pidamente el cl√∫ster y seguir las instrucciones del art√≠culo, recomiendo usar Google Cloud Platform, que ofrece a los nuevos usuarios <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">$ 300 gratis</a> . <br><br>  Despu√©s de crear un cl√∫ster y configurar el acceso a Kubernetes a trav√©s de la utilidad de la consola, puede instalar Istio a trav√©s del administrador de paquetes Helm. <br><br><h2>  Instalaci√≥n de tim√≥n </h2><br>  Instale el cliente Helm en su computadora, como dicen en la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">documentaci√≥n oficial</a> .  Lo usaremos para generar plantillas para instalar Istio en la siguiente secci√≥n. <br><br><h2>  Instalar Istio </h2><br>  Descargue los recursos de Istio de la <a href="">√∫ltima versi√≥n</a> <i>(el enlace del autor original a la versi√≥n 1.0.5 se cambia al actual, es decir, 1.0.6 - aprox. Transl.)</i> , Extraiga el contenido en un directorio, que llamar√© en el futuro <code>[istio-resources]</code> . <br><br>  Para facilitar la identificaci√≥n de los recursos de Istio, cree el espacio de nombres del <code>istio-system</code> istio en el cl√∫ster K8s: <br><br><pre> <code class="bash hljs">$ kubectl create namespace istio-system</code> </pre> <br>  Complete la instalaci√≥n yendo al <code>[istio-resources]</code> y ejecutando el comando: <br><br><pre> <code class="bash hljs">$ helm template install/kubernetes/helm/istio \ --<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> global.mtls.enabled=<span class="hljs-literal"><span class="hljs-literal">false</span></span> \ --<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> tracing.enabled=<span class="hljs-literal"><span class="hljs-literal">true</span></span> \ --<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> kiali.enabled=<span class="hljs-literal"><span class="hljs-literal">true</span></span> \ --<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> grafana.enabled=<span class="hljs-literal"><span class="hljs-literal">true</span></span> \ --namespace istio-system &gt; istio.yaml</code> </pre> <br>  Este comando mostrar√° los componentes clave de Istio en el archivo <code>istio.yaml</code> .  Cambiamos la plantilla est√°ndar para nosotros, especificando los siguientes par√°metros: <br><br><ul><li>  <code>global.mtls.enabled</code> establece en <code>false</code> <i>(es decir, la autenticaci√≥n mTLS est√° deshabilitada, aprox. transl.)</i> para simplificar nuestro proceso de citas; </li><li>  <code>tracing.enabled</code> habilita el rastreo de consultas usando Jaeger; </li><li>  <code>kiali.enabled</code> instala Kiali en un cl√∫ster para visualizar servicios y tr√°fico; </li><li>  <code>grafana.enabled</code> configura Grafana para visualizar las m√©tricas recopiladas. </li></ul><br>  Aplicamos los recursos generados con el comando: <br><br><pre> <code class="bash hljs">$ kubectl apply -f istio.yaml</code> </pre> <br>  ¬°La instalaci√≥n de Istio en el cl√∫ster ha finalizado!  Espere hasta que todos los pods en el <code>istio-system</code> nombres del <code>istio-system</code> est√©n en <code>Running</code> o <code>Completed</code> ejecutando el siguiente comando: <br><br><pre> <code class="bash hljs">$ kubectl get pods -n istio-system</code> </pre> <br>  Ahora estamos listos para continuar en la siguiente secci√≥n, donde abordaremos y lanzaremos la aplicaci√≥n. <br><br><h2>  Arquitectura de aplicaciones de an√°lisis de sentimientos </h2><br>  Tomemos un ejemplo de la aplicaci√≥n de microservicio Sentiment Analysis utilizada en el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">art√≠culo de introducci√≥n</a> ya mencionado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">en Kubernetes</a> .  Es lo suficientemente sofisticado como para mostrar las capacidades de Istio en la pr√°ctica. <br><br>  La aplicaci√≥n consta de cuatro microservicios: <br><br><ol><li>  Servicio <b>SA-Frontend</b> , que sirve aplicaciones front-end en Reactjs; </li><li>  Un servicio <b>SA-WebApp</b> que atiende solicitudes de an√°lisis de opini√≥n; </li><li>  Servicio <b>SA-Logic</b> , que realiza <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">an√°lisis sentimentales</a> ; </li><li>  Servicio <b>SA-Feedback</b> , que recibe comentarios de los usuarios sobre la precisi√≥n del an√°lisis. </li></ol><br><img src="https://habrastorage.org/webt/hi/jv/oc/hijvoc4y7ercttsbopo4jzbo4w4.png"><br><br>  En este diagrama, adem√°s de los servicios, tambi√©n vemos el controlador de ingreso, que en Kubernetes enruta las solicitudes entrantes a los servicios correspondientes.  Istio utiliza un concepto similar dentro de Ingress Gateway, cuyos detalles seguir√°n a continuaci√≥n. <br><br><h2>  Lanzar una aplicaci√≥n con un proxy desde Istio </h2><br>  Para las operaciones adicionales mencionadas en el art√≠culo, clone el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">repositorio de istio-dominio</a> .  Contiene la aplicaci√≥n y los manifiestos para Kubernetes e Istio. <br><br><h3>  Insertar sidecar </h3><br>  La inserci√≥n se puede hacer de forma <b>autom√°tica</b> o <b>manual</b> .  Para insertar autom√°ticamente contenedores de sidecar, debe establecer la <code>istio-injection=enabled</code> en el <code>istio-injection=enabled</code> , que se realiza mediante el siguiente comando: <br><br><pre> <code class="bash hljs">$ kubectl label namespace default istio-injection=enabled namespace/default labeled</code> </pre> <br>  Ahora cada pod que se desplegar√° en el espacio de nombres predeterminado recibir√° su contenedor de sidecar.  Para verificar esto, <code>[istio-mastery]</code> una aplicaci√≥n de prueba yendo al directorio ra√≠z del <code>[istio-mastery]</code> y ejecutando el siguiente comando: <br><br><pre> <code class="bash hljs">$ kubectl apply -f resource-manifests/kube persistentvolumeclaim/sqlite-pvc created deployment.extensions/sa-feedback created service/sa-feedback created deployment.extensions/sa-frontend created service/sa-frontend created deployment.extensions/sa-logic created service/sa-logic created deployment.extensions/sa-web-app created service/sa-web-app created</code> </pre> <br>  Despu√©s de expandir los servicios, verificaremos que los pods tengan dos contenedores (con el servicio en s√≠ y su sidecar), ejecutando el <code>kubectl get pods</code> y asegur√°ndonos de que el valor <code>2/2</code> indique en la columna <code>READY</code> , lo que simboliza que ambos contenedores se est√°n ejecutando: <br><br><pre> <code class="bash hljs">$ kubectl get pods NAME READY STATUS RESTARTS AGE sa-feedback-55f5dc4d9c-c9wfv 2/2 Running 0 12m sa-frontend-558f8986-hhkj9 2/2 Running 0 12m sa-logic-568498cb4d-2sjwj 2/2 Running 0 12m sa-logic-568498cb4d-p4f8c 2/2 Running 0 12m sa-web-app-599cf47c7c-s7cvd 2/2 Running 0 12m</code> </pre> <br>  Visualmente se ve as√≠: <br><br><img src="https://habrastorage.org/webt/x9/kt/lu/x9ktluxxjopen7rn9tchuyvvioi.png"><br>  <i>Enviado proxy en una de las vainas</i> <br><br>  Ahora que la aplicaci√≥n est√° en funcionamiento, debemos permitir que el tr√°fico entrante ingrese a la aplicaci√≥n. <br><br><h2>  Puerta de entrada </h2><br>  La mejor pr√°ctica para lograr esto (para permitir el tr√°fico en el cl√∫ster) es a trav√©s de <b>Ingress Gateway</b> en Istio, que se encuentra en el "borde" del cl√∫ster y le permite habilitar las funciones de Istio como enrutamiento, equilibrio de carga, seguridad y monitoreo del tr√°fico entrante. <br><br>  El componente Ingress Gateway y el servicio que lo reenv√≠a al exterior se instalaron en el cl√∫ster durante la instalaci√≥n de Istio.  Para averiguar la direcci√≥n IP externa de un servicio, haga lo siguiente: <br><br><pre> <code class="bash hljs">$ kubectl get svc -n istio-system -l istio=ingressgateway NAME TYPE CLUSTER-IP EXTERNAL-IP istio-ingressgateway LoadBalancer 10.0.132.127 13.93.30.120</code> </pre> <br>  Continuaremos accediendo a la aplicaci√≥n a trav√©s de esta IP (me referir√© a ella como IP EXTERNA), por lo que, por conveniencia, escribiremos el valor en una variable: <br><br><pre> <code class="bash hljs">$ EXTERNAL_IP=$(kubectl get svc -n istio-system \ -l app=istio-ingressgateway \ -o jsonpath=<span class="hljs-string"><span class="hljs-string">'{.items[0].status.loadBalancer.ingress[0].ip}'</span></span>)</code> </pre> <br>  Si intenta acceder a esta IP a trav√©s de un navegador ahora, recibir√° un error de Servicio no disponible, porque  <b>Por defecto, Istio bloquea todo el tr√°fico entrante</b> hasta que se define una puerta de enlace. <br><br><h2>  Recurso de puerta de enlace </h2><br>  Gateway es un CRD (Definici√≥n de recursos personalizados) en Kubernetes, definido despu√©s de instalar Istio en un cl√∫ster y activar la capacidad de especificar los puertos, protocolos y hosts para los que queremos permitir el tr√°fico entrante. <br><br>  En nuestro caso, queremos permitir el tr√°fico HTTP al puerto 80 para todos los hosts.  La tarea se implementa mediante la siguiente definici√≥n <i>( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://gist.github.com/rinormaloku/577d0e23590f7a8dfbe56fe2a1f853d7&amp;usg=ALkJrhjFiLHU-6sGk6oKVKGyVxoPYTFsDw#file-">http-gateway.yaml</a> )</i> : <br><br><pre> <code class="plaintext hljs">apiVersion: networking.istio.io/v1alpha3 kind: Gateway metadata: name: http-gateway spec: selector: istio: ingressgateway servers: - port: number: 80 name: http protocol: HTTP hosts: - "*"</code> </pre> <br>  Esta configuraci√≥n no necesita explicaci√≥n, excepto el <code>istio: ingressgateway</code> .  Con este selector, podemos indicar a qu√© Ingress Gateway se aplica la configuraci√≥n.  En nuestro caso, este es el controlador Ingress Gateway, que se instal√≥ por defecto en Istio. <br><br>  La configuraci√≥n se aplica llamando al siguiente comando: <br><br><pre> <code class="bash hljs">$ kubectl apply -f resource-manifests/istio/http-gateway.yaml gateway.networking.istio.io/http-gateway created</code> </pre> <br>  Ahora la puerta de enlace permite el acceso al puerto 80, pero no tiene idea de d√≥nde enrutar las solicitudes.  Esto requerir√° <b>servicios virtuales</b> . <br><br><h2>  Recurso VirtualService </h2><br>  VirtualService le dice a Ingress Gateway c√≥mo enrutar las solicitudes que est√°n permitidas dentro del cl√∫ster. <br><br>  Las solicitudes a nuestra aplicaci√≥n que se env√≠an a trav√©s de http-gateway deben enviarse a los servicios sa-frontend, sa-web-app y sa-feedback: <br><br><img src="https://habrastorage.org/webt/zi/il/7_/ziil7_-9gfy5ejkhkzzn1wpxkxe.png"><br>  <i>Rutas para configurar con VirtualServices</i> <br><br>  Considere las solicitudes que deben enviarse a SA-Frontend: <br><br><ul><li>  Se debe enviar una coincidencia exacta en <code>/</code> path a SA-Frontend para obtener index.html; </li><li>  Las rutas con el prefijo <code>/static/*</code> deben enviarse a SA-Frontend para recibir archivos est√°ticos utilizados en la interfaz, como CSS y JavaScript; </li><li>  Las rutas que coinciden con la expresi√≥n regular <code>'^.*\.(ico|png|jpg)$'</code> deben enviarse a SA-Frontend, como  Estas son las im√°genes que se muestran en la p√°gina. </li></ul><br>  La implementaci√≥n se logra mediante la siguiente configuraci√≥n <i>( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">sa-virtualservice-external.yaml</a> ):</i> <br><br><pre> <code class="plaintext hljs">kind: VirtualService metadata: name: sa-external-services spec: hosts: - "*" gateways: - http-gateway # 1 http: - match: - uri: exact: / - uri: exact: /callback - uri: prefix: /static - uri: regex: '^.*\.(ico|png|jpg)$' route: - destination: host: sa-frontend # 2 port: number: 80</code> </pre> <br>  Puntos importantes: <br><br><ol><li>  Este servicio virtual se refiere a las solicitudes que llegan a trav√©s de <b>http-gateway</b> ; </li><li>  <code>destination</code> define el servicio donde se env√≠an las solicitudes. </li></ol><br>  <b>Nota</b> : La configuraci√≥n anterior se almacena en el archivo <code>sa-virtualservice-external.yaml</code> , que tambi√©n contiene la configuraci√≥n para el enrutamiento en SA-WebApp y SA-Feedback, pero se acort√≥ aqu√≠ en el art√≠culo para mayor brevedad. <br><br>  Aplique VirtualService llamando a: <br><br><pre> <code class="bash hljs">$ kubectl apply -f resource-manifests/istio/sa-virtualservice-external.yaml virtualservice.networking.istio.io/sa-external-services created</code> </pre> <br>  <b>Nota</b> : Cuando usamos los recursos de Istio, el Servidor API de Kubernetes genera un evento que recibe el Plano de control de Istio, y despu√©s de eso, la nueva configuraci√≥n se aplica a los proxies Envoy de cada pod.  Y el controlador de Ingress Gateway parece ser el pr√≥ximo Envoy configurado en Control Plane.  Todo esto en el diagrama se ve as√≠: <br><br><img src="https://habrastorage.org/webt/dz/nz/4b/dznz4bh_wpzcv7tx8jkykkiad9q.png"><br>  <i>Configuraci√≥n de Istio-IngressGateway para enrutamiento de consultas</i> <br><br>  El An√°lisis de sentimientos se ha hecho disponible en <code>http://{EXTERNAL-IP}/</code> .  No se preocupe si obtiene el estado No encontrado: a <i>veces la configuraci√≥n tarda un poco m√°s y la cach√© de Envoy se actualiza</i> . <br><br>  Antes de continuar, trabaje un poco con la aplicaci√≥n para generar tr√°fico <i>(su presencia es necesaria para mayor claridad en los pr√≥ximos pasos: aprox. Transl.)</i> . <br><br><h2>  Kiali: Observabilidad </h2><br>  Para acceder a la interfaz administrativa de Kiali, ejecute el siguiente comando: <br><br><pre> <code class="bash hljs">$ kubectl port-forward \ $(kubectl get pod -n istio-system -l app=kiali \ -o jsonpath=<span class="hljs-string"><span class="hljs-string">'{.items[0].metadata.name}'</span></span>) \ -n istio-system 20001</code> </pre> <br>  ... y abra <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">http: // localhost: 20001 /</a> , iniciando sesi√≥n como admin / admin.  Aqu√≠ encontrar√° muchas funciones √∫tiles, por ejemplo, para verificar la configuraci√≥n de los componentes de Istio, visualizar servicios basados ‚Äã‚Äãen la informaci√≥n recopilada al interceptar solicitudes de red y recibir respuestas a las preguntas "¬øQui√©n se comunica con qui√©n?", "¬øQu√© versi√≥n del servicio tiene fallas?"  etc.  En general, explore las posibilidades de Kiali antes de pasar a visualizar m√©tricas con Grafana. <br><br><img src="https://habrastorage.org/webt/ix/pd/wr/ixpdwrppiekv0dbk3xcbceasft8.png"><br><br><h2>  Grafana: visualizaci√≥n de m√©tricas </h2><br>  Las m√©tricas recopiladas en Istio entran en Prometheus y se visualizan con Grafana.  Para ingresar a la interfaz de administraci√≥n de Grafana, ejecute el siguiente comando, luego abra <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">http: // localhost: 3000 /</a> : <br><br><pre> <code class="bash hljs">$ kubectl -n istio-system port-forward \ $(kubectl -n istio-system get pod -l app=grafana \ -o jsonpath={.items[0].metadata.name}) 3000</code> </pre> <br>  Al hacer clic en el men√∫ <b>Inicio</b> en la esquina superior izquierda y seleccionar <b>Istio Service Dashboard</b> en la esquina superior izquierda, comience con el servicio <b>sa-web-app</b> para ver las m√©tricas recopiladas: <br><br><img src="https://habrastorage.org/webt/wb/vz/4t/wbvz4tkgi3qgoitxhhwhppk9pu8.png"><br><br>  Aqu√≠ estamos esperando un rendimiento vac√≠o y completamente aburrido; la administraci√≥n nunca lo aprobar√°.  Creemos una peque√±a carga con el siguiente comando: <br><br><pre> <code class="bash hljs">$ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> \ curl -i http://<span class="hljs-variable"><span class="hljs-variable">$EXTERNAL_IP</span></span>/sentiment \ -H <span class="hljs-string"><span class="hljs-string">"Content-type: application/json"</span></span> \ -d <span class="hljs-string"><span class="hljs-string">'{"sentence": "I love yogobella"}'</span></span>; \ sleep .8; <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre> <br>  Ahora tenemos gr√°ficos mucho mejores y, adem√°s de ellos, maravillosas herramientas de Prometheus para monitorear y Grafana para visualizar m√©tricas, lo que nos permitir√° conocer el rendimiento, el estado de salud, las mejoras / degradaci√≥n de los servicios a lo largo del tiempo. <br><br>  Finalmente, veamos el rastro de solicitudes en los servicios. <br><br><h2>  Jaeger: rastro </h2><br>  Necesitaremos seguimiento, porque cuantos m√°s servicios tengamos, m√°s dif√≠cil ser√° llegar a la causa de la falla.  Veamos un caso simple de la imagen a continuaci√≥n: <br><br><img src="https://habrastorage.org/webt/dv/8w/iv/dv8wivmvfn20fvmaebzk8wl6h68.png"><br>  <i>Un ejemplo t√≠pico de una solicitud fallida aleatoria</i> <br><br>  La solicitud llega, cae, <i>¬øcu√°l es el motivo?</i>  <i>Primer servicio?</i>  <i>O el segundo?</i>  Hay excepciones en ambos: echemos un vistazo a los registros de cada uno.  ¬øCon qu√© frecuencia te encuentras haciendo esto?  Nuestro trabajo se parece m√°s a los detectives de software que a los desarrolladores ... <br><br>  Este es un problema generalizado en microservicios y se resuelve mediante sistemas de rastreo distribuidos en los que los servicios se pasan entre s√≠ un encabezado √∫nico, despu√©s de lo cual esta informaci√≥n se redirige al sistema de rastreo, donde se asigna a los datos de la solicitud.  Aqu√≠ hay una ilustraci√≥n: <br><br><img src="https://habrastorage.org/webt/an/_h/tz/an_htzqnc3b4xxhgkzdqi5my-ki.png"><br>  <i>TraceId se utiliza para identificar la solicitud.</i> <br><br>  Istio utiliza Jaeger Tracer, que implementa un marco de API OpenTracing independiente del proveedor.  Puede acceder a la interfaz de usuario de Jaeger con el siguiente comando: <br><br><pre> <code class="bash hljs">$ kubectl port-forward -n istio-system \ $(kubectl get pod -n istio-system -l app=jaeger \ -o jsonpath=<span class="hljs-string"><span class="hljs-string">'{.items[0].metadata.name}'</span></span>) 16686</code> </pre> <br>  Ahora vaya a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">http: // localhost: 16686 /</a> y seleccione el servicio <b>sa-web-app</b> .  Si el servicio no se muestra en el men√∫ desplegable, muestre / genere actividad en la p√°gina y actualice la interfaz.  Despu√©s de eso, haga clic en el bot√≥n <b>Buscar rastros</b> , que mostrar√° los √∫ltimos rastros, seleccione cualquiera, aparecer√° informaci√≥n detallada sobre todos los rastros: <br><br><img src="https://habrastorage.org/webt/r8/zx/1q/r8zx1qjxc2a316-4a803l4vmzv4.png"><br><br>  Este rastro muestra: <br><br><ol><li>  La solicitud llega a <b>istio-ingressgateway</b> (esta es la primera interacci√≥n con uno de los servicios, y se genera la identificaci√≥n de seguimiento para la solicitud), despu√©s de lo cual la puerta de enlace env√≠a la solicitud al servicio <b>sa-web-app</b> . </li><li>  En el servicio <b>sa-web-app, la</b> solicitud es recogida por el sidecar de Envoy, se crea un "hijo" en el lapso (por lo tanto, lo vemos en las trazas) y se redirige al contenedor de la <b>aplicaci√≥n sa-web</b> .  <i>( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Span</a> es una unidad l√≥gica de trabajo en Jaeger que tiene un nombre, la hora en que comenz√≥ la operaci√≥n y su duraci√≥n. Los tramos pueden anidarse y ordenarse. Un gr√°fico ac√≠clico dirigido desde tramos forma una traza. - Transl. Aprox.)</i> </li><li>  Aqu√≠, la solicitud se procesa mediante el m√©todo <b>sentimentAnalysis</b> .  La aplicaci√≥n ya genera estos rastros, es decir  requirieron cambios al c√≥digo. </li><li>  A partir de este momento, <b>se</b> inicia una solicitud POST a <b>sa-logic</b> .  La identificaci√≥n de seguimiento debe reenviarse desde <b>sa-web-app</b> . </li><li>  ... </li></ol><br>  <b>Nota</b> : En el paso 4, la aplicaci√≥n deber√≠a ver los encabezados generados por Istio y pasarlos a solicitudes posteriores, como se muestra en la imagen a continuaci√≥n: <br><br><img src="https://habrastorage.org/webt/qg/a9/ai/qga9aibwkynfogbcxfo2cnwqxfm.png"><br>  <i>(A) Istio es responsable de reenviar los encabezados;</i>  <i><b>(B) Los servicios son responsables de los encabezados.</b></i> <br><br>  Istio hace la mayor parte del trabajo, como  genera encabezados para las solicitudes entrantes, crea nuevos tramos en cada atenci√≥n lateral y los reenv√≠a.  Sin embargo, sin trabajar con los encabezados dentro de los servicios, se perder√° la ruta de seguimiento completa de la solicitud. <br><br>  Se deben considerar (reenviar) los siguientes encabezados: <br><br><pre> <code class="plaintext hljs">x-request-id x-b3-traceid x-b3-spanid x-b3-parentspanid x-b3-sampled x-b3-flags x-ot-span-context</code> </pre> <br>  Sin embargo, esta es una tarea simple, para simplificar su implementaci√≥n, ya existen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">muchas bibliotecas</a> ; por ejemplo, en el servicio sa-web-app, el cliente RestTemplate reenv√≠a estos encabezados si simplemente agrega las bibliotecas Jaeger y OpenTracing dependiendo de <a href="">ello</a> . <br><br>  <i>Tenga en cuenta que la aplicaci√≥n Sentiment Analysis muestra implementaciones en Flask, Spring y ASP.NET Core.</i> <br><br>  Ahora que ha quedado claro lo que estamos sacando de la caja (o casi "fuera de la caja"), consideraremos cuestiones de enrutamiento finamente ajustado, gesti√≥n del tr√°fico de red, seguridad, etc. <br><br>  <i><b>Nota</b></i>  <i><b>perev.</b></i>  <i>: Lea sobre esto en la pr√≥xima entrega de Istio de Rinor Maloku, que estar√° disponible en nuestro blog en un futuro pr√≥ximo.</i>  <i><b>ACTUALIZACI√ìN</b> (14 de marzo): <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">la segunda parte</a> ya ha sido publicada.</i> <br><br><h2>  PD del traductor </h2><br>  Lea tambi√©n en nuestro blog: <br><br><ul><li>  "Volver a microservicios con Istio": <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">parte 2 (enrutamiento, control de tr√°fico)</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">parte 3 (autenticaci√≥n y autorizaci√≥n)</a> ; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Conducto: una malla de servicio ligera para Kubernetes</a> "; </li><li>  ‚Äú <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">¬øQu√© es una malla de servicio y por qu√© la necesito [para una aplicaci√≥n en la nube con microservicios]?</a>  "; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Una gu√≠a ilustrada para la creaci√≥n de redes en Kubernetes".</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Partes 1 y 2</a> "; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">¬øC√≥mo lleg√≥ este contenedor de sidecar aqu√≠ [en Kubernetes]?"</a>  ". </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/438426/">https://habr.com/ru/post/438426/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../438412/index.html">An√°lisis de 112654 tareas de prueba y tendencias en el mercado laboral de programadores en 2019</a></li>
<li><a href="../438414/index.html">Civilizaci√≥n de primavera, 3/5</a></li>
<li><a href="../438416/index.html">Sobre las hormonas</a></li>
<li><a href="../438420/index.html">IA en 2019: el estado actual de las cosas</a></li>
<li><a href="../438422/index.html">Un programa de lesiones electivas (segunda parte): Longride en primeros auxilios y reanimaci√≥n</a></li>
<li><a href="../438428/index.html">Las agencias gubernamentales encontraron una manera de sabotear el software dom√©stico</a></li>
<li><a href="../438430/index.html">Estoy atascado! O c√≥mo superar el efecto de meseta en el aprendizaje del ingl√©s</a></li>
<li><a href="../438434/index.html">Hacker Lab: P1. Bypass de autenticaci√≥n Libssh</a></li>
<li><a href="../438436/index.html">La idea de c√≥mo proporcionar a los empleados acceso temporal a los recursos del cliente sin volver a usar contrase√±as.</a></li>
<li><a href="../438438/index.html">Alimento para loros Bitrix. Probamos el rendimiento, seleccionamos hierro</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>