<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèª‚ÄçüöÄ ‚úä ‚ö±Ô∏è Retour aux microservices avec Istio. 3e partie üöâ üóø üòÜ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Remarque perev. : La premi√®re partie de cette s√©rie a √©t√© consacr√©e √† la pr√©sentation des capacit√©s d'Istio et √† leur d√©monstration en action, la seco...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Retour aux microservices avec Istio. 3e partie</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/443668/"><img src="https://habrastorage.org/webt/bj/j4/oy/bjj4oyjxqshrbjf5eks9sgsvbeg.png"><br><br>  <i><b>Remarque</b></i>  <i><b>perev.</b></i>  <i>: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">La premi√®re partie de</a> cette s√©rie a √©t√© consacr√©e √† la pr√©sentation des capacit√©s d'Istio et √† leur d√©monstration en action, la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">seconde</a> √† un routage finement r√©gl√© et √† une gestion du trafic r√©seau.</i>  <i>Nous allons maintenant parler de s√©curit√©: pour d√©montrer les fonctions de base qui lui sont associ√©es, l'auteur utilise le service d'identit√© Auth0, mais d'autres fournisseurs peuvent √™tre configur√©s par analogie avec lui.</i> <br><br>  Nous avons mis en place un cluster Kubernetes dans lequel Istio et l'application de microservice d'analyse des sentiments ont √©t√© d√©ploy√©s, ce qui a √©t√© la d√©monstration d'Istio. <br><br>  En utilisant Istio, nous avons pu garder les services de petite taille, car ils n'ont pas besoin d'impl√©menter des ¬´couches¬ª telles que les tentatives, retouts, d√©lais d'attente, disjoncteurs, tra√ßage, surveillance .  De plus, nous avons utilis√© des techniques avanc√©es de test et de d√©ploiement: tests A / B, mise en miroir et d√©ploiements canaries. <a name="habracut"></a><br><br><img src="https://habrastorage.org/webt/bs/x7/sc/bsx7sci6cfghlpg8_crfjyutiuk.png"><br><br>  Dans le nouveau mat√©riel, nous traiterons des derni√®res couches sur le chemin de la valeur commerciale: l'authentification et l'autorisation - et √† Istio, c'est un vrai plaisir! <br><br><h2>  Authentification et autorisation √† Istio </h2><br>  Je n'aurais jamais cru que je serais inspir√© par l'authentification et l'autorisation.  Quelle technologie peut offrir Istio pour rendre ces sujets passionnants et encore plus pour vous inspirer? <br><br>  La r√©ponse est simple: Istio transf√®re la responsabilit√© de ces fonctionnalit√©s de vos services aux mandataires Envoy.  Au moment o√π les demandes parviennent aux services, elles sont d√©j√† authentifi√©es et autoris√©es, il vous suffit donc d'√©crire du code utile pour les entreprises. <br><br>  Sonne bien?  Regardons √† l'int√©rieur! <br><br><h2>  Authentification avec Auth0 </h2><br>  Nous utiliserons Auth0 comme serveur pour la gestion des identit√©s et des acc√®s, qui a une version d'essai, qui est intuitive √† utiliser et j'aime √ßa.  Cependant, les m√™mes principes peuvent √™tre appliqu√©s √† toute autre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">impl√©mentation</a> d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">OpenID Connect</a> : KeyCloak, IdentityServer et bien d'autres. <br><br>  Tout d'abord, acc√©dez au <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">portail Auth0</a> avec votre compte, cr√©ez un locataire <i>(locataire - ¬´locataire¬ª, unit√© d'isolation logique, pour plus de d√©tails, consultez la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation</a> - environ la traduction).</i> Allez dans <i>Applications&gt; Application par d√©faut</i> , en choisissant <i>Domaine</i> , comme indiqu√© dans la capture d'√©cran ci-dessous. : <br><br><img src="https://habrastorage.org/webt/1z/x1/ir/1zx1irb-9tqksk6gd8eb0feubdm.png"><br><br>  Sp√©cifiez ce domaine dans le <code>resource-manifests/istio/security/auth-policy.yaml</code> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">source</a> ): <br><br><pre> <code class="plaintext hljs">apiVersion: authentication.istio.io/v1alpha1 kind: Policy metadata: name: auth-policy spec: targets: - name: sa-web-app - name: sa-feedback origins: - jwt: issuer: "https://{YOUR_DOMAIN}/" jwksUri: "https://{YOUR_DOMAIN}/.well-known/jwks.json" principalBinding: USE_ORIGIN</code> </pre> <br>  Ayant une telle ressource, Pilot <i>(l'un des trois composants de base de Control Plane dans Istio - environ. Transl.)</i> Configure les Envoy√©s pour authentifier les demandes avant de les rediriger vers les services: <b><code>sa-web-app</code></b> et <b><code>sa-feedback</code></b> .  Dans le m√™me temps, la configuration ne s'applique pas aux Envoys du <b><code>sa-frontend</code></b> , ce qui nous permet de laisser le frontend non authentifi√©.  Pour appliquer une strat√©gie, ex√©cutez la commande: <br><br><pre> <code class="bash hljs">$ kubectl apply -f resource-manifests/istio/security/auth-policy.yaml policy.authentication.istio.io ‚Äúauth-policy‚Äù created</code> </pre> <br>  Revenez √† la page et faites une demande - vous verrez qu'elle se termine par <i>401</i> Statut <i>non autoris√©</i> .  Nous redirigeons maintenant les utilisateurs frontaux vers l'authentification avec Auth0. <br><br><h2>  Demander une authentification avec Auth0 </h2><br>  Pour authentifier les demandes des utilisateurs finaux, vous devez cr√©er une API dans Auth0 qui repr√©sentera les services authentifi√©s (avis, d√©tails et √©valuations).  Pour cr√©er une API, acc√©dez √† <i>Auth0 Portal&gt; APIs&gt; Create API</i> et remplissez le formulaire: <br><br><img src="https://habrastorage.org/webt/96/_g/b5/96_gb5wcteuxtvt-yakzlsu4a4g.png"><br><br>  Les informations importantes ici sont l' <i>identifiant</i> , que nous utiliserons plus tard dans le script.  √âcrivons-le pour nous comme ceci: <br><br><ul><li>  <b>Audience</b> : {YOUR_AUDIENCE} </li></ul><br>  Les autres d√©tails dont nous avons besoin se trouvent sur le portail Auth0 dans la section <i>Applications</i> - s√©lectionnez <i>Test Application</i> (il est cr√©√© automatiquement avec l'API). <br><br>  Ici, nous √©crivons: <br><br><ul><li>  <b>Domaine</b> : {YOUR_DOMAIN} </li><li>  Identifiant <b>client</b> : {YOUR_CLIENT_ID} </li></ul><br>  Faites d√©filer l' <i>application de test</i> jusqu'√† la zone de texte URL de rappel autoris√©es (URL autoris√©es pour le rappel), dans laquelle nous indiquons l'URL o√π l'appel doit √™tre envoy√© une fois l'authentification termin√©e.  Dans notre cas, c'est: <br><br><pre> <code class="plaintext hljs">http://{EXTERNAL_IP}/callback</code> </pre> <br>  Et pour les <i>URL de d√©connexion autoris√©es</i> ( <i>URL</i> autoris√©es pour la d√©connexion), ajoutez: <br><br><pre> <code class="plaintext hljs">http://{EXTERNAL_IP}/logout</code> </pre> <br>  Passons au frontend. <br><br><h2>  Mise √† jour frontend </h2><br>  Basculez vers la branche <code>auth0</code> du <code>auth0</code> <code>[istio-mastery]</code> .  Dans ce thread, le code frontal est modifi√© pour rediriger les utilisateurs vers Auth0 pour l'authentification et utiliser le jeton JWT dans les demandes d'autres services.  Ce dernier est impl√©ment√© comme suit ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">App.js</a> ): <br><br><pre> <code class="javascript hljs">analyzeSentence() { fetch(<span class="hljs-string"><span class="hljs-string">'/sentiment'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">method</span></span>: <span class="hljs-string"><span class="hljs-string">'POST'</span></span>, <span class="hljs-attr"><span class="hljs-attr">headers</span></span>: { <span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>: <span class="hljs-string"><span class="hljs-string">'application/json'</span></span>, <span class="hljs-string"><span class="hljs-string">'Authorization'</span></span>: <span class="hljs-string"><span class="hljs-string">`Bearer </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${auth.getAccessToken()}</span></span></span><span class="hljs-string">`</span></span> <span class="hljs-comment"><span class="hljs-comment">// Access Token }, body: JSON.stringify({ sentence: this.textField.getValue() }) }) .then(response =&gt; response.json()) .then(data =&gt; this.setState(data)); }</span></span></code> </pre> <br>  Pour convertir le frontend en utilisant les donn√©es du locataire dans Auth0, ouvrez <code>sa-frontend/src/services/Auth.js</code> et remplacez-y les valeurs que nous avons √©crites ci-dessus ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Auth.js</a> ): <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Config = { <span class="hljs-attr"><span class="hljs-attr">clientID</span></span>: <span class="hljs-string"><span class="hljs-string">'{YOUR_CLIENT_ID}'</span></span>, <span class="hljs-attr"><span class="hljs-attr">domain</span></span>:<span class="hljs-string"><span class="hljs-string">'{YOUR_DOMAIN}'</span></span>, <span class="hljs-attr"><span class="hljs-attr">audience</span></span>: <span class="hljs-string"><span class="hljs-string">'{YOUR_AUDIENCE}'</span></span>, <span class="hljs-attr"><span class="hljs-attr">ingressIP</span></span>: <span class="hljs-string"><span class="hljs-string">'{EXTERNAL_IP}'</span></span> <span class="hljs-comment"><span class="hljs-comment">//      }</span></span></code> </pre> <br>  L'application est pr√™te.  Indiquez votre ID Docker dans les commandes ci-dessous lors de la cr√©ation et du d√©ploiement des modifications apport√©es: <br><br><pre> <code class="bash hljs">$ docker build -f sa-frontend/Dockerfile \ -t <span class="hljs-variable"><span class="hljs-variable">$DOCKER_USER_ID</span></span>/sentiment-analysis-frontend:istio-auth0 \ sa-frontend $ docker push <span class="hljs-variable"><span class="hljs-variable">$DOCKER_USER_ID</span></span>/sentiment-analysis-frontend:istio-auth0 $ kubectl <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> image deployment/sa-frontend \ sa-frontend=<span class="hljs-variable"><span class="hljs-variable">$DOCKER_USER_ID</span></span>/sentiment-analysis-frontend:istio-auth0</code> </pre> <br>  Essayez l'application!  Vous serez redirig√© vers Auth0, o√π vous devrez vous connecter (ou vous inscrire), apr√®s quoi vous serez renvoy√© √† la page √† partir de laquelle les demandes d√©j√† authentifi√©es seront effectu√©es.  Si vous essayez les commandes curl mentionn√©es dans les premi√®res parties de l'article, vous recevrez un <i>code d'√©tat 401</i> , qui indique que la demande n'est pas autoris√©e. <br><br>  Passons √† l'√©tape suivante - autoriser les demandes. <br><br><h2>  Autorisation avec Auth0 </h2><br>  L'authentification nous permet de comprendre qui est l'utilisateur, mais pour savoir √† quoi il a acc√®s, une autorisation est requise.  Istio propose √©galement des outils pour cela. <br><br>  √Ä titre d'exemple, nous allons cr√©er deux groupes d'utilisateurs (voir le sch√©ma ci-dessous): <br><br><ul><li>  <b>Utilisateurs</b> <i>(utilisateurs)</i> - avec acc√®s uniquement aux services SA-WebApp et SA-Frontend; </li><li>  <b>Mod√©rateurs</b> - avec acc√®s aux trois services. </li></ul><br><img src="https://habrastorage.org/webt/01/i-/dc/01i-dccinr9i1aq81atcf_qze90.png"><br>  <i>Concept d'autorisation</i> <br><br>  Pour cr√©er ces groupes, nous utiliserons l'extension Auth0 Authorization et utiliserons Istio pour leur fournir diff√©rents niveaux d'acc√®s. <br><br><h2>  Installation et configuration de l'autorisation Auth0 </h2><br>  Sur le portail Auth0, acc√©dez √† <i>Extensions</i> et installez <i>Auth0 Authorization</i> .  Apr√®s l'installation, acc√©dez √† l' <i>extension d'autorisation</i> , puis √† la configuration du locataire en cliquant en haut √† droite et en s√©lectionnant l'option de menu appropri√©e <i>(Configuration)</i> .  Activez <i>Groupes</i> et cliquez sur le bouton <i>R√®gle de publication</i> . <br><br><img src="https://habrastorage.org/webt/qo/tz/5n/qotz5nt8hpt0jcoyjav3rhkrn9g.png"><br><br><h2>  Cr√©ation de groupe </h2><br>  Dans l'extension d'autorisation, acc√©dez √† <i>Groupes</i> et cr√©ez un groupe de <i>mod√©rateurs</i> .  √âtant donn√© que nous consid√©rerons tous les utilisateurs authentifi√©s comme ordinaires, il n'est pas n√©cessaire de cr√©er un groupe suppl√©mentaire pour eux. <br><br>  S√©lectionnez le groupe <i>Mod√©rateurs</i> , cliquez sur <i>Ajouter des membres</i> , ajoutez votre compte principal.  Laissez certains utilisateurs sans groupe pour vous assurer que l'acc√®s leur est refus√©.  (Les nouveaux utilisateurs peuvent √™tre cr√©√©s manuellement via le <i>portail Auth0&gt; Utilisateurs&gt; Cr√©er un utilisateur</i> .) <br><br><h2>  Ajouter une revendication de groupe pour acc√©der au jeton </h2><br>  Les utilisateurs sont ajout√©s aux groupes, mais ces informations doivent se refl√©ter dans les jetons d'acc√®s.  Afin de se conformer √† OpenID Connect et de renvoyer en m√™me temps les groupes dont nous avons besoin, le jeton devra ajouter sa <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">revendication personnalis√©e</a> .  Il est impl√©ment√© selon les r√®gles d'Auth0. <br><br>  Pour cr√©er une r√®gle, acc√©dez au portail Auth0 aux <i>r√®gles</i> , cliquez sur <i>Cr√©er une r√®gle</i> et s√©lectionnez une r√®gle vide dans les mod√®les. <br><br><img src="https://habrastorage.org/webt/k0/v6/di/k0v6diyfaeiftxaknnbfbnvfxq0.png"><br><br>  Copiez le code ci-dessous et enregistrez-le en tant que nouvelle r√®gle d' <i>ajout de revendication de groupe</i> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">namespacedGroup.js</a> ): <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">user, context, callback</span></span></span><span class="hljs-function">) </span></span>{ context.accessToken[<span class="hljs-string"><span class="hljs-string">'https://sa.io/group'</span></span>] = user.groups[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> callback(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, user, context); }</code> </pre> <br>  <b>Remarque</b> : ce code prend le premier groupe d'utilisateurs d√©fini dans l'extension d'autorisation et l'ajoute au jeton d'acc√®s en tant que revendication personnalis√©e (sous son espace de noms, comme requis par Auth0). <br><br>  Revenez √† la page <i>R√®gles</i> et v√©rifiez que vous disposez de deux r√®gles √©crites dans l'ordre suivant: <br><br><ul><li>  auth0-autorisation-extension </li><li>  Ajouter une revendication de groupe </li></ul><br>  L'ordre est important car le champ de groupe re√ßoit de mani√®re asynchrone la <i>r√®gle d'auth0-autorisation-extension</i> et est ensuite ajout√© en tant que revendication par la deuxi√®me r√®gle.  Le r√©sultat est un tel jeton d'acc√®s: <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"https://sa.io/group"</span></span>: <span class="hljs-string"><span class="hljs-string">"Moderators"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"iss"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://sentiment-analysis.eu.auth0.com/"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"sub"</span></span>: <span class="hljs-string"><span class="hljs-string">"google-oauth2|196405271625531691872"</span></span> // [  ] }</code> </pre> <br>  Vous devez maintenant configurer le proxy Envoy pour v√©rifier l'acc√®s utilisateur, pour lequel le groupe sera extrait de la revendication ( <code>https://sa.io/group</code> ) dans le jeton d'acc√®s renvoy√©.  C'est le sujet de la section suivante de l'article. <br><br><h2>  Configuration des autorisations Istio </h2><br>  Pour l'autorisation de travailler, vous devez activer RBAC pour Istio.  Pour ce faire, utilisez la configuration suivante: <br><br><pre> <code class="plaintext hljs">apiVersion: "rbac.istio.io/v1alpha1" kind: RbacConfig metadata: name: default spec: mode: 'ON_WITH_INCLUSION' # 1 inclusion: services: # 2 - "sa-frontend.default.svc.cluster.local" - "sa-web-app.default.svc.cluster.local" - "sa-feedback.default.svc.cluster.local"</code> </pre> <br>  Explications: <br><ul><li>  1 - activer RBAC uniquement pour les services et les espaces de noms r√©pertori√©s dans le champ <code>Inclusion</code> ; </li><li>  2 - listez la liste de nos services. </li></ul><br><br>  Nous appliquons la configuration avec cette commande: <br><br><pre> <code class="bash hljs">$ kubectl apply -f resource-manifests/istio/security/<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-rbac.yaml rbacconfig.rbac.istio.io/default created</code> </pre> <br>  D√©sormais, tous les services n√©cessitent un contr√¥le d'acc√®s bas√© sur les r√¥les.  En d'autres termes, l'acc√®s √† tous les services est refus√© et entra√Ænera une r√©ponse <code>RBAC: access denied</code> .  Autorisez maintenant l'acc√®s aux utilisateurs autoris√©s. <br><br><h2>  Configuration d'acc√®s pour les utilisateurs r√©guliers </h2><br>  Tous les utilisateurs doivent avoir acc√®s aux services SA-Frontend et SA-WebApp.  Mis en ≈ìuvre √† l'aide des ressources Istio suivantes: <br><br><ul><li>  <b>ServiceRole</b> - d√©finit les droits de l'utilisateur; </li><li>  <b>ServiceRoleBinding</b> - D√©termine √† qui appartient ce ServiceRole. </li></ul><br>  Pour les utilisateurs ordinaires, autorisez l'acc√®s √† certains services ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">servicerole.yaml</a> ): <br><br><pre> <code class="plaintext hljs">apiVersion: "rbac.istio.io/v1alpha1" kind: ServiceRole metadata: name: regular-user namespace: default spec: rules: - services: - "sa-frontend.default.svc.cluster.local" - "sa-web-app.default.svc.cluster.local" paths: ["*"] methods: ["*"]</code> </pre> <br>  Et par le biais de la <code>regular-user-binding</code> appliquez un ServiceRole √† tous les visiteurs de la page ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">regular-user-service-role-binding.yaml</a> ): <br><br><pre> <code class="plaintext hljs">apiVersion: "rbac.istio.io/v1alpha1" kind: ServiceRoleBinding metadata: name: regular-user-binding namespace: default spec: subjects: - user: "*" roleRef: kind: ServiceRole name: "regular-user"</code> </pre> <br>  ¬´Tous les utilisateurs¬ª signifie-t-il que les utilisateurs non authentifi√©s auront acc√®s √† SA WebApp?  Non, la politique v√©rifiera la validit√© du jeton JWT. <br><br>  Appliquer la configuration: <br><br><pre> <code class="bash hljs">$ kubectl apply -f resource-manifests/istio/security/user-role.yaml servicerole.rbac.istio.io/regular-user created servicerolebinding.rbac.istio.io/regular-user-binding created</code> </pre> <br><h2>  Configuration d'acc√®s pour les mod√©rateurs </h2><br>  Pour les mod√©rateurs, nous voulons permettre l'acc√®s √† tous les services ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">mod-service-role.yaml</a> ): <br><br><pre> <code class="plaintext hljs">apiVersion: "rbac.istio.io/v1alpha1" kind: ServiceRole metadata: name: mod-user namespace: default spec: rules: - services: ["*"] paths: ["*"] methods: ["*"]</code> </pre> <br>  Mais nous voulons ces droits uniquement pour les utilisateurs dont le jeton d'acc√®s a une revendication <code>https://sa.io/group</code> avec la valeur <code>Moderators</code> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">mod-service-role-binding.yaml</a> ): <br><br><pre> <code class="plaintext hljs">apiVersion: "rbac.istio.io/v1alpha1" kind: ServiceRoleBinding metadata: name: mod-user-binding namespace: default spec: subjects: - properties: request.auth.claims[https://sa.io/group]: "Moderators" roleRef: kind: ServiceRole name: "mod-user"</code> </pre> <br>  Appliquer la configuration: <br><br><pre> <code class="bash hljs">$ kubectl apply -f resource-manifests/istio/security/mod-role.yaml servicerole.rbac.istio.io/mod-user created servicerolebinding.rbac.istio.io/mod-user-binding created</code> </pre> <br>  En raison de la mise en cache des envoy√©s, les r√®gles d'autorisation peuvent prendre quelques minutes pour prendre effet.  Apr√®s cela, vous pouvez vous assurer que les utilisateurs et les mod√©rateurs ont des niveaux d'acc√®s diff√©rents. <br><br><h2>  Conclusion sur cette partie </h2><br>  Eh bien, s√©rieusement: avez-vous d√©j√† vu une approche plus simple, sans effort, √©volutive et s√©curis√©e de l'authentification et de l'autorisation? <br><br>  Seules trois ressources Istio (RbacConfig, ServiceRole et ServiceRoleBinding) √©taient n√©cessaires pour obtenir un contr√¥le plus fin de l'authentification et de l'autorisation d'acc√®s des utilisateurs finaux aux services. <br><br>  De plus, nous avons pris soin de ces questions hors de nos services en tant qu'envoy√©, obtenant: <br><br><ul><li>  R√©duire la quantit√© d'exemples de code pouvant inclure des probl√®mes de s√©curit√© et des bogues; </li><li>  r√©duire le nombre de situations stupides dans lesquelles un point final s'est av√©r√© √™tre accessible de l'ext√©rieur et a oubli√© de le signaler; </li><li>  √©liminer la n√©cessit√© de mettre √† jour tous les services chaque fois qu'un nouveau r√¥le ou droit est ajout√©; </li><li>  que les nouveaux services restent simples, s√©curis√©s et rapides. </li></ul><br><h2>  Conclusion </h2><br>  Istio permet aux √©quipes de concentrer leurs ressources sur les t√¢ches critiques de l'entreprise sans ajouter de frais g√©n√©raux aux services, leur redonnant ainsi le statut micro. <br><br>  L'article (en trois parties) a fourni des connaissances de base et des instructions pratiques pr√™tes √† l'emploi pour commencer √† travailler avec Istio dans des projets r√©els. <br><br><h2>  PS du traducteur </h2><br>  Lisez aussi dans notre blog: <br><br><ul><li>  "Retour aux microservices avec Istio": <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">partie 1 (familiarit√© avec les principales fonctionnalit√©s)</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">partie 2 (routage, gestion du trafic)</a> ; </li><li>  ¬´ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Conduit - un maillage de service l√©ger pour Kubernetes</a> ¬ª; </li><li>  ¬´ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Qu'est-ce qu'un maillage de service et pourquoi en ai-je besoin [pour une application cloud avec microservices]?</a>  ". </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr443668/">https://habr.com/ru/post/fr443668/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr443658/index.html">Configuration du cluster Kubernetes HA sur du m√©tal nu, surveillance, journaux et exemples d'utilisation. Partie 3/3</a></li>
<li><a href="../fr443660/index.html">Experts: ¬´Un scanner 3D co√ªtera 10 fois moins cher qu'une erreur avec un contr√¥le qualit√© traditionnel¬ª</a></li>
<li><a href="../fr443662/index.html">Comprendre le code propre sur Android</a></li>
<li><a href="../fr443664/index.html">Station m√©t√©o Arduino</a></li>
<li><a href="../fr443666/index.html">Notre approche de la coloration des fils</a></li>
<li><a href="../fr443670/index.html">Erreur dans la nouvelle version de Google Chrome (73.0.3683.75)</a></li>
<li><a href="../fr443672/index.html">Tests bas√©s sur les risques</a></li>
<li><a href="../fr443676/index.html">Vinyle au lieu d'un timbre-poste: raret√© inhabituelle</a></li>
<li><a href="../fr443678/index.html">Lisibilit√© du code</a></li>
<li><a href="../fr443680/index.html">Semaine de travail de quatre jours. Exp√©rience russe</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>