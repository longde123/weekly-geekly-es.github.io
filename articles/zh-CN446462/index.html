<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏻‍🏫 🏇🏿 🔘 沉浸在驱动程序中：使用NeoQUEST-2019任务示例进行反向的一般原理 🕺 👩‍👧 🔋</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="像所有程序员一样，您喜欢代码。 你和他是最好的朋友。 但是，一生中迟早会有这样的时刻，那就是您没有代码。 是的，很难相信，但是你们之间会有巨大的鸿沟：你们在外面，而他在里面很深。 由于无望，您和所有人一样，将不得不走到另一边。 在逆向工程方面。 

 使用NeoQUEST-2019在线阶段任务2的示...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>沉浸在驱动程序中：使用NeoQUEST-2019任务示例进行反向的一般原理</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/neobit/blog/446462/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/ql/w3/1t/qlw31t-4mz--bhpo4qa81o_ptse.gif"></div><br> 像所有程序员一样，您喜欢代码。 你和他是最好的朋友。 但是，一生中迟早会有这样的时刻，那就是您没有代码。 是的，很难相信，但是你们之间会有巨大的鸿沟：你们在外面，而他在里面很深。 由于无望，您和所有人一样，将不得不走到另一边。 在逆向工程方面。 <br><br> 使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">NeoQUEST-2019</a>在线阶段任务2的示例<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">，</a>我们将分析反向驱动程序Windows的一般原理。 当然，该示例已相当简化，但是过程的本质并未因此改变-唯一的问题是需要查看的代码量。 有了经验和运气，让我们开始吧！ <a name="habracut"></a><br><h2> 给定 </h2><br> 根据传说，我们得到了两个文件：流量转储和生成相同流量的二进制文件。 首先，使用Wireshark查看转储： <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/xb/4k/gs/xb4kgshocgnwhickftcvukhjqtk.png"></div><br> 转储包含UDP数据包流，每个数据包包含6个字节的数据。 乍一看，这些数据是一些随机的字节集-无法从流量中获取任何信息。 因此，我们将注意力转向二进制，它将告诉您如何解密所有内容。 <br> 在IDA中打开它： <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/pp/v_/cq/ppv_cqotco3m7vjdjxdwyxmmqpc.png"></div><br> 看来我们正在面对某种驱动程序。 具有WSK前缀的功能是指Windows内核模式网络编程接口Winsock内核。 在MSDN上，您可以<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">看到</a> WSK中使用的结构和功能<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">的</a>描述。 <br><br> 为了方便起见，您可以将Windows Driver Kit 8（内核模式）-wdk8_km（或任何更新的）库加载到IDA中，以使用在那里定义的类型： <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/zf/8e/gu/zf8egusvoa5plmcn2uadxwtmapk.png"></div><br><h2> 注意，反向！ </h2><br> 与往常一样，从入口点开始： <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/z6/ry/e1/z6rye1bxurfesyaglba_f_4q9aq.png"></div><br> 让我们去吧。 首先，初始化Wsk，创建并绑定套接字-我们将不详细描述这些功能，它们不携带任何对我们有用的信息。 <br><br>  sub_140001608函数设置4个全局变量。 我们称它为InitVars。 在其中之一中，将值写入地址0xFFFFF78000000320。 稍微搜索一下该地址，我们可以假设它记录了系统启动后系统计时器的滴答数。 现在，让我们将变量命名为TickCount。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/e5/7_/2x/e57_2xuaa7zyx0fxfz7ebyc9kqu.png"></div><br> 然后，EntryPoint设置用于处理IRP数据包（I / O请求数据包）的功能。 您可以在MSDN上<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">阅读</a>有关它们的更多信息。 对于所有类型的请求，都定义了一个函数，该函数将数据包简单地传递到堆栈中的下一个驱动程序。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/b3/xj/sa/b3xjsa1qqtxxc-r7zydxxlzu48w.png"></div><br> 但是对于类型IRP_MJ_READ（3），定义了一个单独的函数； 我们称之为IrpRead。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/gi/a1/5y/gia15yhygs63v9qm5nooaxboay4.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/hu/yd/9w/huyd9wgps6ubfztj72vrfl3pxfm.png"></div><br> 依次安装了CompletionRoutine。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/2l/5o/wq/2l5owqwqa0pqcmy3zrbfnen1h28.png"></div><br>  CompletionRoutine使用从IRP接收的数据填充未知结构，并将其放在列表中。 到目前为止，我们还不知道包中的内容-我们稍后将返回此函数。 <br> 我们在EntryPoint中进一步看。 定义IRP处理程序后，将调用sub_1400012F8函数。 让我们看一下内部，立即注意到在其中创建了一个设备（IoCreateDevice）。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/xn/bv/hg/xnbvhgsku6con1ppuedpwuo2kw8.png"></div><br> 调用函数AddDevice。 如果类型正确，那么我们将看到设备名称为“ \\ Device \\ KeyboardClass0”。 因此，我们的驱动程序与键盘进行交互。 在键盘上下文中查询IRP_MJ_READ，您会<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">发现</a> KEYBOARD_INPUT_DATA结构是以数据包形式传输的。 让我们回到CompletionRoutine，看看它传递什么样的数据。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/y1/hi/rc/y1hirc1v347d7sqvedm0__ht01m.png"></div><br> 这里的IDA不能很好地解析该结构，但是通过偏移量和进一步的调用，您可以理解它由ListEntry，KeyData（密钥的扫描代码存储在此处）和KeyFlags组成。 <br> 在AddDevice之后，在EntryPoint中调用函数sub_140001274。 她创建了一个新的流。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/an/k2/bg/ank2bgcarpusbca9wgiydrkjmo0.png"></div><br> 让我们看看ThreadFunc中发生了什么。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/4b/ia/6f/4bia6fkojwowshkdfwfcj5e5xkq.png"></div><br> 她从列表中获取值并进行处理。 立即注意功能sub_140001A18。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/oa/tp/6z/oatp6zuhwpkm-3yvwoi51heuqzw.png"></div><br> 它将处理后的数据与指向WskSocket的指针以及数字0x89E0FEA928230002一起传递到sub_140001A68函数的输入。 通过字节分析参数编号（0x89 = 137、0xE0 = 224、0xFE = 243、0xA9 = 169、0x2328 = 9000），我们从流量转储中获得了完全相同的地址和端口：169.243.224.137：9000。 逻辑上假设此功能将网络数据包发送到指定的地址和端口-我们将不对其进行详细介绍。 <br> 让我们看看在发送之前如何处理数据。 <br><br> 对于前两个元素，将对生成的值进行等效处理。 由于滴答数是用于计算的，因此可以假定我们面临着伪随机数的产生。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/h1/vi/xa/h1vixaqacqmhbn6nr0p6nbw03py.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/2f/xg/xr/2fxgxrgvu-0be2wb5r2bbnszljy.png"></div><br> 生成数字后，它将覆盖我们之前称为TickCount的变量的值。 公式变量在InitVars中设置。 如果返回此函数的调用，我们将找出这些变量的值，结果将得到以下公式： <br><br>  <b><i>（54773 + 7141 * prev_value）％259200</i></b> <br><br> 这是线性一致<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">伪随机数生成器</a> 。 它是使用TickCount在InitVars中初始化的。 对于每个后续数字，前一个用作初始值（生成器返回一个双字节值，并且该值用于后续生成）。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/td/pd/2f/tdpd2fq9xc9kvskq-tf4ax87xms.png"></div><br> 在等效于从键盘传输的两个值的随机数之后，将调用一个函数，该函数形成消息的剩余两个字节。 它仅产生两个已加密参数和某个常数值的<i>异或</i> 。 这不太可能以某种方式解密数据，因此对我们而言，消息的最后两个字节没有携带任何有用的信息，因此无法考虑。 但是，如何处理加密数据？ <br> 让我们仔细看看到底是什么加密。  KeyData是一种扫描代码，可以采用相当宽范围的值；猜测并不容易。 但是<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">KeyFlags</a>是一个位字段： <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ww/rw/cp/wwrwcpfjwzk1ixnguh7jk-aafiw.png"></div><br> 如果查看扫描代码<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">表</a> ，您会发现大多数情况下标志是0（键按下）或1（键升起）。  KEY_E0很少被公开，但是可能会碰到，但是满足KEY_E1的机会很小。 因此，您可以尝试执行以下操作：我们检查转储中的数据，选择一个加密的KeyFlags值，使其等于0，生成两个连续的PSC。 首先，KeyData是一个字节，我们可以通过高字节检查生成的MSS的正确性。 其次，当使用正确的PSC执行等效操作时，下一个加密的KeyFlags将采用相同的位值。 如果发现这是错误的，则我们假设我们最初查看的KeyFlags为1，依此类推。 <br> 让我们尝试实现我们的算法。 我们将为此使用python： <br><br><div class="spoiler">  <b class="spoiler_title">算法实现</b> <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#  -   keymap = […] # ,   Wireshark traffic_dump = […] #  def bxnor(a, b): return ((~a &amp; 0xffff) | b) &amp; (a | (~b &amp; 0xffff)) #   def brgen(a): return ((7141 * a + 54773) % 259200) &amp; 0xffff def decode(): #     for i in range(0, len(traffic_dump) - 1): #   KeyFlags probe = traffic_dump[i][1] #   - scancode = traffic_dump[i+1][0] #    KeyFlags tester = traffic_dump[i+1][1] fail = True #     (  KEY_E1) for flag in range(4): rnd_flag = bxnor(flag, probe) rnd_sc = brgen(rnd_flag) next_flag = bxnor(tester, brgen(rnd_sc)) #   KeyFlags if next_flag in range(4): sc = bxnor(rnd_sc, scancode) if sc &lt; len(keymap): sym = keymap[sc] if next_flag % 2 == 0: print(sym, end='') fail = False break #   -      KeyFlags   if fail: print('Something went wrong on {} pair'.format(i)) return print() if __name__ == "__main__": decode()</span></span></code> </pre> <br></div></div><br> 对从转储接收的数据运行我们的脚本： <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ht/ct/lp/htctlp99gtxcxje2krcgsjkqnpu.png"></div><br> 在解密的流量中，我们找到了最理想的线路！ <br><br>  <i><b>NQ2019DABE17518674F97DBA393415E9727982FC52C202549E6C1740BC0933C694B3DE</b></i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/z9/3u/ma/z93umaswtxopnn-zbqi4qwbanfu.jpeg"></div><br> 不久将有分析剩余任务的文章，不要错过！ <br><br>  PS并且我们提醒您，每个在NeoQUEST-2019上至少完成一项任务的人都有权获得奖励！ 检查您的邮件是否有信件，如果没有收到，请写信至<b>support@neoquest.ru</b> ！ </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN446462/">https://habr.com/ru/post/zh-CN446462/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN446448/index.html">进行问题访谈以识别消费者需求的5条基本规则</a></li>
<li><a href="../zh-CN446452/index.html">月球飞行任务“ Bereshit”-2019年4月4日，完成向月球轨道的过渡，提前7天飞行，进行了6次机动和1次着陆</a></li>
<li><a href="../zh-CN446454/index.html">Golang Web服务器开发-从简单到复杂</a></li>
<li><a href="../zh-CN446458/index.html">基于Arduino Nano的通用DRO-shDRO。 第二部分</a></li>
<li><a href="../zh-CN446460/index.html">食品设计文摘2019年3月</a></li>
<li><a href="../zh-CN446464/index.html">15只鹦鹉：选择VPS / VDS服务器的托管服务提供商</a></li>
<li><a href="../zh-CN446466/index.html">商业内容营销：Habraseminar＃6及其要点</a></li>
<li><a href="../zh-CN446468/index.html">Go环境变量实用指南</a></li>
<li><a href="../zh-CN446470/index.html">全球首款3D螺旋桨发布</a></li>
<li><a href="../zh-CN446472/index.html">用于显示Lamptest.ru结果的全局更新</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>