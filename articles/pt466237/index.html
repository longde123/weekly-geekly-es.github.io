<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëåüèº üò® üë®üèæ‚Äçüç≥ Como o junior green escreveu seu hot-reloader ü§ñ ü¶í üòâ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Antecedentes 
 Algumas linhas sobre mim para uma compreens√£o geral do n√≠vel do autor e do problema que est√° sendo resolvido.  Meu nome √© Eugene e sou ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como o junior green escreveu seu hot-reloader</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/466237/"><h3>  Antecedentes </h3><br><div class="spoiler"> <b class="spoiler_title">Algumas linhas sobre mim para uma compreens√£o geral do n√≠vel do autor e do problema que est√° sendo resolvido.</b> <div class="spoiler_text">  Meu nome √© Eugene e sou <s>desenvolvedor web</s> frontend junior verde. <br>  H√° algum outro ano, trabalhei em um campo completamente diferente e, apenas em teoria, pensei em mudar de profiss√£o, mas por volta de dezembro de 2018 encontrei meu caminho e comecei a atuar. <br>  Ap√≥s cerca de seis meses de treinamento total, consegui um emprego como programador front-end.  Aprendi coisas fundamentais (eu acho que sim), js, intera√ß√£o com o DOM, reagir + redux.  HTML e CSS pelo menos + uma compreens√£o geral de bootstrap e assembly, trabalhando com git, a linha de comando. <br>  Al√©m da teoria, foram feitos alguns projetos de treinamento, incluindo um bate-papo sobre react + redux, al√©m de algumas tentativas de implementar algumas de suas id√©ias. <br>  Em geral, um cavalheiro moderno padr√£o √© o ponto de partida para uma frente iniciante. <br>  Na primeira semana e meia, montei uma m√°quina virtual, h√° muito de tudo e tudo √© desconhecido e incompreens√≠vel para mim. <br>  No processo, eu me familiarizo com novas ferramentas e tecnologias: com bancos de dados (e me coloco outro marcador na lista "aprender"), massa, wincsp, etc. <br>  Passe com sucesso nesta pista de obst√°culos e v√° para a frente. <br></div></div><br><h3>  Pref√°cio </h3><br>  Depois de escrever meu reloader e este artigo, encontrei an√°logos, incluindo os de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Habr√©</a> .  No entanto, ele decidiu publicar sua bicicleta. <br><br><h3>  Iniciar </h3><br>  Temos um projeto bastante grande, herdado, escrito em angularJS, com todos os seus encantos.  Depois do React, ele parecia um dinossauro para mim, mas nada, eu compro cursos de angularjs, rapidamente dirijo e come√ßo a me beneficiar. <br><br>  Uma impress√£o positiva √© que o projeto foi bem escrito, por pessoas com bra√ßos claramente retos.  Vari√°veis ‚Äã‚Äãcom excelente nomenclatura clara, a estrutura √© a mesma em todos os lugares e, em geral, toda a l√≥gica √© muito acess√≠vel e simplesmente expressa. <br><br>  Mas existem desvantagens suficientes. <br><a name="habracut"></a><br>  O primeiro problema: o projeto est√° sendo constru√≠do por algum minimizador antigo e √© imposs√≠vel usar a sintaxe js moderna.  Nenhum () =&gt; {}, const res = [... dados, subRes], ass√≠ncrono / aguardado ... <br><br>  O segundo problema: n√£o h√° webpack, nem mesmo pelo menos gole, e, portanto, tamb√©m n√£o h√° um servidor webpack-dev familiar para mim com sua excelente recarga a quente. <br><br>  Escreveu.  Salvo.  F5  Inconvenientemente.  Dor?  N√£o √© uma dor direta, mas muito desconfort√°vel. <br><br>  O terceiro problema: criar o arquivo .bat do projeto, no qual parte do projeto √© simplesmente copiada, parte das bibliotecas s√£o coletadas sem minimiza√ß√£o, parte √© minimizada em um arquivo e o restante dos arquivos do projeto em outro.  Lista de bibliotecas no terceiro arquivo.  Lista de arquivos a serem constru√≠dos no quarto.  E assim por diante <br><br>  O quarto problema: todas as bibliotecas est√£o ordenadamente na pasta libs e s√£o conectadas por um script em index.html.  Tudo, exceto expresso e proxy para ele (eles n√£o est√£o envolvidos na montagem, mas apenas para o desenvolvimento). <br>  E longe de qualquer lugar, existem vers√µes ou uma indica√ß√£o de uma biblioteca espec√≠fica. <br><br>  Eu vivi treinando em um belo mundo de programa√ß√£o funcional, cheio de es6 +, webpack-dev-server, tdd, eslint, compila√ß√£o autom√°tica e assim por diante. <br><br>  E aqui no mundo adulto, tudo √© completamente diferente ... <br><br><h3>  Gravata </h3><br>  Mas gosto de trabalhar, considero obst√°culos como oportunidades de autodesenvolvimento, a empresa √© boa, a atmosfera √© excelente, meus olhos est√£o pegando fogo! <br><br>  Nas horas de trabalho, realizo tarefas de trabalho, no meu tempo livre tento melhorar alguma coisa. <br><br>  Em meados de junho, come√ßo com uma tentativa de fixar o webpack, mas a primeira abordagem espera uma falha completa.  Estou atormentado h√° uma semana, estou muito cansado disso, temporariamente adiado. <br><br>  Eu decido come√ßar pequeno - conecto a nova sintaxe atrav√©s do babel.  Eu adiciono o processamento inicial de babel √† nossa build.bat m√°gica, mas algo quebra o id√≠lio e nosso velho minificador trope√ßa.  Estou procurando um problema. <br><br>  Trope√ßa em uma das bibliotecas das boas bibliotecas do papai.  Eu olho para os arquivos da biblioteca: eles j√° est√£o minificados na sintaxe antiga. <br><br>  Eu digo babel - "voc√™ n√£o vai aqui ... a cabe√ßa vai pegar o c√≥digo, vai ser muito ruim".  Verifico: tudo funciona!  Viva!  Agora eu tenho acesso a todas essas novas e elegantes coisas da juventude na moda!  Primeira vit√≥ria.  Nice  Acho que nesta ocasi√£o renomear o script em e.bat (e-Evgen), mas n√£o consigo decidir. <br><br>  A nova sintaxe √© t√£o familiar e agrad√°vel, mas o pensamento de uma constru√ß√£o torta n√£o me deixa. <br><br>  O final de junho e o in√≠cio de julho.  Estou fazendo a segunda abordagem, mais minuciosamente, mas, novamente, encontro erros entre o webpack e o angularjs.  Novamente uma semana de pesquisa. <br><br>  Depois de passar v√°rios dias e parcialmente noites √† procura de uma solu√ß√£o, deparo-me com discursos extremamente interessantes da confer√™ncia HolyJS, onde os caras j√° est√£o se aprofundando no webpack.  Estou avan√ßando em seu entendimento, mas ainda n√£o entendo o material at√© o fim. <br><br>  O interesse se fortalece. <br><br>  Um colega diz - esque√ßa, para entregar o projeto em alguns meses, n√£o √© mais necess√°rio fazer isso. <br>  Eu n√£o martelo, mas adiei - muito trabalho, isso me aperta tudo, n√£o resta tempo para atividades extracurriculares. <br><br>  Em meados de julho, chego em minhas m√£os semelhante ao nosso projeto com uma compila√ß√£o personalizada.  Vou com ele para a terceira abordagem e praticamente estou configurando o webpack conosco, mas no final estou pegando novos erros que n√£o tenho tempo para resolver, o trabalho rola com nova intensidade + me devasta mentalmente, deixo de lado esse neg√≥cio novamente. <br><br><h3>  Corpo principal </h3><br>  Meados de agosto.  Como resultado, um amigo fala sobre o aprendizado do node.js e seu desejo de escrever seu pr√≥prio hot-reloader.  Pensamentos sobre nossa assembl√©ia surgem com vigor renovado. <br><br>  Tarefa: recarregar a p√°gina atual ao atualizar arquivos no projeto. <br>  Recursos: todas as bibliotecas est√£o conectadas em index.html, voc√™ n√£o pode exigir, para n√£o mencionar a importa√ß√£o.  A montagem antes da recarga ainda n√£o √© necess√°ria, apenas recarregue.  Em um servidor de desenvolvimento que solicita proxies para nosso apoio, eu posso usar pacotes e tamb√©m posso exigir! <br><br>  Tudo isso acontece na sexta-feira e eu decido que, em uma vers√£o simplificada do nosso projeto, sou capaz de implementar uma tecnologia que salvar√° a mim e aos meus colegas da F5. <br><br>  O processo de pensamento continua e uma vis√£o da solu√ß√£o √© formada na cabe√ßa. <br>  O servidor mais simples (como o nosso), contornarei toda a pasta e subpastas e formar√° uma √°rvore com as datas de modifica√ß√£o de cada arquivo. <br><br>  Depois de cada milissegundo, ignorarei repetidamente e compararei os valores do tempo de mudan√ßa.  Alterado - recarregar.  Um amigo diz a voc√™: ‚Äún√£o reinvente a roda, h√° um rel√≥gio no node.js‚Äù.  √ìtimo, eu vou us√°-lo.  No server.js, configurarei o watch behind a pasta do projeto e chamarei location.reload () para alterar algo. <br><br>  Primeira itera√ß√£o: <br><br><div class="spoiler">  <b class="spoiler_title">server.js</b> <div class="spoiler_text"><pre><code class="plaintext hljs">var express = require('express'); var app = express(); var server = require('http').Server(app); const port = 9080; server.listen(port); app.use(express.static(__dirname + '/src')); location.reload().</code> </pre> <br></div></div><br>  O primeiro problema √© location- esta n√£o √© uma vari√°vel node.js. (neste momento entendo por que minhas tentativas de acessar process.env na frente tamb√©m n√£o tiveram √™xito))). <br><br>  O segundo problema √© como fazer a frente entender o que a recarga precisa fazer. <br><br>  Sa√≠da - websocket!  A ideia √© tentadora + eu trabalhei com eles ‚Äúmeio-cones‚Äù quando escrevi uma conversa, tenho uma ideia geral.  Ao mesmo tempo, fa√ßo um contador de reinicializa√ß√£o por sess√£o, adiciono uma vari√°vel e processo a solicita√ß√£o que a fornece. <br><br>  Eu tento: <br><br><div class="spoiler">  <b class="spoiler_title">server.js</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">var express = require('express'); //  express var app = express(); var server = require('http').Server(app); //  http  app var io = require('socket.io')(server); //  socket.io     var fs = require('fs'); const port = 9080; server.listen(port); app.use(express.static(__dirname + '/src')); let count = 0; app.get('/data', (req, res) =&gt; { res.data = count; res.send(`${count}`); }) const dir = './src'; fs.watch(dir, () =&gt; { io.emit('change', {data: count}); count += 1; })</code> </pre><br></div></div><br>  Na frente eu estou fazendo o aplicativo mais simples no angularjs <br><br><div class="spoiler">  <b class="spoiler_title">app.js</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">angular.module('App', []) .controller('myAppCtrl',['$scope', '$timeout','$http', ($scope, $timeout, $http) =&gt; { $scope.title = '       '; $scope.count = 0; $scope.todo = [ '  ,  ', '   node.js watch   ', '     ,         ', ' , codeclimate  travis   ' ] $scope.marks = [ 'watcher      ' ] // var socket = io(); // socket.on('change', (data) =&gt; { // console.log(data.data); // $scope.count = data.data; // console.log('scope.count: ', $scope.count); // $scope.$digest();// // location.reload();//agfr // }) $http({method: 'GET',url: 'data'}) .then(response =&gt; { $scope.count = response.data;// }); }])</code> </pre><br></div></div><br>  E um m√≥dulo separado que o recarrega.  Separe, para que o projeto n√£o fique muito. <br><br><div class="spoiler">  <b class="spoiler_title">watch.js</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">var socket = io(); socket.on('change', () =&gt; { location.reload(); })</code> </pre><br></div></div><br>  Isso funciona!  Ele tamb√©m monitora outros arquivos que n√£o js (voc√™ nunca sabe!): Verificado .json, .css. <br>  Eu verifico as subpastas - n√£o funciona. <br><br>  Acho que tudo bem, agora vou cortar recursivamente.  Apenas no caso, o Google e - voila - est√° pronto <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">a decis√£o.</a> <br><br>  Adicione este pacote. <br><br><div class="spoiler">  <b class="spoiler_title">server.js</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">var express = require('express'); //  express var app = express(); var server = require('http').Server(app); //  http  app var io = require('socket.io')(server); //  socket.io     var fs = require('fs'); var watch = require('node-watch'); const port = 9080; server.listen(port); app.use(express.static(__dirname + '/src')); let count = 0; let changed = []; app.get('/data', (req, res) =&gt; { res.data = count; res.send({count, changed}); }) const translate = { remove: "", update: "" } watch('./', { recursive: true }, function(evt, name) { io.emit('change', {data: count}); count += 1; changed = [{name, evt}, ...changed]; });</code> </pre><br></div></div><br>  Viva, funciona! <br><br>  Lembro-me de eslint, codeclimate e travis. <br>  Instale o primeiro, adicione o resto. <br>  Eu limpo o c√≥digo, tudo √© var na const e assim por diante. <br><br>  Linter jura que angular n√£o est√° definido, mas meus recursos de conex√£o de bibliotecas no projeto ditam esse comportamento, eu desativo.  Ao mesmo tempo, eu estrago um pouco as vari√°veis ‚Äã‚Äãda linha de comando, corro tudo funcionando! <br><br>  Ele veio trabalhar na segunda-feira e prendeu a fazenda inteira a um esbo√ßo de trabalho.  Eu tive que mudar um pouco, ao mesmo tempo, fazer altera√ß√µes para que fosse poss√≠vel alterar alguns par√¢metros de inicializa√ß√£o na linha de comando e exce√ß√µes, para n√£o ler tudo. <br><br>  Como resultado, ficou assim: <br><br><div class="spoiler">  <b class="spoiler_title">server.js</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">const express = require('express'), http = require('http'), watch = require('node-watch'), proxy = require('http-proxy-middleware'), app = express(), server = http.createServer(app), io = require('socket.io').listen(server), exeptions = ['git', 'js_babeled', 'node_modules', 'build', 'hotreload'], // ,   ,    backPortObj = { /*  ,   back*/ }, address = process.argv[2] || /*    back*/, localHostPort = process.argv[3] || 9080, backMachinePort = backPortObj[address] || /*   back */, isHotReload = process.argv[4] || "y", // "n" || "y" target = `http://192.168.${address}:${backMachinePort}`, str = `Connected to machine: ${target}, hot reload: ${isHotReload === 'y' ? 'enabled' : 'disabled'}.`, link = `http://localhost:${localHostPort}/`; server.listen(localHostPort); app .use('/bg-portal', proxy({ target, changeOrigin: true, ws: true })) .use(express.static('.')); if (isHotReload === 'y') { watch('./', { recursive: true }, (evt, name) =&gt; { let include = false; exeptions.forEach(item =&gt; { if (`${name}`.includes(item)) include = true; }) if (!include) { console.log(name); io.emit('change', { evt, name, exeptions }); }; }); }; console.log(str); console.log(link);</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">app.js</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">var socket = io.connect(); socket.on('change', ({ evt, name, exeptions }) =&gt; { location.reload(); });</code> </pre><br></div></div><br>  o script em execu√ß√£o no package.json apenas chama server.js no n√≥ e ele come√ßa assim: <br><br><pre> <code class="plaintext hljs">npm start 1.100 8080</code> </pre><br>  Escreveu.  Salvo.  <s>F5</s> <br><br>  Concluindo, quero agradecer a Vanya, minha amiga, em alguns lugares, o mentor e o kicker principal, bem como Sasha - o homem a quem considero meu mentor! <br><br><h3>  Em vez de um posf√°cio </h3><br>  Depois de duas semanas, no √∫ltimo dia do meu per√≠odo de teste, apertei o webpack e o webpack-dev-server em nosso projeto, enviando meu recarregador quente para o p√≥ na prateleira do hist√≥rico. <br><br>  No entanto, nessas duas semanas n√≥s o usamos todos os dias e ele fazia seu trabalho regularmente! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt466237/">https://habr.com/ru/post/pt466237/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt466223/index.html">Decomposi√ß√£o limpa</a></li>
<li><a href="../pt466227/index.html">Programa√ß√£o Orientada a N√≥s</a></li>
<li><a href="../pt466229/index.html">Como comprar dez caixas de algod√£o e n√£o cometer erros</a></li>
<li><a href="../pt466231/index.html">ShIoTiny e o mundo ao redor: conectando sensores a entradas bin√°rias, rejei√ß√£o de contato e outros problemas</a></li>
<li><a href="../pt466235/index.html">Munch em uma varredura equidistante e Meyerhold, que destruiu a Pra√ßa Vermelha - Denis Semenov sobre VR art</a></li>
<li><a href="../pt466247/index.html">Entrevista Introvertida</a></li>
<li><a href="../pt466249/index.html">Escrevendo uma cobra para Android em Kivy, Python</a></li>
<li><a href="../pt466251/index.html">Bombeando o projeto do Soft Launch para US $ 1 milh√£o em receita por m√™s</a></li>
<li><a href="../pt466253/index.html">Como reconstru√≠ os locais de desembarque do ALS Luna-9 e Luna-13</a></li>
<li><a href="../pt466257/index.html">Conquistando os mares: data warehouses flutuantes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>