<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôçüèæ üßòüèΩ üè≥Ô∏è Eu aprendi essas 6 li√ß√µes sobre como trabalhar com a forma√ß√£o de nuvens por toda a vida. üë©üèæ‚Äçü§ù‚Äçüë®üèº üñïüèª ü••</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Comecei a trabalhar com cloudformation h√° 4 anos. Desde ent√£o, quebrei muitas infraestruturas, mesmo aquelas que j√° estavam em produ√ß√£o. Mas toda vez ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Eu aprendi essas 6 li√ß√µes sobre como trabalhar com a forma√ß√£o de nuvens por toda a vida.</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/446918/">  Comecei a trabalhar com <i>cloudformation</i> h√° 4 anos.  Desde ent√£o, quebrei muitas infraestruturas, mesmo aquelas que j√° estavam em produ√ß√£o.  Mas toda vez que estragava algo, aprendia coisas novas.  Gra√ßas a essa experi√™ncia, compartilharei algumas das li√ß√µes mais importantes que aprendi. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f6e/613/762/f6e6137629025956cdcc0a1e810f5066.jpg" alt="imagem"><br><br><h4>  Li√ß√£o 1: Validar Altera√ß√µes Antes da Implementa√ß√£o </h4><br>  Aprendi esta li√ß√£o assim que comecei a trabalhar com a forma√ß√£o de <i>nuvens</i> .  N√£o lembro exatamente o que quebrei na √©poca, mas lembro exatamente que usei o <i>comando aws cloudformation update</i> .  Este comando simplesmente lan√ßa o modelo sem nenhuma verifica√ß√£o das altera√ß√µes que ser√£o implantadas.  N√£o acho que sejam necess√°rias explica√ß√µes, para as quais voc√™ precisa verificar todas as altera√ß√µes antes de implant√°-las. <br><br>  Ap√≥s essa falha, alterei imediatamente o <i>pipeline de implementa√ß√£o</i> , substituindo o comando update pelo comando <i>create-change-set</i> <br><br><pre><code class="plaintext hljs"># OPERATION is either "UPDATE" or "CREATE" changeset_id=$(aws cloudformation create-change-set \ --change-set-name "$CHANGE_SET_NAME" \ --stack-name "$STACK_NAME" \ --template-body "$TPL_PATH" \ --change-set-type "$OPERATION" \ --parameters "$PARAMETERS" \ --output text \ --query Id) aws cloudformation wait \ change-set-create-complete --change-set-name "$changeset_id"</code> </pre> <br>  Quando um conjunto de altera√ß√µes √© criado, ele n√£o afeta a pilha existente.  Ao contr√°rio do comando update, a abordagem do conjunto de altera√ß√µes n√£o √© implementada.  Em vez disso, ele cria uma lista de altera√ß√µes que voc√™ pode revisar antes da implanta√ß√£o.  Voc√™ pode visualizar as altera√ß√µes na interface do console do aws.  Mas se voc√™ preferir automatizar tudo o que √© poss√≠vel, verifique-os na CLI: <br><a name="habracut"></a><br><pre> <code class="plaintext hljs"># this command is presented only for demonstrational purposes. # the real command should take pagination into account aws cloudformation describe-change-set \ --change-set-name "$changeset_id" \ --query 'Changes[*].ResourceChange.{Action:Action,Resource:ResourceType,ResourceId:LogicalResourceId,ReplacementNeeded:Replacement}' \ --output table</code> </pre> <br>  Este comando deve produzir uma sa√≠da semelhante √† seguinte: <br><br><pre> <code class="plaintext hljs">-------------------------------------------------------------------- | DescribeChangeSet | +---------+--------------------+----------------------+------------+ | Action | ReplacementNeeded | Resource | ResourceId | +---------+--------------------+----------------------+------------+ | Modify | True | AWS::ECS::Cluster | MyCluster | | Replace| True | AWS::RDS::DBInstance| MyDB | | Add | None | AWS::SNS::Topic | MyTopic | +---------+--------------------+----------------------+------------+</code> </pre> <br>  Preste especial aten√ß√£o √†s altera√ß√µes em que A√ß√£o √© <i>Substituir</i> , <i>Excluir</i> ou <i>Substitui√ß√£o Necess√°ria √© Verdadeiro</i> .  Essas s√£o as mudan√ßas mais perigosas e geralmente levam √† perda de informa√ß√µes. <br><br>  Quando as altera√ß√µes s√£o exibidas, elas podem ser expandidas <br><br><pre> <code class="plaintext hljs">aws cloudformation execute-change-set --change-set-name "$changeset_id" operation_lowercase=$(echo "$OPERATION" | tr '[:upper:]' '[:lower:]') aws cloudformation wait "stack-${operation_lowercase}-complete" \ --stack-name "$STACK_NAME"</code> </pre> <br><h4>  Li√ß√£o 2: use a pol√≠tica de pilha para impedir a substitui√ß√£o ou remo√ß√£o de estado de recursos </h4><br>  √Äs vezes, simplesmente visualizar as altera√ß√µes n√£o √© suficiente.  Somos todos humanos e todos cometemos erros.  Logo ap√≥s come√ßarmos a usar conjuntos de altera√ß√µes, meu colega de equipe, sem saber, realizou uma implanta√ß√£o, o que levou a uma atualiza√ß√£o do banco de dados.  Nada de terr√≠vel aconteceu, porque era um ambiente de teste. <br><br>  Apesar de nossos scripts exibirem uma lista de altera√ß√µes e solicitarem confirma√ß√£o, a altera√ß√£o Substituir foi ignorada porque a lista de altera√ß√µes era t√£o grande que n√£o cabia na tela.  E como essa era uma atualiza√ß√£o regular no ambiente de teste, pouca aten√ß√£o foi dada √†s altera√ß√µes. <br><cut></cut><br>  Existem recursos que voc√™ nunca desejar√° substituir ou remover.  Esses s√£o servi√ßos completos do estado, como uma inst√¢ncia de um banco de dados RDS ou um cluster de pesquisa el√°stica, etc. Seria bom se o aws se recusasse a implantar automaticamente, se a opera√ß√£o executada exigiria a remo√ß√£o de um recurso.  Felizmente, a forma√ß√£o em nuvem tem uma maneira integrada de fazer isso.  Isso √© chamado de pol√≠tica de pilha e voc√™ pode ler mais sobre isso na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documenta√ß√£o</a> : <br><br><pre> <code class="plaintext hljs">STACK_NAME=$1 RESOURCE_ID=$2 POLICY_JSON=$(cat &lt;&lt;EOF { "Statement" : [{ "Effect" : "Deny", "Action" : [ "Update:Replace", "Update:Delete" ], "Principal": "*", "Resource" : "LogicalResourceId/$RESOURCE_ID" }] } EOF ) aws cloudformation set-stack-policy --stack-name "$STACK_NAME" \ --stack-policy-body "$POLICY_JSON"</code> </pre> <br><h4>  Li√ß√£o 3: use UsePreviousValue ao atualizar uma pilha com par√¢metros secretos </h4><br>  Quando voc√™ cria uma entidade RDS, o mysql AWS exige que voc√™ forne√ßa MasterUsername e MasterUserPassword.  Como √© melhor n√£o guardar segredos no c√≥digo-fonte e eu queria automatizar absolutamente tudo, implementei um ‚Äúmecanismo inteligente‚Äù no qual as credenciais s√£o obtidas do s3 antes da implanta√ß√£o e, se as credenciais n√£o forem encontradas, novas credenciais s√£o geradas e armazenadas no s3 . <br><br>  Essas credenciais ser√£o passadas como par√¢metros para o comando cloudformation create-change-set.  Durante os experimentos com o script, aconteceu que a conex√£o com o s3 foi perdida, e meu ‚Äúmecanismo inteligente‚Äù o considerou um sinal para gerar novas credenciais. <br><cut></cut><br>  Se eu come√ßar a usar esse script em um ambiente de produ√ß√£o, e o problema de conex√£o surgir novamente, ele atualizar√° a pilha com novas credenciais.  Nesse caso em particular, nada de ruim vai acontecer.  No entanto, abandonei essa abordagem e comecei a usar outra, fornecendo credenciais apenas uma vez - ao criar a pilha.  E mais tarde, quando a pilha requer atualiza√ß√£o, em vez de especificar o valor secreto do par√¢metro, eu simplesmente usaria <i>UsePreviousValue = true</i> : <br><br><pre> <code class="plaintext hljs">aws cloudformation create-change-set \ --change-set-name "$CHANGE_SET_NAME" \ --stack-name "$STACK_NAME" \ --template-body "$TPL_PATH" \ --change-set-type "UPDATE" \ --parameters "ParameterKey=MasterUserPassword,UsePreviousValue=true"</code> </pre> <br><h4>  Li√ß√£o 4: usar a configura√ß√£o de revers√£o </h4><br>  Outra equipe com a qual trabalhei estava usando uma fun√ß√£o de forma√ß√£o de <i>nuvem</i> chamada <i>configura√ß√£o de revers√£o</i> .  Eu n√£o a conheci antes e rapidamente percebi que isso tornaria a implanta√ß√£o de minhas pilhas ainda melhor.  Agora uso sempre que implanto meu c√≥digo no lambda ou no ECS usando cloudformation. <br><br>  Como funciona: voc√™ especifica o <i>alarme</i> do <i>CloudWatch no</i> par√¢metro <i>--rollback-configuration</i> ao criar o conjunto de altera√ß√µes.  Mais tarde, quando voc√™ concluir o conjunto de altera√ß√µes, o aws rastreia o alarme por pelo menos um minuto.  Ele reverte a implanta√ß√£o se, durante esse per√≠odo, o alarme mudar de estado para ALARM. <br><br>  A seguir, √© apresentado um exemplo de um trecho do modelo de informa√ß√£o na nuvem, no qual crio um <i>alarme de observa√ß√£o</i> na nuvem que rastreia a m√©trica da nuvem do usu√°rio como o n√∫mero de erros nos logs da nuvem (a m√©trica √© criada via <i>MetricFilter</i> ): <br><br><pre> <code class="plaintext hljs">Resources: # this metric tracks number of errors in the cloudwatch logs. In this # particular case it's assumed logs are in json format and the error logs are # identified by level "error". See FilterPattern ErrorMetricFilter: Type: AWS::Logs::MetricFilter Properties: LogGroupName: !Ref LogGroup FilterPattern: !Sub '{$.level = "error"}' MetricTransformations: - MetricNamespace: !Sub "${AWS::StackName}-log-errors" MetricName: Errors MetricValue: 1 DefaultValue: 0 ErrorAlarm: Type: AWS::CloudWatch::Alarm Properties: AlarmName: !Sub "${AWS::StackName}-errors" Namespace: !Sub "${AWS::StackName}-log-errors" MetricName: Errors Statistic: Maximum ComparisonOperator: GreaterThanThreshold Period: 1 # 1 minute EvaluationPeriods: 1 Threshold: 0 TreatMissingData: notBreaching ActionsEnabled: yes</code> </pre> <br>  Agora, o <i>alarme</i> pode ser usado como um acionador de <i>revers√£o</i> ao executar um conjunto de ferramentas: <br><br><pre> <code class="plaintext hljs">ALARM_ARN=$1 ROLLBACK_TRIGGER=$(cat &lt;&lt;EOF { "RollbackTriggers": [ { "Arn": "$ALARM_ARN", "Type": "AWS::CloudWatch::Alarm" } ], "MonitoringTimeInMinutes": 1 } EOF ) aws cloudformation create-change-set \ --change-set-name "$CHANGE_SET_NAME" \ --stack-name "$STACK_NAME" \ --template-body "$TPL_PATH" \ --change-set-type "UPDATE" \ --rollback-configuration "$ROLLBACK_TRIGGER"</code> </pre> <br><h4>  Li√ß√£o 5: certifique-se de implantar a vers√£o mais recente do modelo </h4><br>  N√£o √© f√°cil implantar a vers√£o mais recente do modelo de forma√ß√£o em nuvem, mas causar√° muitos danos.  Uma vez que estava conosco: o desenvolvedor n√£o enviou as altera√ß√µes mais recentes do Git e, sem saber, implantou a vers√£o anterior da pilha.  Isso levou a um aplicativo simples que usou essa pilha. <br><cut></cut><br>  Algo simples, como adicionar uma verifica√ß√£o para ver se uma ramifica√ß√£o √© relevante antes da implanta√ß√£o, seria bom (supondo que o git seja sua ferramenta de controle de vers√£o): <br><pre> <code class="plaintext hljs">git fetch HEADHASH=$(git rev-parse HEAD) UPSTREAMHASH=$(git rev-parse master@{upstream}) if [[ "$HEADHASH" != "$UPSTREAMHASH" ]] ; then echo "Branch is not up to date with origin. Aborting" exit 1 fi</code> </pre> <br><h4>  Li√ß√£o 6: n√£o reinvente a roda </h4><br>  A implanta√ß√£o com a forma√ß√£o de <i>nuvens</i> pode parecer f√°cil.  Voc√™ s√≥ precisa de v√°rios scripts bash que executam comandos aws cli. <br><br>  H√° 4 anos, comecei com scripts simples chamados de comando aws cloudformation create-stack.  Logo, o script n√£o era mais simples.  Cada li√ß√£o aprendida tornou o script cada vez mais complexo.  N√£o foi apenas dif√≠cil, mas tamb√©m com um monte de bugs. <br><br>  Agora eu trabalho em um pequeno departamento de TI.  A experi√™ncia mostrou que cada equipe tem sua pr√≥pria maneira de implantar pilhas de informa√ß√µes na nuvem.  E isso √© ruim.  Seria melhor se todos usassem uma √∫nica abordagem.  Felizmente, existem muitas ferramentas que ajudam a implantar e configurar pilhas de informa√ß√µes na nuvem. <br><br>  Essas li√ß√µes ajudar√£o a evitar erros. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt446918/">https://habr.com/ru/post/pt446918/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt446906/index.html">M√∫sica ambiente e seus efeitos na escrita de c√≥digo</a></li>
<li><a href="../pt446908/index.html">Recomenda√ß√µes de seguran√ßa da informa√ß√£o DLP e FSTEC: interse√ß√£o de paralelos</a></li>
<li><a href="../pt446912/index.html">Quanto custa a seguran√ßa de aplicativos da Web (usando o Barracuda WAF como servi√ßo como exemplo)</a></li>
<li><a href="../pt446914/index.html">Por que voc√™ ensina ir</a></li>
<li><a href="../pt446916/index.html">Vers√£o hier√°rquica do cat√°logo de endere√ßos atualizada por Zimbra Docs e outros novos no Zimbra 8.8.12</a></li>
<li><a href="../pt446920/index.html">Engenharia reversa do Google Fool de abril</a></li>
<li><a href="../pt446922/index.html">O gato debaixo do cap√¥. Parte 2</a></li>
<li><a href="../pt446924/index.html">Representa√ß√£o de polin√¥mios arbitr√°rios na forma de diferen√ßas finitas com uma etapa arbitr√°ria</a></li>
<li><a href="../pt446926/index.html">"Ent√£o percebi que agora sou engenheiro de encontros e de uma maneira diferente voc√™ pode se posicionar no mercado"</a></li>
<li><a href="../pt446932/index.html">TDMS Fairway e BIM</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>