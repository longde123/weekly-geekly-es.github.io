<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ôüÔ∏è ü§≤üèæ ü¶Ü RxJava2 + Retrofit 2. Kami memodifikasi adaptor untuk menangani kurangnya status Internet di Android üß§ üèÇüèΩ üöÄ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Cukup sering perlu untuk membuat permintaan berulang ke jaringan, misalnya, ketika pengguna tidak memiliki Internet dan ingin menerima data dari Inter...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>RxJava2 + Retrofit 2. Kami memodifikasi adaptor untuk menangani kurangnya status Internet di Android</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/442072/"><img src="https://habrastorage.org/webt/ar/yk/jn/arykjnjuk66yqsjeqdzbyikdjca.png"><br><br>  Cukup sering perlu untuk membuat permintaan berulang ke jaringan, misalnya, ketika pengguna tidak memiliki Internet dan ingin menerima data dari Internet.  Akan lebih baik untuk melemparkan kembali permintaan saat itu muncul.  Merupakan praktik yang baik untuk menunjukkan kepada pengguna UI tertentu yang akan menjelaskan kepadanya apa yang terjadi dan memungkinkan permintaan untuk dilemparkan lagi.  Menambahkan logika seperti itu bisa sangat menyakitkan, terutama ketika kita memiliki sejumlah besar kelas ViewModel.  Tentu saja, Anda dapat menerapkan logika kueri ulang di setiap kelas ViewModel, tetapi ini tidak nyaman dan ada kemungkinan besar kesalahan. <br><a name="habracut"></a><br>
<h3>  Apakah ada cara untuk melakukan pemrosesan ini hanya sekali? </h3><br>  Untungnya, RxJava2 dan Retrofit2 memungkinkan ini. <br><br>  Sudah ada beberapa solusi di Stackoverflow: <br><br>  1. Membuat CallAdapterFactory Anda sendiri (info lebih lanjut di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">sini</a> ) <br>  2. Ulangi rantai menggunakan PublishSubject (info lebih lanjut di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">sini</a> ) <br><br>  Solusi pertama menggunakan RxJava1, sudah usang dan juga hanya mengulangi rantai beberapa kali, tanpa bereaksi terhadap terjadinya peristiwa tersebut.  Solusi kedua baik, tetapi kita perlu menggunakan coba lagi ketika operator di setiap rantai.  Jadi, saya menggabungkan dua solusi menjadi satu. <br><br><h3>  Implementasi </h3><br>  Mari kita buat proyek sederhana.  Tempatkan dua tab di layar utama.  Masing-masing menampilkan teks yang akan menunjukkan berapa banyak elemen yang dimuat oleh API.  Jika kesalahan terjadi selama eksekusi, kami menampilkan SnackBar dengan tombol Coba Lagi. <br><br><img src="https://habrastorage.org/webt/vn/vu/b8/vnvub8wi1enqyeky8k9l45bgce4.gif"><br><br>  Kami mendefinisikan kelas-kelas dasar seperti BaseActivity, BaseFragment, BaseViewModel, mereka diperlukan untuk mengimplementasikan logika pengulangan permintaan di satu tempat dan menghindari duplikasi kode ini.  Buat dua fragmen yang akan memperpanjang BaseFragment.  Setiap fragmen yang ditempatkan memiliki ViewModel sendiri dan secara independen membuat permintaan ke API.  Saya membuat cuplikan ini untuk menunjukkan bahwa jika terjadi kesalahan, setiap permintaan akan diulang.  Selanjutnya, buat pabrik RxRetryCallAdapterFactory yang memperluas CallAdapter.Factory.  Setelah itu, buat instance dari RxJava2CallAdapterFactory.  Kami membutuhkan instance ini untuk mengakses RxJava2CallAdapter, karena kami tidak ingin menduplikasi kode yang sudah ada di pustaka Retrofit.  Selain itu, mari kita buat metode statis yang akan mengembalikan instance pabrik kami.  Contoh kode di bawah ini: <br><br><pre><code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RxRetryCallAdapterFactory</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CallAdapter.Factory</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">companion</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> : CallAdapter.Factory = RxRetryCallAdapterFactory() } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> originalFactory = RxJava2CallAdapterFactory.create() <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(returnType : </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Type</span></span></span></span><span class="hljs-function"><span class="hljs-params">, annotations : </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Array</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Annotation</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt;, retrofit : </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Retrofit</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> : CallAdapter&lt;*, *&gt;? { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> adapter = originalFactory.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(returnType, annotations, retrofit) ?: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RxRetryCallAdapter(adapter) } }</code> </pre> <br>  Selanjutnya, buat RxRetryCallAdapter yang mengimplementasikan antarmuka CallAdapter dan kita perlu meneruskan instance CallAdapter ke konstruktor.  Bahkan, itu harus menjadi turunan dari RxJava2CallAdapter, yang mengembalikan pabrik asli. <br><br>  Selanjutnya, kita perlu menerapkan hal-hal berikut: <br><br><ul><li>  retryWhen pernyataan yang digunakan untuk mengimplementasikan fungsionalitas pengulangan </li><li>  pernyataan doOnError () yang menangani kesalahan.  Ini digunakan untuk mengirim siaran yang diproses di BaseActivity dan menunjukkan SnackBar kepada pengguna. </li><li>  PublishSubject digunakan sebagai pemicu acara yang menandatangani ulang rantai. </li><li>  operator observOn (Schedulers.io ()) yang harus diterapkan ke PublishSubject (jika baris ini tidak ditambahkan, berlangganan akan terjadi di utas utama dan kami akan mendapatkan NetworkOnMainThreadException </li><li>  Kami mengubah PublishSubject menjadi Flowable dan mengatur BackpressureStrategy.LATEST, karena kami hanya membutuhkan kesalahan terakhir </li></ul><br>  Catatan: Untuk menyediakan PublishSubject, saya membuat kelas singleton sederhana yang menyediakan semua dependensi singleton dalam proyek.  Dalam proyek nyata, Anda cenderung menggunakan kerangka kerja injeksi ketergantungan seperti Dagger2 <br><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RxRetryCallAdapter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">R</span></span></span><span class="hljs-class">&gt;</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> originalAdapter : CallAdapter&lt;R, *&gt;) : CallAdapter&lt;R, Any&gt; { <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">adapt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(call : </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Call</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">R</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt;)</span></span></span></span> : Any { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> adaptedValue = originalAdapter.adapt(call) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> (adaptedValue) { <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> Completable -&gt; { adaptedValue.doOnError(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>::sendBroadcast) .retryWhen { AppProvider.provideRetrySubject().toFlowable(BackpressureStrategy.LATEST) .observeOn(Schedulers.io()) } } <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> Single&lt;*&gt; -&gt; { adaptedValue.doOnError(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>::sendBroadcast) .retryWhen { AppProvider.provideRetrySubject().toFlowable(BackpressureStrategy.LATEST) .observeOn(Schedulers.io()) } } <span class="hljs-comment"><span class="hljs-comment">//same for Maybe, Observable, Flowable else -&gt; { adaptedValue } } } override fun responseType() : Type = originalAdapter.responseType() private fun sendBroadcast(throwable : Throwable) { Timber.e(throwable) LocalBroadcastManager.getInstance(AppProvider.appInstance).sendBroadcast(Intent(BaseActivity.ERROR_ACTION)) } }</span></span></code> </pre> <br>  Ketika pengguna mengklik tombol Coba lagi, kami memanggil Subtitle PublishSubtext.  Setelah itu, kami berlangganan kembali ke rx chain. <br><br><h3>  Pengujian </h3><br>  Matikan Internet dan jalankan aplikasi.  Jumlah item yang dimuat adalah nol pada setiap tab dan SnackBar menampilkan kesalahan.  Nyalakan Internet dan klik Coba Adain.  Setelah beberapa detik, jumlah item yang dimuat berubah pada masing-masing tab. <br><br><img src="https://habrastorage.org/webt/a5/bj/0x/a5bj0xe7yqyij_lvqb4d7rnu0s4.gif"><br><br>  Jika ada yang membutuhkannya, maka kode sumbernya ada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">di sini</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id442072/">https://habr.com/ru/post/id442072/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id442058/index.html">Postgres yang Dapat Diperpanjang</a></li>
<li><a href="../id442062/index.html">Digitalisasi komunikasi: mengapa kita perlu emoji</a></li>
<li><a href="../id442064/index.html">Degradasi perangkat lunak</a></li>
<li><a href="../id442066/index.html">Beberapa cara untuk memalsukan PDF dengan tanda tangan digital</a></li>
<li><a href="../id442070/index.html">Perusahaan akhirnya khawatir tentang pengembangan perangkat IoT dan keamanannya</a></li>
<li><a href="../id442074/index.html">Air terjun penuh gaya dari RiME di mesin game: buat aliran air</a></li>
<li><a href="../id442078/index.html">Bekerja dengan API Jira dengan Python</a></li>
<li><a href="../id442080/index.html">Koneksi mikrometer untuk aplikasi web Java</a></li>
<li><a href="../id442082/index.html">Cara menyederhanakan riset basis data Oracle: satu set "gentleman's" dari skrip</a></li>
<li><a href="../id442084/index.html">Barang antik: kamera floppy disk berumur dua puluh tahun</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>