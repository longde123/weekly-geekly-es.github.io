<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëµüèø üí± ‚ôÄÔ∏è Operador de kubernetes de Tarantool üë©üèº‚Äçüíª ‚õΩÔ∏è üë®üèæ‚Äçüåæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Kubernetes ya se ha convertido en un est√°ndar de facto para ejecutar aplicaciones sin estado, principalmente porque puede reducir el tiempo de comerci...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Operador de kubernetes de Tarantool</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/472428/"><img src="https://habrastorage.org/getpro/habr/post_images/550/d23/612/550d23612db44d65216aff9caf75403a.jpg"><br><br>  Kubernetes ya se ha convertido en un est√°ndar de facto para ejecutar aplicaciones sin estado, principalmente porque puede reducir el tiempo de comercializaci√≥n de nuevas caracter√≠sticas.  Lanzar aplicaciones con estado, como bases de datos o microservicios con estado, sigue siendo una tarea compleja, pero las empresas deben cumplir con la competencia y mantener una alta tasa de entrega.  Entonces crean una demanda de tales soluciones. <br><br>  Queremos presentar nuestra soluci√≥n para el lanzamiento de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">agrupaciones de cartuchos de</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Tarantool</a> : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Operador Tarantool Kubernetes</a> , m√°s bajo el corte. <br><a name="habracut"></a><br><ol><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">En lugar de mil palabras</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Lo que el operador realmente hace</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Un poco sobre los detalles</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">C√≥mo funciona el operador</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Lo que crea el operador</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Resumen</a> <br></li></ol><br>  Tarantool es un DBMS de c√≥digo abierto y un servidor de aplicaciones todo en uno.  Como base de datos, tiene muchas caracter√≠sticas √∫nicas: alta eficiencia en la utilizaci√≥n del hardware, esquema de datos flexible, soporte para almacenamiento en disco y en memoria, y la posibilidad de extensi√≥n usando el lenguaje Lua.  Como servidor de aplicaciones, le permite mover el c√≥digo de la aplicaci√≥n lo m√°s cerca posible de los datos con un tiempo de respuesta m√≠nimo y un rendimiento m√°ximo.  Adem√°s, Tarantool tiene un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">extenso ecosistema que</a> proporciona m√≥dulos listos para usar para resolver problemas de aplicaci√≥n: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">fragmentaci√≥n</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">cola</a> , m√≥dulos para un f√°cil desarrollo ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">cartucho</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">luatest</a> ), soluciones para la operaci√≥n ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">m√©trica</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ansible</a> ), solo por nombrar algunos. <br><br>  Por todos sus m√©ritos, las capacidades de una sola instancia de Tarantool son siempre limitadas.  Tendr√≠a que crear decenas y cientos de instancias para almacenar terabytes de datos y procesar millones de solicitudes, lo que ya implica un sistema distribuido con todos sus problemas t√≠picos.  Para resolverlos, tenemos el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">cartucho Tarantool</a> , que es un marco dise√±ado para ocultar todo tipo de dificultades al escribir aplicaciones distribuidas.  Permite a los desarrolladores concentrarse en el valor comercial de la aplicaci√≥n.  Cartridge proporciona un conjunto robusto de componentes para la orquestaci√≥n autom√°tica de cl√∫steres, distribuci√≥n autom√°tica de datos, WebUI para operaci√≥n y herramientas para desarrolladores. <br><br>  Tarantool no solo se trata de tecnolog√≠as, sino tambi√©n de un equipo de ingenieros que trabajan en el desarrollo de sistemas empresariales llave en mano, soluciones listas para usar y soporte para componentes de c√≥digo abierto. <br><br>  A nivel mundial, todas nuestras tareas se pueden dividir en dos √°reas: el desarrollo de nuevos sistemas y la mejora de las soluciones existentes.  Por ejemplo, hay una extensa base de datos de un proveedor conocido.  Para escalarlo para la lectura, se coloca un cach√© consistente eventualmente basado en Tarantool.  O viceversa: para escalar la escritura, Tarantool se instala en la configuraci√≥n fr√≠o / calor: mientras los datos se "enfr√≠an", se vuelcan al almacenamiento en fr√≠o y al mismo tiempo a la cola de an√°lisis.  O se escribe una versi√≥n ligera de un sistema existente (copia de seguridad funcional) para hacer una copia de seguridad de los datos "activos" mediante la replicaci√≥n de datos del sistema principal.  Obtenga m√°s informaci√≥n de los <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">informes de la conferencia T + 2019</a> . <br><br>  Todos estos sistemas tienen una cosa en com√∫n: son algo dif√≠ciles de operar.  Bueno, hay muchas cosas interesantes: crear r√°pidamente un cl√∫ster de m√°s de 100 instancias respaldando en 3 centros de datos;  para actualizar la aplicaci√≥n que almacena datos sin tiempo de inactividad o inconvenientes de mantenimiento;  crear una copia de seguridad y restaurar para prepararse para un posible accidente o errores humanos;  para garantizar la conmutaci√≥n por error de componentes ocultos;  para organizar la gesti√≥n de la configuraci√≥n ... <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">El cartucho de Tarantool</a> que literalmente se acaba de lanzar en c√≥digo abierto simplifica significativamente el desarrollo del sistema distribuido: admite agrupaci√≥n de componentes, descubrimiento de servicios, gesti√≥n de configuraci√≥n, detecci√≥n de fallas de instancia y conmutaci√≥n por error autom√°tica, gesti√≥n de topolog√≠a de replicaci√≥n y componentes de fragmentaci√≥n. <br>  Ser√≠a genial si pudi√©ramos operar todo esto tan r√°pido como desarrollarlo.  Kubernetes lo hace posible, pero un operador especializado har√≠a la vida a√∫n m√°s c√≥moda. <br><br>  Hoy presentamos la versi√≥n alfa de Tarantool Kubernetes Operator. <br><br><a name="1"></a><h2>  En lugar de mil palabras </h2><br>  Hemos preparado un peque√±o ejemplo basado en el cartucho de Tarantool, y vamos a trabajar con √©l.  Es una aplicaci√≥n simple llamada almacenamiento de valor clave distribuido con interfaz HTTP.  Despu√©s de la puesta en marcha, tenemos lo siguiente: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c24/235/2c7/c242352c708a0e0dfa8fc0896bbb986d.png"><br><br>  Donde <br><br><ul><li>  Los enrutadores son parte del cl√∫ster responsable de aceptar y procesar las solicitudes HTTP entrantes; <br></li><li>  Los almacenamientos son parte del cl√∫ster responsable de almacenar y procesar datos;  Se instalan tres fragmentos de la caja, cada uno con un maestro y una r√©plica. <br></li></ul><br>  Para equilibrar el tr√°fico HTTP entrante en los enrutadores, se utiliza un Kubernetes Ingress.  Los datos se distribuyen en el almacenamiento al nivel de Tarantool utilizando el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">componente vshard</a> . <br><br>  Necesitamos Kubernetes 1.14+, pero <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">minikube</a> servir√°.  Tambi√©n es encantador tener <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">kubectl</a> .  Para iniciar el operador, cree una cuenta de servicio, un rol y un enlace de rol: <br><br><pre><code class="plaintext hljs">$ kubectl create -f https://raw.githubusercontent.com/tarantool/tarantool-operator/0.0.1/deploy/service_account.yaml $ kubectl create -f https://raw.githubusercontent.com/tarantool/tarantool-operator/0.0.1/deploy/role.yaml $ kubectl create -f https://raw.githubusercontent.com/tarantool/tarantool-operator/0.0.1/deploy/role_binding.yaml</code> </pre> <br>  Tarantool Operator extiende la API de Kubernetes con sus definiciones de recursos, as√≠ que cre√©moslas: <br><br><pre> <code class="plaintext hljs">$ kubectl create -f https://raw.githubusercontent.com/tarantool/tarantool-operator/0.0.1/deploy/crds/tarantool_v1alpha1_cluster_crd.yaml $ kubectl create -f https://raw.githubusercontent.com/tarantool/tarantool-operator/0.0.1/deploy/crds/tarantool_v1alpha1_role_crd.yaml $ kubectl create -f https://raw.githubusercontent.com/tarantool/tarantool-operator/0.0.1/deploy/crds/tarantool_v1alpha1_replicasettemplate_crd.yaml</code> </pre> <br>  Todo est√° listo para iniciar el operador, as√≠ que aqu√≠ va: <br><br><pre> <code class="plaintext hljs">$ kubectl create -f https://raw.githubusercontent.com/tarantool/tarantool-operator/0.0.1/deploy/operator.yaml</code> </pre> <br>  Estamos esperando que el operador comience y luego podemos continuar con el inicio de la aplicaci√≥n: <br><br><pre> <code class="plaintext hljs">$ kubectl create -f https://raw.githubusercontent.com/tarantool/tarantool-operator/0.0.1/examples/kv/deployment.yaml</code> </pre> <br>  Se declara un Ingress en la interfaz de usuario web en el archivo YAML con el ejemplo;  Est√° disponible en <code>cluster_ip/admin/cluster</code> .  Cuando al menos un Ingress Pod est√° listo y ejecut√°ndose, puede ir all√≠ para ver c√≥mo se agregan nuevas instancias al cl√∫ster y c√≥mo cambia su topolog√≠a. <br>  Estamos esperando que se use el cl√∫ster: <br><br><pre> <code class="plaintext hljs">$ kubectl describe clusters.tarantool.io examples-kv-cluster</code> </pre> <br>  Estamos esperando el siguiente estado del cl√∫ster: <br><br><pre> <code class="plaintext hljs">‚Ä¶ Status: State: Ready ‚Ä¶</code> </pre> <br>  ¬°Eso es todo, y la aplicaci√≥n est√° lista para usar! <br><br>  ¬øNecesitas m√°s espacio de almacenamiento?  Luego, agreguemos algunos fragmentos: <br><br><pre> <code class="plaintext hljs">$ kubectl scale roles.tarantool.io storage --replicas=3</code> </pre> <br>  Si los fragmentos no pueden manejar la carga, aumentemos el n√∫mero de instancias en el fragmento editando la plantilla de conjunto de r√©plicas: <br><br><pre> <code class="plaintext hljs">$ kubectl edit replicasettemplates.tarantool.io storage-template</code> </pre> <br>  <code>.spec.replicas</code> valor de <code>.spec.replicas</code> en dos para aumentar el n√∫mero de instancias en cada conjunto de r√©plicas en dos. <br><br>  Si ya no se necesita un cl√∫ster, simplemente elim√≠nelo junto con todos los recursos: <br><br><pre> <code class="plaintext hljs">$ kubectl delete clusters.tarantool.io examples-kv-cluster</code> </pre> <br>  ¬øAlgo sali√≥ mal?  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Cree un boleto</a> y trabajaremos r√°pidamente en √©l. <br><br><a name="2"></a><h2>  Lo que el operador realmente hace </h2><br>  La puesta en marcha y el funcionamiento del cl√∫ster de cartucho de Tarantool es una historia de la realizaci√≥n de acciones espec√≠ficas en un orden espec√≠fico en un momento espec√≠fico. <br><br>  El cl√∫ster en s√≠ mismo se administra principalmente a trav√©s de la API de administraci√≥n: GraphQL sobre HTTP.  Sin duda, puede bajar un nivel y dar comandos directamente a trav√©s de la consola, pero esto no sucede con mucha frecuencia. <br>  Por ejemplo, as√≠ es como se inicia el cl√∫ster: <br><br><ol><li>  Implementamos el n√∫mero requerido de instancias de Tarantool, por ejemplo, usando systemd. </li><li>  Luego conectamos las instancias en membres√≠a: <br><br><pre> <code class="plaintext hljs">mutation { probe_instance: probe_server(uri: "storage:3301") }</code> </pre> </li><li>  Luego asignamos los roles a las instancias y especificamos los identificadores del conjunto de instancias y r√©plicas.  La API GraphQL se utiliza para este prop√≥sito: <br><br><pre> <code class="plaintext hljs">mutation { join_server( uri:"storage:3301", instance_uuid: "cccccccc-cccc-4000-b000-000000000001", replicaset_uuid: "cccccccc-0000-4000-b000-000000000000", roles: ["storage"], timeout: 5 ) }</code> </pre> </li><li>  Inicialmente, arrancamos el componente responsable de fragmentar utilizando la API: <br><br><pre> <code class="plaintext hljs">mutation { bootstrap_vshard cluster { failover(enabled:true) } }</code> </pre> </li></ol><br>  F√°cil, verdad? <br><br>  Todo es m√°s interesante cuando se trata de expansi√≥n de cl√∫ster.  La funci√≥n de enrutadores del ejemplo se escala f√°cilmente: cree m√°s instancias, √∫nalas a un cl√∫ster existente, ¬°y listo!  El papel de Storages es algo m√°s complicado.  El almacenamiento est√° fragmentado, por lo que al agregar / eliminar instancias, es necesario reequilibrar los datos movi√©ndolos a / desde las instancias nuevas / eliminadas, respectivamente.  De lo contrario, se producir√≠an instancias subcargadas o p√©rdida de datos.  ¬øQu√© pasa si no hay solo uno, sino una docena de cl√∫steres con diferentes topolog√≠as? <br><br>  En general, esto es todo lo que maneja el operador de Tarantool.  El usuario describe el estado necesario del cl√∫ster de cartucho de Tarantool, y el operador lo traduce en un conjunto de acciones aplicadas a los recursos de K8 y en ciertas llamadas a la API del administrador del cl√∫ster de Tarantool en un orden espec√≠fico en un momento espec√≠fico.  Tambi√©n trata de ocultar todos los detalles del usuario. <br><br><a name="3"></a><h2>  Un poco sobre los detalles </h2><br>  Mientras trabaja con la API de administrador del cl√∫ster de Tarantool Cartridge, tanto el orden de las llamadas como su destino son esenciales.  ¬øPor qu√© es eso? <br><br>  Tarantool Cartridge contiene su almacenamiento de topolog√≠a, componente de descubrimiento de servicio y componente de configuraci√≥n.  Cada instancia del cl√∫ster almacena una copia de la topolog√≠a y la configuraci√≥n en un archivo YAML. <br><br><pre> <code class="plaintext hljs">servers: d8a9ce19-a880-5757-9ae0-6a0959525842: uri: storage-2-0.examples-kv-cluster:3301 replicaset_uuid: 8cf044f2-cae0-519b-8d08-00a2f1173fcb 497762e2-02a1-583e-8f51-5610375ebae9: uri: storage-0-0.examples-kv-cluster:3301 replicaset_uuid: 05e42b64-fa81-59e6-beb2-95d84c22a435 ‚Ä¶ vshard: bucket_count: 30000 ...</code> </pre> <br>  Las actualizaciones se aplican consistentemente utilizando el mecanismo de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">confirmaci√≥n de dos fases</a> .  Una actualizaci√≥n exitosa requiere un qu√≥rum del 100%: cada instancia debe responder.  De lo contrario, retrocede.  ¬øQu√© significa esto en t√©rminos de operaci√≥n?  En t√©rminos de confiabilidad, todas las solicitudes a la API de administrador que modifican el estado del cl√∫ster deben enviarse a una sola instancia, o al l√≠der, porque de lo contrario nos arriesgamos a obtener diferentes configuraciones en diferentes instancias.  Tarantool Cartridge no sabe c√≥mo hacer una elecci√≥n de l√≠der (todav√≠a no), pero el operador de Tarantool puede, y para usted, esto es un hecho divertido, porque el operador hace todo. <br><br>  Cada instancia tambi√©n debe tener una identidad fija, es decir, un conjunto de <code>instance_uuid</code> y <code>replicaset_uuid</code> , as√≠ como <code>advertise_uri</code> .  Si de repente se reinicia un almacenamiento y uno de estos par√°metros cambia, entonces corre el riesgo de romper el qu√≥rum, y el operador es responsable de esto. <br><br><a name="4"></a><h2>  C√≥mo funciona el operador </h2><br>  El prop√≥sito del operador es llevar el sistema al estado definido por el usuario y mantener el sistema en este estado hasta que se den nuevas instrucciones.  Para que el operador pueda trabajar, necesita: <br><br><ol><li>  La descripci√≥n del estado del sistema. </li><li>  El c√≥digo que llevar√≠a al sistema a este estado. </li><li>  Un mecanismo para integrar este c√≥digo en k8s (por ejemplo, para recibir notificaciones de cambio de estado). </li></ol><br>  El grupo de cartuchos de Tarantool se describe en t√©rminos de k8s utilizando una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">definici√≥n de recursos personalizados (CRD)</a> .  El operador necesitar√≠a tres recursos personalizados unidos bajo el grupo tarantool.io/v1alpha: <br><br><ul><li>  El cl√∫ster es un recurso de nivel superior que corresponde a un solo cl√∫ster de cartucho de Tarantool. </li><li>  El rol es un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">rol de usuario</a> en t√©rminos de cartucho de Tarantool. </li><li>  Replicaset Template es una plantilla para crear StatefulSets (te dir√© un poco m√°s tarde por qu√© son con estado; no se debe confundir con K8s ReplicaSet). </li></ul><br>  Todos estos recursos reflejan directamente el modelo de descripci√≥n del cl√∫ster de cartucho de Tarantool.  Tener un diccionario com√∫n facilita la comunicaci√≥n con los desarrolladores y la comprensi√≥n de lo que les gustar√≠a ver en producci√≥n. <br><br>  El c√≥digo que lleva el sistema al estado dado es el controlador en t√©rminos de K8.  En el caso del operador Tarantool, hay varios controladores: <br><br><ul><li>  Cluster Controller es responsable de interactuar con el cl√∫ster de Tarantool Cartridge;  conecta instancias al cl√∫ster y desconecta instancias del cl√∫ster. </li><li>  Role Controller es el controlador de roles de usuario responsable de crear StatefulSets a partir de la plantilla y mantener el n√∫mero predefinido de ellos. </li></ul><br>  ¬øC√≥mo es un controlador?  Es un conjunto de c√≥digo que gradualmente pone el mundo a su alrededor en orden.  Un controlador de cl√∫ster se ver√≠a esquem√°ticamente como: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/048/fbd/e9c/048fbde9c799c900b74df1669d3d760e.png"><br><br>  Un punto de entrada es una prueba para ver si existe un recurso Cluster correspondiente para un evento.  ¬øExiste?  "No" significa dejar de fumar.  "S√≠" significa pasar al siguiente bloque y tomar posesi√≥n de los roles de usuario.  Cuando se toma la propiedad de un rol, se cierra y se repite por segunda vez.  Sigue y sigue hasta que toma la propiedad de todos los roles.  Cuando se toma la propiedad, es hora de pasar al siguiente bloque de operaciones.  Y el proceso contin√∫a hasta el √∫ltimo bloque.  Despu√©s de eso, podemos suponer que el sistema controlado est√° en el estado definido. <br><br>  En general, todo es bastante simple.  Sin embargo, es importante determinar los criterios de √©xito para pasar cada etapa.  Por ejemplo, la operaci√≥n de uni√≥n de cl√∫ster no se considera exitosa cuando devuelve √©xito hipot√©tico = verdadero, pero cuando devuelve un error como "ya se uni√≥". <br><br>  Y la √∫ltima parte de este mecanismo es la integraci√≥n del controlador con K8.  Desde una vista de p√°jaro, los K8 completos consisten en un conjunto de controladores que generan eventos y responden a ellos.  Estos eventos est√°n organizados en colas a las que podemos suscribirnos.  Se ver√≠a esquem√°ticamente como: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/51f/aac/8cd/51faac8cdbbc04ec81b0f383313369df.jpg"><br><br>  El usuario llama a <code>kubectl create -f tarantool_cluster.yaml</code> , y se crea el recurso Cluster correspondiente.  El Cluster Controller recibe una notificaci√≥n de la creaci√≥n de recursos del Cluster.  Y lo primero que intenta hacer es encontrar todos los recursos de rol que deber√≠an formar parte de este cl√∫ster.  Si lo hace, entonces asigna el Cl√∫ster como el Propietario del Rol y actualiza el recurso del Rol.  El Controlador de roles recibe una notificaci√≥n de actualizaci√≥n de roles, entiende que el recurso tiene su Propietario y comienza a crear StatefulSets.  As√≠ es como funciona: el primer evento activa el segundo, el segundo evento activa el tercero, y as√≠ sucesivamente hasta que uno de ellos se detiene.  Tambi√©n puede establecer un disparador de tiempo, por ejemplo, cada 5 segundos. <br><br>  As√≠ es como se organiza el operador: creamos un recurso personalizado y escribimos el c√≥digo que responde a los eventos relacionados con los recursos. <br><br><a name="5"></a><h2>  Lo que crea el operador </h2><br>  Las acciones del operador finalmente resultan en la creaci√≥n de K8s Pods y contenedores.  En el cl√∫ster de cartucho de Tarantool implementado en K8, todos los pods est√°n conectados a StatefulSets. <br><br>  ¬øPor qu√© StatefulSet?  Como mencion√© anteriormente, cada instancia de Tarantool Cluster mantiene una copia de la topolog√≠a y configuraci√≥n del cl√∫ster.  Y de vez en cuando un servidor de aplicaciones tiene un espacio dedicado, por ejemplo, para colas o datos de referencia, y este ya es un estado completo.  StatefulSet tambi√©n garantiza que se preservan las identidades de Pod, lo cual es importante cuando se agrupan instancias: las instancias deben tener identidades fijas, de lo contrario corremos el riesgo de perder el qu√≥rum al reiniciar. <br><br>  Cuando todos los recursos del cl√∫ster est√°n listos y en el estado deseado, reflejan la siguiente jerarqu√≠a: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/51f/aac/8cd/51faac8cdbbc04ec81b0f383313369df.jpg"><br><br>  Las flechas indican la relaci√≥n dependiente del propietario entre los recursos.  Es necesario, por ejemplo, que el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">recolector de basura se</a> limpie despu√©s de la eliminaci√≥n del cl√∫ster. <br><br>  Adem√°s de StatefulSets, el operador de Tarantool crea un servicio sin cabeza para la elecci√≥n del l√≠der, y las instancias se comunican entre s√≠ a trav√©s de este servicio. <br><br>  El operador de Tarantool se basa en el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">marco</a> del <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">operador</a> , y el c√≥digo del operador est√° escrito en Golang, por lo que no hay nada especial aqu√≠. <br><br><a name="6"></a><h2>  Resumen </h2><br>  Eso es casi todo lo que hay que hacer.  Estamos a la espera de sus comentarios y entradas.  No podemos prescindir de ellos, es la versi√≥n alfa despu√©s de todo.  ¬øQu√© sigue?  El siguiente paso es pulir mucho: <br><br><ul><li>  Unidad, pruebas E2E; <br></li><li>  Pruebas de Chaos Monkey; <br></li><li>  pruebas de estr√©s; <br></li><li>  copia de seguridad / restauraci√≥n; <br></li><li>  proveedor de topolog√≠a externo. <br></li></ul><br>  Cada uno de estos temas es amplio por s√≠ solo y merece un art√≠culo separado, ¬°as√≠ que espere las actualizaciones! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/472428/">https://habr.com/ru/post/472428/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../472416/index.html">ZeroNights Hackquest 2019. Resultados y rese√±as</a></li>
<li><a href="../472418/index.html">C√≥mo mantener los derechos de desarrollo personalizado</a></li>
<li><a href="../472420/index.html">Hacer que la interfaz sea m√°s receptiva gracias a Promise diferido</a></li>
<li><a href="../472422/index.html">Sber X RamblerFront & Meet Up</a></li>
<li><a href="../472426/index.html">Semana de la seguridad 43: la vida secreta de IoT Hanipots</a></li>
<li><a href="../472430/index.html">C√≥mo elegimos la base de componentes para un hogar inteligente: sobre sensores y un controlador</a></li>
<li><a href="../472432/index.html">Python 3.8: ¬øQu√© hay de nuevo y c√≥mo usarlo?</a></li>
<li><a href="../472434/index.html">Actualiza tus lanzamientos</a></li>
<li><a href="../472438/index.html">C√≥mo se usan los proxies en la seguridad de la informaci√≥n: 6 casos de uso pr√°ctico</a></li>
<li><a href="../472440/index.html">Un d√≠a en Joker 2019</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>