<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤜🏼 👋🏿 🧑🏻 Raspberry Pi + CentOS = Wi-Fi Hotspot (atau Router Raspberry dengan Topi Merah) 👱🏿 👊🏿 🍙</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ada banyak informasi di Internet tentang membuat titik akses Wi-Fi berdasarkan pada PC Raspberry papan tunggal. Sebagai aturan, ini menyiratkan penggu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Raspberry Pi + CentOS = Wi-Fi Hotspot (atau Router Raspberry dengan Topi Merah)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/458994/"> Ada banyak informasi di Internet tentang membuat titik akses Wi-Fi berdasarkan pada PC Raspberry papan tunggal.  Sebagai aturan, ini menyiratkan penggunaan sistem operasi asli untuk Raspberry - Raspbian. <br><br>  Menjadi penganut sistem berbasis RPM, saya tidak bisa melewati keajaiban kecil ini dan tidak mencoba CentOS favorit saya. <br><br>  Artikel ini memberikan instruksi untuk membuat router Wi-Fi 5GHz / AC dari Raspberry Pi 3 Model B + berdasarkan sistem operasi CentOS.  Akan ada beberapa trik standar, tetapi sedikit diketahui, dan sebagai bonus - gambar menghubungkan ke peralatan Wi-Fi tambahan "raspberry", yang memungkinkannya untuk bekerja secara bersamaan dalam beberapa mode (2,4 + 5GHz). <br><br><img src="https://habrastorage.org/webt/mp/yb/fz/mpybfz6gzojqkaftnuljhpzx5da.png" alt="gambar"><br>  <sub><i>(campuran gambar dari akses gratis)</i></sub> <br><a name="habracut"></a><br>  Kami segera mencatat bahwa beberapa kecepatan kosmik tidak akan berfungsi.  Saya memeras maksimum 100 Mbit dari "raspberry" saya di udara, dan ini mencakup kecepatan penyedia Internet saya.  Mengapa kita membutuhkan AC yang lamban, jika bahkan pada N, secara teori, Anda bisa mendapatkan setengah gigabyte?  Jika Anda menanyakan pertanyaan ini, maka pergi ke toko untuk router nyata dengan delapan antena eksternal. <br><br><h1>  0. Apa yang dibutuhkan </h1><br><ul><li>  Sebenarnya, "produk raspberry" kaliber itu sendiri: Pi 3 Model B + (untuk mencapai kecepatan dan saluran 5GHz yang didambakan); <br></li><li>  MicroSD padat&gt; = 4GB; <br></li><li>  Linux workstation dengan pembaca / penulis microSD; <br></li><li>  Kehadiran keterampilan yang memadai di Linux, artikel ini disiapkan untuk Geek; <br></li><li>  Konektivitas jaringan kabel (eth0) antara Raspberry dan Linux, server DHCP yang berfungsi pada jaringan lokal, dan akses Internet dari kedua perangkat. <br></li></ul><br>  Komentar singkat tentang poin terakhir.  “Apa yang datang lebih dulu, telur atau ...” bagaimana membuat router Wi-Fi tanpa adanya peralatan akses Internet?  Mari kita tinggalkan latihan yang menghibur ini di luar ruang lingkup artikel dan anggap saja Raspberry terhubung ke jaringan lokal melalui kabel dan memiliki akses Internet.  Dalam hal ini, kami tidak memerlukan TV tambahan dan manipulator untuk menyiapkan raspberry. <br><br><h1>  1. Instal CentOS </h1><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Beranda proyek</a> <br><br>  Pada saat penulisan ini, versi kerja CentOS pada perangkat adalah 32-bit.  Di suatu tempat di luasnya World Wide Web, saya menemukan pendapat tentang penurunan kinerja OS tersebut pada arsitektur ARM 64-bit sebanyak 20%.  Saya akan meninggalkan titik ini tanpa komentar. <br><br>  Di Linux, unduh gambar minimal dengan kernel " <b>-RaspberryPI-</b> " dan tulis ke microSD: <br><br><pre><code class="plaintext hljs"># xzcat CentOS-Userland-7-armv7hl-RaspberryPI-Minimal-1810-sda.raw.xz | \ dd of=/dev/mmcblk0 bs=4M # sync</code> </pre> <br>  Sebelum menggunakan gambar, hapus bagian SWAP dari itu, perluas root ke seluruh volume yang tersedia dan singkirkan SELinux.  Algoritma ini sederhana: kami membuat salinan root di Linux, menghapus semua partisi dari microSD kecuali yang pertama (/ boot), membuat root baru dan mengembalikan isinya dari salinan. <br><br><div class="spoiler">  <b class="spoiler_title">Contoh tindakan yang diperlukan (output konsol yang keras)</b> <div class="spoiler_text"><pre> <code class="plaintext hljs"># mount /dev/mmcblk0p3 /mnt # cd /mnt # tar cfz ~/pi.tgz . --no-selinux # cd # umount /mnt</code> </pre><br><pre> <code class="plaintext hljs"># parted /dev/mmcblk0 (parted) unit s (parted) print free Model: SD SC16G (sd/mmc) Disk /dev/mmcblk0: 31116288s Sector size (logical/physical): 512B/512B Partition Table: msdos Disk Flags: Number Start End Size Type File system Flags 63s 2047s 1985s Free Space 1 2048s 1370111s 1368064s primary fat32 boot, lba 2 1370112s 2369535s 999424s primary linux-swap(v1) 3 2369536s 5298175s 2928640s primary ext4 5298176s 31116287s 25818112s Free Space (parted) rm 3 (parted) rm 2 (parted) print free Model: SD SC16G (sd/mmc) Disk /dev/mmcblk0: 31116288s Sector size (logical/physical): 512B/512B Partition Table: msdos Disk Flags: Number Start End Size Type File system Flags 63s 2047s 1985s Free Space 1 2048s 1370111s 1368064s primary fat32 boot, lba 1370112s 31116287s 29746176s Free Space (parted) mkpart Partition type? primary/extended? primary File system type? [ext2]? ext4 Start? 1370112s End? 31116287s (parted) set Partition number? 2 Flag to Invert? lba New state? on/[off]? off (parted) print free Model: SD SC16G (sd/mmc) Disk /dev/mmcblk0: 31116288s Sector size (logical/physical): 512B/512B Partition Table: msdos Disk Flags: Number Start End Size Type File system Flags 63s 2047s 1985s Free Space 1 2048s 1370111s 1368064s primary fat32 boot, lba 2 1370112s 31116287s 29746176s primary ext4 (parted) quit</code> </pre><br><pre> <code class="plaintext hljs"># mkfs.ext4 /dev/mmcblk0p2 mke2fs 1.44.6 (5-Mar-2019) /dev/mmcblk0p2 contains a swap file system labelled '_swap' Proceed anyway? (y,N) y Discarding device blocks: done Creating filesystem with 3718272 4k blocks and 930240 inodes Filesystem UUID: 6a1a0694-8196-4724-a58d-edde1f189b31 Superblock backups stored on blocks: 32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632, 2654208 Allocating group tables: done Writing inode tables: done Creating journal (16384 blocks): done Writing superblocks and filesystem accounting information: done # mount /dev/mmcblk0p2 /mnt # tar xfz ~/pi.tgz -C /mnt --no-selinux</code> </pre><br>  Setelah membongkar isi partisi root, saatnya untuk melakukan beberapa perubahan padanya. <br><br>  Nonaktifkan SELinux di <b>/ mnt / etc / selinux / config</b> : <br><br><pre> <code class="plaintext hljs">SELINUX=disabled</code> </pre><br>  Kami mengedit <b>/ mnt / etc / fstab</b> , hanya menyisakan dua entri partisi di dalamnya: boot (/ boot, tidak berubah) dan root (ubah nilai UUID, yang dapat ditemukan dengan memeriksa output dari perintah blkid di Linux): <br><br><pre> <code class="plaintext hljs">UUID=6a1a0694-8196-4724-a58d-edde1f189b31 / ext4 defaults,noatime 0 0 UUID=6938-F4F2 /boot vfat defaults,noatime 0 0</code> </pre><br>  Terakhir, kami mengubah parameter boot kernel: tentukan lokasi baru partisi root, nonaktifkan output informasi debug, dan (opsional) melarang kernel untuk menetapkan alamat IPv6 pada antarmuka jaringan: <br><br><pre> <code class="plaintext hljs"># cd # umount /mnt # mount /dev/mmcblk0p1 /mnt</code> </pre><br>  Kami <b>membawa</b> konten <b>/mnt/cmdline.txt</b> ke formulir berikut (satu baris tanpa tanda hubung): <br><br><pre> <code class="plaintext hljs">root=/dev/mmcblk0p2 rootfstype=ext4 elevator=deadline rootwait quiet ipv6.disable_ipv6=1</code> </pre><br>  Selesai: <br><br><pre> <code class="plaintext hljs"># cd # umount /mnt # sync</code> </pre><br></div></div><br>  Kami mengatur ulang microSD di "Malinka", menjalankannya dan mendapatkan akses jaringan ke sana melalui ssh (root / centos). <br><br><h1>  2. Mengkonfigurasi CentOS </h1><br>  Tiga gerakan pertama yang tidak tergoyahkan: <b>passwd</b> , <b>pembaruan yum -y</b> , <b>reboot</b> . <br><br>  Kami memberikan manajemen jaringan ke <b>networkd</b> : <br><br><pre> <code class="plaintext hljs"># yum install systemd-networkd # systemctl enable systemd-networkd # systemctl disable NetworkManager # chkconfig network off</code> </pre><br>  Buat file (bersama dengan direktori) <b>/etc/systemd/network/eth0.network</b> : <br><br><pre> <code class="plaintext hljs">[Match] Name=eth0 [Network] DHCP=ipv4</code> </pre><br>  Kami me-reboot "raspberry" dan sekali lagi kami mendapatkan akses jaringan ke sana melalui ssh (alamat IP dapat berubah).  Perhatikan bahwa <b>/etc/resolv.conf</b> , yang sebelumnya dibuat oleh Network Manager, digunakan.  Karena itu, jika ada masalah dengan penyelesaian, edit isinya.  Kami tidak akan menggunakan <b>systemd-diselesaikan</b> . <br><br>  Kami menghapus "berlebihan", memperbaiki dan mempercepat pemuatan OS: <br><br><pre> <code class="plaintext hljs"># systemctl set-default multi-user.target # yum remove GeoIP Network* aic* alsa* cloud-utils-growpart \ cronie* dhc* firewal* initscripts iwl* kexec* logrotate \ postfix rsyslog selinux-pol* teamd wpa_supplicant</code> </pre><br>  Siapa yang butuh <b>cron</b> dan siapa yang tidak mencerna <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">timer systemd bawaan</a> , dapat menginstal yang hilang.  <b>/ var / log -</b> dan lihat <b>jurnalctl</b> .  Jika Anda memerlukan riwayat log (secara default, informasi disimpan hanya dari saat sistem dimulai): <br><br><pre> <code class="plaintext hljs"># mkdir /var/log/journal # systemd-tmpfiles --create --prefix /var/log/journal # systemctl restart systemd-journald # vi /etc/systemd/journald.conf</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Nonaktifkan penggunaan IPv6 oleh layanan inti (jika diperlukan)</b> <div class="spoiler_text">  <b>/ etc / ssh / sshd_config</b> : <br><br><pre> <code class="plaintext hljs">AddressFamily inet</code> </pre><br>  <b>/ etc / sysconfig / chronyd</b> : <br><pre> <code class="plaintext hljs">OPTIONS="-4"</code> </pre><br></div></div><br>  Relevansi waktu pada "raspberry" adalah hal yang penting.  Karena "di luar kotak" tidak ada kemampuan perangkat keras untuk menyimpan keadaan jam saat ini saat reboot, Anda perlu sinkronisasi.  Daemon yang sangat bagus dan cepat untuk ini - <b>chrony</b> - sudah diinstal dan mulai secara otomatis.  Anda dapat mengubah server NTP ke yang berikutnya. <br><br>  <b>/etc/chrony.conf</b> : <br><br><pre> <code class="plaintext hljs">server 0.ru.pool.ntp.org iburst server 1.ru.pool.ntp.org iburst server 2.ru.pool.ntp.org iburst server 3.ru.pool.ntp.org iburst</code> </pre><br>  Kami akan menggunakan <b>trik</b> untuk mengatur zona waktu.  Karena tujuan kami adalah membuat router Wi-Fi yang beroperasi pada frekuensi 5GHz, kami akan mempersiapkan terlebih dahulu untuk kejutan <b>regulator</b> : <br><blockquote>  # yum info crda <br>  Ringkasan: Daemon kepatuhan peraturan untuk jaringan nirkabel 802.11 <br></blockquote><br>  Desain dengki ini, dengan fokus, antara lain, pada zona waktu, "melarang" penggunaan (di Rusia) frekuensi dan saluran 5GHz dengan angka "besar".  Caranya adalah dengan mengatur zona waktu tanpa menggunakan nama-nama daratan / kota, yaitu, bukannya: <br><br><pre> <code class="plaintext hljs"># timedatectl set-timezone Europe/Moscow</code> </pre><br>  Tekan: <br><br><pre> <code class="plaintext hljs"># timedatectl set-timezone Etc/GMT-3</code> </pre><br>  Dan sentuhan terakhir dalam gaya rambut sistem: <br><br><pre> <code class="plaintext hljs"># hostnamectl set-hostname router</code> </pre><br>  <b>/root/.bash_profile</b> : <br><br><pre> <code class="plaintext hljs">. . . # User specific environment and startup programs export PROMPT_COMMAND="echo -n $(($(&lt;/sys/class/thermal/thermal_zone0/temp) / 1000))\'C\ " export LANG=en_US.UTF-8 export PATH=$PATH:$HOME/bin</code> </pre><br><h1>  3. Pengaya CentOS </h1><br>  Semua yang dikatakan di atas dapat dianggap sebagai instruksi lengkap untuk menginstal "vanilla" CentOS pada Raspberry Pi.  Anda harus memiliki PC yang melakukan booting dalam waktu kurang dari 10 detik, menggunakan RAM kurang dari 15 megabytes dan 1,5 GB microSD (sebenarnya kurang dari 1 gigabyte karena tidak lengkap / boot, tetapi kami akan jujur ​​sampai akhir): <br><img src="https://habrastorage.org/webt/mu/0g/cf/mu0gcfyiokq0x_2dysrb1ieh0ke.jpeg"><br><br><img src="https://habrastorage.org/webt/xx/l3/_g/xxl3_gukovfw0zawwvvy8ua0dtw.jpeg"><br><br><img src="https://habrastorage.org/webt/wt/yc/-9/wtyc-9erdcdx-rvqnnjite7c9ru.jpeg"><br><br>  Untuk menginstal perangkat lunak titik akses Wi-Fi pada sistem ini, Anda perlu sedikit memperluas kemampuan distribusi CentOS standar.  Pertama-tama, “pompa” driver (firmware) dari adaptor Wi-Fi bawaan.  Situs proyek mengatakan: <br><blockquote>  Wifi di Raspberry 3B dan 3B + <br><br>  File firmware Raspberry PI 3B / 3B + tidak diizinkan untuk didistribusikan oleh Proyek CentOS.  Anda dapat menggunakan artikel berikut ini untuk memahami masalah ini, mendapatkan firmware dan mengatur wifi. <br></blockquote><br>  Apa yang tidak dapat dilakukan proyek CentOS tidak dilarang bagi kami untuk penggunaan pribadi.  Kami mengganti distribusi Wi-Fi firmware di CentOS dengan yang sesuai dari pengembang Broadcom (gumpalan biner yang sama dibenci ...).  Ini, khususnya, akan memungkinkan penggunaan AC dalam mode titik akses. <br><br><div class="spoiler">  <b class="spoiler_title">Pembaruan firmware Wi-Fi</b> <div class="spoiler_text">  Kami mengetahui model perangkat dan versi firmware saat ini: <br><br><pre> <code class="plaintext hljs"># journalctl | grep $(basename $(readlink /sys/class/net/wlan0/device/driver)) Jan 01 04:00:03 router kernel: brcmfmac: F1 signature read @0x18000000=0x15264345 Jan 01 04:00:03 router kernel: brcmfmac: brcmf_fw_map_chip_to_name: using brcm/brcmfmac43455-sdio.bin for chip 0x004345(17221) rev 0x000006 Jan 01 04:00:03 router kernel: usbcore: registered new interface driver brcmfmac Jan 01 04:00:03 router kernel: brcmfmac: brcmf_c_preinit_dcmds: Firmware version = wl0: Mar 1 2015 07:29:38 version 7.45.18 (r538002) FWID 01-6a2c8ad4 Jan 01 04:00:03 router kernel: brcmfmac: brcmf_c_preinit_dcmds: CLM version = API: 12.2 Data: 7.14.8 Compiler: 1.24.9 ClmImport: 1.24.9 Creation: 2014-09-02 03:05:33 Inc Data: 7.17.1 Inc Compiler: 1.26.11 Inc ClmImport: 1.26.11 Creation: 2015-03-01 07:22:34</code> </pre><br>  Kami melihat bahwa versi firmware adalah 7.45.18 tanggal 03/01/2015, dan kami mengingat serangkaian angka berikut: <b>43455</b> (brcmfmac43455-sdio.bin). <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Unduh gambar Raspbian saat ini</a> .  Orang malas dapat menulis gambar ke microSD dan dari sana mengambil file dengan firmware.  Dan Anda dapat me-mount partisi root dari gambar di Linux dan menyalin yang Anda butuhkan dari sana: <br><br><pre> <code class="plaintext hljs"># wget https://downloads.raspberrypi.org/raspbian_lite_latest # unzip -p raspbian_lite_latest &gt; raspbian.img # fdisk -l raspbian.img Disk raspbian.img: 2 GiB, 2197815296 bytes, 4292608 sectors Units: sectors of 1 * 512 = 512 bytes Sector size (logical/physical): 512 bytes / 512 bytes I/O size (minimum/optimal): 512 bytes / 512 bytes Disklabel type: dos Disk identifier: 0x17869b7d Device Boot Start End Sectors Size Id Type raspbian.img1 8192 532480 524289 256M c W95 FAT32 (LBA) raspbian.img2 540672 4292607 3751936 1.8G 83 Linux # mount -t ext4 -o loop,offset=$((540672 * 512)) raspbian.img /mnt # cp -fv /mnt/lib/firmware/brcm/*43455* ... '/mnt/lib/firmware/brcm/brcmfmac43455-sdio.bin' -&gt; ... '/mnt/lib/firmware/brcm/brcmfmac43455-sdio.clm_blob' -&gt; ... '/mnt/lib/firmware/brcm/brcmfmac43455-sdio.txt' -&gt; ... # umount /mnt</code> </pre><br>  File firmware yang dihasilkan untuk adaptor Wi-Fi harus disalin dengan penggantian "raspberry" di direktori <b>/ usr / lib / firmware / brcm /</b> <br><br>  Kami me-reboot router yang akan datang dan lebih banyak tersenyum: <br><br><pre> <code class="plaintext hljs"># journalctl | grep $(basename $(readlink /sys/class/net/wlan0/device/driver)) Jan 01 04:00:03 router kernel: brcmfmac: F1 signature read @0x18000000=0x15264345 Jan 01 04:00:03 router kernel: brcmfmac: brcmf_fw_map_chip_to_name: using brcm/brcmfmac43455-sdio.bin for chip 0x004345(17221) rev 0x000006 Jan 01 04:00:03 router kernel: usbcore: registered new interface driver brcmfmac Jan 01 04:00:03 router kernel: brcmfmac: brcmf_c_preinit_dcmds: Firmware version = wl0: Feb 27 2018 03:15:32 version 7.45.154 (r684107 CY) FWID 01-4fbe0b04 Jan 01 04:00:03 router kernel: brcmfmac: brcmf_c_preinit_dcmds: CLM version = API: 12.2 Data: 9.10.105 Compiler: 1.29.4 ClmImport: 1.36.3 Creation: 2018-03-09 18:56:28</code> </pre><br>  Versi: 7.45.154 dari 02.27.2018. <br></div></div><br>  Dan tentu saja EPEL: <br><br><pre> <code class="plaintext hljs"># cat &gt; /etc/yum.repos.d/epel.repo &lt;&lt; EOF [epel] name=Epel rebuild for armhfp baseurl=https://armv7.dev.centos.org/repodir/epel-pass-1/ enabled=1 gpgcheck=0 EOF # yum clean all # rm -rfv /var/cache/yum # yum update</code> </pre><br><h1>  4. Konfigurasi Jaringan dan Tantangan Mendatang </h1><br>  Seperti yang kami sepakati di atas, "Malinka" dihubungkan oleh "kawat" ke jaringan lokal.  Misalkan penyedia menyediakan akses Internet dengan cara yang persis sama: alamat pada jaringan publik secara dinamis dikeluarkan oleh server DHCP (dapat dihubungkan ke MAC).  Dalam hal ini, setelah pengaturan akhir "raspberry", cukup untuk "mencolokkan" kabel penyedia ke dalamnya dan semuanya siap.  Otorisasi menggunakan <b>systemd-networkd</b> adalah topik dari artikel terpisah dan tidak dipertimbangkan di sini. <br><br>  Antarmuka Wi-Fi Raspberry adalah jaringan lokal, dan adaptor Ethernet bawaan (eth0) bersifat eksternal.  Kami memberi nomor jaringan lokal secara statis, misalnya: 192.168.0.0/24.  Alamat Malinka: 192.168.0.1.  Dalam jaringan eksternal (Internet) server DHCP akan berfungsi. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Masalah keseragaman penamaan</a> dan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">programmer Guatemala terkenal</a> adalah dua masalah menunggu semua orang yang terlibat dalam mengkonfigurasi antarmuka jaringan dan layanan dalam distribusi systemd. <br><br><div class="spoiler">  <b class="spoiler_title">Kekacauan Paralel (penyimpangan liris)</b> <div class="spoiler_text">  Lennart Pottering membuat program <b>systemd-</b> nya dengan sangat baik.  <b>Systemd</b> ini meluncurkan program-program lain dengan sangat cepat sehingga mereka, karena tidak punya waktu untuk menyadarinya dari peluit wasit, tersandung dan jatuh di awal bahkan tanpa memulai rintangan mereka. <br><br>  Tapi serius, paralelisasi agresif dari proses yang diluncurkan pada awal systemd-OS adalah semacam "jembatan keledai" untuk driver LSB seri berpengalaman.  Untungnya, merapikan "kekacauan paralel" ini ternyata sederhana, meskipun kebenarannya tidak selalu jelas. <br></div></div><br>  Kami membuat dua antarmuka jembatan virtual dengan nama konstan: <b>lan</b> dan <b>wan</b> .  Kami akan "menghubungkan" adapter Wi-Fi ke yang pertama, dan eth0 dari "raspberry" ke yang kedua. <br><br>  <b>/etc/systemd/network/lan.netdev</b> : <br><br><pre> <code class="plaintext hljs">[NetDev] Name=lan Kind=bridge</code> </pre><br>  <b>/etc/systemd/network/lan.network</b> : <br><br><pre> <code class="plaintext hljs">[Match] Name=lan [Network] Address=192.168.0.1/24 IPForward=yes</code> </pre><br>  <b>/etc/systemd/network/wan.netdev</b> : <br><br><pre> <code class="plaintext hljs">[NetDev] Name=wan Kind=bridge #MACAddress=xx:xx:xx:xx:xx:xx</code> </pre><br>  <b>/etc/systemd/network/wan.network</b> : <br><br><pre> <code class="plaintext hljs">[Match] Name=wan [Network] DHCP=ipv4 IPForward=yes</code> </pre><br>  <b>IPForward = yes</b> menghilangkan kebutuhan untuk mengisyaratkan ke kernel melalui sysctl untuk mengaktifkan routing. <br>  <b>MACAddress =</b> batalkan komentar dan ubah jika perlu. <br><br>  Pertama, kami menghubungkan eth0.  Ingat "masalah keseragaman" dan hanya gunakan alamat MAC dari antarmuka ini, yang dapat Anda temukan, misalnya, seperti ini: <br><br><pre> <code class="plaintext hljs"># cat /sys/class/net/eth0/address</code> </pre><br>  Buat <b>/etc/systemd/network/eth.network</b> : <br><br><pre> <code class="plaintext hljs">[Match] MACAddress=b8:27:eb:xx:xx:xx [Network] Bridge=wan</code> </pre><br>  Hapus file konfigurasi eth0 sebelumnya, reboot "raspberry" dan dapatkan akses jaringan ke sana (kemungkinan alamat IP akan berubah): <br><br><pre> <code class="plaintext hljs"># rm -fv /etc/systemd/network/eth0.network # reboot</code> </pre><br><h1>  5. DNSMASQ </h1><br>  Untuk pembuatan titik akses Wi-Fi, belum ada yang lebih baik dari pasangan manis dari <b>dnsmasq</b> + <b>hostapd yang</b> belum ditemukan.  Menurut saya. <br><br><div class="spoiler">  <b class="spoiler_title">Jika ada yang lupa, maka ...</b> <div class="spoiler_text">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">hostapd</a> adalah hal yang mengelola adapter Wi-Fi (khususnya, akan menyulitkan untuk menghubungkannya ke ran virtual raspberry), itu mengotorisasi dan mendaftarkan klien nirkabel. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">dnsmasq</a> - mengkonfigurasi tumpukan jaringan klien: memberikan alamat IP, server DNS, gateway default, dan sejenisnya. <br></div></div><br>  Kita mulai dengan dnsmasq: <br><br><pre> <code class="plaintext hljs"># yum install dnsmasq</code> </pre><br>  Templat <b>/etc/resolv.conf</b> : <br><br><pre> <code class="plaintext hljs">nameserver 1.1.1.1 nameserver 1.0.0.1 nameserver 8.8.8.8 nameserver 8.8.4.4 nameserver 77.88.8.8 nameserver 77.88.8.1 domain router.local search router.local</code> </pre><br>  edit sesuai keinginan Anda. <br><br>  Minimal <b>/etc/dnsmasq.conf</b> : <br><br><pre> <code class="plaintext hljs">domain-needed bogus-priv interface=lan bind-dynamic expand-hosts domain=# dhcp-range=192.168.0.100,192.168.0.199,255.255.255.0,24h conf-dir=/etc/dnsmasq.d</code> </pre><br>  "Magic" di sini adalah parameter <b>bind-dynamic</b> , yang memberitahu daemon dnsmasq untuk menunggu <b>interface = lan</b> muncul di sistem, dan tidak pingsan karena serangan kesepian yang bangga setelah permulaan. <br><br><pre> <code class="plaintext hljs"># systemctl enable dnsmasq # systemctl start dnsmasq; journalctl -f</code> </pre><br><h1>  6. HOSTAPD </h1><br>  Akhirnya, konfigurasi hostapd ajaib.  Saya tidak ragu bahwa seseorang sedang membaca artikel ini untuk mencari garis-garis berharga ini. <br><br>  Sebelum menginstal hostapd, Anda harus berurusan dengan "masalah keseragaman".  Adaptor Wi-Fi wlan0 built-in dapat dengan mudah mengubah namanya menjadi wlan1 saat menghubungkan peralatan USB Wi-Fi tambahan.  Oleh karena itu, kami akan memperbaiki nama-nama antarmuka dengan cara berikut: kami akan datang dengan (nirkabel) adapter nama unik dan mengikatnya ke alamat MAC. <br><br>  Untuk adaptor Wi-Fi bawaan, yang masih wlan0: <br><br><pre> <code class="plaintext hljs"># cat /sys/class/net/wlan0/address b8:27:eb:xx:xx:xx</code> </pre><br>  Buat <b>/etc/systemd/network/wl0.link</b> : <br><br><pre> <code class="plaintext hljs">[Match] MACAddress=b8:27:eb:xx:xx:xx [Link] Name=wl0</code> </pre><br>  Sekarang kita akan yakin bahwa <b>wl0</b> adalah Wi-Fi <b>bawaan</b> .  Kami me-reboot "raspberry" untuk melihat ini. <br><br>  Pasang: <br><br><pre> <code class="plaintext hljs"># yum install hostapd wireless-tools</code> </pre><br>  File konfigurasi <b>/etc/hostapd/hostapd.conf</b> : <br><br><pre> <code class="plaintext hljs">ssid=rpi wpa_passphrase=1234567890 channel=36 country_code=US interface=wl0 bridge=lan driver=nl80211 auth_algs=1 wpa=2 wpa_key_mgmt=WPA-PSK rsn_pairwise=CCMP macaddr_acl=0 hw_mode=a wmm_enabled=1 # N ieee80211n=1 require_ht=1 ht_capab=[MAX-AMSDU-3839][HT40+][SHORT-GI-20][SHORT-GI-40][DSSS_CCK-40] # AC ieee80211ac=1 require_vht=1 ieee80211d=0 ieee80211h=0 vht_capab=[MAX-AMSDU-3839][SHORT-GI-80] vht_oper_chwidth=1 vht_oper_centr_freq_seg0_idx=42</code> </pre><br>  Tanpa melupakan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">GKChP</a> selama satu menit, kami mengubah parameter yang kami butuhkan dan memeriksa kinerja secara manual: <br><br><pre> <code class="plaintext hljs"># hostapd /etc/hostapd/hostapd.conf</code> </pre><br>  hostapd akan mulai secara interaktif, menerjemahkan kondisinya ke konsol.  Jika tidak ada kesalahan, maka klien yang mendukung mode AC sudah dapat terhubung ke titik akses.  Untuk menghentikan hostapd - Ctrl-C. <br><br>  Masih memasukkan hostapd dalam startup sistem.  Jika Anda bertindak secara standar (systemctl aktifkan hostapd), maka setelah reboot berikutnya, Anda bisa mendapatkan "daemon dalam darah" iblis dengan diagnosis " <b>antarmuka wl0 tidak ditemukan</b> ."  Sebagai hasil dari "kekacauan paralel," hostapd berakhir lebih cepat daripada kernel menemukan adaptor nirkabel. <br><br>  Internet penuh dengan obat-obatan: dari penghentian waktu paksa sebelum daemon dimulai (selama beberapa menit), ke daemon lain yang memantau tampilan antarmuka dan (kembali) memulai hostpad.  Solusinya cukup berhasil, tetapi sangat jelek.  Kami meminta bantuan <b>systemd yang</b> hebat dengan "tujuan" dan " <s>tugas</s> " "ketergantungannya". <br><br>  Salin file layanan distribusi ke <b>/etc/systemd/system/hostapd.service</b> : <br><br><pre> <code class="plaintext hljs"># cp -fv /usr/lib/systemd/system/hostapd.service /etc/systemd/system</code> </pre><br>  dan bawa isinya ke formulir berikut: <br><br><pre> <code class="plaintext hljs">[Unit] Description=Hostapd IEEE 802.11 AP, IEEE 802.1X/WPA/WPA2/EAP/RADIUS Authenticator After=sys-subsystem-net-devices-wl0.device BindsTo=sys-subsystem-net-devices-wl0.device [Service] Type=forking PIDFile=/run/hostapd.pid ExecStart=/usr/sbin/hostapd /etc/hostapd/hostapd.conf -P /run/hostapd.pid -B [Install] WantedBy=sys-subsystem-net-devices-wl0.device</code> </pre><br>  Keajaiban dari file layanan yang diperbarui adalah untuk secara dinamis mengikat hostapd ke target baru - antarmuka wl0.  Ketika antarmuka muncul, daemon mulai, ketika menghilang, itu berhenti.  Dan semuanya online - tanpa me-reboot sistem.  Khususnya teknik ini akan berguna saat menghubungkan ke adaptor Wi-Fi USB "raspberry". <br><br>  Sekarang kamu bisa: <br><br><pre> <code class="plaintext hljs"># systemctl enable hostapd # reboot</code> </pre><br><h1>  7. IPTABLES </h1><br>  "Shta ???"  © Ya, ya!  Tidak ada <b>sistemd</b> .  Tidak ada kombinasi model baru (dalam bentuk <b>firewalld</b> ), yang pada akhirnya melakukan hal yang sama. <br><br>  Kami menggunakan <b>iptables</b> lama yang baik, layanan yang, setelah dimulainya, akan mengunggah aturan jaringan ke kernel dan diam-diam dimatikan tanpa penduduk tetap dan tanpa menghabiskan sumber daya.  Systemd memiliki <b>IPMasquerade = yang</b> elegan, tetapi kami masih akan mempercayakan iptables dengan terjemahan alamat (NAT) dan firewall. <br><br>  Pasang: <br><br><pre> <code class="plaintext hljs"># yum install iptables-services # systemctl enable iptables ip6tables</code> </pre><br>  Saya lebih suka menyimpan konfigurasi iptables sebagai skrip (contoh): <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash # # Disable IPv6 # ip6tables --flush ip6tables --delete-chain ip6tables --policy INPUT DROP ip6tables --policy FORWARD DROP ip6tables --policy OUTPUT DROP ip6tables-save &gt; /etc/sysconfig/ip6tables systemctl restart ip6tables # # Cleaning # iptables -F iptables -X iptables -t nat -F iptables -t nat -X iptables -t mangle -F iptables -t mangle -X iptables -P INPUT DROP iptables -P OUTPUT ACCEPT iptables -P FORWARD ACCEPT # # Loopback, lan # iptables -A INPUT -i lo -j ACCEPT iptables -A INPUT -i lan -j ACCEPT # # Ping, Established # iptables -A INPUT -p icmp --icmp-type echo-request -j ACCEPT iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT # # NAT # iptables -t nat -A POSTROUTING -o wan -j MASQUERADE # # Saving # iptables-save &gt; /etc/sysconfig/iptables systemctl restart iptables</span></span></code> </pre><br>  Kami menjalankan skrip di atas dan kehilangan kemampuan untuk membangun koneksi ssh kabel baru dengan "Malinka".  Itu benar, kami membuat router Wi-Fi, akses yang "via Internet" secara default dilarang - sekarang hanya "melalui udara."  Kami menghubungkan kabel penyedia ke Ethernet dan mulai berselancar! <br><br><h1>  8. Bonus: + 2.4GHz </h1><br>  Ketika saya merakit router Raspberry pertama dari gambar yang dijelaskan di atas, saya menemukan di peternakan saya sejumlah gadget bahwa, karena keterbatasan desain mereka, Wi-Fi tidak bisa melihat "raspberry" sama sekali.  Mengkonfigurasi ulang router agar berfungsi di 802.11b / g / n tidak seperti olahraga, karena kecepatan maksimum "over the air" dalam kasus ini tidak melebihi 40 Mbps, dan penyedia Internet favorit saya menawarkan saya 100 (melalui kabel). <br><br>  Bahkan, solusi untuk masalah telah ditemukan: antarmuka Wi-Fi kedua yang beroperasi pada 2,4GHz, dan titik akses kedua.  Di warung terdekat, saya membeli bukan yang pertama, tetapi “peluit” USB Wi-Fi kedua yang datang kepada saya.  Penjual tersiksa oleh pertanyaan tentang chipset, kompatibilitas dengan Linux ARM-core dan kemungkinan bekerja dalam mode AP (ia pertama kali memulai). <br><br>  Kami mengonfigurasi "peluit" dengan analogi dengan adaptor Wi-Fi bawaan. <br><br>  Pertama, <b>ubah</b> nama menjadi <b>wl1</b> : <br><br><pre> <code class="plaintext hljs"># cat /sys/class/net/wlan0/address b0:6e:bf:xx:xx:xx</code> </pre><br>  <b>/etc/systemd/network/wl1.link</b> : <br><br><pre> <code class="plaintext hljs">[Match] MACAddress=b0:6e:bf:xx:xx:xx [Link] Name=wl1</code> </pre><br>  Kami akan mempercayakan pengelolaan antarmuka Wi-Fi baru ke daemon hostapd terpisah, yang akan mulai dan berhenti tergantung pada keberadaan "peluit" yang didefinisikan secara ketat dalam sistem: wl1. <br><br>  File konfigurasi <b>/etc/hostapd/hostapd2.conf</b> : <br><br><pre> <code class="plaintext hljs">ssid=rpi2 wpa_passphrase=1234567890 #channel=1 #channel=6 channel=11 interface=wl1 bridge=lan driver=nl80211 auth_algs=1 wpa=2 wpa_key_mgmt=WPA-PSK rsn_pairwise=CCMP macaddr_acl=0 hw_mode=g wmm_enabled=1 # N ieee80211n=1 require_ht=1 ht_capab=[HT40][SHORT-GI-20][SHORT-GI-40][DSSS_CCK-40]</code> </pre><br>  Isi file ini secara langsung tergantung pada model adaptor Wi-Fi USB, sehingga salinan / tempel yang sepele dapat mengecewakan Anda. <br><br>  Salin file layanan distribusi ke <b>/etc/systemd/system/hostapd2.service</b> : <br><br><pre> <code class="plaintext hljs"># cp -fv /usr/lib/systemd/system/hostapd.service /etc/systemd/system/hostapd2.service</code> </pre><br>  dan bawa isinya ke formulir berikut: <br><br><pre> <code class="plaintext hljs">[Unit] Description=Hostapd IEEE 802.11 AP, IEEE 802.1X/WPA/WPA2/EAP/RADIUS Authenticator After=sys-subsystem-net-devices-wl1.device BindsTo=sys-subsystem-net-devices-wl1.device [Service] Type=forking PIDFile=/run/hostapd2.pid ExecStart=/usr/sbin/hostapd /etc/hostapd/hostapd2.conf -P /run/hostapd2.pid -B [Install] WantedBy=sys-subsystem-net-devices-wl1.device</code> </pre><br>  Tetap menyertakan contoh baru hostapd: <br><br><pre> <code class="plaintext hljs"># systemctl enable hostapd2</code> </pre><br>  Itu saja!  Tarik peluit dan raspberry itu sendiri, lihat jaringan nirkabel di sekitarnya. <br><br>  Dan akhirnya, saya ingin memperingatkan tentang kualitas adaptor Wi-Fi USB dan catu daya Raspberry.  Terhubung "ke peluit panas", kadang-kadang dapat menyebabkan "raspberry hang" karena masalah listrik jangka pendek. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id458994/">https://habr.com/ru/post/id458994/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id458984/index.html">Cara membuat aplikasi pertama untuk berdagang di bursa: 3 langkah awal</a></li>
<li><a href="../id458986/index.html">Resep PostgreSQL: Konversi dari HTML dan URL ke PDF dan PS</a></li>
<li><a href="../id458988/index.html">Tekstur, atau apa yang perlu Anda ketahui untuk menjadi Artis Permukaan. Bagian 4. Model, normals, dan sapuan</a></li>
<li><a href="../id458990/index.html">Berhentilah bersemangat dengan komentar dalam kode</a></li>
<li><a href="../id458992/index.html">Perhatian untuk boneka dan implementasi di Keras</a></li>
<li><a href="../id458996/index.html">User Inyerface - bagaimana tidak menyiksa pengguna</a></li>
<li><a href="../id459000/index.html">Bagaimana saya mencoba meningkatkan Halo 2, tetapi hampir merusaknya</a></li>
<li><a href="../id459002/index.html">Cara mengkonfigurasi HTTPS - Generator Konfigurasi SSL akan membantu</a></li>
<li><a href="../id459004/index.html">Algoritma kriptografi Grasshopper: kompleks</a></li>
<li><a href="../id459012/index.html">Membuat aplikasi untuk Bitrix24 dari awal</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>