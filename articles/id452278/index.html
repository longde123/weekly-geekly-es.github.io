<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏼‍💼 👨🏾‍🎤 🖕🏼 Bluetooth LE tidak begitu menakutkan, atau Bagaimana meningkatkan pengalaman pengguna tanpa banyak usaha ↩️ 👩🏻‍🤝‍👨🏽 🕰️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Baru-baru ini, tim kami membuat dan menerapkan fungsi mentransfer uang melalui udara menggunakan teknologi Bluetooth LE. Saya ingin memberi tahu Anda ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Bluetooth LE tidak begitu menakutkan, atau Bagaimana meningkatkan pengalaman pengguna tanpa banyak usaha</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/raiffeisenbank/blog/452278/">  Baru-baru ini, tim kami membuat dan menerapkan fungsi mentransfer uang melalui udara menggunakan teknologi Bluetooth LE.  Saya ingin memberi tahu Anda bagaimana kami melakukannya dan apa yang Apple berikan kepada kami dari alat-alatnya.  Banyak pengembang berpikir bahwa Bluetooth itu sulit, karena itu protokol yang agak rendah, dan tidak banyak ahli di dalamnya.  Tetapi semuanya tidak begitu menakutkan, dan pada kenyataannya, menggunakan fungsi ini sangat sederhana!  Dan fungsi-fungsi yang dapat diimplementasikan menggunakan Bluetooth LE tentu menarik dan selanjutnya akan menyoroti aplikasi Anda di antara para pesaing. <br><br><img src="https://habrastorage.org/webt/97/vu/bb/97vubbbho3z3z4dx_fwnztumh9u.png"><br><a name="habracut"></a><br>  Pertama mari kita pahami teknologi apa itu dan apa bedanya dengan Bluetooth klasik. <br><br><h3>  Apa itu Bluetooth LE? </h3><br>  Mengapa pengembang Bluetooth menamai teknologi ini yaitu Low Energy?  Lagi pula, dengan setiap versi Bluetooth baru, konsumsi daya sudah berkali-kali lebih rendah.  Jawabannya ada pada baterai ini. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ce/qb/65/ceqb65oxhimqzgzovufqysqvsqk.png"></div><br>  Diameternya hanya 2 cm, dan kapasitasnya sekitar 220 mA * h.  Ketika para insinyur mengembangkan Bluetooth LE, mereka ingin perangkat dengan baterai seperti itu berfungsi selama beberapa tahun.  Dan mereka berhasil!  Perangkat Bluetooth LE dengan baterai seperti itu dapat bekerja selama satu tahun.  Berapa banyak dari Anda yang masih mematikan Bluetooth di telepon dengan cara lama untuk menghemat energi, seperti yang Anda lakukan pada tahun 2000?  Sia-sia Anda melakukan ini - penghematannya akan kurang dari 10 detik ponsel per hari.  Dan Anda menonaktifkan fungsi yang sangat besar, seperti Handoff, AirDrop, dan lainnya. <br><br>  Apa yang dicapai para insinyur dengan mengembangkan Bluetooth LE?  Sudahkah mereka memperbaiki protokol klasik?  Membuatnya lebih hemat energi?  Hanya mengoptimalkan semua proses?  Tidak.  Mereka benar-benar mendesain ulang arsitektur tumpukan Bluetooth dan mencapai fakta bahwa sekarang, untuk dapat dilihat oleh semua perangkat lain, Anda perlu lebih sedikit waktu untuk mengudara dan menempati saluran.  Pada gilirannya, ini memungkinkan penghematan konsumsi energi yang baik.  Dan dengan arsitektur baru, setiap perangkat baru sekarang dapat distandarisasi, berkat pengembang dari seluruh dunia dapat berkomunikasi dengan perangkat dan, oleh karena itu, dengan mudah menulis aplikasi baru untuk mengelolanya.  Selain itu, prinsip penemuan-diri tertanam dalam arsitektur: saat menyambungkan ke perangkat, Anda tidak perlu memasukkan kode PIN apa pun, dan jika aplikasi Anda dapat berkomunikasi dengan perangkat ini, koneksi memerlukan hitungan milidetik. <br><br><ul><li>  Lebih sedikit waktu mengudara. </li><li>  Konsumsi daya lebih sedikit. </li><li>  Arsitektur baru. </li><li>  Mengurangi waktu koneksi. </li></ul><br>  <b>Bagaimana para insinyur dapat membuat lompatan besar dalam efisiensi energi?</b> <br><br>  Frekuensinya tetap sama: 2,4 GHz, tidak bersertifikat dan gratis untuk digunakan di banyak negara.  Tetapi penundaan koneksi menjadi kurang: 15-30 ms, bukannya 100 ms dengan Bluetooth klasik.  Jarak kerja tetap sama - 100 m Interval transmisi tidak kuat, tetapi berubah - bukannya 0,625 ms, menjadi 3 ms. <br><br>  Tetapi karena ini, konsumsi energi tidak dapat dikurangi sepuluh kali lipat.  Tentu saja, ada sesuatu yang harus diderita.  Dan ini kecepatannya: alih-alih 24 Mbps, itu menjadi 0,27 Mbps.  Anda mungkin akan mengatakan bahwa ini adalah kecepatan konyol untuk 2018. <br><br><h3>  Di mana Bluetooth LE digunakan? </h3><br><img src="https://habrastorage.org/webt/bz/0r/ca/bz0rcanj9nvdu_gijz0f6ip3h18.png"><br><br>  Teknologi ini tidak muda, ini pertama kali muncul di iPhone 4s.  Dan sudah berhasil menaklukkan banyak daerah.  Bluetooth LE digunakan di semua perangkat rumah pintar dan elektronik yang dapat dipakai.  Sekarang bahkan ada keripik seukuran biji kopi. <br><br><img src="https://habrastorage.org/webt/ex/0c/go/ex0cgowkyn9nhzx_c5vnwvn7v3g.png"><br><br>  <b>Dan bagaimana teknologi ini diterapkan dalam perangkat lunak?</b> <br><br>  Karena Apple adalah yang pertama mengintegrasikan Bluetooth ke dalam perangkat mereka dan mulai menggunakannya, sekarang mereka telah membuat kemajuan yang baik dan teknologi terintegrasi ke dalam ekosistem mereka.  Dan sekarang Anda dapat memenuhi teknologi ini dalam layanan seperti AirDrop, Perangkat mulai cepat, Bagikan kata sandi, Handoff.  Dan bahkan notifikasi di arloji dibuat melalui Bluetooth LE.  Selain itu, Apple telah membuat dokumentasi yang tersedia untuk umum tentang cara memastikan bahwa pemberitahuan dari semua aplikasi datang ke perangkat Anda sendiri.  Apa peran perangkat dalam Bluetooth LE? <br><br><img src="https://habrastorage.org/webt/vd/gk/85/vdgk85ww_wcqq_jykxexwqidgcw.png"><br><br>  <b>Brodcaster.</b>  Mengirim pesan ke semua orang di dekatnya, Anda tidak dapat terhubung ke perangkat ini.  Dengan prinsip ini, iBeacons dan pekerjaan navigasi dalam ruangan. <br><br>  <b>Pengamat.</b>  Mendengarkan apa yang terjadi di sekitar, dan hanya menerima data dari pesan publik.  Tidak membuat koneksi. <br><br>  Tetapi dengan <b>Central</b> dan <b>Periferal</b> lebih menarik.  Mengapa mereka tidak disebut hanya Server-Client?  Logikanya, dilihat dari namanya.  Tapi tidak. <br><br>  Karena Periferal sebenarnya bertindak sebagai server.  Ini adalah perangkat periferal yang mengonsumsi lebih sedikit daya dan terhubung ke Central yang lebih kuat.  Periferal dapat memberi tahu Anda bahwa lokasinya dekat dan layanan apa yang dimilikinya.  Hanya satu perangkat yang dapat terhubung, dan Periferal memiliki beberapa data.  Dan Central dapat memindai udara untuk mencari perangkat, mengirim permintaan koneksi, terhubung ke sejumlah perangkat, dapat membaca, menulis, dan berlangganan data dari Peripheral. <br><br>  Apa yang kita sebagai pengembang punya akses ke dalam ekosistem Apple? <br><br><h3>  Apa yang tersedia untuk kita? </h3><br>  <b>iOS / Mac OS:</b> <br><br><ul><li>  Periferal dan Tengah. </li><li>  Mode latar belakang. </li><li>  Pemulihan kondisi. </li><li>  Interval koneksi 15 ms. </li></ul><br>  <b>watchOS / tvOS:</b> <br><br><ul><li>  watchOS 4+ / tvOS 9+. </li><li>  Hanya di pusat. </li><li>  Maksimal dua koneksi. </li><li>  Apple watch series 2+ / AppleTv 4+. </li><li>  Shutdown saat memasuki latar belakang. </li><li>  Interval koneksi 30 ms. </li></ul><br>  Perbedaan yang paling penting adalah interval koneksi.  Apa pengaruhnya?  Untuk menjawab pertanyaan ini, Anda harus terlebih dahulu memahami cara kerja protokol LE Bluetooth dan mengapa perbedaan kecil dalam nilai absolut sangat penting. <br><br><h3>  Bagaimana protokolnya bekerja </h3><br>  Bagaimana proses pencarian dan koneksi? <br><br>  Periferal mengumumkan kehadirannya pada frekuensi interval iklan, paketnya sangat kecil dan hanya berisi beberapa pengidentifikasi layanan yang disediakan oleh perangkat, serta nama perangkat.  Intervalnya bisa sangat besar dan dapat bervariasi tergantung pada status perangkat saat ini, mode hemat daya dan pengaturan lainnya.  Apple menyarankan pengembang perangkat eksternal untuk mengikat panjang interval ke accelerometer: tingkatkan interval jika perangkat tidak digunakan, dan ketika itu aktif, kurangi untuk menemukan perangkat dengan cepat.  Interval iklan tidak berkorelasi dengan interval koneksi dan ditentukan oleh perangkat itu sendiri, tergantung pada konsumsi daya dan pengaturannya.  Ini tidak dapat diakses dan tidak diketahui oleh kita di ekosistem Apple, itu sepenuhnya dikendalikan oleh sistem. <br><br><img src="https://habrastorage.org/webt/na/_v/66/na_v662ojn9_xtvkdfma2wxyfaa.png"><br><br>  Setelah kami menemukan perangkat, kami mengirim permintaan koneksi, dan di sini interval koneksi memasuki adegan - waktu setelah mana perangkat kedua dapat menanggapi permintaan tersebut.  Tapi ini saat menghubungkan, tetapi apa yang terjadi saat membaca / menulis? <br><br><img src="https://habrastorage.org/webt/iq/mv/hg/iqmvhgecmnlikziagjsbda4vxe0.png"><br><br>  Interval koneksi juga muncul ketika membaca data - menguranginya 2 kali meningkatkan kecepatan transfer data.  Tetapi Anda perlu memahami bahwa jika kedua perangkat tidak mendukung interval yang sama, maka maksimumnya akan dipilih. <br><br>  Mari kita lihat apa paket informasi yang melewati Periferal. <br><br>  MTU (unit transmisi maksimum) dari paket tersebut ditentukan selama proses koneksi dan bervariasi dari perangkat ke perangkat dan tergantung pada sistem operasi.  Dalam protokol versi 4.0, MTU sekitar 30, dan ukuran muatan tidak melebihi 20 byte.  Dalam versi 4.2, semuanya telah berubah, sekarang Anda dapat mentransfer sekitar 520 byte.  Namun, sayangnya, hanya perangkat yang lebih muda dari iPhone 5s yang mendukung versi protokol ini.  Ukuran overhead, terlepas dari ukuran MTU, adalah 7 byte: ini termasuk header ATT dan L2CAP.  Dengan catatan, secara umum, situasi serupa. <br><br><img src="https://habrastorage.org/webt/gp/zi/ho/gpzihocxxa6po-lfmmlqyl5e7wu.png"><br><br>  Hanya ada dua mode: dengan jawab dan tanpa.  Mode tidak dijawab secara signifikan mempercepat transfer data, karena tidak ada interval menunggu sebelum perekaman berikutnya.  Tetapi mode ini tidak selalu tersedia, tidak di semua perangkat dan tidak di semua sistem.  Akses ke mode perekaman ini mungkin dibatasi oleh sistem itu sendiri, karena dianggap kurang hemat energi.  Di iOS, ada metode di mana Anda dapat memeriksa sebelum merekam apakah mode ini tersedia. <br><br>  Sekarang mari kita lihat protokolnya. <br><br><img src="https://habrastorage.org/webt/um/mh/um/ummhumgo7y_x3aeeu03wcv9shiy.png"><br><br>  Protokol terdiri dari 5 level.  <b>Lapisan aplikasi</b> adalah logika Anda, dijelaskan di atas CoreBluetooth.  <b>GATT (Generic Attributes Layer)</b> digunakan untuk bertukar layanan dan karakteristik yang ada di perangkat.  <b>ATT (Attributes Layer)</b> digunakan untuk mengelola karakteristik Anda dan mentransfer data Anda.  <b>L2CAP</b> adalah protokol pertukaran data tingkat rendah.  <b>Controller</b> adalah chip BT itu sendiri. <br><br>  <b>Anda mungkin bertanya apa itu GATT dan bagaimana kami bisa bekerja dengannya?</b> <br><br>  GATT terdiri dari fitur dan layanan.  Karakteristik adalah objek tempat data Anda disimpan, seperti variabel.  Dan layanan adalah grup di mana karakteristik Anda berada, seperti namespace.  Layanan memiliki nama - UUID, Anda memilihnya sendiri.  Suatu layanan dapat berisi layanan tambahan. <br><br><img src="https://habrastorage.org/webt/qs/cr/8k/qscr8kzsigratdfk7boemuqz_ri.png"><br><br>  Karakteristik juga memiliki <b>UUID</b> sendiri - pada kenyataannya, sebuah nama.  <b>Nilai</b> karakteristiknya adalah NSData, di sini Anda dapat merekam dan menyimpan data.  <b>Deskriptor</b> adalah deskripsi karakteristik Anda, Anda dapat menggambarkan data apa yang Anda harapkan dalam karakteristik ini, atau apa artinya.  Ada banyak deskriptor dalam protokol Bluetooth, tetapi sejauh ini hanya dua yang tersedia pada sistem Apple: deskripsi manusia dan format data.  Ada juga Izin untuk fitur Anda: <br><br><img src="https://habrastorage.org/webt/xz/zh/kz/xzzhkzptblzhshwvso6kiiygtwe.png"><br><br><h3>  Mari kita coba sendiri </h3><br>  Kami punya ide untuk memungkinkan untuk mentransfer uang melalui udara tanpa memerlukan apa pun dari penerima.  Bayangkan, Anda bingung dengan tugas yang sangat menarik, menulis kode yang sempurna, dan di sini seorang rekan menyarankan untuk minum kopi.  Dan Anda sangat bersemangat tentang tugas yang tidak bisa Anda hilangkan, dan memintanya untuk membelikan Anda secangkir cappuccino lezat.  Dia membawakanmu kopi, dan kau harus mengembalikan uang itu padanya.  Anda dapat menerjemahkan berdasarkan nomor telepon, ini berfungsi dengan baik.  Tapi ini situasi yang canggung - Anda tidak tahu nomornya.  Nah, seperti ini, Anda sudah bekerja selama tiga tahun, tetapi Anda belum bertukar nomor :) <br><br>  Oleh karena itu, kami memutuskan untuk memungkinkan transfer uang kepada mereka yang berada di dekatnya, tanpa memasukkan data pengguna apa pun.  Seperti di AirDrop.  Cukup pilih pengguna dan kirim jumlah yang dia butuhkan.  Mari kita lihat apa yang kita butuhkan untuk ini. <br><br><img src="https://habrastorage.org/webt/kp/tc/vs/kptcvsdcwhwapavwoxyq7h20nq4.png"><br><br><h3>  PUSH mapping </h3><br>  Kami membutuhkan pengirim: <br><br><ol><li>  Saya dapat menemukan semua perangkat yang ada di dekatnya dan mendukung layanan kami. </li><li>  Saya bisa membaca detailnya. </li><li>  Dan dia bisa mengirim pesan kepada penerima bahwa dia berhasil mengiriminya uang. </li></ol><br>  Penerima, pada gilirannya, harus dapat memberi tahu pengirim lain bahwa ia memiliki layanan dengan data yang diperlukan, dan dapat menerima pesan dari pengirim.  Saya pikir itu tidak layak menggambarkan bagaimana proses mentransfer uang dengan detail di bank kami terjadi.  Sekarang mari kita coba implementasikan ini. <br><br>  Pertama, Anda perlu mencari nama-nama layanan dan karakteristik kami.  Seperti yang saya katakan, ini adalah UUID.  Kami cukup membuatnya dan menyimpannya di Periferal dan Pusat sehingga keduanya sama di kedua perangkat. <br><br><img src="https://habrastorage.org/webt/xp/bd/xi/xpbdxioazo7xd4wbnnluhmncbk4.png"><br><br>  Anda bebas menggunakan UUID apa pun, kecuali yang berakhir seperti ini: XXXXXXXX- <b>0000-1000-8000-00805F9B34FB</b> - undang-undang tersebut dicadangkan untuk perusahaan yang berbeda.  Anda sendiri dapat membeli nomor tersebut dan tidak ada yang akan menggunakannya.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Biayanya</a> $ 2500. <br><br>  Selanjutnya, kita perlu membuat manajer: satu untuk mentransfer dana, yang lain untuk menerima.  Anda hanya perlu menentukan delegasi.  Kami akan mengirimkan Central, menerima Peripheral.  Kami menciptakan keduanya, karena pengirim dan penerima dapat menjadi satu orang pada waktu yang berbeda. <br><br><img src="https://habrastorage.org/webt/m3/vl/ta/m3vltagqi_tzwe8r6ayu70j3wyg.png"><br><br>  Sekarang kita perlu memungkinkannya untuk mendeteksi penerima dan menuliskan rincian penerima dalam karakteristik kita. <br><br><img src="https://habrastorage.org/webt/ui/nf/hb/uinfhboh_hqspuyugii1xkukh1a.png"><br><br>  Pertama, buat layanan.  Kami akan mendaftarkan UUID dan menunjukkan bahwa UUID itu primer - yaitu, layanan ini yang utama untuk perangkat ini.  Contoh yang bagus: monitor detak jantung, yang mana detak jantung saat ini akan menjadi layanan utama, dan status baterai adalah informasi sekunder. <br><br>  Selanjutnya, kami membuat dua karakteristik: satu untuk membaca detail penerima, yang kedua untuk menulis sehingga penerima dapat belajar tentang mengirim uang.  Kami mendaftarkan mereka di layanan kami, kemudian menambahkannya ke manajer, memulai penemuan dan menunjukkan UUID layanan sehingga semua perangkat yang berada di dekatnya dapat mengetahui tentang layanan kami sebelum menghubungkannya.  Data ini ditempatkan dalam paket yang dikirim Pusat selama siaran. <br><br>  Penerima siap, lanjutkan ke pengirim.  Jalankan pencarian dan hubungkan. <br><br><img src="https://habrastorage.org/webt/zq/d6/6j/zqd66jsw2k8gyb-chlj778dx_u8.png"><br><br>  Ketika Anda mengaktifkan manajer, kami mulai mencari perangkat dengan layanan kami.  Ketika kami menemukannya, kami mendapatkannya dalam metode delegasi dan segera terhubung.  Penting: Anda perlu mempertahankan tautan yang kuat ke semua Periferal tempat Anda bekerja, jika tidak mereka akan bocor. <br><br><img src="https://habrastorage.org/webt/ll/ce/nf/llcenfrfgkrgdgxxy0wh2usf9-q.png"><br><br>  Setelah koneksi berhasil, kami mengkonfigurasi delegasi yang akan bekerja dengan perangkat ini, dan kami mendapatkan layanan yang kami butuhkan dari perangkat. <br><br><img src="https://habrastorage.org/webt/j3/f0/lh/j3f0lh82sza1lncds8ujfd4yoac.png"><br><br>  Kami telah berhasil terhubung ke penerima, sekarang Anda harus membaca detailnya. <br><br>  Setelah terhubung, kami telah meminta semua layanan dari perangkat.  Dan setelah menerimanya, metode delegasi akan dipanggil, yang akan mencantumkan semua layanan yang tersedia di perangkat ini.  Kami menemukan yang tepat dan meminta karakteristiknya.  Hasilnya dapat ditemukan oleh UUID dalam metode delegasi, yang menyimpan data untuk diterjemahkan.  Kami mencoba membacanya, dan kami mendapatkan yang diinginkan lagi dalam metode delegasi.  Semua layanan, karakteristik, dan nilainya di-cache oleh sistem, sehingga tidak perlu meminta mereka nanti setiap kali. <br><br><img src="https://habrastorage.org/webt/cn/e8/qh/cne8qh7dtbbir7q76abbpil4ywk.png"><br><br>  Itu saja, kami mengirim uang untuk kopi, saatnya menunjukkan kepada penerima pemberitahuan yang indah sehingga ia menunggu rubel di akunnya.  Untuk melakukan ini, Anda perlu menerapkan proses pengiriman pesan. <br><br>  Kami mendapatkan karakteristik yang kami butuhkan dari pengirim, dalam hal ini kami mengambilnya dari nilai yang disimpan.  Tetapi sebelum itu, Anda harus mendapatkannya dari perangkat, seperti yang kami lakukan sebelumnya.  Dan kemudian cukup tulis data dengan karakteristik yang diinginkan. <br><br>  Setelah itu, di perangkat lain, kami mendapatkan permintaan tulis dalam metode delegasi.  Di sini Anda dapat membaca data yang dikirimkan kepada Anda, merespons kesalahan apa pun, misalnya, tidak ada akses, atau karakteristik ini tidak ada.  Semuanya akan berfungsi, tetapi hanya jika kedua perangkat dihidupkan dan aplikasi aktif.  Dan kita harus bekerja di latar belakang! <br><br><img src="https://habrastorage.org/webt/3n/3x/4n/3n3x4no4wu9c95ej5nlmxrfc5g8.png"><br><br>  Apple memungkinkan Anda untuk menggunakan Bluetooth di latar belakang.  Untuk melakukan ini, Anda perlu menunjukkan di info.plist kunci dalam mode mana yang ingin kita gunakan, di Peripheral atau Central. <br><br><img src="https://habrastorage.org/webt/e8/sk/ns/e8skns2rwruttrhvy1wagrcoppq.png"><br><br>  Selanjutnya, di manajer, Anda perlu menentukan kunci pemulihan dan membuat metode delegasi.  Sekarang mode latar belakang tersedia untuk kita.  Jika aplikasi tertidur atau dibongkar dari memori, maka ketika Anda menemukan Periferal yang diinginkan atau ketika Central terhubung, itu akan bangun dan manajer akan dipulihkan dengan kunci Anda. <br><br><img src="https://habrastorage.org/webt/7y/lz/xd/7ylzxdqlziqkiiqyby2ppkbcfws.png"><br><br>  Semuanya baik-baik saja, siap dirilis.  Tapi di sini desainer datang berlari ke kami dan berkata: "Kami ingin memasukkan foto pengguna sehingga lebih mudah bagi mereka untuk menemukan satu sama lain."  Apa yang harus dilakukan  Dalam karakteristik kami, Anda dapat menulis hanya sekitar 500 byte, tetapi pada beberapa perangkat secara umum 20 :( <br><br><img src="https://habrastorage.org/webt/cu/dd/_l/cudd_lekcmzrpsmf-mz-9w7is0m.png"><br><br><h3>  Pergi lebih dalam </h3><br>  Untuk mengatasi masalah ini, kami harus melangkah lebih dalam. <br><br><img src="https://habrastorage.org/webt/rt/bf/8h/rtbf8hlexfy42goqfvxs8mojyig.png"><br><br>  Sekarang kami berbicara dengan perangkat di tingkat GATT / ATT.  Tetapi di iOS 11, kami memiliki akses ke protokol L2CAP.  Namun, dalam hal ini, Anda harus mengurus sendiri transfer data.  Paket dikirim dengan MTU 2 Kb, tidak perlu menyandikan ulang apa pun, NSStream biasa diterapkan.  Kecepatan data hingga 394 Kbps, menurut Apple. <br><br>  Misalkan Anda mentransfer data apa pun dari layanan Anda dari Periferal ke Pusat dalam bentuk karakteristik normal.  Dan saya butuh untuk membuka saluran.  Anda membukanya di Periferal, sebagai imbalannya Anda mendapatkan PSM - ini adalah jumlah saluran yang dapat Anda hubungkan, dan Anda perlu mentransfernya ke Central menggunakan karakteristik yang sama.  Jumlahnya dinamis, sistem itu sendiri memilih PSM mana yang akan dibuka saat ini.  Setelah transfer, Anda sudah dapat terhubung ke Periferal di Pusat dan bertukar data dalam format yang nyaman bagi Anda.  Mari kita lihat bagaimana melakukan ini. <br><br>  Pertama, buka port terenkripsi pada Peripheral.  Anda dapat melakukannya tanpa enkripsi, maka ini akan sedikit mempercepat transfer. <br><br><img src="https://habrastorage.org/webt/ov/yd/ku/ovydkugm5hgyddaroucpcdjmaq0.png"><br><br>  Selanjutnya, dalam metode delegasi, kami mendapatkan PSM dan mengirimkannya ke perangkat lain. <br><br><img src="https://habrastorage.org/webt/tm/5g/bv/tm5gbvpsr1dbn8_x3jhg1btpth4.png"><br><br>  Setelah menghubungkan perangkat lain, kita akan dipanggil metode di mana kita bisa mendapatkan NSStream yang kita butuhkan untuk transmisi dari saluran. <br><br><img src="https://habrastorage.org/webt/nf/ec/kw/nfeckwjotne6tgzochcost5dr5g.png"><br><br>  Pusat bahkan lebih mudah, kami hanya terhubung ke saluran dengan nomor yang diinginkan ... <br><br><img src="https://habrastorage.org/webt/oi/tm/hg/oitmhgdbpty9nmathmdnbhsisok.png"><br><br>  ... dan setelah itu kita mendapatkan aliran yang kita butuhkan.  Di dalamnya Anda benar-benar dapat mentransfer data apa pun dalam berbagai ukuran, dan membangun protokol Anda di atas L2CAP.  Jadi kami menyadari transfer foto penerima. <br><br><img src="https://habrastorage.org/webt/fq/hq/ha/fqhqha7vfucpkksx4whppmay_du.png"><br><br>  Tetapi ada jebakan, di mana melakukannya tanpa mereka. <br><br><h3>  Perangkap </h3><br>  Mari kita lihat perangkap saat bekerja di latar belakang.  Karena peran Periferal dan Pusat tersedia untuk Anda, Anda mungkin berpikir.  bahwa di latar belakang Anda dapat menentukan perangkat mana yang terdekat di latar belakang dan mana yang aktif.  Secara teori, memang seharusnya begitu, tetapi Apple memperkenalkan batasan: ponsel yang ada di latar belakang, baik Tengah atau Periferal, tidak tersedia untuk ponsel lain yang juga ada di latar belakang.  Selain itu, ponsel yang ada di latar belakang tidak terlihat dari perangkat non-iOS.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mari kita lihat mengapa ini terjadi. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ketika perangkat Anda aktif, ia akan mengirim paket siaran reguler, yang mungkin berisi nama perangkat dan daftar layanan. </font><font style="vertical-align: inherit;">yang disediakan perangkat ini. </font><font style="vertical-align: inherit;">Dan data melimpah adalah semua yang tidak sesuai.</font></font><br><br><img src="https://habrastorage.org/webt/si/ca/ri/sicarigcdlr017kg1zpesa15psc.png"><br><br>       ,    ,       overflow-.   ,     iOS-    ,      — .          ,     .    Apple   overflow-,      ,   ,    .      ,   ,    ,   , ,   ,      . <br><br><img src="https://habrastorage.org/webt/nj/qc/s5/njqcs5ytnn4czeiumbsvwiqb3cu.png"><br><br>       ,   ,  .    -        : <br><br><pre><code class="javascript hljs">CoreBluetooth[WARNING] Unknown error: <span class="hljs-number"><span class="hljs-number">124</span></span></code> </pre> <br>  Yang terburuk adalah tidak ada metode delegasi yang dipanggil, kami bahkan tidak bisa mengalahkan kesalahan ini untuk pengguna.  Hanya pesan di log - dan diam, semuanya membeku.  Tidak ada perubahan besar yang dibuat, jadi kami mulai memutar kembali komitmen.  Dan mereka menemukan bahwa mereka pernah mengoptimalkan kode dan mengubah cara penulisan data.  Masalahnya adalah bahwa tidak semua klien diperbarui, sehingga kesalahan ini terjadi. <br><br><pre> <code class="javascript hljs">.write != .writeWithoutResponse</code> </pre> <br>  Kami, senang bahwa kami telah memperbaiki segalanya, berlari untuk mengujinya, dan mereka segera kembali kepada kami: “Foto mode Anda tidak berfungsi.  Mereka semua kekurangan muatan. ”  Kami mulai mencoba, dan memang benar bahwa kadang-kadang, pada perangkat yang berbeda, foto yang rusak datang pada waktu yang berbeda.  Mereka mulai mencari alasan. <br><br>  Dan lagi-lagi mereka melihat kesalahan sebelumnya.  Segera mengira itu dalam versi yang berbeda.  Tetapi setelah penghapusan lengkap versi lama dari semua perangkat uji, kesalahan masih terjadi.  Kami sedih ... <br><br><pre> <code class="javascript hljs">CoreBluetooth[WARNING] Unknown error: <span class="hljs-number"><span class="hljs-number">722</span></span> CoreBluetooth[WARNING] Unknown error: <span class="hljs-number"><span class="hljs-number">249</span></span> CoreBluetooth[WARNING] Unknown error: <span class="hljs-number"><span class="hljs-number">312</span></span></code> </pre> <br>  Kami mulai mencari alat debugging.  Hal pertama yang kami temui adalah Apple Bluetooth Explorer.  Program yang kuat, dapat melakukan banyak hal, tetapi untuk debugging protokol Bluetooth LE, ada satu tab kecil dengan pencarian perangkat dan mendapatkan karakteristik.  Dan kami perlu menganalisis L2CAP. <br><br>  Kemudian mereka menemukan LightBlue Explorer.  Itu ternyata menjadi program yang cukup baik, meskipun dengan desain dari iOS 7. Ini dapat melakukan hal yang sama seperti Bluetooth Explorer, dan juga tahu cara berlangganan spesifikasi.  Dan itu bekerja lebih stabil.  Semuanya baik-baik saja, tetapi sekali lagi tanpa L2CAP. <br><br>  Dan kemudian kami teringat sniffer WireShark yang terkenal. <br><br>  Ternyata dia akrab dengan Bluetooth LE: dia bisa membaca L2CAP, tetapi hanya di bawah Windows.  Meskipun tidak menakutkan bahwa kami tidak akan menemukan Windows atau sesuatu.  Minus terbesar - program hanya bekerja dengan perangkat tertentu.  Artinya, Anda harus menemukan perangkat di suatu tempat di toko resmi.  Dan Anda sendiri mengerti bahwa perusahaan besar tidak akan menyetujui pembelian perangkat yang tidak dapat dipahami di pasar loak.  Kami bahkan mulai menjelajahi toko online luar negeri. <br><br>  Tetapi di sini mereka menemukan program PacketLogger di Alat Xcode Tambahan.  Ini memungkinkan Anda untuk menonton lalu lintas yang terjadi pada perangkat OS X.  Mengapa tidak menulis ulang MoneyDrop kami di bawah OS X?  Kami sudah memiliki perpustakaan terpisah.  Kami baru saja mengganti UIImage dengan NSImage, semuanya dimulai setelah 10 menit. <br><br><img src="https://habrastorage.org/webt/vm/tn/z3/vmtnz3yw28-g7zsb8-cf6nldt6o.png"><br><br>  Akhirnya, kita bisa membaca paket yang dipertukarkan antar perangkat.  Segera menjadi jelas bahwa pada saat pengiriman data melalui L2CAP salah satu karakteristik dicatat.  Dan karena fakta bahwa saluran itu benar-benar sibuk dengan transfer foto, iOS mengabaikan rekaman tersebut, dan pengirimnya setelah diabaikan memecah saluran.  Setelah memperbaiki masalah dengan transfer foto tidak. <br><br><img src="https://habrastorage.org/webt/ig/gw/sn/iggwsno_4bqfunmdzy0pigsn77i.png"><br><br>  Itu saja, terima kasih sudah membaca :) <br><br><h3>  <b>Tautan yang bermanfaat</b> </h3><br>  <b>WWDC / CoreBluetooth:</b> <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://developer.apple.com/videos/play/wwdc2017/712/</a> </li><li>  WWDC 2012 Sesi 703 Core Bluetooth 101 </li><li>  WWDC 2012 Sesi 705 Advanced Core Bluetooth </li></ul><br>  <b>Bluetooth</b> <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://www.bluetooth.com/specifications/gatt</a> </li><li>  Memulai dengan O'Reilly Bluetooth Rendah Energi </li></ul><br>  <b>YouTube</b> <br><br><ul><li>  Arrow Electronics → Seri Bluetooth Low Energy </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id452278/">https://habr.com/ru/post/id452278/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id452266/index.html">Rak Tanpa Server</a></li>
<li><a href="../id452268/index.html">C # WPF analogue Window.ShowDialog () atau berurusan dengan DispatcherFrame</a></li>
<li><a href="../id452270/index.html">Dokumentasi Xamarin API sekarang tersedia untuk umum</a></li>
<li><a href="../id452272/index.html">Gadis di bawah air terjun</a></li>
<li><a href="../id452276/index.html">Rekayasa Terbalik Klien Dropbox</a></li>
<li><a href="../id452280/index.html">PostgreSQL 11: Evolusi partisi dari Postgres 9.6 ke Postgres 11</a></li>
<li><a href="../id452282/index.html">Dasar, Watson: Anda berintegrasi dengan Voximplant</a></li>
<li><a href="../id452284/index.html">Klasifikasi tutupan lahan menggunakan eo-learning. Bagian 1</a></li>
<li><a href="../id452288/index.html">Situasi: operator seluler AS dituduh melakukan perdagangan ilegal di geodata pelanggan</a></li>
<li><a href="../id452290/index.html">Apa yang dirindukan peretas saat merusak bank di hari PHD</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>