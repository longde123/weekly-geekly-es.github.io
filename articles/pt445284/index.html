<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üí∞ üë®‚Äçüë¶ ‚ô¶Ô∏è An√°lise do produto ClickHouse üåΩ üõ≥Ô∏è üëºüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ao desenvolver qualquer produto, seja um servi√ßo de v√≠deo ou uma fita, hist√≥rias ou artigos, desejo medir a "felicidade" condicional do usu√°rio. Para ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>An√°lise do produto ClickHouse</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/vk/blog/445284/"><img src="https://habrastorage.org/webt/0f/oi/nf/0foinfaynjgjrh11h6w55fr5510.jpeg"><br><br>  Ao desenvolver qualquer produto, seja um servi√ßo de v√≠deo ou uma fita, hist√≥rias ou artigos, desejo medir a "felicidade" condicional do usu√°rio.  Para entender se estamos fazendo nossas altera√ß√µes melhores ou piores, para ajustar a dire√ß√£o do desenvolvimento do produto, confiando n√£o na intui√ß√£o e em nossos pr√≥prios sentimentos, mas nas m√©tricas e n√∫meros em que voc√™ pode acreditar. <br><br>  Neste artigo, mostrarei como conseguimos lan√ßar estat√≠sticas e an√°lises de produtos em um servi√ßo com um p√∫blico de 97 milh√µes de meses, enquanto receb√≠amos consultas anal√≠ticas de desempenho extremamente alto.  Falaremos sobre o ClickHouse, os mecanismos usados ‚Äã‚Äãe os recursos das consultas.  Descreverei uma abordagem para agrega√ß√£o de dados, que nos permite obter m√©tricas complexas em uma fra√ß√£o de segundo e falar sobre convers√£o e teste de dados. <br><br>  Agora, temos cerca de 6 bilh√µes de eventos alimentares por dia; em um futuro pr√≥ximo, chegaremos a 20-25 bilh√µes.  E ent√£o - n√£o em um ritmo t√£o r√°pido, subiremos para 40-50 bilh√µes at√© o final do ano, quando descrevermos todos os eventos alimentares que nos interessam. <br><br>  <b>1 linhas em conjunto.</b>  <b>Decorrido: 0,287 seg.</b>  <b>Processado 59,85 bilh√µes de linhas, 59,85 GB (208,16 bilh√µes de linhas / s., 208,16 GB / s.)</b> <br><br>  Detalhes sob o corte. <br><a name="habracut"></a><br><h1>  Pref√°cio </h1><br>  As ferramentas anal√≠ticas foram VKontakte antes.  Usu√°rios √∫nicos foram considerados, foi poss√≠vel criar agendas de eventos por fatias e, assim, cair nas profundezas do servi√ßo.  No entanto, tratava-se de fatias fixas antecipadamente, de dados agregados, de HLL para os √∫nicos, de alguma rigidez e incapacidade de responder rapidamente a perguntas um pouco mais complicadas do que "quanto?" <br><br>  √â claro que havia, existe e ser√° hadoop, tamb√©m foi escrito, escrito e ser√° escrito muito, muitos logs de uso de servi√ßos.  Infelizmente, o hdfs foi usado apenas por algumas equipes para implementar suas pr√≥prias tarefas.  Mais triste ainda, o hdfs n√£o se refere a consultas anal√≠ticas r√°pidas: havia perguntas para muitos campos, cujas respostas precisavam ser encontradas no c√≥digo e n√£o na documenta√ß√£o acess√≠vel a todos. <br><br>  Chegamos √† conclus√£o de que n√£o √© mais poss√≠vel viver assim.  Cada equipe deve ter dados, as consultas sobre eles devem ser r√°pidas e os dados em si devem ser precisos e ricos em par√¢metros √∫teis. <br><br>  Portanto, formulamos requisitos claros para o novo sistema de estat√≠stica / an√°lise: <br><br><ul><li>  as consultas anal√≠ticas devem ser r√°pidas; </li><li>  os dados s√£o bastante precisos; idealmente, esses s√£o eventos brutos de intera√ß√£o do usu√°rio com o servi√ßo; </li><li>  a estrutura dos eventos deve ser descrita, compreendida e acess√≠vel; </li><li>  armazenamento de dados confi√°vel, garantia de entrega √∫nica; </li><li>  √© poss√≠vel contar os √∫nicos, o p√∫blico (di√°rio, semanal, mensal), m√©tricas de reten√ß√£o, tempo gasto pelo usu√°rio no servi√ßo, a√ß√µes quantificadas em m√©tricas √∫nicas e outras pelo conjunto de fatias; </li><li>  testes, convers√£o e visualiza√ß√£o de dados est√£o em andamento. </li></ul><br><h1>  Na cozinha </h1><br>  A experi√™ncia sugeriu que precis√°vamos de dois bancos de dados: um lento, onde agregar√≠amos e enriquecer√≠amos os dados, e um r√°pido, onde poder√≠amos trabalhar com esses dados e criar gr√°ficos sobre eles.  Essa √© uma das abordagens mais comuns, nas quais, em um banco de dados lento, por exemplo, em hdfs, s√£o projetadas diferentes proje√ß√µes - √∫nicas e no n√∫mero de eventos por fatias por um determinado per√≠odo de tempo. <br><br>  Em um dia quente de setembro, enquanto convers√°vamos sobre uma x√≠cara de ch√° na cozinha com vista para a Catedral de Kazan, tivemos a ideia de experimentar o ClickHouse como uma base r√°pida - naquela √©poca, j√° o usamos para armazenar registros t√©cnicos.  Havia muitas d√∫vidas relacionadas principalmente √† velocidade e √† confiabilidade: os testes de desempenho declarados pareciam irreais e as novas vers√µes do banco de dados interrompiam periodicamente a funcionalidade existente.  Portanto, a proposta era simples - para tentar. <br><br><h1>  Primeiras amostras </h1><br>  Implementamos um cluster de duas m√°quinas com esta configura√ß√£o: <br>  2xE5-2620 v4 (32 n√∫cleos no total), RAM de 256G, locais de 28T (raid10 com ext4). <br><br>  Inicialmente, estava perto do layout, mas depois mudamos para longe.  O ClickHouse possui muitos mecanismos de tabela diferentes, mas os principais s√£o da fam√≠lia MergeTree.  Escolhemos ReplicatedReplacingMergeTree com aproximadamente as seguintes configura√ß√µes: <br><br><pre><code class="sql hljs">PARTITION BY dt ORDER BY (toStartOfHour(time), cityHash64(user_id), event_microsec, event_id) SAMPLE BY cityHash64(user_id) SETTINGS index_granularity = 8192;</code> </pre> <br>  <b>Replicado</b> - significa que a tabela √© replicada e isso resolve um dos nossos requisitos de confiabilidade. <br><br>  <b>Substituindo</b> - a tabela suporta desduplica√ß√£o pela chave prim√°ria: por padr√£o, a chave prim√°ria corresponde √† chave de classifica√ß√£o; portanto, a se√ß√£o ORDER BY apenas informa qual √© a chave prim√°ria. <br><br>  <b>AMOSTRA POR</b> - Eu tamb√©m queria experimentar a amostragem: a amostra retorna uma amostra uniformemente pseudo-aleat√≥ria. <br><br>  <b>index_granularity = 8192</b> √© o n√∫mero m√°gico de linhas de dados entre serifs de √≠ndice (sim, √© escasso), que √© usado por padr√£o.  N√≥s n√£o mudamos isso. <br><br>  O particionamento foi realizado por dia (embora por padr√£o - por m√™s).  Muitos pedidos de dados deveriam ser intradi√°rios - por exemplo, crie um gr√°fico minucioso de visualiza√ß√µes de v√≠deo para um determinado dia. <br><br>  Em seguida, pegamos um peda√ßo de registros t√©cnicos e enchemos a mesa com cerca de um bilh√£o de linhas.  Excelente compacta√ß√£o, agrupando por tipo de coluna Int *, contando valores √∫nicos - tudo funcionou incrivelmente r√°pido! <br><br>  Falando em velocidade, quero dizer que nem uma √∫nica solicita√ß√£o durou mais de 500 ms e a maioria se encaixava em 50 a 100 ms.  E isso ocorre em duas m√°quinas - e, de fato, apenas uma estava envolvida nos c√°lculos. <br><br>  Analisamos tudo isso e imaginamos que, em vez da coluna UInt8, haver√° um ID do pa√≠s e a coluna Int8 ser√° substitu√≠da por dados, por exemplo, sobre a idade do usu√°rio.  E eles perceberam que o ClickHouse √© completamente adequado para n√≥s, se tudo for feito corretamente. <br><br><h1>  Digita√ß√£o de dados forte </h1><br>  O benef√≠cio do ClickHouse come√ßa exatamente quando o esquema de dados correto √© formado.  Exemplo: plataforma String - ruim, plataforma Int8 + dicion√°rio - bom, LowCardinality (String) - conveniente e bom (falarei sobre LowCardinality um pouco mais tarde). <br><br>  Criamos uma classe de gerador especial em php, que, mediante solicita√ß√£o, cria classes de wrapper sobre eventos com base em tabelas no ClickHouse e um √∫nico ponto de entrada para o log.  Vou explicar o exemplo do esquema que acabou: <br><br><ol><li>  O analista / engenheiro de dados / desenvolvedor descreve a documenta√ß√£o: quais campos, poss√≠veis valores e eventos precisam ser registrados. </li><li>  Uma tabela √© criada no ClickHouse de acordo com a estrutura de dados do par√°grafo anterior. </li><li>  As classes de quebra autom√°tica para eventos baseados em uma tabela s√£o geradas. </li><li>  A equipe do produto implementa o preenchimento dos campos de um objeto desta classe, enviando. </li></ol><br>  Alterar o esquema no n√≠vel php e o tipo de dados registrados n√£o funcionar√° sem primeiro alterar a tabela no ClickHouse.  E isso, por sua vez, n√£o pode ser feito sem coordena√ß√£o com a equipe, altera√ß√µes na documenta√ß√£o e descri√ß√£o dos eventos. <br><br>  Para cada evento, voc√™ pode definir duas configura√ß√µes que controlam a porcentagem de eventos enviados ao ClickHouse e ao hadoop, respectivamente.  As configura√ß√µes s√£o necess√°rias principalmente para rolagem gradual, com a capacidade de reduzir o registro, se algo der errado.  Antes do hadoop, os dados s√£o entregues de maneira padr√£o usando o Kafka.  E no ClickHouse, eles passam por um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">esquema com o KittenHouse</a> no modo persistente, o que garante pelo menos uma entrega de evento √∫nico. <br><br>  O evento √© entregue √† tabela de buffer no shard desejado, com base no restante da divis√£o de algum hash de user_id pelo n√∫mero de shards no cluster.  Em seguida, a tabela de buffer libera os dados para o ReplicatedReplacingMergeTree local.  E, al√©m das tabelas locais, uma tabela distribu√≠da √© puxada com o mecanismo Distributed, que permite acessar dados de todos os shards. <br><br><h1>  Desnormaliza√ß√£o </h1><br>  ClickHouse √© um DBMS colunar.  N√£o se trata de formul√°rios normais, o que significa que √© melhor ter todas as informa√ß√µes corretas no evento do que participar.  Tamb√©m h√° Join, mas se a tabela correta n√£o couber na mem√≥ria, a dor come√ßa.  Portanto, tomamos uma decis√£o obstinada: todas as informa√ß√µes em que estamos interessados ‚Äã‚Äãdevem ser armazenadas no pr√≥prio evento.  Por exemplo, sexo, idade do usu√°rio, pa√≠s, cidade, data de nascimento - todas essas informa√ß√µes p√∫blicas podem ser √∫teis para an√°lise de p√∫blico-alvo, bem como todas as informa√ß√µes √∫teis sobre o objeto de intera√ß√£o.  Se, por exemplo, estamos falando de v√≠deo, √© video_id, video_owner_id, data de upload do v√≠deo, dura√ß√£o, qualidade no momento do evento, qualidade m√°xima e assim por diante. <br><br>  No total, em cada tabela, temos de 50 a 200 colunas, enquanto em todas as tabelas existem campos de servi√ßo.  Por exemplo, o log de erros √© error_log - na verdade, chamamos um erro fora do intervalo do tipo.  Caso valores estranhos ultrapassem o tamanho do tipo no campo com a idade. <br><br><h2>  Tipo Baixa Cardinalidade (T) </h2><br>  ClickHouse tem a capacidade de usar dicion√°rios externos.  Eles s√£o armazenados na mem√≥ria, atualizados periodicamente, podem ser efetivamente usados ‚Äã‚Äãem v√°rios cen√°rios, inclusive como livros de refer√™ncia cl√°ssicos.  Por exemplo, voc√™ deseja registrar o sistema operacional e tem duas alternativas: uma sequ√™ncia ou um n√∫mero + um diret√≥rio.  Obviamente, em grandes quantidades de dados e para consultas anal√≠ticas de alto desempenho, √© l√≥gico escrever um n√∫mero e obter uma representa√ß√£o de string do dicion√°rio quando voc√™ precisar: <br><br><pre> <code class="sql hljs">dictGetString('os', 'os_name', toUInt64(os_id))</code> </pre> <br>  Mas h√° uma maneira muito mais conveniente - usar o tipo LowCardinality (String), que cria automaticamente um dicion√°rio.  O desempenho com LowCardinality sob a condi√ß√£o de baixa cardinalidade do conjunto de valores √© radicalmente mais alto que com String. <br><br>  Por exemplo, usamos LowCardinality (String) para os tipos de evento 'play', 'pause', 'rewind'.  Ou para a plataforma: 'web', 'android', 'iphone': <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> vk_platform, <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> t <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> dt = yesterday() <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> vk_platform Elapsed: <span class="hljs-number"><span class="hljs-number">0.145</span></span> sec. Processed <span class="hljs-number"><span class="hljs-number">1.98</span></span> billion <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>, <span class="hljs-number"><span class="hljs-number">5.96</span></span> GB (<span class="hljs-number"><span class="hljs-number">13.65</span></span> billion <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>/s., <span class="hljs-number"><span class="hljs-number">41.04</span></span> GB/s.)</code> </pre> <br>  O recurso ainda √© experimental, portanto, para us√°-lo, voc√™ deve executar: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> allow_experimental_low_cardinality_type = <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> <br>  Mas h√° um sentimento de que, depois de algum tempo, ela n√£o estar√° mais no cen√°rio. <br><br><h1>  Agrega√ß√£o de dados VKontakte </h1><br>  Como existem muitas colunas e muitos eventos, o desejo natural √© cortar as parti√ß√µes ‚Äúantigas‚Äù, mas primeiro - montar as unidades.  Ocasionalmente, √© necess√°rio analisar eventos brutos (um m√™s ou um ano atr√°s), para n√£o cortar os dados em hdfs - qualquer analista pode entrar em contato com o parquet desejado para qualquer data. <br><br>  Como regra, ao agregar em um intervalo de tempo, sempre nos baseamos no fato de que o n√∫mero de linhas por unidade de tempo √© igual ao produto da pot√™ncia de corte.  Isso imp√µe restri√ß√µes: os pa√≠ses come√ßam a se reunir em grupos como 'R√∫ssia', '√Åsia', 'Europa', 'O resto do mundo' e idades - em intervalos, para reduzir a dimens√£o a um milh√£o de linhas condicionais por data. <br><br><h2>  Agrega√ß√£o por <b>dt, user_id</b> </h2><br>  Mas temos um ClickHouse reativo!  Podemos acelerar para 50 a 100 milh√µes de linhas em uma data? <br>  Testes r√°pidos mostraram que podemos e, nesse momento, surgiu uma id√©ia simples - deixar o usu√°rio na m√°quina.  Nomeadamente, agregar n√£o por "data, fatias" usando ferramentas spark, mas por "data, usu√°rio" significa ClickHouse, enquanto realiza alguma "transposi√ß√£o" de dados. <br><br>  Com essa abordagem, armazenamos os usu√°rios em dados agregados, o que significa que ainda podemos considerar indicadores de p√∫blico, m√©tricas de reten√ß√£o e frequ√™ncia.  Podemos conectar unidades, contando o p√∫blico comum de v√°rios servi√ßos at√© todo o p√∫blico VKontakte.  Tudo isso pode ser feito por qualquer fatia presente na tabela pelo mesmo tempo, condicionalmente. <br><br>  Ilustrarei com um exemplo: <br><br><img src="https://habrastorage.org/webt/1n/zq/23/1nzq23ia7micv91mecw0kqzxgrm.jpeg"><br><br>  Ap√≥s a agrega√ß√£o (muitas mais colunas √† direita): <br><br><img src="https://habrastorage.org/webt/nx/ol/xl/nxolxl2vmnnlsxlx6svuaklh9go.jpeg"><br><br>  Nesse caso, a agrega√ß√£o ocorre precisamente por (dt, user_id).  Para campos com informa√ß√µes do usu√°rio, com essa agrega√ß√£o, voc√™ pode usar as fun√ß√µes any, anyHeavy (seleciona um valor que ocorre com frequ√™ncia).  Voc√™ pode, por exemplo, coletar qualquer Heavy (plataforma) em um agregado para saber qual plataforma o usu√°rio est√° usando na maior parte dos eventos de v√≠deo.  Se desejar, voc√™ pode usar groupUniqArray (plataforma) e armazenar uma matriz de todas as plataformas das quais o usu√°rio gerou o evento.  Se isso n√£o for suficiente, voc√™ poder√° criar colunas separadas para a plataforma e armazenar, por exemplo, o n√∫mero de v√≠deos exclusivos exibidos pela metade a partir de uma plataforma espec√≠fica: <br><br><pre> <code class="sql hljs">uniqCombinedIf(cityHash64(video_owner_id, video_id), (platform = 'android') AND (event = '50p')) as uniq_videos_50p_android</code> </pre> <br>  Com essa abordagem, √© obtido um agregado bastante amplo, no qual cada linha √© um usu√°rio √∫nico e cada coluna cont√©m informa√ß√µes sobre o usu√°rio ou sobre sua intera√ß√£o com o servi√ßo. <br><br>  Acontece que, para calcular a DAU de um servi√ßo, basta executar essa solicita√ß√£o al√©m de seu agregado: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> dt, <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DAU <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> agg <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> dt Elapsed: <span class="hljs-number"><span class="hljs-number">0.078</span></span> sec.</code> </pre> <br>  Ou calcule quantos dias os usu√°rios estavam no servi√ßo da semana: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> days_in_service, <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> uniques <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> uniqUpTo(<span class="hljs-number"><span class="hljs-number">7</span></span>)(dt) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> days_in_service <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> agg2 <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> dt &gt; (yesterday() - <span class="hljs-number"><span class="hljs-number">7</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> user_id ) <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> days_in_service <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> days_in_service <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> set. Elapsed: <span class="hljs-number"><span class="hljs-number">2.922</span></span> sec.</code> </pre> <br>  Podemos acelerar por amostragem, enquanto quase sem perder a precis√£o: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> days_in_service, <span class="hljs-number"><span class="hljs-number">10</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> uniques <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> uniqUpTo(<span class="hljs-number"><span class="hljs-number">7</span></span>)(dt) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> days_in_service <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> agg2 <span class="hljs-keyword"><span class="hljs-keyword">SAMPLE</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> / <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> dt &gt; (yesterday() - <span class="hljs-number"><span class="hljs-number">7</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> user_id ) <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> days_in_service <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> days_in_service <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> set. Elapsed: <span class="hljs-number"><span class="hljs-number">0.454</span></span> sec.</code> </pre> <br>  Deve-se notar imediatamente que a amostragem n√£o √© pela porcentagem de eventos, mas pela porcentagem de usu√°rios - e, como resultado, ela se torna uma ferramenta incrivelmente poderosa. <br><br>  Ou o mesmo por 4 semanas com amostragem de 1/100 - s√£o obtidos resultados cerca de 1% menos precisos. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> days_in_service, <span class="hljs-number"><span class="hljs-number">100</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> uniques <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> uniqUpTo(<span class="hljs-number"><span class="hljs-number">7</span></span>)(dt) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> days_in_service <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> agg2 <span class="hljs-keyword"><span class="hljs-keyword">SAMPLE</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> / <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> dt &gt; (yesterday() - <span class="hljs-number"><span class="hljs-number">28</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> user_id ) <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> days_in_service <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> days_in_service <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span> <span class="hljs-number"><span class="hljs-number">28</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> set. Elapsed: <span class="hljs-number"><span class="hljs-number">0.287</span></span> sec.</code> </pre> <br><h2>  Agrega√ß√£o, por outro lado </h2><br>  Ao agregar por (dt, user_id), n√£o perdemos o usu√°rio, n√£o perdemos informa√ß√µes sobre a intera√ß√£o dele com o servi√ßo, mas, √© claro, perdemos as m√©tricas sobre um objeto de intera√ß√£o espec√≠fico.  Mas voc√™ tamb√©m n√£o pode perder isso - vamos construir a unidade <br>  (dt, video_owner_id, video_id), aderindo √†s mesmas ideias.  Mantemos as informa√ß√µes sobre o v√≠deo o m√°ximo poss√≠vel, n√£o perdemos os dados sobre a intera√ß√£o do v√≠deo com o usu√°rio e perdemos completamente as informa√ß√µes sobre o usu√°rio espec√≠fico. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> starts <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> agg3 <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> (dt = yesterday()) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (video_id = ...) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (video_owner_id = ...) <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> set. Elapsed: <span class="hljs-number"><span class="hljs-number">0.030</span></span> sec</code> </pre> <br>  Ou as 10 principais visualiza√ß√µes de v√≠deo ontem: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> video_id, video_owner_id, watches <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> video_agg_video_d1 <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> dt = yesterday() <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> watches <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> set. Elapsed: <span class="hljs-number"><span class="hljs-number">0.035</span></span> sec.</code> </pre> <br>  Como resultado, temos um esquema de agregados no formato: <br><br><ul><li>  agrega√ß√£o por "data, usu√°rio" no produto; </li><li>  agrega√ß√£o por "data, objeto de intera√ß√£o" no produto; </li><li>  outras vezes surgem outras proje√ß√µes. </li></ul><br><h1>  Azkaban e TeamCity </h1><br>  Finalmente, algumas palavras sobre a infraestrutura.  Nossa cole√ß√£o agregada come√ßa √† noite, come√ßando com OPTIMIZE em cada uma das tabelas com dados brutos para acionar uma mesclagem extraordin√°ria de dados no ReplicatedReplacingMergeTree.  A opera√ß√£o pode durar o suficiente, no entanto, √© necess√°rio remover as tomadas, se elas ocorrerem.  Vale a pena notar que at√© agora nunca encontrei duplicatas, mas n√£o h√° garantias de que elas n√£o aparecer√£o no futuro. <br><br>  O pr√≥ximo passo √© a cria√ß√£o de agregados.  Estes s√£o scripts bash nos quais ocorre o seguinte: <br><br><ul><li>  primeiro obtemos o n√∫mero de shards e alguns hosts do shard: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> shard_num, <span class="hljs-keyword"><span class="hljs-keyword">any</span></span>(host_name) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> host <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> system.clusters <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> shard_num</code> </pre> </li><li>  o script executa sequencialmente para cada shard (clickhouse-client -h $ host) uma solicita√ß√£o do formul√°rio (para agregados de usu√°rios): <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">SAMPLE</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>/$shards_count <span class="hljs-keyword"><span class="hljs-keyword">OFFSET</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>/$shard_num</code> </pre> </li></ul><br>  Isso n√£o √© totalmente ideal e pode gerar muita intera√ß√£o de rede entre hosts.  No entanto, ao adicionar novos shards, tudo continua funcionando, a localidade dos dados para as unidades √© mantida, por isso decidimos n√£o nos preocupar muito com isso. <br><br>  Temos Azkaban como agendador de tarefas.  Eu n√£o diria que essa √© uma ferramenta super conveniente, mas lida com sua tarefa perfeitamente, inclusive quando se trata de construir pipelines um pouco mais complexos e quando um script precisa esperar que v√°rios outros sejam conclu√≠dos. <br><br>  O tempo total gasto na convers√£o dos eventos agora existentes em agregados √© de 15 minutos. <br><br><h2>  Teste </h2><br>  Todas as manh√£s realizamos testes automatizados que respondem a perguntas sobre dados brutos, bem como √† prontid√£o e qualidade dos agregados: ‚ÄúVerifique se ontem houve menos de meio por cento menos dados ou dados exclusivos sobre dados brutos ou agregados comparado ao mesmo dia da semana passada. " <br><br>  Tecnologicamente, esses s√£o testes de unidade comuns usando JUnit e implementando o driver jdbc para ClickHouse.  A execu√ß√£o de todos os testes √© iniciada no TeamCity e leva cerca de 30 segundos em um thread. Em caso de falhas, recebemos notifica√ß√µes do VKontakte do nosso maravilhoso bot do TeamCity. <br><br><h1>  Conclus√£o </h1><br>  Use apenas vers√µes est√°veis ‚Äã‚Äãdo ClickHouse e seu cabelo ficar√° macio e sedoso.  Vale acrescentar que o <b><i>ClickHouse n√£o fica mais lento</i></b> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt445284/">https://habr.com/ru/post/pt445284/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt445272/index.html">JavaScript √© a melhor linguagem de programa√ß√£o para iniciantes. Ent√£o √© ou n√£o?</a></li>
<li><a href="../pt445274/index.html">Quando "Zo√´"! == "Zo√´", ou por que voc√™ precisa normalizar seq√º√™ncias de caracteres Unicode</a></li>
<li><a href="../pt445276/index.html">Guia completo de UseEffect</a></li>
<li><a href="../pt445278/index.html">Como criar um jogo se voc√™ nunca √© um artista</a></li>
<li><a href="../pt445280/index.html">Rentabilidade de sites e servi√ßos</a></li>
<li><a href="../pt445286/index.html">Apoio para os p√©s para o c√©rebro: Hedera Hashgraph Distributed Registry Platform</a></li>
<li><a href="../pt445288/index.html">Todos os seus empr√©stimos ao consumidor e dados pessoais "em um s√≥ lugar" ...</a></li>
<li><a href="../pt445290/index.html">Como implementar processos unificados, levando em considera√ß√£o todos os recursos da empresa?</a></li>
<li><a href="../pt445292/index.html">O que nunca me disseram sobre CSS</a></li>
<li><a href="../pt445294/index.html">E, novamente, sobre o segundo monitor do tablet ...</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>