<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧗🏿 🚲 👌🏻 Stack ELK untuk menyimpan log aplikasi Django ♏️ 🌌 👷🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Setiap proyek yang melampaui tahap prototipe perlu mengatur penebangan. Penebangan yang tepat memecahkan banyak masalah dan membantu untuk memahami st...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Stack ELK untuk menyimpan log aplikasi Django</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/421819/"><p>  Setiap proyek yang melampaui tahap prototipe perlu mengatur penebangan.  Penebangan yang tepat memecahkan banyak masalah dan membantu untuk memahami status proyek.  Pada tahap awal, masuk ke file cocok untuk saya sampai proyek tumbuh dan pencarian dengan log tidak mulai memakan waktu. </p><br><p>  Solusinya adalah membuat repositori log terpusat dengan agregasi log dan pencarian.  Pilihannya jatuh pada tumpukan ELK.  ELK adalah kombinasi dari tiga proyek OpenSource: ElasticSearch, Logstash dan Kibana.  ELK menyimpan log, membuat grafik, dan ada dukungan untuk pencarian teks lengkap dengan filter.  Artikel ini menjelaskan proses pengaturan tumpukan ELK untuk menyimpan log aplikasi Django. <a name="habracut"></a></p><br><h2 id="ustanovka-elk">  Instalasi RUSA </h2><br><p>  Docker akan digunakan untuk menginstal tumpukan ELK, berdasarkan repositori <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">docker-elk</a> .  Ubah pengaturan Logstash, tambahkan pola GROK untuk mencocokkan log nginx dan mengubah bagian output sehingga log aplikasi Django dan log nginx disimpan dalam indeks ElasticSearch yang berbeda.  Hasilnya, logstash.conf terlihat seperti ini: </p><br><pre><code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">input</span></span> { beats { port =&gt; <span class="hljs-number"><span class="hljs-number">5000</span></span> host =&gt; <span class="hljs-string"><span class="hljs-string">"0.0.0.0"</span></span> } } filter { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class">] == "nginx" { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">grok</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">match</span></span></span><span class="hljs-class"> =&gt; { "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">message</span></span></span><span class="hljs-class">" =&gt; "%{</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IPORHOST</span></span></span><span class="hljs-class">:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">remote_ip</span></span></span><span class="hljs-class">} - %{</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DATA</span></span></span><span class="hljs-class">:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user_name</span></span></span><span class="hljs-class">} \[%{</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HTTPDATE</span></span></span><span class="hljs-class">:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">access_time</span></span></span><span class="hljs-class">}\] \"%{</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WORD</span></span></span><span class="hljs-class">:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">http_method</span></span></span><span class="hljs-class">} %{</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DATA</span></span></span><span class="hljs-class">:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">url</span></span></span><span class="hljs-class">} </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HTTP</span></span></span><span class="hljs-class">/%{</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NUMBER</span></span></span><span class="hljs-class">:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">http_version</span></span></span><span class="hljs-class">}\" %{</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NUMBER</span></span></span><span class="hljs-class">:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">response_code</span></span></span><span class="hljs-class">} %{</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NUMBER</span></span></span><span class="hljs-class">:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">body_sent_bytes</span></span></span><span class="hljs-class">} \"%{</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DATA</span></span></span><span class="hljs-class">:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">referrer</span></span></span><span class="hljs-class">}\" \"%{</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DATA</span></span></span><span class="hljs-class">:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">agent</span></span></span><span class="hljs-class">}\"" } } } } output { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> [</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class">] == "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nginx</span></span></span><span class="hljs-class">" { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">elasticsearch</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hosts</span></span></span><span class="hljs-class"> =&gt; "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">elasticsearch</span></span></span><span class="hljs-class">:9200" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">index</span></span></span><span class="hljs-class"> =&gt; "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nginx</span></span></span><span class="hljs-class">-%{+</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">YYYY</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MM</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dd</span></span></span><span class="hljs-class">}" } } else if [</span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class">] == "django" { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">elasticsearch</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hosts</span></span></span><span class="hljs-class"> =&gt; "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">elasticsearch</span></span></span><span class="hljs-class">:9200" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">index</span></span></span><span class="hljs-class"> =&gt; "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">django</span></span></span><span class="hljs-class">-%{+</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">YYYY</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MM</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dd</span></span></span><span class="hljs-class">}" } } else { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">elasticsearch</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hosts</span></span></span><span class="hljs-class"> =&gt; "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">elasticsearch</span></span></span><span class="hljs-class">:9200" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">index</span></span></span><span class="hljs-class"> =&gt; "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unknown_messages</span></span></span><span class="hljs-class">" } } }</span></span></code> </pre> <br><p>  Setelah melakukan perubahan, jalankan tumpukan: </p><br><pre> <code class="hljs powershell">docker<span class="hljs-literal"><span class="hljs-literal">-compose</span></span> up</code> </pre> <br><p>  Setelah memulai, tumpukan mendengarkan pada port berikut: </p><br><ul><li>  5000: Logstash input TCP. </li><li>  9200: HTTP Elasticsearch </li><li>  9300: Transportasi TCP Elasticsearch </li><li>  5601: Kibana </li></ul><br><h2 id="arhitektura-logirovaniya">  Arsitektur Penebangan </h2><br><p>  Pertimbangkan arsitektur logging dari aplikasi Django. </p><br><p><img src="https://habrastorage.org/webt/3u/sd/-i/3usd-ipwvef2bdmnh_nqhozsdv4.png" alt="gambar"></p><br><p>  Seperti yang dapat Anda lihat dari diagram, aplikasi terdiri dari layanan: nginx, aplikasi Django, pekerja seledri.  Setiap layanan mengirim log ke tumpukan ELK.  Pertimbangkan untuk mengkonfigurasi setiap layanan secara individual. </p><br><h2 id="zapis-nginx-logov-v-elk">  Menulis Log Nginx ke ELK </h2><br><p>  Untuk bekerja dengan log nginx, layanan Filebeat tambahan diperlukan.  Proses instalasi untuk Filebeat dijelaskan secara rinci di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">situs web resmi</a> .  Contoh menginstal layanan Filebeat di server Ubuntu: </p><br><pre> <code class="hljs powershell">curl <span class="hljs-literal"><span class="hljs-literal">-L</span></span> <span class="hljs-literal"><span class="hljs-literal">-O</span></span> https://artifacts.elastic.co/downloads/beats/filebeat/filebeat<span class="hljs-literal"><span class="hljs-literal">-6</span></span>.<span class="hljs-number"><span class="hljs-number">4.0</span></span><span class="hljs-literal"><span class="hljs-literal">-amd64</span></span>.deb sudo dpkg <span class="hljs-literal"><span class="hljs-literal">-i</span></span> filebeat<span class="hljs-literal"><span class="hljs-literal">-6</span></span>.<span class="hljs-number"><span class="hljs-number">4.0</span></span><span class="hljs-literal"><span class="hljs-literal">-amd64</span></span>.deb</code> </pre> <br><p>  Filebeat akan membaca log dari file dan mengirim ke Logstash.  Contoh Konfigurasi: </p><br><pre> <code class="hljs pgsql">filebeat.inputs: - <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">log</span></span> enabled: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> paths: - /var/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/nginx/<span class="hljs-keyword"><span class="hljs-keyword">access</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> fields: <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: nginx fields_under_root: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> scan_frequency: <span class="hljs-number"><span class="hljs-number">5</span></span>s output.logstash: hosts: ["logstash:5000"]</code> </pre> <br><p>  Kami meluncurkan layanan Filebeat kami dan mengamati tampilan log di Kibana. </p><br><h2 id="zapis-django-logov-v-elk">  Menulis Django Log dalam ELK </h2><br><p>  Agar Django berinteraksi dengan layanan Logstash, instal <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">paket Python-logstash</a> opsional. </p><br><pre> <code class="hljs sql">pip <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> python-logstash</code> </pre> <br><p>  Mari kita ubah pengaturan aplikasi Django sehingga log dikirim ke layanan Logstash. </p><br><pre> <code class="hljs scala"><span class="hljs-type"><span class="hljs-type">LOGGING</span></span> = { <span class="hljs-symbol"><span class="hljs-symbol">'versio</span></span>n': <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">'disable_existing_logger</span></span>s': <span class="hljs-type"><span class="hljs-type">False</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">'formatter</span></span>s': { <span class="hljs-symbol"><span class="hljs-symbol">'simpl</span></span>e': { <span class="hljs-symbol"><span class="hljs-symbol">'forma</span></span>t': <span class="hljs-symbol"><span class="hljs-symbol">'velname</span></span>)s %(message)s' }, }, <span class="hljs-symbol"><span class="hljs-symbol">'handler</span></span>s': { <span class="hljs-symbol"><span class="hljs-symbol">'consol</span></span>e': { <span class="hljs-symbol"><span class="hljs-symbol">'leve</span></span>l': <span class="hljs-symbol"><span class="hljs-symbol">'INF</span></span>O', <span class="hljs-symbol"><span class="hljs-symbol">'clas</span></span>s': <span class="hljs-symbol"><span class="hljs-symbol">'logging</span></span>.<span class="hljs-type"><span class="hljs-type">StreamHandler</span></span>', <span class="hljs-symbol"><span class="hljs-symbol">'formatte</span></span>r': <span class="hljs-symbol"><span class="hljs-symbol">'simpl</span></span>e' }, <span class="hljs-symbol"><span class="hljs-symbol">'logstas</span></span>h': { <span class="hljs-symbol"><span class="hljs-symbol">'leve</span></span>l': <span class="hljs-symbol"><span class="hljs-symbol">'INF</span></span>O', <span class="hljs-symbol"><span class="hljs-symbol">'clas</span></span>s': <span class="hljs-symbol"><span class="hljs-symbol">'logstash</span></span>.<span class="hljs-type"><span class="hljs-type">TCPLogstashHandler</span></span>', <span class="hljs-symbol"><span class="hljs-symbol">'hos</span></span>t': <span class="hljs-symbol"><span class="hljs-symbol">'logstas</span></span>h', <span class="hljs-symbol"><span class="hljs-symbol">'por</span></span>t': <span class="hljs-number"><span class="hljs-number">5000</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">'versio</span></span>n': <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">'message_typ</span></span>e': <span class="hljs-symbol"><span class="hljs-symbol">'djang</span></span>o', # <span class="hljs-symbol"><span class="hljs-symbol">'typ</span></span>e'   logstash . <span class="hljs-symbol"><span class="hljs-symbol">'fqd</span></span>n': <span class="hljs-type"><span class="hljs-type">False</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">'tag</span></span>s': [<span class="hljs-symbol"><span class="hljs-symbol">'djang</span></span>o'], #  . }, }, <span class="hljs-symbol"><span class="hljs-symbol">'logger</span></span>s': { <span class="hljs-symbol"><span class="hljs-symbol">'django</span></span>.request': { <span class="hljs-symbol"><span class="hljs-symbol">'handler</span></span>s': [<span class="hljs-symbol"><span class="hljs-symbol">'logstas</span></span>h'], <span class="hljs-symbol"><span class="hljs-symbol">'leve</span></span>l': <span class="hljs-symbol"><span class="hljs-symbol">'INF</span></span>O', <span class="hljs-symbol"><span class="hljs-symbol">'propagat</span></span>e': <span class="hljs-type"><span class="hljs-type">True</span></span>, }, ... } }</code> </pre> <br><p>  Setelah itu, aplikasi akan mengirim log ke Logstash.  Contoh penggunaan: </p><br><pre> <code class="hljs python"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> logging logger = logging.getLogger(__name__) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_view</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request, arg1, arg)</span></span></span><span class="hljs-function">:</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> is_error: <span class="hljs-comment"><span class="hljs-comment">#    logger.error('Something went wrong!')</span></span></code> </pre> <br><p>  Setelah itu, konfigurasikan Kibana untuk diri Anda sendiri untuk menampilkan informasi yang diperlukan.  Contoh tangkapan layar pengaturan Anda sendiri: </p><br><p><img src="https://habrastorage.org/webt/13/by/h7/13byh7fdbinasgnqkjp5xzs4poe.png" alt="gambar"><br><img src="https://habrastorage.org/webt/dm/ri/wt/dmriwt3i7hsxtwmtrkyyf9e0inm.png" alt="gambar"><br><img src="https://habrastorage.org/webt/9h/1q/8f/9h1q8fodu60xzmhv31zsumj-pfy.png" alt="gambar"></p><br><p>  Sistem mengumpulkan log layanan, memungkinkan Anda dengan mudah mencarinya, membuat grafik dan visualisasi, memungkinkan Anda untuk dengan cepat mendeteksi dan memperbaiki masalah. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id421819/">https://habr.com/ru/post/id421819/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id421807/index.html">Ikut serta dalam pengujian publik layanan pencarian kerentanan situs web Positive Technologies</a></li>
<li><a href="../id421809/index.html">API Java EE Concurrency</a></li>
<li><a href="../id421811/index.html">IETF telah mengusulkan standar baru untuk pengiriman pesan - apa yang perlu Anda ketahui</a></li>
<li><a href="../id421815/index.html">Logam cair di laptop enam bulan kemudian</a></li>
<li><a href="../id421817/index.html">Bekerja dengan formulir di React.js menggunakan alat dasar</a></li>
<li><a href="../id421821/index.html">Kami menggunakan mosaik, pikselasi, dan topeng geometri Voronoi di shader untuk menghias situs</a></li>
<li><a href="../id421823/index.html">Bagaimana kami membawa X-Ray x64</a></li>
<li><a href="../id421827/index.html">Apa yang harus dibaca tentang Java sekarang?</a></li>
<li><a href="../id421829/index.html">Anomali Frango - romansa fantastis dengan orang-orang nyata dari IT</a></li>
<li><a href="../id421833/index.html">Kami menulis program kami yang paling sederhana untuk ARM Cortex-M3</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>