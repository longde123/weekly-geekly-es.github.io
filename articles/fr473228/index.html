<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§ô üëâüèΩ üë®üèæ‚Äçüé® Mettre Perl directement depuis 1987 üë©üèø‚Äçü§ù‚Äçüë®üèΩ üë®‚Äçüë©‚Äçüëß‚Äçüë¶ üó∫Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Apr√®s avoir lu la nouvelle " Code d'interpr√©teur Perl officiellement port√© sur GitHub " sur LINUX.ORG.RU, j'ai d√©cid√© de jeter un ≈ìil au r√©f√©rentiel P...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Mettre Perl directement depuis 1987</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/473228/"> Apr√®s avoir lu la nouvelle " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="Code d'interpr√©teur Perl officiellement port√© sur GitHub, actualit√© sur la ressource LINUX.ORG.RU">Code d'interpr√©teur Perl officiellement port√© sur GitHub</a> " sur LINUX.ORG.RU, j'ai d√©cid√© de jeter un ≈ìil au r√©f√©rentiel Perl 5, qui est d√©j√† sur GitHub. <br><br>  Il est incroyable de voir √† quel point ils l'ont transf√©r√© de mani√®re consid√©rable et qualitative, en pr√©servant non seulement absolument l'int√©gralit√© de l'histoire du projet pendant 32 ans, mais aussi des rapports de bogues (entr√©s dans les probl√®mes), des correctifs (entr√©s dans les PR), des versions et des branches.  L'inscription " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="Il y a 32 ans sur les fichiers source Perl, r√©f√©rentiel officiel Perl 5 GitHub.">il y a 32 ans</a> " √† c√¥t√© des dossiers provoque un sourire involontaire. <br><br>  Que faire d'autre en ce vendredi soir terne, quand la pluie et la neige bruissent d√©sagr√©ablement dans la rue et que tous les chemins sont embourb√©s dans la neige fondante d'automne?  C'est vrai, les yeux rouges!  Donc, pour des raisons d'exp√©rience et d'int√©r√™t, j'ai d√©cid√© de prendre et d'assembler l'ancien Perl sur une machine x86_64 moderne avec la derni√®re version de <strong>GCC 9.2.0 en</strong> tant que compilateur.  Un tel ancien code peut-il passer l'√©preuve du temps? <br><br><div style="text-align:center;"><img title="D√©monstration de twm, l'un des premiers gestionnaires de fen√™tres pour le syst√®me X Window, sur une distribution Arch Linux moderne." src="https://habrastorage.org/webt/-0/d5/wt/-0d5wtkg6ylqdd-h5g1hbtdiypi.png"></div><br>  <i>D√©monstration de <strong>twm</strong> , l'un des premiers gestionnaires de fen√™tres pour le syst√®me X Window, sur une distribution Arch Linux moderne.</i> <br><br>  Pour √™tre compl√®tement authentique et nekromantnenko, j'ai d√©ploy√© une machine virtuelle avec bare X et gestionnaire de fen√™tres <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="twm, page Wikipedia.">twm</a> , qui date √©galement de 1987.  Qui sait, peut-√™tre que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="Larry Wall, page Wikipedia.">Larry Wall a</a> √©crit son Perl en utilisant exactement <strong>twm</strong> , pour ainsi dire la <em>technologie de pointe de l'</em> √©poque.  La distribution utilis√©e est Arch Linux.  Tout simplement parce qu'il y a des choses utiles dans son r√©f√©rentiel qui ont √©t√© utiles plus tard.  Alors allons-y! <br><a name="habracut"></a><br><a name="article-content"></a><h2>  Contenu: </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">1. Pr√©paration de l'environnement</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">2. Configuration du code source</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">3. Erreurs de fichier de grammaire Yacc</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">4. Erreurs de compilation de code sur "C"</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">5. Correction de certaines erreurs D√©faut de segmentation</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">6. Pour r√©sumer</a> <br><br><a name="environment"></a><h2>  1. Pr√©paration de l'environnement </h2><br>  Tout d'abord, nous installons sur un syst√®me d'exploitation d√©ploy√© dans une machine virtuelle tous les utilitaires et compilateurs n√©cessaires pour assembler et √©diter le code source: <strong>gcc</strong> , <strong>make</strong> , <strong>vim</strong> , <strong>git</strong> , <strong>gdb</strong> , etc. Certains d'entre eux sont d√©j√† install√©s, tandis que d'autres sont disponibles dans le m√©ta-package <strong>base-devel</strong> , il doit √™tre install√© s'il n'est pas install√©.  Une fois l'environnement pr√™t √† l'action, nous obtenons une copie du code source Perl de 32 ans! <br><br><pre><code class="bash hljs">$ git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/Perl/perl5/ --depth=1 -b perl-1.0</code> </pre> <br>  Gr√¢ce aux fonctionnalit√©s de Git, nous n'avons pas besoin de faire glisser un tas de fichiers pour acc√©der √† la toute premi√®re version du projet: <br><br><pre> <code class="plaintext hljs">* commit 8d063cd8450e59ea1c611a2f4f5a21059a2804f1 (grafted, HEAD, tag: perl-1.0) Commit: Larry Wall &lt;lwall@jpl-devvax.jpl.nasa.gov&gt; CommitDate: Fri Dec 18 00:00:00 1987 +0000 a "replacement" for awk and sed</code> </pre><br>  Nous ne t√©l√©chargeons qu'une petite quantit√© de donn√©es et, par cons√©quent, le r√©f√©rentiel avec le code source de la premi√®re version de Perl ne prend que 150 Ko. <br><br>  √Ä cette √©poque sombre et dense, il n'y avait pas de choses √©l√©mentaires comme les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="GNU Autotools, page Wikipedia.">outils automatiques</a> ( <em>quelle b√©n√©diction!</em> ), Cependant, il y a un script <strong>Configure</strong> √† la racine du r√©f√©rentiel.  Quelle est la question?  Mais le fait est que Larry Wall est l'inventeur de ces scripts qui ont permis de g√©n√©rer des Makefiles pour les machines UNIX les plus vari√©es de l'√©poque.  Comme l'indique l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="Configurer le script, l'historique, la page Wikipedia.">article</a> Wikip√©dia sur les scripts du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="Configurer le script, l'historique, la page Wikipedia.">m√™me nom</a> , Larry Wall a fourni le fichier <strong>Configure</strong> avec certains de ses logiciels, par exemple, un lecteur de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="rn, Newsreader, page Wikipedia.">news rn</a> , trois ans avant d'√©crire Perl.  Par la suite, Perl n'a pas fait exception et un script d√©j√† ex√©cut√© sur de nombreuses machines a √©t√© utilis√© pour le construire.  Plus tard, d'autres d√©veloppeurs, par exemple des programmeurs de Trolltech, ont √©galement repris cette id√©e.  Ils ont utilis√© un script similaire pour configurer la construction de leur framework Qt, que beaucoup de gens confondent avec <strong>configure</strong> depuis les <strong>autotools</strong> .  C'est le zoo de ces scripts de diff√©rents d√©veloppeurs qui a donn√© l'impulsion √† la cr√©ation d'outils pour leur g√©n√©ration simplifi√©e et automatique. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><em>&lt;&lt; Passer au contenu</em></a> <br><br><a name="configure"></a><h2>  2. Configuration du code source </h2><br>  Le script <strong>Configure</strong> de la ¬´vieille √©cole¬ª, qui est d√©j√† √©vident √† partir de son <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="Shebang, Unix, page Wikipedia.">Shebang</a> ', qui a un espace: <br><br><pre> <code class="bash hljs">$ cat Configure | head -5 <span class="hljs-comment"><span class="hljs-comment">#! /bin/sh # # If these # comments don't work, trim them. Don't worry about any other # shell scripts, Configure will trim # comments from them for you. #</span></span></code> </pre><br>  Selon le commentaire, il s'av√®re qu'il y avait des obus dans les scripts dont il n'√©tait pas possible de laisser de commentaires!  La situation spatiale semble inhabituelle, mais une fois que c'√©tait la norme, consultez le lien pour plus d'informations <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="L'espace est-il autoris√© entre #! et / bin / bash dans shebang? - Unix et Linux Stack Exchange.">ici</a> .  Plus important encore, il n'y a pas de diff√©rence pour les interpr√©teurs de shell modernes, qu'il y ait ou non un espace. <br><br>  Assez de paroles, passons aux choses s√©rieuses!  Nous commen√ßons le script et voyons une hypoth√®se int√©ressante, qui s'av√®re ne pas √™tre enti√®rement vraie: <br><br><pre> <code class="plaintext hljs">$ ./Configure (I see you are using the Korn shell. Some ksh's blow up on Configure, especially on exotic machines. If yours does, try the Bourne shell instead.) Beginning of configuration questions for perl kit. Checking echo to see how to suppress newlines... ...using -n. Type carriage return to continue. Your cursor should be here--&gt;</code> </pre><br>  √âtonnamment, le script est interactif et contient une √©norme quantit√© d'informations contextuelles diverses.  Le mod√®le d'interaction utilisateur est construit sur des dialogues, analysant les r√©ponses auxquelles le script modifie ses param√®tres, selon lesquelles il g√©n√©rera ensuite des Makefiles.  Je voulais personnellement v√©rifier si toutes les commandes shell sont en place? <br><br><pre> <code class="plaintext hljs">Locating common programs... expr is in /bin/expr. sed is in /bin/sed. echo is in /bin/echo. cat is in /bin/cat. rm is in /bin/rm. mv is in /bin/mv. cp is in /bin/cp. tr is in /bin/tr. mkdir is in /bin/mkdir. sort is in /bin/sort. uniq is in /bin/uniq. grep is in /bin/grep. Don't worry if any of the following aren't found... test is in /bin/test. egrep is in /bin/egrep. I don't see Mcc out there, offhand.</code> </pre><br>  Apparemment avant, c'√©tait loin d'√™tre le cas.  Je me demande de quoi l'utilitaire <strong>Mcc</strong> est responsable, lequel est introuvable?  Le plus dr√¥le, c'est que ce script dans les meilleures traditions des hackers de l'√©poque est plein d'humour amical.  Maintenant, vous verrez √† peine ceci: <br><br><pre> <code class="plaintext hljs">Is your "test" built into sh? [n] (OK to guess) OK Checking compatibility between /bin/echo and builtin echo (if any)... They are compatible. In fact, they may be identical. Your C library is in /lib/libc.a. You're normal. Extracting names from /lib/libc.a for later perusal...done Hmm... Looks kind of like a USG system, but we'll see... Congratulations. You aren't running Eunice. It's not Xenix... Nor is it Venix... Checking your sh to see if it knows about # comments... Your sh handles # comments correctly. Okay, let's see if #! works on this system... It does. Checking out how to guarantee sh startup... Let's see if '#!/bin/sh' works... Yup, it does.</code> </pre><br>  J'ai r√©pondu √† la plupart des questions avec la valeur par d√©faut ou avec ce que le script m'a propos√©.  La demande de drapeaux pour le compilateur et l'√©diteur de liens a √©t√© particuli√®rement satisfaite et surprise: <br><br><pre> <code class="plaintext hljs">Any additional cc flags? [none] Any additional ld flags? [none]</code> </pre><br>  Vous pouvez y √©crire quelque chose d'int√©ressant, par exemple, <strong>-m32</strong> pour cr√©er un fichier ex√©cutable 32 bits ou une biblioth√®que, qui est n√©cessaire lors de la liaison.  √Ä la derni√®re question du script: <br><br><pre> <code class="plaintext hljs">Now you need to generate make dependencies by running "make depend". You might prefer to run it in background: "make depend &gt; makedepend.out &amp;" It can take a while, so you might not want to run it right now. Run make depend now? [n] y</code> </pre><br>  J'ai r√©pondu positivement.  A en juger par <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="makedepend, Histoire, page Wikipedia.">sa page</a> Wikipedia, l'ancien utilitaire <strong>makedepend a</strong> √©t√© cr√©√© au tout d√©but de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="Projet Ath√©na, page Wikipedia.">la</a> vie du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="Projet Ath√©na, page Wikipedia.">projet Athena</a> pour faciliter le travail avec Makefiles.  Ce projet nous a donn√© le syst√®me X Window, Kerberos, Zephyr et a influenc√© beaucoup d'autres choses qui nous sont famili√®res aujourd'hui.  Tout cela est merveilleux, mais d'o√π vient cet utilitaire dans un environnement Linux moderne?  Il n'a longtemps √©t√© utilis√© par personne et nulle part.  Mais si vous regardez attentivement la racine du r√©f√©rentiel, il s'av√®re que Larry Wall a √©crit sa version de script de remplacement, que nous avons soigneusement d√©compress√©e et ex√©cut√© le script de configuration. <br><br>  <strong>Makedepend</strong> termin√© avec quelques erreurs √©tranges: <br><br><pre> <code class="bash hljs">./makedepend: <span class="hljs-built_in"><span class="hljs-built_in">command</span></span> substitution: line 82: unexpected EOF <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> looking <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> matching `<span class="hljs-string"><span class="hljs-string">''</span></span> ./makedepend: <span class="hljs-built_in"><span class="hljs-built_in">command</span></span> substitution: line 83: syntax error: unexpected end of file ./makedepend: <span class="hljs-built_in"><span class="hljs-built_in">command</span></span> substitution: line 82: unexpected EOF <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> looking <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> matching `<span class="hljs-string"><span class="hljs-string">''</span></span> ./makedepend: <span class="hljs-built_in"><span class="hljs-built_in">command</span></span> substitution: line 83: syntax error: unexpected end of file</code> </pre><br>  Ce sont peut-√™tre eux qui ont caus√© le probl√®me √† cause duquel les Makefiles g√©n√©r√©s ont √©t√© un peu m√¢ch√©s: <br><br><pre> <code class="bash hljs">$ make make: *** No rule to make target <span class="hljs-string"><span class="hljs-string">'&lt;built-in&gt;'</span></span>, needed by <span class="hljs-string"><span class="hljs-string">'arg.o'</span></span>. Stop.</code> </pre><br>  Je ne voulais absolument pas entrer dans la jungle des nouilles de coquille complexes de l'utilitaire <strong>makedepend</strong> et j'ai d√©cid√© de regarder attentivement les Makefiles, dans lesquels un motif √©trange est apparu: <br><br><pre> <code class="plaintext hljs">arg.o: arg.c arg.o: arg.h arg.o: array.h arg.o: &lt;built-in&gt; arg.o: cmd.h arg.o: &lt;command-line&gt; arg.o: config.h arg.o: EXTERN.h ... array.o: arg.h array.o: array.c array.o: array.h array.o: &lt;built-in&gt; array.o: cmd.h array.o: &lt;command-line&gt; array.o: config.h array.o: EXTERN.h ...</code> </pre><br>  Apparemment, un utilitaire a incorrectement ins√©r√© ses arguments dans l'√©chappement.  En reprenant l'utilitaire de <s>hache</s> <strong>sed,</strong> j'ai d√©cid√© de corriger l√©g√®rement cette chose: <br><br><pre> <code class="bash hljs">$ sed -i <span class="hljs-string"><span class="hljs-string">'/built-in/d'</span></span> Makefile $ sed -i <span class="hljs-string"><span class="hljs-string">'/command-line/d'</span></span> Makefile</code> </pre><br>  √âtonnamment, l'astuce a fonctionn√© et les Makefiles ont fonctionn√© comme ils le devraient! <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><em>&lt;&lt; Passer au contenu</em></a> <br><br><a name="yacc"></a><h2>  3. Erreurs de fichier de grammaire Yacc </h2><br>  Ce serait incroyable si le code vieux de 32 ans prenait et assemblait sans aucun probl√®me.  Malheureusement, les miracles ne se produisent pas.  En √©tudiant l'arbre source, je suis tomb√© sur un fichier <strong>perl.y</strong> , qui est une description grammaticale de l'utilitaire <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="yacc, page Wikipedia.">yacc</a> , qui a longtemps √©t√© remplac√© par <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="GNU Bison, page Wikipedia.">bison</a> dans les distributions modernes.  Le script situ√© sur le chemin <strong>/ usr / bin / yacc</strong> appelle simplement <strong>bison</strong> en mode de compatibilit√© avec <strong>yacc</strong> .  C'est juste que cette compatibilit√© n'est pas compl√®te et lors du traitement de ce fichier, une √©norme quantit√© d'erreurs affluent, que je ne sais pas comment corriger et que je ne veux pas vraiment, car il existe une solution alternative que j'ai apprise r√©cemment. <br><br>  Il y a √† peine un an ou deux, Helio Chissini de Castro, qui est le d√©veloppeur de KDE, a effectu√© un travail similaire et adapt√© KDE 1, 2 et Qt 1, 2 aux environnements et compilateurs modernes.  Je me suis int√©ress√© √† son travail, j'ai t√©l√©charg√© les codes sources des projets, mais lors de l'assemblage, je suis tomb√© sur un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="Adaptation moderne de Qt 2 par Helio Castro, Issues, GitHub repository.">pi√®ge</a> similaire en raison de l'incompatibilit√© du <strong>yacc</strong> et du <strong>bison</strong> , qui √©taient utilis√©s pour construire l'ancienne version du m√©tacompilateur moc.  Par la suite, j'ai r√©ussi √† trouver une solution √† ce probl√®me sous la forme du remplacement du <strong>bison</strong> par l'utilitaire <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="Berkeley Yacc, page officielle.">byacc</a> (Berkeley Yacc), qui s'est av√©r√© compatible avec les anciennes grammaires pour <strong>yacc</strong> et √©tait disponible dans de nombreuses distributions Linux. <br><br>  Un simple remplacement de <strong>yacc</strong> par <strong>byacc</strong> dans le syst√®me de construction m'a alors aid√©, mais pas pour longtemps, car un peu plus tard dans les nouvelles versions de <strong>byacc, ils ont</strong> encore rompu la compatibilit√© avec <strong>yacc</strong> , interrompant le d√©bogage associ√© √† l'entit√© <strong>yydebug</strong> .  Par cons√©quent, j'ai d√ª l√©g√®rement <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="Correction d'une erreur de r√©f√©rence ind√©finie, Pull Requests, adaptation moderne Qt 2 par Helio Castro, r√©f√©rentiel GitHub.">corriger la grammaire de l'</a> utilitaire. <br><br>  Ainsi, la strat√©gie de correction des erreurs de construction dans le fichier <strong>perl.y a</strong> √©t√© pr√©dite par l'exp√©rience pr√©c√©dente: installez l'utilitaire <strong>byacc</strong> , changez <strong>yacc</strong> en <strong>byacc</strong> dans tous les Makefiles, puis coupez <strong>yydebug</strong> de partout.  Ces actions ont r√©solu tous les probl√®mes avec ce fichier, les erreurs ont disparu et la compilation s'est poursuivie. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><em>&lt;&lt; Passer au contenu</em></a> <br><br><a name="c-errors"></a><h2>  4. Erreurs de compilation de code sur "C" </h2><br>  L'ancien code de Perl √©tait plein d'horreurs, comme la notation depuis longtemps obsol√®te et oubli√©e des d√©finitions de fonction du type K&amp;R: <br><br><pre> <code class="cpp hljs">format(orec,fcmd) <span class="hljs-keyword"><span class="hljs-keyword">register</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">outrec</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">orec</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">register</span></span> FCMD *fcmd; { ... } <span class="hljs-function"><span class="hljs-function">STR * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hfetch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(tb,key)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">register</span></span></span><span class="hljs-function"> HASH *tb</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *key; { ... } <span class="hljs-comment"><span class="hljs-comment">/*VARARGS1*/</span></span> fatal(pat,a1,a2,a3,a4) <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *pat; { <span class="hljs-built_in"><span class="hljs-built_in">fprintf</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">stderr</span></span>,pat,a1,a2,a3,a4); <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>); }</code> </pre><br>  Des fonctionnalit√©s similaires ont √©t√© trouv√©es, par exemple, dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="Arch√©ologie divertissante. Ou PVS-Studio v√©rifie Microsoft Word 1.1a, article sur la ressource Habr.">le</a> code <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="Arch√©ologie divertissante. Ou PVS-Studio v√©rifie Microsoft Word 1.1a, article sur la ressource Habr.">Microsoft Word 1.1a</a> , qui est √©galement assez ancien.  Le premier standard du langage de programmation ¬´C¬ª, appel√© ¬´C89¬ª, n'appara√Ætra que dans deux ans.  Les compilateurs modernes sont capables de travailler avec un tel code, mais certains IDE ne facilitent pas l'analyse de telles d√©finitions et les mettent en √©vidence comme des erreurs de syntaxe, par exemple, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="IDE Qt Creator, page Wikipedia.">Qt Creator a</a> p√©ch√© avant avant d'analyser le code qu'il <strong>contient dans la</strong> biblioth√®que <strong>libclang</strong> . <br><br>  Le compilateur GCC 9.2.0, g√©n√©rant un grand nombre d'avertissements, s'est engag√© √† compiler l'ancien code de la premi√®re version de Perl.  Les feuilles des avertissements √©taient si grandes que pour arriver √† l'erreur, nous avons d√ª faire d√©filer plusieurs pages de l'√©chappement vers le haut.  √Ä ma grande surprise, la plupart des erreurs de compilation √©taient typiques et principalement li√©es √† des d√©finitions pr√©d√©finies, qui jouaient le r√¥le de drapeaux pour l'assemblage. <br><br><div style="text-align:center;"><img title="Le travail du compilateur GCC 9.2.0 moderne et du d√©bogueur GDB 8.3.1 dans le gestionnaire de fen√™tres twm et l'√©mulateur de terminal xterm." src="https://habrastorage.org/getpro/habr/post_images/3a9/b3c/004/3a9b3c0041c48a06e6805bd39883c6a4.png"></div><br>  <i>Le travail du compilateur GCC 9.2.0 moderne et du d√©bogueur GDB 8.3.1 dans le gestionnaire de fen√™tres <strong>twm</strong> et l'√©mulateur de terminal <strong>xterm</strong> .</i> <br><br>  Sous STDSTDIO <strong>,</strong> Larry Wall a exp√©riment√© une biblioth√®que de langage de programmation ancienne et non standard ¬´C¬ª, et sous DEBUGGING, <strong>il y</strong> avait des informations de d√©bogage avec le fameux <strong>yydebug</strong> , que j'ai mentionn√© ci-dessus.  Par d√©faut, ces indicateurs ont √©t√© activ√©s.  En les d√©sactivant dans le fichier <strong>perl.h</strong> et en ajoutant des d√©finitions oubli√©es, j'ai pu r√©duire consid√©rablement le nombre d'erreurs. <br><br>  Un autre type d'erreur remplace les fonctions d√©sormais normalis√©es de la biblioth√®que standard et de la couche POSIX.  Le projet poss√®de ses propres <strong>malloc ()</strong> , <strong>setenv ()</strong> et autres entit√©s qui ont cr√©√© des conflits. <br><br>  Quelques endroits ont d√©fini des fonctions statiques sans d√©clarations.  Au fil du temps, les compilateurs ont commenc√© √† adopter une approche plus stricte de ce probl√®me et ont <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="Comment r√©soudre la d√©claration statique suit la d√©claration non statique dans le code GCC C? - D√©bordement de pile.">transform√© l'avertissement en une erreur</a> .  Et enfin, quelques en-t√™tes oubli√©s, o√π iriez-vous sans eux. <br><br>  √Ä ma grande surprise, le correctif pour le code de 32 ans s'est av√©r√© si minuscule qu'il peut √™tre enti√®rement cit√© ici: <br><br><pre> <code class="diff hljs">diff --git a/malloc.cb/malloc.c index 17c3b27..a1dfe9c 100644 --- a/malloc.c +++ b/malloc.c @@ -79,6 +79,9 @@ static u_int nmalloc[NBUCKETS]; #include &lt;stdio.h&gt; #endif +static findbucket(union overhead *freep, int srchlen); +static morecore(register bucket); + #ifdef debug #define ASSERT(p) if (!(p)) botch("p"); else static diff --git a/perl.hb/perl.h index 3ccff10..e98ded5 100644 --- a/perl.h +++ b/perl.h @@ -6,16 +6,16 @@ * */ -#define DEBUGGING -#define STDSTDIO /* eventually should be in config.h */ +//#define DEBUGGING +//#define STDSTDIO /* eventually should be in config.h */ #define VOIDUSED 1 #include "config.h" -#ifndef BCOPY -# define bcopy(s1,s2,l) memcpy(s2,s1,l); -# define bzero(s,l) memset(s,0,l); -#endif +//#ifndef BCOPY +//# define bcopy(s1,s2,l) memcpy(s2,s1,l); +//# define bzero(s,l) memset(s,0,l); +//#endif #include &lt;stdio.h&gt; #include &lt;ctype.h&gt; @@ -183,11 +183,11 @@ double atof(); long time(); struct tm *gmtime(), *localtime(); -#ifdef CHARSPRINTF - char *sprintf(); -#else - int sprintf(); -#endif +//#ifdef CHARSPRINTF +// char *sprintf(); +//#else +// int sprintf(); +//#endif #ifdef EUNICE #define UNLINK(f) while (unlink(f) &gt;= 0) diff --git a/perl.yb/perl.y index 16f8a9a..1ab769f 100644 --- a/perl.y +++ b/perl.y @@ -7,6 +7,7 @@ */ %{ +#include &lt;stdlib.h&gt; #include "handy.h" #include "EXTERN.h" #include "search.h" diff --git a/perly.cb/perly.c index bc32318..fe945eb 100644 --- a/perly.c +++ b/perly.c @@ -246,12 +246,14 @@ yylex() static bool firstline = TRUE; retry: +#ifdef DEBUGGING #ifdef YYDEBUG if (yydebug) if (index(s,'\n')) fprintf(stderr,"Tokener at %s",s); else fprintf(stderr,"Tokener at %s\n",s); +#endif #endif switch (*s) { default: diff --git a/stab.cb/stab.c index b9ef533..9757cfe 100644 --- a/stab.c +++ b/stab.c @@ -7,6 +7,7 @@ */ #include &lt;signal.h&gt; +#include &lt;errno.h&gt; #include "handy.h" #include "EXTERN.h" #include "search.h" diff --git a/util.hb/util.h index 4f92eeb..95cb9bf 100644 --- a/util.h +++ b/util.h @@ -28,7 +28,7 @@ void prexit(); char *get_a_line(); char *savestr(); int makedir(); -void setenv(); +//void setenv(); int envix(); void notincl(); char *getval();</code> </pre><br>  Excellent r√©sultat pour un code de 32 ans!  La <strong>r√©f√©rence non d√©finie au</strong> bogue de liaison <strong>`crypt 'a</strong> √©t√© corrig√©e en ajoutant la directive <em>-lcrypt</em> au Makefile avec la biblioth√®que <strong>libcrypt</strong> appropri√©e, apr√®s quoi j'ai finalement obtenu l'ex√©cutable d'interpr√©teur Perl souhait√©: <br><br><pre> <code class="bash hljs">$ file perl perl: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=fd952ceae424613568530b3a2ca88ebd6477e0ae, <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> GNU/Linux 3.2.0, not stripped</code> </pre><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><em>&lt;&lt; Passer au contenu</em></a> <br><br><a name="segfaults"></a><h2>  5. Correction de certaines erreurs D√©faut de segmentation </h2><br>  Apr√®s une compilation presque sans tracas, la chance m'a tourn√© le dos.  Imm√©diatement apr√®s le d√©marrage de l'interpr√©teur Perl assembl√©, j'ai eu quelques erreurs √©tranges et un d√©faut de segmentation √† la fin: <br><br><pre> <code class="bash hljs">$ ./perl -e <span class="hljs-string"><span class="hljs-string">'print "Hello World!\n";'</span></span> Corrupt malloc ptr 0x2db36040 at 0x2db36000 Corrupt malloc ptr 0x2db36880 at 0x2db36800 Corrupt malloc ptr 0x2db36080 at 0x2db36040 Corrupt malloc ptr 0x2db37020 at 0x2db37000 Segmentation fault (core dumped)</code> </pre><br>  Apr√®s avoir rong√© le texte source de la phrase <em>Corrupt malloc</em> , il s'est av√©r√© qu'au lieu du syst√®me <strong>malloc ()</strong> une sorte d'allocateur personnalis√© a √©t√© appel√©e √† partir de 1982.  Fait int√©ressant, <strong>Berkeley est</strong> √©crit dans l'un des litt√©raux de cha√Æne de son code source et <strong>Caltech</strong> dans un commentaire √† c√¥t√©.  La collaboration entre ces universit√©s √©tait alors √©vidente tr√®s forte.  En g√©n√©ral, j'ai comment√© cet allocateur de hacker et reconstruit le code source.  Les erreurs de corruption de m√©moire ont disparu, mais l'erreur de segmentation est rest√©e.  Ce n'√©tait donc pas le point, et maintenant nous devons d√©couvrir le d√©bogueur. <br><br>  En ex√©cutant le programme sous <strong>gdb,</strong> j'ai constat√© que le crash se produit lorsque la fonction de cr√©ation d'un fichier temporaire <strong>mktemp () √†</strong> partir de libc est appel√©e: <br><br><pre> <code class="plaintext hljs">$ gdb --args ./perl -e 'print "Hello, World!\n";' (gdb) r Starting program: /home/exl/perl5/perl -e print\ \"Hello\ World\!\\n\"\; Program received signal SIGSEGV, Segmentation fault. 0x00007ffff7cd20c7 in __gen_tempname () from /usr/lib/libc.so.6 (gdb) bt #0 0x00007ffff7cd20c7 in __gen_tempname () from /usr/lib/libc.so.6 #1 0x00007ffff7d71577 in mktemp () from /usr/lib/libc.so.6 #2 0x000055555556bb08 in main ()</code> </pre><br>  Soit dit en passant, l'√©diteur de liens jurait auparavant √† cette fonction.  Pas un compilateur, mais un √©diteur de liens, ce qui m'a surpris: <br><br><pre> <code class="plaintext hljs">/usr/bin/ld: perl.o: in function `main': perl.c:(.text+0x978c): warning: the use of `mktemp' is dangerous, better use `mkstemp' or `mkdtemp'</code> </pre><br>  La premi√®re pens√©e qui vous est probablement venue √† l'esprit √©tait √©galement de remplacer la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="La biblioth√®que GNU C, fichiers temporaires, documentation officielle GNU.">fonction dangereuse</a> <strong>mktemp ()</strong> par <strong>mkstemp ()</strong> , ce que j'ai fait.  L'avertissement de l'√©diteur de liens a disparu, mais la faute de segmentation est rest√©e √† cet endroit de toute fa√ßon, seulement maintenant, elle √©tait dans la fonction <strong>mkstemp ()</strong> . <br><br>  Par cons√©quent, vous devez maintenant regarder tr√®s attentivement le morceau de code associ√© √† cette fonction.  L√†, j'ai d√©couvert une chose assez √©trange qui est mise en √©vidence dans cet extrait: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *e_tmpname = <span class="hljs-string"><span class="hljs-string">"/tmp/perl-eXXXXXX"</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ mktemp(e_tmpname); e_fp = f_open(e_tmpname, <span class="hljs-string"><span class="hljs-string">"w"</span></span>); ... }</code> </pre><br>  Il s'av√®re que <strong>mktemp ()</strong> essaie de changer le litt√©ral du masque, qui se trouve dans la section <strong>.rodata</strong> , qui est √©videmment vou√© √† l'√©chec.  Ou, apr√®s tout, il y a 32 ans, c'√©tait acceptable, respect√© dans le code, et m√™me d'une mani√®re ou d'une autre fonctionn√©? <br><br>  Bien s√ªr, le remplacement de <strong>char * e_tmpname</strong> par <strong>char e_tmpname [] a</strong> corrig√© cette erreur de segmentation et j'ai pu obtenir ce que j'ai tu√© pour toute la soir√©e: <br><br><pre> <code class="bash hljs">$ ./perl -e <span class="hljs-string"><span class="hljs-string">'print "Hello World!\n";'</span></span> $ Hello, World! $ ./perl -e <span class="hljs-string"><span class="hljs-string">'$a = 5; $b = 6.3; $c = $a+$b; print $c."\n";'</span></span> $ 11.3000000000000007 $ ./perl -v <span class="hljs-variable"><span class="hljs-variable">$Header</span></span>: perly.c,v 1.0 87/12/18 15:53:31 root Exp $ Patch level: 0</code> </pre><br>  Nous avons v√©rifi√© l'ex√©cution √† partir de la ligne de commande, mais qu'en est-il du fichier?  J'ai t√©l√©charg√© le premier ¬´Hello World¬ª pour le langage de programmation Perl sur Internet: <br><br><pre> <code class="perl hljs"><span class="hljs-comment"><span class="hljs-comment">################# test.pl #!/usr/bin/perl # # The traditional first program. # Strict and warnings are recommended. use strict; use warnings; # Print a message. print "Hello, World!\n";</span></span></code> </pre><br>  Ensuite, j'ai essay√© de l'ex√©cuter, mais, h√©las, l'erreur de segmentation m'attendait √† nouveau.  Cette fois dans un endroit compl√®tement diff√©rent: <br><br><pre> <code class="plaintext hljs">$ gdb --args ./perl test.pl (gdb) r Starting program: /home/exl/perl5/perl test.pl Program received signal SIGSEGV, Segmentation fault. 0x00007ffff7d1da75 in __strcpy_sse2_unaligned () from /usr/lib/libc.so.6 (gdb) bt #0 0x00007ffff7d1da75 in __strcpy_sse2_unaligned () from /usr/lib/libc.so.6 #1 0x00005555555629ea in yyerror () #2 0x0000555555568dd6 in yyparse () #3 0x000055555556bd4f in main ()</code> </pre><br>  Le point int√©ressant suivant a √©t√© trouv√© dans la fonction <strong>yyerror ()</strong> , je cite l'extrait d'origine: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// perl.y char *tokename[] = { "256", "word", "append", ... // perl.c yyerror(s) char *s; { char tmpbuf[128]; char *tname = tmpbuf; if (yychar &gt; 256) { tname = tokename[yychar-256]; // ??? if (strEQ(tname,"word")) strcpy(tname,tokenbuf); // Oops! else if (strEQ(tname,"register")) sprintf(tname,"$%s",tokenbuf); // Oops! ...</span></span></code> </pre><br>  Encore une fois, la situation est similaire √† celle dont j'ai parl√© plus haut.  Les donn√©es de la section <strong>.rodata</strong> sont √† <strong>nouveau modifi√©es</strong> .  Peut-√™tre que c'est juste des fautes de frappe √† cause de Copy-Paste et au lieu de <strong>tname,</strong> ils voulaient √©crire <strong>tmpbuf</strong> ?  Ou y a-t-il vraiment une sorte de signification cach√©e derri√®re cela?  Dans tous les cas, le remplacement de <strong>char * tokename []</strong> par <strong>char tokename [] [32]</strong> supprime l'erreur de panne de segmentation et Perl nous dit ce qui suit: <br><br><pre> <code class="bash hljs">$ ./perl test.pl syntax error <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> file test.pl at line 7, next token <span class="hljs-string"><span class="hljs-string">"strict"</span></span> Execution aborted due to compilation errors.</code> </pre><br>  Il s'av√®re qu'il n'aime pas toutes sortes d' <strong>utilisations strictes</strong> , c'est ce qu'il essaie de nous dire!  Si vous supprimez ou commentez ces lignes dans le fichier, le programme d√©marre: <br><br><pre> <code class="bash hljs">$ ./perl test.pl Hello, World!</code> </pre><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><em>&lt;&lt; Passer au contenu</em></a> <br><br><a name="theend"></a><h2>  6. Pour r√©sumer </h2><br>  En fait, j'ai atteint mon objectif et fait que l'ancien code de 1987 non seulement compile, mais fonctionne √©galement dans un environnement Linux moderne.  Sans aucun doute, il reste encore une grande pile d'erreurs de d√©fauts de segmentation diverses, probablement li√©es √† la taille du pointeur sur une architecture 64 bits.  Tout cela peut √™tre nettoy√© apr√®s quelques soir√©es avec le d√©bogueur pr√™t.  Mais ce n'est pas une t√¢che tr√®s agr√©able et plut√¥t fastidieuse.  Apr√®s tout, cette exp√©rience √©tait initialement con√ßue comme un divertissement pour une soir√©e ennuyeuse, et non comme une ≈ìuvre √† part enti√®re, qui prendra fin.  Y a-t-il un avantage pratique des actions entreprises?  Peut-√™tre qu'un jour, un arch√©ologue num√©rique rencontrera cet article et il lui sera utile.  Mais dans le monde r√©el, m√™me l'exp√©rience tir√©e de ces recherches, √† mon avis, n'est pas trop pr√©cieuse. <br><br>  Si quelqu'un est int√©ress√©, je poste un ensemble de deux patchs.  Le premier corrige les erreurs de compilation et le second corrige certaines erreurs de segmentation. <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="Correction du correctif des erreurs de compilation, r√©f√©rentiel EXLMOTODEV GitHub."><strong>Perl1987-Fix-compilation-errors.patch</strong></a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="Correction d'un correctif de d√©fauts de segmentation, r√©f√©rentiel EXLMOTODEV GitHub."><strong>Perl1987-Fix-some-Segmentation-Faults.patch</strong></a> </li></ul><br>  PS Je m'empresse de bouleverser les fans de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="Programme Perl Single Line, article de Lurkmore.">joueurs destructeurs sur une seule ligne</a> , cela ne fonctionne pas ici.  La version de Perl est peut-√™tre trop ancienne pour un tel divertissement. <br>  PPS Tout va bien et passez un bon week-end.  Merci √† <strong>kawaii_neko</strong> pour une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="Perl directement de 1987, commentez la ressource LINUX.ORG.RU">petite correction</a> . <br><br>  <em>Mise √† jour du 28 octobre 2019: un</em> utilisateur du forum LINUX.ORG.RU, utilisant le surnom <strong>utf8nowhere</strong> , a fourni des liens tr√®s int√©ressants <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="Perl directement de 1987, commentez la ressource LINUX.ORG.RU">dans son commentaire</a> sur cet article, dont les informations clarifient non seulement la situation avec les litt√©raux de cha√Æne mutables, mais prennent m√™me en compte le probl√®me d'utilisation d√©crit ci-dessus. <strong>Fonctions mktemp ()</strong> !  Permettez-moi de citer ces sources, qui d√©crivent diverses incompatibilit√©s entre le K&amp;R C non normalis√© et le GNU C: <br><blockquote>  <strong>Incompatibilit√©s de GCC</strong> <br>  Il existe plusieurs incompatibilit√©s notables entre les versions GNU C et K&amp;R (non ISO) de C. <br><br>  GCC fait normalement des constantes de cha√Æne en lecture seule.  Si plusieurs constantes de cha√Æne d'aspect identique sont utilis√©es, GCC ne stocke qu'une seule copie de la cha√Æne. <br>  Une cons√©quence est que vous ne pouvez pas appeler <strong>mktemp</strong> avec un argument de cha√Æne constante.  La fonction <strong>mktemp</strong> modifie toujours la cha√Æne vers laquelle pointe son argument. <br><br>  Une autre cons√©quence est que <strong>sscanf</strong> ne fonctionne pas sur certains syst√®mes lorsqu'il <strong>re√ßoit</strong> une constante de cha√Æne comme cha√Æne ou entr√©e de contr√¥le de format.  Cela est d√ª au fait que <strong>sscanf</strong> essaie incorrectement d'√©crire dans la constante de cha√Æne.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De m√™me </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fscanf</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">scanf</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La meilleure solution √† ces probl√®mes consiste √† modifier le programme pour utiliser des </font><font style="vertical-align: inherit;">variables </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">char</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -array avec des cha√Ænes d'initialisation √† ces fins au lieu de constantes de cha√Æne. </font><font style="vertical-align: inherit;">Mais si cela n'est pas possible, vous pouvez utiliser l' </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">indicateur -fwritable-strings</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui indique √† GCC de g√©rer les constantes de cha√Æne de la m√™me mani√®re que la plupart des compilateurs C. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Source: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="Utilisation du manuel officiel de la collection de compilateurs GNU (GCC 3.3)."><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Utilisation du manuel officiel de GNU Compiler Collection (GCC 3.3)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L' </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">indicateur de</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> compilateur </font><strong><font style="vertical-align: inherit;">-fwritable-strings</font></strong><font style="vertical-align: inherit;"> a </font><font style="vertical-align: inherit;">√©t√© d√©conseill√© dans GCC 3.4 et d√©finitivement supprim√© dans GCC 4.0.</font></font><br><blockquote> <strong>ANSI C rationale | String literals</strong> <br> String literals are specified to be unmodifiable. This specification allows implementations to share copies of strings with identical text, to place string literals in read-only memory, and perform certain optimizations. However, string literals do not have the type array of const char, in order to avoid the problems of pointer type checking, particularly with library functions, since assigning a pointer to const char to a plain pointer to char is not valid. Those members of the Committee who insisted that string literals should be modifiable were content to have this practice designated a common extension (see F.5.5). <br><br> Existing code which modifies string literals can be made strictly conforming by replacing the string literal with an initialized static character array. For instance, <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *p, *make_temp(<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *str); <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> p = make_temp(<span class="hljs-string"><span class="hljs-string">"tempXXX"</span></span>); <span class="hljs-comment"><span class="hljs-comment">/* make_temp overwrites the literal */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* with a unique name */</span></span></code> </pre><br> can be changed to: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *p, *make_temp(<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *str); <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>[ ] = <span class="hljs-string"><span class="hljs-string">"tempXXX"</span></span>; p = make_temp( <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> ); }</code> </pre><br> : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="Justification de l'American National Standard for Information Systems, Programming Language C, String literals.">Rationale for American National Standard for Information Systems, Programming Language C</a> . <br></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'utilisateur </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VarfolomeyKote4ka a</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> propos√© un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="Perl directement de 1987, commentez la ressource LINUX.ORG.RU"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hack sale int√©ressant</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> qui vous permet de contourner les erreurs de segmentation lors des tentatives de modification des donn√©es dans la section </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.rodata</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en les convertissant en section </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.rwdata</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Il n'y a pas si longtemps, un article tr√®s int√©ressant est apparu sur Internet, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="Du .rodata au .rwdata - introduction au mappage de la m√©moire et aux scripts LD, Guy on BITS."><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬´Du .rodata au .rwdata - introduction au mappage de la m√©moire et aux scripts LD¬ª</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> par le programmeur </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">guye1296</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui explique comment faire cette astuce. Pour faciliter l'obtention du r√©sultat souhait√©, l'auteur de l'article a pr√©par√© un script assez volumineux pour l'√©diteur de liens standard </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ld</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><a href="" title="Script rwdata.ld pour ld linker, guye1296, r√©f√©rentiel GitHub."><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rwdata.ld</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Il suffit de t√©l√©charger ce script, de le placer √† la racine du r√©pertoire source Perl, de corriger l'indicateur </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LDFLAGS</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> comme suit: </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LDFLAGS = -T rwdata.ld</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , puis reconstruire le projet. </font><font style="vertical-align: inherit;">En cons√©quence, nous avons les √©l√©ments suivants:</font></font><br><br><pre> <code class="bash hljs">$ make clean &amp;&amp; make -j1 $ mv perl perl_rodata $ curl -LOJ https://raw.githubusercontent.com/guye1296/ld_script_elf_blog_post/master/rwdata.ld $ sed -i <span class="hljs-string"><span class="hljs-string">'s/LDFLAGS =/LDFLAGS = -T rwdata.ld/'</span></span> Makefile $ make clean &amp;&amp; make -j1 $ mv perl perl_rwdata $ objdump -s -j .rodata perl_rodata | grep tmp -2 19da0 21233f5e 7e3d2d25 30313233 34353637 !<span class="hljs-comment"><span class="hljs-comment">#?^~=-%01234567 19db0 38392e2b 262a2829 2c5c2f5b 7c002400 89.+&amp;*(),\/[|.$. 19dc0 73746465 7272002f 746d702f 7065726c stderr./tmp/perl 19dd0 2d655858 58585858 00323536 00617070 -eXXXXXX.256.app 19de0 656e6400 6c6f6f70 63746c00 66756e63 end.loopctl.func $ objdump -s -j .rwdata perl_rodata | grep tmp -2 objdump: section '.rwdata' mentioned in a -j option, but not found in any input file $ objdump -s -j .rwdata perl_rwdata | grep tmp -2 41d9c0 21233f5e 7e3d2d25 30313233 34353637 !#?^~=-%01234567 41d9d0 38392e2b 262a2829 2c5c2f5b 7c002400 89.+&amp;*(),\/[|.$. 41d9e0 73746465 7272002f 746d702f 7065726c stderr./tmp/perl 41d9f0 2d655858 58585858 00323536 00617070 -eXXXXXX.256.app 41da00 656e6400 6c6f6f70 63746c00 66756e63 end.loopctl.func $ objdump -s -j .rodata perl_rwdata | grep tmp -2 objdump: section '.rodata' mentioned in a -j option, but not found in any input file $ ./perl_rodata -e 'print "Hello, World!\n";' Segmentation fault (core dumped) $ ./perl_rwdata -e 'print "Hello, World!\n";' Hello, World!</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il s'av√®re que gr√¢ce √† ce hack, presque toutes les modifications du deuxi√®me patch peuvent √™tre simplement omises! </font><font style="vertical-align: inherit;">Bien que, bien s√ªr, amener le code √† un aspect qui ne viole pas les normes est toujours pr√©f√©rable. </font></font><br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&lt;&lt; Passer au contenu</font></font></em></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr473228/">https://habr.com/ru/post/fr473228/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr473214/index.html">Yaga - Contes slaves dans le cadre mobile</a></li>
<li><a href="../fr473218/index.html">Entretien avec Ivan Kruglov, d√©veloppeur principal: Service Mesh et outils Booking.com ¬´non standard¬ª</a></li>
<li><a href="../fr473220/index.html">Les pierres angulaires de la destruction lente de code dans Wolfram Language: acc√©l√©rer des dizaines, des centaines et des milliers de fois</a></li>
<li><a href="../fr473222/index.html">R√®gles iptables personnalis√©es pour docker utilisant zabbix comme exemple</a></li>
<li><a href="../fr473224/index.html">Enseignement sup√©rieur vs comp√©tence. Opinion individuelle d'un juge de la Cour constitutionnelle de la F√©d√©ration de Russie sur l'√©tat de l'enseignement sup√©rieur</a></li>
<li><a href="../fr473230/index.html">L'Internet par satellite est-il une nouvelle course √† l'espace?</a></li>
<li><a href="../fr473232/index.html">Quel syst√®me de contr√¥le de version utilisez-vous (en vrai travail, la plupart)?</a></li>
<li><a href="../fr473234/index.html">Cr√©ation d'une API REST avec Node.js et une base de donn√©es Oracle</a></li>
<li><a href="../fr473236/index.html">Travail en informatique, gestion de projet, r√©gulation PD et d√©veloppement dans le cloud: m√©gadigest de 1cloud.ru</a></li>
<li><a href="../fr473238/index.html">Comment fonctionne Netflix</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>