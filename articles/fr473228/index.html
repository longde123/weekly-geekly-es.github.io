<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤙 👉🏽 👨🏾‍🎨 Mettre Perl directement depuis 1987 👩🏿‍🤝‍👨🏽 👨‍👩‍👧‍👦 🗺️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Après avoir lu la nouvelle " Code d'interpréteur Perl officiellement porté sur GitHub " sur LINUX.ORG.RU, j'ai décidé de jeter un œil au référentiel P...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Mettre Perl directement depuis 1987</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/473228/"> Après avoir lu la nouvelle " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="Code d'interpréteur Perl officiellement porté sur GitHub, actualité sur la ressource LINUX.ORG.RU">Code d'interpréteur Perl officiellement porté sur GitHub</a> " sur LINUX.ORG.RU, j'ai décidé de jeter un œil au référentiel Perl 5, qui est déjà sur GitHub. <br><br>  Il est incroyable de voir à quel point ils l'ont transféré de manière considérable et qualitative, en préservant non seulement absolument l'intégralité de l'histoire du projet pendant 32 ans, mais aussi des rapports de bogues (entrés dans les problèmes), des correctifs (entrés dans les PR), des versions et des branches.  L'inscription " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="Il y a 32 ans sur les fichiers source Perl, référentiel officiel Perl 5 GitHub.">il y a 32 ans</a> " à côté des dossiers provoque un sourire involontaire. <br><br>  Que faire d'autre en ce vendredi soir terne, quand la pluie et la neige bruissent désagréablement dans la rue et que tous les chemins sont embourbés dans la neige fondante d'automne?  C'est vrai, les yeux rouges!  Donc, pour des raisons d'expérience et d'intérêt, j'ai décidé de prendre et d'assembler l'ancien Perl sur une machine x86_64 moderne avec la dernière version de <strong>GCC 9.2.0 en</strong> tant que compilateur.  Un tel ancien code peut-il passer l'épreuve du temps? <br><br><div style="text-align:center;"><img title="Démonstration de twm, l'un des premiers gestionnaires de fenêtres pour le système X Window, sur une distribution Arch Linux moderne." src="https://habrastorage.org/webt/-0/d5/wt/-0d5wtkg6ylqdd-h5g1hbtdiypi.png"></div><br>  <i>Démonstration de <strong>twm</strong> , l'un des premiers gestionnaires de fenêtres pour le système X Window, sur une distribution Arch Linux moderne.</i> <br><br>  Pour être complètement authentique et nekromantnenko, j'ai déployé une machine virtuelle avec bare X et gestionnaire de fenêtres <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="twm, page Wikipedia.">twm</a> , qui date également de 1987.  Qui sait, peut-être que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="Larry Wall, page Wikipedia.">Larry Wall a</a> écrit son Perl en utilisant exactement <strong>twm</strong> , pour ainsi dire la <em>technologie de pointe de l'</em> époque.  La distribution utilisée est Arch Linux.  Tout simplement parce qu'il y a des choses utiles dans son référentiel qui ont été utiles plus tard.  Alors allons-y! <br><a name="habracut"></a><br><a name="article-content"></a><h2>  Contenu: </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">1. Préparation de l'environnement</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">2. Configuration du code source</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">3. Erreurs de fichier de grammaire Yacc</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">4. Erreurs de compilation de code sur "C"</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">5. Correction de certaines erreurs Défaut de segmentation</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">6. Pour résumer</a> <br><br><a name="environment"></a><h2>  1. Préparation de l'environnement </h2><br>  Tout d'abord, nous installons sur un système d'exploitation déployé dans une machine virtuelle tous les utilitaires et compilateurs nécessaires pour assembler et éditer le code source: <strong>gcc</strong> , <strong>make</strong> , <strong>vim</strong> , <strong>git</strong> , <strong>gdb</strong> , etc. Certains d'entre eux sont déjà installés, tandis que d'autres sont disponibles dans le méta-package <strong>base-devel</strong> , il doit être installé s'il n'est pas installé.  Une fois l'environnement prêt à l'action, nous obtenons une copie du code source Perl de 32 ans! <br><br><pre><code class="bash hljs">$ git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/Perl/perl5/ --depth=1 -b perl-1.0</code> </pre> <br>  Grâce aux fonctionnalités de Git, nous n'avons pas besoin de faire glisser un tas de fichiers pour accéder à la toute première version du projet: <br><br><pre> <code class="plaintext hljs">* commit 8d063cd8450e59ea1c611a2f4f5a21059a2804f1 (grafted, HEAD, tag: perl-1.0) Commit: Larry Wall &lt;lwall@jpl-devvax.jpl.nasa.gov&gt; CommitDate: Fri Dec 18 00:00:00 1987 +0000 a "replacement" for awk and sed</code> </pre><br>  Nous ne téléchargeons qu'une petite quantité de données et, par conséquent, le référentiel avec le code source de la première version de Perl ne prend que 150 Ko. <br><br>  À cette époque sombre et dense, il n'y avait pas de choses élémentaires comme les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="GNU Autotools, page Wikipedia.">outils automatiques</a> ( <em>quelle bénédiction!</em> ), Cependant, il y a un script <strong>Configure</strong> à la racine du référentiel.  Quelle est la question?  Mais le fait est que Larry Wall est l'inventeur de ces scripts qui ont permis de générer des Makefiles pour les machines UNIX les plus variées de l'époque.  Comme l'indique l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="Configurer le script, l'historique, la page Wikipedia.">article</a> Wikipédia sur les scripts du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="Configurer le script, l'historique, la page Wikipedia.">même nom</a> , Larry Wall a fourni le fichier <strong>Configure</strong> avec certains de ses logiciels, par exemple, un lecteur de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="rn, Newsreader, page Wikipedia.">news rn</a> , trois ans avant d'écrire Perl.  Par la suite, Perl n'a pas fait exception et un script déjà exécuté sur de nombreuses machines a été utilisé pour le construire.  Plus tard, d'autres développeurs, par exemple des programmeurs de Trolltech, ont également repris cette idée.  Ils ont utilisé un script similaire pour configurer la construction de leur framework Qt, que beaucoup de gens confondent avec <strong>configure</strong> depuis les <strong>autotools</strong> .  C'est le zoo de ces scripts de différents développeurs qui a donné l'impulsion à la création d'outils pour leur génération simplifiée et automatique. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><em>&lt;&lt; Passer au contenu</em></a> <br><br><a name="configure"></a><h2>  2. Configuration du code source </h2><br>  Le script <strong>Configure</strong> de la «vieille école», qui est déjà évident à partir de son <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="Shebang, Unix, page Wikipedia.">Shebang</a> ', qui a un espace: <br><br><pre> <code class="bash hljs">$ cat Configure | head -5 <span class="hljs-comment"><span class="hljs-comment">#! /bin/sh # # If these # comments don't work, trim them. Don't worry about any other # shell scripts, Configure will trim # comments from them for you. #</span></span></code> </pre><br>  Selon le commentaire, il s'avère qu'il y avait des obus dans les scripts dont il n'était pas possible de laisser de commentaires!  La situation spatiale semble inhabituelle, mais une fois que c'était la norme, consultez le lien pour plus d'informations <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="L'espace est-il autorisé entre #! et / bin / bash dans shebang? - Unix et Linux Stack Exchange.">ici</a> .  Plus important encore, il n'y a pas de différence pour les interpréteurs de shell modernes, qu'il y ait ou non un espace. <br><br>  Assez de paroles, passons aux choses sérieuses!  Nous commençons le script et voyons une hypothèse intéressante, qui s'avère ne pas être entièrement vraie: <br><br><pre> <code class="plaintext hljs">$ ./Configure (I see you are using the Korn shell. Some ksh's blow up on Configure, especially on exotic machines. If yours does, try the Bourne shell instead.) Beginning of configuration questions for perl kit. Checking echo to see how to suppress newlines... ...using -n. Type carriage return to continue. Your cursor should be here--&gt;</code> </pre><br>  Étonnamment, le script est interactif et contient une énorme quantité d'informations contextuelles diverses.  Le modèle d'interaction utilisateur est construit sur des dialogues, analysant les réponses auxquelles le script modifie ses paramètres, selon lesquelles il générera ensuite des Makefiles.  Je voulais personnellement vérifier si toutes les commandes shell sont en place? <br><br><pre> <code class="plaintext hljs">Locating common programs... expr is in /bin/expr. sed is in /bin/sed. echo is in /bin/echo. cat is in /bin/cat. rm is in /bin/rm. mv is in /bin/mv. cp is in /bin/cp. tr is in /bin/tr. mkdir is in /bin/mkdir. sort is in /bin/sort. uniq is in /bin/uniq. grep is in /bin/grep. Don't worry if any of the following aren't found... test is in /bin/test. egrep is in /bin/egrep. I don't see Mcc out there, offhand.</code> </pre><br>  Apparemment avant, c'était loin d'être le cas.  Je me demande de quoi l'utilitaire <strong>Mcc</strong> est responsable, lequel est introuvable?  Le plus drôle, c'est que ce script dans les meilleures traditions des hackers de l'époque est plein d'humour amical.  Maintenant, vous verrez à peine ceci: <br><br><pre> <code class="plaintext hljs">Is your "test" built into sh? [n] (OK to guess) OK Checking compatibility between /bin/echo and builtin echo (if any)... They are compatible. In fact, they may be identical. Your C library is in /lib/libc.a. You're normal. Extracting names from /lib/libc.a for later perusal...done Hmm... Looks kind of like a USG system, but we'll see... Congratulations. You aren't running Eunice. It's not Xenix... Nor is it Venix... Checking your sh to see if it knows about # comments... Your sh handles # comments correctly. Okay, let's see if #! works on this system... It does. Checking out how to guarantee sh startup... Let's see if '#!/bin/sh' works... Yup, it does.</code> </pre><br>  J'ai répondu à la plupart des questions avec la valeur par défaut ou avec ce que le script m'a proposé.  La demande de drapeaux pour le compilateur et l'éditeur de liens a été particulièrement satisfaite et surprise: <br><br><pre> <code class="plaintext hljs">Any additional cc flags? [none] Any additional ld flags? [none]</code> </pre><br>  Vous pouvez y écrire quelque chose d'intéressant, par exemple, <strong>-m32</strong> pour créer un fichier exécutable 32 bits ou une bibliothèque, qui est nécessaire lors de la liaison.  À la dernière question du script: <br><br><pre> <code class="plaintext hljs">Now you need to generate make dependencies by running "make depend". You might prefer to run it in background: "make depend &gt; makedepend.out &amp;" It can take a while, so you might not want to run it right now. Run make depend now? [n] y</code> </pre><br>  J'ai répondu positivement.  A en juger par <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="makedepend, Histoire, page Wikipedia.">sa page</a> Wikipedia, l'ancien utilitaire <strong>makedepend a</strong> été créé au tout début de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="Projet Athéna, page Wikipedia.">la</a> vie du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="Projet Athéna, page Wikipedia.">projet Athena</a> pour faciliter le travail avec Makefiles.  Ce projet nous a donné le système X Window, Kerberos, Zephyr et a influencé beaucoup d'autres choses qui nous sont familières aujourd'hui.  Tout cela est merveilleux, mais d'où vient cet utilitaire dans un environnement Linux moderne?  Il n'a longtemps été utilisé par personne et nulle part.  Mais si vous regardez attentivement la racine du référentiel, il s'avère que Larry Wall a écrit sa version de script de remplacement, que nous avons soigneusement décompressée et exécuté le script de configuration. <br><br>  <strong>Makedepend</strong> terminé avec quelques erreurs étranges: <br><br><pre> <code class="bash hljs">./makedepend: <span class="hljs-built_in"><span class="hljs-built_in">command</span></span> substitution: line 82: unexpected EOF <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> looking <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> matching `<span class="hljs-string"><span class="hljs-string">''</span></span> ./makedepend: <span class="hljs-built_in"><span class="hljs-built_in">command</span></span> substitution: line 83: syntax error: unexpected end of file ./makedepend: <span class="hljs-built_in"><span class="hljs-built_in">command</span></span> substitution: line 82: unexpected EOF <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> looking <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> matching `<span class="hljs-string"><span class="hljs-string">''</span></span> ./makedepend: <span class="hljs-built_in"><span class="hljs-built_in">command</span></span> substitution: line 83: syntax error: unexpected end of file</code> </pre><br>  Ce sont peut-être eux qui ont causé le problème à cause duquel les Makefiles générés ont été un peu mâchés: <br><br><pre> <code class="bash hljs">$ make make: *** No rule to make target <span class="hljs-string"><span class="hljs-string">'&lt;built-in&gt;'</span></span>, needed by <span class="hljs-string"><span class="hljs-string">'arg.o'</span></span>. Stop.</code> </pre><br>  Je ne voulais absolument pas entrer dans la jungle des nouilles de coquille complexes de l'utilitaire <strong>makedepend</strong> et j'ai décidé de regarder attentivement les Makefiles, dans lesquels un motif étrange est apparu: <br><br><pre> <code class="plaintext hljs">arg.o: arg.c arg.o: arg.h arg.o: array.h arg.o: &lt;built-in&gt; arg.o: cmd.h arg.o: &lt;command-line&gt; arg.o: config.h arg.o: EXTERN.h ... array.o: arg.h array.o: array.c array.o: array.h array.o: &lt;built-in&gt; array.o: cmd.h array.o: &lt;command-line&gt; array.o: config.h array.o: EXTERN.h ...</code> </pre><br>  Apparemment, un utilitaire a incorrectement inséré ses arguments dans l'échappement.  En reprenant l'utilitaire de <s>hache</s> <strong>sed,</strong> j'ai décidé de corriger légèrement cette chose: <br><br><pre> <code class="bash hljs">$ sed -i <span class="hljs-string"><span class="hljs-string">'/built-in/d'</span></span> Makefile $ sed -i <span class="hljs-string"><span class="hljs-string">'/command-line/d'</span></span> Makefile</code> </pre><br>  Étonnamment, l'astuce a fonctionné et les Makefiles ont fonctionné comme ils le devraient! <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><em>&lt;&lt; Passer au contenu</em></a> <br><br><a name="yacc"></a><h2>  3. Erreurs de fichier de grammaire Yacc </h2><br>  Ce serait incroyable si le code vieux de 32 ans prenait et assemblait sans aucun problème.  Malheureusement, les miracles ne se produisent pas.  En étudiant l'arbre source, je suis tombé sur un fichier <strong>perl.y</strong> , qui est une description grammaticale de l'utilitaire <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="yacc, page Wikipedia.">yacc</a> , qui a longtemps été remplacé par <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="GNU Bison, page Wikipedia.">bison</a> dans les distributions modernes.  Le script situé sur le chemin <strong>/ usr / bin / yacc</strong> appelle simplement <strong>bison</strong> en mode de compatibilité avec <strong>yacc</strong> .  C'est juste que cette compatibilité n'est pas complète et lors du traitement de ce fichier, une énorme quantité d'erreurs affluent, que je ne sais pas comment corriger et que je ne veux pas vraiment, car il existe une solution alternative que j'ai apprise récemment. <br><br>  Il y a à peine un an ou deux, Helio Chissini de Castro, qui est le développeur de KDE, a effectué un travail similaire et adapté KDE 1, 2 et Qt 1, 2 aux environnements et compilateurs modernes.  Je me suis intéressé à son travail, j'ai téléchargé les codes sources des projets, mais lors de l'assemblage, je suis tombé sur un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="Adaptation moderne de Qt 2 par Helio Castro, Issues, GitHub repository.">piège</a> similaire en raison de l'incompatibilité du <strong>yacc</strong> et du <strong>bison</strong> , qui étaient utilisés pour construire l'ancienne version du métacompilateur moc.  Par la suite, j'ai réussi à trouver une solution à ce problème sous la forme du remplacement du <strong>bison</strong> par l'utilitaire <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="Berkeley Yacc, page officielle.">byacc</a> (Berkeley Yacc), qui s'est avéré compatible avec les anciennes grammaires pour <strong>yacc</strong> et était disponible dans de nombreuses distributions Linux. <br><br>  Un simple remplacement de <strong>yacc</strong> par <strong>byacc</strong> dans le système de construction m'a alors aidé, mais pas pour longtemps, car un peu plus tard dans les nouvelles versions de <strong>byacc, ils ont</strong> encore rompu la compatibilité avec <strong>yacc</strong> , interrompant le débogage associé à l'entité <strong>yydebug</strong> .  Par conséquent, j'ai dû légèrement <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="Correction d'une erreur de référence indéfinie, Pull Requests, adaptation moderne Qt 2 par Helio Castro, référentiel GitHub.">corriger la grammaire de l'</a> utilitaire. <br><br>  Ainsi, la stratégie de correction des erreurs de construction dans le fichier <strong>perl.y a</strong> été prédite par l'expérience précédente: installez l'utilitaire <strong>byacc</strong> , changez <strong>yacc</strong> en <strong>byacc</strong> dans tous les Makefiles, puis coupez <strong>yydebug</strong> de partout.  Ces actions ont résolu tous les problèmes avec ce fichier, les erreurs ont disparu et la compilation s'est poursuivie. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><em>&lt;&lt; Passer au contenu</em></a> <br><br><a name="c-errors"></a><h2>  4. Erreurs de compilation de code sur "C" </h2><br>  L'ancien code de Perl était plein d'horreurs, comme la notation depuis longtemps obsolète et oubliée des définitions de fonction du type K&amp;R: <br><br><pre> <code class="cpp hljs">format(orec,fcmd) <span class="hljs-keyword"><span class="hljs-keyword">register</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">outrec</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">orec</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">register</span></span> FCMD *fcmd; { ... } <span class="hljs-function"><span class="hljs-function">STR * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hfetch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(tb,key)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">register</span></span></span><span class="hljs-function"> HASH *tb</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *key; { ... } <span class="hljs-comment"><span class="hljs-comment">/*VARARGS1*/</span></span> fatal(pat,a1,a2,a3,a4) <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *pat; { <span class="hljs-built_in"><span class="hljs-built_in">fprintf</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">stderr</span></span>,pat,a1,a2,a3,a4); <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>); }</code> </pre><br>  Des fonctionnalités similaires ont été trouvées, par exemple, dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="Archéologie divertissante. Ou PVS-Studio vérifie Microsoft Word 1.1a, article sur la ressource Habr.">le</a> code <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="Archéologie divertissante. Ou PVS-Studio vérifie Microsoft Word 1.1a, article sur la ressource Habr.">Microsoft Word 1.1a</a> , qui est également assez ancien.  Le premier standard du langage de programmation «C», appelé «C89», n'apparaîtra que dans deux ans.  Les compilateurs modernes sont capables de travailler avec un tel code, mais certains IDE ne facilitent pas l'analyse de telles définitions et les mettent en évidence comme des erreurs de syntaxe, par exemple, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="IDE Qt Creator, page Wikipedia.">Qt Creator a</a> péché avant avant d'analyser le code qu'il <strong>contient dans la</strong> bibliothèque <strong>libclang</strong> . <br><br>  Le compilateur GCC 9.2.0, générant un grand nombre d'avertissements, s'est engagé à compiler l'ancien code de la première version de Perl.  Les feuilles des avertissements étaient si grandes que pour arriver à l'erreur, nous avons dû faire défiler plusieurs pages de l'échappement vers le haut.  À ma grande surprise, la plupart des erreurs de compilation étaient typiques et principalement liées à des définitions prédéfinies, qui jouaient le rôle de drapeaux pour l'assemblage. <br><br><div style="text-align:center;"><img title="Le travail du compilateur GCC 9.2.0 moderne et du débogueur GDB 8.3.1 dans le gestionnaire de fenêtres twm et l'émulateur de terminal xterm." src="https://habrastorage.org/getpro/habr/post_images/3a9/b3c/004/3a9b3c0041c48a06e6805bd39883c6a4.png"></div><br>  <i>Le travail du compilateur GCC 9.2.0 moderne et du débogueur GDB 8.3.1 dans le gestionnaire de fenêtres <strong>twm</strong> et l'émulateur de terminal <strong>xterm</strong> .</i> <br><br>  Sous STDSTDIO <strong>,</strong> Larry Wall a expérimenté une bibliothèque de langage de programmation ancienne et non standard «C», et sous DEBUGGING, <strong>il y</strong> avait des informations de débogage avec le fameux <strong>yydebug</strong> , que j'ai mentionné ci-dessus.  Par défaut, ces indicateurs ont été activés.  En les désactivant dans le fichier <strong>perl.h</strong> et en ajoutant des définitions oubliées, j'ai pu réduire considérablement le nombre d'erreurs. <br><br>  Un autre type d'erreur remplace les fonctions désormais normalisées de la bibliothèque standard et de la couche POSIX.  Le projet possède ses propres <strong>malloc ()</strong> , <strong>setenv ()</strong> et autres entités qui ont créé des conflits. <br><br>  Quelques endroits ont défini des fonctions statiques sans déclarations.  Au fil du temps, les compilateurs ont commencé à adopter une approche plus stricte de ce problème et ont <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="Comment résoudre la déclaration statique suit la déclaration non statique dans le code GCC C? - Débordement de pile.">transformé l'avertissement en une erreur</a> .  Et enfin, quelques en-têtes oubliés, où iriez-vous sans eux. <br><br>  À ma grande surprise, le correctif pour le code de 32 ans s'est avéré si minuscule qu'il peut être entièrement cité ici: <br><br><pre> <code class="diff hljs">diff --git a/malloc.cb/malloc.c index 17c3b27..a1dfe9c 100644 --- a/malloc.c +++ b/malloc.c @@ -79,6 +79,9 @@ static u_int nmalloc[NBUCKETS]; #include &lt;stdio.h&gt; #endif +static findbucket(union overhead *freep, int srchlen); +static morecore(register bucket); + #ifdef debug #define ASSERT(p) if (!(p)) botch("p"); else static diff --git a/perl.hb/perl.h index 3ccff10..e98ded5 100644 --- a/perl.h +++ b/perl.h @@ -6,16 +6,16 @@ * */ -#define DEBUGGING -#define STDSTDIO /* eventually should be in config.h */ +//#define DEBUGGING +//#define STDSTDIO /* eventually should be in config.h */ #define VOIDUSED 1 #include "config.h" -#ifndef BCOPY -# define bcopy(s1,s2,l) memcpy(s2,s1,l); -# define bzero(s,l) memset(s,0,l); -#endif +//#ifndef BCOPY +//# define bcopy(s1,s2,l) memcpy(s2,s1,l); +//# define bzero(s,l) memset(s,0,l); +//#endif #include &lt;stdio.h&gt; #include &lt;ctype.h&gt; @@ -183,11 +183,11 @@ double atof(); long time(); struct tm *gmtime(), *localtime(); -#ifdef CHARSPRINTF - char *sprintf(); -#else - int sprintf(); -#endif +//#ifdef CHARSPRINTF +// char *sprintf(); +//#else +// int sprintf(); +//#endif #ifdef EUNICE #define UNLINK(f) while (unlink(f) &gt;= 0) diff --git a/perl.yb/perl.y index 16f8a9a..1ab769f 100644 --- a/perl.y +++ b/perl.y @@ -7,6 +7,7 @@ */ %{ +#include &lt;stdlib.h&gt; #include "handy.h" #include "EXTERN.h" #include "search.h" diff --git a/perly.cb/perly.c index bc32318..fe945eb 100644 --- a/perly.c +++ b/perly.c @@ -246,12 +246,14 @@ yylex() static bool firstline = TRUE; retry: +#ifdef DEBUGGING #ifdef YYDEBUG if (yydebug) if (index(s,'\n')) fprintf(stderr,"Tokener at %s",s); else fprintf(stderr,"Tokener at %s\n",s); +#endif #endif switch (*s) { default: diff --git a/stab.cb/stab.c index b9ef533..9757cfe 100644 --- a/stab.c +++ b/stab.c @@ -7,6 +7,7 @@ */ #include &lt;signal.h&gt; +#include &lt;errno.h&gt; #include "handy.h" #include "EXTERN.h" #include "search.h" diff --git a/util.hb/util.h index 4f92eeb..95cb9bf 100644 --- a/util.h +++ b/util.h @@ -28,7 +28,7 @@ void prexit(); char *get_a_line(); char *savestr(); int makedir(); -void setenv(); +//void setenv(); int envix(); void notincl(); char *getval();</code> </pre><br>  Excellent résultat pour un code de 32 ans!  La <strong>référence non définie au</strong> bogue de liaison <strong>`crypt 'a</strong> été corrigée en ajoutant la directive <em>-lcrypt</em> au Makefile avec la bibliothèque <strong>libcrypt</strong> appropriée, après quoi j'ai finalement obtenu l'exécutable d'interpréteur Perl souhaité: <br><br><pre> <code class="bash hljs">$ file perl perl: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=fd952ceae424613568530b3a2ca88ebd6477e0ae, <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> GNU/Linux 3.2.0, not stripped</code> </pre><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><em>&lt;&lt; Passer au contenu</em></a> <br><br><a name="segfaults"></a><h2>  5. Correction de certaines erreurs Défaut de segmentation </h2><br>  Après une compilation presque sans tracas, la chance m'a tourné le dos.  Immédiatement après le démarrage de l'interpréteur Perl assemblé, j'ai eu quelques erreurs étranges et un défaut de segmentation à la fin: <br><br><pre> <code class="bash hljs">$ ./perl -e <span class="hljs-string"><span class="hljs-string">'print "Hello World!\n";'</span></span> Corrupt malloc ptr 0x2db36040 at 0x2db36000 Corrupt malloc ptr 0x2db36880 at 0x2db36800 Corrupt malloc ptr 0x2db36080 at 0x2db36040 Corrupt malloc ptr 0x2db37020 at 0x2db37000 Segmentation fault (core dumped)</code> </pre><br>  Après avoir rongé le texte source de la phrase <em>Corrupt malloc</em> , il s'est avéré qu'au lieu du système <strong>malloc ()</strong> une sorte d'allocateur personnalisé a été appelée à partir de 1982.  Fait intéressant, <strong>Berkeley est</strong> écrit dans l'un des littéraux de chaîne de son code source et <strong>Caltech</strong> dans un commentaire à côté.  La collaboration entre ces universités était alors évidente très forte.  En général, j'ai commenté cet allocateur de hacker et reconstruit le code source.  Les erreurs de corruption de mémoire ont disparu, mais l'erreur de segmentation est restée.  Ce n'était donc pas le point, et maintenant nous devons découvrir le débogueur. <br><br>  En exécutant le programme sous <strong>gdb,</strong> j'ai constaté que le crash se produit lorsque la fonction de création d'un fichier temporaire <strong>mktemp () à</strong> partir de libc est appelée: <br><br><pre> <code class="plaintext hljs">$ gdb --args ./perl -e 'print "Hello, World!\n";' (gdb) r Starting program: /home/exl/perl5/perl -e print\ \"Hello\ World\!\\n\"\; Program received signal SIGSEGV, Segmentation fault. 0x00007ffff7cd20c7 in __gen_tempname () from /usr/lib/libc.so.6 (gdb) bt #0 0x00007ffff7cd20c7 in __gen_tempname () from /usr/lib/libc.so.6 #1 0x00007ffff7d71577 in mktemp () from /usr/lib/libc.so.6 #2 0x000055555556bb08 in main ()</code> </pre><br>  Soit dit en passant, l'éditeur de liens jurait auparavant à cette fonction.  Pas un compilateur, mais un éditeur de liens, ce qui m'a surpris: <br><br><pre> <code class="plaintext hljs">/usr/bin/ld: perl.o: in function `main': perl.c:(.text+0x978c): warning: the use of `mktemp' is dangerous, better use `mkstemp' or `mkdtemp'</code> </pre><br>  La première pensée qui vous est probablement venue à l'esprit était également de remplacer la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="La bibliothèque GNU C, fichiers temporaires, documentation officielle GNU.">fonction dangereuse</a> <strong>mktemp ()</strong> par <strong>mkstemp ()</strong> , ce que j'ai fait.  L'avertissement de l'éditeur de liens a disparu, mais la faute de segmentation est restée à cet endroit de toute façon, seulement maintenant, elle était dans la fonction <strong>mkstemp ()</strong> . <br><br>  Par conséquent, vous devez maintenant regarder très attentivement le morceau de code associé à cette fonction.  Là, j'ai découvert une chose assez étrange qui est mise en évidence dans cet extrait: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *e_tmpname = <span class="hljs-string"><span class="hljs-string">"/tmp/perl-eXXXXXX"</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ mktemp(e_tmpname); e_fp = f_open(e_tmpname, <span class="hljs-string"><span class="hljs-string">"w"</span></span>); ... }</code> </pre><br>  Il s'avère que <strong>mktemp ()</strong> essaie de changer le littéral du masque, qui se trouve dans la section <strong>.rodata</strong> , qui est évidemment voué à l'échec.  Ou, après tout, il y a 32 ans, c'était acceptable, respecté dans le code, et même d'une manière ou d'une autre fonctionné? <br><br>  Bien sûr, le remplacement de <strong>char * e_tmpname</strong> par <strong>char e_tmpname [] a</strong> corrigé cette erreur de segmentation et j'ai pu obtenir ce que j'ai tué pour toute la soirée: <br><br><pre> <code class="bash hljs">$ ./perl -e <span class="hljs-string"><span class="hljs-string">'print "Hello World!\n";'</span></span> $ Hello, World! $ ./perl -e <span class="hljs-string"><span class="hljs-string">'$a = 5; $b = 6.3; $c = $a+$b; print $c."\n";'</span></span> $ 11.3000000000000007 $ ./perl -v <span class="hljs-variable"><span class="hljs-variable">$Header</span></span>: perly.c,v 1.0 87/12/18 15:53:31 root Exp $ Patch level: 0</code> </pre><br>  Nous avons vérifié l'exécution à partir de la ligne de commande, mais qu'en est-il du fichier?  J'ai téléchargé le premier «Hello World» pour le langage de programmation Perl sur Internet: <br><br><pre> <code class="perl hljs"><span class="hljs-comment"><span class="hljs-comment">################# test.pl #!/usr/bin/perl # # The traditional first program. # Strict and warnings are recommended. use strict; use warnings; # Print a message. print "Hello, World!\n";</span></span></code> </pre><br>  Ensuite, j'ai essayé de l'exécuter, mais, hélas, l'erreur de segmentation m'attendait à nouveau.  Cette fois dans un endroit complètement différent: <br><br><pre> <code class="plaintext hljs">$ gdb --args ./perl test.pl (gdb) r Starting program: /home/exl/perl5/perl test.pl Program received signal SIGSEGV, Segmentation fault. 0x00007ffff7d1da75 in __strcpy_sse2_unaligned () from /usr/lib/libc.so.6 (gdb) bt #0 0x00007ffff7d1da75 in __strcpy_sse2_unaligned () from /usr/lib/libc.so.6 #1 0x00005555555629ea in yyerror () #2 0x0000555555568dd6 in yyparse () #3 0x000055555556bd4f in main ()</code> </pre><br>  Le point intéressant suivant a été trouvé dans la fonction <strong>yyerror ()</strong> , je cite l'extrait d'origine: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// perl.y char *tokename[] = { "256", "word", "append", ... // perl.c yyerror(s) char *s; { char tmpbuf[128]; char *tname = tmpbuf; if (yychar &gt; 256) { tname = tokename[yychar-256]; // ??? if (strEQ(tname,"word")) strcpy(tname,tokenbuf); // Oops! else if (strEQ(tname,"register")) sprintf(tname,"$%s",tokenbuf); // Oops! ...</span></span></code> </pre><br>  Encore une fois, la situation est similaire à celle dont j'ai parlé plus haut.  Les données de la section <strong>.rodata</strong> sont à <strong>nouveau modifiées</strong> .  Peut-être que c'est juste des fautes de frappe à cause de Copy-Paste et au lieu de <strong>tname,</strong> ils voulaient écrire <strong>tmpbuf</strong> ?  Ou y a-t-il vraiment une sorte de signification cachée derrière cela?  Dans tous les cas, le remplacement de <strong>char * tokename []</strong> par <strong>char tokename [] [32]</strong> supprime l'erreur de panne de segmentation et Perl nous dit ce qui suit: <br><br><pre> <code class="bash hljs">$ ./perl test.pl syntax error <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> file test.pl at line 7, next token <span class="hljs-string"><span class="hljs-string">"strict"</span></span> Execution aborted due to compilation errors.</code> </pre><br>  Il s'avère qu'il n'aime pas toutes sortes d' <strong>utilisations strictes</strong> , c'est ce qu'il essaie de nous dire!  Si vous supprimez ou commentez ces lignes dans le fichier, le programme démarre: <br><br><pre> <code class="bash hljs">$ ./perl test.pl Hello, World!</code> </pre><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><em>&lt;&lt; Passer au contenu</em></a> <br><br><a name="theend"></a><h2>  6. Pour résumer </h2><br>  En fait, j'ai atteint mon objectif et fait que l'ancien code de 1987 non seulement compile, mais fonctionne également dans un environnement Linux moderne.  Sans aucun doute, il reste encore une grande pile d'erreurs de défauts de segmentation diverses, probablement liées à la taille du pointeur sur une architecture 64 bits.  Tout cela peut être nettoyé après quelques soirées avec le débogueur prêt.  Mais ce n'est pas une tâche très agréable et plutôt fastidieuse.  Après tout, cette expérience était initialement conçue comme un divertissement pour une soirée ennuyeuse, et non comme une œuvre à part entière, qui prendra fin.  Y a-t-il un avantage pratique des actions entreprises?  Peut-être qu'un jour, un archéologue numérique rencontrera cet article et il lui sera utile.  Mais dans le monde réel, même l'expérience tirée de ces recherches, à mon avis, n'est pas trop précieuse. <br><br>  Si quelqu'un est intéressé, je poste un ensemble de deux patchs.  Le premier corrige les erreurs de compilation et le second corrige certaines erreurs de segmentation. <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="Correction du correctif des erreurs de compilation, référentiel EXLMOTODEV GitHub."><strong>Perl1987-Fix-compilation-errors.patch</strong></a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="Correction d'un correctif de défauts de segmentation, référentiel EXLMOTODEV GitHub."><strong>Perl1987-Fix-some-Segmentation-Faults.patch</strong></a> </li></ul><br>  PS Je m'empresse de bouleverser les fans de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="Programme Perl Single Line, article de Lurkmore.">joueurs destructeurs sur une seule ligne</a> , cela ne fonctionne pas ici.  La version de Perl est peut-être trop ancienne pour un tel divertissement. <br>  PPS Tout va bien et passez un bon week-end.  Merci à <strong>kawaii_neko</strong> pour une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="Perl directement de 1987, commentez la ressource LINUX.ORG.RU">petite correction</a> . <br><br>  <em>Mise à jour du 28 octobre 2019: un</em> utilisateur du forum LINUX.ORG.RU, utilisant le surnom <strong>utf8nowhere</strong> , a fourni des liens très intéressants <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="Perl directement de 1987, commentez la ressource LINUX.ORG.RU">dans son commentaire</a> sur cet article, dont les informations clarifient non seulement la situation avec les littéraux de chaîne mutables, mais prennent même en compte le problème d'utilisation décrit ci-dessus. <strong>Fonctions mktemp ()</strong> !  Permettez-moi de citer ces sources, qui décrivent diverses incompatibilités entre le K&amp;R C non normalisé et le GNU C: <br><blockquote>  <strong>Incompatibilités de GCC</strong> <br>  Il existe plusieurs incompatibilités notables entre les versions GNU C et K&amp;R (non ISO) de C. <br><br>  GCC fait normalement des constantes de chaîne en lecture seule.  Si plusieurs constantes de chaîne d'aspect identique sont utilisées, GCC ne stocke qu'une seule copie de la chaîne. <br>  Une conséquence est que vous ne pouvez pas appeler <strong>mktemp</strong> avec un argument de chaîne constante.  La fonction <strong>mktemp</strong> modifie toujours la chaîne vers laquelle pointe son argument. <br><br>  Une autre conséquence est que <strong>sscanf</strong> ne fonctionne pas sur certains systèmes lorsqu'il <strong>reçoit</strong> une constante de chaîne comme chaîne ou entrée de contrôle de format.  Cela est dû au fait que <strong>sscanf</strong> essaie incorrectement d'écrire dans la constante de chaîne.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De même </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fscanf</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">scanf</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La meilleure solution à ces problèmes consiste à modifier le programme pour utiliser des </font><font style="vertical-align: inherit;">variables </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">char</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -array avec des chaînes d'initialisation à ces fins au lieu de constantes de chaîne. </font><font style="vertical-align: inherit;">Mais si cela n'est pas possible, vous pouvez utiliser l' </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">indicateur -fwritable-strings</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui indique à GCC de gérer les constantes de chaîne de la même manière que la plupart des compilateurs C. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Source: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="Utilisation du manuel officiel de la collection de compilateurs GNU (GCC 3.3)."><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Utilisation du manuel officiel de GNU Compiler Collection (GCC 3.3)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L' </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">indicateur de</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> compilateur </font><strong><font style="vertical-align: inherit;">-fwritable-strings</font></strong><font style="vertical-align: inherit;"> a </font><font style="vertical-align: inherit;">été déconseillé dans GCC 3.4 et définitivement supprimé dans GCC 4.0.</font></font><br><blockquote> <strong>ANSI C rationale | String literals</strong> <br> String literals are specified to be unmodifiable. This specification allows implementations to share copies of strings with identical text, to place string literals in read-only memory, and perform certain optimizations. However, string literals do not have the type array of const char, in order to avoid the problems of pointer type checking, particularly with library functions, since assigning a pointer to const char to a plain pointer to char is not valid. Those members of the Committee who insisted that string literals should be modifiable were content to have this practice designated a common extension (see F.5.5). <br><br> Existing code which modifies string literals can be made strictly conforming by replacing the string literal with an initialized static character array. For instance, <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *p, *make_temp(<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *str); <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> p = make_temp(<span class="hljs-string"><span class="hljs-string">"tempXXX"</span></span>); <span class="hljs-comment"><span class="hljs-comment">/* make_temp overwrites the literal */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* with a unique name */</span></span></code> </pre><br> can be changed to: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *p, *make_temp(<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *str); <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>[ ] = <span class="hljs-string"><span class="hljs-string">"tempXXX"</span></span>; p = make_temp( <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> ); }</code> </pre><br> : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="Justification de l'American National Standard for Information Systems, Programming Language C, String literals.">Rationale for American National Standard for Information Systems, Programming Language C</a> . <br></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'utilisateur </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VarfolomeyKote4ka a</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> proposé un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="Perl directement de 1987, commentez la ressource LINUX.ORG.RU"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hack sale intéressant</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> qui vous permet de contourner les erreurs de segmentation lors des tentatives de modification des données dans la section </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.rodata</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en les convertissant en section </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.rwdata</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Il n'y a pas si longtemps, un article très intéressant est apparu sur Internet, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="Du .rodata au .rwdata - introduction au mappage de la mémoire et aux scripts LD, Guy on BITS."><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">«Du .rodata au .rwdata - introduction au mappage de la mémoire et aux scripts LD»</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> par le programmeur </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">guye1296</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui explique comment faire cette astuce. Pour faciliter l'obtention du résultat souhaité, l'auteur de l'article a préparé un script assez volumineux pour l'éditeur de liens standard </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ld</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><a href="" title="Script rwdata.ld pour ld linker, guye1296, référentiel GitHub."><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rwdata.ld</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Il suffit de télécharger ce script, de le placer à la racine du répertoire source Perl, de corriger l'indicateur </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LDFLAGS</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> comme suit: </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LDFLAGS = -T rwdata.ld</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , puis reconstruire le projet. </font><font style="vertical-align: inherit;">En conséquence, nous avons les éléments suivants:</font></font><br><br><pre> <code class="bash hljs">$ make clean &amp;&amp; make -j1 $ mv perl perl_rodata $ curl -LOJ https://raw.githubusercontent.com/guye1296/ld_script_elf_blog_post/master/rwdata.ld $ sed -i <span class="hljs-string"><span class="hljs-string">'s/LDFLAGS =/LDFLAGS = -T rwdata.ld/'</span></span> Makefile $ make clean &amp;&amp; make -j1 $ mv perl perl_rwdata $ objdump -s -j .rodata perl_rodata | grep tmp -2 19da0 21233f5e 7e3d2d25 30313233 34353637 !<span class="hljs-comment"><span class="hljs-comment">#?^~=-%01234567 19db0 38392e2b 262a2829 2c5c2f5b 7c002400 89.+&amp;*(),\/[|.$. 19dc0 73746465 7272002f 746d702f 7065726c stderr./tmp/perl 19dd0 2d655858 58585858 00323536 00617070 -eXXXXXX.256.app 19de0 656e6400 6c6f6f70 63746c00 66756e63 end.loopctl.func $ objdump -s -j .rwdata perl_rodata | grep tmp -2 objdump: section '.rwdata' mentioned in a -j option, but not found in any input file $ objdump -s -j .rwdata perl_rwdata | grep tmp -2 41d9c0 21233f5e 7e3d2d25 30313233 34353637 !#?^~=-%01234567 41d9d0 38392e2b 262a2829 2c5c2f5b 7c002400 89.+&amp;*(),\/[|.$. 41d9e0 73746465 7272002f 746d702f 7065726c stderr./tmp/perl 41d9f0 2d655858 58585858 00323536 00617070 -eXXXXXX.256.app 41da00 656e6400 6c6f6f70 63746c00 66756e63 end.loopctl.func $ objdump -s -j .rodata perl_rwdata | grep tmp -2 objdump: section '.rodata' mentioned in a -j option, but not found in any input file $ ./perl_rodata -e 'print "Hello, World!\n";' Segmentation fault (core dumped) $ ./perl_rwdata -e 'print "Hello, World!\n";' Hello, World!</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il s'avère que grâce à ce hack, presque toutes les modifications du deuxième patch peuvent être simplement omises! </font><font style="vertical-align: inherit;">Bien que, bien sûr, amener le code à un aspect qui ne viole pas les normes est toujours préférable. </font></font><br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&lt;&lt; Passer au contenu</font></font></em></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr473228/">https://habr.com/ru/post/fr473228/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr473214/index.html">Yaga - Contes slaves dans le cadre mobile</a></li>
<li><a href="../fr473218/index.html">Entretien avec Ivan Kruglov, développeur principal: Service Mesh et outils Booking.com «non standard»</a></li>
<li><a href="../fr473220/index.html">Les pierres angulaires de la destruction lente de code dans Wolfram Language: accélérer des dizaines, des centaines et des milliers de fois</a></li>
<li><a href="../fr473222/index.html">Règles iptables personnalisées pour docker utilisant zabbix comme exemple</a></li>
<li><a href="../fr473224/index.html">Enseignement supérieur vs compétence. Opinion individuelle d'un juge de la Cour constitutionnelle de la Fédération de Russie sur l'état de l'enseignement supérieur</a></li>
<li><a href="../fr473230/index.html">L'Internet par satellite est-il une nouvelle course à l'espace?</a></li>
<li><a href="../fr473232/index.html">Quel système de contrôle de version utilisez-vous (en vrai travail, la plupart)?</a></li>
<li><a href="../fr473234/index.html">Création d'une API REST avec Node.js et une base de données Oracle</a></li>
<li><a href="../fr473236/index.html">Travail en informatique, gestion de projet, régulation PD et développement dans le cloud: mégadigest de 1cloud.ru</a></li>
<li><a href="../fr473238/index.html">Comment fonctionne Netflix</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>