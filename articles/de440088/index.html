<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üï£ ü•† üï∞Ô∏è bobaflu - Programmierzubeh√∂r auf Flattern üò∞ üö™ üèÇüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dieser Artikel konzentriert sich auf die Implementierung des mobilen Flutter-Clients. 


 Welcher mobile Client? 


 In der vorherigen Ver√∂ffentlichun...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>bobaflu - Programmierzubeh√∂r auf Flattern</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/440088/"><p><img src="https://habrastorage.org/webt/-n/0y/sv/-n0ysvv41yt_uwk8hh-fa1ui79e.png"></p><br><p> Dieser Artikel konzentriert sich auf die Implementierung des mobilen Flutter-Clients. </p><br><p>  Welcher mobile Client? </p><br><p>  In der vorherigen Ver√∂ffentlichung wurde das System des Softwarezubeh√∂rs beschrieben: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">bobaoskit - Zubeh√∂r, dnssd und WebSocket</a> . </p><br><p> Ein Analogon eines Software-Zubeh√∂rs ist ein echtes Objekt.  Gl√ºhbirne, Schalter, CD- / Kassettenrekorder, Radioplayer, Thermostat, Temperatursensor, Bewegungssensor usw. ... Ein Satz Zubeh√∂r wird durch Vorstellungskraft und Programmcode bestimmt.  Sie k√∂nnen mindestens ein Schachbrett implementieren.  F√ºr eine solche Karte muss ein Kontrollfeld ( <code>control</code> ) <code>move</code> , das beispielsweise ein Objekt <code>{ from: "e2", to: "e4" }</code> und Servicefelder zum Zur√ºcksetzen von Zahlen usw. enth√§lt. Das Zubeh√∂rskript verarbeitet die Anforderung zum Steuern des <code>move</code> , akzeptieren Die Entscheidung ist, ob es m√∂glich ist, die Figur zu bewegen, und ob der Status mit der Position der Figuren im gesamten Feld zur√ºckgegeben wird (oder nicht). </p><br><p>  Derzeit unterst√ºtzte Zubeh√∂rarten mit minimaler Funktionalit√§t sind: "Schalter", "Temperatursensor", "Thermostat", "Radio-Player". </p><br><p>  √úber Schach wird es keine weitere Diskussion geben.  Wenn es interessant ist und in diesem Fall, willkommen bei Katze. </p><a name="habracut"></a><br><p>  Also ist <code>bobaoskit.worker</code> Betrieb.  Im Speicher des Computers befinden sich Zubeh√∂robjekte. Sie k√∂nnen Informationen dazu lesen, eine <code>JSON</code> Anforderung manuell an den <code>WebSocket</code> Port senden und eingehende Ereignisse anzeigen. </p><br><p>  F√ºr das Management habe ich die einfachste mobile Anwendung erstellt. </p><br><h2 id="pochemu-flutter">  Warum flattern? </h2><br><p>  In den letzten Jahren lebte in meinem Kopf eine Idee, Programmierung f√ºr mobile Ger√§te zu studieren.  Da ich in <code>JavaScript</code> schreibe, habe ich L√∂sungen studiert, mit denen Sie keine neue Programmiersprache lernen k√∂nnen. </p><br><p>  <code>Appcelerator</code>  Er begann das Studium mit ihm.  Wenn sich der Speicher nicht √§ndert, ist das SDK ge√∂ffnet, aber die IDE mit verschiedenen Tarifen. <br>  <code>NativeScript</code>  Hier habe ich bereits eine einfache Anwendung erstellt, die eine Liste mit Bildern zeigt.  Es ging nicht weiter. <br>  <code>ReactNative</code>  Der l√§ngste Angriff der bisher aufgef√ºhrten Frameworks.  Die gr√∂√üte Herausforderung besteht darin, loszulegen.  Ich habe mir den Kurs angesehen.  Zun√§chst ist es klar, interessant, es stellt sich heraus.  Aber <code>redux</code> und nach √úberw√§ltigung scheiterten.  Dann versuchte er regelm√§√üig zu schreiben, aber <code>redux</code> erlaubte sich nicht, sich zu √ºberw√§ltigen. </p><br><p>  Infolgedessen war ich damals (Ende 2016) an keine Entscheidung gebunden.  Vielleicht, weil es keine bestimmte Aufgabe gab, vielleicht aus anderen Gr√ºnden. </p><br><p>  N√§her am Herbst der Vergangenheit (2018) wurde bereits an der SDK f√ºr Software-Zubeh√∂r gearbeitet.  Nat√ºrlich ben√∂tigen Sie eine mobile Anwendung.  Alles begann mit mdns.  In meiner Freizeit habe ich ReactNative aktualisiert, das Plugin "react-native-zeroconf" gefunden und die Anwendung erstellt.  Gem√§√ü den Anweisungen installiert, einen <code>link</code> , gestartet.  Die Expo-Debugging-Anwendung wurde gestartet, die keine nativen Module unterst√ºtzt, und dementsprechend funktionierte das mdns-Plugin nicht.  Zu diesem Zeitpunkt war nicht gen√ºgend Zeit vorhanden, um eine saubere (ohne Expo) reaktionsnative Anwendung zu erstellen und damit zu testen.  Die Arbeit wurde um einige Monate verschoben. </p><br><p>  Gleichzeitig erschienen immer mehr Materialien √ºber das <code>flutter</code> im Netzwerk.  Ich habe mich installiert.  Die Installation ist einfach: <code>git clone</code> und zu <code>PATH</code> hinzuf√ºgen.  Der Rest richtet bereits das Android SDK / Xcode ein (in meinem Fall ist das Android SDK bereits seit langer Zeit eingerichtet. Ich kann es nicht f√ºr iOS entwickeln, da ich kein MacOS-Benutzer bin) und das Dart SDK (kann separat installiert werden, aber nicht unbedingt, da es Teil des Flatterns ist). </p><br><h2 id="principshema-raboty">  Prinzip / Arbeitsschema </h2><br><ul><li>  Beim Start sucht die Anwendung mithilfe des Plugins <code>_bobaoskit._tcp</code> im lokalen Netzwerk nach <code>_bobaoskit._tcp</code> Diensten.  Es gibt mehrere Versionen dieses Plugins, die alle ihre Wurzeln in der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ver√∂ffentlichten</a> Version haben. Es ist jedoch nicht mit neuen Versionen des Dart SDK kompatibel. Viele haben eine gegabelte und zus√§tzliche Kompatibilit√§t.  Ich habe diese Version gew√§hlt, weil die anderen die Hosts mehrerer erkannter Dienste nicht gleichzeitig aufgel√∂st haben. <br>  Bei Erkennung und Bestimmung (onResolve) wird der Host zur Liste hinzugef√ºgt. <br>  Die Seite mit der Liste der <code>setState() {...}</code> Dienste lautet <code>StatefulWidget</code> . Wenn Dienste <code>setState() {...}</code> / verloren werden, wird <code>setState() {...}</code> aufgerufen </li><li>  Bei der Auswahl eines Hosts aus der Liste wird eine neue Seite (auch <code>StatefulWidget</code> ) erstellt, an die der <code>host</code> und der <code>port</code> ausgew√§hlten Dienstes √ºbertragen werden. <br>  Das f√ºr die Kommunikation verantwortliche <code>BobaosKit</code> Objekt wird erstellt.  Antworten werden durch R√ºckrufe verarbeitet  w√§hrend ich nicht viel asynchronen Dart studierte.  Nach der gescannten Dokumentation ist <code>Futures</code> jedoch ein Analogon zu <code>Promise</code> in JS. <br>  Funktionen werden f√ºr eingehende Ereignisse aufgezeichnet (keine Antworten).  <code>EventEmitter</code> hier nach <code>EventEmitter</code> f√ºr Dart <code>EventEmitter</code> .  Ich habe meine sehr einfache geschrieben. </li></ul><br><pre> <code class="plaintext hljs"> void registerListener(String name, Function cb) { this._events.add(new BobaosKitCallback(name, cb)); } void removeAllListeners() { this._events = []; } void emitEvent(String name, dynamic params) { // call all listeners List&lt;BobaosKitCallback&gt; foundCallbacks = this._events.where((t) =&gt; t.name == name).toList(); foundCallbacks.forEach((f) =&gt; f.cb(params)); } ... ... void listen() { this.ws.listen((text) { var json = jsonDecode(text); if (json.containsKey('response_id')) { .... } else { //   response_id -  this.emitEvent(json['method'], json['payload']); } }); }</code> </pre> <br><p>  Eingehende Ereignisse - Wenn das Zubeh√∂r entfernt, hinzugef√ºgt und der Status aktualisiert wurde.  Oder wenn alle Zubeh√∂rteile entfernt sind ( <code>clear accessories</code> ). </p><br><p>  Registrierte Funktionen - zum Aktualisieren von Listen, Widgets f√ºr diese Ereignisse. </p><br><ul><li>  Es wird eine Anfrage f√ºr Informationen zu s√§mtlichem Zubeh√∂r gesendet. </li></ul><br><p>  F√ºr jedes Zubeh√∂r wird ein AccessoryInfo-Objekt erstellt: </p><br><pre> <code class="plaintext hljs">import 'package:scoped_model/scoped_model.dart'; // AccessoryInfo extends Model // so, when accessory value is updated it descends down to // all widgets inside ScopedModelDescendant class AccessoryInfo extends Model { dynamic id; dynamic type; String name; String job_channel; List control; List status; bool selected; Map&lt;dynamic, dynamic&gt; currentState; AccessoryInfo(Map&lt;dynamic, dynamic&gt; obj) { this.id = obj['id']; this.type = obj['type']; this.name = obj['name']; this.job_channel = obj['job_channel']; this.control = obj['control']; this.status = obj['status']; this.currentState = {}; } void updateCurrentState(key, value) { currentState[key] = value; notifyListeners(); } void notify() { notifyListeners(); } }</code> </pre> <br><p>  Dieses Objekt ist bereits ein Modell.  Anfangs habe ich √ºberall <code>StatefulWidget</code> und <code>setState() {}</code> , aber <code>setState() {}</code> funktioniert nur f√ºr ein Widget, in dem Listener registriert sind.  F√ºr eine detaillierte Verwaltung der Zubeh√∂rteile habe ich zun√§chst neue <code>Stateful</code> Seiten erstellt und festgestellt, dass der Status nicht aktualisiert wird.  Als L√∂sung - verwendet <code>ScopedModel</code> . </p><br><p>  Nachdem die Liste der Zubeh√∂rteile eingegangen ist, senden wir f√ºr jedes Zubeh√∂r eine Statusanfrage und f√ºgen sie der Liste <code>List &lt;AccessoryInfo&gt;</code> .  Rufen Sie <code>setState() {}</code> und f√ºgen Sie der Schnittstelle ein unterst√ºtztes Zubeh√∂r hinzu.  Unterst√ºtzte Zubeh√∂rtypen werden in <code>ListView.builder</code> und in <code>./lib/widgets/*.dart</code> .  Derzeit unterst√ºtzter <code>switch/temperature sensor/radio player/thermostat</code> .  Die Hauptarbeit besteht darin, neue hinzuzuf√ºgen und vorhandene Widgets zu verbessern. </p><br><ul><li>  Nun erfahren Sie, wie Sie f√ºr jedes Zubeh√∂r separate Elemente erstellen.  Betrachten Sie beispielsweise einen Schalter. </li></ul><br><pre> <code class="plaintext hljs"> @override Widget build(BuildContext context) { return new ScopedModel&lt;AccessoryInfo&gt;( model: info, child: ScopedModelDescendant&lt;AccessoryInfo&gt;( builder: (context, child, model) { var cardColor = Theme.of(context).cardColor; dynamic switchState = model.currentState['state']; if (switchState is bool) { if (switchState) { cardColor = Colors.deepPurple; } else { cardColor = Theme.of(context).cardColor; } } return Card( color: cardColor, child: ListTile( selected: false, leading: new Icon(Icons.lightbulb_outline), title: new Text("${model.name}"), onTap: () { // to control accessory value // get status value at first bobaos.getStatusValue( model.id, "state", (bool err, Object payload) { if (err) { return print('error ocurred $payload'); } if (payload is Map) { dynamic currentValue = payload['status']['value']; bool newValue; if (currentValue is bool) { // invert newValue = !currentValue; } else { newValue = false; } // then send new value bobaos.controlAccessoryValue( model.id, {"state": newValue}, (bool err, Object payload) { if (err) { return print('error ocurred $payload'); } }); } }); }, onLongPress: () { // TODO: dialog with additional funcs }, )); })); }</code> </pre> <br><p>  F√ºr ein Zubeh√∂r vom Typ <code>switch</code> wird in der allgemeinen Zubeh√∂rliste ein Element erstellt, wenn bei der Interaktion (onTap) eine Anforderung zum Abrufen des aktuellen Werts gesendet wird, um diesen Wert dann zu wechseln.  <code>ScopedModel</code> k√∂nnen <code>ScopedModel</code> das Widget f√ºr eingehende Statusaktualisierungen neu zeichnen. </p><br><p>  Ein Long-Click-Handler ist f√ºr dieses Zubeh√∂r nicht implementiert. </p><br><p>  F√ºr einen Radioplayer sieht es so aus: </p><br><pre> <code class="plaintext hljs"> onLongPress: () { Navigator.of(context).push(MaterialPageRoute( builder: (context) =&gt; AccRadioPlayerControl( info: info, bobaos: bobaos, ))); },</code> </pre> <br><p>  Die Seite <code>AccRadioPlayerControl</code> wird <code>AccRadioPlayerControl</code> , auf der auch das <code>ScopedModel</code> zum Verwalten des Status verwendet wird. </p><br><p>  Damit ist die gesamte Beschreibung des Programmoperationsalgorithmus ersch√∂pft.  Es sind keine zus√§tzlichen Funktionen implementiert, z. B. das Speichern des letzten Hosts und das Sortieren von Zubeh√∂r in Kategorien / R√§ume.  Im Moment ist alles einfach. </p><br><h2 id="problemy">  Die Probleme </h2><br><p>  Ich werde das Hauptproblem beschreiben, das jetzt ist.  Ich verstehe immer noch nicht, wie eine unterbrochene <code>WebSocket</code> Verbindung <code>WebSocket</code> . </p><br><p>  Ich benutze: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">WebSocket-Klasse</a> . </p><br><p>  Wenn sich die Anwendung / das Ger√§t l√§ngere Zeit im Ruhemodus befindet, wird die Verbindung getrennt.  Sie m√ºssen zur ersten Seite zur√ºckkehren und den erkannten Dienst erneut √∂ffnen. </p><br><h2 id="posleslovie">  Nachwort </h2><br><p>  Einerseits lernt und entwickelt Flutter ziemlich schnell.  ScopedModel erwies sich f√ºr mich als verst√§ndlicher als Redux. <br>  Dart √§hnelte dem bekannten JavaScript.  Wenn Sie + dynamische Typen eingeben, kann jeder so bequem schreiben. </p><br><p>  Schwierigkeiten beim Schreiben von Code: gro√üe Verschachtelung von Widgets.  Die bekannte R√ºckrufh√∂lle nach dem Flattern sieht anders aus.  Vim-Modus und <code>%</code> sind n√ºtzlich. </p><br><p>  Nun ein paar Gedanken zum IoT.  In letzter Zeit immer mehr intelligente Ger√§te / Dienste, die eine Registrierung in der Cloud erfordern.  Chinesische Verkaufsstellen, f√ºr deren Verwendung Sie die Anwendung installieren m√ºssen, erstellen ein Konto, und erst danach k√∂nnen Sie es verwenden. </p><br><p>  Sprachassistenten.  Alice von Yandex ben√∂tigt ihre Cloud, in die der erkannte Text gesendet wird.  Amazonas Alexa arbeitet auf √§hnliche Weise. </p><br><p>  Das erfolgreichste ist meiner Meinung nach Apple HomeKit in Zusammenarbeit mit Siri.  Die Cloud wird zur Texterkennung verwendet.  Interaktion mit Ger√§ten - im lokalen Netzwerk. </p><br><p>  Meiner Meinung nach muss die Cloud f√ºr ihren Zweck existieren: Fernsteuerung, Aktualisierung usw. ... Wenn das Ger√§t in einem lokalen Netzwerk gesteuert werden kann, m√ºssen Sie dies tun. </p><br><h2 id="ssylki">  Referenzen </h2><br><ol><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Anwendungs-Repository</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Bobaoskit-Dokumentation</a> - beschreibt, wie Sie bobaoskit.worker installieren und das <code>radio player</code> Zubeh√∂r starten. </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de440088/">https://habr.com/ru/post/de440088/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de440074/index.html">Roskomos h√§lt es f√ºr falsch, die Raptor-Motoren Ilona Mask und RD-180 zu vergleichen</a></li>
<li><a href="../de440076/index.html">√úbersetzung und Interpretation von Werbung aus dem Englischen ins Russische</a></li>
<li><a href="../de440078/index.html">Schnelles Compiler-Ger√§t. Teil 4</a></li>
<li><a href="../de440084/index.html">10 Milliarden Softwareexporte sind vernachl√§ssigbar</a></li>
<li><a href="../de440086/index.html">MS-DOS Virus World</a></li>
<li><a href="../de440090/index.html">Wie funktionieren technische Indikatoren an der B√∂rse tats√§chlich?</a></li>
<li><a href="../de440092/index.html">Eine mathematische Untersuchung dar√ºber, wie gef√§lschte Gouverneurwahlen in Primorje am 16. September 2018 vorget√§uscht wurden</a></li>
<li><a href="../de440094/index.html">Bl√ºhende G√§rten auf dem Mars bleiben ein Traum: Das Mars One-Projekt ging bankrott</a></li>
<li><a href="../de440096/index.html">RunC-Sicherheitsl√ºcke, die Kubernetes, Docker und Containerd betrifft</a></li>
<li><a href="../de440098/index.html">Der Mondschein ist immer noch vollautomatisch. Teil 2. Trennzeichen. K√ºhlschrank. W√ºrfel Algorithmen</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>