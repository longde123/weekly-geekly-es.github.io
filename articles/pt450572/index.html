<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§∫ üßõüèø üë©üèæ‚Äç‚öïÔ∏è Samba DC como um segundo controlador no dom√≠nio AD do Windows 2012R2 e pastas m√≥veis para clientes no Windows e Linux üëµüèæ üõï üòΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A percep√ß√£o de que eu estava no mix de importa√ß√£o n√£o veio imediatamente. Somente quando novos suprimentos de um PC come√ßaram a chegar de forma est√°ve...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Samba DC como um segundo controlador no dom√≠nio AD do Windows 2012R2 e pastas m√≥veis para clientes no Windows e Linux</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/450572/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/q7/qz/gi/q7qzgibifknfegmdk3ffls-fik0.jpeg" alt="imagem"></div><br>  A percep√ß√£o de que eu estava no mix de importa√ß√£o n√£o veio imediatamente.  Somente quando novos suprimentos de um PC come√ßaram a chegar de forma est√°vel da organiza√ß√£o-m√£e com a distribui√ß√£o Alt Linux a bordo, eu suspeitei que algo estivesse errado. <br><br>  No entanto, no processo de passar pelas etapas de aceita√ß√£o do inevit√°vel, me envolvi e at√© comecei a gostar um pouco do processo.  E, em algum momento, pensei que, a esse ritmo, mais cedo ou mais tarde teria que desistir da decis√£o de organizar o servi√ßo de diret√≥rio da Microsoft e avan√ßar para algo mais ex√≥tico.  Portanto, a fim de preparar antecipadamente o inevit√°vel e, se poss√≠vel, capturar mais armadilhas, foi decidido implantar uma bancada de testes, que inclui: <br><br><ul><li>  DC1 - Windows Server 2012R2 </li><li>  DC2 - Servidor Alt 8.2 </li><li>  Servidor de arquivos - Windows Server 2012R2 </li><li>  PC1 - Windows 7 </li><li>  PC2 - Esta√ß√£o de trabalho Alt 8.2 </li></ul><a name="habracut"></a><br><h4>  Tarefas do estande: </h4><br><ol><li> Implante um dom√≠nio com base em w2k12r2.  Crie um conjunto m√≠nimo de pol√≠ticas de grupo (semelhantes √†s usadas na infraestrutura de trabalho), incluindo uma pol√≠tica para transferir pastas de trabalho do usu√°rio (Downloads / Documentos / √Årea de Trabalho).  No final, eu quero que, quando um usu√°rio altere seu local de trabalho do Windows para Linux e vice-versa, ele tenha acesso confort√°vel aos seus documentos de trabalho. </li><li>  Entrando no Samba DC pelo segundo controlador.  Verificando o servi√ßo de diret√≥rio e a replica√ß√£o de DNS </li><li>  Configurando clientes Linux com pastas m√≥veis </li></ol><br><h4>  Implementa√ß√£o: </h4><br><ol><li>  <b>Instale e insira um novo controlador</b> <br><br>  Com a instala√ß√£o do MS Windows 2012R2, tudo √© simples e menos claro.  Na Internet, h√° um manual 1001 para implantar um dom√≠nio no Windows usando a GUI e o Powershell, por isso n√£o vou repeti-lo novamente, deixarei apenas um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">link</a> desativado.  documenta√ß√£o para curiosos e para quem deseja refrescar sua mem√≥ria. <br><br>  No entanto, h√° um ponto importante neste par√°grafo.  At√© o momento, o Samba n√£o pode trabalhar com esquemas de cat√°logo acima de 2008R2. <br><br><div class="spoiler">  <b class="spoiler_title">T√≠tulo de spoiler</b> <div class="spoiler_text">  Em vez disso, os desenvolvedores desse suporte s√£o declarados como experimentais.  Mas, na pr√°tica, uma tentativa de inserir o samba como um segundo controlador de dom√≠nio em um dom√≠nio existente do Windows com o esquema 69 o encontrar√° com o seguinte erro <br><blockquote>  DsAddEntry falhou com o status WERR_ACCESS_DENIED info (8567, 'WERR_DS_INCOMPATIBLE_VERSION') </blockquote><br></div></div><br>  O problema √© que o Windows 2012 e o 2012R2 usam ferramentas WMI para trabalhar com dom√≠nios e florestas, cujo suporte est√°vel √© anunciado apenas para o Samba vers√£o 4.11, que deve sair antes do final deste ano. <br>  Daqui resulta que a √∫nica op√ß√£o para introduzir o samba no dom√≠nio do AD implantado em um servidor 2012R2 √© reduzir o esquema de 69 para 47. Obviamente, isso n√£o √© necess√°rio na infraestrutura de trabalho sem uma boa raz√£o, mas temos um banco de testes aqui, por que motivo na verdade n√£o. <br><br>  Colocamos o Alt Server 8.2.  Durante a instala√ß√£o, selecione o perfil "Servidor Samba-DC (Controlador AD)".  No servidor implantado, fazemos uma atualiza√ß√£o completa do sistema e instalamos o pacote task-samba-dc, que extrair√° tudo o que voc√™ precisa <br><br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># apt-get install task-samba-dc</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Se task-samba-dc subitamente, contrariamente √†s garantias da documenta√ß√£o, Alta se recusa a instalar tudo o que for necess√°rio.</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># apt-get install python-module-samba-DC samba-DC-common samba-DC-winbind-clients samba-DC-winbind samba-DC-common-libs libpytalloc-devel</span></span></code> </pre> <br></div></div><br>  Em seguida, prossiga para configurar o Kerberos e receba um ticket.  Abra o arquivo krb5.conf, v√° para a se√ß√£o [libdefaults] e leve-o para o seguinte formul√°rio: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># vim /etc/krb5.conf</span></span></code> </pre> <br><pre> <code class="bash hljs"> dns_lookup_kdc = <span class="hljs-literal"><span class="hljs-literal">true</span></span> dns_lookup_realm = <span class="hljs-literal"><span class="hljs-literal">true</span></span> default_realm = TEST.LOCAL</code> </pre> <br>  Solicitar um ingresso <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># kinit administrator Password for administrator@TEST.LOCAL:</span></span></code> </pre> <br>  Verificando a lista de tickets Kerberos recebidos <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># klist Ticket cache: KEYRING:persistent:0:0 Default principal: administrator@TEST.LOCAL Valid starting Expires Service principal 16.05.2019 11:51:38 16.05.2019 21:51:38 krbtgt/TEST.LOCAL@TEST.LOCAL renew until 23.05.2019 11:51:35</span></span></code> </pre> <br>  Agora exclua ou renomeie a configura√ß√£o existente do samba. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># mv smb.conf smb.conf.bak1</span></span></code> </pre> <br>  Por fim, inserimos o segundo controlador no dom√≠nio do AD: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># samba-tool domain join test.local DC -U"TEST\administrator"</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">A entrada bem-sucedida ser√° seguida pelo seguinte log</b> <div class="spoiler_text"><pre> <code class="bash hljs">Finding a writeable DC <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> domain <span class="hljs-string"><span class="hljs-string">'test.local'</span></span> Found DC DC1.TEST.LOCAL Password <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> [TEST\administrator]: Reconnecting to naming master e31d7da6-8f56-4420-8473-80f2b3a31338._msdcs.TEST. LOCAL DNS name of new naming master is DC1.TEST.LOCAL workgroup is TEST realm is TEST.LOCAL Adding CN=DC2,OU=Domain Controllers,DC=TEST,DC=LOCAL Adding CN=DC2,CN=Servers,CN=Default-First-Site-Name,CN=Sites,CN=Configuration,DC =TEST,DC=LOCAL Adding CN=NTDS Settings,CN=DC2,CN=Servers,CN=Default-First-Site-Name,CN=Sites,CN =Configuration,DC=TEST,DC=LOCAL Adding SPNs to CN=DC2,OU=Domain Controllers,DC=TEST,DC=LOCAL Setting account password <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> DC2$ Enabling account Calling bare provision Looking up IPv4 addresses Looking up IPv6 addresses No IPv6 address will be assigned Setting up share.ldb Setting up secrets.ldb Setting up the registry Setting up the privileges database Setting up idmap db Setting up SAM db Setting up sam.ldb partitions and settings Setting up sam.ldb rootDSE Pre-loading the Samba 4 and AD schema A Kerberos configuration suitable <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Samba AD has been generated at /var/lib/sa mba/private/krb5.conf Provision OK <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> domain DN DC=TEST,DC=LOCAL Starting replication Schema-DN[CN=Schema,CN=Configuration,DC=TEST,DC=LOCAL] objects[402/1426] linked _values[0/0] Schema-DN[CN=Schema,CN=Configuration,DC=TEST,DC=LOCAL] objects[804/1426] linked _values[0/0] Schema-DN[CN=Schema,CN=Configuration,DC=TEST,DC=LOCAL] objects[1206/1426] linke d_values[0/0] Schema-DN[CN=Schema,CN=Configuration,DC=TEST,DC=LOCAL] objects[1608/1426] linke d_values[0/0] Schema-DN[CN=Schema,CN=Configuration,DC=TEST,DC=LOCAL] objects[1743/1426] linke d_values[0/0] Analyze and apply schema objects Partition[CN=Configuration,DC=TEST,DC=LOCAL] objects[402/2240] linked_values[0/ 24] Partition[CN=Configuration,DC=TEST,DC=LOCAL] objects[804/2240] linked_values[0/ 24] Partition[CN=Configuration,DC=TEST,DC=LOCAL] objects[1206/2240] linked_values[0 /24] Partition[CN=Configuration,DC=TEST,DC=LOCAL] objects[1608/2240] linked_values[0 /24] Partition[CN=Configuration,DC=TEST,DC=LOCAL] objects[1772/2240] linked_values[2 4/24] Replicating critical objects from the base DN of the domain Partition[DC=TEST,DC=LOCAL] objects[109/110] linked_values[26/29] Partition[DC=TEST,DC=LOCAL] objects[394/5008] linked_values[29/29] Done with always replicated NC (base, config, schema) Replicating DC=DomainDnsZones,DC=TEST,DC=LOCAL Partition[DC=DomainDnsZones,DC=TEST,DC=LOCAL] objects[42/42] linked_values[0/0] Replicating DC=ForestDnsZones,DC=TEST,DC=LOCAL Partition[DC=ForestDnsZones,DC=TEST,DC=LOCAL] objects[20/20] linked_values[0/0] Exop on[CN=RID Manager$,CN=System,DC=TEST,DC=LOCAL] objects[3] linked_values[0] Committing SAM database Adding 1 remote DNS records <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> DC2.TEST.LOCAL Adding DNS A record DC2.TEST.LOCAL <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> IPv4 IP: 192.168.90.201 Adding DNS CNAME record 6ff1df40-cbb5-41f0-b7b3-53a27dde8edf._msdcs.TEST.LOCAL <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> DC2.TEST.LOCAL All other DNS records (like _ldap SRV records) will be created samba_dnsupdate on first startup Replicating new DNS records <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> DC=DomainDnsZones,DC=TEST,DC=LOCAL Partition[DC=DomainDnsZones,DC=TEST,DC=LOCAL] objects[1/42] linked_values[0/0] Replicating new DNS records <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> DC=ForestDnsZones,DC=TEST,DC=LOCAL Partition[DC=ForestDnsZones,DC=TEST,DC=LOCAL] objects[1/20] linked_values[0/0] Sending DsReplicaUpdateRefs <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> all the replicated partitions Setting isSynchronized and dsServiceName Setting up secrets database Joined domain TEST (SID S-1-5-21-3959064270-1572045903-2556826204) as a DC</code> </pre> <br></div></div><br>  Um registro sobre o novo controlador de dom√≠nio no dom√≠nio TEST.LOCAL deve aparecer no snap-in ADUC e um novo registro A correspondente ao DC2 deve aparecer no gerenciador de DNS. </li><li>  <b>Replica√ß√£o entre controladores</b> <br><br>  Para come√ßar, confira o Servi√ßo de Replica√ß√£o de Diret√≥rio (DRS) <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># samba-tool drs showrepl</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Todas as tentativas de replica√ß√£o na sa√≠da devem ser bem-sucedidas.</b>  <b class="spoiler_title">Na lista de objetos KCC, dentro de 15 minutos ap√≥s a entrada, nosso DC1 no Windows deve aparecer</b> <div class="spoiler_text"><pre> <code class="bash hljs">Default-First-Site-Name\DC2 DSA Options: 0x00000001 DSA object GUID: 0e9f5bce-ff59-401e-bdbd-fc69df3fc6bf DSA invocationId: 017997b5-d718-41d7-a3f3-e57ab5151b5c ==== INBOUND NEIGHBORS ==== DC=ForestDnsZones,DC=<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>,DC=<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> Default-First-Site-Name\DC1 via RPC DSA object GUID: 60fb339d-efa3-4585-a42d-04974e6601b7 Last attempt @ Mon May 27 12:56:31 2019 MSK was successful 0 consecutive failure(s). Last success @ Mon May 27 12:56:31 2019 MSK DC=DomainDnsZones,DC=<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>,DC=<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> Default-First-Site-Name\DC1 via RPC DSA object GUID: 60fb339d-efa3-4585-a42d-04974e6601b7 Last attempt @ Mon May 27 12:56:32 2019 MSK was successful 0 consecutive failure(s). Last success @ Mon May 27 12:56:32 2019 MSK CN=Schema,CN=Configuration,DC=<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>,DC=<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> Default-First-Site-Name\DC1 via RPC DSA object GUID: 60fb339d-efa3-4585-a42d-04974e6601b7 Last attempt @ Mon May 27 12:56:32 2019 MSK was successful 0 consecutive failure(s). Last success @ Mon May 27 12:56:32 2019 MSK DC=<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>,DC=<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> Default-First-Site-Name\DC1 via RPC DSA object GUID: 60fb339d-efa3-4585-a42d-04974e6601b7 Last attempt @ Mon May 27 12:56:32 2019 MSK was successful 0 consecutive failure(s). Last success @ Mon May 27 12:56:32 2019 MSK CN=Configuration,DC=<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>,DC=<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> Default-First-Site-Name\DC1 via RPC DSA object GUID: 60fb339d-efa3-4585-a42d-04974e6601b7 Last attempt @ Mon May 27 12:56:33 2019 MSK was successful 0 consecutive failure(s). Last success @ Mon May 27 12:56:33 2019 MSK ==== OUTBOUND NEIGHBORS ==== DC=ForestDnsZones,DC=<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>,DC=<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> Default-First-Site-Name\DC1 via RPC DSA object GUID: 60fb339d-efa3-4585-a42d-04974e6601b7 Last attempt @ Thu May 23 16:40:03 2019 MSK was successful 0 consecutive failure(s). Last success @ Thu May 23 16:40:03 2019 MSK DC=DomainDnsZones,DC=<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>,DC=<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> Default-First-Site-Name\DC1 via RPC DSA object GUID: 60fb339d-efa3-4585-a42d-04974e6601b7 Last attempt @ Thu May 23 16:40:03 2019 MSK was successful 0 consecutive failure(s). Last success @ Thu May 23 16:40:03 2019 MSK CN=Schema,CN=Configuration,DC=<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>,DC=<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> Default-First-Site-Name\DC1 via RPC DSA object GUID: 60fb339d-efa3-4585-a42d-04974e6601b7 Last attempt @ Thu May 23 16:40:08 2019 MSK was successful 0 consecutive failure(s). Last success @ Thu May 23 16:40:08 2019 MSK DC=<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>,DC=<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> Default-First-Site-Name\DC1 via RPC DSA object GUID: 60fb339d-efa3-4585-a42d-04974e6601b7 Last attempt @ Thu May 23 16:40:08 2019 MSK was successful 0 consecutive failure(s). Last success @ Thu May 23 16:40:08 2019 MSK CN=Configuration,DC=<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>,DC=<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> Default-First-Site-Name\DC1 via RPC DSA object GUID: 60fb339d-efa3-4585-a42d-04974e6601b7 Last attempt @ Mon May 27 12:12:17 2019 MSK was successful 0 consecutive failure(s). Last success @ Mon May 27 12:12:17 2019 MSK ==== KCC CONNECTION OBJECTS ==== Connection -- Connection name: 6d2652b3-e723-4af7-a19f-1ee48915753c Enabled : TRUE Server DNS name : DC1.test.local Server DN name : CN=NTDS Settings,CN=DC1,CN=Servers,CN=Default-First-Site-Name,CN=Sites,CN=Configuration,DC=<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>,DC=<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> TransportType: RPC options: 0x00000001 Warning: No NC replicated <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Connection!</code> </pre> <br></div></div><br>  Aviso <i>"Nenhum NC replicado para o Connection!"</i>  pode ser ignorado com seguran√ßa.  Parece que, ao registrar um novo controlador de dom√≠nio, o samba define incorretamente alguns sinalizadores de replica√ß√£o. <br><br>  Verificar a replica√ß√£o LDAP tamb√©m √© uma boa ideia. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># samba-tool ldapcmp ldap://dc1.test.local ldap://dc2.test.local -Uadministrator</span></span></code> </pre> <br>  O comando acima comparar√° os valores de atributo dos objetos de todo o diret√≥rio no DC1 e DC2. <br><br><div class="spoiler">  <b class="spoiler_title">Exemplo de replica√ß√£o bem-sucedida</b> <div class="spoiler_text"><pre> <code class="bash hljs">* Comparing [DOMAIN] context... * Objects to be compared: 249 * Result <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> [DOMAIN]: SUCCESS * Comparing [CONFIGURATION] context... * Objects to be compared: 1750 * Result <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> [CONFIGURATION]: SUCCESS * Comparing [SCHEMA] context... * Objects to be compared: 1739 * Result <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> [SCHEMA]: SUCCESS * Comparing [DNSDOMAIN] context... * Objects to be compared: 42 * Result <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> [DNSDOMAIN]: SUCCESS * Comparing [DNSFOREST] context... * Objects to be compared: 20 * Result <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> [DNSFOREST]: SUCCESS</code> </pre> </div></div><br>  Em alguns casos, os atributos de objetos em diferentes controladores podem diferir e a sa√≠da do comando informar√° sobre isso.  Mas nem sempre, isso ser√° um sinal de um problema de replica√ß√£o. <br><br>  A pr√≥xima etapa √© configurar manualmente a replica√ß√£o est√°vel do diret√≥rio SysVol. <br>  O fato √© que o samba ainda n√£o suporta o DFS-R, no entanto, pois n√£o suportava o FRS anterior.  Portanto, para a replica√ß√£o entre o DC Samba e o Windows, a √∫nica solu√ß√£o funcional atualmente √© a replica√ß√£o unidirecional usando o utilit√°rio <i>Robocopy</i> das <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Ferramentas</a> do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Windows Server 2003 Resource Kit</a> . <br><br>  Os desenvolvedores do Samba, para evitar problemas de compatibilidade, recomendam primeiro instalar o kit utilit√°rio em uma esta√ß√£o de trabalho comum e, em seguida, copie o Robocopy para o controlador na pasta "C: \ Arquivos de Programas (x86) \ Windows Resource Kits \ Tools \" <br><br>  Ap√≥s a instala√ß√£o, no agendador de tarefas no controlador do Windows, criamos uma tarefa para replica√ß√£o com os seguintes par√¢metros: <br><br>  - Executar para todos os usu√°rios <br>  - Disparador para executar diariamente a cada 5 minutos durante o dia <br>  - Nas a√ß√µes que prescrevemos o caminho para o utilit√°rio robocopy, indicamos como argumentos: <br><br><pre> <code class="xml hljs">\\DC1\SYSVOL\test.local\ \\DC2\SYSVOL\test.local\ /mir /sec</code> </pre> <br>  Em um caso espec√≠fico, copie o conte√∫do do diret√≥rio SysVol do DC1 para o DC2. <br></li><li>  <b>Pastas de usu√°rio port√°teis usando a configura√ß√£o pam_mount</b> <br><br>  Empiricamente, encontrei duas op√ß√µes vi√°veis ‚Äã‚Äãpara resolver esse problema com sua ajuda. <br><br><ol><li>  Montagem completa da pasta de perfil da rede na se√ß√£o / home <br><br>  Uma op√ß√£o simples.  Funciona bem se os nomes de pasta Meus Documentos, Downloads e √Årea de Trabalho forem iguais nos dois sistemas operacionais.  Entende-se que um PC Linux j√° foi inserido no dom√≠nio e os usu√°rios efetuam login em suas contas de dom√≠nio usando sssd como mecanismo de autentica√ß√£o e autoriza√ß√£o. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># vim /etc/security/pam_mount.conf.xml</span></span></code> </pre> <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">volume</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">uid</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"100000000-2000000000"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">fstype</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"cifs"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">server</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"dfs"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">path</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Profile_Users/%(USER)"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">mountpoint</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"~"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">options</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"sec=krb5,cruid=%(USERUID),nounix,uid=%(USERUID),gid=%(USERGID),file_mode=0664,dir_mode=0775"</span></span></span><span class="hljs-tag">/&gt;</span></span></code> </pre><br>  onde: <br><br><ul><li>  <b>uid = "100000000-2000000000"</b> - o intervalo de UID atribu√≠do aos usu√°rios do dom√≠nio do SSSD </li><li>  <b>server = "dfs"</b> - nome do servidor de arquivos </li><li>  <b>path = "Profile_Users /% (USER)"</b> - um recurso no servidor de arquivos com o perfil de usu√°rio hospedado </li><li>  <b>mountpoint = "~"</b> - caminho de montagem para a pasta inicial do usu√°rio </li></ul><br>  O login do usu√°rio √© passado para a vari√°vel de macro "% (USER)" usada por pam_mount para conectar nosso recurso de rede, na forma em que √© inserido no gerenciador de exibi√ß√£o.  Portanto, √© importante que o logon do DM seja inserido sem uma indica√ß√£o expl√≠cita do nome do dom√≠nio. <br><br>  No sssd.conf, isso √© resolvido comentando ou configurando o valor False para a op√ß√£o <b>use_fully_qualified_names</b> , que ativa o modo de nome completo (incluindo dom√≠nio) para usu√°rios e grupos. <br></li><li>  O segundo m√©todo √© menos direto e desajeitado e, na minha opini√£o, mais conveniente e preferido.  A diferen√ßa da primeira apenas na configura√ß√£o pam_mount <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># vim /etc/security/pam_mount.conf.xml</span></span></code> </pre> <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">volume</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">uid</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"100000000-2000200000"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">fstype</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"cifs"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">server</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"dfs"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">path</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Profile_Users/%(USER)/ "</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">mountpoint</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"~/ "</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">options</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"sec=krb5,cruid=%(USERUID),nounix,uid=%(USERUID),gid=%(USERGID),file_mode=0664,dir_mode=0775"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">volume</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">uid</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"100000000-2000200000"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">fstype</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"cifs"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">server</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"dfs"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">path</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Profile_Users/%(USER)/Downloads"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">mountpoint</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"~/"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">options</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"sec=krb5,cruid=%(USERUID),nounix,uid=%(USERUID),gid=%(USERGID),file_mode=0664,dir_mode=0775"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">volume</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">uid</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"100000000-2000200000"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">fstype</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"cifs"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">server</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"dfs"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">path</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Profile_Users/%(USER)/ "</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">mountpoint</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"~/"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">options</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"sec=krb5,cruid=%(USERUID),nounix,uid=%(USERUID),gid=%(USERGID),file_mode=0664,dir_mode=0775"</span></span></span><span class="hljs-tag">/&gt;</span></span></code> </pre> <br>  Ou seja, simplesmente montamos cada uma de nossas pastas separadamente no diret√≥rio correspondente </li></ol></li></ol><br>  <b>Conclus√µes</b> <br><br>  Durante mais de meio m√™s de trabalho em uma bancada de testes, esse pacote sobreviveu com √™xito a v√°rios desligamentos alternativos de longo e curto prazo de ambos os controladores, praticamente sem conseq√º√™ncias para os clientes (uma vez que um cliente no Windows7 perdeu a confian√ßa). <br><br>  Em geral, tive uma impress√£o bastante agrad√°vel de trabalhar com este produto, apesar de todas as nuances que tive que enfrentar tanto no artigo quanto nos bastidores. <br><br>  Existem armadilhas, existem muitas e, no decorrer do trabalho com o samba, elas ter√£o que ser capturadas em grandes quantidades.  No entanto, at√© o momento, n√£o h√° outras solu√ß√µes que permitam organizar um ambiente h√≠brido usando servi√ßos de diret√≥rio e sem o Windows. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt450572/">https://habr.com/ru/post/pt450572/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt450554/index.html">Quebrando o Padr√£o de Design - Singleton em PHP</a></li>
<li><a href="../pt450556/index.html">Valve Index - revis√£o do novo conjunto VR</a></li>
<li><a href="../pt450564/index.html">Glitter e pobreza: como a revolu√ß√£o digital tornou os m√∫sicos mais pobres</a></li>
<li><a href="../pt450566/index.html">OutOfMemory e o uso de imagens vetoriais no Android Studio</a></li>
<li><a href="../pt450568/index.html">Cada veneno tem seu pr√≥prio ant√≠doto. Como salvar ou pelo menos tentar (atual: sobre ant√≠dotos para intoxica√ß√£o dom√©stica)</a></li>
<li><a href="../pt450574/index.html">Crie um jogo na web para m√∫ltiplos jogadores .io</a></li>
<li><a href="../pt450576/index.html">Novas regras para o anonimato do messenger</a></li>
<li><a href="../pt450578/index.html">O que √© ouvido no ar? Recebemos e decodificamos os sinais mais interessantes. Parte 2, VHF</a></li>
<li><a href="../pt450582/index.html">Princ√≠pios PIM</a></li>
<li><a href="../pt450586/index.html">Fish Redux - Nova Biblioteca Redux para Flutter</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>