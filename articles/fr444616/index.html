<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏾‍🤝‍👨🏼 🙇🏻 🤸 Création de votre propre enregistreur vocal Android à l'aide de Kotlin 👬 👊 🖨️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Le cadre multimédia Android prend en charge l'enregistrement et la lecture audio. Dans cet article, je vais montrer comment développer une application...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Création de votre propre enregistreur vocal Android à l'aide de Kotlin</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/444616/"><p><img src="https://habrastorage.org/getpro/habr/post_images/ab5/218/e0f/ab5218e0faba0896ef09f1ccb076a7a1.jpg" alt="Création de votre propre enregistreur vocal Android à l'aide de Kotlin"></p><br><p> Le cadre multimédia Android prend en charge l'enregistrement et la lecture audio.  Dans cet article, je vais montrer comment développer une application d'enregistrement simple qui enregistrera de l'audio et la stockera dans le stockage local d'un appareil Android à l'aide de <code>MediaRecorder</code> partir du SDK Android. </p><br><p>  Vous apprendrez également comment demander des autorisations à un utilisateur en temps réel et comment travailler avec le stockage local d'un appareil Android. </p><a name="habracut"></a><br><h2 id="sozdanie-polzovatelskogo-interfeysa">  Création d'interface utilisateur </h2><br><p>  Nous devons d'abord créer une interface pour l'enregistrement sonore.  Il s'agit d'une disposition simple à trois boutons qui sera utilisée pour démarrer, suspendre / reprendre et arrêter l'enregistrement. </p><br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">RelativeLayout</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:android</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.android.com/apk/res/android"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:tools</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.android.com/tools"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"match_parent"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"match_parent"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">tools:context</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">".MainActivity"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TextView</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@+id/textview_sound_recorder_heading"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"wrap_content"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"wrap_content"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:text</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Sound Recorder"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_centerHorizontal</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:textSize</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"32dp"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:textStyle</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"bold"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:textColor</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#000"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_marginTop</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"32dp"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@+id/button_start_recording"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"wrap_content"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"wrap_content"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:text</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Start"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_alignParentBottom</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_marginLeft</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"32dp"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_marginBottom</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"32dp"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_centerVertical</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@+id/button_pause_recording"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"wrap_content"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"wrap_content"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:text</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Pause"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_alignParentBottom</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_centerHorizontal</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_marginBottom</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"32dp"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@+id/button_stop_recording"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"wrap_content"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"wrap_content"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:text</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Stop"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_alignParentBottom</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_alignParentRight</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_marginBottom</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"32dp"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_marginRight</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"32dp"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">RelativeLayout</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><h2 id="zapros-trebuemyh-razresheniy">  Demander les autorisations requises </h2><br><p>  Après avoir créé l'interface utilisateur, nous pouvons commencer à utiliser <code>MediaRecorder</code> pour implémenter les fonctionnalités de base de notre application.  Mais d'abord, nous devons demander les autorisations nécessaires pour enregistrer de l'audio et accéder au stockage local.  Nous le ferons avec quelques lignes de code simples dans notre fichier <code>AndroidManifest.xml</code> : </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.permission.RECORD_AUDIO"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.permission.WRITE_EXTERNAL_STORAGE"</span></span></span><span class="hljs-tag">/&gt;</span></span></code> </pre> <br><p>  Vous devez également vérifier si l'utilisateur a approuvé les autorisations avant de pouvoir utiliser notre <code>MediaRecorder</code> .  Faisons-le dans Activity <code>MainActivity.kt</code> : </p><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ContextCompat.checkSelfPermission(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, Manifest.permission.RECORD_AUDIO) != PackageManager.PERMISSION_GRANTED &amp;&amp; ContextCompat.checkSelfPermission(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, Manifest.permission.WRITE_EXTERNAL_STORAGE) != PackageManager.PERMISSION_GRANTED) { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> permissions = arrayOf(android.Manifest.permission.RECORD_AUDIO, android.Manifest.permission.WRITE_EXTERNAL_STORAGE, android.Manifest.permission.READ_EXTERNAL_STORAGE) ActivityCompat.requestPermissions(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, permissions,<span class="hljs-number"><span class="hljs-number">0</span></span>) }</code> </pre> <br><p>  <strong>Remarque:</strong> plus tard, ces lignes de code seront déplacées vers le <code>OnClickListener</code> bouton de démarrage pour l'enregistrement audio, afin que nous puissions nous assurer que <code>MediaRecorder</code> ne <code>MediaRecorder</code> pas sans les autorisations nécessaires. </p><br><h2 id="zapis-i-sohranenie-audio">  Enregistrer et sauvegarder l'audio </h2><br><h3 id="dobavlenie-onclicklisteners">  Ajout d'OnClickListeners </h3><br><p>  Ajoutez des écouteurs aux boutons pour qu'ils répondent aux événements de l'utilisateur.  Comme je l'ai mentionné précédemment, une vérification des autorisations nécessaires sera ajoutée à OnClickListener du bouton de démarrage de l'enregistrement audio: </p><br><pre> <code class="kotlin hljs">button_start_recording.setOnClickListener { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ContextCompat.checkSelfPermission(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, Manifest.permission.RECORD_AUDIO) != PackageManager.PERMISSION_GRANTED &amp;&amp; ContextCompat.checkSelfPermission(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, Manifest.permission.WRITE_EXTERNAL_STORAGE) != PackageManager.PERMISSION_GRANTED) { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> permissions = arrayOf(android.Manifest.permission.RECORD_AUDIO, android.Manifest.permission.WRITE_EXTERNAL_STORAGE, android.Manifest.permission.READ_EXTERNAL_STORAGE) ActivityCompat.requestPermissions(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, permissions,<span class="hljs-number"><span class="hljs-number">0</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { startRecording() } } button_stop_recording.setOnClickListener{ stopRecording() } button_pause_recording.setOnClickListener { pauseRecording() }</code> </pre> <br><h3 id="nastroyka-mediarecorder">  Configurer MediaRecorder </h3><br><p>  Ensuite, nous devons spécifier le chemin pour enregistrer l'audio et configurer MediaRecorder. </p><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> output: String? = <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mediaRecorder: MediaRecorder? = <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> state: <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> = <span class="hljs-literal"><span class="hljs-literal">false</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> recordingStopped: <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> = <span class="hljs-literal"><span class="hljs-literal">false</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(savedInstanceState: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Bundle</span></span></span></span><span class="hljs-function"><span class="hljs-params">?)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(savedInstanceState) setContentView(R.layout.activity_main) output = Environment.getExternalStorageDirectory().absolutePath + <span class="hljs-string"><span class="hljs-string">"/recording.mp3"</span></span> mediaRecorder = MediaRecorder() mediaRecorder?.setAudioSource(MediaRecorder.AudioSource.MIC) mediaRecorder?.setOutputFormat(MediaRecorder.OutputFormat.MPEG_4) mediaRecorder?.setAudioEncoder(MediaRecorder.AudioEncoder.AAC) mediaRecorder?.setOutputFile(output) }</code> </pre> <br><p>  Nous prenons le chemin vers la racine de notre stockage externe et y ajoutons le nom de notre type d'enregistrement et de fichier.  Après cela, nous créons un objet <code>MediaRecorder</code> et définissons la source sonore, l' <code>MediaRecorder</code> audio, le format et le fichier pour l'enregistrement. </p><br><h3 id="zapis-i-sohranenie-audio-1">  Enregistrer et sauvegarder l'audio </h3><br><p>  Le code utilisé pour démarrer <code>MediaRecorder</code> est défini dans le <code>OnClickListener</code> enregistrement audio: </p><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startRecording</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { mediaRecorder?.prepare() mediaRecorder?.start() state = <span class="hljs-literal"><span class="hljs-literal">true</span></span> Toast.makeText(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-string"><span class="hljs-string">"Recording started!"</span></span>, Toast.LENGTH_SHORT).show() } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e: IllegalStateException) { e.printStackTrace() } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e: IOException) { e.printStackTrace() } }</code> </pre> <br><p>  Comme vous pouvez le voir, nous devons appeler la fonction de <code>prepare</code> avant de pouvoir commencer l'enregistrement.  Nous incorporons également l'appel dans le bloc try-catch afin que l'application ne se casse pas lorsque la fonction <code>prepare</code> échoue. </p><br><p>  <code>OnClickListeners</code> arrêt d'enregistrement sont très similaires au code ci-dessus. </p><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stopRecording</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (state) { mediaRecorder?.stop() mediaRecorder?.release() state = <span class="hljs-literal"><span class="hljs-literal">false</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Toast.makeText(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-string"><span class="hljs-string">"You are not recording right now!"</span></span>, Toast.LENGTH_SHORT).show() } }</code> </pre> <br><p>  Ici, nous vérifions si <code>MediaRecorder</code> est en cours d' <code>MediaRecorder</code> avant d'arrêter l'enregistrement car notre application <code>stop</code> si la méthode d' <code>stop</code> est appelée alors que <code>MediaRecorder</code> ne <code>MediaRecorder</code> pas.  Après cela, nous modifions la variable d'état sur <code>false</code> afin que l'utilisateur ne puisse pas appuyer à nouveau sur le bouton d'arrêt. </p><br><p>  Il nous reste à définir le <code>OnClickListener</code> pour le bouton pause / reprise. </p><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@SuppressLint(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"RestrictedApi"</span></span></span><span class="hljs-meta">, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"SetTextI18n"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-meta"><span class="hljs-meta">@TargetApi(Build.VERSION_CODES.N)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pauseRecording</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (state) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!recordingStopped) { Toast.makeText(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>,<span class="hljs-string"><span class="hljs-string">"Stopped!"</span></span>, Toast.LENGTH_SHORT).show() mediaRecorder?.pause() recordingStopped = <span class="hljs-literal"><span class="hljs-literal">true</span></span> button_pause_recording.text = <span class="hljs-string"><span class="hljs-string">"Resume"</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { resumeRecording() } } } <span class="hljs-meta"><span class="hljs-meta">@SuppressLint(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"RestrictedApi"</span></span></span><span class="hljs-meta">, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"SetTextI18n"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-meta"><span class="hljs-meta">@TargetApi(Build.VERSION_CODES.N)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">resumeRecording</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { Toast.makeText(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>,<span class="hljs-string"><span class="hljs-string">"Resume!"</span></span>, Toast.LENGTH_SHORT).show() mediaRecorder?.resume() button_pause_recording.text = <span class="hljs-string"><span class="hljs-string">"Pause"</span></span> recordingStopped = <span class="hljs-literal"><span class="hljs-literal">false</span></span> }</code> </pre> <br><p>  Dans ces deux méthodes, nous vérifions si <code>MediaRecorder</code> .  Si cela fonctionne, nous suspendons l'enregistrement et modifions le texte du bouton pour reprendre.  Appuyez à nouveau pour reprendre l'enregistrement. </p><br><p>  Enfin, nous pouvons enregistrer de l'audio et l'écouter en ouvrant le fichier <code>recording.mp3</code> , qui sera enregistré dans notre stockage local.  Ouvrez simplement l'explorateur de fichiers et effectuez une recherche sur le nom de fichier <code>recording.mp3</code> . </p><br><h2 id="ishodnyy-kod">  Code source </h2><br><p>  Voici le code source complet de notre application: </p><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.example.android.soundrecorder <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.Manifest <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.<span class="hljs-keyword"><span class="hljs-keyword">annotation</span></span>.SuppressLint <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.<span class="hljs-keyword"><span class="hljs-keyword">annotation</span></span>.TargetApi <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.content.pm.PackageManager <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.media.MediaRecorder <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.os.Build <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.support.v7.app.AppCompatActivity <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.os.Bundle <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.os.Environment <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.support.v4.app.ActivityCompat <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.support.v4.content.ContextCompat <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.widget.Toast <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> kotlinx.android.synthetic.main.activity_main.* <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.IOException <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainActivity</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AppCompatActivity</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> output: String? = <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mediaRecorder: MediaRecorder? = <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> state: <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> = <span class="hljs-literal"><span class="hljs-literal">false</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> recordingStopped: <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> = <span class="hljs-literal"><span class="hljs-literal">false</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(savedInstanceState: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Bundle</span></span></span></span><span class="hljs-function"><span class="hljs-params">?)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(savedInstanceState) setContentView(R.layout.activity_main) mediaRecorder = MediaRecorder() output = Environment.getExternalStorageDirectory().absolutePath + <span class="hljs-string"><span class="hljs-string">"/recording.mp3"</span></span> mediaRecorder?.setAudioSource(MediaRecorder.AudioSource.MIC) mediaRecorder?.setOutputFormat(MediaRecorder.OutputFormat.MPEG_4) mediaRecorder?.setAudioEncoder(MediaRecorder.AudioEncoder.AAC) mediaRecorder?.setOutputFile(output) button_start_recording.setOnClickListener { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ContextCompat.checkSelfPermission(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, Manifest.permission.RECORD_AUDIO) != PackageManager.PERMISSION_GRANTED &amp;&amp; ContextCompat.checkSelfPermission(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, Manifest.permission.WRITE_EXTERNAL_STORAGE) != PackageManager.PERMISSION_GRANTED) { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> permissions = arrayOf(android.Manifest.permission.RECORD_AUDIO, android.Manifest.permission.WRITE_EXTERNAL_STORAGE, android.Manifest.permission.READ_EXTERNAL_STORAGE) ActivityCompat.requestPermissions(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, permissions,<span class="hljs-number"><span class="hljs-number">0</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { startRecording() } } button_stop_recording.setOnClickListener{ stopRecording() } button_pause_recording.setOnClickListener { pauseRecording() } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startRecording</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { mediaRecorder?.prepare() mediaRecorder?.start() state = <span class="hljs-literal"><span class="hljs-literal">true</span></span> Toast.makeText(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-string"><span class="hljs-string">"Recording started!"</span></span>, Toast.LENGTH_SHORT).show() } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e: IllegalStateException) { e.printStackTrace() } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e: IOException) { e.printStackTrace() } } <span class="hljs-meta"><span class="hljs-meta">@SuppressLint(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"RestrictedApi"</span></span></span><span class="hljs-meta">, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"SetTextI18n"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-meta"><span class="hljs-meta">@TargetApi(Build.VERSION_CODES.N)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pauseRecording</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (state) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!recordingStopped) { Toast.makeText(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>,<span class="hljs-string"><span class="hljs-string">"Stopped!"</span></span>, Toast.LENGTH_SHORT).show() mediaRecorder?.pause() recordingStopped = <span class="hljs-literal"><span class="hljs-literal">true</span></span> button_pause_recording.text = <span class="hljs-string"><span class="hljs-string">"Resume"</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { resumeRecording() } } } <span class="hljs-meta"><span class="hljs-meta">@SuppressLint(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"RestrictedApi"</span></span></span><span class="hljs-meta">, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"SetTextI18n"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-meta"><span class="hljs-meta">@TargetApi(Build.VERSION_CODES.N)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">resumeRecording</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { Toast.makeText(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>,<span class="hljs-string"><span class="hljs-string">"Resume!"</span></span>, Toast.LENGTH_SHORT).show() mediaRecorder?.resume() button_pause_recording.text = <span class="hljs-string"><span class="hljs-string">"Pause"</span></span> recordingStopped = <span class="hljs-literal"><span class="hljs-literal">false</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stopRecording</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (state) { mediaRecorder?.stop() mediaRecorder?.release() state = <span class="hljs-literal"><span class="hljs-literal">false</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Toast.makeText(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-string"><span class="hljs-string">"You are not recording right now!"</span></span>, Toast.LENGTH_SHORT).show() } } }</code> </pre> <br><h2 id="zaklyuchenie">  Conclusion </h2><br><p>  Vous savez maintenant comment fonctionne <code>MediaRecorder</code> , comment demander des autorisations en temps réel et pourquoi il est important de le faire.  Vous avez également découvert le stockage local de votre appareil Android et comment y stocker des données. </p><br><p>  Une version plus complexe de cette application, qui possède des fonctionnalités supplémentaires, telles que la lecture de vos enregistrements à l'aide de <code>MediaPlayer</code> , est disponible sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Github</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr444616/">https://habr.com/ru/post/fr444616/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr444600/index.html">Évaluation de 14 cm sans tête 2019</a></li>
<li><a href="../fr444602/index.html">Encapsulation en C ++ et C</a></li>
<li><a href="../fr444610/index.html">Statistiques et suivi des scripts PHP en temps réel. ClickHouse et Grafana vont aider Pinba</a></li>
<li><a href="../fr444612/index.html">Dommages macro pour le code C ++</a></li>
<li><a href="../fr444614/index.html">Toute l'histoire de Linux. Partie II: hauts et bas des entreprises</a></li>
<li><a href="../fr444620/index.html">Utilisation de fichiers de séquence de noyau Linux</a></li>
<li><a href="../fr444622/index.html">Le package tidyr et ses nouvelles fonctions pivot_longer et pivot_wider</a></li>
<li><a href="../fr444624/index.html">Voitures électriques en feu et baignade</a></li>
<li><a href="../fr444630/index.html">Bureau d'information: initiatives mondiales sur Internet</a></li>
<li><a href="../fr444634/index.html">Epic Games donne 100 millions de dollars aux développeurs</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>