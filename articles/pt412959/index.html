<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèª‚Äçüíº üö§ üåä Para a quest√£o do AVR e recordes mundiais üóùÔ∏è ‚öæÔ∏è üé≠</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Fa√ßa bem, vai acabar mal 
 A raz√£o para a publica√ß√£o foi recente (quando comecei a escrever, era realmente recente, mas algo aconteceu por um longo te...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Para a quest√£o do AVR e recordes mundiais</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/412959/"><h3>  Fa√ßa bem, vai acabar mal </h3><br>  A raz√£o para a publica√ß√£o foi recente (quando comecei a escrever, era realmente recente, mas algo aconteceu por um longo tempo na pasta Unfinished) na Habr√© sobre aspectos da implementa√ß√£o do software UART no MK do AVR.  As quest√µes levantadas por eles mesmos n√£o s√£o de interesse, mas s√£o dadas respostas t√£o estranhas que eles consideraram seu dever fazer as explica√ß√µes necess√°rias.  O t√≥pico est√° marcado, aqueles que desejam ler sobre ‚Äúreis, repolho e sapatos‚Äù, ou seja, os requisitos das normas, lendo a documenta√ß√£o t√©cnica (correta) e os registros na programa√ß√£o em linguagem assembly para o AVR, podem clicar no bot√£o abaixo. <br><a name="habracut"></a><br>  Vamos descrever a quest√£o com mais detalhes - √© poss√≠vel implementar o IRPS (o nome usual para a interface, em nome do UART), em um AVR tipo MK (especificamente, era Tiny13) ao trabalhar com um gerador interno.  O fato √© que esse gerador n√£o possui indicadores muito bons da precis√£o da reten√ß√£o de frequ√™ncia, motivo pelo qual essa pergunta surge.  Devo fazer uma reserva imediatamente, n√£o importando se consideramos uma implementa√ß√£o de software (como sugerido na postagem original) ou usamos blocos de hardware MK.  Os resultados de um m√©todo (em termos de par√¢metros de precis√£o no tempo) s√£o quase completamente traduzidos para outro. <br><br>  A quest√£o fundamental √© se o gerador interno pode fornecer a precis√£o de opera√ß√£o necess√°ria, pois, no caso de uma resposta negativa a essa pergunta, novos estudos se tornam sem sentido.  Para comparar as duas grandezas independentes, precisamos conhecer as duas, portanto, come√ßaremos determinando a precis√£o necess√°ria do confinamento de frequ√™ncia e os recursos fornecidos por este MK em particular nesta parte.  Uma observa√ß√£o importante para a frase anterior - isso n√£o significa uma inst√¢ncia espec√≠fica, ‚Äúdada a n√≥s em sensa√ß√µes‚Äù, mas um tipo espec√≠fico de MK, que √© apresentado por sua descri√ß√£o t√©cnica. <br><br>  Para come√ßar, encontraremos algo mais f√°cil de encontrar (bem, eu pensava assim) - requisitos para a precis√£o dos par√¢metros de tempo da interface.  Vamos abrir o padr√£o para RS232 e ver tudo o que voc√™ precisa imediatamente.  Acabou que "voc√™ n√£o pode simplesmente pegar e ..." porque o padr√£o √© pago e todas as c√≥pias na Web s√£o ilegais.  Ok, levamos a vers√£o dom√©stica do GOST para a articula√ß√£o C2 e n√£o encontramos nenhum par√¢metro de tempo, com exce√ß√£o da dura√ß√£o da frente e do corte do pulso.  No in√≠cio, isso causou uma ligeira agita√ß√£o - como poderia ser -, mas depois entendeu que a articula√ß√£o C2 descreve apenas a parte da interface do IRPS e os requisitos devem estar na segunda.  Em princ√≠pio, tudo √© l√≥gico, n√£o est√° claro apenas por que isso n√£o √© explicitamente descrito no GOST, mas, no final, √†s vezes voc√™ pode pensar por si mesmo, embora ainda seja "de alguma forma n√£o obtido de maneira ordenada". <br><br>  Obviamente, conhecendo o protocolo de transmiss√£o, √© poss√≠vel, por considera√ß√µes gerais, encontrar a incompatibilidade m√°xima permitida entre as velocidades do transmissor e do receptor (0,5 / 9,5 = 5,2%), mas isso ser√° uma investiga√ß√£o do cavalo esf√©rico que voc√™ sabe onde, porque: <br><br><ol><li>  os requisitos da norma podem e devem ser mais r√≠gidos que um c√°lculo te√≥rico semelhante da diferen√ßa m√°xima admiss√≠vel; </li><li>  saber o n√∫mero final de incompatibilidade n√£o nos fornecer√° o or√ßamento do transmissor e do receptor. </li></ol><br>  A perambula√ß√£o na Internet levou ao AppNote da Atmel (bem, como ainda usamos o MK dessa empresa), ele fala diretamente de uma incompatibilidade permitida de 2% com um or√ßamento igual, o que leva a um requisito de precis√£o para manter a frequ√™ncia do transmissor de 1%.  Confiaremos em uma empresa respeit√°vel e suporemos que eles tenham acesso a materiais classificados e esse n√∫mero est√° correto, especialmente porque parece plaus√≠vel.  Entendo a vulnerabilidade de tal posi√ß√£o, mas para ser sincero, estou cansado de procurar a resposta exata para uma pergunta t√£o simples e mal posso esperar para passar para a pr√≥xima parte. <br><br>  A pr√≥xima metade da resposta est√° dentro do MK e √© determinada pela documenta√ß√£o t√©cnica para ele.  Primeiro, um pouco sobre o dispositivo do gerador interno, principalmente porque ele √© mais ou menos descrito.  O gerador usa uma corrente RC como elemento de temporiza√ß√£o e, como a tarefa de formar um capacitor integrado de um capacitor exato e um resistor exato √© muito trivial, a frequ√™ncia final de inst√¢ncia para inst√¢ncia do MC varia significativamente.  Para tornar esse par√¢metro mais previs√≠vel, os fabricantes adicionaram um n√≥ de hardware controlado por um byte de calibra√ß√£o.  Esta unidade permite alterar a frequ√™ncia do gerador em uma ampla faixa e, consequentemente, obter o valor desejado com uma precis√£o muito maior. <br><br>  Seria interessante descobrir exatamente como o controle √© implementado no hardware; vejo uma op√ß√£o: controlar a tens√£o de carga do capacitor atrav√©s do DAC ou controlar a tens√£o de compara√ß√£o no comparador.  Essas duas op√ß√µes, no entanto, levam a uma n√£o linearidade significativa das caracter√≠sticas de controle, embora sejam simples de implementar.  Mas estabelecer a implementa√ß√£o interna do gerador n√£o faz parte da nossa tarefa, estamos interessados ‚Äã‚Äãem seus par√¢metros externos. <br><br>  Ent√£o, abrimos a documenta√ß√£o (voc√™ pode abrir o arquivo no visualizador, mas eu tenho uma vers√£o tipogr√°fica da descri√ß√£o impressa pelo pr√≥prio fabricante - sim, costumava ser) e procuramos a se√ß√£o apropriada.  Os par√¢metros em que estamos interessados ‚Äã‚Äãest√£o na se√ß√£o "Oscilador RC interno calibrado" e, em seguida, siga os links, se necess√°rio.  E aqui n√≥s (com certeza, n√£o tenho certeza sobre voc√™) est√°vamos esperando a primeira decep√ß√£o - trabalho com os produtos da Atmel h√° muito tempo (cerca de 15 anos) e sempre acreditamos que eles t√™m uma boa documenta√ß√£o para o MK.  Segundo os psiquiatras, ‚Äún√£o h√° pessoas saud√°veis, n√£o h√° pessoas inexploradas‚Äù e um estudo cuidadoso da se√ß√£o relevante confirmou essa verdade, pois eu n√£o pude notar essas falhas na documenta√ß√£o antes.  Em minha defesa, s√≥ posso dizer que: <br><br><ol><li>  Eu nunca usei um gerador interno nos dados MK, por isso n√£o os estudei com muito cuidado; </li><li>  quando comecei a trabalhar com esses MKs (h√° mais de 10 anos), eu era jovem (bem, definitivamente mais jovem do que agora) e est√∫pido e n√£o entendia completamente a necessidade de uma boa documenta√ß√£o (compreens√≠vel, abrangente e inequ√≠voca); </li><li>  Estou pronto para me perdoar muito, simplesmente porque me perdoo muito, e todas as minhas falhas n√£o s√£o fatais (o √∫ltimo argumento √© especialmente convincente, n√£o √©). </li></ol><br>  Assim, depois de terminar de espanar minha cabe√ßa com cinzas, come√ßarei a declarar minhas reivindica√ß√µes na documenta√ß√£o e n√£o h√° desculpas para o fabricante.  Abrimos a se√ß√£o acima e come√ßamos a estud√°-la cuidadosamente, indo para as p√°ginas necess√°rias, se necess√°rio (voc√™ ainda clica nos links).  Juntos, procuraremos os seguintes par√¢metros que caracterizam as caracter√≠sticas de tempo do gerador: precis√£o nominal, influ√™ncia da tens√£o de alimenta√ß√£o, influ√™ncia da temperatura e par√¢metros de envelhecimento - este √© o conjunto m√≠nimo necess√°rio para avaliar os par√¢metros de precis√£o de qualquer gerador. <br><br>  A primeira parte do bal√© de Marleson √© a precis√£o nominal. <br><br>  Imediatamente encontramos o par√¢metro desejado - a tabela de precis√£o de ajuste do gerador, na qual vemos duas linhas ‚ÄúCalibrado na F√°brica‚Äù com o valor especificado ¬± 10% e ‚ÄúCalibra√ß√£o Manual‚Äù com o mesmo par√¢metro ¬± 2%. <br><br>  Com rela√ß√£o a esses dados, surgem v√°rias perguntas imediatamente - o que elas significam e como s√£o as medidas desse par√¢metro.  Para a primeira linha, a tabela indica a temperatura (do ambiente ou do pr√≥prio MK - n√£o est√° claro, mas isso √© um capricho de minha parte) e a tens√£o de alimenta√ß√£o, al√©m disso, a nota diz (na minha opini√£o, √© desnecess√°rio) que essa medi√ß√£o √© realizada em um ponto espec√≠fico no espa√ßo condi√ß√µes externas.  Pode-se adivinhar que, nesse caso, devemos usar o fator de calibra√ß√£o registrado no fabricante, embora seja melhor indicar isso explicitamente na nota.  Tudo √© mais ou menos claro e √© interpretado quase sem ambiguidade (embora, no contexto do estudo da documenta√ß√£o t√©cnica, deva-se dizer que tudo √© confuso e permite varia√ß√µes nas interpreta√ß√µes, e isso √© inaceit√°vel, mas, se o fizermos, o t√≥pico de mais discuss√µes simplesmente desaparecer√° (e o que vem a seguir) escrever, n√£o est√° claro, portanto, mostrar indulg√™ncia). <br><br>  Mas com a segunda linha do caso, √© pior - os limites das mudan√ßas de temperatura e tens√£o de alimenta√ß√£o s√£o dados e argumenta-se que, usando algum tipo de procedimento de calibra√ß√£o m√°gico, voc√™ pode obter resultados significativamente melhores do que os resultados de f√°brica em toda a faixa.  Minha pergunta surge imediatamente - se isso pode ser alcan√ßado em qualquer lugar (a qualquer momento da temperatura e da fonte de alimenta√ß√£o) e o fabricante sabe como fazer isso, ent√£o por que ela n√£o fez isso sozinha na calibra√ß√£o de f√°brica em um ponto espec√≠fico das condi√ß√µes?  Voltamos √† descri√ß√£o do byte de calibra√ß√£o e observamos que ele recebe 128 valores e isso abrange a faixa de 50% a 200% da nominal, que corresponde a 150/128 ~ 1,17% da varia√ß√£o de frequ√™ncia por unidade de valor de calibra√ß√£o, o que deve fornecer a precis√£o esperada melhor do que em 1%  Mas devemos levar em conta que a caracter√≠stica de ajuste n√£o √© claramente linear e, na regi√£o de grandes valores de calibra√ß√£o, temos 60% / 32 ~ 2% da etapa (dados retirados do gr√°fico, eu expressei repetidamente minha atitude com rela√ß√£o a um m√©todo semelhante de representa√ß√£o de par√¢metros t√©cnicos, mas repito - isso √© inaceit√°vel o m√©todo, embora, √© claro, seja melhor que nada), o que fornece uma precis√£o de 1% e se levarmos em conta a monotonicidade da caracter√≠stica de ajuste (sim, √© o que a documenta√ß√£o diz, ela n√£o √© desenhada no gr√°fico, mas claramente indicada no texto. Recuso-me categoricamente a entender para  para, eo mais importante porque, a empresa queria torn√°-lo uma lei de ajuste, mas conseguiu), que √© claramente indicado nas orienta√ß√µes, √© necess√°rio considerar a precis√£o de 2% √© bastante vi√°vel.  N√£o gosto muito de ver o gr√°fico, mas isso n√£o √© necess√°rio e os dados tabulares s√£o suficientes.  Nesta parte, a documenta√ß√£o deve ser considerada completamente compreens√≠vel e consistente, o crit√©rio de corre√ß√£o est√° fora do escopo de nossa compet√™ncia. <br><br>  A segunda parte do bal√© de Marleson.  - a influ√™ncia de condi√ß√µes externas. <br><br>  E ent√£o come√ßa "lixo, fuma√ßa e sodomia".  Em vez de tabelas de valores, somos convidados a ver imagens (por algum motivo, elas s√£o chamadas de gr√°ficos de valores t√≠picos na documenta√ß√£o) e, como voc√™ sabe, "a principal vantagem da representa√ß√£o gr√°fica da informa√ß√£o √© a sua visibilidade e n√£o tem outras vantagens".  Seria poss√≠vel usar essas informa√ß√µes e remover os valores-limite do gr√°fico ("embora isso seja ofensivo para a equipe") se esse gr√°fico n√£o fosse fornecido na se√ß√£o "Caracter√≠sticas t√≠picas".  Eu n√£o sei como algu√©m, pessoalmente, estou profundamente convencido de que, para indicar significados t√≠picos (ou t√≠picos, n√£o sei como ser mais corretos, em um filme eles disseram "apar√™ncia t√≠pica"), pelo menos na forma de gr√°fico, mesmo na tabela, isso simplesmente n√£o indica nada.  Eles n√£o podem ser orientados no projeto, porque esses par√¢metros n√£o est√£o claros do que significam e qualquer desvio dos valores t√≠picos √© aceit√°vel, em contraste com os valores m√≠nimo e m√°ximo, cuja transi√ß√£o indica um mau funcionamento do dispositivo. <br><br>  Bem, n√≥s passamos, tentaremos extrair pelo menos algumas informa√ß√µes e veremos que, quando a temperatura mudar de -40 a + 80 ¬∞ C, a frequ√™ncia do gerador muda em ¬± 4%.  Uma imagem semelhante com a tens√£o de alimenta√ß√£o - apenas gr√°ficos t√≠picos e o erro resultante em -6 + 2% de 3,3 a 5,5.  Os dados sobre o envelhecimento do gerador simplesmente n√£o s√£o fornecidos, o que, em geral, √© l√≥gico, pois no contexto dos par√¢metros j√° fornecidos, a precis√£o de um por cento por 5 anos (valor caracter√≠stico do sil√≠cio) n√£o incomoda ningu√©m. <br><br>  Agora, temos todos os dados para responder √† nossa pergunta inicial - durante a calibra√ß√£o de f√°brica, o gerador n√£o atende aos requisitos de interface para precis√£o, quando calibrado para condi√ß√µes espec√≠ficas de aplica√ß√£o - ele atende aos requisitos de limite, mas n√£o atende ao padr√£o.  Tamb√©m deve ser levado em considera√ß√£o que, se a calibra√ß√£o da tens√£o de alimenta√ß√£o e de um MK espec√≠fico puder ser feita na fabrica√ß√£o do dispositivo e esperar que eles n√£o mudem com o tempo, a temperatura poder√° ser levada em considera√ß√£o apenas em tempo real e requer um padr√£o de tempo externo de precis√£o adequada.  Como o desenvolvimento de dispositivos deve ser guiado pela regra "acreditamos em Deus, tudo o mais exige prova" e n√£o provamos a possibilidade de atender aos requisitos, a resposta correta √© que √© imposs√≠vel garantir a implementa√ß√£o do IRPS que atenda aos requisitos do padr√£o neste MC com um gerador interno.  Observe que fizemos a conclus√£o acima ao analisar a documenta√ß√£o e a formulamos de maneira a enfatizar que, em uma inst√¢ncia espec√≠fica do MK, tudo pode acontecer e acontecer√° se as estrelas subirem com sucesso.  Ou seja, nossa conclus√£o contradiz o post mencionado anteriormente, como isso poderia acontecer, porque tudo funciona muito bem para uma pessoa - vamos descobrir. <br><br>  Agora as cr√≠ticas ao post acima come√ßar√£o.  Primeiro, vamos pensar em como podemos garantir que o dispositivo seja verificado quanto √† conformidade com os requisitos de uma interface espec√≠fica.  Eu posso sugerir as seguintes maneiras: <br><br><ol><li>  Uma boa maneira √© medir os par√¢metros cr√≠ticos da interface do dispositivo e compar√°-los com os requisitos da norma - isso pode ser feito usando instrumentos universais (no nosso caso, o oscilosc√≥pio e a dura√ß√£o do intervalo de bits ou a transmiss√£o completa) ou usando um dispositivo especializado certificado para testar essa interface. </li><li>  Fulano - para organizar a intera√ß√£o com outro dispositivo que implementa a parte de resposta da interface e √© comprovado (atende aos requisitos do padr√£o).  Obviamente, essa verifica√ß√£o √© completamente insuficiente e pode ser aplicada mais para confirmar o mau funcionamento do dispositivo em teste, mas faz pelo menos alguma coisa. </li><li>  O lado ruim √© implementar independentemente a parte da resposta da interface (no mesmo dispositivo ou em outro) e interagir com ele.  Como os dois dispositivos obviamente n√£o est√£o comprovados, a utilidade dessa verifica√ß√£o √© muito, muito duvidosa.  Um bom exemplo dessa abordagem √© o "eco" em um canal serial, que n√£o prova nada e relata pouco mais que nada sobre a velocidade do dispositivo, em princ√≠pio, n√£o est√° quebrado e √© capaz de transmitir alguma coisa. </li><li>  Uma maneira terr√≠vel √© tomar como testador um dispositivo que n√£o atenda aos requisitos da norma (ou melhor, ao contr√°rio deles) e funcionar, como no par√°grafo anterior. </li></ol><br>  √â o √∫ltimo m√©todo usado no posto em considera√ß√£o - √© implementado um receptor de software de canal serial, que, contrariamente aos requisitos da norma, altera sua frequ√™ncia, adaptando-se ao sinal de entrada (especificamente, a dura√ß√£o do bit inicial), o que possibilita receber de forma est√°vel um sinal de baixa qualidade em termos de par√¢metros de tempo.  Isso n√£o quer dizer que isso nunca deva ser feito; al√©m disso, em modems anal√≥gicos, foi adotado o ajuste da velocidade de entrada, que foi implementado de maneira semelhante, mas estava precisamente mudando de frequ√™ncia alterando o divisor, e esse claramente n√£o √© o nosso caso.  E √© nesta vers√£o que tudo √© perfeitamente obtido e a informa√ß√£o √© transmitida de forma est√°vel sob quaisquer condi√ß√µes externas.  Portanto, se falarmos sobre a possibilidade de transmitir informa√ß√µes entre dois MCs operando a partir de geradores internos usando uma interface remotamente reminiscente do IRPS, a resposta √© sim.  Se estamos falando sobre interagir com dispositivos externos que atendem aos requisitos da norma e nada mais, esperamos muitas surpresas desagrad√°veis. <br><br>  A conclus√£o geral do acima exposto: <br><br><ol><li>  ao projetar dispositivos, voc√™ deve se concentrar na documenta√ß√£o (RTFM), </li><li>  voc√™ precisa estudar a documenta√ß√£o e interpretar corretamente o que l√™ (RTFMF), </li><li>  tenha em mente que, em nosso tempo, a documenta√ß√£o pode conter mal-entendidos, imprecis√µes (e at√© erros), portanto </li><li>  verifique as informa√ß√µes recebidas quanto √† consist√™ncia e credibilidade e </li><li>  use as informa√ß√µes obtidas experimentalmente apenas para confirmar as conclus√µes obtidas na an√°lise da documenta√ß√£o, enquanto </li><li>  escolha cuidadosamente os m√©todos de experimentos para testar o equipamento para obter um resultado confi√°vel. </li></ol><br>  Bem, em conclus√£o, como prometido, um pequeno montador.  Eu me permiti reescrever o trecho de c√≥digo citado pelo autor de forma normal, porque o assembler incorporado ao GCC n√£o passa de uma zombaria do programador, posso citar.  N√£o, claro, eu entendo que os desenvolvedores do compilador foram guiados por boas raz√µes, mas o resultado se assemelha dolorosamente √† frase "bem, funciona". <br><br><pre><code class="hljs vhdl">.equ delay=<span class="hljs-number"><span class="hljs-number">15</span></span> TX_Byte: cli ; ld r18,Z+ ; cp r18,r1 ; breq Exit_Transmit ; dec r1 cbi <span class="hljs-keyword"><span class="hljs-keyword">port</span></span>, TX_line Delay_TX: ldi r16,delay Do_Delay_TX: nop dec r16 brne Do_Delay_TX TX_Bit: sbrc r18,<span class="hljs-number"><span class="hljs-number">0</span></span> sbi <span class="hljs-keyword"><span class="hljs-keyword">port</span></span>,TX_line sbrs r18,<span class="hljs-number"><span class="hljs-number">0</span></span> cbi <span class="hljs-keyword"><span class="hljs-keyword">port</span></span>,TX_line lsr r18 lsr r17 brcs Delay_TX sbi <span class="hljs-keyword"><span class="hljs-keyword">port</span></span>, TX_line ldi r16,delay Stop_Bit_TX: nop dec r16 brne Stop_Bit_TX Sei</code> </pre> <br>  E imediatamente um erro no programa chama sua aten√ß√£o - na linha 3 (comentado) o valor do registro 1 deve ser zero, mas a atribui√ß√£o n√£o est√° explicitamente escrita na fun√ß√£o.  Ap√≥s a conclus√£o de um ciclo de transfer√™ncia de byte √∫nico, esse valor √© garantido pela linha 12, mas n√£o na primeira passagem.  Portanto, a inicializa√ß√£o deve ser adicionada, o que exigir√° um aumento no tamanho do c√≥digo. <br><br>  A segunda desvantagem √© a forma√ß√£o real do n√≠vel nas linhas 4-7, uma vez que o m√©todo adotado pelo autor para emitir o pr√≥ximo bit levar√° ao jittering frontal por 2 ciclos de rel√≥gio em v√°rias transi√ß√µes (0-1 e 1-0), o que implicar√° um aumento nos requisitos para a precis√£o da reten√ß√£o de frequ√™ncia.  N√£o que isso daria uma influ√™ncia muito forte, mas se voc√™ pode corrigir uma falha sem estender o programa, por que n√£o - veja a ep√≠grafe.  A vers√£o original teve 4 palavras e foi realizada em 4 compassos, a nova com 4 palavras e foi executada nos mesmos 4 compassos.  Sim, a vers√£o corrigida requer um estudo mais aprofundado da arquitetura MK, mas quem disse que seria f√°cil.  Por outro lado, na primeira vers√£o, a modifica√ß√£o da porta √© at√¥mica e, na segunda, n√£o √©, neste caso, n√£o importa (proibimos explicitamente interrup√ß√µes), mas o sedimento permanece.  Se o MK em quest√£o tivesse um processador de bits real, como na arquitetura 51, poder√≠amos escrever um fragmento ideal combinando todas as vantagens de ambas as abordagens (e at√© um pouco mais curtas), mas o que podemos sonhar com um sonho? <br><br>  A terceira desvantagem √© a quest√£o de mais estilo.  Expressei repetidamente minha atitude em rela√ß√£o √†s constantes m√°gicas que vemos no pre√¢mbulo deste programa.  Enfatizo mais uma vez - pelo fato de o autor definir uma constante no pre√¢mbulo do programa, e n√£o diretamente no operador, a "magia comum das ruas" n√£o vai a lugar algum.  O fato √© que devemos apresentar explicitamente ao leitor o m√©todo de forma√ß√£o de um valor espec√≠fico, e n√£o criar sin√¥nimo para o valor obtido de maneira desconhecida.  Voc√™ pode, √© claro, escrever um coment√°rio em uma linha com um valor no qual especificar a f√≥rmula de c√°lculo, mas √© melhor usar explicitamente a f√≥rmula de c√°lculo para formar a constante e ent√£o voc√™ n√£o precisa de um coment√°rio (√© claro, com os nomes falantes das constantes aplicadas).  Isso √© feito no texto abaixo e observe que convertemos para um n√∫mero inteiro apenas no √∫ltimo momento e arredondamos corretamente, o que nos permite n√£o perder a precis√£o do resultado. <br><br>  H√° outro erro - a dura√ß√£o do bit inicial √© um pouco diferente do intervalo de bits para os dados.  Embora o desvio n√£o seja muito significativo (3 ciclos de clock), no entanto, em altas taxas de bits, onde o intervalo de bits dura cerca de 90 ciclos de clock, esse j√° √© um erro de porcentagem, o que √© inaceit√°vel.  Esse erro pode ser facilmente corrigido adicionando comandos para gerar um atraso adicional, mas isso aumentar√° a dura√ß√£o do programa, para que apenas fixemos sua presen√ßa e depois garantamos que a arquitetura correta do programa (ou seja, mesmo a curto prazo se aplique) seja eliminada automaticamente. <br><br>  Bem, agora que corrigimos os erros (exceto o √∫ltimo), tentaremos melhorar o programa no sentido do crit√©rio principal (obter um registro, neste caso em particular) - o comprimento do c√≥digo.  A primeira coisa que chama a aten√ß√£o √© a presen√ßa de dois atrasos, o que √© ruim porque viola o princ√≠pio DRY (requisito geral) e aumenta o tamanho do c√≥digo (requisito espec√≠fico).  Seria poss√≠vel organizar esse fragmento na forma de um subprograma e ainda assim ganhar√≠amos, pois adicionamos 3 palavras de c√≥digo (1 para cada chamada em dois lugares e 1 para retorno) e economizamos 4, mas h√° uma maneira muito mais bonita - elegante organiza√ß√£o do ciclo de transmiss√£o de bytes, que pode ser visto no texto a seguir. <br><br><pre> <code class="hljs vhdl">.equ delay=<span class="hljs-number"><span class="hljs-number">15</span></span> TX_Byte: cli sec ;   - clt ;  - TransBit: ;    <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> r17,<span class="hljs-keyword"><span class="hljs-keyword">port</span></span> bld r17,Tx_line <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-keyword"><span class="hljs-keyword">port</span></span>,r17 Delay_TX: ;     ldi r17,delay Do_Delay_TX: nop dec r17 brne Do_Delay_TX TX_Bit: bst r16,<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ror</span></span> r16 clc brne TransBit ;    brcs TransBit ;  - Exit_Transmit: Sei</code> </pre><br>  Observe como usamos o byte transmitido junto com o bit de transporte como um contador de bits, uma solu√ß√£o bonita, mas tem uma desvantagem - a dura√ß√£o do √∫ltimo bit de dados ser√° v√°rios (2 ciclos) mais longa que o restante, devido ao atraso na transi√ß√£o.  Se estiv√©ssemos falando de um bit de parada, "n√£o se preocupe", pois n√£o recebemos o intervalo m√≠nimo entre as transfer√™ncias, mas esse √© um pouco significativo e acabamos de criticar o programa original por esse comportamento.  N√£o seremos comparados ao car√°ter b√≠blico da par√°bola do mote aos olhos dos outros e tomaremos medidas para elimin√°-lo.  Esse fen√¥meno pode ser facilmente compensado com a introdu√ß√£o de um atraso de 2 medidas, mas o comprimento do c√≥digo aumentar√° e esse √© um par√¢metro-chave.  Portanto, vamos seguir o caminho cl√°ssico e alterar o tempo da mem√≥ria - usamos um registro separado para organizar o contador de bits transmitidos e obtemos exatamente os mesmos intervalos de bits com o mesmo tamanho de c√≥digo. <br><br>  A pr√≥xima melhoria est√° associada √† forma√ß√£o da dura√ß√£o do intervalo de bits, que no programa original √© realizado em um ciclo de 4 ciclos.  Se o fizermos em tr√™s horas (o menor poss√≠vel neste MK), podemos salvar um byte de c√≥digo e potencialmente melhorar os par√¢metros de precis√£o, pois a discri√ß√£o do atraso se tornar√° menor (o desvio n√£o excede a metade do tamanho do discreto com arredondamento adequado).  Mas deve-se ter em mente que, em um caso espec√≠fico, podemos perder a precis√£o, tudo depende dos dados de origem.  Outra circunst√¢ncia que poderia afetar a escolha de uma dura√ß√£o desse ciclo - o tamanho m√°ximo de atraso para um contador de bytes √© de 256 valores - para a op√ß√£o dispon√≠vel, voc√™ pode usar velocidades de 9600 bauds ou mais, mas com um atraso de 3 ciclos isso n√£o √© poss√≠vel.  Seria muito bom refletir essa circunst√¢ncia (a velocidade m√≠nima permitida da porta) nos coment√°rios do programa e, ao mesmo tempo, exibir uma mensagem de aviso em caso de viola√ß√£o deste requisito.  Bem, fa√ßa as modifica√ß√µes apropriadas nas macros de forma√ß√£o de par√¢metro para formar um atraso, sem esquecer de usar nomes "falantes" para indicar vari√°veis. <br><br><pre> <code class="hljs dos">.<span class="hljs-keyword"><span class="hljs-keyword">equ</span></span> Freq = <span class="hljs-number"><span class="hljs-number">8000000</span></span> .<span class="hljs-keyword"><span class="hljs-keyword">equ</span></span> BaudRate = <span class="hljs-number"><span class="hljs-number">115200</span></span> .<span class="hljs-keyword"><span class="hljs-keyword">equ</span></span> PayLoad = <span class="hljs-number"><span class="hljs-number">9</span></span> ;     .<span class="hljs-keyword"><span class="hljs-keyword">equ</span></span> CycleTime = <span class="hljs-number"><span class="hljs-number">3</span></span> ;    .<span class="hljs-keyword"><span class="hljs-keyword">equ</span></span> delay=((Freq*<span class="hljs-number"><span class="hljs-number">2</span></span>/BaudRate - PayLoad*<span class="hljs-number"><span class="hljs-number">2</span></span>)+CycleTime)/(CycleTime*<span class="hljs-number"><span class="hljs-number">2</span></span>) TX_Byte: cli ldi r18,<span class="hljs-number"><span class="hljs-number">10</span></span> sec ;   - clt ;  - TransBit: <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> r17,port bld r17,Tx_line out port,r17 Delay_TX: ldi r17,delay Do_Delay_TX: dec r17 brne Do_Delay_TX TX_Bit: bst r16,<span class="hljs-number"><span class="hljs-number">0</span></span> ror r16 dec r18 brne TransBit Exit_Transmit: sei</code> </pre><br>  Agora, vejamos o resultado - o tamanho do c√≥digo diminuiu de 20 para 16 palavras (se levarmos em conta apenas a transmiss√£o em si, e ainda mais impressionante - de 18 para 14, o jitter das frentes desapareceu (√© claro, apenas o componente de jitter, causado pelos recursos do programa, no componente de hardware, n√≥s n√£o estamos violando), a precis√£o da manuten√ß√£o de intervalos de tempo melhorou, o programa tornou-se mais vis√≠vel e mais f√°cil de entender (devido a coment√°rios, pois mesmo um programa de montagem bem escrito geralmente n√£o √© auto-documentado). <br><br>  A conclus√£o da √∫ltima parte √© que, se vamos estabelecer recordes mundiais na programa√ß√£o em linguagem assembly, devemos estudar a arquitetura de um MK em particular e aplicar o conhecimento obtido para obter o resultado ideal, prestando aten√ß√£o a todas as sutilezas. <br><br>  Bem, e em conclus√£o - a tarefa de escrever c√≥digo do tamanho m√≠nimo hoje em dia parece um tanto artificial, mas, inesperadamente, recebe confirma√ß√£o de sua vitalidade.  No final do ano passado (2016, quanto tempo esse post aguardava a sua vez), foi anunciado um novo MK da fam√≠lia MSP430, que junto com o pre√ßo excepcionalmente baixo (26 centavos - estamos aguardando a apar√™ncia dos dispositivos chineses baseados nele) tem um tamanho de mem√≥ria de programa excepcionalmente pequeno - 512 byte (n√£o, n√£o me enganei, a letra "k" imediatamente ap√≥s o n√∫mero n√£o √©).  Portanto, o tamanho do c√≥digo pode ser cr√≠tico ao usar este dispositivo, e geralmente escrever programas extremos exige um estudo aprofundado do MK, e "o trabalho em si √© uma b√™n√ß√£o". </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt412959/">https://habr.com/ru/post/pt412959/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt412949/index.html">Astr√≥logos anunciam semana de desenvolvimento iOS no Avito</a></li>
<li><a href="../pt412951/index.html">DotVVM - Comunica√ß√£o entre cliente e servidor</a></li>
<li><a href="../pt412953/index.html">Calibra√ß√£o da c√¢mera Intel RealSense d435 usando OpenCV2 e ROS</a></li>
<li><a href="../pt412955/index.html">Testes de interface do usu√°rio no Xcode com o Embassy e o Succulent</a></li>
<li><a href="../pt412957/index.html">Mi Band 4 e Mi Band 5: o futuro das pulseiras inteligentes da Xiaomi</a></li>
<li><a href="../pt412961/index.html">Compartilhando economia nas telecomunica√ß√µes</a></li>
<li><a href="../pt412963/index.html">Nova precipita√ß√£o: o que se sabe sobre o Vault 76?</a></li>
<li><a href="../pt412967/index.html">Fazendo um bom widget de ajuste de brilho</a></li>
<li><a href="../pt412969/index.html">Os sistemas de reconhecimento de rosto aparecem nas escolas americanas, mas sua efic√°cia est√° em quest√£o</a></li>
<li><a href="../pt412971/index.html">Criando um aplicativo de colora√ß√£o no Unity3D</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>