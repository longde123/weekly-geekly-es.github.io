<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>✍🏾 🧑🏾 ♀️ Test du code SQL Server avec tSQLt 🚋 👩🏻‍🤝‍👨🏼 🌱</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="FYI: Cet article est une version développée de mon rapport sur SQA Days # 25. 

 Sur la base de mon expérience de communication avec des collègues, je...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Test du code SQL Server avec tSQLt</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/arcadia/blog/461133/">  <i>FYI: Cet article est une version développée de mon <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">rapport</a> sur SQA Days # 25.</i> <br><br>  Sur la base de mon expérience de communication avec des collègues, je peux dire que tester du code dans une base de données n'est pas une pratique courante.  Cela peut être un danger potentiel.  La logique de la base de données est écrite par les mêmes personnes qui écrivent le code "normal".  Par conséquent, des erreurs peuvent également y être présentes, et elles peuvent également entraîner des conséquences négatives pour le produit, l'entreprise et les consommateurs.  Peu importe qu'il s'agisse de procédures stockées qui aident le backend ou d'ETL qui convertissent des données en stockage - il y a un risque et les tests peuvent le réduire considérablement.  Je veux vous dire ce qu'est tSQLt et comment il nous aide à tester le code dans SQL Server. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/2e/-h/nx/2e-hnxb3bddbq3ck_8vi4jwah8i.jpeg"></div><br><a name="habracut"></a><br><h1>  Contexte </h1><br>  Il existe un grand entrepôt sur SQL Server contenant diverses données de recherche clinique.  Il est rempli à partir de diverses sources (principalement des bases de données documentaires).  À l'intérieur du serveur lui-même, les données sont converties à plusieurs reprises à l'aide d'ETL.  À l'avenir, ces données peuvent être téléchargées dans des bases de données plus petites pour être utilisées par des applications Web qui résolvent certains petits problèmes spécifiques.  Certains clients du client demandent également une API pour leurs besoins internes.  Dans la mise en œuvre de ces API, les procédures stockées et les requêtes sont souvent utilisées. <br><br><div style="text-align:center;"><img width="75%" height="75%" src="https://habrastorage.org/webt/iw/vu/rz/iwvurz8sbflhuz3mkj39ipf9rag.png"></div><br>  En général, le code est du côté du SGBD dans l'ordre. <br><br><h1>  Pourquoi tout cela est nécessaire </h1><br>  Comme déjà compris depuis l'introduction, le code dans la base de données est le même code <br>  comme les autres, et il peut également y avoir des erreurs. <br><br>  Je pense que beaucoup de gens sont conscients de la dépendance du prix du bug au moment de sa découverte, dont la découverte est généralement attribuée à Barry Bohem.  Une erreur commise à un stade précoce et détectée à un stade ultérieur peut être plus coûteuse en raison de la nécessité de passer par plusieurs étapes (codage, unité, intégration, test du système, etc.) à la fois pour localiser l'erreur et ramener le code corrigé dans l'étape à laquelle le problème a été identifié.  Cet effet est également pertinent pour le cas d'entrepôt.  Si une erreur s'est glissée dans certains ETL et que les données subissent plusieurs transformations, alors si une erreur est détectée dans les données, vous aurez: <br><br><ol><li>  Suivez toutes les étapes de conversion pour localiser le problème. </li><li>  Résolvez le problème. </li><li>  Récupérez les données corrigées (les corrections manuelles ne sont pas exclues). </li><li>  Vérifiez que les données incorrectes provoquées par l'erreur n'apparaissent pas ailleurs. </li></ol><br>  N'oubliez pas que nous ne vendons pas de peluches.  Une erreur dans un domaine comme la recherche clinique peut nuire non seulement aux entreprises, mais aussi à la santé des personnes. <br><br><h1>  Comment tester? </h1><br>  Puisque nous parlons de tests de code, nous entendons les tests unitaires et d'intégration.  Ces choses sont très répétitives et impliquent une régression constante.  À strictement parler, personne ne procède à de tels tests manuellement (enfin, peut-être à l'exception de certains cas complètement dégénérés). <br><br>  Un bon bonus: les tests peuvent être un matériau auxiliaire lors de la documentation du code.  Soit dit en passant, les exigences des clients peuvent ressembler à ceci (cliquable): <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/webt/fh/af/xb/fhafxb5yph-tgvy2zhka9jfcvmk.png"></a> </div><br>  Excel, deux colonnes avec exigences + informations de support dispersées dans d'autres colonnes + balisage flou, ce qui est plus déroutant qu'utile.  Si nécessaire, restaurer les souhaits d'origine peut être difficile.  Les tests peuvent aider à saisir plus précisément les nuances de l'implémentation (bien sûr, vous ne devez pas les considérer comme l'équivalent de la documentation). <br><br>  Malheureusement, avec la complexité du code, la complexité des tests augmente et cet effet peut être nivelé. <br><br>  Les tests peuvent servir de couche de sécurité supplémentaire contre les morses spontanés.  Les auto-tests en CI en raison du formalisme aident à faire face à ce problème. <br><br>  Si notre choix s'est porté sur la voie de l'automatisation, alors nous devons décider des outils pour sa mise en œuvre. <br><br><h1>  Comment tester? </h1><br>  Dans le cas du test du code dans la base de données, je distingue deux approches: propulsée par SQL, c'est-à-dire fonctionnant directement dans le SGBD et non propulsée par SQL.  J'ai pu mettre en évidence les nuances suivantes: <br><div class="scrollable-table"><table><tbody><tr><th>  Alimenté par SQL <br></th><th>  Non alimenté par SQL <br></th></tr><tr><td>  Nécessite l'installation d'objets dans la base de données <br></td><td>  L'installation d'outils externes supplémentaires dans la base de données est requise <br></td></tr><tr><td>  Les tests sont toujours indépendants des technologies utilisées dans l'application en dehors de la base de données <br></td><td>  Les tests peuvent dépendre des technologies utilisées en dehors de la base de données. <br></td></tr><tr><td>  Le cadre est toujours lié à un SGBD spécifique </td><td>  Le cadre prend souvent en charge plusieurs SGBD. </td></tr><tr><td>  Pour écrire des tests, seule la connaissance du SGBD est requise;  pour le développement, vous pouvez utiliser des testeurs manuels ou DBA </td><td>  L'écriture de tests nécessite généralement une connaissance supplémentaire de tout langage et / ou technologie de programmation;  ont souvent besoin de l'aide de programmeurs <br></td></tr><tr><td>  L'exécution au niveau du SGBD permet l'utilisation de contrefaçons et d'assertions plus avancées <br></td><td>  L'exécution externe peut limiter les capacités de l'outil <br></td></tr></tbody></table></div>  Dans SQL Server, nous avons le choix: <br><div class="scrollable-table"><table><tbody><tr><th colspan="6" align="center">  Informations générales </th></tr><tr><th>  Le titre </th><th>  L'approche </th><th>  L'architecture </th><th>  Écrit le </th><th>  Tests pour </th></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tSQLt</a> </td><td>  Alimenté par SQL </td><td>  xUnit </td><td>  T-SQL + CLR </td><td>  T-sql </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">TSQLUnit</a> </td><td>  Alimenté par SQL </td><td>  xUnit </td><td>  T-sql </td><td>  T-sql </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">utTSQL</a> </td><td>  Alimenté par SQL </td><td>  xUnit </td><td>  T-sql </td><td>  T-sql </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Tst</a> </td><td>  Alimenté par SQL </td><td>  xUnit </td><td>  T-sql </td><td>  T-sql </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Dbfit</a> </td><td>  Non alimenté par SQL </td><td>  Fitnessess </td><td>  C # / java </td><td>  Démarque wiki </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Slacker</a> </td><td>  Non alimenté par SQL </td><td>  RSpec (orienté BDD) </td><td>  Rubis </td><td>  Rubis </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">NUnit</a> , etc. </td><td>  Non alimenté par SQL </td><td>  xUnit </td><td>  N / a </td><td>  N / a </td></tr></tbody></table></div><div class="scrollable-table"><table><tbody><tr><th colspan="4" align="center">  Les dates </th></tr><tr><th>  Le titre </th><th>  Première apparition </th><th>  Dernier commit </th><th>  Dernière version </th></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tSQLt</a> </td><td>  2007-07-27 </td><td>  07/07/2019 </td><td>  31/01/2016 </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">TSQLUnit</a> </td><td>  16/12/2006 (0,9) <br>  2007-07-21 (0,91 rc1) </td><td>  26/04/2018 (GitHub) </td><td>  04/09/2011 (SourceForge) </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">utTSQL</a> </td><td>  2003-03-12 </td><td>  2003-03-12 </td><td>  2003-03-12 </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Tst</a> </td><td>  02-03-2009 (v1.0) </td><td>  N / a </td><td>  30-03-2012 </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Dbfit</a> </td><td>  12-01-2009 </td><td>  10-09-2018 </td><td>  15/08/2015 </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Slacker</a> </td><td>  23/06/2011 </td><td>  12-12-2018 </td><td>  12-12-2018 </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">NUnit</a> , etc. </td><td>  N / a </td><td>  N / a </td><td>  N / a </td></tr></tbody></table></div><div class="scrollable-table"><table><tbody><tr><th colspan="7" align="center">  Les possibilités </th></tr><tr><th>  Le titre </th><th>  CLR non requis </th><th>  Sortie XML </th><th>  Des tests enveloppés dans une transaction </th><th>  Faux </th><th>  Gestionnaires d'erreurs </th><th>  Assertions </th></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tSQLt</a> </td><td>  - </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  Super </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">TSQLUnit</a> </td><td>  + </td><td>  - </td><td>  + </td><td>  - </td><td>  - </td><td>  Très mauvais </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">utTSQL</a> </td><td>  + </td><td>  - </td><td>  - </td><td>  - </td><td>  - </td><td>  Mauvais </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Tst</a> </td><td>  + </td><td>  + </td><td>  + (opt.) </td><td>  - </td><td>  + </td><td>  Super </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Dbfit</a> </td><td>  + </td><td>  - </td><td>  + (opt.) </td><td>  - </td><td>  + </td><td>  Bon;  il y a des nuances </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Slacker</a> </td><td>  + </td><td>  - </td><td>  + (opt.) </td><td>  - </td><td>  - </td><td>  Bon;  il y a des nuances </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">NUnit</a> , etc. </td><td>  + </td><td>  + </td><td>  N / a </td><td>  N / a </td><td>  N / a </td><td>  Super  il y a des nuances </td></tr></tbody></table></div><div class="scrollable-table"><table><tbody><tr><th colspan="3" align="center">  Autre </th></tr><tr><th>  Le titre </th><th>  La documentation </th><th>  Communauté </th></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tSQLt</a> </td><td>  Super  il y a des nuances </td><td>  Super </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">TSQLUnit</a> </td><td>  Mauvais </td><td>  Mauvais </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">utTSQL</a> </td><td>  Super </td><td>  Mauvais </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Tst</a> </td><td>  Super </td><td>  Mauvais </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Dbfit</a> </td><td>  Super </td><td>  Ok </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Slacker</a> </td><td>  Super </td><td>  Ok </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">NUnit</a> , etc. </td><td>  Super </td><td>  Super </td></tr></tbody></table></div>  Les évaluations de «bon-mauvais» sont subjectives, désolé, sans cela, nulle part. <br><br>  Explication: La «première apparition» est la date la plus ancienne du chemin de vie du framework que j'ai réussi à trouver, c'est-à-dire la première version ou commit. <br><br>  Vous remarquerez peut-être que les alternatives basées sur SQL ont été abandonnées depuis un certain temps, et tSQLt est la seule option prise en charge.  Fonctionnellement, tSQLt gagne également.  La seule chose est qu'en termes d'assertions, TST propose un choix légèrement plus riche que tSQLt, qui, cependant, est peu susceptible de l'emporter sur ses inconvénients. <br><br>  Il y a des nuances dans la documentation tSQLt, mais j'en parlerai plus tard. <br><br>  Dans le monde non propulsé par SQL, les choses ne sont pas aussi simples.  Des alternatives, bien que non super actives, sont en cours de développement.  DbFit est un outil intéressant basé sur le framework FitNesse.  Il propose des tests d'écriture sur le balisage wiki.  Slacker est également une chose curieuse - l'approche BDD lors de l'écriture de tests pour la base de données. <br><br>  Je vais discuter des assertions non propulsées par SQL.  Extérieurement, il y en a moins, et on pourrait dire qu'ils sont pires à cause de cela.  Mais ici, il vaut la peine de considérer qu'ils sont fondamentalement différents de tSQLt.  Tout n'est pas si simple. <br><br>  La dernière ligne est «NUnit, etc.»  - c'est plutôt un rappel.  De nombreux cadres de tests unitaires familiers dans le travail quotidien peuvent être utilisés sur des bases de données auxiliaires à l'aide de bibliothèques auxiliaires.  Le tableau a beaucoup de N / A, car cette ligne, en fait, comprend de nombreux outils.  Les «nuances» dans la colonne d'assertion viennent du même point - dans différents outils, leur ensemble peut varier et la question de l'applicabilité à la base de données est ouverte. <br><br>  Comme autre mesure intéressante, nous pouvons considérer <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">les tendances de Google</a> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ud/2u/km/ud2ukmcoyjvstvhcu2taegpib34.png"></div><br>  Nuances: <br><br><ol><li>  Je n'ai pas inclus Slacker, car ce nom peut signifier beaucoup de choses (et les demandes comme «Slacker framework» ne sont pas particulièrement visibles sur les graphiques). </li><li>  Par curiosité, la tendance TST a été ajoutée, mais elle ne reflète pas non plus beaucoup la situation, car il s'agit d'une abréviation qui signifie beaucoup de choses différentes. </li><li>  Je n'ai pas inclus NUnit et ses analogues, car il s'agissait à l'origine de frameworks pour tester le code des applications elles-mêmes, et leurs tendances ne sont pas représentatives de notre contexte. </li></ol><br>  En général, nous pouvons dire que tSQLt se présente favorablement dans le contexte des analogues. <br><br><h1>  Qu'est-ce que tSQLt? </h1><br>  tSQLt, comme vous pouvez le deviner, est un framework de tests unitaires basé sur SQL. <br><br>  → <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Site officiel</a> <br><br>  La prise en charge de SQL Server est annoncée depuis 2005 SP2.  Je n'ai jamais pu regarder aussi loin dans le passé, mais nous avons 2012 sur le serveur de développement, j'ai localement 2017 - il n'y a eu aucun problème. <br><br>  Open source, une licence Apache 2.0, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">est disponible sur GitHub</a> .  Vous pouvez bifurquer, passer en contrebande, utiliser gratuitement dans des projets commerciaux et, surtout, ne pas avoir peur des signets dans le CLR. <br><br><h1>  Mécanique du travail </h1><br><div style="text-align:center;"><img width="85%" height="85%" src="https://habrastorage.org/webt/1v/kx/wi/1vkxwixwjyna756vsce7uhwqzw0.png"></div><br>  Les cas de test sont des procédures stockées.  Ils sont combinés en classes de test (suite de tests en termes de xUnit). <br><br>  Les classes de test ne sont rien de plus que des schémas de base de données réguliers.  Ils diffèrent des autres régimes par leur inscription dans les tableaux-cadres.  Vous pouvez effectuer un tel enregistrement en appelant une procédure - tSQLt.NewTestClass. <br><br>  À l'intérieur de la classe de test, il est également possible de définir une procédure SetUp qui sera exécutée avant l'exécution de chaque scénario de test individuel. <br><br>  Une procédure de démontage pour restaurer le système à la fin du scénario de test n'est pas nécessaire.  Chaque scénario de test ainsi que la procédure de configuration sont exécutés dans une transaction distincte, qui est annulée après la collecte des résultats.  C'est très pratique, mais cela a des effets négatifs, dont je parlerai ci-dessous. <br><br>  Le cadre vous permet d'exécuter des cas de test individuels, des classes de test entières ou toutes les classes de test enregistrées à la fois. <br><br><h1>  Caractéristiques par exemple </h1><br>  N'ayant pas envie de raconter un guide officiel déjà simple, je vais parler des possibilités du framework à l'aide d'exemples. <br><br>  <i>Avertissement:</i> <br><br><ul><li>  <i>les exemples sont simplifiés;</i> </li><li>  <i>dans l'original, tout le code de test n'a pas été écrit par moi, ce sont plutôt les fruits de la créativité collective;</i> </li><li>  <i>L'exemple 2 a été inventé afin de démontrer plus complètement les capacités de tSQLt.</i> </li></ul><br><h3>  Exemple 1: CsvSql </h3><br>  À la demande de l'un des clients du client, les éléments suivants ont été mis en œuvre.  La base de données dans les champs Nvarchar (MAX) stocke les requêtes SQL.  Pour afficher ces requêtes, une interface minimale est boulonnée.  Les jeux de résultats renvoyés par ces requêtes sont utilisés par le backend pour générer le fichier CSV à renvoyer via l'appel API. <br><br><div style="text-align:center;"><img width="75%" height="75%" src="https://habrastorage.org/webt/5q/mu/oy/5qmuoyyjjvlphk79jt-xtawwjn8.png"></div><br>  Les jeux de résultats sont assez lourds et contiennent de nombreuses colonnes.  Un exemple conditionnel d'un tel ensemble de résultats: <br><br><div style="text-align:center;"><img width="75%" height="75%" src="https://habrastorage.org/webt/dg/50/bb/dg50bbx25qaw6ycwpfqcsfj5kyk.png"></div><br>  Cet ensemble de résultats comprend des données d'essais cliniques.  Examinons de plus près comment ClinicsNum est considéré - le nombre de cliniques impliquées dans l'étude.  Nous avons deux tableaux: [Trial] et [Clinic]: <br><br><div style="text-align:center;"><img width="85%" height="85%" src="https://habrastorage.org/webt/qo/mu/n-/qomun-gdbdl05teniypbtzi8jio.png"></div><br>  Il y a FK: [Clinic]. [TrialID] -&gt; [Trial]. [TrialID].  Évidemment, pour calculer le nombre de cliniques, nous avons juste besoin du COUNT habituel (*). <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(*), ...  <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dbo.Trial  <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> dbo.Clinic    <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> Trial.ID = Clinic.TrialID  <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> Trial.Name = @trialName  <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> ...</code> </pre> <br>  Comment testons-nous une telle demande?  Pour commencer, nous pouvons utiliser le talon pratique - FakeTable, qui simplifiera considérablement le travail ultérieur. <br><br><pre> <code class="sql hljs">EXEC tSQLt.FakeTable 'dbo.Trial'; EXEC tSQLt.FakeTable 'dbo.Clinic';</code> </pre> <br>  FakeTable fait une chose simple: renommer les anciennes tables et en créer de nouvelles à leur place.  Les mêmes noms, les mêmes colonnes, mais sans contrainte'ov et trigger'ov. <br><br>  Pourquoi avons-nous besoin de cela: <br><br><ol><li>  Certaines données de la base de données de test peuvent interférer avec les tests.  Grâce à FakeTable, nous ne dépendons pas d'eux. </li><li>  Pour le test, en règle générale, vous ne devez remplir que quelques colonnes.  Il peut y en avoir beaucoup dans le tableau, et certains d'entre eux auront des contraintes.  De cette façon, nous simplifions la poursuite de l'installation des données de test - nous n'insérerons que celles qui sont vraiment nécessaires pour le scénario de test. </li><li>  Nous n'affecterons certainement aucun déclencheur lors de l'insertion de données de test et nous n'avons pas à nous soucier des post-effets indésirables. </li></ol><br>  Ensuite, insérez les données de test dont nous avons besoin: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> dbo.Trial ([<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>], [<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>,   <span class="hljs-string"><span class="hljs-string">'Valerian'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> dbo.Clinic ([<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>], [TrialID], [<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>,   <span class="hljs-number"><span class="hljs-number">1</span></span>,        <span class="hljs-string"><span class="hljs-string">'Clinic1'</span></span>), (<span class="hljs-number"><span class="hljs-number">2</span></span>,   <span class="hljs-number"><span class="hljs-number">1</span></span>,        <span class="hljs-string"><span class="hljs-string">'Clinic2'</span></span>);</code> </pre> <br>  Nous obtenons notre requête de la base de données, créons la table réelle et la remplissons avec le jeu de résultats de notre requête: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @sqlStatement <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) = (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span>… <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> actual ([TrialID], ...); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> actual EXEC sp_executesql @sqlStatement, ...</code> </pre> <br>  Remplir attendu - valeurs attendues: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> expected (   ClinicsNum <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> expected <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre> <br>  Je veux attirer votre attention sur le fait que dans le tableau Expected, nous n'avons qu'une seule colonne, alors que dans Actual, nous en avons un ensemble complet. <br><br><div style="text-align:center;"><img width="80%" height="80%" src="https://habrastorage.org/webt/qd/gx/ga/qdgxgaqr4cjp2eayoz0eycjs8cg.png"></div><br>  Cela est dû à la fonctionnalité de la procédure AssertEqualsTable, que nous utiliserons pour vérifier les valeurs. <br><br><pre> <code class="sql hljs">EXEC tSQLt.AssertEqualsTable   'expected',   'actual',   'incorrect number of clinics';</code> </pre> <br>  Il compare uniquement les colonnes présentes dans les deux tables comparées.  C'est très pratique dans notre cas, car la requête de test renvoie un grand nombre de colonnes, chacune ayant sa propre logique, parfois très déroutante.  Nous ne voulons pas gonfler les cas de test, donc cette fonctionnalité nous est très utile.  Bien sûr, c'est une épée à double tranchant.  Si dans Réel, un ensemble de colonnes est rempli automatiquement via SELECT TOP 0 et à un moment donné, une colonne supplémentaire apparaît soudainement, alors un tel cas de test ne rattrapera pas ce moment.  Pour gérer de telles situations, vous devez effectuer des vérifications supplémentaires. <br><br><h3>  Procédures soeurs AssertEqualsTable </h3><br>  Il convient de mentionner que tSQLt contient deux procédures similaires à AssertEqualsTable.  Ce sont AssertEqualsTableSchema et AssertResultSetsHaveSameMetaData.  Le premier fait la même chose que AssertEqualsTable, mais sur les métadonnées de la table.  La seconde fait une comparaison similaire, mais sur les métadonnées des jeux de résultats. <br><br><h3>  Exemple 2: contraintes </h3><br>  Dans l'exemple précédent, nous avons vu comment vous pouvez supprimer la contrainte.  Mais que faire si nous devons les vérifier?  Techniquement, cela fait également partie de la logique et peut également être considéré comme un candidat pour la couverture des tests. <br><br>  Considérez la situation de l'exemple précédent.  Deux tables - [Trial] et [Clinic];  [TrialID] FK: <br><br><div style="text-align:center;"><img width="80%" height="80%" src="https://habrastorage.org/webt/-8/zu/v3/-8zuv3clqoo3ygm9wko5hpibc90.png"></div><br>  Essayons d'écrire un cas de test pour tester cette contrainte.  Au début, comme la dernière fois, nous simulons des tables. <br><br><pre> <code class="sql hljs">EXEC tSQLt.FakeTable '[dbo].[Trial]' EXEC tSQLt.FakeTable '[dbo].[Clinic]'</code> </pre> <br>  L'objectif est le même: se débarrasser des restrictions inutiles.  Nous voulons des chèques isolés sans gestes inutiles. <br><br>  Ensuite, nous renvoyons la contrainte dont nous avons besoin à l'endroit à l'aide de la procédure ApplyConstraint: <br><br><pre> <code class="sql hljs">EXEC tSQLt.ApplyConstraint   '[dbo].[Clinic]',   'Trial_FK';</code> </pre> <br>  Ici, nous avons mis en place une configuration pratique pour la vérification directe.  Le contrôle lui-même consistera en ce qu'une tentative d'insertion de données entraînera inévitablement une exception.  Pour que le scénario de test fonctionne correctement, nous devons intercepter cette exception.  Le gestionnaire d'exceptions ExpectException nous y aidera. <br><br><pre> <code class="sql hljs">EXEC tSQLt.ExpectException   @ExpectedMessage = 'The <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">statement</span></span> conflicted...<span class="hljs-string"><span class="hljs-string">',   @ExpectedSeverity = 16,   @ExpectedState = 0;</span></span></code> </pre> <br>  Après avoir installé le gestionnaire, vous pouvez essayer d'insérer le non insérable. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> [dbo].[Clinic] ([TrialID])   <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre> <br>  Exception interceptée.  Test réussi. <br><br><h3>  Procédures soeurs ApplyConstraint </h3><br>  Les développeurs TSQLt nous proposent une approche similaire pour tester les déclencheurs.  Vous pouvez utiliser la procédure ApplyTrigger pour renvoyer un déclencheur à la fausse table.  De plus, tout est comme dans l'exemple ci-dessus - nous déclenchons le déclencheur, vérifions le résultat. <br><br><h3>  ExpectNoException - l'antonyme d'ExpectException </h3><br>  Pour les cas où une exception ne devrait certainement pas se produire, il existe une procédure ExpectNoException.  Il fonctionne de la même manière qu'une ExpectException, sauf que le test est considéré comme ayant échoué si une exception se produit. <br><br><h3>  Exemple 3: sémaphore </h3><br>  La situation est la suivante.  Il existe un certain nombre de procédures stockées et de services Windows.  Le début de leur exécution peut être provoqué par divers événements externes.  Dans ce cas, l'ordre admissible de leur exécution est fixe.  Un sémaphore est utilisé pour différencier l'accès aux tables de base de données.  Il s'agit d'un groupe de procédures stockées. <br><br>  Par exemple, considérez l'une de ces procédures.  Nous avons deux tableaux: <br><br><div style="text-align:center;"><img width="80%" height="80%" src="https://habrastorage.org/webt/-m/hz/8-/-mhz8-fm_n1w7njpryiv8z3epiw.png"></div><br>  Le tableau [Processus] contient une liste des processus autorisés à être exécutés, [ProcStatus] - une liste des statuts de ces processus. <br><br>  Que fait notre procédure?  Lorsqu'il est appelé, une série de vérifications se produit d'abord: <br><br><ol><li>  Le nom du processus à démarrer, passé dans le paramètre de procédure, est recherché dans le champ [Nom] de la table [Processus]. </li><li>  Si le nom du processus a été trouvé, il est vérifié s'il est actuellement possible de le démarrer - l'indicateur [IsRunable] de la table [Process]. </li><li>  S'il s'est avéré que le processus est acceptable pour l'exécution, alors il reste à être sûr qu'il n'est pas déjà en cours d'exécution.  Dans le tableau [ProcStatus], l'absence d'enregistrements sur ce processus avec le statut = 'InProg' est vérifiée. </li></ol><br>  Si tout va bien, un nouvel enregistrement sur ce processus avec le statut «InProg» est ajouté à ProcStatus (cela est considéré comme un lancement), l'ID de cet enregistrement est renvoyé avec le paramètre ProcStatusId.  Si une vérification échoue, nous nous attendons à ce qui suit: <br><br><ol><li>  Une lettre est envoyée à l'administrateur système. </li><li>  Renvoie ProcStatusId = -1. </li><li>  Une nouvelle entrée dans [ProcStatus] n'est pas ajoutée. </li></ol><br>  Écrivons un cas de test pour tester le cas lorsque le processus ne figure pas dans la liste des cas acceptables. <br><br>  Pour plus de commodité, appliquez immédiatement FakeTable.  Ici, ce n'est pas si fondamentalement important, mais cela peut être utile: <br><br><ol><li>  Nous sommes garantis de nous débarrasser de toutes les données qui pourraient interférer avec la bonne exécution du cas de test. </li><li>  Nous simplifierons la vérification des entrées manquantes dans ProcStatus. </li></ol><br><pre> <code class="sql hljs">EXEC tSQLt.FakeTable 'dbo.Process'; EXEC tSQLt.FakeTable 'dbo.ProcStatus';</code> </pre> <br>  Pour envoyer un message, la procédure [SendEmail] écrite par nos programmeurs est utilisée.  Pour vérifier l'envoi d'une lettre aux administrateurs, nous devons intercepter son appel.  Dans ce cas, tSQLt nous propose d'utiliser SpyProcedure. <br><br><pre> <code class="sql hljs">EXEC tSQLt.SpyProcedure 'dbo.SendEmail'</code> </pre> <br>  SpyProcedure effectue les opérations suivantes: <br><br><ol><li>  Crée une table de la forme [dbo]. [SendEmail_SpyProcedureLog]. </li><li>  Comme FakeTable, il remplace la procédure d'origine par la sienne, avec le même nom, mais contenant une logique de journalisation.  Si vous le souhaitez, vous pouvez ajouter votre propre logique. </li></ol><br>  Comme vous pouvez le deviner, la journalisation se produit dans la table [dbo]. [SendEmail_SpyProcedureLog].  Ce tableau contient la colonne [_ID_] - le numéro de séquence de l'appel de procédure.  Les colonnes suivantes portent les noms des paramètres passés à la procédure et les valeurs passées dans les appels y sont collectées.  Si nécessaire, ils peuvent également être vérifiés. <br><br><div style="text-align:center;"><img width="75%" height="75%" src="https://habrastorage.org/webt/ko/gh/4h/kogh4hgcdsxagldk2bmdcfrptzi.png"></div><br>  La dernière chose que nous devons faire avant d'appeler le sémaphore et de vérifier est de créer une variable dans laquelle nous mettrons l'ID d'enregistrement de la table [ProcStatus] (plus précisément, -1, car l'enregistrement ne sera pas ajouté). <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @ProcStatusId <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span>;</code> </pre> <br>  Appelez le sémaphore: <br><br><pre> <code class="sql hljs">EXEC dbo.[Semaphore_JobStarter]   'SomeProcess',   @ProcStatusId OUTPUT; <span class="hljs-comment"><span class="hljs-comment">--    -1</span></span></code> </pre> <br>  Voilà, nous avons maintenant toutes les données nécessaires pour la vérification.  Commençons par vérifier l'envoi. <br>  lettres: <br><br><pre> <code class="sql hljs">IF NOT EXISTS (   <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> *   <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dbo.SendEmail_SpyProcedureLog) EXEC tSQLt.Fail <span class="hljs-string"><span class="hljs-string">'SendEmail has not been run.'</span></span>;</code> </pre> <br>  Dans ce cas, nous avons décidé de ne pas vérifier les paramètres transmis lors de l'envoi, mais simplement de vérifier le fait lui-même.  J'attire votre attention sur la procédure tSQLt.Fail.  Il vous permet d'échouer "officiellement" le cas de test.  Si vous avez besoin de construire une construction spécifique, tSQLt.Fail vous permettra de le faire. <br><br>  Ensuite, vérifiez l'absence d'entrées dans [dbo]. [ProcStatus]: <br><br><pre> <code class="sql hljs">EXEC tSQLt.AssertEmptyTable 'dbo.ProcStatus';</code> </pre> <br>  C'est là que la FakeTable que nous avons appliquée au tout début nous a aidés.  Grâce à lui, nous pouvons nous attendre au vide.  Sans cela, pour une vérification précise, nous devrions, dans le bon sens, comparer le nombre d'enregistrements avant et après le sémaphore. <br><br>  Equality ProcStatusId = -1, nous pouvons facilement vérifier avec AssertEquals: <br><br><pre> <code class="sql hljs">EXEC tSQLt.AssertEquals   -1,       @ProcStatusId,       'Wrong ProcStatusId.';</code> </pre> <br>  AssertEquals est minimaliste - il compare simplement deux valeurs, rien de surnaturel. <br><br><h3>  Procédures de frères et sœurs AssertEquals </h3><br>  Pour comparer les valeurs, nous disposons de plusieurs procédures: <br><br><ul><li>  AssertEquals </li><li>  AssertNotEquals </li><li>  AssertEqualsString </li><li>  Assertike </li></ul><br>  Je pense que leurs noms parlent d'eux-mêmes.  La seule chose à noter est l'existence d'une procédure AssertEqualsString distincte.  Le fait est que AssertEquals / AssertNotEquals / AssertLike fonctionne avec SQL_VARIANT, et NVARCHAR (MAX) ne s'applique pas à cela, et donc les développeurs tSQLt ont dû allouer une procédure distincte pour tester NVARCHAR (MAX). <br><br><h3>  Fausse fonction </h3><br>  FakeFunction avec un certain étirement peut être appelé une procédure similaire à SpyProcedure.  Ce faux vous permet de remplacer n'importe quelle fonction par la plus simple nécessaire.  Étant donné que les fonctions de SQL Server fonctionnent sur le principe d'un tube avec du dentifrice - elles donnent le résultat par le "seul trou technologique", alors, malheureusement, aucune fonctionnalité de journalisation n'est fournie.  Seulement un remplacement pour la logique. <br><br><h1>  Pièges </h1><br>  Il convient de noter certains pièges que vous pouvez rencontrer en travaillant avec tSQLt.  Dans ce cas, par écueils, j'entends certains problèmes problématiques nés en raison des limitations de SQL Server et / ou qui ne peuvent pas être résolus par les développeurs du framework. <br><br><h3>  Annulation / corruption de transactions </h3><br>  Le premier et le plus important problème auquel notre équipe a été confrontée a été l'annulation de transactions.  SQL Server ne sait pas comment restaurer séparément les transactions imbriquées - uniquement tout dans son ensemble, jusqu'aux plus externes.  Étant donné que tSQLt encapsule chaque cas de test dans une transaction distincte, cela devient un problème.  Après tout, une restauration de transaction à l'intérieur de la procédure de test peut interrompre l'exécution du test, provoquant une erreur d'exécution non descriptive. <br><br>  Pour contourner ce problème, nous utilisons des points de sauvegarde.  L'idée est simple.  Avant de démarrer une transaction dans la procédure de test, nous vérifions si nous sommes déjà à l'intérieur de la transaction.  S'il s'avère que oui, alors nous supposons qu'il s'agit d'une transaction tSQLt, mettez savepoint au lieu de démarrer.  Ensuite, si nécessaire, nous retournerons à ce point de sauvegarde, et non au début de la transaction.  L'imbrication en tant que telle ne l'est pas. <br><br><div style="text-align:center;"><img width="85%" height="85%" src="https://habrastorage.org/webt/zk/0u/jc/zk0ujc2gmggccs7bg7icraan3da.png"></div><br>  Le problème est compliqué par la corruption des transactions.  Si soudainement quelque chose s'est mal passé et que l'exception a fonctionné, alors la transaction peut devenir vouée à l'échec.  Une telle transaction peut non seulement être validée, mais également annulée dans savepoint, mais uniquement annulée. <br><br>  Compte tenu de tout ce qui précède, vous devez appliquer la conception suivante: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @isNestedTransaction <span class="hljs-built_in"><span class="hljs-built_in">BIT</span></span> =   <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> @@trancount &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'true'</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-string"><span class="hljs-string">'false'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> TRY   <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @isNestedTransaction = <span class="hljs-string"><span class="hljs-string">'false'</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">SAVE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span> SavepointName;       <span class="hljs-comment"><span class="hljs-comment">-- something useful   IF @isNestedTransaction = 'false'   COMMIT TRANSACTION; END TRY BEGIN CATCH   DECLARE @isCommitable BIT =       CASE WHEN XACT_STATE() = 1           THEN 'true'           ELSE 'false'   END;   IF @isCommitable = 'true' AND @isNestedTransaction = 'true'       ROLLBACK TRANSACTION SavepointName;   ELSE       ROLLBACK;   THROW; END CATCH;</span></span></code> </pre> <br>  Considérez le code en plusieurs parties.  Nous devons d'abord déterminer si nous sommes à l'intérieur d'une transaction: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @isNestedTransaction <span class="hljs-built_in"><span class="hljs-built_in">BIT</span></span> =   <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> @@trancount &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'true'</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-string"><span class="hljs-string">'false'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>;</code> </pre> <br>  Après avoir reçu l'indicateur @isNestedTransaction, exécutez le bloc TRY et définissez le point de sauvegarde ou le début de la transaction, selon la situation. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> TRY   <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @isNestedTransaction = <span class="hljs-string"><span class="hljs-string">'false'</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">SAVE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span> SavepointName;       <span class="hljs-comment"><span class="hljs-comment">-- something useful</span></span></code> </pre> <br>  Après avoir fait quelque chose d'utile, validez, s'il s'agit d'un «vrai» début de la procédure. <br><br><pre> <code class="sql hljs">       <span class="hljs-comment"><span class="hljs-comment">-- something useful   IF @isNestedTransaction = 'false'   COMMIT TRANSACTION; END TRY</span></span></code> </pre> <br>  Bien sûr, s'il s'agit d'un lancement à partir d'un scénario de test, nous n'avons besoin de rien engager.  À la fin de l'exécution, tSQLt annulera simplement toutes les modifications.  Si soudainement quelque chose s'est mal passé et que nous sommes entrés dans le bloc CATCH, la première chose à faire est de savoir si notre transaction peut même être validée. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> CATCH   <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @isCommitable <span class="hljs-built_in"><span class="hljs-built_in">BIT</span></span> =       <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> XACT_STATE() = <span class="hljs-number"><span class="hljs-number">1</span></span>           <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'true'</span></span>           <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-string"><span class="hljs-string">'false'</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>;</code> </pre> <br>  Nous ne pouvons revenir au point de sauvegarde que si <br><br><ol><li>  transaction commitable </li><li>  un essai a lieu, c.-à-d.  le point de sauvegarde existe. </li></ol><br>  Dans d'autres cas, nous devons annuler la totalité de la transaction. <br><br><pre> <code class="sql hljs">   IF @isCommitable = 'true' AND @isNestedTransaction = 'true'       <span class="hljs-keyword"><span class="hljs-keyword">ROLLBACK</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span> SavepointName;   ELSE       <span class="hljs-keyword"><span class="hljs-keyword">ROLLBACK</span></span>;   THROW; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> CATCH;</code> </pre> <br>  Oui, malheureusement, si lors d'une exécution de test, nous obtenons une transaction non validable, nous obtenons toujours une erreur dans l'exécution du scénario de test. <br><br><h3>  FakeTable et problème avec la clé étrangère </h3><br>  Considérez les tableaux familiers [Trial] et [Clinic]: <br><br><div style="text-align:center;"><img width="85%" height="85%" src="https://habrastorage.org/webt/fy/k7/nm/fyk7nmhfha_fnezignyxclpflay.png"></div><br>  Nous nous souvenons du [TrialID] FK.  Quels problèmes cela peut-il causer?  Dans les exemples donnés précédemment, nous avons appliqué FakeTable aux deux tables à la fois.  Si nous l'appliquons uniquement sur [Trial], nous obtenons la situation suivante: <br><br><div style="text-align:center;"><img width="85%" height="85%" src="https://habrastorage.org/webt/og/to/3-/ogto3-drjheieblpi1_gsyup4hs.png"></div><br>  Une tentative d'insertion d'une entrée dans [Clinic], de cette manière, peut s'avérer être un échec (même si nous avons préparé toutes les données nécessaires dans la fausse version du tableau [Trial]). <br><br><pre> <code class="sql hljs">[dbo].[Test_FK_Problem] failed: (Error) The <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">statement</span></span> conflicted <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constraint</span></span> <span class="hljs-string"><span class="hljs-string">"Trial_Fk"</span></span>. The conflict occurred <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">database</span></span> <span class="hljs-string"><span class="hljs-string">"HabrDemo"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-string"><span class="hljs-string">"dbo.tSQLt_tempobject_ba8f36353f7a44f6a9176a7d1db02493"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">column</span></span> <span class="hljs-string"><span class="hljs-string">'TrialID'</span></span>.[<span class="hljs-number"><span class="hljs-number">16</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>]{Test_FK_Problem,<span class="hljs-number"><span class="hljs-number">14</span></span>}</code> </pre> <br>  Conclusion: vous devez soit tout simuler, soit ne rien simuler.  Dans le second cas, il est évident que la base doit être préparée à l'avance pour les tests. <br><br><h3>  SpyProcedure sur les procédures système </h3><br>  Hélas, l'espionnage des appels aux procédures système échouera. <br><br><pre> <code class="sql hljs">[HabrDemo].[test_test] failed: (Error) Cannot <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> SpyProcedure <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> sys.sp_help because the <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> does <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> exist[<span class="hljs-number"><span class="hljs-number">16</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>] {tSQLt.Private_ValidateProcedureCanBeUsedWithSpyProcedure,<span class="hljs-number"><span class="hljs-number">7</span></span>}</code> </pre> <br>  Dans l'exemple du sémaphore, nous avons suivi les appels à la procédure [SendEmail] écrits par nos développeurs.  Dans ce cas, l'écriture d'une procédure distincte est due à la nécessité de collecter et de traiter certaines informations supplémentaires avant d'envoyer des messages directement.  Dans l'ensemble, il faut être mentalement préparé au fait que l'on peut avoir à écrire des procédures intercouches pour certaines procédures système uniquement à des fins de test. <br><br><h1>  Les avantages </h1><br><h3>  Installation rapide </h3><br>  L'installation se déroule en 2 étapes et dure environ 2 minutes.  Il vous suffit d'activer le CLR sur le serveur, si ce n'est déjà fait, et d'exécuter un seul script.  Tout, vous pouvez ajouter la première classe de test et écrire des cas de test. <br><br><h3>  Développement rapide </h3><br>  tSQLt est un outil facile à apprendre.  Il m'a fallu une petite journée pour le maîtriser.  J'ai demandé à mes collègues qui travaillaient avec le cadre, et il s'est avéré que tout le monde passerait environ une journée. <br><br><h3>  Implémentation rapide dans CI </h3><br>  Il a fallu environ 2 heures pour configurer l'intégration dans CI sur notre projet.  Bien sûr, le temps peut varier, mais en général ce n'est pas un problème et l'intégration peut être effectuée très rapidement. <br><br><h3>  Large gamme d'outils </h3><br>  Il s'agit d'une évaluation subjective, mais, à mon avis, la fonctionnalité fournie par tSQLt est assez riche et couvre la part du lion des besoins dans la pratique.  Dans de rares cas où il n'y a pas assez de contrefaçons et d'assertions intégrées, il y a bien sûr tSQLt.Fail. <br><br><h3>  Documentation pratique </h3><br>  La documentation officielle est pratique et cohérente.  Avec son aide, vous pouvez facilement comprendre l'essence de l'utilisation de tSQLt en peu de temps, même s'il s'agit de votre premier outil de test unitaire. <br><br><h3>  Sortie pratique </h3><br>  Les données peuvent être obtenues sous forme de texte très clair: <br><br><pre> <code class="plaintext hljs">[tSQLtDemo].[test_error_messages] failed: (Failure) Expected an error to be raised. [tSQLtDemo].[test_tables_comparison] failed: (Failure) useful and descriptive error message Unexpected/missing resultset rows! |_m_|Column1|Column2| +---+-------+-------+ |&lt; |2 |Value2 | |= |1 |Value1 | |= |3 |Value3 | |&gt; |2 |Value3 | +----------------------+ |Test Execution Summary| +----------------------+ |No|Test Case Name |Dur(ms)|Result | +--+------------------------------------+-------+-------+ |1 |[tSQLtDemo].[test_constraint] | 83|Success| |2 |[tSQLtDemo].[test_trial_view] | 83|Success| |3 |[tSQLtDemo].[test_error_messages] | 127|Failure| |4 |[tSQLtDemo].[test_tables_comparison]| 147|Failure| ----------------------------------------------------------------------------- Msg 50000, Level 16, State 10, Line 1 Test Case Summary: 4 test case(s) executed, 2 succeeded, 2 failed, 0 errored. -----------------------------------------------------------------------------</code> </pre><br>  Vous pouvez également extraire de la base de données (cliquable) ... <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/webt/-f/83/la/-f83lajcz1mfcnkhtttz45b0x3g.png"></a> </div><br>  ... ou obtenez au format XML. <br><br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testsuites</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testsuite</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tSQLtDemo"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">tests</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"3"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">errors</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">failures</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">timestamp</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2019-06-22T16:46:06"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">time</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0.433"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">hostname</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"BLAHBLAHBLAH\SQL2017"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">package</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tSQLt"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">properties</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testcase</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">classname</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tSQLtDemo"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"test_constraint"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">time</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0.097"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testcase</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">classname</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tSQLtDemo"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"test_error_messages"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">time</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0.153"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">failure</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">message</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Expected an error to be raised."</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tSQLt.Fail"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testcase</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testcase</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">classname</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tSQLtDemo"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"test_trial_view"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">time</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0.156"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system-out</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system-err</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testsuite</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testsuites</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Cette dernière option vous permet d'intégrer facilement des tests dans CI.  En particulier, tout fonctionne pour nous sous Atlassian Bamboo. <br><br><h3>  Prise en charge de Redgate </h3><br>  Les avantages incluent la prise en charge d'un si grand fournisseur d'outils DBA comme RedGate.  SQL Test - leur plugin pour SQL Server Management Studio - fonctionne avec tSQLt dès la sortie de la boîte.  En outre, RedGate fournit une assistance au développeur principal tSQLt avec l'environnement de développement, comme le prétend le développeur lui-même des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">groupes Google</a> . <br><br><h1>  Inconvénients </h1><br><h3>  Aucun faux table temporaire </h3><br>  tSQLt n'autorise pas les fausses tables temporaires.  Si nécessaire, vous pouvez utiliser le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">module complémentaire non officiel</a> .  Malheureusement, ce module complémentaire n'est pris en charge que par SQL Server 2016+. <br><br><h3>  Pas d'accès aux bases de données externes </h3><br>  Il ne fonctionnera pas de conserver une base séparée uniquement pour stocker le cadre.  tSQLt est conçu pour tester ce qui se trouve dans la même base de données.  Le faux, hélas, ne fonctionnera pas. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> [tSQLtDemo].[test_outer_db] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP <span class="hljs-number"><span class="hljs-number">10</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [AdventureWorks2017].[Person].[<span class="hljs-keyword"><span class="hljs-keyword">Password</span></span>]   EXEC tSQLt.FakeTable <span class="hljs-string"><span class="hljs-string">'[AdventureWorks2017].[Person].[Password]'</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP <span class="hljs-number"><span class="hljs-number">10</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [AdventureWorks2017].[Person].[<span class="hljs-keyword"><span class="hljs-keyword">Password</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">END</span></span></code> </pre><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ga/au/ny/gaaunygdr124sssxhonbb2s0b_0.png"></div><br>  Les assertions semblent fonctionner, mais personne ne garantit leur performance, bien sûr. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> [tSQLtDemo].[test_outer_db_assertions] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP <span class="hljs-number"><span class="hljs-number">1</span></span> *   <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-comment"><span class="hljs-comment">#Actual   FROM [AdventureWorks2017].[Person].[Password]   SELECT *   INTO #Expected   FROM (          SELECT 'bE3XiWw=' AS [PasswordSalt]   ) expectedresult;   EXEC tSQLt.AssertEqualsTable '#Expected', '#Actual', 'The salt is not salty'; END</span></span></code> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/cg/dk/ow/cgdkowych69imevqmbirkkgsniq.png"></div><br><h3>  Bogues de documentation </h3><br>  Malgré le fait que j'ai écrit ci-dessus sur la cohérence et l'accessibilité de la documentation, elle contient également des problèmes.  Il y a des moments dépassés. <br><br>  Exemple 1. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">«Guide de démarrage rapide»</a> suggère de télécharger le framework depuis SourceForge.  Ils ont dit au revoir à SourceForge <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">en 2015</a> . <br><br>  Exemple 2. Le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">guide ApplyConstraint</a> de l'exemple utilise une procédure Fail pour intercepter une exception, qui serait plus facile et plus visuelle à remplacer par ExpectException. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> ConstraintTests.[<span class="hljs-keyword"><span class="hljs-keyword">test</span></span> ReferencingTable_ReferencedTable_FK prevents <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> orphaned <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> EXEC tSQLt.FakeTable <span class="hljs-string"><span class="hljs-string">'dbo.ReferencedTable'</span></span>; EXEC tSQLt.FakeTable 'dbo.ReferencingTable'; EXEC tSQLt.ApplyConstraint 'dbo.ReferencingTable','ReferencingTable_ReferencedTable_FK'; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @ErrorMessage <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @ErrorMessage = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* []     ExceptException ? */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> TRY <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> dbo.ReferencingTable ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, ReferencedTableId ) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> ( <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">11</span></span> ) ; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> TRY <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> CATCH <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @ErrorMessage = ERROR_MESSAGE(); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> CATCH <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @ErrorMessage <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> <span class="hljs-string"><span class="hljs-string">'%ReferencingTable_ReferencedTable_FK%'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> EXEC tSQLt.Fail <span class="hljs-string"><span class="hljs-string">'Expected error message containing ''ReferencingTable_ReferencedTable_FK'' but got: '''</span></span>,@ErrorMessage,<span class="hljs-string"><span class="hljs-string">'''!'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre><br>  Et c'est naturel, car ça se passe ... <br><br><h3>  Abandon partiel </h3><br>  Il y a une longue interruption dans le développement de tSQLt de début 2016 à juin 2019. Oui, malheureusement, cet outil est partiellement abandonné.  En 2019, peu à peu, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">à en juger par GitHub</a> , le développement a encore progressé.  Bien que les groupes Google officiels <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">aient un fil</a> dans lequel Sebastian, le principal développeur de tSQLt, a été directement interrogé sur le sort du développement.  La dernière question a été posée le 2 mars 2019, la réponse n'a pas encore été reçue. <br><br><h3>  Problème avec SQL Server 2017 </h3><br>  Si vous utilisez SQL Server 2017, alors pour vous, l'installation de tSQLt nécessitera éventuellement une manipulation supplémentaire.    ,    2012   SQL Server  security-.       «CLR strict security»,      ( SAFE).       (,  ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>     ).      . <br><br>   , ,     « »,       tSQLt,        ,    . <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> GitHub   issue</a> , ,       2017 (.  ). <br><br><h1>  (±)    </h1><br>        . tSQLt      . ,    (CLR,   T-SQL     SQL ),        ,       . ,     tSQLt  ,       SQL-powered   . <br><br> ,  PostgreSQL       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ptTAP</a> .      «» PL/pgSQL      TAP.  MySQL  ,       — <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">MyTAP</a> .       Oracle,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">utPLSQL</a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Un outil très puissant et activement (je dirais même plus que) un outil de développement.</font></font><br><br><h1>  Conclusion </h1><br> ,         . <br><br>  —     .     SQL Server, Oracle  MySQL — .          ,       .       ,       ,    ,  , ,  . <br><br>   —   .  ,     ,   SQL Server,  tSQLt    100% ,    ,      .        ,     ,   . <br><br><div class="spoiler"> <b class="spoiler_title">,    ( )</b> <div class="spoiler_text"> DbFit — Automated Open Source Database Testing: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">http://www.methodsandtools.com/tools/dbfit.php</a> <br><br> DbFit Documentation: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://dbfit.github.io/dbfit/docs/</a> <br><br> Slacker wiki: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/vassilvk/slacker/wiki</a> <br><br> TST documentation: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://archive.codeplex.com/projects/TST/4e04e281-9f35-4891-809a-15f09d304f4e</a> <br><br> NUnit Assertions: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/nunit/docs/wiki/Assertions</a> <br><br> utTSQL code: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://sourceforge.net/p/uttsql/code/HEAD/tree/</a> <br><br> Junit Class Assert: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://junit.org/junit4/javadoc/latest/org/junit/Assert.html</a> <br><br> pgTap: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://pgtap.org/</a> <br><br> utPLSQL: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">http://utplsql.org/</a> <br><br> MyTap: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/hepabolu/mytap</a> <br><br> tSQLt Google groups: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://groups.google.com/forum/#!forum/tsqlt</a> <br><br> tSQLt official website: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://tsqlt.org/</a> <br><br> tSQLt GitHub: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/tSQLt-org/tSQLt</a> <br><br> Google trends: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://bit.ly/2x7BQL6</a> <br><br> How to ROLLBACK a transaction when testing using tSQLt: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://stackoverflow.com/questions/8973138/how-to-rollback-a-transaction-when-testing-using-tsqlt</a> <br><br> What are the Pros and Cons of Manual Unit Testing against the Automated Unit Testing?: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://stackoverflow.com/questions/2948337/what-are-the-pros-and-cons-of-manual-unit-testing-against-the-automated-unit-tes#2948354</a> <br><br> The Good, the Bad, and the Ugle̅e̅: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://sqlquantumleap.com/2017/08/07/sqlclr-vs-sql-server-2017-part-1-clr-strict-security/</a> <br><br> Rex Black, Erik Van Veenendal, Dorothy Graham, Foundations of Software Testing, Third edition, 2012 Cengage Learning EMEA <br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr461133/">https://habr.com/ru/post/fr461133/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr461121/index.html">Petites expériences multitâches dans un microcontrôleur</a></li>
<li><a href="../fr461125/index.html">La tâche de création de codes numériques séquentiels pour la numérotation des messages dans le code source dans Visual Studio (ex. C #)</a></li>
<li><a href="../fr461127/index.html">Analyse des performances des machines virtuelles dans VMware vSphere. Partie 3: Stockage</a></li>
<li><a href="../fr461129/index.html">À propos de Kote, de sa femme, de ses deux fils, de l'idée ... et pas seulement. Histoire avec suite</a></li>
<li><a href="../fr461131/index.html">Chariot à chariots ROS, partie 2. Logiciel</a></li>
<li><a href="../fr461137/index.html">Comment nous avons développé un appareil pour surveiller l'attention des conducteurs. Découvrez Yandex.Taxi</a></li>
<li><a href="../fr461141/index.html">Mon premier jour avec Haiku: elle est étonnamment bonne</a></li>
<li><a href="../fr461143/index.html">Sur les problèmes actuels de conception de jeux et les moyens de les résoudre. Vue de dessous</a></li>
<li><a href="../fr461145/index.html">Que doit diriger une équipe: rôles, responsabilités et compétences</a></li>
<li><a href="../fr461147/index.html">Comment économiser 64 heures en combinant des clés dans PowerPoint</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>