<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚úçüèæ üßëüèæ ‚ôÄÔ∏è Test du code SQL Server avec tSQLt üöã üë©üèª‚Äçü§ù‚Äçüë®üèº üå±</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="FYI: Cet article est une version d√©velopp√©e de mon rapport sur SQA Days # 25. 

 Sur la base de mon exp√©rience de communication avec des coll√®gues, je...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Test du code SQL Server avec tSQLt</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/arcadia/blog/461133/">  <i>FYI: Cet article est une version d√©velopp√©e de mon <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">rapport</a> sur SQA Days # 25.</i> <br><br>  Sur la base de mon exp√©rience de communication avec des coll√®gues, je peux dire que tester du code dans une base de donn√©es n'est pas une pratique courante.  Cela peut √™tre un danger potentiel.  La logique de la base de donn√©es est √©crite par les m√™mes personnes qui √©crivent le code "normal".  Par cons√©quent, des erreurs peuvent √©galement y √™tre pr√©sentes, et elles peuvent √©galement entra√Æner des cons√©quences n√©gatives pour le produit, l'entreprise et les consommateurs.  Peu importe qu'il s'agisse de proc√©dures stock√©es qui aident le backend ou d'ETL qui convertissent des donn√©es en stockage - il y a un risque et les tests peuvent le r√©duire consid√©rablement.  Je veux vous dire ce qu'est tSQLt et comment il nous aide √† tester le code dans SQL Server. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/2e/-h/nx/2e-hnxb3bddbq3ck_8vi4jwah8i.jpeg"></div><br><a name="habracut"></a><br><h1>  Contexte </h1><br>  Il existe un grand entrep√¥t sur SQL Server contenant diverses donn√©es de recherche clinique.  Il est rempli √† partir de diverses sources (principalement des bases de donn√©es documentaires).  √Ä l'int√©rieur du serveur lui-m√™me, les donn√©es sont converties √† plusieurs reprises √† l'aide d'ETL.  √Ä l'avenir, ces donn√©es peuvent √™tre t√©l√©charg√©es dans des bases de donn√©es plus petites pour √™tre utilis√©es par des applications Web qui r√©solvent certains petits probl√®mes sp√©cifiques.  Certains clients du client demandent √©galement une API pour leurs besoins internes.  Dans la mise en ≈ìuvre de ces API, les proc√©dures stock√©es et les requ√™tes sont souvent utilis√©es. <br><br><div style="text-align:center;"><img width="75%" height="75%" src="https://habrastorage.org/webt/iw/vu/rz/iwvurz8sbflhuz3mkj39ipf9rag.png"></div><br>  En g√©n√©ral, le code est du c√¥t√© du SGBD dans l'ordre. <br><br><h1>  Pourquoi tout cela est n√©cessaire </h1><br>  Comme d√©j√† compris depuis l'introduction, le code dans la base de donn√©es est le m√™me code <br>  comme les autres, et il peut √©galement y avoir des erreurs. <br><br>  Je pense que beaucoup de gens sont conscients de la d√©pendance du prix du bug au moment de sa d√©couverte, dont la d√©couverte est g√©n√©ralement attribu√©e √† Barry Bohem.  Une erreur commise √† un stade pr√©coce et d√©tect√©e √† un stade ult√©rieur peut √™tre plus co√ªteuse en raison de la n√©cessit√© de passer par plusieurs √©tapes (codage, unit√©, int√©gration, test du syst√®me, etc.) √† la fois pour localiser l'erreur et ramener le code corrig√© dans l'√©tape √† laquelle le probl√®me a √©t√© identifi√©.  Cet effet est √©galement pertinent pour le cas d'entrep√¥t.  Si une erreur s'est gliss√©e dans certains ETL et que les donn√©es subissent plusieurs transformations, alors si une erreur est d√©tect√©e dans les donn√©es, vous aurez: <br><br><ol><li>  Suivez toutes les √©tapes de conversion pour localiser le probl√®me. </li><li>  R√©solvez le probl√®me. </li><li>  R√©cup√©rez les donn√©es corrig√©es (les corrections manuelles ne sont pas exclues). </li><li>  V√©rifiez que les donn√©es incorrectes provoqu√©es par l'erreur n'apparaissent pas ailleurs. </li></ol><br>  N'oubliez pas que nous ne vendons pas de peluches.  Une erreur dans un domaine comme la recherche clinique peut nuire non seulement aux entreprises, mais aussi √† la sant√© des personnes. <br><br><h1>  Comment tester? </h1><br>  Puisque nous parlons de tests de code, nous entendons les tests unitaires et d'int√©gration.  Ces choses sont tr√®s r√©p√©titives et impliquent une r√©gression constante.  √Ä strictement parler, personne ne proc√®de √† de tels tests manuellement (enfin, peut-√™tre √† l'exception de certains cas compl√®tement d√©g√©n√©r√©s). <br><br>  Un bon bonus: les tests peuvent √™tre un mat√©riau auxiliaire lors de la documentation du code.  Soit dit en passant, les exigences des clients peuvent ressembler √† ceci (cliquable): <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/webt/fh/af/xb/fhafxb5yph-tgvy2zhka9jfcvmk.png"></a> </div><br>  Excel, deux colonnes avec exigences + informations de support dispers√©es dans d'autres colonnes + balisage flou, ce qui est plus d√©routant qu'utile.  Si n√©cessaire, restaurer les souhaits d'origine peut √™tre difficile.  Les tests peuvent aider √† saisir plus pr√©cis√©ment les nuances de l'impl√©mentation (bien s√ªr, vous ne devez pas les consid√©rer comme l'√©quivalent de la documentation). <br><br>  Malheureusement, avec la complexit√© du code, la complexit√© des tests augmente et cet effet peut √™tre nivel√©. <br><br>  Les tests peuvent servir de couche de s√©curit√© suppl√©mentaire contre les morses spontan√©s.  Les auto-tests en CI en raison du formalisme aident √† faire face √† ce probl√®me. <br><br>  Si notre choix s'est port√© sur la voie de l'automatisation, alors nous devons d√©cider des outils pour sa mise en ≈ìuvre. <br><br><h1>  Comment tester? </h1><br>  Dans le cas du test du code dans la base de donn√©es, je distingue deux approches: propuls√©e par SQL, c'est-√†-dire fonctionnant directement dans le SGBD et non propuls√©e par SQL.  J'ai pu mettre en √©vidence les nuances suivantes: <br><div class="scrollable-table"><table><tbody><tr><th>  Aliment√© par SQL <br></th><th>  Non aliment√© par SQL <br></th></tr><tr><td>  N√©cessite l'installation d'objets dans la base de donn√©es <br></td><td>  L'installation d'outils externes suppl√©mentaires dans la base de donn√©es est requise <br></td></tr><tr><td>  Les tests sont toujours ind√©pendants des technologies utilis√©es dans l'application en dehors de la base de donn√©es <br></td><td>  Les tests peuvent d√©pendre des technologies utilis√©es en dehors de la base de donn√©es. <br></td></tr><tr><td>  Le cadre est toujours li√© √† un SGBD sp√©cifique </td><td>  Le cadre prend souvent en charge plusieurs SGBD. </td></tr><tr><td>  Pour √©crire des tests, seule la connaissance du SGBD est requise;  pour le d√©veloppement, vous pouvez utiliser des testeurs manuels ou DBA </td><td>  L'√©criture de tests n√©cessite g√©n√©ralement une connaissance suppl√©mentaire de tout langage et / ou technologie de programmation;  ont souvent besoin de l'aide de programmeurs <br></td></tr><tr><td>  L'ex√©cution au niveau du SGBD permet l'utilisation de contrefa√ßons et d'assertions plus avanc√©es <br></td><td>  L'ex√©cution externe peut limiter les capacit√©s de l'outil <br></td></tr></tbody></table></div>  Dans SQL Server, nous avons le choix: <br><div class="scrollable-table"><table><tbody><tr><th colspan="6" align="center">  Informations g√©n√©rales </th></tr><tr><th>  Le titre </th><th>  L'approche </th><th>  L'architecture </th><th>  √âcrit le </th><th>  Tests pour </th></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tSQLt</a> </td><td>  Aliment√© par SQL </td><td>  xUnit </td><td>  T-SQL + CLR </td><td>  T-sql </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">TSQLUnit</a> </td><td>  Aliment√© par SQL </td><td>  xUnit </td><td>  T-sql </td><td>  T-sql </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">utTSQL</a> </td><td>  Aliment√© par SQL </td><td>  xUnit </td><td>  T-sql </td><td>  T-sql </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Tst</a> </td><td>  Aliment√© par SQL </td><td>  xUnit </td><td>  T-sql </td><td>  T-sql </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Dbfit</a> </td><td>  Non aliment√© par SQL </td><td>  Fitnessess </td><td>  C # / java </td><td>  D√©marque wiki </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Slacker</a> </td><td>  Non aliment√© par SQL </td><td>  RSpec (orient√© BDD) </td><td>  Rubis </td><td>  Rubis </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">NUnit</a> , etc. </td><td>  Non aliment√© par SQL </td><td>  xUnit </td><td>  N / a </td><td>  N / a </td></tr></tbody></table></div><div class="scrollable-table"><table><tbody><tr><th colspan="4" align="center">  Les dates </th></tr><tr><th>  Le titre </th><th>  Premi√®re apparition </th><th>  Dernier commit </th><th>  Derni√®re version </th></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tSQLt</a> </td><td>  2007-07-27 </td><td>  07/07/2019 </td><td>  31/01/2016 </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">TSQLUnit</a> </td><td>  16/12/2006 (0,9) <br>  2007-07-21 (0,91 rc1) </td><td>  26/04/2018 (GitHub) </td><td>  04/09/2011 (SourceForge) </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">utTSQL</a> </td><td>  2003-03-12 </td><td>  2003-03-12 </td><td>  2003-03-12 </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Tst</a> </td><td>  02-03-2009 (v1.0) </td><td>  N / a </td><td>  30-03-2012 </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Dbfit</a> </td><td>  12-01-2009 </td><td>  10-09-2018 </td><td>  15/08/2015 </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Slacker</a> </td><td>  23/06/2011 </td><td>  12-12-2018 </td><td>  12-12-2018 </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">NUnit</a> , etc. </td><td>  N / a </td><td>  N / a </td><td>  N / a </td></tr></tbody></table></div><div class="scrollable-table"><table><tbody><tr><th colspan="7" align="center">  Les possibilit√©s </th></tr><tr><th>  Le titre </th><th>  CLR non requis </th><th>  Sortie XML </th><th>  Des tests envelopp√©s dans une transaction </th><th>  Faux </th><th>  Gestionnaires d'erreurs </th><th>  Assertions </th></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tSQLt</a> </td><td>  - </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  Super </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">TSQLUnit</a> </td><td>  + </td><td>  - </td><td>  + </td><td>  - </td><td>  - </td><td>  Tr√®s mauvais </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">utTSQL</a> </td><td>  + </td><td>  - </td><td>  - </td><td>  - </td><td>  - </td><td>  Mauvais </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Tst</a> </td><td>  + </td><td>  + </td><td>  + (opt.) </td><td>  - </td><td>  + </td><td>  Super </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Dbfit</a> </td><td>  + </td><td>  - </td><td>  + (opt.) </td><td>  - </td><td>  + </td><td>  Bon;  il y a des nuances </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Slacker</a> </td><td>  + </td><td>  - </td><td>  + (opt.) </td><td>  - </td><td>  - </td><td>  Bon;  il y a des nuances </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">NUnit</a> , etc. </td><td>  + </td><td>  + </td><td>  N / a </td><td>  N / a </td><td>  N / a </td><td>  Super  il y a des nuances </td></tr></tbody></table></div><div class="scrollable-table"><table><tbody><tr><th colspan="3" align="center">  Autre </th></tr><tr><th>  Le titre </th><th>  La documentation </th><th>  Communaut√© </th></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tSQLt</a> </td><td>  Super  il y a des nuances </td><td>  Super </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">TSQLUnit</a> </td><td>  Mauvais </td><td>  Mauvais </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">utTSQL</a> </td><td>  Super </td><td>  Mauvais </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Tst</a> </td><td>  Super </td><td>  Mauvais </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Dbfit</a> </td><td>  Super </td><td>  Ok </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Slacker</a> </td><td>  Super </td><td>  Ok </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">NUnit</a> , etc. </td><td>  Super </td><td>  Super </td></tr></tbody></table></div>  Les √©valuations de ¬´bon-mauvais¬ª sont subjectives, d√©sol√©, sans cela, nulle part. <br><br>  Explication: La ¬´premi√®re apparition¬ª est la date la plus ancienne du chemin de vie du framework que j'ai r√©ussi √† trouver, c'est-√†-dire la premi√®re version ou commit. <br><br>  Vous remarquerez peut-√™tre que les alternatives bas√©es sur SQL ont √©t√© abandonn√©es depuis un certain temps, et tSQLt est la seule option prise en charge.  Fonctionnellement, tSQLt gagne √©galement.  La seule chose est qu'en termes d'assertions, TST propose un choix l√©g√®rement plus riche que tSQLt, qui, cependant, est peu susceptible de l'emporter sur ses inconv√©nients. <br><br>  Il y a des nuances dans la documentation tSQLt, mais j'en parlerai plus tard. <br><br>  Dans le monde non propuls√© par SQL, les choses ne sont pas aussi simples.  Des alternatives, bien que non super actives, sont en cours de d√©veloppement.  DbFit est un outil int√©ressant bas√© sur le framework FitNesse.  Il propose des tests d'√©criture sur le balisage wiki.  Slacker est √©galement une chose curieuse - l'approche BDD lors de l'√©criture de tests pour la base de donn√©es. <br><br>  Je vais discuter des assertions non propuls√©es par SQL.  Ext√©rieurement, il y en a moins, et on pourrait dire qu'ils sont pires √† cause de cela.  Mais ici, il vaut la peine de consid√©rer qu'ils sont fondamentalement diff√©rents de tSQLt.  Tout n'est pas si simple. <br><br>  La derni√®re ligne est ¬´NUnit, etc.¬ª  - c'est plut√¥t un rappel.  De nombreux cadres de tests unitaires familiers dans le travail quotidien peuvent √™tre utilis√©s sur des bases de donn√©es auxiliaires √† l'aide de biblioth√®ques auxiliaires.  Le tableau a beaucoup de N / A, car cette ligne, en fait, comprend de nombreux outils.  Les ¬´nuances¬ª dans la colonne d'assertion viennent du m√™me point - dans diff√©rents outils, leur ensemble peut varier et la question de l'applicabilit√© √† la base de donn√©es est ouverte. <br><br>  Comme autre mesure int√©ressante, nous pouvons consid√©rer <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">les tendances de Google</a> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ud/2u/km/ud2ukmcoyjvstvhcu2taegpib34.png"></div><br>  Nuances: <br><br><ol><li>  Je n'ai pas inclus Slacker, car ce nom peut signifier beaucoup de choses (et les demandes comme ¬´Slacker framework¬ª ne sont pas particuli√®rement visibles sur les graphiques). </li><li>  Par curiosit√©, la tendance TST a √©t√© ajout√©e, mais elle ne refl√®te pas non plus beaucoup la situation, car il s'agit d'une abr√©viation qui signifie beaucoup de choses diff√©rentes. </li><li>  Je n'ai pas inclus NUnit et ses analogues, car il s'agissait √† l'origine de frameworks pour tester le code des applications elles-m√™mes, et leurs tendances ne sont pas repr√©sentatives de notre contexte. </li></ol><br>  En g√©n√©ral, nous pouvons dire que tSQLt se pr√©sente favorablement dans le contexte des analogues. <br><br><h1>  Qu'est-ce que tSQLt? </h1><br>  tSQLt, comme vous pouvez le deviner, est un framework de tests unitaires bas√© sur SQL. <br><br>  ‚Üí <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Site officiel</a> <br><br>  La prise en charge de SQL Server est annonc√©e depuis 2005 SP2.  Je n'ai jamais pu regarder aussi loin dans le pass√©, mais nous avons 2012 sur le serveur de d√©veloppement, j'ai localement 2017 - il n'y a eu aucun probl√®me. <br><br>  Open source, une licence Apache 2.0, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">est disponible sur GitHub</a> .  Vous pouvez bifurquer, passer en contrebande, utiliser gratuitement dans des projets commerciaux et, surtout, ne pas avoir peur des signets dans le CLR. <br><br><h1>  M√©canique du travail </h1><br><div style="text-align:center;"><img width="85%" height="85%" src="https://habrastorage.org/webt/1v/kx/wi/1vkxwixwjyna756vsce7uhwqzw0.png"></div><br>  Les cas de test sont des proc√©dures stock√©es.  Ils sont combin√©s en classes de test (suite de tests en termes de xUnit). <br><br>  Les classes de test ne sont rien de plus que des sch√©mas de base de donn√©es r√©guliers.  Ils diff√®rent des autres r√©gimes par leur inscription dans les tableaux-cadres.  Vous pouvez effectuer un tel enregistrement en appelant une proc√©dure - tSQLt.NewTestClass. <br><br>  √Ä l'int√©rieur de la classe de test, il est √©galement possible de d√©finir une proc√©dure SetUp qui sera ex√©cut√©e avant l'ex√©cution de chaque sc√©nario de test individuel. <br><br>  Une proc√©dure de d√©montage pour restaurer le syst√®me √† la fin du sc√©nario de test n'est pas n√©cessaire.  Chaque sc√©nario de test ainsi que la proc√©dure de configuration sont ex√©cut√©s dans une transaction distincte, qui est annul√©e apr√®s la collecte des r√©sultats.  C'est tr√®s pratique, mais cela a des effets n√©gatifs, dont je parlerai ci-dessous. <br><br>  Le cadre vous permet d'ex√©cuter des cas de test individuels, des classes de test enti√®res ou toutes les classes de test enregistr√©es √† la fois. <br><br><h1>  Caract√©ristiques par exemple </h1><br>  N'ayant pas envie de raconter un guide officiel d√©j√† simple, je vais parler des possibilit√©s du framework √† l'aide d'exemples. <br><br>  <i>Avertissement:</i> <br><br><ul><li>  <i>les exemples sont simplifi√©s;</i> </li><li>  <i>dans l'original, tout le code de test n'a pas √©t√© √©crit par moi, ce sont plut√¥t les fruits de la cr√©ativit√© collective;</i> </li><li>  <i>L'exemple 2 a √©t√© invent√© afin de d√©montrer plus compl√®tement les capacit√©s de tSQLt.</i> </li></ul><br><h3>  Exemple 1: CsvSql </h3><br>  √Ä la demande de l'un des clients du client, les √©l√©ments suivants ont √©t√© mis en ≈ìuvre.  La base de donn√©es dans les champs Nvarchar (MAX) stocke les requ√™tes SQL.  Pour afficher ces requ√™tes, une interface minimale est boulonn√©e.  Les jeux de r√©sultats renvoy√©s par ces requ√™tes sont utilis√©s par le backend pour g√©n√©rer le fichier CSV √† renvoyer via l'appel API. <br><br><div style="text-align:center;"><img width="75%" height="75%" src="https://habrastorage.org/webt/5q/mu/oy/5qmuoyyjjvlphk79jt-xtawwjn8.png"></div><br>  Les jeux de r√©sultats sont assez lourds et contiennent de nombreuses colonnes.  Un exemple conditionnel d'un tel ensemble de r√©sultats: <br><br><div style="text-align:center;"><img width="75%" height="75%" src="https://habrastorage.org/webt/dg/50/bb/dg50bbx25qaw6ycwpfqcsfj5kyk.png"></div><br>  Cet ensemble de r√©sultats comprend des donn√©es d'essais cliniques.  Examinons de plus pr√®s comment ClinicsNum est consid√©r√© - le nombre de cliniques impliqu√©es dans l'√©tude.  Nous avons deux tableaux: [Trial] et [Clinic]: <br><br><div style="text-align:center;"><img width="85%" height="85%" src="https://habrastorage.org/webt/qo/mu/n-/qomun-gdbdl05teniypbtzi8jio.png"></div><br>  Il y a FK: [Clinic]. [TrialID] -&gt; [Trial]. [TrialID].  √âvidemment, pour calculer le nombre de cliniques, nous avons juste besoin du COUNT habituel (*). <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(*), ...  <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dbo.Trial  <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> dbo.Clinic    <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> Trial.ID = Clinic.TrialID  <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> Trial.Name = @trialName  <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> ...</code> </pre> <br>  Comment testons-nous une telle demande?  Pour commencer, nous pouvons utiliser le talon pratique - FakeTable, qui simplifiera consid√©rablement le travail ult√©rieur. <br><br><pre> <code class="sql hljs">EXEC tSQLt.FakeTable 'dbo.Trial'; EXEC tSQLt.FakeTable 'dbo.Clinic';</code> </pre> <br>  FakeTable fait une chose simple: renommer les anciennes tables et en cr√©er de nouvelles √† leur place.  Les m√™mes noms, les m√™mes colonnes, mais sans contrainte'ov et trigger'ov. <br><br>  Pourquoi avons-nous besoin de cela: <br><br><ol><li>  Certaines donn√©es de la base de donn√©es de test peuvent interf√©rer avec les tests.  Gr√¢ce √† FakeTable, nous ne d√©pendons pas d'eux. </li><li>  Pour le test, en r√®gle g√©n√©rale, vous ne devez remplir que quelques colonnes.  Il peut y en avoir beaucoup dans le tableau, et certains d'entre eux auront des contraintes.  De cette fa√ßon, nous simplifions la poursuite de l'installation des donn√©es de test - nous n'ins√©rerons que celles qui sont vraiment n√©cessaires pour le sc√©nario de test. </li><li>  Nous n'affecterons certainement aucun d√©clencheur lors de l'insertion de donn√©es de test et nous n'avons pas √† nous soucier des post-effets ind√©sirables. </li></ol><br>  Ensuite, ins√©rez les donn√©es de test dont nous avons besoin: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> dbo.Trial ([<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>], [<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>,   <span class="hljs-string"><span class="hljs-string">'Valerian'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> dbo.Clinic ([<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>], [TrialID], [<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>,   <span class="hljs-number"><span class="hljs-number">1</span></span>,        <span class="hljs-string"><span class="hljs-string">'Clinic1'</span></span>), (<span class="hljs-number"><span class="hljs-number">2</span></span>,   <span class="hljs-number"><span class="hljs-number">1</span></span>,        <span class="hljs-string"><span class="hljs-string">'Clinic2'</span></span>);</code> </pre> <br>  Nous obtenons notre requ√™te de la base de donn√©es, cr√©ons la table r√©elle et la remplissons avec le jeu de r√©sultats de notre requ√™te: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @sqlStatement <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) = (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span>‚Ä¶ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> actual ([TrialID], ...); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> actual EXEC sp_executesql @sqlStatement, ...</code> </pre> <br>  Remplir attendu - valeurs attendues: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> expected (   ClinicsNum <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> expected <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre> <br>  Je veux attirer votre attention sur le fait que dans le tableau Expected, nous n'avons qu'une seule colonne, alors que dans Actual, nous en avons un ensemble complet. <br><br><div style="text-align:center;"><img width="80%" height="80%" src="https://habrastorage.org/webt/qd/gx/ga/qdgxgaqr4cjp2eayoz0eycjs8cg.png"></div><br>  Cela est d√ª √† la fonctionnalit√© de la proc√©dure AssertEqualsTable, que nous utiliserons pour v√©rifier les valeurs. <br><br><pre> <code class="sql hljs">EXEC tSQLt.AssertEqualsTable   'expected',   'actual',   'incorrect number of clinics';</code> </pre> <br>  Il compare uniquement les colonnes pr√©sentes dans les deux tables compar√©es.  C'est tr√®s pratique dans notre cas, car la requ√™te de test renvoie un grand nombre de colonnes, chacune ayant sa propre logique, parfois tr√®s d√©routante.  Nous ne voulons pas gonfler les cas de test, donc cette fonctionnalit√© nous est tr√®s utile.  Bien s√ªr, c'est une √©p√©e √† double tranchant.  Si dans R√©el, un ensemble de colonnes est rempli automatiquement via SELECT TOP 0 et √† un moment donn√©, une colonne suppl√©mentaire appara√Æt soudainement, alors un tel cas de test ne rattrapera pas ce moment.  Pour g√©rer de telles situations, vous devez effectuer des v√©rifications suppl√©mentaires. <br><br><h3>  Proc√©dures soeurs AssertEqualsTable </h3><br>  Il convient de mentionner que tSQLt contient deux proc√©dures similaires √† AssertEqualsTable.  Ce sont AssertEqualsTableSchema et AssertResultSetsHaveSameMetaData.  Le premier fait la m√™me chose que AssertEqualsTable, mais sur les m√©tadonn√©es de la table.  La seconde fait une comparaison similaire, mais sur les m√©tadonn√©es des jeux de r√©sultats. <br><br><h3>  Exemple 2: contraintes </h3><br>  Dans l'exemple pr√©c√©dent, nous avons vu comment vous pouvez supprimer la contrainte.  Mais que faire si nous devons les v√©rifier?  Techniquement, cela fait √©galement partie de la logique et peut √©galement √™tre consid√©r√© comme un candidat pour la couverture des tests. <br><br>  Consid√©rez la situation de l'exemple pr√©c√©dent.  Deux tables - [Trial] et [Clinic];  [TrialID] FK: <br><br><div style="text-align:center;"><img width="80%" height="80%" src="https://habrastorage.org/webt/-8/zu/v3/-8zuv3clqoo3ygm9wko5hpibc90.png"></div><br>  Essayons d'√©crire un cas de test pour tester cette contrainte.  Au d√©but, comme la derni√®re fois, nous simulons des tables. <br><br><pre> <code class="sql hljs">EXEC tSQLt.FakeTable '[dbo].[Trial]' EXEC tSQLt.FakeTable '[dbo].[Clinic]'</code> </pre> <br>  L'objectif est le m√™me: se d√©barrasser des restrictions inutiles.  Nous voulons des ch√®ques isol√©s sans gestes inutiles. <br><br>  Ensuite, nous renvoyons la contrainte dont nous avons besoin √† l'endroit √† l'aide de la proc√©dure ApplyConstraint: <br><br><pre> <code class="sql hljs">EXEC tSQLt.ApplyConstraint   '[dbo].[Clinic]',   'Trial_FK';</code> </pre> <br>  Ici, nous avons mis en place une configuration pratique pour la v√©rification directe.  Le contr√¥le lui-m√™me consistera en ce qu'une tentative d'insertion de donn√©es entra√Ænera in√©vitablement une exception.  Pour que le sc√©nario de test fonctionne correctement, nous devons intercepter cette exception.  Le gestionnaire d'exceptions ExpectException nous y aidera. <br><br><pre> <code class="sql hljs">EXEC tSQLt.ExpectException   @ExpectedMessage = 'The <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">statement</span></span> conflicted...<span class="hljs-string"><span class="hljs-string">',   @ExpectedSeverity = 16,   @ExpectedState = 0;</span></span></code> </pre> <br>  Apr√®s avoir install√© le gestionnaire, vous pouvez essayer d'ins√©rer le non ins√©rable. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> [dbo].[Clinic] ([TrialID])   <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre> <br>  Exception intercept√©e.  Test r√©ussi. <br><br><h3>  Proc√©dures soeurs ApplyConstraint </h3><br>  Les d√©veloppeurs TSQLt nous proposent une approche similaire pour tester les d√©clencheurs.  Vous pouvez utiliser la proc√©dure ApplyTrigger pour renvoyer un d√©clencheur √† la fausse table.  De plus, tout est comme dans l'exemple ci-dessus - nous d√©clenchons le d√©clencheur, v√©rifions le r√©sultat. <br><br><h3>  ExpectNoException - l'antonyme d'ExpectException </h3><br>  Pour les cas o√π une exception ne devrait certainement pas se produire, il existe une proc√©dure ExpectNoException.  Il fonctionne de la m√™me mani√®re qu'une ExpectException, sauf que le test est consid√©r√© comme ayant √©chou√© si une exception se produit. <br><br><h3>  Exemple 3: s√©maphore </h3><br>  La situation est la suivante.  Il existe un certain nombre de proc√©dures stock√©es et de services Windows.  Le d√©but de leur ex√©cution peut √™tre provoqu√© par divers √©v√©nements externes.  Dans ce cas, l'ordre admissible de leur ex√©cution est fixe.  Un s√©maphore est utilis√© pour diff√©rencier l'acc√®s aux tables de base de donn√©es.  Il s'agit d'un groupe de proc√©dures stock√©es. <br><br>  Par exemple, consid√©rez l'une de ces proc√©dures.  Nous avons deux tableaux: <br><br><div style="text-align:center;"><img width="80%" height="80%" src="https://habrastorage.org/webt/-m/hz/8-/-mhz8-fm_n1w7njpryiv8z3epiw.png"></div><br>  Le tableau [Processus] contient une liste des processus autoris√©s √† √™tre ex√©cut√©s, [ProcStatus] - une liste des statuts de ces processus. <br><br>  Que fait notre proc√©dure?  Lorsqu'il est appel√©, une s√©rie de v√©rifications se produit d'abord: <br><br><ol><li>  Le nom du processus √† d√©marrer, pass√© dans le param√®tre de proc√©dure, est recherch√© dans le champ [Nom] de la table [Processus]. </li><li>  Si le nom du processus a √©t√© trouv√©, il est v√©rifi√© s'il est actuellement possible de le d√©marrer - l'indicateur [IsRunable] de la table [Process]. </li><li>  S'il s'est av√©r√© que le processus est acceptable pour l'ex√©cution, alors il reste √† √™tre s√ªr qu'il n'est pas d√©j√† en cours d'ex√©cution.  Dans le tableau [ProcStatus], l'absence d'enregistrements sur ce processus avec le statut = 'InProg' est v√©rifi√©e. </li></ol><br>  Si tout va bien, un nouvel enregistrement sur ce processus avec le statut ¬´InProg¬ª est ajout√© √† ProcStatus (cela est consid√©r√© comme un lancement), l'ID de cet enregistrement est renvoy√© avec le param√®tre ProcStatusId.  Si une v√©rification √©choue, nous nous attendons √† ce qui suit: <br><br><ol><li>  Une lettre est envoy√©e √† l'administrateur syst√®me. </li><li>  Renvoie ProcStatusId = -1. </li><li>  Une nouvelle entr√©e dans [ProcStatus] n'est pas ajout√©e. </li></ol><br>  √âcrivons un cas de test pour tester le cas lorsque le processus ne figure pas dans la liste des cas acceptables. <br><br>  Pour plus de commodit√©, appliquez imm√©diatement FakeTable.  Ici, ce n'est pas si fondamentalement important, mais cela peut √™tre utile: <br><br><ol><li>  Nous sommes garantis de nous d√©barrasser de toutes les donn√©es qui pourraient interf√©rer avec la bonne ex√©cution du cas de test. </li><li>  Nous simplifierons la v√©rification des entr√©es manquantes dans ProcStatus. </li></ol><br><pre> <code class="sql hljs">EXEC tSQLt.FakeTable 'dbo.Process'; EXEC tSQLt.FakeTable 'dbo.ProcStatus';</code> </pre> <br>  Pour envoyer un message, la proc√©dure [SendEmail] √©crite par nos programmeurs est utilis√©e.  Pour v√©rifier l'envoi d'une lettre aux administrateurs, nous devons intercepter son appel.  Dans ce cas, tSQLt nous propose d'utiliser SpyProcedure. <br><br><pre> <code class="sql hljs">EXEC tSQLt.SpyProcedure 'dbo.SendEmail'</code> </pre> <br>  SpyProcedure effectue les op√©rations suivantes: <br><br><ol><li>  Cr√©e une table de la forme [dbo]. [SendEmail_SpyProcedureLog]. </li><li>  Comme FakeTable, il remplace la proc√©dure d'origine par la sienne, avec le m√™me nom, mais contenant une logique de journalisation.  Si vous le souhaitez, vous pouvez ajouter votre propre logique. </li></ol><br>  Comme vous pouvez le deviner, la journalisation se produit dans la table [dbo]. [SendEmail_SpyProcedureLog].  Ce tableau contient la colonne [_ID_] - le num√©ro de s√©quence de l'appel de proc√©dure.  Les colonnes suivantes portent les noms des param√®tres pass√©s √† la proc√©dure et les valeurs pass√©es dans les appels y sont collect√©es.  Si n√©cessaire, ils peuvent √©galement √™tre v√©rifi√©s. <br><br><div style="text-align:center;"><img width="75%" height="75%" src="https://habrastorage.org/webt/ko/gh/4h/kogh4hgcdsxagldk2bmdcfrptzi.png"></div><br>  La derni√®re chose que nous devons faire avant d'appeler le s√©maphore et de v√©rifier est de cr√©er une variable dans laquelle nous mettrons l'ID d'enregistrement de la table [ProcStatus] (plus pr√©cis√©ment, -1, car l'enregistrement ne sera pas ajout√©). <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @ProcStatusId <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span>;</code> </pre> <br>  Appelez le s√©maphore: <br><br><pre> <code class="sql hljs">EXEC dbo.[Semaphore_JobStarter]   'SomeProcess',   @ProcStatusId OUTPUT; <span class="hljs-comment"><span class="hljs-comment">--    -1</span></span></code> </pre> <br>  Voil√†, nous avons maintenant toutes les donn√©es n√©cessaires pour la v√©rification.  Commen√ßons par v√©rifier l'envoi. <br>  lettres: <br><br><pre> <code class="sql hljs">IF NOT EXISTS (   <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> *   <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dbo.SendEmail_SpyProcedureLog) EXEC tSQLt.Fail <span class="hljs-string"><span class="hljs-string">'SendEmail has not been run.'</span></span>;</code> </pre> <br>  Dans ce cas, nous avons d√©cid√© de ne pas v√©rifier les param√®tres transmis lors de l'envoi, mais simplement de v√©rifier le fait lui-m√™me.  J'attire votre attention sur la proc√©dure tSQLt.Fail.  Il vous permet d'√©chouer "officiellement" le cas de test.  Si vous avez besoin de construire une construction sp√©cifique, tSQLt.Fail vous permettra de le faire. <br><br>  Ensuite, v√©rifiez l'absence d'entr√©es dans [dbo]. [ProcStatus]: <br><br><pre> <code class="sql hljs">EXEC tSQLt.AssertEmptyTable 'dbo.ProcStatus';</code> </pre> <br>  C'est l√† que la FakeTable que nous avons appliqu√©e au tout d√©but nous a aid√©s.  Gr√¢ce √† lui, nous pouvons nous attendre au vide.  Sans cela, pour une v√©rification pr√©cise, nous devrions, dans le bon sens, comparer le nombre d'enregistrements avant et apr√®s le s√©maphore. <br><br>  Equality ProcStatusId = -1, nous pouvons facilement v√©rifier avec AssertEquals: <br><br><pre> <code class="sql hljs">EXEC tSQLt.AssertEquals   -1,       @ProcStatusId,       'Wrong ProcStatusId.';</code> </pre> <br>  AssertEquals est minimaliste - il compare simplement deux valeurs, rien de surnaturel. <br><br><h3>  Proc√©dures de fr√®res et s≈ìurs AssertEquals </h3><br>  Pour comparer les valeurs, nous disposons de plusieurs proc√©dures: <br><br><ul><li>  AssertEquals </li><li>  AssertNotEquals </li><li>  AssertEqualsString </li><li>  Assertike </li></ul><br>  Je pense que leurs noms parlent d'eux-m√™mes.  La seule chose √† noter est l'existence d'une proc√©dure AssertEqualsString distincte.  Le fait est que AssertEquals / AssertNotEquals / AssertLike fonctionne avec SQL_VARIANT, et NVARCHAR (MAX) ne s'applique pas √† cela, et donc les d√©veloppeurs tSQLt ont d√ª allouer une proc√©dure distincte pour tester NVARCHAR (MAX). <br><br><h3>  Fausse fonction </h3><br>  FakeFunction avec un certain √©tirement peut √™tre appel√© une proc√©dure similaire √† SpyProcedure.  Ce faux vous permet de remplacer n'importe quelle fonction par la plus simple n√©cessaire.  √âtant donn√© que les fonctions de SQL Server fonctionnent sur le principe d'un tube avec du dentifrice - elles donnent le r√©sultat par le "seul trou technologique", alors, malheureusement, aucune fonctionnalit√© de journalisation n'est fournie.  Seulement un remplacement pour la logique. <br><br><h1>  Pi√®ges </h1><br>  Il convient de noter certains pi√®ges que vous pouvez rencontrer en travaillant avec tSQLt.  Dans ce cas, par √©cueils, j'entends certains probl√®mes probl√©matiques n√©s en raison des limitations de SQL Server et / ou qui ne peuvent pas √™tre r√©solus par les d√©veloppeurs du framework. <br><br><h3>  Annulation / corruption de transactions </h3><br>  Le premier et le plus important probl√®me auquel notre √©quipe a √©t√© confront√©e a √©t√© l'annulation de transactions.  SQL Server ne sait pas comment restaurer s√©par√©ment les transactions imbriqu√©es - uniquement tout dans son ensemble, jusqu'aux plus externes.  √âtant donn√© que tSQLt encapsule chaque cas de test dans une transaction distincte, cela devient un probl√®me.  Apr√®s tout, une restauration de transaction √† l'int√©rieur de la proc√©dure de test peut interrompre l'ex√©cution du test, provoquant une erreur d'ex√©cution non descriptive. <br><br>  Pour contourner ce probl√®me, nous utilisons des points de sauvegarde.  L'id√©e est simple.  Avant de d√©marrer une transaction dans la proc√©dure de test, nous v√©rifions si nous sommes d√©j√† √† l'int√©rieur de la transaction.  S'il s'av√®re que oui, alors nous supposons qu'il s'agit d'une transaction tSQLt, mettez savepoint au lieu de d√©marrer.  Ensuite, si n√©cessaire, nous retournerons √† ce point de sauvegarde, et non au d√©but de la transaction.  L'imbrication en tant que telle ne l'est pas. <br><br><div style="text-align:center;"><img width="85%" height="85%" src="https://habrastorage.org/webt/zk/0u/jc/zk0ujc2gmggccs7bg7icraan3da.png"></div><br>  Le probl√®me est compliqu√© par la corruption des transactions.  Si soudainement quelque chose s'est mal pass√© et que l'exception a fonctionn√©, alors la transaction peut devenir vou√©e √† l'√©chec.  Une telle transaction peut non seulement √™tre valid√©e, mais √©galement annul√©e dans savepoint, mais uniquement annul√©e. <br><br>  Compte tenu de tout ce qui pr√©c√®de, vous devez appliquer la conception suivante: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @isNestedTransaction <span class="hljs-built_in"><span class="hljs-built_in">BIT</span></span> =   <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> @@trancount &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'true'</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-string"><span class="hljs-string">'false'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> TRY   <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @isNestedTransaction = <span class="hljs-string"><span class="hljs-string">'false'</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">SAVE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span> SavepointName;       <span class="hljs-comment"><span class="hljs-comment">-- something useful   IF @isNestedTransaction = 'false'   COMMIT TRANSACTION; END TRY BEGIN CATCH   DECLARE @isCommitable BIT =       CASE WHEN XACT_STATE() = 1           THEN 'true'           ELSE 'false'   END;   IF @isCommitable = 'true' AND @isNestedTransaction = 'true'       ROLLBACK TRANSACTION SavepointName;   ELSE       ROLLBACK;   THROW; END CATCH;</span></span></code> </pre> <br>  Consid√©rez le code en plusieurs parties.  Nous devons d'abord d√©terminer si nous sommes √† l'int√©rieur d'une transaction: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @isNestedTransaction <span class="hljs-built_in"><span class="hljs-built_in">BIT</span></span> =   <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> @@trancount &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'true'</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-string"><span class="hljs-string">'false'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>;</code> </pre> <br>  Apr√®s avoir re√ßu l'indicateur @isNestedTransaction, ex√©cutez le bloc TRY et d√©finissez le point de sauvegarde ou le d√©but de la transaction, selon la situation. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> TRY   <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @isNestedTransaction = <span class="hljs-string"><span class="hljs-string">'false'</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">SAVE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span> SavepointName;       <span class="hljs-comment"><span class="hljs-comment">-- something useful</span></span></code> </pre> <br>  Apr√®s avoir fait quelque chose d'utile, validez, s'il s'agit d'un ¬´vrai¬ª d√©but de la proc√©dure. <br><br><pre> <code class="sql hljs">       <span class="hljs-comment"><span class="hljs-comment">-- something useful   IF @isNestedTransaction = 'false'   COMMIT TRANSACTION; END TRY</span></span></code> </pre> <br>  Bien s√ªr, s'il s'agit d'un lancement √† partir d'un sc√©nario de test, nous n'avons besoin de rien engager.  √Ä la fin de l'ex√©cution, tSQLt annulera simplement toutes les modifications.  Si soudainement quelque chose s'est mal pass√© et que nous sommes entr√©s dans le bloc CATCH, la premi√®re chose √† faire est de savoir si notre transaction peut m√™me √™tre valid√©e. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> CATCH   <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @isCommitable <span class="hljs-built_in"><span class="hljs-built_in">BIT</span></span> =       <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> XACT_STATE() = <span class="hljs-number"><span class="hljs-number">1</span></span>           <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'true'</span></span>           <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-string"><span class="hljs-string">'false'</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>;</code> </pre> <br>  Nous ne pouvons revenir au point de sauvegarde que si <br><br><ol><li>  transaction commitable </li><li>  un essai a lieu, c.-√†-d.  le point de sauvegarde existe. </li></ol><br>  Dans d'autres cas, nous devons annuler la totalit√© de la transaction. <br><br><pre> <code class="sql hljs">   IF @isCommitable = 'true' AND @isNestedTransaction = 'true'       <span class="hljs-keyword"><span class="hljs-keyword">ROLLBACK</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span> SavepointName;   ELSE       <span class="hljs-keyword"><span class="hljs-keyword">ROLLBACK</span></span>;   THROW; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> CATCH;</code> </pre> <br>  Oui, malheureusement, si lors d'une ex√©cution de test, nous obtenons une transaction non validable, nous obtenons toujours une erreur dans l'ex√©cution du sc√©nario de test. <br><br><h3>  FakeTable et probl√®me avec la cl√© √©trang√®re </h3><br>  Consid√©rez les tableaux familiers [Trial] et [Clinic]: <br><br><div style="text-align:center;"><img width="85%" height="85%" src="https://habrastorage.org/webt/fy/k7/nm/fyk7nmhfha_fnezignyxclpflay.png"></div><br>  Nous nous souvenons du [TrialID] FK.  Quels probl√®mes cela peut-il causer?  Dans les exemples donn√©s pr√©c√©demment, nous avons appliqu√© FakeTable aux deux tables √† la fois.  Si nous l'appliquons uniquement sur [Trial], nous obtenons la situation suivante: <br><br><div style="text-align:center;"><img width="85%" height="85%" src="https://habrastorage.org/webt/og/to/3-/ogto3-drjheieblpi1_gsyup4hs.png"></div><br>  Une tentative d'insertion d'une entr√©e dans [Clinic], de cette mani√®re, peut s'av√©rer √™tre un √©chec (m√™me si nous avons pr√©par√© toutes les donn√©es n√©cessaires dans la fausse version du tableau [Trial]). <br><br><pre> <code class="sql hljs">[dbo].[Test_FK_Problem] failed: (Error) The <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">statement</span></span> conflicted <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constraint</span></span> <span class="hljs-string"><span class="hljs-string">"Trial_Fk"</span></span>. The conflict occurred <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">database</span></span> <span class="hljs-string"><span class="hljs-string">"HabrDemo"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-string"><span class="hljs-string">"dbo.tSQLt_tempobject_ba8f36353f7a44f6a9176a7d1db02493"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">column</span></span> <span class="hljs-string"><span class="hljs-string">'TrialID'</span></span>.[<span class="hljs-number"><span class="hljs-number">16</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>]{Test_FK_Problem,<span class="hljs-number"><span class="hljs-number">14</span></span>}</code> </pre> <br>  Conclusion: vous devez soit tout simuler, soit ne rien simuler.  Dans le second cas, il est √©vident que la base doit √™tre pr√©par√©e √† l'avance pour les tests. <br><br><h3>  SpyProcedure sur les proc√©dures syst√®me </h3><br>  H√©las, l'espionnage des appels aux proc√©dures syst√®me √©chouera. <br><br><pre> <code class="sql hljs">[HabrDemo].[test_test] failed: (Error) Cannot <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> SpyProcedure <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> sys.sp_help because the <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> does <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> exist[<span class="hljs-number"><span class="hljs-number">16</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>] {tSQLt.Private_ValidateProcedureCanBeUsedWithSpyProcedure,<span class="hljs-number"><span class="hljs-number">7</span></span>}</code> </pre> <br>  Dans l'exemple du s√©maphore, nous avons suivi les appels √† la proc√©dure [SendEmail] √©crits par nos d√©veloppeurs.  Dans ce cas, l'√©criture d'une proc√©dure distincte est due √† la n√©cessit√© de collecter et de traiter certaines informations suppl√©mentaires avant d'envoyer des messages directement.  Dans l'ensemble, il faut √™tre mentalement pr√©par√© au fait que l'on peut avoir √† √©crire des proc√©dures intercouches pour certaines proc√©dures syst√®me uniquement √† des fins de test. <br><br><h1>  Les avantages </h1><br><h3>  Installation rapide </h3><br>  L'installation se d√©roule en 2 √©tapes et dure environ 2 minutes.  Il vous suffit d'activer le CLR sur le serveur, si ce n'est d√©j√† fait, et d'ex√©cuter un seul script.  Tout, vous pouvez ajouter la premi√®re classe de test et √©crire des cas de test. <br><br><h3>  D√©veloppement rapide </h3><br>  tSQLt est un outil facile √† apprendre.  Il m'a fallu une petite journ√©e pour le ma√Ætriser.  J'ai demand√© √† mes coll√®gues qui travaillaient avec le cadre, et il s'est av√©r√© que tout le monde passerait environ une journ√©e. <br><br><h3>  Impl√©mentation rapide dans CI </h3><br>  Il a fallu environ 2 heures pour configurer l'int√©gration dans CI sur notre projet.  Bien s√ªr, le temps peut varier, mais en g√©n√©ral ce n'est pas un probl√®me et l'int√©gration peut √™tre effectu√©e tr√®s rapidement. <br><br><h3>  Large gamme d'outils </h3><br>  Il s'agit d'une √©valuation subjective, mais, √† mon avis, la fonctionnalit√© fournie par tSQLt est assez riche et couvre la part du lion des besoins dans la pratique.  Dans de rares cas o√π il n'y a pas assez de contrefa√ßons et d'assertions int√©gr√©es, il y a bien s√ªr tSQLt.Fail. <br><br><h3>  Documentation pratique </h3><br>  La documentation officielle est pratique et coh√©rente.  Avec son aide, vous pouvez facilement comprendre l'essence de l'utilisation de tSQLt en peu de temps, m√™me s'il s'agit de votre premier outil de test unitaire. <br><br><h3>  Sortie pratique </h3><br>  Les donn√©es peuvent √™tre obtenues sous forme de texte tr√®s clair: <br><br><pre> <code class="plaintext hljs">[tSQLtDemo].[test_error_messages] failed: (Failure) Expected an error to be raised. [tSQLtDemo].[test_tables_comparison] failed: (Failure) useful and descriptive error message Unexpected/missing resultset rows! |_m_|Column1|Column2| +---+-------+-------+ |&lt; |2 |Value2 | |= |1 |Value1 | |= |3 |Value3 | |&gt; |2 |Value3 | +----------------------+ |Test Execution Summary| +----------------------+ |No|Test Case Name |Dur(ms)|Result | +--+------------------------------------+-------+-------+ |1 |[tSQLtDemo].[test_constraint] | 83|Success| |2 |[tSQLtDemo].[test_trial_view] | 83|Success| |3 |[tSQLtDemo].[test_error_messages] | 127|Failure| |4 |[tSQLtDemo].[test_tables_comparison]| 147|Failure| ----------------------------------------------------------------------------- Msg 50000, Level 16, State 10, Line 1 Test Case Summary: 4 test case(s) executed, 2 succeeded, 2 failed, 0 errored. -----------------------------------------------------------------------------</code> </pre><br>  Vous pouvez √©galement extraire de la base de donn√©es (cliquable) ... <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/webt/-f/83/la/-f83lajcz1mfcnkhtttz45b0x3g.png"></a> </div><br>  ... ou obtenez au format XML. <br><br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testsuites</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testsuite</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tSQLtDemo"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">tests</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"3"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">errors</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">failures</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">timestamp</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2019-06-22T16:46:06"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">time</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0.433"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">hostname</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"BLAHBLAHBLAH\SQL2017"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">package</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tSQLt"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">properties</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testcase</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">classname</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tSQLtDemo"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"test_constraint"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">time</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0.097"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testcase</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">classname</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tSQLtDemo"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"test_error_messages"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">time</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0.153"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">failure</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">message</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Expected an error to be raised."</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tSQLt.Fail"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testcase</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testcase</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">classname</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tSQLtDemo"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"test_trial_view"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">time</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0.156"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system-out</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system-err</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testsuite</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testsuites</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Cette derni√®re option vous permet d'int√©grer facilement des tests dans CI.  En particulier, tout fonctionne pour nous sous Atlassian Bamboo. <br><br><h3>  Prise en charge de Redgate </h3><br>  Les avantages incluent la prise en charge d'un si grand fournisseur d'outils DBA comme RedGate.  SQL Test - leur plugin pour SQL Server Management Studio - fonctionne avec tSQLt d√®s la sortie de la bo√Æte.  En outre, RedGate fournit une assistance au d√©veloppeur principal tSQLt avec l'environnement de d√©veloppement, comme le pr√©tend le d√©veloppeur lui-m√™me des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">groupes Google</a> . <br><br><h1>  Inconv√©nients </h1><br><h3>  Aucun faux table temporaire </h3><br>  tSQLt n'autorise pas les fausses tables temporaires.  Si n√©cessaire, vous pouvez utiliser le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">module compl√©mentaire non officiel</a> .  Malheureusement, ce module compl√©mentaire n'est pris en charge que par SQL Server 2016+. <br><br><h3>  Pas d'acc√®s aux bases de donn√©es externes </h3><br>  Il ne fonctionnera pas de conserver une base s√©par√©e uniquement pour stocker le cadre.  tSQLt est con√ßu pour tester ce qui se trouve dans la m√™me base de donn√©es.  Le faux, h√©las, ne fonctionnera pas. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> [tSQLtDemo].[test_outer_db] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP <span class="hljs-number"><span class="hljs-number">10</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [AdventureWorks2017].[Person].[<span class="hljs-keyword"><span class="hljs-keyword">Password</span></span>]   EXEC tSQLt.FakeTable <span class="hljs-string"><span class="hljs-string">'[AdventureWorks2017].[Person].[Password]'</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP <span class="hljs-number"><span class="hljs-number">10</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [AdventureWorks2017].[Person].[<span class="hljs-keyword"><span class="hljs-keyword">Password</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">END</span></span></code> </pre><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ga/au/ny/gaaunygdr124sssxhonbb2s0b_0.png"></div><br>  Les assertions semblent fonctionner, mais personne ne garantit leur performance, bien s√ªr. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> [tSQLtDemo].[test_outer_db_assertions] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP <span class="hljs-number"><span class="hljs-number">1</span></span> *   <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-comment"><span class="hljs-comment">#Actual   FROM [AdventureWorks2017].[Person].[Password]   SELECT *   INTO #Expected   FROM (          SELECT 'bE3XiWw=' AS [PasswordSalt]   ) expectedresult;   EXEC tSQLt.AssertEqualsTable '#Expected', '#Actual', 'The salt is not salty'; END</span></span></code> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/cg/dk/ow/cgdkowych69imevqmbirkkgsniq.png"></div><br><h3>  Bogues de documentation </h3><br>  Malgr√© le fait que j'ai √©crit ci-dessus sur la coh√©rence et l'accessibilit√© de la documentation, elle contient √©galement des probl√®mes.  Il y a des moments d√©pass√©s. <br><br>  Exemple 1. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">¬´Guide de d√©marrage rapide¬ª</a> sugg√®re de t√©l√©charger le framework depuis SourceForge.  Ils ont dit au revoir √† SourceForge <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">en 2015</a> . <br><br>  Exemple 2. Le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">guide ApplyConstraint</a> de l'exemple utilise une proc√©dure Fail pour intercepter une exception, qui serait plus facile et plus visuelle √† remplacer par ExpectException. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> ConstraintTests.[<span class="hljs-keyword"><span class="hljs-keyword">test</span></span> ReferencingTable_ReferencedTable_FK prevents <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> orphaned <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> EXEC tSQLt.FakeTable <span class="hljs-string"><span class="hljs-string">'dbo.ReferencedTable'</span></span>; EXEC tSQLt.FakeTable 'dbo.ReferencingTable'; EXEC tSQLt.ApplyConstraint 'dbo.ReferencingTable','ReferencingTable_ReferencedTable_FK'; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @ErrorMessage <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @ErrorMessage = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* []     ExceptException ? */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> TRY <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> dbo.ReferencingTable ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, ReferencedTableId ) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> ( <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">11</span></span> ) ; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> TRY <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> CATCH <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @ErrorMessage = ERROR_MESSAGE(); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> CATCH <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @ErrorMessage <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> <span class="hljs-string"><span class="hljs-string">'%ReferencingTable_ReferencedTable_FK%'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> EXEC tSQLt.Fail <span class="hljs-string"><span class="hljs-string">'Expected error message containing ''ReferencingTable_ReferencedTable_FK'' but got: '''</span></span>,@ErrorMessage,<span class="hljs-string"><span class="hljs-string">'''!'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre><br>  Et c'est naturel, car √ßa se passe ... <br><br><h3>  Abandon partiel </h3><br>  Il y a une longue interruption dans le d√©veloppement de tSQLt de d√©but 2016 √† juin 2019. Oui, malheureusement, cet outil est partiellement abandonn√©.  En 2019, peu √† peu, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">√† en juger par GitHub</a> , le d√©veloppement a encore progress√©.  Bien que les groupes Google officiels <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">aient un fil</a> dans lequel Sebastian, le principal d√©veloppeur de tSQLt, a √©t√© directement interrog√© sur le sort du d√©veloppement.  La derni√®re question a √©t√© pos√©e le 2 mars 2019, la r√©ponse n'a pas encore √©t√© re√ßue. <br><br><h3>  Probl√®me avec SQL Server 2017 </h3><br>  Si vous utilisez SQL Server 2017, alors pour vous, l'installation de tSQLt n√©cessitera √©ventuellement une manipulation suppl√©mentaire.    ,    2012   SQL Server  security-.       ¬´CLR strict security¬ª,      ( SAFE).       (,  ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>     ).      . <br><br>   , ,     ¬´ ¬ª,       tSQLt,        ,    . <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> GitHub   issue</a> , ,       2017 (.  ). <br><br><h1>  (¬±)    </h1><br>        . tSQLt      . ,    (CLR,   T-SQL     SQL ),        ,       . ,     tSQLt  ,       SQL-powered   . <br><br> ,  PostgreSQL       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ptTAP</a> .      ¬´¬ª PL/pgSQL      TAP.  MySQL  ,       ‚Äî <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">MyTAP</a> .       Oracle,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">utPLSQL</a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Un outil tr√®s puissant et activement (je dirais m√™me plus que) un outil de d√©veloppement.</font></font><br><br><h1>  Conclusion </h1><br> ,         . <br><br>  ‚Äî     .     SQL Server, Oracle  MySQL ‚Äî .          ,       .       ,       ,    ,  , ,  . <br><br>   ‚Äî   .  ,     ,   SQL Server,  tSQLt    100% ,    ,      .        ,     ,   . <br><br><div class="spoiler"> <b class="spoiler_title">,    ( )</b> <div class="spoiler_text"> DbFit ‚Äî Automated Open Source Database Testing: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">http://www.methodsandtools.com/tools/dbfit.php</a> <br><br> DbFit Documentation: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://dbfit.github.io/dbfit/docs/</a> <br><br> Slacker wiki: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/vassilvk/slacker/wiki</a> <br><br> TST documentation: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://archive.codeplex.com/projects/TST/4e04e281-9f35-4891-809a-15f09d304f4e</a> <br><br> NUnit Assertions: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/nunit/docs/wiki/Assertions</a> <br><br> utTSQL code: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://sourceforge.net/p/uttsql/code/HEAD/tree/</a> <br><br> Junit Class Assert: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://junit.org/junit4/javadoc/latest/org/junit/Assert.html</a> <br><br> pgTap: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://pgtap.org/</a> <br><br> utPLSQL: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">http://utplsql.org/</a> <br><br> MyTap: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/hepabolu/mytap</a> <br><br> tSQLt Google groups: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://groups.google.com/forum/#!forum/tsqlt</a> <br><br> tSQLt official website: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://tsqlt.org/</a> <br><br> tSQLt GitHub: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/tSQLt-org/tSQLt</a> <br><br> Google trends: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://bit.ly/2x7BQL6</a> <br><br> How to ROLLBACK a transaction when testing using tSQLt: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://stackoverflow.com/questions/8973138/how-to-rollback-a-transaction-when-testing-using-tsqlt</a> <br><br> What are the Pros and Cons of Manual Unit Testing against the Automated Unit Testing?: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://stackoverflow.com/questions/2948337/what-are-the-pros-and-cons-of-manual-unit-testing-against-the-automated-unit-tes#2948354</a> <br><br> The Good, the Bad, and the UgleÃÖeÃÖ: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://sqlquantumleap.com/2017/08/07/sqlclr-vs-sql-server-2017-part-1-clr-strict-security/</a> <br><br> Rex Black, Erik Van Veenendal, Dorothy Graham, Foundations of Software Testing, Third edition, 2012 Cengage Learning EMEA <br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr461133/">https://habr.com/ru/post/fr461133/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr461121/index.html">Petites exp√©riences multit√¢ches dans un microcontr√¥leur</a></li>
<li><a href="../fr461125/index.html">La t√¢che de cr√©ation de codes num√©riques s√©quentiels pour la num√©rotation des messages dans le code source dans Visual Studio (ex. C #)</a></li>
<li><a href="../fr461127/index.html">Analyse des performances des machines virtuelles dans VMware vSphere. Partie 3: Stockage</a></li>
<li><a href="../fr461129/index.html">√Ä propos de Kote, de sa femme, de ses deux fils, de l'id√©e ... et pas seulement. Histoire avec suite</a></li>
<li><a href="../fr461131/index.html">Chariot √† chariots ROS, partie 2. Logiciel</a></li>
<li><a href="../fr461137/index.html">Comment nous avons d√©velopp√© un appareil pour surveiller l'attention des conducteurs. D√©couvrez Yandex.Taxi</a></li>
<li><a href="../fr461141/index.html">Mon premier jour avec Haiku: elle est √©tonnamment bonne</a></li>
<li><a href="../fr461143/index.html">Sur les probl√®mes actuels de conception de jeux et les moyens de les r√©soudre. Vue de dessous</a></li>
<li><a href="../fr461145/index.html">Que doit diriger une √©quipe: r√¥les, responsabilit√©s et comp√©tences</a></li>
<li><a href="../fr461147/index.html">Comment √©conomiser 64 heures en combinant des cl√©s dans PowerPoint</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>