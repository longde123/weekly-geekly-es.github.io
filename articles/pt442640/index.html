<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üîÅ ü¶å ü§¥üèª Bug perfeito: usando confus√£o de tipo no Flash. Parte 1 üëπ üëâüèº üå∞</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√° novamente! Amanh√£ iniciaremos as aulas em um novo grupo no curso "Engenharia Reversa" . Tradicionalmente, compartilhamos com voc√™ a tradu√ß√£o de ma...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Bug perfeito: usando confus√£o de tipo no Flash. Parte 1</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/442640/"> Ol√° novamente!  Amanh√£ iniciaremos as aulas em um novo grupo no curso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">"Engenharia Reversa"</a> .  Tradicionalmente, compartilhamos com voc√™ a tradu√ß√£o de material √∫til sobre o tema.  Vamos l√°! <br><br>  √â importante para alguns invasores que a explora√ß√£o seja extremamente confi√°vel.  Sempre deve levar √† execu√ß√£o do c√≥digo quando iniciado em um sistema com uma plataforma e vers√£o conhecidas do Flash.  Para cri√°-lo, voc√™ pode usar erros especialmente de alta qualidade.  Este artigo descreve o uso de um desses erros, bem como fatores que o tornam particularmente adequado para uma opera√ß√£o confi√°vel. <br><br><img src="https://habrastorage.org/webt/re/8s/8_/re8s8_s-dzhq-_rod6r1s8cpgu4.png"><br><br>  <b>Bug</b> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">CVE-2015-3077</a> - o problema da confus√£o de tipos nos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">configuradores de</a> filtro Adobe Flash <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Button</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">MovieClip</a> , que permite confundir qualquer <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tipo de filtro</a> com qualquer outro.  Eu relatei no in√≠cio de dezembro de 2015 e em maio foi corrigido.  O bug ocorre porque o cracker pode substituir o construtor usado para inicializar o objeto de filtro.  O c√≥digo de amostra que reproduz o problema √© apresentado abaixo: <a name="habracut"></a><br><br><img src="https://habrastorage.org/webt/va/xj/rh/vaxjrhzbaobwb2fuzt1iy6m0ajc.png"><br><br>  Esse c√≥digo √© um pouco confuso devido ao uso do operador [], necess√°rio para a compila√ß√£o no Flash CS.  O c√≥digo logicamente equivalente (que n√£o √© um fato que compila) √© fornecido abaixo: <br><br><img src="https://habrastorage.org/webt/j1/kz/iy/j1kziyhb8bvsxi38rguqwl4wt_u.png"><br><br>  Esse c√≥digo define o campo de filtro do objeto: Button ou MovieClip como BlurFilter, que √© armazenado diretamente no Flash.  O construtor BlurFilter √© substitu√≠do pelo construtor ConvolutionFilter.  Depois disso, o getter √© chamado e um objeto ActionScript √© criado para armazenar o BlurFilter original.  No entanto, o construtor j√° foi substitu√≠do, portanto, ConvolutionFilter √© chamado.  Isso produz um objeto do tipo ConvolutionFilter, suportado pelo retorno do BlueFilter original. <br><br>  Por fim, os campos ConvolutionFilter podem ser acessados ‚Äã‚Äã(leitura e grava√ß√£o) como se pertencessem ao BlurFilter.  Da mesma forma para qualquer outro tipo de filtro.  Isso abre uma ampla gama de manipula√ß√µes √∫teis para explorar. <br><br>  O diagrama abaixo mostra o local dos objetos originais na mem√≥ria que podem ser confundidos usando essa vulnerabilidade no Linux de 64 bits. <br><br><img src="https://habrastorage.org/webt/y2/oj/bx/y2ojbxjilki-dlsgfkcosg4ifia.png"><br><br>  Em dois casos, ponteiros s√£o compar√°veis ‚Äã‚Äãa n√∫meros inteiros e n√∫meros de ponto flutuante que podem ser manipulados.  Isso significa que os ponteiros podem ser lidos e escritos diretamente.  Al√©m disso, como os campos dos objetos s√£o ordenados e classificados por tamanho, de acordo com a defini√ß√£o da classe, eles est√£o sempre em locais previs√≠veis, para que a escrita e a leitura n√£o falhem.  Essas propriedades s√£o importantes para garantir a confiabilidade da explora√ß√£o. <br><br>  <b>Explorar</b> <br><br>  Como explorar esse problema requer execu√ß√£o repetida de confus√£o de tipo, comecei criando uma fun√ß√£o de utilit√°rio para confus√£o de tipo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">FilterConfuse.confuse</a> .  Ele tamb√©m arruma as coisas: retorna os construtores de filtro do ActionScript de volta ao seu estado normal para chamar repetidamente uma fun√ß√£o vulner√°vel sem afetar o comportamento do ActionScript fora da pr√≥pria fun√ß√£o. <br>  O primeiro passo foi ignorar o ASLR, definindo o endere√ßo da tabela de fun√ß√µes virtuais (brevemente vtable).  A maneira ideal para isso √© confundir um objeto com uma vtable com um objeto no qual existe um elemento sobreposto √† vtable que pode ser manipulado.  Mas a tabela de todos os objetos de filtro tem o mesmo deslocamento.  Em vez disso, usei o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">objeto BitmapData</a> no DisplacementMapFilter para determinar o endere√ßo da tabela. <br><br>  Para determinar o local na mem√≥ria BitmapData do objeto, confundi DisplacementMapFilter com BevelFilter.  Isso fez com que o ponteiro BitmapData armazenado no DisplacementMapFilter se alinhasse √†s propriedades de cor BevelFilter ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">shadowColor</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">shadowAlpha</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">realceColor</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">realceAlpha</a> ).  Essas propriedades s√£o suportadas por dois n√∫meros inteiros de 32 bits (mostrados como scolor e hcolor acima e abaixo), e as propriedades da cor acessam 24 bits de cada n√∫mero inteiro, enquanto as propriedades alfa acessam os 8 bits superiores.  Se voc√™ ler essas propriedades e combin√°-las usando a aritm√©tica de bits, poder√° extrair o endere√ßo BitmapData imediato do objeto. <br><br><img src="https://habrastorage.org/webt/h6/br/v4/h6brv4dh4dvgpaobzvxmcy3enni.png"><br><br>  Em seguida, voc√™ precisa ler a vtable na parte superior do objeto BitmapData.  Para isso, usei a propriedade <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">matrix</a> do objeto ConvolutionFilter.  Ele √© armazenado como um ponteiro para uma matriz de n√∫meros de ponto flutuante, na qual a mem√≥ria √© alocada ao definir a propriedade, e uma matriz do ActionScript contendo esses n√∫meros √© retornada quando a propriedade √© recebida.  Ao definir o ponteiro da matriz para um objeto BitmapData, voc√™ pode ler o conte√∫do desse objeto da mem√≥ria como uma matriz de n√∫meros de ponto flutuante. <br><br>  Para definir o ponteiro, confundi o objeto ConvolutionFilter com o objeto DisplacementMapFilter (n√£o o mesmo DisplacementMapFilter usado acima!) E defina o local do BitmapData do objeto acima na propriedade <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">mapPoint</a> .  A propriedade mapPoint √© um ponto com coordenadas inteiras x e y (p_x e p_y na figura abaixo) que correspondem ao ponteiro da matriz no ConvolutionFilter, o que facilitou a configura√ß√£o desse valor.  Depois disso, tornou-se poss√≠vel ler a vtable do objeto BitmapData usando uma matriz de matriz do objeto ConvolutionFilter (vale a pena notar que, para isso, o objeto tinha que ser confundido com DisplacementBitmapFilter e depois confundido com ConvolutionFilter). <br><br><img src="https://habrastorage.org/webt/c9/_m/ch/c9_mchtficp34f3op6lts9sv0x0.png"><br><br>  Nesse ponto, fica mais dif√≠cil manter a confiabilidade da explora√ß√£o devido ao uso de n√∫meros de ponto flutuante.  Os valores vtable_low e vtable_high s√£o lidos na matriz ConvolutionFilter como n√∫meros de ponto flutuante, pois esse √© um tipo de matriz.  Infelizmente, por√©m, nem todo valor de ponteiro v√°lido √© um n√∫mero de ponto flutuante v√°lido.  Isso significa que a leitura do valor retornar√° NaN, ou pior, um valor num√©rico n√£o totalmente correto. <br><br>  Idealmente, para resolver esse problema, voc√™ precisa acessar vtable_low e vtable_high atrav√©s de um getter, que os interpreta como n√∫meros inteiros, mas isso n√£o ocorre porque os elementos de filtro geralmente s√£o flutuantes devido √† sua funcionalidade. <br><br>  Felizmente, a m√°quina virtual AS2 √© pregui√ßosa o suficiente para interpretar n√∫meros de ponto flutuante - apenas converte um valor em um flutuador quando uma opera√ß√£o √© executada no ActionScript.  As opera√ß√µes originais geralmente n√£o requerem interpreta√ß√£o, exceto as especiais, como a aritm√©tica.  Isso significa que, ao copiar um n√∫mero de ponto flutuante de uma matriz para vtable_low ou vtable_high, ele manter√° seu valor na mem√≥ria, mesmo se for inv√°lido para float, enquanto a vari√°vel na qual foi copiada n√£o for usada no ActionScript ou para executar opera√ß√µes aritm√©ticas no nativo c√≥digo.  Assim, se o valor de uma vari√°vel for instantaneamente confundido com outro tipo que suporte toda a faixa de valores de 32 bits, por exemplo int, √© garantido que seja o mesmo que o valor original na mem√≥ria da matriz.  Portanto, para evitar falta de confiabilidade na explora√ß√£o, √© importante realizar confus√£o de tipo antes de manipular flutua√ß√µes no ActionScript. <br><br>  Para fazer isso, escrevi uma classe de convers√£o, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">FloatConverter</a> , usando confus√£o de tipo em filtros para implementar fun√ß√µes de inteiro para flutuar e de flutuar para inteiro.  Ele confunde a propriedade ColorMatrixFilter da <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">matriz</a> (n√£o a confunda com a propriedade da matriz ConvolutionFilter), que √© um conjunto de flutuadores internos, com as propriedades de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">cor</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">alfa</a> do GlowFilter que acessam diferentes bytes int. <br><br><img src="https://habrastorage.org/webt/q_/as/zn/q_asznantji32lw-qcgaqe0rlwi.png"><br><br>  Dessa forma, voc√™ pode implementar uma convers√£o confi√°vel de um float para um int, mas, infelizmente, isso n√£o funciona de maneira confi√°vel na dire√ß√£o oposta.  Para acessar a matriz de cores no ColorMatrix no ActionScript, a matriz inteira √© copiada, mesmo se voc√™ acessar apenas a primeira delas.  Ao copiar uma matriz, cada elemento √© convertido em Number, que inclui uma chamada para ponteiros (por exemplo, chamando o valor de um objeto).  Como a matriz de cores √© a mais longa de toda a classe GlowFilter, fica acumulada quando confundida com o GlowFilter.  Isso significa que pode ocorrer a convers√£o de valores desconhecidos desse heap, o que causar√° falha se eles se referirem a ponteiros inv√°lidos ao converter para Number.  Portanto, para int-to-float, implementei um conversor de flutua√ß√£o usando outra confus√£o ConvolutionFilter e DisplacementMapFilter, que √© uma convers√£o direta e n√£o causa valores desconhecidos do heap. <br><br><img src="https://habrastorage.org/webt/0s/js/qv/0sjsqvadnz0x0dhkzxk9lcsmlia.png"><br><br>  Isso resolve o problema de falhas causadas pelo acesso a valores desconhecidos do heap, mas, infelizmente, h√° outro problema de confiabilidade associado aos flutuadores nessa explora√ß√£o.  Isso ocorre devido √† implementa√ß√£o do getter de matriz ConvolutionFilter.  Todos os valores num√©ricos no ActionScript 2 s√£o do tipo Number, que √© a uni√£o de um n√∫mero inteiro e um ponteiro em um n√∫mero duplo.  A matriz ConvolutionFilter original √© armazenada como uma matriz de n√∫meros de ponto flutuante, mas √© copiada para a matriz do ActionScript para preservar o acesso quando o getter de matriz √© chamado e os valores s√£o convertidos para dobrar no processo.  Em seguida, ao chamar o conversor flutuante, eles s√£o convertidos novamente em n√∫meros de ponto flutuante. <br><br>  A convers√£o de um n√∫mero de ponto flutuante em um n√∫mero de precis√£o dupla e vice-versa geralmente salva seu valor, mas n√£o se o valor de flutua√ß√£o for SNaN.  De acordo com a especifica√ß√£o de ponto flutuante, existem dois tipos de NaNs: NaN silencioso (QNaN) e NaN de sinal (SNaN).  Quando o QNaN aparece, nada acontece, mas o SNaN em alguns casos gera uma exce√ß√£o de ponto flutuante.  No x86, a convers√£o de double para float sempre resulta em QNaN (mesmo que o double tenha vindo do SNaN) para evitar exce√ß√µes inesperadas. <br><br>  Portanto, se os bits inferiores do ponteiro forem SNaN, eles ser√£o convertidos para QNaN, o que significa que o primeiro bit (o primeiro bit de mantissa, bit 22) ser√° definido quando n√£o deve.  Esse problema pode ser evitado ao ler o vtable - o terceiro byte do ponteiro que cont√©m o primeiro bit pode ser lido sem alinhamento para confirmar o valor atual.  Portanto, o c√≥digo ser√° lido sem alinhamentos (ap√≥s a leitura da vtable novamente com o ponteiro de Bitmap aumentado em um) e ajustar√° o valor int se o float for SNaN. <br><br>  Usando os conversores flutuantes descritos acima, o endere√ßo vtable pode ser convertido em um n√∫mero inteiro.  Agora voc√™ precisa obter o c√≥digo para executar usando este endere√ßo.  Uma maneira f√°cil de mover o ponteiro de instru√ß√£o √© substituir a tabela de objetos do objeto (ou um ponteiro para um objeto que possui uma tabela de objetos).  Isso pode ser feito confundindo a matriz da matriz ConvolutionFilter e o BitmapData do ponteiro DisplacementFilter. <br><br>  O fim da primeira parte.  A segunda parte da tradu√ß√£o ser√° publicada um pouco mais tarde, e agora aguardamos seus coment√°rios e convidamos todos para o curso de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">engenharia reversa</a> OTUS. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt442640/">https://habr.com/ru/post/pt442640/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt442626/index.html">Habraiting: construindo uma nuvem de palavras que falam russo no exemplo dos cabe√ßalhos Habra</a></li>
<li><a href="../pt442630/index.html">Durabilidade da l√¢mpada LED e emiss√£o de luz reduzida</a></li>
<li><a href="../pt442632/index.html">Energia geot√©rmica: como o calor da Terra se transformou em um recurso energ√©tico eficiente</a></li>
<li><a href="../pt442636/index.html">Voc√™ traz m√°s not√≠cias para a ger√™ncia?</a></li>
<li><a href="../pt442638/index.html">Escalonamento de aplicativos Kubernetes com base nas m√©tricas do Prometheus</a></li>
<li><a href="../pt442642/index.html">O que ler em mar√ßo: 22 novos livros para profissionais de marketing, gerentes, desenvolvedores e designers</a></li>
<li><a href="../pt442644/index.html">A maioria das habilidades que n√£o s√£o de programa√ß√£o aumentam o valor do desenvolvedor</a></li>
<li><a href="../pt442646/index.html">Redes Kubernetes: ingresso</a></li>
<li><a href="../pt442648/index.html">Ir mecanismos de aloca√ß√£o</a></li>
<li><a href="../pt442650/index.html">An√°lise e otimiza√ß√£o de aplicativos React</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>