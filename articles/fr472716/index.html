<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§õüèº üë©‚Äçüç≥ ‚úçüèª Obtenir correctement Spring Bean √† partir d'un contexte d'application tiers üè® üë©‚Äçüè´ üï∫üèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, Khabrovites! 

 Dans cet article, je propose de discuter de l'un des probl√®mes que l'on rencontre souvent dans les projets utilisant le frame...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Obtenir correctement Spring Bean √† partir d'un contexte d'application tiers</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/472716/">  Bonjour, Khabrovites! <br><br>  Dans cet article, je propose de discuter de l'un des probl√®mes que l'on rencontre souvent dans les projets utilisant le framework Spring.  Le probl√®me d√©crit dans cet article se pose en raison d'une des erreurs typiques dans les configurations de ressort.  Pas besoin d'essayer de faire une telle erreur dans la configuration, et donc cette erreur est assez courante. <br><a name="habracut"></a><br><h3>  √ânonc√© du probl√®me </h3><br>  Le probl√®me pr√©sent√© dans cet article est li√© √† la configuration incorrecte des beans dans le contexte d'application actuel, qui sont extraits d'autres contextes d'application.  Un tel probl√®me peut survenir dans une grande application industrielle, qui se compose de nombreux pots, chacun ayant son propre contexte d'application contenant des haricots de printemps. <br><br>  En raison d'une configuration incorrecte, nous obtenons plusieurs copies de beans avec un √©tat impr√©visible, m√™me s'ils ont la port√©e singleton.  De plus, une copie irr√©fl√©chie des beans peut conduire au fait que plus d'une douzaine de copies de tous les beans de n'importe quel bocal seront cr√©√©es dans l'application, ce qui est lourd de probl√®mes de performances d'application et d'une augmentation du temps de d√©marrage de l'application. <br><br><h3>  Un exemple d'utilisation d'un bean √† partir d'un contexte d'application externe dans le courant </h3><br>  Imaginez que nous d√©veloppons dans l'un des modules d'application, dans lequel il existe de nombreux autres modules, et que chacun des modules a son propre contexte d'application.  Une telle application doit avoir un module dans lequel des instances du contexte d'application de tous les modules d'application sont cr√©√©es. <br><br><img src="https://habrastorage.org/webt/cj/rv/up/cjrvupro3dfswnrsg1uxgxfma1a.png" height="300" width="300"><br><br>  Supposons que, dans le contexte d'application de l'un des modules externes, une instance du bean de la classe NumberGenerator soit cr√©√©e, que nous voulons obtenir dans notre module.  Supposons √©galement que la classe NumberGenerator se trouve dans le package org.example.kruchon.generators, qui stocke certaines classes qui g√©n√®rent des valeurs. <br><br><img src="https://habrastorage.org/webt/jx/s5/nx/jxs5nx1jehc6xiq_xzgxym8vxni.png" height="400" width="400"><br><br>  Ce bean a un √©tat - le champ nombre entier. <br><br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> org.example.kruchon.calculators <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NumberGenerator</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> count = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">synchronized</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">next</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> count++; } }</code> </pre> <br>  Une instance de ce bean est cr√©√©e dans la sous-configuration GeneratorsConfiguration. <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GeneratorsConfiguration</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> NumberGenerator </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">numberGenerator</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NumberGenerator(); } ... }</code> </pre> <br>  Toujours dans le contexte d'application externe, il existe une configuration principale dans laquelle toutes les sous-configurations du module externe sont import√©es. <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-meta"><span class="hljs-meta">@Import</span></span>({GeneratorsConfiguration.class, ...}) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ExternalContextConfiguration</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> </pre> <br>  Je vais maintenant donner quelques exemples dans lesquels le bean singleton de la classe NumberGenerator est mal configur√© dans la configuration du contexte d'application actuel. <br><br><h3>  Configuration incorrecte 1. Importation de la configuration principale du contexte d'application externe </h3><br>  La pire d√©cision qui puisse √™tre. <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-meta"><span class="hljs-meta">@Import</span></span>(ExternalContextConfiguration.class) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CurrentContextConfiguration</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> </pre> <br><ul><li>  L'application recr√©e toutes les instances de beans √† partir du contexte d'application externe.  En d'autres termes, une copie de l'ensemble du module externe est cr√©√©e, ce qui affecte la consommation de m√©moire, les performances et le temps de d√©marrage de l'application. </li><li>  Obtenez une copie de NumberGenerator dans le contexte d'application actuel.  Une copie de NumberGenerator a sa propre valeur pour le champ count, incompatible avec la premi√®re instance de NumberGenerator.  Cette incoh√©rence entra√Æne des erreurs difficiles √† d√©boguer dans l'application. </li></ul><br><h3>  Configuration incorrecte 2. Importer la sous-configuration du contexte d'application externe </h3><br>  La deuxi√®me option est incorrecte et souvent rencontr√©e dans la pratique. <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-meta"><span class="hljs-meta">@Import</span></span>(GeneratorsConfiguration.class) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CurrentContextConfiguration</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> </pre> <br>  Dans ce mode de r√©alisation, une copie compl√®te du module externe n'est plus cr√©√©e, cependant, nous obtenons √† nouveau le deuxi√®me bean de la classe NumberGenerator. <br><br><h3>  Configuration incorrecte 3. Recherchez l'injection directement dans le bean, o√π nous voulons utiliser NumberGenerator </h3><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OrderFactory</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> NumberGenerator numberGenerator; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OrderFactory</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ ApplicationContext externalApplicationContext = getExternalContext(); numberGenerator = externalApplicationContext.getBean(NumberGenerator.class); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Order </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Order order = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Order(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> id = numberGenerator.next(); order.setId(id); order.setCreatedDate(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Date()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> order; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> ApplicationContext </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getExternalContext</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ ... } }</code> </pre> <br>  Dans cette m√©thode, la duplication d'un bean ayant la port√©e singleton peut √™tre consid√©r√©e comme r√©solue.  En effet, maintenant nous r√©utilisons le bean √† partir d'un autre contexte d'application et ne le recr√©ons pas! <br><br>  Mais de cette fa√ßon: <br><br><ol><li>  Complique la classe d√©velopp√©e et ses tests unitaires. </li><li>  Exclut l'impl√©mentation automatique du bean de la classe NumberGenerator dans les beans du module actuel. </li><li>  Il n'est pas courant d'utiliser lookUp pour injecter un bean singleton dans les cas g√©n√©raux. </li></ol><br>  Par cons√©quent, une telle solution ressemble plus √† une solution de contournement maladroite qu‚Äôune solution rationnelle √† un probl√®me. <br><br>  Consid√©rez comment configurer correctement un bean √† partir d'un contexte d'application externe. <br><br><h3>  Solution 1. Obtenez le bean du contexte d'application externe dans la configuration </h3><br>  Cette m√©thode est tr√®s similaire au 3e exemple d'une configuration incorrecte avec une diff√©rence: nous obtenons un bean en faisant une recherche √† partir du contexte externe dans la configuration, et pas directement dans le bean. <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CurrentContextConfiguration</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> NumberGenerator </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">numberGenerator</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ ApplicationContext externalApplicationContext = getExternalContext(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> externalApplicationContext.getBean(NumberGenerator.class); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> ApplicationContext </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getExternalContext</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ ... } }</code> </pre> <br>  Nous pouvons maintenant int√©grer automatiquement ce bean dans des beans √† partir de notre propre module. <br><br><h3>  Solution 2. Rendre le parent du contexte d'application externe </h3><br>  Il est probable que la fonctionnalit√© du module actuel √©tend la fonctionnalit√© de l'externe.  Il peut y avoir un cas o√π dans l'un des modules externes des beans auxiliaires communs √† l'application enti√®re sont d√©velopp√©s, et dans d'autres modules ces beans sont utilis√©s.  Dans ce cas, il est logique d'indiquer que le module externe est parent du pr√©c√©dent.  Dans ce cas, tout le bean du module parent peut √™tre utilis√© dans le module actuel, puis le <i>bean du module parent n'a pas besoin d'√™tre configur√©</i> dans la configuration du contexte d'application actuel. <br><br>  Il est possible de sp√©cifier une relation parent lors de la cr√©ation d'une instance de contexte √† l'aide du constructeur avec le param√®tre parent: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AbstractApplicationContext</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ApplicationContext parent)</span></span></span><span class="hljs-function"> </span></span>{ ... }</code> </pre> <br>  Ou utilisez le setter: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setParent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ApplicationContext parent)</span></span></span><span class="hljs-function"> </span></span>{ ... }</code> </pre> <br>  Si le contexte d'application est d√©clar√© en xml, nous pouvons utiliser le constructeur: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ClassPathXmlApplicationContext</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] configLocations, ApplicationContext parent)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> BeansException </span></span>{ ... }</code> </pre> <br><h3>  Conclusion </h3><br>  Par cons√©quent, soyez prudent lorsque vous configurez des beans ressort, suivez les recommandations de l'article et essayez de ne pas copier les beans qui ont une port√©e singleton.  Je me ferai un plaisir de r√©pondre √† vos questions! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr472716/">https://habr.com/ru/post/fr472716/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr472690/index.html">Nouveaut√©s de Zabbix 4.4</a></li>
<li><a href="../fr472694/index.html">Plus que Ceph: MCS Block Cloud Storage</a></li>
<li><a href="../fr472702/index.html">JH Rainwater ¬´Comment faire pa√Ætre les chats¬ª: races de programmeurs et caract√©ristiques de leur √©levage</a></li>
<li><a href="../fr472708/index.html">Imperva a r√©v√©l√© les d√©tails techniques du hack Cloud WAF</a></li>
<li><a href="../fr472714/index.html">O√π trouver le travailleur frontal pour chercher du travail et ne pas tomber amoureux: T√©l√©gramme, Slack et pas seulement</a></li>
<li><a href="../fr472720/index.html">L'ERP ne fonctionne pas ... Quelle est l'alternative? ou juste √† temps. Pour la Russie?</a></li>
<li><a href="../fr472724/index.html">Introduction √† skydive.network</a></li>
<li><a href="../fr472726/index.html">Am√©lioration de l'immunit√© au bruit Arduino</a></li>
<li><a href="../fr472730/index.html">Ivanovo! Mitap en l'honneur du 10e anniversaire de Node.js</a></li>
<li><a href="../fr472736/index.html">Webinaire ouvert "Introduction √† l'automatisation des tests d'applications mobiles sur S√©l√©nium et Appium"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>