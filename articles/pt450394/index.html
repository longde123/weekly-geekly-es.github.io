<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üõÑ üìï üßïüèª Investiga√ß√£o de um arquivo desconhecido ‚öîÔ∏è ü§πüèº üë™</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Realoca√ß√£o. Nova cidade. Procura de emprego. Mesmo para um profissional de TI, isso pode levar muito tempo. Uma s√©rie de entrevistas, que, em geral, s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Investiga√ß√£o de um arquivo desconhecido</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/450394/">  Realoca√ß√£o.  Nova cidade.  Procura de emprego.  Mesmo para um profissional de TI, isso pode levar muito tempo.  Uma s√©rie de entrevistas, que, em geral, s√£o muito semelhantes entre si.  E como normalmente acontece quando voc√™ j√° encontra um emprego, depois de um tempo, um escrit√≥rio interessante √© anunciado. <br><br>  Era dif√≠cil entender o que ela estava fazendo especificamente, no entanto, sua √°rea de interesse era o estudo de software de outras pessoas.  Parece intrigante, embora quando voc√™ percebe que esse n√£o parece um fornecedor que libera software para seguran√ßa cibern√©tica, voc√™ p√°ra por um segundo e come√ßa a co√ßar os nabos. <br><br><img src="https://lh3.googleusercontent.com/Wm2cSc19nc9XsapzlEW-eGMZBZCEgSbZFCSj6hdNNlkqCa40ksCXrYv8ual-VfYF3rcn5OoM9X2OwIJY07u_dD5Lo_7mzZU4D7rQuu164GIDE2_IjBu_J1dIMsjD4uDgyep3yipN"><br><a name="habracut"></a><br>  Resumindo: eles descartaram o arquivo e se ofereceram para examin√°-lo como uma tarefa de teste e tentar calcular uma certa assinatura com base nos dados de entrada apresentados.  Vale a pena notar que eu tinha muito pouca experi√™ncia em tais atividades e, provavelmente, √© por isso que na primeira itera√ß√£o da solu√ß√£o eu s√≥ tinha algumas horas - ent√£o a motiva√ß√£o para fazer isso n√£o deu em nada.  E sim, claro, a primeira coisa que tentei execut√°-lo no telefone / emulador - esse aplicativo √© inv√°lido. <br><br>  <b>O que temos: um</b> arquivo com a extens√£o <b>".apk"</b> .  Coloquei a tarefa por baixo do spoiler para que n√£o fosse indexada pelos mecanismos de busca: e se os caras n√£o gostarem, eu coloco a solu√ß√£o no Habr? <br><br><div class="spoiler">  <b class="spoiler_title">Tarefa em si</b> <div class="spoiler_text">  O APK cont√©m funcionalidade para gerar assinaturas para uma matriz associativa. <br>  Tente obter uma assinatura para o seguinte conjunto de dados: <br><br><pre><code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"user"</span></span> : <span class="hljs-string"><span class="hljs-string">"LeetD3vM4st3R"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"password"</span></span>: <span class="hljs-string"><span class="hljs-string">"__s33cr$$tV4lu3__"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"hash"</span></span>: <span class="hljs-string"><span class="hljs-string">"34765983265937875692356935636464"</span></span> }</code> </pre> <br></div></div><br><h2>  Arrega√ßar as mangas </h2><br>  Diz-se que o arquivo cont√©m a funcionalidade de assinar uma matriz associativa.  Pela extens√£o do arquivo, entendemos imediatamente que estamos lidando com um aplicativo escrito para Android.  Primeiro, descompactamos o arquivo.  De fato, este √© um arquivo ZIP comum, e qualquer arquivador ir√° lidar com ele de √¢nimo leve.  Usei o utilit√°rio apktool e, como se viu, ignorou acidentalmente alguns ancinhos.  Sim, acontece (geralmente o oposto, sim?).  O feiti√ßo √© bem simples: <br><br><pre> <code class="bash hljs">apktool d task.zip</code> </pre> <br>  Acontece que o c√≥digo e os recursos no arquivo apk tamb√©m s√£o armazenados compactados em bin√°rios separados e ser√° necess√°rio outro software para extra√≠-los.  O apktool retirou implicitamente os bytes da classe, os recursos e decomp√¥s tudo em uma hierarquia de arquivos natural.  Voc√™ pode prosseguir. <br><br><pre> <code class="bash hljs">‚îú‚îÄ‚îÄ AndroidManifest.xml ‚îú‚îÄ‚îÄ apktool.yml ‚îú‚îÄ‚îÄ lib ‚îÇ   ‚îî‚îÄ‚îÄ arm64-v8a ‚îú‚îÄ‚îÄ original ‚îÇ   ‚îú‚îÄ‚îÄ AndroidManifest.xml ‚îÇ   ‚îî‚îÄ‚îÄ META-INF ‚îú‚îÄ‚îÄ res ‚îÇ   ‚îú‚îÄ‚îÄ anim ‚îÇ   ‚îú‚îÄ‚îÄ color ‚îÇ   ‚îú‚îÄ‚îÄ drawable ‚îÇ   ‚îú‚îÄ‚îÄ layout ‚îÇ   ‚îú‚îÄ‚îÄ layout-watch-v20 ‚îÇ   ‚îú‚îÄ‚îÄ mipmap-anydpi-v26 ‚îÇ   ‚îú‚îÄ‚îÄ values ‚îÇ   ‚îî‚îÄ‚îÄ values-af ‚îú‚îÄ‚îÄ smali ‚îÇ   ‚îú‚îÄ‚îÄ android ‚îÇ   ‚îú‚îÄ‚îÄ butterknife ‚îÇ   ‚îú‚îÄ‚îÄ com ‚îÇ   ‚îú‚îÄ‚îÄ net ‚îÇ   ‚îî‚îÄ‚îÄ org ‚îî‚îÄ‚îÄ unknown   ‚îî‚îÄ‚îÄ org</code> </pre> <br>  Vemos uma hierarquia semelhante (deixou sua vers√£o simplificada) e estamos tentando descobrir por onde come√ßar.  Vale a pena notar que, no entanto, uma vez eu escrevi alguns aplicativos pequenos para Android, portanto, a ess√™ncia de parte dos diret√≥rios e, em geral, os princ√≠pios dos aplicativos para dispositivos Android, s√£o aproximadamente claros para mim. <br><br>  Para come√ßar, decido apenas "percorrer" os arquivos.  Abro o AndroidManifest.xml e come√ßo a ler de forma significativa.  Minha aten√ß√£o √© atra√≠da por um atributo estranho <br><br><pre> <code class="xml hljs">android:supportsRtl="true"</code> </pre> <br>  Acontece que ele √© respons√°vel pelo suporte a idiomas com a letra "da direita para a esquerda" no aplicativo.  Come√ßamos a nos esfor√ßar.  N√£o √© bom <br><br>  Al√©m disso, meu olhar se apega √† pasta desconhecida.  Abaixo dele, h√° uma hierarquia no formato: <b>org.apache.commons.codec.language.bm</b> e um grande n√∫mero de arquivos de texto com conte√∫do obscuro.  Pesquise no Google o nome completo do pacote e o que est√° armazenado aqui, algo relacionado ao algoritmo de busca por palavras foneticamente semelhantes ao dado.  Francamente, aqui comecei a me esfor√ßar mais.  Tendo vasculhado um pouco os diret√≥rios, encontrei o c√≥digo em si e a divers√£o come√ßou.  Fui recebido n√£o pelo c√≥digo de c√≥digo Java habitual, com o qual consegui brincar, mas por outra coisa.  Muito parecido, mas diferente. <br><br>  Como se viu, o Android tem sua pr√≥pria m√°quina virtual - Dalvik.  E, como toda m√°quina virtual respeitada, ela tem seu pr√≥prio bytecode.  Parece que na primeira tentativa de resolver esse problema, foi com essa triste nota que anunciei o intervalo, fiz uma rever√™ncia, abaixei a cortina e joguei tudo por 4 meses at√© que minha curiosidade me acabasse completamente. <br><br><h2>  Arregace as mangas [2] </h2><br>  "Mas n√£o √© poss√≠vel que tudo fique mais f√°cil?"  - Essa √© a pergunta que me fiz quando iniciei a tarefa pela segunda vez.  Comecei a pesquisar na internet um descompilador de smali para Java.  Vi apenas que √© imposs√≠vel realizar esse processo sem ambiguidade.  Franzindo a testa um pouco, ele foi ao Github e colocou algumas frases-chave na linha de pesquisa.  O primeiro veio <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">smali2java</a> . <br><br><pre> <code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> gradle build java -jar smali2java.jar ..</code> </pre> <br>  Erros  Vejo um enorme rastreamento de pilha e erros em v√°rias p√°ginas do terminal.  Depois de ler um pouco sobre a ess√™ncia do conte√∫do (e restringir as emo√ß√µes pelo tamanho do rastreamento da pilha), acho que essa ferramenta funciona com base em uma certa gram√°tica descrita e o c√≥digo de c√≥digo que ela conheceu claramente n√£o corresponde a ela.  Abro o bytecode smali e vejo anota√ß√µes, m√©todos sint√©ticos e outras constru√ß√µes estranhas nele.  N√£o havia tal coisa no bytecode Java!  Quanto tempo?  Excluir! <br><br><div class="spoiler">  <b class="spoiler_title">Mais detalhes</b> <div class="spoiler_text">  A m√°quina virtual Dalvik (assim como a JVM), como se viu, n√£o est√° ciente da exist√™ncia de conceitos como classes internas / externas (leia classes aninhadas), e o compilador gera os chamados m√©todos "sint√©ticos" para fornecer acesso da classe aninhada para campos externos, por exemplo. <br><br><h4>  Como exemplo: </h4><br>  Se a classe externa (OuterClass) tiver um campo <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OuterClass</span></span></span><span class="hljs-class"> </span></span>{ List a; ... }</code> </pre> <br>  Para que a classe privada possa acessar o campo da classe externa, o compilador gerar√° implicitamente o seguinte m√©todo: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> synthetic java.util.<span class="hljs-function"><span class="hljs-function">List </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getList</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(OuterClass p1)</span></span></span><span class="hljs-function"> </span></span>{ p1 = p1.a; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> p1; }</code> </pre> <br>  Al√©m disso, devido a essa cozinha de ‚Äúcompartimento do motor‚Äù, o trabalho de alguns outros mecanismos que a linguagem fornece √© alcan√ßado. <br><br>  Voc√™ pode come√ßar a estudar essa quest√£o em mais detalhes a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">partir daqui</a> . </div></div><br>  N√£o ajuda  Ele at√© jura por um c√≥digo de c√≥digo aparentemente n√£o suspeito.  Abro o c√≥digo-fonte do descompilador, leio e vejo algo muito estranho: mesmo programadores hindus (com todo o respeito) n√£o teriam escrito isso.  Um pensamento surge: n√£o √© realmente o c√≥digo gerado.  Rejeito a ideia por cerca de 30 minutos, tentando entender qual √© o erro.  COMPLICADO.  Abro o Github novamente - e realmente, um analisador de gram√°tica.  E aqui est√° o pr√≥prio gerador.  Pondo tudo de lado e tentando se aproximar do outro lado. <br><br>  <i>Vale a pena notar que, um pouco mais tarde, ainda tentei mudar a gram√°tica e, em alguns lugares, at√© o pr√≥prio bytecode para que o descompilador ainda pudesse digeri-lo.</i>  <i>Mas mesmo quando o bytecode se tornou v√°lido em termos de gram√°tica do descompilador, o programa simplesmente n√£o retornou nada para mim.</i>  <i>C√≥digo aberto ...</i> <br><br>  Folheio o bytecode e trope√ßo em constantes desconhecidas para mim.  No Google, encontro o mesmo no livro sobre aplicativos reversos para Android.  Lembro que esse √© apenas o ID atribu√≠do pelo pr√©-processador do compilador, atribu√≠do aos recursos do aplicativo Android (a constante de tempo de grava√ß√£o de c√≥digo √© R. *).  Na pr√≥xima meia hora - hora, examinarei brevemente quais registros s√£o respons√°veis ‚Äã‚Äãpor qu√™, em que ordem os argumentos s√£o passados ‚Äã‚Äãe, em geral, nos aprofundamos na sintaxe. <br><br><h2>  Como √© isso? </h2><br><img src="https://lh4.googleusercontent.com/6vy-LnmhLmjl2TnDiAoA632c026jlrPG7zFlclZNXJRdpethXv_iFjRtzwyvQWrqkd1LUKixzHfzXAyDj4c28JAzqVYTmP9uqJTmUYgjJd8Yx5pEDkd0cad34bNg9LYDf3r2jFVj" width="350" height="496" align="left">  Encontrei o layout da janela principal do aplicativo e, a partir dele, j√° entendi o que estava acontecendo no aplicativo: na tela principal (Activity) existe um RecyclerView (condicionalmente, um View que pode reutilizar objetos da interface do usu√°rio que n√£o s√£o exibidos atualmente para utiliza√ß√£o da mem√≥ria) com campos de entrada pares chave / valor, alguns bot√µes respons√°veis ‚Äã‚Äãpor adicionar um novo par chave / valor a um determinado cont√™iner abstrato e um bot√£o que gera uma assinatura (assinatura) para esse cont√™iner. <br><br>  Observando as anota√ß√µes e observando uma certa quantidade de c√≥digo suspeitamente semelhante √† gerada, come√ßo a pesquisar no Google.  O projeto usa a biblioteca ButterKnife, que permite o uso de anota√ß√µes para <b>aumentar</b> automaticamente os elementos da interface do usu√°rio <b>() -&gt; bind ()</b> .  Se houver anota√ß√µes na classe, o processador de anota√ß√£o ButterKnife implicitamente cria outra classe de fich√°rios no formato <b>&lt;original_class&gt; __ViewBinding</b> , que faz todo o trabalho sujo por baixo do cap√¥.  Na verdade, obtive todas essas informa√ß√µes em apenas um arquivo MainActivity depois de recriar manualmente a semelhan√ßa da fonte Java.  Depois de meia hora, percebi que as anota√ß√µes dessa biblioteca tamb√©m podem definir um retorno de chamada nas a√ß√µes dos bot√µes e encontrei as principais fun√ß√µes que eram realmente respons√°veis ‚Äã‚Äãpor adicionar um par de chave / valor ao cont√™iner e gerar uma assinatura. <br><br>  <i>√â claro que, durante o estudo, eu tive que entrar nas "miudezas" de v√°rias bibliotecas e plugins, porque mesmo belos landos com cookies n√£o cobrem todos os casos de uso e detalhes, o que para qualquer "inversor", eu acho, √© uma pr√°tica comum.</i> <br><br><h2>  Pregui√ßa √© amigo de um programador </h2><br>  Depois de passar mais algum tempo na segunda fonte, fiquei completamente cansado e percebi que n√£o era poss√≠vel cozinhar mingau.  Estou subindo no Github novamente e desta vez estou olhando mais de perto.  Acho o projeto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Smali2PsuedoJava</a> - um decompilador em "c√≥digo pseudo-Java".  Mesmo que esse utilit√°rio, pelo menos alguma coisa possa levar a uma apar√™ncia humana, ent√£o para mim o autor √© uma caneca de sua cerveja favorita (bem, ou pelo menos coloque um asterisco no Github, para iniciantes). <br><br>  E realmente funciona!  Efeito no rosto: <br><br><img src="https://lh6.googleusercontent.com/4yxBPy1Wt7_J7uLey66rp_qHwomfvAW_B1C6g3CsrS0DR73J_U42t4JgobNaGIUXVstTEVIaHriawFfRVZL4IqUEObjCL8RdLUv5VCGKiv_jeAxBclaXZlsMvmFUzFuuuuxfshw7"><br><br><h2>  Conhe√ßa Cipher.so </h2><br>  Um pouco mais tarde, estudando o pseudo-c√≥digo Java do projeto e comparando-o incrivelmente com o bytecode smali, encontro uma biblioteca estranha no c√≥digo - Cipher.so.  Pesquisando no Google, descobri que √© a criptografia de um conjunto de valores de tempo de compila√ß√£o dentro do arquivo APK.  Isso geralmente √© necess√°rio quando o aplicativo usa constantes do formul√°rio: endere√ßos IP, credenciais para um banco de dados externo, tokens para autoriza√ß√£o etc.  - o que pode ser obtido com a ajuda da engenharia reversa do aplicativo.  √â verdade que o autor escreve claramente que esse projeto √© abandonado, dizem eles, desaparece.  Isso est√° ficando interessante. <br><br>  Essa biblioteca fornece acesso aos valores por meio da biblioteca Java, onde o m√©todo espec√≠fico √© a chave de seu interesse.  Isso apenas alimenta meu interesse e come√ßo a subir mais fundo. <br><br>  Em resumo, o que o Cipher.so faz e como funciona: <br><br><ul><li>  no arquivo Gradle do nosso projeto, as chaves e os valores correspondentes s√£o registrados <br></li><li>  todos os valores-chave ser√£o compactados automaticamente em uma biblioteca din√¢mica separada (.so), que ser√° gerada no momento da compila√ß√£o.  Sim - sim, SER√Å gerado. <br></li><li>  essas chaves podem ser obtidas dos m√©todos Java gerados pelo Cipher.so <br></li><li>  depois de criar o APK, os nomes das chaves s√£o divididos em hash pelo MD5 (para maior seguran√ßa, √© claro) <br></li></ul><br>  Tendo encontrado a biblioteca din√¢mica de que preciso na pasta de arquivamento, prossigo para selecion√°-la.  Para come√ßar, como um reverso experiente (n√£o), tento come√ßar com um simples - decido olhar para a se√ß√£o com constantes e para linhas interessantes em um bin√°rio semelhante a ELF.  Infelizmente, os usu√°rios do mac prontamente ausentes est√£o faltando e, antes do in√≠cio, dizemos o querido: <br><br><pre> <code class="bash hljs">brew install binuitls</code> </pre> <br>  E n√£o se esque√ßa de escrever o caminho para <b>/ usr / local</b> no PATH, porque o <i>brew o</i> protege de tudo de maneira gentil ... <br><br><pre> <code class="bash hljs">greadelf -p .rodata lib/arm64-v8a/libcipher-lib.so | head -n 15</code> </pre> <br>  Limitamos a sa√≠da √†s 15 primeiras linhas; caso contr√°rio, isso pode causar choque para um engenheiro despreparado. <br><br><img src="https://lh6.googleusercontent.com/-ka6awAjaQ6zTDJ4sogEHaqBEG2QL3il5HTS1M-HchKGBg4hK5qe__lAtEKtcL7CT0i_lhqtiEZYYRsnTpLmbc10hdpVTMcAeRP0bGJE87jUBvtkncNMJ3s5YtjgGXk0duZeHIrY"><br><br>  Nos endere√ßos inferiores, notamos linhas suspeitas.  Como descobri, estudando as fontes do Cipher.so, as chaves e os valores s√£o colocados no <b>std :: map</b> usual <b>:</b> isso fornece pouca informa√ß√£o, mas sabemos que no binar junto com as senhas criptografadas tamb√©m existem chaves ofuscadas. <br><br>  Como √© a criptografia de valores?  Estudando a fonte, descobri que a criptografia ocorre usando o AES - o sistema de criptografia sim√©trica padr√£o.  Portanto, se houver valores criptografados, a chave deve estar pr√≥xima ... Depois de estud√°-la por um tempo, deparei-me com um problema no mesmo projeto com o provocativo t√≠tulo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">‚ÄúArmazenamento inseguro de chaves: segredos s√£o muito f√°ceis de recuperar‚Äù</a> .  De fato, descobri que a chave est√° armazenada de forma clara no binar e encontrei o algoritmo de descriptografia.  No exemplo, a chave estava no endere√ßo zero e, embora eu entenda que o compilador possa coloc√°-lo em outro lugar na se√ß√£o .rodata do arquivo bin√°rio, decidi que essa unidade suspeita no endere√ßo zero √© a chave. <br><br>  <b>Tentativa 1: procuro</b> decifrar os valores e acredito que a chave de criptografia √© a mesma.  O erro  O OpenSSL sugere que algo n√£o est√° certo.  Depois de ler as fontes de Cipher.so um pouco, entendo que, se o usu√°rio n√£o especificar uma chave durante a montagem, a chave padr√£o ser√° usada - <i>Cipher.so@DEFAULT</i> . <br><br>  <b>Tentativa 2:</b> Erro novamente.  Hmm ... √â realmente redefinido por esta constante?  √â muito simples cometer um erro: c√≥digo confuso escrito em Gradle, com formata√ß√£o "sumida".  Eu verifico novamente.  Tudo parece ser assim. <br><br>  Em vez das chaves est√£o os hashes MD5, e ent√£o tento tentar a sorte e abrir um servi√ßo com tabelas arco-√≠ris.  Voila - uma das chaves √© a palavra "senha".  N√£o h√° segundo.  D√°-nos, √© claro, n√£o muito.  Ambas as chaves est√£o nos endere√ßos 240 e 2a2, respectivamente.  Em princ√≠pio, √© f√°cil reconhec√™-los imediatamente - 32 caracteres (MD5). <br><br>  Eu verifiquei tudo de novo e tentei descriptografar com todas as outras linhas (que est√£o nos endere√ßos inferiores) como uma chave para descriptografia - tudo √© em v√£o. <br>  Portanto, h√° outra chave secreta, o algoritmo de a√ß√µes parece estar correto.  Jogo essa tarefa de lado e tento n√£o me enterrar. <br><br>  Tendo vasculhado um pouco o algoritmo de assinatura do cont√™iner, ainda vejo chamadas para a biblioteca e c√≥digo Cipher.so que tamb√©m usam as fun√ß√µes criptogr√°ficas da biblioteca Java. <br><br><h2>  Um enigma (que eu nunca resolvi) </h2><br>  Na fun√ß√£o respons√°vel pela criptografia, no in√≠cio h√° uma verifica√ß√£o de chaves no cont√™iner. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] a(java/util/Map p1) { v0 = p1.size() v1 = <span class="hljs-number"><span class="hljs-number">0x0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (v0 != <span class="hljs-number"><span class="hljs-number">0</span></span>) goto :cond_0 p1 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[v1]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> p1; :cond_0 v0 = <span class="hljs-string"><span class="hljs-string">"user"</span></span>; v0 = p1.containsKey(v0) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (v0 == <span class="hljs-number"><span class="hljs-number">0</span></span>) goto :cond_1 p1 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[v1]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> p1; ...</code> </pre><br>  Literalmente: se houver uma chave "usu√°rio", esse cont√™iner n√£o ser√° assinado (uma assinatura zero ser√° retornada).  Um sentimento estranho: parece que o problema est√° resolvido, mas parece de alguma forma simples.  Ent√£o, por que inventar todo o resto?  Desviar-se?  Ent√£o, por que n√£o estudei esse c√≥digo fluentemente antes?  Hmm ... <br><br>  N√£o, n√£o √© verdade.  Especifiquei a resposta de um determinado usu√°rio em um messenger azul, cujos contatos me foram fornecidos ao atribuir a tarefa.  Cavando mais.  Talvez a chave / valor de entrada definido de alguma forma seja alterado √† medida que √© adicionado ao cont√™iner?  Eu li o c√≥digo com cuidado. <br><br>  Observe que o descompilador removeu anota√ß√µes do c√≥digo smali.  E se ele removeu algo importante?  Eu verifico os arquivos principais - ao que parece, nada significativo.  Tudo importante est√° no lugar, mas o significado n√£o est√° perdido.  Verifico as fun√ß√µes de retorno de chamada respons√°veis ‚Äã‚Äãpor escrever um par de chave / valor do TextBox condicional para cont√™ineres internos.  N√£o encontrei nada de criminoso. <br><br>  Tornei-me o mais c√©tico poss√≠vel sobre cada linha de c√≥digo - n√£o posso mais confiar em ningu√©m. <br><br>  Solu√ß√£o simples # 2: notei que o procedimento de assinatura come√ßa verificando a presen√ßa de algum valor (substring na cadeia de caracteres) na assinatura do certificado com o qual o aplicativo foi assinado. <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@OnClick</span></span> <span class="hljs-comment"><span class="hljs-comment">//   protected void huvot324yo873yvo837yvo() { String signature = "no data"; boolean result = some_packages.isKeyInSignature(this); if result { Map map = new HashMap(); ...</span></span></code> </pre> <br>  O significado em si, √© claro, est√° criptografado naquele bin√°rio infeliz.  E, na verdade, se esse valor n√£o estiver na assinatura, o algoritmo n√£o assinar√° nada, mas simplesmente retornar√° a string "no data", como a assinatura ... Novamente, somos escolhidos para Cipher ... <br><br><h2>  Luta final de descriptografia de chaves </h2><br>  Para entender a escala da trag√©dia, fiquei confuso assim: <br><br>  Fiz um despejo hexagonal desta se√ß√£o e espiei as duas primeiras linhas, cujas suspeitas n√£o desapareceram desde o in√≠cio. <br><br><img src="https://lh4.googleusercontent.com/J4lmChj6kk0lWWy23D8QngSgnJlNfd-xDP1XyBnw1wyQ_U1NBRLYyx2BFZ4y9D1HXEjcSeCKVvZC3xgVCpx-VSV0bIHD5dcmsfdaX4jrmH-uRFsRMc9VJrqpUEMDEEaijeSTPRbk"><br><br>  Se voc√™ prestar aten√ß√£o, o caractere que separa as linhas aqui √© '0x00'.  Tamb√©m √© comumente usado pela biblioteca C padr√£o, em fun√ß√µes de string.  Por isso n√£o √© menos interessante, que tipo de caractere de espa√ßo est√° no meio da primeira linha?  Em seguida, tentativas malucas come√ßam, onde est√° a chave: <br><br><ul><li>  primeira linha inteira <br></li><li>  primeira linha antes do espa√ßo <br></li><li>  primeira linha do espa√ßo at√© o fim <br></li><li>  ... <br></li></ul><br>  O grau de paran√≥ia j√° pode ser estimado.  Quando voc√™ n√£o entende o qu√£o dif√≠cil e astuta a tarefa deve ser, come√ßa a dirigir.  E, no entanto, n√£o √© isso.  Ent√£o, o pensamento veio √† minha mente: ‚ÄúO algoritmo funciona corretamente devido a problemas na minha m√°quina?‚Äù.  Em geral, a sequ√™ncia de a√ß√µes √© l√≥gica e n√£o levantou quest√µes, mas a pergunta √©: os comandos na minha m√°quina fazem o que √© necess√°rio?  Ent√£o o que voc√™ acha? <br><br>  Depois de verificar todas as etapas manualmente, verificou-se que <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"some_base64_input"</span></span> | openssl base64 -d</code> </pre> <br>  em alguns argumentos de entrada, ele repentinamente retorna uma string vazia.  Hmm. <br><br>  Substituindo-o pelo primeiro decodificador base64 na m√°quina e classificando os candidatos principais, uma chave adequada foi encontrada imediatamente e as chaves foram descriptografadas de acordo. <br><br><h2>  Recuperando assinaturas de um certificado </h2><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isKeyInSignature</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(android.content.Context p1)</span></span></span><span class="hljs-function"> </span></span>{ v0 = <span class="hljs-number"><span class="hljs-number">0x0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> TRY_0{ v1 = p1.getPackageManager() p0 = p1.getPackageName() v2 = <span class="hljs-number"><span class="hljs-number">0x40</span></span>; <span class="hljs-comment"><span class="hljs-comment">// GET_SIGNATURES PackageInfo p0 = v1.getPackageInfo(p0, v2) android.content.pm.Signature[] p0 = p0.signatures; // Order are not guaranteed v1 = p0.length; v2 = 0x0; :goto_0 if (v2 &gt;= v1) goto :cond_1 v3 = p0[v2]; String v3 = v3.toCharsString() String v4 = net.idik.lib.cipher.so.CipherClient.a() v3 = v3.contains(v4) }TRY_0 catch TRY_0 (android/content/pm/PackageManager$NameNotFoundException) goto :catch_0; if (v3 == 0) goto :cond_0 p1 = 0x1; return p1; :cond_0 v2 = v2 + 0x1; goto :goto_0 :catch_0 p0 = Thrown Exception p1.printStackTrace() :cond_1 return v0; }</span></span></code> </pre> <br>  √â assim que o pseudoc√≥digo gerado se parece com minhas edi√ß√µes menores.  Confunde algumas coisas: <br><br><ul><li>  pouco conhecimento de criptografia e a "cozinha" dos certificados do dispositivo <br></li><li>  de acordo com a documenta√ß√£o, esse m√©todo n√£o garante a ordem dos certificados na cole√ß√£o retornada e, portanto, n√£o seria poss√≠vel fazer um loop na mesma ordem - e se o aplicativo fosse assinado com mais de um certificado? <br></li><li>  falta de conhecimento sobre como extrair o certificado do APK, j√° que n√£o est√° claro o que o Android Runtime faz neste caso <br></li></ul><br>  Eu tive que me aprofundar em todos esses problemas e o resultado foi o seguinte: <br><br><ul><li>  o pr√≥prio certificado est√° no diret√≥rio <i>original / META-INF / CERT.RSA</i> <i><br></i> <br>  neste diret√≥rio, existe apenas um arquivo com esta extens√£o - o que significa que o aplicativo √© assinado com apenas um certificado <br></li><li>  No site sobre engenharia de pesquisa de aplicativos Android, foi encontrada uma lista que pode extrair a assinatura necess√°ria como o Android.  Segundo o autor, pelo menos. <br></li></ul><br>  Ao executar esse c√≥digo, posso descobrir a assinatura e, na realidade, a chave que precisamos √© uma substring.  V√° em frente.  A Solu√ß√£o Simples # 2 est√° sendo varrida. <br><br>  De fato, a chave est√° no certificado, resta apenas entender o que vem a seguir, porque se tivermos a chave de "usu√°rio", todos receberemos uma assinatura zero e, como aprendemos acima, esta √© a resposta errada. <br><br><h2>  Escreva a documenta√ß√£o com cuidado! </h2><br>  Pesquisas adicionais sobre o fato de os dados inseridos nos campos de texto serem alterados s√£o descartadas por falta de evid√™ncia.  A paran√≥ia rola com vigor renovado: talvez o c√≥digo que retirou a assinatura do certificado esteja incorreto ou seja uma implementa√ß√£o de c√≥digo para vers√µes antigas do Android?  Abro a documenta√ß√£o novamente e vejo o seguinte: ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://developer.android.com/reference/android/content/pm/Signature.html#toChars ()</a> ): <br><br><img src="https://lh5.googleusercontent.com/1TZ3rj6hzTEWw5YHEl1EWnANjsiqpzGR-tTrXP_Nc6jt42ANPf1QW-fmP-mh7Y2MhgMcZF0Z8CpskzT_ge65C0YCcryiWjjpG0UuPeqkUCsde1qcQgm5NbeqFj4KO3QkdtvHM3v2"><br><br>  <b>Nota: a</b> fun√ß√£o codifica a assinatura como texto ASCII.  A sa√≠da que recebi acima foi uma representa√ß√£o hexadecimal dos dados.  Essa API me pareceu estranha, mas se voc√™ acredita na documenta√ß√£o, acontece que fiquei paralisada novamente e a chave criptografada n√£o √© uma substring da assinatura.  Depois de ficar pensando um pouco no c√≥digo por um tempo, n√£o aguentei mais e abri o c√≥digo-fonte para esta classe.  <a href="">https://android.googlesource.com/platform/frameworks/base/+/e639da7/core/java/android/content/pm/Signature.java</a> <br><br>  A resposta n√£o demorou a chegar.  E, na verdade, no pr√≥prio c√≥digo - uma pintura a √≥leo: o formato de sa√≠da √© uma sequ√™ncia hexadecimal comum.  E agora pense: ou eu n√£o entendo alguma coisa ou a documenta√ß√£o est√° escrita "ligeiramente" incorretamente.  Tendo repreendido de maneira alguma, comecei a trabalhar novamente. <br><br><h2>  Sum√°rio </h2><br>  As seguintes n horas se passaram: <br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">verificar a corre√ß√£o do trabalho no c√≥digo com o RecyclerView e verificar seu comportamento atrav√©s do c√≥digo-fonte desde </font><font style="vertical-align: inherit;">Novamente, nem todos os pontos s√£o abordados em detalhes no dock e mesmo no Stackoverflow</font></font><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">descompila√ß√£o manual do fragmento de c√≥digo respons√°vel por assinar a cole√ß√£o no Java compilado. </font><font style="vertical-align: inherit;">Eu assumi a suposi√ß√£o de que ainda perdi algo e a primeira chave no cont√™iner ("usu√°rio") foi eliminada implicitamente da cole√ß√£o. </font><font style="vertical-align: inherit;">Decidi definir o restante dos dados no c√≥digo.</font></font><br></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Em geral, esse c√≥digo se recusou a assinar at√© os argumentos restantes (al√©m disso, ao trabalhar com criptografia, esses argumentos me jogaram implicitamente √† dist√¢ncia). </font></font><br><br>  N√£o.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Acabou que voc√™ n√£o pode assinar esta entrada. Infelizmente, n√£o poderei aprovar este trabalho e descobrir se realmente √© assim. Que pena. Por um tempo, ocupou meus pensamentos, mas me tranquilizei de ter feito tudo o que pude. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Na verdade, passei muito tempo nessa tarefa e, ao mesmo tempo, na restaura√ß√£o de lacunas de conhecimento. Foi realmente √∫til. Voc√™ pode rastrear todo o caminho e prestar aten√ß√£o em como eu me apeguei a partes absolutamente n√£o-decis√≥rias. Talvez isso ajude algu√©m a entender como os iniciantes resolvem problemas desse tipo, porque geralmente lemos ‚Äúhist√≥rias de sucesso‚Äù, onde todas as etapas s√£o l√≥gicas, consistentes e levam ao resultado certo.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se algu√©m quiser tentar aprofundar um pouco mais essa tarefa ou fazer uma pergunta - escreva-me no mensageiro azul </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">arturbrsg</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fique atento.</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt450394/">https://habr.com/ru/post/pt450394/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt450374/index.html">Placa de expans√£o RAM para Apple IIgs</a></li>
<li><a href="../pt450376/index.html">Como o Yandex.Taxi procura carros quando n√£o est√£o</a></li>
<li><a href="../pt450378/index.html">GitLab 11.10</a></li>
<li><a href="../pt450384/index.html">A hist√≥ria de um pequeno estudo de c√≥digo legado</a></li>
<li><a href="../pt450386/index.html">Interfaces como tipos de dados abstratos no Go</a></li>
<li><a href="../pt450396/index.html">Como melhorar o seu ingl√™s escrito: dicas pr√°ticas e ferramentas √∫teis</a></li>
<li><a href="../pt450398/index.html">Os venenos mais destemidos</a></li>
<li><a href="../pt450410/index.html">Terraformer - Infraestrutura para codificar</a></li>
<li><a href="../pt450416/index.html">Como os provedores de VPN de shareware vendem seus dados</a></li>
<li><a href="../pt450418/index.html">A arte de criar modelos 3D org√¢nicos: Shaders subd√©rmicos</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>