<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üê¨ üå∏ üóìÔ∏è Cloud Smart Home. Parte 1: Controlador y sensores üß§ üßëüèø‚Äçü§ù‚Äçüßëüèª üéÆ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hoy, gracias al r√°pido desarrollo de la microelectr√≥nica, los canales de comunicaci√≥n, las tecnolog√≠as de Internet y la Inteligencia Artificial, el te...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Cloud Smart Home. Parte 1: Controlador y sensores</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/467219/"><img src="https://habrastorage.org/webt/q6/ni/9k/q6ni9k05gsedjwzqbsyfr_zc7sc.png"><br><br>  Hoy, gracias al r√°pido desarrollo de la microelectr√≥nica, los canales de comunicaci√≥n, las tecnolog√≠as de Internet y la Inteligencia Artificial, el tema de los hogares inteligentes se est√° volviendo cada vez m√°s relevante.  La vivienda humana ha experimentado cambios significativos desde la Edad de Piedra y en la era de la Revoluci√≥n Industrial 4.0 e Internet de las Cosas se volvi√≥ conveniente, funcional y segura.  Llegan al mercado soluciones que convierten un apartamento o una casa de campo en sofisticados sistemas de informaci√≥n administrados desde cualquier parte del mundo utilizando un tel√©fono inteligente.  Adem√°s, el conocimiento de los lenguajes de programaci√≥n ya no es necesario para la interacci√≥n hombre-m√°quina: gracias a los algoritmos de reconocimiento de voz y s√≠ntesis de voz, una persona habla su idioma nativo con un hogar inteligente. <br><br>  Algunos sistemas dom√©sticos inteligentes actualmente en el mercado son un desarrollo l√≥gico de sistemas de videovigilancia basados ‚Äã‚Äãen la nube, cuyos desarrolladores se dieron cuenta de la necesidad de una soluci√≥n integral no solo para el monitoreo, sino tambi√©n para administrar objetos remotos. <br><br>  Le ofrecemos una serie de tres art√≠culos, que le informar√°n sobre todos los componentes principales del sistema de hogar inteligente en la nube, desarrollado personalmente por el autor y puesto en funcionamiento.  El primer art√≠culo est√° dedicado al equipo del cliente terminal instalado dentro de una casa inteligente, el segundo a la arquitectura de un sistema de almacenamiento y procesamiento de datos en la nube, y finalmente, el tercero a una aplicaci√≥n cliente para administrar el sistema en dispositivos m√≥viles y estacionarios. <br><a name="habracut"></a><br><h1>  Equipamiento para el hogar inteligente </h1><br>  Primero, hablemos sobre c√≥mo hacer una casa inteligente a partir de un apartamento, caba√±a o caba√±a ordinaria.  Para esto, como regla, se requiere colocar el siguiente equipo en el hogar: <br><br><ol><li>  sensores que miden varios par√°metros ambientales; </li><li>  actuadores que act√∫an sobre objetos externos; </li><li>  un controlador que realiza c√°lculos de acuerdo con las mediciones del sensor y la l√≥gica integrada, y emite comandos a los actuadores. </li></ol><br>  La siguiente figura muestra el diagrama de una casa inteligente, en la que hay sensores de fugas de agua (1) en el ba√±o, temperatura (2) e iluminaci√≥n (3) en el dormitorio, una toma inteligente (4) en la cocina y una c√°mara de video vigilancia (5) en el pasillo. <br><br><img src="https://habrastorage.org/webt/nq/en/f-/nqenf-epwiuqhsimy3ft2wbyvpo.png"><br><br>  Actualmente, los sensores inal√°mbricos que operan bajo los protocolos RF433, Z-Wave, ZigBee, Bluetooth y WiFi son ampliamente utilizados.  Sus principales ventajas son la facilidad de instalaci√≥n y uso, as√≠ como el bajo costo y la confiabilidad, porque  Los fabricantes buscan llevar sus dispositivos al mercado masivo y ponerlos a disposici√≥n del usuario promedio. <br><br>  Los sensores y actuadores, por regla general, est√°n conectados a trav√©s de una interfaz inal√°mbrica al controlador dom√©stico inteligente (6), un microordenador especializado que integra todos estos dispositivos en una sola red y los controla. <br><br>  Sin embargo, algunas soluciones pueden combinar un sensor, un actuador y un controlador al mismo tiempo.  Por ejemplo, se puede programar una toma inteligente para encender o apagar en un horario, y una c√°mara de videovigilancia basada en la nube puede grabar video en funci√≥n de una se√±al del detector de movimiento.  En los casos m√°s simples, puede prescindir de un controlador separado, pero para crear un sistema flexible con muchos escenarios, es necesario. <br><br>  Para conectar el controlador dom√©stico inteligente a la red global, se puede usar un enrutador de Internet convencional (7), que durante mucho tiempo ha sido un electrodom√©stico familiar en cualquier hogar.  Hay un argumento m√°s a favor del controlador de casa inteligente: si se pierde la conexi√≥n a Internet, la casa inteligente continuar√° funcionando normalmente debido al bloque l√≥gico almacenado dentro del controlador y no en el servicio en la nube. <br><br><h1>  Controlador de casa inteligente </h1><br>  El controlador para el sistema dom√©stico inteligente en la nube discutido en este art√≠culo se desarroll√≥ sobre la base del microordenador de placa √∫nica <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Raspberry Pi 3 modelo B +</a> , que se lanz√≥ en marzo de 2018 y tiene recursos y rendimiento suficientes para las tareas del hogar inteligente.  Consiste en un procesador Cortex-A53 de cuatro n√∫cleos con una arquitectura ARMv8-A de 64 bits, con velocidad de reloj de 1,4 GHz, as√≠ como 1 GB de RAM, Wi-Fi 802.11ac, Bluetooth 4.2 y un adaptador Gigabit Ethernet que funciona a trav√©s del bus USB 2.0. <br><br><img src="https://habrastorage.org/webt/ki/di/-_/kidi-_hdoclhmawxeqcgxvjxnwm.jpeg"><br><br>  Montar el controlador es muy simple: el microordenador (1) se instala en una caja de pl√°stico (2), luego se inserta una tarjeta microSD de 8 GB con software (3) y un controlador de red USB Z-Wave (4) en las ranuras correspondientes.  El controlador dom√©stico inteligente est√° conectado a la red el√©ctrica a trav√©s de un adaptador de corriente de 5V, 2.1A (5) y un cable USB-micro-USB (6).  Cada controlador tiene un n√∫mero de identificaci√≥n √∫nico, que se registra en el archivo de configuraci√≥n en el primer inicio y es necesario para la interacci√≥n con los servicios dom√©sticos inteligentes en la nube. <br><br>  El software de controlador de casa inteligente fue desarrollado por el autor de este art√≠culo basado en el <b>sistema</b> operativo <b>Linux Raspbian Stretch</b> .  Se compone de los siguientes subsistemas principales: <br><br><ul><li>  proceso de servidor para interactuar con equipos dom√©sticos inteligentes y la nube; </li><li>  interfaz gr√°fica de usuario para configurar el controlador y los par√°metros operativos; </li><li>  Bases de datos para almacenar la configuraci√≥n del controlador. </li></ul><br><img src="https://habrastorage.org/webt/s6/lx/k-/s6lxk-xr0gnx8cy5wohn6u8pgqo.png"><br><br>  <b>La base de datos del</b> controlador de casa inteligente se basa en el DBMS incorporado de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">SQLite</a> y es un archivo en la tarjeta SD con el software del sistema.  Sirve como dep√≥sito de la configuraci√≥n del controlador: informaci√≥n sobre el equipo conectado y su estado actual, un bloque de reglas de producci√≥n l√≥gicas, as√≠ como informaci√≥n que requiere indexaci√≥n (por ejemplo, nombres de archivo del archivo de video local).  Cuando se reinicia el controlador, esta informaci√≥n se guarda, lo que hace posible restaurar el controlador en caso de una falla de energ√≠a. <br><br>  <b>La interfaz gr√°fica del</b> controlador dom√©stico inteligente se desarrolla en PHP 7 utilizando el microframework <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Slim</a> .  El servidor web <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://www.lig">lighttpd</a> , que a menudo se usa en dispositivos integrados debido a su buen rendimiento y bajos requisitos de recursos, es responsable de la aplicaci√≥n. <br><br> <a href=""><img src="https://habrastorage.org/webt/p6/jh/w0/p6jhw0khe-pnljdtzf54qjrtgna.png"></a> <br>  <font color="grey">(haga clic en la imagen para abrir en una resoluci√≥n m√°s alta)</font> <br><br>  La funci√≥n principal de la interfaz gr√°fica es conectar equipos dom√©sticos inteligentes (c√°maras IP y sensores) al controlador.  La aplicaci√≥n web lee la configuraci√≥n y el estado actual del controlador y los dispositivos conectados desde la base de datos SQLite.  Para cambiar la configuraci√≥n del controlador, env√≠a comandos de control en formato JSON a trav√©s de la API RESTful del proceso del servidor. <br><br><h1>  Proceso del servidor </h1><br>  <b>El proceso del servidor</b> es un componente clave que hace todo el trabajo b√°sico de automatizar los procesos de informaci√≥n que constituyen la base de un hogar inteligente: recibir y procesar datos sensoriales, emitiendo acciones de control dependiendo de la l√≥gica subyacente.  El prop√≥sito del proceso del servidor es interactuar con el equipo dom√©stico inteligente, seguir las reglas de l√≥gica de producci√≥n, recibir y procesar comandos desde la interfaz gr√°fica y la nube.  El proceso del servidor en este controlador dom√©stico inteligente se implementa como una aplicaci√≥n multiproceso desarrollada en C ++ y lanzada como un servicio <b>systemd</b> separado del <b>sistema</b> operativo <b>Linux Raspbian</b> . <br><br>  Los bloques principales del proceso del servidor son: <br><br><ol><li>  Administrador de mensajes </li><li>  Servidor de c√°mara IP; </li><li>  Servidor de dispositivo Z-Wave; </li><li>  Reglas l√≥gicas de producci√≥n del servidor; </li><li>  Base de datos de configuraci√≥n del controlador y el bloque de reglas l√≥gicas; </li><li>  Servidor API RESTful para interactuar con la interfaz gr√°fica; </li><li>  Cliente MQTT para interactuar con la nube. </li></ol><br>  Los bloques del proceso del servidor se implementan como flujos separados, cuya informaci√≥n se transmite en forma de mensajes en formato JSON (o estructuras de datos que representan este formato en la memoria del proceso). <br><br><img src="https://habrastorage.org/webt/vl/vm/md/vlvmmduxt7nsh-bjkpshrywrcqa.png"><br><br>  El componente principal del proceso del servidor es el <b>administrador de mensajes</b> , que enruta los mensajes en formato JSON para todos los bloques del proceso del servidor.  Los tipos de campos de informaci√≥n de mensajes JSON y los valores que pueden aceptar se enumeran en la tabla: <br><br><div class="scrollable-table"><table><tbody><tr><th>  tipo de dispositivo </th><th>  protocolo </th><th>  messageType </th><th>  deviceState </th><th>  comando </th></tr><tr><td>  camara </td><td>  onvif </td><td>  sensorData </td><td>  en </td><td>  transmisi√≥n (activar / desactivar) </td></tr><tr><td>  sensor </td><td>  zwave </td><td>  comando </td><td>  fuera </td><td>  grabaci√≥n (activar / desactivar) </td></tr><tr><td>  efector </td><td>  mqtt </td><td>  businessLogicRule </td><td>  transmisi√≥n (activar / desactivar) </td><td>  evice (Agregar / Eliminar) </td></tr><tr><td></td><td>  l√≥gica de negocios </td><td>  configurationData </td><td>  grabaci√≥n (activar / desactivar) </td><td></td></tr><tr><td></td><td>  bluetooth </td><td>  deviceState </td><td>  error </td><td></td></tr><tr><td></td><td>  wifi </td><td></td><td></td><td></td></tr><tr><td></td><td>  rf </td><td></td><td></td><td></td></tr></tbody></table></div><br><br>  Por ejemplo, un mensaje de un detector de movimiento de c√°mara se ve as√≠: <br><br><pre><code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"vendor"</span></span>: <span class="hljs-string"><span class="hljs-string">"*****"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"version"</span></span>: <span class="hljs-string"><span class="hljs-string">"3.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"timestampMs"</span></span>: <span class="hljs-string"><span class="hljs-string">"1566293475475"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"clientType"</span></span>: <span class="hljs-string"><span class="hljs-string">"gateway"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"deviceId"</span></span>: <span class="hljs-string"><span class="hljs-string">"1616453d-30cd-44b7-9bf0-************"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"deviceType"</span></span>: <span class="hljs-string"><span class="hljs-string">"camera"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"protocol"</span></span>: <span class="hljs-string"><span class="hljs-string">"onvif"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"messageType"</span></span>: <span class="hljs-string"><span class="hljs-string">"sensorData"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"sensorType"</span></span>: <span class="hljs-string"><span class="hljs-string">"camera"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"label"</span></span>: <span class="hljs-string"><span class="hljs-string">"motionDetector"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"sensorData"</span></span>: <span class="hljs-string"><span class="hljs-string">"on"</span></span> }</code> </pre> <br><h1>  L√≥gica de producci√≥n </h1><br>  Para recibir o enviar un mensaje del despachador, el bloque de proceso del servidor se suscribe a mensajes de cierto tipo.  La suscripci√≥n es una regla l√≥gica de producci√≥n del tipo <i>"If ... then ..."</i> , presentada en formato JSON, y un enlace al controlador de mensajes dentro del bloque de proceso del servidor.  Por ejemplo, para que el servidor de la c√°mara IP pueda recibir comandos de la GUI y la nube, debe agregar la siguiente regla: <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"if"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"and"</span></span>: [{ <span class="hljs-attr"><span class="hljs-attr">"equal"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"deviceId"</span></span>: <span class="hljs-string"><span class="hljs-string">"1616453d-30cd-44b7-9bf0-************"</span></span> } }, { <span class="hljs-attr"><span class="hljs-attr">"equal"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"messageType"</span></span>: <span class="hljs-string"><span class="hljs-string">"command"</span></span> } } ] }, <span class="hljs-attr"><span class="hljs-attr">"then"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"result"</span></span>: <span class="hljs-string"><span class="hljs-string">"true"</span></span> } }</code> </pre><br>  Si las condiciones especificadas en el <b>antecedente</b> (lado izquierdo) de la regla son verdaderas, entonces la <b>regla</b> (lado derecho) de la regla se ejecuta y el controlador obtiene acceso al cuerpo del mensaje JSON.  El antecedente admite operadores l√≥gicos que realizan la comparaci√≥n de pares clave-valor JSON: <br><br><ol><li>  igual a "igual"; </li><li>  no es igual a "not_equal"; </li><li>  menos "menos"; </li><li>  m√°s "mayor"; </li><li>  menor o igual que "menor_o igual"; </li><li>  mayor o igual a mayor_o_equal. </li></ol><br>  Los resultados de la comparaci√≥n se pueden vincular entre s√≠ utilizando los operadores de √°lgebra booleana: <br><br><ol><li>  Y "y"; </li><li>  O "o"; </li><li>  NO "no". </li></ol><br>  Por lo tanto, al escribir operadores y operandos en notaci√≥n polaca, es posible formar condiciones bastante complejas con una gran cantidad de par√°metros. <br><br>  Exactamente el mismo mecanismo, basado en mensajes JSON y reglas de producci√≥n en formato JSON, se usa en el bloque del servidor l√≥gico de producci√≥n para representar el conocimiento y hacer inferencia l√≥gica usando datos sensoriales de sensores dom√©sticos inteligentes. <br><br>  Usando una aplicaci√≥n m√≥vil, un usuario crea scripts seg√∫n los cuales una casa inteligente deber√≠a funcionar.  Por ejemplo: <i>"Si el sensor para abrir la puerta delantera ha funcionado, encienda la luz en el pasillo"</i> .  La aplicaci√≥n lee los identificadores de los sensores (sensor de apertura) y los actuadores (toma inteligente o l√°mpara inteligente) de la base de datos y genera una regla l√≥gica en formato JSON, que se env√≠a al controlador dom√©stico inteligente.  Este mecanismo se discutir√° con m√°s detalle en el tercer art√≠culo de nuestra serie, donde hablaremos sobre una aplicaci√≥n cliente para administrar un hogar inteligente. <br><br>  El mecanismo de l√≥gica de producci√≥n discutido anteriormente se implementa utilizando la biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">RapidJSON</a> , un analizador SAX del formato JSON en C ++.  La lectura y el an√°lisis coherentes de una serie de reglas de producci√≥n facilitan la implementaci√≥n de la funci√≥n de coincidencia de datos dentro de los antecedentes: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> CRuleEngine::Process(PProperties pFact) { m_pActions-&gt;clear(); rapidjson::Reader reader; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(TStringMap::value_type&amp; rRule : m_Rules) { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> sRuleId = rRule.first; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> sRuleBody = rRule.second; <span class="hljs-function"><span class="hljs-function">CRuleHandler </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ruleHandler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pFact)</span></span></span></span>; rapidjson::<span class="hljs-function"><span class="hljs-function">StringStream </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ruleStream</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(sRuleBody.c_str())</span></span></span></span>; rapidjson::ParseResult parseResult = reader.Parse(ruleStream, ruleHandler); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!parseResult) { m_Logger.LogMessage( NLogger2::ePriorityLevelError, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>(<span class="hljs-string"><span class="hljs-string">"JSON parse error"</span></span>), <span class="hljs-string"><span class="hljs-string">"CRuleEngine::Process()"</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>(<span class="hljs-string"><span class="hljs-string">"RuleId: "</span></span>) + sRuleId); } PProperties pAction = ruleHandler.GetAction(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(pAction) { pAction-&gt;Set(<span class="hljs-string"><span class="hljs-string">"ruleId"</span></span>, sRuleId); m_pActions-&gt;push_back(pAction); } } }</code> </pre><br>  Aqu√≠ <b>pFact</b> es una estructura que contiene pares clave-valor de un mensaje JSON, <b>m_Rules</b> es una matriz de cadenas de reglas de producci√≥n.  La comparaci√≥n del mensaje entrante y la regla de producci√≥n se realiza en la funci√≥n <b>reader.Parse (ruleStream, ruleHandler)</b> , donde <b>ruleHandler</b> es un objeto que contiene la l√≥gica de operadores booleanos y operadores de comparaci√≥n.  <b>sRuleId</b> es un identificador de regla √∫nico, gracias al cual es posible almacenar y editar reglas dentro de la base de datos de un controlador dom√©stico inteligente.  <b>m_pActions</b> : una matriz con los resultados de la inferencia l√≥gica: mensajes JSON que contienen consistentes de la base de reglas y se env√≠an al administrador de mensajes para que las secuencias de suscriptores puedan procesarlos. <br><br>  El rendimiento de RapidJSON es comparable a la funci√≥n <b>strlen ()</b> , y los requisitos m√≠nimos de recursos del sistema permiten que esta biblioteca se use en dispositivos integrados.  El uso de mensajes y reglas l√≥gicas en formato JSON le permite implementar un sistema flexible de intercambio de informaci√≥n entre todos los componentes del controlador dom√©stico inteligente. <br><br><h2>  Sensores y Actuadores Z-Wave </h2><br>  La principal ventaja de un hogar inteligente es que puede medir de forma independiente varios par√°metros ambientales y realizar funciones √∫tiles seg√∫n la situaci√≥n.  Para hacer esto, los sensores y actuadores est√°n conectados al controlador de casa inteligente.  En la versi√≥n actual, se trata de dispositivos inal√°mbricos que funcionan seg√∫n el protocolo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Z-Wave</a> a una frecuencia especialmente asignada de <b>869 MHz</b> para Rusia.  Para su trabajo, se combinan en una red de malla, en la que los repetidores de se√±al est√°n presentes para aumentar el √°rea de cobertura.  Los dispositivos tambi√©n tienen un modo especial de ahorro de energ√≠a: pasan la mayor parte del tiempo en modo de suspensi√≥n y env√≠an informaci√≥n solo cuando cambia su estado, lo que puede extender significativamente la vida √∫til de la bater√≠a incorporada. <br><br><img src="https://habrastorage.org/webt/d8/ur/dp/d8urdpbsw6yxxxxqov8uj-hphzs.jpeg"><br><br>  En el mercado ahora puede encontrar una cantidad bastante grande de dispositivos Z-Wave diferentes.  Como ejemplo, considere algunos: <br><br><ol><li>  El z√≥calo inteligente Zipato PAN16 puede medir los siguientes par√°metros: consumo de energ√≠a (kW / h), potencia (W), voltaje (V) y corriente (A) en la red el√©ctrica.  Tambi√©n tiene un interruptor incorporado con el que puede controlar el aparato el√©ctrico conectado; </li><li>  El sensor de fugas Neo Coolcam detecta la presencia de l√≠quido derramado al cerrar los contactos de la sonda remota; </li><li>  El detector de humo Zipato PH-PSG01 se activa cuando las part√≠culas de humo ingresan a la c√°mara del analizador de gases; </li><li>  El sensor de movimiento Neo Coolcam analiza la radiaci√≥n infrarroja del cuerpo humano.  Adem√°s hay un sensor de luz (Lx); </li><li>  El multisensor Philio PST02-A mide la temperatura (¬∞ C), la exposici√≥n a la luz (%), la apertura de la puerta, la presencia de una persona en la habitaci√≥n; </li><li>  Controlador de red Z-Wave USB Stick ZME E UZB1, al que est√°n conectados los sensores. </li></ol><br>  Es muy importante que los dispositivos y el controlador funcionen a la misma frecuencia, de lo contrario, simplemente, no se ver√°n en el momento de la conexi√≥n.  Se pueden conectar hasta 232 dispositivos a un controlador de red Z-Wave, que es suficiente para un apartamento o una casa de campo.  Para expandir el √°rea de cobertura de la red en interiores, se puede usar un enchufe inteligente como repetidor de se√±al. <br><br><img src="https://habrastorage.org/webt/o_/q2/oa/o_q2oa4n9w7hpqzr2vihyois9he.png"><br><br>  En el proceso del servidor del controlador dom√©stico inteligente, discutido en el p√°rrafo anterior, el servidor Z-Wave es responsable de interactuar con los dispositivos Z-Wave.  Para obtener informaci√≥n de los sensores, utiliza la biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">OpenZWave</a> en C ++, que proporciona una interfaz para la interacci√≥n con un controlador USB de la red Z-Wave y funciona con muchos sensores y actuadores.  El servidor Z-Wave registra el valor del par√°metro ambiental medido por el sensor en forma de mensaje JSON: <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"vendor"</span></span>: <span class="hljs-string"><span class="hljs-string">"*****"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"version"</span></span>: <span class="hljs-string"><span class="hljs-string">"3.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"timestampMs"</span></span>: <span class="hljs-string"><span class="hljs-string">"1566479791290"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"clientType"</span></span>: <span class="hljs-string"><span class="hljs-string">"gateway"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"deviceId"</span></span>: <span class="hljs-string"><span class="hljs-string">"20873eb0-dd5e-4213-a175-************"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"deviceType"</span></span>: <span class="hljs-string"><span class="hljs-string">"sensor"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"protocol"</span></span>: <span class="hljs-string"><span class="hljs-string">"zwave"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"messageType"</span></span>: <span class="hljs-string"><span class="hljs-string">"sensorData"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"homeId"</span></span>: <span class="hljs-string"><span class="hljs-string">"0xefa0cfa7"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"nodeId"</span></span>: <span class="hljs-string"><span class="hljs-string">"20"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"sensorType"</span></span>: <span class="hljs-string"><span class="hljs-string">"METER"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"label"</span></span>: <span class="hljs-string"><span class="hljs-string">"Voltage"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"sensorData"</span></span>: <span class="hljs-string"><span class="hljs-string">"229.3"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"units"</span></span>: <span class="hljs-string"><span class="hljs-string">"V"</span></span> }</code> </pre><br>  Luego se reenv√≠a al administrador de mensajes de proceso del servidor para que los hilos de suscriptor puedan recibirlo.  El suscriptor principal es el servidor l√≥gico de producci√≥n, que compara los valores de los campos de mensaje en los antecedentes de las reglas l√≥gicas.  Los resultados de la salida l√≥gica que contiene los comandos de control se env√≠an de vuelta al administrador de mensajes y desde all√≠ van al servidor Z-Wave, que los decodifica y los env√≠a al controlador USB de la red Z-Wave.  Luego caen en el dispositivo ejecutivo, que cambia el estado del entorno, y el hogar inteligente, por lo tanto, hace un trabajo √∫til. <br><br> <a href=""><img src="https://habrastorage.org/webt/_s/1m/wk/_s1mwk6ysdi5l9ynhtawcbaolfg.png"></a> <br>  <font color="grey">(haga clic en la imagen para abrir en una resoluci√≥n m√°s alta)</font> <br><br>  Los dispositivos Z-Wave est√°n conectados en la interfaz gr√°fica del controlador dom√©stico inteligente.  Para hacer esto, vaya a la p√°gina con la lista de dispositivos y haga clic en el bot√≥n "Agregar".  El comando add a trav√©s de la API RESTful ingresa al proceso del servidor y, luego, es enviado por el administrador de mensajes al servidor Z-Wave, que coloca el controlador USB Z-Wave en el modo especial de agregar dispositivos.  A continuaci√≥n, en el dispositivo Z-Wave, debe hacer una serie de pulsaciones r√°pidas (3 pulsaciones en 1,5 segundos) del bot√≥n de servicio.  Un controlador USB conecta el dispositivo a la red y env√≠a informaci√≥n sobre √©l al servidor Z-Wave.  Eso, a su vez, crea un nuevo registro en la base de datos SQLite con los par√°metros del nuevo dispositivo.  Despu√©s de un intervalo de tiempo predeterminado, la interfaz gr√°fica vuelve a la p√°gina de la lista de dispositivos Z-Wave, lee informaci√≥n de la base de datos y muestra el nuevo dispositivo en la lista.  Al mismo tiempo, cada dispositivo recibe su propio identificador √∫nico, que se utiliza en las reglas de inferencia de producci√≥n y cuando se trabaja en la nube.  El funcionamiento de este algoritmo se muestra en el diagrama UML: <br><br> <a href=""><img src="https://habrastorage.org/webt/np/01/lc/np01lc-tc4xbqzxccv18tfuxuz4.png"></a> <br>  <font color="grey">(haga clic en la imagen para abrir en una resoluci√≥n m√°s alta)</font> <br><br><h2>  Conexi√≥n de c√°mara IP </h2><br>  El sistema de hogar inteligente en la nube discutido en este art√≠culo es una modernizaci√≥n del sistema de videovigilancia en la nube, tambi√©n desarrollado por el autor, que ha estado en el mercado durante varios a√±os y tiene muchas instalaciones en Rusia. <br><br>  Para los sistemas de videovigilancia en la nube, uno de los problemas agudos es la elecci√≥n limitada de los equipos con los que se puede realizar la integraci√≥n.  El software responsable de la conexi√≥n a la nube se instala dentro de la videoc√°mara, lo que inmediatamente exige mucho a su hardware: el procesador y la cantidad de memoria libre.  Esto explica principalmente el mayor precio de las c√°maras de videovigilancia basadas en la nube en comparaci√≥n con las c√°maras IP convencionales.  Adem√°s, se requiere una larga etapa de negociaciones con los fabricantes de c√°maras de CCTV para obtener acceso al sistema de archivos de la c√°mara y a todas las herramientas de desarrollo necesarias. <br><br><img src="https://habrastorage.org/webt/zx/c-/sq/zxc-sqnecsbismwgwmztyclcg9k.jpeg"><br><br>  Por otro lado, todas las c√°maras IP modernas tienen protocolos est√°ndar para interactuar con otros equipos (en particular, DVR).  Por lo tanto, el uso de un controlador separado que se conecta utilizando el protocolo est√°ndar y transmite transmisiones de video desde c√°maras IP a la nube proporciona ventajas competitivas significativas para los sistemas de videovigilancia en la nube.  Adem√°s, si el cliente ya hab√≠a instalado un sistema de videovigilancia basado en c√°maras IP simples, entonces es posible expandirlo y convertirlo en un hogar inteligente nublado de pleno derecho. <br><br>  El protocolo m√°s popular para los sistemas de videovigilancia IP, que ahora es compatible con todos los fabricantes de c√°maras IP sin excepci√≥n, es el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ONVIF Profile S</a> , cuyas especificaciones existen en el lenguaje de descripci√≥n de servicios web <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">WSDL</a> .  Usando utilidades del <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">kit de</a> herramientas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">gSOAP</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">es</a> posible generar el c√≥digo fuente de los servicios que funcionan con c√°maras IP: <br><br><pre> <code class="bash hljs">$ wsdl2h -o onvif.h \ https://www.onvif.org/ver10/device/wsdl/devicemgmt.wsdl \ https://www.onvif.org/ver10/events/wsdl/event.wsdl \ https://www.onvif.org/ver10/media/wsdl/media.wsdl \ https://www.onvif.org/ver20/ptz/wsdl/ptz.wsdl $ soapcpp2 -Cwvbj -c++11 -d cpp_files/onvif -i onvif.h</code> </pre><br>  Como resultado, obtenemos un conjunto de archivos de encabezado "* .h" y de origen "* .cpp" en C ++, que pueden colocarse directamente en una aplicaci√≥n o en una biblioteca separada y compilarse utilizando el compilador GCC.  Debido a las muchas funciones, el c√≥digo es grande y requiere una optimizaci√≥n adicional.  El microordenador Raspberry Pi 3 modelo B + tiene un rendimiento suficiente para ejecutar este c√≥digo, pero si es necesario portar el c√≥digo a otra plataforma, es necesario elegir la arquitectura del procesador y los recursos del sistema correctamente. <br><br>  Las c√°maras IP que admiten el est√°ndar ONVIF, cuando operan en una red local, est√°n conectadas a un grupo especial de multidifusi√≥n con la direcci√≥n <b>239.255.255.250</b> .  Existe un protocolo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">WS-Discovery</a> , que le permite automatizar la b√∫squeda de dispositivos en la red local. <br><br>  La interfaz inteligente del controlador dom√©stico inteligente implementa la funci√≥n de b√∫squeda de c√°maras IP en el lenguaje PHP, lo cual es muy conveniente cuando interact√∫a con servicios web a trav√©s de mensajes XML.  Cuando selecciona los elementos del men√∫ <i>Dispositivos&gt; C√°maras IP&gt; Escanear</i> , se inicia el algoritmo de b√∫squeda de c√°maras IP, que muestra el resultado en una tabla: <br><br> <a href=""><img src="https://habrastorage.org/webt/ew/xk/m6/ewxkm6g2tl7-2nqvjeyzfed8ees.png"></a> <br>  <font color="grey">(haga clic en la imagen para abrir en una resoluci√≥n m√°s alta)</font> <br><br>  Al agregar una c√°mara al controlador, puede especificar la configuraci√≥n seg√∫n la cual interactuar√° con la nube.  Tambi√©n en esta etapa, se le asigna autom√°ticamente un identificador de dispositivo √∫nico, por el cual se puede identificar f√°cilmente en el futuro dentro de la nube. <br><br><img src="https://habrastorage.org/webt/jp/uq/al/jpuqalxe9cryxzzg2dpynptjjmy.png"><br><br>  A continuaci√≥n, se genera un mensaje en formato JSON que contiene todos los par√°metros de la c√°mara agregada, y se env√≠a al proceso del servidor del controlador dom√©stico inteligente a trav√©s del comando RESTful API, donde los par√°metros de la c√°mara se decodifican y almacenan en la base de datos interna de SQLite, y tambi√©n se utilizan para iniciar los siguientes subprocesos de procesamiento: <br><br><ol><li>  establecer una conexi√≥n RTSP para recibir transmisiones de video y audio; </li><li>  transcodificaci√≥n de audio desde los formatos G.711 mu-Law, G.711 A-Law, G.723, etc.  a formato AAC; </li><li>  transcodificar transmisiones de video H.264 y audio AAC al contenedor FLV y transmitirlo a la nube usando RTMP; </li><li>  establecer una conexi√≥n con el punto final del detector de movimiento de la c√°mara IP mediante el protocolo ONVIF y su sondeo peri√≥dico; </li><li>  generar peri√≥dicamente una imagen de vista previa en miniatura y enviarla a la nube utilizando el protocolo MQTT; </li><li>  Grabaci√≥n local de transmisiones de video y audio en forma de archivos separados en formato MP4 en una tarjeta SD o Flash de un controlador dom√©stico inteligente. </li></ol><br><img src="https://habrastorage.org/webt/4m/yc/yb/4mycybe00ye3dxglny-fcgsohua.png"><br><br>  Para establecer una conexi√≥n con c√°maras, transcodificar, procesar y grabar transmisiones de video en el proceso del servidor, se utilizan las funciones de la biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">FFmpeg</a> 4.1.0. <br><br>  En el experimento de prueba de rendimiento, se conectaron 3 c√°maras al controlador: <br><br><ol><li>  HiWatch DS-I114W (resoluci√≥n - 720p, formato de compresi√≥n - H.264, velocidad de bits - 1 Mb / s, sonido G.711 mu-Law); </li><li>  Microdigital MDC-M6290FTD-1 (resoluci√≥n - 1080p, formato de compresi√≥n - H.264, velocidad de bits - 1 Mb / s, sin sonido); </li><li>  Dahua DH-IPC-HDW4231EMP-AS-0360B (resoluci√≥n - 1080p, formato de compresi√≥n - H.264, velocidad de bits - 1.5 Mb / s, sonido AAC). </li></ol><br><img src="https://habrastorage.org/webt/h2/dv/mk/h2dvmkujuqu4sdp6daccgdimnre.png"><br><br>  Las tres transmisiones se enviaron simult√°neamente a la nube, la transcodificaci√≥n de sonido se realiz√≥ solo desde una c√°mara y se deshabilit√≥ la grabaci√≥n del archivo local.  La utilizaci√≥n de la CPU fue aproximadamente del 5%, el uso de RAM fue de 32 MB (por proceso), 56 MB (total con el sistema operativo). <br><br>  Por lo tanto, se pueden conectar aproximadamente de 20 a 30 c√°maras (dependiendo de la resoluci√≥n y la velocidad de bits) al controlador dom√©stico inteligente, que es suficiente para un sistema de videovigilancia de una casa de tres pisos o un peque√±o almac√©n.  En tareas donde se requiere un alto rendimiento, puede usar una nettop con un procesador Intel multi-core y Linux Debian Sarge OS.  Actualmente, el controlador est√° en operaci√≥n de prueba y se actualizar√°n los datos sobre su rendimiento. <br><br><h2>  Interacci√≥n en la nube </h2><br>  El hogar inteligente en la nube almacena datos de usuario (mediciones de video y sensor) en la nube.  La arquitectura de almacenamiento en la nube se analizar√° con m√°s detalle en el pr√≥ximo art√≠culo de nuestra serie.  Ahora hablemos de la interfaz para transmitir mensajes de informaci√≥n desde el controlador de casa inteligente a la nube. <br><br>  Los estados de los dispositivos conectados y las mediciones del sensor se transmiten utilizando el protocolo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">MQTT</a> , que a menudo se usa en proyectos de IoT debido a su simplicidad y eficiencia energ√©tica.  MQTT utiliza un modelo cliente-servidor cuando los clientes se suscriben a ciertos temas dentro del intermediario y publican sus mensajes.  El intermediario env√≠a mensajes a todos los suscriptores de acuerdo con las reglas determinadas por el nivel de calidad de servicio (QoS): <br><br><ul><li>  QoS 0: como m√°ximo una vez (sin garant√≠a de entrega); </li><li>  QoS 1: al menos una vez (con confirmaci√≥n de entrega); </li><li>  QoS 2: exactamente una vez (con confirmaci√≥n de entrega adicional). </li></ul><br>  En nuestro caso, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Eclipse Mosquitto se</a> utiliza como corredor de MQTT.  El nombre del tema es el identificador √∫nico del controlador de inicio inteligente.  El cliente MQTT dentro del proceso del servidor se suscribe a este tema y traduce los mensajes JSON que provienen del administrador de mensajes.  Por el contrario, los mensajes del agente MQTT se les env√≠an en el administrador de mensajes, que luego los multiplexa a sus suscriptores dentro del proceso del servidor: <br><br><img src="https://habrastorage.org/webt/zx/ao/ea/zxaoeaqetsr7odlbfsx2xtn35fy.png"><br><br>  Para transmitir mensajes sobre el estado del controlador dom√©stico inteligente, se utiliza el mecanismo de mensajes guardados mensajes <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">retenidos del</a> protocolo MQTT.  Esto le permite monitorear correctamente los momentos de reconexi√≥n durante fallas de energ√≠a. <br><br>  El cliente MQTT se desarroll√≥ en base a la implementaci√≥n de la biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Eclipse Paho</a> en C ++. <br><br>  Las transmisiones de medios H.264 + AAC se env√≠an a la nube utilizando el protocolo RTMP, donde un grupo de servidores de medios es responsable de su procesamiento y almacenamiento.  Para distribuir de manera √≥ptima la carga en el cl√∫ster y seleccionar el servidor de medios menos cargado, el controlador dom√©stico inteligente realiza una solicitud preliminar al equilibrador de carga en la nube y solo entonces env√≠a el flujo de medios. <br><br><h1>  Conclusi√≥n </h1><br>  El art√≠culo examin√≥ una implementaci√≥n espec√≠fica de un controlador dom√©stico inteligente basado en el microordenador Raspberry Pi 3 B +, que puede recibir, procesar informaci√≥n y administrar equipos usando el protocolo Z-Wave, interactuar con c√°maras IP usando el protocolo ONVIF y tambi√©n intercambiar datos y comandos con la nube Servicio de protocolo MQTT y RTMP.  Se ha desarrollado un motor l√≥gico de producci√≥n basado en una comparaci√≥n de reglas l√≥gicas y hechos presentados en formato JSON. <br><br>  Ahora el controlador de casa inteligente se est√° sometiendo a una operaci√≥n de prueba en varias instalaciones en Mosc√∫ y la regi√≥n de Mosc√∫. <br><br>  En la pr√≥xima versi√≥n del controlador, se planea conectar dispositivos de otros tipos (RF, Bluetooth, WiFi, cableados).  Para comodidad de los usuarios, el procedimiento para conectar sensores y c√°maras IP se transferir√° a la aplicaci√≥n m√≥vil.  Tambi√©n hay ideas para optimizar el c√≥digo de proceso del servidor y portar el software al sistema operativo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">OpenWrt</a> .  Esto ahorrar√° en un controlador separado y transferir√° la funcionalidad de un hogar inteligente a un enrutador dom√©stico normal. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/467219/">https://habr.com/ru/post/467219/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../467203/index.html">Solo divisi√≥n, o c√≥mo crear una teor√≠a matem√°tica y ganar $ 400K con ella. Serie dos, pen√∫ltima</a></li>
<li><a href="../467205/index.html">Desarrollamos una aplicaci√≥n que env√≠a datos a otras aplicaciones (aplicaci√≥n de ecosistema)</a></li>
<li><a href="../467207/index.html">Cinco lenguajes de programaci√≥n prometedores con un futuro brillante (3 a√±os despu√©s)</a></li>
<li><a href="../467209/index.html">"Agentes aut√≥nomos" o ejecute c√≥digo en la criptoplataforma abierta Obyte</a></li>
<li><a href="../467215/index.html">22 museos de inform√°tica: una gu√≠a para ingenieros que viajan por Europa</a></li>
<li><a href="../467223/index.html">Bienvenido a JavaScript Meetup SuperJob 10 de octubre</a></li>
<li><a href="../467227/index.html">C√≥mo abrir un paquete npm con una implementaci√≥n normal, CI y demostraci√≥n (sin p√©rdida de alegr√≠a en la vida)</a></li>
<li><a href="../467231/index.html">Presentamos Iniciar sesi√≥n con Apple en tu aplicaci√≥n iOS</a></li>
<li><a href="../467237/index.html">Eleve su servidor DNS sobre HTTPS</a></li>
<li><a href="../467239/index.html">La diferencia entre Data Scientist y un adolescente en un auto deportivo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>