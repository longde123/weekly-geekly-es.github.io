<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèª‚Äçüöí ü§ú ü•† Ni un solo ORM üï∂Ô∏è üë®üèº‚Äç‚öñÔ∏è üöê</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ni un solo ORM 


 Hola a todos! Estoy a cargo del departamento de Desarrollo de Socios del servicio de reserva de hoteles Ostrovok.ru . En este art√≠c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Ni un solo ORM</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ostrovok/blog/447706/"><h1 id="ne-ormom-edinym">  Ni un solo ORM </h1><br><p>  Hola a todos!  Estoy a cargo del departamento de Desarrollo de Socios del servicio de reserva de hoteles <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Ostrovok.ru</a> .  En este art√≠culo, me gustar√≠a hablar sobre c√≥mo usamos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Django ORM</a> en un proyecto. </p><br><p>  De hecho, estaba enga√±ando, el nombre deber√≠a haber sido " <del>  No </del>  ORM single ". Si se pregunta por qu√© escrib√≠ esto, as√≠ como si: </p><br><ul><li> Tiene Django en la pila y desea exprimir el m√°ximo de ORM, no solo <code>Model.objects.all()</code> , </li><li>  Desea transferir parte de la l√≥gica empresarial al nivel de la base de datos, </li><li>  ¬øO desea averiguar por qu√© la excusa m√°s frecuente para los desarrolladores en B2B.Ostrovok.ru es <em>"tan hist√≥ricamente"</em> , </li></ul><br><p>  ... bienvenido a cat. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/66b/308/b1c/66b308b1cd5afefead46ef7bffdbbddf.jpg" alt="cdpv"></p><a name="habracut"></a><br><p>  En 2014, lanzamos B2B.Ostrovok.ru, un servicio de reserva en l√≠nea para hoteles, traslados, autom√≥viles y otros servicios de viaje para profesionales del mercado tur√≠stico (agentes de viajes, operadores y clientes corporativos). </p><br><p>  En B2B, hemos dise√±ado y utilizado con bastante √©xito un modelo de orden abstracto basado en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><code>GenericForeignKey</code></a> - meta order - <code>MetaOrder</code> . </p><br><p>  Un metaorden es una entidad abstracta que se puede usar sin importar a qu√© tipo de orden pertenece: hotel ( <code>Hotel</code> ), servicio adicional ( <code>Upsell</code> ) o autom√≥vil ( <code>Car</code> ).  En el futuro, pueden aparecer otros tipos. </p><br><p>  Este no siempre ha sido el caso.  Cuando se lanz√≥ el servicio B2B, solo se pod√≠an reservar hoteles a trav√©s de √©l, y toda la l√≥gica empresarial se centr√≥ en ellos.  Se han creado muchos campos, por ejemplo, para mostrar los tipos de cambio del importe de venta y el importe del reembolso de la reserva.  Con el tiempo, nos dimos cuenta de la mejor manera de almacenar y reutilizar estos datos, dados los metaordenes.  Pero no se pudo reescribir todo el c√≥digo, y parte de este patrimonio entr√≥ en la nueva arquitectura.  En realidad, esto condujo a dificultades en los c√°lculos, que utilizan varios tipos de √≥rdenes.  Qu√© hacer, as√≠ que <em>hist√≥ricamente</em> ... </p><br><p>  Mi objetivo es mostrar el poder de Django ORM en nuestro ejemplo. </p><br><h2 id="predystoriya">  Antecedentes </h2><br><p>  Para planificar sus gastos, nuestros clientes B2B realmente carec√≠an de informaci√≥n sobre cu√°nto deben pagar ahora / ma√±ana / m√°s tarde, si tienen deudas pendientes en los pedidos y cu√°nto son, y tambi√©n cu√°nto m√°s pueden gastar dentro de sus l√≠mites.  Decidimos mostrar esta informaci√≥n en forma de tablero, un z√≥calo tan simple con un diagrama claro. </p><br><p><img src="https://habrastorage.org/webt/2a/rj/yo/2arjyoaa9_xfe8ddcaz5qn4w5mu.gif" alt="dash1"><br>  <em>(todos los valores son de prueba y no se aplican a un socio espec√≠fico)</em> </p><br><p>  A primera vista, todo es bastante simple: filtramos todos los pedidos del socio, lo resumimos y lo mostramos. </p><br><h2 id="varianty-resheniya">  Opciones de solucion </h2><br><p>  Una peque√±a explicaci√≥n sobre c√≥mo hacemos los c√°lculos.  Somos una empresa internacional, nuestros socios de diferentes pa√≠ses realizan operaciones, compran y revenden reservas, en diferentes monedas.  Adem√°s, deben recibir estados financieros en la moneda elegida (generalmente local).  Ser√≠a tonto y poco pr√°ctico almacenar todos los datos posibles sobre las tasas de todas las monedas, por lo que debe elegir una moneda de referencia, por ejemplo, el rublo.  Por lo tanto, puede almacenar las tasas de todas las monedas solo en el rublo.  En consecuencia, cuando un socio desea recibir un resumen, convertimos los montos a la tasa establecida al momento de la venta. </p><br><h3 id="v-lob">  "En la frente" </h3><br><p>  De hecho, este es <code>Model.objects.all()</code> y el bucle de condiciones: </p><br><div class="spoiler">  <b class="spoiler_title">Model.objects.all () con condiciones</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">output</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(partner_id)</span></span></span><span class="hljs-function">:</span></span> today = dt.date.today() <span class="hljs-comment"><span class="hljs-comment"># query_get_one -    partner = query_get_one(Partner.objects.filter(id=partner_id)) #    -  query = MetaOrder.objects.filter(partner=partner) result = defaultdict(Decimal) for morder in query: #  ,     #     payment_pending = morder.get_payment_pending() payment_due = morder.get_payment_due() #        # (     ) payable = morder.get_payable_in_cur() #       if payment_pending &gt; today: result['payment_pending'] += payable # ,     if payment_pending &lt; today and payment_due &gt; today: result['payment_due'] += payable return result</span></span></code> </pre> </div></div><br><p>  Esta consulta devolver√° un generador que potencialmente contiene varios cientos de reservas.  Se realizar√° una solicitud a la base de datos para cada una de estas reservas y, por lo tanto, el ciclo funcionar√° durante mucho tiempo. </p><br><p>  Puede acelerar un poco las cosas agregando el m√©todo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><code>prefetch_related</code></a> : </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># object -      GenericForeignKey. query = query.prefetch_related('object')</span></span></code> </pre> <br><p>  Luego habr√° un poco menos de solicitudes a la base de datos ( <code>GenericForeignKey</code> en <code>GenericForeignKey</code> ), pero a√∫n as√≠, al final, nos detendremos en su n√∫mero, porque la solicitud a la base de datos a√∫n se realizar√° en cada iteraci√≥n del ciclo. </p><br><p>  El m√©todo de <code>output</code> puede (y debe) almacenarse en cach√©, pero a√∫n as√≠ la primera llamada cumple el orden de un minuto, lo cual es completamente inaceptable. </p><br><p>  Aqu√≠ est√°n los resultados de este enfoque: </p><br><p><img src="https://habrastorage.org/webt/yz/ur/wq/yzurwquhxoeqczgncqi66je8570.png" alt="timing_before"></p><br><p>  El tiempo de respuesta promedio es de 4 segundos y hay picos que alcanzan los 21 segundos.  Bastante largo tiempo </p><br><p>  No implementamos el panel de control para todos los socios y, por lo tanto, no ten√≠amos muchas solicitudes, pero a√∫n lo suficiente como para comprender que ese enfoque no es efectivo. </p><br><p><img src="https://habrastorage.org/webt/f0/rz/yn/f0rzynfsqypr3z0mh1cnwoi6ee0.png" alt="cuenta_antes"><br>  <em>Los n√∫meros de la parte inferior derecha son el n√∫mero de consultas: m√≠nimo, m√°ximo, promedio, total.</em> </p><br><h3 id="s-umom">  Sabiamente </h3><br><p>  El prototipo de la frente era bueno para comprender la complejidad de la tarea, pero no era √≥ptimo para su uso.  Decidimos que ser√≠a mucho m√°s r√°pido y menos intensivo en recursos hacer varias consultas complejas en la base de datos que muchas simples. </p><br><h4 id="plan-zaprosa">  Plan de solicitud </h4><br><p>  Los trazos amplios del plan de consulta se pueden describir as√≠: </p><br><ul><li>  recoger pedidos de acuerdo con las condiciones iniciales, </li><li>  preparar campos para el c√°lculo mediante <code>annotate</code> , </li><li>  calcular valores de campo </li><li>  hacer <code>aggregate</code> por la cantidad y cantidad </li></ul><br><h4 id="nachalnye-usloviya">  Condiciones iniciales </h4><br><p>  Los socios que visitan el sitio solo pueden ver informaci√≥n sobre su contrato. </p><br><pre> <code class="python hljs">partner = query_get_one(Partner.objects.filter(id=partner_id))</code> </pre> <br><p>  En caso de que no queramos mostrar nuevos tipos de pedidos / reservas, solo necesitamos filtrar los admitidos: </p><br><pre> <code class="python hljs">query = MetaOrder.objects.filter( partner=partner, content_type__in=[ Hotel.get_content_type(), Car.get_content_type(), Upsell.get_content_type(), ] )</code> </pre> <br><p>  El estado del pedido es importante (m√°s sobre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><code>Q</code></a> ): </p><br><pre> <code class="python hljs">query = query.filter( Q(hotel__status__in=[<span class="hljs-string"><span class="hljs-string">'completed'</span></span>, <span class="hljs-string"><span class="hljs-string">'cancelled'</span></span>]) <span class="hljs-comment"><span class="hljs-comment">#     ,    # | Q(car__status__in=[...]) )</span></span></code> </pre> <br><p>  Tambi√©n usamos solicitudes preparadas, por ejemplo, para excluir todos los pedidos que no se pueden pagar.  Hay bastante l√≥gica de negocios, lo que no es muy interesante para nosotros en el marco de este art√≠culo, pero en esencia estos son solo filtros adicionales.  Un m√©todo que devuelve una consulta preparada podr√≠a tener este aspecto: </p><br><pre> <code class="python hljs">query = MetaOrder.exclude_non_payable_metaorders(query)</code> </pre> <br><p>  Como puede ver, este es un m√©todo de clase que tambi√©n devolver√° un <code>QuerySet</code> . </p><br><p>  Tambi√©n prepararemos un par de variables para construcciones condicionales y para almacenar resultados de c√°lculo: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> dt <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> typing.decimal <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Decimal today = dt.date.today() result = defaultdict(Decimal)</code> </pre> <br><h4 id="podgotovka-poley-annotatehttpsdocsdjangoprojectcomen21refmodelsquerysetsannotate">  Preparaci√≥n de campo ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><code>annotate</code></a> ) </h4><br><p>  Debido al hecho de que tenemos que referirnos a los campos seg√∫n el tipo de orden, utilizaremos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><code>Coalesce</code></a> .  Por lo tanto, podemos abstraer cualquier n√∫mero de nuevos tipos de √≥rdenes en un solo campo. </p><br><p>  Aqu√≠ est√° la primera parte del bloque de <code>annotate</code> : </p><br><div class="spoiler">  <b class="spoiler_title">Primero anotar</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#     , #      from app.helpers.numbers import ZERO, ONE query_annoted = query.annotate( _payment_pending=Coalesce( 'hotel__payment_pending', 'car__payment_pending', 'upsell__payment_pending', ), _payment_due=Coalesce( 'hotel__payment_due', 'car__payment_due', 'upsell__payment_due', ), _refund=Coalesce( 'hotel__refund', Value(ZERO) ), _refund_currency_rate=Coalesce( 'hotel__refund_currency_rate', Value(ONE) ), _sell=Coalesce( 'hotel__sell', Value(ZERO) ), _sell_currency_rate=Coalesce( 'hotel__sell_currency_rate', Value(ONE) ), )</span></span></code> </pre> </div></div><br><p>  <code>Coalesce</code> funciona aqu√≠ con una explosi√≥n, porque los pedidos de hoteles tienen varias propiedades especiales, y en todos los dem√°s casos (servicios adicionales y autom√≥viles) estas propiedades no son importantes para nosotros.  As√≠ es como aparece el <code>Value(ZERO)</code> para cantidades y el <code>Value(ONE)</code> para tasas de cambio.  <code>ZERO</code> y <code>ONE</code> son <code>Decimal('0')</code> y <code>Decimal(1)</code> , solo en forma de constantes.  Un enfoque aficionado, pero en nuestro proyecto se acepta as√≠. </p><br><p>  Es posible que tenga una pregunta, ¬øpor qu√© no colocar algunos campos en un nivel en un metaorden?  Por ejemplo, <code>payment_pending</code> , que est√° en todas partes.  De hecho, con el tiempo, transferimos dichos campos a un metaorden, pero ahora el c√≥digo funciona bien, por lo que tales tareas no son nuestra prioridad. </p><br><h4 id="esche-odna-podgotovka-i-raschety">  Otra preparaci√≥n y c√°lculos. </h4><br><p>  Ahora necesitamos hacer algunos c√°lculos con las cantidades que recibimos en el √∫ltimo bloque de <code>annotate</code> .  Tenga en cuenta que aqu√≠ ya no necesita estar vinculado al tipo de orden (excepto por una excepci√≥n). </p><br><div class="spoiler">  <b class="spoiler_title">Segunda anotaci√≥n</b> <div class="spoiler_text"><pre> <code class="python hljs">.annotate( <span class="hljs-comment"><span class="hljs-comment">#  _base     _sell_base=( F('_sell') * F('_sell_currency_rate') ), _refund_base=( F('_refund') * F('_refund_currency_rate') ), _payable_base=( F('_sell_base') - F('_refund_base') ), _reporting_currency_rate=Case( When( content_type=Hotel.get_content_type(), then=RawSQL( '(hotel.currency_data-&gt;&gt;%s)::numeric', (partner.reporting_currency,), ), ), output_field=DecimalField(), default=Decimal('1'), ), )</span></span></code> </pre> </div></div><br><p>  La parte m√°s interesante de este bloque es el campo <code>_reporting_currency_rate</code> , o el tipo de cambio de la moneda de referencia en el momento de la venta.  Los datos sobre los tipos de cambio de todas las monedas a la moneda de referencia para un pedido de hotel se almacenan en <code>currency_data</code> .  Esto es solo JSON.  ¬øPor qu√© guardamos esto?  <em>Este es hist√≥ricamente el caso</em> . </p><br><p>  Y aqu√≠, parece, ¬øpor qu√© no usar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><code>F</code></a> y sustituir el valor de la moneda del contrato?  Es decir, ser√≠a genial si pudieras hacer esto: </p><br><pre> <code class="python hljs">F(<span class="hljs-string"><span class="hljs-string">f'currency_data__</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{partner.reporting_currency}</span></span></span><span class="hljs-string">'</span></span>)</code> </pre> <br><p>  Pero <code>f-strings</code> no <code>f-strings</code> compatibles con <code>F</code>  Aunque el hecho de que Django ORM ya tenga la capacidad de acceder a campos json anidados es muy agradable - <code>F('currency_data__USD')</code> . </p><br><p>  Y el √∫ltimo bloque de <code>annotate</code> es el c√°lculo <code>_payable_in_cur</code> , que se <code>_payable_in_cur</code> para todos los pedidos.  Este valor debe estar en la moneda del contrato. </p><br><p><img src="https://habrastorage.org/webt/3g/hi/rd/3ghirdq4rnexrp2vnhwucju7rkw.png" alt="dash2"></p><br><pre> <code class="python hljs">.annotate( _payable_in_cur=( F(<span class="hljs-string"><span class="hljs-string">'_payable_base'</span></span>) / F(<span class="hljs-string"><span class="hljs-string">'_reporting_currency_rate'</span></span>) ) )</code> </pre> <br><p>  La peculiaridad del m√©todo de <code>annotate</code> es que genera una gran cantidad de construcciones <code>SELECT something AS something_else</code> que no est√°n directamente involucradas en la solicitud.  Esto se puede ver descargando la consulta SQL - <code>query.__str__()</code> . </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">As√≠ es como se ve el</a> c√≥digo SQL generado por Django ORM para <code>base_query_annotated</code> .  Debe leerlo con bastante frecuencia para comprender d√≥nde puede optimizar su consulta. </p><br><h4 id="zaklyuchitelnye-podschety">  C√°lculos finales </h4><br><p>  Habr√° un peque√±o contenedor para el <code>aggregate</code> , de modo que en el futuro, si el socio necesita alguna otra m√©trica, se puede agregar f√°cilmente. </p><br><p><img src="https://habrastorage.org/webt/ky/qm/pi/kyqmpiht-jwpwuripuf6wlfiqv0.png" alt="dash3"></p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_get_data_from_query</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(query: QuerySet)</span></span></span><span class="hljs-function"> -&gt; Decimal:</span></span> result = query.aggregate( _sum_payable=Sum(F(<span class="hljs-string"><span class="hljs-string">'_payable_in_cur'</span></span>)), ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result[<span class="hljs-string"><span class="hljs-string">'_sum_payable'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> ZERO</code> </pre> <br><p>  Y una cosa m√°s: este es el √∫ltimo filtrado por condici√≥n comercial, por ejemplo, necesitamos todos los pedidos que deber√°n pagarse pronto. </p><br><p><img src="https://habrastorage.org/webt/xz/rj/ss/xzrjssl1barwnpvtegjkg1tkvs0.png" alt="dash4"></p><br><pre> <code class="python hljs">before_payment_pending_query = _get_data_from_query( base_query_annotated.filter(_payment_pending__gt=today) )</code> </pre> <br><h4 id="otladka-i-proverka">  Depuraci√≥n y Verificaci√≥n </h4><br><p>  Una forma muy conveniente de verificar la exactitud de la solicitud creada es compararla con una versi√≥n m√°s legible de los c√°lculos. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> morder <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> query: payable = morder.get_payable_in_cur() payment_pending = morder.get_payment_pending() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> payment_pending &gt; today: result[<span class="hljs-string"><span class="hljs-string">'payment_pending'</span></span>] += payable</code> </pre> <br><p>  ¬øConoces el m√©todo de "frente"? </p><br><h3 id="finalnyy-kod">  C√≥digo final </h3><br><p>  Como resultado, obtuvimos algo como lo siguiente: </p><br><div class="spoiler">  <b class="spoiler_title">C√≥digo final</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_get_data_from_query</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(query: QuerySet)</span></span></span><span class="hljs-function"> -&gt; tuple:</span></span> result = query.aggregate( _sum_payable=Sum(F(<span class="hljs-string"><span class="hljs-string">'_payable_in_cur'</span></span>)), ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result[<span class="hljs-string"><span class="hljs-string">'_sum_payable'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> ZERO <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">output</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(partner_id: int)</span></span></span><span class="hljs-function">:</span></span> today = dt.date.today() partner = query_get_one(Partner.objects.filter(id=partner_id)) query = MetaOrder.objects.filter(partner=partner, content_type__in=[ Hotel.get_content_type(), Car.get_content_type(), Upsell.get_content_type(), ]) result = defaultdict(Decimal) query_annoted = query.annotate( _payment_pending=Coalesce( <span class="hljs-string"><span class="hljs-string">'hotel__payment_pending'</span></span>, <span class="hljs-string"><span class="hljs-string">'car__payment_pending'</span></span>, <span class="hljs-string"><span class="hljs-string">'upsell__payment_pending'</span></span>, ), _payment_due=Coalesce( <span class="hljs-string"><span class="hljs-string">'hotel__payment_due'</span></span>, <span class="hljs-string"><span class="hljs-string">'car__payment_due'</span></span>, <span class="hljs-string"><span class="hljs-string">'upsell__payment_due'</span></span>, ), _refund=Coalesce( <span class="hljs-string"><span class="hljs-string">'hotel__refund'</span></span>, Value(ZERO) ), _refund_currency_rate=Coalesce( <span class="hljs-string"><span class="hljs-string">'hotel__refund_currency_rate'</span></span>, Value(Decimal(<span class="hljs-string"><span class="hljs-string">'1'</span></span>)) ), _sell=Coalesce( <span class="hljs-string"><span class="hljs-string">'hotel__sell'</span></span>, Value(ZERO) ), _sell_currency_rate=Coalesce( <span class="hljs-string"><span class="hljs-string">'hotel__sell_currency_rate'</span></span>, Value(Decimal(<span class="hljs-string"><span class="hljs-string">'1'</span></span>)) ), ).annotate( <span class="hljs-comment"><span class="hljs-comment"># Calculated fields _sell_base=( F('_sell') * F('_sell_currency_rate') ), _refund_base=( F('_refund') * F('_refund_currency_rate') ), _payable_base=( F('_sell_base') - F('_refund_base') ), _reporting_currency_rate=Case( # Only hotels have currency_data, therefore we need a # check and default value When( content_type=Hotel.get_content_type(), then=RawSQL( '(hotel.currency_data-&gt;&gt;%s)::numeric', (partner.reporting_currency,), ), ), output_field=DecimalField(), default=Decimal('1'), ), ) .annotate( _payable_in_cur=( F('_payable_base') / F('_reporting_currency_rate') ) ) before_payment_pending_query = _get_data_from_query( base_query_annotated.filter(_payment_pending__gt=today) ) after_payment_pending_before_payment_due_query = _get_data_from_query( base_query_annotated.filter( Q(_payment_pending__lte=today) &amp; Q(_payment_due__gt=today) ) )</span></span></code> </pre></div></div><br><p>  As√≠ es como funciona ahora: </p><br><p><img src="https://habrastorage.org/webt/xg/1i/rf/xg1irfnazuk-rqk14wdlxn32nhi.png" alt="timing_after"></p><br><p><img src="https://habrastorage.org/webt/mt/k7/cq/mtk7cqefuzlx96roihjpgvpeaz8.png" alt="cuenta_despu√©s"></p><br><h2 id="vyvody">  Conclusiones </h2><br><p>  Despu√©s de reescribir y optimizar la l√≥gica, logramos hacer un manejo bastante r√°pido de las m√©tricas de afiliados y reducir en gran medida el n√∫mero de consultas a la base de datos.  La soluci√≥n result√≥ ser buena y reutilizaremos esta l√≥gica en otras partes del proyecto.  ORM es nuestro todo. </p><br><p>  Escriba comentarios, haga preguntas, ¬°trataremos de responder!  Gracias </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/447706/">https://habr.com/ru/post/447706/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../447696/index.html">¬øPor qu√© las ciudades se oponen a Amazon Go, las primeras tiendas sin efectivo?</a></li>
<li><a href="../447698/index.html">Red Hogwarts: acad√©mico sin diploma</a></li>
<li><a href="../447700/index.html">La flexibilidad emocional es la clave del crecimiento personal.</a></li>
<li><a href="../447702/index.html">El c√≠rculo matem√°tico ideal no existe.</a></li>
<li><a href="../447704/index.html">Climbing Elbrus - Reconocimiento en batalla. Parte t√©cnica 1. Registros, pilas y otros detalles t√©cnicos.</a></li>
<li><a href="../447708/index.html">Yandex present√≥ a los j√≥venes cient√≠ficos y l√≠deres cient√≠ficos los primeros premios Ilya Segalovich</a></li>
<li><a href="../447712/index.html">Hola SaaS | Rusia SaaS 2018 - resultados</a></li>
<li><a href="../447714/index.html">Sobre la aplicaci√≥n de la teor√≠a de los procesos ARMA en la pr√°ctica de la ingenier√≠a.</a></li>
<li><a href="../447716/index.html">Unidad: dibuja muchas barras de salud en una sola llamada</a></li>
<li><a href="../447718/index.html">Todo ir√° de acuerdo al plan</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>