<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🔈 🙏🏿 🎐 Fungsi yang tidak dikenali memperlambat program 5 kali 🐢 🏇🏼 🙌</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Memperlambat Windows Bagian 3: Proses Pengakhiran 



 Penulis terlibat dalam mengoptimalkan kinerja Chrome di Google - kira-kira. trans. 

 Pada musi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Fungsi yang tidak dikenali memperlambat program 5 kali</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/432076/"> <b>Memperlambat Windows Bagian 3: Proses Pengakhiran</b> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b55/8f1/93c/b558f193cbc015bf35b2b068ff1c8e65.jpg"><br><br>  <font color="gray">Penulis terlibat dalam mengoptimalkan kinerja Chrome di Google - kira-kira.</font>  <font color="gray">trans.</font> <br><br>  Pada musim panas 2017, saya berjuang dengan masalah kinerja Windows.  Pengakhiran proses lambat, serial dan diblokir antrian input sistem, yang menyebabkan beberapa pembekuan kursor mouse selama perakitan Chrome.  Alasan utama adalah bahwa pada akhir proses, Windows menghabiskan banyak waktu mencari objek GDI, sambil memegang bagian penting dari system-global user32.  Saya membicarakan hal ini dalam artikel <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">"prosesor 24-core, tapi saya tidak bisa menggerakkan kursor</a> . <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">"</a> <br><br>  Microsoft memperbaiki bug, dan saya kembali ke bisnis saya, tetapi ternyata bug itu kembali.  Ada keluhan tentang lambatnya operasi tes LLVM, dengan seringnya input hang. <br><br>  Namun nyatanya, bug itu tidak kembali.  Alasannya adalah perubahan kode kami. <br><a name="habracut"></a><br><h1>  Masalah 2017 </h1><br><img src="https://habrastorage.org/getpro/habr/post_images/dcd/5f4/417/dcd5f4417f6d878a47d7d3c292a9304a.png" align="left">  Setiap proses Windows berisi beberapa deskriptor objek GDI standar.  Untuk proses yang tidak melakukan apa pun dengan grafik, deskriptor ini biasanya NULL.  Pada akhir proses, Windows memanggil beberapa fungsi untuk deskriptor ini, bahkan jika mereka NULL.  Tidak masalah - fitur-fiturnya bekerja dengan cepat - sampai rilis Windows 10 Anniversary Edition, di mana <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">beberapa perubahan keamanan membuat fitur-fitur ini lambat</a> .  Selama operasi, mereka memegang kunci yang sama yang digunakan untuk acara masukan.  Ketika sejumlah besar proses dihentikan secara bersamaan, masing-masing membuat beberapa panggilan ke fungsi lambat yang menahan kunci kritis ini, yang pada akhirnya menyebabkan input pengguna diblokir dan kursor membeku. <br><br>  Tambalan Microsoft bukan untuk memanggil fungsi-fungsi ini untuk proses tanpa objek GDI.  Saya tidak tahu detailnya, tapi saya pikir tambalan Microsoft adalah seperti ini: <br><br> <code>+ if (IsGUIProcess()) <br> + NtGdiCloseProcess(); <br> – NtGdiCloseProcess();</code> <br> <br>  Artinya, lewati saja pembersihan GDI jika prosesnya bukan proses GUI / GDI. <br><br>  Karena kompiler dan proses lain yang kami buat dan akhiri dengan cepat tidak menggunakan objek GDI, tambalan ini ternyata cukup untuk memperbaiki pembekuan UI. <br><br><h1>  Masalah 2018 </h1><br>  Ternyata prosesnya sangat mudah sebenarnya dialokasikan beberapa objek GDI standar.  Jika proses Anda memuat gdi32.dll, maka Anda akan secara otomatis menerima objek GDI (DC, permukaan, wilayah, kuas, font, dll.), Baik Anda membutuhkannya atau tidak (perhatikan bahwa objek GDI standar ini tidak ditampilkan di Task Manager di antara objek GDI untuk proses). <br><br>  Tapi itu seharusnya tidak menjadi masalah.  Maksud saya, mengapa kompiler memuat gdi32.dll?  Nah, ternyata jika Anda memuat user32.dll, shell32.dll, ole32.dll atau banyak DLL lainnya, maka Anda akan secara otomatis mendapatkan tambahan gdi32.dll (dengan objek GDI standar yang disebutkan di atas).  Dan sangat mudah untuk secara tidak sengaja mengunduh salah satu perpustakaan ini. <br><br>  LLVM menguji ketika memuat setiap proses yang disebut <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">CommandLineToArgvW</a> (shell32.dll), dan kadang-kadang disebut <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">SHGetKnownFolderPath</a> (juga shell32.dll) Panggilan ini cukup untuk mengeluarkan gdi32.dll dan menghasilkan objek GDI standar yang menakutkan ini.  Karena rangkaian uji LLVM menghasilkan <i>begitu</i> banyak proses, pada akhirnya membuat cerita bersambung pada selesainya proses, menyebabkan penundaan besar dan pembekuan input, jauh lebih buruk daripada yang ada pada 2017. <br><br>  Tapi kali ini kami tahu tentang masalah utama dengan pemblokiran, jadi kami segera tahu apa yang harus dilakukan. <br><br>  Pertama-tama, kita menyingkirkan memanggil <i>CommandLineToArgvW</i> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">secara manual mem-parsing baris perintah</a> .  Setelah itu, test suite LLVM jarang memanggil fungsi dari DLL yang bermasalah.  Tapi kami tahu sebelumnya bahwa ini tidak akan memengaruhi kinerja dengan cara apa pun.  Alasannya adalah bahwa bahkan panggilan <i>bersyarat yang</i> tersisa sudah cukup untuk selalu menarik shell32.dll, yang pada gilirannya menarik gdi32.dll, yang menciptakan objek GDI standar. <br><br>  Perbaikan kedua adalah <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">penundaan loading shell32.dll</a> .  Penundaan pemuatan berarti bahwa perpustakaan memuat sesuai permintaan - saat fungsi dipanggil - alih-alih memuat saat proses dimulai.  Ini berarti bahwa shell32.dll dan gdi32.dll jarang dimuat, dan tidak selalu. <br><br>  Setelah itu, test suite LLVM mulai berjalan <i>lima kali</i> lebih cepat - dalam satu menit, bukan lima.  Dan tidak ada lagi tikus yang membeku di mesin pengembangan, sehingga karyawan dapat bekerja secara normal selama pelaksanaan tes.  Ini adalah percepatan gila untuk perubahan yang begitu sederhana, dan penulis tambalan itu sangat bersyukur atas investigasi saya sehingga ia menominasikan saya untuk <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">bonus perusahaan</a> . <br><br>  Terkadang perubahan terkecil memiliki konsekuensi terbesar.  Anda hanya perlu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">tahu di mana harus memanggil "nol"</a> . <br><br><h1>  Jalur eksekusi tidak diterima </h1><br><img src="https://habrastorage.org/getpro/habr/post_images/83d/1a9/e86/83d1a9e868d112a30dd4c37ea0caa9cb.jpg" align="left" width="350">  Perlu diulang bahwa kita memperhatikan kode yang <i>tidak dieksekusi</i> - dan ini adalah perubahan utama.  Jika Anda memiliki alat baris perintah yang tidak mengakses gdi32.dll, maka menambahkan kode dengan panggilan fungsi <i>bersyarat</i> akan memperlambat proses berkali-kali jika gdi32.dll dimuat.  Dalam contoh di bawah ini, <i>CommandLineToArgvW</i> tidak pernah dipanggil, tetapi bahkan kehadiran sederhana dalam kode (tanpa penundaan panggilan) mempengaruhi kinerja: <br><br><pre> <code class="plaintext hljs">int main(int argc, char* argv[]) { if (argc &lt; 0) { CommandLineToArgvW(nullptr, nullptr); // shell32.dll, pulls in gdi32.dll } }</code> </pre> <br>  Jadi ya, menghapus panggilan fungsi, bahkan jika kode tidak pernah dieksekusi, mungkin cukup untuk secara signifikan meningkatkan kinerja dalam beberapa kasus. <br><br><h1>  Reproduksi patologi </h1><br><img src="https://habrastorage.org/getpro/habr/post_images/8ab/f3f/4aa/8abf3f4aac933be4fe7cdb400727b049.png" align="left">  Ketika saya menyelidiki kesalahan awal, saya menulis sebuah program yang menciptakan 1000 proses dan kemudian membunuh semuanya secara paralel.  Ini mereproduksi pembekuan, dan ketika Microsoft memperbaiki kesalahan, saya menggunakan program pengujian untuk memeriksa patch: lihat <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">videonya</a> .  Setelah reinkarnasi bug, saya mengubah program saya dengan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">menambahkan opsi -user32</a> , yang memuat user32.dll untuk masing-masing dari ribuan proses pengujian.  Seperti yang diharapkan, waktu penyelesaian semua proses pengujian meningkat secara dramatis dengan opsi ini, dan mudah untuk mendeteksi kursor mouse yang membeku.  Waktu pembuatan proses juga meningkat dengan opsi -user32, tetapi tidak ada suspensi kursor selama pembuatan proses.  Anda dapat menggunakan program ini dan melihat seberapa buruk masalahnya.  Berikut adalah beberapa hasil khas notebook empat-inti / delapan-threaded saya setelah seminggu uptime.  Opsi -user32 meningkatkan waktu untuk semuanya, tetapi kunci <i>UserCrit</i> pada proses berakhir terutama secara dramatis: <br><br> <code>&gt; ProcessCreatetests.exe <br> Process creation took 2.448 s (2.448 ms per process). <br> Lock blocked for 0.008 s total, maximum was 0.001 s. <br> <br> Process destruction took 0.801 s (0.801 ms per process). <br> Lock blocked for 0.004 s total, maximum was 0.001 s. <br> <br> &gt; ProcessCreatetests.exe -user32 <br> Testing with 1000 descendant processes with user32.dll loaded. <br> Process creation took 3.154 s (3.154 ms per process). <br> Lock blocked for 0.032 s total, maximum was 0.007 s. <br> <br> Process destruction took 2.240 s (2.240 ms per process). <br> Lock blocked for 1.991 s total, maximum was 0.864 s.</code> <br> <br><h1>  Menggali lebih dalam hanya untuk bersenang-senang </h1><br>  Saya memikirkan beberapa metode ETW yang dapat digunakan untuk mempelajari masalah secara lebih rinci, dan sudah mulai menulisnya.  Tetapi saya menemukan perilaku yang tidak dapat dijelaskan, yang saya putuskan untuk mencurahkan artikel terpisah.  Cukuplah untuk mengatakan bahwa dalam kasus ini, Windows berperilaku lebih aneh. <br><br>  Artikel lain dalam seri: <br><br><ul><li>  Memperlambat Windows, bagian 0: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">perlambatan sewenang-wenang dari VirtualAlloc</a> </li><li>  Memperlambat Windows, bagian 1: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">akses file</a> </li><li>  Memperlambat Windows Bagian 2: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Membuat Proses</a> </li><li>  Memperlambat Windows, bagian 3: ini </li></ul><br><h1>  Sastra </h1><br><ul><li>  Laporan Penangguhan UI Pertama: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">"prosesor 24-core, tetapi saya tidak dapat memindahkan kursor"</a> </li><li>  Artikel berikut, yang mengarah pada pemahaman masalah: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">"Apa * yang * Windows lakukan saat memegang kunci ini"</a> </li><li>  Artikel tentang blok UI <i>lain</i> karena interaksi antara Gmail, pekerja ASLR v8, kebijakan alokasi memori CFG, dan pemindaian WMI lambat: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">"CPU 24-core, tapi saya tidak bisa mengetikkan email"</a> </li><li>  Pemuatan kompilator gdi32.dll tampaknya aneh, tetapi bahkan lebih aneh lagi bahwa kompilator memuat mshtml.dll, yang <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">biasa digunakan VC ++ dalam beberapa kasus</a> </li><li>  Kadang-kadang minggu penelitian menyebabkan perubahan kecil tapi kritis, seperti yang dibahas dalam artikel <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">"Mengetahui Tempat Melakukan Panggilan Nol"</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Video yang</a> menunjukkan penggunaan ProcessCreateTests dan ETW untuk memverifikasi perbaikan bug </li><li>  Perubahan pertama untuk LLVM dengan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">parsing baris perintah manual</a> </li><li>  Perbaikan kedua untuk LLVM menggunakan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">penundaan load shell32.dll</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id432076/">https://habr.com/ru/post/id432076/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id432064/index.html">Cara melarikan diri dari "hares". Instruksi UV</a></li>
<li><a href="../id432068/index.html">Cara memfasilitasi studi Bahasa Inggris: 5 layanan bermanfaat</a></li>
<li><a href="../id432070/index.html">Secara singkat tentang saluran redux-saga</a></li>
<li><a href="../id432072/index.html">Tiga jenis kebocoran memori</a></li>
<li><a href="../id432074/index.html">Bagaimana pemain merobek kain realitas Spelunky dengan senapan</a></li>
<li><a href="../id432078/index.html">Lalu lintas di ujung terowongan atau DNS di pentest</a></li>
<li><a href="../id432080/index.html">Pemain salah paham saat menilai risiko. Kontrol generator angka acak dalam pengembangan</a></li>
<li><a href="../id432082/index.html">Microsoft AI Chatbot Meluncurkan Koleksi Pakaian Cina</a></li>
<li><a href="../id432084/index.html">Bagaimana kami mengatur kompetisi shift antara pekerja produksi (seperti dalam USSR)</a></li>
<li><a href="../id432086/index.html">Pencetakan 3D di sekolah internasional dinamai M.V. Lomonosov</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>