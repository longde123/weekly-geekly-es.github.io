<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëº üòõ üïç Vom Anf√§nger bis zur Stilikone: Wie wir in 2GIS Auszeichnungen vergeben haben üë®üèº‚Äç‚úàÔ∏è ‚úçüèº ‚õΩÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Jeden Tag helfen uns 2GIS-Benutzer dabei, die Datengenauigkeit aufrechtzuerhalten: Sie informieren √ºber neue Unternehmen, f√ºgen Verkehrsereignisse hin...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Vom Anf√§nger bis zur Stilikone: Wie wir in 2GIS Auszeichnungen vergeben haben</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/2gis/blog/470942/"><img src="https://habrastorage.org/webt/kl/9g/ja/kl9gjaqo9dmcbsimconigs2pnxo.png"><br><br>  Jeden Tag helfen uns 2GIS-Benutzer dabei, die Datengenauigkeit aufrechtzuerhalten: Sie informieren √ºber neue Unternehmen, f√ºgen Verkehrsereignisse hinzu, laden Fotos hoch und schreiben Bewertungen.  Bisher konnten wir ihnen nur mit Worten danken oder ein Werbegeschenk arrangieren.  Aber mit der Zeit werden Worte vergessen und nicht jeder bekommt Geschenke.  Deshalb haben wir uns entschlossen sicherzustellen, dass alle, die sich f√ºr 2GIS interessieren, ihren Beitrag zum Produkt und unsere Dankbarkeit daf√ºr sehen. <br><br>  Es gab also Auszeichnungen - virtuelle Medaillen, die wir f√ºr verschiedene Aufgaben sammeln: Fotos auf Caf√©karten hochladen, Rezensionen √ºber Theater schreiben, Arbeitszeiten von Organisationen festlegen und so weiter.  Benutzer sehen die erzielten Belohnungen in ihrem pers√∂nlichen 2GIS-Profil und auf der Registerkarte "Mein 2GIS" in der mobilen Anwendung.  Dort zeigen wir, wie viel bis zum n√§chsten Erfolg √ºbrig bleibt. <br><br>  Um diese Funktion zu implementieren, haben wir gelernt, wie ein Ereignisstrom mit einem Volumen von 500.000 Datens√§tzen pro Stunde (an Orten mit bis zu 50.000 Datens√§tzen pro Sekunde) verarbeitet und Daten von mehreren Diensten analysiert werden.  Und au√üerdem haben sie eine kleine Metaprogrammierung hinzugef√ºgt, um die Konfiguration bei der Entwicklung neuer Auszeichnungen zu vereinfachen. <br><br>  Zusammen mit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link">Rapter</a> werden wir Ihnen sagen, was sich unter der Haube des Vergabeverfahrens befindet. <br><a name="habracut"></a><br><h2>  Konzept </h2><br>  Um die Komplexit√§t der Funktion zu verstehen, m√ºssen Sie verstehen, wie sich das technische Problem angeh√∂rt hat.  Dann - betrachten Sie die Idee der Implementierung und das allgemeine Schema der Systemkomponenten.  Dies werden wir in diesem Abschnitt tun. <br><br><h3>  Anforderungen an Abstracts </h3><br>  Anforderungen - eine ziemlich langweilige Sache, damit wir nicht alle Nuancen malen, sondern uns auf die wichtigsten Dinge konzentrieren: <br><br><ul><li>  Auszeichnungen werden nur an autorisierte Benutzer vergeben; </li><li>  Die Aktualisierung des Fortschritts bei einer Belohnung sollte so schnell wie m√∂glich erfolgen. </li><li>  Belohnung - das Ergebnis eines Benutzers, der eine Reihe von Aktionen im Produkt ausf√ºhrt: Hochladen eines Fotos, Schreiben einer Bewertung, Finden von Anweisungen usw. Es gibt viele Datenquellen. </li></ul><br><h3>  Architektonische Idee </h3><br>  Die Idee der Implementierung ist nicht sehr kompliziert.  Es kann theoretisch ausgedr√ºckt werden: <br><br><ul><li>  Die Auszeichnung besteht aus Aufgaben, deren Ergebnisse gem√§√ü der bei der Konfiguration der Auszeichnung angegebenen Formel kombiniert werden. </li><li>  Die Aufgabe reagiert auf Ereignisse √ºber Benutzeraktionen von au√üen, filtert sie und registriert die √Ñnderung in Form von Z√§hlern. </li><li>  ‚ÄûExterne Ereignisse‚Äú werden von Mastersystemen (Foto-, Feedback-, Verfeinerungsdienste usw.) oder Hilfsdiensten generiert, die bereits vorhandene Ereignisfl√ºsse transformieren oder filtern. </li><li>  Die Ereignisverarbeitung erfolgt asynchron und kann bei Bedarf jederzeit gestoppt werden. </li><li>  Der Benutzer sieht den aktuellen Status seiner Auszeichnungen. </li><li>  Alles andere sind die Details ... </li></ul><br><h3>  Schl√ºsselentit√§ten </h3><br>  Das folgende Diagramm zeigt die Hauptentit√§ten des Themenbereichs und ihre Beziehung: <br><br><img src="https://habrastorage.org/webt/vi/ya/59/viya59qa7bnnad3hogutbunyds4.png"><br><br>  Im Diagramm werden zwei Zonen unterschieden: <br><br><ul><li>  Schema - eine Zone zur Beschreibung der Struktur von Auszeichnungen und der Regeln f√ºr deren Abgrenzung; </li><li>  Daten - Auszeichnungsbereich f√ºr bestimmte Benutzer und Daten zu ihrem aktuellen Status. </li></ul><br>  Die Entit√§ten im Diagramm: <br><br><ul><li>  Erhalten - Informationen √ºber die Auszeichnung, die erhalten werden k√∂nnen.  Enth√§lt Metainformationen und eine Beschreibung, wie die Ergebnisse von Aufgaben kombiniert werden k√∂nnen - eine Strategie. </li><li>  Ziel - eine Aufgabe, deren Bedingungen erf√ºllt sein m√ºssen, um eine Auszeichnung zu erhalten. </li><li>  UserAchieve - Der aktuelle Status der Belohnung f√ºr einen bestimmten Benutzer. </li><li>  UserObjective - Der aktuelle Status des Belohnungsjobs des Benutzers. </li><li>  Benutzer - Informationen √ºber den Benutzer, die f√ºr Benachrichtigungen und das Verst√§ndnis seines aktuellen Status erforderlich sind (entfernte und gesperrte Belohnungen sind nicht erforderlich). </li><li>  ProcessingLog - Ein Protokoll der R√ºckstellungen f√ºr Aufgaben.  Enth√§lt Informationen dar√ºber, wie eine bestimmte Aktion den Fortschritt der Zuweisung beeinflusst hat. </li><li>  Ereignis - Die minimal erforderlichen Informationen zu einem Ereignis, die den Fortschritt der Aufgaben des Benutzers irgendwie beeinflusst haben. </li></ul><br><h3>  Servicestruktur </h3><br>  Betrachten Sie nun die Hauptkomponenten des Dienstes und ihre Abh√§ngigkeiten: <br><br><img src="https://habrastorage.org/webt/qi/dp/k_/qidpk_jo7rqnh2x5dywk0sg0ij4.png"><br><br><ul><li>  Ereignisbus - Ein Ereignisbus, mit dem Aufgaben erledigt werden k√∂nnen.  Wir verwenden Apache Kafka. </li><li>  Master- und Slave-DBs sind das Haupt-Data-Warehouse.  In diesem Fall ein PostgreSQL-Cluster. </li><li>  ConsumingWorkers - Handler f√ºr Busereignisse.  Die Hauptaufgabe besteht darin, Ereignisse aus einer bestimmten Quelle (Fotos, Rezensionen usw.) zu lesen, sie auf Benutzeraufgaben anzuwenden und das Ergebnis zu speichern. </li><li>  AchievesWorker - zeigt den Fortschritt der Benutzerbelohnungen entsprechend dem Status der Aufgaben an. </li><li>  NotificationWorkers - eine Reihe von Handlern zum Planen und Senden von Benachrichtigungen √ºber den Erhalt von Auszeichnungen, Ank√ºndigungen neuer m√∂glicher Erfolge usw. </li><li>  √ñffentliche API - eine √∂ffentliche REST-Schnittstelle f√ºr Web- und mobile Anwendungen. </li><li>  Private API - REST-Schnittstelle f√ºr das Admin-Panel, die bei der Untersuchung von Vorf√§llen und der Serviceunterst√ºtzung hilft.  Es steht Entwicklern und Supportteams zur Verf√ºgung. </li></ul><br>  Jede der Komponenten ist in Bezug auf Logik und Verantwortungsbereiche isoliert, wodurch unn√∂tige Integrationen und Deadlocks beim √Ñndern von Daten vermieden werden.  Im Folgenden betrachten wir nur einen Teil des Schemas, das mit der Verarbeitung von Ereignissen und deren Umwandlung in Belohnungen verbunden ist. <br><br><h2>  Ereignisbehandlung </h2><br><h3>  Inhalt </h3><br>  Belohnungen sind in erster Linie ein Datenaggregationsdienst.  Jedes Mastersystem generiert verschiedene Arten von Ereignissen.  In der Regel h√§ngt jeder Ereignistyp eng mit dem Status des Inhalts und seinem Statusmodell zusammen.  So kann ein Foto moderiert, gel√∂scht, blockiert, ausgeblendet oder aktiv werden.  All dies sind unterschiedliche Ereignisse, die von einem separaten Mitarbeiter behandelt werden, der sich auf eine bestimmte Quelle spezialisiert hat.  Derzeit besteht eine Interaktion mit folgenden Quellen (Mastersystemen): <br><br><ul><li>  Foto - Erzeugt verschiedene Ereignisse, die sich auf Vorg√§nge beziehen, die Benutzer an Fotos ausf√ºhren. </li><li>  √úberpr√ºfungen - Ereignisse im Zusammenhang mit Vorg√§ngen f√ºr Benutzer√ºberpr√ºfungen. </li><li>  Datenfeedback - Ereignisse im Zusammenhang mit Verfeinerungsvorg√§ngen.  Klarstellung ist eine √Ñnderung der Informationen √ºber ein Objekt auf einer Karte, sei es eine Firma oder ein Denkmal. </li><li>  Check - Ereignisse, die sich auf die 2GIS Check-Anwendung beziehen. </li><li>  BSS sind Analyseereignisse, die 2GIS-Anwendungen generieren.  Zum Beispiel die Er√∂ffnung eines bestimmten Unternehmens, Fahrten mit dem Navigator usw. </li></ul><br><img src="https://habrastorage.org/webt/vg/xy/zb/vgxyzbizbytl_up3fllx5epasue.png"><br><br>  Vom Mastersystem generierte Ereignisse fallen in der Reihenfolge der √Ñnderung ihres Status in das Kafka-Thema. Dadurch kann der Fortschritt der Auszeichnung f√ºr den Benutzer nicht nur vorw√§rts, sondern auch r√ºckw√§rts verschoben werden.  Wenn sich das Foto beispielsweise im Status "aktiv" befand und dann aus irgendeinem Grund den Status "blockiert" erhielt, sollte sich der Fortschritt bei der Auszeichnung nach unten √§ndern.  Der Preisfortschritt ist eine Interpretation interner Objekte, die als Inhaltsz√§hler bezeichnet werden. <br><br>  Die Z√§hler k√∂nnen f√ºr verschiedene Daten variieren.  Bei Ereignissen zum Foto sind dies beispielsweise die folgenden: die Anzahl der genehmigten, die Anzahl der moderierten, die Anzahl der blockierten Ereignisse und bei Ereignissen beim √ñffnen von Karten m√ºssen Sie nur die Anzahl der vom Benutzer ge√∂ffneten Karten ber√ºcksichtigen.  Basierend auf den aktuellen Werten der Inhaltsz√§hler f√ºr einen bestimmten Benutzer werden im Rahmen einer bestimmten Auszeichnung die Antworten auf die folgenden Fragen festgelegt: <br><br><ul><li>  Hat die Auszeichnung begonnen? </li><li>  Was ist der Fortschritt </li><li>  Ist die Belohnung vollst√§ndig abgeschlossen? </li></ul><br><h3>  Filter und Regeln </h3><br>  Die Jobz√§hler einer bestimmten Auszeichnung werden nur ge√§ndert, wenn eine Veranstaltung mit dem gew√ºnschten Inhaltstyp sowie den f√ºr den Erhalt der Auszeichnung erforderlichen Daten eingetroffen ist. <br><br>  Um nur den Inhalt zu √ºberspringen, der f√ºr die Auszeichnung geeignet ist, f√ºhren wir jede Veranstaltung durch eine Reihe von Filtern und Regeln. <br><br>  Ein Filter ist eine bestimmte Einschr√§nkung, die dem Inhalt auferlegt wird.  Es geht ihm nur um die Beantwortung der Frage: "Passt ein neues Ereignis zu dieser Bedingung oder nicht?" <br>  Eine Regel ist ein spezieller Filter, dessen Zweck lautet: "Wenn ein Ereignis der Bedingung entspricht, wie sollten sich dann die Z√§hler √§ndern?"  Die Regel enth√§lt einen Algorithmus zum √Ñndern von Z√§hlern.  Jede Auszeichnung enth√§lt nur eine Regel. <br><br>  Die Implementierung von Filtern und Regeln befindet sich im Projektcode, und die Beschreibung, welche Filter (Regeln) zu einer bestimmten Auszeichnung geh√∂ren, befindet sich in der Datenbank im JSON-Format.  Wir sind nicht sofort zu einer solchen Entscheidung gekommen.  Anf√§nglich konnten Filter und Regeln nicht mithilfe der Konfiguration √ºber die Datenbank festgelegt werden. Die Auszeichnung wurde vollst√§ndig im Code beschrieben, nur die Kennung wurde in der Tabelle gespeichert.  Diese Entscheidung brachte eine Reihe wesentlicher Nachteile mit sich: <br><br><ul><li>  Das Problem der Unterst√ºtzung mehrerer Umgebungen.  Wenn Sie einen Status der Liste der Auszeichnungen f√ºr die Testumgebung bereitstellen und einen anderen in den Kampf schicken m√∂chten, m√ºssen Sie die Umgebung im Projektcode kennen oder √ºber eine Konfigurationsdatei mit der Liste der Auszeichnungen verf√ºgen.  Gleichzeitig ist es nicht m√∂glich, unterschiedliche Datenbanken f√ºr diese Aufgabe zu verwenden, obwohl diese bereits f√ºr jede Umgebung vorhanden sind. </li><li>  M√∂glichkeit, die Filterung nur vom Entwickler zu konfigurieren.  Da alles im Code beschrieben ist und nur eine Person, die das Projekt und die Programmiersprache kennt, √Ñnderungen vornehmen kann, m√∂chte ich, dass dies einfach √ºber die private API oder Datenbank m√∂glich ist. </li><li>  Der Nachteil der Betrachtung.  Es gibt viele Belohnungen, manchmal m√ºssen Sie die Filter sehen, die sie verwenden.  Jedes Mal ist es ziemlich m√ºhsam, dies durch Anzeigen des Codes zu tun. </li></ul><br>  Zu Beginn der Anwendung stimmen wir mit dem Namen der aus der Datenbank geladenen Filter √ºberein und setzen sie in eine bestimmte Belohnung ein.  Beispiel f√ºr eine Filterbeschreibung: <br><br><pre><code class="json hljs">[ { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>:<span class="hljs-string"><span class="hljs-string">"SourceFilter"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"config"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"sources"</span></span>:[<span class="hljs-string"><span class="hljs-string">"reviews"</span></span>] } }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"ReviewsLengthFilter"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"config"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"allowed_length"</span></span>: <span class="hljs-number"><span class="hljs-number">100</span></span> } } ]</code> </pre> <br>  In diesem Fall nehmen wir nur die √úberpr√ºfungen (dies wird durch das erste Beschreibungsobjekt aus dem Filterarray angezeigt), deren Text mehr als 100 Zeichen enth√§lt (der zweite Filter in der Liste). <br><br>  Beispiel f√ºr eine Regelbeschreibung: <br><br><pre> <code class="json hljs">{<span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"ReviewUniqueByObjectRule"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"config"</span></span>:{}}</code> </pre><br>  Mit dieser Regel k√∂nnen Sie die Z√§hler nur √§ndern, wenn der Benutzer eine Bewertung f√ºr das Objekt geschrieben hat, w√§hrend nur eine Bewertung f√ºr ein Objekt ber√ºcksichtigt wird. <br><br><h3>  Bss </h3><br>  Lassen Sie uns separat auf die Arbeit mit dem Strom von BSS-Ereignissen eingehen.  Daf√ºr gibt es mindestens drei Gr√ºnde: <br><br><ul><li>  Analytics-Ereignisse k√∂nnen nicht zur√ºckgesetzt werden, da sie kein Statusmodell enthalten. Dies ist im Allgemeinen logisch, da das Durchfahren eines Navigators oder das Erstellen einer Route nicht abgebrochen werden kann.  Die Aktion war entweder da oder nicht. </li><li>  B√§nde.  Ich m√∂chte Sie daran erinnern, dass das Gesamtpublikum von 2GIS mehr als 50 Millionen Benutzer pro Monat betr√§gt.  Zusammen f√ºhren sie mehr als 1,5 Milliarden Suchanfragen sowie viele andere Aktionen durch: Starten der Anwendung, Anzeigen der Objektkarte usw. In der Spitze kann die Anzahl der Ereignisse 50.000 pro Sekunde erreichen.  Wir m√ºssen all diese Informationen durch Filter weitergeben, um dem Benutzer eine Belohnung zu geben. </li><li>  Analytics-Ereignisse haben Funktionen: verschiedene Formate, eine Vielzahl von Typen. </li></ul><br>  All dies hat die Verarbeitung von Daten aus dem BSS-Thema stark beeinflusst, da wir, wenn wir Echtzeit ben√∂tigen, eine sehr enge Verarbeitungszeit ben√∂tigen. <br><br>  Um die beschriebenen Unterschiede zu verringern, wurde ein separater Dienst erstellt, der solche Ereignisse vorbereitet.  Der Dienst kann mit der Vielzahl von Nachrichtenformaten arbeiten, die aus der Analyse stammen.  Das Wesentliche seiner Arbeit ist wie folgt: Der gesamte BSS-Veranstaltungsstrom wird gelesen, aus dem nur diejenigen entnommen werden, die f√ºr die Auszeichnungen ben√∂tigt werden.  Ein solcher Servicefilter reduziert die Last (nach dem Filtern betr√§gt die Flussrate 300 Ereignisse pro Sekunde) durch die Belohnungen des BSS-Stream-Prozessors erheblich und generiert auch Ereignisse in einem einzigen Format, wodurch der mit der Historie der internen Analyse verbundene Nachteil ausgeglichen wird. <br><br><h2>  Auszeichnungen </h2><br>  Also haben wir herausgefunden, wie wir mit Ereignissen umgehen und den Fortschritt bei Aufgaben berechnen k√∂nnen.  Jetzt ist es an der Zeit, einen Blick auf den Prozess der Ausgabe von Belohnungen an Benutzer zu werfen. <br><br>  Die erste Frage, die sich stellt, lautet: Warum sollte die Ausgabe einem separaten Mitarbeiter zugewiesen werden? Kann sie bei der Verarbeitung jedes Ereignisses nicht nachgez√§hlt werden?  Antwort: m√∂glich, aber es lohnt sich nicht. <br><br>  Es gibt mehrere Gr√ºnde, die Auslieferung einem separaten Verfahren zuzuweisen: <br><br><ol><li>  Wenn wir die Nachz√§hlung an jeden ConsumingWorker √ºbertragen, erhalten wir die Race-Bedingung f√ºr die Aktualisierung des Fortschritts durch Belohnung, da jeder Handler versucht, den Fortschritt basierend auf dem bekannten Status der Aufgaben zu aktualisieren, und andere diesen Status aktiv √§ndern. </li><li>  Jeder ConsumingWorker-Stapel verarbeitet Ereignisse von Kafka in einer Transaktion.  Durch Hinzuf√ºgen einer Einf√ºgung zur Belohnungstabelle des Benutzers werden zus√§tzliche Sperren auf Datenbankebene aufgerufen, wodurch andere Handler gesperrt werden. </li><li>  Bei der Vergabe von Pr√§mien gibt es eine Logik zum Senden von Benachrichtigungen, die die Verarbeitung des Ereignisflusses nur verlangsamt, was unerw√ºnscht ist. </li></ol><br>  Die Gr√ºnde f√ºr die Entstehung eines separaten AchievesWorker (Handler f√ºr die Vergabe von Auszeichnungen) wurden gekl√§rt.  Jetzt m√ºssen Sie sich mit zwei wichtigen Teilen der Verarbeitung befassen: <br><br><ol><li>  Die Belohnung enth√§lt eine Reihe von Quests.  F√ºr diese Aufgaben gibt es eine Reihe von Z√§hlern.  Wie kann man verstehen, wie viel die Auszeichnung verdient und wie man sie im Code ausdr√ºckt? <br>  Beispiel: Sie m√ºssen 3 Bewertungen schreiben oder 3 Fotos hochladen.  Der Benutzer hat 1 Bewertung und 2 Fotos.  Wie ist der Fortschritt der Auszeichnung?  Antwort: 3, da der Benutzer definitiv sicher sein wird, dass Sie insgesamt 3 ben√∂tigen. </li><li>  Wir haben einen separaten Handler f√ºr die Vergabe von Auszeichnungen.  Es ist unwahrscheinlich, dass jedes Mal mehrere Dutzend Auszeichnungen f√ºr jeden autorisierten Benutzer, dh mehrere zehn Millionen, schnell erfolgreich sind.  Wie kann er erfahren, welche Fortschritte bestimmte Benutzer haben und welche Aufgaben sich seit der letzten Verarbeitung ge√§ndert haben? </li></ol><br>  Wir werden jedes Teil separat betrachten. <br><br><h3>  Fluss des Fortschritts </h3><br>  Um besser zu verstehen, wie Sie beschreiben k√∂nnen, wie Sie den Fortschritt von Aufgaben durch Belohnung in Fortschritt umwandeln k√∂nnen, teilen wir die Belohnungen in Kategorien ein und betrachten die Transformationen. <br><br>  <b>"Erf√ºlle eine Aufgabe pro X Einheit."</b>  Beispiel: Fahren Sie 10 km mit dem Navigator. <br><br><img src="https://habrastorage.org/webt/vv/qu/x5/vvqux5yb09uehrul3dkd3mux3wm.png"><br><br>  <b>"Erledige mehrere Aufgaben f√ºr jeweils X Einheiten."</b>  Beispiel: Laden Sie 5 Fotos hoch und schreiben Sie 5 Bewertungen in Karten - nur 10 Inhaltseinheiten. <br><br><img src="https://habrastorage.org/webt/fe/n8/oc/fen8oc0kbm372ozvyvr3a7fj8jo.png"><br><br>  <b>"Erf√ºlle mehrere Aufgaben f√ºr insgesamt X Einheiten."</b>  Beispiel: Schreiben Sie 5 Bewertungen oder laden Sie 5 Fotos hoch. <br><br><img src="https://habrastorage.org/webt/d-/ld/gd/d-ldgdazj8xt2eysdzqhgauaxgc.png"><br><br>  <b>"F√ºhren Sie mehrere Aufgaben nach Typ gruppiert aus."</b>  Beispiel: Laden Sie 5 Inhaltseinheiten (Fotos oder Bewertungen) hoch und fahren Sie 10 km mit dem Navigator. <br><br><img src="https://habrastorage.org/webt/ue/c3/ck/uec3ckf33tcm4pjcfmtkfbmv9eq.png"><br><br>  Theoretisch k√∂nnte es komplexere verschachtelte Kombinationen geben.  Unter realen Bedingungen ist es jedoch nicht m√∂glich, dem Benutzer in zwei oder drei S√§tzen die komplexe logische Kombination zu erkl√§ren, die ausgef√ºhrt werden muss, um die Auszeichnung zu erhalten.  Daher sind diese Optionen in den meisten F√§llen ausreichend. <br><br>  Wir haben die Konvertierungsmethode als Strategie bezeichnet und versucht, sie mehr oder weniger universell zu gestalten, indem wir eine formale Beschreibung in Form eines JSON-Objekts ausgearbeitet haben.  Sie k√∂nnten nat√ºrlich daran denken, in Form einer Formel zu schreiben, aber dann m√ºssten Sie √Ñhnlichkeiten verwenden, um die Grammatik zu bewerten oder zu beschreiben und umzusetzen, und dies ist eindeutig eine √úberkomplikation.  Das Speichern der Strategie im Quellcode f√ºr jede Auszeichnung ist nicht sehr praktisch, da die Beschreibung der Auszeichnung (Teil in der Datenbank und Teil im Code) rei√üt und es auch in Zukunft nicht m√∂glich ist, Auszeichnungen von vorgefertigten Komponenten ohne Teilnahme an der Entwicklung zu sammeln. <br><br>  Die Strategie wird in Form eines Baums dargestellt, wobei jeder Knoten: <br><br><ul><li>  Bezieht sich auf den aktuellen Zuweisungsfortschritt oder ist eine Gruppe anderer Knoten. </li><li>  Kann eine Top-Einschr√§nkung haben - in der Tat ein Hinweis auf die Notwendigkeit, min () zu verwenden. </li><li>  Kann einen Normalisierungskoeffizienten haben.  Wird f√ºr einfache Konvertierungen ben√∂tigt, indem das Ergebnis mit einer Zahl multipliziert wird.  Wir haben uns als n√ºtzlich erwiesen, um Meter in Kilometer umzurechnen. </li></ul><br>  Um die obigen Beispiele zu beschreiben, reicht eine Operation aus - Summe.  Die Summe ist ideal, um den Benutzerfortschritt mit einer einzelnen Zahl klar darzustellen. Auf Wunsch k√∂nnen jedoch auch andere Vorg√§nge verwendet werden. <br><br>  Hier ist eine beispielhafte Strategiebeschreibung f√ºr die letzte Kategorie: <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"goal"</span></span>: <span class="hljs-number"><span class="hljs-number">15</span></span>, <span class="hljs-attr"><span class="hljs-attr">"operation"</span></span>: <span class="hljs-string"><span class="hljs-string">"sum"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"strategy"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"goal"</span></span>: <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-attr"><span class="hljs-attr">"operation"</span></span>: <span class="hljs-string"><span class="hljs-string">"sum"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"strategy"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"objective_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"photo"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"objective_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"reviews"</span></span> } ] }, { <span class="hljs-attr"><span class="hljs-attr">"goal"</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-attr"><span class="hljs-attr">"operation"</span></span>: <span class="hljs-string"><span class="hljs-string">"sum"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"strategy"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"objective_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"navi"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"normalization_factor"</span></span>: <span class="hljs-number"><span class="hljs-number">0.001</span></span> } ] } ] }</code> </pre><br><h3>  Erforderliche Updates </h3><br>  Es gibt mehrere Handler, die Ereignisse von Benutzern unerm√ºdlich analysieren und √Ñnderungen am Fortschritt von Aufgaben vornehmen.  Eine regelm√§√üige Suche aller Benutzer mit jeder Auszeichnung f√ºhrt zu einer Analyse von mehreren zehn Millionen Auszeichnungen - nicht sehr ermutigend, vorausgesetzt, dass echte Aktualisierungen in Tausenden gemessen werden.  Wie kann man nur √ºber Tausende lernen und nicht Millionen von CPU verschwenden? <br><br>  Die Idee, den Fortschritt nur bei den tats√§chlich ge√§nderten Auszeichnungen neu zu berechnen, kam ziemlich schnell.  Es basiert auf der Verwendung von Vektoruhren. <br><br>  Vor der Beschreibung werde ich an Entit√§ten erinnern: <br><br><ul><li>  UserObjective - Daten zum Fortschritt des Benutzers durch Festlegen der Auszeichnung. </li><li>  UserAchieve - Belohnt Benutzerfortschrittsdaten. </li></ul><br>  Die Implementierung sieht folgenderma√üen aus: <br><br><ul><li>  Wir erhalten das Versionsfeld f√ºr UserObjective und UserAchieve and Sequence in PostgreSQL. </li><li>  Jedes Update der UserObjective-Entit√§t √§ndert ihre Version.  Der Wert wird aus der Sequenz entnommen (wir haben ihn allen Datens√§tzen gemeinsam). </li><li>  Der Versionswert f√ºr UserAchieve wird als Maximum der Versionen des zugeordneten UserObjective festgelegt. </li><li>  Bei jedem Verarbeitungszyklus sucht AchievesWorker nach einem solchen UserObjective, f√ºr das es kein UserAchieve oder UserAchieve.version &lt;UserObjective.version gibt.  Das Problem wird durch eine einzelne Abfrage an die Datenbank gel√∂st. </li></ul><br>  Es ist erw√§hnenswert, dass die L√∂sung Einschr√§nkungen hinsichtlich der Anzahl der Eintr√§ge in den Tabellen mit Auszeichnungen und Aufgaben sowie der H√§ufigkeit von √Ñnderungen bei den Aufgaben aufweist. Mit einigen zehn Millionen Auszeichnungen und einer Anzahl von Aktualisierungen von weniger als tausend pro Minute ist es jedoch durchaus m√∂glich, mit einer solchen L√∂sung zu leben.  Irgendwie werden wir separat dar√ºber berichten, wie wir die Ausgabe f√ºr den Wettbewerb ‚Äû <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">2GIS Agents</a> ‚Äú optimiert haben. <br><br><h2>  Schlussfolgerungen </h2><br>  Trotz der Tatsache, dass sich der Artikel als ziemlich umfangreich herausstellte, blieben viele Nuancen hinter den Kulissen, da es nicht m√∂glich w√§re, kurz dar√ºber zu sprechen. <br><br>  Welche Schlussfolgerungen haben wir dank der Auszeichnungen gezogen: <br><br><ul><li>  Das Prinzip "Teilen und Erobern" spielte uns in diesem Fall in die H√§nde.  Die Zuordnung von Ereignishandlern zu jeder Quelle hilft uns bei Bedarf bei der Skalierung.  Ihre Arbeit ist nach Daten isoliert und schneidet sich nur in kleinen Bereichen.  Durch Hervorheben der Belohnungslogik k√∂nnen Sie den Overhead in Ereignishandlern reduzieren. </li><li>  Wenn Sie viele Daten verarbeiten m√ºssen und die Verarbeitung recht teuer ist, sollten Sie sofort dar√ºber nachdenken, wie Sie herausfiltern k√∂nnen, was definitiv nicht ben√∂tigt wird.  Die Erfahrung mit dem Filtern eines BSS-Streams ist ein Beispiel. </li><li>  Wir waren erneut davon √ºberzeugt, dass die Integration von Diensten √ºber einen gemeinsamen Ereignisbus sehr bequem ist und es Ihnen erm√∂glicht, unn√∂tige Belastungen anderer Dienste zu vermeiden.  Wenn der Rewards-Dienst Daten von Foto-, √úberpr√ºfungs- usw. Diensten √ºber http-Anforderungen erhalten w√ºrde, m√ºssten mehrere Dienste f√ºr eine zus√§tzliche Belastung vorbereitet werden. </li><li>  Ein bisschen Metaprogrammierung kann dabei helfen, die Integrit√§t der Datenkonfiguration aufrechtzuerhalten und Umgebungen willk√ºrlich zu trennen.  Das Speichern von Filtern, Regeln und Strategien in der Datenbank vereinfachte das Entwickeln und Freigeben neuer Auszeichnungen. </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de470942/">https://habr.com/ru/post/de470942/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de470928/index.html">Best Practices f√ºr die Ausf√ºhrung von Buildah in einem Container</a></li>
<li><a href="../de470930/index.html">Gamification des Produkts. Verlauf Ratatype</a></li>
<li><a href="../de470934/index.html">Heilt vor der Hochzeit: Zellproliferation und Regenerationsf√§higkeit von Quallen</a></li>
<li><a href="../de470938/index.html">So √∂ffnen Sie einen Link in Python. Arbeiten mit WebBrowser und L√∂sen eines Problems mit Internet Explorer</a></li>
<li><a href="../de470940/index.html">MSK VUE.JS Meetup # 3 bei Mail.ru Group: Materialien von Mitap</a></li>
<li><a href="../de470950/index.html">bear_hug: Spiele in ASCII-Grafik in Python3.6 +</a></li>
<li><a href="../de470952/index.html">Tipps und Tricks zur digitalen Forensik: Forensik-App ‚ÄûYour Phone‚Äú</a></li>
<li><a href="../de470954/index.html">Installieren Sie Zimbra OSE 8.8.15 und Zextras Suite Pro unter Ubuntu 18.04 LTS</a></li>
<li><a href="../de470958/index.html">Lebendigkeitssonden in Kubernetes k√∂nnen gef√§hrlich sein</a></li>
<li><a href="../de470962/index.html">JSConf Budapest 2019</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>