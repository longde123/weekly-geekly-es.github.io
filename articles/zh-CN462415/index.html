<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ˜Œ ğŸ•´ğŸ» ğŸ§™ğŸ» é€šè¿‡CIåœ¨AWSä¸Šéƒ¨ç½²Symfony + Reactåº”ç”¨ç¨‹åº ğŸ‘·ğŸ» ğŸ‘¨ğŸ¼â€âš–ï¸ ğŸ‘¨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ä¸‹åˆå¥½ï¼Œåœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†å±•ç¤ºå¦‚ä½•åœ¨AWSä¸Šéƒ¨ç½²Symfony 4åº”ç”¨ç¨‹åºã€‚ å®˜æ–¹æ–‡æ¡£ä¸­æœ‰è¿™æ ·ä¸€ä¸ªè¿‡ç¨‹çš„ç¤ºä¾‹ï¼Œä½†æ˜¯æˆ‘çš„ç‰ˆæœ¬å¹¶ä¸åƒä½¿ç”¨åº”ç”¨ç¨‹åºä¸‹è½½zipå­˜æ¡£é‚£æ ·ç®€å•ã€‚ åœ¨2019å¹´çš„é™¢å­é‡Œï¼Œä»¥dockeræ¨¡å¼ï¼Œå¾®æœåŠ¡æ¶æ„å’ŒCI / CDå®è·µç»ˆäºå¼€å§‹è¢«åŒ…æ‹¬åœ¨DevOpså·¥ç¨‹å¸ˆå’Œæ™®é€šå‡¡äººå¼€å‘äººå‘˜çš„å·¥å…·ä¸­ã€‚ ä¸º...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>é€šè¿‡CIåœ¨AWSä¸Šéƒ¨ç½²Symfony + Reactåº”ç”¨ç¨‹åº</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/462415/">ä¸‹åˆå¥½ï¼Œåœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†å±•ç¤ºå¦‚ä½•åœ¨AWSä¸Šéƒ¨ç½²Symfony 4åº”ç”¨ç¨‹åºã€‚ å®˜æ–¹æ–‡æ¡£ä¸­æœ‰è¿™æ ·ä¸€ä¸ªè¿‡ç¨‹çš„ç¤ºä¾‹ï¼Œä½†æ˜¯æˆ‘çš„ç‰ˆæœ¬å¹¶ä¸åƒä½¿ç”¨åº”ç”¨ç¨‹åºä¸‹è½½zipå­˜æ¡£é‚£æ ·ç®€å•ã€‚ åœ¨2019å¹´çš„é™¢å­é‡Œï¼Œä»¥dockeræ¨¡å¼ï¼Œå¾®æœåŠ¡æ¶æ„å’ŒCI / CDå®è·µç»ˆäºå¼€å§‹è¢«åŒ…æ‹¬åœ¨DevOpså·¥ç¨‹å¸ˆå’Œæ™®é€š<s>å‡¡äºº</s>å¼€å‘äººå‘˜çš„å·¥å…·ä¸­ã€‚ ä¸ºäº†ä½¿æ–‡ç« æ›´æœ‰è¶£ï¼Œæˆ‘åœ¨React.JSä¸Šæ·»åŠ äº†å‰é¢æ¿ï¼Œä»¥æ»¡è¶³å¹¿å¤§äººç¾¤çš„éœ€æ±‚ï¼Œå¦‚æœæ‚¨çš„åº”ç”¨ç¨‹åºä¸ä½¿ç”¨Encoreï¼Œæ²¡å…³ç³»ï¼Œæˆ‘å°†å‘æ‚¨è¯´æ˜å¦‚ä½•æ›´æ”¹Dockeræ–‡ä»¶ï¼Œå¯¹React.JSçš„æ”¯æŒåªä¼šå½±å“åˆ°å®ƒã€‚ è°ä¼šå¯¹æœ¬æ•™ç¨‹æ„Ÿå…´è¶£ï¼Ÿ é¦–å…ˆï¼Œå®ƒé¢å‘å¸Œæœ›æ›´æ”¹å…¶éƒ¨ç½²å®è·µçš„PHPå¼€å‘äººå‘˜-æ‘†è„±é€šå¸¸çš„è§„èŒƒï¼Œå¹¶ä½¿ç”¨dockeræ‰“åŒ…å…¶åº”ç”¨ç¨‹åºå¹¶å¸ƒç½®å›¾åƒã€‚ ä½†æ˜¯æ‚¨å¯ä»¥æ›´æ·±å…¥ä¸€ç‚¹ï¼Œè¿›ä¸€æ­¥çš„å™è¿°å°†æ—¨åœ¨é€šè¿‡CI / CDå¹³å°ä»Gitè‡ªåŠ¨éƒ¨ç½²åº”ç”¨ç¨‹åºï¼ˆå°†ä½¿ç”¨CircleCIï¼Œä½†æ˜¯å¦‚æœæ‚¨å¯¹Gitlabé…ç½®æ„Ÿå…´è¶£ï¼Œè¯·åœ¨æ³¨é‡Šä¸­å†™ä¸Šæˆ‘çš„é™„ä»¶ï¼‰ã€‚ å®é™…ä¸Šï¼Œå¯¹äºReact / PHPæ¥è¯´ï¼Œæ— è®ºæ‚¨æ˜¯æ‹¥æœ‰åº”ç”¨ç¨‹åºè¿˜æ˜¯.NET Coreï¼Œè¿™éƒ½ä¸æ˜¯ç»å¯¹é‡è¦çš„ï¼Œå¯¹äºå¼€å‘äººå‘˜æ¥è¯´ï¼Œè·å¾—é€šç”¨çš„éƒ¨ç½²è‡ªåŠ¨åŒ–æŠ€èƒ½å°†æ˜¯å¾ˆæœ‰è¶£çš„ã€‚ æºä»£ç ä½äºgithubå­˜å‚¨åº“ä¸­ï¼Œä½äºæ–‡ç« ç»“å°¾çš„é“¾æ¥ã€‚ å¥½å§ï¼Œèµ°å§ï¼ <br><a name="habracut"></a><br> æˆ‘å‡è®¾æ‚¨æœ‰è‡ªå·±çš„Symfonyåº”ç”¨ç¨‹åºï¼Œä½†æ˜¯å‡ºäºæ¼”ç¤ºç›®çš„ï¼Œæˆ‘è‰ç»˜äº†â€œ helloï¼Œworldï¼â€ï¼Œå…¶ä¸­åŒ…å«ä»¥ä¸‹è½¯ä»¶åŒ…ï¼š <br><br>  <code>`symfony/webpack-encore-bundle symfony/form symfony/orm-pack symfony/profiler-pack symfony/security-bundle symfony/twig-bundle symfony/validator symfony/phpunit-bridge`</code>æ˜¯ä¸€ä¸ªæœ€å°çš„ç»…å£«ç»„åˆã€‚ ç›®å‰ï¼Œæ–‡ä»¶å¤¹ç»“æ„åº”å¦‚ä¸‹æ‰€ç¤ºï¼š <br><br><img width="350" src="https://habrastorage.org/webt/6m/ck/xi/6mckxiczmqlde3nsjhdpzcbforq.png" alt="å›¾ç‰‡"><br><br> ç°åœ¨ï¼Œæ‚¨éœ€è¦é…ç½®æ‚¨çš„äº‘åŸºç¡€æ¶æ„ã€‚ æˆ‘å°†ä¸ä¸“æ³¨äºæ³¨å†Œå’Œæ¿€æ´»AWSçš„è¯•ç”¨æœŸï¼Œåœ¨è¿™ä¸€é˜¶æ®µï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»º2ä¸ªæ•°æ®åº“å®ä¾‹-æˆ‘å°†ä½¿ç”¨2ç§ç±»å‹çš„ç¯å¢ƒï¼šSTGï¼ˆåˆ†æ®µï¼‰æ¥æµ‹è¯•æ–°â€œåŠŸèƒ½â€çš„å®ç°ä»¥åŠPRODï¼ˆç”Ÿäº§ï¼‰ç›´æ¥ä½œä¸ºâ€œæˆ˜æ–—â€çš„å®ç°ä¼ºæœå™¨ å…³äºæ‰˜ç®¡æœåŠ¡æ•°æ®åº“çš„å¥½å¤„ï¼Œå·²ç»å†™äº†å¾ˆå¤šæ–‡ç« ï¼Œæ­¤å¤–ï¼Œåœ¨æœ¬æŒ‡å—ä¸­ï¼Œæˆ‘ä»¬ä¸»è¦æ˜¯ä¸ºå¼€å‘äººå‘˜å¯»æ±‚ä¾¿åˆ©ï¼Œå› æ­¤æˆ‘ä»¬ä½¿ç”¨RDSï¼Œè€Œä¸æ˜¯å¼€å‘è‡ªå·±çš„ç‹¬ç«‹æ•°æ®åº“æœåŠ¡å™¨ã€‚ ä½œä¸ºè¯¥ç¤ºä¾‹çš„DBMSï¼Œæˆ‘ä½¿ç”¨äº†PostgreSQLï¼Œæ‚¨å¯ä»¥è‡ªç”±é€‰æ‹©é€‚åˆæ‚¨çš„ä»»ä½•ä¸€ç§ï¼Œè½¬åˆ°RDSæœåŠ¡å¹¶åˆ›å»ºæ‰€éœ€å®¹é‡å’Œå®¹é‡çš„2ä¸ªå®ä¾‹ã€‚ ç”±äº<code>.env</code>æ–‡ä»¶å¯åœ¨Symfonyä¸­â€œå¼€ç®±å³ç”¨â€åœ°ä½¿ç”¨ï¼Œå› æ­¤æˆ‘ä»¬å°†ä½¿ç”¨å®ƒï¼ˆä¾‹å¦‚ï¼Œå¯¹äºPRODï¼‰ï¼Œå¯¹äºSTGï¼Œæˆ‘ä»¬å°†åˆ›å»º<code>.env.stg</code>çš„å‰¯æœ¬ï¼Œ <code>.env.stg</code>å’Œ<code>APP_ENV=dev</code>æ›´æ”¹ä¸º<code>APP_ENV=stg</code> <code>APP_ENV=dev</code> <code>APP_ENV=prod</code> <code>APP_ENV=dev</code> <code>APP_ENV=prod</code> ï¼Œå¹¶ä¸”è¿˜ä¸ºæ¯ä¸ªåˆ›å»ºçš„å®ä¾‹è¾“å…¥<code>.env</code>è¿æ¥å‚æ•°ã€‚ <br><br> å¤ªå¥½äº†ï¼Œå·²ç»å¼€å§‹äº†ï¼ å¦‚æ‚¨æ‰€çŸ¥ï¼Œsymfonyä¾èµ–é¡¹æ˜¯é€šè¿‡composerå®‰è£…çš„ï¼Œè¦å®‰è£…å®ƒï¼Œè¯·ä½¿ç”¨composer.shæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶ä½äºé¡¹ç›®çš„æ ¹ç›®å½•ä¸­ï¼š <br><br><div class="spoiler">  <b class="spoiler_title">ä½œæ›²å®¶</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">#!/bin/sh EXPECTED_SIGNATURE="$(wget -q -O - https://composer.github.io/installer.sig)" php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');" ACTUAL_SIGNATURE="$(php -r "echo hash_file('sha384', 'composer-setup.php');")" if [ "$EXPECTED_SIGNATURE" != "$ACTUAL_SIGNATURE" ] then &gt;&amp;2 echo 'ERROR: Invalid installer signature' rm composer-setup.php exit 1 fi php composer-setup.php --quiet RESULT=$? rm composer-setup.php exit $RESULT</code> </pre> <br></div></div><br> è¿™<a href="">æ˜¯composerçš„è½¯ä»¶å®‰è£…</a>æŒ‡å—ã€‚ <br><br> ç°åœ¨ï¼Œå¯¹äºæ¯ç§ç¯å¢ƒï¼Œåœ¨é¡¹ç›®çš„æ ¹ç›®å½•ä¸­åˆ›å»ºè‡ªå·±çš„Dockerfileï¼š <br><br><div class="spoiler">  <b class="spoiler_title">Dockerfile.stgï¼ˆæš‚å­˜ï¼‰</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">FROM php:7.2.19-apache EXPOSE 80 RUN mv "$PHP_INI_DIR/php.ini-production" "$PHP_INI_DIR/php.ini" &amp;&amp; a2enmod rewrite RUN sed -ri -e 's!memory_limit = 128M!memory_limit = 256M!g' "$PHP_INI_DIR/php.ini" RUN apt-get update &amp;&amp; apt-get install -y \ wget \ curl \ libfreetype6-dev \ libjpeg62-turbo-dev \ libpng-dev \ libzip-dev \ zip \ libpq-dev \ &amp;&amp; docker-php-ext-configure gd --with-freetype-dir=/usr/include/ --with-jpeg-dir=/usr/include/ \ &amp;&amp; docker-php-ext-configure zip --with-libzip \ &amp;&amp; docker-php-ext-configure pgsql -with-pgsql=/usr/local/pgsql \ &amp;&amp; docker-php-ext-install -j$(nproc) gd \ &amp;&amp; docker-php-ext-install zip \ &amp;&amp; docker-php-ext-install pdo pdo_pgsql pgsql WORKDIR /var/www ENV APACHE_DOCUMENT_ROOT /var/www/public RUN sed -ri -e 's!/var/www/html!${APACHE_DOCUMENT_ROOT}!g' /etc/apache2/sites-available/*.conf RUN sed -ri -e 's!/var/www/!${APACHE_DOCUMENT_ROOT}!g' /etc/apache2/apache2.conf /etc/apache2/conf-available/*.conf RUN echo "ServerName localhost" &gt;&gt; /etc/apache2/apache2.conf COPY ./composer.sh ./ RUN chmod +x ./composer.sh &amp;&amp; ./composer.sh &amp;&amp; mv composer.phar /usr/local/bin/composer RUN curl -sL https://deb.nodesource.com/setup_10.x | bash - \ &amp;&amp; apt-get install -y nodejs RUN curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add - \ &amp;&amp; echo "deb https://dl.yarnpkg.com/debian/ stable main" | tee /etc/apt/sources.list.d/yarn.list \ &amp;&amp; apt-get update -qq \ &amp;&amp; apt-get install -y yarn COPY ./ ./ COPY ./.env.stg ./.env RUN composer install &amp;&amp; yarn &amp;&amp; yarn run build</code> </pre> <br></div></div><br> å’Œ <br><br><div class="spoiler">  <b class="spoiler_title">Dockerfileï¼ˆç”Ÿäº§ï¼‰</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">FROM php:7.2.19-apache EXPOSE 80 RUN mv "$PHP_INI_DIR/php.ini-production" "$PHP_INI_DIR/php.ini" &amp;&amp; a2enmod rewrite RUN sed -ri -e 's!memory_limit = 128M!memory_limit = 256M!g' "$PHP_INI_DIR/php.ini" RUN apt-get update &amp;&amp; apt-get install -y \ wget \ curl \ libfreetype6-dev \ libjpeg62-turbo-dev \ libpng-dev \ libzip-dev \ zip \ libpq-dev \ &amp;&amp; docker-php-ext-configure gd --with-freetype-dir=/usr/include/ --with-jpeg-dir=/usr/include/ \ &amp;&amp; docker-php-ext-configure zip --with-libzip \ &amp;&amp; docker-php-ext-configure pgsql -with-pgsql=/usr/local/pgsql \ &amp;&amp; docker-php-ext-install -j$(nproc) gd \ &amp;&amp; docker-php-ext-install zip \ &amp;&amp; docker-php-ext-install pdo pdo_pgsql pgsql WORKDIR /var/www ENV APACHE_DOCUMENT_ROOT /var/www/public RUN sed -ri -e 's!/var/www/html!${APACHE_DOCUMENT_ROOT}!g' /etc/apache2/sites-available/*.conf RUN sed -ri -e 's!/var/www/!${APACHE_DOCUMENT_ROOT}!g' /etc/apache2/apache2.conf /etc/apache2/conf-available/*.conf RUN echo "ServerName localhost" &gt;&gt; /etc/apache2/apache2.conf COPY ./composer.sh ./ RUN chmod +x ./composer.sh &amp;&amp; ./composer.sh &amp;&amp; mv composer.phar /usr/local/bin/composer RUN curl -sL https://deb.nodesource.com/setup_10.x | bash - \ &amp;&amp; apt-get install -y nodejs RUN curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add - \ &amp;&amp; echo "deb https://dl.yarnpkg.com/debian/ stable main" | tee /etc/apt/sources.list.d/yarn.list \ &amp;&amp; apt-get update -qq \ &amp;&amp; apt-get install -y yarn COPY ./ ./ RUN composer install &amp;&amp; yarn &amp;&amp; yarn run build</code> </pre> <br></div></div><br> æ–‡ä»¶å¯ä»¥â€œæŒ‰åŸæ ·â€ä½¿ç”¨ï¼Œæ²¡æœ‰å®ç”¨äºæ›´æ”¹ã€‚ è®©æˆ‘ä»¬éå†Dockerfileçš„å†…å®¹ä»¥æ¶ˆé™¤â€œé­”å¹»â€çš„è”ç³»ã€‚ ä½œä¸ºâ€œåŸºç¡€â€ï¼Œæˆ‘ä»¬å°†å®˜æ–¹çš„PHP 7.2.19æ˜ åƒä¸é›†æˆçš„Apache WebæœåŠ¡å™¨ä¸€èµ·ä½¿ç”¨ï¼ˆæ‚¨å¯ä»¥éšæ„ä½¿ç”¨ä»»ä½•é€‰æ‹©ï¼Œä¸Nginxé…ç½®æ†ç»‘åŒ…ï¼Œä¾æ­¤ç±»æ¨ï¼Œåœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘è®¤ä¸ºä»¥ä¸Šç¤ºä¾‹æœ€å¤šï¼‰æ–¹ä¾¿ï¼‰ã€‚ ç›®å‰ï¼Œå…¬å¼€è¡Œå¯¹æˆ‘ä»¬å¹¶ä¸é‡è¦ï¼Œå®ƒæœ¬èº«ä»€ä¹ˆä¹Ÿä¸åšï¼Œä½†æ˜¯å°†æ¥å®ƒå°†ç”±ElasticBeanstalkä½¿ç”¨ï¼Œéœ€è¦å®ƒæ­£ç¡®éƒ¨ç½²ã€‚ ä»¥ä¸‹æ„é€ ä½¿ç”¨åˆ¶é€ å•†æ¨èçš„PHPä¼˜åŒ–ç”Ÿäº§è®¾ç½®ï¼Œæ¿€æ´»Apacheçš„mod_rewriteå¹¶å°†PHPè„šæœ¬çš„æœ€å¤§å†…å­˜ä»128 mbå¢åŠ åˆ°256 mbï¼Œè¿™å¯¹äºä½œæ›²å®¶æ­£å¸¸å·¥ä½œæ˜¯å¿…éœ€çš„ã€‚ æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å®‰è£…å¿…è¦çš„åº”ç”¨ç¨‹åºï¼ŒPHPä¾èµ–é¡¹å’Œæ‰©å±•ï¼Œå¹¶ç«‹å³å¯¹å…¶è¿›è¡Œé…ç½®ã€‚ æˆ‘ä»¬å°†æ–‡ä»¶å¤¹/ var / wwwåˆ†é…ç»™åº”ç”¨ç¨‹åºçš„å·¥ä½œç›®å½•-åº”ç”¨ç¨‹åºçš„æºä»£ç å°†å¤åˆ¶åˆ°è¯¥ç›®å½•ä¸­ã€‚ ç”±äºé»˜è®¤æƒ…å†µä¸‹ï¼Œapacheä½¿ç”¨/ var / wwwä½œä¸ºå…¶ä¸»æœºçš„å…¥å£ç‚¹ï¼Œå¹¶ä¸”symfonyç´¢å¼•æ–‡ä»¶ä½äº/ var / www / publicä¸­ï¼Œå› æ­¤æˆ‘ä»¬ä½¿ç”¨ä»¥ä¸‹ç»“æ„æ›´æ”¹apacheæ–‡æ¡£çš„æ ¹ç›®å½•ã€‚ ç„¶åï¼Œæˆ‘ä»¬ä¾æ¬¡å®‰è£…composerï¼Œnodejså’Œyarnï¼ˆå¦‚æœæ‚¨åœ¨åº”ç”¨ç¨‹åºä¸­ä¸ä½¿ç”¨encore / react.jsï¼Œåˆ™ä¸éœ€è¦æœ€åä¸¤ç‚¹ï¼‰ã€‚ æœ€åï¼Œæˆ‘ä»¬å¤åˆ¶æºä»£ç ï¼Œå¹¶é€šè¿‡composeræ¥å®‰è£…symfonyçš„ä¾èµ–å…³ç³»ï¼Œå¹¶é€šè¿‡yarnæ¥è¿›è¡Œreact.jsçš„ä¾èµ–å…³ç³»çš„å®‰è£…ã€‚ ç”¨äºSTGçš„å•ç‹¬Dockerfileçš„å«ä¹‰åœ¨äºå€’æ•°ç¬¬äºŒæ¡æŒ‡ä»¤ï¼Œç”¨äºå°†docker-å°†.env.stgå¤åˆ¶åˆ°.envï¼Œå› æ­¤STGæ˜ åƒä¸­çš„.envæ–‡ä»¶å°†åŒ…å«ä¸æ­¤ç¯å¢ƒç›¸å…³çš„å‚æ•°ã€‚ æ‚¨å¯ä»¥åœ¨æœ¬åœ°ï¼ˆå½“ç„¶å®‰è£…äº†dockerï¼‰æ”¶é›†å›¾åƒï¼Œè¿è¡Œå®ƒå¹¶ç¡®ä¿åº”ç”¨ç¨‹åºæ­£åœ¨è¿è¡Œï¼Œå¹¶ä¸”ä¸éœ€è¦å…¶ä»–ä»»ä½•å·¥ä½œï¼š <br><br><pre> <code class="plaintext hljs">docker build -t tmp:stg -f Dockerfile.stg . docker run -p 80:80 tmp:stg</code> </pre> <br> å¯¹äºSTGå’Œ <br><br><pre> <code class="plaintext hljs">docker build -t tmp:prod . docker run -p 80:80 tmp:prod</code> </pre> <br> ç”¨äºPRODã€‚ <br> æˆ‘ä»¬å¯ä»¥ä½¿ç”¨EC2ï¼Œé…ç½®ELB / ASGç­‰ï¼Œæˆ–ä½¿ç”¨ElasticBeanstalkï¼Œè¿™åªæ˜¯ç»™æˆ‘ä»¬å¸¦æ¥çš„ä¾¿åˆ©ã€‚ è½¬åˆ°ElasticBeanstalkéƒ¨åˆ†ï¼Œå¹¶ä½¿ç”¨å…¶åç§°å’Œæè¿°åˆ›å»ºä¸€ä¸ªæ–°åº”ç”¨ç¨‹åºã€‚ ç„¶ååˆ›å»ºä¸¤ä¸ªå‰é¢æåˆ°çš„ç¯å¢ƒï¼šSTGå’ŒPRODï¼Œå°†è¿™ä¸¤ä¸ªç¯å¢ƒéƒ½åˆ›å»ºä¸ºWebæœåŠ¡å™¨ç¯å¢ƒï¼Œå°†â€œ Dockerâ€æŒ‡å®šä¸ºå¹³å°ï¼Œå¹¶å°†Sampleåº”ç”¨ç¨‹åºä¿ç•™ä¸ºåº”ç”¨ç¨‹åºä»£ç ã€‚ éƒ¨ç½²åˆ°ElasticBeanstalkçš„æ–¹æ³•æ˜¯ä¸Šä¼ é¡¹ç›®æ–‡ä»¶æˆ–è¯´æ˜ï¼Œé€šå¸¸æ˜¯åœ¨zipå­˜æ¡£ä¸­ã€‚ åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæµç¨‹å°†æ˜¯è¿™æ ·çš„ï¼šæˆ‘ä»¬æ”¶é›†åº”ç”¨ç¨‹åºçš„Dockeræ˜ åƒï¼Œå°†å…¶åŠ è½½åˆ°å­˜å‚¨åº“ä¸­å¹¶åŠ è½½æŒ‡ä»¤ï¼Œè€Œä¸æ˜¯æºå½’æ¡£æˆ–Dockeræ˜ åƒï¼Œè¿™å‘Šè¯‰ElasticBeanstalkä»è¿œç¨‹æœåŠ¡å™¨è·å–è¯¥æ˜ åƒå¹¶è¿›è¡Œéƒ¨ç½²ã€‚ æ‰€æœ‰è¿™ä¸€åˆ‡éƒ½æ˜¯è‡ªåŠ¨çš„ã€‚ <br><br> è®©æˆ‘ä»¬ä»åˆ›å»ºç”¨äºå­˜å‚¨dockeræ˜ åƒçš„å­˜å‚¨åº“å¼€å§‹ã€‚ æœ‰2ä¸ªé€‰é¡¹ï¼š <br><br>  1-æ‚¨çš„é¡¹ç›®æ˜¯ç§æœ‰çš„ï¼Œå…¶ä»£ç å·²å…³é—­ï¼Œå¹¶ä¸”å­˜å‚¨åº“ä¹Ÿå¿…é¡»åˆ†åˆ«å…³é—­ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥å°†è‡ªå·±çš„å›¾åƒæ³¨å†Œä¿å­˜åœ¨æŸä¸ªåœ°æ–¹ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ç§æœ‰äº‘ã€‚  AWSå…·æœ‰ç”¨äºè¿™äº›ç›®çš„çš„ECRï¼Œæ‚¨å¯ä»¥åœ¨æ­¤å¤„åˆ›å»ºå­˜å‚¨åº“ï¼Œä½†æ˜¯æ²¡æœ‰äººå¼ºè¿«æ‚¨è¿™æ ·åšã€‚ <br><br>  2-æ‚¨æœ‰ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œå¯ä»¥ä½¿ç”¨dockerhubã€‚ <br><br> åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œä»£ç æ˜¯å¼€æ”¾çš„ï¼Œä½†æ˜¯æˆ‘å°†å±•ç¤ºå¦‚ä½•ä½¿ç”¨å°é—­çš„å­˜å‚¨åº“ï¼Œåœ¨ç†è§£äº†æ­¤è¿‡ç¨‹ä¹‹åï¼Œä»dockerhubè¿æ¥æ˜ åƒå¹¶ä¸å›°éš¾ã€‚ æˆ‘ä»¬éœ€è¦åšçš„ç¬¬ä¸€ä»¶äº‹æ˜¯åˆ›å»ºå­˜å‚¨åº“æœ¬èº«ï¼Œä¹‹åæ‚¨å°†è·å¾—å…¶å”¯ä¸€çš„URIã€‚ è¿›ä¸€æ­¥çš„å™è¿°å°†é’ˆå¯¹ç¬¬ä¸‰æ–¹ï¼ˆè€ŒéAWS ECRå­˜å‚¨åº“åŠå…¶é›†æˆï¼‰ï¼Œå¯¹äºECRï¼Œæˆ‘å°†åœ¨æ­¤ä¹‹åç¼–å†™ã€‚ <br><br> åˆ›å»ºå­˜å‚¨åº“åï¼Œæˆ‘ä»¬éœ€è¦ç™»å½•åˆ°æ­¤æœåŠ¡ï¼Œå¹¶ä¸”æœ‰ä¸€ä¸ªå°æŠ€å·§...è½¬åˆ°æœ¬åœ°å®‰è£…çš„Dockerçš„è®¾ç½®ï¼Œå¹¶æ£€æŸ¥æ˜¯å¦å¯ä»¥é€‰æ‹©å°†å¯†ç ä¿å­˜åœ¨å·²åˆ é™¤çš„å¤–éƒ¨å­˜å‚¨ä¸­ï¼ˆå¯¹äºmacOSç”¨æˆ·ï¼šâ€œå®‰å…¨å­˜å‚¨dockerç™»å½•ååœ¨macOS Keychainä¸­ï¼‰ï¼Œå¦åˆ™æˆ‘ä»¬éœ€è¦çš„é…ç½®æ–‡ä»¶å°†ä¸ºç©ºã€‚ å› æ­¤ï¼Œæˆ‘ä»¬æˆæƒæ‰€é€‰æœåŠ¡å­˜å‚¨æ‚¨çš„å›¾åƒå¯„å­˜å™¨ï¼š <br><br><pre> <code class="plaintext hljs">docker login -u LOGIN -p PASSWORD REGISTRY</code> </pre> <br> æˆåŠŸé€šè¿‡èº«ä»½éªŒè¯åï¼Œä»¥ä¸‹æ„é€ å°†å‡ºç°åœ¨ã€œ/ .docker / config.jsoné…ç½®æ–‡ä»¶ä¸­ï¼š <br><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"REGISTRY"</span></span> : { <span class="hljs-attr"><span class="hljs-attr">"auth"</span></span> : <span class="hljs-string"><span class="hljs-string">"BASE64_ENCODED_TOKEN"</span></span> }</code> </pre><br> å¦‚æœæœªå‡ºç°ï¼Œè¯·å†æ¬¡æ£€æŸ¥ä¸Šè¿°dockeré…ç½®ã€‚ <br><br> ç°åœ¨ä¸€åˆ‡å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥ä¸ºElasticBeanstalk-Dockerrun.aws.jsonå‡†å¤‡æŒ‡ä»¤æ–‡ä»¶ï¼Œå…¶ä»£ç å°†å¦‚ä¸‹æ‰€ç¤ºï¼š <br><br><div class="spoiler">  <b class="spoiler_title">Dockerrun.aws.json</b> <div class="spoiler_text"><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"AWSEBDockerrunVersion"</span></span>: <span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"Authentication"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"Bucket"</span></span>: <span class="hljs-string"><span class="hljs-string">"BUCKET_ID"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"Key"</span></span>: <span class="hljs-string"><span class="hljs-string">"KEY_PATH"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"Image"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"Name"</span></span>: <span class="hljs-string"><span class="hljs-string">"IMAGE_URL"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"Update"</span></span>: <span class="hljs-string"><span class="hljs-string">"true"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"Ports"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"ContainerPort"</span></span>: <span class="hljs-string"><span class="hljs-string">"80"</span></span> } ] }</code> </pre><br></div></div><br> é€šå¸¸ï¼Œè¯¥æŒ‡ä»¤å¦‚ä¸‹æ‰€ç¤ºï¼šä½¿ç”¨KEY_PATHä½äºS3å­˜å‚¨åŒºBUCKET_IDä¸­çš„å¯†é’¥ç™»å½•ï¼Œé€šè¿‡IMAGE_URLè¦†ç›–å·²ä¿å­˜çš„å›¾åƒåŠ è½½å›¾åƒï¼Œé€šè¿‡å°†ç«¯å£80è½¬å‘åˆ°å®¹å™¨ä¸Šçš„ç›¸åŒç«¯å£æ¥å¯åŠ¨å®ƒã€‚ ç°åœ¨å…³äºä½¿ç”¨çš„å¸¸é‡ï¼š <br><br>  BUCKET_IDæ˜¯åœ¨S3æœåŠ¡ä¸­è‡ªåŠ¨ä¸ºæ‚¨åˆ›å»ºçš„â€œèƒŒåŒ…â€ï¼Œæ ¼å¼ä¸ºelasticbeanstalk-REGION-HASHï¼Œåœ¨è¿™é‡Œç³»ç»Ÿå¯ä»¥æ‰¾åˆ°ElasticBeanstalkçš„æœåŠ¡æ–‡ä»¶ï¼ŒåŒ…æ‹¬ä½¿ç”¨â€œä¸Šä¼ å’Œéƒ¨ç½²â€æŒ‰é’®ä¸‹è½½çš„åº”ç”¨ç¨‹åºæ–‡ä»¶ã€‚ <br><br>  KEY_PATH-å›¾åƒå­˜å‚¨åº“æˆæƒæ–‡ä»¶çš„è·¯å¾„ï¼Œæˆ‘ä½¿ç”¨APP_NAME / cr.jsonæ ¼å¼ï¼Œå³åœ¨æˆ‘çš„åº”ç”¨ç¨‹åºåç§°ä¸‹BUCKET_IDå†…çš„æ–‡ä»¶å¤¹ä¸­ï¼ˆæˆ‘åˆ›å»ºï¼Œå¦‚æœå°šæœªåˆ›å»ºï¼‰ï¼Œæˆ‘å°†åŒ…å«æˆæƒåæ”¶åˆ°çš„ä»£ç çš„cr.jsonæ–‡ä»¶æ”¾å…¥å¯„å­˜å™¨ä¸­æœ¬åœ°å›¾åƒï¼š <br><br><div class="spoiler">  <b class="spoiler_title">BUCKET_ID / APP_NAME / cr.json</b> <div class="spoiler_text"><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"REGISTRY"</span></span> : { <span class="hljs-attr"><span class="hljs-attr">"auth"</span></span> : <span class="hljs-string"><span class="hljs-string">"BASE64_ENCODED_TOKEN"</span></span> } }</code> </pre> </div></div><br>  IMAGE_URLæ˜¯å›¾åƒå¯„å­˜å™¨çš„å”¯ä¸€URI +å›¾åƒæœ¬èº«çš„æ ‡ç­¾ï¼Œæ­¤å¤„åº”æ¸…é™¤æ‰€æœ‰å†…å®¹ã€‚ <br><br> å°±æ˜¯è¿™æ ·ï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥åœ¨ElasticBeanstalkä¸­å°†è¯¥æ–‡ä»¶ä¸‹è½½ä¸ºåº”ç”¨ç¨‹åºçš„ç‰ˆæœ¬ï¼Œä»–å°†æå–æŒ‡å®šçš„æ˜ åƒå¹¶è¿›è¡Œéƒ¨ç½²ã€‚ <br><br> ä»ç„¶å¯ä»¥è‡ªåŠ¨æ‰§è¡Œæ­¤è¿‡ç¨‹ã€‚ ç»å¯¹æœ‰è¶£çš„æ˜¯ï¼Œæˆ‘å°†ä¸ºä¸‹ä¸€ä¸ªæµç¨‹å®ç°æ­¥éª¤åºåˆ—ï¼šå¯¹äºä¸åœ¨masteråˆ†æ”¯ä¸­çš„æ‰€æœ‰æäº¤ï¼Œæ˜ åƒå°†è¢«æ”¶é›†å¹¶éƒ¨ç½²åœ¨STGç¯å¢ƒä¸­ï¼Œå¦‚æœæˆ‘ä»¬æ¨é€åˆ°masterä¸­ï¼Œæˆ–è€…æ›´å¥½çš„æ˜¯ï¼Œå°†å…¶å…³é—­å¹¶ç”¨åˆå¹¶è¯·æ±‚å¡«å……ï¼Œåˆ™ä»£ç å°†éƒ¨ç½²åœ¨PRODä¸Šã€‚ å› æ­¤ï¼Œæˆ‘ä»¬åœ¨PRODä¸­è·å¾—äº†ä¸€ä¸ªæœ€æ–°çš„å‘å¯¼ï¼Œè¯¥å‘å¯¼ä¸­çš„æ‰€æœ‰å†…å®¹å‡åº”æ­£å¸¸è¿è¡Œï¼Œå¹¶å…·æœ‰ç”¨äºåœ¨STGä¸­å¼€å‘å’Œæµ‹è¯•æ–°ä»£ç çš„åˆ†æ”¯ã€‚ å¯¹äºæ­¤å®ç°ï¼Œæˆ‘ä»¬éœ€è¦æœ‰å…³ä¸Šä¼ éæœ€æ–°å›¾åƒçš„è¯´æ˜ï¼Œå°†Dockerrun.aws.jsonå¤åˆ¶åˆ°Dockerrun.aws.stg.jsonï¼Œå¹¶å°†Dockerrun.aws.jsoné‡å‘½åä¸ºDockerrun.aws.prod.jsonï¼ˆä»…ä¸ºæ–¹ä¾¿èµ·è§ï¼‰ã€‚ <br><br> å°†Dockerrun.aws.stg.jsonä¸Dockerrun.aws.prod.jsonåŒºåˆ«å¼€çš„å”¯ä¸€ä¸œè¥¿æ˜¯IMAGE_URLï¼š <br><br><div class="spoiler">  <b class="spoiler_title">Dockerrun.aws.stg.json</b> <div class="spoiler_text"><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"AWSEBDockerrunVersion"</span></span>: <span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"Authentication"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"Bucket"</span></span>: <span class="hljs-string"><span class="hljs-string">"BUCKET_ID"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"Key"</span></span>: <span class="hljs-string"><span class="hljs-string">"KEY_PATH"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"Image"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"Name"</span></span>: <span class="hljs-string"><span class="hljs-string">"IMAGE_URL:dev"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"Update"</span></span>: <span class="hljs-string"><span class="hljs-string">"true"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"Ports"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"ContainerPort"</span></span>: <span class="hljs-string"><span class="hljs-string">"80"</span></span> } ] }</code> </pre><br></div></div><br> æ­£å¦‚æˆ‘åœ¨æ–‡ç« å¼€å¤´æ‰€è¯´ï¼Œæˆ‘å°†ä½¿ç”¨CircleCIä½œä¸ºCI / CDï¼Œæ ¹æ®æˆ‘çš„ä¸ªäººæ„Ÿè§‰ï¼Œå¦‚æœä½¿ç”¨å…è´¹çš„SaaSç‰ˆæœ¬ï¼Œå®ƒçš„é€Ÿåº¦å°†æ¯”GitlabCIå¿«ã€‚  Free Traviså¯ä»¥åšåˆ°ï¼Œä½†æ˜¯ç”±äºå®ƒä¸é€‚ç”¨äºç§äººgitå­˜å‚¨åº“ï¼Œå› æ­¤æˆ‘æ²¡æœ‰ä¸“é—¨è¿›è¡Œæ¼”ç¤ºï¼Œå› æ­¤åœ¨éœ€è¦è¿™ç§æœºä¼šæ—¶ä¸ä¼šæ„Ÿåˆ°å¤±æœ›ã€‚ æˆ‘å°†æŠŠCircleCIä¸­é¡¹ç›®çš„è®¾ç½®ç•™ç»™è¯»è€…è¿›è¡Œç‹¬ç«‹ç ”ç©¶ï¼Œæˆ‘è‡ªå·±ç»™å‡ºéƒ¨ç½²æ‰€éœ€çš„è¯´æ˜-åœ¨æˆ‘ä»¬é¡¹ç›®çš„æ ¹ç›®å½•ä¸­ï¼Œæˆ‘ä»¬å°†åœ¨.configæ–‡ä»¶ä¸­åˆ›å»º.circleciæ–‡ä»¶å¤¹ï¼Œå…¶ä¸­config.ymlå…·æœ‰ä»¥ä¸‹å†…å®¹ï¼š <br><br><div class="spoiler">  <b class="spoiler_title">.circleci /é…ç½®æ–‡ä»¶</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">version: 2 jobs: build: machine: true steps: - checkout - run: echo "$CI_REGISTRY_PASSWORD" | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY - run: docker build -t $CI_REGISTRY/$CI_REGISTRY_ID:dev -f Dockerfile.stg . - run: docker push $CI_REGISTRY/$CI_REGISTRY_ID:dev build-master: machine: true steps: - checkout - run: echo "$CI_REGISTRY_PASSWORD" | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY - run: docker build -t $CI_REGISTRY/$CI_REGISTRY_ID:latest . - run: docker push $CI_REGISTRY/$CI_REGISTRY_ID:latest deploy-stg: docker: - image: circleci/python:latest steps: - checkout - run: sudo pip install awsebcli --upgrade - run: | mkdir ~/.aws touch ~/.aws/config chmod 600 ~/.aws/config echo "[profile eb-cli]" &gt; ~/.aws/config echo "aws_access_key_id=$AWS_ACCESS_KEY_ID" &gt;&gt; ~/.aws/config echo "aws_secret_access_key=$AWS_SECRET_ACCESS_KEY" &gt;&gt; ~/.aws/config - run: eb init --region EB_REGION --platform Docker EB_APP - run: cp Dockerrun.aws.stg.json Dockerrun.aws.json - run: eb use EB_ENV_STG --region EB_REGION - run: eb deploy -v --staged --profile eb-cli deploy-prod: docker: - image: circleci/python:latest steps: - checkout - run: sudo pip install awsebcli --upgrade - run: | mkdir ~/.aws touch ~/.aws/config chmod 600 ~/.aws/config echo "[profile eb-cli]" &gt; ~/.aws/config echo "aws_access_key_id=$AWS_ACCESS_KEY_ID" &gt;&gt; ~/.aws/config echo "aws_secret_access_key=$AWS_SECRET_ACCESS_KEY" &gt;&gt; ~/.aws/config - run: eb init --region EB_REGION --platform Docker EB_APP - run: cp Dockerrun.aws.prod.json Dockerrun.aws.json - run: eb use EB_ENV_STG --region EB_REGION - run: eb deploy -v --staged --profile eb-cli workflows: version: 2 build: jobs: - build: filters: branches: ignore: - master - deploy-stg: requires: - build filters: branches: ignore: - master build-deploy: jobs: - build-master: filters: branches: only: - master - deploy-prod: requires: - build-master filters: branches: only: - master</code> </pre></div></div><br> æˆ‘æ—©äº›æ—¶å€™ç”»äº†æµç¨‹æœ¬èº«ï¼Œåœ¨è¿™é‡Œå®ƒè¢«ç¿»è¯‘æˆCircleCIçš„yamlæŒ‡ä»¤ï¼Œè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹å…·ä½“æ­¥éª¤çš„å®ç°ã€‚ é‡è¦çš„æ˜¯è¦æ³¨æ„å­˜åœ¨ä¸ºCIå®šä¹‰çš„ç¯å¢ƒå˜é‡ï¼Œè¯¥å˜é‡å°†ç”±ä»–åœ¨å·¥ä½œæœŸé—´ä½¿ç”¨ï¼š <br><br> éœ€è¦CI_REGISTRYï¼ŒCI_REGISTRY_USERå’ŒCI_REGISTRY_PASSWORDæ¥è®¿é—®Dockeræ˜ åƒå­˜å‚¨-ä¸æˆ‘ä»¬åœ¨cr.jsonä¸­æ”¾å…¥çš„å†…å®¹ç›¸åŒï¼Œåªä¸è¿‡æ²¡æœ‰base64 <br><br>  CI_REGISTRY / CI_REGISTRY_IDç»„æˆä¸€ä¸ªå”¯ä¸€çš„å›¾åƒURLï¼Œä¸å¸¦æ ‡ç­¾ <br><br>  AWS_ACCESS_KEY_IDå’ŒAWS_SECRET_ACCESS_KEY-åç§°å¯ä»¥è¯´æ˜ä¸€åˆ‡ï¼Œè¿™äº›æ˜¯ä¸ºCircleCIä»£è¡¨å…¶éƒ¨ç½²çš„ç”¨æˆ·çš„AWSç§¯åˆ†ã€‚ è½¬åˆ°AWS IAMå¹¶åˆ›å»ºä¸€ä¸ªç”¨æˆ·ï¼Œå°†å…¶æ·»åŠ åˆ°ç®¡ç†å‘˜ç»„ä¸­ï¼Œå¹¶ä»…æä¾›ç¼–ç¨‹è®¿é—®æƒé™ã€‚ è¯·è®°ä½ï¼ŒAWS_SECRET_ACCESS_KEYä»…å¯æŸ¥çœ‹/å¤åˆ¶ä¸€æ¬¡ï¼Œåœ¨æ‚¨å•å‡»â€œæ˜¾ç¤ºâ€é“¾æ¥åï¼Œæ‚¨å°†ä¸ä¼šå†æ¬¡çœ‹åˆ°å®ƒã€‚ <br><br> è¿”å›CircleCIé…ç½®æ­¥éª¤ã€‚ ä»€ä¹ˆæ˜¯é­”æœ¯ï¼Ÿ  Checkoutå°†æºä»£ç ä»gitåˆ†æ”¯åŠ è½½åˆ°å½“å‰å·¥ä½œç›®å½•ä¸­ï¼Œæ­¤è¿‡ç¨‹åœ¨æ¯ä¸ªä½œä¸šä¸­éƒ½é‡å¤è¿›è¡Œã€‚ åœ¨æ„å»ºè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬é¡ºåºç™»å½•åˆ°å­˜å‚¨åº“ï¼ŒåŸºäºDockerfile.stgåœ¨XXXï¼šdevæ ‡ç­¾ä¸‹æ”¶é›†ä»£ç ï¼Œå¹¶å°†å…¶å‘é€åˆ°å­˜å‚¨åº“ã€‚  build-masterä¼šæ‰§è¡Œç›¸åŒçš„æ“ä½œï¼Œä»…å¯¹äºå…¶æ„å»ºä½¿ç”¨æ ‡ç­¾â€œ XXXï¼šLatestâ€ä¸‹çš„â€œ normalâ€ Dockerfileã€‚ <br><br>  deploy-stgå°†å®‰è£…AWS EB CLIå¹¶åœ¨ã€œ/ .aws / configæ–‡ä»¶ä¸­åˆ›å»ºä¸€ä¸ªæˆæƒé…ç½®æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶æ˜¯CLIæ­£å¸¸å·¥ä½œæ‰€å¿…éœ€çš„ï¼Œç„¶ååˆå§‹åŒ–CLIçš„å˜é‡-æ‚¨å°†éœ€è¦æŒ‡å®šé€‰æ‹©çš„åŒºåŸŸï¼Œå¹³å°-å§‹ç»ˆæ˜¯Dockerå’Œæ‚¨çš„åº”ç”¨ç¨‹åºåç§°ã€‚ æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†Dockerrun.aws.stg.jsonçš„å†…å®¹å¤åˆ¶åˆ°æ–°çš„Dockerrun.aws.jsonæ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨ç‰¹å®šçš„ç¯å¢ƒå’ŒåŒºåŸŸï¼Œç»™å‡ºå‘½ä»¤ä»¥ä½¿ç”¨åˆ›å»ºçš„æˆæƒé…ç½®æ–‡ä»¶éƒ¨ç½²æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œä½œä¸ºæ­¤å‘½ä»¤çš„ç»“æœï¼Œå—ç›‘è§†åˆ†æ”¯çš„æ‰€æœ‰ä»£ç éƒ½å°†æœ€ç»ˆå­˜å‚¨åœ¨ä¸€ä¸ªzipå½’æ¡£æ–‡ä»¶ä¸­ï¼Œè¯¥æ–‡ä»¶å°†ä¸‹è½½åˆ°ElasticBeanstalkå¹¶åœ¨é‚£é‡Œè§£å‹ç¼©ï¼Œä½†æ˜¯æ­¤æ“ä½œç›¸å¯¹æ˜‚è´µï¼Œå› æ­¤æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„Dockerrun.aws.jsonæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶è¶³ä»¥éƒ¨ç½²æˆ‘ä»¬åˆ›å»ºçš„æ–‡ä»¶è¿œç¨‹æ˜ åƒï¼Œå®é™…ä¸Šæˆ‘ä»¬åªéœ€è¦ä¸Šä¼ å®ƒã€‚ ä¸ºæ­¤ï¼Œè¯·åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª.ebignoreæ–‡ä»¶ï¼š <br><br><div class="spoiler">  <b class="spoiler_title">.ebignore</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">* !Dockerrun.aws.json</code> </pre></div></div><br> è¯¥æ–‡ä»¶ä½¿ç”¨.gitignoreè¯­æ³•ï¼Œå¹¶ä¸”æ˜¯.gitignoreï¼Œä½†ä¸æ˜¯ç”¨äºGit CLIï¼Œè€Œæ˜¯ç”¨äºAWS EB CLIã€‚ åœ¨æ­¤æ–‡ä»¶ä¸­ï¼Œæˆ‘å‘Šè¯‰CLIè·³è¿‡é™¤Dockerrun.aws.jsonå¤–çš„æ‰€æœ‰æ–‡ä»¶ã€‚ å°±æ˜¯è¿™æ ·ï¼Œç°åœ¨å½“æ‚¨åœ¨ElasticBeanstalkä¸­è¿è¡Œdeploy-stgä½œä¸šæ—¶ï¼Œå°†ä»…å‘é€æˆ‘ä»¬åˆ›å»ºçš„æ–‡ä»¶ã€‚  deploy-prodåšåŒæ ·çš„äº‹æƒ…ï¼Œä»…å°†Dockerrun.aws.prod.jsonæ–‡ä»¶çš„å†…å®¹å¤åˆ¶åˆ°Dockerrun.aws.jsonï¼Œæœ€åä¸€ä¸ªä»¥CircleCIæ ¼å¼æŒ‡ç¤ºå·¥ä½œé¡ºåºï¼ˆæ„å»ºåä¸ºploy-stgï¼Œæ„å»ºåä¸ºdeploy-prod -masterï¼‰ï¼Œä»¥åŠè¦åœ¨å“ªä¸ªåˆ†æ”¯ä¸ŠæŸ¥æ‰¾æ•°æ®ï¼ˆå¿½ç•¥ï¼š-masterï¼Œä»…ï¼š-masterï¼‰ã€‚ <br><br> æ­£å¦‚æˆ‘æ‰€æ‰¿è¯ºçš„ï¼ŒAWS ECRçš„é—®é¢˜ç¨æœ‰ä¸åŒï¼Œæˆ‘ä»¬å°†ç»§ç»­è®¨è®ºã€‚ æ‚¨ä¸éœ€è¦è¿œç¨‹ç™»å½•ECRå¹¶åˆ›å»ºcr.jsonæ–‡ä»¶ï¼Œå› ä¸ºElasticBeanstalkâ€œäº²è‡ªç»“è¯†äº†ä¸€ä¸ªå…„å¼Ÿâ€ã€‚ å› æ­¤ï¼ŒDockerrun.aws.jsonçœ‹èµ·æ¥ä¼šæœ‰æ‰€ä¸åŒ-æ ¹æœ¬å°±ä¸ä¼šæœ‰èº«ä»½éªŒè¯å—ï¼š <br><br><div class="spoiler">  <b class="spoiler_title">Dockerrun.aws.jsonï¼ˆAWS ECRï¼‰</b> <div class="spoiler_text"><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"AWSEBDockerrunVersion"</span></span>: <span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"Image"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"Name"</span></span>: <span class="hljs-string"><span class="hljs-string">"IMAGE_URL"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"Update"</span></span>: <span class="hljs-string"><span class="hljs-string">"true"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"Ports"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"ContainerPort"</span></span>: <span class="hljs-string"><span class="hljs-string">"80"</span></span> } ] }</code> </pre><br></div></div><br> ä½†æ˜¯èº«ä»½éªŒè¯å°†å¦‚ä½•å‘ç”Ÿï¼Ÿ äº‹å®æ˜¯ï¼Œè®¿é—®ECRçš„æœåŠ¡å…·æœ‰ä¸€å®šçš„æƒé™é›†ï¼Œè€Œè¿™äº›æƒé™åˆåŸºäºæŸäº›å®‰å…¨ç­–ç•¥ã€‚ åœ¨æˆ‘ä»¬çš„æ¡ˆä¾‹ä¸­ï¼Œå½“é€šè¿‡AWS CLIä»ç¬¬ä¸‰æ–¹æœåŠ¡å™¨ï¼ˆä»CIï¼‰å¯åŠ¨éƒ¨ç½²æ—¶ï¼Œå°†ä½¿ç”¨â€œ aws-elasticbeanstalk-ec2-roleâ€è§’è‰²ï¼Œåœ¨AWS IAMçš„è§’è‰²éƒ¨åˆ†ä¸­æ‰¾åˆ°è¯¥è§’è‰²ï¼Œå¹¶å°†é™„åŠ ç­–ç•¥â€œ AmazonEC2ContainerRegistryReadOnlyâ€é™„åŠ åˆ°è¯¥è§’è‰²ã€‚ ç°åœ¨ï¼Œä»ç§æœ‰å­˜å‚¨åº“ä¸‹è½½åˆ°å…¶â€œé‚»å±…â€å°†æˆåŠŸï¼Œä¸ä¼šå‡ºç°é”™è¯¯ã€‚ <br><br> ä½†è¿™å®Œå…¨æ˜¯ä»åŒä¸€VPCåŠ è½½çš„ï¼Œé€šè¿‡CLIï¼Œdocker loginå‘½ä»¤ä¹Ÿä¸æ˜¯â€œæ²¡æœ‰æŠ€å·§â€ï¼šæ‚¨éœ€è¦é€šè¿‡AWS CLIè·å¾—ï¼ˆåªæ˜¯è·å–ï¼‰dockerç™»å½•çš„ä¿¡ç”¨ï¼Œä¸ºæ­¤ <br><br> <code>aws ecr get-login --region REGION --no-include-email</code> <br> <br> æ­¤å‘½ä»¤å°†ä»¥docker login ...å½¢å¼è¿”å›ä¸€è¡Œï¼Œç®€è€Œè¨€ä¹‹ï¼Œæ‚¨éœ€è¦åœ¨æ§åˆ¶å°ä¸­æ‰§è¡Œ <br><br> <code>eval $(aws ecr get-login --region EB_REGION --no-include-email)</code> <br> <br> è¯¥å‘½ä»¤å°†é¦–å…ˆæ¥æ”¶ç”¨äºèº«ä»½éªŒè¯çš„å­—ç¬¦ä¸²ï¼Œç„¶åå¯åŠ¨ç›¸åº”çš„è¿‡ç¨‹ã€‚ é‰´äºAWS ECRçš„è¿™äº›è§„åˆ™ï¼ŒCircleCIçš„æŒ‡ä»¤æ–‡ä»¶å¦‚ä¸‹æ‰€ç¤ºï¼š <br><br><div class="spoiler">  <b class="spoiler_title">.circleci / config.ymlï¼ˆé€‚ç”¨äºAWS ECRï¼‰</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">version: 2 jobs: build: docker: - image: circleci/python:latest steps: - checkout - run: sudo pip install awscli --upgrade - run: | mkdir ~/.aws touch ~/.aws/config chmod 600 ~/.aws/config echo "[profile eb-cli]" &gt; ~/.aws/config echo "aws_access_key_id=$AWS_ACCESS_KEY_ID" &gt;&gt; ~/.aws/config echo "aws_secret_access_key=$AWS_SECRET_ACCESS_KEY" &gt;&gt; ~/.aws/config - setup_remote_docker - run: eval $(aws ecr get-login --region EB_REGION --no-include-email) - run: docker build -t $CI_REGISTRY/$CI_REGISTRY_ID:dev -f Dockerfile.stg . - run: docker push $CI_REGISTRY/$CI_REGISTRY_ID:dev build-master: docker: - image: circleci/python:latest steps: - checkout - run: sudo pip install awscli --upgrade - run: | mkdir ~/.aws touch ~/.aws/config chmod 600 ~/.aws/config echo "[profile eb-cli]" &gt; ~/.aws/config echo "aws_access_key_id=$AWS_ACCESS_KEY_ID" &gt;&gt; ~/.aws/config echo "aws_secret_access_key=$AWS_SECRET_ACCESS_KEY" &gt;&gt; ~/.aws/config - setup_remote_docker - run: eval $(aws ecr get-login --region EB_REGION --no-include-email) - run: docker build -t $CI_REGISTRY/$CI_REGISTRY_ID:latest . - run: docker push $CI_REGISTRY/$CI_REGISTRY_ID:latest deploy-stg: docker: - image: circleci/python:latest steps: - checkout - run: sudo pip install awsebcli --upgrade - run: | mkdir ~/.aws touch ~/.aws/config chmod 600 ~/.aws/config echo "[profile eb-cli]" &gt; ~/.aws/config echo "aws_access_key_id=$AWS_ACCESS_KEY_ID" &gt;&gt; ~/.aws/config echo "aws_secret_access_key=$AWS_SECRET_ACCESS_KEY" &gt;&gt; ~/.aws/config - run: eb init --region EB_REGION --platform Docker EB_APP - run: cp Dockerrun.aws.stg.json Dockerrun.aws.json - run: eb use EB_ENV_STG --region EB_REGION - run: eb deploy -v --staged --profile eb-cli deploy-prod: docker: - image: circleci/python:latest steps: - checkout - run: sudo pip install awsebcli --upgrade - run: | mkdir ~/.aws touch ~/.aws/config chmod 600 ~/.aws/config echo "[profile eb-cli]" &gt; ~/.aws/config echo "aws_access_key_id=$AWS_ACCESS_KEY_ID" &gt;&gt; ~/.aws/config echo "aws_secret_access_key=$AWS_SECRET_ACCESS_KEY" &gt;&gt; ~/.aws/config - run: eb init --region EB_REGION --platform Docker EB_APP - run: cp Dockerrun.aws.prod.json Dockerrun.aws.json - run: eb use EB_ENV_STG --region EB_REGION - run: eb deploy -v --staged --profile eb-cli workflows: version: 2 build: jobs: - build: filters: branches: ignore: - master - deploy-stg: requires: - build filters: branches: ignore: - master build-deploy: jobs: - build-master: filters: branches: only: - master - deploy-prod: requires: - build-master filters: branches: only: - master</code> </pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸ºäº†æ”¯æŒdocker-in-dockerï¼Œæˆ‘ä»¬åœ¨ç»„è£…é˜¶æ®µæ·»åŠ äº†setup_remote_dockerï¼Œæ‚¨åº”è¯¥å·²ç»ä»æœ¬æ–‡çš„å†…å®¹ä¸­äº†è§£äº†å…¶ä½™å†…å®¹ã€‚</font><font style="vertical-align: inherit;">å°±æ˜¯è¿™æ ·ï¼Œç°åœ¨æˆ‘ä»¬çš„é¡¹ç›®ç»“æ„å¦‚ä¸‹ï¼š</font></font><br><br><img width="350" src="https://habrastorage.org/webt/7e/cw/sj/7ecwsjkjjmr8myxiuutwkujwnkg.png" alt="å›¾ç‰‡"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å°è¯•æ›´æ”¹ä»£ç ï¼Œå°†å…¶å‹å…¥ä»»åŠ¡åˆ†æ”¯ï¼Œç„¶åå‘ä¸»æœåŠ¡å™¨å‘å‡ºåˆå¹¶ï¼ˆæ‹‰ï¼‰è¯·æ±‚å¹¶æ¥å—å®ƒã€‚</font><font style="vertical-align: inherit;">æ²¡æœ‰æ›´å¤šçš„â€œåŠ¨ä½œâ€æ¥å‘å¸ƒæ›´æ–°ã€‚</font><font style="vertical-align: inherit;">å¯èƒ½ï¼ˆå¹¶ä¸”æœ‰äººéœ€è¦ï¼‰èµ°å¾—æ›´è¿œï¼Œä¸ºæ»šåŠ¨è¿ç§»ç¼–å†™è‡ªå·±çš„å·¥ä½œå°ï¼Œé‡‡å–å¼ºåˆ¶æ€§çš„ä¸­é—´æ­¥éª¤ä»¥é€šè¿‡è‡ªåŠ¨æµ‹è¯•ï¼Œä¾æ­¤ç±»æ¨ï¼Œç­‰ç­‰ï¼Œæˆ‘å¸Œæœ›æœ¬æ–‡å°†ä¸ºæ­¤ç±»å®éªŒä»¥åŠéšåçš„é«˜è´¨é‡å’Œé€‚å½“å†…å®¹äº¤ä»˜çš„å®ç°å¥ å®šåŸºç¡€ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHubæºä»£ç ï¼š</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tutorial-aws-symfony-ci</font></font></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN462415/">https://habr.com/ru/post/zh-CN462415/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN462401/index.html">å¼€å‘è€…è‡´å‘½ç½ª</a></li>
<li><a href="../zh-CN462403/index.html">æ˜¾ç¤ºå™¨å°ºå¯¸é€‰æ‹©ï¼šè§’åº¦å°ºå¯¸ç†è®ºï¼ŒåŸç†å’Œæ¯”è¾ƒ</a></li>
<li><a href="../zh-CN462407/index.html">é£Ÿå“è®¾è®¡æ–‡æ‘˜2019å¹´7æœˆ</a></li>
<li><a href="../zh-CN462409/index.html">AVRå¾®æ§åˆ¶å™¨çš„æ±‡ç¼–ä»£ç ç”Ÿæˆå™¨åº“ã€‚ ç¬¬ä¸€éƒ¨åˆ†</a></li>
<li><a href="../zh-CN462411/index.html">ç”¨ç®—æ³•Xè§£å†³æ•°ç‹¬</a></li>
<li><a href="../zh-CN462417/index.html">è‹¹æœçš„è¯·æ„¿ä¹¦</a></li>
<li><a href="../zh-CN462421/index.html">ApolloæŒ‡å¯¼è®¡ç®—æœº-ä½“ç³»ç»“æ„å’Œç³»ç»Ÿè½¯ä»¶ã€‚ ç¬¬äºŒéƒ¨åˆ†</a></li>
<li><a href="../zh-CN462423/index.html">é¡¹ç›®ç®¡ç†</a></li>
<li><a href="../zh-CN462429/index.html">VueJs + VueRouter +æ¨¡æ€ã€‚ å¦ä¸€è¾†è‡ªè¡Œè½¦</a></li>
<li><a href="../zh-CN462431/index.html">309å·ç§»åŠ¨å¼€å‘äººå‘˜çš„æœ‰è¶£ææ–™æ‘˜è¦ï¼ˆ7æœˆ29æ—¥è‡³8æœˆ4æ—¥ï¼‰</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>