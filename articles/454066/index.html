<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚úãüèº ‚òéÔ∏è üåô C√≥mo dejar de olvidarse de los √≠ndices y comenzar a verificar el plan de ejecuci√≥n en las pruebas üö° üç© üññüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hace alg√∫n tiempo, me sucedi√≥ una historia desagradable, que sirvi√≥ como desencadenante de un peque√±o proyecto en un github y result√≥ en este art√≠culo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C√≥mo dejar de olvidarse de los √≠ndices y comenzar a verificar el plan de ejecuci√≥n en las pruebas</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tinkoff/blog/454066/"><img src="https://habrastorage.org/webt/cb/kk/ps/cbkkpswi947gczpzqmwkyh2pwmm.jpeg" alt="cdpv"><br><br>  Hace alg√∫n tiempo, me sucedi√≥ una historia desagradable, que sirvi√≥ como desencadenante de un peque√±o proyecto en un github y result√≥ en este art√≠culo. <br><br>  Un d√≠a t√≠pico, una liberaci√≥n normal: todas las tareas son revisadas por nuestro ingeniero de control de calidad, por lo que con la tranquilidad de la vaca sagrada "rodamos" al escenario.  La aplicaci√≥n se comporta bien, en los registros: silencio.  Decidimos hacer el cambio (etapa &lt;-&gt; prod).  Cambiamos, miramos los dispositivos ... <br><br>  Tarda un par de minutos, el vuelo es estable.  El ingeniero de control de calidad realiza una prueba de humo y se da cuenta de que la aplicaci√≥n se est√° ralentizando de forma poco natural.  Escribimos para calentar los cach√©s. <br><br>  Pasan un par de minutos, la primera queja de la primera l√≠nea: los datos se descargan de los clientes durante mucho tiempo, la aplicaci√≥n se ralentiza, tarda mucho en responder, etc.  Comenzamos a preocuparnos ... miramos los registros, buscamos posibles razones. <br><a name="habracut"></a><br>  Un par de minutos despu√©s, llega una carta de los administradores de DB.  Escriben que el tiempo de ejecuci√≥n de las consultas a la base de datos (en adelante, la base de datos) ha roto todos los l√≠mites posibles y tiende al infinito. <br><br>  Abro el monitoreo (uso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">JavaMelody</a> ), encuentro estas solicitudes.  Comienzo PGAdmin, me reproduzco.  Muy largo  Agrego "explicar", miro el plan de ejecuci√≥n ... es decir, nos olvidamos de los √≠ndices. <br><br><h2>  ¬øPor qu√© la revisi√≥n de c√≥digo no es suficiente? </h2><br>  Ese incidente me ense√±√≥ mucho.  S√≠, "apagu√© el fuego" durante una hora, creando de alguna manera el √≠ndice correcto directamente en el producto (no se olvide de la opci√≥n CONCURRENTEMENTE): <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> CONCURRENTLY <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> ix_pets_name <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> pets_table (name_column);</code> </pre> <br>  De acuerdo, esto fue equivalente a un despliegue con tiempo de inactividad.  Para la aplicaci√≥n en la que estoy trabajando, esto es inaceptable. <br><br>  Llegu√© a conclusiones y agregu√© un punto especial en negrita a la lista de verificaci√≥n para la revisi√≥n del c√≥digo: si veo que durante el proceso de desarrollo se agreg√≥ / cambi√≥ una de las clases del Repositorio, compruebo las migraciones de SQL para la presencia de un script que crea y cambia el √≠ndice all√≠.  Si √©l no est√° all√≠, le escribo una pregunta al autor: ¬øest√° seguro de que el √≠ndice no es necesario aqu√≠? <br><br>  Es probable que no se necesite un √≠ndice si hay pocos datos, pero si trabajamos con una tabla en la que se cuenta el n√∫mero de filas en millones, un error de √≠ndice puede volverse fatal y conducir a la historia establecida al comienzo del art√≠culo. <br><br>  En este caso, le pido al autor de la solicitud de extracci√≥n (en adelante, PR) que est√© 100% seguro de que la consulta que escribi√≥ en HQL est√° al menos parcialmente cubierta por el √≠ndice (se utiliza Index Scan).  Para esto, el desarrollador: <br><br><ol><li>  lanza la aplicaci√≥n </li><li>  buscando consulta convertida (HQL -&gt; SQL) en los registros </li><li>  abre PGAdmin u otra herramienta de administraci√≥n de bases de datos </li><li>  genera en la base de datos local, para no molestar a nadie con sus experimentos, una cantidad de datos aceptable para las pruebas (m√≠nimo 10K - 20K registros) </li><li>  cumple la solicitud </li><li>  solicita plan de ejecuci√≥n </li><li>  lo estudia cuidadosamente y saca conclusiones apropiadas </li><li>  agrega / modifica el √≠ndice, asegurando que el plan de ejecuci√≥n se adapte a √©l </li><li>  se da de baja en PR que la cobertura de la solicitud ha verificado </li><li>  Al evaluar de manera experta los riesgos y la gravedad de la solicitud, puedo verificar sus acciones </li></ol><br>  Muchas acciones rutinarias y el factor humano, pero durante alg√∫n tiempo estuve satisfecho y viv√≠ con esto. <br><br><h2>  Camino a casa </h2><br>  Dicen que es muy √∫til al menos a veces ir del trabajo sin escuchar m√∫sica / podcasts en el camino.  En este momento, solo pensando en la vida, puede llegar a conclusiones e ideas interesantes. <br><br>  Un d√≠a camin√© a casa y pens√© en lo que pas√≥ ese d√≠a.  Hubo algunas revisiones, revis√© cada una con una lista de verificaci√≥n e hice una serie de acciones descritas anteriormente.  Esa vez me cans√© tanto, pens√©, ¬øqu√© demonios?  ¬øEs imposible hacer esto autom√°ticamente? ... Di un paso r√°pido, queriendo "cortar" r√°pidamente esta idea. <br><br><h2>  Declaraci√≥n del problema. </h2><br>  ¬øQu√© es lo m√°s importante para el desarrollador en el plan de ejecuci√≥n? <br>  Por supuesto, seq escanea en grandes cantidades de datos causados ‚Äã‚Äãpor la falta de un √≠ndice. <br><br>  Por lo tanto, era necesario hacer una prueba que: <br><br><ol><li>  Realizado en una base de datos con una configuraci√≥n similar a la del producto </li><li>  Intercepta una consulta de base de datos realizada por un repositorio JPA (Hibernate) </li><li>  Lo consigue plan de ejecuci√≥n </li><li>  Plan de Ejecuci√≥n Parsit, estableci√©ndolo en una estructura de datos conveniente para cheques </li><li>  Usando un conjunto conveniente de m√©todos Assert, verifica las expectativas.  Por ejemplo, esa exploraci√≥n seq no se usa. </li></ol><br><br>  Era necesario probar r√°pidamente esta hip√≥tesis haciendo un prototipo. <br><br><h2>  Arquitectura de soluciones </h2><br><img src="https://habrastorage.org/webt/6e/2i/bz/6e2ibz7cl8roycahqee4yb1lqqq.png" alt="arquitectura checkinx"><br><br>  El primer problema que deb√≠a resolverse fue el lanzamiento de la prueba en una base de datos real que coincide con la versi√≥n y la configuraci√≥n con la utilizada en el producto. <br><br>  Gracias a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Docker &amp; TestContainers</a> , resuelven este problema. <br><br>  SqlInterceptor, ExecutionPlanQuery, ExecutionPlanParse y AssertService son las interfaces que he implementado actualmente para Postgres.  Los planes son implementar para otras bases de datos.  Si quieres participar, bienvenido.  El c√≥digo est√° escrito en Kotlin. <br><br>  Todo esto junto lo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">publiqu√©</a> en GitHub y llam√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">checkinx-utils</a> .  No necesita repetir esto, solo conecte la dependencia a checkinx en maven / gradle y use afirmaciones convenientes.  C√≥mo hacer esto, lo describir√© con m√°s detalle a continuaci√≥n. <br><br><h3>  Descripci√≥n de la interacci√≥n de los componentes CheckInx </h3><br><h4>  ProxyDataSource </h4><br>  El primer problema que deb√≠a resolverse era la intercepci√≥n de consultas de bases de datos listas para su ejecuci√≥n.  Ya con los par√°metros establecidos, sin preguntas, etc. <br><br>  Para hacer esto, necesita envolver el dataSource real en un Proxy determinado, lo que le permitir√≠a integrarse en la canalizaci√≥n de ejecuci√≥n de consultas y, en consecuencia, interceptarlos. <br><br>  Tal ProxyDataSource ya ha sido implementado por muchos.  Utilic√© la soluci√≥n <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ttddyy</a> lista para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">usar</a> , que me permite instalar mi Listener interceptando la solicitud que necesito. <br><br>  Sustituyo la fuente DataSource usando la clase DataSourceWrapper (BeanPostProcessor). <br><br><h4>  SqlInterceptor </h4><br>  De hecho, su m√©todo start () establece su Listener en proxyDataSource y comienza a interceptar solicitudes, almacen√°ndolas en la lista de declaraciones internas.  El m√©todo stop (), respectivamente, elimina el oyente instalado. <br><br><h4>  Ejecuci√≥nPlanQuery </h4><br>  Aqu√≠, la solicitud original se transforma en una solicitud de un plan de ejecuci√≥n.  En el caso de Postgres, esta es una adici√≥n a la palabra clave de consulta "EXPLICAR". <br><br>  Adem√°s, esta consulta se ejecuta en la misma base de datos desde los contenedores de prueba y se devuelve un plan de ejecuci√≥n "sin procesar" (lista de l√≠neas). <br><br><h4>  Ejecuci√≥nPlanParser </h4><br>  Es inconveniente trabajar con un plan de ejecuci√≥n sin procesar.  Por lo tanto, lo analizo en un √°rbol que consiste en nodos (PlanNode). <br><br>  Analicemos los campos PlanNode usando un ejemplo de un ExecutionPlan real: <br><br><pre> <code class="sql hljs">Index Scan using ix_pets_age on pets  (cost=0.29..8.77 rows=1 width=36) Index Cond: (age &lt; 10) Filter: ((name)::text = 'Jack'::text)</code> </pre> <br><div class="scrollable-table"><table><tbody><tr><th>  Propiedad </th><th>  Ejemplo </th><th>  Descripci√≥n </th></tr><tr><td>  raw: String </td><td>  Escaneo de √≠ndice usando ix_pets_age en mascotas (costo = 0.29..8.77 filas = 1 ancho = 36) </td><td>  cadena fuente </td></tr><tr><td>  tabla: cadena? </td><td>  mascotas <br></td><td>  nombre de la tabla </td></tr><tr><td>  target: cadena? </td><td>  ix_pets_age </td><td>  nombre de √≠ndice </td></tr><tr><td>  cobertura: cadena? </td><td>  Exploraci√≥n de √≠ndice </td><td>  cubrir </td></tr><tr><td>  nivel de cobertura </td><td>  Medio </td><td>  abstracci√≥n de revestimiento (CERO, MEDIO, COMPLETO) </td></tr><tr><td>  hijos: MutableList &lt;PlanNode&gt; </td><td>  - </td><td>  nodos secundarios </td></tr><tr><td>  propiedades: MutableList &lt;Par &lt;Cadena, Cadena &gt;&gt; </td><td>  <i>clave</i> : √≠ndice Cond, <i>valor</i> : (edad &lt;10); <br>  <i>clave</i> : filtro, <i>valor</i> : ((nombre) :: texto = 'Jack' :: texto) <br></td><td>  propiedades </td></tr><tr><td>  otros: MutableList &lt;String&gt; </td><td>  - </td><td>  Todo lo que no se pudo reconocer en la versi√≥n actual de checkinx </td></tr></tbody></table></div><br><h4>  AssertService </h4><br>  Ya es posible trabajar normalmente con la estructura de datos devuelta por el analizador.  CheckInxAssertService es un conjunto de comprobaciones del √°rbol PlanNode descrito anteriormente.  Le permite establecer sus propias lambdas de cheques o utilizar los predefinidos, en mi opini√≥n, los m√°s populares.  Por ejemplo, para que su consulta no tenga Seq Scan, o si desea asegurarse de que se utiliza / no se utiliza un √≠ndice espec√≠fico. <br><br><h4>  Nivel de cobertura </h4><br>  Muy importante Enum, lo describir√© por separado: <br><div class="scrollable-table"><table><tbody><tr><th>  Valor </th><th>  Descripci√≥n </th></tr><tr><td>  NO_USING <br></td><td>  comprueba que no se utiliza un objetivo espec√≠fico (√≠ndice) <br></td></tr><tr><td>  CERO <br></td><td>  √≠ndice no utilizado (Seq Scan) <br></td></tr><tr><td>  Medio <br></td><td>  cobertura parcial de la consulta por √≠ndice (Index Scan).  Por ejemplo, una b√∫squeda se realiza por √≠ndice, pero para los datos resultantes, se refiere a una tabla <br></td></tr><tr><td>  COMPLETO <br></td><td>  cobertura completa de la consulta por √≠ndice (Escaneo de solo √≠ndice) <br></td></tr><tr><td>  DESCONOCIDO <br></td><td>  cobertura desconocida  Por alguna raz√≥n, no fue posible instalarlo. <br></td></tr></tbody></table></div><br>  A continuaci√≥n, veremos algunos ejemplos de uso. <br><br><h2>  Ejemplos de prueba con CheckInx </h2><br>  Hice un proyecto por separado en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">checkinx-demo de</a> GitHub, donde implement√© un repositorio JPA para la tabla de mascotas y las pruebas para este repositorio comprobando la cobertura, los √≠ndices, etc.  Ser√° √∫til mirar all√≠ como punto de partida. <br><br>  Es posible que tenga una prueba como esta: <br><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testFindByLocation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> {  <span class="hljs-comment"><span class="hljs-comment">// ARRANGE  val location = "Moscow"  //   ,      10-20.  //   TestNG      @BeforeClass  IntRange(1, 10000).forEach {      val pet = Pet()      pet.id = UUID.randomUUID()      pet.age = it      pet.location = "Saint Petersburg"      pet.name = "Jack-$it"      repository.save(pet)  }  // ACT  //     sqlInterceptor.startInterception()  //    val pets = repository.findByLocation(location)  //    sqlInterceptor.stopInterception()  // ASSERT  //         assertEquals(1, sqlInterceptor.statements.size.toLong())  // ,    ix_pets_location    (Index Scan)  checkInxAssertService.assertCoverage(CoverageLevel.HALF, "ix_pets_location", sqlInterceptor.statements[0])  //        ,      Seq Scan,        checkInxAssertService.assertCoverage(CoverageLevel.HALF, sqlInterceptor.statements[0])  // ...  ,      checkInxAssertService.assertPlan(plan) {          it.coverageLevel.level &lt; CoverageLevel.FULL.level      } }</span></span></code> </pre> <br>  El plan de implementaci√≥n podr√≠a ser el siguiente: <br><br><pre> <code class="sql hljs">Index Scan using ix_pets_location on pets pet0_  (cost=0.29..4.30 rows=1 width=46) Index Cond: ((location)::text = 'Moscow'::text)</code> </pre> <br>  ... o as√≠ si nos olvidamos del √≠ndice (las pruebas se vuelven rojas): <br><br><pre> <code class="sql hljs">Seq Scan on pets pet0_  (cost=0.00..19.00 rows=4 width=84) Filter: ((location)::text = 'Moscow'::text)</code> </pre> <br>  En mi proyecto, utilizo principalmente la afirmaci√≥n m√°s simple, que dice que no hay Seq Scan en el plan de ejecuci√≥n: <br><br><pre> <code class="kotlin hljs">checkInxAssertService.assertCoverage(CoverageLevel.HALF, sqlInterceptor.statements[<span class="hljs-number"><span class="hljs-number">0</span></span>])</code> </pre> <br>  La presencia de tal prueba sugiere que, al menos, estudi√© el plan de implementaci√≥n. <br>  Tambi√©n hace que la gesti√≥n de proyectos sea m√°s expl√≠cita, y aumenta la capacidad de documentar y predecir el c√≥digo. <br><br><div class="spoiler">  <b class="spoiler_title">Modo experimentado</b> <div class="spoiler_text">  Recomiendo usar CheckInxAssertService, pero si es necesario, puede omitir el √°rbol analizado (ExecutionPlanParser) usted mismo o, en general, analizar el plan de ejecuci√≥n sin procesar (el resultado de ejecutar ExecutionPlanQuery). <br><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testFindByLocation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> {  <span class="hljs-comment"><span class="hljs-comment">// ARRANGE  val location = "Moscow"  // ACT  //     sqlInterceptor.startInterception()  //    val pets = repository.findByLocation(location)  //    sqlInterceptor.stopInterception()  // ASSERT  //  ""    val executionPlan = executionPlanQuery.execute(sqlInterceptor.statements[0])  //    -   val plan = executionPlanParser.parse(executionPlan)  assertNotNull(plan)  // ...     val rootNode = plan.rootPlanNode  assertEquals("Index Scan", rootNode.coverage)  assertEquals("ix_pets_location", rootNode.target)  assertEquals("pets pet0_", rootNode.table) }</span></span></code> </pre> </div></div><br><br><h2>  Conexi√≥n al proyecto. </h2><br>  En mi proyecto, asign√© tales pruebas a un grupo separado, llam√°ndolo Pruebas de integraci√≥n intensiva. <br><br>  Conectarse y comenzar a usar checkinx-utils es bastante f√°cil.  Comencemos con el script de compilaci√≥n. <br><br>  Conecte el repositorio primero.  Alg√∫n d√≠a subir√© checkinx a maven, pero ahora puedes descargar artefactos solo desde GitHub a trav√©s de jitpack. <br><br><pre> <code class="plaintext hljs">repositories { // ...  maven { url 'https://jitpack.io' } }</code> </pre> <br>  A continuaci√≥n, agregue la dependencia: <br><br><pre> <code class="plaintext hljs">dependencies { // ...  implementation 'com.github.tinkoffcreditsystems:checkinx-utils:0.2.0' }</code> </pre> <br>  Completamos la conexi√≥n agregando la configuraci√≥n.  Solo Postgres es compatible actualmente. <br><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Profile(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"test"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-meta"><span class="hljs-meta">@ImportAutoConfiguration(classes = [PostgresConfig::class])</span></span> <span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CheckInxConfig</span></span></span></span></code> </pre> <br>  Presta atenci√≥n al perfil de prueba.  De lo contrario, encontrar√° ProxyDataSource en su producto. <br><br>  PostgresConfig conecta varios beans: <br><br><ol><li>  DataSourceWrapper </li><li>  PostgresInterceptor </li><li>  PostgresExecutionPlanParser </li><li>  PostgresExecutionPlanQuery </li><li>  CheckInxAssertServiceImpl </li></ol><br>  Si necesita alg√∫n tipo de personalizaci√≥n que la API actual no proporciona, siempre puede reemplazar uno de los beans con su implementaci√≥n. <br><br><h2>  Problemas conocidos </h2><br>  A veces, un DataSourceWrapper no puede reemplazar el dataSource original debido al proxy Spring CGLIB.  En este caso, no un DataSource llega a BeanPostProcessor, sino ScopedProxyFactoryBean y existen problemas con la verificaci√≥n de tipos. <br><br>  La soluci√≥n m√°s f√°cil ser√≠a crear manualmente HikariDataSource para las pruebas.  Entonces su configuraci√≥n ser√° la siguiente: <br><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Profile(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"test"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-meta"><span class="hljs-meta">@ImportAutoConfiguration(classes = [PostgresConfig::class])</span></span> <span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CheckInxConfig</span></span></span><span class="hljs-class"> </span></span>{  <span class="hljs-meta"><span class="hljs-meta">@Primary</span></span>  <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span>  <span class="hljs-meta"><span class="hljs-meta">@ConfigurationProperties(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"spring.datasource"</span></span></span><span class="hljs-meta">)</span></span>  <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dataSource</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: DataSource {      <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> DataSourceBuilder.create()          .type(HikariDataSource::<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">.&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">i</span></span></span><span class="hljs-class">&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/i</span></span></span><span class="hljs-class">&gt;)          .</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">build</span></span></span></span>()  }  <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span>  <span class="hljs-meta"><span class="hljs-meta">@ConfigurationProperties(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"spring.datasource.configuration"</span></span></span><span class="hljs-meta">)</span></span>  <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dataSource</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(properties: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">DataSourceProperties</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: HikariDataSource {      <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> properties.initializeDataSourceBuilder()          .type(HikariDataSource::<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">.&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">i</span></span></span><span class="hljs-class">&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/i</span></span></span><span class="hljs-class">&gt;)          .</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">build</span></span></span></span>()  } }</code> </pre> <br><br><h2>  Planes de desarrollo </h2><br><ol><li>  Me gustar√≠a entender si alguien m√°s que yo necesita esto.  Para hacer esto, cree una encuesta.  Estar√© encantado de responder honestamente. </li><li>  Vea lo que realmente necesita y expanda la lista est√°ndar de m√©todos de afirmaci√≥n. </li><li>  Escribir implementaciones para otras bases de datos. </li><li>  La construcci√≥n de sqlInterceptor.statements [0] no parece muy obvia, quiero mejorarla. </li></ol><br>  Me alegrar√≠a si alguien quiere unirse y ganar algo de cr√©dito practicando en Kotlin. <br><br><h2>  Conclusi√≥n </h2><br>  Estoy seguro de que habr√° comentarios: <i>es imposible predecir c√≥mo se comportar√° el planificador de consultas en el producto, todo depende de las estad√≠sticas recopiladas</i> . <br><br>  De hecho, un planificador.  Usando las estad√≠sticas recopiladas anteriormente, puede construir un plan diferente al que se est√° probando.  El significado es un poco diferente. <br><br>  La tarea del planificador es mejorar, no empeorar, la solicitud.  Por lo tanto, sin raz√≥n aparente, no usar√° repentinamente Seq Scan, pero puede hacerlo sin saberlo. <br><br>  Necesita CheckInx para que al escribir una prueba, no olvide estudiar el plan de ejecuci√≥n de la consulta y considere la posibilidad de crear un √≠ndice, o viceversa, que muestre claramente con una prueba que no se necesitan √≠ndices aqu√≠ y que est√° satisfecho con Seq Scan.  Esto le ahorrar√≠a preguntas innecesarias sobre la revisi√≥n del c√≥digo. <br><br><h2>  Referencias </h2><br><ol><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://github.com/TinkoffCreditSystems/checkinx-utils</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://github.com/dsemyriazhko/checkinx-demo</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://github.com/ttddyy/datasource-proxy</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://mvnrepository.com/artifact/org.testcontainers/postgresql</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://github.com/javamelody/javamelody/wiki</a> </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/454066/">https://habr.com/ru/post/454066/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../454056/index.html">C√≥mo conectar cl√∫steres de Kubernetes en diferentes centros de datos</a></li>
<li><a href="../454058/index.html">Herramienta conveniente para medir el c√≥digo C #</a></li>
<li><a href="../454060/index.html">Una mirada inesperada a los circuitos asincr√≥nicos independientes de la velocidad.</a></li>
<li><a href="../454062/index.html">Tel√©fono corporativo, como un cuchillo suizo: para inventario, chat, llamadas de soporte y consultas</a></li>
<li><a href="../454064/index.html">La historia no contada de la IA</a></li>
<li><a href="../454070/index.html">Elegir un monowheel para viajar</a></li>
<li><a href="../454072/index.html">Cinco grandes ejemplos de mentiras sobre 5G</a></li>
<li><a href="../454074/index.html">DynamicData: Colecciones din√°micas, arquitectura MVVM y extensiones reactivas</a></li>
<li><a href="../454076/index.html">DotNext 2019 Piter: peque√±o informe</a></li>
<li><a href="../454078/index.html">"Contenido m√≥vil" de forma gratuita, sin SMS ni registros. Detalles de fraude de meg√°fono</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>