<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤴🏿 🤚🏻 🔥 Neuer Buhtrap Downloader 🛌🏿 😋 😪</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Heute werden wir Ihnen einen neuen Ansatz zum Senden von Malware an die Buhtrap-Gruppe vorstellen. 



 Bootloader-Modul 
 Am 19. Dezember wurde uns e...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Neuer Buhtrap Downloader</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/bizone/blog/434626/">  Heute werden wir Ihnen einen neuen Ansatz zum Senden von Malware an die Buhtrap-Gruppe vorstellen. <br><br><img src="https://habrastorage.org/webt/sn/u8/a1/snu8a1cvx8zvuttb34taqxmyoxi.png"><br><br><h3>  <font color="#4169E1">Bootloader-Modul</font> </h3><br>  Am 19. Dezember wurde uns ein böswilliges Mailing mit einer ausführbaren Datei ( <i>md5: faf833a1456e1bb85117d95c23892368</i> ) bekannt.  Die Datei hatte verschiedene Namen: "Abgleich für December.exe", "Docs wednesday.exe", "Documents 19.12.exe", "Closing documents wednesday.exe". <br><br>  Von interessant - die Datei ist in .Net geschrieben, was für diese kriminelle Gruppe nicht typisch ist.  Zum Dekompilieren von .Net können Sie eine beliebige Software verwenden: <b>Reflector</b> , <b>dotPeek</b> , <b>dnSpy</b> , <b>ILSpy</b> .  In dem Artikel werden wir über die Funktionen der Implementierung dieser Datei sprechen und wie wir sie analysiert haben. <br><a name="habracut"></a><br><h3>  <font color="#4169E1">Erstinspektion des Bootloaders</font> </h3><br>  Für die Analyse haben wir <b>dnSpy verwendet</b> , und alle weiteren Screenshots werden davon stammen. <br>  Öffnen Sie aus Gewohnheit die ausführbare Datei in <b>IDA Pro</b> und sehen Sie sich den Importabschnitt an.  Beispiele: <br><br><img src="https://habrastorage.org/webt/6n/ks/r-/6nksr-jvgkh8kj5kerx7erkx13w.png"><br><br>  Das Vorhandensein einiger Funktionen deutet auf das Vorhandensein einer gepackten Nutzlast ( <b>LoadCursorW</b> , <b>LoadIconW</b> - hat das Objekt aus den Ressourcen <b>abgerufen</b> , <b>VirtualProtect</b> - hat die <b>Seitenattribute</b> geändert, dann können Sie den Code ausführen) und eines einfachen Anti-Debugging ( <b>IsDebuggerPresent</b> ) hin.  Aber alles stellte sich als noch einfacher heraus.  Die Ausführung erreichte nicht einmal IsDebuggerPresent, und LoadCursorW und LoadIconW funktionierten nutzlos, weil sie versuchten, auf nicht vorhandene Ressourcen zuzugreifen (LoadCursorW von " <i>fiza</i> " und LoadIconW von " <i>saxikulatebutohutejijobodugore</i> "): <br><br><img src="https://habrastorage.org/webt/gp/ye/vf/gpyevft3j2j5-vzaeg87-o9tczw.png"><br><br><img src="https://habrastorage.org/webt/lo/kq/ic/lokqicp7awjfseefk3gnouqs3p0.png"><br><br>  Aber zurück zum <b>dnSpy-</b> Dekompiler.  In der ausführbaren Datei sehen wir eine erhebliche Menge nicht verwalteten Codes: <br><br><img src="https://habrastorage.org/webt/n1/og/k_/n1ogk_upsf-5baxmk9q04-8tsyw.png"><br><br>  Um zu verstehen, welcher nicht verwaltete Code in der untersuchten Datei enthalten ist, verwenden wir IDA Pro.  Am einfachsten ist es, den nicht verwalteten Code in hexadezimaler Form anzuzeigen.  Wechseln Sie dazu zum Offset File Offset.  Verwenden Sie die Funktion <b>_main ()</b> als Beispiel: <br><br><img src="https://habrastorage.org/webt/-4/5p/81/-45p816dvsaj7whinkl7ctkaj8u.png"><br><br><img src="https://habrastorage.org/webt/vr/mf/ua/vrmfua0qkoqgqfcqvwzgj3rl_qc.png"><br><br>  Als nächstes werden <b>wir</b> in <b>IDA Pro</b> nach Hex-Reihenfolge suchen: <br><br><img src="https://habrastorage.org/webt/ro/hh/oy/rohhoylitba4gnuxygzn9bs_pes.png"><br><br>  Am Ausgang erhalten wir die nicht verwaltete Funktion _main (), mit der Sie bequem mit Hilfe des idov-Dekompilierers arbeiten können: <br><br><img src="https://habrastorage.org/webt/zv/gs/pc/zvgspc2az6zmnuymfakhjy8tc0e.png"><br><br><img src="https://habrastorage.org/webt/ef/ea/sz/efeaszcwmkc-dpzpm_sl-dfjuk0.png"><br><br><h4>  Nutzlast bekommen </h4><br>  Zurück zu dnSpy.  Es wird auf die Variable <b>payloadData hingewiesen</b> . <br><br><img src="https://habrastorage.org/webt/fk/sc/od/fkscodflcwfpqv91v780smb2h4c.png"><br><br><img src="https://habrastorage.org/webt/rm/xx/xd/rmxxxdvbwil4utycw3fd5romqci.png"><br><br>  Wir finden diese Sequenz in IDA Pro, erhalten Links dazu und stellen fest, dass der Aufruf nur in der Funktion <b>_main () erfolgt</b> : <br><br><img src="https://habrastorage.org/webt/lm/2m/i7/lm2mi7e28qgrkqqtwbfenvkppls.png"><br><br>  Der mit diesem Puffer dekompilierte Code sieht folgendermaßen aus: <br><br><img src="https://habrastorage.org/webt/u_/cw/1j/u_cw1jdwih4vxh7xx-2kb09fd5m.png"><br><br>  Die folgenden Funktionen sind für die Konvertierung dieses Puffers verantwortlich: <br><br><img src="https://habrastorage.org/webt/oc/tw/a6/octwa6li37592_dxbjjl5iw_vtu.png"><br><br>  Hier wird die <b>Holdrand-</b> Variable auf <i>0xEA48CB16</i> <b>initialisiert</b> und die Funktion <b>foo ()</b> wird in einer Schleife für jedes Byte aus <b>payloadData</b> ( <i>Parameter sbyte c</i> ) <i>aufgerufen</i> .  Es ist zu beachten, dass die Funktion t () aus einem unsicheren Code stammt: Wenn Sie sich den Code ansehen, können Sie sicherstellen, dass er immer <i>0x343FD zurückgibt</i> . <br><br>  Wir rüsten uns mit IDA Pro aus und stellen beim Betrachten des resultierenden entpackten Puffers fest, dass er am Anfang Code enthält: <br><br><img src="https://habrastorage.org/webt/sf/5r/wu/sf5rwudeoqmxkcs-kcrrk5hskcg.png"><br><br>  Bei Offset <i>0x15A0</i> vom Anfang des Puffers befindet sich eine ausführbare Datei: <br><br><img src="https://habrastorage.org/webt/4y/ul/fa/4yulfappi52yhaucx3iuy2je-tc.png"><br><br>  Speichern Sie es für eine spätere Analyse. <br><br>  Nun, im ausführbaren Code selbst ist eine ziemlich triviale Sache implementiert.  Zunächst wird die folgende Struktur gebildet ( <i>hier ist mz_base die Offset-Adresse im Puffer mit dem entpackten PE, und die verbleibenden Felder sind die Adressen der erforderlichen Funktionen und Bibliothekshandles</i> ): <br><br><img src="https://habrastorage.org/webt/em/tx/2x/emtx2xx3rpongt81rdkgqenspt8.png"><br><br>  Anschließend wird mithilfe der erhaltenen Funktionen der Prozess derselben ausführbaren Datei erstellt ( <i>md5: faf833a1456e1bb85117d95c23892368</i> ), und die entpackte ausführbare Datei wird den virtuellen Adressen des neuen Prozesses zugeordnet.  Nach dem Ändern der Adresse der ausführbaren Anweisung ( <b>GetThreadContext-</b> und <b>SetThreadContext-</b> Bundle) wird der Thread des neuen Prozesses <b>gestartet</b> und der übergeordnete Prozess selbst wird beendet. <br><br>  Nun wenden wir uns der Analyse der resultierenden ausführbaren Datei (Nutzdaten) zu. <br><br><h3>  <font color="#4169E1">Nutzlast auspacken</font> </h3><br>  Die Nutzdaten ( <i>md5 dump: d8f40c7060c44fab57df87ab709f058f</i> ) werden ebenfalls im .Net Framework geschrieben. <br><br>  Zum Schutz vor statischen und dynamischen Analysen verwendeten <b>Malware-</b> Entwickler den neuesten beliebten <b>ConfuserEx-</b> Protector: <br><br><img src="https://habrastorage.org/webt/75/ui/tb/75uitbdw5gznezlw4flyzx4c6-e.png"><br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ConfuserEx</a> ist ein etablierter Open Source Protector. <br><br><h3>  <font color="#4169E1">Primäres Auspacken</font> </h3><br>  Der Einstiegspunkt für Dateien, die durch diesen Protektor geschützt sind, lautet wie folgt: <br><br><img src="https://habrastorage.org/webt/xc/fk/sr/xcfksree6xb2nl7l3sg-nn1dsqg.png"><br><br>  Nach der Entschlüsselung wird das Byte-Array in Form eines Moduls namens <b>Koi</b> in den Speicher geladen.  Dann wird die Hauptmethode dieses Moduls bestimmt und aufgerufen.  Auf der .Net-Plattform kann eine Methode oder ein Konstruktor in einem Modul aus dem Metadaten-Token abgerufen werden, indem die Funktion <b>Module.ResolveMethod () aufgerufen wird</b> .  Um die Steuerung auf die erhaltene Methode zu übertragen, wird die Funktion <b>MethodBase.Invoke ()</b> verwendet. <br><br><img src="https://habrastorage.org/webt/-s/1n/xo/-s1nxo2iy6mgehse3asimugo_ra.png"><br><br>  Der ausführbare Code im <b>Koi-</b> Modul lautet wie folgt: <br><br><img src="https://habrastorage.org/webt/fp/cj/9v/fpcj9viyn46punvfce7grleeati.png"><br><br>  Um das Profil zu entfernen, haben wir die folgenden Dienstprogramme verwendet: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">github.com/cawk/ConfuserEx-Unpacker</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">github.com/0xd4d/de4dot</a> </li></ul><br>  <b>ConfuserEx-Unpacker</b> entschlüsselte die Zeilen und den Code innerhalb der Methoden und <b>de4dot</b> machte die Namen der Methoden lesbar. <br><br>  Das Ergebnis ist ein Code, der für die statische Analyse geeignet ist: <br><br><img src="https://habrastorage.org/webt/5p/_c/yx/5p_cyxuqhky7vndvuh0htnkkzp4.png"><br><br>  Natürlich hatten wir das Glück, lesbaren Code zu erhalten.  Virenschreiber können den Quellcode für das <b>ConfuserEx-</b> Profil <b>ändern</b> , um die Analyse weiter zu erschweren. <br>  Es gab noch zwei Probleme, die für eine komfortable Analyse der Datei gelöst werden mussten. <br><br><h4>  1. Problem </h4><br>  Nach dem Entfernen des Profils konnte der Dekompiler einige der Methoden nicht analysieren.  Zum Beispiel: <br><br><img src="https://habrastorage.org/webt/uj/xm/h4/ujxmh4ivlwt0fm7w0xzkig5lu_k.png"><br><br>  Wenn Sie zum IL-Code wechseln, werden Sie Aufrufe an Nullzeigern bemerken: <br><br><img src="https://habrastorage.org/webt/5b/pw/is/5bpwismvu1l9gt6bktnrpvoxlya.png"><br><br>  Ersetzen Sie falsche Anweisungen durch keine Anweisungen, um Dekompilierungsfehler zu beheben.  (Mit <b>dem</b> Dienstprogramm <b>dnSpy</b> können <b>Sie</b> sowohl dekompilierten Code als auch IL-Code ändern.) <br>  Nach dem Ersetzen sieht der dekompilierte Code korrekt aus: <br><br><img src="https://habrastorage.org/webt/gy/zi/8l/gyzi8lglspniec_imqi-uauacz4.png"><br><br>  Wenn wir den IL-Code in allen problematischen Methoden ändern, erhalten wir eine vollständig dekompilierte Datei. <br><br><h4>  2. Problem </h4><br>  Es ist unwahrscheinlich, dass die resultierende Datei gestartet wird, und dies schließt die Möglichkeit einer dynamischen Analyse aus.  Um dieses Problem zu lösen, müssen Sie das Token der Eingabemethode in der Struktur der ausführbaren Datei angeben. <br><br>  Sie können es auf zwei Arten finden: <br><br><ul><li>  Schauen Sie unter Debugging nach, mit welchem ​​Parameter die Funktion aufgerufen wurde </li></ul><br>  <b>Module.ResolveMethod ()</b> vor dem Entpacken der Datei: <br><br><img src="https://habrastorage.org/webt/1y/vt/ex/1yvtexa_v0psvugzbzwla1ow4zq.png"><br><br><ul><li>  Suchen Sie in der entpackten Datei die Methode mit der Bezeichnung <b>[STAThread]</b> : </li></ul><br><img src="https://habrastorage.org/webt/xr/an/wi/xranwidrui8z1gmkbc23c84ibpg.png"><br><br>  In diesem Fall lautet das Metadaten-Token für die Eingabemethode <i>0x6000106</i> .  Wir ändern es mit dem Dienstprogramm <b>CFF Explorer</b> : <br><br><img src="https://habrastorage.org/webt/ad/7u/xp/ad7uxpajjbfh1gzvdqgaj8kw3oc.png"><br><br>  Nach dem Speichern der Änderungen wird die entpackte Datei gestartet und ordnungsgemäß debuggt. <br><br><h3>  <font color="#4169E1">Bootloader-Analyse</font> </h3><br>  Unmittelbar nach Arbeitsbeginn prüft der Bootloader, ob er in einer virtuellen Umgebung ausgeführt wird. <br>  Die Ausführung unter <b>VMWare</b> oder <b>QEMU</b> wird durch Suchen nach den Teilzeichenfolgen "vmware" und "qemu" im folgenden Registrierungswert bestimmt: <br><br><ul><li>  [HKLM \ System \ CurrentControlSet \ Services \ Disk \ Enum \ 0]. </li></ul><br>  Wenn eine virtuelle Maschine erkannt wird, zeigt der Bootloader die entsprechende Fenstermeldung an: <br><br><img src="https://habrastorage.org/webt/wt/pw/lz/wtpwlzmwrcfsghc-bgib6fw0kru.png"><br><br>  Interessanterweise hat die Ausgabe dieser Nachricht keinen Einfluss auf den Betrieb des Prozesses. <br><br>  Danach versucht die Malware, die Bibliotheken aus der folgenden Liste in den Speicher zu laden: <b>SbieDll.dll, dbghelp.dll, api_log.dll, dir_watch.dll, pstorec.dll, vmcheck.dll, wpespy.dll, snxhk.dll, guard32.dll</b> . <br><br>  Darüber hinaus prüft der Loader anhand der Aufrufe der Funktionen <b>Debugger.IsLogging ()</b> und <b>Debugger.get_IsAttached ()</b> , ob er unter dem Debugger ausgeführt wird. <br>  Wenn mindestens eine der Bibliotheken erfolgreich <i>geladen wurde</i> oder der Loader feststellt, dass sie unter dem Debugger ausgeführt wird, wird sie mit dem Befehl „ <i>cmd / C ping 8.8.8.8 -n 1 -w 3000&gt; Nul &amp; Del</i> “ <i>automatisch gelöscht</i> .  Interessanterweise kann sich der Bootloader selbst auf einem realen System selbst löschen, indem er die Bibliothek <b>dbghelp.dl</b> l <b>lädt</b> . <br><br>  Als nächstes prüft die Malware, ob sie aus dem Verzeichnis gestartet wird, das den Teilstring "Mozilla" enthält. <br><br><h4>  Wenn der Prozess nicht aus dem Verzeichnis gestartet wird, das den Teilstring "Mozilla" enthält </h4><br><ul><li>  VPO erstellt eine Liste von Verzeichnissen, die sich auf dem Desktop befinden und die folgenden Teilzeichenfolgen enthalten (alle Zeilen im Bootloader werden mit dem AES-256-ECB-Algorithmus verschlüsselt, Verschlüsselungsschlüssel werden durch fest codierte Kennwörter generiert): </li></ul><br><img src="https://habrastorage.org/webt/5f/xj/cb/5fxjcbvohua3udy6wiwixj3kwmo.jpeg"><br><br><ul><li>  Generiert eine Liste von URLs aus dem Browserverlauf, die die folgenden Teilzeichenfolgen enthalten: </li></ul><br><img src="https://habrastorage.org/webt/tc/ra/lh/tcralhf4zikmr0z5egouejvwafw.jpeg"><br><br><ul><li>  Erzeugt eine Liste von Dateien, die sich in den Verzeichnissen "% UserProfile% \\ Desktop", "% AppData%", "C: \\ Programme (x86)", "C: \\ Programme (x86) (x86)" und befinden haben die folgenden Namen: </li></ul><br><img src="https://habrastorage.org/webt/g5/5a/4k/g55a4keejjvjzv0jjdto5cs1fgw.jpeg"><br><br><ul><li>  Zählt die Anzahl der nicht leeren Listen anhand von Indikatoren für Bankgeschäfte (in der aktuellen Version des Bootloaders hat diese Funktionalität keine Auswirkungen). </li><li>  Erstellt eine Aufgabe, um diese Datei jedes Mal auszuführen, wenn sich ein Benutzer mit dem Befehl "schtasks / create / f / sc ONLOGON / RL HIGHEST / tn LimeRAT-Admin / tr" anmeldet. </li><li>  Wenn die Aufgabe nicht erstellt werden konnte, wird die Verknüpfung "% AppData% \\ Microsoft \\ Windows \\ Startmenü \\ Programme \\ Startup \\ MozillaUpdate.lnk" mit der Angabe "% Appdata% \\ Mozilla \\ xaudiodg.exe" erstellt. Dies stellt sicher, dass die Datei xaudiodg.exe bei jedem Neustart des Systems gestartet wird. </li><li>  Es kopiert sich entlang des Pfads "% AppData% \\ Mozilla \\ xaudiodg.exe". </li><li>  Löscht die Datei &lt;self_path&gt;: Zone.Identifier, führt xaudiodg.exe aus und löscht sich selbst. </li></ul><br><h4>  Wenn der Prozess aus dem Verzeichnis gestartet wird, das den Teilstring "Mozilla" enthält </h4><br><ul><li>  Malware sucht auch nach den oben genannten Indikatoren für Bankgeschäfte innerhalb des infizierten Systems. </li><li>  Sammelt andere Systeminformationen zum Senden an den Verwaltungsserver. </li><li>  In einem separaten Thread werden Informationen an C &amp; C gesendet und auf eine Antwort vom Server gewartet. </li><li>  In einem anderen Thread wird eine verschlüsselte Zeichenfolge "PING?" In einer Endlosschleife an den Server gesendet. </li></ul><br><h3>  <font color="#4169E1">Management Server-Interaktion</font> </h3><br>  Die Server-IP-Adresse im getesteten Malware-Beispiel lautet 213.252.244 [.] 200.  Die Verbindung wird durch einen zufällig ausgewählten Port aus der Liste initialisiert: <br><br>  • 8989, <br>  • 5656, <br>  • 2323. <br><br>  Unmittelbar nach der Initialisierung der Verbindung sendet der Bootloader Informationen über das infizierte System an C &amp; C: <br><br>  • Benutzer-ID, <br>  • Benutzername, <br>  • Betriebssystemversion, <br>  • eine eigene Version (Loader v0.2.1), <br>  • Listen von Indikatoren für Bankgeschäfte auf dem infizierten System. <br><br>  Ein Beispiel für eine vom Loader an den Verwaltungsserver gesendete Zeile: <br><br><pre><code class="xml hljs">«INFO<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">NYANxCAT</span></span></span><span class="hljs-tag">&gt;</span></span>9D3A4B22D21C<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">NYANxCAT</span></span></span><span class="hljs-tag">&gt;</span></span>IEUser<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">NYANxCAT</span></span></span><span class="hljs-tag">&gt;</span></span> Windows 7 Enterprise SP 1 <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">NYANxCAT</span></span></span><span class="hljs-tag">&gt;</span></span>loader v0.2.1<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">NYANxCAT</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">NYANxCAT</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">NYANxCAT</span></span></span><span class="hljs-tag">&gt;</span></span>1c, »</code> </pre> <br><br>  Diese Zeile wird gesendet, wenn sich auf dem Desktop des infizierten Benutzers ein Ordner "1c" befindet und keine anderen Anzeigen vorhanden sind. <br>  Die Funktion zum Verarbeiten der Antwort vom Server lautet wie folgt: <br><br><img src="https://habrastorage.org/webt/o7/a0/qj/o7a0qjtcivxuursy_coehrz0lds.png"><br><br>  Die entschlüsselte Antwort vom Server lautet wie folgt: <br><br><ul><li><pre> <code class="xml hljs">COMMAND<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">NYANxCAT</span></span></span><span class="hljs-tag">&gt;</span></span>DATA1<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">NYANxCAT</span></span></span><span class="hljs-tag">&gt;</span></span>DATA2<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">NYANxCAT</span></span></span><span class="hljs-tag">&gt;</span></span>…</code> </pre> </li></ul><br>  Wie aus dem Screenshot ersichtlich, kann COMMAND einen der folgenden Werte annehmen: <br><br><ul><li>  <b>SCHLIESSEN</b> - Beendet die Verbindung und schließt den aktuellen Prozess. </li><li>  <b>DW</b> - dekodiert base64-Inhalte aus DATA2, schreibt sie mit der Erweiterung aus DATA1 in die Datei &lt;temp_file_name&gt; und startet die Datei zur Ausführung. </li><li>  <b>UPDATE</b> - Dekodiert Base64-Inhalte aus DATA1, schreibt sie in eine Datei mit dem Namen &lt;Temp_Dateiname&gt; und der Erweiterung .exe, startet eine neue ausführbare Datei und löscht sich selbst. </li><li>  <b>RD-</b> - sendet als Antwort die Zeichenfolge "RD-"; </li><li>  <b>RD +</b> - sendet einen Screenshot an den Verwaltungsserver. </li><li>  DEL - löscht sich selbst. </li></ul><br>  Während der Bootloader-Untersuchung ist es uns gelungen, den DW-Befehl vom Angreifer-Server abzurufen.  Infolgedessen wurde die Punto Switcher-Software mit der schädlichen DLL winmm.dll (md5: 9d25553bb09e2785262b2f7ba7923605) installiert, bei der es sich um ein Buhtrap-Spyware-Modul handelt. <br><br>  TCP Stream ist wie folgt: <br><br><img src="https://habrastorage.org/webt/3c/su/h_/3csuh_fjfjm6hs4g9tt0ngql5qa.png"><br><br><img src="https://habrastorage.org/webt/mj/bw/uv/mjbwuvakfsdnak_k8lhfvtsht6o.png"><br><br>  Zum Verschlüsseln von Daten, die zwischen dem Client und dem Verwaltungsserver übertragen werden, wird der <b>AES-128-ECB-</b> Algorithmus verwendet.  Der Verschlüsselungsschlüssel wird mit einem fest codierten Kennwort initialisiert. <br><br>  Nach der Entschlüsselung ist der Verkehr wie folgt: <br><br><img src="https://habrastorage.org/webt/yp/-z/-8/yp-z-8jb5walz17xs-rozjatzjw.png"><br><br><img src="https://habrastorage.org/webt/lw/kg/ni/lwkgniohrsvqexvxamrwogmcmgy.png"><br><br>  Ab base64 wird das NSIS-Installationsprogramm mit den folgenden Inhalten dekodiert: <br><br><img src="https://habrastorage.org/webt/nx/fe/ij/nxfeijizxvvy4agsiobhqeil9tu.png"><br><br>  Interessanterweise antwortete der Server, obwohl die Liste der Bankindikatoren leer war. <br><br><h3>  <font color="#4169E1">Schädliche DLL</font> </h3><br>  Die Bibliothek <b>winmm.dll wird</b> mithilfe der DLL-Hijacking-Technik ausgeführt.  Das schädliche Modul sendet Informationen über das infizierte System und eine Liste der aktiven Smartcard-Leser an C &amp; C.  Darüber hinaus verfügt es über eine Keylogger-Komponente und kann andere schädliche Module vom verwaltenden Server empfangen, von der Festplatte oder im Speicher des aktuellen Prozesses ausführen.  C &amp; C-Server der untersuchten Stichprobe befinden sich unter folgenden Adressen: <br><br><ul><li>  hxxp: // my1cprovider [.] xyz: 6060 / klog [.] php </li><li>  hxxp: // tinderminderorli1999 [.] xyz: 7764 / klog [.] php </li></ul><br><h3>  <font color="#4169E1">Fazit</font> </h3><br>  Der Infektionsprozess kann wie folgt dargestellt werden: <br><br><img src="https://habrastorage.org/webt/r8/ho/0e/r8ho0ecv5utwzrjykx0yg4jrpuk.png"><br><br>  Trotz des guten Schutzes vor Analysen ist klar, dass der Bootloader derzeit nicht richtig funktioniert und sich höchstwahrscheinlich im Entwicklungsprozess befindet: <br><br><ul><li>  kann sich selbst auf einem realen System selbst löschen; </li><li>  Überprüft die Verbindung des infizierten Systems mit Bankgeschäften, bevor es sich selbst in "% AppData% \\ Mozilla \\ xaudiodg.exe" kopiert und mit C &amp; C interagiert, verwendet diese Informationen jedoch in keiner Weise. </li></ul><br>  Erinnern Sie sich schließlich an die seltsame Fenstermeldung.  Interessanterweise ist dies ein Fehler bei den Entwicklern - oder wird dies speziell getan, um Benutzer zu ermutigen, die virtuelle Umgebung zu verlassen und auf einer realen Maschine zu starten?  Willkommen in den Kommentaren. <br><br><h3>  <font color="#4169E1">IOCs</font> </h3><br>  <b>MD5:</b> <br><br>  <i>faf833a1456e1bb85117d95c23892368</i> <i><br></i>  <i>9d25553bb09e2785262b2f7ba7923605</i> <br><br>  <b>URLs:</b> <br><br>  hxxp: // my1cprovider [.] xyz: 6060 / klog [.] php <br>  hxxp: // tinderminderorli1999 [.] xyz: 7764 / klog [.] php <br>  IPs: <br>  213.252.244 [.] 200 </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de434626/">https://habr.com/ru/post/de434626/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de434616/index.html">Sowjetisches HI-FI und seine Schöpfer: Digitale Tonaufnahme in der UdSSR - ein Schritt vom Sieg entfernt</a></li>
<li><a href="../de434618/index.html">MVP und Dolch 2 - Android Application Skeleton - Teil 2</a></li>
<li><a href="../de434620/index.html">Erstellen Sie einen stilvollen Wasserfall aus RiME direkt in Unity oder UE4</a></li>
<li><a href="../de434622/index.html">Welche Welten können nach dem Tod der Sonne überleben?</a></li>
<li><a href="../de434624/index.html">Wie ich einen Fehler in GNU Tar gefunden habe</a></li>
<li><a href="../de434628/index.html">bitContainer (für Lebensmittel) - hausgemachte Yandex.Station</a></li>
<li><a href="../de434634/index.html">Universal Radio Hacker - Eine einfache Möglichkeit, digitale Funkprotokolle zu erkunden</a></li>
<li><a href="../de434636/index.html">Wie man Kinder ausbeutet</a></li>
<li><a href="../de434638/index.html">Raketenstart aus dem Osten mit eigenen Augen</a></li>
<li><a href="../de434640/index.html">Warum eine regelmäßige E-Mail-Validierung nicht ausreicht. Validierung von MX-Datensätzen anhand von Beispielen in PHP und Ruby</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>