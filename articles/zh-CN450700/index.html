<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏼‍🏭 👨🏾‍🔧 🧑🏽 关于有漏洞的抽象（或关于不可预测的环境） 🔽 🕣 🐩</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="因此，这是Windows程序的相当简单的一部分。 有一个包含多个条目的文件。 而且它们需要以某种方式进行过滤。 

 解决方案非常简单-打开文件，逐一读取记录，然后将必要的记录写入临时文件。 关闭文件。 我们将其删除。 重命名为原始临时文件。 一切都很简单，我什至不提供代码。 这真的是这篇文章足够的...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>关于有漏洞的抽象（或关于不可预测的环境）</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/450700/"> 因此，这是Windows程序的相当简单的一部分。 有一个包含多个条目的文件。 而且它们需要以某种方式进行过滤。 <br><br> 解决方案非常简单-打开文件，逐一读取记录，然后将必要的记录写入临时文件。 关闭文件。 我们将其删除。 重命名为原始临时文件。 一切都很简单，我什至不提供代码。 这真的是这篇文章足够的理由吗？ <br><br> 尽管一切正常，但实际上没有理由对此进行撰写。 但是后来突然有一天“一切都掉了”，因为 由于访问被拒绝错误，未发生重命名。 这种情况很少发生，但怀疑宇宙射线的可能性仍然更高。 <br><a name="habracut"></a><br> 我们开始挖掘。 找到的第一个线索：在进行挖掘的过程中，Microsoft文档中的这句话提醒： <br><blockquote>  DeleteFile函数在关闭时将文件标记为要删除。 因此，在关闭文件的最后一个句柄之前，不会发生文件删除。 随后对CreateFile的调用以打开文件失败，并显示ERROR_ACCESS_DENIED。 </blockquote> 就症状而言，它们非常相似，但是这些“其他处理程序”来自哪里，如果除了我们之外，没有人对这个文件做任何事情，也应该不做任何事情？ 而且我们没有其他线程可以对该文件进行处理的线程吗？ <br><br> 正是由于SysInternals及其ProcessMonitor才找到了罪魁祸首。 我们启动它，将过滤器安装在我们长期受苦的文件上，并尝试长期持久地重现它。 我们复制。 我们看。 我们在那看到什么？ <br><blockquote>  01.2：30：28.3162097 PM our_prog.exe 1288 CreateFile our.file成功所需访问权限：通用读取/写入 <br>  02.2：25：28.3164513 PM our_prog.exe 1288 WriteFile our.file成功偏移量：0，长度：898，优先级：正常 <br>  ... <br>  34.2：25：28.3173405 PM our_prog.exe 1288 WriteFile our.file成功偏移量：35,290，长度：1,113 <br>  35.2：25：28.3173493 PM our_prog.exe 1288 WriteFile our.file成功偏移量：36,403，长度：1,128 <br>  36.2：25：28.3173736 PM our_prog.exe 1288 FlushBuffersFile our.file成功 <br>  37.2：25：28.3174212 PM our_prog.exe 1288 WriteFile our.file成功偏移量：0，长度：40,960， <br>  38.2：25：28.3175927 PM Explorer.EXE 1884 QueryBasicInformationFile our.file成功 <br>  39.2：25：28.3176144 PM Explorer.EXE 1884 CloseFile our.file成功 <br>  40.2：25：28.3263642 PM Explorer.EXE 1884 CreateFile our.file成功所需访问权限：读取属性， <br>  41.2：25：28.3294990 PM our_prog.exe 1288 CloseFile our.file成功 <br>  42.2：25：28.3351356 PM our_prog.exe 1288 CreateFile our.file成功所需访问权限：读取属性，删除， <br>  43.2：25：28.3351856 PM our_prog.exe 1288 QueryAttributeTagFile our.file成功属性：A，ReparseTag：0x0 <br>  44.2：25：28.3352020 PM our_prog.exe 1288 SetDispositionInformationFile our.file成功删除：True <br>  45.2：25：28.3352218 PM our_prog.exe 1288 CloseFile our.file成功 <br>  46.2：25：28.3358275 PM our_prog.exe 1288 CreateFile our.file DELETE PENDING所需的访问权限：通用读取/写入， <br>  47.2：25：28.3362207 PM our_prog.exe 1288 CreateFile our.file DELETE PENDING所需的访问权限：通用读取/写入， <br>  48.2：25：28.3367696 PM Explorer.EXE 1884 QueryBasicInformationFile our.file成功 <br>  49.2：25：28.4279152 PM Explorer.EXE 1884 CloseFile our.file成功 <br>  50.2：25：28.4282859 PM Explorer.EXE 1884 CreateFile our.file名称未找到所需的访问权限：读取属性， <br>  ... <br>  83.2：25：29.3497760 PM our_prog.exe 1288 CreateFile our.file成功所需访问权限：通用读取/写入， </blockquote> 我们在那里看到了以下内容（删除了多余的数据，以免造成混乱）。 第1至36行-我们创建一个文件，写入该文件，进行刷新。 最有趣的是从38-40行开始。  Explorer.exe无处不在，并开始读取我们的文件。 <br><br> 在第41行，我们关闭文件。 第42行-删除。 并且由于explorer.exe仍在读取它，因此不会删除该文件。 当我们尝试将临时文件重命名为主要文件时（在DELETE PENDING状态而不是SUCCESS），我们在第46和47行上看到了什么。 <br><br>  Explorer.exe仅在第49行完成读取。仅在此刻，文件才被物理删除（正如第50行间接告诉我们的那样，我们的永久explorer.exe再次尝试打开该文件以进行读取，但是由于该文件而失败不再）。 <br><br> 随之而来的是什么？ 多亏了Microsoft Windows，现在甚至需要采用偏执编程的方式来完成简单的文件删除操作。 他们调用了delete函数，确保它返回OK，然后进入等待周期“直到文件已被物理删除为止”。 是的，是的，在不知道“她的内部有霓虹灯”的情况下，几乎什么也做不了... <br><br> 但是现在，令人怀疑的是，这种方法是一种普遍接受的做法。 为了在使用Windows中的文件进行操作时牢记，操作系统随时会在您不知情的情况下决定对文件进行某些操作，并编写可抵抗这种情况的代码。 就此而言，调查较低。 </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN450700/">https://habr.com/ru/post/zh-CN450700/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN450686/index.html">Zimbra Collaboration Suite的其他三项显而易见的功能将有助于提高员工的工作效率</a></li>
<li><a href="../zh-CN450692/index.html">企业如何在产品销售中使用7个致命罪</a></li>
<li><a href="../zh-CN450694/index.html">为什么杰夫·贝索斯（Jeff Bezos）建议扩大规模失败并观看科幻小说</a></li>
<li><a href="../zh-CN450696/index.html">用于Yii的CRUD小部件生成器</a></li>
<li><a href="../zh-CN450698/index.html">Box2D中的齿轮</a></li>
<li><a href="../zh-CN450702/index.html">该死的地方？</a></li>
<li><a href="../zh-CN450704/index.html">安全周19：IP摄像机，GPS跟踪器和无线监控器中的漏洞</a></li>
<li><a href="../zh-CN450708/index.html">Visual Studio Code中的Python-2019年4月发布</a></li>
<li><a href="../zh-CN450710/index.html">从合成视频（及类似视频）重建Midi</a></li>
<li><a href="../zh-CN450712/index.html">DotNext 2019 Piter上的DotNetRu</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>