<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>✋🏻 ♐️ 🎋 Präfixbaum mit Bitmap-Indizes 👎🏿 ✊🏾 ✋🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Vor nicht allzu langer Zeit musste ich eine Funktionalität implementieren, die bereits von anderen Leuten und mehrmals implementiert wurde, aber für e...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Präfixbaum mit Bitmap-Indizes</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/479244/">  Vor nicht allzu langer Zeit musste ich eine Funktionalität implementieren, die bereits von anderen Leuten und mehrmals implementiert wurde, aber für einige Eigenschaften nicht geeignet war.  In diesem Fall war eine Art Datenstruktur mit der Möglichkeit erforderlich, nach einem Zeichenfolgenschlüssel oder mehreren Anfangszeichen des Schlüssels zu suchen.  Der Schlüssel ist in jedem Fall eine Folge lateinischer Buchstaben, Leerzeichen und Zahlen. <br><br>  Andere Implementierungen passten zuallererst nicht zum verbrauchten Speicher.  In jedem Fall wird eine weitere Implementierung des Präfixbaums nicht überflüssig sein. <a name="habracut"></a><br><br>  Die Idee wurde wahrscheinlich von <a href="https://habr.com/ru/company/badoo/blog/451938/">diesem Artikel</a> inspiriert, da entschieden wurde, den Bitmap-Index zum Indizieren von Links zu nachfolgenden Knoten im Knoten zu verwenden. <br><br>  Offensichtlich darf die Anzahl der Verknüpfungen in einem Knoten nicht mehr als 63 betragen (10 Ziffern, 26 Buchstaben in jedem Register plus ein Leerzeichen).  Daher wird für einen Bitmap-Index an jedem Knoten eine 64-Bit-Nummer verwendet.  Das gesetzte Bit an einer beliebigen Position bedeutet das Vorhandensein des entsprechenden Symbols und Knotens (Teilbaum). <br><br>  Die Verteilung im Bitmap-Index ist wie folgt: Zahlen von 0 bis 9 belegen 0 bis 9 Bit, Buchstaben az von 10 bis 35 Bit, Buchstaben AZ von 36 bis 62 Bit und ein Leerzeichen belegen 63 Bit.  Um die Bitnummer zu erhalten, wird einfach der ASCII-Zeichencode verwendet, der um eine bestimmte Zahl verringert wird.  Für jeden Zeichenbereich ist die Zahl unterschiedlich: für die Zahlen 48 (der Ziffernbereich in ASCII-Codes beginnt mit 48), für die Buchstaben az 87 (der Buchstabenbereich az beginnt mit minus 10 Bits, die bereits mit 10 Ziffern belegt sind) und so weiter. <br><br>  Die entsprechende Tabelle ist unten dargestellt. <br><br><div class="scrollable-table"><table><tbody><tr><th colspan="14">  Zeichenverteilung </th></tr><tr><td>  Symbol </td><td>  0 </td><td>  1 </td><td>  ... </td><td>  9 </td><td>  a </td><td>  b </td><td>  ... </td><td>  z </td><td>  A </td><td>  B </td><td>  ... </td><td>  Z </td><td>  Leertaste </td></tr><tr><td>  Bitnummer </td><td>  0 </td><td>  1 </td><td>  ... </td><td>  9 </td><td>  10 </td><td>  11 </td><td>  ... </td><td>  35 </td><td>  36 </td><td>  37 </td><td>  ... </td><td>  61 </td><td>  62 </td></tr></tbody></table></div><br>  Der Knoten wird durch den folgenden Code dargestellt: <br><br><pre><code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Trie <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { rw sync.RWMutex characters <span class="hljs-keyword"><span class="hljs-keyword">uint64</span></span> subTries []*Trie data <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>{} }</code> </pre> <br>  Somit speichert jeder Knoten den Bitmap-Index der folgenden Zeichen, ein Slice mit Links zu Teilbäumen und den Daten selbst.  Ich werde kurz auf die Such-, Einfüge- und Löschmechanismen eingehen. <br><br>  Bei der Eingabe der Eingabe durchläuft der Schlüssel symbolisch den Baum, beginnend mit dem Stammknoten.  Für jedes Zeichen aus seinem ASCII-Code wird die Bitnummer berechnet, und auf deren Grundlage wird der Index in der Schicht von Verknüpfungen (SubTries) zu Unterbäumen berechnet.  Der Indexwert ist die Anzahl der Bits vor dem gewünschten Bit.  Zum Beispiel haben wir einen solchen Index: 00 ... 101.  Dies bedeutet, dass es im Bitmap-Index die Nummern 0 und 2 gibt. Dann ist der Index für die Nummer 0 Null, und für die Nummer 2 ist es 1, dh SubTries speichert 2 Links zu Unterbäumen: SubTries [0] und SubTries [1]. . <br><br>  Der Code zum Abrufen der Bitnummer für das Zeichen: <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">calcBitNum</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(char </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">rune</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint64</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">// Characters az use bit positions 10-35 if char &gt; 96 &amp;&amp; char &lt; 123 { return uint64(char - 87), true } // Characters AZ use bit positions 36-61 if char &gt; 64 &amp;&amp; char &lt; 91 { return uint64(char - 29), true } // digits 0-9 use bit positions 0-9 if char &gt; 47 &amp;&amp; char &lt; 58 { return uint64(char - 48), true } // space uses 62 bit position if char == 32 { return 62, true } return 0, false }</span></span></code> </pre> <br>  Der Code zum Abrufen des Knotenindex für das Zeichen: <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(trie *Trie)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getSubTreeIndex</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(bitNum </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint64</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span></span> { shifted := trie.characters &lt;&lt; (<span class="hljs-number"><span class="hljs-number">64</span></span> - bitNum) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bits.OnesCount64(shifted) }</code> </pre> <br>  Der Code zum Abrufen des Knotens für das angegebene Zeichen: <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(trie *Trie)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getSubTrie</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(char </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">rune</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint64</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">, *Trie)</span></span></span></span> { bitNum, _ := calcBitNum(char) subTrieId := trie.getSubTreeIndex(bitNum) <span class="hljs-comment"><span class="hljs-comment">// There is no subTrie under given character since the corresponding bit is zero if trie.characters&amp;(1&lt;&lt;bitNum) == 0 { return bitNum, subTrieId, nil } return bitNum, subTrieId, trie.subTries[subTrieId] }</span></span></code> </pre> <br><h4>  Einfügen </h4><br>  Ein Baum wird durchlaufen, um ein Element einzufügen.  Fehlt ein Zeichen (und damit alle nachfolgenden), wird es in den Bitmap-Index eingefügt.  Es wird ein Teilbaum erstellt, dessen Verknüpfung an der richtigen Stelle der Slice-SubTries eingefügt wird (die richtige Stelle wird durch die Anzahl der Bits bis zur gewünschten bestimmt).  Wenn sie das letzte Zeichen des Schlüssels erreicht haben, werden Daten in den letzten Teilbaum eingefügt. <br><br><h4>  Suche </h4><br>  Zum Suchen "rennt" der Schlüssel symbolisch durch den Baum.  Sobald es vorbei ist, wird das Ergebnis zurückgegeben.  Wenn für den Schlüssel keine Daten vorhanden sind, aber weitere Teilbäume vorhanden sind, werden die Ergebnisse aus allen nachfolgenden Teilbäumen mit Daten ausgewählt.  Das Limit für die Anzahl der zurückgegebenen Daten kann festgelegt werden.  Somit ist es möglich, einen Knoten durch das Zusammentreffen des gesamten Schlüssels oder eine Menge von Knoten durch das Zusammentreffen mehrerer Anfangszeichen zu suchen. <br><br><h4>  Löschen </h4><br>  Der Entfernungsvorgang war (wie erwartet) komplizierter als der Rest.  Um einen Schlüssel zu löschen, wird ein Baum durchlaufen, während dessen Knoten ohne Daten in einem separaten Slice aufgezeichnet werden.  Wenn ein Knoten mit Daten gefunden wird, wird die Schicht auf Null zurückgesetzt und der Durchgang durch den Baum wird weiter fortgesetzt.  Das heißt, das Segment der zu löschenden Knoten sollte eine Folge von Knoten enthalten, die keine Daten enthalten.  Wenn das Slice am Ende nicht leer ist, wird die Reihenfolge umgekehrt, und die entsprechenden Bits werden aus dem Bitmap-Index entfernt und die Knoten werden gelöscht. <br><br><h4>  Zusammenfassung </h4><br>  Das Ergebnis ist ein Präfixbaum, der hinsichtlich Geschwindigkeit und Speicherverbrauch anderen Analoga überlegen ist (durchschnittlich 30% weniger Speicher und ebenso viel schneller).  Außerdem war ich nicht zu faul, Multithreading-Vorgänge mit einem Baum zu ermöglichen, was die Produktivität insbesondere bei Suchvorgängen erheblich steigert.  Natürlich ist die Lösung ziemlich spezialisiert (Beschränkung in Form von lateinischen Zeichen, Zahlen und einem Leerzeichen als Schlüsselkomponenten). <br><br>  Basierend auf dem Zweck des Präfixbaums kann mit dieser Lösung ein Wörterbuch und ein Suchindex erstellt werden. <br><br>  Ich habe die Einfüge-, Such- und Löschcodes nicht zitiert, um den Artikel nicht zu <a href="https://github.com/maratig/go-trie">überfrachten</a> . Außerdem ist der Quellcode <a href="https://github.com/maratig/go-trie">auf dem Github</a> verfügbar. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de479244/">https://habr.com/ru/post/de479244/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de479234/index.html">Neuigkeiten aus der Welt von OpenStreetMap Nr. 488 (19.11.19 - 25.11.19)</a></li>
<li><a href="../de479236/index.html">Kivy. Erstellen Sie Pakete für Android und keine Zauberei</a></li>
<li><a href="../de479238/index.html">Funktionale Programmierung ist nicht das, was uns gesagt wird</a></li>
<li><a href="../de479240/index.html">Der Code, in dem wir leben</a></li>
<li><a href="../de479242/index.html">Wir stellen Yandex.Station fertig, um YouTube anzuschauen</a></li>
<li><a href="../de479246/index.html">11 Richtungen für das Wachstum und die berufliche Entwicklung eines Programmierers</a></li>
<li><a href="../de479248/index.html">Mitap „Kubernetes in Aktion!“ - echte Erfahrung beim Aufbau skalierbarer Systeme</a></li>
<li><a href="../de479250/index.html">Wie ich gelernt habe, mit Mikrocontrollern zu arbeiten - eine Anfängererfahrung</a></li>
<li><a href="../de479252/index.html">Listenverständnis vs Karte</a></li>
<li><a href="../de479256/index.html">Nach dem Astrotracker an zwei Abenden - Meine Erfahrung</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>