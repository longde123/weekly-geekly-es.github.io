<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏾‍🤝‍👨🏼 🕉️ 👩🏼‍🎓 Cooking Perfect CSS 🤽 👩🏽‍🌾 🙅🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, Habr! 

 Il n'y a pas si longtemps, j'ai réalisé que travailler avec CSS dans toutes mes applications est une douleur pour le développeur et ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Cooking Perfect CSS</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/constanta/blog/428800/">  Bonjour, Habr! <br><br>  Il n'y a pas si longtemps, j'ai réalisé que travailler avec CSS dans toutes mes applications est une douleur pour le développeur et l'utilisateur. <br><br>  Sous la coupe se trouvent mes problèmes, un tas de code étrange et des pièges sur la façon de travailler correctement avec les styles. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/hh/ut/5e/hhut5eodm-tw-e1wdqnecn7dxlu.png"></div><a name="habracut"></a><br><h2>  Problème CSS </h2><br>  Dans les projets React et Vue que j'ai réalisés, l'approche des styles était à peu près la même.  Le projet est collecté par webpack, un fichier CSS est importé du point d'entrée principal.  Ce fichier importe en lui-même le reste des fichiers CSS qui utilisent BEM pour nommer les classes. <br><br><pre><code class="plaintext hljs">styles/ indes.css blocks/ apps-banner.css smart-list.css ...</code> </pre> <br>  Est-ce familier?  J'ai utilisé cette implémentation presque partout.  Et tout allait bien jusqu'à ce que l'un des sites atteigne un état tel que les problèmes de style ont commencé à énerver mes yeux. <br><br>  <b>1. Le problème du rechargement à chaud</b> <br>  L'importation des styles les uns des autres s'est faite via le plugin postcss ou le chargeur de stylets. <br>  Le hic est le suivant: <br><br>  Lorsque nous résolvons les importations via le plugin postcss ou le chargeur de stylets, la sortie est un grand fichier CSS.  Maintenant, même avec un léger changement dans l'une des feuilles de style, tous les fichiers CSS seront à nouveau traités. <br><br>  Il tue vraiment la vitesse de rechargement à chaud: il faut environ 4 secondes pour traiter ~ 950 Ko de fichiers de stylet. <br><br><div class="spoiler">  <b class="spoiler_title">Remarque sur css-loader</b> <div class="spoiler_text">  Si l'importation de fichiers CSS a été résolue via css-loader, un tel problème ne se serait pas posé: <br>  css-loader transforme CSS en JavaScript.  Il remplacera toutes les importations de style par require.  La modification d'un fichier CSS n'affectera pas les autres fichiers et le rechargement à chaud se fera rapidement. <br><br>  Vers css-loader <br><br><pre> <code class="css hljs"><span class="hljs-comment"><span class="hljs-comment">/* main.css */</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">'./test.css'</span></span>; <span class="hljs-selector-tag"><span class="hljs-selector-tag">html</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">body</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">margin</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">padding</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">width</span></span>: <span class="hljs-number"><span class="hljs-number">100%</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">height</span></span>: <span class="hljs-number"><span class="hljs-number">100%</span></span>; } <span class="hljs-selector-tag"><span class="hljs-selector-tag">body</span></span> { <span class="hljs-comment"><span class="hljs-comment">/* background-color: #a1616e; */</span></span> <span class="hljs-attribute"><span class="hljs-attribute">background-color</span></span>: red; }</code> </pre><br>  Après <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/* main.css */</span></span> <span class="hljs-comment"><span class="hljs-comment">// imports exports.i(require("-!../node_modules/css-loader/index.js!./test.css"), ""); // module exports.push([module.id, "html, body {\n margin: 0;\n padding: 0;\n width: 100%;\n height: 100%;\n}\n\nbody {\n /* background-color: #a1616e; */\n background-color: red;\n}\n", ""]); // exports</span></span></code> </pre><br></div></div><br>  <b>2. Le problème du fractionnement de code</b> <br><br>  Lorsque les styles sont chargés à partir d'un dossier séparé, nous ne connaissons pas le contexte d'utilisation de chacun d'eux.  Avec cette approche, il n'est pas possible de diviser CSS en plusieurs parties et de les charger selon les besoins. <br><br>  <b>3. Grands noms de classe CSS</b> <br><br>  Chaque nom de classe BEM ressemble à ceci: nom-bloc__nom-élément.  Un nom aussi long affecte fortement la taille finale du fichier CSS: sur le site Web Habr, par exemple, les noms de classe CSS occupent 36% de la taille du fichier de style. <br><br>  Google est conscient de ce problème et utilise depuis longtemps la minification des noms dans tous ses projets: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/zb/ft/yx/zbftyxjxnsh-irc6odfc5cszvxk.png" alt="Un morceau de google.com"></div><br>  <font color="#999999"><i>Un morceau de google.com</i></font> <br><br>  Tous ces problèmes m'ont remis en ordre, j'ai finalement décidé d'y mettre fin et d'obtenir le résultat parfait. <br><br><h2>  Sélection de décision </h2><br>  Pour se débarrasser de tous les problèmes ci-dessus, j'ai trouvé deux solutions: CSS In JS (styled-components) et modules CSS. <br><br>  Je n'ai pas vu de défauts critiques dans ces solutions, mais au final mon choix s'est porté sur les modules CSS pour plusieurs raisons: <br><br><ul><li>  Vous pouvez mettre CSS dans un fichier séparé pour une mise en cache séparée de JS et CSS. </li><li>  Plus d'options pour les styles de frittage. </li><li>  Il est plus courant de travailler avec des fichiers CSS. </li></ul><br>  Le choix est fait, il est temps de commencer la cuisine! <br><br><h2>  Réglage de base </h2><br>  Configurez un peu le webpack.  Ajoutez css-loader et activez-y les modules CSS: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/* webpack.config.js */</span></span> <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { <span class="hljs-comment"><span class="hljs-comment">/* … */</span></span> <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>: { <span class="hljs-attr"><span class="hljs-attr">rules</span></span>: [ <span class="hljs-comment"><span class="hljs-comment">/* … */</span></span> { <span class="hljs-attr"><span class="hljs-attr">test</span></span>: <span class="hljs-regexp"><span class="hljs-regexp">/\.css$/</span></span>, <span class="hljs-attr"><span class="hljs-attr">use</span></span>: [ <span class="hljs-string"><span class="hljs-string">'style-loader'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">loader</span></span>: <span class="hljs-string"><span class="hljs-string">'css-loader'</span></span>, <span class="hljs-attr"><span class="hljs-attr">options</span></span>: { <span class="hljs-attr"><span class="hljs-attr">modules</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, } }, ], }, ], }, };</code> </pre><br>  Nous allons maintenant diffuser les fichiers CSS dans des dossiers contenant des composants.  À l'intérieur de chaque composant, nous importons les styles nécessaires. <br><br><pre> <code class="plaintext hljs">project/ components/ CoolComponent/ index.js index.css</code> </pre><br><pre> <code class="css hljs"><span class="hljs-comment"><span class="hljs-comment">/* components/CoolComponent/index.css */</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.contentWrapper</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">padding</span></span>: <span class="hljs-number"><span class="hljs-number">8px</span></span> <span class="hljs-number"><span class="hljs-number">16px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">background-color</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">rgba</span></span>(45, 45, 45, .3); } <span class="hljs-selector-class"><span class="hljs-selector-class">.title</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">font-size</span></span>: <span class="hljs-number"><span class="hljs-number">14px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">font-weight</span></span>: bold; } <span class="hljs-selector-class"><span class="hljs-selector-class">.text</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">font-size</span></span>: <span class="hljs-number"><span class="hljs-number">12px</span></span>; }</code> </pre><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/* components/CoolComponent/index.js */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> React <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> styles <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./index.css'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> ({ text }) =&gt; ( <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">className</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{styles.contentWrapper}</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">className</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{styles.title}</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> Weird title </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">className</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{styles.text}</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> {text} </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> );</code> </pre><br>  Maintenant que nous avons cassé les fichiers CSS, le rechargement à chaud ne traitera que les modifications apportées à un seul fichier.  Problème numéro 1 résolu, bravo! <br><br><h2>  Divisez le CSS en morceaux </h2><br>  Lorsqu'un projet comporte de nombreuses pages et que le client n'a besoin que d'une seule, il est inutile de pomper toutes les données.  React dispose d'une excellente bibliothèque téléchargeable pour cela.  Il vous permet de créer un composant qui télécharge dynamiquement le fichier dont nous avons besoin, si nécessaire. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/* AsyncCoolComponent.js */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Loadable <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react-loadable'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Loading <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'path/to/Loading'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> Loadable({ <span class="hljs-attr"><span class="hljs-attr">loader</span></span>: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span>(<span class="hljs-comment"><span class="hljs-comment">/* webpackChunkName: 'CoolComponent' */</span></span><span class="hljs-string"><span class="hljs-string">'path/to/CoolComponent'</span></span>), <span class="hljs-attr"><span class="hljs-attr">loading</span></span>: Loading, });</code> </pre><br>  Webpack transformera le composant CoolComponent en un fichier JS (bloc) distinct, qui sera téléchargé lorsque AsyncCoolComponent sera rendu. <br><br>  Dans le même temps, CoolComponent contient ses propres styles.  CSS s'y trouve jusqu'à présent sous la forme d'une chaîne JS et est inséré en tant que style à l'aide du chargeur de style.  Mais pourquoi ne coupons-nous pas les styles dans un fichier séparé? <br><br>  Nous créerons notre propre fichier CSS pour le fichier principal et pour chacun des morceaux. <br><br>  Installez mini-css-extract-plugin et évoquez la configuration du webpack: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/* webpack.config.js */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> MiniCssExtractPlugin = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'mini-css-extract-plugin'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> isDev = process.env.NODE_ENV === <span class="hljs-string"><span class="hljs-string">'development'</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>: { <span class="hljs-attr"><span class="hljs-attr">rules</span></span>: [ { <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> test: <span class="hljs-regexp"><span class="hljs-regexp">/\.css$/</span></span>, <span class="hljs-attr"><span class="hljs-attr">use</span></span>: [ (isDev ? <span class="hljs-string"><span class="hljs-string">'style-loader'</span></span> : MiniCssExtractPlugin.loader), { <span class="hljs-attr"><span class="hljs-attr">loader</span></span>: <span class="hljs-string"><span class="hljs-string">'css-loader'</span></span>, <span class="hljs-attr"><span class="hljs-attr">options</span></span>: { <span class="hljs-attr"><span class="hljs-attr">modules</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, }, }, ], }, ], }, <span class="hljs-attr"><span class="hljs-attr">plugins</span></span>: [ <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> ...(isDev ? [] : [ <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MiniCssExtractPlugin({ <span class="hljs-attr"><span class="hljs-attr">filename</span></span>: <span class="hljs-string"><span class="hljs-string">'[name].[contenthash].css'</span></span>, <span class="hljs-attr"><span class="hljs-attr">chunkFilename</span></span>: <span class="hljs-string"><span class="hljs-string">'[name].[contenthash].css'</span></span>, }), ]), ], };</code> </pre><br>  C'est tout!  Assemblons le projet en mode production, ouvrons le navigateur et voyons l'onglet réseau: <br><br><pre> <code class="plaintext hljs">//    GET /main.aff4f72df3711744eabe.css GET /main.43ed5fc03ceb844eab53.js //  CoolComponent ,   JS  CSS GET /CoolComponent.3eaa4773dca4fffe0956.css GET /CoolComponent.2462bbdbafd820781fae.js</code> </pre><br>  Le problème numéro 2 est terminé. <br><br><h2>  Nous minimisons les classes CSS </h2><br>  Css-loader modifie les noms de classe à l'intérieur et renvoie une variable avec le mappage des noms de classe locaux à global. <br><br>  Après notre configuration de base, css-loader génère un long hachage basé sur le nom et l'emplacement du fichier. <br><br>  Dans le navigateur, notre CoolComponent ressemble maintenant à ceci: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"rs2inRqijrGnbl0txTQ8v"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"_2AU-QBWt5K2v7J1vRT0hgn"</span></span></span><span class="hljs-tag">&gt;</span></span> Weird title <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"_1DaTAH8Hgn0BQ4H13yRwQ0"</span></span></span><span class="hljs-tag">&gt;</span></span> Lorem ipsum dolor sit amet consectetur. <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Bien sûr, cela ne nous suffit pas. <br><br>  Il est nécessaire que pendant le développement, il y ait des noms pour trouver le style original.  Et en mode production, les noms de classe doivent être minifiés. <br><br>  Css-loader vous permet de personnaliser le changement de nom de classe via les options localIdentName et getLocalIdent.  En mode développement, nous définirons le descriptif localIdentName - '[chemin] _ [nom] _ [local]', et pour le mode production, nous créerons une fonction qui minimisera les noms de classe: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/* webpack.config.js */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> getScopedName = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'path/to/getScopedName'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> isDev = process.env.NODE_ENV === <span class="hljs-string"><span class="hljs-string">'development'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>: { <span class="hljs-attr"><span class="hljs-attr">rules</span></span>: [ <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> { <span class="hljs-attr"><span class="hljs-attr">test</span></span>: <span class="hljs-regexp"><span class="hljs-regexp">/\.css$/</span></span>, <span class="hljs-attr"><span class="hljs-attr">use</span></span>: [ <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">isDev ? </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'style-loader'</span></span></span></span><span class="hljs-function"><span class="hljs-params"> : MiniCssExtractPlugin.loader</span></span></span><span class="hljs-function">), { </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">loader</span></span></span><span class="hljs-function">: '</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">css</span></span></span><span class="hljs-function">-</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">loader</span></span></span><span class="hljs-function">', </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">: { </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">modules</span></span></span><span class="hljs-function">: </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">true</span></span></span><span class="hljs-function">, ...(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">isDev ? { localIdentName: </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'[path]_[name]_[local]'</span></span></span></span><span class="hljs-function"><span class="hljs-params">, } : { getLocalIdent: (context, localIdentName, localName</span></span></span><span class="hljs-function">) =&gt;</span></span> ( getScopedName(localName, context.resourcePath) ), }), }, }, ], }, ], }, };</code> </pre><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/* getScopedName.js */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   ,        CSS      */</span></span> <span class="hljs-comment"><span class="hljs-comment">//      const incstr = require('incstr'); const createUniqueIdGenerator = () =&gt; { const uniqIds = {}; const generateNextId = incstr.idGenerator({ //  d ,    ad, //      Adblock alphabet: 'abcefghijklmnopqrstuvwxyzABCEFGHJKLMNOPQRSTUVWXYZ', }); //       return (name) =&gt; { if (!uniqIds[name]) { uniqIds[name] = generateNextId(); } return uniqIds[name]; }; }; const localNameIdGenerator = createUniqueIdGenerator(); const componentNameIdGenerator = createUniqueIdGenerator(); module.exports = (localName, resourcePath) =&gt; { //   ,     index.css const componentName = resourcePath .split('/') .slice(-2, -1)[0]; const localId = localNameIdGenerator(localName); const componentId = componentNameIdGenerator(componentName); return `${componentId}_${localId}`; };</span></span></code> </pre><br>  Et nous avons ici dans le développement de beaux noms visuels: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"src-components-ErrorNotification-_index_content-wrapper"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"src-components-ErrorNotification-_index_title"</span></span></span><span class="hljs-tag">&gt;</span></span> Weird title <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"src-components-ErrorNotification-_index_text"</span></span></span><span class="hljs-tag">&gt;</span></span> Lorem ipsum dolor sit amet consectetur. <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Et dans les classes de production minifiées: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"e_f"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"e_g"</span></span></span><span class="hljs-tag">&gt;</span></span> Weird title <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"e_h"</span></span></span><span class="hljs-tag">&gt;</span></span> Lorem ipsum dolor sit amet consectetur. <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Le troisième problème est surmonté. <br><br><h2>  Supprimer l'invalidation inutile du cache </h2><br>  En utilisant la technique de minification de classe décrite ci-dessus, essayez de construire le projet plusieurs fois.  Faites attention aux caches de fichiers: <br><br><pre> <code class="plaintext hljs">/*   */ app.bf70bcf8d769b1a17df1.js app.db3d0bd894d38d036117.css /*   */ app.1f296b75295ada5a7223.js app.eb2519491a5121158bd2.css</code> </pre><br>  Il semble qu'après chaque nouvelle version, nous ayons invalidé les caches.  Comment ça? <br><br>  Le problème est que webpack ne garantit pas l'ordre dans lequel les fichiers sont traités.  Autrement dit, les fichiers CSS seront traités dans un ordre imprévisible, différents noms minifiés seront générés pour le même nom de classe avec différents assemblys. <br><br>  Pour surmonter ce problème, enregistrons les données sur les noms de classe générés entre les assemblys.  Mettez à jour un peu le fichier getScopedName.js: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/* getScopedName.js */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> incstr = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'incstr'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//     const { getGeneratorData, saveGeneratorData, } = require('./generatorHelpers'); const createUniqueIdGenerator = (generatorIdentifier) =&gt; { //    const uniqIds = getGeneratorData(generatorIdentifier); const generateNextId = incstr.idGenerator({ alphabet: 'abcefghijklmnopqrstuvwxyzABCEFGHJKLMNOPQRSTUVWXYZ', }); return (name) =&gt; { if (!uniqIds[name]) { uniqIds[name] = generateNextId(); //    , //      // (   debounce  ) saveGeneratorData(generatorIdentifier, uniqIds); } return uniqIds[name]; }; }; //     , //          const localNameIdGenerator = createUniqueIdGenerator('localName'); const componentNameIdGenerator = createUniqueIdGenerator('componentName'); module.exports = (localName, resourcePath) =&gt; { const componentName = resourcePath .split('/') .slice(-2, -1)[0]; const localId = localNameIdGenerator(localName); const componentId = componentNameIdGenerator(componentName); return `${componentId}_${localId}`; };</span></span></code> </pre><br>  L'implémentation du fichier generatorHelpers.js n'a pas vraiment d'importance, mais si vous êtes intéressé, voici le mien: <br><br><div class="spoiler">  <b class="spoiler_title">generatorHelpers.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> fs = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'fs'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> path = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'path'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> getGeneratorDataPath = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">generatorIdentifier</span></span></span><span class="hljs-function"> =&gt;</span></span> ( path.resolve(__dirname, <span class="hljs-string"><span class="hljs-string">`meta/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${generatorIdentifier}</span></span></span><span class="hljs-string">.json`</span></span>) ); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> getGeneratorData = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">generatorIdentifier</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> path = getGeneratorDataPath(generatorIdentifier); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fs.existsSync(path)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(path); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> {}; }; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> saveGeneratorData = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">generatorIdentifier, uniqIds</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> path = getGeneratorDataPath(generatorIdentifier); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> data = <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(uniqIds, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>); fs.writeFileSync(path, data, <span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>); }; <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { getGeneratorData, saveGeneratorData, };</code> </pre><br></div></div><br>  Les caches sont devenus les mêmes entre les builds, tout va bien.  Un autre point en notre faveur! <br><br><h2>  Supprimer la variable d'exécution </h2><br>  Puisque j'ai décidé de prendre une meilleure décision, il serait bien de supprimer cette variable avec le mappage des classes, car nous avons toutes les données nécessaires au stade de la compilation. <br><br>  Babel-plugin-react-css-modules nous aidera avec cela.  Au moment de la compilation, il: <br><br><ol><li>  Trouvera l'importation CSS dans le fichier. </li><li>  Il ouvrira ce fichier CSS et changera les noms des classes CSS comme le fait css-loader. </li><li>  Il trouvera les nœuds JSX avec l'attribut styleName. </li><li>  Remplace les noms de classe locaux de styleName par des noms globaux. </li></ol><br>  Configurez ce plugin.  Jouons avec la configuration babel: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/* .babelrc.js */</span></span> <span class="hljs-comment"><span class="hljs-comment">//   ,     const getScopedName = require('path/to/getScopedName'); const isDev = process.env.NODE_ENV === 'development'; module.exports = { /* ... */ plugins: [ /* ... */ ['react-css-modules', { generateScopedName: isDev ? '[path]_[name]_[local]' : getScopedName, }], ], };</span></span></code> </pre><br>  Mettez à jour nos fichiers JSX: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/* CoolComponent/index.js */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> React <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">'./index.css'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> ({ text }) =&gt; ( <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">styleName</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"content-wrapper"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">styleName</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"title"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> Weird title </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">styleName</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"text"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> {text} </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> );</code> </pre><br>  Et donc nous avons cessé d'utiliser la variable avec l'affichage des noms de style, maintenant nous ne l'avons pas! <br><br>  ... Ou est-il? <br><br>  Nous collecterons le projet et étudierons les sources: <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/* main.24436cbf94546057cae3.js */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* … */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e, t, n</span></span></span><span class="hljs-function">) </span></span>{ e.exports = { <span class="hljs-string"><span class="hljs-string">"content-wrapper"</span></span>: <span class="hljs-string"><span class="hljs-string">"e_f"</span></span>, <span class="hljs-attr"><span class="hljs-attr">title</span></span>: <span class="hljs-string"><span class="hljs-string">"e_g"</span></span>, <span class="hljs-attr"><span class="hljs-attr">text</span></span>: <span class="hljs-string"><span class="hljs-string">"e_h"</span></span> } } <span class="hljs-comment"><span class="hljs-comment">/* … */</span></span></code> </pre><br>  Il semble que la variable soit toujours là, bien qu'elle ne soit utilisée nulle part.  Pourquoi est-ce arrivé? <br><br>  Le webpack prend en charge plusieurs types de structure modulaire, les plus populaires sont ES2015 (import) et commonJS (requis). <br><br>  Les modules ES2015, contrairement à commonJS, prennent en charge le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tremblement d'arbre en</a> raison de leur structure statique. <br><br>  Mais le chargeur css et le chargeur mini-css-extract-plugin utilisent la syntaxe commonJS pour exporter les noms de classe, de sorte que les données exportées ne sont pas supprimées de la génération. <br><br>  Nous allons écrire notre petit chargeur et supprimer les données supplémentaires en mode production: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/* webpack.config.js */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> path = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'path'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> resolve = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">relativePath</span></span></span><span class="hljs-function"> =&gt;</span></span> path.resolve(__dirname, relativePath); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> isDev = process.env.NODE_ENV === <span class="hljs-string"><span class="hljs-string">'development'</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>: { <span class="hljs-attr"><span class="hljs-attr">rules</span></span>: [ <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> { <span class="hljs-attr"><span class="hljs-attr">test</span></span>: <span class="hljs-regexp"><span class="hljs-regexp">/\.css$/</span></span>, <span class="hljs-attr"><span class="hljs-attr">use</span></span>: [ ...(isDev ? [<span class="hljs-string"><span class="hljs-string">'style-loader'</span></span>] : [ resolve(<span class="hljs-string"><span class="hljs-string">'path/to/webpack-loaders/nullLoader'</span></span>), MiniCssExtractPlugin.loader, ]), { <span class="hljs-attr"><span class="hljs-attr">loader</span></span>: <span class="hljs-string"><span class="hljs-string">'css-loader'</span></span>, <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> }, ], }, ], }, };</code> </pre><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/* nullLoader.js */</span></span> <span class="hljs-comment"><span class="hljs-comment">//     ,   module.exports = () =&gt; '// empty';</span></span></code> </pre><br>  Vérifiez à nouveau le fichier assemblé: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/* main.35f6b05f0496bff2048a.js */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* … */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e, t, n</span></span></span><span class="hljs-function">) </span></span>{} <span class="hljs-comment"><span class="hljs-comment">/* … */</span></span></code> </pre><br>  Vous pouvez expirer avec soulagement, tout a fonctionné. <br><br><div class="spoiler">  <b class="spoiler_title">Impossible de supprimer la variable de mappage de classe</b> <div class="spoiler_text">  Au début, il m'a paru plus évident d'utiliser le package <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">null-loader</a> déjà existant. <br><br>  Mais tout s'est avéré pas si simple: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/*  null-loader */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'// empty (null-loader)'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pitch</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'// empty (null-loader)'</span></span>; }</code> </pre><br>  Comme vous pouvez le voir, en plus de la fonction principale, null-loader exporte également la fonction pitch.  J'ai appris <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">de la documentation</a> que les méthodes de pitch sont appelées plus tôt que les autres et peuvent annuler tous les chargeurs suivants s'ils retournent des données de cette méthode. <br><br>  Avec un chargeur nul, la séquence de production CSS commence à ressembler à ceci: <br><br><ul><li>  La méthode pitch de null-loader est appelée, ce qui renvoie une chaîne vide. </li><li>  En raison de la valeur de retour de la méthode de pas, tous les chargeurs suivants ne sont pas appelés. </li></ul><br>  Je ne voyais plus les solutions et j'ai décidé de fabriquer mon propre chargeur. <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Utiliser avec Vue.js</b> <div class="spoiler_text">  Si vous n'avez qu'un seul Vue.js à portée de main, mais que vous voulez vraiment compresser les noms de classe et supprimer la variable d'exécution, alors j'ai un bon hack! <br><br>  Tout ce dont nous avons besoin, ce sont deux plugins: babel-plugin-transform-vue-jsx et babel-plugin-react-css-modules.  Nous aurons besoin du premier pour écrire JSX dans les fonctions de rendu, et le second, comme vous le savez déjà, pour générer des noms au stade de la compilation. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/* .babelrc.js */</span></span> <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { <span class="hljs-attr"><span class="hljs-attr">plugins</span></span>: [ <span class="hljs-string"><span class="hljs-string">'transform-vue-jsx'</span></span>, [<span class="hljs-string"><span class="hljs-string">'react-css-modules'</span></span>, { <span class="hljs-comment"><span class="hljs-comment">//    attributeNames: { styleName: 'class', }, }], ], };</span></span></code> </pre><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">'./index.css'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> TextComponent = { render(h) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>( <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">styleName</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"text"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> Lorem ipsum dolor. </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> ); }, mounted() { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'I\'m mounted!'</span></span>); }, }; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> TextComponent;</code> </pre><br></div></div><br><br><h2>  Compressez le CSS au maximum </h2><br>  Imaginez que le CSS suivant apparaisse dans le projet: <br><pre> <code class="css hljs"><span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.component1__title</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">color</span></span>: red; } <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.component2__title</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">color</span></span>: green; } <span class="hljs-selector-class"><span class="hljs-selector-class">.component2__title_red</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">color</span></span>: red; }</code> </pre><br>  Vous êtes un minifieur CSS.  Comment le serriez-vous? <br><br>  Je pense que votre réponse est quelque chose comme ceci: <br><br><pre> <code class="css hljs"><span class="hljs-selector-class"><span class="hljs-selector-class">.component2__title</span></span>{<span class="hljs-attribute"><span class="hljs-attribute">color</span></span>:green} <span class="hljs-selector-class"><span class="hljs-selector-class">.component2__title_red</span></span>, <span class="hljs-selector-class"><span class="hljs-selector-class">.component1__title</span></span>{<span class="hljs-attribute"><span class="hljs-attribute">color</span></span>:red}</code> </pre><br>  Nous allons maintenant vérifier ce que feront les minificateurs habituels.  Mettez notre morceau de code dans un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">minifieur en ligne</a> : <br><br><pre> <code class="css hljs"><span class="hljs-selector-class"><span class="hljs-selector-class">.component1__title</span></span>{<span class="hljs-attribute"><span class="hljs-attribute">color</span></span>:red} <span class="hljs-selector-class"><span class="hljs-selector-class">.component2__title</span></span>{<span class="hljs-attribute"><span class="hljs-attribute">color</span></span>:green} <span class="hljs-selector-class"><span class="hljs-selector-class">.component2__title_red</span></span>{<span class="hljs-attribute"><span class="hljs-attribute">color</span></span>:red}</code> </pre><br>  Pourquoi ne pouvait-il pas? <br><br>  Le minifieur a peur qu'en raison d'un changement dans l'ordre de la déclaration des styles, quelque chose se casse.  Par exemple, si le projet a ce code: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"component1__title component2__title"</span></span></span><span class="hljs-tag">&gt;</span></span>Some weird title<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  À cause de vous, le titre deviendra rouge et le minificateur en ligne laissera l'ordre de déclaration de style correct et deviendra vert.  Bien sûr, vous savez qu'il n'y aura jamais d'intersection entre component1__title et component2__title, car ils sont dans des composants différents.  Mais comment dire cela au minificateur? <br><br>  Après avoir recherché la documentation, j'ai trouvé la possibilité de spécifier le contexte pour utiliser les classes uniquement avec <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">csso</a> .  Et il n'a pas de solution pratique pour le webpack prêt à l'emploi.  Pour aller plus loin, nous avons besoin d'un petit vélo. <br><br>  Vous devez combiner les noms de classe de chaque composant dans des tableaux séparés et les insérer dans csso.  Un peu plus tôt, nous avons généré des noms de classe minifiés selon ce modèle: '[componentId] _ [classNameId]'.  Ainsi, les noms de classe peuvent être combinés simplement par la première partie du nom! <br><br>  Attachez vos ceintures et écrivez votre plugin: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/* webpack.config.js */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> cssoLoader = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'path/to/cssoLoader'</span></span>); <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> plugins: [ <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> cssoLoader(), ], };</code> </pre><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/* cssoLoader.js */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> csso = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'csso'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> RawSource = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'webpack-sources/lib/RawSource'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> getScopes = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./helpers/getScopes'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> isCssFilename = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">filename</span></span></span><span class="hljs-function"> =&gt;</span></span> /\.css$/.test(filename); <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cssoPlugin</span></span></span><span class="hljs-class"> </span></span>{ apply(compiler) { compiler.hooks.compilation.tap(<span class="hljs-string"><span class="hljs-string">'csso-plugin'</span></span>, (compilation) =&gt; { compilation.hooks.optimizeChunkAssets.tapAsync(<span class="hljs-string"><span class="hljs-string">'csso-plugin'</span></span>, (chunks, callback) =&gt; { chunks.forEach(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">chunk</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-comment"><span class="hljs-comment">//    CSS  chunk.files.forEach((filename) =&gt; { if (!isCssFilename(filename)) { return; } const asset = compilation.assets[filename]; const source = asset.source(); //  ast  CSS  const ast = csso.syntax.parse(source); //        const scopes = getScopes(ast); //  ast const { ast: compressedAst } = csso.compress(ast, { usage: { scopes, }, }); const minifiedCss = csso.syntax.generate(compressedAst); compilation.assets[filename] = new RawSource(minifiedCss); }); }); callback(); }); }); } } /*    sourceMap,     ,       https://github.com/zoobestik/csso-webpack-plugin" */</span></span></code> </pre><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/* getScopes.js */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   ,          ,     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> csso = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'csso'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> getComponentId = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">className</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> tokens = className.split(<span class="hljs-string"><span class="hljs-string">'_'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//   ,   //   [componentId]_[classNameId], //     if (tokens.length !== 2) { return 'default'; } return tokens[0]; }; module.exports = (ast) =&gt; { const scopes = {}; //      csso.syntax.walk(ast, (node) =&gt; { if (node.type !== 'ClassSelector') { return; } const componentId = getComponentId(node.name); if (!scopes[componentId]) { scopes[componentId] = []; } if (!scopes[componentId].includes(node.name)) { scopes[componentId].push(node.name); } }); return Object.values(scopes); };</span></span></code> </pre><br>  Et ce n'était pas si difficile, non?  Habituellement, cette minification comprime en outre CSS de 3 à 6%. <br><br><h2>  Cela en valait-il la peine? </h2><br>  Bien sûr. <br><br>  Dans mes applications, un rechargement rapide à chaud est finalement apparu, et CSS a commencé à se diviser en morceaux et à peser en moyenne 40% de moins. <br><br>  Cela accélérera le chargement du site et réduira le temps d'analyse des styles, ce qui affectera non seulement les utilisateurs, mais également les PDG. <br><br>  L'article a considérablement augmenté, mais je suis heureux que quelqu'un ait pu le faire défiler jusqu'à la fin.  Merci pour votre temps! <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/cd/wm/b8/cdwmb8ygmq0mysnve4zjina7-iw.png"></div><br><h4>  Matériaux utilisés </h4><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Réduire la taille du bundle CSS de 70% en coupant les noms de classe et en utilisant l'isolement de portée</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr428800/">https://habr.com/ru/post/fr428800/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr428790/index.html">Nous écrivons un chat bot pour VKontakte en python en utilisant longpoll. Deuxième partie Boucles doubles, exceptions et autres hérésies</a></li>
<li><a href="../fr428792/index.html">La nouvelle puce Apple T2 rend difficile l'écoute via le microphone intégré de l'ordinateur portable</a></li>
<li><a href="../fr428794/index.html">Présentation des méthodes de base d'optimisation mathématique pour les problèmes de contraintes</a></li>
<li><a href="../fr428796/index.html">Manipulation en temps réel des maillages sur Unity</a></li>
<li><a href="../fr428798/index.html">Comment survivre à un développeur indépendant. 2e partie</a></li>
<li><a href="../fr428806/index.html">Analyse des chèques de consommation: ce qu'ils achètent sur Amazon</a></li>
<li><a href="../fr428808/index.html">Peu de commodité dans la vie étudiante</a></li>
<li><a href="../fr428810/index.html">18 documents sur la technologie numérique dans l'audio</a></li>
<li><a href="../fr428812/index.html">TypeScript: désérialisation de JSON en classes avec validation de type sur les propriétés</a></li>
<li><a href="../fr428814/index.html">Appariement de produits à l'aide d'Elasticsearch pour le service de surveillance des prix des concurrents</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>