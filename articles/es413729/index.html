<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçä üëÄ ‚õ©Ô∏è C√≥mo y por qu√© escribimos nuestro ECS üçä üñ•Ô∏è üßìüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En un art√≠culo anterior, describ√≠ las tecnolog√≠as y los enfoques que utilizamos al desarrollar un nuevo tirador m√≥vil de ritmo r√°pido. Porque fue una ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C√≥mo y por qu√© escribimos nuestro ECS</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pixonic/blog/413729/">  En un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">art√≠culo anterior,</a> describ√≠ las tecnolog√≠as y los enfoques que utilizamos al desarrollar un nuevo tirador m√≥vil de ritmo r√°pido.  Porque  fue una revisi√≥n e incluso un art√≠culo superficial: hoy profundizar√© y explicar√© en detalle por qu√© decidimos escribir nuestro propio marco ECS y no utilizamos los existentes.  Habr√° ejemplos de c√≥digo y una peque√±a bonificaci√≥n al final. <br><img src="https://habrastorage.org/webt/qn/lg/zw/qnlgzwthwpjkkzzeeilv257iiga.png"><br><a name="habracut"></a><br><h3>  ¬øQu√© es ECS como ejemplo? </h3><br>  Ya describ√≠ brevemente qu√© es Entity Component System, y hay art√≠culos sobre Habr√© sobre ECS (b√°sicamente, sin embargo, traducciones de art√≠culos; vea mi revisi√≥n de los m√°s interesantes al final del art√≠culo, como un bono).  Y hoy les dir√© c√≥mo usamos ECS, utilizando nuestro ejemplo de c√≥digo. <br><br>  El diagrama anterior describe la esencia del <i>reproductor</i> , sus componentes y sus datos, y los sistemas que funcionan con el reproductor y sus componentes.  El objeto clave en el diagrama es el jugador: <br><br><ul><li>  puede moverse en el espacio: componentes de <i>transformaci√≥n</i> y <i>movimiento</i> , <i>MoveSystem</i> ; </li><li>  tiene algo de salud y puede morir: componente <i>Salud</i> , <i>Da√±o</i> , <i>DamageSystem</i> ; </li><li>  despu√©s de que aparece la muerte en el punto de reaparici√≥n: el componente <i>Transformar</i> para la posici√≥n, el <i>RespawnSystem</i> ; </li><li>  puede ser invulnerable - componente <i>invencible</i> . </li></ul><br>  Describimos esto con un c√≥digo.  Primero, obtengamos interfaces para componentes y sistemas.  Los componentes pueden tener m√©todos auxiliares comunes, el sistema solo tiene un m√©todo de <i>ejecuci√≥n</i> , que recibe el estado del mundo en la entrada para el procesamiento: <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IComponent</span></span> { <span class="hljs-comment"><span class="hljs-comment">// &lt; &gt; } public interface ISystem { void Execute(GameState gs); }</span></span></code> </pre> <br>  Para los componentes, creamos clases de c√≥digo auxiliar que utiliza nuestro generador de c√≥digo para convertirlas en c√≥digo de componente realmente utilizado.  Consigamos algunos espacios en blanco para <i>Salud</i> , <i>Da√±o</i> e <i>Invencible</i> (para el resto de los componentes ser√° similar). <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Component</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Health</span></span> { [Max(<span class="hljs-number"><span class="hljs-number">1000</span></span>)] <span class="hljs-comment"><span class="hljs-comment">//  -  1000 public int Hp; // -   public Health(int hp) {} } [Component] public class Damage { [DontSend] //      ,      public uint Amount; // -  public Entity Victim; //    public Entity Source; //    public Damage(uint amount, Entity victim, Entity source) {} } [Component] public class Invincible //   ,  ,    { }</span></span></code> </pre> <br>  Los componentes determinan el estado del mundo, por lo tanto, contienen solo datos, sin m√©todos.  Al mismo tiempo, no hay datos en <i>Invincible</i> , se usa en l√≥gica como un signo de invulnerabilidad: si la esencia del jugador tiene este componente, el jugador ahora es invulnerable. <br><br>  El generador utiliza el atributo <i>Componente</i> para buscar las clases en blanco para los componentes.  Los <i>atributos</i> <i>Max</i> y <i>DontSend</i> son necesarios como pistas al serializar y reducir el tama√±o del estado del mundo transmitido a trav√©s de la red o guardado en el disco.  En este caso, el servidor no serializar√° el campo <i>Cantidad</i> y lo enviar√° a trav√©s de la red (dado que los clientes no usan este par√°metro, solo es necesario en el servidor).  Y el campo <i>Hp</i> puede estar bien empaquetado en varios bits, dado el valor m√°ximo de salud. <br><br>  Tambi√©n tenemos una clase <i>prefabricada de entidad</i> , donde agregamos informaci√≥n sobre todos los componentes posibles de cualquier entidad, y el generador ya crear√° una clase real a partir de ella: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Entity</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Health Health; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Damage Damage; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Invincible Invincible; <span class="hljs-comment"><span class="hljs-comment">// ... &lt; &gt; }</span></span></code> </pre> <br>  Despu√©s de eso, nuestro generador crear√° el c√≥digo de las clases de componentes <i>Salud</i> , <i>Da√±o</i> e <i>Invencible</i> , que ya se utilizar√°n en la l√≥gica del juego: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Health</span></span> : <span class="hljs-title"><span class="hljs-title">IComponent</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Hp; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Reset</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Hp = <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>); } <span class="hljs-comment"><span class="hljs-comment">// ... &lt;  &gt; } public sealed class Damage : IComponent { public int Amount; public Entity Victim; public Entity Source; public void Reset() { Amount = default(int); Victim = default(Entity); Source = default(Entity); } // ... &lt;  &gt; } public sealed class Invincible : IComponent { }</span></span></code> </pre> <br>  Como puede ver, los datos permanecieron en las clases y se agregaron m√©todos, por ejemplo, <i>Restablecer</i> .  Es necesario para optimizar y reutilizar componentes en grupos.  Otros m√©todos auxiliares no contienen l√≥gica de negocios; no los dar√© por brevedad. <br><br>  Tambi√©n se generar√° una clase para el estado del mundo, que contiene una lista de todos los componentes y entidades: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">GameState</span></span> { <span class="hljs-comment"><span class="hljs-comment">//  public Table&lt;Movement&gt; Movements; public Table&lt;Health&gt; Healths; public Table&lt;Damage&gt; Damages; public Table&lt;Transform&gt; Transforms; public Table&lt;Invincible&gt; Invincibles; //   public Entity CreateEntity() { /* &lt;&gt; */ } public void Copy(GameState gs2) { /* &lt;&gt; */ } public Entity this[uint id] { /* &lt;&gt; */ } // ... &lt;   &gt; }</span></span></code> </pre> <br>  Y finalmente, el c√≥digo generado para <i>Entity</i> : <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Entity</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> Id; <span class="hljs-comment"><span class="hljs-comment">//   public GameState GameState; //     //     : public Health Health { get { return GameState.Healths[Id]; } } public Damage Damage { get { return GameState.Damages[Id]; } } public Invincible Invincible { get { return GameState.Invincibles[Id]; } } // ‚Ä¶     public Damage AddDamage() { return GameState.Damages.Insert(Id); } public Damage AddDamage(int total, Entity victim, Entity source) { var c = GameState.Damages.Insert(Id); c.Amount = total; c.Victim = victim; c.Source = source; return c; } public void DelDamage() { GameState.Damages.Delete(Id); } // ‚Ä¶ &lt;     &gt; }</span></span></code> </pre> <br>  La clase de <i>entidad</i> es esencialmente solo un identificador de componente.  La referencia a los objetos del mundo <i>GameState</i> se usa solo en m√©todos auxiliares para la conveniencia de escribir c√≥digo de l√≥gica de negocios.  Conociendo el identificador de un componente, podemos usarlo para serializar relaciones entre entidades, implementar enlaces en componentes a otras entidades.  Por ejemplo, el componente <i>Da√±o</i> contiene una referencia a la entidad <i>V√≠ctima</i> para determinar qui√©n result√≥ da√±ado. <br><br>  Esto termina el c√≥digo generado.  En general, necesitamos un generador para no escribir m√©todos auxiliares cada vez.  Solo describimos los componentes como datos, luego el generador hace todo el trabajo.  Ejemplos de m√©todos auxiliares: <br><br><ul><li>  crear / eliminar entidades; </li><li>  agregue / elimine / copie un componente, acceda si existe; </li><li>  compara dos estados del mundo; </li><li>  serializar el estado del mundo; </li><li>  compresi√≥n delta; </li><li>  c√≥digo de una p√°gina web o ventana de Unity para mostrar el estado del mundo, entidades, componentes (ver detalles a continuaci√≥n); </li><li>  y otros </li></ul><br>  Pasemos al c√≥digo del sistema.  Definen la l√≥gica empresarial.  Por ejemplo, escribamos el c√≥digo de un sistema que calcula el da√±o a un jugador: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DamageSystem</span></span> : <span class="hljs-title"><span class="hljs-title">ISystem</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> ISystem.Execute(GameState gs) { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> damage <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> gs.Damages) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> invincible = damage.Victim.Invincible; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (invincible != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> health = damage.Victim.Health; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (health == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; health.Hp -= damage.Amount; } } }</code> </pre> <br>  El sistema revisa todos los componentes de <i>Da√±o</i> en el mundo y busca si hay un componente <i>Invencible</i> en un jugador potencialmente da√±ado ( <i>V√≠ctima</i> ).  Si es as√≠, el jugador es invulnerable, el da√±o no se acumula.  Luego, obtenemos el componente de <i>Salud de</i> la v√≠ctima y reducimos la salud del jugador por el tama√±o del da√±o. <br><br>  Considere las caracter√≠sticas clave de los sistemas: <br><br><ol><li>  Un sistema suele ser una clase sin estado, no contiene ning√∫n dato interno, no intenta guardarlo en alg√∫n lugar, excepto los datos sobre el mundo transmitidos desde el exterior. </li><li>  Los sistemas generalmente pasan por todos los componentes de un determinado tipo y trabajan con ellos.  Por lo general, se les llama por el tipo de componente ( <i>Damage</i> ‚Üí <i>DamageSystem</i> ) o por la acci√≥n que realizan ( <i>RespawnSystem</i> ). </li><li>  El sistema implementa una funcionalidad m√≠nima.  Por ejemplo, si vamos m√°s all√°, despu√©s de <i>ejecutar</i> <i>DamageSystem</i> <i>,</i> otro <i>RemoveDamageSystem</i> eliminar√° todos los componentes de <i>Damage</i> .  En el siguiente tic, otro <i>ApplyDamageSystem</i> basado en los disparos del jugador puede colgar nuevamente el componente <i>Da√±o</i> con un nuevo da√±o.  Y luego, <i>PlayerDeathSystem</i> verificar√° la salud del jugador ( <i>Health.Hp</i> ) y, si es menor o igual a 0, destruir√° todos los componentes del jugador excepto <i>Transformar</i> y agregar√° el componente de bandera <i>Muerta</i> . </li></ol><br>  Total, obtenemos las siguientes clases y las relaciones entre ellas: <br><img src="https://habrastorage.org/webt/g7/59/mq/g759mq06qfqqjymhz8ympcwejro.png"><br><br><h3>  Algunos hechos sobre ECS </h3><br>  ECS tiene sus ventajas y desventajas como un enfoque para el desarrollo y una forma de representar el mundo del juego, por lo que todos deciden por s√≠ mismos si lo usan o no.  Comencemos con los profesionales: <br><br><ul><li>  <b>Composici√≥n versus herencia m√∫ltiple.</b>  En el caso de herencia m√∫ltiple, se puede heredar un mont√≥n de funcionalidades innecesarias.  En el caso de ECS, la funcionalidad aparece / desaparece cuando se agrega / elimina un componente. </li><li>  <b>Separaci√≥n de l√≥gica y datos.</b>  La capacidad de cambiar la l√≥gica (cambiar sistemas, eliminar / agregar componentes) sin romper datos.  Es decir  puede deshabilitar el grupo de sistemas responsables de una determinada funcionalidad en cualquier momento, todo lo dem√°s seguir√° funcionando y esto no afectar√° los datos. </li><li>  <b>El ciclo del juego se simplifica.</b>  Aparece una <i>actualizaci√≥n</i> y todo el ciclo se divide en sistemas.  Los datos son procesados ‚Äã‚Äãpor el "flujo" en el sistema, independientemente del motor (no hay millones de llamadas de <i>actualizaci√≥n</i> , como en Unity). </li><li>  <b>Una entidad no sabe qu√© clases le afectan</b> (y no deber√≠a saberlo). </li><li>  <b>Uso eficiente de la memoria</b> .  Depende de la implementaci√≥n de ECS.  Puede reutilizar objetos y componentes de entidad creados mediante agrupaciones;  puede usar tipos de valores para datos y almacenarlos en la memoria uno al lado del otro ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">localidad de datos</a> ). </li><li>  <b>Es m√°s f√°cil probar</b> cuando los datos est√°n separados de la l√≥gica.  Especialmente cuando considera que la l√≥gica es un sistema peque√±o con varias l√≠neas de c√≥digo. </li><li>  <b>Ver y editar el estado del mundo en tiempo real</b> .  Porque  el estado del mundo son solo datos, escribimos una herramienta que muestra en la p√°gina web todo el estado del mundo en una coincidencia en el servidor (as√≠ como la escena de la coincidencia en 3D).  Cualquier componente de cualquier entidad se puede ver, modificar, eliminar.  Lo mismo se puede hacer en el editor de Unity para el cliente. </li></ul><br><img src="https://habrastorage.org/webt/zd/rz/a-/zdrza-80yltaqp8g3dqwd59zgqw.jpeg"><br><br>  Y ahora los contras: <br><br><ul><li>  <b>Debe aprender a pensar, dise√±ar y escribir c√≥digo de manera diferente</b> .  Piense en t√©rminos de entidades, componentes y sistemas.  Muchos patrones de dise√±o en ECS se implementan de una manera completamente diferente (vea un ejemplo de implementaci√≥n del patr√≥n de <i>Estado</i> en uno de los art√≠culos de revisi√≥n al final). </li><li>  <b>M√°s c√≥digo</b>  Debatable  Por un lado, debido al hecho de que dividimos la l√≥gica en sistemas peque√±os, en lugar de describir toda la funcionalidad en una clase, hay m√°s clases, pero no hay mucho m√°s c√≥digo. </li><li>  <b>El orden en que se llaman los sistemas afecta el funcionamiento de todo el juego</b> .  Por lo general, los sistemas dependen unos de otros, el orden de su ejecuci√≥n se establece en la lista y se ejecutan en este orden.  Por ejemplo, primero <i>DamageSystem</i> considera el da√±o, luego <i>RemoveDamageSystem</i> elimina el componente <i>Damage</i> .  Si accidentalmente cambia el orden, entonces todo funcionar√° de manera diferente.  En general, esto tambi√©n es cierto para el caso habitual de OOP, si cambia el orden de las llamadas a m√©todos, pero en ECS es m√°s f√°cil cometer un error.  Por ejemplo, si parte de la l√≥gica se ejecuta en el cliente para la predicci√≥n, el orden debe ser el mismo que en el servidor. </li><li>  <b>Necesitamos conectar de alguna manera los datos y eventos de la l√≥gica con la vista</b> .  En el caso de Unity, tenemos MVP: <br><br>  - Modelo - <i>GameState</i> de ECS; <br>  - Ver: con nosotros, estas son clases de <i>MonoBehavior</i> Unity exclusivamente est√°ndar ( <i>Renderer</i> , <i>Texto</i> , etc.) y prefabricados; <br>  - Presenter usa <i>GameState</i> para determinar los eventos de aparici√≥n / desaparici√≥n de entidades, componentes, etc., crea objetos Unity a partir de prefabricados y los cambia de acuerdo con los cambios en el estado del mundo. </li></ul><br>  <i>Sab√≠as que:</i> <br><br><ul><li>  <b>ECS no se trata solo de la localidad de datos</b> .  Para m√≠, esto es m√°s un paradigma de programaci√≥n, un patr√≥n, otra forma de dise√±ar el mundo del juego, ll√°malo como quieras.  La localidad de datos es solo una optimizaci√≥n. </li><li>  <b>¬°La unidad no tiene ECS!</b>  A menudo le preguntas a los candidatos en una entrevista de equipo: ¬øqu√© sabes sobre ECS?  Si no lo has escuchado, d√≠selo, y ellos respondieron: "Ah, entonces es como en Unity, ¬°entonces lo s√©!".  Pero no, no es como en el motor de Unity.  All√≠, los datos y la l√≥gica se combinan en el componente <i>MonoBehaviour</i> , y <i>GameObject</i> (si se compara con una entidad en ECS) tiene datos adicionales: un nombre, un lugar en la jerarqu√≠a, etc. Los desarrolladores de Unity est√°n <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">trabajando</a> actualmente en una implementaci√≥n normal de ECS en el motor, y hasta ahora parece que ser√° bueno.  Contrataron especialistas en este campo, espero que resulte genial. </li></ul><br><h3>  Nuestros criterios de selecci√≥n para el marco ECS </h3><br>  Cuando decidimos hacer un juego en ECS, comenzamos a buscar una soluci√≥n preparada y anotamos los requisitos para ella en funci√≥n de la experiencia de uno de los desarrolladores.  Y pintaron c√≥mo las soluciones existentes satisfacen nuestros requisitos.  Fue hace un a√±o, por el momento, algo podr√≠a haber cambiado.  Como soluciones, consideramos: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Entitas</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Artemis C #</a> </li><li>  <a href="">Ash.net</a> </li><li>  ECS es nuestra propia soluci√≥n en el momento en que la concebimos.  Es decir  nuestras suposiciones y deseos, lo que podemos hacer nosotros mismos. </li></ul><br>  Compilamos una tabla para comparar, donde tambi√©n inclu√≠ nuestra soluci√≥n actual (designada como <i>ECS (ahora)</i> ): <br><br><img src="https://habrastorage.org/webt/0p/eh/hk/0pehhk27fihkyp-qmuhlpu0m5m4.png"><br>  <i>Color rojo: la soluci√≥n no es compatible con nuestros requisitos, naranja: parcialmente compatible, verde: totalmente compatible.</i> <br><br>  Para nosotros, la analog√≠a de las operaciones para acceder a los componentes y buscar entidades en ECS fueron las operaciones en una base de datos SQL.  Por lo tanto, utilizamos conceptos como tabla (tabla), uni√≥n (operaci√≥n de uni√≥n), √≠ndices (√≠ndices), etc. <br><br>  Describiremos nuestros requisitos y hasta qu√© punto las bibliotecas y marcos de terceros correspondieron a ellos: <br><br><ul><li>  <b>conjuntos de datos separados (historial, actual, visual, est√°tico)</b> : la capacidad de obtener y almacenar por separado estados mundiales (por ejemplo, el estado actual para el procesamiento, para la representaci√≥n, el historial de estado, etc.).  <i>Todas las decisiones consideradas respaldaron este requisito</i> . </li><li>  <b>ID de entidad como entero</b> : soporte para representar una entidad por su n√∫mero de identificador.  Es necesario para la transmisi√≥n a trav√©s de la red y la capacidad de conectar entidades en la historia de los estados.  <i>Ninguna de las soluciones consideradas compatibles.</i>  <i>Por ejemplo, en Entitas, una entidad est√° representada por un objeto completo (como un GameObject en Unity).</i> </li><li>  <b>unirse por ID O (N + M)</b> : soporte para muestreo relativamente r√°pido de dos tipos de componentes.  Por ejemplo, cuando necesita obtener todas las entidades con componentes del tipo Da√±o (por ejemplo, sus N piezas) y Salud (piezas M) para calcular y causar da√±o.  <i>Hubo pleno apoyo en Artemisa;</i>  <i>en Entitas y Ash.NET es m√°s r√°pido que O (N¬≤), pero m√°s lento que O (N + M).</i>  <i>No recuerdo la evaluaci√≥n ahora.</i> </li><li>  <b>unirse por la referencia de identificaci√≥n O (N + M)</b> : lo mismo que arriba solo cuando un componente de una entidad tiene un enlace a otro, y este √∫ltimo necesita obtener otro componente (en nuestro ejemplo, el componente <i>Da√±o</i> en la entidad auxiliar se refiere a la entidad del jugador <i>V√≠ctima</i> y desde all√≠ necesitas obtener el componente de <i>Salud</i> ).  <i>No es compatible con ninguna de las soluciones consideradas.</i> </li><li>  <b>sin asignaci√≥n de consulta</b> : sin asignaciones de memoria adicionales al consultar componentes y entidades del estado del mundo.  En Entitas, fue en ciertos casos, pero insignificante para nosotros. </li><li>  <b>tablas de grupo</b> : almacenamiento de datos mundiales en grupos, la capacidad de reutilizar memoria, asignaci√≥n solo cuando el grupo est√° vac√≠o.  <i>Hubo "algo" de soporte en Entitas y Artemis, una ausencia completa en Ash.NET.</i> </li><li>  <b>comparar por ID (add, del)</b> : soporte integrado para eventos de creaci√≥n / destrucci√≥n de entidades y componentes por ID.  Es necesario que el nivel de visualizaci√≥n (Ver) muestre / oculte objetos, reproduzca animaciones, efectos.  <i>No es compatible con ninguna de las soluciones consideradas.</i> </li><li>  <b>Œî serializaci√≥n (cuantizaci√≥n, omisi√≥n)</b> : compresi√≥n delta incorporada para serializar el estado del mundo (por ejemplo, para reducir el tama√±o de los datos enviados a trav√©s de la red).  <i>Out of the Box no fue compatible con ninguna de las soluciones.</i> </li><li>  <b>La interpolaci√≥n</b> es un mecanismo de interpolaci√≥n incorporado entre los estados mundiales.  <i>Ninguna de las soluciones soportadas.</i> </li><li>  <b>reutilizar tipo de componente</b> : la capacidad de usar una vez escrito el tipo de componente en diferentes tipos de entidades.  <i>Solo se admiten Entitas</i> . </li><li>  <b>orden expl√≠cito de sistemas</b> : la capacidad de establecer sus propios sistemas de orden de llamadas.  <i>Todas las decisiones respaldadas.</i> </li><li>  <b>editor (unity / server)</b> : soporte para visualizar y editar entidades en tiempo real, tanto para el cliente como para el servidor.  <i>Entitas solo admite la capacidad de ver y editar entidades y componentes en el editor de Unity.</i> </li><li>  <b>copia / reemplazo r√°pido</b> : la capacidad de copiar / reemplazar datos de manera econ√≥mica.  <i>Ninguna de las soluciones soportadas.</i> </li><li>  <b>componente como tipo de valor (estructura)</b> : componentes como tipos de valor.  En principio, quer√≠a lograr un buen rendimiento basado en esto.  <i>No se admit√≠a un solo sistema; las clases de componentes estaban en todas partes.</i> </li></ul><br>  Requisitos opcionales ( <i>ninguna de las soluciones en ese momento los admit√≠a</i> ): <br><br><ul><li>  <b>√≠ndices</b> : datos de indexaci√≥n como en una base de datos. </li><li>  <b>claves compuestas: claves</b> complejas para un acceso r√°pido a los datos (como en la base de datos). </li><li>  <b>comprobaci√≥n de integridad</b> : la capacidad de verificar la integridad de los datos en un estado del mundo.  √ötil para la depuraci√≥n. </li><li>  <b>La compresi√≥n de contenido</b> es la mejor compresi√≥n de datos basada en el conocimiento de la naturaleza de los datos.  Por ejemplo, si conocemos el tama√±o m√°ximo del mapa o el n√∫mero m√°ximo de objetos en el mundo. </li><li>  <b>L√≠mite de tipos / sistemas</b> : restricci√≥n en el n√∫mero de tipos de componentes o sistemas.  <i>En Artemis en ese momento era imposible crear m√°s de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">32 o 64 tipos de componentes y sistemas</a></i> . </li></ul><br>  Como se puede ver en la tabla, por nuestra cuenta quer√≠amos implementar todos los requisitos, excepto los opcionales.  De hecho, por el momento no hemos hecho: <br><br><ul><li>  <i>unirse por ID O (N + M)</i> y <i>unirse por referencia ID O (N + M)</i> : la selecci√≥n de dos componentes diferentes todav√≠a ocupa O (N¬≤) (de hecho, un bucle <i>for</i> anidado).  Por otro lado, no hay tantas entidades y componentes para una coincidencia. </li><li>  <i>comparar por ID (add, del)</i> : no es necesario a nivel de marco.  Implementamos esto en un nivel superior en MVP. </li><li>  <i>copia / reemplazo r√°pido</i> y <i>componente como tipo de valor (estructura)</i> - en alg√∫n momento nos dimos cuenta de que trabajar con estructuras no ser√≠a tan conveniente como con las clases, y nos decidimos por las clases - preferimos la conveniencia de desarrollo en lugar de un mejor rendimiento.  Por cierto, los desarrolladores de Entitas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">hicieron lo mismo al final</a> . </li></ul><br>  Al mismo tiempo, sin embargo, nos dimos cuenta de uno de los requisitos que inicialmente eran opcionales en nuestra opini√≥n: <br><br><ul><li>  <i>Compresi√≥n consciente del contenido</i> : gracias a esto pudimos reducir significativamente (decenas de veces) el tama√±o del paquete transmitido a trav√©s de la red.  Para las redes de datos m√≥viles, es muy importante ajustar el tama√±o del paquete en la MTU para que no se ‚Äúdescomponga‚Äù en partes peque√±as que puedan perderse, ir en un orden diferente y luego deben ensamblarse en partes.  Por ejemplo, en Photon, si el tama√±o de los datos no cabe en la biblioteca MTU, divide los datos en paquetes y los env√≠a como confiables (con entrega garantizada), incluso si los env√≠a como "no confiables" desde arriba.  Probado con dolor de primera mano. </li></ul><br><h3>  Caracter√≠sticas de nuestro desarrollo en ECS </h3><br><ul><li>  <b>Nosotros en ECS escribimos l√≥gica de negocios exclusivamente</b> .  No trabajar con recursos, vistas, etc.  Dado que el c√≥digo l√≥gico ECS se ejecuta simult√°neamente en el cliente en Unity y en el servidor, debe ser lo m√°s independiente posible de otros niveles y m√≥dulos. </li><li>  <b>Intentamos minimizar los componentes y sistemas</b> .  Por lo general, para cada nueva tarea, comenzamos nuevos componentes y sistemas.  Pero a veces sucede que modificamos los antiguos, agregamos nuevos datos a los componentes e "inflamos" los sistemas. </li><li>  <b>En nuestra implementaci√≥n de ECS, no puede agregar varios componentes del mismo tipo a una entidad</b> .  Por lo tanto, si un jugador fue golpeado varias veces en una marca (por ejemplo, varios oponentes), generalmente creamos una nueva entidad para cada da√±o y le agregamos un componente de <i>Da√±o</i> . </li><li>  <b>A veces, la presentaci√≥n no es suficiente de la informaci√≥n que se encuentra en <i>GameState</i></b> .  Luego debe agregar componentes especiales o datos adicionales que no est√°n involucrados en la l√≥gica, pero que la vista necesita.  Por ejemplo, el disparo es instant√°neo en el servidor, se activa una marca y, visualmente, es m√°s largo en el cliente.  Por lo tanto, para el cliente, el disparo se agrega al par√°metro "vida √∫til del disparo". </li><li>  <b>Implementamos eventos / solicitudes creando componentes especiales</b> .  Por ejemplo, si un jugador ha muerto, le colgamos un componente sin datos <i>muertos</i> , que es un evento para otros sistemas y el nivel de Vista en el que el jugador ha muerto.  O si necesitamos revivir al jugador en el punto nuevamente, creamos una entidad separada con el componente <i>Respawn</i> con informaci√≥n adicional sobre a qui√©n revivir.  Un <i>RespawnSystem</i> separado al comienzo del ciclo del juego pasa por estos componentes y ya crea la esencia del jugador.  Es decir  de hecho, la primera entidad es una solicitud para crear la segunda. </li><li>  <b>Tenemos componentes / entidades especiales "singleton"</b> .  Por ejemplo, tenemos una entidad con ID = 1, en la que cuelgan componentes especiales: la configuraci√≥n del juego. </li></ul><br><h3>  Bono </h3><br>    ‚Äî       ECS ‚Äî    .     ,        ,   ,   : <br><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Unity, ECS  --</a> ‚Äî       ECS   .  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">mopsicus</a>  ,   ECS,  .        :  Unity  ECS   ,   .    .   ¬´¬ª ECS    Unity.    ECS-,      : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">LeoECS</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">BrokenBricksECS</a> , <a href="">Svelto.ECS</a> . </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Unity3D ECS  Job System</a> ‚Äî   ,      ECS  Unity.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">fstleo</a>   ,   Unity ECS,     ,         -      ,    JobSystem. </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">  Entity System Framework      ?</a> ‚Äî    Ash-  ActionScript.  ,   ,        OOP-  ECS-. </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">    Ash Entity System </a> ‚Äî   ,    FSM  State  ECS ‚Äî      ,       . </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">  Entity-Component-System ‚Äî    </a> ‚Äî     ECS  C++. </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es413729/">https://habr.com/ru/post/es413729/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es413717/index.html">GraphQL para plataformas InterSystems</a></li>
<li><a href="../es413719/index.html">C ++ 20 en camino! Encuentro en Rapperswil Yona</a></li>
<li><a href="../es413721/index.html">Comprobaci√≥n de tiempo: Timejacking vs Bitcoin</a></li>
<li><a href="../es413723/index.html">Saga de servicios electr√≥nicos y sus ubicaciones. Parte 2. Armario electr√≥nico</a></li>
<li><a href="../es413725/index.html">Trabajando con matrices en bash</a></li>
<li><a href="../es413731/index.html">BA / SA Investigaci√≥n de mercado laboral</a></li>
<li><a href="../es413733/index.html">Mikrosh, Krista, Apogee, Lviv: las primeras computadoras sovi√©ticas para llevar</a></li>
<li><a href="../es413739/index.html">C√≥mo escaneamos todo Internet y lo que aprendimos</a></li>
<li><a href="../es413741/index.html">Qu√© era y c√≥mo: impresiones del equipo WWDC Redmadrobot</a></li>
<li><a href="../es413743/index.html">Inicie LAMP y cientos de otras aplicaciones web con unos pocos clics.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>