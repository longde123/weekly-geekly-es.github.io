<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🕣 🔎 🈸 Pemantauan pertanian kolektif UPS dengan protokol Megatec di Zabbix 🛤️ 🏿 🤙</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ada kebutuhan untuk memantau kebun binatang UPS, Ippon, Powercom dan Krauler tersedia. Sebagai alat pemantauan digunakan Zabbix. 
 
 Secara alami, mas...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Pemantauan pertanian kolektif UPS dengan protokol Megatec di Zabbix</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/397637/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ada kebutuhan untuk memantau kebun binatang UPS, Ippon, Powercom dan Krauler tersedia. </font><font style="vertical-align: inherit;">Sebagai alat pemantauan digunakan Zabbix. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Secara alami, masalah perlu diselesaikan 1) murah 2) bahkan lebih murah, sehingga opsi dengan modul SNMP langsung ditolak. </font><font style="vertical-align: inherit;">Diputuskan untuk menggunakan koneksi port serial, karena ada pengalaman pengembangan untuk Ippon dan APC. </font><font style="vertical-align: inherit;">Omong-omong, APC di pasar sekunder memiliki modul SNMP dengan harga yang wajar, tetapi untuk UPS yang murah, saya hanya bisa menemukan modul baru dengan harga 11-20 ribu rubel. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Selama pekerjaan, tugas tambahan berikut ditetapkan:</font></font><br>
 <br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">temukan dan periksa kabel untuk menghubungkan setiap UPS, karena tidak ada dalam kit</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Untuk mengimplementasikan modul tertentu yang akan memiliki antarmuka RS-232 di satu sisi dan memahami protokol pertukaran data dengan masing-masing UPS, dan di sisi lain, memiliki antarmuka jaringan dan dapat mengirim data dalam bentuk zabbix_trapper.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uji pengumpulan data dan model transmisi, bagian-bagian kode, serta format data.</font></font></li>
</ol><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selama implementasi paragraf kedua dan ketiga, saya ingin mengumpulkan di satu tempat semua data yang akan memungkinkan di masa depan untuk mengimplementasikan perangkat terpisah untuk m / c.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jadi:</font></font><br>
<br>
<ul>
<li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. Kabel</font></font></b></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Tidak ada kabel untuk UPS apa pun. </font><font style="vertical-align: inherit;">Pada prinsipnya, tugas pertama tidak menimbulkan masalah bagi orang yang dapat menghitung kontak pada konektor DB9. </font><font style="vertical-align: inherit;">Ternyata, tidak hanya semua orang tahu caranya, termasuk saya. </font><font style="vertical-align: inherit;">Kontak pada konektor F dan M dicerminkan, tetapi ditandatangani, secara umum, tidak mungkin membuat kesalahan, jika Anda berhati-hati.</font></font><br>
 <br>
<ul>
<li> Ippon Smart Winner 2000     back power pro,    2-2, 3-3, 5-5.         ,   .</li>
<li> Krauler Memo RT 2000        krauler.ru,    2-2,3-3, 5-5.</li>
<li> Powercom SXL-2000A       <a href="">www.pcm.ru/data/docs/cables.zip</a>,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">forum.pcm.ru</a>.  2-9, 3-6, 5-7. (-).</li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Offtopic kecil. Tulang punggung server terdiri dari dua host Vmware ESXi, yang ditempatkan di rak dengan dua UPS. Beberapa server memiliki 2 catu daya. Dan sebagian, sayangnya, hanya satu, itulah sebabnya mereka menderita secara berkala. Zabbix saat ini dihosting di salah satu host sebagai mesin virtual. Pada prinsipnya, menggunakan server virtual kecil di Ubuntu (saya menggunakan platform ini untuk layanan) untuk mengimplementasikan tugas apa pun bukanlah masalah. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Dengan demikian, skema yang dikembangkan: COM port pada ESXi -&gt; Com port pada mesin virtual -&gt; program C yang mengembalikan data dari UPS -&gt; Script atau program yang mengirimkan jebakan zabbix. Dua poin terakhir harus dikombinasikan di masa depan. Meskipun berfungsi seperti itu.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Masalahnya diselesaikan secara berurutan, dengan kabel kabel untuk satu UPS, dengan kabel konektor tambahan untuk server (ada dua dari mereka, ditambah adaptor rj-45 di DB9), memeriksa koneksi, memeriksa program, mengatur elemen-elemen di Zabbiks.</font></font><br>
<br>
<ul>
<li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. Interogasi port COM oleh program</font></font></b></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Hal pertama yang diperlukan adalah memilih server untuk hosting kode yang dapat dieksekusi. </font><font style="vertical-align: inherit;">Saya tidak memutar otak saya dan memposting semua ini di server Zabbix. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Kedua, saya berpikir bagaimana memproses data. </font><font style="vertical-align: inherit;">Karena desain di Bash</font></font><pre><code class="bash hljs">array=( $(/home/appliance/uniups) )<font></font>
<font></font>
</code></pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> yang memecah string menjadi array data, saya memutuskan untuk hanya mengembalikan segmen baris MMM.M NNN.N PPP.P QQQ RR.R S.SS TT.T </font></font><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kode program</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt;   /*   / */</span></span></span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;string&gt;</span></span></span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;iostream&gt;</span></span></span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;cstring&gt;</span></span></span></span><font></font>
<font></font>
<span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>;
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;unistd.h&gt;  /*    UNIX */</span></span></span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;fcntl.h&gt;   /*    */</span></span></span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;errno.h&gt;   /*    */</span></span></span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;termios.h&gt; /*   POSIX- */</span></span></span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span></span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;sys/stat.h&gt;</span></span></span></span><font></font>
<font></font>
<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> fd; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buf[<span class="hljs-number"><span class="hljs-number">512</span></span>];<span class="hljs-comment"><span class="hljs-comment">/*      */</span></span>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> argc, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* argv[])</span></span></span><span class="hljs-function">
 </span></span>{
    <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> iIn,iOut;
    <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> UPSAnswer;
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (argc&gt;=<span class="hljs-number"><span class="hljs-number">2</span></span>)<font></font>
{<font></font>
        fd = open(argv[<span class="hljs-number"><span class="hljs-number">1</span></span>], O_RDWR | O_NOCTTY | O_NDELAY); <span class="hljs-comment"><span class="hljs-comment">/*'open_port()' -    */</span></span>
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fd == <span class="hljs-number"><span class="hljs-number">-1</span></span>)   {
           <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"error port\n"</span></span>);<font></font>
           perror(<span class="hljs-string"><span class="hljs-string">"open_port: Unable to open port - "</span></span>);   }
     <span class="hljs-keyword"><span class="hljs-keyword">else</span></span><font></font>
        {<font></font>
         struct termios options; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span>
         tcgetattr(fd, &amp;options); <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span><font></font>
<font></font>
         cfsetispeed(&amp;options, B2400); <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span>
         cfsetospeed(&amp;options, B2400); <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span><font></font>
<font></font>
         options.c_cflag &amp;= ~PARENB; <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span>
         options.c_cflag &amp;= ~CSTOPB; <span class="hljs-comment"><span class="hljs-comment">/* 2- ,  1 */</span></span>
         options.c_cflag &amp;= ~CSIZE; <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span>
         options.c_cflag |= CS8; <span class="hljs-comment"><span class="hljs-comment">/* 8*/</span></span>
         tcsetattr(fd, TCSANOW, &amp;options); <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span><font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> Params[<span class="hljs-number"><span class="hljs-number">64</span></span>];<font></font>
<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(argc&gt;=<span class="hljs-number"><span class="hljs-number">3</span></span>)<font></font>
        {<font></font>
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-built_in"><span class="hljs-built_in">strcmp</span></span>(argv[<span class="hljs-number"><span class="hljs-number">2</span></span>],<span class="hljs-string"><span class="hljs-string">"status"</span></span>))<font></font>
            {<font></font>
                iOut = write(fd, <span class="hljs-string"><span class="hljs-string">"Q1\r"</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>);<font></font>
                usleep(<span class="hljs-number"><span class="hljs-number">800000</span></span>);
                <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (iOut &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>)  <span class="hljs-built_in"><span class="hljs-built_in">fputs</span></span>(<span class="hljs-string"><span class="hljs-string">"write() of 4 bytes failed!\n"</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">stderr</span></span>);<font></font>
                iIn=read(fd,buf,<span class="hljs-number"><span class="hljs-number">250</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span><font></font>
<font></font>
                 <span class="hljs-built_in"><span class="hljs-built_in">strncpy</span></span>(Params,&amp;buf[<span class="hljs-number"><span class="hljs-number">38</span></span>],<span class="hljs-number"><span class="hljs-number">11</span></span>);<font></font>
                 Params[<span class="hljs-number"><span class="hljs-number">46</span></span>]=<span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
            }<font></font>
            <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-built_in"><span class="hljs-built_in">strcmp</span></span>(argv[<span class="hljs-number"><span class="hljs-number">2</span></span>],<span class="hljs-string"><span class="hljs-string">"help"</span></span>))<font></font>
            {<font></font>
                <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span> (<span class="hljs-string"><span class="hljs-string">" .   !\r\n"</span></span>);<font></font>
            }<font></font>
            <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-built_in"><span class="hljs-built_in">strcmp</span></span>(argv[<span class="hljs-number"><span class="hljs-number">2</span></span>],<span class="hljs-string"><span class="hljs-string">"name"</span></span>))<font></font>
            {<font></font>
                iOut = write(fd, <span class="hljs-string"><span class="hljs-string">"I\r"</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>);<font></font>
                usleep(<span class="hljs-number"><span class="hljs-number">800000</span></span>);
                <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (iOut &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>)  <span class="hljs-built_in"><span class="hljs-built_in">fputs</span></span>(<span class="hljs-string"><span class="hljs-string">"write() of 4 bytes failed!\n"</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">stderr</span></span>);<font></font>
                iIn=read(fd,buf,<span class="hljs-number"><span class="hljs-number">250</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span>
                <span class="hljs-built_in"><span class="hljs-built_in">strncpy</span></span>(Params,&amp;buf[<span class="hljs-number"><span class="hljs-number">0</span></span>],<span class="hljs-number"><span class="hljs-number">60</span></span>);<font></font>
<font></font>
            }<font></font>
            <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-built_in"><span class="hljs-built_in">strcmp</span></span>(argv[<span class="hljs-number"><span class="hljs-number">2</span></span>],<span class="hljs-string"><span class="hljs-string">"stat2"</span></span>))<font></font>
            {<font></font>
                iOut = write(fd, <span class="hljs-string"><span class="hljs-string">"F\r"</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>);<font></font>
                usleep(<span class="hljs-number"><span class="hljs-number">800000</span></span>);
                <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (iOut &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>)  <span class="hljs-built_in"><span class="hljs-built_in">fputs</span></span>(<span class="hljs-string"><span class="hljs-string">"write() of 4 bytes failed!\n"</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">stderr</span></span>);<font></font>
                iIn=read(fd,buf,<span class="hljs-number"><span class="hljs-number">250</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span>
                <span class="hljs-built_in"><span class="hljs-built_in">strncpy</span></span>(Params,&amp;buf[<span class="hljs-number"><span class="hljs-number">1</span></span>],<span class="hljs-number"><span class="hljs-number">60</span></span>);<font></font>
         Params[<span class="hljs-number"><span class="hljs-number">20</span></span>]=<span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
            }<font></font>
            <span class="hljs-keyword"><span class="hljs-keyword">else</span></span><font></font>
            {<font></font>
                <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span> (<span class="hljs-string"><span class="hljs-string">"? \r\n"</span></span>);<font></font>
            }<font></font>
        }<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">else</span></span><font></font>
        {<font></font>
           <span class="hljs-comment"><span class="hljs-comment">/*    Q1 */</span></span>
                usleep(<span class="hljs-number"><span class="hljs-number">1800</span></span>);<font></font>
                iIn=read(fd,buf,<span class="hljs-number"><span class="hljs-number">250</span></span>);<font></font>
                usleep(<span class="hljs-number"><span class="hljs-number">1800</span></span>);<font></font>
           iOut = write(fd, <span class="hljs-string"><span class="hljs-string">"Q1\r"</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>);<font></font>
           usleep(<span class="hljs-number"><span class="hljs-number">800000</span></span>);
           <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (iOut &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>)  <span class="hljs-built_in"><span class="hljs-built_in">fputs</span></span>(<span class="hljs-string"><span class="hljs-string">"write() of 4 bytes failed!\n"</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">stderr</span></span>);<font></font>
           iIn=read(fd,buf,<span class="hljs-number"><span class="hljs-number">250</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span><font></font>
<font></font>
           <span class="hljs-built_in"><span class="hljs-built_in">strncpy</span></span>(Params,&amp;buf[<span class="hljs-number"><span class="hljs-number">1</span></span>],<span class="hljs-number"><span class="hljs-number">36</span></span>);<font></font>
           Params[<span class="hljs-number"><span class="hljs-number">36</span></span>]=<span class="hljs-string"><span class="hljs-string">' '</span></span>;<font></font>
        }<font></font>
    close(fd);<font></font>
    <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"%s\r\n"</span></span>,Params);<font></font>
}<font></font>
<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>
<span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"Usage %s /dev/ttySx"</span></span>, argv[<span class="hljs-number"><span class="hljs-number">0</span></span>]);<font></font>
<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Saya menemukan bekerja dengan port di Google, Anda dapat membaca dari Bash, tetapi dari Bash itu tidak mungkin untuk mencapai operasi yang stabil. </font><font style="vertical-align: inherit;">Pada prinsipnya, kode C di linux adalah b. </font><font style="vertical-align: inherit;">Ippon pertama diuji, kemudian selama studi tentang Powercom UPS, sebuah monitor port diluncurkan, yang menunjukkan bahwa PowerCom juga bekerja melalui protokol Megatec, dan program asli memungut UPS pada saat startup dengan perintah "I" dan "F", dan kemudian secara siklikal "Q1". </font><font style="vertical-align: inherit;">Saya menggantung nama port dalam bentuk "/ dev / ttyS0" atau "/ dev / ttyS1" pada argumen pertama, argumen kedua memungkinkan Anda untuk meminta parameter tambahan, kode menunjukkan. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Dalam direktori / home / appliance / menempatkan program, menyebutnya uniups.cpp. </font><font style="vertical-align: inherit;">Disusun</font></font><pre><code class="bash hljs">g++ -o uniups uniups.cpp </code></pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada prinsipnya, hasilnya adalah seperti ini (ya, saya bekerja di bawah root, bahkan tidak berkomentar)</font></font><br>
<br>
<pre><code class="bash hljs">root@zabbix:~<span class="hljs-comment"><span class="hljs-comment"># ./uniups /dev/ttyS0</span></span><font></font>
204.4 204.4 204.4 035 49.9 54.8 54.5<font></font>
root@zabbix:~<span class="hljs-comment"><span class="hljs-comment"># ./uniups /dev/ttyS0 name</span></span><font></font>
I<font></font>
root@zabbix:~<span class="hljs-comment"><span class="hljs-comment"># ./uniups /dev/ttyS1 name</span></span>
<span class="hljs-comment"><span class="hljs-comment">#POWERCOM        SXL-2000A  LCD  V4.3</span></span>
root@zabbix:~<span class="hljs-comment"><span class="hljs-comment"># ./uniups /dev/ttyS1</span></span><font></font>
216.3 216.3 216.3 000 50.0 54.2 30.0<font></font>
root@zabbix:~<span class="hljs-comment"><span class="hljs-comment"># ./uniups /dev/ttyS1 stat2</span></span><font></font>
220.0 009 048.0 50.0<font></font>
root@zabbix:~<span class="hljs-comment"><span class="hljs-comment">#</span></span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Yang penting, pada akhirnya ternyata semua UPS menggunakan protokol yang sama, yang memungkinkan penggunaan satu program. </font><font style="vertical-align: inherit;">Koneksi pada 2400, 8N1 digunakan, yang lainnya mati. </font><font style="vertical-align: inherit;">Ada lalat di salep, nama UPS biasanya hanya kembali ke Powercom, Ippon tidak mengerti perintah "I", dan Krauler mengembalikan "# R1.1.1". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selain itu, Krauler mengembalikan tegangan ke elemen, dan sisa UPS ke baterai, dalam dokumentasi itu digambarkan sebagai</font></font><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SS.S atau S.SS Untuk unit on-line, tegangan / sel baterai disediakan dalam bentuk S.SS. </font><font style="vertical-align: inherit;">Untuk unit siaga, tegangan baterai aktual disediakan dalam bentuk SS.S</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mengingat hal ini, saya harus menempelkan skrip pada skrip. </font><font style="vertical-align: inherit;">Tentang itu di bawah ini.</font></font><br>
<br>
<ul>
<li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3. Mengirim data ke Zabbix</font></font></b></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dengan mengirimkan ini ternyata kebun binatang untuk semua kesempatan. </font><font style="vertical-align: inherit;">Di server, Zabbix menggunakan utilitas zabbix_sender untuk mempercepat proses.</font></font><br>
<pre><code class="bash hljs">zabbix_sender -z _ -p 10051 -s ___ -k  -o 
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada prinsipnya, untuk polling dua UPS, ini sudah cukup, pada saat ini, bagaimanapun, saya akan memiliki yang ketiga, dan di masa depan saya akan memiliki yang keempat, jadi saya memilih yang pertama dan, secara kebetulan aneh, satu-satunya server Linux pada host Vmware kedua dan mengirimkannya ke dia port COM. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya tidak menggunakan agen zabbix atau menyalin zabbix_sender, saya menemukan deskripsi yang terakhir pada </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Semua garam terdiri dari penyandian data di Base64. </font><font style="vertical-align: inherit;">Untuk memeriksa, saya menggunakan perintah</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"&lt;req&gt;\n&lt;host&gt;S3JhdWxlck1lbW9SVDIwMDA=&lt;/host&gt;\n&lt;key&gt;RnJlcQ==&lt;/key&gt;\n&lt;data&gt;NDkuNA==&lt;/data&gt;\n&lt;/req&gt;\n"</span></span> | nc -q 0 192.168.53.23 10051</code></pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">di mana 192.168.53.23 adalah alamat server Zabbix. </font><font style="vertical-align: inherit;">Dia sedang bekerja. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya menelepon skrip di atas zabbix_sender.pl dan meletakkannya di server, skrip saya terlihat seperti ini:</font></font><br>
<pre><code class="perl hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/perl</span></span><font></font>
<font></font>
<span class="hljs-keyword"><span class="hljs-keyword">use</span></span> IO::Socket;
<span class="hljs-keyword"><span class="hljs-keyword">use</span></span> IO::Select;
<span class="hljs-keyword"><span class="hljs-keyword">use</span></span> MIME::Base64;<font></font>
<font></font>
<span class="hljs-keyword"><span class="hljs-keyword">my</span></span> ($zabbixserver,$hostname,$item,$data) = @_;<font></font>
<font></font>
$zabbixserver= @ARGV[<span class="hljs-number"><span class="hljs-number">0</span></span>];<font></font>
$hostname= @ARGV[<span class="hljs-number"><span class="hljs-number">1</span></span>];<font></font>
$item= @ARGV[<span class="hljs-number"><span class="hljs-number">2</span></span>];<font></font>
$data= @ARGV[<span class="hljs-number"><span class="hljs-number">3</span></span>];<font></font>
<font></font>
 <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $timeout=<span class="hljs-number"><span class="hljs-number">10</span></span>;
 <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $request=<span class="hljs-keyword"><span class="hljs-keyword">sprintf</span></span>(<span class="hljs-string"><span class="hljs-string">"&lt;req&gt;\n&lt;host&gt;%s&lt;/host&gt;\n&lt;key&gt;%s&lt;/key&gt;\n&lt;data&gt;%s&lt;/data&gt;\n&lt;/req&gt;\n"</span></span>,<font></font>
 encode_base64($hostname),encode_base64($item),encode_base64($data));<font></font>
<font></font>
 <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $sock = new IO::Socket::INET ( <span class="hljs-string"><span class="hljs-string">PeerAddr =&gt;</span></span> $zabbixserver, <span class="hljs-string"><span class="hljs-string">PeerPort =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">'10051'</span></span>, <span class="hljs-string"><span class="hljs-string">Proto =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">'tcp'</span></span>, <span class="hljs-string"><span class="hljs-string">Timeout =&gt;</span></span> $timeout);
 <span class="hljs-keyword"><span class="hljs-keyword">die</span></span> <span class="hljs-string"><span class="hljs-string">"Could not create socket: $!\n"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unless</span></span> $sock;<font></font>
 $sock-&gt;<span class="hljs-keyword"><span class="hljs-keyword">send</span></span>($request);
 <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> @handles=IO::Select-&gt;new($sock)-&gt;can_read($timeout);
 <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">scalar</span></span>(@handles) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>)<font></font>
 {<font></font>
  $sock-&gt;<span class="hljs-keyword"><span class="hljs-keyword">recv</span></span>($result,<span class="hljs-number"><span class="hljs-number">1024</span></span>);
  <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"answer from zabbix server $zabbixserver: $result\n"</span></span>;<font></font>
 }<font></font>
 <span class="hljs-keyword"><span class="hljs-keyword">else</span></span><font></font>
 {<font></font>
  <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"no answer from zabbix server\n"</span></span>;<font></font>
 }<font></font>
 $sock-&gt;<span class="hljs-keyword"><span class="hljs-keyword">close</span></span>();
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Perl sudah ada di server. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selanjutnya, kami membutuhkan skrip yang akan menghubungkan semua komponen bersama dan yang dapat ditempatkan di Cron. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Berikut adalah contoh untuk satu port, untuk port lain Anda cukup menyalin kode yang sama dan mengganti nama yang berbeda. </font><font style="vertical-align: inherit;">Saya tidak melakukan siklus, saya hampir tidak membayangkan mobil dengan lebih dari 2 port COM.</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta"><span class="hljs-meta">#!/bin/bash</span></span><font></font>
array=( $(//uniups /dev/ttyS0) )<font></font>
Names=( InVolt FaultVolt OutVolt Current Freq UBatt UTemp NA )<font></font>
correct[5]=<span class="hljs-string"><span class="hljs-string">"24.0"</span></span><font></font>
j=0;<font></font>
<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"Checking UPS on serial A - </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${#array[@]}</span></span></span><span class="hljs-string">"</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>  [ <span class="hljs-variable"><span class="hljs-variable">${#array[@]}</span></span> -gt <span class="hljs-string"><span class="hljs-string">"7"</span></span> ]
<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>
param=<span class="hljs-string"><span class="hljs-string">""</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${array[@]}</span></span></span><span class="hljs-string">"</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">do</span></span>
   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [[ <span class="hljs-variable"><span class="hljs-variable">${correct[$j]}</span></span> ]]
      <span class="hljs-keyword"><span class="hljs-keyword">then</span></span>
         param=$( <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"scale = 0; </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$i</span></span></span><span class="hljs-string"> * </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${correct[$j]}</span></span></span><span class="hljs-string">"</span></span> | bc)
       <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>.<font></font>
      param=<span class="hljs-variable"><span class="hljs-variable">$i</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span>
   //zabbix_sender.pl 192.168.53.23 KraulerMemoRT2000 <span class="hljs-variable"><span class="hljs-variable">${Names[$j]}</span></span> <span class="hljs-variable"><span class="hljs-variable">$param</span></span>
   j=<span class="hljs-variable"><span class="hljs-variable">$j</span></span>+1;
<span class="hljs-keyword"><span class="hljs-keyword">done</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>
<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"No data on A"</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">fi</span></span>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Komentar kecil:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">array - array yang dikembalikan oleh program polling UPS, Names - array dengan nama Item, pada elemen server Zabbix dengan nama yang sama harus dimulai. </font><font style="vertical-align: inherit;">KraulerMemoRT2000 - nama yang tidak terputus, harus cocok dengan nama host di server.</font></font></li>
<li> ,    ,   Zabbix  , ,   ,    NA,      ,      ,     .</li>
<li>      ${#array[@]},    .         ,      .        :         ,       ,       .    ,    , .       ,   ,    .</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">betul [5] = “24.0” adalah koreksi tegangan untuk baterai (elemen ke-5 dalam susunan) jika UPS mengembalikan tegangan pada elemen (tegangan / sel baterai). </font><font style="vertical-align: inherit;">Saya memiliki 6 elemen dalam baterai, 4 buah seri, total 24. Pada prinsipnya, ini dijelaskan dalam protokol. </font><font style="vertical-align: inherit;">Saya merasa tidak perlu membuat elemen terpisah, karena semua UPS yang saya miliki dimonitor oleh template dan semuanya memiliki 48 volt. </font><font style="vertical-align: inherit;">Ketika memantau UPS dengan voltase yang berbeda, tentu saja, akan diperlukan untuk sedikit mengubah struktur, mungkin optimal untuk memalu parameter baterai di server.</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Script di atas ditambahkan ke cron untuk setiap menit eksekusi. </font><font style="vertical-align: inherit;">Pengaturan Zabbix tidak dipertimbangkan dalam artikel ini. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada prinsipnya, itu saja. </font><font style="vertical-align: inherit;">Saya akan senang jika informasi yang dikumpulkan bermanfaat bagi seseorang.</font></font></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id397637/">https://habr.com/ru/post/id397637/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id397627/index.html">Posting tentang sedikit</a></li>
<li><a href="../id397629/index.html">Tanyakan Ethan No. 93: Apple Newton Acak</a></li>
<li><a href="../id397631/index.html">Lingkungan Dyson - untuk apa ini? Bagian III: Penerapan Cincin Dyson dan elemen individual</a></li>
<li><a href="../id397633/index.html">Microsoft menyatukan ahli biologi dan pemrogram kanker</a></li>
<li><a href="../id397635/index.html">Hi-Fi Ingot: Cowon PLENUE S Audio Player</a></li>
<li><a href="../id397639/index.html">Obat Radiasi Darurat</a></li>
<li><a href="../id397641/index.html">Bekerja dengan sensor Hall effect sekarang: ACS758</a></li>
<li><a href="../id397643/index.html">Rumah pintar lain, di beberapa bagian. Pencahayaan dekoratif</a></li>
<li><a href="../id397645/index.html">Geohot mengumumkan autopilot "peretasan" seharga $ 999</a></li>
<li><a href="../id397649/index.html">Peluncuran stasiun ruang angkasa Tiongkok Tiangong-2 [terjemahan teks selesai]</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>