<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßîüèº üßôüèΩ üëåüèΩ Removendo dados de um banco de dados fragment√°vel ü§≤üèø üòØ üë©‚Äç‚ù§Ô∏è‚Äçüë®</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Um artigo sobre como resolver o problema de otimizar o processo de exclus√£o de arquivos de um sistema fragmentado. √â sobre um projeto para compartilha...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Removendo dados de um banco de dados fragment√°vel</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/427895/"> Um artigo sobre como resolver o problema de otimizar o processo de exclus√£o de arquivos de um sistema fragmentado.  √â sobre um projeto para compartilhar e trabalhar com arquivos.  O sistema era uma startup h√° cerca de 8 anos, depois foi filmado com sucesso e foi vendido v√°rias vezes.  O projeto tem 4 desenvolvedores que est√£o com o projeto desde o in√≠cio, o que √© muito valioso.  A documenta√ß√£o, tradicionalmente, n√£o tinha tempo para escrever ou n√£o √© muito relevante. <br><br>  Por que voc√™ leu isso e por que escrevi tudo isso?  Eu gostaria de falar sobre um ancinho que repousa cuidadosamente dentro do sistema e bate para que as estrelas saiam dos olhos. <br><br>  Quero agradecer a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">Hanna_Hlushakova</a> por trabalharem juntos, por <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">encerrar</a> o projeto e ajudar na prepara√ß√£o do artigo.  Basicamente, voc√™ encontrar√° descri√ß√µes do problema e o algoritmo para resolv√™-lo, que usamos, n√£o h√° exemplos de c√≥digo, estruturas de dados ou outras coisas necess√°rias.  N√£o sei se minha experi√™ncia o ajudar√° a evitar um rake em casa, mas espero que voc√™ consiga algo √∫til.  Talvez este artigo seja uma perda absolutamente irrevog√°vel de tempo valioso. <br><br><img src="https://habrastorage.org/webt/lb/p2/s5/lbp2s5dnlsusssfxqfd3zf9aoyk.png"><br><a name="habracut"></a><br><h3>  Sobre o projeto </h3><br>  O projeto √© um dos l√≠deres na pra√ßa Gartner, possui empresas clientes com mais de 300 mil funcion√°rios nos EUA e na Europa e v√°rios bilh√µes de arquivos para manuten√ß√£o. <br><br>  As seguintes tecnologias s√£o usadas no projeto: Microsoft, servidores C # .net, banco de dados MS SQL, 14 servidores ativos + 14 no modo de espelhamento de dados. <br><br>  O volume de bancos de dados √© de at√© 4 TB, a carga constante no hor√°rio comercial √© de cerca de 400 mil solicita√ß√µes por minuto. <br><br>  H√° muita l√≥gica de neg√≥cios no banco de dados: <br>  450 mesas <br>  1000 procedimentos armazenados <br>  80.000 linhas de c√≥digo SQL <br>  Tradicionalmente, eles n√£o tinham tempo para escrever a documenta√ß√£o ou isso n√£o √© relevante. <br><br><h3>  Sobre a tarefa </h3><br>  A tarefa √© refazer a exclus√£o de arquivos do armazenamento que j√° foram exclu√≠dos pelos clientes e o per√≠odo de armazenamento dos arquivos exclu√≠dos expirou, caso eles desejem ser restaurados.  Na vers√£o atual, de acordo com os c√°lculos da pr√≥pria empresa, os arquivos que foram exclu√≠dos h√° um ano foram armazenados nos servidores, embora de acordo com os termos de neg√≥cios eles devessem ter sido armazenados apenas 1 m√™s.  Como alguns dos arquivos est√£o armazenados no S3, a empresa pagou pelos dados extras e os clientes que usaram o armazenamento local ficaram imaginando por que os arquivos ocupavam mais espa√ßo do que deveriam. <br><br>  Bancos de dados shardovany para o cliente da empresa. <br><br><h3>  Como a remo√ß√£o funcionou anteriormente? </h3><br><br><img src="https://habrastorage.org/webt/wy/zx/dq/wyzxdqqakclb2u1kjmtbzl3v39y.png"><br><br>  Em um servidor global com informa√ß√µes sobre todos os arquivos no sistema, foram formados intervalos de 15 mil identificadores de arquivos. <br><br>  Ent√£o, de acordo com o cronograma, foi iniciada uma pesquisa de servidor para v√°rios identificadores de arquivo. <br>  Os limites do intervalo foram transmitidos para cada fragmento. <br><br>  O shard em resposta enviou arquivos encontrados do intervalo. <br><br>  O servidor principal adicionou os arquivos ausentes √† tabela da fila para exclus√£o em seu banco de dados. <br>  Em seguida, na tabela de filas, o servi√ßo de exclus√£o de arquivo f√≠sico do armazenamento recebeu v√°rios identificadores para exclus√£o, ap√≥s o que enviou uma confirma√ß√£o de que iria excluir os arquivos e uma verifica√ß√£o foi iniciada para todos os shards, se esses arquivos foram usados ‚Äã‚Äãl√°. <br>  Com um aumento no n√∫mero de arquivos, essa abordagem come√ßou a funcionar muito lentamente, pois havia v√°rios bilh√µes de arquivos e o n√∫mero de intervalos aumentou significativamente.  Os arquivos exclu√≠dos ainda permaneciam menos de 5% em compara√ß√£o com o n√∫mero total, respectivamente, √© muito ineficiente classificar bilh√µes de arquivos para encontrar v√°rios milh√µes de arquivos exclu√≠dos. <br><br>  Por exemplo, geralmente depois que um usu√°rio exclui um arquivo, ele deve ser armazenado por 1 m√™s, caso precise ser restaurado.  Ap√≥s esse per√≠odo, o arquivo deve ser exclu√≠do pelo programa do reposit√≥rio.  Com o n√∫mero atual de arquivos, o n√∫mero de intervalos e a velocidade dos desvios, levaria 1 ano para o servidor ignorar completamente todos os intervalos. <br>  √â claro que o local n√£o foi liberado e isso causou insatisfa√ß√£o dos usu√°rios, pois seus servidores armazenavam muitas vezes mais arquivos do que deveriam ter sido relatados.  A pr√≥pria empresa de servi√ßos pagou por um lugar adicional no S3, o que foi uma perda direta para ele. <br><br>  Somente no S3, no momento em que o trabalho come√ßou, 2 Petabytes de arquivos exclu√≠dos foram armazenados, e isso √© apenas na nuvem.  Al√©m disso, havia clientes cujos arquivos eram armazenados em seus servidores dedicados, com o mesmo problema: o espa√ßo do servidor era ocupado por arquivos exclu√≠dos pelos usu√°rios, mas n√£o exclu√≠dos do servidor. <br><br><h3>  O que voc√™ decidiu fazer? </h3><br>  Decidimos rastrear os eventos de remo√ß√£o: <br><br><ul><li>  o cliente excluiu o arquivo e expirou. </li><li>  o usu√°rio excluiu o arquivo imediatamente sem a possibilidade de recupera√ß√£o. </li></ul><br>  Ao excluir um arquivo de um banco de dados fragmentado, decidimos usar uma abordagem otimista e remover uma das verifica√ß√µes para uso.  Sab√≠amos que 99% dos arquivos s√£o usados ‚Äã‚Äãapenas em um shard.  Decidimos adicionar imediatamente o arquivo √† fila de exclus√£o e n√£o verificamos o restante dos shards para o uso desse arquivo, pois a verifica√ß√£o ser√° feita novamente quando a exclus√£o da loja confirmar o servi√ßo. <br><br>  Al√©m disso, eles deixaram o JOB atual que verificou os arquivos exclu√≠dos por intervalos para adicionar arquivos que foram exclu√≠dos antes do lan√ßamento da nova vers√£o. <br><br>  Tudo o que foi exclu√≠do no shard √© coletado em uma tabela e depois transferido para um √∫nico servidor, com informa√ß√µes sobre todos os arquivos. <br><br>  Nesse servidor, ele √© enviado para a tabela da fila de exclus√£o. <br><br>  Na tabela para exclus√£o antes da exclus√£o, √© verificado se o arquivo n√£o √© usado em todos os shards.  Esta parte da verifica√ß√£o estava aqui antes da altera√ß√£o do c√≥digo e eles decidiram n√£o toc√°-la. <br><br><h4>  O que voc√™ precisou mudar no c√≥digo? </h4><br>  Em cada um dos shards, foi adicionada uma tabela na qual o identificador do arquivo exclu√≠do deve ser gravado. <br><br>  Encontramos todos os procedimentos para excluir arquivos do banco de dados, havia apenas 2. Depois que o usu√°rio excluiu o arquivo, o arquivo permanece no banco de dados por algum tempo. <br><br>  No procedimento para excluir um arquivo do banco de dados, adicionamos uma entrada a esta tabela local com arquivos exclu√≠dos. <br><br>  No servidor global com arquivos, eles criaram um JOB que baixa uma lista de arquivos dos bancos de dados shard.  Apenas chamando um procedimento a partir de um banco de dados shardable, ele faz um DELETE dentro e exibe uma lista de arquivos em OUTPUT.  No MS SQL Server, a extra√ß√£o de um servidor remoto √© muito mais r√°pida do que a inser√ß√£o em um servidor remoto.  Tudo isso √© feito em blocos. <br>  Esses arquivos s√£o adicionados √† tabela da fila de exclus√£o no servidor global. <br>  Uma tabela com um identificador de fragmento foi adicionada √† tabela da fila para saber de onde veio o evento de exclus√£o. <br><br><h3>  Como todos o testaram? </h3><br>  Existem 3 ambientes: <br><br>  O Dev √© um ambiente de desenvolvimento.  O c√≥digo √© retirado do ramo de desenvolvimento do gith.  √â poss√≠vel implantar uma vers√£o diferente do c√≥digo no IIS e criar v√°rias vers√µes da orquestra√ß√£o.  Ele se conectar√° ao ambiente de desenvolvimento a partir do cliente dentro da VPN.  At√© recentemente, o inconveniente era apenas com bancos de dados, pois todas as altera√ß√µes no banco de dados podem interromper o trabalho de outras partes do sistema.  Ent√£o as bases foram localizadas.  O c√≥digo em execu√ß√£o j√° pode ser derramado nos servidores dev com bancos de dados para n√£o arruinar o trabalho de todos.  Em um ambiente de desenvolvimento, existem 3 shards, em vez de 12, que est√£o no prod, mas isso geralmente √© suficiente para testar a intera√ß√£o. <br><br>  Preparo - o ambiente √© o mesmo com o prod de acordo com a vers√£o do c√≥digo (quase o mesmo, pois √© raro, mas h√° altera√ß√µes diretamente no prod pelos administradores).  Uma c√≥pia do c√≥digo da ramifica√ß√£o principal.  √Äs vezes, algumas diferen√ßas com o c√≥digo no produto foram detectadas no banco de dados, mas, em geral, s√£o id√™nticas.  Existem tamb√©m tr√™s fragmentos no estadiamento e na donzela.  N√£o h√° carga no teste, bem como no dev.  Aqui voc√™ pode executar testes de integra√ß√£o completamente, j√° que o c√≥digo corresponde ao prod.  Todos os testes devem passar, este √© um pr√©-requisito antes de ir para a Implanta√ß√£o. <br><br>  Laborat√≥rio de Perf, onde os testes s√£o feitos sob carga.  A carga √© criada usando jmeter, 10 vezes menos do que no prod, e h√° apenas um fragmento, o que √†s vezes cria inconvenientes.  Os dados de vendas s√£o coletados, anonimizados e usados ‚Äã‚Äãno laborat√≥rio de perf.  Todos os servidores da mesma configura√ß√£o que no prod. <br><br>  A carga √© 10 vezes menor, porque sup√µe-se que seja uma carga aproximada que chega ao prod para 1 shard.  A desvantagem √© que a base global √© muito subutilizada, diferentemente das vendas.  E, se as altera√ß√µes dizem respeito principalmente ao banco de dados global com arquivos, voc√™ pode confiar nos resultados do teste apenas aproximadamente - no produto, isso pode n√£o funcionar dessa maneira.  Embora o perf lab n√£o corresponda idealmente √† carga com o prod, a capacidade de testar sob a carga j√° ajuda a detectar muitos erros antes de implantar no prod. <br><br>  H√° tamb√©m um servidor de backup onde voc√™ pode ver os dados da venda para capturar alguns casos.  Em geral, a empresa opera sob uma licen√ßa que pro√≠be os desenvolvedores de conceder acesso aos dados de vendas e o acesso √† equipe de administra√ß√£o e suporte (Opera√ß√µes) ao desenvolvimento, portanto, √© necess√°rio solicitar a ajuda dos administradores de banco de dados.  Os dados de vendas tornam o teste muito f√°cil, porque alguns casos surgem apenas em dados do produto e √© muito √∫til estudar os dados em um sistema real para entender como o sistema funciona para o usu√°rio. <br><br>  Durante os testes no laborat√≥rio de desempenho, verificou-se que a carga de exclus√£o de arquivos do armazenamento n√£o foi realizada a partir da palavra.  Ao implementar o teste de carga, escolhemos solicita√ß√µes mais populares do software cliente, algumas das quais n√£o foram inclu√≠das na limpeza do armazenamento.  Como se trata de um banco de dados, acabou por realizar um teste simplificado para todos os objetos alterados com a chamada dos procedimentos alterados em diferentes dados manualmente.  (nas op√ß√µes que eu conhecia). <br>  Al√©m disso, nos testes de integra√ß√£o e desempenho, a √™nfase principal foi colocada no tipo mais popular de armazenamento de arquivos. <br><br>  Um recurso adicional do laborat√≥rio de perf, que n√£o foi descoberto imediatamente, √© a incompatibilidade da quantidade de dados em algumas tabelas no prod e no perf.  No sentido de que todos os JOBs de vendas funcionam no perf, que geram dados, mas nem sempre h√° algo que processa os dados gerados na tabela.  E, por exemplo, a fila de tabela acima mencionada para exclus√£o no perf √© muito maior do que no prod - 20 milh√µes de registros no perf e 200 mil registros no profissional. <br><br><h4>  Processo de implanta√ß√£o </h4><br>  O processo de implanta√ß√£o √© bastante padr√£o.  N√£o houve altera√ß√µes no c√≥digo do aplicativo para esta tarefa, todas as altera√ß√µes est√£o apenas no banco de dados.  Um DBA √© sempre rolado no banco de dados; esse processo n√£o √© automatizado.  2 vers√µes de scripts s√£o preparadas - para aplicar altera√ß√µes e reverter altera√ß√µes, e uma instru√ß√£o para DBA √© escrita.  Sempre s√£o feitas 2 vers√µes de scripts e s√£o necessariamente testadas para revers√£o e revers√£o de altera√ß√µes.  E esses mesmos scripts s√£o usados ‚Äã‚Äãpara aplicar altera√ß√µes no laborat√≥rio de prepara√ß√£o e desempenho antes de iniciar a integra√ß√£o e o teste de carga. <br><br><h3>  O que aconteceu ap√≥s a implanta√ß√£o? </h3><br>  Nas primeiras 5 horas ap√≥s a implanta√ß√£o, ocorreu um milh√£o de eventos em que o software cliente recebeu um erro ao tentar fazer o download do arquivo.  O evento "arquivo corrompido".  Isso significa que o cliente est√° tentando fazer o download do arquivo, mas o arquivo n√£o foi encontrado no reposit√≥rio.  Geralmente, esses eventos n√£o s√£o de todo ou s√£o medidos em 1 a 2 mil por dia. <br><br>  Devo dizer imediatamente que demorou pelo menos 1 semana para encontrar a causa do fracasso em uma equipe de 3 e, √†s vezes, 5 pessoas (incluindo eu). <br><br>  Coletamos toda a lista de arquivos para os quais o evento "Arquivo corrompido" veio. <br><br>  Apesar do fato de haver mais de 1 milh√£o de eventos e todos eles serem de usu√°rios diferentes, empresas diferentes, havia apenas 250 arquivos exclusivos nessa lista. <br><br>  O DBA no servidor de backup foi gerado para investigar os backups do banco de dados no momento em que os eventos chegaram.  Existem algumas tabelas nas bases do projeto com todos os tipos de logs que ajudaram na an√°lise.  Mesmo ao excluir informa√ß√µes do banco de dados, um log √© adicionado ao que foi exclu√≠do e por qual evento.  No produto, esses registros s√£o armazenados por 1 semana e depois mesclados no servidor de arquivamento. <br><br>  E o mesmo acontece com as tabelas com logs que ajudaram muito na an√°lise do que aconteceu: <br>  Um log completo com eventos do cliente √© mantido em cada shard <br><br>  No servidor global: <br><br><ul><li>  Log de solicita√ß√µes para baixar todos os arquivos pelos usu√°rios </li><li>  Log de upload de arquivos para o sistema pelos usu√°rios </li><li>  Log de eventos FileCorrupt </li><li>  Arquivo de log para cancelar a exclus√£o do armazenamento </li><li>  Log de arquivos exclu√≠dos do banco de dados </li></ul><br>  Al√©m disso, um ELK com logs de aplicativos estava dispon√≠vel. <br><br>  Conseguimos repetir o erro no ambiente de desenvolvimento, o que confirmou a exatid√£o da suposi√ß√£o.  No in√≠cio, ningu√©m levou a s√©rio essa hip√≥tese, pois era muito dif√≠cil acreditar que tantos fatores coincidiam ao mesmo tempo e que muitos usu√°rios chegavam nesse momento espec√≠fico. <br><br><h3>  O que deu errado? </h3><br>  Descobriu-se que o sistema tinha cerca de 250 (para compara√ß√£o, bilh√µes de arquivos no sistema) super mega arquivos populares.  250 sim! <br><br>  Esses arquivos ainda eram muito antigos.  No momento em que esses arquivos foram carregados no sistema, outro sistema para gerar a chave do arquivo para o armazenamento foi usado. <br><br>  Descobriu-se que, para esse tipo de chave, o m√©todo de remo√ß√£o f√≠sica do armazenamento f√≠sico se comporta de maneira diferente dos outros arquivos. <br><br>  Na classe com exclus√£o, h√° um bloco de c√≥digo com uma condi√ß√£o espec√≠fica para arquivos com a chave antiga.  O sistema, no momento da exclus√£o, antes de verificar se o arquivo n√£o est√° em fragmentos, move esse arquivo antigo para outro local.  Bem, isso n√£o deu certo. <br><br>  E, no momento em que o arquivo foi movido (e lembrarei que √© muito popular), se um dos usu√°rios tentar conceder a ele novos direitos de usu√°rio, o software cliente vai para o armazenamento desse arquivo, mas o arquivo n√£o est√° no lugar certo.  Uma vez que √© movido, isso n√£o funciona.  E o software cliente envia uma mensagem informando que o arquivo est√° quebrado.  No banco de dados, est√° marcado como quebrado.  E todas as informa√ß√µes s√£o exclu√≠das do banco de dados (bem, quase todas). <br><br>  Enquanto isso, nossa rotina de verifica√ß√£o de fragmentos descobre que o arquivo est√° sendo usado.  E envia uma resposta que voc√™ precisa para devolv√™-lo.  Mas todas as informa√ß√µes j√° foram exclu√≠das do banco de dados e √© imposs√≠vel devolv√™-las. <br><br>  Engra√ßado n√©? <br><br>  Ou seja, quando o arquivo foi exclu√≠do, o usu√°rio estava naquele per√≠odo em que o arquivo foi movido, os shards verificados e foi nesse momento que o usu√°rio enviou uma solicita√ß√£o de download. <br><br>  Aqui est√° - alta carga de a√ß√£o, quando as partidas mais incr√≠veis que voc√™ combina. <br><br><img src="https://habrastorage.org/webt/_y/m6/me/_ym6meu2s43ds32d1ngjzspn67k.png"><br><br>  Tendo nos recuperado de surpresa e revertendo tudo, garantimos que os arquivos dos usu√°rios estejam vivos, pois foram restaurados a partir dos discos de outros clientes. <br><br>  Naturalmente, tudo correu bem nos testes, porque, durante o teste, os arquivos mais recentes foram exclu√≠dos com um novo tipo de chave usado nos √∫ltimos 5 anos e n√£o s√£o transferidos para outro local de armazenamento durante o tempo da exclus√£o. <br><br>  Nosso otimismo diminuiu e decidimos n√£o seguir o caminho mais otimista. <br><br><h3>  Retrospectiva </h3><br>  Decidimos que precisamos adicionar testes para diferentes tipos de armazenamento <br>  Adicione uma carga ao perf lab que use chamadas quando removidas do armazenamento <br>  Fechar condi√ß√µes de corrida famosas <br>  Adicionar monitoramento (apesar de estar nos planos, mas n√£o se encaixar no escopo original) <br><br><h3>  Sobre o monitoramento </h3><br>  Eles decidiram fazer o monitoramento imediatamente, mas ele desapareceu em segundo plano, pois era necess√°rio implantar mais rapidamente. <br><br>  Para o monitoramento, o projeto usou o Zabbix, ELK, Grafana, NewRelic, SQL Sentry e uma vers√£o de teste do AppDynamics. <br><br>  Sobre isso, no pef lab estavam o NewRelic e o SQL Sentry. <br><br>  J√° medimos todas as m√©tricas do sistema e, por isso, quer√≠amos medir as m√©tricas de neg√≥cios.  Tive experi√™ncia em organizar esse monitoramento atrav√©s do Zabbix - decidimos fazer o mesmo. <br><br>  O esquema √© muito simples no banco de dados para criar uma tabela na qual coletar as m√©tricas necess√°rias pelo JOB e um procedimento que far√° o upload das m√©tricas coletadas no Zabbix. <br><br>  M√©tricas: <br><br><ul><li>  O n√∫mero de arquivos na fila para exclus√£o em uma base global </li><li>  N√∫mero de arquivos na fila pelo servidor </li><li>  N√∫mero de arquivos enviados ao desinstalador </li><li>  N√∫mero de arquivos exclu√≠dos </li><li>  N√∫mero de eventos FileCorrupt </li><li>  O n√∫mero de arquivos a serem exclu√≠dos em cada shard </li></ul><br>  O monitoramento foi implementado e implantado no produto separadamente, antes de come√ßarem a implantar uma nova implementa√ß√£o de exclus√£o. <br><br><h3>  Nova solu√ß√£o </h3><br>  Em geral, decidimos que era melhor comer demais do que n√£o dormir e fizemos um novo plano. <br><br><ol><li>  verifique no mesmo fragmento que ningu√©m mais usa o arquivo e transfira apenas arquivos n√£o utilizados para o servidor; </li><li>  ao transferir para o servidor, colete todos os arquivos na tabela e verifique se os arquivos n√£o s√£o usados ‚Äã‚Äãnos shards antes de serem colocados na tabela da fila de desenfileiramento; </li><li>  ao usar um arquivo e procur√°-lo no sistema, marque a fila de desenfileiramento na tabela como um arquivo que requer verifica√ß√£o; </li><li>  retornar apenas arquivos para os quais n√£o houve pesquisas; </li><li>  arquivos que foram pesquisados, verifique novamente se h√° fragmentos; </li><li>  em geral, remova a verifica√ß√£o do procedimento que exclui o arquivo, pois ele deve funcionar rapidamente - e o arquivo usado n√£o deve alcan√ß√°-lo em princ√≠pio; </li><li>  leve em considera√ß√£o no procedimento que tudo exclui pelo arquivo batido que est√° em processo de exclus√£o e n√£o exclui as informa√ß√µes nele. </li></ol><br>  O ponto 6 durante a implanta√ß√£o incluiu a remo√ß√£o da verifica√ß√£o em v√°rias etapas.  Primeiro, eles deixaram o cheque e, uma semana depois, o cheque dos arquivos dos funcion√°rios da empresa foi desativado; depois de duas semanas, o cheque foi desativado. <br><br><h3>  O que voc√™ precisou mudar no c√≥digo? </h3><br>  Mais uma vez, todas as altera√ß√µes se aplicam apenas ao banco de dados. <br><br>  A escala das altera√ß√µes foi a maior no servidor global: <br>  Adicione uma tabela intermedi√°ria na qual adicionar todos os arquivos baixados dos shards. <br>  Fa√ßa um JOB que verifique os arquivos na tabela intermedi√°ria que eles n√£o s√£o usados ‚Äã‚Äãnos shards. <br><br>  Na fila de arquivos exclu√≠dos, adicione um campo com a data em que o arquivo foi acessado pela √∫ltima vez e adicione um √≠ndice. <br><br>  Encontre todos os procedimentos com acesso ao arquivo - resultou em 5 procedimentos.  Adicione a eles um bloco alterando a data do √∫ltimo uso na tabela de filas.  A data muda sempre, independentemente de ter sido preenchida ou n√£o. <br><br>  Adicione o programa de exclus√£o aos procedimentos de emiss√£o de arquivos para que ele exiba apenas arquivos com uma data de uso vazia. <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adicione um JOB que colete todos os arquivos com a data de uso e as verifica√ß√µes (com um atraso de 10 minutos, o que √© necess√°rio para que o software cliente possa adicionar o arquivo ao shard, geralmente leva at√© 2 minutos, mas decidiu jogar com seguran√ßa), use o arquivo em todos os shards. Ap√≥s a conclus√£o da verifica√ß√£o, a data de uso √© redefinida para zero se o arquivo n√£o for encontrado, caso contr√°rio, o arquivo ser√° exclu√≠do da fila. Se a data de uso foi alterada durante o processo de verifica√ß√£o, os dados n√£o s√£o alterados, pois sup√µe-se que, enquanto a verifica√ß√£o estava em andamento, o arquivo pudesse ser carregado no fragmento, no qual a verifica√ß√£o j√° havia sido conclu√≠da e era necess√°rio um novo ciclo de verifica√ß√£o para o arquivo. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em fragmentos:</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No procedimento que exclui arquivos da tabela com arquivos exclu√≠dos, foi necess√°rio adicionar uma verifica√ß√£o para verificar se o arquivo n√£o foi usado. </font><font style="vertical-align: inherit;">O procedimento perdeu sua simplicidade e beleza n√£o muito - em DELETE com sa√≠da, eles simplesmente adicionaram NOT EXISTS. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adicionamos um JOB que, em segundo plano, era proveniente dos arquivos de tabela usados ‚Äã‚Äãno servidor.</font></font><br><br><h4>  Testes </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cen√°rios sobre o uso de todas as op√ß√µes de armazenamento foram adicionados aos testes de integra√ß√£o. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eles tamb√©m escreveram novos casos para testar a nova funcionalidade de remo√ß√£o de arquivos. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O Perf Lab adicionou carga ao servidor global. </font><font style="vertical-align: inherit;">Al√©m disso, adicionamos uma carga correspondente √† exclus√£o de arquivos do armazenamento.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Implantar </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Os scripts foram preparados para a aplica√ß√£o e revers√£o de altera√ß√µes no banco de dados. O DBA rolou scripts e, durante o teste de carga, eles n√£o prestaram aten√ß√£o aos bloqueios nas tabelas de filas para excluir arquivos. Como resultado, n√£o corrigimos o √≠ndice, que n√£o era o mais ideal. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por esse motivo, foi necess√°rio desativar as verifica√ß√µes de JOB por intervalos e analisar e adicionar identificadores de arquivos exclu√≠dos manualmente, por arquivos que foram exclu√≠dos no sistema antes da implanta√ß√£o do novo c√≥digo.</font></font><br><br><h3>  Resultados </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como resultado, como resultado da implanta√ß√£o, novos arquivos exclu√≠dos s√£o exclu√≠dos do armazenamento dentro de 24 horas. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Os arquivos exclu√≠dos antes do lan√ßamento do novo sistema foram criados no backup e adicionados √† fila para prod. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como resultado, dados em excesso no S3, no valor de 2 petabytes, foram exclu√≠dos. </font><font style="vertical-align: inherit;">O mesmo aconteceu com os arquivos em servidores clientes dedicados e agora o local deles no servidor coincide com o local exibido nos clientes. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O √≠ndice curvo na tabela da fila ainda vive em prod, a tarefa de alterar o √≠ndice na lista de pend√™ncias, mas ligeiramente adiado devido a tarefas de prioridade mais alta.</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt427895/">https://habr.com/ru/post/pt427895/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt427879/index.html">Como mudei de Python para Julia (e por que)</a></li>
<li><a href="../pt427883/index.html">Apresentando a virtualiza√ß√£o, cont√™ineres e Kubernetes: 18 recursos de nuvem</a></li>
<li><a href="../pt427889/index.html">Errado, errado, errado! m√©todos de mitiga√ß√£o de DDoS</a></li>
<li><a href="../pt427891/index.html">Milh√µes de pessoas podem ser atacadas por vulnerabilidade na plataforma Cisco WebEx Conference</a></li>
<li><a href="../pt427893/index.html">Lola sangrenta em Omega 2 ou Python sufocante no Halloween</a></li>
<li><a href="../pt427897/index.html">Analisando um Resson√¢ncia Magn√©tica II: Metamateriais na RM</a></li>
<li><a href="../pt427899/index.html">JsonWriterSax - uma biblioteca para criar JSON</a></li>
<li><a href="../pt427901/index.html">Como n√£o usar a API de fluxo do Node.js.</a></li>
<li><a href="../pt427905/index.html">Minera√ß√£o de alimentos ou encruzilhada atrav√©s dos olhos de um hacker</a></li>
<li><a href="../pt427907/index.html">Tiro com drone, rake, hackers, autodesenvolvimento e carreira de um fot√≥grafo / vide√≥grafo: novo podcast GLPH</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>