<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üìÑ üï¥üèæ ‚óæÔ∏è Turla Cybergroup Outlook Backdoor-Analyse üìé üí≥ üìö</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Turla (Snake, Uroboros) ist eine Cyberspionagegruppe, die 2008 ber√ºhmt wurde, nachdem sie gesch√ºtzte Objekte gehackt hatte, darunter das Netzwerk des ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Turla Cybergroup Outlook Backdoor-Analyse</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/eset/blog/421399/"><p>  Turla (Snake, Uroboros) ist eine Cyberspionagegruppe, die 2008 ber√ºhmt wurde, nachdem sie gesch√ºtzte Objekte gehackt hatte, darunter das Netzwerk des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Zentralkommandos der US-Streitkr√§fte</a> .  Seitdem ist er auf Angriffe auf milit√§rische Einrichtungen und diplomatische Organisationen auf der ganzen Welt spezialisiert.  Ber√ºhmte Opfer sind das <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">finnische Au√üenministerium</a> 2013 und das <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Schweizer Verteidigungsunternehmen RUAG</a> von 2014 bis 2016.  und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">die Bundesregierung</a> Ende 2017 - Anfang 2018. </p><br><p>  Nach dem j√ºngsten Vorfall ver√∂ffentlichten mehrere Medien Informationen √ºber die Methoden der Angreifer - mithilfe von E-Mail-Anh√§ngen, um Malware zu kontrollieren und gestohlene Daten vom System zu √ºbertragen.  Es wurden jedoch keine technischen Informationen zur Hintert√ºr bereitgestellt.  In diesem Bericht ver√∂ffentlichen wir die Analyse der Turla-Hintert√ºr, die mithilfe von PDF-Anh√§ngen per E-Mail verwaltet wurde. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/l_/db/ws/l_dbws8skuoavwqn1vorwdhobgo.jpeg"></div><a name="habracut"></a><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Medienberichten zufolge</a> waren mehrere Computer des Bundesministeriums f√ºr ausw√§rtige Angelegenheiten mit einer Hintert√ºr infiziert.  Anscheinend begann der Angriff im Jahr 2016 und wurde Ende 2017 von den Sicherheitsdiensten entdeckt. Zun√§chst gef√§hrdeten die Angreifer die Hochschule des Bundes. Danach zogen sie in ihr Netzwerk, bis sie im M√§rz 2017 Zugang zum Netzwerk des Au√üenministeriums erhielten. .  Die Betreiber von Turla hatten etwa ein Jahr lang Zugang zu einigen vertraulichen Daten (z. B. der E-Mail von Mitarbeitern des Bundesau√üenministeriums). </p><br><p>  Unsere Untersuchung ergab auch, dass diese Malware f√ºr Microsoft Outlook gegen verschiedene politische und milit√§rische Abteilungen eingesetzt wurde.  Wir haben daf√ºr gesorgt, dass auch die Au√üenministerien der beiden anderen europ√§ischen L√§nder und der gro√üe Verteidigungsunternehmer kompromittiert wurden.  Unsere Untersuchung erm√∂glichte es uns, Dutzende von E-Mail-Adressen zu ermitteln, die von Turla-Betreibern f√ºr diese Kampagne registriert und verwendet wurden, um exfiltrierte Opferdaten zu erhalten. </p><br><h2>  1. Wichtige Punkte </h2><br><p>  Die Outlook-Hintert√ºr der Turla Group hat zwei Funktionen. </p><br><p>  Erstens ist es der Diebstahl ausgehender Briefe, die an den Angreifer weitergeleitet werden.  Betrifft haupts√§chlich Microsoft Outlook, ist aber auch f√ºr The Bat! Relevant, das in Osteuropa beliebt ist. </p><br><p>  Zweitens die Verwendung von Buchstaben als Transportschicht des C &amp; C-Protokolls.  √úber den Befehl backdoor angeforderte Dateien werden in speziell erstellten PDF-Dokumenten als Anhang zu den Briefen exfiltriert.  Backdoor-Befehle werden auch in PDF-Anh√§ngen gesendet.  Dies erm√∂glicht Geheimhaltung.  Es ist wichtig zu beachten, dass Angreifer keine Sicherheitsl√ºcken in PDF-Readern oder Microsoft Outlook ausnutzen.  Sch√§dliche Software kann Daten aus PDF-Dokumenten dekodieren und als Befehle interpretieren. </p><br><p>  Kampagnenziele sind typisch f√ºr Turla.  Wir haben mehrere europ√§ische Regierungsbeh√∂rden und Verteidigungsunternehmen identifiziert, die von dieser Hintert√ºr betroffen sind.  Es ist wahrscheinlich, dass Angreifer es verwenden, um die Persistenz in Netzwerken mit eingeschr√§nktem Zugriff sicherzustellen, in denen gut konfigurierte Firewalls oder andere Netzwerksicherheitstools die herk√∂mmliche Kommunikation mit C &amp; C-Servern √ºber HTTP (S) effektiv blockieren.  In der folgenden Abbildung sind die Backdoor-Codezeilen aufgef√ºhrt, in denen einige Top-Level-Domains der Regierung erw√§hnt werden.  mfa ist die Dom√§ne des Au√üenministeriums, .gouv ist eine Subdom√§ne der franz√∂sischen Regierung (.gouv.fr), ocse ist die Organisation f√ºr Sicherheit und Zusammenarbeit in Europa. </p><br><img src="https://habrastorage.org/webt/xt/ix/e9/xtixe9vxop-os9ktobaea5qqdbu.png"><br><p>  <i>Abbildung 1. Dom√§nen im Zusammenhang mit √∂ffentlichen Diensten im Malvari-Code</i> </p><br><p>  Basierend auf den Analyse- und Telemetriedaten haben wir festgestellt, dass diese Hintert√ºr seit mindestens 2013 in freier Wildbahn verbreitet ist.  Wie immer bei Turla k√∂nnen wir uns nicht auf Kompilierungszeitstempel konzentrieren, da diese normalerweise gef√§lscht sind.  Wir glauben jedoch, dass die ersten Versionen vor 2013 kompiliert wurden, da die diesj√§hrige Version bereits ziemlich weit fortgeschritten war.  Danach fanden wir eine Version, die der Basisversion √§hnlicher war und deren Zusammenstellung 2009 datiert war.  Die genaue Ver√∂ffentlichung ist noch nicht m√∂glich.  Die folgende Zeitleiste basiert auf unserer Telemetrie und Daten aus offenen Quellen: </p><br><p>  <b>2009</b> : Kompilierungszeitstempel (m√∂glicherweise gef√§lscht) der Basisversion der Outlook-Hintert√ºr.  Nur Momentaufnahme des E-Mail-Inhalts. <br>  <b>2013</b> : Verbessert: Backdoor kann Befehle ausf√ºhren.  Sie werden im XML-Format per E-Mail gesendet. <br>  <b>2013</b> : Die neueste bekannte Version f√ºr The Bat! .. <br>  <b>2016</b> : Verbessert: Teams werden als Anh√§nge in speziell erstellten PDF-Dokumenten gesendet. <br>  <b>2017</b> : Verbessert: Eine Hintert√ºr kann PDF-Dokumente erstellen, um Daten eines Angreifers zu filtern. <br>  <b>M√§rz 2018</b> : Berichterstattung √ºber einen Kompromiss des deutschen Regierungsnetzwerks. <br>  <b>April 2018</b> : Verbessert: Backdoor kann PowerShell-Befehle mit Empire PSInject ausf√ºhren. </p><br><h2>  2. Globale Architektur </h2><br><p>  In neueren Versionen ist die Hintert√ºr eine eigenst√§ndige DLL, in der Code f√ºr die Selbstinstallation und Interaktion mit Outlook und The Bat!, E-Mail-Clients, enthalten ist, auch wenn nur die Installation f√ºr Outlook implementiert ist.  Es kann problemlos von jeder Turla-Komponente gel√∂scht werden, mit der Sie zus√§tzliche Prozesse ausf√ºhren k√∂nnen. </p><br><p>  In diesem Abschnitt basiert unsere Analyse auf einer Stichprobe, die im ersten Halbjahr 2017 ver√∂ffentlicht wurde.  Informationen zu √§lteren oder neueren Mustern k√∂nnen enthalten sein. </p><br><h3>  2.1.  Installation </h3><br><p>  Um eine Hintert√ºr einzurichten, exportieren Angreifer eine DLL namens Install oder registrieren sie bei regsvr32.exe.  Das Argument ist der Ziel-E-Mail-Client.  Die folgende Abbildung zeigt die m√∂glichen Werte.  In den neuesten Versionen ist nur die Installation f√ºr Outlook implementiert. </p><br><img src="https://habrastorage.org/webt/9g/8r/qm/9g8rqm3z7keq_phkhvlztwzwtyo.png"><br><p>  <i>Abbildung 2. M√∂gliche Installationsargumente</i> </p><br><p>  Da es keinen fest codierten Pfad gibt, kann sich die DLL-Datei an einer beliebigen Stelle auf der Festplatte befinden. </p><br><h4>  2.1.1.  Microsoft Outlook </h4><br><p>  Turla-Entwickler verlassen sich auf die Entf√ºhrung von COM-Objekten, um die Persistenz von Malware sicherzustellen.  Dies ist eine bekannte Methode, die seit vielen Jahren in freier Wildbahn angewendet wird, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">auch von der Turla-Gruppe</a> .  Die Methode besteht im Wesentlichen darin, das von der Zielanwendung verwendete COM-Objekt umzuleiten, indem der entsprechende CLSID-Eintrag in der Windows-Registrierung ge√§ndert wird. </p><br><p>  In unserem Fall wurden die folgenden √Ñnderungen an der Windows-Registrierung vorgenommen: </p><br><pre><code class="hljs powershell">HKCU\Software\Classes\CLSID\{<span class="hljs-number"><span class="hljs-number">49</span></span>CBB1C7<span class="hljs-literal"><span class="hljs-literal">-97D1</span></span><span class="hljs-literal"><span class="hljs-literal">-485A</span></span><span class="hljs-literal"><span class="hljs-literal">-9EC1</span></span><span class="hljs-literal"><span class="hljs-literal">-A26065633066</span></span>} = Mail Plugin HKCU\Software\Classes\CLSID\{<span class="hljs-number"><span class="hljs-number">49</span></span>CBB1C7<span class="hljs-literal"><span class="hljs-literal">-97D1</span></span><span class="hljs-literal"><span class="hljs-literal">-485A</span></span><span class="hljs-literal"><span class="hljs-literal">-9EC1</span></span><span class="hljs-literal"><span class="hljs-literal">-A26065633066</span></span>}\InprocServer32 = [<span class="hljs-type"><span class="hljs-type">Path</span></span> <span class="hljs-type"><span class="hljs-type">to</span></span> <span class="hljs-type"><span class="hljs-type">the</span></span> <span class="hljs-type"><span class="hljs-type">backdoor</span></span> <span class="hljs-type"><span class="hljs-type">DLL</span></span>] HKCU\Software\Classes\CLSID\{<span class="hljs-number"><span class="hljs-number">49</span></span>CBB1C7<span class="hljs-literal"><span class="hljs-literal">-97D1</span></span><span class="hljs-literal"><span class="hljs-literal">-485A</span></span><span class="hljs-literal"><span class="hljs-literal">-9EC1</span></span><span class="hljs-literal"><span class="hljs-literal">-A26065633066</span></span>}\InprocServer32\ThreadingModel = Apartment HKCU\Software\Classes\CLSID\{<span class="hljs-number"><span class="hljs-number">84</span></span>DA0A92<span class="hljs-literal"><span class="hljs-literal">-25E0</span></span><span class="hljs-literal"><span class="hljs-literal">-11D3</span></span><span class="hljs-literal"><span class="hljs-literal">-B9F7</span></span><span class="hljs-literal"><span class="hljs-literal">-00C04F4C8F5D</span></span>}\TreatAs = {<span class="hljs-number"><span class="hljs-number">49</span></span>CBB1C7<span class="hljs-literal"><span class="hljs-literal">-97D1</span></span><span class="hljs-literal"><span class="hljs-literal">-485A</span></span><span class="hljs-literal"><span class="hljs-literal">-9EC1</span></span><span class="hljs-literal"><span class="hljs-literal">-A26065633066</span></span>}</code> </pre> <br><p>  <code>{84DA0A92-25E0-11D3-B9F7-00C04F4C8F5D}</code> - erfasste CLSID.  Es entspricht dem Outlook Protocol Manager und l√§dt theoretisch die legitime Outlook DLL <code>OLMAPI32.DLL</code> .  <code>{49CBB1C7-97D1-485A-9EC1-A26065633066}</code> keiner bekannten Software zugeordnet.  Diese CLSID ist beliebig und wird nur als Platzhalter f√ºr die COM-Umleitung verwendet. </p><br><p>  Wenn die √Ñnderung abgeschlossen ist, wird die Backdoor-DLL jedes Mal geladen, wenn Outlook sein COM-Objekt l√§dt.  Nach unseren Beobachtungen geschieht dies beim Start von Outlook. </p><br><p>  F√ºr die COM-Umleitung sind keine Administratorrechte erforderlich, da sie nur f√ºr den aktuellen Benutzer gilt.  Es sind Schutzma√ünahmen vorhanden, um solche b√∂swilligen Weiterleitungen zu verhindern.  Laut <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">MSDN</a> : ‚ÄûUnter Windows Vista und Windows Server 2008 ignoriert die COM-Laufzeit die COM-Konfiguration des Benutzers und greift nur auf die COM-Konfiguration f√ºr jeden Computer zu, wenn die Prozessintegrit√§tsstufe √ºber dem Durchschnitt liegt.‚Äú </p><br><p>  Der Outlook-Prozess wird mit mittlerer Integrit√§t ausgef√ºhrt (siehe Abbildung unten).  Daher ist es nicht f√ºr jeden Benutzer vor COM-Weiterleitung gesch√ºtzt. </p><br><img src="https://habrastorage.org/webt/q4/uq/zt/q4uqzt_g3c6vgonoluf_7ttrqpw.png"><br><p>  <i>Abbildung 3. Integrit√§tsstufe des Outlook-Prozesses</i> </p><br><p>  Durch die Verwendung der Erfassung von COM-Objekten kann die Hintert√ºr nicht <code>C:\Users\User\Documents\mapid.tlb</code> , da der Pfad zur Hintert√ºr (in unserem Beispiel <code>C:\Users\User\Documents\mapid.tlb</code> ) nicht in der Liste der Plugins angezeigt wird, wie in der folgenden Abbildung dargestellt. </p><br><img src="https://habrastorage.org/webt/4l/cj/s3/4lcjs3tai1gd5gopfekwd7skjra.png"><br><p>  <i>Abbildung 4. Liste der Outlook-Plugins - mapid.tlb wird nicht angezeigt</i> </p><br><p>  Auch wenn das Schadprogramm nicht in der Liste der Add-Ons angezeigt wird, wird die Standard-Microsoft-API - MAPI (Messaging Application Programming Interface) f√ºr die Interaktion mit Outlook verwendet. </p><br><h4>  2.1.2.  Die Fledermaus! </h4><br><p>  Wie in der Chronologie angegeben, enthalten die neuesten Versionen der Backdoor nicht mehr den Registrierungscode f√ºr das Plugin The Bat! ... Der gesamte Code f√ºr die Verwaltung von Postf√§chern und Nachrichten ist jedoch weiterhin vorhanden.  Bei Bedarf kann es manuell konfiguriert werden. </p><br><p>  Um sich als Plugin f√ºr The Bat zu registrieren!  Die Malware hat die <code>%appdata%\The Bat!\Mail\TBPlugin.INI</code> .  Dies ist eine legitime M√∂glichkeit, ein Plugin f√ºr The Bat! Zu registrieren. Einige Plugins (z. B. Antispam) verwenden es ebenfalls. </p><br><p>  Nachdem Sie sich jedes Mal registriert haben, wenn Sie The Bat!  Die Backdoor-DLL wird aufgerufen.  Die folgende Abbildung zeigt, wie die DLL den f√ºr Plugins erforderlichen Export implementiert. </p><br><img src="https://habrastorage.org/webt/xq/x7/zs/xqx7zsv5pwjjmhonegcsmpmnwx0.png"><br><p>  <i>Abbildung 5. Standardexport f√ºr das Bat! Plugin</i> </p><br><h3>  2.2.  Interaktion mit dem Mail-Client </h3><br><p>  Die Interaktion mit dem Mail-Client h√§ngt vom Ziel ab. </p><br><h4>  2.2.1.  Microsoft Outlook </h4><br><p>  Microsoft unterst√ºtzt die Messaging Application Programming Interface (MAPI), mit der Anwendungen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">mit Outlook interagieren k√∂nnen</a> .  Die Turla-Hintert√ºr verwendet diese API, um auf die Postf√§cher eines Benutzers / von Benutzern eines gef√§hrdeten Systems zuzugreifen und diese zu verwalten. </p><br><p>  Zun√§chst stellt die Hintert√ºr mithilfe von MAPILogonEx eine Verbindung zum Nachrichtensystem her, wie in der Abbildung dargestellt. </p><br><img src="https://habrastorage.org/webt/nf/fp/u1/nffpu1duhw9u7rmxytdm1chwpey.png"><br><p>  <i>Abbildung 6. MAPI-Anmeldung</i> </p><br><p>  Der zweite Parameter (lpszProfileName) ist leer, das Flag <code>MAPI_USE_DEFAULT</code> ist <code>MAPI_USE_DEFAULT</code> .  In der Dokumentation hei√üt es: "Das Messaging-Subsystem muss den Standardprofilnamen f√ºr den Parameter <code>MAPI_EXPLICIT_PROFILE</code> √ºberschreiben. Das Flag <code>MAPI_EXPLICIT_PROFILE</code> ignoriert, es sei denn, lpszProfileName ist NULL oder leer." </p><br><p>  Im Gegensatz dazu ist das <code>MAPI_NEW_SESSION</code> Flag nicht gesetzt.  In der Dokumentation hei√üt es: "Der Parameter <code>lpszProfileName</code> ignoriert, wenn eine vorherige Sitzung namens MapiLogonEx mit <code>MAPI_ALLOW_OTHERS</code> Flag MAPI_ALLOW_OTHERS existiert und wenn das Flag <code>MAPI_NEW_SESSION</code> nicht gesetzt ist." </p><br><p>  Unserer Meinung nach √∂ffnet Outlook eine Standardsitzung mit dem Flag <code>MAPI_ALLOW_OTHERS</code> .  Daher verwendet die Hintert√ºr eine zuvor ge√∂ffnete Sitzung, um Zugriff auf das Standardprofil des Postfachs zu erhalten.  Dies erkl√§rt das Fehlen einer Anfrage nach Benutzername und Passwort bei der Initialisierung des Backdoor-Plugins. </p><br><p>  Anschlie√üend erh√§lt die Hintert√ºr Zugriff auf die Mailbox und kann diese problemlos mit anderen MAPI-Funktionen verwalten.  Es durchl√§uft verschiedene Nachrichtenspeicher, analysiert Briefe und f√ºgt eingehenden und ausgehenden Nachrichten R√ºckrufe hinzu.  Die Protokolldatei zeigt diesen Prozess an (Benutzername und Adresse ge√§ndert): </p><br><pre> <code class="hljs pgsql">&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; ========= Analyzing msg store ( <span class="hljs-number"><span class="hljs-number">1</span></span> / <span class="hljs-number"><span class="hljs-number">1</span></span> ) ========= Service <span class="hljs-type"><span class="hljs-type">name</span></span>:MSUPST MS Pst <span class="hljs-type"><span class="hljs-type">path</span></span>:C:\Users\[username]\Documents\Outlook Files\[email address].pst Wait main <span class="hljs-keyword"><span class="hljs-keyword">window</span></span> <span class="hljs-keyword"><span class="hljs-keyword">before</span></span> <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> <span class="hljs-keyword"><span class="hljs-keyword">current</span></span> store <span class="hljs-keyword"><span class="hljs-keyword">Loop</span></span> count = <span class="hljs-number"><span class="hljs-number">46</span></span> This <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> message store PUSH store <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> list &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; _____________ FOLDERS _____________ Setting sink <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> folders <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> stores. ========Process msg store ( <span class="hljs-number"><span class="hljs-number">1</span></span> / <span class="hljs-number"><span class="hljs-number">1</span></span> ) ========= Account: [email address] Successfull <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> sink <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> Outbox folder <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-keyword"><span class="hljs-keyword">current</span></span> store. Successfull <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> sink <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> Inbox folder <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-keyword"><span class="hljs-keyword">current</span></span> store.</code> </pre> <br><p>  Mit der Funktion <code>HrAllocAdviseSink</code> in jedem Posteingang und <code>HrAllocAdviseSink</code> ein R√ºckruf <code>HrAllocAdviseSink</code> Abbildung). </p><br><img src="https://habrastorage.org/webt/ud/df/js/uddfjs5ub7qj9n3gxlxslirppcq.png"><br><p>  <i>Abbildung 7. Registrieren eines R√ºckrufs im Postausgang</i> </p><br><p>  <b>2.2.1.1.</b>  <b>R√ºckruf-Posteingang</b> </p><br><p>  Der R√ºckruf im Posteingang zeichnet die Metadaten der eingehenden Nachricht auf, einschlie√ülich Absender- und Empf√§ngeradressen, Betreff- und Anhangsnamen.  Beispiel unten (Entwickler-Rechtschreibung gespeichert): </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">RECIVE</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>&gt;{ <span class="hljs-attribute"><span class="hljs-attribute">From</span></span>: sender@example.com To: receiver@example.net Cc: Bcc: Subj: Mail subject Att: an_attachment.pdf }</code> </pre> <br><p>  Anschlie√üend analysiert er den Brief und die Anh√§nge zum Thema Teams der Angreifer.  Diese Funktion ist in Abschnitt 2.3 beschrieben. </p><br><p>  Schlie√ülich werden NDRs abgefangen, indem eingehende Nachrichten mit der E-Mail-Adresse des Betreibers √ºberpr√ºft werden.  Jeder Brief mit der Adresse des Betreibers wird abgelehnt.  Dies kann zu Problemen f√ºhren, wenn das Opfer den Verdacht hat, dass etwas nicht stimmt, und sich an den Support-Service wendet, ohne die Antworten zu sehen. </p><br><p>  <b>2.2.1.2.</b>  <b>R√ºckruf im Postausgang</b> </p><br><p>  Wie im Posteingang zeichnet der Postausgang die Metadaten aller gesendeten E-Mails auf.  Der folgende Datensatz wird generiert (Bedieneradresse ge√§ndert): </p><br><pre> <code class="hljs css">21<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:57</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:56</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SEND</span></span> &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>{ <span class="hljs-attribute"><span class="hljs-attribute">From</span></span>: To: recipient@example.com Cc: Bcc: Subj: My title Att: [<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-string"><span class="hljs-string">"last_presentation.pdf"</span></span> } 21<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:57</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:56</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Sending</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">data</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">message</span></span> 21<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:57</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:56</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Message</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ENTRYID</span></span>: <span class="hljs-selector-attr"><span class="hljs-selector-attr">[Message ENTRYID]</span></span> 21<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:57</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:56</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Data</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">message</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">was</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">send</span></span>. <span class="hljs-selector-tag"><span class="hljs-selector-tag">To</span></span>: <span class="hljs-selector-attr"><span class="hljs-selector-attr">[redacted]</span></span>@<span class="hljs-keyword"><span class="hljs-keyword">gmx</span></span>[.]<span class="hljs-keyword"><span class="hljs-keyword">com</span></span> From: Subj: My title <span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">57</span></span>:<span class="hljs-number"><span class="hljs-number">56</span></span> Set last time. <span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">57</span></span>:<span class="hljs-number"><span class="hljs-number">56</span></span> Spawned thread for cleaning up outgoing messages (id <span class="hljs-number"><span class="hljs-number">2848</span></span>) <span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">34</span></span> Ending work, client: Outlook <span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">34</span></span> Number of messages to remove: <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">34</span></span> Message ENTRYID: [Message ENTRYID] <span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">34</span></span> DeleteMessages executed successfully. <span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">34</span></span> Number of not removed messages: <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br><p>  M√∂glicherweise stellen Sie fest, dass jede ausgehende Nachricht an die Adresse des Angreifers <code>[‚Ä¶]@gmx[.]com</code> .  GMX - ein beliebter kostenloser E-Mail-Dienst;  Die Angreifer haben sich wahrscheinlich daf√ºr entschieden, weil Organisationen die Domain gmx.com normalerweise nicht blockieren. </p><br><p>  Diese E-Mail-Adresse ist in dem von uns untersuchten Beispiel fest codiert (siehe Abbildung unten).  Es kann jedoch mit einer der Backdoor-Funktionen aktualisiert werden.  Angreifer scheinen mindestens eine E-Mail-Adresse f√ºr jedes Ziel zu registrieren <br>  Organisationen, die das Format <code>firstname.lastname@gmx[.]com</code> mit dem Namen des tats√§chlichen Mitarbeiters verwenden.  Dies vermeidet die Erkennung, da es oft schwierig ist, eine solche Adresse von der pers√∂nlichen Mailbox eines echten Mitarbeiters zu unterscheiden.  Zum Zeitpunkt der Probenanalyse im Juni 2018 war die Adresse nicht verf√ºgbar. </p><br><img src="https://habrastorage.org/webt/9c/tr/-d/9ctr-dcusp0p35kcuhiqw4pypns.png"><br><p>  <i>Abbildung 8. Fest codierte Adresse der Operatoren</i> </p><br><p>  Die Hintert√ºr sendet in bestimmten Abst√§nden Berichte an die Adresse der Bediener.  Der Bericht enth√§lt eindeutige Kennungen, einschlie√ülich der MAC-Adresse, der vollst√§ndigen Protokolldatei und gegebenenfalls der Befehlsergebnisse.  Anschlie√üend werden die Daten mit MISTY1 verschl√ºsselt, wie in Abschnitt 2.3.2.2 beschrieben, und eine g√ºltige PDF-Datei mit verschl√ºsseltem Inhalt erstellt.  Vor diesem verschl√ºsselten Daten-Blob enth√§lt das Dokument ein wei√ües 1x1-Bild in JPEG, das in einem Schadprogramm fest codiert ist.  Auf diese Weise k√∂nnen Sie eine g√ºltige PDF-Datei erstellen, die beim √ñffnen nur eine leere Seite anzeigt. </p><br><p>  Schlie√ülich h√§ngt die Hintert√ºr das PDF an und sendet eine E-Mail an die Angreifer.  Die folgende Abbildung zeigt ein Beispiel f√ºr eine PDF-Datei, die von einer Hintert√ºr erstellt wurde. </p><br><img src="https://habrastorage.org/webt/d4/6f/yx/d46fyxd9n7e-ziu9jwjxdtedqke.png"><br><p>  <i>Abbildung 9. Beginn eines PDF-Dokuments, das von einer Hintert√ºr erstellt wurde, um Daten zu filtern</i> </p><br><p>  Der Bericht wird √ºber die R√ºckruffunktion im Postausgang gesendet.  Dies bedeutet, dass der Brief gleichzeitig mit dem Senden legitimer Benutzernachrichten hinterlassen wird.  Die Hintert√ºr kann keine Briefe mit gestohlenen Daten zu einem f√ºr den Benutzer ungew√∂hnlichen Zeitpunkt senden und vermeidet daher die Erkennung.  Dank Stealth ist dieser Kontroll- und Kontrollmechanismus in freier Wildbahn sehr schwer zu erkennen. </p><br><h4>  2.2.2.  Verschleierung b√∂swilligen Benutzerverhaltens </h4><br><p>  Da die Hintert√ºr funktioniert, wenn der Benutzer mit dem Computer und Outlook arbeitet, versucht die Malware, b√∂swillige Aktivit√§ten zu verbergen, z. B. eingehende Nachrichten von Betreibern. </p><br><p>  Zun√§chst einmal l√∂scht eine Hintert√ºr immer E-Mails, die an Betreiber gesendet oder von diesen empfangen wurden.  Wie in der folgenden Abbildung gezeigt, k√∂nnen Sie einige Sekunden lang sehen, dass eine neue Nachricht angezeigt wurde, die jedoch nicht im Postfach angezeigt wird. </p><br><img src="https://habrastorage.org/webt/o7/pc/wh/o7pcwhrtwemk2qfqrfdtgjb6p0o.png"><br><p>  <i>Abbildung 10. Ungelesene Nachricht</i> </p><br><p>  Zweitens f√§ngt die Hintert√ºr die <code>CreateWindowsEx</code> , wie in den folgenden Abbildungen gezeigt.  Dies verhindert die Erstellung von Fenstern wie NetUIHWND, die Outlook f√ºr Benachrichtigungen verwendet, die unten rechts auf dem Bildschirm angezeigt werden. </p><br><img src="https://habrastorage.org/webt/7y/wn/xq/7ywnxqshbevin9-ncsw8lhprkvo.png"><br><p>  <i>Abbildung 11. Konfigurieren der Erfassung der CreateWindowsEx-Funktion</i> </p><br><img src="https://habrastorage.org/webt/ki/1_/zr/ki1_zrks5vaspkm-bpz2j-z9asu.png"><br><p>  <i>Abbildung 12. Intercept CreateWindowsEx</i> </p><br><p>  Die folgende Abbildung zeigt ein Beispiel f√ºr das NetUIHWND-Fenster, das normalerweise auf dem Desktop angezeigt wird, wenn eine neue Nachricht empfangen wird.  Aufgrund des Abfangens von <code>CreateWindowEx</code> wird keine Benachrichtigung angezeigt, wenn Angreifer einen Brief an die Hintert√ºr senden. </p><br><img src="https://habrastorage.org/webt/bd/5n/3b/bd5n3bq_pijmhlosvf6muvjcyjq.png"><br><p>  <i>Abbildung 13. Benachrichtigung √ºber neue Nachrichten</i> </p><br><h4>  2.2.3.  Die Fledermaus! </h4><br><p>  Trotz der Tatsache, dass die Registrierungsfunktion des Plugins f√ºr The Bat!  existiert nicht mehr, es gibt geerbten Code, der die gleichen Funktionen wie f√ºr Outlook mit der The Bat! -API ausf√ºhrt. </p><br><p>  Wie in der folgenden Abbildung gezeigt, verwendet die Hintert√ºr den Kommunikationskanal mit The Bat!, Um Benutzerinformationen zu empfangen, Briefe zu lesen und zu senden.  Alle anderen Funktionen, die beispielsweise zum Protokollieren von Nachrichten oder zum Ausf√ºhren von Befehlen verwendet werden, sind jedoch mit Outlook identisch. </p><br><img src="https://habrastorage.org/webt/iy/qb/ub/iyqbubrelp4uwudy8n4gby7n6lq.png"><br><p>  <i>Abbildung 14. Der Bat! -Kanal</i> </p><br><h3>  2.3.  Hintert√ºr </h3><br><p>  Wie im vorherigen Abschnitt gezeigt, kann Malware Nachrichten verarbeiten und filtern.  Gleichzeitig ist es eine voll funktionsf√§hige E-Mail-gesteuerte Hintert√ºr, die unabh√§ngig von jeder anderen Turla-Komponente funktionieren kann.  Die Hintert√ºr ben√∂tigt keine permanente Internetverbindung und kann auf jedem Computer verwendet werden, der Nachrichten an externe Adressen sendet.  Dies ist in streng kontrollierten Netzwerken n√ºtzlich, beispielsweise durch Filtern des Internetverkehrs.  Selbst wenn die E-Mail-Adresse des Angreifers inaktiv ist, k√∂nnen sie die Kontrolle wiedererlangen, indem sie einen Befehl von einer anderen Adresse senden.  In diesem Fall wird der Brief auch f√ºr den Benutzer ausgeblendet, da er Befehle enth√§lt, die von der Hintert√ºr interpretiert werden.  Daher ist eine Hintert√ºr so fehlertolerant wie ein Rootkit, das den eingehenden Netzwerkverkehr √ºberpr√ºft. </p><br><h4>  2.3.1.  PDF-Format </h4><br><p>  Anfang 2018 gaben mehrere Medien an, dass Turla-Betreiber E-Mail-Anh√§nge verwenden, um infizierte Computer zu verwalten.  Die Medien hatten recht.  Eine Analyse der Turla Outlook-Hintert√ºr ergab, wie Befehle gesendet und interpretiert werden. </p><br><p>  Befehle werden per E-Mail mit speziell erstellten PDF-Anh√§ngen gesendet.  Wir konnten kein echtes Beispiel-PDF mit Befehlen finden, aber dies sind wahrscheinlich g√ºltige PDF-Dokumente sowie PDF-Dateien, die von der Hintert√ºr zur Exfiltration erstellt wurden. </p><br><p>  Aus PDF-Dokumenten kann eine Hintert√ºr das wiederherstellen, was Bediener einen Container in Magazinen nennen.  Dies ist ein Blob mit einem speziellen Format, das verschl√ºsselte Befehle f√ºr die Hintert√ºr enth√§lt.  Die folgende Abbildung zeigt die Vorgehensweise zum Entfernen dieses Beh√§lters.  Technisch gesehen muss die Anwendung kein g√ºltiges PDF-Dokument sein.  Die einzige Voraussetzung ist, dass der Container im richtigen Format enthalten ist. </p><br><img src="https://habrastorage.org/webt/hb/r_/yf/hbr_yfy47qewou5f_tqbrpdn5ck.png"><br><p>  <i>Abbildung 15. Extrahieren des Befehlscontainers aus der PDF</i> </p><br><p>  Der Container hat eine komplexe Struktur mit vielen verschiedenen Pr√ºfungen.  Es k√∂nnte entworfen werden, um Kommunikationsfehler zu vermeiden, aber wir glauben, dass die Struktur haupts√§chlich geschaffen wurde, um dem Reverse Engineering entgegenzuwirken.  Die Struktur des Containers ist in der folgenden Abbildung dargestellt. </p><br><img src="https://habrastorage.org/webt/ud/aa/6w/udaa6wvubnjskhmfrgsoalfke70.png"><br><p>  <i>Abbildung 16. Befehlscontainerstruktur</i> </p><br><p>  Unmittelbar vor dem Initialisierungsvektor befindet sich eine Liste von Befehlsdeskriptoren.  In der Tabelle sind verschiedene ID-Werte dargestellt: </p><br><img src="https://habrastorage.org/webt/jy/sg/5o/jysg5opuoyhwir5hre-xi9quhxq.png"><br><p><br>  Die ID-Deskriptoren 2 und 4 werden verwendet, um die Verschl√ºsselungs- und Dekomprimierungsfunktionen zu extrahieren, wie in der folgenden Abbildung gezeigt.  Das Schadprogramm implementiert jedoch nur einen Verschl√ºsselungsalgorithmus und einen Komprimierungsalgorithmus.  Der einzige Zweck dieser Felder besteht daher darin, die Analyse der Hintert√ºr zu erschweren. </p><br><img src="https://habrastorage.org/webt/h8/sh/gu/h8shgunmwafcbx6h1shccn9-ndo.png"><br><p>  <i>Abbildung 17. Offset-Dekomprimierungs- und Entschl√ºsselungsfunktionen</i> </p><br><p>  Teams befinden sich im letzten Teil der Struktur.  Sie werden mit MISTY1 verschl√ºsselt und mit bzip2 komprimiert.  Es kann viele verschiedene Befehle in derselben PDF-Datei geben, und jeder kann mehrere Argumente haben. </p><br><h4>  2.3.2.  Kryptographie </h4><br><p>  Hier beschreiben wir die verwendeten Verschl√ºsselungsalgorithmen. </p><br><p>  <b>2.3.2.1.</b>  <b>XOR-Verschl√ºsselung</b> </p><br><p>  Ein Teil des Containers (beginnend mit dem ersten CRC32) wird mit XOR mit dem von der benutzerdefinierten Funktion generierten Bytestream verschl√ºsselt.  Es wird ein <code>srand</code> ben√∂tigt, der an <code>srand</code> , um durch Aufrufen von rand eine zweite Nummer zu generieren.  Der zweite Startwert wird in der unten gezeigten Funktion als Argument f√ºr die Daten in XOR verwendet. </p><br><pre> <code class="hljs powershell">int __usercall F_bytestream_xor<span class="hljs-selector-tag"><span class="hljs-selector-tag">@</span></span>&lt;eax&gt;(unsigned int len<span class="hljs-selector-tag"><span class="hljs-selector-tag">@</span></span>&lt;edx&gt;, int ciphertext<span class="hljs-selector-tag"><span class="hljs-selector-tag">@</span></span>&lt;ecx&gt;, unsigned int seed) { unsigned int v3; // ebx int v4; // esi unsigned int v5; // edi int result; // eax unsigned int v7; // ecx char *v8; // edx unsigned int v9; // esi byte key[<span class="hljs-number"><span class="hljs-number">512</span></span>]; // [<span class="hljs-type"><span class="hljs-type">esp</span></span>+<span class="hljs-type"><span class="hljs-type">Ch</span></span>] [<span class="hljs-type"><span class="hljs-type">ebp</span></span>-<span class="hljs-number"><span class="hljs-number">204</span></span><span class="hljs-type"><span class="hljs-type">h</span></span>] char *v11; // [<span class="hljs-type"><span class="hljs-type">esp</span></span>+<span class="hljs-number"><span class="hljs-number">20</span></span><span class="hljs-type"><span class="hljs-type">Ch</span></span>] [<span class="hljs-type"><span class="hljs-type">ebp</span></span>-<span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-type"><span class="hljs-type">h</span></span>] v3 = len; v11 = (char *)ciphertext; srand(seed); v4 = <span class="hljs-number"><span class="hljs-number">0</span></span>; v5 = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { result = rand(); *(_DWORD *)&amp;key[<span class="hljs-number"><span class="hljs-number">4</span></span> * <span class="hljs-type"><span class="hljs-type">v5</span></span>++] = result; } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ( v5 &lt; <span class="hljs-number"><span class="hljs-number">128</span></span> ); v7 = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !v3 ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; v8 = v11; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { v8[<span class="hljs-type"><span class="hljs-type">v7</span></span>] ^= key[<span class="hljs-type"><span class="hljs-type">v4</span></span>]; v9 = v4 + <span class="hljs-number"><span class="hljs-number">1</span></span>; result = -(v9 &lt; <span class="hljs-number"><span class="hljs-number">512</span></span>); v4 = result &amp; v9; ++v7; } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ( v7 &lt; v3 ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre> <br><p>  <strong>2.3.2.2.</strong>  <strong>MISTY1</strong> </p><br><p>  Turla-Entwickler bevorzugen es, weniger gebr√§uchliche oder modifizierte Verschl√ºsselungsalgorithmen in ihren Backdoors zu verwenden: </p><br><ul><li>  in <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Kohlenstoff und Schlange</a> - CAST-128 </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Gazer</a> - benutzerdefinierte RSA-Implementierung </li><li>  in <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Mosquito</a> - Blum Blum Shub als Zufallszahlengenerator f√ºr XOR-Byte-Stream </li><li>  im Rootkit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Uroburos</a> - eine modifizierte Version von ThreeFish </li></ul><br><p>  In der Outlook-Hintert√ºr implementierten sie MISTY1, einen symmetrischen Verschl√ºsselungsalgorithmus, der 1995 von Kryptographen von Mitsubishi Electric entwickelt wurde.  Es hat die folgenden Eigenschaften: </p><br><ul><li>  ist symmetrisch </li><li>  hat einen 128-Bit-Schl√ºssel </li><li>  verwendet zwei vorberechnete Tabellen: s7 (128 Byte) und s9 (2048 Byte) </li><li>  verwendet drei Funktionen: FL, FO, FI <br>  o FL f√ºhrt einige XOR-Operationen zwischen dem Schreiben von Bytes und dem erweiterten Schl√ºssel aus <br>  o FO f√ºhrt XOR-Operationen zwischen dem Datensatz und dem erweiterten Schl√ºssel aus und verwendet auch FI <br>  o FI f√ºhrt eine nichtlineare Erweiterung mit s7 und s9 durch </li><li>  arbeitet mit Bl√∂cken von 64 Bit </li><li>  f√ºhrt acht Zyklen durch (Zyklus - FO-Funktion aufrufen) </li><li>  verwendet Feistel-Chiffre </li></ul><br><img src="https://habrastorage.org/webt/jf/d4/_i/jfd4_iplej2iexnsc2pkxkeracy.png"><br><p>  <em>Abbildung 18. MISTY1</em> </p><br><img src="https://habrastorage.org/webt/08/qc/_h/08qc_hxb2xju1yxbfsqmizuocwy.png"><br><p>  <em>Abbildung 19. Acht Zyklen f√ºr die Blockverschl√ºsselung</em> </p><br><p>  Turla-Entwickler haben den Algorithmus leicht modifiziert: </p><br><ul><li>  f√ºgte der FI-Funktion zwei XOR-Operationen hinzu, wie in der folgenden Abbildung gezeigt </li><li>  Ein 128-Bit-Schl√ºssel wird aus zwei fest codierten 1024-Bit-Schl√ºsseln plus einem 2048-Bit-Initialisierungsvektor generiert </li><li>  ge√§nderte Tabellen s7 und s9.  Dies st√∂rt den Betrieb aller Tools, die kryptografische Algorithmen basierend auf S-Tabellenwerten erkennen.  Sowohl modifizierte als auch urspr√ºngliche S-Tabellen enthalten dieselben Werte, sie wurden einfach gemischt </li></ul><br><img src="https://habrastorage.org/webt/74/ge/qg/74geqg_tqugk_mgizdhn07hrcp0.png"><br><p>  <em>Abbildung 20. Vergleich der FI-Funktionen (Original links, Turla-Entwicklung rechts)</em> </p><br><h4 id="233-funkcii">  2.3.3.  Funktionen </h4><br><p>  Die Hintert√ºr hat viele Funktionen, vom Filtern von Dateien bis zum Ausf√ºhren von Befehlen.  Die Beschreibung der verschiedenen Funktionen finden Sie in der folgenden Tabelle. </p><br><img src="https://habrastorage.org/webt/zk/ij/od/zkijodwltfd9en0cxuya189_758.png"><br><p><br>  F√ºr die 0x29-Funktion haben Turla-Entwickler den Code aus dem Empire <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">PSInject-</a> Projekt kopiert.  Auf diese Weise k√∂nnen Sie PowerShell-Code in einer speziellen ausf√ºhrbaren Datei namens PowerShell Runner <code>powershell.exe</code> ohne <code>powershell.exe</code> .  Der Hauptvorteil besteht darin, dass die Malware auch dann PowerShell-Befehle ausf√ºhren kann, wenn die Datei <code>powershell.exe</code> auf einem gef√§hrdeten Computer gesperrt ist. </p><br><p>  Nach der Analyse der Hintert√ºr konnten wir ein PDF-Dokument erstellen, das von einem Schadprogramm erfolgreich interpretiert werden kann.  Die folgende Abbildung zeigt die Ausf√ºhrung der MessageBox und den Start des Rechners ( <code>calc.exe</code> ), nachdem Outlook eine E-Mail mit diesem PDF erhalten hat.  Dies zeigt, dass die Hintert√ºr, die wahrscheinlich Befehle in PDF-Anh√§ngen empfangen soll, funktionsf√§hig ist und von jedem gesteuert werden kann, der dieses benutzerdefinierte Format versteht. </p><br><img src="https://habrastorage.org/webt/-t/xc/lr/-txclr3f050ahxdxykqgnimnr5g.png"><br><p>  <em>Abbildung 21. Ausf√ºhren der im PDF-Dokument angegebenen Befehle</em> </p><br><h3 id="24-dopolnitelnye-funkcii">  2.4.  Zus√§tzliche Funktionen </h3><br><p>  Zus√§tzlich zu den Backdoor-Funktionen, die als Plug-In f√ºr den E-Mail-Client implementiert sind, verf√ºgt die Malware √ºber weitere Funktionen. </p><br><h4 id="241-virtualnaya-faylovaya-sistema">  2.4.1.  Virtuelles Dateisystem </h4><br><p>  Die Malware verwendet keine Konfigurationsdateien, unterst√ºtzt jedoch ein kleines virtuelles Dateisystem im Windows-Registrierungsschl√ºssel <code>HKCU\Software\Microsoft\Windows\CurrentVersion\Settings\ZonePolicy\</code> .  Andere Turla-Backdoors wie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Gazer</a> speichern das virtuelle Dateisystem ebenfalls in der Windows-Registrierung.  Wir konnten einige Registrierungswerte ermitteln, wie in der folgenden Tabelle gezeigt. </p><br><img src="https://habrastorage.org/webt/gi/g-/wt/gig-wt39jwfeznw0kpe7qjzvhpm.png"><br><h4 id="242-zhurnaly">  2.4.2.  Zeitschriften </h4><br><p>  Wie bereits erw√§hnt, speichert das Programm ein Journal, das regelm√§√üig per E-Mail in einem speziell erstellten PDF-Dokument an den Bediener gesendet wird.  Es wird in <code>%appdata%/Microsoft/Windows/scawrdot.db</code> und mit einem fest codierten 512-Byte-XOR-Schl√ºssel verschl√ºsselt.  Die Protokolldatei wird nach jeder Exfiltration an die Bediener gel√∂scht.  W√§hrend der forensischen Untersuchung w√§re es daher unm√∂glich, alle fr√ºheren Aktionen der Hintert√ºr zu sehen, nur die letzten. </p><br><p>  Die Protokolle sind ziemlich informativ und erm√∂glichen es Turla-Betreibern, Backdoor-Aktionen zu verfolgen.  Die folgende Abbildung zeigt ein Beispiel f√ºr ein entschl√ºsseltes Protokoll. </p><br><img src="https://habrastorage.org/webt/yo/q_/z6/yoq_z6lfqy5b3ozw3f4lh6reqr4.png"><br><p>  <em>Abbildung 22. Entschl√ºsselte Protokolldatei</em> </p><br><h2 id="3-vyvody">  3. Schlussfolgerungen </h2><br><p>  Der Bericht zeigte, dass Turla-Entwickler genug Ideen haben, wenn sie Backdoors entwickeln.  Soweit wir wissen, ist Turla die einzige Cyberspionagegruppe, die derzeit eine Hintert√ºr verwendet, die vollst√§ndig per E-Mail oder besser PDF-Anh√§ngen verwaltet wird. </p><br><p>  Die Turla-Hintert√ºr ist nicht die erste, die das echte Postfach des Opfers verwendet, um Befehle zu empfangen und Daten zu filtern.  Dies ist jedoch die erste Hintert√ºr, die mithilfe der Standard-API (MAPI) f√ºr die Interaktion mit Microsoft Outlook erlernt wird.  Dies ist eine signifikante Verbesserung gegen√ºber der vorherigen Version, die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">wir untersucht haben</a> und die Outlook Express verwendet hat.  Im Gegensatz dazu funktioniert die neue Turla-Hintert√ºr auch mit den neuesten Versionen von Outlook. </p><br><p>  Dank der M√∂glichkeit, die scheinbar legitime Kommunikation einer infizierten Workstation zu steuern, sowie der Unabh√§ngigkeit von einer bestimmten E-Mail-Adresse ist die Turla-Hintert√ºr verborgen und fehlertolerant.      ,   Uroburos,      . </p><br><p>   ,         Turla,  ,    .     ,  ,     .  ,      -   ,        . </p><br><p>    ,     PDF-,     Turla,      ,     . </p><br><p>  ESET     Turla,        . </p><br><p>      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">GitHub</a> . </p><br><h2 id="4-indikatory-komprometacii"> 4.   </h2><br><h3 id="41-heshi">  4.1.  Hashes </h3><br><p> 8A7E2399A61EC025C15D06ECDD9B7B37D6245EC2 ‚Äî  Win32/Turla.N;   (GMT) 2013-06-28 14:15:54 <br> F992ABE8A67120667A01B88CD5BF11CA39D491A0 ‚Äî  Win32/Turla.AW; GMT 2014-12-03 20:50:08 <br> CF943895684C6FF8D1E922A76B71A188CFB371D7 ‚Äî  Win32/Turla.R; GMT 2014-12-03 20:44:27 <br> 851DFFA6CD611DC70C9A0D5B487FF00BC3853F30 ‚Äî  Win32/Turla.DA; GMT 2016-09-15 08:14:47 </p><br><h3 id="42-imena-faylov">  4.2.   </h3><br><p> %appdata%/Microsoft/Windows/scawrdot.db <br> %appdata%/Microsoft/Windows/flobcsnd.dat <br> mapid.tlb </p><br><h3 id="43-klyuchi-reestra">  4.3.   </h3><br><p> HKCU\Software\Microsoft\Windows\CurrentVersion\Settings\ZonePolicy\ <br> HKCU\Software\Classes\CLSID{49CBB1C7-97D1-485A-9EC1-A26065633066} <br> HKCU\Software\Classes\CLSID{84DA0A92-25E0-11D3-B9F7-00C04F4C8F5D} </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de421399/">https://habr.com/ru/post/de421399/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de421389/index.html">Gewaltenteilung in Zimbra</a></li>
<li><a href="../de421391/index.html">HackThings - ein gro√üer Hackathon im Internet der Dinge vom 7. bis 9. September in Skoltech</a></li>
<li><a href="../de421393/index.html">Verlassener Mailchimp Basket: Ein Leitfaden f√ºr die Faulen</a></li>
<li><a href="../de421395/index.html">Bericht des Club of Rome 2018, Kapitel 3.7: ‚ÄûKlima: gute Nachrichten, aber gro√üe Probleme‚Äú</a></li>
<li><a href="../de421397/index.html">Starten Sie den Mini AI Cup # 3. Maschinenkampf auf engstem Raum</a></li>
<li><a href="../de421401/index.html">Anatomie von Empfehlungssystemen. Teil zwei</a></li>
<li><a href="../de421403/index.html">Sicherheitswoche 32: Fortnite-Android-Drama</a></li>
<li><a href="../de421407/index.html">Technisches Treffen in St. Petersburg 13. September - Wie man gro√üe √Ñnderungen am Backend vornimmt</a></li>
<li><a href="../de421409/index.html">Spionage Dinge: Halten Sie ein Geheimnis</a></li>
<li><a href="../de421411/index.html">Einf√ºhrung in Go-Module</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>