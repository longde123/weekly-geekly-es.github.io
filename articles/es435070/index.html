<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§¥üèæ ü§ûüèΩ üéè Introducci√≥n a Layer 3 Firewall MikroTik ‚öíÔ∏è üåò üë®‚Äçüëß</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="El cortafuegos (o filtro de paquetes) es un tema amplio y complejo tanto en t√©rminos te√≥ricos como pr√°cticos. Un filtro de paquetes en varios sistemas...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Introducci√≥n a Layer 3 Firewall MikroTik</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/435070/"><p>  El cortafuegos (o filtro de paquetes) es un tema amplio y complejo tanto en t√©rminos te√≥ricos como pr√°cticos.  Un filtro de paquetes en varios sistemas operativos puede tener sus ventajas y desventajas en comparaci√≥n con otras implementaciones.  En este art√≠culo, considerar√© exclusivamente Firewall en RouterOS con un ojo en sus iptables progenitoras. </p><a name="habracut"></a><br><h3 id="predislovie">  Pr√≥logo </h3><br><h4 id="dlya-kogo-eta-statya">  ¬øPara qui√©n es este art√≠culo? </h4><br><p>  Si sabe c√≥mo trabajar con iptables, contin√∫e y configure el firewall, no habr√° nada nuevo para usted en este art√≠culo (bueno, excepto que se usan cadenas con otros nombres en la tabla NAT).  Si es la primera vez que ve un firewall en RouterOS y desea obtener una secuencia de comandos preparada para la configuraci√≥n, no lo encontrar√° aqu√≠.  El material est√° dirigido a aquellos que desean tener una idea <strong>b√°sica</strong> de c√≥mo funciona el firewall y qu√© sucede con el paquete ip en las diferentes etapas de su procesamiento.  Se obtendr√° una comprensi√≥n m√°s profunda con la experiencia y la resoluci√≥n de problemas cotidianos e inusuales utilizando un filtro de paquetes. </p><br><h3 id="teoreticheskaya-chast">  Parte te√≥rica </h3><br><h4 id="chto-takoe-layer3-firewall">  ¬øQu√© es el firewall Layer3? </h4><br><p><img src="https://habrastorage.org/webt/ai/xt/od/aixtod5yvn-bvirxxdvwmnm2m30.png"></p><br><p>  Supongamos que tiene un enrutador con acceso a Internet y dos interfaces de puente: bridge-lan (ether2-ether5) y bridge-dmz (ether6-ether10). </p><br><p>  Dentro de la interfaz de Bridge, los dispositivos encuentran vecinos de forma independiente desde su subred e intercambian paquetes, el enrutador act√∫a como un interruptor y no monitorea dicho tr√°fico a nivel de red (por supuesto, puede forzarlo a hacer esto, pero hablaremos de Layer2 Firewall en otro momento). </p><br><p>  Si es necesario, p√≥ngase en contacto con el dispositivo conectado a otra interfaz de puente o ubicado en la red global, los dispositivos transmiten paquetes al enrutador, que determina la ruta y los procesa en el nivel de la red (Capa 3). </p><br><h4 id="packet-flow-diagram">  Diagrama de flujo de paquetes </h4><br><p>  La ruta completa del tr√°fico se describe en el Diagrama de flujo de paquetes, hay varias versiones oficiales (v5, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">v6</a> ), necesitan ser conocidas y utilizadas en el trabajo diario, pero para comprender el funcionamiento del filtro de paquetes, est√°n sobrecargadas, por lo que explicar√© en una versi√≥n ligera. </p><br><p><img src="https://habrastorage.org/webt/cb/fr/uu/cbfruui7ydb8lqm19myzozfotbo.png"></p><br><p>  La interfaz de entrada / salida es cualquier interfaz de enrutador de capa 3 (f√≠sica o virtual).  Un paquete que va de la red local a Internet llega a la interfaz de entrada y sale de la interfaz de salida.  Un paquete de Internet a la red local tambi√©n llega a la interfaz de entrada y abandona la interfaz de salida.  El flujo de paquetes siempre se lee en una direcci√≥n de entrada -&gt; salida. </p><br><h4 id="osobennosti-terminologii">  Caracter√≠sticas terminol√≥gicas </h4><br><p>  Al estudiar el flujo de paquetes para iptables, puede encontrar descripciones a trav√©s de "cadenas en tablas" o "tablas en cadenas".  El diagrama muestra las tablas en cadenas, al agregar reglas al firewall, todo ser√° al rev√©s. </p><br><p>  Pero, de hecho, el paquete se mueve entre los bloques [chain + tables], por ejemplo, si acepta en el bloque [prerouting + mangle], el paquete de tr√°nsito a√∫n se procesar√° en [forward + mangle].  Es importante recordar esto en configuraciones complejas con pbr y colas. </p><br><p>  La documentaci√≥n de iptables tiene definiciones m√°s precisas, pero en palabras simples: <br>  <strong>Las cadenas</strong> son responsables de d√≥nde se procesa el paquete y la secuencia de reglas. <br>  <strong>Las tablas</strong> determinan las acciones que se pueden realizar en un paquete. </p><br><h4 id="bazovye-varianty-sledovaniya-paketa">  Opciones b√°sicas de seguimiento de paquetes </h4><br><p><img src="https://habrastorage.org/webt/1d/tm/6j/1dtm6j1wiiolczrm215gcz_imss.png"></p><br><p>  <strong>Tr√°nsito</strong> </p><br><p><img src="https://habrastorage.org/webt/rj/9z/_w/rj9z_w8s9pc4valiwixtkrwpdke.png"></p><br><ol><li>  Un paquete de la red llega a una de las interfaces del enrutador </li><li>  En la cadena PREROUTING, el administrador puede influir en la ruta del paquete: determinar la interfaz de salida (enrutamiento base de la pol√≠tica) o redirigir a otra direcci√≥n (dst-nat). </li><li>  De acuerdo con la tabla de enrutamiento para el paquete, se determina la interfaz de salida. </li><li>  La cadena FORWARD es el principal lugar de filtrado para pasar el tr√°fico. </li><li>  El √∫ltimo elemento antes de ingresar a la red es la cadena POSTROUTING, en la que puede cambiar la direcci√≥n del remitente (src-nat). </li><li>  El paquete se puso en l√≠nea. </li></ol><br><p>  <strong>Entrante</strong> </p><br><p><img src="https://habrastorage.org/webt/qn/l8/gd/qnl8gdad6vpxhgdjnhvhpzngcau.png"></p><br><ol><li>  Un paquete de la red lleg√≥ a una de las interfaces del enrutador </li><li>  Golpea la cadena PREROUTING. </li><li>  Seg√∫n la tabla de enrutamiento, el paquete se envi√≥ para su procesamiento al proceso local. </li><li>  La cadena de ENTRADA filtra el tr√°fico entrante por el administrador. </li><li>  El paquete fue procesado por el proceso local. </li></ol><br><p>  <strong>Saliente</strong> </p><br><p><img src="https://habrastorage.org/webt/jh/qr/sd/jhqrsd8rq3lt8x1s3jzjuup_m-8.png"></p><br><ol><li>  Uno de los procesos del enrutador gener√≥ un paquete de ip (nuevo o de respuesta, no importa). </li><li>  De acuerdo con la tabla de enrutamiento, se define una interfaz de salida para el paquete. </li><li>  El administrador puede filtrar el tr√°fico saliente o cambiar la ruta en la cadena de SALIDA. </li><li>  Para el paquete, se toma la decisi√≥n final sobre la interfaz de salida. </li><li>  El paquete cae en POSTROUTING, al igual que el tr√°fico que <em>pasa</em> . </li><li>  El paquete se puso en l√≠nea. </li></ol><br><h4 id="connection-tracker">  Rastreador de conexi√≥n </h4><br><p>  Primero debe comprender qu√© son los filtros de paquetes con estado y sin estado. </p><br><p><img src="https://habrastorage.org/webt/8c/lg/7z/8clg7zcfasexwuw3e3utjyhypl8.png"></p><br><p>  Un ejemplo  La computadora 192.168.100.10 abre una conexi√≥n TCP al servidor 192.0.2.10.  En el lado del cliente, se usa el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">puerto din√°mico</a> 49149, en el lado del servidor 80. Antes de recibir el contenido, el cliente y el servidor deben intercambiar paquetes para establecer una sesi√≥n tcp. </p><br><p>  En <em>sin estado,</em> debe abrir el tr√°fico de la red local a Internet y de Internet a la red local (al menos para el rango de puertos din√°micos).  Que en su conjunto es un agujero. </p><br><p>  En un enrutador con <em>estado</em> , analiza los paquetes y, despu√©s de haber recibido tcp syn de 192.168.100.10:49149 para 192.0.2.10:80, considera que este es el comienzo de una nueva conexi√≥n.  Todos los paquetes adicionales (en cualquier direcci√≥n) entre 192.168.100.10:49149 y 192.0.2.10:80 se considerar√°n parte de la conexi√≥n establecida hasta que se cierre la sesi√≥n tcp o expiren los temporizadores. </p><br><p>  Para UDP / ICMP y otros tipos de tr√°fico, donde el inicio y el final de la conexi√≥n no se pueden distinguir claramente, el primer paquete es el primero, el resto se considera parte de la conexi√≥n establecida y actualiza los temporizadores, el enrutador olvida dichas conexiones despu√©s de que expiren los temporizadores. </p><br><p>  El rastreador de conexiones divide los paquetes en varios tipos: </p><br><p><img src="https://habrastorage.org/webt/j2/do/3f/j2do3fsdj1-t-hq7p2wnf0pnqte.png"></p><br><p>  <em>nuevo</em> : un paquete que abre una conexi√≥n, por ejemplo <em>syn</em> para tcp o el primer paquete en una secuencia de udp. <br>  <em>establecido</em> : un paquete relacionado con una conexi√≥n conocida. <br>  <em>related</em> : paquete relacionado con la conexi√≥n adicional en el multiprotocolo (sip, pptp, ftp, ...). <br>  <em>inv√°lido</em> - paquete de una conexi√≥n desconocida. <br>  no rastreado: rastreador de conexiones de paquetes no rastreados. </p><br><p>  <strong>Configuraci√≥n del rastreador de conexiones</strong> <br>  enabled = yes - activado. <br>  habilitado = no: deshabilitado. <br>  enabed = auto - disabled hasta que aparezca una regla que use las capacidades de conntrack en el firewall.  Se usa por defecto. </p><br><p><img src="https://habrastorage.org/webt/a9/2b/tl/a92btlt5yfxh9fhf7-wmpgrohbu.png"></p><br><p>  Los par√°metros restantes son temporizadores diferentes y, por lo general, no requieren ajuste. </p><br><p>  El administrador puede ver y eliminar conexiones, por ejemplo, la conexi√≥n a NAT se ve as√≠: </p><br><p><img src="https://habrastorage.org/webt/mb/i7/7x/mbi77x9oinpcys1ohb516glu4mc.png"></p><br><p>  El uso de conntrack afecta el rendimiento y el consumo de recursos (especialmente con una gran cantidad de conexiones), pero no funcionar√° en la mayor√≠a de las configuraciones, ya que  tendr√° un firewall sin estado sin NAT. </p><br><div class="spoiler">  <b class="spoiler_title">Lista de funciones dependientes del rastreador de conexiones</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/la/td/kz/latdkzskcwi9cx2o4lkdwtehps8.png"></p></div></div><br><h4 id="ttl">  TTL </h4><br><p>  Time To Live: un campo en el encabezado del paquete IP que define la cantidad de enrutadores a trav√©s de los cuales puede pasar un paquete antes de ser destruido, protege contra el reenv√≠o de paquetes sin fin durante los bucles de enrutamiento. </p><br><p><img src="https://habrastorage.org/webt/gp/qi/js/gpqijsw0wgsu2yqrkcamd3z0mhk.png"></p><br><p>  Al reenviar, el enrutador disminuye el valor TTL en 1, si TTL = 0.  En este caso, un paquete con TTL = 1 llegar√° al proceso local del enrutador. </p><br><p>  Algunos operadores utilizan trucos TTL para evitar el uso de enrutadores.  Todas estas limitaciones justifican el aumento del valor ttl en la tabla de cambios. </p><br><h4 id="nat">  NAT </h4><br><p>  Traducci√≥n de direcciones de red: tecnolog√≠a para cambiar las direcciones en el encabezado del paquete ip.  Al igual que Linux, NAT es parte del filtro de paquetes.  NAT funciona en base al rastreador de conexiones. </p><br><p>  Inicialmente, NAT se dise√±√≥ como una soluci√≥n r√°pida al problema del agotamiento de las direcciones IPv4, para las redes locales se propuso utilizar una subred de los rangos: 10.0.0.0/8;  172.16.0.0/12;  192.168.0.0/16 y traducirlos a una (o varias) direcciones enrutables.  De hecho, hay algunas subredes de servicio m√°s que se pueden usar en redes privadas y el enrutador, en principio, es el mismo que para NAT, pero se recomienda seguir los est√°ndares. </p><br><p>  Procesos NAT solamente: tcp, udp, icmp y algunos multiprotocolos desde [IP] -&gt; [Firewall] -&gt; [Puerto de servicio].  Solo se procesa el primer paquete (estado de conexi√≥n = nuevo) en la conexi√≥n, los paquetes restantes se procesan autom√°ticamente sin la participaci√≥n de la tabla NAT.  Esto puede ser rastreado por el cambio en los contadores en las reglas. </p><br><p>  El encabezado del paquete contiene la direcci√≥n de origen y de destino, respectivamente, y NAT se divide en NAT de origen y de destino. </p><br><p>  <strong>Source NAT</strong> : suplantaci√≥n de direcciones del remitente, presente en la gran mayor√≠a de los enrutadores dom√©sticos y corporativos del mundo. </p><br><p><img src="https://habrastorage.org/webt/2s/ej/or/2sejor290wkc26agkonobacposa.png"></p><br><p>  Permite que muchos dispositivos con direcciones "grises" en la red local se comuniquen con Internet utilizando una (o varias) direcciones reales. </p><br><p><img src="https://habrastorage.org/webt/hh/hi/du/hhhidurhkrsiiuflmg6dakupph8.png"></p><br><p>  Volviendo a Packet Flow, vemos que SRC-NAT est√° en Postrouting, despu√©s de decidir si enrutar el paquete. </p><br><p>  El paquete de respuesta pasa a trav√©s de <em>un</em> DST-NAT <em>impl√≠cito</em> en el que la direcci√≥n del destinatario se cambia a local. </p><br><p>  <strong>Destino NAT</strong> : sustituci√≥n de la direcci√≥n del destinatario. </p><br><p><img src="https://habrastorage.org/webt/id/rb/l9/idrbl9jdlfgfvbftjkgwoorszae.png"></p><br><p>  Se usa, si es necesario, para reenviar el paquete a otra direcci√≥n, generalmente se usa para "reenviar puertos" desde la red externa a la local. </p><br><p><img src="https://habrastorage.org/webt/ju/uv/ly/juuvlyxr74gi8qykxx80vzhyvg4.png"></p><br><p>  Seg√∫n Packet Flow, la operaci√≥n DST-NAT ocurre antes de que se tome la decisi√≥n sobre el enrutamiento en Prerouting; el SRC-NAT <em>impl√≠cito</em> est√° presente para el tr√°fico de respuesta. </p><br><p>  NAT es una herramienta de administraci√≥n de tr√°fico bastante poderosa, pero debe usarse en √∫ltimo lugar (cuando otras herramientas no pueden ayudar). </p><br><h4 id="cepochkichains-bazovye-i-polzovatelskie">  Cadenas (cadenas) b√°sicas y de usuario </h4><br><p>  Las cadenas consisten en reglas y fuerzan la l√≥gica del procesamiento de paquetes. <br>  Hay varias cadenas b√°sicas asignadas al flujo de paquetes: <br>  <strong>Enrutamiento previo (dstnat)</strong> : procesamiento de paquetes antes de decidir el enrutamiento <br>  <strong>Entrada</strong> : paquetes de procesamiento destinados a procesos locales del enrutador <br>  <strong>Salida</strong> : procesando paquetes de paquetes generados por los procesos locales del enrutador <br>  <strong>Reenviar</strong> : procesamiento del tr√°fico de paso <br>  <strong>Postrouting (srcnat)</strong> : procesamiento del tr√°fico listo para su transmisi√≥n a la interfaz </p><br><p>  <em>Todo es como en iptables, pero las cadenas en nat cambian de nombre.</em>  <em>Lo que esto est√° conectado (muy probablemente con la descarga de hotspot o hardware de nat) es desconocido para m√≠, pero no cambia nada en absoluto.</em> </p><br><p>  El paquete pasa las reglas de la cadena secuencialmente, si es adecuado para todas las condiciones, la acci√≥n se aplica al paquete.  Si la acci√≥n est√° finalizando y no descarta el paquete, se pasa al siguiente bloque de flujo de paquetes. </p><br><p>  Todas las cadenas base tienen una acci√≥n predeterminada (si el paquete no se ajustaba a ninguna de las reglas): <em>aceptar</em> . </p><br><p>  Las cadenas personalizadas son necesarias para reducir la cantidad de reglas que pasa cada paquete y para construir reglas complejas para procesar el tr√°fico.  Todas las cadenas de usuarios tienen una acci√≥n predeterminada: <em>regresar</em> . </p><br><p><img src="https://habrastorage.org/webt/bk/rg/sk/bkrgskh5wudzzf54mueqiy9oehk.png"></p><br><p>  Dentro de la tabla, puede reenviar las reglas desde varias cadenas base (y de usuario) diferentes a la cadena de usuario, pero el paquete volver√° a la cadena de la que proviene. </p><br><p><img src="https://habrastorage.org/webt/_8/kw/oi/_8kwoirut9mtd67elbejqkzdsek.png"></p><br><h4 id="usloviya-v-pravilah">  T√©rminos y condiciones </h4><br><p>  Las cadenas consisten en reglas; cada regla consiste en condiciones y acciones.  Hay muchas condiciones, pero no todas las usar√°n en configuraciones reales.  La mayor√≠a de las condiciones pueden tener el prefijo "not" (signo "!").  Para coincidir con la regla, el paquete debe ser adecuado para todas estas condiciones. </p><br><p><img src="https://habrastorage.org/webt/la/dh/or/ladhorisauzv81cnmffmkjo6_hi.png"></p><br><div class="spoiler">  <b class="spoiler_title">Algunas de las condiciones</b> <div class="spoiler_text"><table><thead><tr><th>  Condici√≥n </th><th>  Descripci√≥n </th></tr></thead><tbody><tr><td>  direcci√≥n src </td><td>  Direcci√≥n de origen </td></tr><tr><td>  dst-address </td><td>  Direcci√≥n del destinatario </td></tr><tr><td>  src-address-list </td><td>  La direcci√≥n de origen est√° en la lista. </td></tr><tr><td>  dst-address-list </td><td>  La direcci√≥n del destinatario est√° en la lista </td></tr><tr><td>  protocolo </td><td>  Protocolo de capa de transporte </td></tr><tr><td>  src-port </td><td>  Puerto de origen </td></tr><tr><td>  dst-port </td><td>  Puerto receptor </td></tr><tr><td>  puerto </td><td>  Puerto de origen o destino </td></tr><tr><td>  en la interfaz </td><td>  La interfaz en la que vino el paquete </td></tr><tr><td>  interfaz externa </td><td>  La interfaz desde la cual se enviar√° el paquete a la red. </td></tr><tr><td>  lista-de-interfaz </td><td>  La interfaz a la que vino el paquete aparece </td></tr><tr><td>  lista de interfaz de salida </td><td>  Se enumera la interfaz desde la cual se enviar√° el paquete a la red. </td></tr><tr><td>  protocolo layer7 </td><td>  An√°lisis de los contenidos de los primeros 10 paquetes en una conexi√≥n </td></tr><tr><td>  contenido </td><td>  Buscar una cadena dada en un lote </td></tr><tr><td>  tls-host </td><td>  Buscar host en el encabezado de tls </td></tr><tr><td>  pol√≠tica ipsec </td><td>  Compruebe si el paquete coincide con la pol√≠tica de ipsec o no </td></tr><tr><td>  tama√±o de paquete </td><td>  tama√±o de paquete en bytes </td></tr><tr><td>  src-mac-address </td><td>  direcci√≥n de origen del paquete mac </td></tr><tr><td>  marca de conexi√≥n </td><td>  Etiqueta de conexi√≥n </td></tr><tr><td>  marca de paquete </td><td>  Etiqueta del paquete </td></tr><tr><td>  marca de enrutamiento </td><td>  Paquete Waypoint </td></tr><tr><td>  estado de conexi√≥n </td><td>  Estado del paquete de conexi√≥n </td></tr><tr><td>  tcp-flags </td><td>  Paquete tcp de banderas </td></tr><tr><td>  opciones de icmp </td><td>  Opciones de paquete de ICMP </td></tr><tr><td>  al azar </td><td>  La regla se activa (cuando otras condiciones coinciden) con una probabilidad dada </td></tr><tr><td>  tiempo </td><td>  Puede especificar las horas de trabajo de la regla, desafortunadamente sin una conversi√≥n de fecha </td></tr><tr><td>  ttl </td><td>  Valor de campo Ttl en paquete </td></tr><tr><td>  dscp </td><td>  Valor de campo DSCP (ToS) en paquete </td></tr><tr><td>  - // - </td><td>  - // - </td></tr><tr><td>  lugar antes </td><td>  Opci√≥n de consola (sin condici√≥n), le permite agregar una regla antes de la especificada </td></tr><tr><td>  deshabilitado </td><td>  Opci√≥n de consola (no condici√≥n), le permite deshabilitar la regla </td></tr></tbody></table><br><p>  <strong>Notas</strong> <br>  Como direcci√≥n src. (Dst.), Puede especificar: una √∫nica ip, un rango de direcciones a trav√©s de un gui√≥n o una subred. <br>  Se necesitan listas de direcciones para combinar varias IP no conectadas con el mismo nombre.  A diferencia de ipset en netfilter, las entradas en las listas de MikroTik se pueden eliminar despu√©s de un per√≠odo de tiempo espec√≠fico.  Puede ver las listas y realizar cambios en [IP] -&gt; [Cortafuegos] -&gt; [Listas de direcciones]. <br>  Como n√∫mero de puerto (puerto, puerto src, puerto dst), puede especificar un solo puerto, varios puertos separados por comas o un rango de puertos a trav√©s de un gui√≥n. </p></div></div><br><p>  En el √∫ltimo MUM en MSC, hubo una buena presentaci√≥n sobre el efecto de varias condiciones en la velocidad de procesamiento de los paquetes (all√≠ aprender√° c√≥mo usar la tabla sin formato para reducir la carga en el enrutador), a quienes les interesa: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">grabaci√≥n</a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">presentaci√≥n</a> . </p><br><h4 id="deystviya-v-tablicah">  Acciones de tablas </h4><br><p>  El conjunto de acciones disponibles en el paquete depende de la tabla en la que se procesa. <br><img src="https://habrastorage.org/webt/i3/ba/xj/i3baxjyyz-fnswxpanh_qek5kq8.png"><br>  <strong>Filtro</strong> : tabla de filtrado de tr√°fico, uno de los dos lugares donde puede soltar el paquete. </p><br><p>  <strong>NAT</strong> : tabla para modificar las direcciones IP y los puertos (tpc, udp) en el encabezado del paquete ip. </p><br><p>  <strong>Mangle</strong> : una tabla para modificar otros campos del paquete ip y configurar varias etiquetas. </p><br><p><img src="https://habrastorage.org/webt/w0/dc/n3/w0dcn3uinajpugbflfjha0pt5jy.png"></p><br><p>  Hay tres tipos de etiquetas de paquetes internos: conexi√≥n, paquete, ruta.  Las etiquetas solo existen dentro del enrutador y no van a la red.  Un paquete puede tener una etiqueta de cada tipo, mientras pasa varias reglas mark- * en secuencia, las etiquetas se sobrescriben. <br>  Las etiquetas de ruta solo se pueden establecer en las cadenas de enrutamiento y salida, el resto en cualquier cadena. </p><br><p>  Es una buena pr√°ctica marcar primero la conexi√≥n, luego el paquete (paquete) o la ruta (ruta).  Buscar etiquetas es m√°s r√°pido que los campos de paquetes.  En la pr√°ctica, este no es siempre el caso en colas complejas o pbr no es √∫til el marcado adicional de la conexi√≥n. </p><br><p>  <strong>RAW</strong> : una tabla que permite que los paquetes omitan el rastreador de conexiones.  Se utiliza para contrarrestar DoS y reducir la carga en la CPU (por ejemplo, omitiendo el tr√°fico de multidifusi√≥n).  Te permite soltar el paquete. </p><br><p>  Las acciones de terminaci√≥n completan el procesamiento de un paquete en la cadena y lo pasan al siguiente bloque en el flujo de paquetes, o lo descartan. </p><br><div class="spoiler">  <b class="spoiler_title">Acciones</b> <div class="spoiler_text"><table><thead><tr><th>  Mesa </th><th>  Acci√≥n </th><th>  Descripci√≥n </th><th>  Terminando? </th></tr></thead><tbody><tr><td>  Todos </td><td>  aceptar </td><td>  Deje de procesar el paquete y transfi√©ralo al siguiente bloque de flujo Pakcet </td><td>  Si </td></tr><tr><td>  Todos </td><td>  registro </td><td>  Informaci√≥n del paquete de registro: en las versiones modernas, puede agregar el registro a cualquier otra acci√≥n. </td><td>  No </td></tr><tr><td>  Todos </td><td>  passtrough </td><td>  Cuenta la cantidad de paquetes.  Utilizado para depurar </td><td>  No </td></tr><tr><td>  Todos </td><td>  agregue src a la lista de direcciones y agregue dst a la lista de direcciones </td><td>  Agregar la direcci√≥n de origen (destino) del paquete a la lista dada </td><td>  No </td></tr><tr><td>  Todos </td><td>  saltar </td><td>  Ir a la cadena de usuarios </td><td>  Si </td></tr><tr><td>  Todos </td><td>  volver </td><td>  Regresar a la cadena principal.  En cadenas base funciona como aceptar </td><td>  Si </td></tr><tr><td>  Filtro y crudo </td><td>  soltar </td><td>  Detenga el flujo de paquetes en el flujo de paquetes y des√©chelos </td><td>  Si </td></tr><tr><td>  Filtro y enrutamiento previo </td><td>  v√≠a r√°pida </td><td>  Marcar paquete para un flujo r√°pido de paquetes </td><td>  Si </td></tr><tr><td>  Filtro </td><td>  rechazar </td><td>  Como descartar, pero al remitente de un paquete se le env√≠a una notificaci√≥n (tcp o icmp) sobre el paquete descartado </td><td>  Si </td></tr><tr><td>  Filtro </td><td>  trapit </td><td>  Emule la presencia de un puerto abierto.  Utilizado para protecci√≥n contra DoS, enga√±o y (a veces) depuraci√≥n </td><td>  Si </td></tr><tr><td>  NAT </td><td>  src-nat </td><td>  Sustituci√≥n de la direcci√≥n del remitente por la especificada </td><td>  Si </td></tr><tr><td>  NAT </td><td>  disfraces </td><td>  Un caso especial de src-nat, reemplaza la direcci√≥n del remitente con una de las direcciones de la interfaz, se usa en interfaces din√°micas (dhcp, vpn).  No se recomienda usar si hay varias ip en la interfaz </td><td>  Si </td></tr><tr><td>  NAT </td><td>  lo mismo </td><td>  Un caso especial de src-nat.  Reemplaza la direcci√≥n del remitente con una direcci√≥n del rango especificado </td><td>  Si </td></tr><tr><td>  NAT </td><td>  dst-nat </td><td>  Reemplaza la direcci√≥n del destinatario con la especificada </td><td>  Si </td></tr><tr><td>  NAT </td><td>  redirigir </td><td>  Un caso especial de dst-nat, reemplaza la direcci√≥n del destinatario con la direcci√≥n de la interfaz del enrutador a la que vino el paquete </td><td>  Si </td></tr><tr><td>  NAT </td><td>  mapa de red </td><td>  No es un reemplazo para dst-nat.  Utilizado para la traducci√≥n de red a red, ver ejemplos </td><td>  Si </td></tr><tr><td>  Destrozar </td><td>  marcar conexi√≥n </td><td>  Etiqueta de conexi√≥n </td><td>  No </td></tr><tr><td>  Destrozar </td><td>  paquete de marca </td><td>  Etiqueta de paquete aplicada en colas </td><td>  No </td></tr><tr><td>  Destrozar </td><td>  marcar enrutamiento </td><td>  Etiqueta de ruta aplicada en el enrutamiento base de pol√≠ticas </td><td>  No </td></tr><tr><td>  Destrozar </td><td>  cambiar ttl </td><td>  Editar ttl </td><td>  No </td></tr><tr><td>  Destrozar </td><td>  cambiar dcsp (tos) </td><td>  Cambiar dcsp decimal </td><td>  No </td></tr><tr><td>  Destrozar </td><td>  cambiar mss </td><td>  Cambiar mss a tcp syn </td><td>  No </td></tr><tr><td>  Destrozar </td><td>  claro df </td><td>  Borrar no fragmentar la bandera </td><td>  No </td></tr><tr><td>  Destrozar </td><td>  opciones de strip ipv4 </td><td>  Borrar opciones avanzadas de ipv4 </td><td>  No </td></tr><tr><td>  Destrozar </td><td>  establecer prioridad </td><td>  Establecer prioridad para CoS </td><td>  No </td></tr><tr><td>  Destrozar </td><td>  ruta </td><td>  Establecer puerta de enlace para el paquete.  Versi√≥n simple de PBR </td><td>  No </td></tr><tr><td>  Destrozar </td><td>  sniff tzsp </td><td>  Encapsula paquetes en udp y env√≠alos a la ip especificada </td><td>  No </td></tr><tr><td>  Destrozar </td><td>  olfatear pc </td><td>  Un an√°logo de tzsp, pero con un tipo diferente de encapsulaci√≥n.  En wiki si usa casos con calea </td><td>  No </td></tr><tr><td>  Destrozar </td><td>  passtrough </td><td>  Por defecto, la mayor√≠a de las reglas en mangle no impiden que el paquete pase, puede cambiar este comportamiento estableciendo passtrough = no </td><td>  No </td></tr><tr><td>  Crudo </td><td>  notrack </td><td>  No rastrear el paquete en el rastreador de conexiones </td><td>  Si </td></tr></tbody></table><br><p>  <em>Si hay quienes lo desean, puedo escribir m√°s sobre FastTrack y FastPath, pero no debe esperar milagros de estas tecnolog√≠as.</em> </p></div></div><br><h4 id="para-slov-pro-dpi">  Algunas palabras sobre DPI </h4><br><p>  Hay varias posibilidades para analizar el paquete un poco m√°s profundo que el encabezado de la capa de transporte: <br>  <em>contenido</em> : busca una cadena determinada en un paquete. <br>  <em>protocolo layer7</em> : almacena los primeros 10 paquetes (o 2 KB) de la conexi√≥n y busca expresiones regulares en los datos almacenados.  Una gran cantidad de reglas de layer7 afectan significativamente el rendimiento. <br>  <em>tls-host</em> es la direcci√≥n del nombre de host en el encabezado TLS / SNI de una conexi√≥n HTTPS. </p><br><h3 id="primery">  Ejemplos </h3><br><p>  No copie los ejemplos sin pensar, es mejor tomar el dispositivo e intentar escribir la configuraci√≥n usted mismo (o reescribir los ejemplos, pero para comprender qu√© hace cada una de las reglas).  Si no sabe c√≥mo complementar las reglas: en las configuraciones dom√©sticas predeterminadas y m√≠nimas no hay acceso al enrutador desde la interfaz wan, agr√©guelo con filtrado por la lista de direcciones. </p><br><h4 id="defoltnyy-firewall-routeros">  Firewall predeterminado RouterOS </h4><br><p>  Una configuraci√≥n bastante segura, pero en lugares muy confusos: </p><br><pre><code class="plaintext hljs">/ip firewall filter #     (established, related)   (untracked)  add action=accept chain=input connection-state=established,related,untracked #    (invalid)  add action=drop chain=input connection-state=invalid #  icmp  add action=accept chain=input protocol=icmp #          add action=drop chain=input in-interface-list=!LAN #   ipsec    add action=accept chain=forward ipsec-policy=in,ipsec add action=accept chain=forward ipsec-policy=out,ipsec #          add action=fasttrack-connection chain=forward connection-state=established,related #       add action=accept chain=forward connection-state=established,related,untracked #    add action=drop chain=forward connection-state=invalid #     wan ,     dstnat (,      src-nat   dst-nat) add action=drop chain=forward connection-nat-state=!dstnat connection-state=new in-interface-list=WAN /ip firewall nat #Source NAT      ipsec,      WAN add action=masquerade chain=srcnat ipsec-policy=out,none out-interface-list=WAN</code> </pre> <br><p>  Nunca us√© la configuraci√≥n predeterminada, pero antes el firewall predeterminado era mucho peor. </p><br><h4 id="minimalnyy-domashniy-firewall">  Cortafuegos de casa m√≠nimo </h4><br><p>  Lo m√°s f√°cil de inventar.  S√≠, el tr√°fico no rastreado no est√° permitido (pero en la etapa del estudio b√°sico del firewall todav√≠a no lo necesita) y habr√° problemas con el t√∫nel ipsec (nuevamente, si puede configurar ipsec, usted mismo sabe lo que debe hacerse). </p><br><pre> <code class="plaintext hljs">/ip firewall filter #     (established, related)  add chain=input connection-state=established,related action=accept #  icmp  add chain=input connection-state=new protocol=icmp action=accept #      add chain=input connection-state=new in-interface-list=LAN action=accept #     add chain=input action=drop #       add chain=forward connection-state=established,related action=accept #         add chain=forward connection-state=new in-interface-list=LAN action=accept #     add chain=forward action=drop /ip firewall nat #Source NAT        WAN add chain=srcnat out-interface-list=WAN action=masquerade</code> </pre> <br><h4 id="primer-s-dmz">  Ejemplo DMZ </h4><br><p>  En los enrutadores "dom√©sticos", el acr√≥nimo DMZ le gusta llamar a una computadora en la subred local para la cual se reenv√≠an todos los puertos de la red externa. </p><br><p>  De hecho, esto no es as√≠ y una de las opciones de DMZ es separar el recurso al que debe proporcionar acceso desde Internet y se puede llevar a cabo un ataque exitoso (un servidor web con cms en el que se encuentran agujeros constantemente es un buen objetivo para un atacante).  En caso de pirater√≠a, un atacante no podr√° afectar a los participantes en la red local. </p><br><p><img src="https://habrastorage.org/webt/bb/pp/9g/bbpp9gbe7k4owuef7hxuzisrurg.png"></p><br><pre> <code class="plaintext hljs">#  /ip firewall nat add chain=dstnat dst-port=80,443 action=dst-nat to-address=192.168.200.2 /ip firewall filter #   icmp   add chain=input connection-state=established,related action=accept add chain=input protocol=icmp connection-state=new action=accept #      add chain=input in-interface=ether2-lan action=accept #    add chain=input action=drop #    add chain=forward connection-state=established,related action=accept #        add chain=forward in-interface=ether2-lan connection-state=new action=accept #    web  add chain=forward out-interface=ether3-dmz dst-address=192.168.200.2 dst-port=80,443 connection-state=new action=accept #   add chain=forward action=drop</code> </pre> <br><h4 id="hairpin-nat">  Horquilla NAT </h4><br><p><img src="https://habrastorage.org/webt/r5/ms/wv/r5mswv8kwtp0m3amzpl--bd5fn0.png"></p><br><pre> <code class="plaintext hljs">/ip firewall nat add chain=dstnat dst-port=80 action=dst-nat to-address=192.168.100.2</code> </pre> <br><p>  Una situaci√≥n t√≠pica es cuando reenv√≠a un puerto a un servidor en una red local y todo funciona desde el exterior, pero dentro de la red local no se puede acceder al servidor en una direcci√≥n externa. </p><br><p>  Veamos que pasa: </p><br><ol><li>  La computadora 192.168.100.10 env√≠a una solicitud a 192.0.2.100 </li><li>  Realiza DST-NAT en el enrutador y el paquete se reenv√≠a a 192.168.100.2 </li><li>  El servidor ve que un paquete de 192.168.100.10 ha llegado a la direcci√≥n 192.168.100.2 y est√° respondiendo desde la direcci√≥n local. </li><li>  La computadora recibe un paquete inesperado de 192.168.100.2 y lo descarta. </li></ol><br><p>  La soluci√≥n es agregar una regla adicional que cambie la direcci√≥n de origen a la direcci√≥n del enrutador, para que el servidor devuelva el paquete al enrutador, que lo enviar√° a la computadora inicializadora. </p><br><pre> <code class="plaintext hljs">/ip firewall nat #  add chain=dstnat dst-port=80 action=dst-nat to-address=192.168.100.2 # ,      add chain=srcnat src-address=192.168.100.0/24 dst-address=192.168.100.2 action=masquerade</code> </pre> <br><p>  En la pr√°ctica, este esquema no se usa con frecuencia, pero como ejemplo de depuraci√≥n de un firewall, realmente me gusta. </p><br><h4 id="pravilnoe-ispolzovanie-netmap">  Uso adecuado de netmap </h4><br><p><img src="https://habrastorage.org/webt/l9/xa/ox/l9xaoxkyat1phpmy6tnnhau6nls.png"><br>  Netmap es una tecnolog√≠a para traducir direcciones de una subred a las direcciones de otra subred. <br>  La direcci√≥n IP (en la entrada de la m√°scara) consta de dos partes: la red (el n√∫mero de bits especificado en la m√°scara de subred) y el host (bits restantes).  Netmap cambia la parte de red de la direcci√≥n, pero no toca la parte del host. </p><br><p><img src="https://habrastorage.org/webt/jy/eh/xh/jyehxh3hok1l5-wfw6c8n4czdlu.png"></p><br><p>  Hay dos enrutadores conectados por un canal VPN.  Los enrutadores sirven subredes con el mismo direccionamiento.  Es necesario hacer acceso entre subredes. </p><br><p>  No puede prescindir de direccionamiento adicional. </p><br><p>  Los usuarios de la subred izquierda golpear√°n a la derecha a trav√©s de la subred 192.168.102.0/24 <br>  Los usuarios de la subred derecha tocar√°n a la izquierda a trav√©s de la subred 192.168.101.0/24 </p><br><p>  Configuraci√≥n en MikroTik 1. </p><br><pre> <code class="plaintext hljs">#     /ip route add distance=1 dst-address=192.168.102.0/24 gateway /ip firewall nat #       add action=netmap chain=srcnat dst-address=192.168.102.0/24 out-interface=ipip src-address=192.168.100.0/24 to-address=192.168.101.0/24 #       add action=netmap chain=dstnat dst-address=192.168.101.0/24 in-interface=ipip src-address=192.168.102.0/24 to-address=192.168.100.0/24</code> </pre> <br><p>  La configuraci√≥n de MikroTik2 es casi la misma: </p><br><pre> <code class="plaintext hljs">/ip route add distance=1 dst-address=192.168.101.0/24 gateway=10.10.10.1 /ip firewall nat add action=netmap chain=srcnat dst-address=192.168.101.0/24 out-interface=ipip src-address=192.168.100.0/24 to-address=192.168.102.0/24 add action=netmap chain=dstnat dst-address=192.168.102.0/24 in-interface=ipip src-address=192.168.101.0/24 to-address=192.168.100.0/24</code> </pre> <br><p>  Hay configuraciones m√°s complejas que usan netmap, por ejemplo, si tiene muchas conexiones a puntos remotos con subredes que se cruzan y no hay forma de cambiar la configuraci√≥n en equipos remotos, pero esto ya es enrutamiento avanzado. </p><br><p>  Si no comprende nada (sobre netmap), entonces no lo necesita y simplemente no use esta acci√≥n al reenviar puertos. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es435070/">https://habr.com/ru/post/es435070/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es435054/index.html">Universidad ITMO "en la pr√°ctica": con qu√© empresas de tecnolog√≠a cooperamos</a></li>
<li><a href="../es435056/index.html">Samsung SSD 860 QVO 1 TB y 4 TB: el primer consumidor SATA QLC (3 partes)</a></li>
<li><a href="../es435060/index.html">2018 fue el a√±o del scooter. Que sigue</a></li>
<li><a href="../es435062/index.html">Gu√≠a: Thymeleaf + Spring. Parte 1</a></li>
<li><a href="../es435064/index.html">Montamos la aspiradora Xiaomi</a></li>
<li><a href="../es435072/index.html">Memoria anal√≥gica de 8 bits para trabajar con redes neuronales.</a></li>
<li><a href="../es435074/index.html">Vulnerabilidades de Kyivstar: 1) an√°lisis de una publicaci√≥n anterior sobre contrase√±as + 2) informaci√≥n sobre compras que pasan por los servicios de Kyivstar</a></li>
<li><a href="../es435076/index.html">C√≥mo los especialistas en marketing que trabajan con Google monetizan nuestra incomodidad</a></li>
<li><a href="../es435078/index.html">¬øQu√© pasa si la inteligencia artificial hace que los actores sean inmortales?</a></li>
<li><a href="../es435080/index.html">Gu√≠a: Thymeleaf + Spring. Parte 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>