<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üî¨ üå°Ô∏è üëàüèº Apprenez Metaflow en 10 minutes ‚ôÄÔ∏è üõÄüèª üõÇ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Metaflow est un framework Python cr√©√© dans Netflix et ax√© sur le domaine de la science des donn√©es. √Ä savoir, il est con√ßu pour cr√©er des projets visa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Apprenez Metaflow en 10 minutes</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/482462/">  Metaflow est un framework Python cr√©√© dans Netflix et ax√© sur le domaine de la science des donn√©es.  √Ä savoir, il est con√ßu pour cr√©er des projets visant √† travailler avec des donn√©es et pour g√©rer de tels projets.  R√©cemment, la soci√©t√© l'a transf√©r√© dans la cat√©gorie open-source.  Le framework Metaflow a √©t√© largement utilis√© au sein de Netflix au cours des 2 derni√®res ann√©es.  En particulier, il a permis de r√©duire consid√©rablement le temps n√©cessaire √† la conclusion des projets en production. <br><br> <a href="https://habr.com/ru/company/ruvds/blog/482462/"><img src="https://habrastorage.org/webt/yd/2j/7p/yd2j7p_dpzkyrjeef9us6a7pgs4.png"></a> <br><br>  Le mat√©riel que nous traduisons aujourd'hui est un guide rapide de Metaflow. <br><a name="habracut"></a><br><h2>  <font color="#3AC1EF">Qu'est-ce que Metaflow?</font> </h2><br>  Vous trouverez ci-dessous un graphique illustrant la mise en ≈ìuvre du cadre Metaflow dans Netflix. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6bd/bb8/297/6bdbb82972a098b8fd241f42d7f55b51.png"></div><br>  <i><font color="#999999">Impl√©mentation de Metaflow dans Netflix</font></i> <br><br>  En novembre 2018, ce cadre a √©t√© utilis√© dans 134 projets de l'entreprise. <br><br>  Metaflow est un cadre pour cr√©er et ex√©cuter des workflows de science des donn√©es.  Il pr√©sente les fonctionnalit√©s suivantes: <br><br><ul><li>  Gestion des ressources informatiques. </li><li>  Lancement de t√¢che conteneuris√©e. </li><li>  Gestion des d√©pendances externes. </li><li>  Gestion des versions, r√©ex√©cution des t√¢ches, poursuite de l'ex√©cution des t√¢ches suspendues. </li><li>  API client pour examiner les r√©sultats des t√¢ches qui peuvent √™tre utilis√©es dans l'environnement Jupyter Notebook. </li><li>  Prise en charge de l'ex√©cution de t√¢ches locales (par exemple, sur un ordinateur portable) et √† distance (dans le cloud).  Possibilit√© de basculer entre ces modes. </li></ul><br>  L'utilisateur vtuulos a <a href="https://news.ycombinator.com/item%3Fid%3D21698711">√©crit</a> sur Ycombinator que Metaflow peut automatiquement cr√©er des instantan√©s (instantan√©s) de code, de donn√©es et de d√©pendances.  Tout cela est plac√© dans un r√©f√©rentiel avec adressage par contenu, qui est g√©n√©ralement bas√© sur S3, bien que le syst√®me de fichiers local soit √©galement pris en charge.  Cela vous permet de continuer √† ex√©cuter des t√¢ches arr√™t√©es, de reproduire les r√©sultats pr√©c√©demment obtenus et d'explorer tout ce qui concerne les t√¢ches, par exemple dans le bloc-notes Jupyter. <br><br>  En g√©n√©ral, nous pouvons dire que Metaflow vise √† augmenter la productivit√© des scientifiques de donn√©es.  Cela est d√ª au fait que le cadre leur permet de s'engager exclusivement dans le travail avec des donn√©es, sans √™tre distrait par la r√©solution de t√¢ches connexes.  De plus, Metaflow acc√©l√®re le retrait des projets bas√©s sur celui-ci en production. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d16/311/176/d1631117682028c779664c90bef2a885.png"></div><br>  <i><font color="#999999">Les besoins d'un data scientist li√©s √† ses responsabilit√©s directes et la solution des t√¢ches auxiliaires li√©es √† l'infrastructure sur laquelle les calculs sont effectu√©s</font></i> <br><br><h2>  <font color="#3AC1EF">Sc√©narios de workflow avec Metaflow</font> </h2><br>  Voici quelques sc√©narios de workflow que vous pouvez organiser √† l'aide de Metaflow: <br><br><ul><li>  <b>Collaboration</b>  Un data scientist veut aider un autre √† trouver la source de l'erreur.  Dans le m√™me temps, l'assistant souhaite t√©l√©charger sur son ordinateur l'ensemble de l'environnement dans lequel la t√¢che qui s'est √©cras√©e a fonctionn√©. </li><li>  <b>Poursuite des t√¢ches arr√™t√©es depuis l'endroit o√π elles ont √©t√© arr√™t√©es.</b>  Une t√¢che s'est arr√™t√©e avec une erreur (ou a √©t√© arr√™t√©e intentionnellement).  L'erreur a √©t√© corrig√©e (ou le code a √©t√© modifi√©).  Il est n√©cessaire de red√©marrer la t√¢che pour que son travail continue √† partir de l'endroit o√π elle a √©chou√© (ou a √©t√© arr√™t√©e). </li><li>  <b>Ex√©cution de t√¢ches hybrides.</b>  Vous devez effectuer une certaine √©tape du flux de travail localement (il s'agit peut-√™tre de t√©l√©charger des donn√©es √† partir d'un fichier stock√© dans un dossier sur l'ordinateur), et une autre √©tape qui n√©cessite de grandes ressources de calcul (il s'agit peut-√™tre de la formation du mod√®le) doit √™tre effectu√©e dans le cloud. </li><li>  <b>Examen des m√©tadonn√©es obtenues apr√®s avoir termin√© une t√¢che.</b>  Trois scientifiques des donn√©es sont engag√©s dans la s√©lection d'hyperparam√®tres du m√™me mod√®le, en essayant d'am√©liorer la pr√©cision de ce mod√®le.  Apr√®s cela, vous devez analyser les r√©sultats de l'ex√©cution des t√¢ches de formation du mod√®le et s√©lectionner l'ensemble d'hyperparam√®tres qui s'est av√©r√© √™tre le meilleur. </li><li>  <b>Utilisation de plusieurs versions du m√™me package.</b>  Dans le projet, vous devez utiliser diff√©rentes versions, par exemple, les biblioth√®ques sklearn.  Pendant le pr√©traitement, sa version 0.20 est requise et pendant la mod√©lisation, la version 0.22 est requise. </li></ul><br><h2>  <font color="#3AC1EF">Flux de travail typique de Metaflow</font> </h2><br>  Consid√©rez un flux de travail Metaflow typique d'un point de vue conceptuel et de programmation. <br><br><h3>  <font color="#3AC1EF">LookAvis conceptuel sur le flux de travail Metaflow</font> </h3><br>  D'un point de vue conceptuel, les workflows Metaflow (cha√Ænes de t√¢ches) sont repr√©sent√©s par des <a href="https://ru.wikipedia.org/wiki/%25D0%259E%25D1%2580%25D0%25B8%25D0%25B5%25D0%25BD%25D1%2582%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B9_%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BA%25D0%25BB%25D0%25B8%25D1%2587%25D0%25B5%25D1%2581%25D0%25BA%25D0%25B8%25D0%25B9_%25D0%25B3%25D1%2580%25D0%25B0%25D1%2584">graphiques acycliques dirig√©s</a> (DAG).  Les illustrations ci-dessous vous aideront √† mieux comprendre cette id√©e. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/584/53d/52e/58453d52e9dfbd50dcc5b974ffae11e1.png"></div><br>  <i><font color="#999999">Graphique acyclique lin√©aire</font></i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3d7/a8d/810/3d7a8d81017d4112913a5c081c70b9a8.png"></div><br>  <i><font color="#999999">Graphique acyclique avec chemins "parall√®les"</font></i> <br><br>  Chaque n≈ìud du graphique repr√©sente une √©tape de traitement des donn√©es dans le flux de travail. <br><br>  √Ä chaque √©tape de la cha√Æne de t√¢ches, Metaflow ex√©cute du code Python normal sans aucune modification sp√©ciale.  Le code est ex√©cut√© dans des conteneurs s√©par√©s dans lesquels le code est compress√© avec ses d√©pendances. <br><br>  Un aspect cl√© de l'architecture Metaflow est repr√©sent√© par le fait qu'il vous permet d'impl√©menter presque toutes les biblioth√®ques externes de l'√©cosyst√®me conda dans des projets bas√©s sur celui-ci sans utiliser de plugins.  Cela distingue Metaflow des autres solutions polyvalentes similaires.  Par exemple - depuis Airflow. <br><br><h3>  <font color="#3AC1EF">‚ñç Flux de travail Metaflow en termes de programmation</font> </h3><br>  Chaque cha√Æne de t√¢ches (flux) peut √™tre repr√©sent√©e comme une classe Python standard (les noms de ces classes ont g√©n√©ralement le mot <code>Flow</code> ) si elle satisfait aux exigences minimales suivantes: <br><br><ul><li>  La classe est la descendante de la classe Metaflow <code>FlowSpec</code> . </li><li>  Le <code>@step</code> chaque fonction qui repr√©sente une √©tape de la cha√Æne de t√¢ches. </li><li>  √Ä la fin de chaque fonction <code>@step</code> , il doit y avoir une indication d'une fonction similaire qui la suit.  Cela peut √™tre fait en utilisant une construction de ce type: <code>self.next(self.function_name_here)</code> . </li><li>  La classe impl√©mente les fonctions de <code>start</code> et de <code>end</code> . </li></ul><br>  Prenons un exemple de cha√Æne minimale de t√¢ches compos√©e de trois n≈ìuds. <br><br>  Son sch√©ma ressemble √† ceci: <br><br><pre> <code class="python hljs">start ‚Üí process_message ‚Üí end</code> </pre> <br>  Voici son code: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> metaflow <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> FlowSpec, step <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LinearFlow</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(FlowSpec)</span></span></span><span class="hljs-class">:</span></span>         <span class="hljs-string"><span class="hljs-string">"""     ,      Metaflow.    """</span></span>       <span class="hljs-comment"><span class="hljs-comment">#         @step    def start(self):        self.message = 'Thanks for reading.'        self.next(self.process_message)    @step    def process_message(self):        print('the message is: %s' % self.message)        self.next(self.end)    @step    def end(self):        print('the message is still: %s' % self.message) if __name__ == '__main__':    LinearFlow()</span></span></code> </pre> <br><h2>  <font color="#3AC1EF">Instructions d'installation de Metaflow</font> </h2><br><h3>  <font color="#3AC1EF">‚ñçInstallation et essai</font> </h3><br>  Voici la s√©quence d'√©tapes que vous devez effectuer pour installer et lancer d'abord Metaflow: <br><br><ul><li>  Installer Metaflow (Python 3 recommand√©): <code>pip3 install metaflow</code> . </li><li>  Mettez le fragment de code ci-dessus ( <a href="https://gist.github.com/Viveckh/95a3348309b158adba062fa031b753a1">ici</a> sur GitHub) dans le fichier <code>linear_flow.py</code> . </li><li>  Pour consulter l'architecture de la cha√Æne de t√¢ches impl√©ment√©e par ce code, utilisez la commande <code>python3 linear_flow.py show</code> . </li><li>  Pour d√©marrer le flux, ex√©cutez la <code>python3 linear_flow.py run</code> . </li></ul><br>  Vous devriez obtenir quelque chose de similaire √† celui illustr√© ci-dessous. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/281/5af/ec5/2815afec51573d8a01db3cd8b4ae19e0.png"></div><br>  <i><font color="#999999">Bilan de sant√© Metaflow r√©ussi</font></i> <br><br>  Ici, il convient de pr√™ter attention √† certaines choses.  Le framework Metaflow cr√©e un <code>.metaflow</code> donn√©es <code>.metaflow</code> local.  L√†, il stocke toutes les m√©tadonn√©es li√©es √† l'ex√©cution des t√¢ches et les instantan√©s associ√©s aux sessions d'ex√©cution des t√¢ches.  Si vous avez configur√© des param√®tres Metaflow li√©s au stockage de donn√©es dans le cloud, les instantan√©s seront stock√©s dans AWS S3 Bucket et les m√©tadonn√©es li√©es aux lancements de t√¢ches iront au service de m√©tadonn√©es bas√© sur RDS (Relational Data Store, Relational Data Store).  Plus tard, nous parlerons de la fa√ßon d'explorer ces m√©tadonn√©es √† l'aide de l'API client.  Une autre bagatelle, bien qu'importante, √† laquelle il convient de pr√™ter attention, est que les identificateurs de processus (pid, ID de processus) attach√©s aux diff√©rentes √©tapes diff√®rent.  N'oubliez pas - nous avons dit ci-dessus que Metaflow conteneurise ind√©pendamment chaque √©tape de la cha√Æne de t√¢ches et effectue chaque √©tape dans son propre environnement (en ne transmettant que les donn√©es entre les √©tapes). <br><br><h3>  <font color="#3AC1EF">‚ñçInstallation et configuration de conda (si vous pr√©voyez d'impl√©menter des d√©pendances)</font> </h3><br>  Suivez ces √©tapes pour installer conda: <br><br><ul><li>  <a href="https://docs.conda.io/en/latest/miniconda.html">T√©l√©chargez</a> et installez Miniconda. </li><li>  Ajoutez <a href="https://docs.conda.io/projects/conda/en/latest/user-guide/concepts/channels.html">un canal conda avec la</a> commande <code>conda config --add channels conda-forge</code> . </li></ul><br>  Vous √™tes maintenant pr√™t √† int√©grer des d√©pendances conda dans vos cha√Ænes de t√¢ches.  Les d√©tails de ce processus seront discut√©s ci-dessous. <br><br><h2>  <font color="#3AC1EF">Exemple de workflow r√©aliste</font> </h2><br>  Ci-dessus, nous avons expliqu√© comment installer Metaflow et comment vous assurer que le syst√®me est op√©rationnel.  De plus, nous avons discut√© des bases de l'architecture de workflow et regard√© un exemple simple.  Nous examinons ici un exemple plus complexe, tout en r√©v√©lant certains des concepts de Metaflow. <br><br><h3>  <font color="#3AC1EF">‚ñçEmploi</font> </h3><br>  Cr√©ez un workflow √† l'aide de Metaflow qui impl√©mente les fonctions suivantes: <br><br><ul><li>  Chargement de donn√©es de film CSV dans une trame de donn√©es Pandas. </li><li>  Calcul parall√®le des quartiles pour les genres. </li><li>  Enregistrement d'un dictionnaire avec les r√©sultats des calculs. </li></ul><br><h3>  <font color="#3AC1EF">‚ñç Cha√Æne de t√¢ches</font> </h3><br>  Le squelette de la classe <code>GenreStatsFlow</code> est illustr√© <code>GenreStatsFlow</code> - <code>GenreStatsFlow</code> .  Apr√®s l'avoir analys√©, vous comprendrez l'essence de l'approche mise en ≈ìuvre ici pour r√©soudre notre probl√®me. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> metaflow <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> FlowSpec, step, catch, retry, IncludeFile, Parameter <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GenreStatsFlow</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(FlowSpec)</span></span></span><span class="hljs-class">:</span></span>  <span class="hljs-string"><span class="hljs-string">"""    ,  ,   .         :    1)  CSV-   Pandas.    2)     .    3)     .  """</span></span>   @step  <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">start</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span>    <span class="hljs-string"><span class="hljs-string">"""         :        1)      Pandas.        2)    .        3)        .    """</span></span>       <span class="hljs-comment"><span class="hljs-comment"># </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment">  CSV         self.genres = []    self.next(self.compute_statistics, foreach='genres') #  1     @catch(var='compute_failed') #  2  @retry(times=1) #  3  @step  def compute_statistics(self):    """    .   ."""    self.genre = self.input #  4    # </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment">        self.next(self.join)     @step  def join(self, inputs):    """       ."""    # </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment">      self.next(self.end)     @step  def end(self):      """End the flow."""      pass   if __name__ == '__main__':  GenreStatsFlow()</span></span></code> </pre> <br>  Consid√©rez certaines parties importantes de cet exemple.  Le code contient des commentaires de la forme <code>#  n</code> , auxquels nous ferons r√©f√©rence ci-dessous. <br><br><ul><li>  Dans le <code> 1</code> , √† l'√©tape de <code>start</code> , faites attention au param√®tre <code>foreach</code> .  Gr√¢ce √† lui, des copies des √©tapes <code>compute_statistics</code> sont <code>compute_statistics</code> en <code>compute_statistics</code> dans une boucle <code>for each</code> entr√©e de la liste des <code>genres</code> . </li><li>  Dans le <code> 2</code> d√©corateur <code>@catch(var='compute_failed')</code> interceptera toute exception qui <code>compute_statistics</code> √©tape <code>compute_statistics</code> et l'√©crira dans la variable <code>compute_failed</code> (il peut √™tre lu √† l'√©tape suivante). </li><li>  Dans le <code> 3</code> d√©corateur <code>@retry(times=1)</code> fait exactement ce que son nom laisse <code>@retry(times=1)</code> .  √Ä savoir, lorsque des erreurs se produisent, il r√©p√®te l'√©tape. </li><li>  D'o√π vient le <code> 4</code> , dans <code>compute_statistics</code> , <code>self.input</code> ?  Le fait est que l' <code>input</code> est une variable de classe fournie par Metaflow.  Il contient des donn√©es applicables √† une instance particuli√®re de <code>compute_statistics</code> (lorsqu'il existe plusieurs copies d'une fonction ex√©cut√©e en parall√®le).  Cette variable n'est ajout√©e par Metaflow que lorsque les n≈ìuds sont repr√©sent√©s par plusieurs processus parall√®les, ou lorsque plusieurs n≈ìuds sont combin√©s. </li><li>  Voici un exemple d'ex√©cution de la m√™me fonction en parall√®le - <code>compute_statistics</code> .  Mais, si n√©cessaire, vous pouvez simultan√©ment ex√©cuter des fonctions compl√®tement diff√©rentes qui ne sont pas li√©es les unes aux autres.  Pour ce faire, changez ce qui est montr√© dans le <code> 1</code> en quelque chose comme <code>self.next(self.func1, self.function2, self.function3)</code> .  Bien s√ªr, avec cette approche, il sera √©galement n√©cessaire de r√©√©crire l'√©tape de <code>join</code> , ce qui permettra de traiter les r√©sultats des diff√©rentes fonctions sur celle-ci. </li></ul><br>  Voici comment imaginer la classe squelette ci-dessus. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7af/b4b/d00/7afb4bd00f2cea2df0ebf9fff780b8d2.png"></div><br>  <i><font color="#999999">Repr√©sentation visuelle de la classe GenreStatsFlow</font></i> <br><br><h3>  <font color="#3AC1EF">‚ñçLisez le fichier de donn√©es et les param√®tres de transfert</font> </h3><br><ul><li>  T√©l√©chargez <a href="https://www.mediafire.com/file/g9vfu4xxqbs4h2o/movies.csv/file">ce</a> fichier CSV de film. </li><li>  Vous devez maintenant √©quiper le programme de la prise en charge de la possibilit√© de transf√©rer dynamiquement le chemin d'acc√®s au fichier <code>movie_data</code> et la valeur <code>max_genres</code> √† la <code>max_genres</code> .  Le m√©canisme des arguments externes nous y aidera.  Metaflow vous permet de passer des arguments au programme en utilisant des indicateurs suppl√©mentaires dans la commande de d√©marrage du workflow.  Par exemple, cela pourrait ressembler √† ceci: <code>python3 tutorial_flow.py run --movie_data=path/to/movies.csv --max_genres=5</code> . </li><li>  Metaflow fournit au d√©veloppeur des objets <code>IncludeFile</code> et <code>Parameter</code> qui vous permettent de lire l'entr√©e dans le code de workflow.  Nous nous r√©f√©rons aux arguments pass√©s en affectant des objets <code>IncludeFile</code> et <code>Parameter</code> aux variables de classe.  Cela d√©pend de ce que nous voulons lire exactement - le fichier ou la valeur habituelle. </li></ul><br>  Voici √† quoi ressemble le code en lisant les param√®tres pass√©s au programme lors de son lancement √† partir de la ligne de commande: <br><br><pre> <code class="python hljs">    movie_data = IncludeFile(<span class="hljs-string"><span class="hljs-string">"movie_data"</span></span>,                             help=<span class="hljs-string"><span class="hljs-string">"The path to a movie metadata file."</span></span>,                             default = <span class="hljs-string"><span class="hljs-string">'movies.csv'</span></span>)                               max_genres = Parameter(<span class="hljs-string"><span class="hljs-string">'max_genres'</span></span>,                help=<span class="hljs-string"><span class="hljs-string">"The max number of genres to return statistics for"</span></span>,                default=<span class="hljs-number"><span class="hljs-number">5</span></span>)</code> </pre> <br><h3>  <font color="#3AC1EF">‚ñçInclusion de conda dans la cha√Æne de t√¢ches</font> </h3><br><ul><li>  Si vous n'avez pas encore install√© conda, reportez-vous √† la section sur l'installation et la configuration de conda dans cet article. </li><li>  Ajoutez le d√©corateur <code>GenreStatsFlow</code> fourni par Metaflow √† la classe GenreStatsFlow.  Ce d√©corateur s'attend √† recevoir la version python.  Il peut √™tre soit d√©fini dans le code, soit obtenu √† l'aide d'une fonction auxiliaire.  Vous trouverez ci-dessous le code qui illustre l'utilisation du d√©corateur et montre une fonction d'assistance. <br><br><pre> <code class="plaintext hljs">def get_python_version():    """     ,    python,       .         conda        python.    """    import platform    versions = {'2' : '2.7.15',                '3' : '3.7.4'}    return versions[platform.python_version_tuple()[0]] #       python. @conda_base(python=get_python_version()) class GenreStatsFlow(FlowSpec):</code> </pre> </li><li>  Vous pouvez maintenant ajouter le d√©corateur <code>@conda</code> √† n'importe quelle √©tape de la cha√Æne de t√¢ches.  Il attend un objet avec des d√©pendances, qui lui est transmis via le param√®tre de <code>libraries</code> .  Metaflow, avant de commencer l'√©tape, se chargera de pr√©parer le conteneur avec les d√©pendances sp√©cifi√©es.  Si n√©cessaire, vous pouvez utiliser en toute s√©curit√© diff√©rentes versions de packages √† diff√©rentes √©tapes, car Metaflow lance chaque √©tape dans un conteneur s√©par√©. <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">    @conda(libraries={'pandas' : '0.24.2'})    @step    def start(self):</span></span></code> </pre> </li><li>  Ex√©cutez maintenant la commande suivante: <code>python3 tutorial_flow.py --environment=conda run</code> . </li></ul><br><h3>  <font color="#3AC1EF">StartD√©but de l'impl√©mentation</font> </h3><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@conda(libraries={'pandas' : '0.24.2'})    @step    def start(self):    """         :        1)      Pandas.        2)    .        3)        .    """        import pandas        from io import StringIO        #      Pandas.        self.dataframe = pandas.read_csv(StringIO(self.movie_data))        #   'genres'      .         #   .        self.genres = {genre for genres \                       in self.dataframe['genres'] \                       for genre in genres.split('|')}        self.genres = list(self.genres)        #        .        #  'foreach'             #          self.next(self.compute_statistics, foreach='genres')</span></span></code> </pre> <br>  Consid√©rez certaines des fonctionnalit√©s de ce code: <br><br><ul><li>  Notez que l'expression d'importation pandas se trouve √† l'int√©rieur de la fonction qui d√©crit l'√©tape.  Le fait est que cette d√©pendance n'est introduite par conda que dans le cadre de cette √©tape. </li><li>  Mais les variables d√©clar√©es ici ( <code>dataframe</code> et <code>genres</code> ) sont disponibles m√™me dans le code des √©tapes effectu√©es apr√®s cette √©tape.  Le fait est que Metaflow fonctionne sur la base des principes de s√©paration des environnements d'ex√©cution de code, mais permet aux donn√©es de se d√©placer naturellement entre les √©tapes de la cha√Æne de t√¢ches. </li></ul><br><h3>  <font color="#3AC1EF">‚ñç Impl√©mentation de l'√©tape compute_statistics</font> </h3><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@catch(var='compute_failed')    @retry    @conda(libraries={'pandas' : '0.25.3'})    @step    def compute_statistics(self):        """            .        """        #             # 'input'.        self.genre = self.input        print("Computing statistics for %s" % self.genre)        #         ,         #        .        selector = self.dataframe['genres'].\                   apply(lambda row: self.genre in row)        self.dataframe = self.dataframe[selector]        self.dataframe = self.dataframe[['movie_title', 'genres', 'gross']]        #     gross   .        points = [.25, .5, .75]        self.quartiles = self.dataframe['gross'].quantile(points).values        #  ,    .        self.next(self.join)</span></span></code> </pre> <br>  Veuillez noter que dans cette √©tape, nous nous r√©f√©rons √† la variable de <code>dataframe</code> qui a √©t√© d√©clar√©e √† l'√©tape de <code>start</code> pr√©c√©dente.  Nous modifions cette variable.  Lorsque vous passez aux √©tapes suivantes, cette approche, qui implique l'utilisation d'un nouvel objet de <code>dataframe</code> modifi√©, vous permet d'organiser un travail efficace avec les donn√©es. <br><br><h3>  <font color="#3AC1EF">‚ñç Mettre en ≈ìuvre l'√©tape de jointure</font> </h3><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@conda(libraries={'pandas' : '0.25.3'})    @step    def join(self, inputs):        """               .        """        inputs = inputs[0:self.max_genres]        #   ,    .        self.genre_stats = {inp.genre.lower(): \                            {'quartiles': inp.quartiles,                             'dataframe': inp.dataframe} \                            for inp in inputs}        self.next(self.end)</span></span></code> </pre> <br>  Ici, il convient de souligner quelques points: <br><br><ul><li>  Dans cette √©tape, nous utilisons une version compl√®tement diff√©rente de la biblioth√®que pandas. </li><li>  Chaque √©l√©ment du tableau d' <code>inputs</code> est une copie des <code>compute_statistics</code> pr√©c√©demment ex√©cut√©es.  Il contient l'√©tat de la fonction correspondante ex√©cut√©e, c'est-√†-dire les valeurs de diverses variables.  Ainsi, l' <code>input[0].quartiles</code> peut contenir des quartiles pour le genre <code>comedy</code> , et l' <code>input[1].quartiles</code> <code>input[0].quartiles</code> peut contenir des quartiles pour le genre <code>sci-fi</code> . </li></ul><br><h3>  <font color="#3AC1EF">EadyProjet pr√™t</font> </h3><br>  Le code de projet complet que nous venons de revoir se trouve <a href="https://github.com/Viveckh/metaflow_crash_course_prep/blob/master/tutorial_flow.py">ici</a> . <br><br>  Pour voir comment fonctionne le flux de travail d√©crit dans le fichier <code>tutorial_flow.py</code> , vous devez ex√©cuter la commande suivante: <br><br><pre> <code class="python hljs">python3 tutorial_flow.py --environment=conda show</code> </pre> <br>  Utilisez la commande suivante pour d√©marrer le workflow: <br><br><pre> <code class="python hljs">python3 tutorial_flow.py --environment=conda run --movie_data=path/to/movies.csv --max_genres=<span class="hljs-number"><span class="hljs-number">7</span></span></code> </pre> <br><h2>  <font color="#3AC1EF">Examen des r√©sultats de l'ex√©cution d'un flux de travail √† l'aide de l'API client</font> </h2><br>  Afin d'examiner des instantan√©s de donn√©es et l'√©tat des lancements pr√©c√©dents du flux de travail, vous pouvez utiliser l' <a href="https://docs.metaflow.org/metaflow/client">API</a> client fournie par Metaflow.  Cette API est id√©ale pour explorer les d√©tails des exp√©riences effectu√©es dans l'environnement Jupyter Notebook. <br><br>  Voici un exemple simple de la sortie de la variable <code>genre_stats</code> , tir√©e des donn√©es du dernier lancement r√©ussi de <code>GenreStatsFlow</code> . <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> metaflow <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Flow, get_metadata <span class="hljs-comment"><span class="hljs-comment">#      print("Using metadata provider: %s" % get_metadata()) #     MovieStatsFlow. run = Flow('GenreStatsFlow').latest_successful_run print("Using analysis from '%s'" % str(run)) genre_stats = run.data.genre_stats print(genre_stats)</span></span></code> </pre> <br><h2>  <font color="#3AC1EF">Ex√©cution de workflows dans le cloud</font> </h2><br>  Apr√®s avoir cr√©√© et test√© le flux de travail sur un ordinateur ordinaire, il est tr√®s probable que vous souhaitiez ex√©cuter le code dans le cloud pour acc√©l√©rer le travail. <br><br>  Actuellement, Metaflow prend uniquement en charge l'int√©gration avec AWS.  Dans l'image suivante, vous pouvez voir un mappage des ressources locales et cloud utilis√©es par Metaflow. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/08a/acc/458/08aacc458fc3202ec08624422bef0cb4.png"></div><br>  <i><font color="#999999">Int√©gration de Metaflow et AWS</font></i> <br><br>  Pour connecter Metaflow √† AWS, vous devez effectuer les √©tapes suivantes: <br><br><ul><li>  Vous devez d'abord effectuer une configuration AWS unique en cr√©ant des ressources avec lesquelles Metaflow peut travailler.  Les m√™mes ressources peuvent √™tre utilis√©es, par exemple, par des membres d'une √©quipe de travail qui se d√©montrent mutuellement les r√©sultats des workflows.  <a href="https://docs.metaflow.org/metaflow-on-aws/deploy-to-aws">Vous</a> pouvez trouver des instructions pertinentes ici.  Les param√®tres sont assez rapides, car Metaflow dispose d'un mod√®le de param√®tres CloudFormation. </li><li>  Ensuite, sur l'ordinateur local, vous devez ex√©cuter la <code>metaflow configure aws</code> et entrer les r√©ponses aux questions syst√®me.  Avec ces donn√©es, Metaflow pourra utiliser des entrep√¥ts de donn√©es bas√©s sur le cloud. </li><li>  Maintenant, pour d√©marrer des workflows locaux dans le cloud, ajoutez simplement la cl√© de <code>--with batch</code> √† la <code>--with batch</code> d√©marrage du workflow.  Par exemple, cela pourrait ressembler √† ceci: <code>python3 sample_flow.py run --with batch</code> . </li><li>  Pour effectuer un lancement hybride du flux de travail, c'est-√†-dire pour effectuer certaines √©tapes localement et d'autres dans le cloud, vous devez ajouter le d√©corateur <code>@batch</code> aux √©tapes qui doivent √™tre effectu√©es dans le cloud.  Par exemple, comme ceci: <code>@batch(cpu=1, memory=500)</code> . </li></ul><br><h2>  <font color="#3AC1EF">R√©sum√©</font> </h2><br>  Ici, je voudrais noter quelques fonctionnalit√©s de Metaflow qui peuvent √™tre consid√©r√©es √† la fois comme les avantages et les inconv√©nients de ce cadre: <br><br><ul><li>  Metaflow est √©troitement int√©gr√© √† AWS.  Mais dans les plans de d√©veloppement du cadre, il existe un support pour un plus grand nombre de fournisseurs de cloud. </li><li>  Metaflow est un outil qui ne prend en charge que l'interface de ligne de commande.  Il ne poss√®de pas d'interface graphique (contrairement √† d'autres cadres universels pour organiser les processus de travail, tels que Airflow). </li></ul><br>  <b>Chers lecteurs!</b>  Envisagez-vous d'utiliser Metaflow? <br><br> <a href="https://ruvds.com/ru-rub/"><img src="https://habrastorage.org/files/1ba/550/d25/1ba550d25e8846ce8805de564da6aa63.png"></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr482462/">https://habr.com/ru/post/fr482462/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr482442/index.html">La plus grande technologie √©choue de 2019</a></li>
<li><a href="../fr482446/index.html">Prions - peur et horreur de l'avenir</a></li>
<li><a href="../fr482452/index.html">Le syst√®me br√©silien n'est pas un mythe. Comment l'utiliser en informatique?</a></li>
<li><a href="../fr482456/index.html">Notre FunCode, ou comment nous avons organis√© un concours pour les d√©veloppeurs iOS</a></li>
<li><a href="../fr482458/index.html">5 fonctionnalit√©s Python que je ne connaissais pas - mais en vain</a></li>
<li><a href="../fr482464/index.html">Que sont * args et ** kwargs en Python?</a></li>
<li><a href="../fr482468/index.html">5 extensions et th√®mes pour VS Code qui peuvent changer la vie d'un d√©veloppeur front-end</a></li>
<li><a href="../fr482470/index.html">Chargement de page rapide sur les t√©l√©phones bon march√© les plus simples</a></li>
<li><a href="../fr482472/index.html">De quoi JavaScript est-il fait?</a></li>
<li><a href="../fr482478/index.html">Iteraptor: biblioth√®que pour redus de carte transparent profond</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>