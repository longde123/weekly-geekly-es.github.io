<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🔬 🌡️ 👈🏼 Apprenez Metaflow en 10 minutes ♀️ 🛀🏻 🛂</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Metaflow est un framework Python créé dans Netflix et axé sur le domaine de la science des données. À savoir, il est conçu pour créer des projets visa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Apprenez Metaflow en 10 minutes</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/482462/">  Metaflow est un framework Python créé dans Netflix et axé sur le domaine de la science des données.  À savoir, il est conçu pour créer des projets visant à travailler avec des données et pour gérer de tels projets.  Récemment, la société l'a transféré dans la catégorie open-source.  Le framework Metaflow a été largement utilisé au sein de Netflix au cours des 2 dernières années.  En particulier, il a permis de réduire considérablement le temps nécessaire à la conclusion des projets en production. <br><br> <a href="https://habr.com/ru/company/ruvds/blog/482462/"><img src="https://habrastorage.org/webt/yd/2j/7p/yd2j7p_dpzkyrjeef9us6a7pgs4.png"></a> <br><br>  Le matériel que nous traduisons aujourd'hui est un guide rapide de Metaflow. <br><a name="habracut"></a><br><h2>  <font color="#3AC1EF">Qu'est-ce que Metaflow?</font> </h2><br>  Vous trouverez ci-dessous un graphique illustrant la mise en œuvre du cadre Metaflow dans Netflix. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6bd/bb8/297/6bdbb82972a098b8fd241f42d7f55b51.png"></div><br>  <i><font color="#999999">Implémentation de Metaflow dans Netflix</font></i> <br><br>  En novembre 2018, ce cadre a été utilisé dans 134 projets de l'entreprise. <br><br>  Metaflow est un cadre pour créer et exécuter des workflows de science des données.  Il présente les fonctionnalités suivantes: <br><br><ul><li>  Gestion des ressources informatiques. </li><li>  Lancement de tâche conteneurisée. </li><li>  Gestion des dépendances externes. </li><li>  Gestion des versions, réexécution des tâches, poursuite de l'exécution des tâches suspendues. </li><li>  API client pour examiner les résultats des tâches qui peuvent être utilisées dans l'environnement Jupyter Notebook. </li><li>  Prise en charge de l'exécution de tâches locales (par exemple, sur un ordinateur portable) et à distance (dans le cloud).  Possibilité de basculer entre ces modes. </li></ul><br>  L'utilisateur vtuulos a <a href="https://news.ycombinator.com/item%3Fid%3D21698711">écrit</a> sur Ycombinator que Metaflow peut automatiquement créer des instantanés (instantanés) de code, de données et de dépendances.  Tout cela est placé dans un référentiel avec adressage par contenu, qui est généralement basé sur S3, bien que le système de fichiers local soit également pris en charge.  Cela vous permet de continuer à exécuter des tâches arrêtées, de reproduire les résultats précédemment obtenus et d'explorer tout ce qui concerne les tâches, par exemple dans le bloc-notes Jupyter. <br><br>  En général, nous pouvons dire que Metaflow vise à augmenter la productivité des scientifiques de données.  Cela est dû au fait que le cadre leur permet de s'engager exclusivement dans le travail avec des données, sans être distrait par la résolution de tâches connexes.  De plus, Metaflow accélère le retrait des projets basés sur celui-ci en production. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d16/311/176/d1631117682028c779664c90bef2a885.png"></div><br>  <i><font color="#999999">Les besoins d'un data scientist liés à ses responsabilités directes et la solution des tâches auxiliaires liées à l'infrastructure sur laquelle les calculs sont effectués</font></i> <br><br><h2>  <font color="#3AC1EF">Scénarios de workflow avec Metaflow</font> </h2><br>  Voici quelques scénarios de workflow que vous pouvez organiser à l'aide de Metaflow: <br><br><ul><li>  <b>Collaboration</b>  Un data scientist veut aider un autre à trouver la source de l'erreur.  Dans le même temps, l'assistant souhaite télécharger sur son ordinateur l'ensemble de l'environnement dans lequel la tâche qui s'est écrasée a fonctionné. </li><li>  <b>Poursuite des tâches arrêtées depuis l'endroit où elles ont été arrêtées.</b>  Une tâche s'est arrêtée avec une erreur (ou a été arrêtée intentionnellement).  L'erreur a été corrigée (ou le code a été modifié).  Il est nécessaire de redémarrer la tâche pour que son travail continue à partir de l'endroit où elle a échoué (ou a été arrêtée). </li><li>  <b>Exécution de tâches hybrides.</b>  Vous devez effectuer une certaine étape du flux de travail localement (il s'agit peut-être de télécharger des données à partir d'un fichier stocké dans un dossier sur l'ordinateur), et une autre étape qui nécessite de grandes ressources de calcul (il s'agit peut-être de la formation du modèle) doit être effectuée dans le cloud. </li><li>  <b>Examen des métadonnées obtenues après avoir terminé une tâche.</b>  Trois scientifiques des données sont engagés dans la sélection d'hyperparamètres du même modèle, en essayant d'améliorer la précision de ce modèle.  Après cela, vous devez analyser les résultats de l'exécution des tâches de formation du modèle et sélectionner l'ensemble d'hyperparamètres qui s'est avéré être le meilleur. </li><li>  <b>Utilisation de plusieurs versions du même package.</b>  Dans le projet, vous devez utiliser différentes versions, par exemple, les bibliothèques sklearn.  Pendant le prétraitement, sa version 0.20 est requise et pendant la modélisation, la version 0.22 est requise. </li></ul><br><h2>  <font color="#3AC1EF">Flux de travail typique de Metaflow</font> </h2><br>  Considérez un flux de travail Metaflow typique d'un point de vue conceptuel et de programmation. <br><br><h3>  <font color="#3AC1EF">LookAvis conceptuel sur le flux de travail Metaflow</font> </h3><br>  D'un point de vue conceptuel, les workflows Metaflow (chaînes de tâches) sont représentés par des <a href="https://ru.wikipedia.org/wiki/%25D0%259E%25D1%2580%25D0%25B8%25D0%25B5%25D0%25BD%25D1%2582%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B9_%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BA%25D0%25BB%25D0%25B8%25D1%2587%25D0%25B5%25D1%2581%25D0%25BA%25D0%25B8%25D0%25B9_%25D0%25B3%25D1%2580%25D0%25B0%25D1%2584">graphiques acycliques dirigés</a> (DAG).  Les illustrations ci-dessous vous aideront à mieux comprendre cette idée. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/584/53d/52e/58453d52e9dfbd50dcc5b974ffae11e1.png"></div><br>  <i><font color="#999999">Graphique acyclique linéaire</font></i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3d7/a8d/810/3d7a8d81017d4112913a5c081c70b9a8.png"></div><br>  <i><font color="#999999">Graphique acyclique avec chemins "parallèles"</font></i> <br><br>  Chaque nœud du graphique représente une étape de traitement des données dans le flux de travail. <br><br>  À chaque étape de la chaîne de tâches, Metaflow exécute du code Python normal sans aucune modification spéciale.  Le code est exécuté dans des conteneurs séparés dans lesquels le code est compressé avec ses dépendances. <br><br>  Un aspect clé de l'architecture Metaflow est représenté par le fait qu'il vous permet d'implémenter presque toutes les bibliothèques externes de l'écosystème conda dans des projets basés sur celui-ci sans utiliser de plugins.  Cela distingue Metaflow des autres solutions polyvalentes similaires.  Par exemple - depuis Airflow. <br><br><h3>  <font color="#3AC1EF">▍ Flux de travail Metaflow en termes de programmation</font> </h3><br>  Chaque chaîne de tâches (flux) peut être représentée comme une classe Python standard (les noms de ces classes ont généralement le mot <code>Flow</code> ) si elle satisfait aux exigences minimales suivantes: <br><br><ul><li>  La classe est la descendante de la classe Metaflow <code>FlowSpec</code> . </li><li>  Le <code>@step</code> chaque fonction qui représente une étape de la chaîne de tâches. </li><li>  À la fin de chaque fonction <code>@step</code> , il doit y avoir une indication d'une fonction similaire qui la suit.  Cela peut être fait en utilisant une construction de ce type: <code>self.next(self.function_name_here)</code> . </li><li>  La classe implémente les fonctions de <code>start</code> et de <code>end</code> . </li></ul><br>  Prenons un exemple de chaîne minimale de tâches composée de trois nœuds. <br><br>  Son schéma ressemble à ceci: <br><br><pre> <code class="python hljs">start → process_message → end</code> </pre> <br>  Voici son code: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> metaflow <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> FlowSpec, step <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LinearFlow</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(FlowSpec)</span></span></span><span class="hljs-class">:</span></span>         <span class="hljs-string"><span class="hljs-string">"""     ,      Metaflow.    """</span></span>       <span class="hljs-comment"><span class="hljs-comment">#         @step    def start(self):        self.message = 'Thanks for reading.'        self.next(self.process_message)    @step    def process_message(self):        print('the message is: %s' % self.message)        self.next(self.end)    @step    def end(self):        print('the message is still: %s' % self.message) if __name__ == '__main__':    LinearFlow()</span></span></code> </pre> <br><h2>  <font color="#3AC1EF">Instructions d'installation de Metaflow</font> </h2><br><h3>  <font color="#3AC1EF">▍Installation et essai</font> </h3><br>  Voici la séquence d'étapes que vous devez effectuer pour installer et lancer d'abord Metaflow: <br><br><ul><li>  Installer Metaflow (Python 3 recommandé): <code>pip3 install metaflow</code> . </li><li>  Mettez le fragment de code ci-dessus ( <a href="https://gist.github.com/Viveckh/95a3348309b158adba062fa031b753a1">ici</a> sur GitHub) dans le fichier <code>linear_flow.py</code> . </li><li>  Pour consulter l'architecture de la chaîne de tâches implémentée par ce code, utilisez la commande <code>python3 linear_flow.py show</code> . </li><li>  Pour démarrer le flux, exécutez la <code>python3 linear_flow.py run</code> . </li></ul><br>  Vous devriez obtenir quelque chose de similaire à celui illustré ci-dessous. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/281/5af/ec5/2815afec51573d8a01db3cd8b4ae19e0.png"></div><br>  <i><font color="#999999">Bilan de santé Metaflow réussi</font></i> <br><br>  Ici, il convient de prêter attention à certaines choses.  Le framework Metaflow crée un <code>.metaflow</code> données <code>.metaflow</code> local.  Là, il stocke toutes les métadonnées liées à l'exécution des tâches et les instantanés associés aux sessions d'exécution des tâches.  Si vous avez configuré des paramètres Metaflow liés au stockage de données dans le cloud, les instantanés seront stockés dans AWS S3 Bucket et les métadonnées liées aux lancements de tâches iront au service de métadonnées basé sur RDS (Relational Data Store, Relational Data Store).  Plus tard, nous parlerons de la façon d'explorer ces métadonnées à l'aide de l'API client.  Une autre bagatelle, bien qu'importante, à laquelle il convient de prêter attention, est que les identificateurs de processus (pid, ID de processus) attachés aux différentes étapes diffèrent.  N'oubliez pas - nous avons dit ci-dessus que Metaflow conteneurise indépendamment chaque étape de la chaîne de tâches et effectue chaque étape dans son propre environnement (en ne transmettant que les données entre les étapes). <br><br><h3>  <font color="#3AC1EF">▍Installation et configuration de conda (si vous prévoyez d'implémenter des dépendances)</font> </h3><br>  Suivez ces étapes pour installer conda: <br><br><ul><li>  <a href="https://docs.conda.io/en/latest/miniconda.html">Téléchargez</a> et installez Miniconda. </li><li>  Ajoutez <a href="https://docs.conda.io/projects/conda/en/latest/user-guide/concepts/channels.html">un canal conda avec la</a> commande <code>conda config --add channels conda-forge</code> . </li></ul><br>  Vous êtes maintenant prêt à intégrer des dépendances conda dans vos chaînes de tâches.  Les détails de ce processus seront discutés ci-dessous. <br><br><h2>  <font color="#3AC1EF">Exemple de workflow réaliste</font> </h2><br>  Ci-dessus, nous avons expliqué comment installer Metaflow et comment vous assurer que le système est opérationnel.  De plus, nous avons discuté des bases de l'architecture de workflow et regardé un exemple simple.  Nous examinons ici un exemple plus complexe, tout en révélant certains des concepts de Metaflow. <br><br><h3>  <font color="#3AC1EF">▍Emploi</font> </h3><br>  Créez un workflow à l'aide de Metaflow qui implémente les fonctions suivantes: <br><br><ul><li>  Chargement de données de film CSV dans une trame de données Pandas. </li><li>  Calcul parallèle des quartiles pour les genres. </li><li>  Enregistrement d'un dictionnaire avec les résultats des calculs. </li></ul><br><h3>  <font color="#3AC1EF">▍ Chaîne de tâches</font> </h3><br>  Le squelette de la classe <code>GenreStatsFlow</code> est illustré <code>GenreStatsFlow</code> - <code>GenreStatsFlow</code> .  Après l'avoir analysé, vous comprendrez l'essence de l'approche mise en œuvre ici pour résoudre notre problème. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> metaflow <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> FlowSpec, step, catch, retry, IncludeFile, Parameter <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GenreStatsFlow</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(FlowSpec)</span></span></span><span class="hljs-class">:</span></span>  <span class="hljs-string"><span class="hljs-string">"""    ,  ,   .         :    1)  CSV-   Pandas.    2)     .    3)     .  """</span></span>   @step  <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">start</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span>    <span class="hljs-string"><span class="hljs-string">"""         :        1)      Pandas.        2)    .        3)        .    """</span></span>       <span class="hljs-comment"><span class="hljs-comment"># </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment">  CSV         self.genres = []    self.next(self.compute_statistics, foreach='genres') #  1     @catch(var='compute_failed') #  2  @retry(times=1) #  3  @step  def compute_statistics(self):    """    .   ."""    self.genre = self.input #  4    # </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment">        self.next(self.join)     @step  def join(self, inputs):    """       ."""    # </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment">      self.next(self.end)     @step  def end(self):      """End the flow."""      pass   if __name__ == '__main__':  GenreStatsFlow()</span></span></code> </pre> <br>  Considérez certaines parties importantes de cet exemple.  Le code contient des commentaires de la forme <code>#  n</code> , auxquels nous ferons référence ci-dessous. <br><br><ul><li>  Dans le <code> 1</code> , à l'étape de <code>start</code> , faites attention au paramètre <code>foreach</code> .  Grâce à lui, des copies des étapes <code>compute_statistics</code> sont <code>compute_statistics</code> en <code>compute_statistics</code> dans une boucle <code>for each</code> entrée de la liste des <code>genres</code> . </li><li>  Dans le <code> 2</code> décorateur <code>@catch(var='compute_failed')</code> interceptera toute exception qui <code>compute_statistics</code> étape <code>compute_statistics</code> et l'écrira dans la variable <code>compute_failed</code> (il peut être lu à l'étape suivante). </li><li>  Dans le <code> 3</code> décorateur <code>@retry(times=1)</code> fait exactement ce que son nom laisse <code>@retry(times=1)</code> .  À savoir, lorsque des erreurs se produisent, il répète l'étape. </li><li>  D'où vient le <code> 4</code> , dans <code>compute_statistics</code> , <code>self.input</code> ?  Le fait est que l' <code>input</code> est une variable de classe fournie par Metaflow.  Il contient des données applicables à une instance particulière de <code>compute_statistics</code> (lorsqu'il existe plusieurs copies d'une fonction exécutée en parallèle).  Cette variable n'est ajoutée par Metaflow que lorsque les nœuds sont représentés par plusieurs processus parallèles, ou lorsque plusieurs nœuds sont combinés. </li><li>  Voici un exemple d'exécution de la même fonction en parallèle - <code>compute_statistics</code> .  Mais, si nécessaire, vous pouvez simultanément exécuter des fonctions complètement différentes qui ne sont pas liées les unes aux autres.  Pour ce faire, changez ce qui est montré dans le <code> 1</code> en quelque chose comme <code>self.next(self.func1, self.function2, self.function3)</code> .  Bien sûr, avec cette approche, il sera également nécessaire de réécrire l'étape de <code>join</code> , ce qui permettra de traiter les résultats des différentes fonctions sur celle-ci. </li></ul><br>  Voici comment imaginer la classe squelette ci-dessus. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7af/b4b/d00/7afb4bd00f2cea2df0ebf9fff780b8d2.png"></div><br>  <i><font color="#999999">Représentation visuelle de la classe GenreStatsFlow</font></i> <br><br><h3>  <font color="#3AC1EF">▍Lisez le fichier de données et les paramètres de transfert</font> </h3><br><ul><li>  Téléchargez <a href="https://www.mediafire.com/file/g9vfu4xxqbs4h2o/movies.csv/file">ce</a> fichier CSV de film. </li><li>  Vous devez maintenant équiper le programme de la prise en charge de la possibilité de transférer dynamiquement le chemin d'accès au fichier <code>movie_data</code> et la valeur <code>max_genres</code> à la <code>max_genres</code> .  Le mécanisme des arguments externes nous y aidera.  Metaflow vous permet de passer des arguments au programme en utilisant des indicateurs supplémentaires dans la commande de démarrage du workflow.  Par exemple, cela pourrait ressembler à ceci: <code>python3 tutorial_flow.py run --movie_data=path/to/movies.csv --max_genres=5</code> . </li><li>  Metaflow fournit au développeur des objets <code>IncludeFile</code> et <code>Parameter</code> qui vous permettent de lire l'entrée dans le code de workflow.  Nous nous référons aux arguments passés en affectant des objets <code>IncludeFile</code> et <code>Parameter</code> aux variables de classe.  Cela dépend de ce que nous voulons lire exactement - le fichier ou la valeur habituelle. </li></ul><br>  Voici à quoi ressemble le code en lisant les paramètres passés au programme lors de son lancement à partir de la ligne de commande: <br><br><pre> <code class="python hljs">    movie_data = IncludeFile(<span class="hljs-string"><span class="hljs-string">"movie_data"</span></span>,                             help=<span class="hljs-string"><span class="hljs-string">"The path to a movie metadata file."</span></span>,                             default = <span class="hljs-string"><span class="hljs-string">'movies.csv'</span></span>)                               max_genres = Parameter(<span class="hljs-string"><span class="hljs-string">'max_genres'</span></span>,                help=<span class="hljs-string"><span class="hljs-string">"The max number of genres to return statistics for"</span></span>,                default=<span class="hljs-number"><span class="hljs-number">5</span></span>)</code> </pre> <br><h3>  <font color="#3AC1EF">▍Inclusion de conda dans la chaîne de tâches</font> </h3><br><ul><li>  Si vous n'avez pas encore installé conda, reportez-vous à la section sur l'installation et la configuration de conda dans cet article. </li><li>  Ajoutez le décorateur <code>GenreStatsFlow</code> fourni par Metaflow à la classe GenreStatsFlow.  Ce décorateur s'attend à recevoir la version python.  Il peut être soit défini dans le code, soit obtenu à l'aide d'une fonction auxiliaire.  Vous trouverez ci-dessous le code qui illustre l'utilisation du décorateur et montre une fonction d'assistance. <br><br><pre> <code class="plaintext hljs">def get_python_version():    """     ,    python,       .         conda        python.    """    import platform    versions = {'2' : '2.7.15',                '3' : '3.7.4'}    return versions[platform.python_version_tuple()[0]] #       python. @conda_base(python=get_python_version()) class GenreStatsFlow(FlowSpec):</code> </pre> </li><li>  Vous pouvez maintenant ajouter le décorateur <code>@conda</code> à n'importe quelle étape de la chaîne de tâches.  Il attend un objet avec des dépendances, qui lui est transmis via le paramètre de <code>libraries</code> .  Metaflow, avant de commencer l'étape, se chargera de préparer le conteneur avec les dépendances spécifiées.  Si nécessaire, vous pouvez utiliser en toute sécurité différentes versions de packages à différentes étapes, car Metaflow lance chaque étape dans un conteneur séparé. <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">    @conda(libraries={'pandas' : '0.24.2'})    @step    def start(self):</span></span></code> </pre> </li><li>  Exécutez maintenant la commande suivante: <code>python3 tutorial_flow.py --environment=conda run</code> . </li></ul><br><h3>  <font color="#3AC1EF">StartDébut de l'implémentation</font> </h3><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@conda(libraries={'pandas' : '0.24.2'})    @step    def start(self):    """         :        1)      Pandas.        2)    .        3)        .    """        import pandas        from io import StringIO        #      Pandas.        self.dataframe = pandas.read_csv(StringIO(self.movie_data))        #   'genres'      .         #   .        self.genres = {genre for genres \                       in self.dataframe['genres'] \                       for genre in genres.split('|')}        self.genres = list(self.genres)        #        .        #  'foreach'             #          self.next(self.compute_statistics, foreach='genres')</span></span></code> </pre> <br>  Considérez certaines des fonctionnalités de ce code: <br><br><ul><li>  Notez que l'expression d'importation pandas se trouve à l'intérieur de la fonction qui décrit l'étape.  Le fait est que cette dépendance n'est introduite par conda que dans le cadre de cette étape. </li><li>  Mais les variables déclarées ici ( <code>dataframe</code> et <code>genres</code> ) sont disponibles même dans le code des étapes effectuées après cette étape.  Le fait est que Metaflow fonctionne sur la base des principes de séparation des environnements d'exécution de code, mais permet aux données de se déplacer naturellement entre les étapes de la chaîne de tâches. </li></ul><br><h3>  <font color="#3AC1EF">▍ Implémentation de l'étape compute_statistics</font> </h3><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@catch(var='compute_failed')    @retry    @conda(libraries={'pandas' : '0.25.3'})    @step    def compute_statistics(self):        """            .        """        #             # 'input'.        self.genre = self.input        print("Computing statistics for %s" % self.genre)        #         ,         #        .        selector = self.dataframe['genres'].\                   apply(lambda row: self.genre in row)        self.dataframe = self.dataframe[selector]        self.dataframe = self.dataframe[['movie_title', 'genres', 'gross']]        #     gross   .        points = [.25, .5, .75]        self.quartiles = self.dataframe['gross'].quantile(points).values        #  ,    .        self.next(self.join)</span></span></code> </pre> <br>  Veuillez noter que dans cette étape, nous nous référons à la variable de <code>dataframe</code> qui a été déclarée à l'étape de <code>start</code> précédente.  Nous modifions cette variable.  Lorsque vous passez aux étapes suivantes, cette approche, qui implique l'utilisation d'un nouvel objet de <code>dataframe</code> modifié, vous permet d'organiser un travail efficace avec les données. <br><br><h3>  <font color="#3AC1EF">▍ Mettre en œuvre l'étape de jointure</font> </h3><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@conda(libraries={'pandas' : '0.25.3'})    @step    def join(self, inputs):        """               .        """        inputs = inputs[0:self.max_genres]        #   ,    .        self.genre_stats = {inp.genre.lower(): \                            {'quartiles': inp.quartiles,                             'dataframe': inp.dataframe} \                            for inp in inputs}        self.next(self.end)</span></span></code> </pre> <br>  Ici, il convient de souligner quelques points: <br><br><ul><li>  Dans cette étape, nous utilisons une version complètement différente de la bibliothèque pandas. </li><li>  Chaque élément du tableau d' <code>inputs</code> est une copie des <code>compute_statistics</code> précédemment exécutées.  Il contient l'état de la fonction correspondante exécutée, c'est-à-dire les valeurs de diverses variables.  Ainsi, l' <code>input[0].quartiles</code> peut contenir des quartiles pour le genre <code>comedy</code> , et l' <code>input[1].quartiles</code> <code>input[0].quartiles</code> peut contenir des quartiles pour le genre <code>sci-fi</code> . </li></ul><br><h3>  <font color="#3AC1EF">EadyProjet prêt</font> </h3><br>  Le code de projet complet que nous venons de revoir se trouve <a href="https://github.com/Viveckh/metaflow_crash_course_prep/blob/master/tutorial_flow.py">ici</a> . <br><br>  Pour voir comment fonctionne le flux de travail décrit dans le fichier <code>tutorial_flow.py</code> , vous devez exécuter la commande suivante: <br><br><pre> <code class="python hljs">python3 tutorial_flow.py --environment=conda show</code> </pre> <br>  Utilisez la commande suivante pour démarrer le workflow: <br><br><pre> <code class="python hljs">python3 tutorial_flow.py --environment=conda run --movie_data=path/to/movies.csv --max_genres=<span class="hljs-number"><span class="hljs-number">7</span></span></code> </pre> <br><h2>  <font color="#3AC1EF">Examen des résultats de l'exécution d'un flux de travail à l'aide de l'API client</font> </h2><br>  Afin d'examiner des instantanés de données et l'état des lancements précédents du flux de travail, vous pouvez utiliser l' <a href="https://docs.metaflow.org/metaflow/client">API</a> client fournie par Metaflow.  Cette API est idéale pour explorer les détails des expériences effectuées dans l'environnement Jupyter Notebook. <br><br>  Voici un exemple simple de la sortie de la variable <code>genre_stats</code> , tirée des données du dernier lancement réussi de <code>GenreStatsFlow</code> . <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> metaflow <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Flow, get_metadata <span class="hljs-comment"><span class="hljs-comment">#      print("Using metadata provider: %s" % get_metadata()) #     MovieStatsFlow. run = Flow('GenreStatsFlow').latest_successful_run print("Using analysis from '%s'" % str(run)) genre_stats = run.data.genre_stats print(genre_stats)</span></span></code> </pre> <br><h2>  <font color="#3AC1EF">Exécution de workflows dans le cloud</font> </h2><br>  Après avoir créé et testé le flux de travail sur un ordinateur ordinaire, il est très probable que vous souhaitiez exécuter le code dans le cloud pour accélérer le travail. <br><br>  Actuellement, Metaflow prend uniquement en charge l'intégration avec AWS.  Dans l'image suivante, vous pouvez voir un mappage des ressources locales et cloud utilisées par Metaflow. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/08a/acc/458/08aacc458fc3202ec08624422bef0cb4.png"></div><br>  <i><font color="#999999">Intégration de Metaflow et AWS</font></i> <br><br>  Pour connecter Metaflow à AWS, vous devez effectuer les étapes suivantes: <br><br><ul><li>  Vous devez d'abord effectuer une configuration AWS unique en créant des ressources avec lesquelles Metaflow peut travailler.  Les mêmes ressources peuvent être utilisées, par exemple, par des membres d'une équipe de travail qui se démontrent mutuellement les résultats des workflows.  <a href="https://docs.metaflow.org/metaflow-on-aws/deploy-to-aws">Vous</a> pouvez trouver des instructions pertinentes ici.  Les paramètres sont assez rapides, car Metaflow dispose d'un modèle de paramètres CloudFormation. </li><li>  Ensuite, sur l'ordinateur local, vous devez exécuter la <code>metaflow configure aws</code> et entrer les réponses aux questions système.  Avec ces données, Metaflow pourra utiliser des entrepôts de données basés sur le cloud. </li><li>  Maintenant, pour démarrer des workflows locaux dans le cloud, ajoutez simplement la clé de <code>--with batch</code> à la <code>--with batch</code> démarrage du workflow.  Par exemple, cela pourrait ressembler à ceci: <code>python3 sample_flow.py run --with batch</code> . </li><li>  Pour effectuer un lancement hybride du flux de travail, c'est-à-dire pour effectuer certaines étapes localement et d'autres dans le cloud, vous devez ajouter le décorateur <code>@batch</code> aux étapes qui doivent être effectuées dans le cloud.  Par exemple, comme ceci: <code>@batch(cpu=1, memory=500)</code> . </li></ul><br><h2>  <font color="#3AC1EF">Résumé</font> </h2><br>  Ici, je voudrais noter quelques fonctionnalités de Metaflow qui peuvent être considérées à la fois comme les avantages et les inconvénients de ce cadre: <br><br><ul><li>  Metaflow est étroitement intégré à AWS.  Mais dans les plans de développement du cadre, il existe un support pour un plus grand nombre de fournisseurs de cloud. </li><li>  Metaflow est un outil qui ne prend en charge que l'interface de ligne de commande.  Il ne possède pas d'interface graphique (contrairement à d'autres cadres universels pour organiser les processus de travail, tels que Airflow). </li></ul><br>  <b>Chers lecteurs!</b>  Envisagez-vous d'utiliser Metaflow? <br><br> <a href="https://ruvds.com/ru-rub/"><img src="https://habrastorage.org/files/1ba/550/d25/1ba550d25e8846ce8805de564da6aa63.png"></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr482462/">https://habr.com/ru/post/fr482462/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr482442/index.html">La plus grande technologie échoue de 2019</a></li>
<li><a href="../fr482446/index.html">Prions - peur et horreur de l'avenir</a></li>
<li><a href="../fr482452/index.html">Le système brésilien n'est pas un mythe. Comment l'utiliser en informatique?</a></li>
<li><a href="../fr482456/index.html">Notre FunCode, ou comment nous avons organisé un concours pour les développeurs iOS</a></li>
<li><a href="../fr482458/index.html">5 fonctionnalités Python que je ne connaissais pas - mais en vain</a></li>
<li><a href="../fr482464/index.html">Que sont * args et ** kwargs en Python?</a></li>
<li><a href="../fr482468/index.html">5 extensions et thèmes pour VS Code qui peuvent changer la vie d'un développeur front-end</a></li>
<li><a href="../fr482470/index.html">Chargement de page rapide sur les téléphones bon marché les plus simples</a></li>
<li><a href="../fr482472/index.html">De quoi JavaScript est-il fait?</a></li>
<li><a href="../fr482478/index.html">Iteraptor: bibliothèque pour redus de carte transparent profond</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>