<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöÅ ‚ôøÔ∏è üëµ Pruebas escamosas ‚óªÔ∏è üèß üëÇüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="¬øQu√© es m√°s desagradable que la "prueba roja"? La prueba es verde o roja, y no est√° claro por qu√©. En nuestra conferencia Heisenbug 2017 en Mosc√∫, And...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Pruebas escamosas</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/jugru/blog/416757/">  ¬øQu√© es m√°s desagradable que la "prueba roja"?  La prueba es verde o roja, y no est√° claro por qu√©.  En nuestra conferencia Heisenbug 2017 en Mosc√∫, <b>Andrei Solntsev</b> (Codeborne) habl√≥ sobre por qu√© podr√≠an surgir y c√≥mo reducir su n√∫mero.  Los ejemplos en su informe son tales que siente el dolor directamente en la piel cuando choca con ellos.  Y los consejos son √∫tiles, y vale la pena conocer tanto a los evaluadores como a los desarrolladores.  Hay algo inesperado: puedes descubrir c√≥mo a veces puedes resolver un problema si te separas de la pantalla y juegas cubos con tu hija. <br><br>  Como resultado, el p√∫blico agradeci√≥ el informe, y decidimos no solo publicar el video, sino tambi√©n hacer una versi√≥n de texto del informe para Habr. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/jLG3RXECQU8" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><a name="habracut"></a><br>  En mi opini√≥n, las pruebas escamosas son el tema m√°s relevante en el mundo de la automatizaci√≥n.  Porque la pregunta "¬øqu√© se est√° haciendo en el mundo, c√≥mo te va con la automatizaci√≥n?"  todos responden: "¬°No hay estabilidad!  Nuestras pruebas caen peri√≥dicamente ". <br><br>  Hiciste una prueba en tu casa, es verde, otros dos d√≠as verde, y luego una vez y de repente cay√≥ sobre Jenkins.  Intenta repetirlo, iniciarlo y vuelve a estar verde.  Y al final, nunca se sabe: ¬øes un error o es solo una prueba de glucano?  Y cada vez que necesitas entender. <br><br>  A menudo, despu√©s de un lanzamiento nocturno de pruebas en Jenkins, el probador primero ve "30 pruebas han ca√≠do, debe estudiar", pero todos saben lo que sucede despu√©s ... <br><br><img src="https://habrastorage.org/webt/fz/vg/jh/fzvgjhfo6snzfs6qa0d9clltgcc.jpeg"><br><br>  Usted, por supuesto, adivin√≥ qu√© palabra indecente disfraz√≥: "Reiniciar√©".  Como, "hoy no hay renuencia a entender ..." As√≠ es como suele suceder, y es un verdadero desastre. <br><br>  No hay estad√≠sticas exactas, pero a menudo escuch√© de diferentes personas que tienen alrededor del 30% de las pruebas, escamosas.  En t√©rminos generales, lanzan un millar, de los cuales 300 son peri√≥dicamente rojos, y luego comprueban con sus manos si realmente cayeron. <br><br>  Google public√≥ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">un art√≠culo hace un</a> par de a√±os: dice que tienen un 1,5% de pruebas escamosas y cuenta c√≥mo luchan para reducir su n√∫mero.  Puedo presumir un poco y decir que mi proyecto en Codeborne es ahora del 0.1%.  Pero, de hecho, todo esto es malo, incluso 0.1%.  Por qu√© <br><br>  Tome 1.5%, este n√∫mero parece peque√±o, pero ¬øqu√© significa en la pr√°ctica?  Digamos que hay mil pruebas en un proyecto.  Esto puede significar que 15 pruebas cayeron en una construcci√≥n, las siguientes 12, luego 18. Y esto es terriblemente malo, porque en este caso casi todas las construcciones son rojas, y debe verificar constantemente con sus manos si es cierto o no. <br><br>  E incluso nuestra una ppm (0.1%) sigue siendo mala.  Supongamos que tenemos 1000 pruebas, entonces 0.1% significa que regularmente una de cada diez ca√≠das con 1-2 pruebas rojas.  Aqu√≠ est√° la imagen real de nuestro Jenkins, y resulta: con una carrera, cay√≥ una prueba escamosa, y otra comenz√≥ otra. <br><br><img src="https://habrastorage.org/webt/dv/gx/da/dvgxdacsvc67zygojg18pu50v-q.jpeg"><br><br>  Resulta que no tenemos un d√≠a sin una construcci√≥n roja.  Como hay mucho verde, todo parece estar bien, pero el cliente tiene derecho a preguntarnos: "¬°Chicos, le pagamos dinero y siempre nos proporciona rojo!"  ¬øQu√© haces? <br><br>  No estar√≠a satisfecho en el lugar del cliente, y explicar "en general, esto es normal en la industria, todo es rojo para todos" no es bueno, ¬øverdad?  Por lo tanto, en mi opini√≥n, este es un problema muy urgente, y comprendamos juntos c√≥mo lidiar con √©l. <br><br>  El plan es este: <br><br><ol><li>  Mi colecci√≥n de pruebas inestables (de mi pr√°ctica, casos absolutamente reales, historias de detectives complejas e interesantes) </li><li>  Causas de inestabilidad (algunos incluso tardaron a√±os en investigar) </li><li>  ¬øC√≥mo lidiar con ellos?  (espero que esta sea la parte m√°s √∫til) </li></ol><br>  Entonces, comencemos con mi colecci√≥n, que valoro mucho: me cost√≥ muchas horas de vida nocturna y depuraci√≥n.  Comencemos con un ejemplo simple. <br><br><h2>  Ejemplo 1: cl√°sico </h2><br>  Para semilla: el cl√°sico script Selenium: <br><br><pre><code class="java hljs">driver.navigate().to(<span class="hljs-string"><span class="hljs-string">"https://www.google.com/"</span></span>); driver.findElement(By.name(<span class="hljs-string"><span class="hljs-string">"q"</span></span>)).sendKeys(<span class="hljs-string"><span class="hljs-string">"selenide"</span></span>); driver.findElement(By.name(<span class="hljs-string"><span class="hljs-string">"btnK"</span></span>)).click(); assertEquals(<span class="hljs-number"><span class="hljs-number">9</span></span>, driver.findElements(By.cssSelector(<span class="hljs-string"><span class="hljs-string">"#ires .g"</span></span>)).size());</code> </pre> <br><ol><li>  Abrimos WebDriver; </li><li>  Encuentre el elemento q, maneje la palabra para buscar all√≠; </li><li>  Encuentre el elemento "Bot√≥n" y haga clic; </li><li>  Verifique que la respuesta sea nueve resultados. </li></ol><br>  Pregunta: ¬øqu√© l√≠nea puede romperse aqu√≠? <br><br>  As√≠ es, todos sabemos bien que ninguno!  Cualquier l√≠nea puede romperse, por razones completamente diferentes: <br><br>  La primera l√≠nea es la Internet lenta, el servicio se bloque√≥, los administradores no configuraron algo. <br><br>  La segunda l√≠nea: el elemento a√∫n no ha tenido tiempo de renderizarse si se dibuja din√°micamente. <br>  ¬øQu√© podr√≠a romperse en la tercera l√≠nea?  Aqu√≠ fue inesperado para m√≠: escrib√≠ esta prueba para la conferencia, la ejecut√© localmente y cay√≥ en la tercera l√≠nea con este error: <br><br><img src="https://habrastorage.org/webt/8n/qu/4l/8nqu4l-8byopdwjdkbcrcgkhery.jpeg"><br><br>  Esto dice que el elemento en este punto no es cliqueable.  Parece un simple formulario b√°sico de Google.  El secreto era que en la segunda l√≠nea tocamos la palabra, y mientras la ingres√°bamos, Google ya encontr√≥ los primeros resultados, mostr√≥ los primeros resultados en una ventana emergente y cerraron el siguiente bot√≥n.  Y esto no sucede en todos los navegadores y no siempre.  Esto me sucedi√≥ con este script aproximadamente una vez de cada cinco. <br><br>  La cuarta l√≠nea puede caer, por ejemplo, porque este elemento se dibuja din√°micamente y a√∫n no ha tenido tiempo de dibujar. <br><br>  En este ejemplo, quiero decir que, en mi experiencia, el 90% de las pruebas escamosas se basan en las mismas razones: <br><br><ul><li>  Velocidad de solicitud de Ajax: a veces corren m√°s lento, a veces m√°s r√°pido; </li><li>  El orden de las solicitudes de Ajax; </li><li>  Velocidad js. </li></ul><br>  ¬°Afortunadamente, hay una cura por estas razones!  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Selenide</a> resuelve estos problemas.  ¬øC√≥mo se decide?  Reescribimos nuestra prueba de Google en Selenide: casi todo parece, solo se usan los signos $: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">userCanLogin</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ open(‚Äúhttp:<span class="hljs-comment"><span class="hljs-comment">//localhost:8080/login‚Äù); $(By.name(‚Äúusername‚Äù).setValue(‚Äújohn‚Äù); $(‚Äú#submit‚Äù).click(); $(‚Äú.menu‚Äù).shouldHave(text(‚ÄúHello, John!‚Äù)); }</span></span></code> </pre><br>  Esta prueba siempre pasa.  Debido al hecho de que los m√©todos setValue (), click () y shouldHave () son inteligentes: si algo no tiene tiempo para pintar, esperan un poco e intentan nuevamente (esto se llama "expectativas inteligentes"). <br><br>  Si observa un poco m√°s en detalle, todos estos m√©todos * deber√≠an ser inteligentes: <br><br><img src="https://habrastorage.org/webt/gq/x8/uq/gqx8uq3gjj6wudrx0n3uajntzdy.jpeg"><br><br>  Pueden esperar si es necesario.  Por defecto, esperan hasta 4 segundos, y este tiempo de espera, por supuesto, es configurable, puede especificar cualquier otro.  Por ejemplo, as√≠: mvn -Dselenide.timeout = 8000. <br><br><h2>  Ejemplo 2: nbob </h2><br>  Entonces, el 90% de los problemas con las pruebas escamosas se resuelven con Selenide.  Pero el 10% de los casos mucho m√°s sofisticados permanecen con razones complejas y confusas.  Precisamente de ellos quiero hablar hoy, porque es una "zona gris".  Perm√≠teme darte un ejemplo: una prueba escamosa, que inmediatamente encontr√© en un nuevo proyecto.  A primera vista, esto simplemente no puede suceder, pero esto es algo interesante. <br><br>  Probamos la aplicaci√≥n de teclado para iniciar sesi√≥n en quioscos.  La prueba quer√≠a iniciar sesi√≥n como usuario "bob", es decir, ingresar tres letras en el campo "iniciar sesi√≥n": bob.  Para hacer esto, se usaron los botones en la pantalla.  Como regla, esto funcion√≥, pero a veces la prueba se bloque√≥ y el valor "nbob" permaneci√≥ en el campo "inicio de sesi√≥n": <br><br><img src="https://habrastorage.org/webt/7u/hp/zs/7uhpzsf9wrppgubv_cra_ldg2ri.jpeg"><br><br>  Naturalmente, tiene dificultades para buscar por el c√≥digo donde podr√≠amos haber escrito "nbob", pero en todo el proyecto no est√° en absoluto (ni en la base de datos, ni en el c√≥digo, ni siquiera en los archivos de Excel).  ¬øC√≥mo es esto posible? <br><br>  Observamos el c√≥digo con m√°s detalle: parece que todo es simple, sin acertijos: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loginKiosk</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ open(‚Äúhttp:<span class="hljs-comment"><span class="hljs-comment">//localhost:9000/kiosk‚Äù); $(‚Äúbody‚Äù).click(); $(By.name(‚Äúusername‚Äù)).sendKeys(‚Äúbob‚Äù); $(‚Äú#login‚Äù).click(); }</span></span></code> </pre><br>  Comenzamos a debatir m√°s, a ir paso a paso, y con este m√©todo logramos entender: este error a veces aparece despu√©s de la l√≠nea $ ("cuerpo"). Haga clic en ().  Es decir, en este paso, aparece "n" en el campo "inicio de sesi√≥n", luego se agrega "bob" en los pasos posteriores.  ¬øQui√©n ya ha adivinado de d√≥nde viene "n"? <br><br>  Dio la casualidad de que la letra N estaba en el medio de la pantalla, y la funci√≥n click () al menos en Chrome funciona as√≠: calcula la coordenada central de un elemento y hace clic en ella.  Como el cuerpo es un elemento grande, hizo clic en el centro de toda la pantalla. <br><br><img src="https://habrastorage.org/webt/56/xh/k_/56xhk_clrm85lqkyn-wqeaa5hg4.jpeg"><br><br>  Y esto no siempre cay√≥.  ¬øQui√©n sabe por qu√©?  De hecho, yo mismo no lo s√© completamente.  Quiz√°s debido al hecho de que la ventana del navegador se abri√≥ todo el tiempo en diferentes tama√±os, y esto no siempre cay√≥ en la letra N. <br><br>  Probablemente tenga una pregunta: ¬øpor qu√© alguien gan√≥ $ ("cuerpo")? Haga clic en ()?  Tampoco lo s√© hasta el final, pero supongo que eliminar√© el foco del campo.  Hay un problema en Selenium que hace clic () pero no hace clic ().  Si hay un foco en el campo, entonces no se puede eliminar de all√≠, solo puede hacer clic en cualquier otro elemento.  Y como no hab√≠a otros elementos razonables, hicieron clic en el cuerpo y obtuvieron tal efecto. <br><br>  De ah√≠ la moraleja: no inserte nada que entre en el &lt;cuerpo&gt;.  En otras palabras, no necesita hacer ning√∫n movimiento adicional en p√°nico.  De hecho, esto sucede a menudo: como trato con Selenide, a menudo recibo quejas "algo no funciona", y luego resulta que en alg√∫n lugar de los m√©todos de configuraci√≥n hab√≠a 15 l√≠neas adicionales que no hacen nada √∫til e interfieren .  No es necesario preocuparse e insertar de todos modos en pruebas como "de repente ser√° m√°s confiable". <br><br>  Como resultado, ampliamos la lista de razones para las pruebas inestables: <br><br><ul><li>  Ajax solicita velocidad; </li><li>  El orden de las solicitudes de Ajax; </li><li>  Velocidad js; </li><li>  Tama√±o de la ventana del navegador; </li><li>  Vanidad! </li></ul><br>  Y al mismo tiempo, mi recomendaci√≥n es: no ejecute pruebas en maximizado (es decir, no abra el navegador en una ventana completa).  Como regla, todos hacen esto, y en Selenide fue por defecto (o a√∫n lo es).  En cambio, le aconsejo que siempre inicie un navegador con una resoluci√≥n de pantalla estrictamente definida, porque entonces se excluye este factor aleatorio.  Y le aconsejo que configure el tama√±o m√≠nimo que su aplicaci√≥n admite de acuerdo con las especificaciones. <br><br><h2>  Ejemplo 3: cuentas fantasmas </h2><br>  Un ejemplo es interesante porque todo lo que solo puede coincidir inmediatamente coincidi√≥. <br><br>  Hubo una prueba que verific√≥ que deber√≠a haber 5 cuentas en esta pantalla. <br><br><img src="https://habrastorage.org/webt/td/hp/vl/tdhpvl7b-2ar4jxetsboygszf7m.jpeg"><br><br>  Como regla general, era verde, pero a veces no estaba claro en qu√© condiciones cay√≥ y dijo que no hab√≠a cinco, sino seis cuentas en la pantalla. <br><br>  Empec√© a investigar de d√≥nde viene la factura extra.  Absolutamente incomprensible.  Surgi√≥ la pregunta: ¬øquiz√°s tengamos otra prueba, que durante la prueba crea una nueva cuenta?  Result√≥ que s√≠, hay una prueba de pr√©stamo.  Y entre √©l y la prueba de cuentas que cae (que espera cinco cuentas) puede haber un mill√≥n de otras pruebas. <br><br>  Estamos tratando de entender c√≥mo es esto: ¬øno deber√≠a el LoansTest, que crea la cuenta, eliminarlo al final?  Observamos su c√≥digo: s√≠, deber√≠a, al final hay una funci√≥n After para esto.  Entonces, en teor√≠a, todo deber√≠a estar bien, ¬øcu√°l es el problema? <br><br>  ¬øTal vez la prueba lo elimina, pero permanece en cach√© en alguna parte?  Observamos el c√≥digo de producci√≥n que carga las cuentas: realmente tiene la anotaci√≥n @CacheFor, almacena en cach√© las cuentas durante cinco minutos. <br><br>  Surge la pregunta: ¬øpero no deber√≠a la prueba borrar este cach√©?  Ser√≠a l√≥gico, ¬øno puede haber tal jamba?  Observamos su c√≥digo; s√≠, realmente borra el cach√© antes de cada prueba.  Que pasa  Aqu√≠ ya est√° perdido, porque las hip√≥tesis han terminado: se elimina el objeto, se borra el cach√©, se pegan los √°rboles, ¬øqu√© m√°s podr√≠a ser un problema?  Luego comenz√≥ a escalar el c√≥digo, tom√≥ algo de tiempo, tal vez incluso unos pocos d√≠as.  Hasta que finalmente mir√© esta clase y superclase, y encontr√© una cosa sospechosa all√≠: <br><br><img src="https://habrastorage.org/webt/ug/iz/qz/ugizqze3zr1gmexqfzgxfzqtb_o.jpeg"><br><br>  Alguien ya se dio cuenta, ¬øverdad?  As√≠ es: en el ni√±o y en la clase padre hay un m√©todo con el mismo nombre, y no se llama super. <br><br>  Y en Java es muy f√°cil de hacer: presiona Alt + Intro o Ctrl + Insertar en IntelliJ IDEA o Eclipse, por defecto crea el m√©todo setUp () para usted, y no nota que anula el m√©todo en la superclase.  Es decir, el cach√© todav√≠a no fue llamado.  Cuando vi esto, estaba muy enojado.  Es alegre para m√≠ ahora. <br><br>  De ah√≠ la moraleja: <br><br><ol><li>  En las pruebas, es muy importante monitorear el c√≥digo limpio.  Si en el c√≥digo de producci√≥n todos est√°n atentos a esto, realizan una revisi√≥n del c√≥digo, luego en las pruebas, no siempre. </li><li>  Si el c√≥digo de producci√≥n se verifica mediante pruebas, ¬øqui√©n probar√° las pruebas?  Por lo tanto, es especialmente importante utilizar controles en el IDE. </li></ol><br>  Despu√©s de este incidente, encontr√© en IDEA una inspecci√≥n, desactivada por defecto, que comprueba: si el m√©todo se anula en alg√∫n lugar, pero no hay una anotaci√≥n @ Overrid, entonces marca esto como un error.  Ahora siempre marco hist√©ricamente esta casilla. <br><br>  Resumamos nuevamente: ¬øc√≥mo sucedi√≥ esto? ¬øPor qu√© la prueba fall√≥ no siempre?  En primer lugar, depend√≠a del orden de estas dos pruebas; siempre se ejecutan en orden aleatorio.  Otra prueba dependi√≥ de cu√°nto tiempo pas√≥ entre ellos.  Las cuentas se almacenan en la memoria cach√© durante cinco minutos, si se pasan m√°s, la prueba fue verde y, si es menos, cay√≥, y esto rara vez sucedi√≥. <br><br>  Ampliamos la lista de por qu√© las pruebas pueden ser inestables: <br><br><ul><li>  Ajax solicita velocidad; </li><li>  El orden de las solicitudes de Ajax; </li><li>  Velocidad js; </li><li>  Tama√±o de la ventana del navegador; </li><li>  Cach√© de aplicaciones; </li><li>  Datos de pruebas anteriores; </li><li>  Tiempo </li></ul><br><h2>  Ejemplo 4: tiempo de Java </h2><br>  Hubo una prueba que funcion√≥ en todas nuestras computadoras y en nuestro Jenkins, pero que a veces fallaba en un cliente de Jenkins.  Miramos la prueba, entendemos por qu√©.  Resulta que estaba cayendo, porque al verificar "la fecha de pago deber√≠a ser ahora o en el pasado", result√≥ ser "en el futuro". <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> payment.time &lt;= <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Date();</code> </pre><br>  Observamos el c√≥digo, de repente, en algunas condiciones, ¬øpodemos establecer una fecha en el futuro?  No podemos: en el √∫nico lugar donde se inicializa el tiempo de pago, se usa la nueva Fecha (), y esta es siempre la hora actual (en casos extremos, puede ser en el pasado si la prueba fue muy lenta).  ¬øC√≥mo es esto posible?  Se golpearon la cabeza durante mucho tiempo, no pod√≠an entender. <br><br>  Y una vez que buscaron en el registro de la aplicaci√≥n.  De ah√≠ la primera moraleja: es muy √∫til cuando se examinan las pruebas para examinar el registro de la aplicaci√≥n en s√≠.  Levanta las manos, qui√©n lo hace.  En general, no la mayor√≠a, por desgracia.  Y hay informaci√≥n √∫til: por ejemplo, el registro de solicitud, tal y tal URL se ejecut√≥ en ese momento, dio tal y tal respuesta. <br><br><img src="https://habrastorage.org/webt/z5/ca/cv/z5cacvqul4e4p9gw_lltdzoqk2c.jpeg"><br><br>  ¬øHay algo sospechoso aqu√≠, aviso?  Observamos la hora: esta solicitud se proces√≥ menos tres segundos.  ¬øC√≥mo puede ser esto?  Lucharon durante mucho tiempo, no pod√≠an entender.  Finalmente, cuando se nos acab√≥ la teor√≠a, tomamos una decisi√≥n est√∫pida: Jenkins escribi√≥ un gui√≥n simple que registra la hora actual en un ciclo una vez por segundo.  Lanzado  Al d√≠a siguiente, cuando esta prueba escamosa cay√≥ una vez por la noche, comenzaron a ver un extracto de este archivo para el momento en que cay√≥: <br><br><img src="https://habrastorage.org/webt/yn/et/wx/ynetwxiyv1bc7kzmcgfafqolso8.jpeg"><br><br>  Entonces: 34 segundos, 35, 36, 37, 35, 39 ... Es genial que lo hayamos encontrado, pero ¬øc√≥mo es eso posible?  Las teor√≠as terminaron nuevamente, otros dos d√≠as rasc√°ndose la cabeza.  Este es realmente el caso cuando Matrix est√° bromeando contigo, ¬øverdad? <br><br>  Hasta que por fin una idea me golpe√≥ ... Y result√≥ ser.  Linux tiene un servicio de sincronizaci√≥n horaria que se ejecuta en un servidor central y pregunta "¬øcu√°ntos milisegundos hay ahora?"  Y resulta que se lanzaron dos servicios diferentes en este Jenkins en particular.  La prueba comenz√≥ a fallar cuando Ubuntu se actualiz√≥ en este servidor. <br><br>  All√≠, se configur√≥ previamente un servicio ntp, que accedi√≥ a un servidor bancario especial y tom√≥ tiempo desde all√≠.  Y con la nueva versi√≥n de Ubuntu, se incluy√≥ un nuevo servicio liviano por defecto, por ejemplo, systemd-timesyncd.  Y ambos funcionaron.  Nadie se dio cuenta de esto.  Por alguna raz√≥n, el servidor de la banca central y alg√∫n servidor central de Ubuntu emitieron una respuesta con una diferencia de 3 segundos.  Naturalmente, estos dos servicios interfieren entre s√≠.  En alg√∫n lugar profundo de la documentaci√≥n de Ubuntu dice que, por supuesto, no permita esta situaci√≥n ... Bueno, gracias por la informaci√≥n :) <br><br>  Por cierto, al mismo tiempo aprend√≠ un interesante matiz de Java, que antes de eso, a pesar de mis muchos a√±os de experiencia, no sab√≠a.  Uno de los m√©todos m√°s b√°sicos en Java se llama System.currentTimeMillis (), con la ayuda del cual generalmente se programa para llamar a algo, muchos escribieron ese c√≥digo: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">long</span></span> start = System.currentTimeMillis(); <span class="hljs-comment"><span class="hljs-comment">// ... long end = System.currentTimeMillis(); log.info("Loaded in {} ms", end-start);</span></span></code> </pre><br>  Dicho c√≥digo se encuentra en las bibliotecas Apache Commons, Guava.  Es decir, si necesita detectar cu√°ntos milisegundos se tard√≥ en llamar a algo, generalmente lo hacen.  Y muchos probablemente escucharon que esto no deber√≠a hacerse.  Tambi√©n escuch√©, pero no sab√≠a por qu√©, y demasiado vago para entender.  Pens√© que la pregunta era exactamente porque System.nanoTime () apareci√≥ en alguna versi√≥n de Java: es m√°s precisa, produce nanosegundos que son un mill√≥n de veces m√°s precisos.  Y dado que, por regla general, mis llamadas duran un segundo o medio segundo, esta precisi√≥n no es importante para m√≠, y segu√≠ usando System.currentTimeMillis (), que vimos en el registro donde estaba -3 segundos.  Entonces, de hecho, la forma correcta es esta, y ahora descubr√≠ por qu√©: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">long</span></span> start = System.nanoTime(); <span class="hljs-comment"><span class="hljs-comment">// ... long end = System.nanoTime(); log.info("Loaded in {} ms", (end-start)/1000000);</span></span></code> </pre><br>  En realidad, esto est√° escrito en la documentaci√≥n de los m√©todos, pero nunca lo le√≠.  Toda mi vida he pensado que System.currentTimeMillis () y System.nanoTime () son lo mismo, solo que con un mill√≥n de veces de diferencia.  Pero result√≥ que estas son cosas fundamentalmente diferentes. <br><br>  System.currentTimeMillis () devuelve la fecha actual real: cu√°ntos milisegundos hay ahora desde el 1 de enero de 1970.  Y System.nanoTime () es un tipo de contador abstracto que no est√° vinculado al tiempo real: s√≠, est√° garantizado que crecer√° cada nanosegundo por unidad, pero no est√° conectado con el tiempo actual, incluso puede ser negativo.  Al comienzo de la JVM, un punto en el tiempo se selecciona de alguna manera al azar, y comienza a crecer.  Fue una sorpresa para mi.  Para ti tambien  Bueno, no en vano lleg√≥. <br><br><h2>  Ejemplo 5: La maldici√≥n del bot√≥n verde </h2><br>  Aqu√≠, nuestra prueba llena un formulario determinado, hace clic en el bot√≥n verde Confirmar y, a veces, no va m√°s all√°.  Por qu√© no funciona es incomprensible. <br><br><img src="https://habrastorage.org/webt/cb/wq/fe/cbwqfenxe6_sfzyescgepr5m8tg.png"><br><br>  Conducimos en cuatro ceros y colgamos, no pasemos a la p√°gina siguiente.  Hacer clic ocurre sin errores.  Mir√© todo: solicitudes de Ajax, esperas, tiempos de espera, registros de aplicaciones, cach√©. No encontr√© nada.  La biblioteca de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Video Recorder</a> escrita por Sergey Pirogov a√∫n no ha aparecido.  Permite, agregar una anotaci√≥n al c√≥digo, grabar video.  Luego pude grabar un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">video de</a> esta prueba, verlo en c√°mara lenta, y esto finalmente aclar√≥ la situaci√≥n que no pude resolver durante varios meses antes del video. <br><br><img src="https://habrastorage.org/webt/i_/gz/_j/i_gz_jsw_vswjbeql9s2lwsefga.png"><br><br>  La barra de progreso bloque√≥ el bot√≥n durante una fracci√≥n de segundo, y el clic funcion√≥ exactamente en ese momento y golpe√≥ esta barra de progreso.  Es decir, la barra de progreso hizo clic y desapareci√≥.  Y no ser√° visible en ninguna captura de pantalla, en ning√∫n registro, nunca sabr√° lo que sucedi√≥. <br><br>  En principio, esto es, en cierto sentido, un error de la aplicaci√≥n: apareci√≥ una barra de progreso porque la aplicaci√≥n realmente se arrastra fuera del borde de la pantalla, y si se desplaza, resulta ser una gran cantidad de datos √∫tiles.  Pero los usuarios no se quejaron, porque todo encajaba en la pantalla grande, no cab√≠a solo en la peque√±a. <br><br><h2>  Ejemplo 6: ¬øpor que Chrome se congela? </h2><br>  Una investigaci√≥n de detectives de dos a√±os es un caso absolutamente real.  La situaci√≥n es esta: nuestras pruebas a menudo fueron escamosas y cayeron, y en los rastros de la pila estaba claro que Chrome se congela: no nuestra prueba, es decir, Chrome.  En los registros era visible "La compilaci√≥n se est√° ejecutando 36 horas ..." Comenzaron a eliminar los volcados de hilos y los rastros de la pila: muestran que todo est√° bien en las pruebas, la llamada a Chromedriver se cuelga y, como regla, en el momento del cierre (llamamos al m√©todo de cierre, y este m√©todo no hace nada, se cuelga 36 horas).  Si es interesante, el seguimiento de la pila se ve as√≠: <br><br><img src="https://habrastorage.org/webt/fz/ew/1e/fzew1eu0u-e3oatl1age_oqhnso.jpeg"><br><br>  Intentamos hacer todo lo que solo se nos ocurr√≠a: <br><br><ul><li>  Configure el tiempo de espera para abrir / cerrar el navegador (si no pudo abrir / cerrar el navegador en 15 segundos, intente nuevamente despu√©s de 15 segundos, hasta tres intentos).  Abra y cierre el navegador en un hilo separado.  Resultado: los tres intentos colgaron de la misma manera. </li><li>  Mata viejos procesos de Chrome.  Crearon un trabajo separado en 'kill-chrome' de Jenkins, por ejemplo, de esta manera, puede "matar" todos los procesos anteriores a una hora: <br><br>  killall: m√°s antiguo que 1h chromedriver <br>  killall - m√°s viejo que 1h cromo <br><br>  Esto al menos liber√≥ memoria, pero no respondi√≥ a la pregunta "¬øqu√© est√° pasando?".  De hecho, esto solo nos retras√≥ el momento de la decisi√≥n. </li><li>  Habilite los registros de la aplicaci√≥n de depuraci√≥n. </li><li>  Habilite los registros de depuraci√≥n de WebDriver. </li><li>  Vuelva a abrir el navegador despu√©s de cada 20 pruebas.  Puede parecer rid√≠culo, pero la idea era: "¬øQu√© pasa si Chrome se congela porque est√° cansado?"  Bueno, una p√©rdida de memoria o algo m√°s. </li></ul><br>  El resultado del √∫ltimo intento fue completamente inesperado: ¬°el problema comenz√≥ a repetirse m√°s a menudo!  Y esper√°bamos que esto ayudara a estabilizar Chrome para que funcione mejor.  Esto generalmente es una conclusi√≥n del cerebro.  Pero, de hecho, cuando el problema comienza a repetirse con mayor frecuencia, uno no debe estar triste, ¬°sino alegrarse!  Esto hace posible estudiarlo mejor.  Si ella comenz√≥ a repetir m√°s a menudo, uno deber√≠a aferrarse a ella: "S√≠, s√≠, ahora agregar√© algo m√°s, registros, puntos de interrupci√≥n ..." <br><br>  Estamos tratando de repetir el problema: escribimos un ciclo del 1 al 1000, en el ciclo simplemente abrimos el navegador y cerramos la primera p√°gina de nuestra aplicaci√≥n.  Escribimos tal ciclo, y ... ¬°bingo!  Resultado: ¬°el problema comenz√≥ a repetirse de manera estable (aunque aproximadamente cada 80 iteraciones)!  Genial!  Es cierto que este logro no dio nada durante mucho tiempo.  Lo comenz√≥, esper√≥ la iteraci√≥n 80, Chrome se estrell√≥ ... ¬øy luego qu√© hacer?  Observa los rastros de la pila, los volcados, los registros: all√≠ no hay nada √∫til.  Las herramientas de desarrollador en Chrome pueden ayudar, pero hasta septiembre de 2017 estas herramientas no funcionaron con Selenium (los puertos estaban en conflicto: inicia Chrome desde Selenium y DevTools no se abre).  Durante mucho tiempo no pude pensar en qu√© hacer. <br><br>  Y aqu√≠ en esta historia comienza un momento fabuloso.  Una vez, despu√©s de un n√∫mero infinito de intentos, realic√© estas pruebas nuevamente, est√° colgando nuevamente en alguna iteraci√≥n como la 56, creo que "vamos a cavar algo m√°s" (aunque no s√© d√≥nde m√°s poner el punto de interrupci√≥n o qu√© agregar un registro).  En este momento, mi hija se ofrece a jugar cubos, pero mi prueba simplemente se cuelga aqu√≠.  Le digo: "Espera", ella me dijo: "¬°Qu√©, no entiendes, tengo <b>un b y un</b> aqu√≠!" <br><br>  Qu√© hacer, tristemente dej√© la computadora, fui a jugar cubos ... Y de repente, despu√©s de unos 20 minutos, accidentalmente miro la pantalla y veo una imagen completamente inesperada: <br><br><img src="https://habrastorage.org/webt/hm/7o/6p/hm7o6peoyj0zroryt-8g-osfvkc.jpeg"><br><br>  Qu√© sucede: hay una cuenta regresiva, despu√©s de cu√°ntos minutos expira la sesi√≥n, y construyo una torre de cubos, quedan dos, uno ... la sesi√≥n expira, la prueba contin√∫a, corre hasta el final y cae (ya no hay ning√∫n elemento, la sesi√≥n ha expirado). <br><br>  Qu√© sucede: Chrome realmente no se congel√≥, como pensamos todo este tiempo, ha estado esperando algo todo este tiempo.  Cuando la sesi√≥n expir√≥, esper√≥, continu√≥.  Qu√© esperaba exactamente Chrome: es completamente incomprensible entender esto, tuve que descifrar todo el c√≥digo usando el m√©todo de b√∫squeda binario: tirar la mitad de JavaScript y HTML, intentar repetir 80 iteraciones nuevamente; no se bloque√≥, oh, eso significa que en alg√∫n lugar por ah√≠ ... En general, entendimos experimentalmente que el problema esta aqu√≠: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> timeout = setTimeout(sessionWatcher);</code> </pre><br>      JavaScript ‚Äî  ,   ,   . ,  JavaScript- ,      : ,     &lt;script&gt;  .  ,  , ,         ,    .     JavaScript ‚Äî   jQuery,   $,     function   ,      : <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> timeout; $(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ timeout = setTimeout(...); });</code> </pre> <br>   -, , , .      ,    .         1000 ,   . <br><br> ,       : ,  ,    ,      .  ,   Chrome,   . ,        . <br><br>    ,     flaky-  , , ,         .  ,       ‚Äî ,       ,     (  ).    ,      .  ,     :   ? <br><br>     Chrome       flaky-:       -,   ,    ,    . <br><br>  UI-  :    ,             .    click(),          ,       . , ,  :  click()   ,       . -   , ?  :) <br><br>       .   ,    ,   ,       . ,     ,   ,    ,        Docker. <br><br>  ,    - ,    .     : <br><br><ul><li>  Ajax-; </li><li>  Ajax-; </li><li>  JS; </li><li>   ; </li><li>  ; </li><li>    ; </li><li> ; </li><li>  ; </li><li> UI-; </li><li>   ( ). </li></ul><br>    flaky-    ,     . ,   -,    :  ,   . <br><br>       .  ¬´¬ª .    ,  flaky- ,                 ID,  flaky-    .        . <br><br>   ,  :    ,   ,      . <br><br>  ,  flaky-     usability,   -,       flaky-  .            . <br><br>   ,       ,      ‚Ä¶      ,    , ,  flaky-  security-,     .     ,      ! <br><br>    ,    ,     flaky-: <br><br><ul><li>  ; </li><li> Selenide; </li><li>  ; </li><li>     . </li></ul><br>  ‚Äî   .     flaky- ,  unit-    ,  UI-?  ,    (   ),      ,     flaky. <br><br>  Selenide  . <br><br> .              (,   /   ).   ,     ¬´      ?¬ª.      ,  ,    .    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="> </a> ,   . <br><br>       ,    .    ,    ,    ,   ,      .      :     ¬´ ¬ª, ,         (10 , 20 ,   ‚Äî ,   ‚Äî  ).       ,   flaky -   . <br><br>     ,   flaky- : <br><br><ol><li>   ; </li><li> ; </li><li>  Video </li></ol><br>  ¬´   ¬ª    ,    ,   ,   : -         .      ¬´¬ª,  ¬´¬ª  ,  :   flaky-,      ,    flaky.  ,   ,   .     . ,    Jenkins pipeline,   Jenkins      : <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { stage(<span class="hljs-string"><span class="hljs-string">"Reports"</span></span>) { junit <span class="hljs-string"><span class="hljs-string">'build/test-results/**/*.xml'</span></span> artifacts = <span class="hljs-string"><span class="hljs-string">'build./reports/**/*,build/test-results/**/*,logs/**/*'</span></span> archiveArtifacts artifacts: artifacts } }</code> </pre><br>  finally    ,    .   :    -  - .  Jenkins        ,  . ,   Jenkins       ,   .   ,  . <br><br>       (Selenide   ,     ).      flaky-.  ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Video Recorder</a> ,    :      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">video</a> ‚Äî  ,    ! <br><br>    ,      Docker:    TestContainers (    Heisenbug <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="> </a> ).       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">Rule</a> ,   ‚Äî      Docker    ,  ,     .           . <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Rule</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> BrowserWebDriverContainer chrome = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BrowserWebDriverContainer() .withRecordingMode(RECORD_ALL, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> File(<span class="hljs-string"><span class="hljs-string">"build"</span></span>)) .withDesiredCapabilities(chrome());</code> </pre><br>  . <br><br>     . , ,    ,   , ,     .      flaky-        . <br><br> ,   !  ,    :)        .     ,    ¬´     ,    ,  ¬ª,       ,      . <br><br>     ‚Äî , ,   ,   , -   .      ‚Äî    ,    ‚Ä¶ ! :)       flaky-  ‚Äî :    ! <br><br><blockquote>     ,  : 6-7  <b>Heisenbug</b>    .      ,   ,       .     (,  ,  )    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="> </a> . </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es416757/">https://habr.com/ru/post/es416757/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es416743/index.html">Bot para Starcraft en Rust, C y cualquier otro idioma</a></li>
<li><a href="../es416745/index.html">Nuevo ASUS ROG en Computex 2018</a></li>
<li><a href="../es416751/index.html">Recopilaci√≥n de informaci√≥n contextual para el registro.</a></li>
<li><a href="../es416753/index.html">El popular plugin Hola VPN est√° comprometido</a></li>
<li><a href="../es416755/index.html">Me gusta extremo - Comit√© de investigaci√≥n contra</a></li>
<li><a href="../es416759/index.html">¬øPor qu√© la inteligencia artificial no resolver√° todos los problemas?</a></li>
<li><a href="../es416761/index.html">Lenguaje c√≥smico, parte 1: ¬øes universal la gram√°tica universal?</a></li>
<li><a href="../es416763/index.html">Puppet Salt Chef Ensemble: compara Ansible, SaltStack, Chef y Puppet</a></li>
<li><a href="../es416765/index.html">Empresa Foliplast: un ciclo completo de producci√≥n digital en Rusia</a></li>
<li><a href="../es416767/index.html">Un deuce para ti o una auditor√≠a con pirater√≠a</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>