<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘ï¸ ğŸ‘¶ğŸ» ğŸ‘‰ğŸ» Envoyer une surprise Ã  fsync () PostgreSQL ğŸ’¬ ğŸ˜– ğŸ‘•</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Les dÃ©veloppeurs de SGBD, par nÃ©cessitÃ©, craignent que les donnÃ©es ne tombent en toute sÃ©curitÃ© dans un stockage permanent. Par consÃ©quent, lorsque la...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Envoyer une surprise Ã  fsync () PostgreSQL</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/472684/"><img width="50%" align="left" src="https://habrastorage.org/webt/oz/ps/ut/ozpsutp44sz5dvmpfteszdiba5o.png">  Les dÃ©veloppeurs de SGBD, par nÃ©cessitÃ©, craignent que les donnÃ©es ne tombent en toute sÃ©curitÃ© dans un stockage permanent.  Par consÃ©quent, lorsque la communautÃ© PostgreSQL a dÃ©couvert que la faÃ§on dont le noyau gÃ¨re les erreurs d'E / S peut entraÃ®ner une perte de donnÃ©es sans qu'aucune erreur ne soit signalÃ©e Ã  l'espace utilisateur, un grand mÃ©contentement est apparu.  Un problÃ¨me qui est aggravÃ© par le fait que PostgreSQL effectue des E / S tamponnÃ©es n'est pas unique Ã  Linux et ne sera pas facile Ã  rÃ©soudre mÃªme lÃ -bas. <br><br>  Craig Ringer a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">signalÃ© le problÃ¨me</a> pour la premiÃ¨re <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">fois</a> Ã  la liste de diffusion pgsql-hackers fin mars.  En bref, PostgreSQL suppose qu'un appel <code>fsync()</code> rÃ©ussi indique que toutes les donnÃ©es enregistrÃ©es depuis le dernier appel rÃ©ussi ont Ã©tÃ© transfÃ©rÃ©es en toute sÃ©curitÃ© vers un stockage persistant.  Lorsque les Ã©critures d'E / S mises en mÃ©moire tampon Ã©chouent en raison d'une erreur matÃ©rielle, les systÃ¨mes de fichiers rÃ©agissent diffÃ©remment, mais ce comportement implique gÃ©nÃ©ralement la suppression de donnÃ©es sur les pages correspondantes et leur marquage comme propres.  Par consÃ©quent, la lecture de blocs qui viennent d'Ãªtre Ã©crits retournera trÃ¨s probablement quelque chose d'autre, mais pas de donnÃ©es enregistrÃ©es. <br><a name="habracut"></a><br>  Qu'en est-il du rapport d'erreurs?  Il y a un an, le sommet du systÃ¨me de fichiers, du stockage et de la gestion de la mÃ©moire Linux (LSFMM) comprenait une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">session de</a> rapport de bogues au <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cours</a> de laquelle tout cela Ã©tait appelÃ© un Â«dÃ©sordreÂ»;  les erreurs peuvent facilement Ãªtre perdues, donc aucune application ne les verra jamais.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Certains correctifs</a> inclus dans 4.13 ont quelque peu amÃ©liorÃ© la situation pendant le cycle de dÃ©veloppement (et dans 4.16 il y a eu quelques changements pour l'amÃ©liorer davantage), cependant, il existe des moyens de perdre les notifications d'erreur, comme dÃ©crit ci-dessous.  Si cela se produit sur un serveur PostgreSQL, cela peut entraÃ®ner une corruption automatique de la base de donnÃ©es. <br><br>  Les dÃ©veloppeurs de PostgreSQL n'Ã©taient pas satisfaits.  Tom Lane a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">dÃ©crit</a> cela comme des Â« <b>lÃ©sions cÃ©rÃ©brales au noyau</b> Â», tandis que Robert Haas l'a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">appelÃ©</a> Â« <b>100% stupide</b> Â».  Au dÃ©but de la discussion, les dÃ©veloppeurs de PostgreSQL ont compris assez clairement comment, Ã  leur avis, le noyau devrait fonctionner: les pages qui ne pouvaient pas Ãªtre Ã©crites devaient Ãªtre stockÃ©es en mÃ©moire dans un Ã©tat Â«saleÂ» (pour les tentatives ultÃ©rieures), et le descripteur de fichier correspondant devait Ãªtre traduit en Statut d'erreur permanent afin que le serveur PostgreSQL ne puisse pas ignorer le problÃ¨me. <br><br><h4>  OÃ¹ quelque chose s'est-il mal passÃ© </h4><br>  Cependant, avant mÃªme que la communautÃ© du noyau n'entre dans la discussion, il est devenu clair que la situation n'Ã©tait pas aussi simple qu'elle y paraissait.  Thomas Munro a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">dÃ©clarÃ©</a> que Linux n'est pas unique dans ce comportement;  OpenBSD et NetBSD peuvent Ã©galement ne pas signaler d'erreurs d'Ã©criture dans l'espace utilisateur.  Et, comme il s'est avÃ©rÃ©, la faÃ§on dont PostgreSQL gÃ¨re les opÃ©rations d'E / S tamponnÃ©es complique considÃ©rablement l'image. <br><br>  Ce mÃ©canisme <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><u>a Ã©tÃ© dÃ©crit en dÃ©tail par</u></a> Haas.  Un serveur PostgreSQL fonctionne comme un ensemble de processus, dont beaucoup peuvent effectuer des E / S sur des fichiers de base de donnÃ©es.  Le <code>fsync()</code> appel <code>fsync()</code> , cependant, est gÃ©rÃ© dans un seul processus de <code>fsync()</code> vÃ©rification (Â«processus de point de contrÃ´leÂ»), qui consiste Ã  maintenir le stockage sur disque dans un Ã©tat cohÃ©rent pour rÃ©cupÃ©rer des Ã©checs.  Checkpointer ne garde gÃ©nÃ©ralement pas tous les fichiers pertinents ouverts, il doit donc souvent ouvrir le fichier avant d'appeler <code>fsync()</code> .  C'est lÃ  que le problÃ¨me se pose: mÃªme dans les noyaux 4.13 et versions ultÃ©rieures, checkpointer ne verra aucune erreur survenue avant l'ouverture du fichier.  Si quelque chose de mauvais se produit avant d'appeler <code>open()</code> checkpointer-a, le prochain appel Ã  <code>fsync()</code> renverra le succÃ¨s.  Il existe plusieurs faÃ§ons de provoquer une erreur d'E / S en dehors de <code>fsync()</code> ;  par exemple, le noyau peut rencontrer l'un d'eux lors de l'Ã©criture en arriÃ¨re-plan.  Une personne appelant <code>sync()</code> peut Ã©galement rencontrer une erreur d'E / S et Â«absorberÂ» l'Ã©tat d'erreur rÃ©sultant. <br><br>  Haas a dÃ©crit ce comportement comme Ã©tant incapable de rÃ©pondre aux attentes de PostgreSQL: <br><blockquote>  Tout ce que vous (ou quelqu'un) avez est essentiellement une hypothÃ¨se non prouvÃ©e que <br>  quels descripteurs de fichiers peuvent Ãªtre pertinents pour une erreur particuliÃ¨re, mais il s'est avÃ©rÃ© que PostgreSQL ne l'a jamais fait correspondre.  Vous pouvez continuer Ã  dire que le problÃ¨me est dans nos suppositions, mais il me semble erronÃ© de supposer que nous sommes le seul programme Ã  les avoir fait. </blockquote><br>  En consÃ©quence, Joshua Drake a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">dÃ©placÃ© la conversation</a> vers la liste de dÃ©veloppement pour ext4, y compris une partie de la communautÃ© de dÃ©veloppement du noyau.  Dave Chinner a rapidement <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">dÃ©crit</a> ce comportement comme "une <b>recette pour un dÃ©sastre, en particulier dans le code multiplateforme, oÃ¹ chaque plate-forme de systÃ¨me d'exploitation se comporte diffÃ©remment et ne correspond presque jamais Ã  ce qui Ã©tait attendu</b> ".  Au lieu de cela, Ted Tso a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">expliquÃ©</a> pourquoi les pages affectÃ©es sont marquÃ©es comme propres aprÃ¨s une erreur d'E / S;  en bref, la cause la plus courante d'erreurs d'E / S est lorsque l'utilisateur Ã©jecte la clÃ© USB au mauvais moment.  Si un processus a copiÃ© beaucoup de donnÃ©es sur ce disque, le rÃ©sultat sera l'accumulation de pages sales dans la mÃ©moire, peut-Ãªtre au point que le systÃ¨me n'a pas assez de mÃ©moire pour d'autres tÃ¢ches.  Ainsi, ces pages ne peuvent pas Ãªtre enregistrÃ©es et seront effacÃ©es si l'utilisateur souhaite que le systÃ¨me reste utilisable aprÃ¨s un tel Ã©vÃ©nement. <br><br>  Chinner et Tso, ainsi que d'autres, ont dÃ©clarÃ© que PostgreSQL avait la bonne solution - passer aux E / S directes (DIO).  L'utilisation de DIO offre un plus grand niveau de contrÃ´le sur l'Ã©criture diffÃ©rÃ©e et les E / S en gÃ©nÃ©ral;  cela inclut l'accÃ¨s aux informations sur les opÃ©rations d'E / S qui peuvent avoir Ã©chouÃ©.  Andres Freund, comme un certain nombre d'autres dÃ©veloppeurs PostgreSQL, a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">reconnu</a> que DIO est la meilleure solution Ã  long terme.  Mais il a Ã©galement notÃ© qu'il ne faut pas s'attendre Ã  ce que les dÃ©veloppeurs plongent profondÃ©ment dans la mise en Å“uvre de cette tÃ¢che.  Pendant ce temps, il a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">dÃ©clarÃ©</a> qu'il existe d'autres programmes (il a mentionnÃ© dpkg) qui sont Ã©galement sujets Ã  ce comportement. <br><br><h4>  Vers une solution Ã  court terme </h4><br>  Au cours de la discussion, une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">attention</a> considÃ©rable a Ã©tÃ© accordÃ©e Ã  l'idÃ©e qu'un Ã©chec d'Ã©criture devrait conduire au fait que les pages affectÃ©es seront stockÃ©es en mÃ©moire dans leur Ã©tat sale.  Mais les dÃ©veloppeurs de PostgreSQL se sont rapidement Ã©loignÃ©s de cette idÃ©e et ne l'ont pas exigÃ©e.  Ce dont ils ont vraiment besoin, c'est finalement un moyen fiable de savoir si quelque chose s'est mal passÃ©.  Dans cet esprit, les mÃ©canismes habituels de gestion des erreurs de PostgreSQL peuvent gÃ©rer cela;  cependant, peu de choses peuvent Ãªtre faites en son absence. <br><br>  Ã€ un moment donnÃ© de la discussion, Tso a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">mentionnÃ©</a> que Google avait son propre mÃ©canisme de gestion des erreurs d'E / S.  Le noyau a Ã©tÃ© chargÃ© de signaler les erreurs d'E / S via le socket netlink;  Le processus dÃ©diÃ© reÃ§oit ces notifications et rÃ©pond en consÃ©quence.  Pourtant, ce mÃ©canisme n'a jamais fait cela Ã  l'entrÃ©e.  Freind a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">soulignÃ©</a> que ce mÃ©canisme serait "idÃ©al" pour PostgreSQL, donc il pourrait apparaÃ®tre dans le domaine public dans un avenir proche. <br><br>  Pendant ce temps, Jeff Leighton <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">rÃ©flÃ©chissait Ã </a> une autre idÃ©e: dÃ©finir un indicateur dans le superbloc du systÃ¨me de fichiers lorsqu'une erreur d'E / S se produit.  Un appel Ã  <code>syncfs()</code> alors cet indicateur et retournera une erreur s'il a Ã©tÃ© dÃ©fini.  Le pointeur de contrÃ´le PostgreSQL peut pÃ©riodiquement appeler <code>syncfs()</code> pour rechercher les erreurs sur le systÃ¨me de fichiers contenant la base de donnÃ©es.  Freund a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">convenu</a> que cela pourrait Ãªtre une solution viable au problÃ¨me. <br><br>  Bien sÃ»r, un tel mÃ©canisme n'apparaÃ®tra que dans les nouveaux noyaux;  ParallÃ¨lement, les installations PostgreSQL s'exÃ©cutent gÃ©nÃ©ralement sur des noyaux plus anciens pris en charge par les distributions d'entreprise.  Dans ces noyaux, il semble qu'il n'y ait mÃªme pas les amÃ©liorations incluses dans 4.13.  Pour ces systÃ¨mes, rien ne peut Ãªtre fait pour aider PostgreSQL Ã  dÃ©tecter les erreurs d'E / S.  Il peut Ãªtre suffisant de dÃ©marrer un dÃ©mon qui analyse le journal systÃ¨me et y recherche des messages d'erreur d'E / S.  Ce n'est pas la solution la plus Ã©lÃ©gante, et elle est compliquÃ©e par le fait que diffÃ©rents pilotes de blocs et systÃ¨mes de fichiers, en rÃ¨gle gÃ©nÃ©rale, signalent les erreurs de diffÃ©rentes maniÃ¨res, mais cela peut Ãªtre la meilleure option disponible. <br><br>  La prochaine Ã©tape sera probablement une discussion lors de l'Ã©vÃ©nement LSFMM 2018 le 23 avril.  Si vous Ãªtes chanceux, il y aura une sorte de solution qui fonctionnera pour les parties intÃ©ressÃ©es.  Cependant, une chose qui ne changera pas est le simple fait que la gestion des erreurs est difficile Ã  faire correctement. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr472684/">https://habr.com/ru/post/fr472684/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr472670/index.html">Limely automne, Limely hiver ...</a></li>
<li><a href="../fr472672/index.html">La rubrique Â«Lisez des articles pour vousÂ». Juillet - septembre 2019</a></li>
<li><a href="../fr472674/index.html">Variables d'environnement pour les projets Python</a></li>
<li><a href="../fr472676/index.html">Nous crÃ©ons le dÃ©partement de jones pour aider les Ã©quipes principales, en utilisant uniquement Slack, Jira et le ruban Ã©lectrique bleu</a></li>
<li><a href="../fr472682/index.html">Ralentir le vieillissement avec des synergies de mÃ©dicaments chez C. elegans</a></li>
<li><a href="../fr472686/index.html">Studio vidÃ©o basÃ© sur i486</a></li>
<li><a href="../fr472688/index.html">Fonctionnement du rendu de jeu 3D: traitement des sommets</a></li>
<li><a href="../fr472690/index.html">NouveautÃ©s de Zabbix 4.4</a></li>
<li><a href="../fr472694/index.html">Plus que Ceph: MCS Block Cloud Storage</a></li>
<li><a href="../fr472702/index.html">JH Rainwater Â«Comment faire paÃ®tre les chatsÂ»: races de programmeurs et caractÃ©ristiques de leur Ã©levage</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>