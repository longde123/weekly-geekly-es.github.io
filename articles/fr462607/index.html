<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🐓 👨🏽‍🏭 🙎 Comment j'ai écrit une bibliothèque pour le service Yandex.Music 🦋 👨🏾‍🚀 👨🏾‍🤝‍👨🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Présentation 
 À propos de moi 


 Bonjour à tous, je suis un étudiant ordinaire dans la spécialité "technicien logiciel". Depuis l'enfance, j'aime le...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment j'ai écrit une bibliothèque pour le service Yandex.Music</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/462607/"><h1 id="vvedenie">  Présentation </h1><br><h2 id="obo-mne">  À propos de moi </h2><br><p>  Bonjour à tous, je suis un étudiant ordinaire dans la spécialité "technicien logiciel".  Depuis l'enfance, j'aime les ordinateurs, depuis la 7e année j'ai commencé à apprendre la programmation elle-même.  Je suis propriétaire d'un abonnement à Yandex Music depuis plus d'un an et je suis généralement satisfait du service (bien qu'il y ait maintenant des répétitions continues dans la playlist du jour). </p><br><h2 id="predystoriya">  Contexte </h2><br><p> Je ne me souviens pas exactement pourquoi j'ai décidé de rechercher la documentation officielle de l'API pour ce service, comme un bot que je voulais écrire pour Telegram, mais je suis tombé sur le fait que ce n'était pas le cas ... Après un certain temps, j'ai rencontré un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">problème</a> dans le référentiel <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">yandex / audio-js</a> .  Là, les gars posent exactement la même question que moi: "Où est l'API?"  Peu de gens sont impatients d'écouter de la musique via un navigateur, ils veulent une application, mais il n'y a pas non plus d'application Linux!  L'intégration à votre joueur préféré est impossible! </p><br><p>  Puis j'ai eu l'idée de le faire.  Naturellement, je dois en quelque sorte travailler avec le service, faire des béquilles autour d'une application Web n'est pas une option.  J'ai compris qu'avoir un tel service, avoir des applications mobiles et Windows (du Microsoft Store), il est tout simplement impossible de ne pas avoir sa propre API interne pour l'interaction.  J'avais raison! </p><br><h2 id="obyazatelno-k-prochteniyu-pered-osnovnoy-chastyu">  Lecture obligatoire devant l'instance principale </h2><br><p>  Je suis conscient qu'en étudiant leur API non publique, je fouille dans les choses sales des autres.  Ci-dessous seront décrites diverses questions controversées, les décisions des développeurs et, en général, comment ils l'ont écrit et comment ils l'utilisent.  À certains endroits, <strong>j'étais juste choqué</strong> , mais je suis sûr que s'ils le faisaient, il <strong>y avait des raisons à cela</strong> !  N'oublions pas que personne n'aurait dû voir ça.  Je tiens également à dire que tout ce qui est écrit ci-dessous est <strong>mon opinion</strong> .  Vous pouvez être d'accord avec lui ou non. </p><a name="habracut"></a><br><h1 id="osnovnaya-chast">  Corps principal </h1><br><h2 id="podgotovka">  La préparation </h2><br><h3 id="api-veb-prilozheniya">  API d'application Web </h3><br><p> Ci-dessus, j'ai déjà écrit que j'avais trouvé l'API.  Ce n'était pas du tout difficile.  Tout d'abord, j'ai regardé leur application Web, leur point de terminaison au moment de la rédaction est ici: <code>https://music.yandex.ru/api/v2.1/</code> .  Ils ont des URL suffisamment longues dans lesquelles je participe aux données, et ils envoient également le formulaire.  Je vous demande également de faire attention à <strong>indiquer la version de l'API</strong> , elle l' <strong>est</strong> . </p><br><p>  Vous devez comprendre que ce que j'ai trouvé n'est utilisé par eux que dans une application Web.  Il n'y a pas d'OAuth.  Plus précisément, il a plus de chances d'exister, mais là, dans les entrailles de notre séance sur le site.  En général, la bibliothèque ne convient pas pour les béquilles en autorisation. </p><br><h3 id="api-prilozheniy">  API d'application </h3><br><p>  Je me mis à chercher plus loin.  J'étais trop paresseux pour prendre le téléphone, donc j'allais en dernier aux applications mobiles.  À cette époque, l'ordinateur exécutait Windows 10 et j'ai activement utilisé l'application officielle <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Yandex Music du Microsoft Store</a> .  En conséquence, j'ai commencé à étudier comment cela fonctionne. </p><br><p>  Pour la recherche, j'avais besoin d'un renifleur pour suivre tout le trafic des applications.  Vous pouvez utiliser <em>Wireshark</em> , mais je me suis installé sur <em>HTTP Analyzer</em> .  Il me semble plus léger et parfaitement adapté à ma tâche. </p><br><p>  Allumez le renifleur, accédez à l'application et vous avez terminé.  Les demandes sont acheminées par flux.  Nous nous asseyons, comprenons, essayons d'appeler chaque gestionnaire qui se trouve dans cette application et découvrons toutes les méthodes existantes, leurs arguments et, bien sûr, <strong>les réponses JSON</strong> . </p><br><p><img src="https://habrastorage.org/webt/ha/ld/g1/haldg1jv_nj89ezqeygrgt2qdke.png" alt="Capture d'écran d'une des demandes"></p><br><p>  De la capture d'écran ci-dessus, vous pouvez immédiatement remarquer une adresse API complètement différente - <code>api.music.yandex.net</code> .  De plus, faites attention aux rubriques.  En plus des informations sur mon client à partir duquel la demande a été faite, il existe un jeton OAuth - c'est ce dont vous avez besoin! </p><br><h2 id="izuchenie-api">  API d'apprentissage </h2><br><p>  L'étude a eu lieu en même temps que l'écriture du code.  J'ai écrit des classes wrapper pour les objets de service reçus de l'API, implémenté l'envoi de requêtes, trié les paramètres et à certains endroits, j'ai juste deviné ce que ce nom pouvait signifier.  À ce stade, j'ai rencontré diverses choses que je ne m'attendais pas à voir ici. </p><br><p>  Au moment de la rédaction, la bibliothèque contient <strong>83 classes,</strong> et seules certaines d'entre elles sont auxiliaires.  Les autres sont des cours de musique Yandex, qui indiquent l'ampleur de ce service et le niveau d'abstractions. </p><br><p>  L'envoi de <strong>47 méthodes a</strong> été implémenté.  Et ce n'est pas tout ce qui se trouve dans l'API (plus d'informations ci-dessous). </p><br><h2 id="bol">  La douleur </h2><br><p>  Au début, j'ai essayé de ne pas faire attention, j'ai été simplement surpris, car c'est <strong>Yandex</strong> , comment cela peut-il être.  Mais ensuite, à un moment précis, tout a explosé.  Je vais peut-être commencer par lui. </p><br><ol><li><p>  <strong>Deux objets avec différents niveaux d'attachement au champ</strong> </p><br><p><img src="https://habrastorage.org/webt/8d/ri/my/8drimyevhjw1pirnlbc-bdsjqp4.png" alt="Nouvelle version de l'objet"></p><br><p>  L'objet lui-même n'est qu'une «référence» à lui-même.  Pour sa version complète.  Lorsque nous demandons une liste de pistes, nous recevons leur identifiant, grâce auquel nous pouvons obtenir des informations plus détaillées.  De bonnes pratiques, beaucoup le font, mais elles ne sont pas toujours respectées (paragraphe 9). </p><br><p><img src="https://habrastorage.org/webt/bu/gz/eg/bugzeg-c9rm2nvluh0mmpfny_d0.png" alt="Ancienne version de l'objet"></p><br><p>  Ayant implémenté la classe pour cet objet au tout début, j'ai pensé que je l'utiliserais partout, mais peu importe comment!  Il me semble que les commentaires sont superflus et tout peut être vu dans les captures d'écran. </p><br><p>  Je n'ai pas réparé ce type de montants dans ma bibliothèque, donc avoir la classe <code>TrackShortOld</code> a maintenant <code>TrackShortOld</code> . </p><br><p>  Soit dit en passant, ces deux objets vivent dans la même méthode, dans la méthode d' <em>atterrissage</em> . </p><br></li><li><p>  <strong>Versions, méthodes d'API</strong> </p><br><p>  Je ne vous ai pas simplement demandé de prêter attention à la façon dont la version est spécifiée dans l'API de l'application Web.  Généralement, comment indique-t-on habituellement une version?  Probablement de l'une des manières suivantes: </p><br><ul><li>  faire la version sur un sous-domaine séparé; </li><li>  mettre la version dans la partie demande; </li><li>  passez la version souhaitée du paramètre API à la demande. </li></ul><br><p>  Yandex a décidé dans ce cas de faire autrement.  Nous avons une méthode <strong>landing3</strong> - sa version actuelle au moment de la rédaction.  Mais personne <strong>n'interdit d'</strong> envoyer une demande d' <strong>atterrissage2</strong> - une structure complètement différente, d'autres objets. </p><br><p>  J'ai découvert cela tout à fait par accident, <strong>oubliant</strong> simplement <strong>d'ajouter un nombre à la fin du nom de la méthode</strong> et interceptant un tas d'exceptions. </p><br></li><li><p>  <strong>Travailler avec le nouveau, ne pas abandonner l'ancien</strong> </p><br><p>  Je l'ai vu quand j'ai écrit des méthodes d'envoi "Like" pour tous les objets qui le sont.  Il n'y en a pas beaucoup (playlist, artiste, piste, album).  Quelle a été ma surprise quand j'ai vu différentes approches de la même action. </p><br><p>  Nous aimons les artistes comme celui-ci: <code>https://api.music.yandex.net/users/&lt;USER_ID&gt;/likes/artists/add</code> et transférer l' <code>artist-id</code> dans le formulaire. </p><br><p>  Nous aimons les pistes comme celle-ci: <code>https://api.music.yandex.net/users/&lt;USER_ID&gt;/likes/tracks/add-multiple</code> et sous la forme de <code>track-ids</code> . </p><br><p>  Si vous ne l'avez pas remarqué, alors quand vous aimez la piste, la méthode <strong>add-multiple</strong> est utilisée, pas <strong>add</strong> .  Cette méthode n'est utilisée avec aucun autre type, <strong>mais</strong> elles <strong>existent</strong> toutes (cela valait la peine d'essayer d'envoyer une demande)!  Et je les ai implémentés dans ma bibliothèque au lieu d'en <strong>ajouter</strong> .  Après tout, cette méthode est universelle.  Vous pouvez ajouter une ou plusieurs pistes. </p><br></li><li><p>  <strong>Qu'est-ce qu'un identifiant de piste unique</strong> </p><br><p>  Beaucoup de temps s'est écoulé, mais je ne comprends toujours pas quand envoyer uniquement l' <code>id</code> la piste, et quand l'identifiant et l'album_id sont concaténés via deux points ( <code>id:album_id</code> ).  Parfois une piste est dans plusieurs albums, parfois il n'y a pas d'album.  Cas trop obscurs en regardant de côté, je ne sais pas comment ils gèrent cela (ou je ne peux pas le faire, bagus 2). </p><br></li><li><p>  <strong>Nombreux champs facultatifs</strong> </p><br><p>  J'ai eu quelques problèmes.  S'il y a un problème, il est lié au champ requis.  Je ne cesse d'être surpris de voir comment, à mon avis, les champs obligatoires ne renvoient tout simplement pas l'API. </p><br><ul><li>  album_id de la classe TrackID et TrackShort; </li><li>  order_id de la classe AutoRenewable (abonnement); </li><li>  next_revision dans Feed; </li><li>  cover_uri dans Track; </li><li>  anniversaire dans le compte; </li><li>  balises dans la liste de lecture. </li></ul><br><p>  La liste est longue, mais tout est dans l'histoire des commits.  Peut-être que cet article est aspiré du doigt. </p><br></li><li><p>  <strong>Méthodes de similitude à l'exception de certains champs de la réponse</strong> </p><br><p>  Réponse sur l'état du compte ( <code>api.music.yandex.net/account/status</code> ): </p><br><p><img src="https://habrastorage.org/webt/vq/w5/ob/vqw5obhwgf-sfxzvldnjx0oqiow.png" alt="Réponse sur l'état du compte"></p><br><p>  État du compte <strong>radio de</strong> réponse ( <code>https://api.music.yandex.net/rotor/account/status</code> ): </p><br><p><img src="https://habrastorage.org/webt/5u/x-/-i/5ux--iokzt8ubw_n0xg8p7mtdl8.png" alt="Réponse radio de l'état du compte"></p><br><p>  Je comprends que les droits sont différents, les champs sont maintenant avec une limite non pas sur le nombre de pistes dans le cache, mais sur le nombre de sauts par heure, mais cela ressemble plus à une sorte de duplication. </p><br><p>  Je ne sais pas comment dans Yandex, mais je l'ai fusionné en une seule classe. </p><br></li><li><p>  <strong>Donc un ou plusieurs?</strong> </p><br><p>  J'ai toujours pensé que si une méthode renvoie une liste, même si le résultat est un élément, la liste contenant cet élément sera renvoyée et rien d'autre, mais ici et là, et plus encore. </p><br><p><img src="https://habrastorage.org/webt/r5/so/n8/r5son8mfj8yudwvmvtz52rb5smw.png" alt="fonctionnalité et fonctionnalités"></p><br><p>  Cette <em>fonctionnalité</em> reviendra, puis les <em>fonctionnalités</em> , puis la <em>fonctionnalité</em> et les <em>fonctionnalités</em> . </p><br></li><li><p>  <strong>Utilisation abusive des méthodes</strong> </p><br><p>  Ci-dessus, j'ai écrit qu'ils utilisent l'une ou l'autre méthode pour effectuer une action.  Ils sont allés plus loin. </p><br><p><img src="https://habrastorage.org/webt/xo/mz/gx/xomzgx1wbkbvhhfawdgy7vm4qss.png" alt="Envoi de morceaux supprimés lorsque le dos en est bien conscient"></p><br><p>  En plus de l' <strong>ID</strong> de la liste de lecture et des images <strong>avec</strong> et <strong>par</strong> quelle piste supprimer, pour une raison quelconque, ils transfèrent les <strong>pistes</strong> à supprimer à la méthode de suppression des pistes de la liste de lecture.  Il est possible que je n'aie pas compris cela, comme tout le reste, mais la méthode fonctionne sans trop d'informations.  Et quelles pistes ont été supprimées, il vaut mieux le savoir au dos, que de passer par paramètre. </p><br></li><li><p>  <strong>Demandes très lourdes</strong> </p><br><p>  J'ai écrit ci-dessus que donner une liste avec les ID de piste est une bonne pratique, vous obtenez des informations détaillées sur une piste uniquement lorsque vous en avez vraiment besoin.  Ce n'est pas toujours utilisé ici. </p><br><p>  Jetez un œil à la façon dont ils donnent sans pitié des informations détaillées sur <strong>tous</strong> mes morceaux de la liste de lecture "J'aime" en une seule demande: </p><br><p><img src="https://habrastorage.org/webt/cp/rk/1z/cprk1zszg-9qym37enbbunzxx40.png" alt="Demande lourde"></p><br><p>  Il a donné <strong>les 396 pistes</strong> !  Octets reçus: <strong>3,75 M</strong> , et ceci est un autre téléchargement de couverture! </p><br></li></ol><br><h2 id="bagusiki">  Baguettes </h2><br><ol><li><p>  <strong>Téléchargez toutes les pistes dans le cache à partir de "J'aime"</strong> </p><br><p>  Lorsque la limite a été atteinte, un ajout a été fait à la fin et supprimé depuis le début.  Merci pour la visualisation de la file d'attente, mais j'ai pensé que je ne ferais que télécharger les 100 derniers morceaux de la playlist.  Cela s'est produit dans le client mobile pour Android ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">regarder la vidéo</a> ). </p><br></li><li><p>  <strong>On dirait que je ne suis pas confus quand je dois envoyer un identifiant, mais quand id: album_id</strong> </p><br><p><img src="https://habrastorage.org/webt/x4/gl/fh/x4glfha84s1itujzdqjt0b53pbw.png" alt="Pistes en double"></p><br></li></ol><br><h1 id="zametki">  Remarques </h1><br><p>  Le nombre de tentatives d'activation du code cadeau est de 10. Prochaine interdiction pour 24 heures. </p><br><p>  Selon l'application à partir de laquelle vous êtes assis, différentes offres vous sont proposées pour souscrire un abonnement. </p><br><p>  La limite du nombre de pistes dans le cache est une illusion, c'est juste un nombre, et l'application ne vous permet pas de charger plus (bagus 2). </p><br><p>  Toutes ces listes de lecture intelligentes, suggestions, couleurs de texte et de bouton proviennent de l'API - le voici, un vrai RESTFull. </p><br><p>  L'heure de début de l'annonce et l'annonce elle-même sont renvoyées même si vous avez un abonnement. </p><br><p>  Un lien vers XML contenant des données sur l'emplacement du fichier à télécharger dure 1 minute, puis une erreur 410. </p><br><h1 id="zaklyuchenie">  Conclusion </h1><br><p>  Je n'ai écrit que ce dont je me souvenais.  Après tout, j'ai rencontré tout cela pendant plusieurs mois.  Toutes mes notes sont des messages dans un télégramme, parce que quand je suis tombé sur quelque chose comme ça, j'ai partagé avec des amis.  J'ai essayé de restaurer les points clés. </p><br><p>  Je ne voulais en aucun cas dire à quel point tout était mauvais, en quelque sorte pour mettre les jambages sur le public spécialement.  Ce n'est peut-être pas du tout un montant, mais tout ce que j'ai écrit ci-dessus <strong>me</strong> semble personnellement étrange. </p><br><p>  Il a partagé avec vous comment il a écrit la bibliothèque de l'API de service privée Yandex.Music et quelles choses il a rencontrées pendant le développement. </p><br><p>  Vous savez maintenant comment et sur quoi fonctionne leur application Windows, et donc ma bibliothèque. </p><br><p>  Au fait, maintenant j'essaie de tout documenter, lors de la documentation de ma bibliothèque, je documente automatiquement leur API.  C'est serré, et j'ai encore besoin de temps pour trouver une entreprise pour passer par la pratique technologique industrielle. </p><br><p>  Merci d'avoir lu jusqu'ici! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr462607/">https://habr.com/ru/post/fr462607/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr462593/index.html">De l'autre côté du stand</a></li>
<li><a href="../fr462595/index.html">Audit et test des lettres: ce à quoi vous devez faire attention lors de la mise en page</a></li>
<li><a href="../fr462597/index.html">Dactylographier et réagir</a></li>
<li><a href="../fr462601/index.html">Sauvegarde des serveurs Windows dans AWS</a></li>
<li><a href="../fr462605/index.html">Trace italienne en cryptographie</a></li>
<li><a href="../fr462615/index.html">Pourquoi est-il si difficile de choisir le film à regarder (et les réseaux de neurones ne résoudront pas ce problème)</a></li>
<li><a href="../fr462619/index.html">Enfants, mathématiques et R</a></li>
<li><a href="../fr462625/index.html">Dell G5 5590: l'un des ordinateurs portables de jeu les plus abordables avec RTX 2060</a></li>
<li><a href="../fr462631/index.html">Week-end Web: développement intensif de sites Web en Netologie</a></li>
<li><a href="../fr462635/index.html">Quantum, or there and back: un nouvel algorithme pour étudier la transition quantique-classique</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>