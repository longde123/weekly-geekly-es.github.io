<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👲 🕞 ✏️ Die Fernüberwachung und -verwaltung von Linux / OpenWrt / Lede-basierten Geräten über Port 80 wurde fortgesetzt 👨🏼‍🔬 👨‍🍳 🕖</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dies ist der letzte Teil des Artikels, hier ist der Anfang . 

 Das letzte Mal, als ich darüber schrieb, wie ich die Geräteüberwachung implementiert h...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Die Fernüberwachung und -verwaltung von Linux / OpenWrt / Lede-basierten Geräten über Port 80 wurde fortgesetzt</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/446230/">  Dies ist der letzte Teil des Artikels, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier ist der Anfang</a> . <br><br>  Das letzte Mal, als ich darüber schrieb, wie ich die Geräteüberwachung implementiert habe, konzentrieren wir uns jetzt auf das Management.  In Gesprächen mit "Technikfreaks" seitens des Kunden stoße ich häufig auf eine eingeschränkte Wahrnehmung der Fähigkeiten derart kleiner Geräte (mit geringen Speicherressourcen und Leistung). Viele Leute denken, dass "das Maximum, das wir brauchen, ein Neustart ist, für etwas Ernsthafteres - wir werden ein Team schicken". . <br><br>  Die Praxis zeigt jedoch, dass dies nicht ganz stimmt. <br><a name="habracut"></a><br>  Hier ist eine kurze Liste allgemeiner allgemeiner Aufgaben: <br><br><ol><li>  Netzwerkdiagnose und Fehlerbehebung.  Hinter dem Ethernet-Port Ihres Routers verfügt normalerweise eine andere Hardware über eine eigene interne IP-Adresse.  Manchmal kann (muss) es "pingen".  Oder Tunnelverwaltung - wenn ein Router, der nicht plötzlich auf einem Router hochfährt, der über ein 3G-Modem ausgeführt wird, den Router selbst sieht. </li><li>  Systemdienst.  Firmware-Upgrade, Service-Skript-Upgrade. </li><li>  Balanceakt.  Dies könnte als "Perversionen" bezeichnet werden, aber das Konzept des "Balancers", wie ich zitiere, <i>"die Fähigkeit eines Zirkuskünstlers, das Gleichgewicht in einer instabilen Position des Körpers aufrechtzuerhalten",</i> ist geeigneter.  Ähnliche Situationen ergeben sich aus dem begrenzten Budget des Kunden.  Nachfolgend einige Beispiele, aber weil  Sie haben keinen direkten Bezug zum Thema der Erzählung, schreiben Sie sie in Notizen </li></ol><br><div class="spoiler">  <b class="spoiler_title">Wifi-Überwachung</b> <div class="spoiler_text">  Ein modisches Thema der letzten fünf Jahre sind vor allem die Einzelhandelsketten des Bundes.  Sie gehen langsam durch die Handelsetagen, und Ihr Mobiltelefon mit eingeschaltetem Wi-Fi, das versucht, sich an einen Netzwerkthread zu halten, sendet regelmäßig Probe Request-Pakete, die analysiert werden können, um zu berechnen, wie oft Sie für was in dieses Geschäft kommen Gehen Sie die Flugbahnen und so weiter.  Dann werden die Daten gesammelt, analysiert, Heatmaps erstellt und Manager für solche Bilder „schlagen“ Geld vom Management oder von Investoren aus.  In der Zwischenzeit ... "es gibt kein Geld, aber du hältst an ...", und das Ergebnis (echt) muss bereits gezeigt werden, das gute alte Lied ist enthalten "Ja, ja, dann werden wir natürlich Tsiska setzen und was auch immer du willst, aber jetzt brauchen wir Zeigen Sie dem Kunden das Ergebnis!  Übrigens haben sie vergessen zu sagen, dass der Kunde zugelassen hat, dass unsere Geräte über WLAN mit seinem Hotspot verbunden sind, aber im Allgemeinen ist es so, als wären wir Gastkunden. "  Und jetzt müssen Sie Router-Balancer erstellen - mehrere WiFi-Subschnittstellen entstehen, von denen eine an einem Hotspot haftet, und die zweite überwacht die Umgebung, entlädt das Ergebnis von tcpdump verzweifelt in sich selbst, dann wird der Inhalt der Datei in das Archiv gepackt und es besteht die Gefahr, dass er durch "übermäßiges Essen" stirbt versuchen, den Inhalt auf dem FTP-Server auszuspucken.  Es ist nicht verwunderlich, dass der Router-Balancer häufig „ausfällt“ und irgendwie aus der Ferne wiederbelebt werden muss. <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Radius</b> <div class="spoiler_text">  Hier ist es einfacher, die Situation mit so etwas wie der Aussage des Kunden zu beschreiben: <i>„Wir wollen ein dezentrales Netzwerk von Hotspots, die an Geräten arbeiten, deren Modell nicht im Voraus über Kanäle bekannt ist, die wir aber noch nicht kennen.</i>  <i>Ah, sie haben vergessen zu sagen, wir wollen nicht nur Anzeigen für Kunden schalten, sondern auch alles rund um den Installationsort des Hotspots analysieren.</i>  <i>Nein, wir wissen noch nicht warum, aber wir werden ohne Zweifel auf diese Idee kommen. "</i> <br></div></div><br>  Und wir dürfen nicht vergessen, dass aufgrund der Vielzahl von Umständen, die im Voraus ungewiss sind, die Steuerung unter nicht standardmäßigen Bedingungen durchgeführt werden sollte, wenn wir keine direkte Verbindung zum Router über ip: the port herstellen können und nur auf die Aktivität von dort warten müssen.  Wenn wir es ignorieren, kann der Dialog zwischen dem Server und dem Router folgendermaßen dargestellt werden: <br><br><ul><li>  <b>Router</b> : Hallo.  Ich bin so ein Router, gibt es irgendwelche Aufgaben für mich? </li><li>  <b>Server</b> : so und so ein Router Ich habe dich registriert, dass du am Leben bist.  Hier ist die Aufgabe: Zeigen Sie mir das Ergebnis des Befehls ifconfig? </li><li>  <b>Router</b> : Hallo.  Ich bin so ein Router. Als Sie mich das letzte Mal gebeten haben, das Ergebnis von ifconfig anzuzeigen, ist es hier.  Gibt es irgendwelche Aufgaben für mich? </li><li>  <b>Server</b> : so und so ein Router Ich habe dich registriert, dass du am Leben bist.  Es gibt keine Aufgaben für Sie. </li></ul><br>  Die interessanteste Frage: Wie kann ein Remote-Router eine bestimmte Menge an Informationen senden?  Im letzten Teil habe ich beschrieben, dass es auf dem Router aufgrund begrenzter Ressourcen nur ein "abgespecktes" Wget gibt, das nur über GET funktioniert, und sonst nichts, es gibt keinen FTP-Client oder Curl.  Genauer gesagt, wir brauchen einen universellen Weg, unabhängig von den Merkmalen der Bildanordnung.  Ich entschied mich für wget.  Genauer gesagt, wie ich "aufgehört" habe - ich hatte einfach keine Wahl :) <br><br><div class="spoiler">  <b class="spoiler_title">Sofortige Reservierung</b> <div class="spoiler_text">  Meine Managementlösung funktioniert, ist aber sehr begrenzt und ich bin sicher, dass sie schief ist, auch wenn sie für die meisten meiner Kunden geeignet ist.  Wie es möglich wäre, es mit Bedacht zu tun - ein kleines Dienstprogramm zu schreiben, das Binärdaten über den 80. Port sendet.  Fügen Sie es (Dienstprogramm) in die Firmware des Routers ein und verwenden Sie bash, um darauf zuzugreifen.  Aber die Realität ist: a) Sie müssen schnell b) Vielleicht müssen Sie alles auf dem vorhandenen "Router Zoo" tun c) "keinen Schaden anrichten!"  - Wenn der Router funktioniert und andere Aufgaben ausführt, versuchen Sie, Änderungen vorzunehmen, die sich auf die vorhandene Funktionalität auswirken. <br></div></div><br>  Fahren wir mit der Implementierung fort.  Angenommen, Ihr Kunde möchte, dass zabbix den Router einfach und natürlich mit einem Mausklick neu startet.  Heute beginnen wir die Beschreibung der Implementierung mit zabbiksa. <br><br>  Fügen Sie im Menü "Administration" -&gt; "Skripte" ein neues Skript hinzu.  Wir nennen es "Reboot", als Befehl schreiben wir "php /usr/share/zabbix/reboot.php {HOST.HOST}" <br><br><img src="https://habrastorage.org/webt/pf/hg/on/pfhgongtotx7njamqfnrnxcqvhg.jpeg"><br><br>  Weiter: Menü "Überwachung" -&gt; "Letzte Daten" -&gt; "Rechtsklick auf den Netzwerkknoten".  So sieht das Menü nach dem Hinzufügen eines Skripts aus. <br><br><img src="https://habrastorage.org/webt/4k/um/go/4kumgoc08rhijg8sz5jq_e1t3z4.jpeg"><br>  Dementsprechend legen wir das Skript reboot.php im Verzeichnis / usr / share / zabbix ab (möglicherweise haben Sie ein anderes, ich verwende das Stammverzeichnis von zabbixa). <br><br><div class="spoiler">  <b class="spoiler_title">Haftungsausschluss für die Sicherheit</b> <div class="spoiler_text">  Zur Verdeutlichung der Erklärung im Skript verwende ich nur die ID des Routers, aber nicht das Kennwort.  In der Arbeitsversion wird dies nicht empfohlen!  Warum habe ich das getan: Weil die große Frage ist, wo Passwörter für Router gespeichert werden sollen?  In zabbixe selbst im "Inventar"?  Widersprüchliche Praxis.  Optional: Beschränken Sie den externen Zugriff auf die Datei reboot.php <br></div></div><br>  Reboot.php Datei <br><br><pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">//      $user = $argv[1]; // .      -   !            . //$password = $argv[2]; $conn=new mysqli("localhost","db_user","db_password","db_name"); if (mysqli_connect_errno()) { exit(); } $conn-&gt;set_charset("utf8"); // ""  reboot     task  users.   task    . $sql_users=$conn-&gt;prepare("UPDATE users SET task='reboot' WHERE id=? AND status='active';"); $sql_users-&gt;bind_param('s', $user); $sql_users-&gt;execute(); $sql_users-&gt;close(); </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre> <br>  Eigentlich alles.  Die Frage „Wie erhält man das Ergebnis der Ausführung eines Befehls von der Geräteseite?“ Bleibt offen.  Betrachten Sie das Problem am Beispiel des Befehls ifconfig.  Dieser Befehl kann an das Gerät gesendet werden: <br><br><pre> <code class="bash hljs">message=`ifconfig`; wget <span class="hljs-string"><span class="hljs-string">"http://xn--80abgfbdwanb2akugdrd3a2e5gsbj.xn--p1ai/a.php?u=user&amp;p=password!&amp;m=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$message</span></span></span><span class="hljs-string">"</span></span> -O /tmp/out.txt</code> </pre> <br>  wo: <br>  <i>message = `ifconfig`</i> - Wir weisen das Ergebnis der Ausgabe des Befehls ifconfig der Variablen $ message zu <br>  <i>wget " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">xn - 80abgfbdwanb2akugdrd3a2e5gsbj.xn - p1ai / a.php</a></i> - unser a.php-Skript, das Router registriert und Nachrichten von ihnen empfängt <br>  <i>u = Benutzer &amp; p = Passwort! &amp; m = $ message</i> - Anmeldeinformationen und der Wert der Anforderungsvariablen m - weist den Inhalt der Variablen $ message zu <br>  <i>-O /tmp/out.txt</i> - In diesem Fall benötigen wir keine Ausgabe in die Datei /tmp/out.txt. Wenn Sie diesen Parameter jedoch nicht angeben, funktioniert wget nicht <br><br><div class="spoiler">  <b class="spoiler_title">Warum funktioniert es schief?</b> <div class="spoiler_text">  Weil es eine potenzielle Sicherheitslücke ist.  Der harmloseste Fehler, der auftreten kann, ist beispielsweise, wenn die Ausgabe Ihres Befehls ein "&amp;" -Symbol enthält.  Daher ist es notwendig, alles zu filtern, was von Routern gesendet wird, und alles, was zum Server kommt.  <b>Ja, ich schäme mich wirklich.</b>  Zu meiner Verteidigung kann ich nur schreiben, dass der gesamte Artikel der Verwaltung von Routern mit undefinierter Firmware im Voraus und Kommunikationskanälen im Voraus gewidmet ist. <br></div></div><br>  Nun, ich habe die Zukunft berührt: Ich habe nicht herausgefunden, wie ich die Ergebnisse (z. B. das Ergebnis des Befehls) widerspiegeln kann, die mit Standard-Zabbix-Tools auf den Server gelangen. <br><br>  Ich erinnere Sie daran, dass <a href="">alle Quellen aus dem Git-Repository entnommen werden können</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de446230/">https://habr.com/ru/post/de446230/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de446212/index.html">SIEM-Tiefen: Out-of-Box-Korrelationen. Teil 5. Methodik zur Entwicklung von Korrelationsregeln</a></li>
<li><a href="../de446214/index.html">OS1: Ein primitiver Kernel auf Rust für x86. Teil 3. Speicherkarte, Seitenfehlerausnahme, Heap und Zuordnungen</a></li>
<li><a href="../de446218/index.html">Game Designer unterscheidet sich nicht viel von einem Psycho. Wie wir das CMAN-Spiel gemacht haben</a></li>
<li><a href="../de446222/index.html">Nutzung thermischer Potentiale für die Gebietsanalyse</a></li>
<li><a href="../de446228/index.html">Verbesserung der Qualität der Textklassifizierung durch Verbindung von Wikipedia</a></li>
<li><a href="../de446234/index.html">Wie Freiwillige aus aller Welt Live-Übertragungen von ICPC-2019 erstellen</a></li>
<li><a href="../de446236/index.html">Yandex wird die Spracherkennungsalgorithmen verbessern</a></li>
<li><a href="../de446238/index.html">Ausnutzen signierter Bootloader, um UEFI Secure Boot zu umgehen</a></li>
<li><a href="../de446242/index.html">Aufschub als Werkzeug für Zeitreisen</a></li>
<li><a href="../de446244/index.html">Chrome-Erweiterungen für die Webentwicklung und die Arbeit mit GitHub</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>