<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèΩ‚Äçüî¨ ü§πüèº üßòüèª C√≥mo ensamblar una imagen de Oracle DB para Testcontainers üë®üèæ‚Äçü§ù‚Äçüë®üèΩ ‚ÄºÔ∏è üè¥Û†ÅßÛ†Å¢Û†Å∑Û†Å¨Û†Å≥Û†Åø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="El c√≥digo debe probarse en el DBMS con el que funcionar√°. Testcontainers es una biblioteca que le permite usar casi cualquier DBMS en pruebas unitaria...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C√≥mo ensamblar una imagen de Oracle DB para Testcontainers</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/480106/"><p>  El c√≥digo debe probarse en el DBMS con el que funcionar√°.  Testcontainers es una biblioteca que le permite usar casi cualquier DBMS en pruebas unitarias con la misma facilidad que las bases de datos integradas como HSQLDB o H2.  Solo habr√≠a una imagen acoplable </p><br><img src="https://habrastorage.org/webt/hn/x3/ho/hnx3hojiqvya8flignz-mqkrk6s.jpeg"><br><p>  Este art√≠culo est√° dedicado al ensamblaje de una imagen acoplable que es conveniente para usar con Testcontainers.  Cuando intent√© hacerlo, tuve problemas y aqu√≠ comparto mi soluci√≥n. <br>  Recopilar√© la imagen para Oracle 11, porque es peque√±a y tengo suficiente versi√≥n 11.  Con otras versiones, el enfoque es casi el mismo. </p><br><p>  Para dejar en claro c√≥mo usar la imagen, tambi√©n habr√° un c√≥digo Java que demuestre el uso de la imagen para probar las aplicaciones Spring Boot.  El m√©todo de conexi√≥n a los contenedores de prueba que he dado probablemente no sea el mejor.  Pero, en primer lugar, muestra c√≥mo usar la configuraci√≥n especificada al crear la imagen.  En segundo lugar, es simple.  Y en tercer lugar, casi no est√° vinculado a Spring, incluso puede estar atascado en el c√≥digo Java, en el que no hay nada m√°s que vac√≠o est√°tico p√∫blico main. </p><br><p>  Se supone que el lector est√° superficialmente familiarizado con Docker y Testcontaners, y tambi√©n conoce bien Java.  Para compilar, debe usar Linux, si est√° compilando en Windows, necesitar√° usar msys2 o algo as√≠. </p><br><p>  El c√≥digo de demostraci√≥n se carga en el github aqu√≠ <a href="https://github.com/poxu/testcontainers-spring-demo" rel="nofollow">https://github.com/poxu/testcontainers-spring-demo Los</a> scripts corregidos para ensamblar la imagen se pueden ver en mi tenedor de las instrucciones de Oraklov <a href="https://github.com/poxu/docker-images/tree/master/OracleDatabase/SingleInstance" rel="nofollow">https://github.com/poxu/docker-images/tree/ master / OracleDatabase / SingleInstance</a> </p><a name="habracut"></a><br><h1>  Construir una imagen de Docker </h1><br><p>  Oracle no proporciona im√°genes para la ventana acoplable, pero public√≥ instrucciones detalladas sobre c√≥mo ensamblarlas en el github. </p><br><p>  Desafortunadamente, no es posible usar estas im√°genes en contenedores de prueba porque el contenedor que se inicia desde esta imagen comienza de dos a 20 minutos. </p><br><p>  Esto es inaceptable para su uso en pruebas unitarias, por lo que debe realizar sus propios cambios en los scripts, pero primero, es mejor intentar ensamblar el contenedor de acuerdo con las instrucciones proporcionadas por Oracle.  Har√© un breve recuento aqu√≠, una instrucci√≥n m√°s completa se puede encontrar en este enlace <a href="https://github.com/oracle/docker-images/tree/master/OracleDatabase/SingleInstance" rel="nofollow">https://github.com/oracle/docker-images/tree/master/OracleDatabase/SingleInstance</a> </p><br><h2>  Ensamblaje de la imagen seg√∫n las instrucciones de Oracle </h2><br><p>  Primero, debe clonar el repositorio con instrucciones sobre c√≥mo ensamblar la imagen. </p><br><pre><code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/oracle/docker-images.git</code> </pre> <br><p>  Luego obtenga el paquete rpm para la versi√≥n express autorizada de Oracle 11.2.0.2. No es muy dif√≠cil, solo necesita registrarse en el sitio web de Oracle, ir a la p√°gina de descarga de Oracle DBMS, seleccionar la versi√≥n 11.2.0.2 XE all√≠ y descargar el archivo rpm empaquetado oracle-xe-11.2.0 -1.0.x86 ~ 64 ~ .rpm.zip. </p><br><p>  Coloque el archivo en el repositorio git descargado en el directorio docker-images / OracleDatabase / SingleInstance / dockerfiles / 11.2.0.2 / </p><br><p>  A continuaci√≥n, vaya al directorio docker-images / OracleDatabase / SingleInstance / dockerfiles y ejecute el comando </p><br><pre> <code class="bash hljs">./buildDockerImage.sh -v 11.2.0.2 -x</code> </pre> <br><p>  La ventana acoplable ensamblar√° una imagen llamada oracle / database: 11.2.0.2-xe en funci√≥n de la cual debe crear el contenedor con este comando </p><br><pre> <code class="bash hljs">docker run --rm --name vanilla_oracle_test_habr \ -p 1234:1521 \ -p 5678:5500 \ -e ORACLE_PWD=123 \ --shm-size=<span class="hljs-string"><span class="hljs-string">"1g"</span></span> \ oracle/database:11.2.0.2-xe</code> </pre> <br><p>  El contenedor comienza unos minutos, porque despu√©s de comenzar crea una nueva base de datos, y este proceso no es r√°pido. </p><br><p>  Despu√©s de unos minutos, aparecer√° un banner en la consola. </p><br><blockquote>  ############################ <br>  ¬°LA BASE DE DATOS EST√Å LISTA PARA USAR! <br>  ############################ </blockquote><p>  Despu√©s de eso, puede conectarse a la base de datos utilizando el inicio de sesi√≥n del SISTEMA, la contrase√±a es 123, la direcci√≥n de conexi√≥n es localhost y SID es XE. </p><br><p>  Si todo funcion√≥, puede continuar con el proceso de creaci√≥n de una imagen en contenedores de prueba.  De lo contrario, es mejor leer primero el manual de Oracle y descubrir qu√© est√° mal. </p><br><p>  Como ya descubrimos, el contenedor se inicia durante mucho tiempo debido al hecho de que despu√©s del inicio se crea una base de datos.  En algunos casos, esto puede ser conveniente, pero ahora esto est√° causando un da√±o total.  Es necesario preparar el contenedor para su uso inmediatamente despu√©s del lanzamiento. </p><br><h2>  Refinamiento manual de imagen </h2><br><p>  Una forma de obtener la imagen de la base de datos terminada es esperar hasta que se inicie el contenedor y se complete la creaci√≥n de la base de datos, y luego guardar el contenedor en una nueva imagen. </p><br><p>  Solo es importante no iniciar el contenedor con el argumento --rm, de lo contrario, la ventana acoplable lo golpear√° inmediatamente despu√©s de detenerse. </p><br><pre> <code class="bash hljs">docker commit --message <span class="hljs-string"><span class="hljs-string">"container for unit tests"</span></span> &lt;container id&gt; my/oracle-11.2.0.2-for-unit-tests</code> </pre> <br><p>  Esto crear√° una nueva imagen del contenedor, que se lanzar√° no solo en unos minutos, sino en 20-30 segundos. </p><br><h2>  Modificaci√≥n del proceso de ensamblaje de im√°genes para obtener una imagen terminada inmediatamente despu√©s del ensamblaje </h2><br><p>  Por supuesto, es bueno tener instrucciones para ensamblar la imagen en forma de c√≥digo para que pueda comenzar el ensamblaje con un comando y no haya necesidad de esperar a que el contenedor se inicie y cree una imagen basada en ella con sus manos. </p><br><p>  La √∫ltima l√≠nea del dockerfile indica el comando que se ejecuta despu√©s del inicio. </p><br><pre> <code class="bash hljs">CMD <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> <span class="hljs-variable"><span class="hljs-variable">$ORACLE_BASE</span></span>/<span class="hljs-variable"><span class="hljs-variable">$RUN_FILE</span></span></code> </pre> <br><p>  \ $ ORACLE ~ BASE ~ / \ $ RUN ~ FILE ~ apunta al archivo docker-images / OracleDatabase / SingleInstance / dockerfiles / 11.2.0.2 / runOracle.sh </p><br><p>  Si detiene este contenedor y luego lo ejecuta nuevamente, como resultado, por primera vez, el script crear√° la base de datos, y la segunda vez simplemente lo iniciar√°.  Se puede suponer que si ejecuta el script en la etapa de ensamblaje de la imagen, la imagen se ensamblar√° desde la base de datos ya creada. </p><br><p>  Pero en el camino hacia la implementaci√≥n de este plan audaz, surge una complicaci√≥n. </p><br><p>  El script se ejecuta para siempre, es decir, hasta que llega una se√±al en el contenedor de que el trabajo debe completarse.  Esto se resuelve de manera bastante simple.  La √∫ltima l√≠nea del archivo runOracle.sh contiene el comando de espera.  Sabemos que en la etapa de ensamblaje no necesita esperar nada, debe terminar el trabajo y, por lo tanto, colocaremos una declaraci√≥n condicional en el script. </p><br><p>  Verificar√° si el argumento --running-while-building no se pasa al archivo y si se pasa este argumento, no espere se√±ales, simplemente interrumpa el trabajo.  Es decir, haz esto: </p><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">"</span></span> != <span class="hljs-string"><span class="hljs-string">"--running-while-building"</span></span> ] <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">wait</span></span> <span class="hljs-variable"><span class="hljs-variable">$childPID</span></span> <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span></code> </pre> <br><p>  Bueno, en el dockerfile agregamos otra llamada de script, solo en la etapa de ensamblaje.  Resultar√° as√≠. </p><br><pre> <code class="bash hljs">RUN <span class="hljs-variable"><span class="hljs-variable">$ORACLE_BASE</span></span>/<span class="hljs-variable"><span class="hljs-variable">$RUN_FILE</span></span> --running-while-building CMD <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> <span class="hljs-variable"><span class="hljs-variable">$ORACLE_BASE</span></span>/<span class="hljs-variable"><span class="hljs-variable">$RUN_FILE</span></span></code> </pre> <br><h2>  Cambios necesarios para su uso en pruebas </h2><br><h3 id="ustranit-ispolzovanie-tomov">  Eliminar el uso de volumen </h3><br><p>  Necesito encontrar la linea </p><br><blockquote>  VOLUMEN ["\ $ ORACLE ~ BASE ~ / oradata"] </blockquote><p>  Y comentarlo.  No es necesario usar vol√∫menes, ya que todos los cambios se realizar√°n despu√©s de cada ejecuci√≥n de prueba, pero pueden surgir f√°cilmente problemas al usar vol√∫menes al copiar im√°genes. </p><br><h3 id="udalit-nenuzhnye-fayly">  Eliminar archivos innecesarios </h3><br><p>  Necesito agregar l√≠neas </p><br><pre> <code class="bash hljs">rm -rf <span class="hljs-variable"><span class="hljs-variable">$ORACLE_HOME</span></span>/demo &amp;&amp; \ rm -rf <span class="hljs-variable"><span class="hljs-variable">$ORACLE_HOME</span></span>/jdbc &amp;&amp; \ rm -rf <span class="hljs-variable"><span class="hljs-variable">$ORACLE_HOME</span></span>/jlib &amp;&amp; \ rm -rf <span class="hljs-variable"><span class="hljs-variable">$ORACLE_HOME</span></span>/md &amp;&amp; \ rm -rf <span class="hljs-variable"><span class="hljs-variable">$ORACLE_HOME</span></span>/nls/demo &amp;&amp; \ rm -rf <span class="hljs-variable"><span class="hljs-variable">$ORACLE_HOME</span></span>/odbc &amp;&amp; \ rm -rf <span class="hljs-variable"><span class="hljs-variable">$ORACLE_HOME</span></span>/rdbms/jlib &amp;&amp; \ rm -rf <span class="hljs-variable"><span class="hljs-variable">$ORACLE_HOME</span></span>/rdbms/public &amp;&amp; \ rm -rf <span class="hljs-variable"><span class="hljs-variable">$ORACLE_HOME</span></span>/rdbms/demo &amp;&amp; \ rm -rf <span class="hljs-variable"><span class="hljs-variable">$ORACLE_HOME</span></span>/bin/rman &amp;&amp; \</code> </pre> <br><p>  Justo antes de la l√≠nea </p><br><pre> <code class="bash hljs">chmod ug+x <span class="hljs-variable"><span class="hljs-variable">$ORACLE_BASE</span></span>/*.sh</code> </pre> <br><p>  Esto eliminar√° de la imagen todos los archivos que no son necesarios para fines de prueba.  Cuanto m√°s peque√±a es la imagen, mejor. </p><br><h3 id="ubrat-razbienie-obraza-na-sloi">  Eliminar divisi√≥n de imagen </h3><br><p>  Para reducir la imagen, debe crearla utilizando el argumento de <strong>squash</strong> .  Eliminar√° la separaci√≥n en capas de la imagen, lo que reducir√° a√∫n m√°s su volumen.  El argumento de squash es experimental, por lo que debe habilitarlo por separado.  En diferentes sistemas operativos, esto se hace de diferentes maneras. </p><br><p>  Para reenviar argumentos a la ventana acoplable, docker-images / OracleDatabase / SingleInstance / dockerfiles / buildDockerImage.sh proporciona el argumento -o.  Es decir, para reenviar el argumento --squash al docker, debe llamar a buildDockerImage.sh de esta manera </p><br><pre> <code class="bash hljs">./buildDockerImage.sh -o <span class="hljs-string"><span class="hljs-string">'--squash'</span></span></code> </pre> <br><h3 id="pomenyat-nazvanie-obraza">  Cambiar nombre de imagen </h3><br><p>  Hasta la fecha, la imagen es significativamente diferente de lo que Oracle propone hacer, por lo que debe cambiar su nombre.  Para hacer esto, ya necesita editar el archivo buildDockerImage.sh. El script toma el nombre de la imagen de la variable IMAGE ~ NAME ~, cuyo valor se establece directamente en el archivo </p><br><p>  Justo aqui </p><br><pre> <code class="plaintext hljs"># Oracle Database Image Name IMAGE_NAME="oracle/database:$VERSION-$EDITION"</code> </pre> <br><p>  Me cambi√© a </p><br><pre> <code class="plaintext hljs"># Oracle Database Image Name IMAGE_NAME="my/oracle-for-habr:$VERSION-$EDITION"</code> </pre> <br><h3 id="zadat-parol-k-bd">  Establecer contrase√±a de base de datos </h3><br><p>  Esta contrase√±a se establece en la variable de entorno ORACLE ~ PWD ~ durante el primer inicio del contenedor.  Pero tenemos la configuraci√≥n de la base de datos durante la creaci√≥n de la imagen, por lo que la variable debe definirse en esta etapa.  Si no es necesaria la capacidad de establecer una contrase√±a para cada ensamblaje a trav√©s de la l√≠nea de comando, simplemente puede ingresarla en el dockerfile: </p><br><pre> <code class="plaintext hljs">ENV ORACLE_PWD=123</code> </pre> <br><p>  Si para algo necesita poder determinar la contrase√±a nuevamente con cada compilaci√≥n, para reenviar el argumento a la ventana acoplable, puede usar nuevamente -o </p><br><pre> <code class="bash hljs">./buildDockerImage.sh -v 11.2.0.2 -x -o <span class="hljs-string"><span class="hljs-string">'--squash --build-arg ORACLE_PWD=123'</span></span></code> </pre> <br><p>  Esto transferir√° la variable de entorno ORACLE ~ PWD ~ al dockerfile, pero el dockerfile no lo pasar√° a los scripts que se ejecutan durante la compilaci√≥n.  Para que √©l haga esto, debe agregar la instrucci√≥n ARG al dockerfile. </p><br><pre> <code class="plaintext hljs">ARG ORACLE_PWD=default</code> </pre> <br><p>  La contrase√±a, como probablemente ya se haya aclarado, ser√° 123, y si no pasa ORACLE ~ PWD ~ a buildDockerImage.sh, entonces estar√° predeterminado. </p><br><p>  A veces, Oracle cree que la contrase√±a es incorrecta y no quiere funcionar, por lo que puede ser necesario reemplazar 123 por otra cosa </p><br><h2>  Prueba elevando la imagen resultante </h2><br><p>  Ahora puede intentar ejecutar el contenedor en funci√≥n de la imagen </p><br><pre> <code class="bash hljs">docker run --rm --name dockertest_habr \ -p 1234:1521 \ -p 5678:5500 \ --shm-size=<span class="hljs-string"><span class="hljs-string">"1g"</span></span> \ my/oracle-for-habr:11.2.0.2-xe</code> </pre> <br><p>  El argumento --shm-size = "1g" es importante aqu√≠, sin el cual se inicia el contenedor, pero Oracle 11.2.0.2 en s√≠ mismo no puede funcionar.  Esto, por si acaso, no significa que el contenedor necesitar√° un gigabyte de RAM, ya que consume unos 100 megabytes. </p><br><p>  Si el contenedor se ha elevado normalmente, puede intentar conectarse a la base de datos, que se encuentra all√≠. </p><br><p>  Direcci√≥n base: probablemente localhost <br>  Puerto - 1234 <br>  Usuario - SISTEMA <br>  Contrase√±a - 123 </p><br><p>  Si comienza normalmente, puede continuar con el siguiente paso. </p><br><h2>  Script de inicializaci√≥n de DB </h2><br><p>  Para que el programa pueda trabajar con la base de datos desde la imagen, es necesario que haya un circuito all√≠ despu√©s del lanzamiento.  Puede crear este circuito en la etapa de construcci√≥n, pero prefiero hacerlo cuando se inicia el contenedor. </p><br><p>  Despu√©s de comenzar, el contenedor buscar√° en el directorio <em>u01 / app / oracle / scripts / startup</em> y ejecutar√° todos los scripts sql que encuentre all√≠, que puede usar colocando el archivo all√≠ que crear√° el circuito.  Algo asi. </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span> TEST_USER <span class="hljs-keyword"><span class="hljs-keyword">IDENTIFIED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> passwordnoquotes; <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span> TEST_USER <span class="hljs-keyword"><span class="hljs-keyword">QUOTA</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unlimited</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SYSTEM</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SESSION</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONNECT</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">RESOURCE</span></span>, DBA <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> TEST_USER; <span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">PRIVILEGES</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> TEST_USER;</code> </pre> <br><p>  Todo esto debe agregarse al archivo init ~ db ~ .sql, y el archivo se arroja al contenedor usando -v </p><br><pre> <code class="bash hljs">docker run --rm --name dockertest_habr \ -p 1234:1521 \ -p 5678:5500 \ -e ORACLE_PWD=123 \ -v <span class="hljs-variable"><span class="hljs-variable">${PWD}</span></span>/init_db.sql:/u01/app/oracle/scripts/startup/init_db.sql \ --shm-size=<span class="hljs-string"><span class="hljs-string">"1g"</span></span> \ my/oracle-for-habr:11.2.0.2-xe</code> </pre> <br><p>  \ $ {PWD} Aqu√≠ se usa porque se necesita la ruta absoluta al archivo, cuando se usa Windows, debe especificarlo de alguna manera diferente.  Si, despu√©s de comenzar, el esquema TEST ~ USER ~ se cre√≥ con √©xito, puede proceder a atornillar el contenedor reci√©n creado a las pruebas. </p><br><h1>  Usando una imagen en c√≥digo Java </h1><br><p>  Cuando se prueba con la base de datos integrada, como regla general, surge el mismo problema.  Si la configuraci√≥n no se puede tomar del cach√©, Spring la recopila nuevamente.  En particular, vuelve a crear la base de datos integrada, lo que, por supuesto, ralentiza considerablemente las pruebas.  Resolv√≠ el problema con la fuerza bruta simplemente haciendo que la parte de elevaci√≥n del contenedor fuera √∫nica.  Real, condominio. </p><br><p>  Para Oracle XE, Testcontainers tiene una clase especialmente preparada.  En primer lugar, esta clase sabe que estamos hablando de un contenedor con un DBMS y que para determinar si est√° activado, debemos intentar conectarnos a la base de datos usando jdbc. </p><br><p>  Un objeto de esta clase esperar√° a que el contenedor se levante solo, solo necesita decirle qu√© registros con contrase√±a usar. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.testcontainers.containers.BindMode; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.testcontainers.containers.OracleContainer; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StaticOracleContainer</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> OracleContainer </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getContainer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> LazyOracleContainer.ORACLE_CONTAINER; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LazyOracleContainer</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> OracleContainer ORACLE_CONTAINER = makeContainer(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> OracleContainer </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">makeContainer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//       testcontainers.properties //  oracle.container.image final var dockerImageName = "my/oracle-for-habr"; final var container = new OracleContainer(dockerImageName) //    ,  testcontainers //  ,  ,  //   .withUsername("SYSTEM").withPassword("123") // ,  testcontainers  //     .withExposedPorts(1521, 5500) //      shared memory //    .withSharedMemorySize(2147483648L) //   ,       // -v /path/to/init_db.sql:/u01/app/oracle/scripts/startup/init_db.sql //    init_db.sql   .withClasspathResourceMapping("init_db.sql" , "/u01/app/oracle/scripts/startup/init_db.sql" , BindMode.READ_ONLY); container.start(); return container; } } }</span></span></code> </pre> <br><p>  Adem√°s, testcontainers, cuando se inicia, asigna los puertos internos del contenedor a puertos externos desocupados definidos al azar.  Por lo tanto, no puede temer que el contenedor no se levante, porque el puerto ya est√° siendo utilizado por alguien.  Se puede obtener un puerto externo del contenedor utilizando el m√©todo getOraclePort (). </p><br><p>  Tambi√©n puede obtener la direcci√≥n del contenedor utilizando el m√©todo getContainerIpAddress (), pero cualquier contenedor tiene este m√©todo. </p><br><p>  Despu√©s de la primera llamada al m√©todo getContainer, el contenedor no se volver√° a crear, pero se devolver√° el existente.  Este m√©todo ahora se puede usar en Java desnudo o en la configuraci√≥n de Spring para obtener un objeto con un contenedor desde el cual puede extraer los puertos y la direcci√≥n para la conexi√≥n. </p><br><p>  Por ejemplo, puede hacer un inicializador que, al generar el contexto, anular√° los atributos de primavera que son responsables de conectarse a la base de datos. </p><br><h2>  Clase para unir Testcontainers a Spring </h2><br><p>  Despu√©s de levantar el contenedor, el inicializador anula las propiedades responsables de la URL para conectarse a la base de datos, inicio de sesi√≥n, contrase√±a y todo eso. </p><br><p>  Pero, si no hay una configuraci√≥n de evilcorp.testcontainers.enabled en application.properties, el contenedor no se levantar√° y todo funcionar√° como si nadie conectara los contenedores de prueba. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.evilcorp.demo; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.junit.platform.commons.logging.Logger; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.junit.platform.commons.logging.LoggerFactory; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.boot.test.util.TestPropertyValues; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.context.ApplicationContextInitializer; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.context.ConfigurableApplicationContext; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.testcontainers.containers.OracleContainer; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestcontainersInitializer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApplicationContextInitializer</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConfigurableApplicationContext</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Logger log = LoggerFactory.getLogger(TestcontainersInitializer.class); <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initialize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConfigurableApplicationContext applicationContext)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ,   Testcontainers final String testcontainersEnabled = applicationContext.getEnvironment().getProperty("evilcorp.testcontainers.enabled"); if (!"true".equals(testcontainersEnabled)) { return; } OracleContainer oracleContainer = StaticOracleContainer.getContainer(); oracleContainer.followOutput(s -&gt; log.debug(() -&gt; s.getUtf8String())); // IP       //  ,    // (linux, MacOs, Windows  ) , //    oracleContainer.getContainerIpAddress() //    // // Testcontainers     //   ,    oracleContainer.getOraclePort() //  ,         final String jdbcUrl = "jdbc:oracle:thin:@//" + oracleContainer.getContainerIpAddress() + ":" + oracleContainer.getOraclePort() + "/XE"; //      init_db.sql //      final String user = "TEST_USER"; final String password = "passwordnoquotes"; TestPropertyValues.of( "spring.jpa.properties.hibernate.default_schema=" + user, "spring.datasource.driver-class-name=oracle.jdbc.OracleDriver", "spring.jpa.database-platform=org.hibernate.dialect.Oracle10gDialect", "spring.datasource.username=" + user, "spring.datasource.password=" + password, "spring.datasource.url=" + jdbcUrl, "spring.liquibase.url=" + jdbcUrl, "spring.liquibase.user=" + user, "spring.liquibase.password=" + password ).applyTo(applicationContext.getEnvironment(), TestPropertyValues.Type.MAP, "test"); } }</span></span></code> </pre> <br><p>  Esta configuraci√≥n se puede utilizar en la prueba de arranque de primavera para sobrescribir la configuraci√≥n de la base de datos sobre la marcha. </p><br><h2>  Prueba usando Testcontainers </h2><br><p>  La prueba simplemente escribe un objeto en la base de datos y luego lo lee, nada especial. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.evilcorp.demo; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.evilcorp.demo.entity.User; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.junit.jupiter.api.BeforeEach; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.junit.jupiter.api.Test; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.beans.factory.annotation.Autowired; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.boot.test.context.SpringBootTest; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.test.context.ContextConfiguration; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Optional; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> org.junit.jupiter.api.Assertions.assertEquals; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> org.junit.jupiter.api.Assertions.assertNotNull; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> org.junit.jupiter.api.Assertions.assertNotSame; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> org.junit.jupiter.api.Assertions.assertTrue; <span class="hljs-meta"><span class="hljs-meta">@SpringBootTest</span></span> <span class="hljs-meta"><span class="hljs-meta">@ContextConfiguration</span></span>(initializers = {TestcontainersInitializer.class}) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestcontainersSpringDemoApplicationTests</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> UserRepository userRepository; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> User createdUser; <span class="hljs-meta"><span class="hljs-meta">@BeforeEach</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setUp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ createdUser = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User(); createdUser.setName(<span class="hljs-string"><span class="hljs-string">"Fry"</span></span>); userRepository.save(createdUser); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">userRepositoryLoaded</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ assertNotNull(userRepository); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">userAdded</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Optional&lt;User&gt; loadedUser = userRepository.findById(createdUser.getUserId()); assertTrue(loadedUser.isPresent()); assertEquals(<span class="hljs-string"><span class="hljs-string">"Fry"</span></span>, loadedUser.get().getName()); assertNotSame(createdUser, loadedUser.get()); } }</code> </pre> <br><p>  Y s√≠, agregue dependencias a pom.xml </p><br><pre> <code class="xml hljs"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.testcontainers<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>testcontainers<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>1.12.3<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">scope</span></span></span><span class="hljs-tag">&gt;</span></span>test<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">scope</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.testcontainers<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>oracle-xe<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>1.12.3<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">scope</span></span></span><span class="hljs-tag">&gt;</span></span>test<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">scope</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Se trata de c√≥mo puede hacer una imagen acoplable Oracle DBMS y usarla en c√≥digo Java.  Solo queda colocar la imagen en el repositorio corporativo de artefactos y organizar el lanzamiento de las pruebas dentro de otro contenedor acoplable.  Pero esta es una historia completamente diferente. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/480106/">https://habr.com/ru/post/480106/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../480096/index.html">Fin de la infancia: derechos de autor en obras creadas por inteligencia artificial (IA)</a></li>
<li><a href="../480098/index.html">JH Rainwater "C√≥mo pastar gatos": en el otro lado del desarrollo</a></li>
<li><a href="../480100/index.html">Principiantes Sobre SEO</a></li>
<li><a href="../480102/index.html">Resumen de gesti√≥n de productos de noviembre</a></li>
<li><a href="../480104/index.html">9 trucos HTML √∫tiles</a></li>
<li><a href="../480108/index.html">F√≠sica en un proyecto de unidad utilizando la lucha m√≥vil como ejemplo</a></li>
<li><a href="../480110/index.html">uMCPIno: escribir un protocolo simple con entrega garantizada para Arduino</a></li>
<li><a href="../480112/index.html">Diferencias entre C ++ / Visual Basic y Java a nivel general (para principiantes y estudiantes)</a></li>
<li><a href="../480114/index.html">Todo sobre impuestos para trabajadores independientes de TI. IE y aut√≥nomos. Parte 1</a></li>
<li><a href="../480116/index.html">Posici√≥n del Grupo Mail.ru sobre el desarrollo de c√≥digo abierto en Rusia</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>