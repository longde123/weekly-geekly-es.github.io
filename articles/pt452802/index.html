<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üö∂üèæ üîü ü§∏üèº Como conectar um script a um site de terceiros üìû üë®üèæ‚Äçüî¨ üë©üèª‚Äçüî¨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√° Habr! Este √© o primeiro post em nosso blog. Muitas pessoas nos conhecem como um chat para o site, foi com ele que come√ßamos e agora ocupamos posi√ß...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como conectar um script a um site de terceiros</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/jivosite/blog/452802/"> Ol√° Habr!  Este √© o primeiro post em nosso blog.  Muitas pessoas nos conhecem como um chat para o site, foi com ele que come√ßamos e agora ocupamos posi√ß√µes de lideran√ßa no campo dos mensageiros de neg√≥cios.  Gradualmente, evolu√≠mos para uma solu√ß√£o comercial abrangente que oferece muitas oportunidades para os clientes: retorno de chamada, comunica√ß√£o com clientes por meio de mensagens instant√¢neas, redes sociais, aplicativos m√≥veis, PBX virtual, fun√ß√µes de CRM e muito mais. <br><br>  Por v√°rios anos, resolvemos com sucesso muitos problemas t√©cnicos, acumulamos muitas coisas interessantes e, em alguns lugares, uma experi√™ncia √∫nica, √© claro, escrevemos nossas muletas e bicicletas.  Com este post, come√ßamos uma s√©rie de artigos nos quais compartilharemos nossa experi√™ncia no desenvolvimento, constru√ß√£o de processos em uma equipe totalmente remota, falar sobre nossa arquitetura, solu√ß√µes t√©cnicas que nos permitem atender efetivamente centenas de milhares de clientes em todo o mundo. <br><br><img src="https://habrastorage.org/webt/zp/bn/fv/zpbnfvc-9q274ie5wcyhvuo3pma.jpeg" alt="imagem"><br><br>  <b>Jivosite hoje √©:</b> <br><br><ul><li>  250 mil clientes em todo o mundo; </li><li>  150 milh√µes de impress√µes de widgets por dia; </li><li>  3,5 milh√µes de mensagens por dia; </li><li>  10 milh√µes de bate-papos por m√™s; </li><li>  1M conex√µes simult√¢neas; </li><li>  Mais de 250 servidores em produ√ß√£o. </li></ul><br>  Como a maioria das pessoas nos conhece como bate-papo para um site, provavelmente come√ßaremos com ele.  Neste artigo, mostraremos como conectar seu c√≥digo a um site de terceiros e a que voc√™ deve prestar aten√ß√£o como exemplo de nossos muitos anos de experi√™ncia trabalhando com bate-papo.  Este artigo ser√° √∫til para aqueles que est√£o planejando ou j√° est√£o desenvolvendo um servi√ßo de plug-in e simplesmente para todos os interessados ‚Äã‚Äãneste t√≥pico. <br><br><h3>  <font color="#00bf54">Ponto de entrada</font> </h3><br>  O teatro come√ßa com um cabide e o servi√ßo conectado com um c√≥digo de inser√ß√£o.  √â o ponto de entrada para qualquer servi√ßo ou m√≥dulo no site.  Como regra, ele pode ser encontrado nas instru√ß√µes de instala√ß√£o, ap√≥s as quais √© necess√°rio adicion√°-lo ao c√≥digo HTML do site e, em seguida, existe a "m√°gica", que carrega e inicializa o script de uma certa maneira. <br><br><pre><code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://site.com/file.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Parece que seria mais f√°cil conectar o script ao site? <a name="habracut"></a>  Por padr√£o, voc√™ s√≥ precisa adicionar uma tag de script ao c√≥digo HTML da p√°gina.  Mas, de fato, esta √© uma etapa importante, escondendo muitas armadilhas.  Por exemplo, identifica√ß√£o do usu√°rio, implementa√ß√£o de um canal de carregamento de script de backup, personaliza√ß√£o de apar√™ncia ou l√≥gica, velocidade de carregamento da p√°gina e assim por diante.  Mas vamos falar sobre tudo em ordem. <br><br><h3>  <font color="#00bf54">Identifica√ß√£o</font> </h3><br>  S√≥ porque n√£o √© muito interessante algu√©m conectar um script, com certeza o script executa algum tipo de l√≥gica, e essa l√≥gica est√° ligada ao usu√°rio.  Por exemplo, o ID do contador, APP_ID da rede social, no nosso caso, esse √© o ID do canal de comunica√ß√£o criado.  Ou seja, o script deve identificar o usu√°rio em solicita√ß√µes ao servidor.  Para identificar o cliente atrav√©s do c√≥digo de inser√ß√£o, existem tr√™s op√ß√µes de implementa√ß√£o. <br><br>  <b>Op√ß√£o 1</b> <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">async</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://site.com/file.js?id=123"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Passe o ID diretamente no link para o arquivo e, no servidor, de alguma forma, jogue-o no script.  Nesse caso, o servidor precisar√° gravar o ID no arquivo rapidamente ou formar uma string JS com o ID que carregar√° file.js.  Essa l√≥gica √© semelhante √† implementa√ß√£o de solicita√ß√µes JSONP. <br><br><img src="https://habrastorage.org/webt/e-/h5/ks/e-h5ks-gi2mnrck3jwkkogy9trk.png"><br>  Durante muito tempo, trabalhamos com esse princ√≠pio, mas as desvantagens dessa abordagem s√£o que a carga "inativa" no servidor e a necessidade de implementar o cache do servidor s√£o adicionadas. <br><br>  <b>Op√ß√£o # 2</b> <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://site.com/file.js"</span></span></span><span class="hljs-tag"> [</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">async</span></span></span><span class="hljs-tag">]&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">‚Äùtext/javascript‚Äù</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">window</span></span></span><span class="javascript">.serviceNameId = ‚Äú</span><span class="hljs-number"><span class="javascript"><span class="hljs-number">123</span></span></span><span class="javascript">‚Äù; </span><span class="hljs-comment"><span class="javascript"><span class="hljs-comment">// ServiceNameModule.init({id: ‚Äú123‚Äù}); </span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  <i>Atributo ass√≠ncrono - informa ao navegador que n√£o √© necess√°rio aguardar o carregamento do script para criar o DOM, o script deve ser executado imediatamente ap√≥s o carregamento.</i>  <i>Isso reduz o tempo de carregamento da p√°gina, mas tamb√©m h√° um outro lado da moeda: o script pode ser executado antes que o DOM esteja pronto para funcionar.</i> <br><br>  Uma das implementa√ß√µes mais populares, incluindo grandes servi√ßos, faz exatamente isso, apenas a sintaxe √© diferente, mas a ess√™ncia de tudo √© a mesma. <br><br><img src="https://habrastorage.org/webt/ga/9x/as/ga9xasvv7abeeu_f29q-y8zcqze.png"><br>  Essa abordagem tem duas principais desvantagens: a primeira - o c√≥digo de incorpora√ß√£o √© complicado e a segunda - a ordem de execu√ß√£o desse c√≥digo √© muito importante, caso contr√°rio nada funcionar√°.  Al√©m disso, voc√™ precisa escolher entre velocidade (ass√≠ncrona) e estabilidade (sem ass√≠ncrona); a maioria escolhe a segunda op√ß√£o. <br><br>  <b>Op√ß√£o n¬∫ 3</b> <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">async</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://site.com/file.js?id=123"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Da mesma forma que a primeira op√ß√£o, transfira o ID no link para o arquivo, mas recupere-o no navegador e n√£o no servidor.  N√£o √© t√£o simples quanto parece, mas √© poss√≠vel.  A API do navegador possui uma propriedade document.currentScript, retorna um link para um script carregado e atualmente em execu√ß√£o no navegador.  Sabendo disso, √© poss√≠vel calcular o ID; para isso, √© necess√°rio obter a propriedade document.currentScript.src e extrair regularmente o ID dela. <br><br><img src="https://habrastorage.org/webt/p7/mc/jf/p7mcjfln8bnay8g2myb3289vt8y.png"><br>  H√° uma coisa, mas: document.currentScript n√£o √© suportado por todos os navegadores.  Para navegadores que n√£o suportam essa propriedade, criamos um hack interessante.  No c√≥digo file.js, voc√™ pode lan√ßar uma exce√ß√£o "falsa" especial envolvida em try / catch, ap√≥s o qual a URL do script no qual o erro ocorreu na pilha de erros ser√° lan√ßada.  O URL conter√° o ID obtido com a mesma regularidade. <br><br>  Esse tipo de m√°gica √© obtida, mas funciona.  N√£o h√° problemas com a ordem de execu√ß√£o, o c√≥digo de inser√ß√£o parece simples e n√£o h√° sobrecarga no servidor.  Nos √∫ltimos dois anos, temos usado exatamente essa abordagem, embora o c√≥digo de inser√ß√£o em si seja diferente, mas o princ√≠pio seja o mesmo. <br><br><h3>  <font color="#00bf54">Configura√ß√µes</font> </h3><br>  Na maioria dos casos, os scripts de plug-in possuem configura√ß√µes respons√°veis ‚Äã‚Äãpela apar√™ncia ou l√≥gica do trabalho.  Essas configura√ß√µes devem ser "lan√ßadas" no script do plug-in, pois existem duas abordagens fundamentalmente diferentes. <br><br>  <b>Abordagem # 1</b> <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">async</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://site.com/file.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">‚Äùtext/javascript‚Äù</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">window</span></span></span><span class="javascript">.serviceName = {</span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">color</span></span></span><span class="javascript">: ‚Äúred‚Äù, </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">title</span></span></span><span class="javascript">: ‚Äú‚Äù, ...}; </span><span class="hljs-comment"><span class="javascript"><span class="hljs-comment">// ServiceNameModule.init({color: ‚Äúred‚Äù, title: ‚Äú‚Äù, ...}); </span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Essa abordagem tamb√©m inclui passar as configura√ß√µes nos par√¢metros GET para o URL do script, semelhante √† op√ß√£o 1 da se√ß√£o "Identifica√ß√£o".  A abordagem √© que, se o cliente deseja alterar as configura√ß√µes, ele precisa editar o c√≥digo de incorpora√ß√£o e atualiz√°-lo no site. <br><br><img src="https://habrastorage.org/webt/lo/ua/-n/loua-nwuth3l7a0vbilxtu8ilmk.png"><br>  Isso √© bom porque todas as configura√ß√µes s√£o armazenadas no cliente e elas n√£o precisam ser armazenadas no servidor, desenvolvem e mant√™m toda a l√≥gica de neg√≥cios relacionada a isso.  A principal desvantagem dessa abordagem √© o inconveniente para o cliente, ele precisa fazer tudo manualmente e, se houver muitas configura√ß√µes, o c√≥digo de incorpora√ß√£o se tornar√° uma planilha dif√≠cil de manter, na qual √© f√°cil cometer um erro.  E para que as atualiza√ß√µes entrem em vigor, voc√™ precisa atualizar o site, esses s√£o os gestos extras de desenvolvedores e administradores. <br><br>  <b>Abordagem # 2</b> <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">async</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://site.com/file.js?id=123"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  A segunda abordagem √© que, se for necess√°rio alterar as configura√ß√µes, o cliente n√£o precisa modificar o c√≥digo de inser√ß√£o, todas as configura√ß√µes s√£o armazenadas no servidor.  Para alterar as configura√ß√µes, v√° ao painel gr√°fico, altere os par√¢metros necess√°rios e clique no bot√£o "Salvar".  Depois disso, as configura√ß√µes ser√£o aplicadas automaticamente ao site dele! <br><br><img src="https://habrastorage.org/webt/yq/xb/no/yqxbnominbt8r7_sj3ng0mib9wc.png"><br>  N√£o √© necess√°rio entender o c√≥digo e fazer uma implanta√ß√£o para isso. Isso pode ser feito por uma pessoa que est√° longe do JavaScript, por exemplo, um gerente.  Obviamente, essa op√ß√£o √© muito mais conveniente e mais simples para os usu√°rios, e √© por isso que a usamos.  Mas voc√™ precisa pagar por conveni√™ncia, essa abordagem requer o desenvolvimento e o suporte da l√≥gica no servidor e implica uma carga adicional nele.  Nos artigos a seguir, mostraremos definitivamente como processamos 150 milh√µes dessas solicita√ß√µes diariamente. <br><br><h3>  <font color="#00bf54">Compatibilidade com vers√µes anteriores</font> </h3><br>  √â muito importante obter uma vers√£o madura do c√≥digo de incorpora√ß√£o o mais r√°pido poss√≠vel.  Porque a atualiza√ß√£o dos c√≥digos de inser√ß√£o j√° instalados ser√° extremamente dif√≠cil.  Um exemplo de nossa pr√°tica: nas primeiras vers√µes, usamos IDs num√©ricos, mas, por raz√µes de seguran√ßa, os substitu√≠mos por alfanum√©ricos.  Acontece que √© muito dif√≠cil conseguir uma altera√ß√£o no c√≥digo de incorpora√ß√£o j√° instalado.  Muitas pessoas nem sabem o que √© HTML e como os sites s√£o projetados.  Por exemplo, um site foi criado por freelancers, um est√∫dio ou site foi criado por meio de um CMS / construtor, etc. Na maioria dos casos, nossos clientes trabalham apenas com o painel de configura√ß√µes do widget.  Desde ent√£o, ainda temos no nginx um mapa de reescrever IDs antigos para novos, com cerca de 40 mil registros. <br><br><pre> <code class="xml hljs">.... /script/widget/config/15**90 /script/widget/config/bqZB**rjW5; /script/widget/config/15**94 /script/widget/config/qtfx**xnTi; /script/widget/config/15**95 /script/widget/config/fqmpa**4YX; /script/widget/config/15**97 /script/widget/config/Vr21g**nuT; /script/widget/config/15**98 /script/widget/config/8NXL5**F8E; /script/widget/config/15**00 /script/widget/config/Th2HN**6RJ; ....</code> </pre><br>  Devido a esse recurso, somos for√ßados a manter a compatibilidade com vers√µes anteriores do c√≥digo de incorpora√ß√£o para todas as refatora√ß√µes, das quais havia cerca de 5 em nossa mem√≥ria. <br><br><h3>  <font color="#00bf54">Isolamento de c√≥digo</font> </h3><br>  Como o script est√° conectado a um site de terceiros que j√° possui c√≥digo JavaScript e CSS para o site e outros servi√ßos, o objetivo principal n√£o √© prejudicar o site para que nosso c√≥digo n√£o mude a l√≥gica, muito menos quebre.  Pode ser um erro de JavaScript que interrompe o fluxo de execu√ß√£o ou estilos que substituem os estilos de site.  Mas o c√≥digo do site tamb√©m pode afetar o script conectado, por exemplo, √© usada uma biblioteca que modifica a API do navegador, ap√≥s a qual o c√≥digo para de funcionar ou n√£o funciona conforme o esperado. <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="actionscript"><span class="actionscript"> </span><span class="hljs-comment"><span class="actionscript"><span class="hljs-comment">//  mootools.js var JSON = new Hash({ encode: function () {}, decode: function () {} // ... }); //    JSON.parse(json); // Uncaught TypeError: JSON.parse is not a function </span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/css"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"><span class="undefined"> //      body * { padding: 20px; } form input { display: block; border: 2px solid red; } </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><br>  Existem diferentes op√ß√µes para isolar o c√≥digo.  Por exemplo, voc√™ pode usar prefixos em vari√°veis ‚Äã‚ÄãJS, closures, para n√£o entupir o contexto global, usar algo como BEM para estilos.  Mas a maneira mais f√°cil √© executar o c√≥digo em um iframe, pois resolve a maioria dos problemas de isolamento, mas imp√µe certas restri√ß√µes.  N√≥s usamos uma vers√£o h√≠brida, falaremos mais sobre o isolamento de c√≥digo nos seguintes artigos. <br><br><h3>  <font color="#00bf54">Bloquear site de carregamento</font> </h3><br><img src="https://habrastorage.org/webt/1l/wr/du/1lwrdup_ictcih9u7ectyzgwsp4.png"><br><br>  Evento Onload - ocorre depois que a p√°gina da Web √© totalmente carregada, incluindo imagens, estilos e scripts externos.  Um recurso importante √© que, na maioria dos sites, a l√≥gica JS, scripts de terceiros e an√∫ncios come√ßam a trabalhar na ocorr√™ncia deste evento.  Um ponto muito importante para todos os scripts conectados √© evitar um impacto negativo nesse evento. <br><br>  Isso acontece nos casos em que o servidor do qual o script √© carregado responde por um longo per√≠odo ou n√£o responde: o evento onload √© atrasado e o carregamento adicional da p√°gina √© essencialmente bloqueado.  No caso em que o servidor n√£o estiver dispon√≠vel, o evento onload ocorrer√° somente ap√≥s o tempo limite da solicita√ß√£o, que √© superior a 60 s.  Portanto, problemas no servidor de upload de scripts essencialmente "interrompem" os sites, o que √© inaceit√°vel. <br><br>  <b>Experi√™ncia pessoal</b> <br>  No passado, eu trabalhava para uma empresa que tinha um site com 100K on-line simult√¢neo, namoro online.  Naqueles dias, os bot√µes "Compartilhar nas redes sociais" eram populares.  Para eles aparecerem no site, era necess√°rio conectar um script (sdk) a partir das redes sociais desejadas.  Um dia, colegas correram para n√≥s e disseram que nosso site n√£o estava funcionando!  Analisamos o monitoramento, no qual tudo estava normal, e a princ√≠pio n√£o entendemos qual era o problema.  Quando come√ßaram a se aprofundar, perceberam que os servidores cdn do Twitter estavam ca√≠dos e o SDK n√£o podia carregar, isso nos impediu de carregar o site por ~ 1,5 minutos.  Ou seja, depois de abrir o site, um pouco de HTML foi carregado (o restante do SPA) e somente ap√≥s 1,5 minutos tudo foi carregado, o tempo limite da solicita√ß√£o funcionou.  Precisamos organizar urgentemente um hotfix e remover o script deles do site.  Ap√≥s repetir essa situa√ß√£o, decidimos remover o bloco Compartilhar. <br><br>  Nas primeiras vers√µes do c√≥digo de inser√ß√£o, n√£o levamos isso em considera√ß√£o e, no caso de problemas t√©cnicos do nosso lado, para dizer o m√≠nimo, incomodamos nossos clientes, mas com o tempo corrigimos. <br><br>  <b>Solu√ß√£o</b> <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'text/javascript'</span></span></span><span class="hljs-tag">&gt;</span></span><span class="actionscript"><span class="actionscript"> (</span><span class="hljs-function"><span class="hljs-keyword"><span class="actionscript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="hljs-params"><span class="actionscript"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span></span><span class="actionscript">{ </span><span class="hljs-keyword"><span class="actionscript"><span class="hljs-keyword">var</span></span></span><span class="actionscript"> initCode = </span><span class="hljs-function"><span class="hljs-keyword"><span class="actionscript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="actionscript"><span class="hljs-function"> </span></span><span class="hljs-params"><span class="actionscript"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span><span class="actionscript"><span class="hljs-function"> </span></span></span><span class="actionscript">{ </span><span class="hljs-comment"><span class="actionscript"><span class="hljs-comment">// insert script tag }; document.readyState === 'complete' ? initCode() : w.addEventListener('load', initCode, false); })(); </span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  A solu√ß√£o √© simples, voc√™ precisa se inscrever no evento de uma carga completa do site e, em seguida, carregar o script. Para isso, √© necess√°rio usar o c√≥digo de incorpora√ß√£o, e n√£o a tag de script. <br><br><h3>  <font color="#00bf54">Velocidade de p√°gina do Google</font> </h3><br><br><img src="https://habrastorage.org/webt/ur/b9/4t/urb94tbcz9obpytp_da8ed27c8s.png"><br>  <i>An√°lise da vers√£o m√≥vel do habr.com</i> <br><br>  A maioria deles presta aten√ß√£o √† velocidade de carregamento do site, segundo muitos estudos, isso afeta diretamente o lucro, al√©m de algoritmos de busca quando o ranking come√ßou a levar em considera√ß√£o o tempo de carregamento da p√°gina.  Nesse sentido, os propriet√°rios de sites geralmente usam ferramentas semelhantes para avaliar o desempenho do site.  Portanto, √© muito importante conectar o c√≥digo de maneira ideal ao site, pois isso afeta diretamente o tempo de download. <br><br>  Isso significa que voc√™ deve usar t√©cnicas modernas para otimizar o carregamento da p√°gina.  Por exemplo, use Gzip, armazene em cache arquivos e solicita√ß√µes est√°ticas, use carregamento de script ass√≠ncrono, comprima est√°tica com algoritmos modernos, como WebP / Brotli / etc, e use outras otimiza√ß√µes.  Realizamos auditorias regularmente e respondemos a avisos e recomenda√ß√µes para atender aos requisitos atuais. <br><br><h3>  <font color="#00bf54">Cdn</font> </h3><br>  Nas primeiras vers√µes, baixamos est√°tica dos servidores de aplicativos.  Mas essa abordagem tem desvantagens: tr√°fego caro, afastamento dos visitantes do site e carga excessiva no canal do servidor.  Voc√™ pode entupir facilmente o canal dos servidores de aplicativos com o efeito habr dos sites, pois o tr√°fego est√°tico √© muito "pesado". <br><br>  Para economizar or√ßamento, estabilidade e reduzir a lat√™ncia da rede, √© ideal carregar estat√≠sticas de servidores especialmente projetados para essa finalidade.  Voc√™ pode usar provedores de CDN prontos, mas em larga escala n√£o √© barato e precisa ser limitado pelos recursos que esse ou aquele provedor oferece. <br><br><img src="https://habrastorage.org/webt/vi/jy/f3/vijyf3bxfqmihwwfswlfqzxtqie.png"><br><br>  N√≥s o implementamos de forma simples e encomendamos servidores baratos na R√∫ssia, Europa e Am√©rica com tr√°fego ilimitado e um amplo canal.  √â barato, n√£o nos imp√µe restri√ß√µes, podemos personalizar tudo por n√≥s mesmos, e a toler√¢ncia a falhas √© garantida pelo mecanismo que funciona no navegador.  Atualmente, 1 TB de est√°tica √© carregado diariamente de nossos servidores CDN. <br><br><h3>  <font color="#00bf54">Toler√¢ncia a falhas</font> </h3><br>  Infelizmente, o mundo n√£o √© perfeito, inc√™ndios ocorrem, uplinks caem, DCs ficam completamente submersos, o ILV bloqueia sub-redes e as pessoas cometem erros.  No entanto, √© necess√°rio ser capaz de lidar com essas situa√ß√µes e continuar trabalhando. <br><br>  <b>Monitoramento</b> <br>  Primeiro voc√™ precisa entender que algo deu errado.  Obviamente, voc√™ pode esperar at√© que os usu√°rios venham reclamar, mas √© melhor configurar monitoramento e alertas e, ap√≥s os lan√ßamentos, verificar se tudo est√° em ordem.  Monitoramos muitos par√¢metros diferentes, servidor e cliente, e se algo der errado, n√≥s o vemos imediatamente.  Por exemplo, o n√∫mero de downloads de widgets ou um aumento anormal no tr√°fego nos servidores CDN diminuiu. <br><br><img src="https://habrastorage.org/webt/z7/kp/dq/z7kpdqcble85t395hv7z_bqt8fg.png"><br>  <i>O n√∫mero total de downloads de widgets para cada vers√£o</i> <br><br>  <b>Coleta de erro</b> <br>  O JavaScript √© uma linguagem muito espec√≠fica e √© f√°cil cometer um erro.  Al√©m disso, o zool√≥gico de navegadores na web moderna √© muito grande;  o que funciona no Chrome mais recente n√£o √© um fato que funcione no Safari ou Firefox.  Portanto, √© muito importante configurar a coleta de erros no navegador e responder a picos no tempo.  Se o seu c√≥digo funcionar em um iframe, voc√™ poder√° fazer isso rastreando o manipulador global window.onerror e, no caso de um erro, enviar dados para o servidor.  Se o c√≥digo funcionar fora do iframe, ser√° muito dif√≠cil implementar a coleta de erros. <br><br><img src="https://habrastorage.org/webt/g-/d6/jd/g-d6jddyvo9gpslniix1ndyvo1y.png"><br>  <i>O n√∫mero total de erros de todos os sites e navegadores</i> <br><br><img src="https://habrastorage.org/webt/3w/fp/ju/3wfpjuzxcyzpfervxtkq6o_zx10.png"><br>  <i>Informa√ß√µes de erro espec√≠ficas</i> <br><br>  <b>Failover de CDN</b> <br>  Eu j√° escrevi acima que tudo tem a propriedade de cair, por isso √© importante lidar com essas situa√ß√µes e melhor - automaticamente.  Passamos por v√°rios est√°gios do fallback dos servidores CDN, iniciados no manual e, finalmente, encontramos uma maneira de fazer isso de forma autom√°tica e otimizada para o navegador. <br><br>  No modo manual, isso funcionou simplesmente: o SMS recebeu administradores dizendo que a CDN estava inativa, eles executaram certas manipula√ß√µes, ap√≥s o que o widget come√ßou a carregar dos servidores de aplicativos.  Isso pode levar de 5 minutos a 2 horas. <br><br>  Para implementar o fallback autom√°tico, voc√™ precisa detectar de alguma forma que o script come√ßou a carregar, mas isso n√£o √© t√£o f√°cil quanto parece.  O navegador n√£o fornece a capacidade de monitorar estados intermedi√°rios do carregamento da tag de script, como o evento onprogress em XMLHttpRequest, mas relata apenas o evento quando o script √© carregado e executado.  Tamb√©m √© imposs√≠vel por um tempo aceit√°vel descobrir que o servidor est√° indispon√≠vel no momento, o √∫nico evento onerror √© acionado ap√≥s o tempo limite da solicita√ß√£o expirar, mais de 1 minuto.  Em um minuto, o visitante j√° pode sair da p√°gina, mas o script n√£o ser√° carregado. <br><br>  Tentamos op√ß√µes diferentes, simples e complexas, mas, no final, criamos uma solicita√ß√£o de ping para um servidor CDN.  Funciona assim: primeiro fazemos ping no servidor CDN, se ele respondeu, depois carregamos o widget a partir dele.  Para implementar esse esquema de maneira otimizada para o navegador e nossos servidores, usamos uma solicita√ß√£o HEAD leve (sem um corpo) e, para downloads subsequentes, n√£o o fazemos at√© que a vers√£o do widget seja atualizada, porque o widget j√° est√° no cache do navegador. <br><br><img src="https://habrastorage.org/webt/r-/zf/gh/r-zfghwbzyarwvybwbdkbaaz5py.png"><br>  Assim, recebemos uma detec√ß√£o muito r√°pida e autom√°tica da disponibilidade do servidor est√°tico e, no caso de uma queda, passamos para o servidor de backup quase sem demora. <br><br><h3>  <font color="#00bf54">Carregador</font> </h3><br>  Para fazer upload do seu script para um site de terceiros, √© necess√°rio levar em considera√ß√£o muitos pontos, mas √© dif√≠cil implementar essa l√≥gica no c√≥digo de incorpora√ß√£o, pois ele simplesmente se transforma em "carne".  Mas voc√™ ainda precisa fazer isso, para isso criamos um pequeno m√≥dulo que gerencia toda essa l√≥gica "por baixo do cap√¥" e carrega o c√≥digo principal do widget.  Ele carrega primeiro e implementa CDN Failover, armazenamento em cache, compatibilidade com c√≥digos antigos incorporados, testes A / B, o layout gradual da nova vers√£o do widget e muitas outras fun√ß√µes. <br><br><img src="https://habrastorage.org/webt/-e/pj/-j/-epj-jpym6xcdxu9bk7axxtmtsa.png"><br>  Assim, em etapas, chegamos a um esquema que abrange os principais casos de carregamento e inicializa√ß√£o do widget.  Ela provou sua efic√°cia ao longo dos anos de uso em um grande n√∫mero de sites diferentes.  Ao mesmo tempo, o c√≥digo de inser√ß√£o permanece simples e universal, pois n√£o h√° l√≥gica nele e podemos alter√°-lo a qualquer momento, sem for√ßar os usu√°rios a alterar o c√≥digo de inser√ß√£o. <br><br><h3>  <font color="#00bf54">Servi√ßos de Terceiros</font> </h3><br>  E, finalmente, vale a pena mencionar servi√ßos de terceiros que se conectam ao site ou de alguma forma interagem com sites: bots de pesquisa, an√°lises, v√°rios analisadores e assim por diante.  Esses servi√ßos deixam uma marca no trabalho; voc√™ tamb√©m n√£o deve esquecer isso.  Vou contar alguns casos de nossa pr√°tica. <br><br>  <b>Googlebot</b> <br>  O aplicativo de nossa operadora possui a fun√ß√£o "Visitantes", na qual √© poss√≠vel ver os visitantes que est√£o visualizando o site no momento, e v√°rias informa√ß√µes sobre eles: hor√°rio no site, p√°gina, n√∫mero de p√°ginas visualizadas etc.  Em algum momento, os clientes come√ßaram a reclamar que estavam "pendurando" visitantes de outros sites, ou seja, no site que vende iPhones, um cliente que supostamente tinha uma p√°gina chamada "Comprar creme para o rosto".  Quando eles come√ßaram a descobrir, era o GoogleBot, que, ao mudar de site para site, armazenava em cache primeiro o LocalStorage e posteriormente transferia dados incorretos para o servidor. <br><br>  A solu√ß√£o √© simples, o servidor come√ßou a ignorar dados do GoogleBot. <br><br>  <b>Yandex.Metrica</b> <br>  H√° um recurso maravilhoso na m√©trica - um navegador da web, que permite ver o que o usu√°rio viu e fez na forma de screencast.  Para fazer isso, a m√©trica registra todas as a√ß√µes do usu√°rio e, ap√≥s um bot de m√©trica especial percorrer os sites, executa as mesmas a√ß√µes e registra isso.  O problema era que, para simular o navegador m√≥vel do usu√°rio, de acordo com nossos dados, o Firefox estava ativado no modo de emula√ß√£o m√≥vel, mas o userAgent no bot era de desktop. <br><br>  Isso levou ao fato de que, ao visualizar sess√µes de usu√°rios m√≥veis no navegador da web, a vers√£o para desktop do widget foi aberta nas grava√ß√µes, embora, na verdade, os usu√°rios tenham aberto a vers√£o m√≥vel.  Nossos clientes pensaram que sim e nos bombardearam com reclama√ß√µes.     ,     , ,      ,        . <br><br>   , , ,      . <br><br><h3> <font color="#00bf54"></font> </h3><br>      ,        .   ,         .                , ,    NodeJS   ,     270         -    ,         . <br><br>   ,        ! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt452802/">https://habr.com/ru/post/pt452802/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt452792/index.html">An√°lise de SSD de estado s√≥lido para usu√°rios corporativos Kingston DC500R</a></li>
<li><a href="../pt452794/index.html">Sobre localiza√ß√£o de produtos. Parte um: por onde come√ßar?</a></li>
<li><a href="../pt452796/index.html">Convidamos voc√™ para a reuni√£o do departamento de desenvolvimento de jogos da GeekUniversity</a></li>
<li><a href="../pt452798/index.html">Armazenamento e classifica√ß√£o autom√°tica de fotos e outros arquivos. Trabalhar com armazenamento de arquivos baseado no NAS Synology</a></li>
<li><a href="../pt452800/index.html">Microbiota. Como as bact√©rias intestinais afetam a doen√ßa</a></li>
<li><a href="../pt452804/index.html">Sa√≠ do emprego dos meus sonhos porque n√£o suporto o desenvolvimento de produtos</a></li>
<li><a href="../pt452806/index.html">Entrevista - 10 perguntas sobre Swift. Parte 2</a></li>
<li><a href="../pt452808/index.html">Gerenciamento de uma equipe de programadores: como e como motiv√°-los corretamente? Parte dois</a></li>
<li><a href="../pt452812/index.html">Recebi um cheque de 0x $ 3,00 de Knut</a></li>
<li><a href="../pt452816/index.html">O que acontecer√° em 1¬∫ de fevereiro de 2020?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>