<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üõ§Ô∏è ‚úùÔ∏è üë©üèΩ‚Äçü§ù‚Äçüë©üèª Creando un juego para Game Boy üìö üè© üéÅ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hace unas semanas, decid√≠ trabajar en un juego para Game Boy, cuya creaci√≥n me dio un gran placer. Su nombre de trabajo es Aqua and Ashes. El juego ti...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Creando un juego para Game Boy</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/436330/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/913/597/052/91359705210df58524bc0e6c9e9955a8.png" alt="imagen"></div><br>  Hace unas semanas, decid√≠ trabajar en un juego para Game Boy, cuya creaci√≥n me dio un gran placer.  Su nombre de trabajo es Aqua and Ashes.  El juego tiene c√≥digo abierto y est√° publicado en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">GitHub</a> . <br><br><h2>  ¬øC√≥mo se me ocurri√≥ esta idea? </h2><br>  Recientemente obtuve un trabajo de pasant√≠a creando un backend en PHP y Python para el sitio web de mi universidad.  Este es un trabajo bueno e interesante, por lo que estoy muy agradecido.  Pero ... al mismo tiempo, todo este c√≥digo de desarrollo web de alto nivel me ha infectado con un deseo insaciable.  Y era el deseo de trabajo de bajo nivel con brocas. <br><br>  Recib√≠ un resumen semanal de itch.io sobre jams de juegos, en el que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">se</a> anunci√≥ el lanzamiento de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Mini Jam 4</a> .  Fue un atasco de 48 horas (bueno, en realidad un poco m√°s grande), en el que la limitaci√≥n era crear gr√°ficos al estilo de Game Boy.  Mi primera reacci√≥n l√≥gica fue crear un juego casero para Game Boy.  El tema de la mermelada fue "estaciones" y "llama". <br><br>  Despu√©s de pensar un poco en la trama y la mec√°nica que se pueden implementar en 48 horas y encajar en las limitaciones del tema, se me ocurri√≥ un <s>clon de una</s> nueva interpretaci√≥n del nivel del juego SNES de 1993 Tiny Toon Adventures: Buster Busts Loose!, En el que el jugador en el papel de Baster juega f√∫tbol americano . <br><a name="habracut"></a><br><iframe width="560" height="315" src="https://www.youtube.com/embed/XmyJZkJ-zeA" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Siempre me gust√≥ c√≥mo los creadores de este nivel tomaron un deporte incre√≠blemente complejo, se deshicieron de todos los trucos, posiciones y elementos estrat√©gicos, como resultado de obtener un juego extremadamente interesante y f√°cil.  Obviamente, una visi√≥n tan simplificada del f√∫tbol americano no reemplazar√° a Madden, al igual que NBA Jam (una idea similar: solo 4 jugadores en un campo mucho m√°s peque√±o con un juego m√°s directo que en un juego normal) no reemplazar√° a la serie 2K.  Pero esta idea tiene cierto encanto, y las cifras de ventas de NBA Jam lo confirman. <br><br>  ¬øC√≥mo se relaciona todo esto con mi idea?  Decid√≠ tomar este nivel de f√∫tbol y rehacerlo para que siga siendo similar al original y al mismo tiempo est√© fresco.  En primer lugar, reduje el juego a solo cuatro jugadores: un defensor y un atacante.  Esto se hizo principalmente debido a las limitaciones del hardware, pero al mismo tiempo me permitir√° experimentar un poco con una IA m√°s inteligente, no se limita al principio de "correr hacia la izquierda y, a veces, saltar" de jugar en SNES. <br><br>  En aras de la conformidad con el tema, reemplazar√© las puertas con columnas encendidas, o con hogueras, o con algo as√≠ (a√∫n no lo he decidido), y un bal√≥n de f√∫tbol con antorchas y cubos de agua.  El ganador ser√° el equipo que controla ambas hogueras, y en torno a este concepto simple, f√°cilmente puede llegar a una trama.  Las estaciones tambi√©n se tienen en cuenta: decid√≠ que las estaciones cambiar√°n cada turno, para que el equipo de bomberos obtenga una ventaja en el verano y el equipo de bomberos en el invierno.  Esta ventaja parece obst√°culos en el campo que interfieren solo con el equipo contrario. <br><br>  Por supuesto, al crear dos equipos, se necesitaban dos animales que amaran y no les gustara el fuego.  Al principio pens√© en hormigas de fuego y algunas chinches de agua, mantis religiosa y similares, pero despu√©s de estudiar el tema, no encontr√© ning√∫n insecto activo en invierno, as√≠ que los reemplac√© con zorros polares y gecos.  A los zorros polares les gusta la nieve, a los geckos les gusta tumbarse al sol, por lo que todo parece l√≥gico.  Al final, es solo un juego para Game Boy. <br><br>  Adem√°s, en caso de que esto a√∫n no est√© claro, al final del atasco el juego no estaba cerca de completarse.  De todos modos, fue divertido de todos modos. <br><br><h2>  Game Boy Training </h2><br>  Primero debes determinar los requisitos.  Decid√≠ escribir para DMG (nombre interno para el modelo Game Boy, abreviatura de Dot Matrix Game).  Principalmente para cumplir con los requisitos de un atasco de juego, pero tambi√©n porque realmente quer√≠a hacerlo.  Personalmente, nunca he tenido juegos para DMG (aunque hay varios juegos para Game Boy Color), pero considero que la est√©tica de 2 bits es una limitaci√≥n muy agradable e interesante para los experimentos.  Quiz√°s agregue color adicional para SGB y CGB, pero hasta ahora no he pensado en ello. <br><br>  Tambi√©n decid√≠ usar un cartucho con 32K ROM + sin RAM, en caso de que quiera crear una copia f√≠sica del juego.  CatSkull, que ha publicado varios juegos de Game Boy, como Sheep it Up !, tiene <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">a la venta cartuchos flash de 32 kilobytes muy baratos</a> que son perfectos para m√≠.  Esta es otra limitaci√≥n adicional, pero no creo que en un futuro cercano pueda superar el volumen de 32K con un juego tan simple.  Lo m√°s dif√≠cil ser√° con los gr√°ficos, y si todo est√° completamente mal, intentar√© comprimirlo. <br><br>  En cuanto al trabajo de Game Boy, entonces todo es bastante complicado.  Sin embargo, para ser honesto, de todas las consolas retro con las que tuve que trabajar, Game Boy fue la m√°s agradable.  Comenc√© con un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">excelente tutorial</a> (al menos por primera vez, porque nunca fue completado) por el autor de AssemblyDigest.  Sab√≠a que lo mejor es escribir en ASM, por m√°s doloroso que sea a veces, porque el hardware no est√° dise√±ado para C, y no estaba seguro de que el lenguaje genial que Wiz mencion√≥ en el tutorial ser√≠a adecuado a largo plazo.  Adem√°s, hago esto principalmente porque <em>puedo</em> trabajar con ASM. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Comprueba el commit 8c0a4ea</a> <br><br>  Lo primero que deb√≠a hacer era arrancar el Game Boy.  Si el logotipo de Nintendo no se encuentra en un desplazamiento de <code>$104</code> , y el resto del encabezado no est√° configurado correctamente, entonces el equipo de Game Boy asumir√° que el cartucho est√° insertado incorrectamente y se negar√° a cargar.  Resolver este problema es muy simple, porque ya se han escrito muchos tutoriales sobre esto.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">As√≠ es como resolv√≠ el problema del encabezado.</a>  No hay nada que merezca especial atenci√≥n. <br><br>  Ser√° m√°s dif√≠cil realizar acciones significativas despu√©s de la carga.  Es muy simple hacer que el sistema entre en un ciclo ocupado infinito en el que ejecuta una l√≠nea de c√≥digo una y otra vez.  La ejecuci√≥n del c√≥digo comienza con la etiqueta <code>main</code> (donde indica el salto a la direcci√≥n <code>$100</code> ), por lo que debe insertar un c√≥digo simple all√≠.  Por ejemplo: <br><br><pre> <code class="hljs pgsql">main: .<span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>: halt jr .<span class="hljs-keyword"><span class="hljs-keyword">loop</span></span></code> </pre> <br>  y no hace absolutamente nada m√°s que esperar a que comience la interrupci√≥n, despu√©s de lo cual vuelve a la etiqueta <code>.loop</code> .  (En lo sucesivo, omitir√© una descripci√≥n detallada de ASM. Si se confunde, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">consulte la documentaci√≥n del ensamblador que uso</a> ). Puede que tenga curiosidad por qu√© no vuelvo a la etiqueta <code>main</code> .  Esto se debe a que quiero que todo antes de la etiqueta <code>.loop</code> sea ‚Äã‚Äãla inicializaci√≥n del programa, y ‚Äã‚Äãtodo despu√©s de que ocurra cada fotograma.  Por lo tanto, no tengo que pasar por alto el ciclo de carga de datos del cartucho y borrar la memoria en cada cuadro. <br><br>  Vamos a dar un paso m√°s.  El paquete ensamblador RGBDS que uso contiene un convertidor de im√°genes.  Como en esta etapa a√∫n no he dibujado ning√∫n recurso para el juego, decid√≠ usar el bot√≥n monocromo de mi p√°gina Acerca de como mapa de bits de prueba.  Usando RGBGFX, lo convert√≠ al formato Game Boy y us√© el comando ensamblador .incbin para insertarlo despu√©s de la funci√≥n <code>main</code> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/26e/1d4/8b2/26e1d48b29e761edb6df6c6a3a3d035b.png" alt="imagen"></div><br>  Para mostrarlo en la pantalla, necesito lo siguiente: <br><br><ol><li>  LCD apagado </li><li>  Establecer paleta </li><li>  Establecer posici√≥n de desplazamiento </li><li>  Borrar memoria de video (VRAM) </li><li>  Cargue gr√°ficos de mosaico en VRAM </li><li>  Descargar el mapa de fondo del mosaico VRAM </li><li>  Encienda la pantalla LCD nuevamente </li></ol><br><h3>  LCD apagado </h3><br>  Para los principiantes, este se convierte en el obst√°culo m√°s serio.  En el primer Game Boy, es imposible simplemente escribir datos en VRAM en cualquier momento.  Es necesario esperar el momento en que el sistema no dibuja nada.  Imitando el brillo del f√≥sforo en televisores CRT viejos, el intervalo entre cada cuadro cuando VRAM est√° abierto se llama Vertical-Blank, o VBlank (en CRT es un impulso para dejar en blanco el haz del kinescopio durante una exploraci√≥n inversa).  (Tambi√©n hay HBlank entre cada l√≠nea de la pantalla, pero es muy corto). Sin embargo, podemos solucionar este problema apagando la pantalla LCD, es decir, podemos grabar en VRAM independientemente de d√≥nde se encuentre el "rastro de f√≥sforo" de la pantalla CRT. <br><br>  Si est√° confundido, entonces <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">esta revisi√≥n deber√≠a explicarle mucho</a> .  En √©l, la pregunta se considera desde el punto de vista de SNES, as√≠ que no olvide que no hay haz de electrones y que los n√∫meros son diferentes, pero en todo lo dem√°s es bastante aplicable.  Esencialmente, necesitamos establecer la bandera FBlank. <br><br>  Sin embargo, el truco de Game Boy es que solo puedes apagar la pantalla LCD durante VBlank.  Es decir, tenemos que esperar a VBlank.  Para hacer esto, usa interrupciones.  Las interrupciones son se√±ales de que Game Boy env√≠a hardware a la CPU.  Si el controlador de interrupci√≥n est√° configurado, el procesador detiene su trabajo y llama al controlador.  Game Boy admite cinco interrupciones, y una de ellas comienza cuando comienza VBlank. <br><br>  Las interrupciones se pueden manejar de dos maneras diferentes.  La primera y m√°s com√∫n es la tarea de <em>un controlador de interrupciones</em> que funciona como expliqu√© anteriormente.  Sin embargo, podemos habilitar una interrupci√≥n espec√≠fica y deshabilitar todos los controladores configurando el indicador de habilitaci√≥n para esta interrupci√≥n y usando el c√≥digo <code>di</code> operaci√≥n.  Por lo general, no hace nada, pero tiene el efecto secundario de salir del c√≥digo de operaci√≥n HALT, que detiene la CPU antes de que ocurra una interrupci√≥n.  (Esto tambi√©n sucede cuando los controladores est√°n activados, lo que nos permite salir del ciclo HALT en <code>main</code> ). En caso de que est√© interesado, tambi√©n crearemos un controlador VBlank con el tiempo, pero mucho depender√° de ciertos valores en ciertas direcciones.  Como hasta ahora no se ha configurado nada en la RAM, un intento de llamar al controlador VBlank puede provocar un bloqueo del sistema. <br><br>  Para establecer los valores, necesitamos enviar comandos a los registros de hardware de Game Boy.  Hay direcciones de memoria especiales que est√°n directamente relacionadas con varias partes del equipo, en nuestro caso, la CPU, que le permite cambiar la forma en que funciona.  Estamos particularmente interesados ‚Äã‚Äãen las direcciones <code>$FFFF</code> (campo de bit de activaci√≥n de interrupci√≥n), <code>$FF0F</code> (campo de bit de interrupci√≥n activado pero no controlado) y <code>$FF40</code> (control LCD).  Puede encontrar una lista de estos registros <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">en las p√°ginas</a> asociadas con la secci√≥n "Documentaci√≥n" de la lista Awesome Game Boy Development. <br><br>  Para apagar la pantalla LCD, activamos solo la interrupci√≥n VBlank, asignando a <code>$FFFF</code> valor <code>$01</code> , realizamos HALT hasta que se cumpla la condici√≥n <code>$FF0F == $01</code> , y luego asignamos el bit 7 de la direcci√≥n <code>$FF40</code> a 0. <br><br><h3>  Establecer la paleta y la posici√≥n de desplazamiento </h3><br>  Esto es f√°cil de hacer.  Ahora que la pantalla LCD est√° apagada, no tenemos que preocuparnos por VBlank.  Para establecer la posici√≥n de desplazamiento, es suficiente establecer los registros X e Y en 0. Con la paleta, todo es un poco m√°s complicado.  En Game Boy, puede asignar sombras del primer al cuarto gr√°fico de cualquiera de las 4 sombras de gris (o verde pantano, si lo desea), lo cual es √∫til para realizar transiciones y similares.  Establec√≠ un gradiente simple como una paleta, definida como una lista de bits <code>%11100100</code> . <br><br><h3>  Borrar VRAM y cargar gr√°ficos de mosaico </h3><br>  Cuando se inicie, todos los datos gr√°ficos y el mapa de fondo consistir√°n solo en un logotipo de Nintendo desplazable, que se muestra cuando se inicia el sistema.  Si enciendo sprites (est√°n deshabilitados por defecto), ser√°n basura diseminada por la pantalla.  Debe borrar la memoria de video para comenzar desde cero. <br><br>  Para hacer esto, necesito una funci√≥n como <code>memset</code> de C. (Tambi√©n necesito una <code>memcpy</code> anal√≥gica para copiar los datos gr√°ficos). La funci√≥n <code>memset</code> establece el fragmento de memoria especificado en un determinado byte.  Ser√° f√°cil para m√≠ implementar esto yo mismo, pero el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">tutorial de AssemblyDigest</a> ya tiene estas funciones, as√≠ que las uso. <br><br>  En este punto, puedo borrar VRAM con <code>memset</code> escribiendo <code>$00</code> (aunque la primera confirmaci√≥n us√≥ el valor <code>$FF</code> , que tambi√©n era adecuado), y luego cargar los gr√°ficos de mosaico en VRAM usando <code>memcpy</code> .  M√°s espec√≠ficamente, necesito copiarlo a la direcci√≥n <code>$9000</code> , porque estos son mosaicos utilizados solo para gr√°ficos de fondo.  (Las direcciones <code>$8000-$87FF</code> se usan solo para fichas de sprite, y las direcciones <code>$8800-$8FFF</code> son comunes para ambos tipos). <br><br><h3>  Configuraci√≥n del mapa de mosaico </h3><br>  Game Boy tiene una capa de fondo, dividida en 8x8 mosaicos.  La capa de fondo en s√≠ toma aproximadamente 32x32 mosaicos, es decir, tiene un tama√±o total de 256x256.  (A modo de comparaci√≥n: la pantalla de la consola tiene una resoluci√≥n de 160x144.) Necesitaba indicar manualmente los mosaicos que componen mi imagen l√≠nea por l√≠nea.  Afortunadamente, todos los mosaicos se organizaron en orden, por lo que solo tuve que llenar cada l√≠nea con valores de <code>N*11</code> a <code>N*11 + 10</code> , donde <code>N</code> es el n√∫mero de l√≠nea y los 22 elementos restantes completan <code>$FF</code> . <br><br><h3>  Encendido de la pantalla LCD </h3><br>  Aqu√≠ no necesitamos esperar a VBlank, porque la pantalla todav√≠a no se encender√° hasta VBlank, por lo que acabo de escribir nuevamente en el registro de control LCD.  Tambi√©n inclu√≠ capas de fondo y sprites, y tambi√©n indiqu√© las direcciones correctas del mapa de mosaico y los gr√°ficos de mosaico.  Despu√©s de eso obtuve los siguientes resultados.  Tambi√©n encend√≠ los manejadores de interrupciones nuevamente usando el <code>ei</code> opcode. <br><br>  En este punto, para hacerlo a√∫n m√°s interesante, escrib√≠ un manejador de interrupciones muy simple para VBlank.  Al agregar el c√≥digo de operaci√≥n de transici√≥n a <code>$40</code> , puedo hacer que el controlador tenga cualquier funci√≥n que necesite.  En este caso, escrib√≠ una funci√≥n simple que desplaza la pantalla hacia arriba y hacia abajo. <br><br>  Aqu√≠ est√°n los resultados finales.  [Adici√≥n: me acabo de dar cuenta de que el GIF no est√° colocado correctamente, debe transferir constantemente la imagen.] <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fd0/c84/9db/fd0c849dbe3bc68910d186b1ef014c66.gif"></div><br>  Hasta ahora, nada particularmente sorprendente, pero sigue siendo genial que, en teor√≠a, pueda obtener mi viejo Game Boy Color y ver c√≥mo se ejecuta mi propio c√≥digo. <br><br><h2>  Diversi√≥n con s√°banas a cuadros </h2><br>  Para dibujar algo en la pantalla, naturalmente necesito alg√∫n tipo de sprite.  Despu√©s de estudiar la PPU (Picture Processing Unit) de la consola Game Boy, decid√≠ centrarme en sprites 8x8 u 8x16.  Probablemente, necesitar√© la √∫ltima opci√≥n, pero solo para sentir el tama√±o, r√°pidamente garabate√© una captura de pantalla del juego en una escala de 1: 8 en papel a cuadros. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/887/b5b/ece/887b5becec39b13f2fd167e9436c63e5.jpg"></div><br>  Quer√≠a dejar la parte superior de la pantalla debajo del HUD.  Me pareci√≥ que se ver√≠a m√°s natural que desde abajo, porque cuando est√° arriba, si los personajes necesitan bloquear temporalmente el HUD, como en Super Mario Bros, pueden hacerlo.  Este juego no tendr√° plataformas complejas, y de hecho el dise√±o del nivel, as√≠ que no necesito mostrar una visi√≥n muy general del campo.  La posici√≥n de los personajes en la pantalla y, posiblemente, los obst√°culos que aparecen de vez en cuando ser√°n suficientes.  Por lo tanto, puedo permitirme sprites bastante grandes. <br><br>  Entonces, si un cuadrado era un mosaico de 8x8, entonces un sprite <em>no</em> ser√° suficiente, sin importar el tama√±o que elija.  Esto es especialmente cierto dado que casi no habr√° movimiento vertical en el juego, con la excepci√≥n de los saltos.  Entonces decid√≠ crear sprites a partir de cuatro sprites de 8x16.  La excepci√≥n fue la cola del zorro, que ocupa dos sprites de 8x16.  Despu√©s de c√°lculos simples, qued√≥ claro que dos zorros y dos geckos ocupar√°n 20 de los 40 sprites, es decir, ser√° posible agregar muchos m√°s sprites adicionales.  (Los sprites 8x8 se quedar√≠an r√°pidamente fuera de mi l√≠mite, lo que no quiero hacer en las primeras etapas de desarrollo). <br><br>  Por ahora, solo necesito dibujar sprites.  A continuaci√≥n hay bocetos en papel a cuadros.  Tengo un sprite en espera, un sprite "pensante" para elegir si pasar o correr, como en un juego de SNES ... y eso es todo.  Tambi√©n plane√© hacer sprites de personajes corriendo, saltando personajes y personajes que agarran los oponentes.  Pero para empezar, dibujaba solo sprites que esperaban y pensaban, para no complicarme.  Todav√≠a no hice el resto, necesito hacer esto. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/623/20c/124/62320c12434cacf0c0ca06a2aad33fae.jpg"></div><br>  S√≠, lo s√©, no dibujo muy bien.  La perspectiva es algo complicado.  (S√≠, y esta cara del zorro polar es terrible). Pero me queda perfectamente.  El dise√±o de personajes no tiene caracter√≠sticas especiales, pero es adecuado para el juego jam.  Por supuesto, us√© geckos reales y zorros polares como referencias.  ¬øEs imperceptible? <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1fe/b2e/936/1feb2e936415aeceaf8cd35596d7e55d.jpg"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/215/cc8/568/215cc856884bb518df111799d6e10a87.jpg"></div><br>  No puedes decirlo.  (Para el registro: despu√©s de haber visto estas im√°genes nuevamente, me di cuenta de que hay una gran diferencia entre geckos y lagartos. No s√© qu√© hacer con esto, excepto para considerarme est√∫pido ...) Creo que puedes adivinar que es la fuente de inspiraci√≥n para Blaze the Cat de la serie de juegos de Sonic sirvi√≥ como la cabeza del zorro. <br><br>  Inicialmente, quer√≠a que los defensores y delanteros en cada equipo fueran de diferentes sexos y era m√°s f√°cil distinguirlos.  (Tambi√©n iba a dejar que los jugadores elijan el g√©nero de su personaje). Sin embargo, esto requerir√≠a mucho m√°s dibujo.  As√≠ que me decid√≠ por gecos machos y zorros hembras. <br><br>  Y finalmente, dibuj√© una pantalla de bienvenida porque hab√≠a un lugar para ello en un pedazo de papel a cuadros. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c67/5ac/30a/c675ac30af04025014da7eee842d285d.jpg"></div><br>  S√≠, las poses de acci√≥n a√∫n est√°n lejos de ser ideales.  El zorro polar deber√≠a estar m√°s molesto y corriendo, y el gecko deber√≠a verse amenazador.  Defender Fox en el fondo: una divertida referencia al arte en el cuadro Doom. <br><br><h2>  Digitalizaci√≥n de sprites. </h2><br>  Entonces comenc√© a convertir dibujos de papel en sprites.  Para esto, utilic√© el programa GraphicsGale, que recientemente se hizo gratuito.  (S√© que podr√≠as usar asesprite, pero prefiero GraphicsGale). El trabajo en sprites result√≥ ser mucho m√°s complicado de lo que esperaba.  Cada uno de estos cuadrados de los sprites que se muestran arriba ocupa hasta 4 p√≠xeles en una cuadr√≠cula de 2x2.  Y estos cuadrados a menudo ten√≠an MUCHO m√°s detalles que 4 p√≠xeles.  Por lo tanto, tuve que deshacerme de muchos detalles de los bocetos.  A veces incluso era dif√≠cil adherirse a una forma simple, porque era necesario dejar un lugar aceptable para los ojos o la nariz.  Pero me parece que todo se ve bien, incluso si el sprite se ha vuelto completamente diferente. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/39f/789/d16/39f789d16e3c10c85fa4f0613a0cf571.png"></div><br>  Los ojos del zorro perdieron su forma almendrada y se convirtieron en una l√≠nea de dos p√≠xeles de altura.  Los ojos del gecko han conservado su redondez.  La cabeza del gecko tuvo que agrandarse, deshaci√©ndose de los hombros anchos, y todas las curvas que el zorro podr√≠a haber tenido se suavizaron significativamente.  Pero, sinceramente, todos estos cambios f√°ciles no son tan malos.  A veces casi no puedo elegir cu√°l de las variaciones es mejor. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a52/32f/d71/a5232fd71193a02dfaebdc2c043edbe5.png"></div><br>  GraphicsGale tambi√©n tiene funciones convenientes para capas y animaciones.  Esto significa que puedo animar la cola del zorro por separado de su cuerpo.  Esto ayuda mucho a ahorrar un valioso espacio VRAM porque no necesito duplicar la cola en cada cuadro.  Adem√°s, esto significaba que pod√≠as mover la cola con una velocidad variable, disminuyendo la velocidad cuando el personaje est√° de pie y acelerando mientras corres.  Sin embargo, esto hace que la programaci√≥n sea un poco m√°s complicada.  Pero a√∫n as√≠ voy a asumir esta tarea.  Me decid√≠ por 4 cuadros de animaci√≥n, porque esto es suficiente. <br><br>  Puede notar que el zorro polar usa los tres tonos m√°s claros de gris, mientras que el gecko usa los tres tonos m√°s oscuros de gris.  En GameBoy, esto es aceptable, porque aunque solo puede haber tres colores en un sprite, la consola le permite especificar dos paletas.  Lo hice para que la paleta 0 se use para los zorros, y la paleta 1 para los geckos. Eso es todo el conjunto de paletas disponible, pero no creo que necesite otros. <br><br>  Tambi√©n necesitaba cuidar el fondo.  No me molest√© con sus bocetos, porque plane√© que ser√≠a un color s√≥lido o un patr√≥n geom√©trico simple.  Todav√≠a no he digitalizado el protector de pantalla, porque no tuve suficiente tiempo. <br><br><h2>  Cargando sprites en el juego </h2><br>  Verifique con el compromiso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">be99d97</a> . <br><br>  Despu√©s de guardar cada cuadro individual de gr√°ficos de personajes, fue posible comenzar a convertirlos al formato GameBoy.  Result√≥ que en RGBDS hay una utilidad muy conveniente para esto llamada RGBGFX.  Puede llamarlo con el comando <code>rgbgfx -h -o output.bin input.png</code> y crear√° un conjunto de mosaicos compatibles con GameBoy.  (El modificador -h especifica un modo de mosaico compatible con 8x16 para que la conversi√≥n se realice de arriba a abajo y no de izquierda a derecha). Sin embargo, no proporciona enlaces y no puede rastrear mosaicos duplicados cuando cada cuadro es una imagen separada.  Pero dejaremos este problema para m√°s adelante. <br><br>  Despu√©s de generar los archivos .bin de salida, simplemente agr√©guelos en ensamblador usando <code>incbin "output.bin"</code> .  Para mantener todo junto, cre√© un archivo com√∫n "gfxinclude.z80", que contiene todos los gr√°ficos que se agregar√°n. <br><br>  Sin embargo, fue muy aburrido regenerar manualmente los gr√°ficos cada vez que algo cambiaba.  As√≠ que edit√© el archivo build.bat, agregando la l√≠nea <code>for %%f in (gfx/*.png) do rgbds\rgbgfx -h -o gfx/bin/%%f.bin gfx/%%f</code> , que convierte cada archivo. png en la carpeta gfx / en el archivo bin y lo guarda en gfx / bin.  Me simplific√≥ mucho la vida. <br><br>  Para crear gr√°ficos de fondo, utilic√© una forma <em>mucho</em> m√°s perezosa.  RGBASM tiene una directiva <code>dw `</code> .  Le sigue una l√≠nea de 8 valores de 0 a 4 igual a una l√≠nea de datos de p√≠xeles.  Como los sprites de fondo eran muy simples, result√≥ m√°s f√°cil copiar y pegar un patr√≥n geom√©trico simple para crear un patr√≥n s√≥lido, rayado o de tablero de ajedrez.  Aqu√≠, por ejemplo, parece una baldosa terrestre. <br><br><pre> <code class="hljs powershell">bg_dirt: dw `00110011 dw `00000000 dw `01100110 dw `00000000 dw `11001100 dw `00000000 dw `10011001 dw `00000000</code> </pre> <br>  Crea una serie de rayas desplazadas con la ilusi√≥n de la perspectiva.  Este es un enfoque simple pero inteligente.  Con hierba era un poco m√°s complicado.  Inicialmente, era un grupo de l√≠neas horizontales de 2 p√≠xeles de altura, pero agregu√© manualmente algunos p√≠xeles que agregan un poco de ruido que hace que el c√©sped se vea mejor: <br><br><pre> <code class="hljs powershell">bg_grass: dw `12121112 dw `12121212 dw `22112211 dw `11121212 dw `22112211 dw `21212121 dw `12121212 dw `12211222</code> </pre> <br><h2>  Renderizado de gr√°ficos </h2><br>  En GameBoy, los sprites se almacenan en un √°rea llamada OAM, o memoria de atributo de objeto.  Contiene solo atributos (direcci√≥n, paleta y prioridad), as√≠ como el n√∫mero de mosaico.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fue suficiente para m√≠ llenar esta √°rea de memoria para mostrar sprites en la pantalla. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aunque hay peque√±as caracter√≠sticas. Primero, debe cargar los gr√°ficos desde la ROM en VRAM. GameBoy solo puede renderizar mosaicos que est√°n almacenados en un √°rea especial de memoria llamada VRAM. Afortunadamente, para copiar de ROM a VRAM, es suficiente realizarlo </font></font><code>memcpy</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en la etapa de inicializaci√≥n del programa. Result√≥ que con solo 6 sprites de personajes y 4 fichas de cola, ya tom√© una cuarta parte del √°rea VRAM asignada para sprites. (VRAM generalmente se divide en √°reas de fondo y sprites, y 128 bytes son comunes para ellos).</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adem√°s, el acceso a OAM solo es posible durante VBlank. Comenc√© diciendo que VBlank estaba esperando los c√°lculos de sprites, pero me encontr√© con problemas porque los c√°lculos de sprites duraron todo el tiempo asignado por VBlank y era imposible terminarlos. La soluci√≥n aqu√≠ es escribir en un </font><font style="vertical-align: inherit;">√°rea de memoria </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">separada</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fuera de VBlank y simplemente copiarlos a OAM durante VBlank. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Al final result√≥ que, GameBoy tiene un procedimiento especial de copia de hardware, un tipo de DMA (Acceso directo a la memoria, acceso directo a la memoria) que hace exactamente eso. Al escribir en un registro espec√≠fico e ir al ciclo de ocupado en HiRAM (porque la ROM no est√° disponible durante DMA), puede copiar datos de RAM a OAM mucho m√°s r√°pido que usar la funci√≥n</font></font><code>memcpy</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Si est√° interesado, puede encontrar detalles jugosos </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqu√≠</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En esta etapa, solo pude crear un procedimiento que determine </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lo</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que finalmente se escribir√° en el DMA. </font><font style="vertical-align: inherit;">Para hacer esto, necesitaba almacenar el estado de los objetos en otro lugar. </font><font style="vertical-align: inherit;">Como m√≠nimo, se requer√≠a lo siguiente:</font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tipo (gecko, zorro polar o art√≠culo de transporte de uno de los equipos) </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Direcci√≥n </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Posici√≥n X </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Posici√≥n Y </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Marco de animaci√≥n </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Temporizador de animaci√≥n </font></font></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En la primera decisi√≥n, muy desali√±ada, verifiqu√© el tipo de objeto y, dependiendo de ello, cambi√© a un procedimiento que dibuja este tipo de objeto. El procedimiento del zorro polar, por ejemplo, tom√≥ una posici√≥n en X, dependiendo de la direcci√≥n, agreg√≥ o resta 16, agreg√≥ dos sprites de cola y luego se movi√≥ hacia arriba y hacia abajo del sprite principal. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aqu√≠ hay una captura de pantalla de c√≥mo se ve√≠a el sprite en VRAM cuando se renderiza en la pantalla. La parte izquierda es sprites individuales, n√∫meros hexadecimales junto a ellos, de arriba a abajo: posici√≥n vertical y horizontal, mosaico y banderas de atributos. A la derecha puedes ver c√≥mo se ve√≠a todo despu√©s del ensamblaje.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8e9/e7d/240/8e9e7d2401e1a07d0c77e2f0c6c99e3d.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Con la animaci√≥n de cola, fue un poco m√°s complicado. En la primera soluci√≥n, simplemente realic√© un incremento del temporizador de animaci√≥n en cada cuadro y produje uno l√≥gico </font></font><code>and</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">con un valor </font></font><code>%11</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para obtener el n√∫mero de cuadro. Luego, simplemente podr√≠a agregar 4 * el n√∫mero de cuadro (cada cuadro de animaci√≥n consta de 4 cuadros) al primer cuadro de cola en VRAM para obtener 4 cuadros diferentes almacenados en VRAM. Funcion√≥ (especialmente el que tiene la b√∫squeda de mosaico de la cola), pero la cola se movi√≥ </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">incre√≠blemente</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> r√°pido, y necesitaba encontrar una manera de frenarlo. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En la segunda, mejor soluci√≥n, realic√© un incremento del </font><font style="vertical-align: inherit;">temporizador </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">global</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en cada cuadro </font><font style="vertical-align: inherit;">, y cuando el valor de la operaci√≥n </font></font><code>and</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">con </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√©l</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y el grado de dos elegido por m√≠ fue 0, se realiz√≥ el incremento del temporizador de objetos. Por lo tanto, cada objeto individual podr√≠a contar su temporizador de animaci√≥n a cualquier velocidad que necesitara. Esto funcion√≥ perfectamente y me permiti√≥ desacelerar la cola a un nivel razonable.</font></font><br><br><h2>  Dificultades </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pero si todo fuera tan simple. No olvide que administr√© todo esto en el c√≥digo, usando mi propio subprocedimiento para cada objeto, y si necesita continuar, debe hacerlo en cada marco. Tuve que especificar c√≥mo proceder al siguiente sprite, as√≠ como en qu√© mosaico consiste, manipulando manualmente los registros. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Era un sistema completamente inestable. Para dibujar un cuadro, era necesario hacer malabarismos con un n√∫mero suficientemente grande de registros y tiempo de CPU. Era casi imposible agregar soporte para otro personal, e incluso si hubiera tenido √©xito, el soporte del sistema ser√≠a muy doloroso. </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cr√©eme, fue un verdadero caos.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Necesitaba un sistema en el que el c√≥digo para renderizar sprites fuera generalizado y directo, de modo que no fuera una combinaci√≥n de condiciones, manipulaci√≥n de registros y operadores matem√°ticos. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øC√≥mo solucion√© esto? </font><font style="vertical-align: inherit;">Hablar√© de esto en la pr√≥xima parte del art√≠culo.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/47d/f64/3a2/47df643a2bd620cf8899b3601162748b.gif" alt="imagen"></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es436330/">https://habr.com/ru/post/es436330/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es436320/index.html">Muchas propiedades u objeto de propiedad: criterios de selecci√≥n</a></li>
<li><a href="../es436322/index.html">@Pythonetc Diciembre 2018</a></li>
<li><a href="../es436324/index.html">Consejos y trucos de mi canal de Telegram @pythonetc, diciembre de 2018</a></li>
<li><a href="../es436326/index.html">Recentralizaci√≥n de la web. Por siempre esta vez</a></li>
<li><a href="../es436328/index.html">PVS-Studio 7.00</a></li>
<li><a href="../es436332/index.html">PVS-Studio 7.00</a></li>
<li><a href="../es436334/index.html">Aprendiendo conceptos a trav√©s de la interacci√≥n sensoriomotora</a></li>
<li><a href="../es436338/index.html">¬øC√≥mo funciona el aeropuerto de Vnukovo?</a></li>
<li><a href="../es436340/index.html">Nivel de registro separado para cada solicitud</a></li>
<li><a href="../es436342/index.html">Una introducci√≥n a la optimizaci√≥n robusta [... y una peque√±a lista de compras que olvid√© ...]</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>