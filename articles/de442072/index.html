<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßíüèø ‚Ü©Ô∏è üòã RxJava2 + Retrofit 2. Wir modifizieren den Adapter, um den fehlenden Internetstatus unter Android zu beheben üë∞üèº ‚ùï ‚õ∑Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sehr oft ist es notwendig, wiederholte Anfragen an das Netzwerk zu stellen, beispielsweise wenn der Benutzer nicht √ºber das Internet verf√ºgt und Daten...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>RxJava2 + Retrofit 2. Wir modifizieren den Adapter, um den fehlenden Internetstatus unter Android zu beheben</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/442072/"><img src="https://habrastorage.org/webt/ar/yk/jn/arykjnjuk66yqsjeqdzbyikdjca.png"><br><br>  Sehr oft ist es notwendig, wiederholte Anfragen an das Netzwerk zu stellen, beispielsweise wenn der Benutzer nicht √ºber das Internet verf√ºgt und Daten aus dem Internet empfangen m√∂chte.  Es w√§re sch√∂n, die Anfrage erneut zu werfen, wenn sie erscheint.  Es wird empfohlen, dem Benutzer eine bestimmte Benutzeroberfl√§che anzuzeigen, die ihm erkl√§rt, was passiert ist, und das erneute Ausl√∂sen der Anforderung zu erm√∂glichen.  Das Hinzuf√ºgen einer solchen Logik kann sehr schmerzhaft sein, insbesondere wenn wir eine gro√üe Anzahl von ViewModel-Klassen haben.  Nat√ºrlich k√∂nnen Sie die Neuabfragelogik in jeder ViewModel-Klasse implementieren, dies ist jedoch nicht praktisch und es besteht eine gro√üe Fehlerwahrscheinlichkeit. <br><a name="habracut"></a><br><h3>  Gibt es eine M√∂glichkeit, diese Verarbeitung nur einmal durchzuf√ºhren? </h3><br>  Gl√ºcklicherweise erlauben RxJava2 und Retrofit2 dies. <br><br>  Es gibt bereits mehrere L√∂sungen f√ºr Stackoverflow: <br><br>  1. Erstellen Sie Ihre eigene CallAdapterFactory (weitere Informationen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> ) <br>  2. Wiederholen Sie die Kette mit PublishSubject (weitere Informationen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> ). <br><br>  Die erste L√∂sung verwendet RxJava1, ist bereits veraltet und wiederholt die Kette einfach mehrmals, ohne auf das Auftreten des Ereignisses zu reagieren.  Die zweite L√∂sung ist gut, aber wir m√ºssen den Operator retryWhen in jeder Kette verwenden.  Und so habe ich die beiden L√∂sungen zu einer kombiniert. <br><br><h3>  Implementierung </h3><br>  Lassen Sie uns ein einfaches Projekt erstellen.  Platzieren Sie zwei Registerkarten auf dem Hauptbildschirm.  Jeder von ihnen zeigt Text an, der zeigt, wie viele Elemente von der API geladen werden.  Wenn w√§hrend der Ausf√ºhrung ein Fehler auftritt, wird eine SnackBar mit der Schaltfl√§che "Erneut versuchen" angezeigt. <br><br><img src="https://habrastorage.org/webt/vn/vu/b8/vnvub8wi1enqyeky8k9l45bgce4.gif"><br><br>  Wir definieren Basisklassen wie BaseActivity, BaseFragment, BaseViewModel. Sie sind erforderlich, um die Logik der Anforderungswiederholung an einer Stelle zu implementieren und Doppelarbeit dieses Codes zu vermeiden.  Erstellen Sie zwei Fragmente, die BaseFragment erweitern.  Jedes platzierte Fragment verf√ºgt √ºber ein eigenes ViewModel und stellt unabh√§ngig Anforderungen an die API.  Ich habe diese Snippets erstellt, um zu zeigen, dass bei einem Fehler jede Anforderung wiederholt wird.  Erstellen Sie als N√§chstes eine RxRetryCallAdapterFactory-Factory, die CallAdapter.Factory erweitert.  Erstellen Sie anschlie√üend eine Instanz von RxJava2CallAdapterFactory.  Wir ben√∂tigen diese Instanz, um auf den RxJava2CallAdapter zuzugreifen, da wir den Code, der sich bereits in der Retrofit-Bibliothek befindet, nicht duplizieren m√∂chten.  Erstellen wir au√üerdem eine statische Methode, die eine Instanz unserer Factory zur√ºckgibt.  Beispielcode unten: <br><br><pre><code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RxRetryCallAdapterFactory</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CallAdapter.Factory</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">companion</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> : CallAdapter.Factory = RxRetryCallAdapterFactory() } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> originalFactory = RxJava2CallAdapterFactory.create() <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(returnType : </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Type</span></span></span></span><span class="hljs-function"><span class="hljs-params">, annotations : </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Array</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Annotation</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt;, retrofit : </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Retrofit</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> : CallAdapter&lt;*, *&gt;? { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> adapter = originalFactory.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(returnType, annotations, retrofit) ?: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RxRetryCallAdapter(adapter) } }</code> </pre> <br>  Erstellen Sie als N√§chstes einen RxRetryCallAdapter, der die CallAdapter-Schnittstelle implementiert, und wir m√ºssen die CallAdapter-Instanz an den Konstruktor √ºbergeben.  Tats√§chlich muss es sich um eine Instanz von RxJava2CallAdapter handeln, die die urspr√ºngliche Factory zur√ºckgibt. <br><br>  Als n√§chstes m√ºssen wir die folgenden Dinge implementieren: <br><br><ul><li>  retryWhen-Anweisung zum Implementieren der Wiederholungsfunktion </li><li>  doOnError () - Anweisung, die Fehler behandelt.  Es wird zum Senden der Sendung verwendet, die in BaseActivity verarbeitet wird und dem Benutzer die SnackBar anzeigt. </li><li>  PublishSubject wird als Ereignisausl√∂ser verwendet, der die Kette neu signiert. </li><li>  Der Operator ObservOn (Schedulers.io ()), der auf PublishSubject angewendet werden muss (wenn diese Zeile nicht hinzugef√ºgt wird, erfolgt das Abonnement im Hauptthread und wir erhalten eine NetworkOnMainThreadException </li><li>  Wir transformieren PublishSubject in Flowable und setzen BackpressureStrategy.LATEST, da wir nur den letzten Fehler ben√∂tigen </li></ul><br>  Hinweis: Um PublishSubject bereitzustellen, habe ich eine einfache Singleton-Klasse erstellt, die alle Singleton-Abh√§ngigkeiten im Projekt bereitstellt.  In einem realen Projekt verwenden Sie wahrscheinlich ein Abh√§ngigkeitsinjektionsframework wie Dagger2 <br><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RxRetryCallAdapter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">R</span></span></span><span class="hljs-class">&gt;</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> originalAdapter : CallAdapter&lt;R, *&gt;) : CallAdapter&lt;R, Any&gt; { <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">adapt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(call : </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Call</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">R</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt;)</span></span></span></span> : Any { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> adaptedValue = originalAdapter.adapt(call) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> (adaptedValue) { <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> Completable -&gt; { adaptedValue.doOnError(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>::sendBroadcast) .retryWhen { AppProvider.provideRetrySubject().toFlowable(BackpressureStrategy.LATEST) .observeOn(Schedulers.io()) } } <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> Single&lt;*&gt; -&gt; { adaptedValue.doOnError(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>::sendBroadcast) .retryWhen { AppProvider.provideRetrySubject().toFlowable(BackpressureStrategy.LATEST) .observeOn(Schedulers.io()) } } <span class="hljs-comment"><span class="hljs-comment">//same for Maybe, Observable, Flowable else -&gt; { adaptedValue } } } override fun responseType() : Type = originalAdapter.responseType() private fun sendBroadcast(throwable : Throwable) { Timber.e(throwable) LocalBroadcastManager.getInstance(AppProvider.appInstance).sendBroadcast(Intent(BaseActivity.ERROR_ACTION)) } }</span></span></code> </pre> <br>  Wenn der Benutzer auf die Schaltfl√§che Erneut versuchen klickt, rufen wir onNext PublishSubject auf.  Danach abonnieren wir die RX-Kette erneut. <br><br><h3>  Testen </h3><br>  Schalten Sie das Internet aus und f√ºhren Sie die Anwendung aus.  Die Anzahl der geladenen Elemente ist auf jeder Registerkarte Null und SnackBar zeigt einen Fehler an.  Schalten Sie das Internet ein und klicken Sie auf Try Adain.  Nach einigen Sekunden √§ndert sich die Anzahl der geladenen Elemente auf jeder der Registerkarten. <br><br><img src="https://habrastorage.org/webt/a5/bj/0x/a5bj0xe7yqyij_lvqb4d7rnu0s4.gif"><br><br>  Wenn jemand es braucht, dann ist der Quellcode <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de442072/">https://habr.com/ru/post/de442072/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de442058/index.html">Erweiterbare Postgres</a></li>
<li><a href="../de442062/index.html">Digitalisierung der Kommunikation: Warum brauchen wir Emoji?</a></li>
<li><a href="../de442064/index.html">Software-Verschlechterung</a></li>
<li><a href="../de442066/index.html">Verschiedene M√∂glichkeiten, PDF mit digitaler Signatur zu f√§lschen</a></li>
<li><a href="../de442070/index.html">Die Unternehmen machten sich schlie√ülich Sorgen um die Entwicklung von IoT-Ger√§ten und deren Sicherheit</a></li>
<li><a href="../de442074/index.html">Stilvoller Wasserfall von RiME in der Game Engine: Machen Sie einen Wasserstrahl</a></li>
<li><a href="../de442078/index.html">Arbeiten mit der Jira API mit Python</a></li>
<li><a href="../de442080/index.html">Mikrometerverbindung f√ºr Java-Webanwendung</a></li>
<li><a href="../de442082/index.html">So vereinfachen Sie die Oracle-Datenbankrecherche: ein "Gentleman-Satz" von Skripten</a></li>
<li><a href="../de442084/index.html">Antiquit√§ten: 20 Jahre alte Diskettenkamera</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>